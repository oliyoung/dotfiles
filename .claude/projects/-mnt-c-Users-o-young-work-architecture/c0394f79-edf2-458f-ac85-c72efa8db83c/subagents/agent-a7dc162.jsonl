{"parentUuid":null,"isSidechain":true,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","agentId":"a7dc162","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":"I need to restructure the Flybuys solution architecture document (5276 lines) to match the more comprehensive and TOGAF-aligned structure of the Salesforce solution architecture document (3328 lines).\n\nCurrent Flybuys structure issues:\n- Executive Summary is brief and early (line 9)\n- No Vision or Architectural Approach sections\n- No formal Technical Requirements section  \n- No Baseline Architecture section (content scattered in TS-0)\n- Informal \"Key Technology Decisions\" instead of formal ADRs\n- No dedicated Assumptions and Constraints section\n- No comprehensive Non-Functional Requirements section\n- No Monitoring and Observability section\n- Gap Analysis is after Interface Specifications instead of integrated into architecture\n\nFlybuys strengths to preserve:\n- Detailed Physical Data Models with JSON schemas\n- Complete API Documentation\n- Correlation ID Propagation specification\n- SBB Dependency Flowchart\n- Comprehensive sequence diagrams and interaction flows\n\nSalesforce structure (target):\n1. Purpose and Scope (with Vision, Architectural Approach, Architecture Overview)\n2. Solution Approach\n3. Executive Summary (Challenge/Solution/Significance structure)\n4. Technical Requirements\n5. Technical Architecture (with Baseline, Gap Analysis, Target State, ADRs)\n6. Solution Building Blocks\n7. Data Architecture\n8. Interface Specifications\n9. Work Packages\n10. Transition Architecture\n11. Assumptions and Constraints\n12. Non-Functional Requirements\n13. Monitoring and Observability\n14. Solution Validation\n\nPlease provide:\n1. A detailed restructuring plan with section mappings\n2. Recommendations for converting Key Technology Decisions to ADRs\n3. Strategy for extracting Baseline Architecture from TS-0\n4. Approach for organizing Non-Functional Requirements\n5. Any content that should be created vs moved\n6. Risks and validation checkpoints"},"uuid":"ecbf742f-159d-4116-a5f3-fef794d20fc0","timestamp":"2026-01-09T04:57:09.288Z"}
{"parentUuid":"ecbf742f-159d-4116-a5f3-fef794d20fc0","isSidechain":true,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","agentId":"a7dc162","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01EscfcheQeSj7qFejmNJpr5","type":"message","role":"assistant","content":[{"type":"text","text":"I'll analyze both documents to create a comprehensive restructuring plan that preserves Flybuys' technical depth while adopting Salesforce's TOGAF-aligned structure."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":17725,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":17725,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CWwDBnL42eGVx3ypHmaxS","type":"assistant","uuid":"a0d9bc05-7b10-4101-97fe-4233a8dea00c","timestamp":"2026-01-09T04:57:12.291Z"}
{"parentUuid":"a0d9bc05-7b10-4101-97fe-4233a8dea00c","isSidechain":true,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","agentId":"a7dc162","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01EscfcheQeSj7qFejmNJpr5","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01JSt5nLD3nUoij5eBnJy3HT","name":"Read","input":{"file_path":"/mnt/c/Users/o.young/work/architecture/architecture_definitions/flybuys_integration.adoc"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":17725,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":17725,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CWwDBnL42eGVx3ypHmaxS","type":"assistant","uuid":"977c3f36-1309-4b2c-946d-d1fafe3f9cf8","timestamp":"2026-01-09T04:57:13.228Z"}
{"parentUuid":"977c3f36-1309-4b2c-946d-d1fafe3f9cf8","isSidechain":true,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","agentId":"a7dc162","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01EscfcheQeSj7qFejmNJpr5","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01MfoqzuRqWBoAqFkCdU95kX","name":"Read","input":{"file_path":"/mnt/c/Users/o.young/work/architecture/architecture_definitions/salesforce_customer_support.adoc"}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":17725,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":17725,"ephemeral_1h_input_tokens":0},"output_tokens":181,"service_tier":"standard"}},"requestId":"req_011CWwDBnL42eGVx3ypHmaxS","type":"assistant","uuid":"e857192d-7d2c-4310-ab7d-6286edbd342f","timestamp":"2026-01-09T04:57:13.834Z"}
{"parentUuid":"e857192d-7d2c-4310-ab7d-6286edbd342f","isSidechain":true,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","agentId":"a7dc162","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01MfoqzuRqWBoAqFkCdU95kX","type":"tool_result","content":"     1→= Salesforce Customer Support\n     2→:project-name: OTR-002\n     3→:togaf-adm-phase: Phase C: Information Systems Architectures\n     4→:document-type: Architecture Definition Document\n     5→:status: Discovery\n     6→:version: 0.1\n     7→:domain: Engagement\n     8→:domain-architect: O.Young@otr.com.au\n     9→:doctype: article\n    10→:toc: left\n    11→:toclevels: 4\n    12→:sectanchors:\n    13→:sectlinks:\n    14→:sectnums:\n    15→:icons: font\n    16→:source-highlighter: highlightjs\n    17→:experimental:\n    18→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"d2941359-9df5-4376-814f-b01d19292f7f","timestamp":"2026-01-09T04:57:14.118Z","toolUseResult":{"type":"text","file":{"filePath":"/mnt/c/Users/o.young/work/architecture/architecture_definitions/salesforce_customer_support.adoc","content":"= Salesforce Customer Support\n:project-name: OTR-002\n:togaf-adm-phase: Phase C: Information Systems Architectures\n:document-type: Architecture Definition Document\n:status: Discovery\n:version: 0.1\n:domain: Engagement\n:domain-architect: O.Young@otr.com.au\n:doctype: article\n:toc: left\n:toclevels: 4\n:sectanchors:\n:sectlinks:\n:sectnums:\n:icons: font\n:source-highlighter: highlightjs\n:experimental:\n","numLines":18,"startLine":1,"totalLines":18}},"sourceToolAssistantUUID":"e857192d-7d2c-4310-ab7d-6286edbd342f"}
{"parentUuid":"977c3f36-1309-4b2c-946d-d1fafe3f9cf8","isSidechain":true,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","agentId":"a7dc162","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"type":"tool_result","content":"File content (36843 tokens) exceeds maximum allowed tokens (25000). Please use offset and limit parameters to read specific portions of the file, or use the GrepTool to search for specific content.","is_error":true,"tool_use_id":"toolu_01JSt5nLD3nUoij5eBnJy3HT"}]},"uuid":"16d8f282-a292-4177-9233-4d67cdac8f4c","timestamp":"2026-01-09T04:57:14.488Z","toolUseResult":"Error: File content (36843 tokens) exceeds maximum allowed tokens (25000). Please use offset and limit parameters to read specific portions of the file, or use the GrepTool to search for specific content.","sourceToolAssistantUUID":"977c3f36-1309-4b2c-946d-d1fafe3f9cf8"}
{"parentUuid":"16d8f282-a292-4177-9233-4d67cdac8f4c","isSidechain":true,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","agentId":"a7dc162","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_012FGJaFwkc3uK7iWpZgiaUt","type":"message","role":"assistant","content":[{"type":"text","text":"Let me read the Flybuys document in sections to analyze its structure."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":300,"cache_creation_input_tokens":256,"cache_read_input_tokens":17725,"cache_creation":{"ephemeral_5m_input_tokens":256,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWwDCAkvppokjmbXDCrwv","type":"assistant","uuid":"39d5a58d-17d0-46ac-a92d-fee9df565e78","timestamp":"2026-01-09T04:57:17.769Z"}
{"parentUuid":"39d5a58d-17d0-46ac-a92d-fee9df565e78","isSidechain":true,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","agentId":"a7dc162","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_012FGJaFwkc3uK7iWpZgiaUt","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01UiJAiffLLFvgnGcHH9d2TB","name":"Read","input":{"file_path":"/mnt/c/Users/o.young/work/architecture/architecture_definitions/flybuys_integration.adoc","offset":1,"limit":500}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":300,"cache_creation_input_tokens":256,"cache_read_input_tokens":17725,"cache_creation":{"ephemeral_5m_input_tokens":256,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWwDCAkvppokjmbXDCrwv","type":"assistant","uuid":"7d30213e-e071-46ec-892d-e697ed30d64e","timestamp":"2026-01-09T04:57:18.449Z"}
{"parentUuid":"7d30213e-e071-46ec-892d-e697ed30d64e","isSidechain":true,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","agentId":"a7dc162","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_012FGJaFwkc3uK7iWpZgiaUt","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01TqPocvaWxHRSE2Cc7gJfdu","name":"Read","input":{"file_path":"/mnt/c/Users/o.young/work/architecture/architecture_definitions/salesforce_customer_support.adoc","offset":1,"limit":500}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":300,"cache_creation_input_tokens":256,"cache_read_input_tokens":17725,"cache_creation":{"ephemeral_5m_input_tokens":256,"ephemeral_1h_input_tokens":0},"output_tokens":229,"service_tier":"standard"}},"requestId":"req_011CWwDCAkvppokjmbXDCrwv","type":"assistant","uuid":"cc198012-153a-428c-8655-1661748f9f2d","timestamp":"2026-01-09T04:57:19.182Z"}
{"parentUuid":"cc198012-153a-428c-8655-1661748f9f2d","isSidechain":true,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","agentId":"a7dc162","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01TqPocvaWxHRSE2Cc7gJfdu","type":"tool_result","content":"     1→= Salesforce Customer Support\n     2→:project-name: OTR-002\n     3→:togaf-adm-phase: Phase C: Information Systems Architectures\n     4→:document-type: Architecture Definition Document\n     5→:status: Discovery\n     6→:version: 0.1\n     7→:domain: Engagement\n     8→:domain-architect: O.Young@otr.com.au\n     9→:doctype: article\n    10→:toc: left\n    11→:toclevels: 4\n    12→:sectanchors:\n    13→:sectlinks:\n    14→:sectnums:\n    15→:icons: font\n    16→:source-highlighter: highlightjs\n    17→:experimental:\n    18→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"ac6b7ecd-aa2a-4dcb-b33b-f30fecbc0fe1","timestamp":"2026-01-09T04:57:19.416Z","toolUseResult":{"type":"text","file":{"filePath":"/mnt/c/Users/o.young/work/architecture/architecture_definitions/salesforce_customer_support.adoc","content":"= Salesforce Customer Support\n:project-name: OTR-002\n:togaf-adm-phase: Phase C: Information Systems Architectures\n:document-type: Architecture Definition Document\n:status: Discovery\n:version: 0.1\n:domain: Engagement\n:domain-architect: O.Young@otr.com.au\n:doctype: article\n:toc: left\n:toclevels: 4\n:sectanchors:\n:sectlinks:\n:sectnums:\n:icons: font\n:source-highlighter: highlightjs\n:experimental:\n","numLines":18,"startLine":1,"totalLines":18}},"sourceToolAssistantUUID":"cc198012-153a-428c-8655-1661748f9f2d"}
{"parentUuid":"7d30213e-e071-46ec-892d-e697ed30d64e","isSidechain":true,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","agentId":"a7dc162","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01UiJAiffLLFvgnGcHH9d2TB","type":"tool_result","content":"     1→= Flybuys Integration - Architecture Definition\n     2→:project-name: OTR-002\n     3→:togaf-adm-phase: Phase C: Information Systems Architectures\n     4→:document-type: Architecture Definition Document\n     5→:status: Discovery\n     6→:version: 0.1\n     7→:domain: Loyalty\n     8→:programme-lead: Frankie.Mullaly@vivaenergy.com.au\n     9→:domain-architect: O.Young@otr.com.au\n    10→:business-owner: D.Peisley@otr.com.au\n    11→:business-analyst: Fiona.Cheung@vivaenergy.com.au\n    12→:solution-architecture: link:/solution_architectures/flybuys_integration.adoc[Solution Architectures/Flybuys Integration]\n    13→:doctype: article\n    14→:toc: left\n    15→:toclevels: 4\n    16→:sectanchors:\n    17→:sectlinks:\n    18→:sectnums:\n    19→:icons: font\n    20→:source-highlighter: highlightjs\n    21→:experimental:\n    22→:description: Architecture Definition Document for Flybuys Coalition Loyalty Integration\n    23→:keywords: loyalty, flybuys, integration, architecture-definition, togaf, ddd\n    24→\n    25→== Introduction & Vision\n    26→\n    27→=== Purpose\n    28→\n    29→OTR and Reddy Express customers experience fragmented loyalty programmes across the OTRG store network. REXP stores use manual Flybuys batch processing, OTR stores offer native rewards, and no digital coalition partner linking exists. This limits customer choice, creates operational overhead, and constrains competitive positioning against national chains with integrated loyalty programmes.\n    30→\n    31→=== Vision\n    32→\n    33→> Enable customers to seamlessly link coalition loyalty partners via mobile app, select their reward preference, and earn partner points at any OTR/REXP store—while maintaining architectural flexibility to evolve OTR’s native loyalty capability independently.\n    34→\n    35→=== Architectural Approach\n    36→\n    37→This architecture introduces three bounded contexts (link:../bounded_context/profile.adoc[Profile Service], link:../bounded_context/loyalty.adoc[Loyalty Service], link:../bounded_context/engagement.adoc[Engagement Service]) implementing Domain-Driven Design patterns:\n    38→\n    39→* *link:../bounded_context/profile.adoc[Profile Service]*: Partner account linking (OAuth 2.0), reward preference management, canonical customer identity (VCI)\n    40→* *link:../bounded_context/loyalty.adoc[Loyalty Service]*: Transaction adjudication, credential resolution, partner integration facade, automated batch posting\n    41→* *link:../bounded_context/engagement.adoc[Engagement Service]*: Customer engagement campaigns, notification orchestration, Braze Anti-Corruption Layer\n    42→* *Event-driven integration*: Loose coupling via Event Bus with published domain events\n    43→* *Anti-Corruption Layers*: Isolation from external systems (link:../bounded_context/external/braze.adoc[Braze], link:../bounded_context/external/eagle_eye.adoc[EagleEye], link:../bounded_context/external/flybuys.adoc[Flybuys], link:../bounded_context/external/microsoft_dynamics_365_commerce.adoc[D365 Commerce])\n    44→* *Phased rollout*: Parallel deployment alongside legacy link:../bounded_context/interfaces/otr_app_api.adoc[OTR App API] with feature flag-controlled gradual enablement (link:#AS-1_Foundation[AS-1 Foundation] → link:#AS-2_Linking[AS-2 Linking] → link:#AS-3_Grants[AS-3 Grants]) The link:../bounded_context/profile.adoc[Profile Service] also serves as a facade for link:../bounded_context/interfaces/otr_pos.adoc[OTR POS] integration to link:../bounded_context/external/salesforce_crm.adoc[Salesforce CRM] before the #Highlander programme.\n    45→\n    46→=== Architecture Overview\n    47→\n    48→The following diagram shows the target state architecture with three new bounded contexts (Profile Service, Loyalty Service, Engagement Service) integrating with existing systems:\n    49→\n    50→[mermaid]\n    51→----\n    52→---\n    53→layout: elk\n    54→---\n    55→flowchart LR\n    56→    Customer([\"Customer\"]) -- Uses --> MobileApp[\"Mobile App<br>iOS/Android\"]\n    57→    Customer -- Shops at --> POS[\"OTR/OTR+ POS<br>D365 Commerce\"]\n    58→    Customer -- Receives --> EngagementService[\"Engagement Service<br>Campaign Triggers<br>Customer Notifications<br>Braze Integration\"]\n    59→    MobileApp -- Authenticate --> EntraID[\"Microsoft Entra<br>External ID<br>CIAM\"]\n    60→    MobileApp -- \"Link Partner Account<br>OAuth 2.0 + PKCE\" --> ProfileService[\"Profile Service<br>Partner Account Linking<br>Reward Preferences\"]\n    61→    MobileApp -- Get Partner Links<br>Update Preferences --> ProfileService\n    62→    MobileApp -- Query Flybuys Balance<br>via ACL --> LoyaltyService[\"Loyalty Service<br>Transaction Adjudication<br>Credential Resolution<br>Batch Processing\"]\n    63→    POS -- Scan Loyalty Credential<br>Resolve to VCI --> LoyaltyService\n    64→    POS -- \"Transaction Adjudication<br>Real-time &lt;500ms\" --> LoyaltyService\n    65→    ProfileService -- \"Store OAuth Tokens<br>AES-256 Encrypted\" --> OAuthService[\"OAuth Service<br>Token Management\"]\n    66→    ProfileService -- Query Customer Profile<br>Conformist --> Salesforce[\"Salesforce CRM<br>Customer Profile<br>System of Record\"]\n    67→    ProfileService -- Publish Events<br>PartnerLinked<br>RewardPreferenceChanged --> EventBus[(\"Event Bus<br>Domain Events\")]\n    68→    LoyaltyService -- Transaction Adjudication<br>via ACL --> EagleEye[\"EagleEye<br>Loyalty Engine<br>Points, Offers, Wallet\"]\n    69→    LoyaltyService -- Query Wallet/Points/Tiers<br>via ACL --> EagleEye\n    70→    LoyaltyService -- Nightly Batch SFTP<br>PGP Encrypted --> Flybuys[\"Flybuys<br>Coalition Partner<br>OAuth, SFTP\"]\n    71→    LoyaltyService -- OAuth Balance Query<br>via ACL --> Flybuys\n    72→    LoyaltyService -- Query Reward Preference<br>REST API --> ProfileService\n    73→    LoyaltyService -- Publish Events<br>TransactionAdjudicated<br>PointsEarned --> EventBus\n    74→    EngagementService -- Consume Events<br>PartnerLinked<br>TransactionAdjudicated<br>PointsEarned --> EventBus\n    75→    EngagementService -- Trigger Campaigns<br>Push Notifications<br>via ACL --> Braze[\"Braze<br>Marketing Automation<br>Webhooks\"]\n    76→    EngagementService -- Query Customer Profile<br>Conformist --> Salesforce\n    77→    OAuthService -- OAuth Token Exchange<br>Authorization Code Flow --> Flybuys\n    78→\n    79→     Customer:::customer\n    80→     MobileApp:::presentation\n    81→     POS:::presentation\n    82→     EngagementService:::newService\n    83→     EntraID:::external\n    84→     ProfileService:::newService\n    85→     LoyaltyService:::newService\n    86→     OAuthService:::infrastructure\n    87→     Salesforce:::external\n    88→     EventBus:::infrastructure\n    89→     EagleEye:::external\n    90→     Flybuys:::external\n    91→     Braze:::external\n    92→    classDef newService fill:#4CAF50,stroke:#2E7D32,stroke-width:3px,color:#fff\n    93→    classDef external fill:#FF9800,stroke:#E65100,stroke-width:2px,color:#fff\n    94→    classDef infrastructure fill:#2196F3,stroke:#0D47A1,stroke-width:2px,color:#fff\n    95→    classDef presentation fill:#9C27B0,stroke:#4A148C,stroke-width:2px,color:#fff\n    96→    classDef customer fill:#607D8B,stroke:#263238,stroke-width:2px,color:#fff\n    97→----\n    98→\n    99→==== Key Architectural Patterns\n   100→\n   101→[width=\"100%\",cols=\"19%,34%,47%\",options=\"header\",]\n   102→|===\n   103→|Pattern | Application | Rationale\n   104→|*Anti-Corruption Layer (ACL)* | LoyaltyService → EagleEye, FlybuysEngagementService → Braze | Isolates domain model from external system changes, translates between bounded contexts\n   105→|*Customer-Supplier + Conformist* | ProfileService → SalesforceEngagementService → Salesforce | We conform to Salesforce API (external system we don’t control)\n   106→|*Backend-for-Frontend (BFF)* | LoyaltyService | Orchestrates multiple backend systems (EagleEye, ProfileService) for POS/Mobile clients\n   107→|*Event-Driven Architecture* | Event Bus (OHS+PL) | Loose coupling between bounded contexts, asynchronous notification of domain events\n   108→|*Event Consumer* | EngagementService | Consumes domain events from Profile and Loyalty contexts to trigger customer campaigns\n   109→|*OAuth 2.0 + PKCE* | ProfileService → Flybuys | Secure partner account linking without storing passwords\n   110→|*Strangler Fig* | Parallel deployment with feature flags | Gradual migration to new bounded contexts\n   111→|===\n   112→\n   113→== Technical Requirements\n   114→\n   115→[width=\"100%\",cols=\"4%,96%\",options=\"header\",]\n   116→|===\n   117→|ID | Description\n   118→|TR-001 | Every link:../bounded_context/interfaces/mobile.adoc[Mobile Application] user has a link:../ubiquitous_language.adoc#Salesforce%2520Contact[Salesforce Contact] record in link:../bounded_context/external/salesforce_crm.adoc[Salesforce CRM]\n   119→|TR-002 | Every link:../bounded_context/interfaces/mobile.adoc[Mobile Application] user has a link:../ubiquitous_language.adoc#Viva%2520Consumer%2520ID[VCI] part of their link:../ubiquitous_language.adoc#Loyalty%2520Credential[Loyalty Credentials]\n   120→|TR-003 | Every link:../bounded_context/interfaces/mobile.adoc[Mobile Application] user has a link:../ubiquitous_language.adoc#Wallet[Loyalty Wallet] part of their link:../ubiquitous_language.adoc#Loyalty%2520Credential[Loyalty Credentials]\n   121→|TR-004 | link:../ubiquitous_language.adoc#Customer[Customers] have a single set of link:../ubiquitous_language.adoc#Loyalty%2520Credential[Loyalty Credentials]\n   122→|TR-005 | link:../ubiquitous_language.adoc#Customer[Customers] are able to link and unlink their link:../ubiquitous_language.adoc#Flybuys%2520Digital%2520Identity[Flybuys Digital Identity] from any link:../bounded_context/interfaces/mobile.adoc[Mobile Application]\n   123→|TR-006 | link:../ubiquitous_language.adoc#Customer[Customers] can manage their link:../ubiquitous_language.adoc#Reward%2520Preference[Reward Preference] (select and retain preference)\n   124→|TR-007 | link:../bounded_context/external/flybuys.adoc[Flybuys] link:../ubiquitous_language.adoc#Partner[Partner] transactions are posted to link:../bounded_context/external/flybuys.adoc[Flybuys] for points allocation to link:../ubiquitous_language.adoc#Flybuys%2520Earning%2520Rules[Earning Rules]\n   125→|TR-008 | link:../bounded_context/interfaces/otr_pos.adoc[OTR POS] stores recognise all link:../ubiquitous_language.adoc#Loyalty%2520Credential[Loyalty Credentials] and grant Flybuys Points on fulfilled Transactions where a Customer has a linked Flybuys Digital Identity\n   126→|TR-009 | link:../bounded_context/interfaces/otr_plus_pos.adoc[OTR+ POS] stores recognise all link:../ubiquitous_language.adoc#Loyalty%2520Credential[Loyalty Credentials] and grant Flybuys Points on fulfilled Transactions where a Customer has a linked Flybuys Digital Identity\n   127→|TR-010 | link:../ubiquitous_language.adoc#Customer[Customers] can retrieve their link:../bounded_context/external/flybuys.adoc[Flybuys] points balance in real-time within any link:../bounded_context/interfaces/mobile.adoc[Mobile Application]\n   128→|[line-through]*TR-011* |[line-through]*link:../bounded_context/external/flybuys.adoc[Flybuys] link:../ubiquitous_language.adoc#Digital%2520Fuel%2520Dockets[Digital Fuel Dockets] are redeemable at link:../bounded_context/interfaces/otr_pos.adoc[OTR POS] and link:../bounded_context/interfaces/otr_plus_pos.adoc[OTR+ POS]*\n   129→|TR-012 | All transactions by link:../ubiquitous_language.adoc#Loyalty%2520Credential[Credentialed] link:../ubiquitous_language.adoc#Customer[Customers] through any channel are adjudicated by link:../bounded_context/external/eagle_eye.adoc[EagleEye]\n   130→|TR-013 | Web and Mobile Clients geographically show which Loyalty programmes are available at each store\n   131→|TR-014 | All changes are communicated using a decoupled event-based architecture\n   132→|TR-015 | ==Reporting==\n   133→|TR-016 | ==Customer Service==\n   134→|===\n   135→\n   136→=== Technical Requirements Mapping\n   137→\n   138→[cols=\",\",options=\"header\",]\n   139→|===\n   140→|Business Requirement | Technical Requirement\n   141→|LNKHL_001 | TR-005\n   142→|LNKHL_002 | TR-005\n   143→|LNKHL_003 | TR-004\n   144→|LNKHL_004 | TR-005\n   145→|LNKHL_005 | TR-005\n   146→|LNKHL_006 | TR-014\n   147→|LNKHL_007 | TR-014\n   148→|LNKHL_008 | TR-014\n   149→|LNKHL_009 | TR-014\n   150→|NTWHL_001 | TR-012\n   151→|NTWHL_002 | TR-012\n   152→|NTWHL_003 | TR-013\n   153→|NTWHL_003 | TR-013\n   154→|PEHL_001 | TR-012\n   155→|PEHL_002 |\n   156→|PEHL_003 | TR-010\n   157→|PEHL_004 | TR-012\n   158→|INAHL_001 | TR-008 TR-009\n   159→|INAHL_002 | TR-008 TR-009\n   160→|INAHL_003 | TR-008 TR-009\n   161→|INAHL_004 | TR-008 TR-009\n   162→|INAHL_005 | TR-008 TR-009\n   163→|INAHL_006 | TR-008 TR-009\n   164→|INSHL_001 | TR-008 TR-009\n   165→|INSHL_002 | TR-014\n   166→|TCRHL_001 | TR-007\n   167→|TCRHL_002 | TR-015\n   168→|TCRHL_003 | TR-015\n   169→|TCRHL_004 | TR-015\n   170→|TCRHL_005 | TR-015\n   171→|TCRHL_006 | TR-015\n   172→|TCRHL_007 | TR-015\n   173→|CEHL_001 | TR-016\n   174→|CEHL_002 | TR-016\n   175→|CEHL_003 | TR-016\n   176→|===\n   177→\n   178→=== Stakeholder Analysis\n   179→\n   180→[width=\"100%\",cols=\"20%,28%,10%,11%,31%\",options=\"header\",]\n   181→|===\n   182→|Stakeholder | Role | Interest Level | Influence Level | Engagement Strategy\n   183→|Darren Peisley | Business Owner | High | High | Steering, requirements sign-off\n   184→|Amin Joderyi | Mobile Application and Ecommerce Lead | High | High |Collaboration\n   185→|Frankie Mullaly | Programme Lead | High | Medium | Status updates, escalation point\n   186→|Oli Young | Domain Architect | High | High | Collaboration, architecture decisions\n   187→|Fiona Cheung | Business Analyst | Medium | Medium | Requirements gathering, documentation\n   188→|David Le Pham | Product Owner | High | High | Product decisions, prioritisation\n   189→|Paola Buchan | Marketing & Campaigns Lead | High | Medium | Campaign planning, promotional strategy\n   190→|Nick Cannizzo | Project Manager | High | Low | Programme coordination\n   191→|Mobile App Users | End Users | High | Low | Beta testing programme, feedback surveys\n   192→|link:../bounded_context/external/flybuys.adoc[Flybuys] | External Partner |Medium | Medium | Coordination, API support\n   193→|link:../bounded_context/external/eagle_eye.adoc[EagleEye] | SaaS Loyalty Platform Vendor | Medium | Medium | Business reviews, support tickets\n   194→|D365 Team | POS Operations | Medium | Medium | Training sessions, operational readiness\n   195→|Customer Support Team | Support & Troubleshooting | Medium | Low |Training, escalation procedures\n   196→|Fullstack Team | CRM Integration | Low | Low | Integration coordination\n   197→|Platform Infrastructure | Cloud Platform | Low | High | Deployment planning, capacity planning\n   198→|Data Team | Data Integration | Low | Medium | Data pipeline coordination\n   199→|===\n   200→\n   201→=== Baseline Architecture\n   202→\n   203→==== Current Business Capability\n   204→\n   205→[width=\"100%\",cols=\"19%,7%,9%,4%,57%,4%\",options=\"header\",]\n   206→|===\n   207→|L1 Domain | L2 Subdomain | L3 Capability | Owned By | Supporting Systems |Maturity Level\n   208→|link:../domains/loyalty.adoc[Loyalty Domain] | Preference Management |Reward Preference Management | Loyalty Team\n   209→|link:../bounded_context/external/salesforce_crm.adoc[Salesforce CRM] (manual updates via link:../bounded_context/external/flybuys.adoc[Flybuys]) | Initial\n   210→|link:../domains/loyalty.adoc[Loyalty Domain] | Transaction Processing |Transaction Adjudication | Loyalty Team |link:../bounded_context/interfaces/otr_plus_pos.adoc[OTR+ POS], link:../bounded_context/external/coupon_scanner.adoc[Coupon Scanner], link:../bounded_context/external/eagle_eye.adoc[EagleEye] | Managed\n   211→|link:../domains/loyalty.adoc[Loyalty Domain] | Transaction Processing |Transaction Posting | Loyalty Team | CSV export, SFTP upload | Initial\n   212→|link:../domains/engagement.adoc[Engagement Domain] | Channel Recognition | Mobile Loyalty Credential | Mobile Team\n   213→|link:../bounded_context/interfaces/mobile.adoc[Mobile Application], link:../bounded_context/interfaces/otr_app_api.adoc[OTR App API] | Managed\n   214→|link:../domains/engagement.adoc[Engagement Domain] | Channel Recognition | POS Loyalty Credential | D365 Team |link:../bounded_context/interfaces/otr_pos.adoc[OTR POS], link:../bounded_context/interfaces/otr_plus_pos.adoc[OTR+ POS] | Managed\n   215→|link:../domains/engagement.adoc[Engagement Domain] | Personalised Offers | Digital Fuel Docket Redemption | Loyalty Team |link:../bounded_context/interfaces/otr_plus_pos.adoc[OTR+ POS], link:../bounded_context/external/coupon_scanner.adoc[Coupon Scanner], link:../bounded_context/external/eagle_eye.adoc[EagleEye] | Managed\n   216→|Infrastructure | Partner Integration | Directly Coupled | Platform Team |Direct coupling to external systems | Managed\n   217→|===\n   218→\n   219→==== Current Value Stream\n   220→\n   221→===== Customer Redeems Flybuys Fuel Discount\n   222→\n   223→[mermaid]\n   224→----\n   225→sequenceDiagram\n   226→    actor Customer\n   227→    participant Scanner as Coupon Scanner\n   228→    participant POS as OTR+ POS\n   229→    participant D365 as D365 Commerce\n   230→    participant DataTeam as Data Team\n   231→    participant SQL as SQL Database\n   232→    participant SFTP as SFTP Server\n   233→    participant Flybuys as Flybuys\n   234→    participant Support as Call Centre\n   235→\n   236→    Customer->>Scanner: Present Flybuys card\n   237→    Scanner-->>Customer: Scan fuel docket barcode\n   238→\n   239→    Customer->>POS: Make purchase (fuel/products)\n   240→    POS->>D365: Process transaction\n   241→    D365-->>POS: Transaction recorded\n   242→    POS-->>Customer: Receipt (no points confirmation)\n   243→\n   244→    Note over Customer,Flybuys: Manual Batch Process (Next Day)\n   245→\n   246→    DataTeam->>SQL: Run SQL query\n   247→    SQL-->>DataTeam: Transaction data\n   248→    DataTeam->>DataTeam: Generate CSV file manually\n   249→    DataTeam->>SFTP: Manual SFTP upload\n   250→\n   251→    Note over SFTP,Flybuys: 24+ Hour Delay\n   252→\n   253→    Flybuys->>SFTP: Retrieve batch file\n   254→    Flybuys->>Flybuys: Process transactions\n   255→    Flybuys->>Flybuys: Credit points to member account\n   256→\n   257→    alt Customer checks points before batch processing\n   258→        Customer->>Support: Call support (missing points)\n   259→        Support->>Support: Manual investigation (10-15 min)\n   260→        Support->>SQL: Query transaction status\n   261→        Support-->>Customer: \"Points will appear in 24-48 hours\"\n   262→    end\n   263→\n   264→    Note over Customer,Flybuys: Pain Points:<br/>- No real-time adjudication<br/>- Manual CSV export/upload<br/>- 24+ hour delay<br/>- No retry logic<br/>- High support burden\n   265→----\n   266→\n   267→[width=\"100%\",cols=\"21%,30%,15%,4%,13%,17%\",options=\"header\",]\n   268→|===\n   269→|Actor | Activity | System | Duration | Value Added | Pain Points / Waste\n   270→|link:../ubiquitous_language.adoc#Customer[Customer] | Present link:../ubiquitous_language.adoc#Flybuys%2520Cardholder%2520Number[Flybuys Card] | link:../bounded_context/external/coupon_scanner.adoc[Coupon Scanner] | < 1 Sec | None | Significant delay, manual reconciliation\n   271→|link:../ubiquitous_language.adoc#Customer[Customer] | Makes purchase (fuel/products) | link:../bounded_context/interfaces/otr_plus_pos.adoc[OTR+ POS] | < 1 Sec | Complete transaction | No real-time points confirmation at POS\n   272→|link:../bounded_context/interfaces/otr_pos.adoc[OTR POS] | Process transaction\n   273→|link:../bounded_context/external/microsoft_dynamics_365_commerce.adoc[Microsoft Dynamics 365 Commerce] | < 1 sec | Record transaction | No immediate adjudication\n   274→|link:../bounded_context/external/flybuys.adoc[Flybuys] | Process batch file | link:../bounded_context/external/flybuys.adoc[Flybuys] | > 24 hours |Credit points to member account | Processing time outside OTR control\n   275→|Data Team | Export Flybuys transactions | Automated SQL query, CSV generation | Automated | Prepare Flybuys batch file |\n   276→|Data Team | Upload to Flybuys SFTP | AutomatedSFTP upload | Automated |Post transactions to Flybuys | Automated upload, no retry logic\n   277→|Customer | Call support if issue | Call centre | 10-15 min | Troubleshoot missing points | High support burden, manual investigation\n   278→|===\n   279→\n   280→==== Pain Points\n   281→\n   282→[width=\"100%\",cols=\"16%,38%,46%\",options=\"header\",]\n   283→|===\n   284→|Category | Pain Point | Business Impact\n   285→|Customer Experience | No linking process | Low adoption, no communication permissions\n   286→|Customer Experience | No visibility of Flybuys balance in OTR app |Customer confusion, support calls\n   287→|Integration | Tight coupling to link:../bounded_context/external/eagle_eye.adoc[EagleEye] and link:../bounded_context/external/flybuys.adoc[Flybuys] APIs | Brittle integration, difficult to change partners\n   288→|Compliance | No just-in-time transaction adjudication | Loyalty is pushed to stores causing scaling and timing issues\n   289→|===\n   290→\n   291→=== Target State Architecture\n   292→\n   293→==== Business Capability\n   294→\n   295→[width=\"100%\",cols=\"12%,15%,41%,7%,25%\",options=\"header\",]\n   296→|===\n   297→|L1 Domain | L2 Subdomain | L3 Capability | Owned By | Supporting Systems\n   298→|link:../domains/loyalty.adoc[Loyalty Domain] | Partner Integration |Partner Account Linking | OTR Digital IT |link:../bounded_context/profile.adoc[Profile Service], link:../bounded_context/interfaces/oauth.adoc[OAuth Service]\n   299→|link:../domains/loyalty.adoc[Loyalty Domain] | Points Ledger | Points Earning & Redemption | OTR Digital IT |link:../bounded_context/loyalty.adoc[Loyalty Service], link:../bounded_context/external/eagle_eye.adoc[EagleEye]\n   300→|link:../domains/loyalty.adoc[Loyalty Domain] | Partner Integration |Partner Points Reconciliation | OTR Digital IT |link:../bounded_context/loyalty.adoc[Loyalty Service], link:../bounded_context/external/flybuys.adoc[Flybuys]\n   301→|link:../domains/loyalty.adoc[Loyalty Domain] | Preference Management |Reward Preference Management | OTR Digital IT |link:../bounded_context/profile.adoc[Profile Service]\n   302→|link:../domains/loyalty.adoc[Loyalty Domain] | Transaction Processing |link:../ubiquitous_language.adoc#Transaction%2520Adjudication[Transaction Adjudication] | OTR Digital IT |link:../bounded_context/loyalty.adoc[Loyalty Service], link:../bounded_context/external/eagle_eye.adoc[EagleEye]\n   303→|link:../domains/loyalty.adoc[Loyalty Domain] | Transaction Processing |Transaction Posting | OTR Digital IT |link:../bounded_context/loyalty.adoc[Loyalty Service], link:../bounded_context/external/flybuys.adoc[Flybuys]\n   304→|link:../domains/loyalty.adoc[Loyalty Domain] | Partner Integration |Real-Time Balance Display | OTR Digital IT |link:../bounded_context/interfaces/mobile.adoc[Mobile Application], link:../bounded_context/loyalty.adoc[Loyalty Service]\n   305→|link:../domains/profile.adoc[Profile Domain] | Customer Profile Management | Mobile Loyalty Credential | OTR Digital IT |link:../bounded_context/interfaces/mobile.adoc[Mobile Application], link:../bounded_context/profile.adoc[Profile Service]\n   306→|link:../domains/profile.adoc[Profile Domain] | Customer Profile Management | POS Loyalty Credential | |link:../bounded_context/interfaces/otr_pos.adoc[OTR POS], link:../bounded_context/interfaces/otr_plus_pos.adoc[OTR+ POS], link:../bounded_context/loyalty.adoc[Loyalty Service]\n   307→|link:../domains/loyalty.adoc[Loyalty Domain] | Partner Integration |Digital Fuel Docket Redemption | |link:../bounded_context/interfaces/otr_pos.adoc[OTR POS], link:../bounded_context/interfaces/otr_plus_pos.adoc[OTR+ POS], link:../bounded_context/loyalty.adoc[Loyalty Service]\n   308→|Infrastructure | Integration | OAuth Token Management | |link:../bounded_context/interfaces/oauth.adoc[OAuth Service]\n   309→|Infrastructure | Integration | Anti-Corruption Layer | |link:../bounded_context/loyalty.adoc[Loyalty Service], link:../bounded_context/profile.adoc[Profile Service]\n   310→|Infrastructure | Event Bus | Event Publishing |  | Event Bus\n   311→|===\n   312→\n   313→==== Value Stream\n   314→\n   315→===== Customer Links Flybuys Digital Identity and earns Flybuys Points\n   316→\n   317→==== OAuth Partner Linking Flow\n   318→\n   319→[source,mermaid]\n   320→----\n   321→sequenceDiagram\n   322→    autonumber\n   323→    actor Customer\n   324→    participant Mobile as Mobile App\n   325→    participant Profile as Profile Service\n   326→    participant FlybuysOAuth as Flybuys OAuth Server\n   327→    participant KeyVault as Azure Key Vault\n   328→    participant DB as Profile Database\n   329→    participant EventBus as Event Bus\n   330→\n   331→    Note over Customer,EventBus: Customer initiates Flybuys account linking\n   332→\n   333→    Customer->>Mobile: Tap \"Link Flybuys Account\"\n   334→\n   335→    activate Mobile\n   336→    Mobile->>Mobile: Generate PKCE code verifier (128 bytes)\n   337→    Mobile->>Mobile: Hash verifier → code challenge (SHA256)\n   338→    Mobile->>FlybuysOAuth: Redirect to OAuth authorize endpoint<br/>?code_challenge=xxx&state=yyy\n   339→    deactivate Mobile\n   340→\n   341→    activate FlybuysOAuth\n   342→    FlybuysOAuth-->>Customer: Show Flybuys login page\n   343→    deactivate FlybuysOAuth\n   344→\n   345→    Customer->>FlybuysOAuth: Enter Flybuys credentials\n   346→    activate FlybuysOAuth\n   347→    FlybuysOAuth->>FlybuysOAuth: Authenticate user\n   348→    FlybuysOAuth-->>Customer: Show consent screen<br/>\"OTR wants to access your account\"\n   349→    deactivate FlybuysOAuth\n   350→\n   351→    Customer->>FlybuysOAuth: Approve consent\n   352→    activate FlybuysOAuth\n   353→    FlybuysOAuth->>FlybuysOAuth: Generate authorization code\n   354→    FlybuysOAuth-->>Mobile: Redirect callback<br/>?code=AUTH_CODE&state=yyy\n   355→    deactivate FlybuysOAuth\n   356→\n   357→    activate Mobile\n   358→    Mobile->>Mobile: Verify state parameter (CSRF protection)\n   359→    Mobile->>Profile: POST /partners<br/>{oauthCode, codeVerifier}\n   360→    deactivate Mobile\n   361→\n   362→    activate Profile\n   363→    Profile->>FlybuysOAuth: POST /token<br/>{code, code_verifier, client_id}\n   364→    activate FlybuysOAuth\n   365→    FlybuysOAuth->>FlybuysOAuth: Verify code_verifier matches challenge\n   366→    FlybuysOAuth-->>Profile: {access_token, refresh_token, expires_in: 3600}\n   367→    deactivate FlybuysOAuth\n   368→\n   369→    Profile->>FlybuysOAuth: GET /member/profile<br/>Authorization: Bearer {access_token}\n   370→    activate FlybuysOAuth\n   371→    FlybuysOAuth-->>Profile: {externalMemberId: \"123456789012\"}\n   372→    deactivate FlybuysOAuth\n   373→\n   374→    Profile->>KeyVault: Store tokens<br/>SecretName: flybuys-token-{vci}\n   375→    activate KeyVault\n   376→    KeyVault->>KeyVault: Encrypt with AES-256\n   377→    KeyVault-->>Profile: {secretReference}\n   378→    deactivate KeyVault\n   379→\n   380→    Profile->>DB: Create PartnerLink aggregate<br/>{status: \"LINKED\", oauthTokenRef}\n   381→    activate DB\n   382→    DB-->>Profile: PartnerLink persisted\n   383→    deactivate DB\n   384→\n   385→    Profile->>EventBus: Publish PartnerLinked event<br/>{vivaConsumerId, partner: \"FLYBUYS\"}\n   386→    activate EventBus\n   387→    EventBus-->>Profile: Event published\n   388→    deactivate EventBus\n   389→\n   390→    Profile-->>Mobile: 201 Created<br/>{partnerLinkId, status: \"LINKED\"}\n   391→    deactivate Profile\n   392→\n   393→    activate Mobile\n   394→    Mobile-->>Customer: \"Flybuys account linked successfully!\"\n   395→    deactivate Mobile\n   396→\n   397→    Note over Customer,EventBus: Total flow: 2-3 minutes (user interaction time)\n   398→----\n   399→\n   400→==== Transaction Adjudication Flow\n   401→\n   402→[source,mermaid]\n   403→----\n   404→sequenceDiagram\n   405→    autonumber\n   406→    actor Customer\n   407→    participant POS as POS Terminal<br/>(OTR/OTR+)\n   408→    participant Loyalty as Loyalty Service\n   409→    participant Profile as Profile Service\n   410→    participant EagleEye as EagleEye API\n   411→    participant DB as Loyalty Database\n   412→    participant EventBus as Event Bus\n   413→\n   414→    Note over Customer,EventBus: Customer has Flybuys linked, preference = FLYBUYS_POINTS\n   415→\n   416→    Customer->>POS: Scan Flybuys barcode\n   417→    POS->>Loyalty: POST /credentials/resolve<br/>{barcode: \"EAN13\"}\n   418→\n   419→    activate Loyalty\n   420→    Note over Loyalty: Credential Resolution\n   421→    Loyalty->>Loyalty: Decode barcode → externalMemberId\n   422→    Loyalty->>Profile: GET /partners?externalMemberId=xxx\n   423→    activate Profile\n   424→    Profile->>Profile: Query PartnerLink by externalMemberId\n   425→    Profile-->>Loyalty: {vivaConsumerId, rewardPreference: \"FLYBUYS_POINTS\"}\n   426→    deactivate Profile\n   427→    Loyalty-->>POS: {vivaConsumerId, walletId, rewardPreference}\n   428→    deactivate Loyalty\n   429→\n   430→    Note over Customer,EventBus: Resolution: <100ms p95\n   431→\n   432→    Customer->>POS: Complete purchase ($75.50)\n   433→    POS->>Loyalty: POST /transactions/adjudicate<br/>{vivaConsumerId, transaction}\n   434→\n   435→    activate Loyalty\n   436→    Note over Loyalty: Transaction Adjudication\n   437→    Loyalty->>EagleEye: POST /adjudication<br/>{walletId, transaction}\n   438→    activate EagleEye\n   439→    EagleEye->>EagleEye: Apply earning rules<br/>Base: 100 pts, Bonus: 50 pts\n   440→    EagleEye-->>Loyalty: {grants: [{partner: \"FLYBUYS\", points: 150}]}\n   441→    deactivate EagleEye\n   442→\n   443→    Note over Loyalty: Total adjudication: <300ms p95\n   444→\n   445→    Loyalty->>DB: Persist RewardTransaction<br/>{status: \"PENDING\"}\n   446→    activate DB\n   447→    DB-->>Loyalty: Transaction saved\n   448→    deactivate DB\n   449→\n   450→    Loyalty->>EventBus: Publish TransactionAdjudicated event\n   451→    activate EventBus\n   452→    EventBus-->>Loyalty: Event published\n   453→    deactivate EventBus\n   454→\n   455→    Loyalty-->>POS: {status: \"SUCCESS\", points: 150}\n   456→    deactivate Loyalty\n   457→\n   458→    Note over Loyalty,POS: Total response: <500ms p95\n   459→\n   460→    POS-->>Customer: Receipt: \"150 Flybuys points pending\"\n   461→\n   462→    Note over Customer,EventBus: Points post to Flybuys within 24 hours via batch\n   463→----\n   464→\n   465→===== Detailed Sequence Diagrams\n   466→\n   467→The diagrams above show happy path flows for business stakeholder understanding. For comprehensive implementation details including error scenarios, see link:../solution_architectures/flybuys_integration.adoc[sequence_diagrams/Flybuys Integration Flows].\n   468→\n   469→*Available detailed flows:*\n   470→\n   471→* *Transaction Adjudication* - Happy path + 3 error scenarios (Profile Service timeout, EagleEye circuit breaker, duplicate transaction handling)\n   472→* *OAuth Partner Linking* - Happy path + 3 error scenarios (authorization denied, token exchange failure, partner already linked)\n   473→* *Batch File Processing* - Happy path + 2 error scenarios (SFTP timeout with retry logic, partial batch rejection)\n   474→* *Circuit Breaker* - State transitions (CLOSED → OPEN → HALF_OPEN) with recovery logicL\n   475→* *Event Propagation* - Timeline showing eventual consistency window and out-of-order event handling\n   476→* *OAuth Token Refresh* - Proactive refresh (50-minute timer) + error scenarios (token expiry, API unavailable)\n   477→\n   478→[width=\"100%\",cols=\"17%,31%,14%,3%,16%,19%\",options=\"header\",]\n   479→|===\n   480→|Actor | Activity | System | Duration | Value Added | Pain Points / Waste\n   481→|link:../ubiquitous_language.adoc#Customer[Customer] | Initiate\n   482→link:../ubiquitous_language.adoc#Flybuys%2520Digital%2520Identity[Flybuys\n   483→Digital Identity] linking\n   484→|link:../bounded_context/interfaces/mobile.adoc[Mobile\n   485→Application] | 2 min | Enables coalition loyalty | OAuth redirect\n   486→confusing, trust concerns\n   487→\n   488→|link:../ubiquitous_language.adoc#Customer[Customer] | Approve account\n   489→linking | link:../bounded_context/external/flybuys.adoc[Flybuys] OAuth | 30\n   490→sec | Authorise data sharing | External site navigation, security warnings\n   491→\n   492→|link:../bounded_context/profile.adoc[Profile Service] | Store\n   493→link:../ubiquitous_language.adoc#Partner%2520Link[Partner Link]\n   494→|link:../bounded_context/profile.adoc[Profile Service],\n   495→link:../bounded_context/interfaces/oauth.adoc[OAuth Service] | <\n   496→1 sec | Persist linking status | None\n   497→\n   498→|link:../bounded_context/profile.adoc[Profile Service] | Publish\n   499→link:../bounded_context/profile.adoc#Events[PartnerLinked] event\n   500→|Event Bus | < 5 sec | Notify downstream systems | None\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"41285b78-e3dd-40c7-a5d8-1641c9b216ae","timestamp":"2026-01-09T04:57:19.769Z","toolUseResult":{"type":"text","file":{"filePath":"/mnt/c/Users/o.young/work/architecture/architecture_definitions/flybuys_integration.adoc","content":"= Flybuys Integration - Architecture Definition\n:project-name: OTR-002\n:togaf-adm-phase: Phase C: Information Systems Architectures\n:document-type: Architecture Definition Document\n:status: Discovery\n:version: 0.1\n:domain: Loyalty\n:programme-lead: Frankie.Mullaly@vivaenergy.com.au\n:domain-architect: O.Young@otr.com.au\n:business-owner: D.Peisley@otr.com.au\n:business-analyst: Fiona.Cheung@vivaenergy.com.au\n:solution-architecture: link:/solution_architectures/flybuys_integration.adoc[Solution Architectures/Flybuys Integration]\n:doctype: article\n:toc: left\n:toclevels: 4\n:sectanchors:\n:sectlinks:\n:sectnums:\n:icons: font\n:source-highlighter: highlightjs\n:experimental:\n:description: Architecture Definition Document for Flybuys Coalition Loyalty Integration\n:keywords: loyalty, flybuys, integration, architecture-definition, togaf, ddd\n\n== Introduction & Vision\n\n=== Purpose\n\nOTR and Reddy Express customers experience fragmented loyalty programmes across the OTRG store network. REXP stores use manual Flybuys batch processing, OTR stores offer native rewards, and no digital coalition partner linking exists. This limits customer choice, creates operational overhead, and constrains competitive positioning against national chains with integrated loyalty programmes.\n\n=== Vision\n\n> Enable customers to seamlessly link coalition loyalty partners via mobile app, select their reward preference, and earn partner points at any OTR/REXP store—while maintaining architectural flexibility to evolve OTR’s native loyalty capability independently.\n\n=== Architectural Approach\n\nThis architecture introduces three bounded contexts (link:../bounded_context/profile.adoc[Profile Service], link:../bounded_context/loyalty.adoc[Loyalty Service], link:../bounded_context/engagement.adoc[Engagement Service]) implementing Domain-Driven Design patterns:\n\n* *link:../bounded_context/profile.adoc[Profile Service]*: Partner account linking (OAuth 2.0), reward preference management, canonical customer identity (VCI)\n* *link:../bounded_context/loyalty.adoc[Loyalty Service]*: Transaction adjudication, credential resolution, partner integration facade, automated batch posting\n* *link:../bounded_context/engagement.adoc[Engagement Service]*: Customer engagement campaigns, notification orchestration, Braze Anti-Corruption Layer\n* *Event-driven integration*: Loose coupling via Event Bus with published domain events\n* *Anti-Corruption Layers*: Isolation from external systems (link:../bounded_context/external/braze.adoc[Braze], link:../bounded_context/external/eagle_eye.adoc[EagleEye], link:../bounded_context/external/flybuys.adoc[Flybuys], link:../bounded_context/external/microsoft_dynamics_365_commerce.adoc[D365 Commerce])\n* *Phased rollout*: Parallel deployment alongside legacy link:../bounded_context/interfaces/otr_app_api.adoc[OTR App API] with feature flag-controlled gradual enablement (link:#AS-1_Foundation[AS-1 Foundation] → link:#AS-2_Linking[AS-2 Linking] → link:#AS-3_Grants[AS-3 Grants]) The link:../bounded_context/profile.adoc[Profile Service] also serves as a facade for link:../bounded_context/interfaces/otr_pos.adoc[OTR POS] integration to link:../bounded_context/external/salesforce_crm.adoc[Salesforce CRM] before the #Highlander programme.\n\n=== Architecture Overview\n\nThe following diagram shows the target state architecture with three new bounded contexts (Profile Service, Loyalty Service, Engagement Service) integrating with existing systems:\n\n[mermaid]\n----\n---\nlayout: elk\n---\nflowchart LR\n    Customer([\"Customer\"]) -- Uses --> MobileApp[\"Mobile App<br>iOS/Android\"]\n    Customer -- Shops at --> POS[\"OTR/OTR+ POS<br>D365 Commerce\"]\n    Customer -- Receives --> EngagementService[\"Engagement Service<br>Campaign Triggers<br>Customer Notifications<br>Braze Integration\"]\n    MobileApp -- Authenticate --> EntraID[\"Microsoft Entra<br>External ID<br>CIAM\"]\n    MobileApp -- \"Link Partner Account<br>OAuth 2.0 + PKCE\" --> ProfileService[\"Profile Service<br>Partner Account Linking<br>Reward Preferences\"]\n    MobileApp -- Get Partner Links<br>Update Preferences --> ProfileService\n    MobileApp -- Query Flybuys Balance<br>via ACL --> LoyaltyService[\"Loyalty Service<br>Transaction Adjudication<br>Credential Resolution<br>Batch Processing\"]\n    POS -- Scan Loyalty Credential<br>Resolve to VCI --> LoyaltyService\n    POS -- \"Transaction Adjudication<br>Real-time &lt;500ms\" --> LoyaltyService\n    ProfileService -- \"Store OAuth Tokens<br>AES-256 Encrypted\" --> OAuthService[\"OAuth Service<br>Token Management\"]\n    ProfileService -- Query Customer Profile<br>Conformist --> Salesforce[\"Salesforce CRM<br>Customer Profile<br>System of Record\"]\n    ProfileService -- Publish Events<br>PartnerLinked<br>RewardPreferenceChanged --> EventBus[(\"Event Bus<br>Domain Events\")]\n    LoyaltyService -- Transaction Adjudication<br>via ACL --> EagleEye[\"EagleEye<br>Loyalty Engine<br>Points, Offers, Wallet\"]\n    LoyaltyService -- Query Wallet/Points/Tiers<br>via ACL --> EagleEye\n    LoyaltyService -- Nightly Batch SFTP<br>PGP Encrypted --> Flybuys[\"Flybuys<br>Coalition Partner<br>OAuth, SFTP\"]\n    LoyaltyService -- OAuth Balance Query<br>via ACL --> Flybuys\n    LoyaltyService -- Query Reward Preference<br>REST API --> ProfileService\n    LoyaltyService -- Publish Events<br>TransactionAdjudicated<br>PointsEarned --> EventBus\n    EngagementService -- Consume Events<br>PartnerLinked<br>TransactionAdjudicated<br>PointsEarned --> EventBus\n    EngagementService -- Trigger Campaigns<br>Push Notifications<br>via ACL --> Braze[\"Braze<br>Marketing Automation<br>Webhooks\"]\n    EngagementService -- Query Customer Profile<br>Conformist --> Salesforce\n    OAuthService -- OAuth Token Exchange<br>Authorization Code Flow --> Flybuys\n\n     Customer:::customer\n     MobileApp:::presentation\n     POS:::presentation\n     EngagementService:::newService\n     EntraID:::external\n     ProfileService:::newService\n     LoyaltyService:::newService\n     OAuthService:::infrastructure\n     Salesforce:::external\n     EventBus:::infrastructure\n     EagleEye:::external\n     Flybuys:::external\n     Braze:::external\n    classDef newService fill:#4CAF50,stroke:#2E7D32,stroke-width:3px,color:#fff\n    classDef external fill:#FF9800,stroke:#E65100,stroke-width:2px,color:#fff\n    classDef infrastructure fill:#2196F3,stroke:#0D47A1,stroke-width:2px,color:#fff\n    classDef presentation fill:#9C27B0,stroke:#4A148C,stroke-width:2px,color:#fff\n    classDef customer fill:#607D8B,stroke:#263238,stroke-width:2px,color:#fff\n----\n\n==== Key Architectural Patterns\n\n[width=\"100%\",cols=\"19%,34%,47%\",options=\"header\",]\n|===\n|Pattern | Application | Rationale\n|*Anti-Corruption Layer (ACL)* | LoyaltyService → EagleEye, FlybuysEngagementService → Braze | Isolates domain model from external system changes, translates between bounded contexts\n|*Customer-Supplier + Conformist* | ProfileService → SalesforceEngagementService → Salesforce | We conform to Salesforce API (external system we don’t control)\n|*Backend-for-Frontend (BFF)* | LoyaltyService | Orchestrates multiple backend systems (EagleEye, ProfileService) for POS/Mobile clients\n|*Event-Driven Architecture* | Event Bus (OHS+PL) | Loose coupling between bounded contexts, asynchronous notification of domain events\n|*Event Consumer* | EngagementService | Consumes domain events from Profile and Loyalty contexts to trigger customer campaigns\n|*OAuth 2.0 + PKCE* | ProfileService → Flybuys | Secure partner account linking without storing passwords\n|*Strangler Fig* | Parallel deployment with feature flags | Gradual migration to new bounded contexts\n|===\n\n== Technical Requirements\n\n[width=\"100%\",cols=\"4%,96%\",options=\"header\",]\n|===\n|ID | Description\n|TR-001 | Every link:../bounded_context/interfaces/mobile.adoc[Mobile Application] user has a link:../ubiquitous_language.adoc#Salesforce%2520Contact[Salesforce Contact] record in link:../bounded_context/external/salesforce_crm.adoc[Salesforce CRM]\n|TR-002 | Every link:../bounded_context/interfaces/mobile.adoc[Mobile Application] user has a link:../ubiquitous_language.adoc#Viva%2520Consumer%2520ID[VCI] part of their link:../ubiquitous_language.adoc#Loyalty%2520Credential[Loyalty Credentials]\n|TR-003 | Every link:../bounded_context/interfaces/mobile.adoc[Mobile Application] user has a link:../ubiquitous_language.adoc#Wallet[Loyalty Wallet] part of their link:../ubiquitous_language.adoc#Loyalty%2520Credential[Loyalty Credentials]\n|TR-004 | link:../ubiquitous_language.adoc#Customer[Customers] have a single set of link:../ubiquitous_language.adoc#Loyalty%2520Credential[Loyalty Credentials]\n|TR-005 | link:../ubiquitous_language.adoc#Customer[Customers] are able to link and unlink their link:../ubiquitous_language.adoc#Flybuys%2520Digital%2520Identity[Flybuys Digital Identity] from any link:../bounded_context/interfaces/mobile.adoc[Mobile Application]\n|TR-006 | link:../ubiquitous_language.adoc#Customer[Customers] can manage their link:../ubiquitous_language.adoc#Reward%2520Preference[Reward Preference] (select and retain preference)\n|TR-007 | link:../bounded_context/external/flybuys.adoc[Flybuys] link:../ubiquitous_language.adoc#Partner[Partner] transactions are posted to link:../bounded_context/external/flybuys.adoc[Flybuys] for points allocation to link:../ubiquitous_language.adoc#Flybuys%2520Earning%2520Rules[Earning Rules]\n|TR-008 | link:../bounded_context/interfaces/otr_pos.adoc[OTR POS] stores recognise all link:../ubiquitous_language.adoc#Loyalty%2520Credential[Loyalty Credentials] and grant Flybuys Points on fulfilled Transactions where a Customer has a linked Flybuys Digital Identity\n|TR-009 | link:../bounded_context/interfaces/otr_plus_pos.adoc[OTR+ POS] stores recognise all link:../ubiquitous_language.adoc#Loyalty%2520Credential[Loyalty Credentials] and grant Flybuys Points on fulfilled Transactions where a Customer has a linked Flybuys Digital Identity\n|TR-010 | link:../ubiquitous_language.adoc#Customer[Customers] can retrieve their link:../bounded_context/external/flybuys.adoc[Flybuys] points balance in real-time within any link:../bounded_context/interfaces/mobile.adoc[Mobile Application]\n|[line-through]*TR-011* |[line-through]*link:../bounded_context/external/flybuys.adoc[Flybuys] link:../ubiquitous_language.adoc#Digital%2520Fuel%2520Dockets[Digital Fuel Dockets] are redeemable at link:../bounded_context/interfaces/otr_pos.adoc[OTR POS] and link:../bounded_context/interfaces/otr_plus_pos.adoc[OTR+ POS]*\n|TR-012 | All transactions by link:../ubiquitous_language.adoc#Loyalty%2520Credential[Credentialed] link:../ubiquitous_language.adoc#Customer[Customers] through any channel are adjudicated by link:../bounded_context/external/eagle_eye.adoc[EagleEye]\n|TR-013 | Web and Mobile Clients geographically show which Loyalty programmes are available at each store\n|TR-014 | All changes are communicated using a decoupled event-based architecture\n|TR-015 | ==Reporting==\n|TR-016 | ==Customer Service==\n|===\n\n=== Technical Requirements Mapping\n\n[cols=\",\",options=\"header\",]\n|===\n|Business Requirement | Technical Requirement\n|LNKHL_001 | TR-005\n|LNKHL_002 | TR-005\n|LNKHL_003 | TR-004\n|LNKHL_004 | TR-005\n|LNKHL_005 | TR-005\n|LNKHL_006 | TR-014\n|LNKHL_007 | TR-014\n|LNKHL_008 | TR-014\n|LNKHL_009 | TR-014\n|NTWHL_001 | TR-012\n|NTWHL_002 | TR-012\n|NTWHL_003 | TR-013\n|NTWHL_003 | TR-013\n|PEHL_001 | TR-012\n|PEHL_002 |\n|PEHL_003 | TR-010\n|PEHL_004 | TR-012\n|INAHL_001 | TR-008 TR-009\n|INAHL_002 | TR-008 TR-009\n|INAHL_003 | TR-008 TR-009\n|INAHL_004 | TR-008 TR-009\n|INAHL_005 | TR-008 TR-009\n|INAHL_006 | TR-008 TR-009\n|INSHL_001 | TR-008 TR-009\n|INSHL_002 | TR-014\n|TCRHL_001 | TR-007\n|TCRHL_002 | TR-015\n|TCRHL_003 | TR-015\n|TCRHL_004 | TR-015\n|TCRHL_005 | TR-015\n|TCRHL_006 | TR-015\n|TCRHL_007 | TR-015\n|CEHL_001 | TR-016\n|CEHL_002 | TR-016\n|CEHL_003 | TR-016\n|===\n\n=== Stakeholder Analysis\n\n[width=\"100%\",cols=\"20%,28%,10%,11%,31%\",options=\"header\",]\n|===\n|Stakeholder | Role | Interest Level | Influence Level | Engagement Strategy\n|Darren Peisley | Business Owner | High | High | Steering, requirements sign-off\n|Amin Joderyi | Mobile Application and Ecommerce Lead | High | High |Collaboration\n|Frankie Mullaly | Programme Lead | High | Medium | Status updates, escalation point\n|Oli Young | Domain Architect | High | High | Collaboration, architecture decisions\n|Fiona Cheung | Business Analyst | Medium | Medium | Requirements gathering, documentation\n|David Le Pham | Product Owner | High | High | Product decisions, prioritisation\n|Paola Buchan | Marketing & Campaigns Lead | High | Medium | Campaign planning, promotional strategy\n|Nick Cannizzo | Project Manager | High | Low | Programme coordination\n|Mobile App Users | End Users | High | Low | Beta testing programme, feedback surveys\n|link:../bounded_context/external/flybuys.adoc[Flybuys] | External Partner |Medium | Medium | Coordination, API support\n|link:../bounded_context/external/eagle_eye.adoc[EagleEye] | SaaS Loyalty Platform Vendor | Medium | Medium | Business reviews, support tickets\n|D365 Team | POS Operations | Medium | Medium | Training sessions, operational readiness\n|Customer Support Team | Support & Troubleshooting | Medium | Low |Training, escalation procedures\n|Fullstack Team | CRM Integration | Low | Low | Integration coordination\n|Platform Infrastructure | Cloud Platform | Low | High | Deployment planning, capacity planning\n|Data Team | Data Integration | Low | Medium | Data pipeline coordination\n|===\n\n=== Baseline Architecture\n\n==== Current Business Capability\n\n[width=\"100%\",cols=\"19%,7%,9%,4%,57%,4%\",options=\"header\",]\n|===\n|L1 Domain | L2 Subdomain | L3 Capability | Owned By | Supporting Systems |Maturity Level\n|link:../domains/loyalty.adoc[Loyalty Domain] | Preference Management |Reward Preference Management | Loyalty Team\n|link:../bounded_context/external/salesforce_crm.adoc[Salesforce CRM] (manual updates via link:../bounded_context/external/flybuys.adoc[Flybuys]) | Initial\n|link:../domains/loyalty.adoc[Loyalty Domain] | Transaction Processing |Transaction Adjudication | Loyalty Team |link:../bounded_context/interfaces/otr_plus_pos.adoc[OTR+ POS], link:../bounded_context/external/coupon_scanner.adoc[Coupon Scanner], link:../bounded_context/external/eagle_eye.adoc[EagleEye] | Managed\n|link:../domains/loyalty.adoc[Loyalty Domain] | Transaction Processing |Transaction Posting | Loyalty Team | CSV export, SFTP upload | Initial\n|link:../domains/engagement.adoc[Engagement Domain] | Channel Recognition | Mobile Loyalty Credential | Mobile Team\n|link:../bounded_context/interfaces/mobile.adoc[Mobile Application], link:../bounded_context/interfaces/otr_app_api.adoc[OTR App API] | Managed\n|link:../domains/engagement.adoc[Engagement Domain] | Channel Recognition | POS Loyalty Credential | D365 Team |link:../bounded_context/interfaces/otr_pos.adoc[OTR POS], link:../bounded_context/interfaces/otr_plus_pos.adoc[OTR+ POS] | Managed\n|link:../domains/engagement.adoc[Engagement Domain] | Personalised Offers | Digital Fuel Docket Redemption | Loyalty Team |link:../bounded_context/interfaces/otr_plus_pos.adoc[OTR+ POS], link:../bounded_context/external/coupon_scanner.adoc[Coupon Scanner], link:../bounded_context/external/eagle_eye.adoc[EagleEye] | Managed\n|Infrastructure | Partner Integration | Directly Coupled | Platform Team |Direct coupling to external systems | Managed\n|===\n\n==== Current Value Stream\n\n===== Customer Redeems Flybuys Fuel Discount\n\n[mermaid]\n----\nsequenceDiagram\n    actor Customer\n    participant Scanner as Coupon Scanner\n    participant POS as OTR+ POS\n    participant D365 as D365 Commerce\n    participant DataTeam as Data Team\n    participant SQL as SQL Database\n    participant SFTP as SFTP Server\n    participant Flybuys as Flybuys\n    participant Support as Call Centre\n\n    Customer->>Scanner: Present Flybuys card\n    Scanner-->>Customer: Scan fuel docket barcode\n\n    Customer->>POS: Make purchase (fuel/products)\n    POS->>D365: Process transaction\n    D365-->>POS: Transaction recorded\n    POS-->>Customer: Receipt (no points confirmation)\n\n    Note over Customer,Flybuys: Manual Batch Process (Next Day)\n\n    DataTeam->>SQL: Run SQL query\n    SQL-->>DataTeam: Transaction data\n    DataTeam->>DataTeam: Generate CSV file manually\n    DataTeam->>SFTP: Manual SFTP upload\n\n    Note over SFTP,Flybuys: 24+ Hour Delay\n\n    Flybuys->>SFTP: Retrieve batch file\n    Flybuys->>Flybuys: Process transactions\n    Flybuys->>Flybuys: Credit points to member account\n\n    alt Customer checks points before batch processing\n        Customer->>Support: Call support (missing points)\n        Support->>Support: Manual investigation (10-15 min)\n        Support->>SQL: Query transaction status\n        Support-->>Customer: \"Points will appear in 24-48 hours\"\n    end\n\n    Note over Customer,Flybuys: Pain Points:<br/>- No real-time adjudication<br/>- Manual CSV export/upload<br/>- 24+ hour delay<br/>- No retry logic<br/>- High support burden\n----\n\n[width=\"100%\",cols=\"21%,30%,15%,4%,13%,17%\",options=\"header\",]\n|===\n|Actor | Activity | System | Duration | Value Added | Pain Points / Waste\n|link:../ubiquitous_language.adoc#Customer[Customer] | Present link:../ubiquitous_language.adoc#Flybuys%2520Cardholder%2520Number[Flybuys Card] | link:../bounded_context/external/coupon_scanner.adoc[Coupon Scanner] | < 1 Sec | None | Significant delay, manual reconciliation\n|link:../ubiquitous_language.adoc#Customer[Customer] | Makes purchase (fuel/products) | link:../bounded_context/interfaces/otr_plus_pos.adoc[OTR+ POS] | < 1 Sec | Complete transaction | No real-time points confirmation at POS\n|link:../bounded_context/interfaces/otr_pos.adoc[OTR POS] | Process transaction\n|link:../bounded_context/external/microsoft_dynamics_365_commerce.adoc[Microsoft Dynamics 365 Commerce] | < 1 sec | Record transaction | No immediate adjudication\n|link:../bounded_context/external/flybuys.adoc[Flybuys] | Process batch file | link:../bounded_context/external/flybuys.adoc[Flybuys] | > 24 hours |Credit points to member account | Processing time outside OTR control\n|Data Team | Export Flybuys transactions | Automated SQL query, CSV generation | Automated | Prepare Flybuys batch file |\n|Data Team | Upload to Flybuys SFTP | AutomatedSFTP upload | Automated |Post transactions to Flybuys | Automated upload, no retry logic\n|Customer | Call support if issue | Call centre | 10-15 min | Troubleshoot missing points | High support burden, manual investigation\n|===\n\n==== Pain Points\n\n[width=\"100%\",cols=\"16%,38%,46%\",options=\"header\",]\n|===\n|Category | Pain Point | Business Impact\n|Customer Experience | No linking process | Low adoption, no communication permissions\n|Customer Experience | No visibility of Flybuys balance in OTR app |Customer confusion, support calls\n|Integration | Tight coupling to link:../bounded_context/external/eagle_eye.adoc[EagleEye] and link:../bounded_context/external/flybuys.adoc[Flybuys] APIs | Brittle integration, difficult to change partners\n|Compliance | No just-in-time transaction adjudication | Loyalty is pushed to stores causing scaling and timing issues\n|===\n\n=== Target State Architecture\n\n==== Business Capability\n\n[width=\"100%\",cols=\"12%,15%,41%,7%,25%\",options=\"header\",]\n|===\n|L1 Domain | L2 Subdomain | L3 Capability | Owned By | Supporting Systems\n|link:../domains/loyalty.adoc[Loyalty Domain] | Partner Integration |Partner Account Linking | OTR Digital IT |link:../bounded_context/profile.adoc[Profile Service], link:../bounded_context/interfaces/oauth.adoc[OAuth Service]\n|link:../domains/loyalty.adoc[Loyalty Domain] | Points Ledger | Points Earning & Redemption | OTR Digital IT |link:../bounded_context/loyalty.adoc[Loyalty Service], link:../bounded_context/external/eagle_eye.adoc[EagleEye]\n|link:../domains/loyalty.adoc[Loyalty Domain] | Partner Integration |Partner Points Reconciliation | OTR Digital IT |link:../bounded_context/loyalty.adoc[Loyalty Service], link:../bounded_context/external/flybuys.adoc[Flybuys]\n|link:../domains/loyalty.adoc[Loyalty Domain] | Preference Management |Reward Preference Management | OTR Digital IT |link:../bounded_context/profile.adoc[Profile Service]\n|link:../domains/loyalty.adoc[Loyalty Domain] | Transaction Processing |link:../ubiquitous_language.adoc#Transaction%2520Adjudication[Transaction Adjudication] | OTR Digital IT |link:../bounded_context/loyalty.adoc[Loyalty Service], link:../bounded_context/external/eagle_eye.adoc[EagleEye]\n|link:../domains/loyalty.adoc[Loyalty Domain] | Transaction Processing |Transaction Posting | OTR Digital IT |link:../bounded_context/loyalty.adoc[Loyalty Service], link:../bounded_context/external/flybuys.adoc[Flybuys]\n|link:../domains/loyalty.adoc[Loyalty Domain] | Partner Integration |Real-Time Balance Display | OTR Digital IT |link:../bounded_context/interfaces/mobile.adoc[Mobile Application], link:../bounded_context/loyalty.adoc[Loyalty Service]\n|link:../domains/profile.adoc[Profile Domain] | Customer Profile Management | Mobile Loyalty Credential | OTR Digital IT |link:../bounded_context/interfaces/mobile.adoc[Mobile Application], link:../bounded_context/profile.adoc[Profile Service]\n|link:../domains/profile.adoc[Profile Domain] | Customer Profile Management | POS Loyalty Credential | |link:../bounded_context/interfaces/otr_pos.adoc[OTR POS], link:../bounded_context/interfaces/otr_plus_pos.adoc[OTR+ POS], link:../bounded_context/loyalty.adoc[Loyalty Service]\n|link:../domains/loyalty.adoc[Loyalty Domain] | Partner Integration |Digital Fuel Docket Redemption | |link:../bounded_context/interfaces/otr_pos.adoc[OTR POS], link:../bounded_context/interfaces/otr_plus_pos.adoc[OTR+ POS], link:../bounded_context/loyalty.adoc[Loyalty Service]\n|Infrastructure | Integration | OAuth Token Management | |link:../bounded_context/interfaces/oauth.adoc[OAuth Service]\n|Infrastructure | Integration | Anti-Corruption Layer | |link:../bounded_context/loyalty.adoc[Loyalty Service], link:../bounded_context/profile.adoc[Profile Service]\n|Infrastructure | Event Bus | Event Publishing |  | Event Bus\n|===\n\n==== Value Stream\n\n===== Customer Links Flybuys Digital Identity and earns Flybuys Points\n\n==== OAuth Partner Linking Flow\n\n[source,mermaid]\n----\nsequenceDiagram\n    autonumber\n    actor Customer\n    participant Mobile as Mobile App\n    participant Profile as Profile Service\n    participant FlybuysOAuth as Flybuys OAuth Server\n    participant KeyVault as Azure Key Vault\n    participant DB as Profile Database\n    participant EventBus as Event Bus\n\n    Note over Customer,EventBus: Customer initiates Flybuys account linking\n\n    Customer->>Mobile: Tap \"Link Flybuys Account\"\n\n    activate Mobile\n    Mobile->>Mobile: Generate PKCE code verifier (128 bytes)\n    Mobile->>Mobile: Hash verifier → code challenge (SHA256)\n    Mobile->>FlybuysOAuth: Redirect to OAuth authorize endpoint<br/>?code_challenge=xxx&state=yyy\n    deactivate Mobile\n\n    activate FlybuysOAuth\n    FlybuysOAuth-->>Customer: Show Flybuys login page\n    deactivate FlybuysOAuth\n\n    Customer->>FlybuysOAuth: Enter Flybuys credentials\n    activate FlybuysOAuth\n    FlybuysOAuth->>FlybuysOAuth: Authenticate user\n    FlybuysOAuth-->>Customer: Show consent screen<br/>\"OTR wants to access your account\"\n    deactivate FlybuysOAuth\n\n    Customer->>FlybuysOAuth: Approve consent\n    activate FlybuysOAuth\n    FlybuysOAuth->>FlybuysOAuth: Generate authorization code\n    FlybuysOAuth-->>Mobile: Redirect callback<br/>?code=AUTH_CODE&state=yyy\n    deactivate FlybuysOAuth\n\n    activate Mobile\n    Mobile->>Mobile: Verify state parameter (CSRF protection)\n    Mobile->>Profile: POST /partners<br/>{oauthCode, codeVerifier}\n    deactivate Mobile\n\n    activate Profile\n    Profile->>FlybuysOAuth: POST /token<br/>{code, code_verifier, client_id}\n    activate FlybuysOAuth\n    FlybuysOAuth->>FlybuysOAuth: Verify code_verifier matches challenge\n    FlybuysOAuth-->>Profile: {access_token, refresh_token, expires_in: 3600}\n    deactivate FlybuysOAuth\n\n    Profile->>FlybuysOAuth: GET /member/profile<br/>Authorization: Bearer {access_token}\n    activate FlybuysOAuth\n    FlybuysOAuth-->>Profile: {externalMemberId: \"123456789012\"}\n    deactivate FlybuysOAuth\n\n    Profile->>KeyVault: Store tokens<br/>SecretName: flybuys-token-{vci}\n    activate KeyVault\n    KeyVault->>KeyVault: Encrypt with AES-256\n    KeyVault-->>Profile: {secretReference}\n    deactivate KeyVault\n\n    Profile->>DB: Create PartnerLink aggregate<br/>{status: \"LINKED\", oauthTokenRef}\n    activate DB\n    DB-->>Profile: PartnerLink persisted\n    deactivate DB\n\n    Profile->>EventBus: Publish PartnerLinked event<br/>{vivaConsumerId, partner: \"FLYBUYS\"}\n    activate EventBus\n    EventBus-->>Profile: Event published\n    deactivate EventBus\n\n    Profile-->>Mobile: 201 Created<br/>{partnerLinkId, status: \"LINKED\"}\n    deactivate Profile\n\n    activate Mobile\n    Mobile-->>Customer: \"Flybuys account linked successfully!\"\n    deactivate Mobile\n\n    Note over Customer,EventBus: Total flow: 2-3 minutes (user interaction time)\n----\n\n==== Transaction Adjudication Flow\n\n[source,mermaid]\n----\nsequenceDiagram\n    autonumber\n    actor Customer\n    participant POS as POS Terminal<br/>(OTR/OTR+)\n    participant Loyalty as Loyalty Service\n    participant Profile as Profile Service\n    participant EagleEye as EagleEye API\n    participant DB as Loyalty Database\n    participant EventBus as Event Bus\n\n    Note over Customer,EventBus: Customer has Flybuys linked, preference = FLYBUYS_POINTS\n\n    Customer->>POS: Scan Flybuys barcode\n    POS->>Loyalty: POST /credentials/resolve<br/>{barcode: \"EAN13\"}\n\n    activate Loyalty\n    Note over Loyalty: Credential Resolution\n    Loyalty->>Loyalty: Decode barcode → externalMemberId\n    Loyalty->>Profile: GET /partners?externalMemberId=xxx\n    activate Profile\n    Profile->>Profile: Query PartnerLink by externalMemberId\n    Profile-->>Loyalty: {vivaConsumerId, rewardPreference: \"FLYBUYS_POINTS\"}\n    deactivate Profile\n    Loyalty-->>POS: {vivaConsumerId, walletId, rewardPreference}\n    deactivate Loyalty\n\n    Note over Customer,EventBus: Resolution: <100ms p95\n\n    Customer->>POS: Complete purchase ($75.50)\n    POS->>Loyalty: POST /transactions/adjudicate<br/>{vivaConsumerId, transaction}\n\n    activate Loyalty\n    Note over Loyalty: Transaction Adjudication\n    Loyalty->>EagleEye: POST /adjudication<br/>{walletId, transaction}\n    activate EagleEye\n    EagleEye->>EagleEye: Apply earning rules<br/>Base: 100 pts, Bonus: 50 pts\n    EagleEye-->>Loyalty: {grants: [{partner: \"FLYBUYS\", points: 150}]}\n    deactivate EagleEye\n\n    Note over Loyalty: Total adjudication: <300ms p95\n\n    Loyalty->>DB: Persist RewardTransaction<br/>{status: \"PENDING\"}\n    activate DB\n    DB-->>Loyalty: Transaction saved\n    deactivate DB\n\n    Loyalty->>EventBus: Publish TransactionAdjudicated event\n    activate EventBus\n    EventBus-->>Loyalty: Event published\n    deactivate EventBus\n\n    Loyalty-->>POS: {status: \"SUCCESS\", points: 150}\n    deactivate Loyalty\n\n    Note over Loyalty,POS: Total response: <500ms p95\n\n    POS-->>Customer: Receipt: \"150 Flybuys points pending\"\n\n    Note over Customer,EventBus: Points post to Flybuys within 24 hours via batch\n----\n\n===== Detailed Sequence Diagrams\n\nThe diagrams above show happy path flows for business stakeholder understanding. For comprehensive implementation details including error scenarios, see link:../solution_architectures/flybuys_integration.adoc[sequence_diagrams/Flybuys Integration Flows].\n\n*Available detailed flows:*\n\n* *Transaction Adjudication* - Happy path + 3 error scenarios (Profile Service timeout, EagleEye circuit breaker, duplicate transaction handling)\n* *OAuth Partner Linking* - Happy path + 3 error scenarios (authorization denied, token exchange failure, partner already linked)\n* *Batch File Processing* - Happy path + 2 error scenarios (SFTP timeout with retry logic, partial batch rejection)\n* *Circuit Breaker* - State transitions (CLOSED → OPEN → HALF_OPEN) with recovery logicL\n* *Event Propagation* - Timeline showing eventual consistency window and out-of-order event handling\n* *OAuth Token Refresh* - Proactive refresh (50-minute timer) + error scenarios (token expiry, API unavailable)\n\n[width=\"100%\",cols=\"17%,31%,14%,3%,16%,19%\",options=\"header\",]\n|===\n|Actor | Activity | System | Duration | Value Added | Pain Points / Waste\n|link:../ubiquitous_language.adoc#Customer[Customer] | Initiate\nlink:../ubiquitous_language.adoc#Flybuys%2520Digital%2520Identity[Flybuys\nDigital Identity] linking\n|link:../bounded_context/interfaces/mobile.adoc[Mobile\nApplication] | 2 min | Enables coalition loyalty | OAuth redirect\nconfusing, trust concerns\n\n|link:../ubiquitous_language.adoc#Customer[Customer] | Approve account\nlinking | link:../bounded_context/external/flybuys.adoc[Flybuys] OAuth | 30\nsec | Authorise data sharing | External site navigation, security warnings\n\n|link:../bounded_context/profile.adoc[Profile Service] | Store\nlink:../ubiquitous_language.adoc#Partner%2520Link[Partner Link]\n|link:../bounded_context/profile.adoc[Profile Service],\nlink:../bounded_context/interfaces/oauth.adoc[OAuth Service] | <\n1 sec | Persist linking status | None\n\n|link:../bounded_context/profile.adoc[Profile Service] | Publish\nlink:../bounded_context/profile.adoc#Events[PartnerLinked] event\n|Event Bus | < 5 sec | Notify downstream systems | None","numLines":500,"startLine":1,"totalLines":2722}},"sourceToolAssistantUUID":"7d30213e-e071-46ec-892d-e697ed30d64e"}
{"parentUuid":"41285b78-e3dd-40c7-a5d8-1641c9b216ae","isSidechain":true,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","agentId":"a7dc162","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01FMdpNnBZZPtsgaU16NXoqs","type":"message","role":"assistant","content":[{"type":"text","text":"Let me examine the complete structure of both documents by looking at their table of contents."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":300,"cache_creation_input_tokens":11328,"cache_read_input_tokens":17981,"cache_creation":{"ephemeral_5m_input_tokens":11328,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWwDCZacaBwzzkvEY8snt","type":"assistant","uuid":"852e2cfa-f670-427c-b611-9e478d96ac7a","timestamp":"2026-01-09T04:57:22.896Z"}
{"parentUuid":"852e2cfa-f670-427c-b611-9e478d96ac7a","isSidechain":true,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","agentId":"a7dc162","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01FMdpNnBZZPtsgaU16NXoqs","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01KRrouHYZV9FnUCB8JBXvXt","name":"Bash","input":{"command":"grep -E \"^=+ \" /mnt/c/Users/o.young/work/architecture/architecture_definitions/flybuys_integration.adoc | head -100","description":"Extract Flybuys document structure (headings)"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":300,"cache_creation_input_tokens":11328,"cache_read_input_tokens":17981,"cache_creation":{"ephemeral_5m_input_tokens":11328,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWwDCZacaBwzzkvEY8snt","type":"assistant","uuid":"9981fe46-3230-4cd9-9a72-8006929a8613","timestamp":"2026-01-09T04:57:24.672Z"}
{"parentUuid":"9981fe46-3230-4cd9-9a72-8006929a8613","isSidechain":true,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","agentId":"a7dc162","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01FMdpNnBZZPtsgaU16NXoqs","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01N5tSKvAZF1eieDFjmxdE6A","name":"Bash","input":{"command":"grep -E \"^=+ \" /mnt/c/Users/o.young/work/architecture/architecture_definitions/salesforce_customer_support.adoc | head -100","description":"Extract Salesforce document structure (headings)"}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":300,"cache_creation_input_tokens":11328,"cache_read_input_tokens":17981,"cache_creation":{"ephemeral_5m_input_tokens":11328,"ephemeral_1h_input_tokens":0},"output_tokens":235,"service_tier":"standard"}},"requestId":"req_011CWwDCZacaBwzzkvEY8snt","type":"assistant","uuid":"9ffa0cba-96f4-418d-82d0-f1db78eb190d","timestamp":"2026-01-09T04:57:25.395Z"}
{"parentUuid":"9981fe46-3230-4cd9-9a72-8006929a8613","isSidechain":true,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","agentId":"a7dc162","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01KRrouHYZV9FnUCB8JBXvXt","type":"tool_result","content":"= Flybuys Integration - Architecture Definition\r\n== Introduction & Vision\r\n=== Purpose\r\n=== Vision\r\n=== Architectural Approach\r\n=== Architecture Overview\r\n==== Key Architectural Patterns\r\n== Technical Requirements\r\n=== Technical Requirements Mapping\r\n=== Stakeholder Analysis\r\n=== Baseline Architecture\r\n==== Current Business Capability\r\n==== Current Value Stream\r\n===== Customer Redeems Flybuys Fuel Discount\r\n==== Pain Points\r\n=== Target State Architecture\r\n==== Business Capability\r\n==== Value Stream\r\n===== Customer Links Flybuys Digital Identity and earns Flybuys Points\r\n==== OAuth Partner Linking Flow\r\n==== Transaction Adjudication Flow\r\n===== Detailed Sequence Diagrams\r\n==== Gap Analysis\r\n===== Business Capability Gaps\r\n===== Technology Transformation Requirements\r\n== Technical Architecture\r\n=== Technical Capability Requirements\r\n==== Requirements Traceability\r\n=== Service Catalogues\r\n==== Application Portfolio Catalogue\r\n==== Technology Capability Requirements\r\n==== Feature Flag Register\r\n===== Infrastructure Flags\r\n===== Profile Service Flags\r\n===== Loyalty Service Flags\r\n==== Data Entity Catalogue\r\n=== Baseline Architecture\r\n==== Existing System Components\r\n===== link:../bounded_context/interfaces/otr_pos.adoc[OTR POS]\r\n====== Platform\r\n===== link:../bounded_context/interfaces/otr_plus_pos.adoc[OTR+ POS]\r\n====== Platform\r\n====== Capabilities\r\n====== Limitations\r\n===== OTR App API\r\n====== Platform\r\n====== Capabilities\r\n====== Limitations\r\n===== link:../bounded_context/external/salesforce_crm.adoc[Salesforce CRM]\r\n====== Platform\r\n====== Capabilities\r\n===== link:../bounded_context/external/eagle_eye.adoc[EagleEye]\r\n====== Platform\r\n====== Capabilities\r\n===== link:../bounded_context/external/coupon_scanner.adoc[Coupon Scanner]\r\n===== Platform\r\n===== Capabilities\r\n==== Integration Architecture\r\n==== Technical Debt\r\n=== Gap Analysis\r\n==== Missing Capabilities\r\n==== Missing Bounded Contexts\r\n==== Missing Integration Patterns\r\n=== Target State Architecture\r\n==== Architectural Building Blocks (ABB)\r\n===== link:../bounded_context/profile.adoc[ABB-001 Profile Service]\r\n====== Responsibility\r\n====== Aggregates\r\n====== Invariants\r\n====== Domain Events Published by Profile Service\r\n====== Domain Events Consumed by Profile Service\r\n====== Domain Services\r\n====== Feature Flags\r\n====== External Dependencies\r\n===== link:../bounded_context/loyalty.adoc[ABB-002 Loyalty Service]\r\n====== Responsibility\r\n====== POS Integration Pattern: Bidirectional Anti-Corruption Layer\r\n====== Loyalty Credential Resolution Specification\r\n====== Resolution Logic\r\n====== Constraints\r\n====== Aggregates\r\n====== Invariants\r\n====== Domain Events\r\n====== Domain Services\r\n====== Feature Flags\r\n====== Dependencies\r\n===== link:../bounded_context/location.adoc[ABB-003 Location Service]\r\n====== Responsibility\r\n====== Core Aggregates\r\n====== Dependencies\r\n===== link:../bounded_context/engagement.adoc[ABB-004 Engagement Service]\r\n===== ABB-005 Event Bus\r\n===== link:../bounded_context/interfaces/oauth.adoc[ABB-006 OAuth Service]\r\n===== ABB-007 API Gateway\r\n===== ABB-008 Application Config\r\n===== ABB-009 Application Monitoring\r\n===== link:../bounded_context/interfaces/mobile.adoc[ABB-010 Mobile Application]\r\n===== ABB-011 Caching\r\n===== ABB-012 Braze ACL\r\n===== ABB-013 Flybuys ACL","is_error":false}]},"uuid":"ff34693d-c7da-44bb-b6f3-2859478eaae5","timestamp":"2026-01-09T04:57:26.298Z","toolUseResult":{"stdout":"= Flybuys Integration - Architecture Definition\r\n== Introduction & Vision\r\n=== Purpose\r\n=== Vision\r\n=== Architectural Approach\r\n=== Architecture Overview\r\n==== Key Architectural Patterns\r\n== Technical Requirements\r\n=== Technical Requirements Mapping\r\n=== Stakeholder Analysis\r\n=== Baseline Architecture\r\n==== Current Business Capability\r\n==== Current Value Stream\r\n===== Customer Redeems Flybuys Fuel Discount\r\n==== Pain Points\r\n=== Target State Architecture\r\n==== Business Capability\r\n==== Value Stream\r\n===== Customer Links Flybuys Digital Identity and earns Flybuys Points\r\n==== OAuth Partner Linking Flow\r\n==== Transaction Adjudication Flow\r\n===== Detailed Sequence Diagrams\r\n==== Gap Analysis\r\n===== Business Capability Gaps\r\n===== Technology Transformation Requirements\r\n== Technical Architecture\r\n=== Technical Capability Requirements\r\n==== Requirements Traceability\r\n=== Service Catalogues\r\n==== Application Portfolio Catalogue\r\n==== Technology Capability Requirements\r\n==== Feature Flag Register\r\n===== Infrastructure Flags\r\n===== Profile Service Flags\r\n===== Loyalty Service Flags\r\n==== Data Entity Catalogue\r\n=== Baseline Architecture\r\n==== Existing System Components\r\n===== link:../bounded_context/interfaces/otr_pos.adoc[OTR POS]\r\n====== Platform\r\n===== link:../bounded_context/interfaces/otr_plus_pos.adoc[OTR+ POS]\r\n====== Platform\r\n====== Capabilities\r\n====== Limitations\r\n===== OTR App API\r\n====== Platform\r\n====== Capabilities\r\n====== Limitations\r\n===== link:../bounded_context/external/salesforce_crm.adoc[Salesforce CRM]\r\n====== Platform\r\n====== Capabilities\r\n===== link:../bounded_context/external/eagle_eye.adoc[EagleEye]\r\n====== Platform\r\n====== Capabilities\r\n===== link:../bounded_context/external/coupon_scanner.adoc[Coupon Scanner]\r\n===== Platform\r\n===== Capabilities\r\n==== Integration Architecture\r\n==== Technical Debt\r\n=== Gap Analysis\r\n==== Missing Capabilities\r\n==== Missing Bounded Contexts\r\n==== Missing Integration Patterns\r\n=== Target State Architecture\r\n==== Architectural Building Blocks (ABB)\r\n===== link:../bounded_context/profile.adoc[ABB-001 Profile Service]\r\n====== Responsibility\r\n====== Aggregates\r\n====== Invariants\r\n====== Domain Events Published by Profile Service\r\n====== Domain Events Consumed by Profile Service\r\n====== Domain Services\r\n====== Feature Flags\r\n====== External Dependencies\r\n===== link:../bounded_context/loyalty.adoc[ABB-002 Loyalty Service]\r\n====== Responsibility\r\n====== POS Integration Pattern: Bidirectional Anti-Corruption Layer\r\n====== Loyalty Credential Resolution Specification\r\n====== Resolution Logic\r\n====== Constraints\r\n====== Aggregates\r\n====== Invariants\r\n====== Domain Events\r\n====== Domain Services\r\n====== Feature Flags\r\n====== Dependencies\r\n===== link:../bounded_context/location.adoc[ABB-003 Location Service]\r\n====== Responsibility\r\n====== Core Aggregates\r\n====== Dependencies\r\n===== link:../bounded_context/engagement.adoc[ABB-004 Engagement Service]\r\n===== ABB-005 Event Bus\r\n===== link:../bounded_context/interfaces/oauth.adoc[ABB-006 OAuth Service]\r\n===== ABB-007 API Gateway\r\n===== ABB-008 Application Config\r\n===== ABB-009 Application Monitoring\r\n===== link:../bounded_context/interfaces/mobile.adoc[ABB-010 Mobile Application]\r\n===== ABB-011 Caching\r\n===== ABB-012 Braze ACL\r\n===== ABB-013 Flybuys ACL","stderr":"","interrupted":false,"isImage":false},"sourceToolAssistantUUID":"9981fe46-3230-4cd9-9a72-8006929a8613"}
{"parentUuid":"9ffa0cba-96f4-418d-82d0-f1db78eb190d","isSidechain":true,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","agentId":"a7dc162","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01N5tSKvAZF1eieDFjmxdE6A","type":"tool_result","content":"= Salesforce Customer Support","is_error":false}]},"uuid":"f4488557-9754-4a2b-9654-e9c01d834f6e","timestamp":"2026-01-09T04:57:26.308Z","toolUseResult":{"stdout":"= Salesforce Customer Support","stderr":"","interrupted":false,"isImage":false},"sourceToolAssistantUUID":"9ffa0cba-96f4-418d-82d0-f1db78eb190d"}
{"parentUuid":"f4488557-9754-4a2b-9654-e9c01d834f6e","isSidechain":true,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","agentId":"a7dc162","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01Y2Wvubhj4GUi6BWQXuVPyt","type":"message","role":"assistant","content":[{"type":"text","text":"Let me get more of the Salesforce structure."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":1484,"cache_read_input_tokens":29309,"cache_creation":{"ephemeral_5m_input_tokens":1484,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWwDD55tqjkJ2Es6m3t8i","type":"assistant","uuid":"334765e6-643d-4009-9fd0-77f2f8fb2755","timestamp":"2026-01-09T04:57:29.402Z"}
{"parentUuid":"334765e6-643d-4009-9fd0-77f2f8fb2755","isSidechain":true,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","agentId":"a7dc162","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01Y2Wvubhj4GUi6BWQXuVPyt","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_013oruCQQvb5ncaL31NxTAbK","name":"Bash","input":{"command":"grep -E \"^=+[^=]\" /mnt/c/Users/o.young/work/architecture/architecture_definitions/salesforce_customer_support.adoc | head -150","description":"Extract Salesforce document structure with all headings"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":1484,"cache_read_input_tokens":29309,"cache_creation":{"ephemeral_5m_input_tokens":1484,"ephemeral_1h_input_tokens":0},"output_tokens":134,"service_tier":"standard"}},"requestId":"req_011CWwDD55tqjkJ2Es6m3t8i","type":"assistant","uuid":"13201aed-f11a-4552-be4f-c38049c6e5fc","timestamp":"2026-01-09T04:57:30.928Z"}
{"parentUuid":"13201aed-f11a-4552-be4f-c38049c6e5fc","isSidechain":true,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","agentId":"a7dc162","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_013oruCQQvb5ncaL31NxTAbK","type":"tool_result","content":"= Salesforce Customer Support","is_error":false}]},"uuid":"53645990-86cf-4cec-b242-2fc7aaa6abde","timestamp":"2026-01-09T04:57:31.385Z","toolUseResult":{"stdout":"= Salesforce Customer Support","stderr":"","interrupted":false,"isImage":false},"sourceToolAssistantUUID":"13201aed-f11a-4552-be4f-c38049c6e5fc"}
{"parentUuid":"53645990-86cf-4cec-b242-2fc7aaa6abde","isSidechain":true,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","agentId":"a7dc162","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01VWobP7Ti5Qiv6BPg95fwBu","type":"message","role":"assistant","content":[{"type":"text","text":"Let me try a different approach to get the heading structure."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":257,"cache_read_input_tokens":30793,"cache_creation":{"ephemeral_5m_input_tokens":257,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CWwDDRbvjrXPMAPpUnZp1","type":"assistant","uuid":"d35ee764-ff57-48c0-a432-870b20fa31a5","timestamp":"2026-01-09T04:57:33.942Z"}
{"parentUuid":"d35ee764-ff57-48c0-a432-870b20fa31a5","isSidechain":true,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","agentId":"a7dc162","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01VWobP7Ti5Qiv6BPg95fwBu","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01XyNTS2wSvkJdouxbH6gmZw","name":"Bash","input":{"command":"awk '/^=+ / && !/^=+$/' /mnt/c/Users/o.young/work/architecture/architecture_definitions/salesforce_customer_support.adoc | head -150","description":"Extract Salesforce headings using awk"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":257,"cache_read_input_tokens":30793,"cache_creation":{"ephemeral_5m_input_tokens":257,"ephemeral_1h_input_tokens":0},"output_tokens":137,"service_tier":"standard"}},"requestId":"req_011CWwDDRbvjrXPMAPpUnZp1","type":"assistant","uuid":"78459d49-e737-4997-8b2f-ea5615ccaf86","timestamp":"2026-01-09T04:57:35.249Z"}
{"parentUuid":"78459d49-e737-4997-8b2f-ea5615ccaf86","isSidechain":true,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","agentId":"a7dc162","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01XyNTS2wSvkJdouxbH6gmZw","type":"tool_result","content":"awk: cmd. line:1: /^=+ / && \\!/^=+$/\nawk: cmd. line:1:           ^ backslash not last character on line","is_error":false}]},"uuid":"3e643e5f-e105-4a99-8148-ed2ff6c18d7f","timestamp":"2026-01-09T04:57:48.877Z","toolUseResult":{"stdout":"awk: cmd. line:1: /^=+ / && \\!/^=+$/\nawk: cmd. line:1:           ^ backslash not last character on line","stderr":"","interrupted":false,"isImage":false},"sourceToolAssistantUUID":"78459d49-e737-4997-8b2f-ea5615ccaf86"}
{"parentUuid":"3e643e5f-e105-4a99-8148-ed2ff6c18d7f","isSidechain":true,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","agentId":"a7dc162","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01VewNFmQBy11JmBzhnXbRzh","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01DLNBmRESMYwoQNqtyCvjho","name":"Bash","input":{"command":"awk '/^== / || /^=== / || /^==== /' /mnt/c/Users/o.young/work/architecture/architecture_definitions/salesforce_customer_support.adoc | head -150","description":"Extract Salesforce headings"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":190,"cache_read_input_tokens":31050,"cache_creation":{"ephemeral_5m_input_tokens":190,"ephemeral_1h_input_tokens":0},"output_tokens":125,"service_tier":"standard"}},"requestId":"req_011CWwDEhH2erMSSjsKs3oAp","type":"assistant","uuid":"b89f4748-916a-4675-82ac-1e8bd2a3ff8a","timestamp":"2026-01-09T04:57:51.864Z"}
{"parentUuid":"b89f4748-916a-4675-82ac-1e8bd2a3ff8a","isSidechain":true,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","agentId":"a7dc162","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01DLNBmRESMYwoQNqtyCvjho","type":"tool_result","content":"","is_error":false}]},"uuid":"93f8c2aa-a3ee-44f9-8e34-d5346efc12ba","timestamp":"2026-01-09T04:59:16.798Z","toolUseResult":{"stdout":"","stderr":"","interrupted":false,"isImage":false},"sourceToolAssistantUUID":"b89f4748-916a-4675-82ac-1e8bd2a3ff8a"}
{"parentUuid":"93f8c2aa-a3ee-44f9-8e34-d5346efc12ba","isSidechain":true,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","agentId":"a7dc162","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_013qA48L8fN7RHkK4x3CEYx3","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01A2jsYPijgDZDqqGejS7uJ7","name":"Read","input":{"file_path":"/mnt/c/Users/o.young/work/architecture/architecture_definitions/salesforce_customer_support.adoc","offset":1,"limit":1000}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":6,"cache_creation_input_tokens":150,"cache_read_input_tokens":31240,"cache_creation":{"ephemeral_5m_input_tokens":150,"ephemeral_1h_input_tokens":0},"output_tokens":116,"service_tier":"standard"}},"requestId":"req_011CWwDMAzZekxY58SocM5gq","type":"assistant","uuid":"73584bb7-3b47-4968-9c23-dbb1e6805867","timestamp":"2026-01-09T04:59:19.737Z"}
{"parentUuid":"73584bb7-3b47-4968-9c23-dbb1e6805867","isSidechain":true,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","agentId":"a7dc162","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01A2jsYPijgDZDqqGejS7uJ7","type":"tool_result","content":"     1→= Salesforce Customer Support\n     2→:project-name: OTR-002\n     3→:togaf-adm-phase: Phase C: Information Systems Architectures\n     4→:document-type: Architecture Definition Document\n     5→:status: Discovery\n     6→:version: 0.1\n     7→:domain: Engagement\n     8→:domain-architect: O.Young@otr.com.au\n     9→:doctype: article\n    10→:toc: left\n    11→:toclevels: 4\n    12→:sectanchors:\n    13→:sectlinks:\n    14→:sectnums:\n    15→:icons: font\n    16→:source-highlighter: highlightjs\n    17→:experimental:\n    18→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"716a14ba-9804-48cc-8edd-523209ae2a4a","timestamp":"2026-01-09T04:59:20.106Z","toolUseResult":{"type":"text","file":{"filePath":"/mnt/c/Users/o.young/work/architecture/architecture_definitions/salesforce_customer_support.adoc","content":"= Salesforce Customer Support\n:project-name: OTR-002\n:togaf-adm-phase: Phase C: Information Systems Architectures\n:document-type: Architecture Definition Document\n:status: Discovery\n:version: 0.1\n:domain: Engagement\n:domain-architect: O.Young@otr.com.au\n:doctype: article\n:toc: left\n:toclevels: 4\n:sectanchors:\n:sectlinks:\n:sectnums:\n:icons: font\n:source-highlighter: highlightjs\n:experimental:\n","numLines":18,"startLine":1,"totalLines":18}},"sourceToolAssistantUUID":"73584bb7-3b47-4968-9c23-dbb1e6805867"}
{"parentUuid":"716a14ba-9804-48cc-8edd-523209ae2a4a","isSidechain":true,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","agentId":"a7dc162","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01FgJYNaaxdzvRvzFBbNzifx","type":"message","role":"assistant","content":[{"type":"text","text":"Let me check the actual line count and see if the file might be smaller than expected."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":399,"cache_read_input_tokens":31390,"cache_creation":{"ephemeral_5m_input_tokens":399,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CWwDMSQm8hSSjR5W6vNrE","type":"assistant","uuid":"e4a8c81d-580d-4caf-8c43-0721f4528f3e","timestamp":"2026-01-09T04:59:23.431Z"}
{"parentUuid":"e4a8c81d-580d-4caf-8c43-0721f4528f3e","isSidechain":true,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","agentId":"a7dc162","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01FgJYNaaxdzvRvzFBbNzifx","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01HnscePr37dWgYdxVcrUyfQ","name":"Bash","input":{"command":"wc -l /mnt/c/Users/o.young/work/architecture/architecture_definitions/salesforce_customer_support.adoc /mnt/c/Users/o.young/work/architecture/architecture_definitions/flybuys_integration.adoc","description":"Count lines in both documents"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":399,"cache_read_input_tokens":31390,"cache_creation":{"ephemeral_5m_input_tokens":399,"ephemeral_1h_input_tokens":0},"output_tokens":152,"service_tier":"standard"}},"requestId":"req_011CWwDMSQm8hSSjR5W6vNrE","type":"assistant","uuid":"48cbcb29-64b3-4263-aa02-2e285dcb8ac1","timestamp":"2026-01-09T04:59:24.566Z"}
{"parentUuid":"48cbcb29-64b3-4263-aa02-2e285dcb8ac1","isSidechain":true,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","agentId":"a7dc162","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01HnscePr37dWgYdxVcrUyfQ","type":"tool_result","content":"    17 /mnt/c/Users/o.young/work/architecture/architecture_definitions/salesforce_customer_support.adoc\n  2721 /mnt/c/Users/o.young/work/architecture/architecture_definitions/flybuys_integration.adoc\n  2738 total","is_error":false}]},"uuid":"06b2645d-3937-4432-a608-8cd762338f15","timestamp":"2026-01-09T04:59:24.869Z","toolUseResult":{"stdout":"    17 /mnt/c/Users/o.young/work/architecture/architecture_definitions/salesforce_customer_support.adoc\n  2721 /mnt/c/Users/o.young/work/architecture/architecture_definitions/flybuys_integration.adoc\n  2738 total","stderr":"","interrupted":false,"isImage":false},"sourceToolAssistantUUID":"48cbcb29-64b3-4263-aa02-2e285dcb8ac1"}
{"parentUuid":"06b2645d-3937-4432-a608-8cd762338f15","isSidechain":true,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","agentId":"a7dc162","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01J5iZ7jPGrwaNzSG3ixhHAD","type":"message","role":"assistant","content":[{"type":"text","text":"I see - the Salesforce document is just a stub. Let me check if there's a solution architecture version instead."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":235,"cache_read_input_tokens":31789,"cache_creation":{"ephemeral_5m_input_tokens":235,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWwDMmK4gMs6LjfNj7UR3","type":"assistant","uuid":"c0b1fe8b-d66c-4524-a229-727ab17c3eb6","timestamp":"2026-01-09T04:59:27.930Z"}
{"parentUuid":"c0b1fe8b-d66c-4524-a229-727ab17c3eb6","isSidechain":true,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","agentId":"a7dc162","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01J5iZ7jPGrwaNzSG3ixhHAD","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01JA4wnqYpY1vXkoEgYy9afh","name":"Glob","input":{"pattern":"**/*salesforce*.adoc"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":235,"cache_read_input_tokens":31789,"cache_creation":{"ephemeral_5m_input_tokens":235,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWwDMmK4gMs6LjfNj7UR3","type":"assistant","uuid":"64372576-2004-4bc6-826c-4fccfa74d331","timestamp":"2026-01-09T04:59:28.478Z"}
{"parentUuid":"64372576-2004-4bc6-826c-4fccfa74d331","isSidechain":true,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","agentId":"a7dc162","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01J5iZ7jPGrwaNzSG3ixhHAD","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01BzKSLz3UE4AVDdSJopjJFH","name":"Bash","input":{"command":"wc -l /mnt/c/Users/o.young/work/architecture/modules/ROOT/pages/salesforce_customer_support.adoc 2>/dev/null || echo \"File not found\"","description":"Check if there's a different Salesforce file"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":235,"cache_read_input_tokens":31789,"cache_creation":{"ephemeral_5m_input_tokens":235,"ephemeral_1h_input_tokens":0},"output_tokens":192,"service_tier":"standard"}},"requestId":"req_011CWwDMmK4gMs6LjfNj7UR3","type":"assistant","uuid":"da836c92-6ad4-4b0d-9fde-08e71f6cfdba","timestamp":"2026-01-09T04:59:29.549Z"}
{"parentUuid":"da836c92-6ad4-4b0d-9fde-08e71f6cfdba","isSidechain":true,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","agentId":"a7dc162","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01BzKSLz3UE4AVDdSJopjJFH","type":"tool_result","content":"File not found","is_error":false}]},"uuid":"3e1dad08-d8ee-4401-81f5-ecbe5b5de93c","timestamp":"2026-01-09T04:59:29.973Z","toolUseResult":{"stdout":"File not found","stderr":"","interrupted":false,"isImage":false},"sourceToolAssistantUUID":"da836c92-6ad4-4b0d-9fde-08e71f6cfdba"}
{"parentUuid":"64372576-2004-4bc6-826c-4fccfa74d331","isSidechain":true,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","agentId":"a7dc162","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01JA4wnqYpY1vXkoEgYy9afh","type":"tool_result","content":"/mnt/c/Users/o.young/work/architecture/bounded_context/external/salesforce_crm.adoc\n/mnt/c/Users/o.young/work/architecture/bounded_context/external/salesforce_service_cloud.adoc\n/mnt/c/Users/o.young/work/architecture/architecture_definitions/salesforce_customer_support.adoc\n/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc\n/mnt/c/Users/o.young/work/architecture/initiatives/salesforce_customer_support.adoc"}]},"uuid":"7818d8cf-8eac-45c1-a8f0-160c4e39799e","timestamp":"2026-01-09T04:59:34.057Z","toolUseResult":{"filenames":["/mnt/c/Users/o.young/work/architecture/bounded_context/external/salesforce_crm.adoc","/mnt/c/Users/o.young/work/architecture/bounded_context/external/salesforce_service_cloud.adoc","/mnt/c/Users/o.young/work/architecture/architecture_definitions/salesforce_customer_support.adoc","/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","/mnt/c/Users/o.young/work/architecture/initiatives/salesforce_customer_support.adoc"],"durationMs":4198,"numFiles":5,"truncated":false},"sourceToolAssistantUUID":"64372576-2004-4bc6-826c-4fccfa74d331"}
{"parentUuid":"7818d8cf-8eac-45c1-a8f0-160c4e39799e","isSidechain":true,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","agentId":"a7dc162","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01XDW9uSJoTx69rFbiw2N7ng","type":"message","role":"assistant","content":[{"type":"text","text":"Let me check the solution architecture version."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":33,"cache_creation_input_tokens":378,"cache_read_input_tokens":32024,"cache_creation":{"ephemeral_5m_input_tokens":378,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CWwDNSeRsdrzuBLcBjNfH","type":"assistant","uuid":"db0e0d59-1bcd-4abd-99d1-264af8c8f632","timestamp":"2026-01-09T04:59:37.130Z"}
{"parentUuid":"db0e0d59-1bcd-4abd-99d1-264af8c8f632","isSidechain":true,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","agentId":"a7dc162","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01XDW9uSJoTx69rFbiw2N7ng","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_013GKHRA3AadqmXnvHjn6wCf","name":"Bash","input":{"command":"wc -l /mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc /mnt/c/Users/o.young/work/architecture/solution_architectures/flybuys_integration.adoc","description":"Count lines in solution architecture files"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":33,"cache_creation_input_tokens":378,"cache_read_input_tokens":32024,"cache_creation":{"ephemeral_5m_input_tokens":378,"ephemeral_1h_input_tokens":0},"output_tokens":145,"service_tier":"standard"}},"requestId":"req_011CWwDNSeRsdrzuBLcBjNfH","type":"assistant","uuid":"87aed512-1315-4545-85cc-a844e2e34899","timestamp":"2026-01-09T04:59:38.086Z"}
{"parentUuid":"87aed512-1315-4545-85cc-a844e2e34899","isSidechain":true,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","agentId":"a7dc162","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_013GKHRA3AadqmXnvHjn6wCf","type":"tool_result","content":"  3328 /mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc\n  5276 /mnt/c/Users/o.young/work/architecture/solution_architectures/flybuys_integration.adoc\n  8604 total","is_error":false}]},"uuid":"bf03cc61-06f3-4552-a631-f1869ca64c75","timestamp":"2026-01-09T04:59:38.368Z","toolUseResult":{"stdout":"  3328 /mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc\n  5276 /mnt/c/Users/o.young/work/architecture/solution_architectures/flybuys_integration.adoc\n  8604 total","stderr":"","interrupted":false,"isImage":false},"sourceToolAssistantUUID":"87aed512-1315-4545-85cc-a844e2e34899"}
{"parentUuid":"bf03cc61-06f3-4552-a631-f1869ca64c75","isSidechain":true,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","agentId":"a7dc162","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01Es9rw71BLUxGtQ3oqJoqF2","type":"message","role":"assistant","content":[{"type":"text","text":"Perfect. Now let me analyze the structure of both solution architecture documents."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":4,"cache_creation_input_tokens":362,"cache_read_input_tokens":32402,"cache_creation":{"ephemeral_5m_input_tokens":362,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWwDNm7BeVSevm936CFBV","type":"assistant","uuid":"11a55936-a0af-41cd-9e94-ebe052f87d46","timestamp":"2026-01-09T04:59:41.679Z"}
{"parentUuid":"11a55936-a0af-41cd-9e94-ebe052f87d46","isSidechain":true,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","agentId":"a7dc162","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01Es9rw71BLUxGtQ3oqJoqF2","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01KembsL6kEHXquqPz4V3Rt7","name":"Bash","input":{"command":"grep \"^==\" /mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc | head -150","description":"Get Salesforce solution architecture structure"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":4,"cache_creation_input_tokens":362,"cache_read_input_tokens":32402,"cache_creation":{"ephemeral_5m_input_tokens":362,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWwDNm7BeVSevm936CFBV","type":"assistant","uuid":"a178a3c2-175b-4298-af61-fad609d020c3","timestamp":"2026-01-09T04:59:42.716Z"}
{"parentUuid":"a178a3c2-175b-4298-af61-fad609d020c3","isSidechain":true,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","agentId":"a7dc162","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01Es9rw71BLUxGtQ3oqJoqF2","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01TKh3skkPj2v4FF7SEouHNa","name":"Bash","input":{"command":"grep \"^==\" /mnt/c/Users/o.young/work/architecture/solution_architectures/flybuys_integration.adoc | head -150","description":"Get Flybuys solution architecture structure"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":4,"cache_creation_input_tokens":362,"cache_read_input_tokens":32402,"cache_creation":{"ephemeral_5m_input_tokens":362,"ephemeral_1h_input_tokens":0},"output_tokens":224,"service_tier":"standard"}},"requestId":"req_011CWwDNm7BeVSevm936CFBV","type":"assistant","uuid":"b9c25037-352d-48da-8269-4a4a630cadde","timestamp":"2026-01-09T04:59:43.352Z"}
{"parentUuid":"b9c25037-352d-48da-8269-4a4a630cadde","isSidechain":true,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","agentId":"a7dc162","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01TKh3skkPj2v4FF7SEouHNa","type":"tool_result","content":"== Purpose and Scope\n=== Purpose\n=== Scope\n==== In Scope\n==== Out of Scope\n===== Covered in xref:architecture-definitions:flybuys_integration.adoc[Architecture Definition]\n===== Covered in other documents\n== Executive Summary\n== Solution Approach\n=== Related Documentation\n==== API Specifications\n==== Sequence Diagrams\n==== JSON Schemas\n==== Executive Summary\n== Key Technology Decisions\n=== Implementation Constraints\n=== Success Criteria\n== Solution Building Blocks\n=== Technology Portfolio Catalogue\n=== Solution Building Block Mapping\n=== SBB-001: Profile Service API\n==== Dependencies\n=== SBB-002: Profile Service Database\n=== SBB-003: Loyalty Service API\n==== Capabilities\n===== Loyalty Credential Resolution\n==== Dependencies\n=== SBB-004: Loyalty Service Database\n=== SBB-005: OAuth Token Manager\n==== OAuth Token Refresh Flow\n==== Dependencies\n=== SBB-006: Domain Event Bus\n==== Event Specifications\n===== Topics\n==== Event Documentation\n==== Event Propagation Timeline\n==== Event Flow\n=== SBB-007: Engagement Service API\n==== Responsibilities\n==== Key Events Consumed\n=== SBB-008: Engagement Service Database\n=== SBB-009: Braze Integration Adaptor\n==== Dependencies\n=== SBB-010: Flybuys Integration Adaptor\n=== SBB-011: EagleEye Integration Adaptor\n=== SBB-012: Application Monitoring\n=== SBB-013: API Gateway\n=== SBB-014: OTR Mobile App\n==== Integration\n=== SBB-015: Batch File Pipeline\n==== Batch File Processing Flow\n=== SBB-016: Distributed Cache\n==== Circuit Breaker Pattern\n=== SBB-017: Feature Flag Service\n=== SBB-018: Location\n== Data Architecture\n=== Physical Data Models\n==== Profile Service - PartnerLink Document Schema\n===== JSON Schema\n===== Database Configuration\n===== Key Fields\n===== Example Document\n===== Indexes\n===== Constraints\n==== Loyalty Service - RewardTransaction Document Schema\n===== JSON Schema\n===== Database Configuration\n===== Key Fields\n===== Example Document\n===== Indexes\n===== Constraints\n==== OAuth Token Storage Schema (Key Vault)\n===== JSON Schema\n===== Key Vault Configuration\n===== Secret Value (JSON) - Key Fields\n===== Example Secret\n===== Metadata\n===== Encryption\n== Interface Specifications\n=== Complete API Documentation\n=== REST API\n=== Domain Events\n==== AsyncAPI Specification\n==== Event Schemas\n==== API Versioning Policy\n===== Version Numbering\n===== When to Version\n===== Parallel Version Support\n===== Deprecation Notification\n===== Version Discovery\n===== Consumer Compatibility\n===== Error Response for Sunset APIs\n===== Semantic Versioning Alignment\n==== Loyalty Credential Resolution API\n==== Customer Profile Creation API\n==== Customer Profile Retrieval API\n=== Domain Events\n==== Event Catalogue\n==== Event Consumers\n==== Event Delivery Guarantees\n=== Correlation ID Propagation Specification\n==== Standard\n==== HTTP Propagation\n==== Event Propagation\n==== Structured Logging\n==== Trace Visualization\n==== Implementation Notes\n=== Data Formats\n==== Flybuys Batch File Format (CSV)\n===== Format\n===== Field Specifications\n===== File Requirements\n===== PGP Encryption Specifications\n=== Interaction Flows\n==== OAuth linking Flow (TS-2 linking)\n==== Just-In-Time Profile Creation Flow (TS-1 Foundation)\n==== POS Integration Flow (TS-3 Grants)\n==== POS Transaction Adjudication Flow (TS-3 Grants)\n==== Batch File Processing Flow (TS-3 Grants)\n== Gap Analysis\n=== Missing Capabilities\n=== Missing Bounded Contexts\n=== Missing Integration Patterns\n=== Target State Architecture\n==== Architectural Building Blocks (ABB)\n== Work Packages\n=== Work Package Overview\n=== WP-FB-001: ProfileService Development\n==== Description\n==== Deliverables\n==== Dependencies\n==== Skills Required\n==== Acceptance Criteria\n=== WP-FB-002: LoyaltyService Development\n==== Description\n==== Deliverables\n==== Dependencies\n==== Skills Required\n==== Acceptance Criteria\n=== WP-FB-003: Event Bus Infrastructure\n==== Description\n==== Deliverables\n==== Dependencies\n==== Skills Required\n==== Acceptance Criteria\n=== WP-FB-004: Flybuys OAuth Integration\n==== Description\n==== Deliverables\n==== Dependencies\n==== Skills Required","is_error":false}]},"uuid":"2b9cad8c-e17f-4419-ba35-1fc7460fdae9","timestamp":"2026-01-09T04:59:43.717Z","toolUseResult":{"stdout":"== Purpose and Scope\n=== Purpose\n=== Scope\n==== In Scope\n==== Out of Scope\n===== Covered in xref:architecture-definitions:flybuys_integration.adoc[Architecture Definition]\n===== Covered in other documents\n== Executive Summary\n== Solution Approach\n=== Related Documentation\n==== API Specifications\n==== Sequence Diagrams\n==== JSON Schemas\n==== Executive Summary\n== Key Technology Decisions\n=== Implementation Constraints\n=== Success Criteria\n== Solution Building Blocks\n=== Technology Portfolio Catalogue\n=== Solution Building Block Mapping\n=== SBB-001: Profile Service API\n==== Dependencies\n=== SBB-002: Profile Service Database\n=== SBB-003: Loyalty Service API\n==== Capabilities\n===== Loyalty Credential Resolution\n==== Dependencies\n=== SBB-004: Loyalty Service Database\n=== SBB-005: OAuth Token Manager\n==== OAuth Token Refresh Flow\n==== Dependencies\n=== SBB-006: Domain Event Bus\n==== Event Specifications\n===== Topics\n==== Event Documentation\n==== Event Propagation Timeline\n==== Event Flow\n=== SBB-007: Engagement Service API\n==== Responsibilities\n==== Key Events Consumed\n=== SBB-008: Engagement Service Database\n=== SBB-009: Braze Integration Adaptor\n==== Dependencies\n=== SBB-010: Flybuys Integration Adaptor\n=== SBB-011: EagleEye Integration Adaptor\n=== SBB-012: Application Monitoring\n=== SBB-013: API Gateway\n=== SBB-014: OTR Mobile App\n==== Integration\n=== SBB-015: Batch File Pipeline\n==== Batch File Processing Flow\n=== SBB-016: Distributed Cache\n==== Circuit Breaker Pattern\n=== SBB-017: Feature Flag Service\n=== SBB-018: Location\n== Data Architecture\n=== Physical Data Models\n==== Profile Service - PartnerLink Document Schema\n===== JSON Schema\n===== Database Configuration\n===== Key Fields\n===== Example Document\n===== Indexes\n===== Constraints\n==== Loyalty Service - RewardTransaction Document Schema\n===== JSON Schema\n===== Database Configuration\n===== Key Fields\n===== Example Document\n===== Indexes\n===== Constraints\n==== OAuth Token Storage Schema (Key Vault)\n===== JSON Schema\n===== Key Vault Configuration\n===== Secret Value (JSON) - Key Fields\n===== Example Secret\n===== Metadata\n===== Encryption\n== Interface Specifications\n=== Complete API Documentation\n=== REST API\n=== Domain Events\n==== AsyncAPI Specification\n==== Event Schemas\n==== API Versioning Policy\n===== Version Numbering\n===== When to Version\n===== Parallel Version Support\n===== Deprecation Notification\n===== Version Discovery\n===== Consumer Compatibility\n===== Error Response for Sunset APIs\n===== Semantic Versioning Alignment\n==== Loyalty Credential Resolution API\n==== Customer Profile Creation API\n==== Customer Profile Retrieval API\n=== Domain Events\n==== Event Catalogue\n==== Event Consumers\n==== Event Delivery Guarantees\n=== Correlation ID Propagation Specification\n==== Standard\n==== HTTP Propagation\n==== Event Propagation\n==== Structured Logging\n==== Trace Visualization\n==== Implementation Notes\n=== Data Formats\n==== Flybuys Batch File Format (CSV)\n===== Format\n===== Field Specifications\n===== File Requirements\n===== PGP Encryption Specifications\n=== Interaction Flows\n==== OAuth linking Flow (TS-2 linking)\n==== Just-In-Time Profile Creation Flow (TS-1 Foundation)\n==== POS Integration Flow (TS-3 Grants)\n==== POS Transaction Adjudication Flow (TS-3 Grants)\n==== Batch File Processing Flow (TS-3 Grants)\n== Gap Analysis\n=== Missing Capabilities\n=== Missing Bounded Contexts\n=== Missing Integration Patterns\n=== Target State Architecture\n==== Architectural Building Blocks (ABB)\n== Work Packages\n=== Work Package Overview\n=== WP-FB-001: ProfileService Development\n==== Description\n==== Deliverables\n==== Dependencies\n==== Skills Required\n==== Acceptance Criteria\n=== WP-FB-002: LoyaltyService Development\n==== Description\n==== Deliverables\n==== Dependencies\n==== Skills Required\n==== Acceptance Criteria\n=== WP-FB-003: Event Bus Infrastructure\n==== Description\n==== Deliverables\n==== Dependencies\n==== Skills Required\n==== Acceptance Criteria\n=== WP-FB-004: Flybuys OAuth Integration\n==== Description\n==== Deliverables\n==== Dependencies\n==== Skills Required","stderr":"","interrupted":false,"isImage":false},"sourceToolAssistantUUID":"b9c25037-352d-48da-8269-4a4a630cadde"}
{"parentUuid":"a178a3c2-175b-4298-af61-fad609d020c3","isSidechain":true,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","agentId":"a7dc162","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01KembsL6kEHXquqPz4V3Rt7","type":"tool_result","content":"== Purpose and Scope\n=== Purpose\n=== Vision\n=== Architectural Approach\n=== Scope\n==== In Scope\n==== Out of Scope\n===== Covered in xref:architecture-definitions:salesforce_customer_support.adoc[Architecture Definition]\n===== Covered in Other Documents\n=== Architecture Overview\n==== Key Architectural Patterns\n== Solution Approach\n=== Related Documentation\n==== Architecture Definition\n==== Bounded Context Specifications\n==== Interface Specifications\n==== External System Documentation\n== Executive Summary\n=== Challenge\n=== Solution\n==== New Bounded Contexts\n==== Integration Architecture\n==== Migration Approach\n=== Key Architectural Significance\n=== Success Criteria\n=== Technical Constraints\n=== Open Technical Decisions (TBD)\n== Technical Requirements\n== Technical Architecture\n=== Technical Capability Requirements\n==== Requirements Traceability\n=== Service Catalogues\n==== Application Portfolio Catalogue\n==== Technology Capability Requirements\n==== Feature Flag Register\n==== Data Entity Catalogue\n==== Data Quality & Validation\n== Solution Building Blocks\n=== Technology Portfolio Catalogue\n== Data Architecture\n=== Domain Event Schemas\n==== Event Catalogue\n=== API Request/Response Schemas\n==== ProfileService: GET /profile/contact-id\n==== EngagementService: POST /feedback\n=== Salesforce Field Mappings\n==== Case Object Mapping\n=== Baseline Architecture\n==== Existing System Components\n==== Integration Architecture\n==== Technical Debt\n=== Gap Analysis\n==== Missing Capabilities\n==== Missing Bounded Contexts\n==== Missing Integration Patterns\n=== Target State Architecture\n==== Architectural Building Blocks (ABB)\n==== Integration Architecture\n===== Integration Flows\n===== System of Record Boundaries\n==== Data Architecture Principles\n===== Aggregate Persistence\n===== Event Store\n=== Architecture Decisions\n==== ADR-CS-001: Consolidate onto Salesforce Service Cloud (not build custom solution)\n==== ADR-CS-002: Implement ProfileService and EngagementService as first DDD bounded contexts\n==== ADR-CS-003: Async Case creation via Event Bus (not synchronous)\n==== ADR-CS-004: ProfileService uses email as primary matching key (not VCI)\n==== ADR-CS-005: No Case migration from D365 CE (fresh start)\n==== ADR-CS-006: Big bang cutover (not phased rollout)\n==== ADR-CS-007: EngagementService receives Salesforce webhooks for Case updates\n== Interface Specifications\n=== REST API Specifications\n==== ProfileService API v1\n==== EngagementService API v1\n=== Domain Events (AsyncAPI)\n==== Event Catalogue\n==== Event Delivery Guarantees\n=== API Versioning Policy\n==== Version Numbering\n==== When to Version\n==== Parallel Version Support\n== Work Packages\n=== Work Package Overview\n=== WP-CS-001: ProfileService Development\n==== Description\n==== Deliverables\n==== Dependencies\n==== Skills Required\n==== Acceptance Criteria\n=== WP-CS-002: EngagementService Development\n==== Description\n==== Deliverables\n==== Dependencies\n==== Skills Required\n==== Acceptance Criteria\n=== WP-CS-003: Event Bus Infrastructure\n==== Description\n==== Deliverables\n==== Dependencies\n==== Skills Required\n==== Acceptance Criteria\n=== WP-CS-004: Contact Migration Tooling\n==== Description\n==== Deliverables\n==== Dependencies\n==== Skills Required\n==== Acceptance Criteria\n=== WP-CS-005: Mobile App Integration\n==== Description\n==== Deliverables\n==== Dependencies\n==== Skills Required\n==== Acceptance Criteria\n=== WP-CS-006: Integration Testing\n==== Description\n==== Deliverables\n==== Dependencies\n==== Skills Required\n==== Acceptance Criteria\n=== WP-CS-007: Salesforce Configuration\n==== Description\n==== Deliverables\n==== Dependencies\n==== Skills Required\n==== Acceptance Criteria\n=== WP-CS-008: Contact Data Migration\n==== Description\n==== Deliverables\n==== Dependencies\n==== Skills Required\n==== Acceptance Criteria\n=== WP-CS-009: Production Deployment\n==== Description\n==== Deliverables\n==== Dependencies\n==== Skills Required\n==== Acceptance Criteria\n=== WP-CS-010: Post-Cutover Support\n==== Description\n==== Deliverables\n==== Dependencies\n==== Skills Required\n==== Acceptance Criteria\n=== Work Package Sequencing\n==== Parallel Track 1: Infrastructure & Configuration\n==== Parallel Track 2: Development\n==== Sequential Track 3: Integration & Testing\n==== Sequential Track 4: Migration & Cutover\n==== Critical Path","is_error":false}]},"uuid":"789a31a8-9233-494d-948a-677452273bd3","timestamp":"2026-01-09T04:59:43.722Z","toolUseResult":{"stdout":"== Purpose and Scope\n=== Purpose\n=== Vision\n=== Architectural Approach\n=== Scope\n==== In Scope\n==== Out of Scope\n===== Covered in xref:architecture-definitions:salesforce_customer_support.adoc[Architecture Definition]\n===== Covered in Other Documents\n=== Architecture Overview\n==== Key Architectural Patterns\n== Solution Approach\n=== Related Documentation\n==== Architecture Definition\n==== Bounded Context Specifications\n==== Interface Specifications\n==== External System Documentation\n== Executive Summary\n=== Challenge\n=== Solution\n==== New Bounded Contexts\n==== Integration Architecture\n==== Migration Approach\n=== Key Architectural Significance\n=== Success Criteria\n=== Technical Constraints\n=== Open Technical Decisions (TBD)\n== Technical Requirements\n== Technical Architecture\n=== Technical Capability Requirements\n==== Requirements Traceability\n=== Service Catalogues\n==== Application Portfolio Catalogue\n==== Technology Capability Requirements\n==== Feature Flag Register\n==== Data Entity Catalogue\n==== Data Quality & Validation\n== Solution Building Blocks\n=== Technology Portfolio Catalogue\n== Data Architecture\n=== Domain Event Schemas\n==== Event Catalogue\n=== API Request/Response Schemas\n==== ProfileService: GET /profile/contact-id\n==== EngagementService: POST /feedback\n=== Salesforce Field Mappings\n==== Case Object Mapping\n=== Baseline Architecture\n==== Existing System Components\n==== Integration Architecture\n==== Technical Debt\n=== Gap Analysis\n==== Missing Capabilities\n==== Missing Bounded Contexts\n==== Missing Integration Patterns\n=== Target State Architecture\n==== Architectural Building Blocks (ABB)\n==== Integration Architecture\n===== Integration Flows\n===== System of Record Boundaries\n==== Data Architecture Principles\n===== Aggregate Persistence\n===== Event Store\n=== Architecture Decisions\n==== ADR-CS-001: Consolidate onto Salesforce Service Cloud (not build custom solution)\n==== ADR-CS-002: Implement ProfileService and EngagementService as first DDD bounded contexts\n==== ADR-CS-003: Async Case creation via Event Bus (not synchronous)\n==== ADR-CS-004: ProfileService uses email as primary matching key (not VCI)\n==== ADR-CS-005: No Case migration from D365 CE (fresh start)\n==== ADR-CS-006: Big bang cutover (not phased rollout)\n==== ADR-CS-007: EngagementService receives Salesforce webhooks for Case updates\n== Interface Specifications\n=== REST API Specifications\n==== ProfileService API v1\n==== EngagementService API v1\n=== Domain Events (AsyncAPI)\n==== Event Catalogue\n==== Event Delivery Guarantees\n=== API Versioning Policy\n==== Version Numbering\n==== When to Version\n==== Parallel Version Support\n== Work Packages\n=== Work Package Overview\n=== WP-CS-001: ProfileService Development\n==== Description\n==== Deliverables\n==== Dependencies\n==== Skills Required\n==== Acceptance Criteria\n=== WP-CS-002: EngagementService Development\n==== Description\n==== Deliverables\n==== Dependencies\n==== Skills Required\n==== Acceptance Criteria\n=== WP-CS-003: Event Bus Infrastructure\n==== Description\n==== Deliverables\n==== Dependencies\n==== Skills Required\n==== Acceptance Criteria\n=== WP-CS-004: Contact Migration Tooling\n==== Description\n==== Deliverables\n==== Dependencies\n==== Skills Required\n==== Acceptance Criteria\n=== WP-CS-005: Mobile App Integration\n==== Description\n==== Deliverables\n==== Dependencies\n==== Skills Required\n==== Acceptance Criteria\n=== WP-CS-006: Integration Testing\n==== Description\n==== Deliverables\n==== Dependencies\n==== Skills Required\n==== Acceptance Criteria\n=== WP-CS-007: Salesforce Configuration\n==== Description\n==== Deliverables\n==== Dependencies\n==== Skills Required\n==== Acceptance Criteria\n=== WP-CS-008: Contact Data Migration\n==== Description\n==== Deliverables\n==== Dependencies\n==== Skills Required\n==== Acceptance Criteria\n=== WP-CS-009: Production Deployment\n==== Description\n==== Deliverables\n==== Dependencies\n==== Skills Required\n==== Acceptance Criteria\n=== WP-CS-010: Post-Cutover Support\n==== Description\n==== Deliverables\n==== Dependencies\n==== Skills Required\n==== Acceptance Criteria\n=== Work Package Sequencing\n==== Parallel Track 1: Infrastructure & Configuration\n==== Parallel Track 2: Development\n==== Sequential Track 3: Integration & Testing\n==== Sequential Track 4: Migration & Cutover\n==== Critical Path","stderr":"","interrupted":false,"isImage":false},"sourceToolAssistantUUID":"a178a3c2-175b-4298-af61-fad609d020c3"}
{"parentUuid":"789a31a8-9233-494d-948a-677452273bd3","isSidechain":true,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","agentId":"a7dc162","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_019ioyAcMkyb55dx5j73Nq6k","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me read key sections to understand the detailed structure better."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1193,"cache_creation_input_tokens":1425,"cache_read_input_tokens":32764,"cache_creation":{"ephemeral_5m_input_tokens":1425,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWwDPAUcqsR3XUbeLacTj","type":"assistant","uuid":"5c57023e-e2da-48e8-98a1-b63cefcedfc2","timestamp":"2026-01-09T04:59:47.261Z"}
{"parentUuid":"5c57023e-e2da-48e8-98a1-b63cefcedfc2","isSidechain":true,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","agentId":"a7dc162","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_019ioyAcMkyb55dx5j73Nq6k","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_013WXcsC3z4KFV11LtvtgqMF","name":"Read","input":{"file_path":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","offset":2900,"limit":400}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1193,"cache_creation_input_tokens":1425,"cache_read_input_tokens":32764,"cache_creation":{"ephemeral_5m_input_tokens":1425,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWwDPAUcqsR3XUbeLacTj","type":"assistant","uuid":"ef8a3fe9-47b1-4102-beae-2131d22c0afe","timestamp":"2026-01-09T04:59:49.014Z"}
{"parentUuid":"ef8a3fe9-47b1-4102-beae-2131d22c0afe","isSidechain":true,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","agentId":"a7dc162","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_019ioyAcMkyb55dx5j73Nq6k","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01RVnzzhP8JHLKqjpeWndrs1","name":"Bash","input":{"command":"grep -n \"^== \" /mnt/c/Users/o.young/work/architecture/solution_architectures/flybuys_integration.adoc","description":"Get major section line numbers for Flybuys"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1193,"cache_creation_input_tokens":1425,"cache_read_input_tokens":32764,"cache_creation":{"ephemeral_5m_input_tokens":1425,"ephemeral_1h_input_tokens":0},"output_tokens":227,"service_tier":"standard"}},"requestId":"req_011CWwDPAUcqsR3XUbeLacTj","type":"assistant","uuid":"72cebc78-2551-41e4-8c74-eb460b55bbfc","timestamp":"2026-01-09T04:59:50.367Z"}
{"parentUuid":"ef8a3fe9-47b1-4102-beae-2131d22c0afe","isSidechain":true,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","agentId":"a7dc162","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_013WXcsC3z4KFV11LtvtgqMF","type":"tool_result","content":"  2900→|NFR-SCALE-006\n  2901→|Future growth capacity\n  2902→|Architecture supports 10x growth (1,000-1,500 submissions/day based on 200k DAU) without major redesign\n  2903→\n  2904→|===\n  2905→\n  2906→=== Security Requirements\n  2907→\n  2908→[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n  2909→|===\n  2910→|ID |Requirement |Target\n  2911→\n  2912→|NFR-SEC-001\n  2913→|Mobile App authentication\n  2914→|Microsoft Entra External ID OAuth 2.0 with JWT tokens (existing CIAM)\n  2915→\n  2916→|NFR-SEC-002\n  2917→|API authorisation: ProfileService and EngagementService\n  2918→|JWT token validation, authenticated users only, user context propagation\n  2919→\n  2920→|NFR-SEC-003\n  2921→|Salesforce API authentication\n  2922→|OAuth 2.0 with Connected App and JWT bearer flow (service account)\n  2923→\n  2924→|NFR-SEC-004\n  2925→|Data encryption in transit\n  2926→|TLS 1.2+ for all API calls (Mobile App ↔ ProfileService/EngagementService ↔ Salesforce ↔ Braze)\n  2927→\n  2928→|NFR-SEC-005\n  2929→|Data encryption at rest\n  2930→|Salesforce encryption at rest (managed by Salesforce), Event Bus message encryption (AWS KMS)\n  2931→\n  2932→|NFR-SEC-006\n  2933→|Secret management\n  2934→|AWS Secrets Manager for Salesforce credentials, Braze API keys, OAuth tokens (no hardcoded secrets)\n  2935→\n  2936→|NFR-SEC-007\n  2937→|PII data handling\n  2938→|Contact data (email, phone, name) treated as PII, GDPR-compliant retention policies (Salesforce governance)\n  2939→\n  2940→|NFR-SEC-008\n  2941→|API rate limiting and throttling\n  2942→|API Gateway rate limiting (100 requests/second per user), prevent abuse and DoS\n  2943→\n  2944→|NFR-SEC-009\n  2945→|Logging and auditing\n  2946→|Log all API calls, Salesforce Contact/Case creates/updates, Event Bus publishes (no PII in logs)\n  2947→\n  2948→|NFR-SEC-010\n  2949→|Salesforce data isolation\n  2950→|Multi-tenant data isolation via Salesforce Record Types, queues, sharing rules (defined by Viva Energy admin team)\n  2951→\n  2952→|===\n  2953→\n  2954→=== Reliability Requirements\n  2955→\n  2956→[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n  2957→|===\n  2958→|ID |Requirement |Target\n  2959→\n  2960→|NFR-REL-001\n  2961→|Retry logic: EngagementService → Salesforce Case creation\n  2962→|Exponential backoff (1s, 2s, 4s, 8s, 16s), max 5 retries, then dead letter queue\n  2963→\n  2964→|NFR-REL-002\n  2965→|Dead letter queue monitoring\n  2966→|Alert ops team immediately when DLQ depth > 0 (failed Case creations require manual intervention)\n  2967→\n  2968→|NFR-REL-003\n  2969→|Event Bus message durability\n  2970→|Messages persisted in Event Bus (SNS+SQS/EventBridge/Kinesis), not lost on service restart\n  2971→\n  2972→|NFR-REL-004\n  2973→|Idempotency: Case creation\n  2974→|EngagementService ensures duplicate feedback submissions don't create duplicate Cases (idempotency key)\n  2975→\n  2976→|NFR-REL-005\n  2977→|Circuit breaker: Salesforce API calls\n  2978→|Open circuit after 5 consecutive failures, half-open retry after 30 seconds\n  2979→\n  2980→|NFR-REL-006\n  2981→|Health checks: ProfileService and EngagementService\n  2982→|Health endpoints for load balancer checks, readiness and liveness probes\n  2983→\n  2984→|NFR-REL-007\n  2985→|Disaster recovery: Event Bus\n  2986→|Event Bus messages replicated across AWS availability zones (SQS/EventBridge/Kinesis HA)\n  2987→\n  2988→|===\n  2989→\n  2990→=== Maintainability Requirements\n  2991→\n  2992→[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n  2993→|===\n  2994→|ID |Requirement |Target\n  2995→\n  2996→|NFR-MAINT-001\n  2997→|Code quality: ProfileService and EngagementService\n  2998→|> 80% test coverage (unit + integration tests), automated CI/CD pipeline\n  2999→\n  3000→|NFR-MAINT-002\n  3001→|API documentation\n  3002→|OpenAPI/Swagger specs for ProfileService and EngagementService, auto-generated API docs\n  3003→\n  3004→|NFR-MAINT-003\n  3005→|Deployment automation\n  3006→|Infrastructure as Code (Terraform/CloudFormation/CDK), zero-downtime deployments\n  3007→\n  3008→|NFR-MAINT-004\n  3009→|Logging: structured logs\n  3010→|JSON-formatted logs with correlation IDs, log levels (DEBUG, INFO, WARN, ERROR), centralized log aggregation\n  3011→\n  3012→|NFR-MAINT-005\n  3013→|Monitoring dashboards\n  3014→|Real-time dashboards for ProfileService, EngagementService, Event Bus (see Monitoring and Observability section)\n  3015→\n  3016→|NFR-MAINT-006\n  3017→|Alerting and on-call\n  3018→|PagerDuty/Opsgenie integration for P1/P2 alerts, on-call rotation for ops team\n  3019→\n  3020→|NFR-MAINT-007\n  3021→|Configuration management\n  3022→|Externalized configuration (environment variables, AWS Parameter Store), no hardcoded config\n  3023→\n  3024→|NFR-MAINT-008\n  3025→|Versioning: API and events\n  3026→|Semantic versioning (v1, v2), backward compatibility for API changes, event schema evolution\n  3027→\n  3028→|===\n  3029→\n  3030→=== Usability Requirements\n  3031→\n  3032→[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n  3033→|===\n  3034→|ID |Requirement |Target\n  3035→\n  3036→|NFR-USE-001\n  3037→|Feedback submission UX\n  3038→|Mobile App user receives immediate \"Feedback submitted\" confirmation (< 1 second), not blocked by async Case creation\n  3039→\n  3040→|NFR-USE-002\n  3041→|Push notification delivery\n  3042→|Customer receives \"Your feedback has been received\" notification within 30 seconds of Case creation in Salesforce\n  3043→\n  3044→|NFR-USE-003\n  3045→|Case resolution notification\n  3046→|Customer receives \"Your case has been resolved\" notification within 30 seconds of support agent resolving Case\n  3047→\n  3048→|NFR-USE-004\n  3049→|Error messaging\n  3050→|User-friendly error messages for failed feedback submission (not technical errors), retry prompts\n  3051→\n  3052→|NFR-USE-005\n  3053→|Accessibility\n  3054→|Mobile App feedback form meets WCAG 2.1 AA accessibility standards (existing Mobile App compliance)\n  3055→\n  3056→|===\n  3057→\n  3058→=== Compliance Requirements\n  3059→\n  3060→[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n  3061→|===\n  3062→|ID |Requirement |Target\n  3063→\n  3064→|NFR-COMP-001\n  3065→|GDPR compliance: PII data\n  3066→|Customer Contact data (email, phone, name) managed per GDPR retention policies (Salesforce governance)\n  3067→\n  3068→|NFR-COMP-002\n  3069→|GDPR compliance: Right to erasure\n  3070→|Support \"Delete Account\" feedback category, trigger Contact deletion in Salesforce per GDPR Article 17\n  3071→\n  3072→|NFR-COMP-003\n  3073→|Data residency\n  3074→|Salesforce data residency governed by Viva Energy Salesforce configuration (regional compliance)\n  3075→\n  3076→|NFR-COMP-004\n  3077→|Audit trail\n  3078→|All Contact creates/updates, Case creates/updates logged for compliance auditing (Salesforce audit logs)\n  3079→\n  3080→|NFR-COMP-005\n  3081→|API security standards\n  3082→|OWASP API Security Top 10 compliance (injection prevention, authentication, authorisation, data exposure)\n  3083→\n  3084→|===\n  3085→\n  3086→== Monitoring and Observability\n  3087→\n  3088→=== Key Metrics\n  3089→\n  3090→[width=\"100%\",cols=\"25%,40%,35%\",options=\"header\",]\n  3091→|===\n  3092→|Metric Category |Metric |Target/Threshold\n  3093→\n  3094→|*Feedback Submission*\n  3095→|Feedback submission success rate (Mobile App → EngagementService)\n  3096→|> 99.5%\n  3097→\n  3098→|*Async Case Creation*\n  3099→|Case creation success rate (EngagementService → Salesforce)\n  3100→|> 99%\n  3101→\n  3102→|*Async Case Creation*\n  3103→|Case creation latency (time from feedback submission to Case created in Salesforce)\n  3104→|p95 < 5 minutes\n  3105→\n  3106→|*Event Bus*\n  3107→|Event Bus queue depth (pending Case creations)\n  3108→|< 100 messages\n  3109→\n  3110→|*Event Bus*\n  3111→|Dead letter queue depth (failed Case creations)\n  3112→|= 0 (alert on any failures)\n  3113→\n  3114→|*Salesforce API*\n  3115→|Salesforce API error rate\n  3116→|< 1%\n  3117→\n  3118→|*Salesforce API*\n  3119→|Salesforce API latency (Case creation)\n  3120→|p95 < 2 seconds\n  3121→\n  3122→|*Salesforce API*\n  3123→|Salesforce API rate limit utilization\n  3124→|< 80% of limit\n  3125→\n  3126→|*ProfileService*\n  3127→|Contact reconciliation success rate (JIT lookups)\n  3128→|> 99.5%\n  3129→\n  3130→|*ProfileService*\n  3131→|Contact reconciliation latency\n  3132→|p95 < 500ms\n  3133→\n  3134→|*Braze Notifications*\n  3135→|Push notification delivery rate (Case created/updated)\n  3136→|> 95%\n  3137→\n  3138→|*Salesforce Webhook*\n  3139→|Webhook delivery success rate (Salesforce → EngagementService)\n  3140→|> 99%\n  3141→\n  3142→|*Customer Satisfaction*\n  3143→|Customer satisfaction score (CSAT)\n  3144→|> 4.0/5.0 (improve by 15% from D365 CE baseline)\n  3145→\n  3146→|*Support Operations*\n  3147→|Average case resolution time\n  3148→|Decrease by 20% from D365 CE baseline\n  3149→\n  3150→|===\n  3151→\n  3152→=== Alerting Thresholds\n  3153→\n  3154→[width=\"100%\",cols=\"25%,50%,25%\",options=\"header\",]\n  3155→|===\n  3156→|Alert |Condition |Severity\n  3157→\n  3158→|*Feedback submission failures*\n  3159→|Feedback submission success rate < 95% over 5-minute window\n  3160→|P1 - Critical\n  3161→\n  3162→|*Dead letter queue accumulation*\n  3163→|Dead letter queue depth > 0 (any failed Case creations)\n  3164→|P2 - High\n  3165→\n  3166→|*Event Bus queue backlog*\n  3167→|Event Bus queue depth > 100 messages for > 15 minutes\n  3168→|P2 - High\n  3169→\n  3170→|*Salesforce API errors*\n  3171→|Salesforce API error rate > 5% over 5-minute window\n  3172→|P1 - Critical\n  3173→\n  3174→|*Salesforce API rate limits*\n  3175→|Salesforce API rate limit utilization > 90%\n  3176→|P2 - High\n  3177→\n  3178→|*Contact reconciliation failures*\n  3179→|ProfileService Contact reconciliation failure rate > 5% over 5-minute window\n  3180→|P2 - High\n  3181→\n  3182→|*Braze notification failures*\n  3183→|Braze push notification delivery rate < 80% over 15-minute window\n  3184→|P3 - Medium\n  3185→\n  3186→|*Salesforce webhook failures*\n  3187→|Salesforce webhook delivery success rate < 90% over 15-minute window\n  3188→|P2 - High\n  3189→\n  3190→|*Case creation latency*\n  3191→|Case creation latency p95 > 10 minutes\n  3192→|P3 - Medium\n  3193→\n  3194→|===\n  3195→\n  3196→=== Dashboards\n  3197→\n  3198→*ProfileService Dashboard:*\n  3199→\n  3200→* Contact reconciliation success rate (JIT lookups)\n  3201→* Contact reconciliation latency (p50, p95, p99)\n  3202→* Contact creation vs update ratio (new Contacts created vs existing Contacts updated)\n  3203→* Salesforce API error rate (Contact queries and creates)\n  3204→* Request rate and throughput\n  3205→\n  3206→*EngagementService Dashboard:*\n  3207→\n  3208→* Feedback submission success rate\n  3209→* Case creation success rate (async workflow)\n  3210→* Case creation latency (p50, p95, p99)\n  3211→* Event Bus queue depth (pending Case creations)\n  3212→* Dead letter queue depth (failed Case creations)\n  3213→* Salesforce API error rate (Case creation)\n  3214→* Salesforce API latency\n  3215→* Salesforce API rate limit utilization\n  3216→* Braze push notification delivery rate\n  3217→* Salesforce webhook delivery success rate\n  3218→\n  3219→*Event Bus Dashboard:*\n  3220→\n  3221→* Queue depth (pending messages)\n  3222→* Throughput (messages published/consumed per minute)\n  3223→* Dead letter queue depth (failed messages)\n  3224→* Consumer lag (time between publish and consume)\n  3225→\n  3226→*Customer Support Dashboard (Business Metrics):*\n  3227→\n  3228→* Total feedback submissions per day/week/month\n  3229→* Feedback category breakdown (App, Service, Order, Rewards, Refund, Delete Account)\n  3230→* Customer satisfaction score (CSAT) trend\n  3231→* Average case resolution time trend\n  3232→* Case volume by support team/queue\n  3233→* Unified customer view adoption (support agent feedback)\n  3234→<<<\n  3235→== Solution Validation\n  3236→\n  3237→This section defines the validation criteria and testing approach for the solution.\n  3238→\n  3239→=== Functional Validation\n  3240→\n  3241→==== ProfileService API Testing\n  3242→\n  3243→*Test Scenarios*:\n  3244→1. **Happy Path**: Authenticated user requests Contact ID, existing Contact found in Salesforce, Contact ID returned\n  3245→2. **JIT Creation**: Authenticated user requests Contact ID, no existing Contact, new Contact created in Salesforce, Contact ID returned\n  3246→3. **Salesforce API Failure**: Salesforce unavailable, ProfileService returns 500 error, user retries\n  3247→4. **Invalid JWT**: Unauthenticated request, ProfileService returns 401 error\n  3248→\n  3249→*Acceptance Criteria*:\n  3250→- Contact reconciliation success rate > 99.5%\n  3251→- JIT Contact creation completes within 500ms (p95)\n  3252→\n  3253→==== EngagementService API Testing\n  3254→\n  3255→*Test Scenarios*:\n  3256→1. **Happy Path**: Valid feedback submission, immediate 202 Accepted response, Case created in Salesforce within 5 minutes, Braze notification delivered\n  3257→2. **Invalid Category**: Invalid feedback category, 400 Bad Request response with validation error\n  3258→3. **Salesforce Downtime**: Salesforce unavailable during async Case creation, message queued, retry logic executes, Case created when Salesforce recovers\n  3259→4. **Dead Letter Queue**: Case creation fails after 5 retries, message moved to DLQ, ops team alerted\n  3260→5. **Webhook Notification**: Support agent resolves Case in Salesforce, webhook triggers EngagementService, Braze push notification sent to customer\n  3261→\n  3262→*Acceptance Criteria*:\n  3263→- Feedback submission success rate > 99.5% (including async Case creation)\n  3264→- Async Case creation completes within 5 minutes (p95)\n  3265→- Webhook delivery success rate > 99%\n  3266→\n  3267→=== Non-Functional Validation\n  3268→\n  3269→==== Performance Testing\n  3270→\n  3271→*Load Testing*:\n  3272→\n  3273→*Baseline*: Expected 100-150 submissions/day from 20k DAU (~0.5-0.75% submission rate)\n  3274→\n  3275→- **Normal Load**: 1 submission/minute sustained for 2 hours (simulate typical daily pattern)\n  3276→- **3x Load**: 3 submissions/minute sustained for 1 hour (simulate busy period, 450 submissions/day)\n  3277→- **Peak Load (10x)**: 10 submissions/minute for 15 minutes (simulate incident scenario, app outage causing backlog)\n  3278→- **Stress Test**: 50 submissions/minute for 5 minutes (find breaking point, 20x normal)\n  3279→\n  3280→*Validation*:\n  3281→- API response time p95 < 1 second under 10x load\n  3282→- Event Bus queue depth remains manageable (< 100 messages)\n  3283→- No Case creation failures, all submissions processed successfully\n  3284→- Auto-scaling triggers appropriately for sustained load > 3x baseline\n  3285→\n  3286→*Acceptance Criteria*:\n  3287→- NFR-PERF-001 through NFR-PERF-006 validated under realistic load (3x and 10x baseline)\n  3288→- Auto-scaling triggers within 2 minutes of load increase\n  3289→- System handles 10x peak gracefully, 20x stress test identifies limits\n  3290→\n  3291→==== Resilience Testing\n  3292→\n  3293→*Salesforce API Failure Scenarios*:\n  3294→1. **Complete Outage**: Salesforce unavailable for 2 hours, Event Bus queues buffer work, Cases created when Salesforce recovers\n  3295→2. **Rate Limit Exceeded**: Salesforce rate limit hit, queue throttling activates, Cases created within SLA\n  3296→\n  3297→*Acceptance Criteria*:\n  3298→- NFR-AVAIL-004 validated (graceful degradation during Salesforce downtime)\n  3299→- Circuit breaker activates after 5 consecutive failures\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"ca88a892-06b9-4313-b832-595914d0d3a7","timestamp":"2026-01-09T04:59:50.602Z","toolUseResult":{"type":"text","file":{"filePath":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","content":"|NFR-SCALE-006\n|Future growth capacity\n|Architecture supports 10x growth (1,000-1,500 submissions/day based on 200k DAU) without major redesign\n\n|===\n\n=== Security Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-SEC-001\n|Mobile App authentication\n|Microsoft Entra External ID OAuth 2.0 with JWT tokens (existing CIAM)\n\n|NFR-SEC-002\n|API authorisation: ProfileService and EngagementService\n|JWT token validation, authenticated users only, user context propagation\n\n|NFR-SEC-003\n|Salesforce API authentication\n|OAuth 2.0 with Connected App and JWT bearer flow (service account)\n\n|NFR-SEC-004\n|Data encryption in transit\n|TLS 1.2+ for all API calls (Mobile App ↔ ProfileService/EngagementService ↔ Salesforce ↔ Braze)\n\n|NFR-SEC-005\n|Data encryption at rest\n|Salesforce encryption at rest (managed by Salesforce), Event Bus message encryption (AWS KMS)\n\n|NFR-SEC-006\n|Secret management\n|AWS Secrets Manager for Salesforce credentials, Braze API keys, OAuth tokens (no hardcoded secrets)\n\n|NFR-SEC-007\n|PII data handling\n|Contact data (email, phone, name) treated as PII, GDPR-compliant retention policies (Salesforce governance)\n\n|NFR-SEC-008\n|API rate limiting and throttling\n|API Gateway rate limiting (100 requests/second per user), prevent abuse and DoS\n\n|NFR-SEC-009\n|Logging and auditing\n|Log all API calls, Salesforce Contact/Case creates/updates, Event Bus publishes (no PII in logs)\n\n|NFR-SEC-010\n|Salesforce data isolation\n|Multi-tenant data isolation via Salesforce Record Types, queues, sharing rules (defined by Viva Energy admin team)\n\n|===\n\n=== Reliability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-REL-001\n|Retry logic: EngagementService → Salesforce Case creation\n|Exponential backoff (1s, 2s, 4s, 8s, 16s), max 5 retries, then dead letter queue\n\n|NFR-REL-002\n|Dead letter queue monitoring\n|Alert ops team immediately when DLQ depth > 0 (failed Case creations require manual intervention)\n\n|NFR-REL-003\n|Event Bus message durability\n|Messages persisted in Event Bus (SNS+SQS/EventBridge/Kinesis), not lost on service restart\n\n|NFR-REL-004\n|Idempotency: Case creation\n|EngagementService ensures duplicate feedback submissions don't create duplicate Cases (idempotency key)\n\n|NFR-REL-005\n|Circuit breaker: Salesforce API calls\n|Open circuit after 5 consecutive failures, half-open retry after 30 seconds\n\n|NFR-REL-006\n|Health checks: ProfileService and EngagementService\n|Health endpoints for load balancer checks, readiness and liveness probes\n\n|NFR-REL-007\n|Disaster recovery: Event Bus\n|Event Bus messages replicated across AWS availability zones (SQS/EventBridge/Kinesis HA)\n\n|===\n\n=== Maintainability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-MAINT-001\n|Code quality: ProfileService and EngagementService\n|> 80% test coverage (unit + integration tests), automated CI/CD pipeline\n\n|NFR-MAINT-002\n|API documentation\n|OpenAPI/Swagger specs for ProfileService and EngagementService, auto-generated API docs\n\n|NFR-MAINT-003\n|Deployment automation\n|Infrastructure as Code (Terraform/CloudFormation/CDK), zero-downtime deployments\n\n|NFR-MAINT-004\n|Logging: structured logs\n|JSON-formatted logs with correlation IDs, log levels (DEBUG, INFO, WARN, ERROR), centralized log aggregation\n\n|NFR-MAINT-005\n|Monitoring dashboards\n|Real-time dashboards for ProfileService, EngagementService, Event Bus (see Monitoring and Observability section)\n\n|NFR-MAINT-006\n|Alerting and on-call\n|PagerDuty/Opsgenie integration for P1/P2 alerts, on-call rotation for ops team\n\n|NFR-MAINT-007\n|Configuration management\n|Externalized configuration (environment variables, AWS Parameter Store), no hardcoded config\n\n|NFR-MAINT-008\n|Versioning: API and events\n|Semantic versioning (v1, v2), backward compatibility for API changes, event schema evolution\n\n|===\n\n=== Usability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-USE-001\n|Feedback submission UX\n|Mobile App user receives immediate \"Feedback submitted\" confirmation (< 1 second), not blocked by async Case creation\n\n|NFR-USE-002\n|Push notification delivery\n|Customer receives \"Your feedback has been received\" notification within 30 seconds of Case creation in Salesforce\n\n|NFR-USE-003\n|Case resolution notification\n|Customer receives \"Your case has been resolved\" notification within 30 seconds of support agent resolving Case\n\n|NFR-USE-004\n|Error messaging\n|User-friendly error messages for failed feedback submission (not technical errors), retry prompts\n\n|NFR-USE-005\n|Accessibility\n|Mobile App feedback form meets WCAG 2.1 AA accessibility standards (existing Mobile App compliance)\n\n|===\n\n=== Compliance Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-COMP-001\n|GDPR compliance: PII data\n|Customer Contact data (email, phone, name) managed per GDPR retention policies (Salesforce governance)\n\n|NFR-COMP-002\n|GDPR compliance: Right to erasure\n|Support \"Delete Account\" feedback category, trigger Contact deletion in Salesforce per GDPR Article 17\n\n|NFR-COMP-003\n|Data residency\n|Salesforce data residency governed by Viva Energy Salesforce configuration (regional compliance)\n\n|NFR-COMP-004\n|Audit trail\n|All Contact creates/updates, Case creates/updates logged for compliance auditing (Salesforce audit logs)\n\n|NFR-COMP-005\n|API security standards\n|OWASP API Security Top 10 compliance (injection prevention, authentication, authorisation, data exposure)\n\n|===\n\n== Monitoring and Observability\n\n=== Key Metrics\n\n[width=\"100%\",cols=\"25%,40%,35%\",options=\"header\",]\n|===\n|Metric Category |Metric |Target/Threshold\n\n|*Feedback Submission*\n|Feedback submission success rate (Mobile App → EngagementService)\n|> 99.5%\n\n|*Async Case Creation*\n|Case creation success rate (EngagementService → Salesforce)\n|> 99%\n\n|*Async Case Creation*\n|Case creation latency (time from feedback submission to Case created in Salesforce)\n|p95 < 5 minutes\n\n|*Event Bus*\n|Event Bus queue depth (pending Case creations)\n|< 100 messages\n\n|*Event Bus*\n|Dead letter queue depth (failed Case creations)\n|= 0 (alert on any failures)\n\n|*Salesforce API*\n|Salesforce API error rate\n|< 1%\n\n|*Salesforce API*\n|Salesforce API latency (Case creation)\n|p95 < 2 seconds\n\n|*Salesforce API*\n|Salesforce API rate limit utilization\n|< 80% of limit\n\n|*ProfileService*\n|Contact reconciliation success rate (JIT lookups)\n|> 99.5%\n\n|*ProfileService*\n|Contact reconciliation latency\n|p95 < 500ms\n\n|*Braze Notifications*\n|Push notification delivery rate (Case created/updated)\n|> 95%\n\n|*Salesforce Webhook*\n|Webhook delivery success rate (Salesforce → EngagementService)\n|> 99%\n\n|*Customer Satisfaction*\n|Customer satisfaction score (CSAT)\n|> 4.0/5.0 (improve by 15% from D365 CE baseline)\n\n|*Support Operations*\n|Average case resolution time\n|Decrease by 20% from D365 CE baseline\n\n|===\n\n=== Alerting Thresholds\n\n[width=\"100%\",cols=\"25%,50%,25%\",options=\"header\",]\n|===\n|Alert |Condition |Severity\n\n|*Feedback submission failures*\n|Feedback submission success rate < 95% over 5-minute window\n|P1 - Critical\n\n|*Dead letter queue accumulation*\n|Dead letter queue depth > 0 (any failed Case creations)\n|P2 - High\n\n|*Event Bus queue backlog*\n|Event Bus queue depth > 100 messages for > 15 minutes\n|P2 - High\n\n|*Salesforce API errors*\n|Salesforce API error rate > 5% over 5-minute window\n|P1 - Critical\n\n|*Salesforce API rate limits*\n|Salesforce API rate limit utilization > 90%\n|P2 - High\n\n|*Contact reconciliation failures*\n|ProfileService Contact reconciliation failure rate > 5% over 5-minute window\n|P2 - High\n\n|*Braze notification failures*\n|Braze push notification delivery rate < 80% over 15-minute window\n|P3 - Medium\n\n|*Salesforce webhook failures*\n|Salesforce webhook delivery success rate < 90% over 15-minute window\n|P2 - High\n\n|*Case creation latency*\n|Case creation latency p95 > 10 minutes\n|P3 - Medium\n\n|===\n\n=== Dashboards\n\n*ProfileService Dashboard:*\n\n* Contact reconciliation success rate (JIT lookups)\n* Contact reconciliation latency (p50, p95, p99)\n* Contact creation vs update ratio (new Contacts created vs existing Contacts updated)\n* Salesforce API error rate (Contact queries and creates)\n* Request rate and throughput\n\n*EngagementService Dashboard:*\n\n* Feedback submission success rate\n* Case creation success rate (async workflow)\n* Case creation latency (p50, p95, p99)\n* Event Bus queue depth (pending Case creations)\n* Dead letter queue depth (failed Case creations)\n* Salesforce API error rate (Case creation)\n* Salesforce API latency\n* Salesforce API rate limit utilization\n* Braze push notification delivery rate\n* Salesforce webhook delivery success rate\n\n*Event Bus Dashboard:*\n\n* Queue depth (pending messages)\n* Throughput (messages published/consumed per minute)\n* Dead letter queue depth (failed messages)\n* Consumer lag (time between publish and consume)\n\n*Customer Support Dashboard (Business Metrics):*\n\n* Total feedback submissions per day/week/month\n* Feedback category breakdown (App, Service, Order, Rewards, Refund, Delete Account)\n* Customer satisfaction score (CSAT) trend\n* Average case resolution time trend\n* Case volume by support team/queue\n* Unified customer view adoption (support agent feedback)\n<<<\n== Solution Validation\n\nThis section defines the validation criteria and testing approach for the solution.\n\n=== Functional Validation\n\n==== ProfileService API Testing\n\n*Test Scenarios*:\n1. **Happy Path**: Authenticated user requests Contact ID, existing Contact found in Salesforce, Contact ID returned\n2. **JIT Creation**: Authenticated user requests Contact ID, no existing Contact, new Contact created in Salesforce, Contact ID returned\n3. **Salesforce API Failure**: Salesforce unavailable, ProfileService returns 500 error, user retries\n4. **Invalid JWT**: Unauthenticated request, ProfileService returns 401 error\n\n*Acceptance Criteria*:\n- Contact reconciliation success rate > 99.5%\n- JIT Contact creation completes within 500ms (p95)\n\n==== EngagementService API Testing\n\n*Test Scenarios*:\n1. **Happy Path**: Valid feedback submission, immediate 202 Accepted response, Case created in Salesforce within 5 minutes, Braze notification delivered\n2. **Invalid Category**: Invalid feedback category, 400 Bad Request response with validation error\n3. **Salesforce Downtime**: Salesforce unavailable during async Case creation, message queued, retry logic executes, Case created when Salesforce recovers\n4. **Dead Letter Queue**: Case creation fails after 5 retries, message moved to DLQ, ops team alerted\n5. **Webhook Notification**: Support agent resolves Case in Salesforce, webhook triggers EngagementService, Braze push notification sent to customer\n\n*Acceptance Criteria*:\n- Feedback submission success rate > 99.5% (including async Case creation)\n- Async Case creation completes within 5 minutes (p95)\n- Webhook delivery success rate > 99%\n\n=== Non-Functional Validation\n\n==== Performance Testing\n\n*Load Testing*:\n\n*Baseline*: Expected 100-150 submissions/day from 20k DAU (~0.5-0.75% submission rate)\n\n- **Normal Load**: 1 submission/minute sustained for 2 hours (simulate typical daily pattern)\n- **3x Load**: 3 submissions/minute sustained for 1 hour (simulate busy period, 450 submissions/day)\n- **Peak Load (10x)**: 10 submissions/minute for 15 minutes (simulate incident scenario, app outage causing backlog)\n- **Stress Test**: 50 submissions/minute for 5 minutes (find breaking point, 20x normal)\n\n*Validation*:\n- API response time p95 < 1 second under 10x load\n- Event Bus queue depth remains manageable (< 100 messages)\n- No Case creation failures, all submissions processed successfully\n- Auto-scaling triggers appropriately for sustained load > 3x baseline\n\n*Acceptance Criteria*:\n- NFR-PERF-001 through NFR-PERF-006 validated under realistic load (3x and 10x baseline)\n- Auto-scaling triggers within 2 minutes of load increase\n- System handles 10x peak gracefully, 20x stress test identifies limits\n\n==== Resilience Testing\n\n*Salesforce API Failure Scenarios*:\n1. **Complete Outage**: Salesforce unavailable for 2 hours, Event Bus queues buffer work, Cases created when Salesforce recovers\n2. **Rate Limit Exceeded**: Salesforce rate limit hit, queue throttling activates, Cases created within SLA\n\n*Acceptance Criteria*:\n- NFR-AVAIL-004 validated (graceful degradation during Salesforce downtime)\n- Circuit breaker activates after 5 consecutive failures","numLines":400,"startLine":2900,"totalLines":3329}},"sourceToolAssistantUUID":"ef8a3fe9-47b1-4102-beae-2131d22c0afe"}
{"parentUuid":"72cebc78-2551-41e4-8c74-eb460b55bbfc","isSidechain":true,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","agentId":"a7dc162","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01RVnzzhP8JHLKqjpeWndrs1","type":"tool_result","content":"26:== Purpose and Scope\n64:== Executive Summary\n73:== Solution Approach\n110:== Key Technology Decisions\n227:== Solution Building Blocks\n1536:== Data Architecture\n1741:== Interface Specifications\n3242:== Gap Analysis\n3377:== Work Packages\n4299:== Transition Architecture\n4944:== Solution Validation","is_error":false}]},"uuid":"d07d29a8-e001-48bb-8ba4-204b686b48c8","timestamp":"2026-01-09T04:59:50.655Z","toolUseResult":{"stdout":"26:== Purpose and Scope\n64:== Executive Summary\n73:== Solution Approach\n110:== Key Technology Decisions\n227:== Solution Building Blocks\n1536:== Data Architecture\n1741:== Interface Specifications\n3242:== Gap Analysis\n3377:== Work Packages\n4299:== Transition Architecture\n4944:== Solution Validation","stderr":"","interrupted":false,"isImage":false},"sourceToolAssistantUUID":"72cebc78-2551-41e4-8c74-eb460b55bbfc"}
{"parentUuid":"d07d29a8-e001-48bb-8ba4-204b686b48c8","isSidechain":true,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","agentId":"a7dc162","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01S2LGiik72Hpm4dotrAdMNT","type":"message","role":"assistant","content":[{"type":"text","text":"Perfect. Now let me create a comprehensive restructuring plan. Let me also check what's in the Key Technology Decisions section and what ADRs look like in Salesforce."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":7031,"cache_read_input_tokens":34189,"cache_creation":{"ephemeral_5m_input_tokens":7031,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWwDPfyeRkeWzBufQS1dc","type":"assistant","uuid":"8bd5e5e9-8eb6-4c13-9992-60326fc5c341","timestamp":"2026-01-09T04:59:55.195Z"}
{"parentUuid":"8bd5e5e9-8eb6-4c13-9992-60326fc5c341","isSidechain":true,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","agentId":"a7dc162","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01S2LGiik72Hpm4dotrAdMNT","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_016PgTwFidio6vS4NUwNrm5C","name":"Read","input":{"file_path":"/mnt/c/Users/o.young/work/architecture/solution_architectures/flybuys_integration.adoc","offset":110,"limit":120}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":7031,"cache_read_input_tokens":34189,"cache_creation":{"ephemeral_5m_input_tokens":7031,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWwDPfyeRkeWzBufQS1dc","type":"assistant","uuid":"d4a64fb2-7d9b-4af1-9c33-2750eaa574e2","timestamp":"2026-01-09T04:59:56.593Z"}
{"parentUuid":"d4a64fb2-7d9b-4af1-9c33-2750eaa574e2","isSidechain":true,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","agentId":"a7dc162","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01S2LGiik72Hpm4dotrAdMNT","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01HjuAqURDVFK1jqwuM8YiXq","name":"Bash","input":{"command":"grep -A 30 \"^=== Architecture Decisions\" /mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc | head -50","description":"Get ADR section from Salesforce"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":7031,"cache_read_input_tokens":34189,"cache_creation":{"ephemeral_5m_input_tokens":7031,"ephemeral_1h_input_tokens":0},"output_tokens":259,"service_tier":"standard"}},"requestId":"req_011CWwDPfyeRkeWzBufQS1dc","type":"assistant","uuid":"0cfe504f-0a69-41e5-8eda-81ea3677c97d","timestamp":"2026-01-09T04:59:57.825Z"}
{"parentUuid":"d4a64fb2-7d9b-4af1-9c33-2750eaa574e2","isSidechain":true,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","agentId":"a7dc162","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_016PgTwFidio6vS4NUwNrm5C","type":"tool_result","content":"   110→== Key Technology Decisions\n   111→\n   112→[cols=\"1,2,4,3\"]\n   113→|===\n   114→| ID | Kind | Description | Rationale\n   115→\n   116→| DEC-001\n   117→| Implementation\n   118→| .NET 8.0\n   119→| Aligns with OTR platform standards, team expertise in C#\n   120→\n   121→| DEC-002\n   122→| Hosting\n   123→| #TBD#\n   124→| Autoscaling, managed infrastructure, Docker support\n   125→\n   126→| DEC-003\n   127→| NoSQL Database\n   128→| #TBD#\n   129→| Partition key performance, global distribution, TTL support\n   130→\n   131→| DEC-004\n   132→| Event Bus\n   133→| #TBD#\n   134→| CloudEvents 1.0 standard, built-in retry, dead letter queue\n   135→\n   136→| DEC-005\n   137→| Key Storage\n   138→| #TBD#\n   139→| SaaS OAuth provider, Flybuys IDP integration, reduces custom implementation risk\n   140→\n   141→| DEC-006\n   142→| Data Processing\n   143→| #TBD#\n   144→| SFTP connector, PGP encryption, scheduling\n   145→\n   146→| DEC-007\n   147→| Monitoring\n   148→| #TBD#\n   149→| Native Azure integration, distributed tracing, correlation IDs\n   150→\n   151→| DEC-008\n   152→| API Gateway\n   153→| #TBD#\n   154→| OAuth validation, rate limiting, request transformation\n   155→\n   156→| DEC-009\n   157→| Caching Layer\n   158→| #TBD#\n   159→| Reduces Flybuys API load, low-latency access\n   160→\n   161→| DEC-010\n   162→| Mobile App\n   163→| #TBD#\n   164→| Shared business logic, reduces duplicate code for iOS/Android\n   165→\n   166→| DEC-011\n   167→| Authentication\n   168→| xref:bounded-contexts:microsoft_entra_external_id.adoc[Microsoft Entra External ID]\n   169→| Standardised auth, secure token handling, integrates with mobile app\n   170→\n   171→| DEC-013\n   172→| Resilience\n   173→| #TBD#\n   174→| Circuit breaker, retry policies for external API calls\n   175→\n   176→| DEC-014\n   177→| Configuration / Feature Flags\n   178→| #TBD#\n   179→| Dynamic feature toggling, reduces deployment risk\n   180→\n   181→| DEC-015\n   182→| Transport\n   183→| REST over HTTPS\n   184→|\n   185→\n   186→| DEC-016\n   187→| Observability\n   188→| #TBD#\n   189→|\n   190→\n   191→| DEC-017\n   192→| Deployment\n   193→| #TBD#\n   194→| Docker container + Azure Container Registry\n   195→\n   196→| DEC-018\n   197→| Encryption (At Rest)\n   198→| AES-256\n   199→|\n   200→\n   201→| DEC-019\n   202→| Encryption (In Flight)\n   203→| TLS 1.3\n   204→|\n   205→\n   206→| DEC-020\n   207→| Schema Registry\n   208→| #TBD#\n   209→|\n   210→|===\n   211→\n   212→=== Implementation Constraints\n   213→\n   214→* Must conform to Flybuys API specifications - cannot modify (xref:architecture-definitions:flybuys_integration.adoc#constraints[CON-002])\n   215→* Flybuys partnership potentially term 2-3 years - architecture must support partner flexibility (xref:architecture-definitions:flybuys_integration.adoc#constraints[CON-006])\n   216→* OAuth tokens must be `AES-256` encrypted at rest (<<key-technology-decisions,DEC-018>>), `TLS 1.3` in transit (DEC-018 xref:architecture-definitions:flybuys_integration.adoc#constraints[CON-003])\n   217→* Customer data must reside in Australia East region (xref:architecture-definitions:flybuys_integration.adoc#constraints[CON-011])\n   218→* Phased rollout required, no big-bang deployment (xref:architecture-definitions:flybuys_integration.adoc#constraints[CON-004])\n   219→\n   220→=== Success Criteria\n   221→\n   222→* xref:bounded-contexts:profile.adoc[Profile Service] / xref:bounded-contexts:loyalty.adoc[Loyalty Service] APIs operational with <`500ms` `p95` latency (NFR-001, NFR-002)\n   223→* OAuth linking success rate >95% over 30-day pilot period (7.5 Validation Exit Criteria)\n   224→* Flybuys batch acknowledgement rate >98% for 60 days (NFR-016)\n   225→\n   226→<<<\n   227→== Solution Building Blocks\n   228→\n   229→This section maps the conceptual *Architecture Building Blocks* (ABBs) defined in the xref:architecture-definitions:flybuys_integration.adoc[Architecture Definition] to specific *Solution Building Blocks* (SBBs).\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"f0213637-354e-4806-b05a-e6f89e3c4566","timestamp":"2026-01-09T04:59:58.247Z","toolUseResult":{"type":"text","file":{"filePath":"/mnt/c/Users/o.young/work/architecture/solution_architectures/flybuys_integration.adoc","content":"== Key Technology Decisions\n\n[cols=\"1,2,4,3\"]\n|===\n| ID | Kind | Description | Rationale\n\n| DEC-001\n| Implementation\n| .NET 8.0\n| Aligns with OTR platform standards, team expertise in C#\n\n| DEC-002\n| Hosting\n| #TBD#\n| Autoscaling, managed infrastructure, Docker support\n\n| DEC-003\n| NoSQL Database\n| #TBD#\n| Partition key performance, global distribution, TTL support\n\n| DEC-004\n| Event Bus\n| #TBD#\n| CloudEvents 1.0 standard, built-in retry, dead letter queue\n\n| DEC-005\n| Key Storage\n| #TBD#\n| SaaS OAuth provider, Flybuys IDP integration, reduces custom implementation risk\n\n| DEC-006\n| Data Processing\n| #TBD#\n| SFTP connector, PGP encryption, scheduling\n\n| DEC-007\n| Monitoring\n| #TBD#\n| Native Azure integration, distributed tracing, correlation IDs\n\n| DEC-008\n| API Gateway\n| #TBD#\n| OAuth validation, rate limiting, request transformation\n\n| DEC-009\n| Caching Layer\n| #TBD#\n| Reduces Flybuys API load, low-latency access\n\n| DEC-010\n| Mobile App\n| #TBD#\n| Shared business logic, reduces duplicate code for iOS/Android\n\n| DEC-011\n| Authentication\n| xref:bounded-contexts:microsoft_entra_external_id.adoc[Microsoft Entra External ID]\n| Standardised auth, secure token handling, integrates with mobile app\n\n| DEC-013\n| Resilience\n| #TBD#\n| Circuit breaker, retry policies for external API calls\n\n| DEC-014\n| Configuration / Feature Flags\n| #TBD#\n| Dynamic feature toggling, reduces deployment risk\n\n| DEC-015\n| Transport\n| REST over HTTPS\n|\n\n| DEC-016\n| Observability\n| #TBD#\n|\n\n| DEC-017\n| Deployment\n| #TBD#\n| Docker container + Azure Container Registry\n\n| DEC-018\n| Encryption (At Rest)\n| AES-256\n|\n\n| DEC-019\n| Encryption (In Flight)\n| TLS 1.3\n|\n\n| DEC-020\n| Schema Registry\n| #TBD#\n|\n|===\n\n=== Implementation Constraints\n\n* Must conform to Flybuys API specifications - cannot modify (xref:architecture-definitions:flybuys_integration.adoc#constraints[CON-002])\n* Flybuys partnership potentially term 2-3 years - architecture must support partner flexibility (xref:architecture-definitions:flybuys_integration.adoc#constraints[CON-006])\n* OAuth tokens must be `AES-256` encrypted at rest (<<key-technology-decisions,DEC-018>>), `TLS 1.3` in transit (DEC-018 xref:architecture-definitions:flybuys_integration.adoc#constraints[CON-003])\n* Customer data must reside in Australia East region (xref:architecture-definitions:flybuys_integration.adoc#constraints[CON-011])\n* Phased rollout required, no big-bang deployment (xref:architecture-definitions:flybuys_integration.adoc#constraints[CON-004])\n\n=== Success Criteria\n\n* xref:bounded-contexts:profile.adoc[Profile Service] / xref:bounded-contexts:loyalty.adoc[Loyalty Service] APIs operational with <`500ms` `p95` latency (NFR-001, NFR-002)\n* OAuth linking success rate >95% over 30-day pilot period (7.5 Validation Exit Criteria)\n* Flybuys batch acknowledgement rate >98% for 60 days (NFR-016)\n\n<<<\n== Solution Building Blocks\n\nThis section maps the conceptual *Architecture Building Blocks* (ABBs) defined in the xref:architecture-definitions:flybuys_integration.adoc[Architecture Definition] to specific *Solution Building Blocks* (SBBs).","numLines":120,"startLine":110,"totalLines":5277}},"sourceToolAssistantUUID":"d4a64fb2-7d9b-4af1-9c33-2750eaa574e2"}
{"parentUuid":"0cfe504f-0a69-41e5-8eda-81ea3677c97d","isSidechain":true,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","agentId":"a7dc162","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01HjuAqURDVFK1jqwuM8YiXq","type":"tool_result","content":"=== Architecture Decisions\n\n==== ADR-CS-001: Consolidate onto Salesforce Service Cloud (not build custom solution)\n\n*Status*: Accepted\n\n*Context*:\n\n* D365 Customer Engagement not working well for digital customer support\n* Viva Energy already uses Salesforce Service Cloud for fuel wholesale, Shell Card, other retail channels\n* Post-merger opportunity to consolidate onto single platform\n* Alternative: Build custom support platform or use different SaaS\n\n*Decision*:\n\nConsolidate OTR digital customer support onto Salesforce Service Cloud (shared Viva Energy instance).\n\n*Rationale*:\n\n* **Unified customer view**: Support agents see all interactions across channels (digital, wholesale, Shell Card, retail)\n* **Platform consolidation**: Single support platform reduces operational overhead and costs\n* **Proven solution**: Salesforce Service Cloud is established, feature-rich, well-supported\n* **Post-merger alignment**: Strategic decision to standardize on Viva Energy platforms\n* **Avoid custom development**: Building custom support platform would be costly and high-risk\n\n*Consequences*:\n\n* Unified customer support across Viva Energy Group\n* Reduced operational complexity (single platform vs two)\n* Leverage Salesforce capabilities (case routing, knowledge base, AI, omnichannel)\n* ⚠️ Conformist pattern required (shared instance, conform to existing configuration)","is_error":false}]},"uuid":"f7b2ebba-4626-4aaf-9eb5-e1f58e910fe5","timestamp":"2026-01-09T04:59:58.456Z","toolUseResult":{"stdout":"=== Architecture Decisions\n\n==== ADR-CS-001: Consolidate onto Salesforce Service Cloud (not build custom solution)\n\n*Status*: Accepted\n\n*Context*:\n\n* D365 Customer Engagement not working well for digital customer support\n* Viva Energy already uses Salesforce Service Cloud for fuel wholesale, Shell Card, other retail channels\n* Post-merger opportunity to consolidate onto single platform\n* Alternative: Build custom support platform or use different SaaS\n\n*Decision*:\n\nConsolidate OTR digital customer support onto Salesforce Service Cloud (shared Viva Energy instance).\n\n*Rationale*:\n\n* **Unified customer view**: Support agents see all interactions across channels (digital, wholesale, Shell Card, retail)\n* **Platform consolidation**: Single support platform reduces operational overhead and costs\n* **Proven solution**: Salesforce Service Cloud is established, feature-rich, well-supported\n* **Post-merger alignment**: Strategic decision to standardize on Viva Energy platforms\n* **Avoid custom development**: Building custom support platform would be costly and high-risk\n\n*Consequences*:\n\n* Unified customer support across Viva Energy Group\n* Reduced operational complexity (single platform vs two)\n* Leverage Salesforce capabilities (case routing, knowledge base, AI, omnichannel)\n* ⚠️ Conformist pattern required (shared instance, conform to existing configuration)","stderr":"","interrupted":false,"isImage":false},"sourceToolAssistantUUID":"0cfe504f-0a69-41e5-8eda-81ea3677c97d"}
{"parentUuid":"f7b2ebba-4626-4aaf-9eb5-e1f58e910fe5","isSidechain":true,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","agentId":"a7dc162","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01XtyzUjjM79UWzXxek6sU8U","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me check the Assumptions and Constraints section and Non-Functional Requirements in Salesforce."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":2101,"cache_read_input_tokens":41220,"cache_creation":{"ephemeral_5m_input_tokens":2101,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWwDQFP4x8av2MxHtQEcq","type":"assistant","uuid":"fceb1109-b530-440d-886d-cbc246edbe8b","timestamp":"2026-01-09T05:00:02.047Z"}
{"parentUuid":"fceb1109-b530-440d-886d-cbc246edbe8b","isSidechain":true,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","agentId":"a7dc162","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01XtyzUjjM79UWzXxek6sU8U","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01FvCY9S8vNg1pjCRpRh11AD","name":"Bash","input":{"command":"grep -B 2 -A 20 \"^== Assumptions and Constraints\" /mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","description":"Get Assumptions and Constraints from Salesforce"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":2101,"cache_read_input_tokens":41220,"cache_creation":{"ephemeral_5m_input_tokens":2101,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWwDQFP4x8av2MxHtQEcq","type":"assistant","uuid":"d1c5e63f-994b-492f-8c83-dd500572c22c","timestamp":"2026-01-09T05:00:03.835Z"}
{"parentUuid":"d1c5e63f-994b-492f-8c83-dd500572c22c","isSidechain":true,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","agentId":"a7dc162","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01XtyzUjjM79UWzXxek6sU8U","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01WzKhAJxvQy5qKT4ptkDLng","name":"Bash","input":{"command":"grep -B 2 -A 10 \"^== Non-Functional Requirements\" /mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","description":"Get NFR section from Salesforce"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":2101,"cache_read_input_tokens":41220,"cache_creation":{"ephemeral_5m_input_tokens":2101,"ephemeral_1h_input_tokens":0},"output_tokens":258,"service_tier":"standard"}},"requestId":"req_011CWwDQFP4x8av2MxHtQEcq","type":"assistant","uuid":"1492826c-4bde-40e1-b4b2-4c6b174d8c96","timestamp":"2026-01-09T05:00:04.676Z"}
{"parentUuid":"d1c5e63f-994b-492f-8c83-dd500572c22c","isSidechain":true,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","agentId":"a7dc162","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01FvCY9S8vNg1pjCRpRh11AD","type":"tool_result","content":"|===\n\n== Assumptions and Constraints\n\n=== Assumptions\n\n[width=\"100%\",cols=\"8%,92%\",options=\"header\",]\n|===\n|ID |Assumption\n\n|ASM-CS-001\n|Viva Energy Salesforce admin team will provide Salesforce production access, sandbox environment, and support for Case field mapping and data isolation configuration\n\n|ASM-CS-002\n|App database Contact data is sufficiently complete for migration (email/phone/VCI available for matching)\n\n|ASM-CS-003\n|Expected customer feedback volume (100-150 submissions/day from 20k DAU) is well within Salesforce API rate limits, with capacity planning for 3x-10x growth\n\n|ASM-CS-004\n|Existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis) is sufficient for Event Bus implementation (no additional infrastructure provisioning required)\n\n|ASM-CS-005","is_error":false}]},"uuid":"0626862e-288a-4030-893f-4981580e50a1","timestamp":"2026-01-09T05:00:04.946Z","toolUseResult":{"stdout":"|===\n\n== Assumptions and Constraints\n\n=== Assumptions\n\n[width=\"100%\",cols=\"8%,92%\",options=\"header\",]\n|===\n|ID |Assumption\n\n|ASM-CS-001\n|Viva Energy Salesforce admin team will provide Salesforce production access, sandbox environment, and support for Case field mapping and data isolation configuration\n\n|ASM-CS-002\n|App database Contact data is sufficiently complete for migration (email/phone/VCI available for matching)\n\n|ASM-CS-003\n|Expected customer feedback volume (100-150 submissions/day from 20k DAU) is well within Salesforce API rate limits, with capacity planning for 3x-10x growth\n\n|ASM-CS-004\n|Existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis) is sufficient for Event Bus implementation (no additional infrastructure provisioning required)\n\n|ASM-CS-005","stderr":"","interrupted":false,"isImage":false},"sourceToolAssistantUUID":"d1c5e63f-994b-492f-8c83-dd500572c22c"}
{"parentUuid":"1492826c-4bde-40e1-b4b2-4c6b174d8c96","isSidechain":true,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","agentId":"a7dc162","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01WzKhAJxvQy5qKT4ptkDLng","type":"tool_result","content":"|===\n\n== Non-Functional Requirements\n\n=== Performance Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-PERF-001\n|Mobile App feedback submission API response time (ProfileService + EngagementService)\n|p95 < 1 second, p99 < 2 seconds","is_error":false}]},"uuid":"43c1848b-e805-4dae-8b51-b4ee6a7c4ae7","timestamp":"2026-01-09T05:00:04.955Z","toolUseResult":{"stdout":"|===\n\n== Non-Functional Requirements\n\n=== Performance Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-PERF-001\n|Mobile App feedback submission API response time (ProfileService + EngagementService)\n|p95 < 1 second, p99 < 2 seconds","stderr":"","interrupted":false,"isImage":false},"sourceToolAssistantUUID":"1492826c-4bde-40e1-b4b2-4c6b174d8c96"}
{"parentUuid":"43c1848b-e805-4dae-8b51-b4ee6a7c4ae7","isSidechain":true,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","agentId":"a7dc162","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01TqxYvQrwSEnjSSrv2te7tM","type":"message","role":"assistant","content":[{"type":"text","text":"Perfect. Now let me check what's in the Flybuys Transition Architecture section to see if it needs restructuring."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":734,"cache_read_input_tokens":43321,"cache_creation":{"ephemeral_5m_input_tokens":734,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CWwDQj5T8vWvxhYiZMEvt","type":"assistant","uuid":"5e723a90-1ab8-4535-a9fb-4a66df9b74d0","timestamp":"2026-01-09T05:00:08.612Z"}
{"parentUuid":"5e723a90-1ab8-4535-a9fb-4a66df9b74d0","isSidechain":true,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","agentId":"a7dc162","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01TqxYvQrwSEnjSSrv2te7tM","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_016eq2ywRf6bWF3t4FUcEawr","name":"Read","input":{"file_path":"/mnt/c/Users/o.young/work/architecture/solution_architectures/flybuys_integration.adoc","offset":4299,"limit":200}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":734,"cache_read_input_tokens":43321,"cache_creation":{"ephemeral_5m_input_tokens":734,"ephemeral_1h_input_tokens":0},"output_tokens":143,"service_tier":"standard"}},"requestId":"req_011CWwDQj5T8vWvxhYiZMEvt","type":"assistant","uuid":"7df3b59d-56f0-42cb-b224-8b44b3223fc0","timestamp":"2026-01-09T05:00:09.488Z"}
{"parentUuid":"7df3b59d-56f0-42cb-b224-8b44b3223fc0","isSidechain":true,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","agentId":"a7dc162","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_016eq2ywRf6bWF3t4FUcEawr","type":"tool_result","content":"  4299→== Transition Architecture\n  4300→\n  4301→This section defines the phased approach to migrate from current state to target architecture, showing intermediate architecture states and technical dependencies.\n  4302→\n  4303→. *No Big-Bang Migration*: Incremental rollout using Strangler Fig pattern (reference ADR-005 in Architecture Definition)\n  4304→. *Zero Downtime*: New bounded contexts operate in parallel with legacy OTR App API during transition\n  4305→. *Feature Flag Control*: All new capabilities behind feature flags (see xref:architecture-definitions:flybuys_integration.adoc#Feature%2520Flag%2520Register[Feature Flag Register] in Architecture Definition)\n  4306→. *Data Coexistence*: Dual-write to legacy and new systems during TS-1 Foundation phase (30 days)\n  4307→. *Rollback Capability*: Each phase independently reversible without data loss\n  4308→\n  4309→=== Transition Phase Matrix\n  4310→\n  4311→Progressive rollout of feature flags across architecture states (TS-0 → TS-1 → TS-2 → TS-3 → TS-4).\n  4312→\n  4313→*Flag Definitions*: See xref:architecture-definitions:flybuys_integration.adoc#Feature%2520Flag%2520Register[Feature Flag Register] in Architecture Definition for complete flag purposes, ownership, and strategic rationale.\n  4314→\n  4315→[cols=\"3,1,1,1,1,1\"]\n  4316→|===\n  4317→| Flag Name | TS-0 Current | TS-1 Foundation | TS-2 linking | TS-3 Grants | TS-4 Target\n  4318→\n  4319→| +OTR.Loyalty.Enabled+\n  4320→| OFF\n  4321→| ON\n  4322→| ON\n  4323→| ON\n  4324→| ON\n  4325→\n  4326→| +OTR.Loyalty.PartnerLink.Flybuys+\n  4327→| OFF\n  4328→| OFF\n  4329→| ON\n  4330→| ON\n  4331→| ON\n  4332→\n  4333→| +OTR.Loyalty.RewardPreferenceSelection+\n  4334→| OFF\n  4335→| OFF\n  4336→| ON\n  4337→| ON\n  4338→| ON\n  4339→\n  4340→| +OTR.Loyalty.TransactionAdjudication+\n  4341→| OFF\n  4342→| OFF\n  4343→| OFF\n  4344→| ON\n  4345→| ON\n  4346→\n  4347→| +OTR.Loyalty.PointsEarn.Flybuys+\n  4348→| OFF\n  4349→| OFF\n  4350→| OFF\n  4351→| ON\n  4352→| ON\n  4353→\n  4354→| +OTR.Loyalty.FlybuysBatchPosting+\n  4355→| OFF\n  4356→| OFF\n  4357→| OFF\n  4358→| ON\n  4359→| ON\n  4360→|===\n  4361→\n  4362→*Dependencies*:\n  4363→\n  4364→* +OTR.Loyalty.PartnerLink.Flybuys+ requires +OTR.Loyalty.Enabled+ = ON\n  4365→* +OTR.Loyalty.TransactionAdjudication+ requires +OTR.Loyalty.Enabled+ = ON\n  4366→* +OTR.Loyalty.PointsEarn.Flybuys+ requires +OTR.Loyalty.TransactionAdjudication+ = ON\n  4367→\n  4368→=== Rollback Strategy\n  4369→\n  4370→Feature flags enable rapid rollback without code deployment. Each architecture state can be rolled back by disabling the corresponding flags:\n  4371→\n  4372→==== TS-1 Foundation Rollback\n  4373→\n  4374→*Trigger*: VCI migration failures, EagleEye wallet creation issues, or infrastructure instability\n  4375→\n  4376→*Actions*:\n  4377→\n  4378→. Set +OTR.Loyalty.Enabled+ = OFF (disables all loyalty features)\n  4379→. Delete customer VCI records created during pilot (data cleanup)\n  4380→. Validate legacy OTR App API is functioning normally\n  4381→\n  4382→*Impact*: Mobile app reverts to legacy loyalty features (no EagleEye integration)\n  4383→\n  4384→==== TS-2 linking Rollback\n  4385→\n  4386→*Trigger*: OAuth flow failures (>5% failure rate), Flybuys API unavailability, or customer support tickets >50/day\n  4387→\n  4388→*Actions*:\n  4389→\n  4390→. Set +OTR.Loyalty.PartnerLink.Flybuys+ = OFF (disables Flybuys linking UI)\n  4391→. Set +OTR.Loyalty.RewardPreferenceSelection+ = OFF (hides reward preference selection)\n  4392→. Communicate to pilot users via push notification and email\n  4393→\n  4394→*Impact*: Customers cannot link Flybuys accounts, balance queries disabled\n  4395→\n  4396→==== TS-3 Grants Rollback\n  4397→\n  4398→*Trigger*: POS integration failures, batch file acknowledgement rate <98%, or transaction adjudication errors\n  4399→\n  4400→*Actions*:\n  4401→\n  4402→. Set +OTR.Loyalty.TransactionAdjudication+ = OFF (reverts to legacy POS integration)\n  4403→. Set +OTR.Loyalty.PointsEarn.Flybuys+ = OFF (stops points earning)\n  4404→. Set +OTR.Loyalty.FlybuysBatchPosting+ = OFF (stops daily batch transmission)\n  4405→. Re-enable Reddy Express legacy Flybuys integration (barcode pattern matching)\n  4406→\n  4407→*Impact*: POS reverts to legacy Flybuys integration, transactions in-flight may need manual reconciliation\n  4408→\n  4409→==== Partial Rollback (Batch Posting Issues Only)\n  4410→\n  4411→*Trigger*: Flybuys batch file acknowledgement failures, SFTP transmission errors\n  4412→\n  4413→*Actions*:\n  4414→\n  4415→. Set +OTR.Loyalty.FlybuysBatchPosting+ = OFF (stops batch transmission)\n  4416→. Investigate SFTP connectivity, PGP encryption, and acknowledgement file parsing\n  4417→. Keep +OTR.Loyalty.TransactionAdjudication+ = ON (POS integration continues)\n  4418→\n  4419→*Impact*: Points not posted to Flybuys immediately, requires manual batch file regeneration and transmission\n  4420→\n  4421→=== TS-0 Current State\n  4422→\n  4423→Pre-initiative architecture (reference Architecture Definition §2 Current State)\n  4424→\n  4425→==== Active Components\n  4426→\n  4427→* OTR App API (AWS Lambda, DynamoDB)\n  4428→* Reddy Express legacy loyalty (SQL Server, POS barcode matching) - Flybuys-only\n  4429→* No unified customer identity (OTR users and Reddy Express customers separate)\n  4430→* No partner integrations beyond basic xref:ROOT:ubiquitous_language.adoc#flybuys-cardholder-number[Flybuys Card] scanning\n  4431→\n  4432→==== Technical Debt\n  4433→\n  4434→* Fragmented customer identity (OTR vs Reddy Express silos)\n  4435→* No event-driven architecture (synchronous-only integrations)\n  4436→* Tight POS coupling (direct Flybuys barcode pattern matching at OTR+ stores)\n  4437→* No OAuth infrastructure (no secure third-party account linking)\n  4438→\n  4439→\n  4440→=== TS-1 Foundation\n  4441→\n  4442→Establish xref:bounded-contexts:profile.adoc[Profile Service], xref:bounded-contexts:loyalty.adoc[Loyalty Service], xref:bounded-contexts:otr_app_api.adoc[Event Bus] without customer-facing features\n  4443→\n  4444→==== New SBBS\n  4445→\n  4446→[cols=\"1,3\"]\n  4447→|===\n  4448→| SBB | Description\n  4449→\n  4450→| <<sbb-001-profile-service-api,SBB-001>>\n  4451→| xref:bounded-contexts:profile.adoc[Profile Service] API\n  4452→\n  4453→| <<sbb-002-profile-service-database,SBB-002>>\n  4454→| xref:bounded-contexts:profile.adoc[Profile Service] Database\n  4455→\n  4456→| <<sbb-003-loyalty-service-api,SBB-003>>\n  4457→| xref:bounded-contexts:loyalty.adoc[Loyalty Service] API\n  4458→\n  4459→| <<sbb-004-loyalty-service-database,SBB-004>>\n  4460→| xref:bounded-contexts:loyalty.adoc[Loyalty Service] Database\n  4461→\n  4462→| <<sbb-006-domain-event-bus,SBB-006>>\n  4463→| Domain xref:bounded-contexts:otr_app_api.adoc[Event Bus] (Event Grid)\n  4464→\n  4465→| SBB-008\n  4466→| Eagle Eye[Eagle Eye] Integration Adaptor\n  4467→\n  4468→| <<sbb-012-application-monitoring,SBB-012>>\n  4469→| Application Monitoring (App Insights)\n  4470→\n  4471→| <<sbb-013-api-gateway,SBB-013>>\n  4472→| API Gateway (APIM)\n  4473→|===\n  4474→\n  4475→==== Implementation Approach\n  4476→\n  4477→Enable xref:ROOT:ubiquitous_language.adoc#customer[Customer] uplift with a xref:ROOT:ubiquitous_language.adoc#dark-launch[Dark Launch] rollout strategy. New integration runs in parallel with existing system, validating technical implementation without customer impact\n  4478→\n  4479→[cols=\"2,5\"]\n  4480→|===\n  4481→| Activity | Description\n  4482→\n  4483→| Customer Profile Creation\n  4484→| xref:ROOT:ubiquitous_language.adoc#just-in-time-integration[Just-In-Time Integration] via `POST /api/v1/profile/customers` endpoint - xref:ROOT:ubiquitous_language.adoc#otr-app[Mobile Application] calls this during login if xref:ROOT:ubiquitous_language.adoc#customer[Customer] has no xref:ROOT:ubiquitous_language.adoc#viva-consumer-id-vci[VCI], creating profile and linking to Salesforce\n  4485→\n  4486→| Wallet Provisioning\n  4487→| Orchestrated by profile creation endpoint - `POST /api/v1/profile/customers` calls EagleEye ACL to provision xref:ROOT:ubiquitous_language.adoc#wallet[EagleEye Wallet] atomically with profile creation\n  4488→\n  4489→| Dual-Write Pattern\n  4490→| xref:ROOT:ubiquitous_language.adoc#otr-app[Mobile Application] sends requests to both legacy OTR App API and new xref:bounded-contexts:profile.adoc[Profile Service] / xref:bounded-contexts:loyalty.adoc[Loyalty Service], while legacy remains authoritative until Loyalty Value Chain[Loyalty Value Chain]\n  4491→|===\n  4492→\n  4493→===== Architecture Diagram\n  4494→\n  4495→[mermaid]\n  4496→----\n  4497→graph TD\n  4498→    MobileApp[Mobile App]\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"d4e8fe89-cf60-42ea-9190-4d6c4de38193","timestamp":"2026-01-09T05:00:09.761Z","toolUseResult":{"type":"text","file":{"filePath":"/mnt/c/Users/o.young/work/architecture/solution_architectures/flybuys_integration.adoc","content":"== Transition Architecture\n\nThis section defines the phased approach to migrate from current state to target architecture, showing intermediate architecture states and technical dependencies.\n\n. *No Big-Bang Migration*: Incremental rollout using Strangler Fig pattern (reference ADR-005 in Architecture Definition)\n. *Zero Downtime*: New bounded contexts operate in parallel with legacy OTR App API during transition\n. *Feature Flag Control*: All new capabilities behind feature flags (see xref:architecture-definitions:flybuys_integration.adoc#Feature%2520Flag%2520Register[Feature Flag Register] in Architecture Definition)\n. *Data Coexistence*: Dual-write to legacy and new systems during TS-1 Foundation phase (30 days)\n. *Rollback Capability*: Each phase independently reversible without data loss\n\n=== Transition Phase Matrix\n\nProgressive rollout of feature flags across architecture states (TS-0 → TS-1 → TS-2 → TS-3 → TS-4).\n\n*Flag Definitions*: See xref:architecture-definitions:flybuys_integration.adoc#Feature%2520Flag%2520Register[Feature Flag Register] in Architecture Definition for complete flag purposes, ownership, and strategic rationale.\n\n[cols=\"3,1,1,1,1,1\"]\n|===\n| Flag Name | TS-0 Current | TS-1 Foundation | TS-2 linking | TS-3 Grants | TS-4 Target\n\n| +OTR.Loyalty.Enabled+\n| OFF\n| ON\n| ON\n| ON\n| ON\n\n| +OTR.Loyalty.PartnerLink.Flybuys+\n| OFF\n| OFF\n| ON\n| ON\n| ON\n\n| +OTR.Loyalty.RewardPreferenceSelection+\n| OFF\n| OFF\n| ON\n| ON\n| ON\n\n| +OTR.Loyalty.TransactionAdjudication+\n| OFF\n| OFF\n| OFF\n| ON\n| ON\n\n| +OTR.Loyalty.PointsEarn.Flybuys+\n| OFF\n| OFF\n| OFF\n| ON\n| ON\n\n| +OTR.Loyalty.FlybuysBatchPosting+\n| OFF\n| OFF\n| OFF\n| ON\n| ON\n|===\n\n*Dependencies*:\n\n* +OTR.Loyalty.PartnerLink.Flybuys+ requires +OTR.Loyalty.Enabled+ = ON\n* +OTR.Loyalty.TransactionAdjudication+ requires +OTR.Loyalty.Enabled+ = ON\n* +OTR.Loyalty.PointsEarn.Flybuys+ requires +OTR.Loyalty.TransactionAdjudication+ = ON\n\n=== Rollback Strategy\n\nFeature flags enable rapid rollback without code deployment. Each architecture state can be rolled back by disabling the corresponding flags:\n\n==== TS-1 Foundation Rollback\n\n*Trigger*: VCI migration failures, EagleEye wallet creation issues, or infrastructure instability\n\n*Actions*:\n\n. Set +OTR.Loyalty.Enabled+ = OFF (disables all loyalty features)\n. Delete customer VCI records created during pilot (data cleanup)\n. Validate legacy OTR App API is functioning normally\n\n*Impact*: Mobile app reverts to legacy loyalty features (no EagleEye integration)\n\n==== TS-2 linking Rollback\n\n*Trigger*: OAuth flow failures (>5% failure rate), Flybuys API unavailability, or customer support tickets >50/day\n\n*Actions*:\n\n. Set +OTR.Loyalty.PartnerLink.Flybuys+ = OFF (disables Flybuys linking UI)\n. Set +OTR.Loyalty.RewardPreferenceSelection+ = OFF (hides reward preference selection)\n. Communicate to pilot users via push notification and email\n\n*Impact*: Customers cannot link Flybuys accounts, balance queries disabled\n\n==== TS-3 Grants Rollback\n\n*Trigger*: POS integration failures, batch file acknowledgement rate <98%, or transaction adjudication errors\n\n*Actions*:\n\n. Set +OTR.Loyalty.TransactionAdjudication+ = OFF (reverts to legacy POS integration)\n. Set +OTR.Loyalty.PointsEarn.Flybuys+ = OFF (stops points earning)\n. Set +OTR.Loyalty.FlybuysBatchPosting+ = OFF (stops daily batch transmission)\n. Re-enable Reddy Express legacy Flybuys integration (barcode pattern matching)\n\n*Impact*: POS reverts to legacy Flybuys integration, transactions in-flight may need manual reconciliation\n\n==== Partial Rollback (Batch Posting Issues Only)\n\n*Trigger*: Flybuys batch file acknowledgement failures, SFTP transmission errors\n\n*Actions*:\n\n. Set +OTR.Loyalty.FlybuysBatchPosting+ = OFF (stops batch transmission)\n. Investigate SFTP connectivity, PGP encryption, and acknowledgement file parsing\n. Keep +OTR.Loyalty.TransactionAdjudication+ = ON (POS integration continues)\n\n*Impact*: Points not posted to Flybuys immediately, requires manual batch file regeneration and transmission\n\n=== TS-0 Current State\n\nPre-initiative architecture (reference Architecture Definition §2 Current State)\n\n==== Active Components\n\n* OTR App API (AWS Lambda, DynamoDB)\n* Reddy Express legacy loyalty (SQL Server, POS barcode matching) - Flybuys-only\n* No unified customer identity (OTR users and Reddy Express customers separate)\n* No partner integrations beyond basic xref:ROOT:ubiquitous_language.adoc#flybuys-cardholder-number[Flybuys Card] scanning\n\n==== Technical Debt\n\n* Fragmented customer identity (OTR vs Reddy Express silos)\n* No event-driven architecture (synchronous-only integrations)\n* Tight POS coupling (direct Flybuys barcode pattern matching at OTR+ stores)\n* No OAuth infrastructure (no secure third-party account linking)\n\n\n=== TS-1 Foundation\n\nEstablish xref:bounded-contexts:profile.adoc[Profile Service], xref:bounded-contexts:loyalty.adoc[Loyalty Service], xref:bounded-contexts:otr_app_api.adoc[Event Bus] without customer-facing features\n\n==== New SBBS\n\n[cols=\"1,3\"]\n|===\n| SBB | Description\n\n| <<sbb-001-profile-service-api,SBB-001>>\n| xref:bounded-contexts:profile.adoc[Profile Service] API\n\n| <<sbb-002-profile-service-database,SBB-002>>\n| xref:bounded-contexts:profile.adoc[Profile Service] Database\n\n| <<sbb-003-loyalty-service-api,SBB-003>>\n| xref:bounded-contexts:loyalty.adoc[Loyalty Service] API\n\n| <<sbb-004-loyalty-service-database,SBB-004>>\n| xref:bounded-contexts:loyalty.adoc[Loyalty Service] Database\n\n| <<sbb-006-domain-event-bus,SBB-006>>\n| Domain xref:bounded-contexts:otr_app_api.adoc[Event Bus] (Event Grid)\n\n| SBB-008\n| Eagle Eye[Eagle Eye] Integration Adaptor\n\n| <<sbb-012-application-monitoring,SBB-012>>\n| Application Monitoring (App Insights)\n\n| <<sbb-013-api-gateway,SBB-013>>\n| API Gateway (APIM)\n|===\n\n==== Implementation Approach\n\nEnable xref:ROOT:ubiquitous_language.adoc#customer[Customer] uplift with a xref:ROOT:ubiquitous_language.adoc#dark-launch[Dark Launch] rollout strategy. New integration runs in parallel with existing system, validating technical implementation without customer impact\n\n[cols=\"2,5\"]\n|===\n| Activity | Description\n\n| Customer Profile Creation\n| xref:ROOT:ubiquitous_language.adoc#just-in-time-integration[Just-In-Time Integration] via `POST /api/v1/profile/customers` endpoint - xref:ROOT:ubiquitous_language.adoc#otr-app[Mobile Application] calls this during login if xref:ROOT:ubiquitous_language.adoc#customer[Customer] has no xref:ROOT:ubiquitous_language.adoc#viva-consumer-id-vci[VCI], creating profile and linking to Salesforce\n\n| Wallet Provisioning\n| Orchestrated by profile creation endpoint - `POST /api/v1/profile/customers` calls EagleEye ACL to provision xref:ROOT:ubiquitous_language.adoc#wallet[EagleEye Wallet] atomically with profile creation\n\n| Dual-Write Pattern\n| xref:ROOT:ubiquitous_language.adoc#otr-app[Mobile Application] sends requests to both legacy OTR App API and new xref:bounded-contexts:profile.adoc[Profile Service] / xref:bounded-contexts:loyalty.adoc[Loyalty Service], while legacy remains authoritative until Loyalty Value Chain[Loyalty Value Chain]\n|===\n\n===== Architecture Diagram\n\n[mermaid]\n----\ngraph TD\n    MobileApp[Mobile App]","numLines":200,"startLine":4299,"totalLines":5277}},"sourceToolAssistantUUID":"7df3b59d-56f0-42cb-b224-8b44b3223fc0"}
{"parentUuid":"d4e8fe89-cf60-42ea-9190-4d6c4de38193","isSidechain":true,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","agentId":"a7dc162","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01NTqvDv3YGDNfLNyz17LB7j","type":"message","role":"assistant","content":[{"type":"text","text":"Excellent. Now I have enough information to create a comprehensive restructuring plan. Let me create a detailed document."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":4,"cache_creation_input_tokens":3341,"cache_read_input_tokens":44055,"cache_creation":{"ephemeral_5m_input_tokens":3341,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CWwDR5VHRMf4Gory7mnRY","type":"assistant","uuid":"28a26473-75dc-46e4-b68a-e981805dfddd","timestamp":"2026-01-09T05:00:12.947Z"}
{"parentUuid":"28a26473-75dc-46e4-b68a-e981805dfddd","isSidechain":true,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","agentId":"a7dc162","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01NTqvDv3YGDNfLNyz17LB7j","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01VuYWcbN7GyVyBm3FhoQZsH","name":"Write","input":{"file_path":"/mnt/c/Users/o.young/work/architecture/notes/flybuys_restructuring_plan.md","content":"# Flybuys Integration Solution Architecture - Restructuring Plan\n\n## Executive Summary\n\nThis plan restructures the Flybuys Integration Solution Architecture (5276 lines) to match the comprehensive TOGAF-aligned structure of the Salesforce Customer Support Solution Architecture (3328 lines), while preserving Flybuys' technical strengths (detailed physical data models, complete API documentation, correlation ID propagation, comprehensive sequence diagrams).\n\n**Target Outcome**: A well-organized, TOGAF Phase E-compliant solution architecture that follows established patterns while maintaining the detailed technical specifications that make the Flybuys document valuable.\n\n## Structural Issues Identified\n\n### Current Flybuys Structure Gaps\n\n1. **Executive Summary**: Brief and positioned early (line 64), lacks formal Challenge/Solution/Significance structure\n2. **Missing Vision Section**: No dedicated vision statement (exists in Architecture Definition but not Solution Architecture)\n3. **Missing Architectural Approach**: Not articulated in Solution Architecture\n4. **Informal Technology Decisions**: \"Key Technology Decisions\" table format instead of formal ADRs with status/context/rationale/consequences\n5. **No Baseline Architecture**: Content scattered in TS-0 section instead of formal baseline analysis\n6. **Missing Assumptions and Constraints**: Implementation constraints embedded in other sections, no formal assumptions list\n7. **Missing Non-Functional Requirements**: No comprehensive NFR section (performance, availability, scalability, security, reliability, maintainability, usability, compliance)\n8. **Missing Monitoring and Observability**: No dedicated section for metrics, alerting, dashboards\n9. **Gap Analysis Placement**: After Interface Specifications (line 3242) instead of integrated into Technical Architecture\n10. **No Technical Requirements Section**: Requirements scattered across Architecture Definition\n\n### Flybuys Strengths to Preserve\n\n1. **Physical Data Models**: Detailed JSON schemas for PartnerLink, RewardTransaction, OAuth Token Storage (lines 1536-1740)\n2. **Complete API Documentation**: Full REST API specs, AsyncAPI event schemas, versioning policy\n3. **Correlation ID Propagation**: Comprehensive specification for distributed tracing (unique to Flybuys)\n4. **SBB Dependency Flowchart**: Visual mapping of Solution Building Block dependencies\n5. **Comprehensive Interaction Flows**: OAuth linking, JIT profile creation, POS integration, batch processing\n6. **Detailed Transition Architecture**: Feature flag matrix, rollback strategies, phased architecture states (TS-0 → TS-4)\n7. **Batch File Format Specification**: CSV format, PGP encryption details\n\n## Target Structure (Based on Salesforce Pattern)\n\n```\n1. Purpose and Scope (100-200 lines)\n   1.1 Purpose\n   1.2 Vision ← NEW (from Architecture Definition)\n   1.3 Architectural Approach ← NEW (from Architecture Definition)\n   1.4 Scope\n       1.4.1 In Scope\n       1.4.2 Out of Scope\n   1.5 Architecture Overview ← NEW (from Architecture Definition)\n       1.5.1 Key Architectural Patterns\n\n2. Solution Approach (50-100 lines)\n   2.1 Related Documentation\n\n3. Executive Summary (150-250 lines) ← RESTRUCTURED\n   3.1 Challenge ← NEW\n   3.2 Solution ← ENHANCED\n       3.2.1 New Bounded Contexts\n       3.2.2 Integration Architecture\n       3.2.3 Migration Approach\n   3.3 Key Architectural Significance ← NEW\n   3.4 Success Criteria (existing)\n   3.5 Technical Constraints ← RELOCATED from Implementation Constraints\n   3.6 Open Technical Decisions ← NEW (TBD items)\n\n4. Technical Requirements ← NEW SECTION\n   4.1 Technical Requirements (from Architecture Definition)\n   4.2 Technical Requirements Mapping (from Architecture Definition)\n\n5. Technical Architecture (800-1200 lines) ← REORGANIZED\n   5.1 Baseline Architecture ← EXTRACTED from TS-0\n       5.1.1 Existing System Components\n       5.1.2 Integration Architecture\n       5.1.3 Current Value Stream\n       5.1.4 Technical Debt\n   5.2 Gap Analysis ← RELOCATED from line 3242\n       5.2.1 Missing Capabilities\n       5.2.2 Missing Bounded Contexts\n       5.2.3 Missing Integration Patterns\n   5.3 Target State Architecture\n       5.3.1 Architectural Building Blocks (ABB)\n       5.3.2 Integration Architecture\n       5.3.3 Data Architecture Principles\n   5.4 Architecture Decisions ← CONVERTED from Key Technology Decisions\n       5.4.1 ADR-FB-001: .NET 8.0 Implementation Stack\n       5.4.2 ADR-FB-002: OAuth 2.0 + PKCE for Partner Linking\n       5.4.3 ADR-FB-003: NoSQL Database for Profile and Loyalty Services\n       5.4.4 ADR-FB-004: Event-Driven Integration via Event Bus\n       5.4.5 ADR-FB-005: Phased Rollout with Feature Flags (not big-bang)\n       5.4.6 ADR-FB-006: AES-256 Encryption for OAuth Tokens\n       5.4.7 ADR-FB-007: Nightly Batch SFTP for Flybuys Transaction Posting\n       5.4.8 ADR-FB-008: Circuit Breaker Pattern for External API Resilience\n       5.4.9 ADR-FB-009: Correlation ID Propagation for Distributed Tracing\n       5.4.10 ADR-FB-010: Conformist Pattern for Flybuys API Integration\n\n6. Solution Building Blocks (1200-1500 lines) ← KEEP DETAILED\n   6.1 Technology Portfolio Catalogue\n   6.2 Solution Building Block Mapping\n   6.3 SBB-001 through SBB-018 (detailed as-is)\n\n7. Data Architecture (400-600 lines) ← KEEP DETAILED\n   7.1 Physical Data Models\n       7.1.1 Profile Service - PartnerLink Document Schema\n       7.1.2 Loyalty Service - RewardTransaction Document Schema\n       7.1.3 OAuth Token Storage Schema (Key Vault)\n   7.2 Domain Event Schemas ← NEW (extract from Interface Specifications)\n   7.3 Data Quality & Validation ← NEW\n\n8. Interface Specifications (800-1000 lines) ← REORGANIZED\n   8.1 REST API Specifications\n       8.1.1 Profile Service API v1\n       8.1.2 Loyalty Service API v1\n       8.1.3 Engagement Service API v1\n   8.2 Domain Events (AsyncAPI)\n       8.2.1 Event Catalogue\n       8.2.2 Event Delivery Guarantees\n   8.3 API Versioning Policy\n   8.4 Correlation ID Propagation Specification ← KEEP DETAILED\n   8.5 Data Formats\n       8.5.1 Flybuys Batch File Format (CSV)\n   8.6 Interaction Flows ← KEEP DETAILED\n       8.6.1 OAuth Linking Flow\n       8.6.2 JIT Profile Creation Flow\n       8.6.3 POS Transaction Adjudication Flow\n       8.6.4 Batch File Processing Flow\n\n9. Work Packages (600-800 lines) ← ENHANCED\n   9.1 Work Package Overview\n   9.2 WP-FB-001 through WP-FB-010 (enhanced with sequencing)\n   9.3 Work Package Sequencing ← NEW\n       9.3.1 Parallel Track 1: Infrastructure & Configuration\n       9.3.2 Parallel Track 2: Development\n       9.3.3 Sequential Track 3: Integration & Testing\n       9.3.4 Sequential Track 4: Migration & Cutover\n       9.3.5 Critical Path\n\n10. Transition Architecture (600-800 lines) ← KEEP AS-IS\n    10.1 Transition Phase Matrix\n    10.2 Rollback Strategy\n    10.3 TS-0 Current State\n    10.4 TS-1 Foundation\n    10.5 TS-2 Linking\n    10.6 TS-3 Grants\n    10.7 TS-4 Target State\n\n11. Assumptions and Constraints ← NEW SECTION\n    11.1 Assumptions\n    11.2 Constraints\n\n12. Non-Functional Requirements ← NEW SECTION\n    12.1 Performance Requirements\n    12.2 Availability Requirements\n    12.3 Scalability Requirements\n    12.4 Security Requirements\n    12.5 Reliability Requirements\n    12.6 Maintainability Requirements\n    12.7 Usability Requirements\n    12.8 Compliance Requirements\n\n13. Monitoring and Observability ← NEW SECTION\n    13.1 Key Metrics\n    13.2 Alerting Thresholds\n    13.3 Dashboards\n\n14. Solution Validation ← NEW SECTION\n    14.1 Functional Validation\n    14.2 Non-Functional Validation\n    14.3 Acceptance Criteria\n```\n\n## Detailed Section Mappings\n\n### 1. Purpose and Scope (NEW Structure)\n\n**Source**: Architecture Definition Introduction & Vision section\n\n**Actions**:\n\n1. **Purpose**: Keep existing (lines 27-29 in Solution Architecture)\n2. **Vision**: Copy from Architecture Definition line 32-33\n3. **Architectural Approach**: Copy from Architecture Definition lines 36-44\n4. **Scope**: Keep existing (In Scope/Out of Scope)\n5. **Architecture Overview**: Copy Mermaid diagram from Architecture Definition lines 50-97\n6. **Key Architectural Patterns**: Copy table from Architecture Definition lines 101-111\n\n**Rationale**: Salesforce structure includes comprehensive context upfront. Flybuys Architecture Definition has excellent vision/approach that should be mirrored in Solution Architecture.\n\n### 2. Solution Approach (MINIMAL CHANGES)\n\n**Actions**: Keep existing Related Documentation section\n\n### 3. Executive Summary (MAJOR RESTRUCTURING)\n\n**Current State**: Brief summary at line 64-71\n\n**Target State**: Comprehensive 150-250 line summary following Salesforce pattern\n\n**New Structure**:\n\n```asciidoc\n== Executive Summary\n\n=== Challenge\n\nOTR and Reddy Express customers experience fragmented loyalty programmes across the OTRG store network:\n\n* **No coalition partner linking**: Customers cannot link Flybuys accounts via mobile app\n* **Manual batch processing**: Reddy Express uses CSV exports, 24+ hour point posting delay\n* **Fragmented customer identity**: OTR users and REXP customers are separate (no unified VCI)\n* **Limited competitive positioning**: No digital coalition loyalty vs national chains (Coles, Woolworths)\n* **High operational overhead**: Manual SFTP batch uploads, no retry logic, support burden\n\n*Business Impact*:\n\n* Low Flybuys adoption (REXP stores only, no app integration)\n* Customer confusion about points availability\n* High support call volume (missing points inquiries)\n* Inability to evolve loyalty strategy independently\n\n=== Solution\n\nThis initiative introduces three new bounded contexts (Profile Service, Loyalty Service, Engagement Service) implementing Domain-Driven Design patterns to enable:\n\n1. **Seamless Coalition Partner Linking**: OAuth 2.0 + PKCE partner account linking via mobile app\n2. **Real-Time Transaction Adjudication**: <500ms p95 POS integration with EagleEye and Flybuys\n3. **Automated Batch Processing**: Nightly SFTP with retry logic, PGP encryption\n4. **Event-Driven Architecture**: Loose coupling via Event Bus (ProfileService → LoyaltyService → EngagementService)\n5. **Phased Migration**: Strangler Fig pattern with feature flags (TS-0 → TS-1 → TS-2 → TS-3 → TS-4)\n\n==== New Bounded Contexts\n\n[width=\"100%\",cols=\"20%,40%,40%\",options=\"header\",]\n|===\n|Bounded Context |Responsibility |Key Aggregates\n\n|Profile Service\n|Partner account linking, reward preference management, canonical customer identity (VCI)\n|PartnerLink, CustomerProfile\n\n|Loyalty Service\n|Transaction adjudication, credential resolution, batch posting, Flybuys ACL\n|RewardTransaction, CredentialMapping\n\n|Engagement Service\n|Customer engagement campaigns, notification orchestration, Braze ACL\n|Campaign, Notification\n\n|===\n\n==== Integration Architecture\n\n* **Anti-Corruption Layer (ACL)**: Isolate from EagleEye, Flybuys, Braze API changes\n* **Customer-Supplier + Conformist**: Conform to Salesforce CRM, Flybuys OAuth\n* **Event-Driven**: Domain events (PartnerLinked, TransactionAdjudicated, PointsEarned)\n* **OAuth 2.0 + PKCE**: Secure partner linking without storing passwords\n\n==== Migration Approach\n\n* **Strangler Fig**: Parallel deployment with legacy OTR App API, gradual feature flag enablement\n* **Zero Downtime**: Dual-write during TS-1 Foundation (30 days)\n* **Rollback Capability**: Each phase independently reversible\n* **Phased Rollout**: TS-1 Foundation (dark launch) → TS-2 Linking (pilot) → TS-3 Grants (production)\n\n=== Key Architectural Significance\n\n1. **First DDD Bounded Contexts**: Establishes pattern for future loyalty capabilities (subscriptions, gamification)\n2. **Event-Driven Foundation**: Event Bus enables future integrations (Braze, Recommendation Service)\n3. **Partner Flexibility**: ACL pattern supports future coalition partners (Shell, AFL)\n4. **Platform Consolidation**: Migrates Reddy Express stores to unified OTR platform\n5. **Operational Resilience**: Circuit breaker, retry logic, automated batch posting\n\n=== Success Criteria\n\n[width=\"100%\",cols=\"60%,40%\",options=\"header\",]\n|===\n|Criterion |Target\n\n|Profile Service / Loyalty Service API p95 latency\n|< 500ms\n\n|OAuth linking success rate (30-day pilot)\n|> 95%\n\n|Flybuys batch acknowledgement rate (60 days)\n|> 98%\n\n|POS transaction adjudication p95 latency\n|< 500ms\n\n|Customer support tickets (missing points)\n|Reduce by 50%\n\n|===\n\n=== Technical Constraints\n\n* Must conform to Flybuys API specifications (cannot modify)\n* OAuth tokens must be AES-256 encrypted at rest, TLS 1.3 in transit\n* Customer data must reside in Australia East region\n* Phased rollout required (no big-bang deployment)\n* Flybuys partnership potentially 2-3 years (architecture must support partner flexibility)\n\n=== Open Technical Decisions (TBD)\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Decision |Status\n\n|Hosting Platform (Azure Container Apps, AKS, AWS ECS/Fargate)\n|Under evaluation (DEC-002)\n\n|NoSQL Database (Cosmos DB, DynamoDB, MongoDB Atlas)\n|Under evaluation (DEC-003)\n\n|Event Bus (Azure Event Grid, AWS EventBridge, SNS+SQS)\n|Under evaluation (DEC-004)\n\n|Secrets Management (Azure Key Vault, AWS Secrets Manager)\n|Under evaluation (DEC-005)\n\n|Data Processing (Azure Data Factory, AWS Step Functions)\n|Under evaluation (DEC-006)\n\n|Monitoring (Azure Monitor, AWS CloudWatch, Datadog)\n|Under evaluation (DEC-007)\n\n|API Gateway (Azure APIM, AWS API Gateway, Kong)\n|Under evaluation (DEC-008)\n\n|Caching Layer (Azure Cache for Redis, AWS ElastiCache)\n|Under evaluation (DEC-009)\n\n|Mobile App Framework (Kotlin Multiplatform confirmed)\n|Confirmed (DEC-010)\n\n|Resilience Library (Polly .NET, custom implementation)\n|Under evaluation (DEC-013)\n\n|Feature Flag Service (LaunchDarkly, Azure App Config, custom)\n|Under evaluation (DEC-014)\n\n|Observability (OpenTelemetry, Jaeger, Zipkin)\n|Under evaluation (DEC-016)\n\n|Schema Registry (Confluent, AWS Glue, custom)\n|Under evaluation (DEC-020)\n\n|===\n```\n\n**Actions**:\n\n1. Replace existing Executive Summary (lines 64-71) with comprehensive structure above\n2. Extract Technical Constraints from Implementation Constraints (lines 212-218)\n3. Extract Open Technical Decisions from Key Technology Decisions table (all #TBD# items)\n4. Create Challenge section synthesizing pain points from Architecture Definition\n5. Create Solution section with three subsections (New Bounded Contexts, Integration Architecture, Migration Approach)\n6. Create Key Architectural Significance section highlighting strategic impact\n7. Keep Success Criteria (lines 220-224)\n\n### 4. Technical Requirements (NEW SECTION)\n\n**Source**: Architecture Definition lines 113-176\n\n**Actions**:\n\n1. Copy Technical Requirements table from Architecture Definition\n2. Copy Technical Requirements Mapping table\n3. Consider whether stakeholder analysis should move here (currently in Architecture Definition only)\n\n**Rationale**: TOGAF Phase C requires explicit technical requirements. Salesforce has this section. Currently only in Architecture Definition.\n\n### 5. Technical Architecture (MAJOR REORGANIZATION)\n\n#### 5.1 Baseline Architecture (EXTRACTED from TS-0)\n\n**Current State**: TS-0 Current State is in Transition Architecture section (lines 4421-4438)\n\n**Target State**: Comprehensive baseline analysis in Technical Architecture section (before Gap Analysis)\n\n**New Structure**:\n\n```asciidoc\n=== Baseline Architecture\n\n==== Current Business Capability\n\n[Copy from Architecture Definition lines 203-217]\n\n==== Current Value Stream\n\n===== Customer Redeems Flybuys Fuel Discount\n\n[Copy sequence diagram and value stream table from Architecture Definition lines 221-278]\n\n==== Existing System Components\n\n[Extract from TS-0 Current State]\n\n===== OTR App API\n\nPlatform: AWS Lambda, DynamoDB\nCapabilities:\n* Customer authentication (Microsoft Entra External ID)\n* Loyalty credential storage (VCI)\n* Mobile app backend\n\nLimitations:\n* No partner account linking\n* No real-time transaction adjudication\n* Synchronous integration only\n\n===== Reddy Express Legacy Loyalty\n\nPlatform: SQL Server, POS barcode matching\nCapabilities:\n* Flybuys card scanning at POS\n* CSV batch export (manual Data Team process)\n* SFTP upload to Flybuys\n\nLimitations:\n* 24+ hour delay for points posting\n* No retry logic\n* Manual intervention required\n* No mobile app integration\n\n===== Salesforce CRM\n\nPlatform: Salesforce Sales Cloud\nCapabilities:\n* Customer profile system of record\n* Flybuys Digital Identity stored (manual updates via Flybuys)\n\nLimitations:\n* No real-time reward preference updates\n* No automated partner linking workflow\n\n===== EagleEye\n\nPlatform: SaaS loyalty engine\nCapabilities:\n* Wallet management (grants, offers, fuel discounts)\n* Points ledger\n* Membership tiers\n* Campaign management\n\nLimitations:\n* Not integrated with OTR/REXP POS for real-time adjudication\n* No event publishing to OTR systems\n\n===== Coupon Scanner\n\nPlatform: Hardware device at OTR+ POS\nCapabilities:\n* Barcode scanning (Flybuys cards, fuel dockets)\n* Integrated with D365 Commerce\n\n==== Integration Architecture\n\n[Mermaid diagram showing current state integrations - to be created]\n\nCurrent integration patterns:\n* Direct coupling: POS → Flybuys (barcode pattern matching)\n* Manual batch: Data Team → SFTP → Flybuys\n* Synchronous: Mobile App → OTR App API\n* No event-driven architecture\n\n==== Pain Points\n\n[Copy from Architecture Definition lines 280-289]\n\n==== Technical Debt\n\n[Extract from TS-0 section lines 4433-4437]\n\n* Fragmented customer identity (OTR vs Reddy Express silos)\n* No event-driven architecture (synchronous-only integrations)\n* Tight POS coupling (direct Flybuys barcode pattern matching)\n* No OAuth infrastructure\n* Manual batch processing\n* No distributed tracing\n```\n\n**Actions**:\n\n1. Create new Baseline Architecture section BEFORE Gap Analysis\n2. Extract content from TS-0 Current State (lines 4421-4438)\n3. Copy Current Business Capability and Value Stream from Architecture Definition\n4. Expand Existing System Components with detailed platform/capabilities/limitations\n5. Create current state integration architecture diagram\n6. Copy Pain Points from Architecture Definition\n7. Consolidate Technical Debt from TS-0\n\n**Rationale**: Salesforce has comprehensive baseline before gap analysis. TOGAF requires baseline-gap-target progression.\n\n#### 5.2 Gap Analysis (RELOCATED)\n\n**Current State**: Lines 3242-3376 (after Interface Specifications)\n\n**Target State**: Lines ~2500-2700 (in Technical Architecture, after Baseline, before Target State)\n\n**Actions**:\n\n1. Move entire Gap Analysis section from line 3242 to Technical Architecture\n2. Keep existing structure (Missing Capabilities, Missing Bounded Contexts, Missing Integration Patterns)\n3. Add reference to Baseline Architecture for context\n\n**Rationale**: Gap Analysis should follow Baseline and precede Target State for logical flow (Baseline → Gap → Target).\n\n#### 5.3 Target State Architecture (KEEP)\n\n**Actions**: Keep existing Target State Architecture (ABB definitions, integration architecture)\n\n#### 5.4 Architecture Decisions (MAJOR CONVERSION)\n\n**Current State**: Key Technology Decisions table (lines 110-210) - informal format\n\n**Target State**: Formal ADRs following Salesforce pattern\n\n**Conversion Template**:\n\n```asciidoc\n=== Architecture Decisions\n\n==== ADR-FB-001: .NET 8.0 Implementation Stack\n\n*Status*: Accepted\n\n*Context*:\n\n* OTR platform requires modern, high-performance backend framework\n* Team has strong C# expertise\n* Need cross-platform support (Azure, AWS)\n* Alignment with OTR platform standards critical\n\n*Decision*:\n\nUse .NET 8.0 as the implementation stack for Profile Service, Loyalty Service, and Engagement Service.\n\n*Rationale*:\n\n* **Team Expertise**: Existing C# skills in OTR development team, reduces training overhead\n* **Platform Standards**: Aligns with OTR platform technical strategy (.NET ecosystem)\n* **Performance**: .NET 8.0 provides high-throughput, low-latency performance (critical for <500ms p95 SLA)\n* **Cross-Platform**: Runs on Azure, AWS, Docker containers\n* **Ecosystem**: Rich library ecosystem (Entity Framework, Polly, OpenTelemetry)\n* **Long-Term Support**: LTS release with 3-year support window\n\n*Consequences*:\n\n* Consistent technology stack across OTR services (maintainability)\n* Leverage existing team expertise (faster delivery)\n* ⚠️ Commitment to .NET ecosystem (vendor dependency on Microsoft)\n* ⚠️ Windows Server licensing if not using Linux containers\n\n*Implementation Notes*:\n\n* Use ASP.NET Core for REST APIs\n* Use Entity Framework Core for NoSQL data access\n* Use Polly for circuit breaker and retry policies\n\n---\n\n==== ADR-FB-002: OAuth 2.0 + PKCE for Partner Linking\n\n*Status*: Accepted\n\n*Context*:\n\n* Customers need to link Flybuys accounts without sharing passwords with OTR\n* Security best practices require Authorization Code Flow with PKCE for mobile apps\n* Flybuys provides OAuth 2.0 identity provider\n* Alternative: Store Flybuys credentials (rejected - security risk)\n\n*Decision*:\n\nImplement OAuth 2.0 Authorization Code Flow with PKCE (Proof Key for Code Exchange) for Flybuys partner account linking.\n\n*Rationale*:\n\n* **Security**: Never store customer Flybuys passwords, only OAuth tokens\n* **Industry Standard**: OAuth 2.0 is proven, well-documented, widely supported\n* **PKCE Protection**: Mitigates authorization code interception attacks on mobile apps\n* **User Experience**: Familiar OAuth consent screen, trusted Flybuys login\n* **Token Lifecycle**: Access token refresh via refresh token (no re-authentication)\n\n*Consequences*:\n\n* Secure partner linking without password storage\n* OAuth token refresh logic required (proactive 50-minute refresh)\n* OAuth tokens must be encrypted at rest (AES-256 in Key Vault)\n* ⚠️ Dependency on Flybuys OAuth availability (circuit breaker required)\n* ⚠️ OAuth UX friction (redirect to Flybuys, consent screen)\n\n*Implementation Notes*:\n\n* OAuth Service (SBB-005) manages token lifecycle\n* Profile Service stores OAuth token reference (not token value)\n* Key Vault stores encrypted tokens\n* Correlation ID propagated through OAuth flow for debugging\n\n---\n\n==== ADR-FB-003: NoSQL Database for Profile and Loyalty Services\n\n*Status*: Accepted (technology TBD)\n\n*Context*:\n\n* Profile Service and Loyalty Service require flexible schema for partner-specific data\n* Need high-throughput, low-latency data access (<100ms p95)\n* Global distribution desirable (Australia East primary, disaster recovery)\n* Partition key performance critical (VCI as partition key)\n* Alternatives: Relational database (rejected - schema rigidity, performance)\n\n*Decision*:\n\nUse NoSQL document database for Profile Service (PartnerLink) and Loyalty Service (RewardTransaction).\n\nTechnology options under evaluation:\n* Azure Cosmos DB (MongoDB API)\n* AWS DynamoDB\n* MongoDB Atlas\n\n*Rationale*:\n\n* **Schema Flexibility**: Partner-specific metadata (Flybuys, Shell, future partners) without schema migrations\n* **Partition Key Performance**: VCI as partition key enables horizontal scaling\n* **TTL Support**: Automatic RewardTransaction expiry (90 days retention)\n* **Low Latency**: Single-digit millisecond read/write performance\n* **Global Distribution**: Geo-replication for disaster recovery\n\n*Consequences*:\n\n* Flexible schema supports future coalition partners\n* High performance for transactional workloads\n* ⚠️ Eventually consistent reads (may require strong consistency for wallet queries)\n* ⚠️ Cost increases with throughput (RU/s pricing model)\n* ⚠️ Limited ad-hoc query capabilities (design for access patterns upfront)\n\n*Implementation Notes*:\n\n* Partition key: `vivaConsumerId` (VCI)\n* TTL: `RewardTransaction` 90 days, `PartnerLink` indefinite\n* Indexes: See Data Architecture section for detailed schema\n\n---\n\n==== ADR-FB-004: Event-Driven Integration via Event Bus\n\n*Status*: Accepted (technology TBD)\n\n*Context*:\n\n* Profile Service, Loyalty Service, Engagement Service need loose coupling\n* Domain events enable asynchronous notification (PartnerLinked, TransactionAdjudicated, PointsEarned)\n* Need durability, retry logic, dead letter queue\n* Alternatives: Synchronous REST APIs (rejected - tight coupling, cascading failures)\n\n*Decision*:\n\nImplement event-driven integration via Event Bus using Publish-Subscribe pattern with CloudEvents 1.0 standard.\n\nTechnology options under evaluation:\n* Azure Event Grid\n* AWS EventBridge\n* AWS SNS + SQS\n\n*Rationale*:\n\n* **Loose Coupling**: Bounded contexts evolve independently\n* **Asynchronous Processing**: Non-blocking (EngagementService consumes events without blocking Profile/Loyalty)\n* **Durability**: Messages persisted, not lost on service restart\n* **Retry Logic**: Exponential backoff, dead letter queue for failures\n* **Event Replay**: Support for event sourcing patterns in future\n\n*Consequences*:\n\n* Eventual consistency between bounded contexts (not immediate)\n* Event schema governance required (versioning, backward compatibility)\n* Dead letter queue monitoring critical (manual intervention for failures)\n* ⚠️ Debugging complexity (distributed tracing via correlation IDs essential)\n* ⚠️ Event ordering not guaranteed (idempotency required)\n\n*Implementation Notes*:\n\n* CloudEvents 1.0 standard for event schema\n* Topics: `profile.partner-linked`, `loyalty.transaction-adjudicated`, `loyalty.points-earned`\n* Consumer groups: EngagementService, future RecommendationService\n* Correlation ID propagation for distributed tracing\n\n---\n\n==== ADR-FB-005: Phased Rollout with Feature Flags (not big-bang)\n\n*Status*: Accepted\n\n*Context*:\n\n* High-risk integration with POS, EagleEye, Flybuys\n* Need ability to rollback without code deployment\n* Business requires gradual customer enablement (pilot → production)\n* Constraint: No big-bang deployment allowed (CON-004)\n\n*Decision*:\n\nImplement phased rollout using Strangler Fig pattern with feature flags controlling capability enablement:\n\n* TS-1 Foundation: Dark launch (no customer-facing features)\n* TS-2 Linking: Pilot (10% customers, OAuth linking enabled)\n* TS-3 Grants: Production (100% customers, POS integration enabled)\n\n*Rationale*:\n\n* **Risk Mitigation**: Validate each phase before proceeding (Foundation → Linking → Grants)\n* **Zero Downtime**: Parallel deployment with legacy OTR App API\n* **Rapid Rollback**: Disable feature flags without code deployment (<5 minutes)\n* **Gradual Customer Enablement**: Pilot testing reduces production incident risk\n* **Dual-Write Validation**: TS-1 Foundation validates technical implementation without customer impact\n\n*Consequences*:\n\n* Extended migration timeline (6-9 months total)\n* Dual-write overhead during TS-1 Foundation (30 days)\n* Feature flag management complexity (16+ flags across services)\n* ⚠️ Data coexistence challenges (legacy and new systems active simultaneously)\n* ⚠️ Feature flag tech debt after migration (cleanup required)\n\n*Implementation Notes*:\n\n* Feature Flag Service (SBB-017) centralized configuration\n* See Transition Architecture section for complete flag matrix\n* Rollback procedures documented per architecture state\n\n---\n\n==== ADR-FB-006: AES-256 Encryption for OAuth Tokens\n\n*Status*: Accepted\n\n*Context*:\n\n* OAuth tokens provide access to customer Flybuys accounts\n* Security constraint: Tokens must be encrypted at rest (CON-003)\n* Compliance requirement: Customer data residency in Australia East (CON-011)\n* Alternatives: Plaintext storage (rejected - security risk), tokenization service (over-engineered)\n\n*Decision*:\n\nEncrypt OAuth tokens at rest using AES-256 encryption, stored in Key Vault (Azure or AWS Secrets Manager).\n\n*Rationale*:\n\n* **Security Best Practice**: Industry-standard encryption algorithm (FIPS 140-2 validated)\n* **Compliance**: Meets PCI-DSS, GDPR encryption requirements\n* **Key Management**: Key Vault handles key rotation, access control\n* **Secret Reference Pattern**: Profile Service stores reference to Key Vault secret (not token value)\n\n*Consequences*:\n\n* OAuth tokens protected from database breaches\n* Key Vault dependency for token retrieval (latency overhead ~10-20ms)\n* ⚠️ Key Vault availability critical (circuit breaker required)\n* ⚠️ Cost increases with Key Vault operations (per-secret pricing)\n\n*Implementation Notes*:\n\n* Secret naming: `flybuys-token-{vci}`\n* Metadata: `externalMemberId`, `tokenIssuedAt`, `tokenExpiresAt`\n* Encryption: AES-256-GCM mode\n* TLS 1.3 for token transmission (in-flight encryption)\n\n---\n\n==== ADR-FB-007: Nightly Batch SFTP for Flybuys Transaction Posting\n\n*Status*: Accepted\n\n*Context*:\n\n* Flybuys requires batch file delivery for points posting (API does not support real-time posting)\n* Must conform to Flybuys SFTP specifications (CON-002)\n* Current manual batch process error-prone (Data Team)\n* Need retry logic, PGP encryption, acknowledgement file parsing\n\n*Decision*:\n\nImplement automated nightly batch pipeline (SBB-015) for Flybuys transaction posting:\n\n* Loyalty Service aggregates RewardTransaction records (PENDING → POSTED status)\n* Batch File Pipeline generates CSV, PGP-encrypts, uploads to Flybuys SFTP\n* Acknowledgement file processed, updates transaction status (POSTED → CONFIRMED)\n\n*Rationale*:\n\n* **Flybuys Constraint**: Must use SFTP batch (cannot use real-time API)\n* **Automation**: Eliminates manual Data Team intervention\n* **Retry Logic**: Exponential backoff for SFTP failures (max 5 retries)\n* **Idempotency**: Duplicate transaction detection via transaction ID\n* **Compliance**: PGP encryption meets Flybuys security requirements\n\n*Consequences*:\n\n* 24-hour delay for points posting to Flybuys (acceptable per business)\n* Batch acknowledgement rate must be >98% (success criterion)\n* ⚠️ SFTP availability dependency (circuit breaker, DLQ for failures)\n* ⚠️ PGP key management (key rotation, secure storage)\n\n*Implementation Notes*:\n\n* Schedule: 2:00 AM AEST daily (low-traffic window)\n* CSV format: See Interface Specifications section\n* PGP encryption: Public key from Flybuys, private key in Key Vault\n* Acknowledgement parsing: Update RewardTransaction status asynchronously\n\n---\n\n==== ADR-FB-008: Circuit Breaker Pattern for External API Resilience\n\n*Status*: Accepted\n\n*Context*:\n\n* External API dependencies: EagleEye, Flybuys, Salesforce, Braze\n* Need protection from cascading failures\n* Performance SLA: <500ms p95 (cannot wait indefinitely for external APIs)\n* Alternatives: No circuit breaker (rejected - cascading failures), timeout-only (insufficient)\n\n*Decision*:\n\nImplement Circuit Breaker pattern for all external API calls:\n\n* Closed → Open: After 5 consecutive failures\n* Open → Half-Open: After 30 seconds\n* Half-Open → Closed: After 1 successful call\n\n*Rationale*:\n\n* **Cascading Failure Prevention**: Failing fast when external API unavailable\n* **Resource Protection**: Avoid thread pool exhaustion from hanging requests\n* **Graceful Degradation**: Return cached data or error response vs blocking\n* **Auto-Recovery**: Half-open state tests API recovery without overloading\n\n*Consequences*:\n\n* Improved resilience during external API outages\n* Faster failure detection (<30 seconds vs minutes)\n* ⚠️ False positives possible (temporary network blip triggers circuit open)\n* ⚠️ Caching strategy required for degraded mode operation\n\n*Implementation Notes*:\n\n* Library: Polly .NET (circuit breaker + retry policies)\n* Timeout: 3 seconds per external API call\n* Metrics: Circuit breaker state (CLOSED/OPEN/HALF_OPEN) logged, monitored\n* Cache fallback: Return last-known Flybuys balance during circuit open\n\n---\n\n==== ADR-FB-009: Correlation ID Propagation for Distributed Tracing\n\n*Status*: Accepted\n\n*Context*:\n\n* Distributed architecture: Mobile App → Profile Service → Loyalty Service → EagleEye/Flybuys → Event Bus → Engagement Service → Braze\n* Debugging complex transaction flows requires end-to-end tracing\n* Need to correlate logs across services, APIs, events\n* Alternative: No correlation ID (rejected - impossible to debug cross-service issues)\n\n*Decision*:\n\nImplement Correlation ID propagation using `X-Correlation-ID` HTTP header and CloudEvents `correlationid` extension.\n\n*Rationale*:\n\n* **End-to-End Tracing**: Single ID tracks request from Mobile App → Braze notification\n* **Debugging**: Search logs by correlation ID to reconstruct transaction timeline\n* **Observability**: Distributed tracing tools (Jaeger, Zipkin) visualize service dependencies\n* **Industry Standard**: OpenTelemetry trace context propagation\n\n*Consequences*:\n\n* Simplified debugging of cross-service issues\n* Structured logging requirement (JSON format with correlationId field)\n* ⚠️ All services must propagate correlation ID (developer discipline required)\n* ⚠️ Logging overhead (additional metadata per log entry)\n\n*Implementation Notes*:\n\n* HTTP: `X-Correlation-ID` header (generated by Mobile App or API Gateway)\n* Events: CloudEvents `correlationid` extension attribute\n* Logging: Structured JSON logs with `correlationId`, `serviceName`, `timestamp`, `level`, `message`\n* Trace visualization: Jaeger or AWS X-Ray\n\nSee Interface Specifications → Correlation ID Propagation Specification for detailed implementation.\n\n---\n\n==== ADR-FB-010: Conformist Pattern for Flybuys API Integration\n\n*Status*: Accepted\n\n*Context*:\n\n* Flybuys provides OAuth API (member profile, balance query)\n* OTR does not control Flybuys API contract (external partner)\n* Flybuys partnership potentially 2-3 years (CON-006)\n* Need to isolate OTR domain from Flybuys API changes\n* Alternatives: Direct coupling (rejected - brittle), bidirectional ACL (over-engineered for one-way dependency)\n\n*Decision*:\n\nImplement Conformist pattern with Anti-Corruption Layer (ACL) for Flybuys integration:\n\n* Loyalty Service Flybuys ACL (SBB-010) translates Flybuys API → OTR domain model\n* Profile Service conforms to Flybuys OAuth API for partner linking\n* If Flybuys API changes, only ACL adapter requires updates (domain model unchanged)\n\n*Rationale*:\n\n* **Domain Protection**: OTR domain model independent of Flybuys API schema\n* **Partner Flexibility**: Replace Flybuys with Shell/AFL in future without domain model changes\n* **Conformist Pragmatism**: We conform to Flybuys OAuth/API (don't control it)\n* **ACL Isolation**: Translation logic centralized in adapter layer\n\n*Consequences*:\n\n* OTR domain resilient to Flybuys API versioning\n* Future partner integrations follow same pattern\n* ⚠️ ACL maintenance overhead (adapter updates when Flybuys API changes)\n* ⚠️ Translation logic testing required (Flybuys schema → OTR domain)\n\n*Implementation Notes*:\n\n* Flybuys ACL (SBB-010) implements `IPartnerIntegrationAdapter` interface\n* Translation: `FlybuysBalanceResponse` → `PartnerPointsBalance` value object\n* Versioning: Flybuys API v1 supported, adapter handles v1 → v2 migration\n```\n\n**Actions**:\n\n1. Replace \"Key Technology Decisions\" table with formal ADRs\n2. Convert each decision (DEC-001 through DEC-020) into ADR format\n3. For TBD decisions, mark Status as \"Under Evaluation\" with technology options\n4. Add Status, Context, Decision, Rationale, Consequences, Implementation Notes to each ADR\n5. Include cross-references to constraints (CON-xxx), NFRs, and other sections\n6. Link to detailed implementation specs where applicable\n\n**Conversion Matrix**:\n\n| Current Decision | New ADR | Status | Notes |\n|-----------------|---------|--------|-------|\n| DEC-001: .NET 8.0 | ADR-FB-001 | Accepted | Complete ADR with team expertise rationale |\n| DEC-002: Hosting | ADR-FB-002 (renumber) | Under Evaluation | List Azure/AWS options |\n| DEC-003: NoSQL Database | ADR-FB-003 | Accepted (tech TBD) | Document schema flexibility rationale |\n| DEC-004: Event Bus | ADR-FB-004 | Accepted (tech TBD) | Document loose coupling rationale |\n| DEC-005: Key Storage | ADR-FB-006 (reorder) | Accepted (tech TBD) | Focus on AES-256 encryption decision |\n| DEC-006: Data Processing | ADR-FB-007 | Accepted (tech TBD) | Document batch pipeline rationale |\n| DEC-007: Monitoring | ADR-TBD | Under Evaluation | Create placeholder ADR |\n| DEC-008: API Gateway | ADR-TBD | Under Evaluation | Create placeholder ADR |\n| DEC-009: Caching Layer | ADR-TBD | Under Evaluation | Create placeholder ADR |\n| DEC-010: Mobile App | ADR-TBD | Accepted | Kotlin Multiplatform confirmed |\n| DEC-011: Authentication | ADR-TBD | Accepted | Microsoft Entra External ID confirmed |\n| DEC-013: Resilience | ADR-FB-008 | Accepted | Circuit breaker pattern |\n| DEC-014: Feature Flags | ADR-FB-005 | Accepted | Phased rollout decision |\n| DEC-015: Transport | (Implicit) | Accepted | REST/HTTPS standard |\n| DEC-016: Observability | ADR-FB-009 | Accepted | Correlation ID propagation |\n| DEC-017: Deployment | ADR-TBD | Under Evaluation | Docker containers |\n| DEC-018: Encryption (At Rest) | ADR-FB-006 | Accepted | AES-256 |\n| DEC-019: Encryption (In Flight) | (Implicit) | Accepted | TLS 1.3 standard |\n| DEC-020: Schema Registry | ADR-TBD | Under Evaluation | Create placeholder ADR |\n| (NEW) | ADR-FB-002 | Accepted | OAuth 2.0 + PKCE (explicit ADR) |\n| (NEW) | ADR-FB-010 | Accepted | Conformist pattern for Flybuys (DDD strategic) |\n\n**Rationale**: Formal ADRs are TOGAF best practice, provide decision auditability, and make trade-offs explicit. Salesforce uses this format.\n\n### 6. Solution Building Blocks (MINIMAL CHANGES)\n\n**Actions**: Keep existing detailed SBB specifications (SBB-001 through SBB-018). This is a strength of the Flybuys document.\n\n### 7. Data Architecture (MINIMAL CHANGES)\n\n**Actions**:\n\n1. Keep existing Physical Data Models section (detailed JSON schemas)\n2. **NEW**: Add Domain Event Schemas subsection (extract from Interface Specifications)\n3. **NEW**: Add Data Quality & Validation subsection (following Salesforce pattern)\n\n**New Subsection Example**:\n\n```asciidoc\n=== Domain Event Schemas\n\nSee Interface Specifications → Domain Events section for complete AsyncAPI specification.\n\nKey event schemas:\n\n* `profile.partner-linked` (PartnerLinked event)\n* `loyalty.transaction-adjudicated` (TransactionAdjudicated event)\n* `loyalty.points-earned` (PointsEarned event)\n* `engagement.notification-sent` (NotificationSent event)\n\n=== Data Quality & Validation\n\n==== Profile Service Validation Rules\n\n* `vivaConsumerId`: 36-character UUID format\n* `externalMemberId`: 12-digit Flybuys cardholder number\n* `rewardPreference`: Enum (FLYBUYS_POINTS, SHELL_PRICE_SAVE, OTR_REWARDS)\n* `partnerLinkStatus`: Enum (LINKED, UNLINKED, PENDING, ERROR)\n\n==== Loyalty Service Validation Rules\n\n* `transactionId`: Unique per POS transaction\n* `transactionAmount`: Decimal (2 decimal places, positive)\n* `pointsAwarded`: Integer (non-negative)\n* `transactionStatus`: Enum (PENDING, POSTED, CONFIRMED, FAILED)\n\n==== Data Retention Policies\n\n* RewardTransaction: 90 days (TTL)\n* PartnerLink: Indefinite (until customer account deletion)\n* Event Bus messages: 7 days retention\n* Logs: 30 days retention (compliance)\n```\n\n### 8. Interface Specifications (REORGANIZATION)\n\n**Current State**: Comprehensive but mixed content (APIs, events, correlation ID, batch formats, interaction flows all in one section)\n\n**Actions**:\n\n1. Reorganize into clear subsections:\n   - 8.1 REST API Specifications (consolidated)\n   - 8.2 Domain Events (AsyncAPI)\n   - 8.3 API Versioning Policy\n   - 8.4 Correlation ID Propagation Specification (KEEP DETAILED - unique strength)\n   - 8.5 Data Formats (Flybuys CSV batch format)\n   - 8.6 Interaction Flows (sequence diagrams)\n\n2. **Extract** Domain Event Schemas to Data Architecture section (cross-reference here)\n\n3. Keep detailed API documentation, correlation ID spec, batch format spec (strengths)\n\n### 9. Work Packages (ENHANCED)\n\n**Current State**: Work packages defined but sequencing not explicit (lines 3377-4298)\n\n**Target State**: Add Work Package Sequencing section following Salesforce pattern\n\n**Actions**:\n\n1. Keep existing WP-FB-001 through WP-FB-010 (or expand if needed)\n2. **NEW**: Add Work Package Sequencing subsection\n\n**New Subsection Example**:\n\n```asciidoc\n=== Work Package Sequencing\n\n==== Parallel Track 1: Infrastructure & Configuration\n\nCan execute in parallel, no dependencies:\n\n* WP-FB-003: Event Bus Infrastructure (6 weeks)\n* WP-FB-012: API Gateway Setup (2 weeks)\n* WP-FB-013: Monitoring Infrastructure (3 weeks)\n* WP-FB-014: Key Vault Configuration (1 week)\n\n*Duration*: 6 weeks (constrained by Event Bus)\n\n==== Parallel Track 2: Development\n\nProfileService and LoyaltyService can develop in parallel:\n\n* WP-FB-001: ProfileService Development (8 weeks)\n* WP-FB-002: LoyaltyService Development (10 weeks)\n* WP-FB-007: EngagementService Development (6 weeks)\n\n*Duration*: 10 weeks (constrained by LoyaltyService)\n\n*Dependencies*:\n* Both require WP-FB-003 (Event Bus) for event publishing\n* Both require WP-FB-012 (API Gateway) for deployment\n\n==== Sequential Track 3: Integration & Testing\n\nMust execute sequentially after development:\n\n1. WP-FB-004: Flybuys OAuth Integration (4 weeks) - requires WP-FB-001\n2. WP-FB-005: EagleEye Integration (4 weeks) - requires WP-FB-002\n3. WP-FB-006: POS Integration (6 weeks) - requires WP-FB-002, WP-FB-005\n4. WP-FB-008: Integration Testing (4 weeks) - requires WP-FB-001, WP-FB-002, WP-FB-004, WP-FB-005, WP-FB-006\n\n*Duration*: 18 weeks\n\n==== Sequential Track 4: Migration & Cutover\n\nMust execute after integration testing:\n\n1. WP-FB-009: TS-1 Foundation Rollout (4 weeks) - dark launch\n2. WP-FB-010: TS-2 Linking Pilot (6 weeks) - 10% customers\n3. WP-FB-011: TS-3 Grants Production (8 weeks) - 100% customers\n\n*Duration*: 18 weeks\n\n==== Critical Path\n\nTotal Programme Duration: 44 weeks (~11 months)\n\nCritical path:\n\n1. Weeks 1-6: Event Bus Infrastructure (WP-FB-003)\n2. Weeks 1-10: LoyaltyService Development (WP-FB-002) - parallel with infrastructure\n3. Weeks 11-14: EagleEye Integration (WP-FB-005)\n4. Weeks 15-20: POS Integration (WP-FB-006)\n5. Weeks 21-24: Integration Testing (WP-FB-008)\n6. Weeks 25-28: TS-1 Foundation Rollout (WP-FB-009)\n7. Weeks 29-34: TS-2 Linking Pilot (WP-FB-010)\n8. Weeks 35-42: TS-3 Grants Production (WP-FB-011)\n9. Weeks 43-44: Buffer for issues\n\n[Gantt chart or timeline diagram recommended]\n```\n\n### 10. Transition Architecture (KEEP AS-IS)\n\n**Actions**: Keep existing comprehensive Transition Architecture section. This is a strength (feature flag matrix, rollback strategies, TS-0 through TS-4 definitions).\n\n**Minor Adjustment**: Reference Baseline Architecture section for TS-0 details (avoid duplication).\n\n### 11. Assumptions and Constraints (NEW SECTION)\n\n**Source Content**:\n\n- Implementation Constraints (lines 212-218)\n- Constraints from Architecture Definition\n- Implicit assumptions from architecture decisions\n\n**New Structure**:\n\n```asciidoc\n== Assumptions and Constraints\n\n=== Assumptions\n\n[width=\"100%\",cols=\"10%,90%\",options=\"header\",]\n|===\n|ID |Assumption\n\n|ASM-FB-001\n|Flybuys OAuth API will remain stable during development (6-month window)\n\n|ASM-FB-002\n|Flybuys SFTP batch processing will continue to be supported (not replaced by real-time API)\n\n|ASM-FB-003\n|EagleEye API will support wallet provisioning for all OTR customers (no rate limits)\n\n|ASM-FB-004\n|Expected transaction volume (10,000 transactions/day across 1000 stores) is within EagleEye/Flybuys API rate limits\n\n|ASM-FB-005\n|Existing AWS/Azure infrastructure is sufficient for Profile Service, Loyalty Service, Engagement Service (no major capacity expansion required)\n\n|ASM-FB-006\n|Microsoft Entra External ID CIAM will provide OAuth tokens for API authentication (existing infrastructure)\n\n|ASM-FB-007\n|Salesforce CRM will remain system of record for customer profiles (not replaced during initiative)\n\n|ASM-FB-008\n|Mobile app customers have email addresses for Salesforce Contact matching (>95% coverage)\n\n|ASM-FB-009\n|D365 Commerce POS will support <500ms API call latency for transaction adjudication (network capacity)\n\n|ASM-FB-010\n|Flybuys partnership will continue for at least 2 years (business assumption)\n\n|===\n\n=== Constraints\n\n[width=\"100%\",cols=\"10%,15%,75%\",options=\"header\",]\n|===\n|ID |Type |Constraint\n\n|CON-FB-001\n|Technical\n|Must use .NET 8.0 (platform standard) - cannot use other languages/frameworks\n\n|CON-FB-002\n|Integration\n|Must conform to Flybuys API specifications (OAuth, balance query, batch SFTP) - cannot modify\n\n|CON-FB-003\n|Security\n|OAuth tokens must be AES-256 encrypted at rest, TLS 1.3 in transit\n\n|CON-FB-004\n|Deployment\n|Phased rollout required (no big-bang deployment) - business risk mitigation\n\n|CON-FB-005\n|Performance\n|Transaction adjudication must complete <500ms p95 (POS SLA requirement)\n\n|CON-FB-006\n|Business\n|Flybuys partnership potentially 2-3 years - architecture must support partner flexibility (Shell, AFL future partners)\n\n|CON-FB-007\n|Integration\n|Must integrate with EagleEye for wallet management (existing loyalty platform, cannot replace)\n\n|CON-FB-008\n|Integration\n|Must integrate with Salesforce CRM for customer profiles (system of record, cannot replace)\n\n|CON-FB-009\n|Integration\n|Must integrate with Braze for customer notifications (existing marketing platform)\n\n|CON-FB-010\n|Integration\n|Must integrate with D365 Commerce POS (existing POS platform, cannot replace)\n\n|CON-FB-011\n|Compliance\n|Customer data must reside in Australia East region (data sovereignty)\n\n|CON-FB-012\n|Performance\n|Event Bus message processing must complete <5 minutes p95 (Case creation SLA)\n\n|CON-FB-013\n|Reliability\n|Flybuys batch acknowledgement rate must be >98% (business requirement)\n\n|===\n```\n\n**Actions**:\n\n1. Create new Assumptions section with 10+ assumptions extracted from architecture context\n2. Create new Constraints section with explicit technical, integration, security, deployment constraints\n3. Reference constraint IDs (CON-FB-xxx) from ADRs and other sections\n\n### 12. Non-Functional Requirements (NEW SECTION)\n\n**Source Content**:\n\n- Success Criteria (lines 220-224) - partial NFRs\n- Implicit NFRs from architecture decisions\n- Performance targets from sequence diagrams\n- Salesforce NFR structure as template\n\n**New Structure**:\n\n```asciidoc\n== Non-Functional Requirements\n\n=== Performance Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-PERF-001\n|Mobile App API response time (Profile Service + Loyalty Service)\n|p95 < 500ms, p99 < 1 second\n\n|NFR-PERF-002\n|POS transaction adjudication latency (Loyalty Service → EagleEye)\n|p95 < 500ms, p99 < 1 second\n\n|NFR-PERF-003\n|OAuth linking flow completion time (end-to-end user experience)\n|p95 < 3 minutes (including user interaction time)\n\n|NFR-PERF-004\n|Flybuys balance query latency (Loyalty Service → Flybuys API)\n|p95 < 1 second, p99 < 2 seconds\n\n|NFR-PERF-005\n|Event Bus message processing latency (publish to consume)\n|p95 < 30 seconds, p99 < 2 minutes\n\n|NFR-PERF-006\n|Batch file generation and SFTP upload time\n|< 30 minutes (complete by 2:30 AM AEST)\n\n|===\n\n=== Availability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-AVAIL-001\n|Profile Service uptime\n|99.9% (no more than 43 minutes downtime/month)\n\n|NFR-AVAIL-002\n|Loyalty Service uptime\n|99.9% (no more than 43 minutes downtime/month)\n\n|NFR-AVAIL-003\n|Event Bus uptime\n|99.95% (managed service SLA)\n\n|NFR-AVAIL-004\n|Graceful degradation during EagleEye/Flybuys outages\n|Return cached balance, queue transactions for retry\n\n|NFR-AVAIL-005\n|Database replication for disaster recovery\n|Cross-region replication (Australia East → Australia Southeast), RPO < 5 minutes\n\n|===\n\n=== Scalability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-SCALE-001\n|Transaction volume capacity (current baseline)\n|10,000 transactions/day (1000 stores × 10 transactions/store/day)\n\n|NFR-SCALE-002\n|Transaction volume capacity (3x growth)\n|30,000 transactions/day (no performance degradation)\n\n|NFR-SCALE-003\n|Transaction volume capacity (10x peak)\n|100,000 transactions/day (auto-scaling triggers, graceful degradation)\n\n|NFR-SCALE-004\n|OAuth linking volume capacity\n|1,000 linking flows/day (pilot: 10% of 200k DAU × 5% linking rate)\n\n|NFR-SCALE-005\n|Auto-scaling triggers\n|CPU > 70% sustained for 5 minutes → scale out, CPU < 30% for 10 minutes → scale in\n\n|NFR-SCALE-006\n|Future growth capacity\n|Architecture supports 10x growth (100,000 transactions/day) without major redesign\n\n|===\n\n=== Security Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-SEC-001\n|Mobile App authentication\n|Microsoft Entra External ID OAuth 2.0 with JWT tokens (existing CIAM)\n\n|NFR-SEC-002\n|API authorisation: Profile Service, Loyalty Service, Engagement Service\n|JWT token validation, authenticated users only, user context propagation\n\n|NFR-SEC-003\n|Flybuys OAuth token encryption (at rest)\n|AES-256 encryption in Key Vault (CON-FB-003)\n\n|NFR-SEC-004\n|Data encryption in transit\n|TLS 1.3 for all API calls (Mobile App ↔ Services ↔ EagleEye/Flybuys/Salesforce/Braze)\n\n|NFR-SEC-005\n|Data encryption at rest\n|Database encryption at rest (managed by cloud provider)\n\n|NFR-SEC-006\n|Secret management\n|Key Vault / Secrets Manager for OAuth tokens, API keys, PGP keys (no hardcoded secrets)\n\n|NFR-SEC-007\n|PII data handling\n|Customer profile data (email, phone, VCI) treated as PII, GDPR-compliant retention policies\n\n|NFR-SEC-008\n|API rate limiting and throttling\n|API Gateway rate limiting (100 requests/second per user), prevent abuse and DoS\n\n|NFR-SEC-009\n|Logging and auditing\n|Log all API calls, OAuth linking, transaction adjudication, batch posting (no PII in logs)\n\n|NFR-SEC-010\n|PGP encryption for Flybuys batch files\n|2048-bit RSA PGP encryption, Flybuys public key\n\n|===\n\n=== Reliability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-REL-001\n|Retry logic: External API calls (EagleEye, Flybuys, Salesforce, Braze)\n|Exponential backoff (1s, 2s, 4s, 8s, 16s), max 5 retries, then DLQ\n\n|NFR-REL-002\n|Dead letter queue monitoring\n|Alert ops team when DLQ depth > 0 (failed transactions require manual intervention)\n\n|NFR-REL-003\n|Event Bus message durability\n|Messages persisted in Event Bus (not lost on service restart)\n\n|NFR-REL-004\n|Idempotency: Transaction adjudication\n|Duplicate transaction detection via transaction ID (prevent double points)\n\n|NFR-REL-005\n|Circuit breaker: External API calls\n|Open circuit after 5 consecutive failures, half-open retry after 30 seconds\n\n|NFR-REL-006\n|Health checks: Profile Service, Loyalty Service, Engagement Service\n|Health endpoints for load balancer checks, readiness and liveness probes\n\n|NFR-REL-007\n|Disaster recovery: Database\n|Cross-region replication, automated failover, RPO < 5 minutes, RTO < 15 minutes\n\n|NFR-REL-008\n|Batch file acknowledgement rate\n|> 98% acknowledgement rate over 60 days (success criterion)\n\n|===\n\n=== Maintainability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-MAINT-001\n|Code quality: Profile Service, Loyalty Service, Engagement Service\n|> 80% test coverage (unit + integration tests), automated CI/CD pipeline\n\n|NFR-MAINT-002\n|API documentation\n|OpenAPI/Swagger specs for all REST APIs, AsyncAPI for event schemas, auto-generated docs\n\n|NFR-MAINT-003\n|Deployment automation\n|Infrastructure as Code (Terraform/CloudFormation/Bicep), zero-downtime deployments\n\n|NFR-MAINT-004\n|Logging: structured logs\n|JSON-formatted logs with correlation IDs, log levels (DEBUG, INFO, WARN, ERROR), centralized aggregation\n\n|NFR-MAINT-005\n|Monitoring dashboards\n|Real-time dashboards for services, Event Bus, external APIs (see Monitoring section)\n\n|NFR-MAINT-006\n|Alerting and on-call\n|PagerDuty/Opsgenie integration for P1/P2 alerts, on-call rotation\n\n|NFR-MAINT-007\n|Configuration management\n|Externalized configuration (environment variables, Parameter Store), no hardcoded config\n\n|NFR-MAINT-008\n|Versioning: API and events\n|Semantic versioning (v1, v2), backward compatibility, event schema evolution\n\n|===\n\n=== Usability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-USE-001\n|OAuth linking UX\n|Mobile App user receives immediate feedback on linking success/failure (< 2 seconds)\n\n|NFR-USE-002\n|Flybuys balance display latency\n|Balance query completes within 2 seconds (p95), user sees loading indicator\n\n|NFR-USE-003\n|Transaction adjudication confirmation\n|POS receipt shows points earned/pending within 1 second of transaction completion\n\n|NFR-USE-004\n|Error messaging\n|User-friendly error messages for failed linking/balance queries (not technical errors), retry prompts\n\n|NFR-USE-005\n|Accessibility\n|Mobile App OAuth flow meets WCAG 2.1 AA accessibility standards (existing Mobile App compliance)\n\n|===\n\n=== Compliance Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-COMP-001\n|GDPR compliance: PII data\n|Customer profile data (email, phone, VCI) managed per GDPR retention policies (Salesforce governance)\n\n|NFR-COMP-002\n|GDPR compliance: Right to erasure\n|Support \"Delete Account\" request, delete customer data from Profile/Loyalty databases per GDPR Article 17\n\n|NFR-COMP-003\n|Data residency\n|Customer data stored in Australia East region (CON-FB-011)\n\n|NFR-COMP-004\n|Audit trail\n|All OAuth linking, transaction adjudication, batch posting logged for compliance auditing\n\n|NFR-COMP-005\n|API security standards\n|OWASP API Security Top 10 compliance (injection prevention, authentication, authorisation, data exposure)\n\n|NFR-COMP-006\n|PCI-DSS compliance\n|Flybuys OAuth tokens encrypted at rest (AES-256), no plaintext storage\n\n|===\n```\n\n**Actions**:\n\n1. Create comprehensive NFR section with 8 subsections (Performance, Availability, Scalability, Security, Reliability, Maintainability, Usability, Compliance)\n2. Extract targets from Success Criteria, sequence diagrams, architecture decisions\n3. Reference constraint IDs (CON-FB-xxx) and ADRs where applicable\n4. Use Salesforce structure as template (table format with ID, Requirement, Target columns)\n\n### 13. Monitoring and Observability (NEW SECTION)\n\n**Source Content**:\n\n- SBB-012 Application Monitoring (existing)\n- Correlation ID Propagation Specification (existing)\n- Salesforce Monitoring section as template\n\n**New Structure**:\n\n```asciidoc\n== Monitoring and Observability\n\n=== Key Metrics\n\n[width=\"100%\",cols=\"25%,40%,35%\",options=\"header\",]\n|===\n|Metric Category |Metric |Target/Threshold\n\n|*OAuth Linking*\n|OAuth linking success rate\n|> 95%\n\n|*OAuth Linking*\n|OAuth linking completion time (end-to-end)\n|p95 < 3 minutes\n\n|*Transaction Adjudication*\n|Transaction adjudication success rate (POS → Loyalty Service → EagleEye)\n|> 99%\n\n|*Transaction Adjudication*\n|Transaction adjudication latency\n|p95 < 500ms\n\n|*Flybuys Balance Query*\n|Balance query success rate (Loyalty Service → Flybuys API)\n|> 98%\n\n|*Flybuys Balance Query*\n|Balance query latency\n|p95 < 1 second\n\n|*Batch File Processing*\n|Batch file acknowledgement rate (SFTP → Flybuys)\n|> 98%\n\n|*Batch File Processing*\n|Batch file processing time (generation to SFTP upload complete)\n|< 30 minutes\n\n|*Event Bus*\n|Event Bus queue depth (pending messages)\n|< 100 messages\n\n|*Event Bus*\n|Dead letter queue depth (failed messages)\n|= 0 (alert on any failures)\n\n|*Event Bus*\n|Event processing latency (publish to consume)\n|p95 < 30 seconds\n\n|*External API: EagleEye*\n|EagleEye API error rate\n|< 1%\n\n|*External API: EagleEye*\n|EagleEye API latency (wallet provisioning, transaction adjudication)\n|p95 < 300ms\n\n|*External API: Flybuys*\n|Flybuys API error rate\n|< 2%\n\n|*External API: Flybuys*\n|Flybuys API latency (balance query)\n|p95 < 800ms\n\n|*Profile Service*\n|Profile creation success rate (JIT profile creation)\n|> 99.5%\n\n|*Profile Service*\n|Profile API latency\n|p95 < 200ms\n\n|*Loyalty Service*\n|Loyalty Service API latency\n|p95 < 300ms\n\n|*Circuit Breaker*\n|Circuit breaker state (CLOSED/OPEN/HALF_OPEN)\n|CLOSED (alert on OPEN state)\n\n|*Customer Satisfaction*\n|OAuth linking abandonment rate\n|< 10%\n\n|*Customer Satisfaction*\n|Points posting accuracy (batch reconciliation)\n|> 99.5%\n\n|===\n\n=== Alerting Thresholds\n\n[width=\"100%\",cols=\"25%,50%,25%\",options=\"header\",]\n|===\n|Alert |Condition |Severity\n\n|*OAuth linking failures*\n|OAuth linking success rate < 90% over 15-minute window\n|P1 - Critical\n\n|*Transaction adjudication failures*\n|Transaction adjudication success rate < 95% over 5-minute window\n|P1 - Critical\n\n|*Dead letter queue accumulation*\n|Dead letter queue depth > 0 (any failed messages)\n|P2 - High\n\n|*Event Bus queue backlog*\n|Event Bus queue depth > 100 messages for > 30 minutes\n|P2 - High\n\n|*EagleEye API errors*\n|EagleEye API error rate > 5% over 5-minute window\n|P1 - Critical\n\n|*Flybuys API errors*\n|Flybuys API error rate > 10% over 15-minute window\n|P2 - High\n\n|*Batch file acknowledgement failures*\n|Batch file acknowledgement rate < 95% over 7-day rolling window\n|P2 - High\n\n|*Circuit breaker open*\n|Circuit breaker state = OPEN for any external API\n|P1 - Critical\n\n|*Profile Service latency*\n|Profile Service API latency p95 > 1 second\n|P3 - Medium\n\n|*Loyalty Service latency*\n|Loyalty Service API latency p95 > 1 second\n|P3 - Medium\n\n|*Balance query failures*\n|Flybuys balance query success rate < 90% over 15-minute window\n|P2 - High\n\n|===\n\n=== Dashboards\n\n*Profile Service Dashboard:*\n\n* OAuth linking success rate (15-minute rolling window)\n* OAuth linking completion time (p50, p95, p99)\n* Profile creation vs update ratio (JIT profile creation)\n* Salesforce API error rate (Contact queries)\n* Request rate and throughput\n* Circuit breaker state (Salesforce, Flybuys OAuth)\n\n*Loyalty Service Dashboard:*\n\n* Transaction adjudication success rate\n* Transaction adjudication latency (p50, p95, p99)\n* Flybuys balance query success rate\n* Flybuys balance query latency (p50, p95, p99)\n* EagleEye API error rate\n* EagleEye API latency\n* Flybuys API error rate\n* Flybuys API latency\n* Circuit breaker state (EagleEye, Flybuys)\n\n*Batch File Processing Dashboard:*\n\n* Batch file generation time (nightly job)\n* SFTP upload success rate\n* Batch file acknowledgement rate (7-day rolling window)\n* Batch file size (MB, record count)\n* PGP encryption/decryption time\n* Failed batch files (DLQ)\n\n*Event Bus Dashboard:*\n\n* Queue depth (pending messages per topic)\n* Throughput (messages published/consumed per minute)\n* Dead letter queue depth (failed messages)\n* Consumer lag (time between publish and consume)\n* Event processing latency (p50, p95, p99)\n\n*External API Health Dashboard:*\n\n* EagleEye API availability (uptime %)\n* Flybuys API availability (uptime %)\n* Salesforce API availability (uptime %)\n* Braze API availability (uptime %)\n* Circuit breaker state per API (CLOSED/OPEN/HALF_OPEN)\n* API rate limit utilization (% of limit)\n\n*Business Metrics Dashboard:*\n\n* Total OAuth linking attempts per day/week/month\n* Successful partner links (cumulative count)\n* Active Flybuys-linked customers (% of total customers)\n* Total points earned per day/week/month (Flybuys only)\n* Total transactions adjudicated per day/week/month\n* Batch file acknowledgement trend (7-day rolling window)\n\n*Correlation ID Tracing:*\n\n* Distributed trace visualization (Jaeger/Zipkin/AWS X-Ray)\n* End-to-end transaction flow (Mobile App → Services → External APIs → Event Bus)\n* Trace search by correlation ID\n* Latency breakdown by service hop\n\nSee Correlation ID Propagation Specification (Interface Specifications section) for implementation details.\n```\n\n**Actions**:\n\n1. Create comprehensive Monitoring and Observability section\n2. Define Key Metrics table with targets/thresholds\n3. Define Alerting Thresholds table with P1/P2/P3 severity\n4. Define Dashboards for each service, Event Bus, external APIs, business metrics\n5. Reference Correlation ID Propagation Specification for distributed tracing\n\n### 14. Solution Validation (NEW SECTION)\n\n**Source Content**:\n\n- Success Criteria (existing)\n- Implicit validation requirements from NFRs\n- Salesforce Solution Validation section as template\n\n**New Structure**:\n\n```asciidoc\n== Solution Validation\n\nThis section defines the validation criteria and testing approach for the solution.\n\n=== Functional Validation\n\n==== OAuth Linking Flow Testing\n\n*Test Scenarios*:\n\n1. **Happy Path**: Customer initiates Flybuys linking, approves OAuth consent, ProfileService stores PartnerLink, Event Bus publishes PartnerLinked event\n2. **Authorization Denied**: Customer denies OAuth consent, ProfileService returns error, Mobile App shows \"Linking cancelled\"\n3. **Token Exchange Failure**: Flybuys OAuth server unavailable during token exchange, ProfileService retries with exponential backoff, customer sees \"Please try again later\"\n4. **Partner Already Linked**: Customer attempts to link already-linked Flybuys account, ProfileService returns 409 Conflict with error message\n\n*Acceptance Criteria*:\n\n* OAuth linking success rate > 95% over 30-day pilot period (NFR-REL-008)\n* OAuth linking completion time p95 < 3 minutes (NFR-PERF-003)\n* PartnerLinked event published to Event Bus within 5 seconds (NFR-PERF-005)\n\n==== Transaction Adjudication Testing\n\n*Test Scenarios*:\n\n1. **Happy Path**: POS scans Flybuys barcode, Loyalty Service resolves credential to VCI, adjudicates transaction via EagleEye, points awarded, receipt shows points\n2. **Credential Resolution Failure**: Invalid Flybuys barcode, Loyalty Service returns error, POS shows \"Invalid loyalty card\"\n3. **EagleEye Timeout**: EagleEye API unavailable, circuit breaker opens, Loyalty Service returns cached wallet, transaction queued for retry\n4. **Duplicate Transaction**: Duplicate transaction ID, Loyalty Service detects duplicate, returns error (idempotency check)\n\n*Acceptance Criteria*:\n\n* Transaction adjudication success rate > 99% (NFR-REL-004)\n* Transaction adjudication latency p95 < 500ms (NFR-PERF-002)\n* Circuit breaker activates after 5 consecutive failures (ADR-FB-008)\n\n==== Flybuys Balance Query Testing\n\n*Test Scenarios*:\n\n1. **Happy Path**: Customer views Flybuys balance in Mobile App, Loyalty Service queries Flybuys API via ACL, balance displayed\n2. **Flybuys API Unavailable**: Flybuys API timeout, circuit breaker opens, Loyalty Service returns cached balance, user sees \"Balance may be out of date\"\n3. **OAuth Token Expired**: OAuth access token expired, Loyalty Service refreshes token via OAuth Service, retries balance query\n\n*Acceptance Criteria*:\n\n* Balance query success rate > 98% (NFR-REL-001)\n* Balance query latency p95 < 1 second (NFR-PERF-004)\n* OAuth token refresh completes within 2 seconds (SBB-005)\n\n==== Batch File Processing Testing\n\n*Test Scenarios*:\n\n1. **Happy Path**: Nightly batch pipeline aggregates RewardTransaction records, generates CSV, PGP-encrypts, uploads to Flybuys SFTP, acknowledgement file processed\n2. **SFTP Timeout**: SFTP server unavailable, retry logic executes (exponential backoff), batch file uploaded when SFTP recovers\n3. **Partial Batch Rejection**: Flybuys acknowledges partial batch (some transactions rejected), Loyalty Service updates transaction status (CONFIRMED vs FAILED)\n4. **PGP Encryption Failure**: PGP key invalid, batch pipeline alerts ops team, manual intervention required\n\n*Acceptance Criteria*:\n\n* Batch file acknowledgement rate > 98% over 60 days (NFR-REL-008)\n* Batch file processing completes < 30 minutes (NFR-PERF-006)\n* Retry logic succeeds after SFTP recovery (max 5 retries)\n\n=== Non-Functional Validation\n\n==== Performance Testing\n\n*Load Testing*:\n\n*Baseline*: Expected 10,000 transactions/day across 1000 stores (~7 transactions/minute sustained)\n\n* **Normal Load**: 10 transactions/minute sustained for 2 hours (simulate typical daily pattern)\n* **3x Load**: 30 transactions/minute sustained for 1 hour (simulate busy period, 30,000 transactions/day)\n* **10x Peak Load**: 100 transactions/minute for 15 minutes (simulate peak hour, 100,000 transactions/day)\n* **Stress Test**: 500 transactions/minute for 5 minutes (find breaking point, 50x normal)\n\n*Validation*:\n\n* API response time p95 < 500ms under 10x load (NFR-PERF-002)\n* Event Bus queue depth remains manageable (< 100 messages) under 3x load\n* No transaction adjudication failures under sustained 10x load\n* Auto-scaling triggers within 2 minutes of load increase (NFR-SCALE-005)\n\n*Acceptance Criteria*:\n\n* NFR-PERF-001 through NFR-PERF-006 validated under realistic load (3x and 10x baseline)\n* Auto-scaling triggers appropriately, scales to handle 10x peak gracefully\n* Stress test (50x) identifies breaking point and graceful degradation behavior\n\n==== Resilience Testing\n\n*External API Failure Scenarios*:\n\n1. **EagleEye Complete Outage**: EagleEye unavailable for 2 hours, circuit breaker opens, transactions queued, processed when EagleEye recovers\n2. **Flybuys OAuth Unavailable**: Flybuys OAuth server down during linking flow, customer sees error message, retry succeeds when OAuth recovers\n3. **Salesforce API Rate Limit**: Salesforce rate limit exceeded, ProfileService throttles requests, JIT profile creation queued\n\n*Acceptance Criteria*:\n\n* NFR-AVAIL-004 validated (graceful degradation during external API outages)\n* Circuit breaker activates after 5 consecutive failures, auto-recovers via half-open state (ADR-FB-008)\n* Dead letter queue accumulates failed messages, ops team alerted (NFR-REL-002)\n\n==== Security Testing\n\n*Test Scenarios*:\n\n1. **OAuth Token Encryption**: Verify OAuth tokens encrypted at rest in Key Vault (AES-256)\n2. **TLS 1.3**: Verify all API calls use TLS 1.3 (Mobile App ↔ Services ↔ External APIs)\n3. **API Rate Limiting**: Verify API Gateway rate limits (100 requests/second per user)\n4. **PGP Batch Encryption**: Verify Flybuys batch files PGP-encrypted with 2048-bit RSA\n\n*Acceptance Criteria*:\n\n* NFR-SEC-001 through NFR-SEC-010 validated\n* OAuth tokens never stored in plaintext (audit database, logs, Key Vault)\n* API rate limiting prevents DoS attacks (load test validates throttling)\n* PGP encryption verified by Flybuys (acknowledgement file confirms decryption success)\n\n=== Integration Testing\n\n==== End-to-End Integration Flows\n\n1. **OAuth Linking → Balance Query → Transaction Adjudication → Batch Posting → Acknowledgement**:\n   * Customer links Flybuys account (TS-2 Linking)\n   * Customer views Flybuys balance in Mobile App\n   * Customer makes purchase at POS, Flybuys points awarded\n   * Nightly batch posts transaction to Flybuys\n   * Acknowledgement file confirms points credited\n\n2. **Event-Driven Flow: ProfileService → LoyaltyService → EngagementService → Braze**:\n   * ProfileService publishes PartnerLinked event\n   * LoyaltyService consumes event (logs partner link for audit)\n   * EngagementService consumes event (triggers welcome notification via Braze)\n   * Customer receives push notification \"Flybuys account linked successfully\"\n\n*Acceptance Criteria*:\n\n* End-to-end flows complete successfully (100% success rate during integration testing)\n* Correlation ID propagates through entire flow (distributed tracing validates)\n* Event Bus message delivery guarantees validated (at-least-once delivery)\n\n=== Acceptance Criteria Summary\n\n[width=\"100%\",cols=\"60%,40%\",options=\"header\",]\n|===\n|Criterion |Target\n\n|OAuth linking success rate (30-day pilot)\n|> 95%\n\n|Transaction adjudication success rate\n|> 99%\n\n|Transaction adjudication latency p95\n|< 500ms\n\n|Flybuys balance query success rate\n|> 98%\n\n|Batch file acknowledgement rate (60 days)\n|> 98%\n\n|Event Bus message processing latency p95\n|< 30 seconds\n\n|Profile Service uptime\n|99.9%\n\n|Loyalty Service uptime\n|99.9%\n\n|Customer support tickets (missing points)\n|Reduce by 50% from baseline\n\n|OAuth linking abandonment rate\n|< 10%\n\n|===\n\n=== Validation Schedule\n\n* **TS-1 Foundation (Dark Launch)**: Functional testing, performance baseline, integration testing\n* **TS-2 Linking (Pilot)**: OAuth linking flow validation, 10% customer cohort, 30-day monitoring\n* **TS-3 Grants (Production)**: Full end-to-end validation, 100% customers, 60-day batch acknowledgement validation\n* **Post-Cutover**: Continuous monitoring, SLA validation, customer satisfaction surveys\n```\n\n**Actions**:\n\n1. Create comprehensive Solution Validation section\n2. Define functional validation scenarios for each major flow (OAuth linking, transaction adjudication, balance query, batch processing)\n3. Define non-functional validation (performance, resilience, security testing)\n4. Define integration testing scenarios\n5. Consolidate acceptance criteria\n6. Define validation schedule aligned with Transition Architecture phases\n\n## Content Creation vs. Movement\n\n### Content to Move (No Creation)\n\n1. **Executive Summary** - enhance existing with Challenge/Solution/Significance structure\n2. **Gap Analysis** - move from line 3242 to Technical Architecture section\n3. **Implementation Constraints** - move to Assumptions and Constraints section\n4. **Success Criteria** - move to Executive Summary\n5. **TS-0 Baseline** - extract to Baseline Architecture section\n6. **Domain Event Schemas** - extract from Interface Specifications to Data Architecture\n\n### Content to Convert (Transformation)\n\n1. **Key Technology Decisions table** → **Formal ADRs** (10+ ADRs with Status/Context/Rationale/Consequences)\n\n### Content to Create (New Sections)\n\n1. **Vision** (copy from Architecture Definition)\n2. **Architectural Approach** (copy from Architecture Definition)\n3. **Architecture Overview** (copy from Architecture Definition)\n4. **Technical Requirements** (copy from Architecture Definition)\n5. **Executive Summary - Challenge subsection** (synthesize from pain points)\n6. **Executive Summary - Key Architectural Significance** (new analysis)\n7. **Executive Summary - Open Technical Decisions** (extract from #TBD# decisions)\n8. **Baseline Architecture - Existing System Components** (expand from TS-0)\n9. **Baseline Architecture - Integration Architecture** (new diagram)\n10. **Data Architecture - Data Quality & Validation** (new subsection)\n11. **Work Package Sequencing** (new subsection with Gantt chart)\n12. **Assumptions and Constraints** (new section - 10+ assumptions, consolidate constraints)\n13. **Non-Functional Requirements** (new section - 8 subsections, 40+ NFRs)\n14. **Monitoring and Observability** (new section - metrics, alerting, dashboards)\n15. **Solution Validation** (new section - functional, non-functional, integration testing)\n\n## Risks and Mitigation\n\n### Risk 1: Content Duplication Between Architecture Definition and Solution Architecture\n\n**Risk**: Vision, Architectural Approach, Architecture Overview duplicated in both documents\n\n**Mitigation**:\n\n* Architecture Definition remains source of truth for domain model, bounded contexts, and strategic DDD patterns\n* Solution Architecture focuses on implementation (SBBs, work packages, transition architecture, validation)\n* Cross-reference between documents using Antora xrefs\n* Vision/Approach copied to Solution Architecture for stakeholder convenience (executives don't read Architecture Definition)\n\n### Risk 2: Loss of Technical Detail During Restructuring\n\n**Risk**: Detailed physical data models, API specs, correlation ID spec, batch format spec lost during reorganization\n\n**Mitigation**:\n\n* Preserve all existing technical content (Data Architecture, Interface Specifications sections unchanged)\n* Only reorganize subsections, don't delete content\n* Physical data models remain in Data Architecture (strength of Flybuys document)\n* API documentation remains in Interface Specifications (strength of Flybuys document)\n\n### Risk 3: ADR Conversion Time Burden\n\n**Risk**: Converting 20+ technology decisions to formal ADRs is time-consuming\n\n**Mitigation**:\n\n* Prioritize critical architectural decisions first (OAuth, event-driven, phased rollout, circuit breaker)\n* TBD technology decisions can have placeholder ADRs with \"Under Evaluation\" status\n* Use template for consistent ADR structure (accelerates creation)\n* Extract rationale from existing Implementation Constraints, Success Criteria, architecture context\n\n### Risk 4: NFR Creation Without Baseline Metrics\n\n**Risk**: Non-functional requirements created without understanding current state performance\n\n**Mitigation**:\n\n* Extract NFR targets from existing Success Criteria, sequence diagram annotations, architecture decisions\n* Mark NFRs as \"TBD\" where baseline unknown (e.g., current POS adjudication latency)\n* Validate NFRs during TS-1 Foundation (dark launch phase provides baseline)\n* Use Salesforce NFR structure as template (proven pattern)\n\n### Risk 5: Document Length Increase\n\n**Risk**: Restructuring may increase document length beyond 5276 lines\n\n**Mitigation**:\n\n* Target 5500-6000 lines (acceptable for comprehensive solution architecture)\n* Use tables for NFRs, assumptions, constraints (concise format)\n* Reference detailed specs in separate documents where appropriate (e.g., API specs could be separate OpenAPI files)\n* Use Antora xrefs to Architecture Definition for domain model details (avoid duplication)\n\n## Validation Checkpoints\n\n### Checkpoint 1: Executive Summary (After Restructuring)\n\n**Validate**:\n\n* Challenge section clearly articulates pain points (fragmented loyalty, manual batch, no coalition partner linking)\n* Solution section describes three bounded contexts, integration patterns, migration approach\n* Key Architectural Significance highlights strategic impact (first DDD bounded contexts, event-driven foundation, partner flexibility)\n* Success Criteria measurable and testable\n* Technical Constraints comprehensive (Flybuys conformance, encryption, data residency, phased rollout)\n\n**Acceptance**: Executive can read Executive Summary and understand business problem, solution, strategic value without reading rest of document\n\n### Checkpoint 2: Technical Architecture (After Baseline/Gap/Target/ADR Integration)\n\n**Validate**:\n\n* Baseline Architecture comprehensive (existing systems, integration architecture, value stream, pain points, technical debt)\n* Gap Analysis follows Baseline (logical flow: current state → gaps → target state)\n* Target State Architecture references Gap Analysis (demonstrates how gaps addressed)\n* ADRs formal with Status, Context, Decision, Rationale, Consequences (10+ ADRs)\n* ADRs reference constraints, NFRs, other sections (cross-linked)\n\n**Acceptance**: Domain Architect can review Technical Architecture section and understand baseline, gaps, target state, and architectural decisions with rationale\n\n### Checkpoint 3: Non-Functional Requirements (After Creation)\n\n**Validate**:\n\n* 8 subsections (Performance, Availability, Scalability, Security, Reliability, Maintainability, Usability, Compliance)\n* 40+ NFRs with measurable targets\n* NFRs reference ADRs and constraints where applicable\n* NFRs testable during TS-1, TS-2, TS-3 phases\n\n**Acceptance**: Senior Engineer can use NFR section to design load tests, resilience tests, security tests\n\n### Checkpoint 4: Monitoring and Observability (After Creation)\n\n**Validate**:\n\n* Key Metrics table comprehensive (OAuth linking, transaction adjudication, balance query, batch processing, Event Bus, external APIs, business metrics)\n* Alerting Thresholds table defines P1/P2/P3 severity\n* Dashboards defined for each service, Event Bus, external APIs, business metrics\n* Correlation ID Propagation referenced for distributed tracing\n\n**Acceptance**: Platform SRE can configure monitoring dashboards and alerting based on this section\n\n### Checkpoint 5: Solution Validation (After Creation)\n\n**Validate**:\n\n* Functional validation scenarios comprehensive (OAuth linking, transaction adjudication, balance query, batch processing)\n* Non-functional validation defines load testing (3x, 10x, stress test), resilience testing, security testing\n* Integration testing scenarios validate end-to-end flows\n* Acceptance criteria summary consolidates all success criteria\n* Validation schedule aligns with Transition Architecture phases (TS-1, TS-2, TS-3)\n\n**Acceptance**: QA Lead can design test plans based on this section\n\n### Checkpoint 6: Work Package Sequencing (After Enhancement)\n\n**Validate**:\n\n* Parallel Track 1 (Infrastructure) and Track 2 (Development) clearly defined\n* Sequential Track 3 (Integration & Testing) dependencies explicit\n* Sequential Track 4 (Migration & Cutover) dependencies explicit\n* Critical path identified (44 weeks total duration)\n* Gantt chart or timeline diagram recommended\n\n**Acceptance**: Programme Lead can use Work Package Sequencing to plan resource allocation and timeline\n\n## Execution Approach\n\n### Phase 1: Structure and Mapping (2-3 hours)\n\n1. Create document outline with new section headings\n2. Map existing content to new sections (identify what moves, what converts, what creates)\n3. Validate outline against Salesforce structure (ensure TOGAF alignment)\n\n### Phase 2: Content Movement (3-4 hours)\n\n1. Move Gap Analysis from line 3242 to Technical Architecture\n2. Move Implementation Constraints to Assumptions and Constraints\n3. Move Success Criteria to Executive Summary\n4. Extract TS-0 baseline to Baseline Architecture\n5. Extract domain event schemas to Data Architecture\n\n### Phase 3: Content Conversion (6-8 hours)\n\n1. Convert Key Technology Decisions table to formal ADRs (10+ ADRs)\n2. Enhance Executive Summary with Challenge/Solution/Significance structure\n3. Create Baseline Architecture - Existing System Components (expand from TS-0)\n\n### Phase 4: Content Creation (8-10 hours)\n\n1. Copy Vision, Architectural Approach, Architecture Overview from Architecture Definition\n2. Copy Technical Requirements from Architecture Definition\n3. Create Assumptions and Constraints section (10+ assumptions, consolidate constraints)\n4. Create Non-Functional Requirements section (8 subsections, 40+ NFRs)\n5. Create Monitoring and Observability section (metrics, alerting, dashboards)\n6. Create Solution Validation section (functional, non-functional, integration testing)\n7. Create Work Package Sequencing subsection (parallel/sequential tracks, critical path)\n\n### Phase 5: Validation and Polish (2-3 hours)\n\n1. Validate against 6 checkpoints (Executive Summary, Technical Architecture, NFRs, Monitoring, Solution Validation, Work Packages)\n2. Cross-reference ADRs, constraints, NFRs throughout document\n3. Ensure Antora xrefs to Architecture Definition work correctly\n4. Generate diagrams (Baseline Architecture integration diagram, Work Package Gantt chart)\n5. Final review against Salesforce structure\n\n**Total Estimated Effort**: 21-28 hours\n\n## Recommended Next Steps\n\n1. **Review this plan with Domain Architect** - validate approach, section mappings, ADR conversion strategy\n2. **Approve NFR targets** - validate NFR targets with technical team (performance baselines, availability targets)\n3. **Begin Phase 1** - create document outline, map existing content\n4. **Incremental validation** - validate each phase completion against checkpoints before proceeding\n5. **Stakeholder review** - share restructured Executive Summary with business stakeholders for feedback before proceeding to detailed sections\n\n## Appendix: Section Line Count Estimates\n\n| Section | Current Lines | Target Lines | Change |\n|---------|--------------|--------------|--------|\n| Purpose and Scope | 50 | 200 | +150 (add Vision, Architectural Approach, Architecture Overview) |\n| Solution Approach | 40 | 50 | +10 (minor expansion) |\n| Executive Summary | 10 | 250 | +240 (comprehensive restructuring) |\n| Technical Requirements | 0 | 150 | +150 (new section, copy from Arch Def) |\n| Technical Architecture | 600 | 1200 | +600 (add Baseline, ADRs, reorganize) |\n| Solution Building Blocks | 1300 | 1300 | 0 (keep as-is) |\n| Data Architecture | 200 | 400 | +200 (add event schemas, validation) |\n| Interface Specifications | 1500 | 1000 | -500 (extract event schemas to Data Architecture, reorganize) |\n| Work Packages | 900 | 1000 | +100 (add sequencing) |\n| Transition Architecture | 650 | 650 | 0 (keep as-is) |\n| Assumptions and Constraints | 0 | 100 | +100 (new section) |\n| Non-Functional Requirements | 0 | 400 | +400 (new section) |\n| Monitoring and Observability | 0 | 250 | +250 (new section) |\n| Solution Validation | 0 | 300 | +300 (new section) |\n| **TOTAL** | **5250** | **6250** | **+1000 lines** |\n\n**Final Document Size**: 6000-6500 lines (acceptable for comprehensive TOGAF Phase E solution architecture)\n"}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":4,"cache_creation_input_tokens":3341,"cache_read_input_tokens":44055,"cache_creation":{"ephemeral_5m_input_tokens":3341,"ephemeral_1h_input_tokens":0},"output_tokens":22876,"service_tier":"standard"}},"requestId":"req_011CWwDR5VHRMf4Gory7mnRY","type":"assistant","uuid":"ba62851b-aeab-4180-ad45-a8527167cdb7","timestamp":"2026-01-09T05:08:05.127Z"}
{"parentUuid":"ba62851b-aeab-4180-ad45-a8527167cdb7","isSidechain":true,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","agentId":"a7dc162","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01VuYWcbN7GyVyBm3FhoQZsH","type":"tool_result","content":"File created successfully at: /mnt/c/Users/o.young/work/architecture/notes/flybuys_restructuring_plan.md"}]},"uuid":"349636e7-cd42-46b5-9ef0-d63d05e8f6bd","timestamp":"2026-01-09T05:08:07.575Z","toolUseResult":{"type":"create","filePath":"/mnt/c/Users/o.young/work/architecture/notes/flybuys_restructuring_plan.md","content":"# Flybuys Integration Solution Architecture - Restructuring Plan\n\n## Executive Summary\n\nThis plan restructures the Flybuys Integration Solution Architecture (5276 lines) to match the comprehensive TOGAF-aligned structure of the Salesforce Customer Support Solution Architecture (3328 lines), while preserving Flybuys' technical strengths (detailed physical data models, complete API documentation, correlation ID propagation, comprehensive sequence diagrams).\n\n**Target Outcome**: A well-organized, TOGAF Phase E-compliant solution architecture that follows established patterns while maintaining the detailed technical specifications that make the Flybuys document valuable.\n\n## Structural Issues Identified\n\n### Current Flybuys Structure Gaps\n\n1. **Executive Summary**: Brief and positioned early (line 64), lacks formal Challenge/Solution/Significance structure\n2. **Missing Vision Section**: No dedicated vision statement (exists in Architecture Definition but not Solution Architecture)\n3. **Missing Architectural Approach**: Not articulated in Solution Architecture\n4. **Informal Technology Decisions**: \"Key Technology Decisions\" table format instead of formal ADRs with status/context/rationale/consequences\n5. **No Baseline Architecture**: Content scattered in TS-0 section instead of formal baseline analysis\n6. **Missing Assumptions and Constraints**: Implementation constraints embedded in other sections, no formal assumptions list\n7. **Missing Non-Functional Requirements**: No comprehensive NFR section (performance, availability, scalability, security, reliability, maintainability, usability, compliance)\n8. **Missing Monitoring and Observability**: No dedicated section for metrics, alerting, dashboards\n9. **Gap Analysis Placement**: After Interface Specifications (line 3242) instead of integrated into Technical Architecture\n10. **No Technical Requirements Section**: Requirements scattered across Architecture Definition\n\n### Flybuys Strengths to Preserve\n\n1. **Physical Data Models**: Detailed JSON schemas for PartnerLink, RewardTransaction, OAuth Token Storage (lines 1536-1740)\n2. **Complete API Documentation**: Full REST API specs, AsyncAPI event schemas, versioning policy\n3. **Correlation ID Propagation**: Comprehensive specification for distributed tracing (unique to Flybuys)\n4. **SBB Dependency Flowchart**: Visual mapping of Solution Building Block dependencies\n5. **Comprehensive Interaction Flows**: OAuth linking, JIT profile creation, POS integration, batch processing\n6. **Detailed Transition Architecture**: Feature flag matrix, rollback strategies, phased architecture states (TS-0 → TS-4)\n7. **Batch File Format Specification**: CSV format, PGP encryption details\n\n## Target Structure (Based on Salesforce Pattern)\n\n```\n1. Purpose and Scope (100-200 lines)\n   1.1 Purpose\n   1.2 Vision ← NEW (from Architecture Definition)\n   1.3 Architectural Approach ← NEW (from Architecture Definition)\n   1.4 Scope\n       1.4.1 In Scope\n       1.4.2 Out of Scope\n   1.5 Architecture Overview ← NEW (from Architecture Definition)\n       1.5.1 Key Architectural Patterns\n\n2. Solution Approach (50-100 lines)\n   2.1 Related Documentation\n\n3. Executive Summary (150-250 lines) ← RESTRUCTURED\n   3.1 Challenge ← NEW\n   3.2 Solution ← ENHANCED\n       3.2.1 New Bounded Contexts\n       3.2.2 Integration Architecture\n       3.2.3 Migration Approach\n   3.3 Key Architectural Significance ← NEW\n   3.4 Success Criteria (existing)\n   3.5 Technical Constraints ← RELOCATED from Implementation Constraints\n   3.6 Open Technical Decisions ← NEW (TBD items)\n\n4. Technical Requirements ← NEW SECTION\n   4.1 Technical Requirements (from Architecture Definition)\n   4.2 Technical Requirements Mapping (from Architecture Definition)\n\n5. Technical Architecture (800-1200 lines) ← REORGANIZED\n   5.1 Baseline Architecture ← EXTRACTED from TS-0\n       5.1.1 Existing System Components\n       5.1.2 Integration Architecture\n       5.1.3 Current Value Stream\n       5.1.4 Technical Debt\n   5.2 Gap Analysis ← RELOCATED from line 3242\n       5.2.1 Missing Capabilities\n       5.2.2 Missing Bounded Contexts\n       5.2.3 Missing Integration Patterns\n   5.3 Target State Architecture\n       5.3.1 Architectural Building Blocks (ABB)\n       5.3.2 Integration Architecture\n       5.3.3 Data Architecture Principles\n   5.4 Architecture Decisions ← CONVERTED from Key Technology Decisions\n       5.4.1 ADR-FB-001: .NET 8.0 Implementation Stack\n       5.4.2 ADR-FB-002: OAuth 2.0 + PKCE for Partner Linking\n       5.4.3 ADR-FB-003: NoSQL Database for Profile and Loyalty Services\n       5.4.4 ADR-FB-004: Event-Driven Integration via Event Bus\n       5.4.5 ADR-FB-005: Phased Rollout with Feature Flags (not big-bang)\n       5.4.6 ADR-FB-006: AES-256 Encryption for OAuth Tokens\n       5.4.7 ADR-FB-007: Nightly Batch SFTP for Flybuys Transaction Posting\n       5.4.8 ADR-FB-008: Circuit Breaker Pattern for External API Resilience\n       5.4.9 ADR-FB-009: Correlation ID Propagation for Distributed Tracing\n       5.4.10 ADR-FB-010: Conformist Pattern for Flybuys API Integration\n\n6. Solution Building Blocks (1200-1500 lines) ← KEEP DETAILED\n   6.1 Technology Portfolio Catalogue\n   6.2 Solution Building Block Mapping\n   6.3 SBB-001 through SBB-018 (detailed as-is)\n\n7. Data Architecture (400-600 lines) ← KEEP DETAILED\n   7.1 Physical Data Models\n       7.1.1 Profile Service - PartnerLink Document Schema\n       7.1.2 Loyalty Service - RewardTransaction Document Schema\n       7.1.3 OAuth Token Storage Schema (Key Vault)\n   7.2 Domain Event Schemas ← NEW (extract from Interface Specifications)\n   7.3 Data Quality & Validation ← NEW\n\n8. Interface Specifications (800-1000 lines) ← REORGANIZED\n   8.1 REST API Specifications\n       8.1.1 Profile Service API v1\n       8.1.2 Loyalty Service API v1\n       8.1.3 Engagement Service API v1\n   8.2 Domain Events (AsyncAPI)\n       8.2.1 Event Catalogue\n       8.2.2 Event Delivery Guarantees\n   8.3 API Versioning Policy\n   8.4 Correlation ID Propagation Specification ← KEEP DETAILED\n   8.5 Data Formats\n       8.5.1 Flybuys Batch File Format (CSV)\n   8.6 Interaction Flows ← KEEP DETAILED\n       8.6.1 OAuth Linking Flow\n       8.6.2 JIT Profile Creation Flow\n       8.6.3 POS Transaction Adjudication Flow\n       8.6.4 Batch File Processing Flow\n\n9. Work Packages (600-800 lines) ← ENHANCED\n   9.1 Work Package Overview\n   9.2 WP-FB-001 through WP-FB-010 (enhanced with sequencing)\n   9.3 Work Package Sequencing ← NEW\n       9.3.1 Parallel Track 1: Infrastructure & Configuration\n       9.3.2 Parallel Track 2: Development\n       9.3.3 Sequential Track 3: Integration & Testing\n       9.3.4 Sequential Track 4: Migration & Cutover\n       9.3.5 Critical Path\n\n10. Transition Architecture (600-800 lines) ← KEEP AS-IS\n    10.1 Transition Phase Matrix\n    10.2 Rollback Strategy\n    10.3 TS-0 Current State\n    10.4 TS-1 Foundation\n    10.5 TS-2 Linking\n    10.6 TS-3 Grants\n    10.7 TS-4 Target State\n\n11. Assumptions and Constraints ← NEW SECTION\n    11.1 Assumptions\n    11.2 Constraints\n\n12. Non-Functional Requirements ← NEW SECTION\n    12.1 Performance Requirements\n    12.2 Availability Requirements\n    12.3 Scalability Requirements\n    12.4 Security Requirements\n    12.5 Reliability Requirements\n    12.6 Maintainability Requirements\n    12.7 Usability Requirements\n    12.8 Compliance Requirements\n\n13. Monitoring and Observability ← NEW SECTION\n    13.1 Key Metrics\n    13.2 Alerting Thresholds\n    13.3 Dashboards\n\n14. Solution Validation ← NEW SECTION\n    14.1 Functional Validation\n    14.2 Non-Functional Validation\n    14.3 Acceptance Criteria\n```\n\n## Detailed Section Mappings\n\n### 1. Purpose and Scope (NEW Structure)\n\n**Source**: Architecture Definition Introduction & Vision section\n\n**Actions**:\n\n1. **Purpose**: Keep existing (lines 27-29 in Solution Architecture)\n2. **Vision**: Copy from Architecture Definition line 32-33\n3. **Architectural Approach**: Copy from Architecture Definition lines 36-44\n4. **Scope**: Keep existing (In Scope/Out of Scope)\n5. **Architecture Overview**: Copy Mermaid diagram from Architecture Definition lines 50-97\n6. **Key Architectural Patterns**: Copy table from Architecture Definition lines 101-111\n\n**Rationale**: Salesforce structure includes comprehensive context upfront. Flybuys Architecture Definition has excellent vision/approach that should be mirrored in Solution Architecture.\n\n### 2. Solution Approach (MINIMAL CHANGES)\n\n**Actions**: Keep existing Related Documentation section\n\n### 3. Executive Summary (MAJOR RESTRUCTURING)\n\n**Current State**: Brief summary at line 64-71\n\n**Target State**: Comprehensive 150-250 line summary following Salesforce pattern\n\n**New Structure**:\n\n```asciidoc\n== Executive Summary\n\n=== Challenge\n\nOTR and Reddy Express customers experience fragmented loyalty programmes across the OTRG store network:\n\n* **No coalition partner linking**: Customers cannot link Flybuys accounts via mobile app\n* **Manual batch processing**: Reddy Express uses CSV exports, 24+ hour point posting delay\n* **Fragmented customer identity**: OTR users and REXP customers are separate (no unified VCI)\n* **Limited competitive positioning**: No digital coalition loyalty vs national chains (Coles, Woolworths)\n* **High operational overhead**: Manual SFTP batch uploads, no retry logic, support burden\n\n*Business Impact*:\n\n* Low Flybuys adoption (REXP stores only, no app integration)\n* Customer confusion about points availability\n* High support call volume (missing points inquiries)\n* Inability to evolve loyalty strategy independently\n\n=== Solution\n\nThis initiative introduces three new bounded contexts (Profile Service, Loyalty Service, Engagement Service) implementing Domain-Driven Design patterns to enable:\n\n1. **Seamless Coalition Partner Linking**: OAuth 2.0 + PKCE partner account linking via mobile app\n2. **Real-Time Transaction Adjudication**: <500ms p95 POS integration with EagleEye and Flybuys\n3. **Automated Batch Processing**: Nightly SFTP with retry logic, PGP encryption\n4. **Event-Driven Architecture**: Loose coupling via Event Bus (ProfileService → LoyaltyService → EngagementService)\n5. **Phased Migration**: Strangler Fig pattern with feature flags (TS-0 → TS-1 → TS-2 → TS-3 → TS-4)\n\n==== New Bounded Contexts\n\n[width=\"100%\",cols=\"20%,40%,40%\",options=\"header\",]\n|===\n|Bounded Context |Responsibility |Key Aggregates\n\n|Profile Service\n|Partner account linking, reward preference management, canonical customer identity (VCI)\n|PartnerLink, CustomerProfile\n\n|Loyalty Service\n|Transaction adjudication, credential resolution, batch posting, Flybuys ACL\n|RewardTransaction, CredentialMapping\n\n|Engagement Service\n|Customer engagement campaigns, notification orchestration, Braze ACL\n|Campaign, Notification\n\n|===\n\n==== Integration Architecture\n\n* **Anti-Corruption Layer (ACL)**: Isolate from EagleEye, Flybuys, Braze API changes\n* **Customer-Supplier + Conformist**: Conform to Salesforce CRM, Flybuys OAuth\n* **Event-Driven**: Domain events (PartnerLinked, TransactionAdjudicated, PointsEarned)\n* **OAuth 2.0 + PKCE**: Secure partner linking without storing passwords\n\n==== Migration Approach\n\n* **Strangler Fig**: Parallel deployment with legacy OTR App API, gradual feature flag enablement\n* **Zero Downtime**: Dual-write during TS-1 Foundation (30 days)\n* **Rollback Capability**: Each phase independently reversible\n* **Phased Rollout**: TS-1 Foundation (dark launch) → TS-2 Linking (pilot) → TS-3 Grants (production)\n\n=== Key Architectural Significance\n\n1. **First DDD Bounded Contexts**: Establishes pattern for future loyalty capabilities (subscriptions, gamification)\n2. **Event-Driven Foundation**: Event Bus enables future integrations (Braze, Recommendation Service)\n3. **Partner Flexibility**: ACL pattern supports future coalition partners (Shell, AFL)\n4. **Platform Consolidation**: Migrates Reddy Express stores to unified OTR platform\n5. **Operational Resilience**: Circuit breaker, retry logic, automated batch posting\n\n=== Success Criteria\n\n[width=\"100%\",cols=\"60%,40%\",options=\"header\",]\n|===\n|Criterion |Target\n\n|Profile Service / Loyalty Service API p95 latency\n|< 500ms\n\n|OAuth linking success rate (30-day pilot)\n|> 95%\n\n|Flybuys batch acknowledgement rate (60 days)\n|> 98%\n\n|POS transaction adjudication p95 latency\n|< 500ms\n\n|Customer support tickets (missing points)\n|Reduce by 50%\n\n|===\n\n=== Technical Constraints\n\n* Must conform to Flybuys API specifications (cannot modify)\n* OAuth tokens must be AES-256 encrypted at rest, TLS 1.3 in transit\n* Customer data must reside in Australia East region\n* Phased rollout required (no big-bang deployment)\n* Flybuys partnership potentially 2-3 years (architecture must support partner flexibility)\n\n=== Open Technical Decisions (TBD)\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Decision |Status\n\n|Hosting Platform (Azure Container Apps, AKS, AWS ECS/Fargate)\n|Under evaluation (DEC-002)\n\n|NoSQL Database (Cosmos DB, DynamoDB, MongoDB Atlas)\n|Under evaluation (DEC-003)\n\n|Event Bus (Azure Event Grid, AWS EventBridge, SNS+SQS)\n|Under evaluation (DEC-004)\n\n|Secrets Management (Azure Key Vault, AWS Secrets Manager)\n|Under evaluation (DEC-005)\n\n|Data Processing (Azure Data Factory, AWS Step Functions)\n|Under evaluation (DEC-006)\n\n|Monitoring (Azure Monitor, AWS CloudWatch, Datadog)\n|Under evaluation (DEC-007)\n\n|API Gateway (Azure APIM, AWS API Gateway, Kong)\n|Under evaluation (DEC-008)\n\n|Caching Layer (Azure Cache for Redis, AWS ElastiCache)\n|Under evaluation (DEC-009)\n\n|Mobile App Framework (Kotlin Multiplatform confirmed)\n|Confirmed (DEC-010)\n\n|Resilience Library (Polly .NET, custom implementation)\n|Under evaluation (DEC-013)\n\n|Feature Flag Service (LaunchDarkly, Azure App Config, custom)\n|Under evaluation (DEC-014)\n\n|Observability (OpenTelemetry, Jaeger, Zipkin)\n|Under evaluation (DEC-016)\n\n|Schema Registry (Confluent, AWS Glue, custom)\n|Under evaluation (DEC-020)\n\n|===\n```\n\n**Actions**:\n\n1. Replace existing Executive Summary (lines 64-71) with comprehensive structure above\n2. Extract Technical Constraints from Implementation Constraints (lines 212-218)\n3. Extract Open Technical Decisions from Key Technology Decisions table (all #TBD# items)\n4. Create Challenge section synthesizing pain points from Architecture Definition\n5. Create Solution section with three subsections (New Bounded Contexts, Integration Architecture, Migration Approach)\n6. Create Key Architectural Significance section highlighting strategic impact\n7. Keep Success Criteria (lines 220-224)\n\n### 4. Technical Requirements (NEW SECTION)\n\n**Source**: Architecture Definition lines 113-176\n\n**Actions**:\n\n1. Copy Technical Requirements table from Architecture Definition\n2. Copy Technical Requirements Mapping table\n3. Consider whether stakeholder analysis should move here (currently in Architecture Definition only)\n\n**Rationale**: TOGAF Phase C requires explicit technical requirements. Salesforce has this section. Currently only in Architecture Definition.\n\n### 5. Technical Architecture (MAJOR REORGANIZATION)\n\n#### 5.1 Baseline Architecture (EXTRACTED from TS-0)\n\n**Current State**: TS-0 Current State is in Transition Architecture section (lines 4421-4438)\n\n**Target State**: Comprehensive baseline analysis in Technical Architecture section (before Gap Analysis)\n\n**New Structure**:\n\n```asciidoc\n=== Baseline Architecture\n\n==== Current Business Capability\n\n[Copy from Architecture Definition lines 203-217]\n\n==== Current Value Stream\n\n===== Customer Redeems Flybuys Fuel Discount\n\n[Copy sequence diagram and value stream table from Architecture Definition lines 221-278]\n\n==== Existing System Components\n\n[Extract from TS-0 Current State]\n\n===== OTR App API\n\nPlatform: AWS Lambda, DynamoDB\nCapabilities:\n* Customer authentication (Microsoft Entra External ID)\n* Loyalty credential storage (VCI)\n* Mobile app backend\n\nLimitations:\n* No partner account linking\n* No real-time transaction adjudication\n* Synchronous integration only\n\n===== Reddy Express Legacy Loyalty\n\nPlatform: SQL Server, POS barcode matching\nCapabilities:\n* Flybuys card scanning at POS\n* CSV batch export (manual Data Team process)\n* SFTP upload to Flybuys\n\nLimitations:\n* 24+ hour delay for points posting\n* No retry logic\n* Manual intervention required\n* No mobile app integration\n\n===== Salesforce CRM\n\nPlatform: Salesforce Sales Cloud\nCapabilities:\n* Customer profile system of record\n* Flybuys Digital Identity stored (manual updates via Flybuys)\n\nLimitations:\n* No real-time reward preference updates\n* No automated partner linking workflow\n\n===== EagleEye\n\nPlatform: SaaS loyalty engine\nCapabilities:\n* Wallet management (grants, offers, fuel discounts)\n* Points ledger\n* Membership tiers\n* Campaign management\n\nLimitations:\n* Not integrated with OTR/REXP POS for real-time adjudication\n* No event publishing to OTR systems\n\n===== Coupon Scanner\n\nPlatform: Hardware device at OTR+ POS\nCapabilities:\n* Barcode scanning (Flybuys cards, fuel dockets)\n* Integrated with D365 Commerce\n\n==== Integration Architecture\n\n[Mermaid diagram showing current state integrations - to be created]\n\nCurrent integration patterns:\n* Direct coupling: POS → Flybuys (barcode pattern matching)\n* Manual batch: Data Team → SFTP → Flybuys\n* Synchronous: Mobile App → OTR App API\n* No event-driven architecture\n\n==== Pain Points\n\n[Copy from Architecture Definition lines 280-289]\n\n==== Technical Debt\n\n[Extract from TS-0 section lines 4433-4437]\n\n* Fragmented customer identity (OTR vs Reddy Express silos)\n* No event-driven architecture (synchronous-only integrations)\n* Tight POS coupling (direct Flybuys barcode pattern matching)\n* No OAuth infrastructure\n* Manual batch processing\n* No distributed tracing\n```\n\n**Actions**:\n\n1. Create new Baseline Architecture section BEFORE Gap Analysis\n2. Extract content from TS-0 Current State (lines 4421-4438)\n3. Copy Current Business Capability and Value Stream from Architecture Definition\n4. Expand Existing System Components with detailed platform/capabilities/limitations\n5. Create current state integration architecture diagram\n6. Copy Pain Points from Architecture Definition\n7. Consolidate Technical Debt from TS-0\n\n**Rationale**: Salesforce has comprehensive baseline before gap analysis. TOGAF requires baseline-gap-target progression.\n\n#### 5.2 Gap Analysis (RELOCATED)\n\n**Current State**: Lines 3242-3376 (after Interface Specifications)\n\n**Target State**: Lines ~2500-2700 (in Technical Architecture, after Baseline, before Target State)\n\n**Actions**:\n\n1. Move entire Gap Analysis section from line 3242 to Technical Architecture\n2. Keep existing structure (Missing Capabilities, Missing Bounded Contexts, Missing Integration Patterns)\n3. Add reference to Baseline Architecture for context\n\n**Rationale**: Gap Analysis should follow Baseline and precede Target State for logical flow (Baseline → Gap → Target).\n\n#### 5.3 Target State Architecture (KEEP)\n\n**Actions**: Keep existing Target State Architecture (ABB definitions, integration architecture)\n\n#### 5.4 Architecture Decisions (MAJOR CONVERSION)\n\n**Current State**: Key Technology Decisions table (lines 110-210) - informal format\n\n**Target State**: Formal ADRs following Salesforce pattern\n\n**Conversion Template**:\n\n```asciidoc\n=== Architecture Decisions\n\n==== ADR-FB-001: .NET 8.0 Implementation Stack\n\n*Status*: Accepted\n\n*Context*:\n\n* OTR platform requires modern, high-performance backend framework\n* Team has strong C# expertise\n* Need cross-platform support (Azure, AWS)\n* Alignment with OTR platform standards critical\n\n*Decision*:\n\nUse .NET 8.0 as the implementation stack for Profile Service, Loyalty Service, and Engagement Service.\n\n*Rationale*:\n\n* **Team Expertise**: Existing C# skills in OTR development team, reduces training overhead\n* **Platform Standards**: Aligns with OTR platform technical strategy (.NET ecosystem)\n* **Performance**: .NET 8.0 provides high-throughput, low-latency performance (critical for <500ms p95 SLA)\n* **Cross-Platform**: Runs on Azure, AWS, Docker containers\n* **Ecosystem**: Rich library ecosystem (Entity Framework, Polly, OpenTelemetry)\n* **Long-Term Support**: LTS release with 3-year support window\n\n*Consequences*:\n\n* Consistent technology stack across OTR services (maintainability)\n* Leverage existing team expertise (faster delivery)\n* ⚠️ Commitment to .NET ecosystem (vendor dependency on Microsoft)\n* ⚠️ Windows Server licensing if not using Linux containers\n\n*Implementation Notes*:\n\n* Use ASP.NET Core for REST APIs\n* Use Entity Framework Core for NoSQL data access\n* Use Polly for circuit breaker and retry policies\n\n---\n\n==== ADR-FB-002: OAuth 2.0 + PKCE for Partner Linking\n\n*Status*: Accepted\n\n*Context*:\n\n* Customers need to link Flybuys accounts without sharing passwords with OTR\n* Security best practices require Authorization Code Flow with PKCE for mobile apps\n* Flybuys provides OAuth 2.0 identity provider\n* Alternative: Store Flybuys credentials (rejected - security risk)\n\n*Decision*:\n\nImplement OAuth 2.0 Authorization Code Flow with PKCE (Proof Key for Code Exchange) for Flybuys partner account linking.\n\n*Rationale*:\n\n* **Security**: Never store customer Flybuys passwords, only OAuth tokens\n* **Industry Standard**: OAuth 2.0 is proven, well-documented, widely supported\n* **PKCE Protection**: Mitigates authorization code interception attacks on mobile apps\n* **User Experience**: Familiar OAuth consent screen, trusted Flybuys login\n* **Token Lifecycle**: Access token refresh via refresh token (no re-authentication)\n\n*Consequences*:\n\n* Secure partner linking without password storage\n* OAuth token refresh logic required (proactive 50-minute refresh)\n* OAuth tokens must be encrypted at rest (AES-256 in Key Vault)\n* ⚠️ Dependency on Flybuys OAuth availability (circuit breaker required)\n* ⚠️ OAuth UX friction (redirect to Flybuys, consent screen)\n\n*Implementation Notes*:\n\n* OAuth Service (SBB-005) manages token lifecycle\n* Profile Service stores OAuth token reference (not token value)\n* Key Vault stores encrypted tokens\n* Correlation ID propagated through OAuth flow for debugging\n\n---\n\n==== ADR-FB-003: NoSQL Database for Profile and Loyalty Services\n\n*Status*: Accepted (technology TBD)\n\n*Context*:\n\n* Profile Service and Loyalty Service require flexible schema for partner-specific data\n* Need high-throughput, low-latency data access (<100ms p95)\n* Global distribution desirable (Australia East primary, disaster recovery)\n* Partition key performance critical (VCI as partition key)\n* Alternatives: Relational database (rejected - schema rigidity, performance)\n\n*Decision*:\n\nUse NoSQL document database for Profile Service (PartnerLink) and Loyalty Service (RewardTransaction).\n\nTechnology options under evaluation:\n* Azure Cosmos DB (MongoDB API)\n* AWS DynamoDB\n* MongoDB Atlas\n\n*Rationale*:\n\n* **Schema Flexibility**: Partner-specific metadata (Flybuys, Shell, future partners) without schema migrations\n* **Partition Key Performance**: VCI as partition key enables horizontal scaling\n* **TTL Support**: Automatic RewardTransaction expiry (90 days retention)\n* **Low Latency**: Single-digit millisecond read/write performance\n* **Global Distribution**: Geo-replication for disaster recovery\n\n*Consequences*:\n\n* Flexible schema supports future coalition partners\n* High performance for transactional workloads\n* ⚠️ Eventually consistent reads (may require strong consistency for wallet queries)\n* ⚠️ Cost increases with throughput (RU/s pricing model)\n* ⚠️ Limited ad-hoc query capabilities (design for access patterns upfront)\n\n*Implementation Notes*:\n\n* Partition key: `vivaConsumerId` (VCI)\n* TTL: `RewardTransaction` 90 days, `PartnerLink` indefinite\n* Indexes: See Data Architecture section for detailed schema\n\n---\n\n==== ADR-FB-004: Event-Driven Integration via Event Bus\n\n*Status*: Accepted (technology TBD)\n\n*Context*:\n\n* Profile Service, Loyalty Service, Engagement Service need loose coupling\n* Domain events enable asynchronous notification (PartnerLinked, TransactionAdjudicated, PointsEarned)\n* Need durability, retry logic, dead letter queue\n* Alternatives: Synchronous REST APIs (rejected - tight coupling, cascading failures)\n\n*Decision*:\n\nImplement event-driven integration via Event Bus using Publish-Subscribe pattern with CloudEvents 1.0 standard.\n\nTechnology options under evaluation:\n* Azure Event Grid\n* AWS EventBridge\n* AWS SNS + SQS\n\n*Rationale*:\n\n* **Loose Coupling**: Bounded contexts evolve independently\n* **Asynchronous Processing**: Non-blocking (EngagementService consumes events without blocking Profile/Loyalty)\n* **Durability**: Messages persisted, not lost on service restart\n* **Retry Logic**: Exponential backoff, dead letter queue for failures\n* **Event Replay**: Support for event sourcing patterns in future\n\n*Consequences*:\n\n* Eventual consistency between bounded contexts (not immediate)\n* Event schema governance required (versioning, backward compatibility)\n* Dead letter queue monitoring critical (manual intervention for failures)\n* ⚠️ Debugging complexity (distributed tracing via correlation IDs essential)\n* ⚠️ Event ordering not guaranteed (idempotency required)\n\n*Implementation Notes*:\n\n* CloudEvents 1.0 standard for event schema\n* Topics: `profile.partner-linked`, `loyalty.transaction-adjudicated`, `loyalty.points-earned`\n* Consumer groups: EngagementService, future RecommendationService\n* Correlation ID propagation for distributed tracing\n\n---\n\n==== ADR-FB-005: Phased Rollout with Feature Flags (not big-bang)\n\n*Status*: Accepted\n\n*Context*:\n\n* High-risk integration with POS, EagleEye, Flybuys\n* Need ability to rollback without code deployment\n* Business requires gradual customer enablement (pilot → production)\n* Constraint: No big-bang deployment allowed (CON-004)\n\n*Decision*:\n\nImplement phased rollout using Strangler Fig pattern with feature flags controlling capability enablement:\n\n* TS-1 Foundation: Dark launch (no customer-facing features)\n* TS-2 Linking: Pilot (10% customers, OAuth linking enabled)\n* TS-3 Grants: Production (100% customers, POS integration enabled)\n\n*Rationale*:\n\n* **Risk Mitigation**: Validate each phase before proceeding (Foundation → Linking → Grants)\n* **Zero Downtime**: Parallel deployment with legacy OTR App API\n* **Rapid Rollback**: Disable feature flags without code deployment (<5 minutes)\n* **Gradual Customer Enablement**: Pilot testing reduces production incident risk\n* **Dual-Write Validation**: TS-1 Foundation validates technical implementation without customer impact\n\n*Consequences*:\n\n* Extended migration timeline (6-9 months total)\n* Dual-write overhead during TS-1 Foundation (30 days)\n* Feature flag management complexity (16+ flags across services)\n* ⚠️ Data coexistence challenges (legacy and new systems active simultaneously)\n* ⚠️ Feature flag tech debt after migration (cleanup required)\n\n*Implementation Notes*:\n\n* Feature Flag Service (SBB-017) centralized configuration\n* See Transition Architecture section for complete flag matrix\n* Rollback procedures documented per architecture state\n\n---\n\n==== ADR-FB-006: AES-256 Encryption for OAuth Tokens\n\n*Status*: Accepted\n\n*Context*:\n\n* OAuth tokens provide access to customer Flybuys accounts\n* Security constraint: Tokens must be encrypted at rest (CON-003)\n* Compliance requirement: Customer data residency in Australia East (CON-011)\n* Alternatives: Plaintext storage (rejected - security risk), tokenization service (over-engineered)\n\n*Decision*:\n\nEncrypt OAuth tokens at rest using AES-256 encryption, stored in Key Vault (Azure or AWS Secrets Manager).\n\n*Rationale*:\n\n* **Security Best Practice**: Industry-standard encryption algorithm (FIPS 140-2 validated)\n* **Compliance**: Meets PCI-DSS, GDPR encryption requirements\n* **Key Management**: Key Vault handles key rotation, access control\n* **Secret Reference Pattern**: Profile Service stores reference to Key Vault secret (not token value)\n\n*Consequences*:\n\n* OAuth tokens protected from database breaches\n* Key Vault dependency for token retrieval (latency overhead ~10-20ms)\n* ⚠️ Key Vault availability critical (circuit breaker required)\n* ⚠️ Cost increases with Key Vault operations (per-secret pricing)\n\n*Implementation Notes*:\n\n* Secret naming: `flybuys-token-{vci}`\n* Metadata: `externalMemberId`, `tokenIssuedAt`, `tokenExpiresAt`\n* Encryption: AES-256-GCM mode\n* TLS 1.3 for token transmission (in-flight encryption)\n\n---\n\n==== ADR-FB-007: Nightly Batch SFTP for Flybuys Transaction Posting\n\n*Status*: Accepted\n\n*Context*:\n\n* Flybuys requires batch file delivery for points posting (API does not support real-time posting)\n* Must conform to Flybuys SFTP specifications (CON-002)\n* Current manual batch process error-prone (Data Team)\n* Need retry logic, PGP encryption, acknowledgement file parsing\n\n*Decision*:\n\nImplement automated nightly batch pipeline (SBB-015) for Flybuys transaction posting:\n\n* Loyalty Service aggregates RewardTransaction records (PENDING → POSTED status)\n* Batch File Pipeline generates CSV, PGP-encrypts, uploads to Flybuys SFTP\n* Acknowledgement file processed, updates transaction status (POSTED → CONFIRMED)\n\n*Rationale*:\n\n* **Flybuys Constraint**: Must use SFTP batch (cannot use real-time API)\n* **Automation**: Eliminates manual Data Team intervention\n* **Retry Logic**: Exponential backoff for SFTP failures (max 5 retries)\n* **Idempotency**: Duplicate transaction detection via transaction ID\n* **Compliance**: PGP encryption meets Flybuys security requirements\n\n*Consequences*:\n\n* 24-hour delay for points posting to Flybuys (acceptable per business)\n* Batch acknowledgement rate must be >98% (success criterion)\n* ⚠️ SFTP availability dependency (circuit breaker, DLQ for failures)\n* ⚠️ PGP key management (key rotation, secure storage)\n\n*Implementation Notes*:\n\n* Schedule: 2:00 AM AEST daily (low-traffic window)\n* CSV format: See Interface Specifications section\n* PGP encryption: Public key from Flybuys, private key in Key Vault\n* Acknowledgement parsing: Update RewardTransaction status asynchronously\n\n---\n\n==== ADR-FB-008: Circuit Breaker Pattern for External API Resilience\n\n*Status*: Accepted\n\n*Context*:\n\n* External API dependencies: EagleEye, Flybuys, Salesforce, Braze\n* Need protection from cascading failures\n* Performance SLA: <500ms p95 (cannot wait indefinitely for external APIs)\n* Alternatives: No circuit breaker (rejected - cascading failures), timeout-only (insufficient)\n\n*Decision*:\n\nImplement Circuit Breaker pattern for all external API calls:\n\n* Closed → Open: After 5 consecutive failures\n* Open → Half-Open: After 30 seconds\n* Half-Open → Closed: After 1 successful call\n\n*Rationale*:\n\n* **Cascading Failure Prevention**: Failing fast when external API unavailable\n* **Resource Protection**: Avoid thread pool exhaustion from hanging requests\n* **Graceful Degradation**: Return cached data or error response vs blocking\n* **Auto-Recovery**: Half-open state tests API recovery without overloading\n\n*Consequences*:\n\n* Improved resilience during external API outages\n* Faster failure detection (<30 seconds vs minutes)\n* ⚠️ False positives possible (temporary network blip triggers circuit open)\n* ⚠️ Caching strategy required for degraded mode operation\n\n*Implementation Notes*:\n\n* Library: Polly .NET (circuit breaker + retry policies)\n* Timeout: 3 seconds per external API call\n* Metrics: Circuit breaker state (CLOSED/OPEN/HALF_OPEN) logged, monitored\n* Cache fallback: Return last-known Flybuys balance during circuit open\n\n---\n\n==== ADR-FB-009: Correlation ID Propagation for Distributed Tracing\n\n*Status*: Accepted\n\n*Context*:\n\n* Distributed architecture: Mobile App → Profile Service → Loyalty Service → EagleEye/Flybuys → Event Bus → Engagement Service → Braze\n* Debugging complex transaction flows requires end-to-end tracing\n* Need to correlate logs across services, APIs, events\n* Alternative: No correlation ID (rejected - impossible to debug cross-service issues)\n\n*Decision*:\n\nImplement Correlation ID propagation using `X-Correlation-ID` HTTP header and CloudEvents `correlationid` extension.\n\n*Rationale*:\n\n* **End-to-End Tracing**: Single ID tracks request from Mobile App → Braze notification\n* **Debugging**: Search logs by correlation ID to reconstruct transaction timeline\n* **Observability**: Distributed tracing tools (Jaeger, Zipkin) visualize service dependencies\n* **Industry Standard**: OpenTelemetry trace context propagation\n\n*Consequences*:\n\n* Simplified debugging of cross-service issues\n* Structured logging requirement (JSON format with correlationId field)\n* ⚠️ All services must propagate correlation ID (developer discipline required)\n* ⚠️ Logging overhead (additional metadata per log entry)\n\n*Implementation Notes*:\n\n* HTTP: `X-Correlation-ID` header (generated by Mobile App or API Gateway)\n* Events: CloudEvents `correlationid` extension attribute\n* Logging: Structured JSON logs with `correlationId`, `serviceName`, `timestamp`, `level`, `message`\n* Trace visualization: Jaeger or AWS X-Ray\n\nSee Interface Specifications → Correlation ID Propagation Specification for detailed implementation.\n\n---\n\n==== ADR-FB-010: Conformist Pattern for Flybuys API Integration\n\n*Status*: Accepted\n\n*Context*:\n\n* Flybuys provides OAuth API (member profile, balance query)\n* OTR does not control Flybuys API contract (external partner)\n* Flybuys partnership potentially 2-3 years (CON-006)\n* Need to isolate OTR domain from Flybuys API changes\n* Alternatives: Direct coupling (rejected - brittle), bidirectional ACL (over-engineered for one-way dependency)\n\n*Decision*:\n\nImplement Conformist pattern with Anti-Corruption Layer (ACL) for Flybuys integration:\n\n* Loyalty Service Flybuys ACL (SBB-010) translates Flybuys API → OTR domain model\n* Profile Service conforms to Flybuys OAuth API for partner linking\n* If Flybuys API changes, only ACL adapter requires updates (domain model unchanged)\n\n*Rationale*:\n\n* **Domain Protection**: OTR domain model independent of Flybuys API schema\n* **Partner Flexibility**: Replace Flybuys with Shell/AFL in future without domain model changes\n* **Conformist Pragmatism**: We conform to Flybuys OAuth/API (don't control it)\n* **ACL Isolation**: Translation logic centralized in adapter layer\n\n*Consequences*:\n\n* OTR domain resilient to Flybuys API versioning\n* Future partner integrations follow same pattern\n* ⚠️ ACL maintenance overhead (adapter updates when Flybuys API changes)\n* ⚠️ Translation logic testing required (Flybuys schema → OTR domain)\n\n*Implementation Notes*:\n\n* Flybuys ACL (SBB-010) implements `IPartnerIntegrationAdapter` interface\n* Translation: `FlybuysBalanceResponse` → `PartnerPointsBalance` value object\n* Versioning: Flybuys API v1 supported, adapter handles v1 → v2 migration\n```\n\n**Actions**:\n\n1. Replace \"Key Technology Decisions\" table with formal ADRs\n2. Convert each decision (DEC-001 through DEC-020) into ADR format\n3. For TBD decisions, mark Status as \"Under Evaluation\" with technology options\n4. Add Status, Context, Decision, Rationale, Consequences, Implementation Notes to each ADR\n5. Include cross-references to constraints (CON-xxx), NFRs, and other sections\n6. Link to detailed implementation specs where applicable\n\n**Conversion Matrix**:\n\n| Current Decision | New ADR | Status | Notes |\n|-----------------|---------|--------|-------|\n| DEC-001: .NET 8.0 | ADR-FB-001 | Accepted | Complete ADR with team expertise rationale |\n| DEC-002: Hosting | ADR-FB-002 (renumber) | Under Evaluation | List Azure/AWS options |\n| DEC-003: NoSQL Database | ADR-FB-003 | Accepted (tech TBD) | Document schema flexibility rationale |\n| DEC-004: Event Bus | ADR-FB-004 | Accepted (tech TBD) | Document loose coupling rationale |\n| DEC-005: Key Storage | ADR-FB-006 (reorder) | Accepted (tech TBD) | Focus on AES-256 encryption decision |\n| DEC-006: Data Processing | ADR-FB-007 | Accepted (tech TBD) | Document batch pipeline rationale |\n| DEC-007: Monitoring | ADR-TBD | Under Evaluation | Create placeholder ADR |\n| DEC-008: API Gateway | ADR-TBD | Under Evaluation | Create placeholder ADR |\n| DEC-009: Caching Layer | ADR-TBD | Under Evaluation | Create placeholder ADR |\n| DEC-010: Mobile App | ADR-TBD | Accepted | Kotlin Multiplatform confirmed |\n| DEC-011: Authentication | ADR-TBD | Accepted | Microsoft Entra External ID confirmed |\n| DEC-013: Resilience | ADR-FB-008 | Accepted | Circuit breaker pattern |\n| DEC-014: Feature Flags | ADR-FB-005 | Accepted | Phased rollout decision |\n| DEC-015: Transport | (Implicit) | Accepted | REST/HTTPS standard |\n| DEC-016: Observability | ADR-FB-009 | Accepted | Correlation ID propagation |\n| DEC-017: Deployment | ADR-TBD | Under Evaluation | Docker containers |\n| DEC-018: Encryption (At Rest) | ADR-FB-006 | Accepted | AES-256 |\n| DEC-019: Encryption (In Flight) | (Implicit) | Accepted | TLS 1.3 standard |\n| DEC-020: Schema Registry | ADR-TBD | Under Evaluation | Create placeholder ADR |\n| (NEW) | ADR-FB-002 | Accepted | OAuth 2.0 + PKCE (explicit ADR) |\n| (NEW) | ADR-FB-010 | Accepted | Conformist pattern for Flybuys (DDD strategic) |\n\n**Rationale**: Formal ADRs are TOGAF best practice, provide decision auditability, and make trade-offs explicit. Salesforce uses this format.\n\n### 6. Solution Building Blocks (MINIMAL CHANGES)\n\n**Actions**: Keep existing detailed SBB specifications (SBB-001 through SBB-018). This is a strength of the Flybuys document.\n\n### 7. Data Architecture (MINIMAL CHANGES)\n\n**Actions**:\n\n1. Keep existing Physical Data Models section (detailed JSON schemas)\n2. **NEW**: Add Domain Event Schemas subsection (extract from Interface Specifications)\n3. **NEW**: Add Data Quality & Validation subsection (following Salesforce pattern)\n\n**New Subsection Example**:\n\n```asciidoc\n=== Domain Event Schemas\n\nSee Interface Specifications → Domain Events section for complete AsyncAPI specification.\n\nKey event schemas:\n\n* `profile.partner-linked` (PartnerLinked event)\n* `loyalty.transaction-adjudicated` (TransactionAdjudicated event)\n* `loyalty.points-earned` (PointsEarned event)\n* `engagement.notification-sent` (NotificationSent event)\n\n=== Data Quality & Validation\n\n==== Profile Service Validation Rules\n\n* `vivaConsumerId`: 36-character UUID format\n* `externalMemberId`: 12-digit Flybuys cardholder number\n* `rewardPreference`: Enum (FLYBUYS_POINTS, SHELL_PRICE_SAVE, OTR_REWARDS)\n* `partnerLinkStatus`: Enum (LINKED, UNLINKED, PENDING, ERROR)\n\n==== Loyalty Service Validation Rules\n\n* `transactionId`: Unique per POS transaction\n* `transactionAmount`: Decimal (2 decimal places, positive)\n* `pointsAwarded`: Integer (non-negative)\n* `transactionStatus`: Enum (PENDING, POSTED, CONFIRMED, FAILED)\n\n==== Data Retention Policies\n\n* RewardTransaction: 90 days (TTL)\n* PartnerLink: Indefinite (until customer account deletion)\n* Event Bus messages: 7 days retention\n* Logs: 30 days retention (compliance)\n```\n\n### 8. Interface Specifications (REORGANIZATION)\n\n**Current State**: Comprehensive but mixed content (APIs, events, correlation ID, batch formats, interaction flows all in one section)\n\n**Actions**:\n\n1. Reorganize into clear subsections:\n   - 8.1 REST API Specifications (consolidated)\n   - 8.2 Domain Events (AsyncAPI)\n   - 8.3 API Versioning Policy\n   - 8.4 Correlation ID Propagation Specification (KEEP DETAILED - unique strength)\n   - 8.5 Data Formats (Flybuys CSV batch format)\n   - 8.6 Interaction Flows (sequence diagrams)\n\n2. **Extract** Domain Event Schemas to Data Architecture section (cross-reference here)\n\n3. Keep detailed API documentation, correlation ID spec, batch format spec (strengths)\n\n### 9. Work Packages (ENHANCED)\n\n**Current State**: Work packages defined but sequencing not explicit (lines 3377-4298)\n\n**Target State**: Add Work Package Sequencing section following Salesforce pattern\n\n**Actions**:\n\n1. Keep existing WP-FB-001 through WP-FB-010 (or expand if needed)\n2. **NEW**: Add Work Package Sequencing subsection\n\n**New Subsection Example**:\n\n```asciidoc\n=== Work Package Sequencing\n\n==== Parallel Track 1: Infrastructure & Configuration\n\nCan execute in parallel, no dependencies:\n\n* WP-FB-003: Event Bus Infrastructure (6 weeks)\n* WP-FB-012: API Gateway Setup (2 weeks)\n* WP-FB-013: Monitoring Infrastructure (3 weeks)\n* WP-FB-014: Key Vault Configuration (1 week)\n\n*Duration*: 6 weeks (constrained by Event Bus)\n\n==== Parallel Track 2: Development\n\nProfileService and LoyaltyService can develop in parallel:\n\n* WP-FB-001: ProfileService Development (8 weeks)\n* WP-FB-002: LoyaltyService Development (10 weeks)\n* WP-FB-007: EngagementService Development (6 weeks)\n\n*Duration*: 10 weeks (constrained by LoyaltyService)\n\n*Dependencies*:\n* Both require WP-FB-003 (Event Bus) for event publishing\n* Both require WP-FB-012 (API Gateway) for deployment\n\n==== Sequential Track 3: Integration & Testing\n\nMust execute sequentially after development:\n\n1. WP-FB-004: Flybuys OAuth Integration (4 weeks) - requires WP-FB-001\n2. WP-FB-005: EagleEye Integration (4 weeks) - requires WP-FB-002\n3. WP-FB-006: POS Integration (6 weeks) - requires WP-FB-002, WP-FB-005\n4. WP-FB-008: Integration Testing (4 weeks) - requires WP-FB-001, WP-FB-002, WP-FB-004, WP-FB-005, WP-FB-006\n\n*Duration*: 18 weeks\n\n==== Sequential Track 4: Migration & Cutover\n\nMust execute after integration testing:\n\n1. WP-FB-009: TS-1 Foundation Rollout (4 weeks) - dark launch\n2. WP-FB-010: TS-2 Linking Pilot (6 weeks) - 10% customers\n3. WP-FB-011: TS-3 Grants Production (8 weeks) - 100% customers\n\n*Duration*: 18 weeks\n\n==== Critical Path\n\nTotal Programme Duration: 44 weeks (~11 months)\n\nCritical path:\n\n1. Weeks 1-6: Event Bus Infrastructure (WP-FB-003)\n2. Weeks 1-10: LoyaltyService Development (WP-FB-002) - parallel with infrastructure\n3. Weeks 11-14: EagleEye Integration (WP-FB-005)\n4. Weeks 15-20: POS Integration (WP-FB-006)\n5. Weeks 21-24: Integration Testing (WP-FB-008)\n6. Weeks 25-28: TS-1 Foundation Rollout (WP-FB-009)\n7. Weeks 29-34: TS-2 Linking Pilot (WP-FB-010)\n8. Weeks 35-42: TS-3 Grants Production (WP-FB-011)\n9. Weeks 43-44: Buffer for issues\n\n[Gantt chart or timeline diagram recommended]\n```\n\n### 10. Transition Architecture (KEEP AS-IS)\n\n**Actions**: Keep existing comprehensive Transition Architecture section. This is a strength (feature flag matrix, rollback strategies, TS-0 through TS-4 definitions).\n\n**Minor Adjustment**: Reference Baseline Architecture section for TS-0 details (avoid duplication).\n\n### 11. Assumptions and Constraints (NEW SECTION)\n\n**Source Content**:\n\n- Implementation Constraints (lines 212-218)\n- Constraints from Architecture Definition\n- Implicit assumptions from architecture decisions\n\n**New Structure**:\n\n```asciidoc\n== Assumptions and Constraints\n\n=== Assumptions\n\n[width=\"100%\",cols=\"10%,90%\",options=\"header\",]\n|===\n|ID |Assumption\n\n|ASM-FB-001\n|Flybuys OAuth API will remain stable during development (6-month window)\n\n|ASM-FB-002\n|Flybuys SFTP batch processing will continue to be supported (not replaced by real-time API)\n\n|ASM-FB-003\n|EagleEye API will support wallet provisioning for all OTR customers (no rate limits)\n\n|ASM-FB-004\n|Expected transaction volume (10,000 transactions/day across 1000 stores) is within EagleEye/Flybuys API rate limits\n\n|ASM-FB-005\n|Existing AWS/Azure infrastructure is sufficient for Profile Service, Loyalty Service, Engagement Service (no major capacity expansion required)\n\n|ASM-FB-006\n|Microsoft Entra External ID CIAM will provide OAuth tokens for API authentication (existing infrastructure)\n\n|ASM-FB-007\n|Salesforce CRM will remain system of record for customer profiles (not replaced during initiative)\n\n|ASM-FB-008\n|Mobile app customers have email addresses for Salesforce Contact matching (>95% coverage)\n\n|ASM-FB-009\n|D365 Commerce POS will support <500ms API call latency for transaction adjudication (network capacity)\n\n|ASM-FB-010\n|Flybuys partnership will continue for at least 2 years (business assumption)\n\n|===\n\n=== Constraints\n\n[width=\"100%\",cols=\"10%,15%,75%\",options=\"header\",]\n|===\n|ID |Type |Constraint\n\n|CON-FB-001\n|Technical\n|Must use .NET 8.0 (platform standard) - cannot use other languages/frameworks\n\n|CON-FB-002\n|Integration\n|Must conform to Flybuys API specifications (OAuth, balance query, batch SFTP) - cannot modify\n\n|CON-FB-003\n|Security\n|OAuth tokens must be AES-256 encrypted at rest, TLS 1.3 in transit\n\n|CON-FB-004\n|Deployment\n|Phased rollout required (no big-bang deployment) - business risk mitigation\n\n|CON-FB-005\n|Performance\n|Transaction adjudication must complete <500ms p95 (POS SLA requirement)\n\n|CON-FB-006\n|Business\n|Flybuys partnership potentially 2-3 years - architecture must support partner flexibility (Shell, AFL future partners)\n\n|CON-FB-007\n|Integration\n|Must integrate with EagleEye for wallet management (existing loyalty platform, cannot replace)\n\n|CON-FB-008\n|Integration\n|Must integrate with Salesforce CRM for customer profiles (system of record, cannot replace)\n\n|CON-FB-009\n|Integration\n|Must integrate with Braze for customer notifications (existing marketing platform)\n\n|CON-FB-010\n|Integration\n|Must integrate with D365 Commerce POS (existing POS platform, cannot replace)\n\n|CON-FB-011\n|Compliance\n|Customer data must reside in Australia East region (data sovereignty)\n\n|CON-FB-012\n|Performance\n|Event Bus message processing must complete <5 minutes p95 (Case creation SLA)\n\n|CON-FB-013\n|Reliability\n|Flybuys batch acknowledgement rate must be >98% (business requirement)\n\n|===\n```\n\n**Actions**:\n\n1. Create new Assumptions section with 10+ assumptions extracted from architecture context\n2. Create new Constraints section with explicit technical, integration, security, deployment constraints\n3. Reference constraint IDs (CON-FB-xxx) from ADRs and other sections\n\n### 12. Non-Functional Requirements (NEW SECTION)\n\n**Source Content**:\n\n- Success Criteria (lines 220-224) - partial NFRs\n- Implicit NFRs from architecture decisions\n- Performance targets from sequence diagrams\n- Salesforce NFR structure as template\n\n**New Structure**:\n\n```asciidoc\n== Non-Functional Requirements\n\n=== Performance Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-PERF-001\n|Mobile App API response time (Profile Service + Loyalty Service)\n|p95 < 500ms, p99 < 1 second\n\n|NFR-PERF-002\n|POS transaction adjudication latency (Loyalty Service → EagleEye)\n|p95 < 500ms, p99 < 1 second\n\n|NFR-PERF-003\n|OAuth linking flow completion time (end-to-end user experience)\n|p95 < 3 minutes (including user interaction time)\n\n|NFR-PERF-004\n|Flybuys balance query latency (Loyalty Service → Flybuys API)\n|p95 < 1 second, p99 < 2 seconds\n\n|NFR-PERF-005\n|Event Bus message processing latency (publish to consume)\n|p95 < 30 seconds, p99 < 2 minutes\n\n|NFR-PERF-006\n|Batch file generation and SFTP upload time\n|< 30 minutes (complete by 2:30 AM AEST)\n\n|===\n\n=== Availability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-AVAIL-001\n|Profile Service uptime\n|99.9% (no more than 43 minutes downtime/month)\n\n|NFR-AVAIL-002\n|Loyalty Service uptime\n|99.9% (no more than 43 minutes downtime/month)\n\n|NFR-AVAIL-003\n|Event Bus uptime\n|99.95% (managed service SLA)\n\n|NFR-AVAIL-004\n|Graceful degradation during EagleEye/Flybuys outages\n|Return cached balance, queue transactions for retry\n\n|NFR-AVAIL-005\n|Database replication for disaster recovery\n|Cross-region replication (Australia East → Australia Southeast), RPO < 5 minutes\n\n|===\n\n=== Scalability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-SCALE-001\n|Transaction volume capacity (current baseline)\n|10,000 transactions/day (1000 stores × 10 transactions/store/day)\n\n|NFR-SCALE-002\n|Transaction volume capacity (3x growth)\n|30,000 transactions/day (no performance degradation)\n\n|NFR-SCALE-003\n|Transaction volume capacity (10x peak)\n|100,000 transactions/day (auto-scaling triggers, graceful degradation)\n\n|NFR-SCALE-004\n|OAuth linking volume capacity\n|1,000 linking flows/day (pilot: 10% of 200k DAU × 5% linking rate)\n\n|NFR-SCALE-005\n|Auto-scaling triggers\n|CPU > 70% sustained for 5 minutes → scale out, CPU < 30% for 10 minutes → scale in\n\n|NFR-SCALE-006\n|Future growth capacity\n|Architecture supports 10x growth (100,000 transactions/day) without major redesign\n\n|===\n\n=== Security Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-SEC-001\n|Mobile App authentication\n|Microsoft Entra External ID OAuth 2.0 with JWT tokens (existing CIAM)\n\n|NFR-SEC-002\n|API authorisation: Profile Service, Loyalty Service, Engagement Service\n|JWT token validation, authenticated users only, user context propagation\n\n|NFR-SEC-003\n|Flybuys OAuth token encryption (at rest)\n|AES-256 encryption in Key Vault (CON-FB-003)\n\n|NFR-SEC-004\n|Data encryption in transit\n|TLS 1.3 for all API calls (Mobile App ↔ Services ↔ EagleEye/Flybuys/Salesforce/Braze)\n\n|NFR-SEC-005\n|Data encryption at rest\n|Database encryption at rest (managed by cloud provider)\n\n|NFR-SEC-006\n|Secret management\n|Key Vault / Secrets Manager for OAuth tokens, API keys, PGP keys (no hardcoded secrets)\n\n|NFR-SEC-007\n|PII data handling\n|Customer profile data (email, phone, VCI) treated as PII, GDPR-compliant retention policies\n\n|NFR-SEC-008\n|API rate limiting and throttling\n|API Gateway rate limiting (100 requests/second per user), prevent abuse and DoS\n\n|NFR-SEC-009\n|Logging and auditing\n|Log all API calls, OAuth linking, transaction adjudication, batch posting (no PII in logs)\n\n|NFR-SEC-010\n|PGP encryption for Flybuys batch files\n|2048-bit RSA PGP encryption, Flybuys public key\n\n|===\n\n=== Reliability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-REL-001\n|Retry logic: External API calls (EagleEye, Flybuys, Salesforce, Braze)\n|Exponential backoff (1s, 2s, 4s, 8s, 16s), max 5 retries, then DLQ\n\n|NFR-REL-002\n|Dead letter queue monitoring\n|Alert ops team when DLQ depth > 0 (failed transactions require manual intervention)\n\n|NFR-REL-003\n|Event Bus message durability\n|Messages persisted in Event Bus (not lost on service restart)\n\n|NFR-REL-004\n|Idempotency: Transaction adjudication\n|Duplicate transaction detection via transaction ID (prevent double points)\n\n|NFR-REL-005\n|Circuit breaker: External API calls\n|Open circuit after 5 consecutive failures, half-open retry after 30 seconds\n\n|NFR-REL-006\n|Health checks: Profile Service, Loyalty Service, Engagement Service\n|Health endpoints for load balancer checks, readiness and liveness probes\n\n|NFR-REL-007\n|Disaster recovery: Database\n|Cross-region replication, automated failover, RPO < 5 minutes, RTO < 15 minutes\n\n|NFR-REL-008\n|Batch file acknowledgement rate\n|> 98% acknowledgement rate over 60 days (success criterion)\n\n|===\n\n=== Maintainability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-MAINT-001\n|Code quality: Profile Service, Loyalty Service, Engagement Service\n|> 80% test coverage (unit + integration tests), automated CI/CD pipeline\n\n|NFR-MAINT-002\n|API documentation\n|OpenAPI/Swagger specs for all REST APIs, AsyncAPI for event schemas, auto-generated docs\n\n|NFR-MAINT-003\n|Deployment automation\n|Infrastructure as Code (Terraform/CloudFormation/Bicep), zero-downtime deployments\n\n|NFR-MAINT-004\n|Logging: structured logs\n|JSON-formatted logs with correlation IDs, log levels (DEBUG, INFO, WARN, ERROR), centralized aggregation\n\n|NFR-MAINT-005\n|Monitoring dashboards\n|Real-time dashboards for services, Event Bus, external APIs (see Monitoring section)\n\n|NFR-MAINT-006\n|Alerting and on-call\n|PagerDuty/Opsgenie integration for P1/P2 alerts, on-call rotation\n\n|NFR-MAINT-007\n|Configuration management\n|Externalized configuration (environment variables, Parameter Store), no hardcoded config\n\n|NFR-MAINT-008\n|Versioning: API and events\n|Semantic versioning (v1, v2), backward compatibility, event schema evolution\n\n|===\n\n=== Usability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-USE-001\n|OAuth linking UX\n|Mobile App user receives immediate feedback on linking success/failure (< 2 seconds)\n\n|NFR-USE-002\n|Flybuys balance display latency\n|Balance query completes within 2 seconds (p95), user sees loading indicator\n\n|NFR-USE-003\n|Transaction adjudication confirmation\n|POS receipt shows points earned/pending within 1 second of transaction completion\n\n|NFR-USE-004\n|Error messaging\n|User-friendly error messages for failed linking/balance queries (not technical errors), retry prompts\n\n|NFR-USE-005\n|Accessibility\n|Mobile App OAuth flow meets WCAG 2.1 AA accessibility standards (existing Mobile App compliance)\n\n|===\n\n=== Compliance Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-COMP-001\n|GDPR compliance: PII data\n|Customer profile data (email, phone, VCI) managed per GDPR retention policies (Salesforce governance)\n\n|NFR-COMP-002\n|GDPR compliance: Right to erasure\n|Support \"Delete Account\" request, delete customer data from Profile/Loyalty databases per GDPR Article 17\n\n|NFR-COMP-003\n|Data residency\n|Customer data stored in Australia East region (CON-FB-011)\n\n|NFR-COMP-004\n|Audit trail\n|All OAuth linking, transaction adjudication, batch posting logged for compliance auditing\n\n|NFR-COMP-005\n|API security standards\n|OWASP API Security Top 10 compliance (injection prevention, authentication, authorisation, data exposure)\n\n|NFR-COMP-006\n|PCI-DSS compliance\n|Flybuys OAuth tokens encrypted at rest (AES-256), no plaintext storage\n\n|===\n```\n\n**Actions**:\n\n1. Create comprehensive NFR section with 8 subsections (Performance, Availability, Scalability, Security, Reliability, Maintainability, Usability, Compliance)\n2. Extract targets from Success Criteria, sequence diagrams, architecture decisions\n3. Reference constraint IDs (CON-FB-xxx) and ADRs where applicable\n4. Use Salesforce structure as template (table format with ID, Requirement, Target columns)\n\n### 13. Monitoring and Observability (NEW SECTION)\n\n**Source Content**:\n\n- SBB-012 Application Monitoring (existing)\n- Correlation ID Propagation Specification (existing)\n- Salesforce Monitoring section as template\n\n**New Structure**:\n\n```asciidoc\n== Monitoring and Observability\n\n=== Key Metrics\n\n[width=\"100%\",cols=\"25%,40%,35%\",options=\"header\",]\n|===\n|Metric Category |Metric |Target/Threshold\n\n|*OAuth Linking*\n|OAuth linking success rate\n|> 95%\n\n|*OAuth Linking*\n|OAuth linking completion time (end-to-end)\n|p95 < 3 minutes\n\n|*Transaction Adjudication*\n|Transaction adjudication success rate (POS → Loyalty Service → EagleEye)\n|> 99%\n\n|*Transaction Adjudication*\n|Transaction adjudication latency\n|p95 < 500ms\n\n|*Flybuys Balance Query*\n|Balance query success rate (Loyalty Service → Flybuys API)\n|> 98%\n\n|*Flybuys Balance Query*\n|Balance query latency\n|p95 < 1 second\n\n|*Batch File Processing*\n|Batch file acknowledgement rate (SFTP → Flybuys)\n|> 98%\n\n|*Batch File Processing*\n|Batch file processing time (generation to SFTP upload complete)\n|< 30 minutes\n\n|*Event Bus*\n|Event Bus queue depth (pending messages)\n|< 100 messages\n\n|*Event Bus*\n|Dead letter queue depth (failed messages)\n|= 0 (alert on any failures)\n\n|*Event Bus*\n|Event processing latency (publish to consume)\n|p95 < 30 seconds\n\n|*External API: EagleEye*\n|EagleEye API error rate\n|< 1%\n\n|*External API: EagleEye*\n|EagleEye API latency (wallet provisioning, transaction adjudication)\n|p95 < 300ms\n\n|*External API: Flybuys*\n|Flybuys API error rate\n|< 2%\n\n|*External API: Flybuys*\n|Flybuys API latency (balance query)\n|p95 < 800ms\n\n|*Profile Service*\n|Profile creation success rate (JIT profile creation)\n|> 99.5%\n\n|*Profile Service*\n|Profile API latency\n|p95 < 200ms\n\n|*Loyalty Service*\n|Loyalty Service API latency\n|p95 < 300ms\n\n|*Circuit Breaker*\n|Circuit breaker state (CLOSED/OPEN/HALF_OPEN)\n|CLOSED (alert on OPEN state)\n\n|*Customer Satisfaction*\n|OAuth linking abandonment rate\n|< 10%\n\n|*Customer Satisfaction*\n|Points posting accuracy (batch reconciliation)\n|> 99.5%\n\n|===\n\n=== Alerting Thresholds\n\n[width=\"100%\",cols=\"25%,50%,25%\",options=\"header\",]\n|===\n|Alert |Condition |Severity\n\n|*OAuth linking failures*\n|OAuth linking success rate < 90% over 15-minute window\n|P1 - Critical\n\n|*Transaction adjudication failures*\n|Transaction adjudication success rate < 95% over 5-minute window\n|P1 - Critical\n\n|*Dead letter queue accumulation*\n|Dead letter queue depth > 0 (any failed messages)\n|P2 - High\n\n|*Event Bus queue backlog*\n|Event Bus queue depth > 100 messages for > 30 minutes\n|P2 - High\n\n|*EagleEye API errors*\n|EagleEye API error rate > 5% over 5-minute window\n|P1 - Critical\n\n|*Flybuys API errors*\n|Flybuys API error rate > 10% over 15-minute window\n|P2 - High\n\n|*Batch file acknowledgement failures*\n|Batch file acknowledgement rate < 95% over 7-day rolling window\n|P2 - High\n\n|*Circuit breaker open*\n|Circuit breaker state = OPEN for any external API\n|P1 - Critical\n\n|*Profile Service latency*\n|Profile Service API latency p95 > 1 second\n|P3 - Medium\n\n|*Loyalty Service latency*\n|Loyalty Service API latency p95 > 1 second\n|P3 - Medium\n\n|*Balance query failures*\n|Flybuys balance query success rate < 90% over 15-minute window\n|P2 - High\n\n|===\n\n=== Dashboards\n\n*Profile Service Dashboard:*\n\n* OAuth linking success rate (15-minute rolling window)\n* OAuth linking completion time (p50, p95, p99)\n* Profile creation vs update ratio (JIT profile creation)\n* Salesforce API error rate (Contact queries)\n* Request rate and throughput\n* Circuit breaker state (Salesforce, Flybuys OAuth)\n\n*Loyalty Service Dashboard:*\n\n* Transaction adjudication success rate\n* Transaction adjudication latency (p50, p95, p99)\n* Flybuys balance query success rate\n* Flybuys balance query latency (p50, p95, p99)\n* EagleEye API error rate\n* EagleEye API latency\n* Flybuys API error rate\n* Flybuys API latency\n* Circuit breaker state (EagleEye, Flybuys)\n\n*Batch File Processing Dashboard:*\n\n* Batch file generation time (nightly job)\n* SFTP upload success rate\n* Batch file acknowledgement rate (7-day rolling window)\n* Batch file size (MB, record count)\n* PGP encryption/decryption time\n* Failed batch files (DLQ)\n\n*Event Bus Dashboard:*\n\n* Queue depth (pending messages per topic)\n* Throughput (messages published/consumed per minute)\n* Dead letter queue depth (failed messages)\n* Consumer lag (time between publish and consume)\n* Event processing latency (p50, p95, p99)\n\n*External API Health Dashboard:*\n\n* EagleEye API availability (uptime %)\n* Flybuys API availability (uptime %)\n* Salesforce API availability (uptime %)\n* Braze API availability (uptime %)\n* Circuit breaker state per API (CLOSED/OPEN/HALF_OPEN)\n* API rate limit utilization (% of limit)\n\n*Business Metrics Dashboard:*\n\n* Total OAuth linking attempts per day/week/month\n* Successful partner links (cumulative count)\n* Active Flybuys-linked customers (% of total customers)\n* Total points earned per day/week/month (Flybuys only)\n* Total transactions adjudicated per day/week/month\n* Batch file acknowledgement trend (7-day rolling window)\n\n*Correlation ID Tracing:*\n\n* Distributed trace visualization (Jaeger/Zipkin/AWS X-Ray)\n* End-to-end transaction flow (Mobile App → Services → External APIs → Event Bus)\n* Trace search by correlation ID\n* Latency breakdown by service hop\n\nSee Correlation ID Propagation Specification (Interface Specifications section) for implementation details.\n```\n\n**Actions**:\n\n1. Create comprehensive Monitoring and Observability section\n2. Define Key Metrics table with targets/thresholds\n3. Define Alerting Thresholds table with P1/P2/P3 severity\n4. Define Dashboards for each service, Event Bus, external APIs, business metrics\n5. Reference Correlation ID Propagation Specification for distributed tracing\n\n### 14. Solution Validation (NEW SECTION)\n\n**Source Content**:\n\n- Success Criteria (existing)\n- Implicit validation requirements from NFRs\n- Salesforce Solution Validation section as template\n\n**New Structure**:\n\n```asciidoc\n== Solution Validation\n\nThis section defines the validation criteria and testing approach for the solution.\n\n=== Functional Validation\n\n==== OAuth Linking Flow Testing\n\n*Test Scenarios*:\n\n1. **Happy Path**: Customer initiates Flybuys linking, approves OAuth consent, ProfileService stores PartnerLink, Event Bus publishes PartnerLinked event\n2. **Authorization Denied**: Customer denies OAuth consent, ProfileService returns error, Mobile App shows \"Linking cancelled\"\n3. **Token Exchange Failure**: Flybuys OAuth server unavailable during token exchange, ProfileService retries with exponential backoff, customer sees \"Please try again later\"\n4. **Partner Already Linked**: Customer attempts to link already-linked Flybuys account, ProfileService returns 409 Conflict with error message\n\n*Acceptance Criteria*:\n\n* OAuth linking success rate > 95% over 30-day pilot period (NFR-REL-008)\n* OAuth linking completion time p95 < 3 minutes (NFR-PERF-003)\n* PartnerLinked event published to Event Bus within 5 seconds (NFR-PERF-005)\n\n==== Transaction Adjudication Testing\n\n*Test Scenarios*:\n\n1. **Happy Path**: POS scans Flybuys barcode, Loyalty Service resolves credential to VCI, adjudicates transaction via EagleEye, points awarded, receipt shows points\n2. **Credential Resolution Failure**: Invalid Flybuys barcode, Loyalty Service returns error, POS shows \"Invalid loyalty card\"\n3. **EagleEye Timeout**: EagleEye API unavailable, circuit breaker opens, Loyalty Service returns cached wallet, transaction queued for retry\n4. **Duplicate Transaction**: Duplicate transaction ID, Loyalty Service detects duplicate, returns error (idempotency check)\n\n*Acceptance Criteria*:\n\n* Transaction adjudication success rate > 99% (NFR-REL-004)\n* Transaction adjudication latency p95 < 500ms (NFR-PERF-002)\n* Circuit breaker activates after 5 consecutive failures (ADR-FB-008)\n\n==== Flybuys Balance Query Testing\n\n*Test Scenarios*:\n\n1. **Happy Path**: Customer views Flybuys balance in Mobile App, Loyalty Service queries Flybuys API via ACL, balance displayed\n2. **Flybuys API Unavailable**: Flybuys API timeout, circuit breaker opens, Loyalty Service returns cached balance, user sees \"Balance may be out of date\"\n3. **OAuth Token Expired**: OAuth access token expired, Loyalty Service refreshes token via OAuth Service, retries balance query\n\n*Acceptance Criteria*:\n\n* Balance query success rate > 98% (NFR-REL-001)\n* Balance query latency p95 < 1 second (NFR-PERF-004)\n* OAuth token refresh completes within 2 seconds (SBB-005)\n\n==== Batch File Processing Testing\n\n*Test Scenarios*:\n\n1. **Happy Path**: Nightly batch pipeline aggregates RewardTransaction records, generates CSV, PGP-encrypts, uploads to Flybuys SFTP, acknowledgement file processed\n2. **SFTP Timeout**: SFTP server unavailable, retry logic executes (exponential backoff), batch file uploaded when SFTP recovers\n3. **Partial Batch Rejection**: Flybuys acknowledges partial batch (some transactions rejected), Loyalty Service updates transaction status (CONFIRMED vs FAILED)\n4. **PGP Encryption Failure**: PGP key invalid, batch pipeline alerts ops team, manual intervention required\n\n*Acceptance Criteria*:\n\n* Batch file acknowledgement rate > 98% over 60 days (NFR-REL-008)\n* Batch file processing completes < 30 minutes (NFR-PERF-006)\n* Retry logic succeeds after SFTP recovery (max 5 retries)\n\n=== Non-Functional Validation\n\n==== Performance Testing\n\n*Load Testing*:\n\n*Baseline*: Expected 10,000 transactions/day across 1000 stores (~7 transactions/minute sustained)\n\n* **Normal Load**: 10 transactions/minute sustained for 2 hours (simulate typical daily pattern)\n* **3x Load**: 30 transactions/minute sustained for 1 hour (simulate busy period, 30,000 transactions/day)\n* **10x Peak Load**: 100 transactions/minute for 15 minutes (simulate peak hour, 100,000 transactions/day)\n* **Stress Test**: 500 transactions/minute for 5 minutes (find breaking point, 50x normal)\n\n*Validation*:\n\n* API response time p95 < 500ms under 10x load (NFR-PERF-002)\n* Event Bus queue depth remains manageable (< 100 messages) under 3x load\n* No transaction adjudication failures under sustained 10x load\n* Auto-scaling triggers within 2 minutes of load increase (NFR-SCALE-005)\n\n*Acceptance Criteria*:\n\n* NFR-PERF-001 through NFR-PERF-006 validated under realistic load (3x and 10x baseline)\n* Auto-scaling triggers appropriately, scales to handle 10x peak gracefully\n* Stress test (50x) identifies breaking point and graceful degradation behavior\n\n==== Resilience Testing\n\n*External API Failure Scenarios*:\n\n1. **EagleEye Complete Outage**: EagleEye unavailable for 2 hours, circuit breaker opens, transactions queued, processed when EagleEye recovers\n2. **Flybuys OAuth Unavailable**: Flybuys OAuth server down during linking flow, customer sees error message, retry succeeds when OAuth recovers\n3. **Salesforce API Rate Limit**: Salesforce rate limit exceeded, ProfileService throttles requests, JIT profile creation queued\n\n*Acceptance Criteria*:\n\n* NFR-AVAIL-004 validated (graceful degradation during external API outages)\n* Circuit breaker activates after 5 consecutive failures, auto-recovers via half-open state (ADR-FB-008)\n* Dead letter queue accumulates failed messages, ops team alerted (NFR-REL-002)\n\n==== Security Testing\n\n*Test Scenarios*:\n\n1. **OAuth Token Encryption**: Verify OAuth tokens encrypted at rest in Key Vault (AES-256)\n2. **TLS 1.3**: Verify all API calls use TLS 1.3 (Mobile App ↔ Services ↔ External APIs)\n3. **API Rate Limiting**: Verify API Gateway rate limits (100 requests/second per user)\n4. **PGP Batch Encryption**: Verify Flybuys batch files PGP-encrypted with 2048-bit RSA\n\n*Acceptance Criteria*:\n\n* NFR-SEC-001 through NFR-SEC-010 validated\n* OAuth tokens never stored in plaintext (audit database, logs, Key Vault)\n* API rate limiting prevents DoS attacks (load test validates throttling)\n* PGP encryption verified by Flybuys (acknowledgement file confirms decryption success)\n\n=== Integration Testing\n\n==== End-to-End Integration Flows\n\n1. **OAuth Linking → Balance Query → Transaction Adjudication → Batch Posting → Acknowledgement**:\n   * Customer links Flybuys account (TS-2 Linking)\n   * Customer views Flybuys balance in Mobile App\n   * Customer makes purchase at POS, Flybuys points awarded\n   * Nightly batch posts transaction to Flybuys\n   * Acknowledgement file confirms points credited\n\n2. **Event-Driven Flow: ProfileService → LoyaltyService → EngagementService → Braze**:\n   * ProfileService publishes PartnerLinked event\n   * LoyaltyService consumes event (logs partner link for audit)\n   * EngagementService consumes event (triggers welcome notification via Braze)\n   * Customer receives push notification \"Flybuys account linked successfully\"\n\n*Acceptance Criteria*:\n\n* End-to-end flows complete successfully (100% success rate during integration testing)\n* Correlation ID propagates through entire flow (distributed tracing validates)\n* Event Bus message delivery guarantees validated (at-least-once delivery)\n\n=== Acceptance Criteria Summary\n\n[width=\"100%\",cols=\"60%,40%\",options=\"header\",]\n|===\n|Criterion |Target\n\n|OAuth linking success rate (30-day pilot)\n|> 95%\n\n|Transaction adjudication success rate\n|> 99%\n\n|Transaction adjudication latency p95\n|< 500ms\n\n|Flybuys balance query success rate\n|> 98%\n\n|Batch file acknowledgement rate (60 days)\n|> 98%\n\n|Event Bus message processing latency p95\n|< 30 seconds\n\n|Profile Service uptime\n|99.9%\n\n|Loyalty Service uptime\n|99.9%\n\n|Customer support tickets (missing points)\n|Reduce by 50% from baseline\n\n|OAuth linking abandonment rate\n|< 10%\n\n|===\n\n=== Validation Schedule\n\n* **TS-1 Foundation (Dark Launch)**: Functional testing, performance baseline, integration testing\n* **TS-2 Linking (Pilot)**: OAuth linking flow validation, 10% customer cohort, 30-day monitoring\n* **TS-3 Grants (Production)**: Full end-to-end validation, 100% customers, 60-day batch acknowledgement validation\n* **Post-Cutover**: Continuous monitoring, SLA validation, customer satisfaction surveys\n```\n\n**Actions**:\n\n1. Create comprehensive Solution Validation section\n2. Define functional validation scenarios for each major flow (OAuth linking, transaction adjudication, balance query, batch processing)\n3. Define non-functional validation (performance, resilience, security testing)\n4. Define integration testing scenarios\n5. Consolidate acceptance criteria\n6. Define validation schedule aligned with Transition Architecture phases\n\n## Content Creation vs. Movement\n\n### Content to Move (No Creation)\n\n1. **Executive Summary** - enhance existing with Challenge/Solution/Significance structure\n2. **Gap Analysis** - move from line 3242 to Technical Architecture section\n3. **Implementation Constraints** - move to Assumptions and Constraints section\n4. **Success Criteria** - move to Executive Summary\n5. **TS-0 Baseline** - extract to Baseline Architecture section\n6. **Domain Event Schemas** - extract from Interface Specifications to Data Architecture\n\n### Content to Convert (Transformation)\n\n1. **Key Technology Decisions table** → **Formal ADRs** (10+ ADRs with Status/Context/Rationale/Consequences)\n\n### Content to Create (New Sections)\n\n1. **Vision** (copy from Architecture Definition)\n2. **Architectural Approach** (copy from Architecture Definition)\n3. **Architecture Overview** (copy from Architecture Definition)\n4. **Technical Requirements** (copy from Architecture Definition)\n5. **Executive Summary - Challenge subsection** (synthesize from pain points)\n6. **Executive Summary - Key Architectural Significance** (new analysis)\n7. **Executive Summary - Open Technical Decisions** (extract from #TBD# decisions)\n8. **Baseline Architecture - Existing System Components** (expand from TS-0)\n9. **Baseline Architecture - Integration Architecture** (new diagram)\n10. **Data Architecture - Data Quality & Validation** (new subsection)\n11. **Work Package Sequencing** (new subsection with Gantt chart)\n12. **Assumptions and Constraints** (new section - 10+ assumptions, consolidate constraints)\n13. **Non-Functional Requirements** (new section - 8 subsections, 40+ NFRs)\n14. **Monitoring and Observability** (new section - metrics, alerting, dashboards)\n15. **Solution Validation** (new section - functional, non-functional, integration testing)\n\n## Risks and Mitigation\n\n### Risk 1: Content Duplication Between Architecture Definition and Solution Architecture\n\n**Risk**: Vision, Architectural Approach, Architecture Overview duplicated in both documents\n\n**Mitigation**:\n\n* Architecture Definition remains source of truth for domain model, bounded contexts, and strategic DDD patterns\n* Solution Architecture focuses on implementation (SBBs, work packages, transition architecture, validation)\n* Cross-reference between documents using Antora xrefs\n* Vision/Approach copied to Solution Architecture for stakeholder convenience (executives don't read Architecture Definition)\n\n### Risk 2: Loss of Technical Detail During Restructuring\n\n**Risk**: Detailed physical data models, API specs, correlation ID spec, batch format spec lost during reorganization\n\n**Mitigation**:\n\n* Preserve all existing technical content (Data Architecture, Interface Specifications sections unchanged)\n* Only reorganize subsections, don't delete content\n* Physical data models remain in Data Architecture (strength of Flybuys document)\n* API documentation remains in Interface Specifications (strength of Flybuys document)\n\n### Risk 3: ADR Conversion Time Burden\n\n**Risk**: Converting 20+ technology decisions to formal ADRs is time-consuming\n\n**Mitigation**:\n\n* Prioritize critical architectural decisions first (OAuth, event-driven, phased rollout, circuit breaker)\n* TBD technology decisions can have placeholder ADRs with \"Under Evaluation\" status\n* Use template for consistent ADR structure (accelerates creation)\n* Extract rationale from existing Implementation Constraints, Success Criteria, architecture context\n\n### Risk 4: NFR Creation Without Baseline Metrics\n\n**Risk**: Non-functional requirements created without understanding current state performance\n\n**Mitigation**:\n\n* Extract NFR targets from existing Success Criteria, sequence diagram annotations, architecture decisions\n* Mark NFRs as \"TBD\" where baseline unknown (e.g., current POS adjudication latency)\n* Validate NFRs during TS-1 Foundation (dark launch phase provides baseline)\n* Use Salesforce NFR structure as template (proven pattern)\n\n### Risk 5: Document Length Increase\n\n**Risk**: Restructuring may increase document length beyond 5276 lines\n\n**Mitigation**:\n\n* Target 5500-6000 lines (acceptable for comprehensive solution architecture)\n* Use tables for NFRs, assumptions, constraints (concise format)\n* Reference detailed specs in separate documents where appropriate (e.g., API specs could be separate OpenAPI files)\n* Use Antora xrefs to Architecture Definition for domain model details (avoid duplication)\n\n## Validation Checkpoints\n\n### Checkpoint 1: Executive Summary (After Restructuring)\n\n**Validate**:\n\n* Challenge section clearly articulates pain points (fragmented loyalty, manual batch, no coalition partner linking)\n* Solution section describes three bounded contexts, integration patterns, migration approach\n* Key Architectural Significance highlights strategic impact (first DDD bounded contexts, event-driven foundation, partner flexibility)\n* Success Criteria measurable and testable\n* Technical Constraints comprehensive (Flybuys conformance, encryption, data residency, phased rollout)\n\n**Acceptance**: Executive can read Executive Summary and understand business problem, solution, strategic value without reading rest of document\n\n### Checkpoint 2: Technical Architecture (After Baseline/Gap/Target/ADR Integration)\n\n**Validate**:\n\n* Baseline Architecture comprehensive (existing systems, integration architecture, value stream, pain points, technical debt)\n* Gap Analysis follows Baseline (logical flow: current state → gaps → target state)\n* Target State Architecture references Gap Analysis (demonstrates how gaps addressed)\n* ADRs formal with Status, Context, Decision, Rationale, Consequences (10+ ADRs)\n* ADRs reference constraints, NFRs, other sections (cross-linked)\n\n**Acceptance**: Domain Architect can review Technical Architecture section and understand baseline, gaps, target state, and architectural decisions with rationale\n\n### Checkpoint 3: Non-Functional Requirements (After Creation)\n\n**Validate**:\n\n* 8 subsections (Performance, Availability, Scalability, Security, Reliability, Maintainability, Usability, Compliance)\n* 40+ NFRs with measurable targets\n* NFRs reference ADRs and constraints where applicable\n* NFRs testable during TS-1, TS-2, TS-3 phases\n\n**Acceptance**: Senior Engineer can use NFR section to design load tests, resilience tests, security tests\n\n### Checkpoint 4: Monitoring and Observability (After Creation)\n\n**Validate**:\n\n* Key Metrics table comprehensive (OAuth linking, transaction adjudication, balance query, batch processing, Event Bus, external APIs, business metrics)\n* Alerting Thresholds table defines P1/P2/P3 severity\n* Dashboards defined for each service, Event Bus, external APIs, business metrics\n* Correlation ID Propagation referenced for distributed tracing\n\n**Acceptance**: Platform SRE can configure monitoring dashboards and alerting based on this section\n\n### Checkpoint 5: Solution Validation (After Creation)\n\n**Validate**:\n\n* Functional validation scenarios comprehensive (OAuth linking, transaction adjudication, balance query, batch processing)\n* Non-functional validation defines load testing (3x, 10x, stress test), resilience testing, security testing\n* Integration testing scenarios validate end-to-end flows\n* Acceptance criteria summary consolidates all success criteria\n* Validation schedule aligns with Transition Architecture phases (TS-1, TS-2, TS-3)\n\n**Acceptance**: QA Lead can design test plans based on this section\n\n### Checkpoint 6: Work Package Sequencing (After Enhancement)\n\n**Validate**:\n\n* Parallel Track 1 (Infrastructure) and Track 2 (Development) clearly defined\n* Sequential Track 3 (Integration & Testing) dependencies explicit\n* Sequential Track 4 (Migration & Cutover) dependencies explicit\n* Critical path identified (44 weeks total duration)\n* Gantt chart or timeline diagram recommended\n\n**Acceptance**: Programme Lead can use Work Package Sequencing to plan resource allocation and timeline\n\n## Execution Approach\n\n### Phase 1: Structure and Mapping (2-3 hours)\n\n1. Create document outline with new section headings\n2. Map existing content to new sections (identify what moves, what converts, what creates)\n3. Validate outline against Salesforce structure (ensure TOGAF alignment)\n\n### Phase 2: Content Movement (3-4 hours)\n\n1. Move Gap Analysis from line 3242 to Technical Architecture\n2. Move Implementation Constraints to Assumptions and Constraints\n3. Move Success Criteria to Executive Summary\n4. Extract TS-0 baseline to Baseline Architecture\n5. Extract domain event schemas to Data Architecture\n\n### Phase 3: Content Conversion (6-8 hours)\n\n1. Convert Key Technology Decisions table to formal ADRs (10+ ADRs)\n2. Enhance Executive Summary with Challenge/Solution/Significance structure\n3. Create Baseline Architecture - Existing System Components (expand from TS-0)\n\n### Phase 4: Content Creation (8-10 hours)\n\n1. Copy Vision, Architectural Approach, Architecture Overview from Architecture Definition\n2. Copy Technical Requirements from Architecture Definition\n3. Create Assumptions and Constraints section (10+ assumptions, consolidate constraints)\n4. Create Non-Functional Requirements section (8 subsections, 40+ NFRs)\n5. Create Monitoring and Observability section (metrics, alerting, dashboards)\n6. Create Solution Validation section (functional, non-functional, integration testing)\n7. Create Work Package Sequencing subsection (parallel/sequential tracks, critical path)\n\n### Phase 5: Validation and Polish (2-3 hours)\n\n1. Validate against 6 checkpoints (Executive Summary, Technical Architecture, NFRs, Monitoring, Solution Validation, Work Packages)\n2. Cross-reference ADRs, constraints, NFRs throughout document\n3. Ensure Antora xrefs to Architecture Definition work correctly\n4. Generate diagrams (Baseline Architecture integration diagram, Work Package Gantt chart)\n5. Final review against Salesforce structure\n\n**Total Estimated Effort**: 21-28 hours\n\n## Recommended Next Steps\n\n1. **Review this plan with Domain Architect** - validate approach, section mappings, ADR conversion strategy\n2. **Approve NFR targets** - validate NFR targets with technical team (performance baselines, availability targets)\n3. **Begin Phase 1** - create document outline, map existing content\n4. **Incremental validation** - validate each phase completion against checkpoints before proceeding\n5. **Stakeholder review** - share restructured Executive Summary with business stakeholders for feedback before proceeding to detailed sections\n\n## Appendix: Section Line Count Estimates\n\n| Section | Current Lines | Target Lines | Change |\n|---------|--------------|--------------|--------|\n| Purpose and Scope | 50 | 200 | +150 (add Vision, Architectural Approach, Architecture Overview) |\n| Solution Approach | 40 | 50 | +10 (minor expansion) |\n| Executive Summary | 10 | 250 | +240 (comprehensive restructuring) |\n| Technical Requirements | 0 | 150 | +150 (new section, copy from Arch Def) |\n| Technical Architecture | 600 | 1200 | +600 (add Baseline, ADRs, reorganize) |\n| Solution Building Blocks | 1300 | 1300 | 0 (keep as-is) |\n| Data Architecture | 200 | 400 | +200 (add event schemas, validation) |\n| Interface Specifications | 1500 | 1000 | -500 (extract event schemas to Data Architecture, reorganize) |\n| Work Packages | 900 | 1000 | +100 (add sequencing) |\n| Transition Architecture | 650 | 650 | 0 (keep as-is) |\n| Assumptions and Constraints | 0 | 100 | +100 (new section) |\n| Non-Functional Requirements | 0 | 400 | +400 (new section) |\n| Monitoring and Observability | 0 | 250 | +250 (new section) |\n| Solution Validation | 0 | 300 | +300 (new section) |\n| **TOTAL** | **5250** | **6250** | **+1000 lines** |\n\n**Final Document Size**: 6000-6500 lines (acceptable for comprehensive TOGAF Phase E solution architecture)\n","structuredPatch":[],"originalFile":null},"sourceToolAssistantUUID":"ba62851b-aeab-4180-ad45-a8527167cdb7"}
{"parentUuid":"349636e7-cd42-46b5-9ef0-d63d05e8f6bd","isSidechain":true,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","agentId":"a7dc162","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01PDqM3ZPdru8MTvQJVTcrtD","type":"message","role":"assistant","content":[{"type":"text","text":"Perfect. Now let me create a summary document for quick reference."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":4,"cache_creation_input_tokens":70317,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":70317,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWwE2L3ckT73b1taxfBCL","type":"assistant","uuid":"3b562eaa-df35-4145-8d65-8b2bca404226","timestamp":"2026-01-09T05:08:13.032Z"}
{"parentUuid":"3b562eaa-df35-4145-8d65-8b2bca404226","isSidechain":true,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","agentId":"a7dc162","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01PDqM3ZPdru8MTvQJVTcrtD","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01YRUtAtgnbrGnrNGzegs3yt","name":"Write","input":{"file_path":"/mnt/c/Users/o.young/work/architecture/notes/flybuys_restructuring_summary.md","content":"# Flybuys Integration Solution Architecture Restructuring - Executive Summary\n\n## Goal\n\nRestructure Flybuys Integration Solution Architecture (5276 lines) to match the comprehensive TOGAF-aligned structure of Salesforce Customer Support Solution Architecture (3328 lines), while preserving Flybuys' technical strengths.\n\n## Key Problems Identified\n\n1. **Executive Summary**: Brief, early placement (line 64), lacks Challenge/Solution/Significance structure\n2. **Missing Sections**: No Vision, Architectural Approach, Baseline Architecture, Assumptions/Constraints, NFRs, Monitoring/Observability, Solution Validation\n3. **Informal Technology Decisions**: Table format instead of formal ADRs with Status/Context/Rationale/Consequences\n4. **Gap Analysis Placement**: After Interface Specifications (line 3242) instead of in Technical Architecture\n5. **Scattered Content**: Baseline in TS-0, constraints in multiple locations, NFRs implicit\n\n## Strengths to Preserve\n\n1. **Detailed Physical Data Models**: JSON schemas for PartnerLink, RewardTransaction, OAuth tokens\n2. **Complete API Documentation**: REST APIs, AsyncAPI events, versioning policy\n3. **Correlation ID Propagation**: Comprehensive distributed tracing specification\n4. **Comprehensive Interaction Flows**: OAuth linking, JIT profile creation, POS integration, batch processing\n5. **Detailed Transition Architecture**: Feature flag matrix, rollback strategies, TS-0 → TS-4 phases\n\n## Target Structure (14 Sections)\n\n```\n1. Purpose and Scope (+150 lines)\n   - Copy Vision, Architectural Approach, Architecture Overview from Arch Def\n\n2. Solution Approach (+10 lines)\n   - Minor expansion\n\n3. Executive Summary (+240 lines) ← MAJOR RESTRUCTURING\n   - Challenge (new)\n   - Solution with 3 subsections (new)\n   - Key Architectural Significance (new)\n   - Success Criteria (existing)\n   - Technical Constraints (relocated)\n   - Open Technical Decisions (new)\n\n4. Technical Requirements (+150 lines) ← NEW SECTION\n   - Copy from Architecture Definition\n\n5. Technical Architecture (+600 lines) ← MAJOR REORGANIZATION\n   - Baseline Architecture (extracted from TS-0)\n   - Gap Analysis (relocated from line 3242)\n   - Target State Architecture (existing)\n   - Architecture Decisions (converted from Key Tech Decisions)\n\n6. Solution Building Blocks (0 change)\n   - Keep detailed SBB specifications\n\n7. Data Architecture (+200 lines)\n   - Physical Data Models (existing)\n   - Domain Event Schemas (extracted from Interface Specs)\n   - Data Quality & Validation (new)\n\n8. Interface Specifications (-500 lines)\n   - Reorganized subsections\n   - Move event schemas to Data Architecture\n\n9. Work Packages (+100 lines)\n   - Add Work Package Sequencing subsection\n\n10. Transition Architecture (0 change)\n    - Keep detailed TS-0 → TS-4 phases\n\n11. Assumptions and Constraints (+100 lines) ← NEW SECTION\n    - 10+ assumptions\n    - Consolidated constraints\n\n12. Non-Functional Requirements (+400 lines) ← NEW SECTION\n    - 8 subsections: Performance, Availability, Scalability, Security, Reliability, Maintainability, Usability, Compliance\n    - 40+ NFRs with measurable targets\n\n13. Monitoring and Observability (+250 lines) ← NEW SECTION\n    - Key Metrics\n    - Alerting Thresholds\n    - Dashboards\n\n14. Solution Validation (+300 lines) ← NEW SECTION\n    - Functional Validation\n    - Non-Functional Validation\n    - Acceptance Criteria\n```\n\n**Final Document Size**: 6000-6500 lines (+1000 lines from current)\n\n## Major Transformations\n\n### 1. Key Technology Decisions → Architecture Decisions (ADRs)\n\n**From**: Simple table with ID/Kind/Description/Rationale\n\n**To**: Formal ADRs with Status/Context/Decision/Rationale/Consequences/Implementation Notes\n\n**Example ADRs to Create**:\n\n- ADR-FB-001: .NET 8.0 Implementation Stack\n- ADR-FB-002: OAuth 2.0 + PKCE for Partner Linking\n- ADR-FB-003: NoSQL Database for Profile and Loyalty Services\n- ADR-FB-004: Event-Driven Integration via Event Bus\n- ADR-FB-005: Phased Rollout with Feature Flags (not big-bang)\n- ADR-FB-006: AES-256 Encryption for OAuth Tokens\n- ADR-FB-007: Nightly Batch SFTP for Flybuys Transaction Posting\n- ADR-FB-008: Circuit Breaker Pattern for External API Resilience\n- ADR-FB-009: Correlation ID Propagation for Distributed Tracing\n- ADR-FB-010: Conformist Pattern for Flybuys API Integration\n\n**TBD Decisions**: Mark as \"Under Evaluation\" with technology options (Hosting, NoSQL DB, Event Bus, Secrets Manager, etc.)\n\n### 2. Executive Summary Enhancement\n\n**From**: 10-line brief summary\n\n**To**: 250-line comprehensive summary with:\n\n- **Challenge**: Fragmented loyalty, manual batch processing, no coalition partner linking, high operational overhead\n- **Solution**: Three bounded contexts (Profile, Loyalty, Engagement), OAuth 2.0 + PKCE, event-driven architecture, phased migration\n- **Key Architectural Significance**: First DDD bounded contexts, event-driven foundation, partner flexibility, platform consolidation\n- **Success Criteria**: Measurable targets (>95% OAuth linking, <500ms adjudication, >98% batch acknowledgement)\n- **Technical Constraints**: Flybuys conformance, AES-256 encryption, Australia East data residency, phased rollout\n- **Open Technical Decisions**: TBD technology choices with evaluation status\n\n### 3. Baseline Architecture Extraction\n\n**From**: TS-0 Current State buried in Transition Architecture section (lines 4421-4438)\n\n**To**: Comprehensive Baseline Architecture section in Technical Architecture with:\n\n- Current Business Capability (from Arch Def)\n- Current Value Stream (from Arch Def)\n- Existing System Components (expanded from TS-0)\n  - OTR App API (platform, capabilities, limitations)\n  - Reddy Express Legacy Loyalty (platform, capabilities, limitations)\n  - Salesforce CRM, EagleEye, Coupon Scanner\n- Integration Architecture (new diagram)\n- Pain Points (from Arch Def)\n- Technical Debt (from TS-0)\n\n## Content Movement Map\n\n| Content | From | To | Action |\n|---------|------|-----|--------|\n| Gap Analysis | Line 3242 (after Interface Specs) | Technical Architecture | Move |\n| Implementation Constraints | Line 212 | Assumptions and Constraints | Move |\n| Success Criteria | Line 220 | Executive Summary | Move |\n| TS-0 Baseline | Line 4421 (Transition Architecture) | Baseline Architecture | Extract |\n| Domain Event Schemas | Interface Specifications | Data Architecture | Extract |\n| Key Technology Decisions | Line 110 | Architecture Decisions (ADRs) | Convert |\n| Vision, Architectural Approach | Architecture Definition | Purpose and Scope | Copy |\n| Technical Requirements | Architecture Definition | Technical Requirements | Copy |\n\n## Content Creation Checklist\n\n- [ ] Vision (copy from Architecture Definition)\n- [ ] Architectural Approach (copy from Architecture Definition)\n- [ ] Architecture Overview diagram (copy from Architecture Definition)\n- [ ] Executive Summary - Challenge subsection (synthesize from pain points)\n- [ ] Executive Summary - Key Architectural Significance (new analysis)\n- [ ] Executive Summary - Open Technical Decisions (extract from #TBD# decisions)\n- [ ] Technical Requirements (copy from Architecture Definition)\n- [ ] Baseline Architecture - Existing System Components (expand from TS-0)\n- [ ] Baseline Architecture - Integration Architecture diagram (create)\n- [ ] Architecture Decisions - 10+ formal ADRs (convert from Key Tech Decisions)\n- [ ] Data Architecture - Data Quality & Validation (new subsection)\n- [ ] Work Package Sequencing (parallel/sequential tracks, critical path)\n- [ ] Assumptions and Constraints (10+ assumptions, consolidated constraints)\n- [ ] Non-Functional Requirements (8 subsections, 40+ NFRs)\n- [ ] Monitoring and Observability (metrics, alerting, dashboards)\n- [ ] Solution Validation (functional, non-functional, integration testing)\n\n## Validation Checkpoints\n\n### Checkpoint 1: Executive Summary\n\n**Test**: Can an executive read Executive Summary and understand business problem, solution, strategic value without reading rest of document?\n\n**Validate**:\n- [ ] Challenge section clearly articulates pain points\n- [ ] Solution section describes bounded contexts, integration patterns, migration approach\n- [ ] Key Architectural Significance highlights strategic impact\n- [ ] Success Criteria measurable and testable\n- [ ] Technical Constraints comprehensive\n\n### Checkpoint 2: Technical Architecture\n\n**Test**: Can a Domain Architect understand baseline, gaps, target state, and architectural decisions with rationale?\n\n**Validate**:\n- [ ] Baseline Architecture comprehensive (existing systems, integration, value stream, pain points, technical debt)\n- [ ] Gap Analysis follows Baseline (logical flow: current → gaps → target)\n- [ ] Target State Architecture references Gap Analysis\n- [ ] ADRs formal with Status/Context/Decision/Rationale/Consequences (10+ ADRs)\n- [ ] ADRs reference constraints, NFRs, other sections\n\n### Checkpoint 3: Non-Functional Requirements\n\n**Test**: Can a Senior Engineer design load tests, resilience tests, security tests from NFR section?\n\n**Validate**:\n- [ ] 8 subsections (Performance, Availability, Scalability, Security, Reliability, Maintainability, Usability, Compliance)\n- [ ] 40+ NFRs with measurable targets\n- [ ] NFRs reference ADRs and constraints\n- [ ] NFRs testable during TS-1, TS-2, TS-3 phases\n\n### Checkpoint 4: Monitoring and Observability\n\n**Test**: Can a Platform SRE configure monitoring dashboards and alerting from this section?\n\n**Validate**:\n- [ ] Key Metrics table comprehensive (all services, Event Bus, external APIs, business metrics)\n- [ ] Alerting Thresholds table defines P1/P2/P3 severity\n- [ ] Dashboards defined for each service, Event Bus, external APIs, business metrics\n- [ ] Correlation ID Propagation referenced for distributed tracing\n\n### Checkpoint 5: Solution Validation\n\n**Test**: Can a QA Lead design test plans from this section?\n\n**Validate**:\n- [ ] Functional validation scenarios comprehensive (OAuth, adjudication, balance query, batch)\n- [ ] Non-functional validation defines load testing (3x, 10x, stress), resilience, security\n- [ ] Integration testing scenarios validate end-to-end flows\n- [ ] Acceptance criteria summary consolidates all success criteria\n- [ ] Validation schedule aligns with Transition Architecture phases\n\n### Checkpoint 6: Work Package Sequencing\n\n**Test**: Can a Programme Lead plan resource allocation and timeline from this section?\n\n**Validate**:\n- [ ] Parallel Track 1 (Infrastructure) and Track 2 (Development) clearly defined\n- [ ] Sequential Track 3 (Integration & Testing) dependencies explicit\n- [ ] Sequential Track 4 (Migration & Cutover) dependencies explicit\n- [ ] Critical path identified (44 weeks total duration)\n- [ ] Gantt chart or timeline diagram provided\n\n## Execution Plan\n\n### Phase 1: Structure and Mapping (2-3 hours)\n- Create document outline with new section headings\n- Map existing content to new sections\n- Validate outline against Salesforce structure\n\n### Phase 2: Content Movement (3-4 hours)\n- Move Gap Analysis to Technical Architecture\n- Move Implementation Constraints to Assumptions and Constraints\n- Move Success Criteria to Executive Summary\n- Extract TS-0 baseline to Baseline Architecture\n- Extract domain event schemas to Data Architecture\n\n### Phase 3: Content Conversion (6-8 hours)\n- Convert Key Technology Decisions to formal ADRs (10+ ADRs)\n- Enhance Executive Summary with Challenge/Solution/Significance structure\n- Create Baseline Architecture - Existing System Components\n\n### Phase 4: Content Creation (8-10 hours)\n- Copy Vision, Architectural Approach, Architecture Overview from Architecture Definition\n- Copy Technical Requirements from Architecture Definition\n- Create Assumptions and Constraints section\n- Create Non-Functional Requirements section\n- Create Monitoring and Observability section\n- Create Solution Validation section\n- Create Work Package Sequencing subsection\n\n### Phase 5: Validation and Polish (2-3 hours)\n- Validate against 6 checkpoints\n- Cross-reference ADRs, constraints, NFRs throughout document\n- Ensure Antora xrefs work correctly\n- Generate diagrams (Baseline integration diagram, Work Package Gantt)\n- Final review against Salesforce structure\n\n**Total Estimated Effort**: 21-28 hours\n\n## Risks and Mitigation\n\n| Risk | Mitigation |\n|------|-----------|\n| Content duplication between Architecture Definition and Solution Architecture | Architecture Definition remains source of truth for domain model; Solution Architecture focuses on implementation; cross-reference using Antora xrefs |\n| Loss of technical detail during restructuring | Preserve all existing technical content (Data Architecture, Interface Specifications); only reorganize subsections, don't delete |\n| ADR conversion time burden | Prioritize critical architectural decisions first; TBD decisions can have placeholder ADRs; use template for consistency |\n| NFR creation without baseline metrics | Extract NFR targets from existing Success Criteria, sequence diagrams, architecture decisions; mark as \"TBD\" where unknown; validate during TS-1 Foundation |\n| Document length increase | Target 5500-6000 lines (acceptable for comprehensive solution architecture); use tables for conciseness; reference detailed specs in separate documents |\n\n## Success Criteria\n\n- [ ] Document structure matches Salesforce pattern (14 sections)\n- [ ] Executive Summary passes Checkpoint 1 (executive-readable)\n- [ ] Technical Architecture passes Checkpoint 2 (Domain Architect-readable)\n- [ ] Non-Functional Requirements passes Checkpoint 3 (Senior Engineer-readable)\n- [ ] Monitoring and Observability passes Checkpoint 4 (Platform SRE-readable)\n- [ ] Solution Validation passes Checkpoint 5 (QA Lead-readable)\n- [ ] Work Package Sequencing passes Checkpoint 6 (Programme Lead-readable)\n- [ ] All technical strengths preserved (physical data models, API docs, correlation ID spec, interaction flows, transition architecture)\n- [ ] All Antora xrefs to Architecture Definition validated\n- [ ] Document length 5500-6500 lines (target range)\n- [ ] Formal ADRs created for all critical architectural decisions (10+ ADRs)\n\n## Next Steps\n\n1. **Review plan with Domain Architect** - validate approach, section mappings, ADR conversion strategy\n2. **Approve NFR targets** - validate NFR targets with technical team\n3. **Begin Phase 1** - create document outline, map existing content\n4. **Incremental validation** - validate each phase completion against checkpoints\n5. **Stakeholder review** - share restructured Executive Summary with business stakeholders before proceeding\n"}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":4,"cache_creation_input_tokens":70317,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":70317,"ephemeral_1h_input_tokens":0},"output_tokens":3798,"service_tier":"standard"}},"requestId":"req_011CWwE2L3ckT73b1taxfBCL","type":"assistant","uuid":"432a31d7-bc2a-490e-8676-5e71885eb88b","timestamp":"2026-01-09T05:09:26.431Z"}
{"parentUuid":"432a31d7-bc2a-490e-8676-5e71885eb88b","isSidechain":true,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","agentId":"a7dc162","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01YRUtAtgnbrGnrNGzegs3yt","type":"tool_result","content":"File created successfully at: /mnt/c/Users/o.young/work/architecture/notes/flybuys_restructuring_summary.md"}]},"uuid":"8b63cce1-72c4-40f7-9bd2-87a036f1db00","timestamp":"2026-01-09T05:09:26.676Z","toolUseResult":{"type":"create","filePath":"/mnt/c/Users/o.young/work/architecture/notes/flybuys_restructuring_summary.md","content":"# Flybuys Integration Solution Architecture Restructuring - Executive Summary\n\n## Goal\n\nRestructure Flybuys Integration Solution Architecture (5276 lines) to match the comprehensive TOGAF-aligned structure of Salesforce Customer Support Solution Architecture (3328 lines), while preserving Flybuys' technical strengths.\n\n## Key Problems Identified\n\n1. **Executive Summary**: Brief, early placement (line 64), lacks Challenge/Solution/Significance structure\n2. **Missing Sections**: No Vision, Architectural Approach, Baseline Architecture, Assumptions/Constraints, NFRs, Monitoring/Observability, Solution Validation\n3. **Informal Technology Decisions**: Table format instead of formal ADRs with Status/Context/Rationale/Consequences\n4. **Gap Analysis Placement**: After Interface Specifications (line 3242) instead of in Technical Architecture\n5. **Scattered Content**: Baseline in TS-0, constraints in multiple locations, NFRs implicit\n\n## Strengths to Preserve\n\n1. **Detailed Physical Data Models**: JSON schemas for PartnerLink, RewardTransaction, OAuth tokens\n2. **Complete API Documentation**: REST APIs, AsyncAPI events, versioning policy\n3. **Correlation ID Propagation**: Comprehensive distributed tracing specification\n4. **Comprehensive Interaction Flows**: OAuth linking, JIT profile creation, POS integration, batch processing\n5. **Detailed Transition Architecture**: Feature flag matrix, rollback strategies, TS-0 → TS-4 phases\n\n## Target Structure (14 Sections)\n\n```\n1. Purpose and Scope (+150 lines)\n   - Copy Vision, Architectural Approach, Architecture Overview from Arch Def\n\n2. Solution Approach (+10 lines)\n   - Minor expansion\n\n3. Executive Summary (+240 lines) ← MAJOR RESTRUCTURING\n   - Challenge (new)\n   - Solution with 3 subsections (new)\n   - Key Architectural Significance (new)\n   - Success Criteria (existing)\n   - Technical Constraints (relocated)\n   - Open Technical Decisions (new)\n\n4. Technical Requirements (+150 lines) ← NEW SECTION\n   - Copy from Architecture Definition\n\n5. Technical Architecture (+600 lines) ← MAJOR REORGANIZATION\n   - Baseline Architecture (extracted from TS-0)\n   - Gap Analysis (relocated from line 3242)\n   - Target State Architecture (existing)\n   - Architecture Decisions (converted from Key Tech Decisions)\n\n6. Solution Building Blocks (0 change)\n   - Keep detailed SBB specifications\n\n7. Data Architecture (+200 lines)\n   - Physical Data Models (existing)\n   - Domain Event Schemas (extracted from Interface Specs)\n   - Data Quality & Validation (new)\n\n8. Interface Specifications (-500 lines)\n   - Reorganized subsections\n   - Move event schemas to Data Architecture\n\n9. Work Packages (+100 lines)\n   - Add Work Package Sequencing subsection\n\n10. Transition Architecture (0 change)\n    - Keep detailed TS-0 → TS-4 phases\n\n11. Assumptions and Constraints (+100 lines) ← NEW SECTION\n    - 10+ assumptions\n    - Consolidated constraints\n\n12. Non-Functional Requirements (+400 lines) ← NEW SECTION\n    - 8 subsections: Performance, Availability, Scalability, Security, Reliability, Maintainability, Usability, Compliance\n    - 40+ NFRs with measurable targets\n\n13. Monitoring and Observability (+250 lines) ← NEW SECTION\n    - Key Metrics\n    - Alerting Thresholds\n    - Dashboards\n\n14. Solution Validation (+300 lines) ← NEW SECTION\n    - Functional Validation\n    - Non-Functional Validation\n    - Acceptance Criteria\n```\n\n**Final Document Size**: 6000-6500 lines (+1000 lines from current)\n\n## Major Transformations\n\n### 1. Key Technology Decisions → Architecture Decisions (ADRs)\n\n**From**: Simple table with ID/Kind/Description/Rationale\n\n**To**: Formal ADRs with Status/Context/Decision/Rationale/Consequences/Implementation Notes\n\n**Example ADRs to Create**:\n\n- ADR-FB-001: .NET 8.0 Implementation Stack\n- ADR-FB-002: OAuth 2.0 + PKCE for Partner Linking\n- ADR-FB-003: NoSQL Database for Profile and Loyalty Services\n- ADR-FB-004: Event-Driven Integration via Event Bus\n- ADR-FB-005: Phased Rollout with Feature Flags (not big-bang)\n- ADR-FB-006: AES-256 Encryption for OAuth Tokens\n- ADR-FB-007: Nightly Batch SFTP for Flybuys Transaction Posting\n- ADR-FB-008: Circuit Breaker Pattern for External API Resilience\n- ADR-FB-009: Correlation ID Propagation for Distributed Tracing\n- ADR-FB-010: Conformist Pattern for Flybuys API Integration\n\n**TBD Decisions**: Mark as \"Under Evaluation\" with technology options (Hosting, NoSQL DB, Event Bus, Secrets Manager, etc.)\n\n### 2. Executive Summary Enhancement\n\n**From**: 10-line brief summary\n\n**To**: 250-line comprehensive summary with:\n\n- **Challenge**: Fragmented loyalty, manual batch processing, no coalition partner linking, high operational overhead\n- **Solution**: Three bounded contexts (Profile, Loyalty, Engagement), OAuth 2.0 + PKCE, event-driven architecture, phased migration\n- **Key Architectural Significance**: First DDD bounded contexts, event-driven foundation, partner flexibility, platform consolidation\n- **Success Criteria**: Measurable targets (>95% OAuth linking, <500ms adjudication, >98% batch acknowledgement)\n- **Technical Constraints**: Flybuys conformance, AES-256 encryption, Australia East data residency, phased rollout\n- **Open Technical Decisions**: TBD technology choices with evaluation status\n\n### 3. Baseline Architecture Extraction\n\n**From**: TS-0 Current State buried in Transition Architecture section (lines 4421-4438)\n\n**To**: Comprehensive Baseline Architecture section in Technical Architecture with:\n\n- Current Business Capability (from Arch Def)\n- Current Value Stream (from Arch Def)\n- Existing System Components (expanded from TS-0)\n  - OTR App API (platform, capabilities, limitations)\n  - Reddy Express Legacy Loyalty (platform, capabilities, limitations)\n  - Salesforce CRM, EagleEye, Coupon Scanner\n- Integration Architecture (new diagram)\n- Pain Points (from Arch Def)\n- Technical Debt (from TS-0)\n\n## Content Movement Map\n\n| Content | From | To | Action |\n|---------|------|-----|--------|\n| Gap Analysis | Line 3242 (after Interface Specs) | Technical Architecture | Move |\n| Implementation Constraints | Line 212 | Assumptions and Constraints | Move |\n| Success Criteria | Line 220 | Executive Summary | Move |\n| TS-0 Baseline | Line 4421 (Transition Architecture) | Baseline Architecture | Extract |\n| Domain Event Schemas | Interface Specifications | Data Architecture | Extract |\n| Key Technology Decisions | Line 110 | Architecture Decisions (ADRs) | Convert |\n| Vision, Architectural Approach | Architecture Definition | Purpose and Scope | Copy |\n| Technical Requirements | Architecture Definition | Technical Requirements | Copy |\n\n## Content Creation Checklist\n\n- [ ] Vision (copy from Architecture Definition)\n- [ ] Architectural Approach (copy from Architecture Definition)\n- [ ] Architecture Overview diagram (copy from Architecture Definition)\n- [ ] Executive Summary - Challenge subsection (synthesize from pain points)\n- [ ] Executive Summary - Key Architectural Significance (new analysis)\n- [ ] Executive Summary - Open Technical Decisions (extract from #TBD# decisions)\n- [ ] Technical Requirements (copy from Architecture Definition)\n- [ ] Baseline Architecture - Existing System Components (expand from TS-0)\n- [ ] Baseline Architecture - Integration Architecture diagram (create)\n- [ ] Architecture Decisions - 10+ formal ADRs (convert from Key Tech Decisions)\n- [ ] Data Architecture - Data Quality & Validation (new subsection)\n- [ ] Work Package Sequencing (parallel/sequential tracks, critical path)\n- [ ] Assumptions and Constraints (10+ assumptions, consolidated constraints)\n- [ ] Non-Functional Requirements (8 subsections, 40+ NFRs)\n- [ ] Monitoring and Observability (metrics, alerting, dashboards)\n- [ ] Solution Validation (functional, non-functional, integration testing)\n\n## Validation Checkpoints\n\n### Checkpoint 1: Executive Summary\n\n**Test**: Can an executive read Executive Summary and understand business problem, solution, strategic value without reading rest of document?\n\n**Validate**:\n- [ ] Challenge section clearly articulates pain points\n- [ ] Solution section describes bounded contexts, integration patterns, migration approach\n- [ ] Key Architectural Significance highlights strategic impact\n- [ ] Success Criteria measurable and testable\n- [ ] Technical Constraints comprehensive\n\n### Checkpoint 2: Technical Architecture\n\n**Test**: Can a Domain Architect understand baseline, gaps, target state, and architectural decisions with rationale?\n\n**Validate**:\n- [ ] Baseline Architecture comprehensive (existing systems, integration, value stream, pain points, technical debt)\n- [ ] Gap Analysis follows Baseline (logical flow: current → gaps → target)\n- [ ] Target State Architecture references Gap Analysis\n- [ ] ADRs formal with Status/Context/Decision/Rationale/Consequences (10+ ADRs)\n- [ ] ADRs reference constraints, NFRs, other sections\n\n### Checkpoint 3: Non-Functional Requirements\n\n**Test**: Can a Senior Engineer design load tests, resilience tests, security tests from NFR section?\n\n**Validate**:\n- [ ] 8 subsections (Performance, Availability, Scalability, Security, Reliability, Maintainability, Usability, Compliance)\n- [ ] 40+ NFRs with measurable targets\n- [ ] NFRs reference ADRs and constraints\n- [ ] NFRs testable during TS-1, TS-2, TS-3 phases\n\n### Checkpoint 4: Monitoring and Observability\n\n**Test**: Can a Platform SRE configure monitoring dashboards and alerting from this section?\n\n**Validate**:\n- [ ] Key Metrics table comprehensive (all services, Event Bus, external APIs, business metrics)\n- [ ] Alerting Thresholds table defines P1/P2/P3 severity\n- [ ] Dashboards defined for each service, Event Bus, external APIs, business metrics\n- [ ] Correlation ID Propagation referenced for distributed tracing\n\n### Checkpoint 5: Solution Validation\n\n**Test**: Can a QA Lead design test plans from this section?\n\n**Validate**:\n- [ ] Functional validation scenarios comprehensive (OAuth, adjudication, balance query, batch)\n- [ ] Non-functional validation defines load testing (3x, 10x, stress), resilience, security\n- [ ] Integration testing scenarios validate end-to-end flows\n- [ ] Acceptance criteria summary consolidates all success criteria\n- [ ] Validation schedule aligns with Transition Architecture phases\n\n### Checkpoint 6: Work Package Sequencing\n\n**Test**: Can a Programme Lead plan resource allocation and timeline from this section?\n\n**Validate**:\n- [ ] Parallel Track 1 (Infrastructure) and Track 2 (Development) clearly defined\n- [ ] Sequential Track 3 (Integration & Testing) dependencies explicit\n- [ ] Sequential Track 4 (Migration & Cutover) dependencies explicit\n- [ ] Critical path identified (44 weeks total duration)\n- [ ] Gantt chart or timeline diagram provided\n\n## Execution Plan\n\n### Phase 1: Structure and Mapping (2-3 hours)\n- Create document outline with new section headings\n- Map existing content to new sections\n- Validate outline against Salesforce structure\n\n### Phase 2: Content Movement (3-4 hours)\n- Move Gap Analysis to Technical Architecture\n- Move Implementation Constraints to Assumptions and Constraints\n- Move Success Criteria to Executive Summary\n- Extract TS-0 baseline to Baseline Architecture\n- Extract domain event schemas to Data Architecture\n\n### Phase 3: Content Conversion (6-8 hours)\n- Convert Key Technology Decisions to formal ADRs (10+ ADRs)\n- Enhance Executive Summary with Challenge/Solution/Significance structure\n- Create Baseline Architecture - Existing System Components\n\n### Phase 4: Content Creation (8-10 hours)\n- Copy Vision, Architectural Approach, Architecture Overview from Architecture Definition\n- Copy Technical Requirements from Architecture Definition\n- Create Assumptions and Constraints section\n- Create Non-Functional Requirements section\n- Create Monitoring and Observability section\n- Create Solution Validation section\n- Create Work Package Sequencing subsection\n\n### Phase 5: Validation and Polish (2-3 hours)\n- Validate against 6 checkpoints\n- Cross-reference ADRs, constraints, NFRs throughout document\n- Ensure Antora xrefs work correctly\n- Generate diagrams (Baseline integration diagram, Work Package Gantt)\n- Final review against Salesforce structure\n\n**Total Estimated Effort**: 21-28 hours\n\n## Risks and Mitigation\n\n| Risk | Mitigation |\n|------|-----------|\n| Content duplication between Architecture Definition and Solution Architecture | Architecture Definition remains source of truth for domain model; Solution Architecture focuses on implementation; cross-reference using Antora xrefs |\n| Loss of technical detail during restructuring | Preserve all existing technical content (Data Architecture, Interface Specifications); only reorganize subsections, don't delete |\n| ADR conversion time burden | Prioritize critical architectural decisions first; TBD decisions can have placeholder ADRs; use template for consistency |\n| NFR creation without baseline metrics | Extract NFR targets from existing Success Criteria, sequence diagrams, architecture decisions; mark as \"TBD\" where unknown; validate during TS-1 Foundation |\n| Document length increase | Target 5500-6000 lines (acceptable for comprehensive solution architecture); use tables for conciseness; reference detailed specs in separate documents |\n\n## Success Criteria\n\n- [ ] Document structure matches Salesforce pattern (14 sections)\n- [ ] Executive Summary passes Checkpoint 1 (executive-readable)\n- [ ] Technical Architecture passes Checkpoint 2 (Domain Architect-readable)\n- [ ] Non-Functional Requirements passes Checkpoint 3 (Senior Engineer-readable)\n- [ ] Monitoring and Observability passes Checkpoint 4 (Platform SRE-readable)\n- [ ] Solution Validation passes Checkpoint 5 (QA Lead-readable)\n- [ ] Work Package Sequencing passes Checkpoint 6 (Programme Lead-readable)\n- [ ] All technical strengths preserved (physical data models, API docs, correlation ID spec, interaction flows, transition architecture)\n- [ ] All Antora xrefs to Architecture Definition validated\n- [ ] Document length 5500-6500 lines (target range)\n- [ ] Formal ADRs created for all critical architectural decisions (10+ ADRs)\n\n## Next Steps\n\n1. **Review plan with Domain Architect** - validate approach, section mappings, ADR conversion strategy\n2. **Approve NFR targets** - validate NFR targets with technical team\n3. **Begin Phase 1** - create document outline, map existing content\n4. **Incremental validation** - validate each phase completion against checkpoints\n5. **Stakeholder review** - share restructured Executive Summary with business stakeholders before proceeding\n","structuredPatch":[],"originalFile":null},"sourceToolAssistantUUID":"432a31d7-bc2a-490e-8676-5e71885eb88b"}
{"parentUuid":"8b63cce1-72c4-40f7-9bd2-87a036f1db00","isSidechain":true,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","agentId":"a7dc162","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01MFzR6HcaTBrpEs5FsVtLUW","type":"message","role":"assistant","content":[{"type":"text","text":"## Summary\n\nI've created a comprehensive restructuring plan for the Flybuys Integration Solution Architecture document. Here's what I've delivered:\n\n### 1. Detailed Restructuring Plan (`notes/flybuys_restructuring_plan.md`)\n\n**Comprehensive 21-28 hour execution plan** covering:\n\n- **Current Issues Identified**: 10 structural gaps (missing Vision, Baseline Architecture, NFRs, Monitoring, etc.)\n- **Strengths to Preserve**: Physical data models, API documentation, correlation ID propagation, transition architecture\n- **Target Structure**: 14 sections following Salesforce TOGAF-aligned pattern\n- **Detailed Section Mappings**: Move/convert/create actions for each section\n- **ADR Conversion Strategy**: 10+ formal Architecture Decision Records with Status/Context/Rationale/Consequences\n- **Content Examples**: Complete examples for Executive Summary, Baseline Architecture, ADRs, NFRs, Monitoring, Solution Validation\n- **Validation Checkpoints**: 6 checkpoints to ensure quality (Executive, Technical Architecture, NFRs, Monitoring, Validation, Work Packages)\n- **Execution Approach**: 5 phases from structure mapping to validation and polish\n- **Risk Mitigation**: 5 risks identified with mitigation strategies\n\n### 2. Executive Summary (`notes/flybuys_restructuring_summary.md`)\n\n**Quick-reference guide** covering:\n\n- Goal and key problems\n- Target structure overview\n- Major transformations (Key Tech Decisions → ADRs, Executive Summary enhancement, Baseline extraction)\n- Content movement map\n- Content creation checklist\n- 6 validation checkpoints\n- 5-phase execution plan\n- Risks and success criteria\n\n### Key Recommendations\n\n#### 1. Converting Key Technology Decisions to ADRs\n\n**10+ Formal ADRs to Create**:\n\n- ADR-FB-001: .NET 8.0 Implementation Stack (Accepted)\n- ADR-FB-002: OAuth 2.0 + PKCE for Partner Linking (Accepted)\n- ADR-FB-003: NoSQL Database (Accepted, technology TBD)\n- ADR-FB-004: Event-Driven Integration (Accepted, technology TBD)\n- ADR-FB-005: Phased Rollout with Feature Flags (Accepted)\n- ADR-FB-006: AES-256 Encryption for OAuth Tokens (Accepted)\n- ADR-FB-007: Nightly Batch SFTP (Accepted)\n- ADR-FB-008: Circuit Breaker Pattern (Accepted)\n- ADR-FB-009: Correlation ID Propagation (Accepted)\n- ADR-FB-010: Conformist Pattern for Flybuys (Accepted)\n\n**Template**: Status, Context, Decision, Rationale, Consequences, Implementation Notes\n\n#### 2. Extracting Baseline Architecture from TS-0\n\n**Current State**: TS-0 content scattered in Transition Architecture section (lines 4421-4438)\n\n**Target State**: Comprehensive Baseline Architecture section in Technical Architecture with:\n\n- Current Business Capability (from Architecture Definition)\n- Current Value Stream with sequence diagram (from Architecture Definition)\n- Existing System Components (OTR App API, Reddy Express, Salesforce, EagleEye, Coupon Scanner)\n- Integration Architecture diagram (to be created)\n- Pain Points (from Architecture Definition)\n- Technical Debt (from TS-0)\n\n**Why**: TOGAF requires baseline-gap-target progression. Salesforce has comprehensive baseline before gap analysis.\n\n#### 3. Organizing Non-Functional Requirements\n\n**8 Subsections**:\n\n1. Performance Requirements (6 NFRs: API latency, adjudication latency, OAuth flow, balance query, Event Bus, batch processing)\n2. Availability Requirements (5 NFRs: service uptime, graceful degradation, disaster recovery)\n3. Scalability Requirements (6 NFRs: transaction volume 1x/3x/10x, auto-scaling)\n4. Security Requirements (10 NFRs: authentication, authorisation, encryption, secret management, PII handling, rate limiting)\n5. Reliability Requirements (8 NFRs: retry logic, DLQ monitoring, idempotency, circuit breaker, health checks)\n6. Maintainability Requirements (8 NFRs: code quality, API docs, deployment automation, logging, monitoring, alerting)\n7. Usability Requirements (5 NFRs: OAuth UX, balance display, transaction confirmation, error messaging, accessibility)\n8. Compliance Requirements (6 NFRs: GDPR, data residency, audit trail, API security, PCI-DSS)\n\n**Total**: 40+ NFRs with measurable targets\n\n#### 4. Content to Create vs. Move\n\n**Move** (no creation):\n- Gap Analysis (line 3242 → Technical Architecture)\n- Implementation Constraints → Assumptions and Constraints\n- Success Criteria → Executive Summary\n- TS-0 Baseline → Baseline Architecture\n- Domain Event Schemas → Data Architecture\n\n**Convert** (transformation):\n- Key Technology Decisions table → Formal ADRs (10+ ADRs)\n\n**Create** (new sections):\n- Vision, Architectural Approach, Architecture Overview (copy from Architecture Definition)\n- Technical Requirements (copy from Architecture Definition)\n- Executive Summary - Challenge/Key Architectural Significance/Open Technical Decisions\n- Baseline Architecture - Existing System Components/Integration Architecture\n- Data Quality & Validation\n- Work Package Sequencing\n- Assumptions and Constraints (10+ assumptions)\n- Non-Functional Requirements (8 subsections, 40+ NFRs)\n- Monitoring and Observability (metrics, alerting, dashboards)\n- Solution Validation (functional, non-functional, integration testing)\n\n#### 5. Validation Checkpoints\n\n**6 Checkpoints**:\n\n1. **Executive Summary**: Can executive understand business problem, solution, strategic value?\n2. **Technical Architecture**: Can Domain Architect understand baseline, gaps, target state, decisions?\n3. **Non-Functional Requirements**: Can Senior Engineer design load/resilience/security tests?\n4. **Monitoring and Observability**: Can Platform SRE configure monitoring/alerting?\n5. **Solution Validation**: Can QA Lead design test plans?\n6. **Work Package Sequencing**: Can Programme Lead plan resource allocation/timeline?\n\n### Estimated Effort\n\n**Total**: 21-28 hours across 5 phases\n\n**Final Document Size**: 6000-6500 lines (+1000 lines from current 5276 lines)\n\nBoth planning documents are saved in `/mnt/c/Users/o.young/work/architecture/notes/` for your review."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":4,"cache_creation_input_tokens":3817,"cache_read_input_tokens":70317,"cache_creation":{"ephemeral_5m_input_tokens":3817,"ephemeral_1h_input_tokens":0},"output_tokens":1573,"service_tier":"standard"}},"requestId":"req_011CWwE88F8Jp4JrjWnGFJXK","type":"assistant","uuid":"f9c2f99d-4ef3-4765-9ccc-9c47ddf81769","timestamp":"2026-01-09T05:10:02.245Z"}
