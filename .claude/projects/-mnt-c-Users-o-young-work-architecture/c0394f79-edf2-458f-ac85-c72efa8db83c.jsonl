{"type":"summary","summary":"Refactor Salesforce Interfaces to External Specifications","leafUuid":"2325d1fe-eb24-4b5d-8c16-c580ef5ae9bc"}
{"type":"summary","summary":"Refactor Salesforce Architecture: Move Inline Interface Specs","leafUuid":"d5a4c5da-d306-4d33-a50c-bf84cb47037a"}
{"type":"summary","summary":"Refactor Salesforce Architecture: Move Inline Interfaces to Specs","leafUuid":"a2a709b2-ca89-419f-838e-4d798af233ca"}
{"type":"summary","summary":"Refactor Salesforce Architecture: Move Inline Interfaces to Specifications","leafUuid":"0b3b4c2a-15c3-4518-a1cc-71b9a89cd818"}
{"type":"summary","summary":"Refactor Salesforce Architecture: Move Interface Specs Inline","leafUuid":"f4bb2606-6d9b-4d3f-b5c9-29f4ed82e6e0"}
{"type":"summary","summary":"Refactor Salesforce Architecture: Move Inline Interfaces","leafUuid":"61907f8b-16f8-4cff-986d-f35001486bda"}
{"type":"summary","summary":"Refactor Salesforce architecture interface specifications","leafUuid":"4f238db3-ec2c-4911-b803-73dd48ac0e97"}
{"type":"summary","summary":"Salesforce Architecture: Extract Inline Interface Specifications","leafUuid":"7fbb3d50-60ef-4e10-ac17-527536a8a252"}
{"type":"summary","summary":"Refactor Salesforce Architecture: Move Inline Interfaces to Specs","leafUuid":"3a61632b-a7d9-4032-9947-09b033b720ec"}
{"type":"summary","summary":"Salesforce Solution Architecture Interface Specifications Refactoring","leafUuid":"ff119434-c7ec-4002-b39c-73d094217243"}
{"type":"summary","summary":"Refactor Salesforce Architecture: Move Inline Interface Specs","leafUuid":"fe7a998b-6635-4ede-9223-57c3a0da46d0"}
{"type":"summary","summary":"Refactor Salesforce Architecture: Extract Inline Interface Specifications","leafUuid":"80bedd58-7bdc-41cf-9d53-749570e4135f"}
{"type":"summary","summary":"Refactor Salesforce Architecture Interface Specifications","leafUuid":"adde0ae3-0a2d-4593-af1b-e3e0baa22ff4"}
{"type":"summary","summary":"Refactor Salesforce Architecture: Extract Inline Specs","leafUuid":"b7552d2b-fcca-4bf2-b680-dcf571ffe80f"}
{"type":"summary","summary":"Salesforce Solution Architecture Refactoring and TOGAF Alignment","leafUuid":"02f1fad1-dc49-4c34-8682-d9ad2eff8d0a"}
{"type":"summary","summary":"Refactor Salesforce Architecture to TOGAF Phase E","leafUuid":"e19ca4d3-ff25-42d0-ba3c-9826bb1d4874"}
{"type":"summary","summary":"Refactor Salesforce architecture specs to proper files","leafUuid":"ee7eb63b-b999-408d-888b-0edf2bc0876b"}
{"type":"summary","summary":"Refactor Salesforce Architecture Specs Into Files","leafUuid":"0f627f02-258e-4d99-9d42-14c7aff1603c"}
{"type":"summary","summary":"Salesforce Solution Architecture: Extract Specs and Add Work Packages","leafUuid":"0536b5b5-9595-4d47-ba42-b9a45f2557c3"}
{"type":"summary","summary":"Refactor Salesforce Architecture: Remove Inline Specs, Add Work Packages","leafUuid":"d0313152-3646-4d52-8f63-fef5657be345"}
{"type":"summary","summary":"Refactor Salesforce Architecture: Remove Inline Specs","leafUuid":"9bb24870-e18e-4b29-8eef-f7f229168116"}
{"type":"summary","summary":"Salesforce Solution Architecture: Extract Specs & Add Work Packages","leafUuid":"b32d5895-05fa-463f-a86c-a377a4b71b48"}
{"type":"summary","summary":"Refactor Salesforce & Flybuys docs to exemplary TOGAF Phase E","leafUuid":"1ec0b2ce-53a2-46ab-8a6c-e4d2f59c2ac7"}
{"type":"summary","summary":"Refactor Salesforce & Flybuys docs to exemplary TOGAF Phase E","leafUuid":"efd4c839-b0af-4acd-99f1-774cbac32442"}
{"type":"summary","summary":"Refactor Salesforce & Flybuys to exemplary TOGAF Phase E","leafUuid":"6a75c2bc-a6d1-4de0-8e44-a7803fa446fb"}
{"type":"summary","summary":"Refactor Salesforce & Flybuys TOGAF Phase E","leafUuid":"a012b91d-52ba-4ab3-8303-0cb3fefa7f67"}
{"type":"summary","summary":"Refactor Salesforce & Flybuys docs to exemplary TOGAF Phase E","leafUuid":"4061a4d2-4f6b-4dc0-a1a9-44745d420a89"}
{"type":"summary","summary":"Refactor Salesforce & Flybuys docs to exemplary TOGAF Phase E","leafUuid":"288d27c9-a8c2-4709-9e47-ebe0f8549542"}
{"type":"summary","summary":"Refactor Salesforce & Flybuys docs to exemplary TOGAF Phase E standard","leafUuid":"c233570a-121d-4055-a814-502f89ca4171"}
{"type":"summary","summary":"Refactor Salesforce architecture and align Flybuys doc to TOGAF Phase E","leafUuid":"fac2db1f-bab8-46a3-84a1-b2b4b99bf314"}
{"type":"summary","summary":"Refactor Salesforce & Flybuys docs to exemplary TOGAF Phase E","leafUuid":"fb554aea-f9b1-4462-8b15-4a836a240d09"}
{"type":"summary","summary":"Refactoring Salesforce & Flybuys Docs to Exemplary TOGAF Phase E","leafUuid":"167b5696-34dd-4242-9023-c7caf187f1f2"}
{"type":"summary","summary":"Refactor TOGAF Phase E: Add Work Packages","leafUuid":"0fb96123-e59b-433a-9b61-f67aa529d4db"}
{"type":"summary","summary":"Refactor TOGAF Phase E: Add Work Packages","leafUuid":"475a1e90-c51e-4a37-8ade-97a7f5a73aa6"}
{"type":"summary","summary":"Refactor Salesforce Architecture: Extract Specs, Add TOGAF Work Packages","leafUuid":"786d4e0a-3cad-4a8f-89ea-a16cbaa2082e"}
{"type":"file-history-snapshot","messageId":"e17cae10-3f59-40e7-acba-e9f3a007d772","snapshot":{"messageId":"e17cae10-3f59-40e7-acba-e9f3a007d772","trackedFileBackups":{},"timestamp":"2026-01-09T03:08:25.579Z"},"isSnapshotUpdate":false}
{"parentUuid":null,"isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","type":"user","message":{"role":"user","content":"internally link the work packages in teh salesforce soultion arch"},"uuid":"e17cae10-3f59-40e7-acba-e9f3a007d772","timestamp":"2026-01-09T03:08:25.561Z","thinkingMetadata":{"level":"high","disabled":false,"triggers":[]},"todos":[]}
{"parentUuid":"e17cae10-3f59-40e7-acba-e9f3a007d772","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01YEHyQ19xuimLX8ee1Yqe1U","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"The user wants me to internally link the work packages in the Salesforce solution architecture. Let me first understand what files we're dealing with and what needs to be linked.\n\nBased on the git status, I can see:\n- `architecture_definitions/salesforce_customer_support.adoc`\n- `modules/ROOT/pages/salesforce_customer_support.adoc`\n\nThe user mentions \"solution arch\" which likely refers to solution architecture documentation. Let me first explore what files exist and understand the structure.\n\nI should:\n1. Find the Salesforce solution architecture files\n2. Identify the work packages that need to be linked\n3. Add internal cross-references between them\n\nLet me start by finding and reading the relevant files.","signature":"EuoGCkYICxgCKkAon4boNr7Ynj1NLDmiZVK36SCvq9tG8KyqtRXeFf+g+X2s0Zkq8+9YKoyYMwcrUtC4YOtlAMiUS9ILKX6a44vjEgxqSlhGuaIWUZR1o9waDLt105ZlEGyvq/dUDCIw8cWWTE3SUeoV3HVMCBBkk0vAMbEUwJirQg1ueonUgnoVm4P84VbXdwUGkpJ2ke7SKtEFU7TkPEhgPtfabMWiVBkwiuqtohid+/W3PqEVN0pcFXtvlqv6TTrP05+7gJcMatFLeKMms+cFshyg60XPNcIkZPpwBP8M2Op6nUvGepRoEmgetbqxQ3L4amcnFC5KEuFxCBxw3rMWPKEcDTazbVdJGVaiOkMcjzHQ62i4xJS98bh4cdHaH8aBDXusMfmo7J8RG35OjH/IUOlg0NnWpe9f/RfF9n9WWhGF3m+x/saiA/4rv9brE5d2SSzYv8z3WgK+le2NeOwQSiP26VclsiHZbxwVkt8xt/cSi4gbgq+feeI4mNCRcrbGw5PCn+GLkAi9qvvllKnxn+dT1iX14/bjE+bTUDuUiDH5eZmD7GA3HJOAEXjPl3rjX2C6APU3KV3sft1bRidiuUYHp5rvaDgWqIDSfO1whr6MgTRSafkCLkgpNb6ygdsaQBy0RjD0ZU3CAEd5H15oZ5JNPkT1J+2hCZXH/IJZzKvR+YnWzzX8UScC21mJu3VmTG6ovsV2PjTFkaKaArkcvBJ9zRPsr4BFBrIB5yz/X8uXE9SqIqK+8HehApKAgkxMm13s9BIDPtwON18nuv1GO0d2SJ2/gLlHkT9oTgOR79/1EeiBITf8WqFv8BkKi0zf7H3yaSujdIYtYcIjfD86JnJ6K6YaSBWhgWi7ubNZX5jdkJmI9wCDTI80cJzQ83mms4Y3F6l4HvE8F5Pkckhd85lIlYICEeTL4UZIQwXtptRppXZqNxjoYfDJJBZ088hKXKnkFfh2psfMWnjhhtdKVOLfGNCGFLnVZgKNtsYvfVfkjG0KnUbBqCtEIDsIRuB6q6I6eGkKBkAzEGE+nkmVjOgnt55XRUqwOE69j2p8gp3CwNXbDRQloVObxYuzFXnfLB+V2zW6UaD2cKBrSg0zVO7laSzCfrOiVSaVJZBQR5nYl5pECuCOciMfitey9r7Md12DAuGJadwRHBgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":24282,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":24282,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CWw4tsj65Ldb8rpDom5FK","type":"assistant","uuid":"4c6e1008-13f9-41ce-b49e-50a772a4245d","timestamp":"2026-01-09T03:08:33.020Z"}
{"parentUuid":"4c6e1008-13f9-41ce-b49e-50a772a4245d","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01YEHyQ19xuimLX8ee1Yqe1U","type":"message","role":"assistant","content":[{"type":"text","text":"I'll help you add internal links between the work packages in the Salesforce solution architecture. Let me first find and examine the relevant files."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":24282,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":24282,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CWw4tsj65Ldb8rpDom5FK","type":"assistant","uuid":"31507a9b-2237-4481-bff3-74dc3fdd06d0","timestamp":"2026-01-09T03:08:33.604Z"}
{"parentUuid":"31507a9b-2237-4481-bff3-74dc3fdd06d0","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01YEHyQ19xuimLX8ee1Yqe1U","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01PRpbkUwds814ijFVaTe4up","name":"Glob","input":{"pattern":"**/*salesforce*solution*.adoc"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":24282,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":24282,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CWw4tsj65Ldb8rpDom5FK","type":"assistant","uuid":"43cfa2d4-d489-4880-abc6-7240916b6814","timestamp":"2026-01-09T03:08:34.220Z"}
{"parentUuid":"43cfa2d4-d489-4880-abc6-7240916b6814","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01YEHyQ19xuimLX8ee1Yqe1U","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_016zAg88FYW3CjYERGt5fuVA","name":"Glob","input":{"pattern":"**/salesforce_customer_support.adoc"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":24282,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":24282,"ephemeral_1h_input_tokens":0},"output_tokens":303,"service_tier":"standard"}},"requestId":"req_011CWw4tsj65Ldb8rpDom5FK","type":"assistant","uuid":"eda18804-1ec1-4299-b68a-ebc7c23bd96a","timestamp":"2026-01-09T03:08:34.499Z"}
{"parentUuid":"43cfa2d4-d489-4880-abc6-7240916b6814","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01PRpbkUwds814ijFVaTe4up","type":"tool_result","content":"No files found"}]},"uuid":"c700db55-ea56-4dda-95fd-2d13b0324f92","timestamp":"2026-01-09T03:08:38.435Z","toolUseResult":{"filenames":[],"durationMs":3842,"numFiles":0,"truncated":false},"sourceToolAssistantUUID":"43cfa2d4-d489-4880-abc6-7240916b6814"}
{"parentUuid":"eda18804-1ec1-4299-b68a-ebc7c23bd96a","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_016zAg88FYW3CjYERGt5fuVA","type":"tool_result","content":"/mnt/c/Users/o.young/work/architecture/architecture_definitions/salesforce_customer_support.adoc\n/mnt/c/Users/o.young/work/architecture/initiatives/salesforce_customer_support.adoc\n/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc"}]},"uuid":"0bc85417-0576-4505-bb0f-d528aefdaed0","timestamp":"2026-01-09T03:08:38.476Z","toolUseResult":{"filenames":["/mnt/c/Users/o.young/work/architecture/architecture_definitions/salesforce_customer_support.adoc","/mnt/c/Users/o.young/work/architecture/initiatives/salesforce_customer_support.adoc","/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc"],"durationMs":3884,"numFiles":3,"truncated":false},"sourceToolAssistantUUID":"eda18804-1ec1-4299-b68a-ebc7c23bd96a"}
{"parentUuid":"0bc85417-0576-4505-bb0f-d528aefdaed0","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_011KTfVGb71o8pSqdywMYpXC","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Good, I found three files. Based on the context and the git status showing `modules/ROOT/pages/salesforce_customer_support.adoc`, I should look at the solution_architectures one. Let me read it to see the work packages.","signature":"EoQDCkYICxgCKkDy5qU8Wn1pnohsIqcyJem/FHkoTpPo2Pe2ZFzZCKMcmHzvDkL7baelanzBE72KgW6O+KdpZzZyPI4YaN0jTA9VEgzyfXcaEfy7Jhhz9toaDJHirgND4+EihH0t8SIwpX6W3JxOmLg1cB5XFP6vT9hEV4KeFSeaLnhygy6D3l0+2r2VyttEyEI/juO02fywKusBRFXP2ADkWqWCQiBBOdidl1PQ3rw9P+wGj0Clakrm5U5HzfxO7sZBYapXNBPIZ5GWhC4m7/9x6IU9z9rGS7KRUjx9AdgAlm0wOKuyv2w65El/XbuS7Tzb4BbDVYUk+SZJL0wWqo9r+XBP2/+jWQlTCwk/U8hC1Fpsg4QQIao9CVrjLiVscum20G6zOwykkpbf0M+GDJPXwnhGjg+IGvQiH7gsXKeDD2ejCH4PcmjdkjYvfuiUcLtAKXzMpnMG9c68Vp3POlWSsAcT3PcZXDkoiCOs2fXNxKxucB13rANB9E5G9FyD/9AZdhFi3BgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":14,"cache_creation_input_tokens":452,"cache_read_input_tokens":24282,"cache_creation":{"ephemeral_5m_input_tokens":452,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWw4uq2tgSQGrfS6qJYuo","type":"assistant","uuid":"29736fab-ef32-4069-a450-dced45e2fa7c","timestamp":"2026-01-09T03:08:43.811Z"}
{"parentUuid":"29736fab-ef32-4069-a450-dced45e2fa7c","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_011KTfVGb71o8pSqdywMYpXC","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01GzVwR6LeGiNHSdyF3MSye5","name":"Read","input":{"file_path":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":14,"cache_creation_input_tokens":452,"cache_read_input_tokens":24282,"cache_creation":{"ephemeral_5m_input_tokens":452,"ephemeral_1h_input_tokens":0},"output_tokens":144,"service_tier":"standard"}},"requestId":"req_011CWw4uq2tgSQGrfS6qJYuo","type":"assistant","uuid":"466c9be0-0fb3-4b35-b4e9-7c6d193bd21f","timestamp":"2026-01-09T03:08:44.454Z"}
{"parentUuid":"466c9be0-0fb3-4b35-b4e9-7c6d193bd21f","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"type":"tool_result","content":"File content (34227 tokens) exceeds maximum allowed tokens (25000). Please use offset and limit parameters to read specific portions of the file, or use the GrepTool to search for specific content.","is_error":true,"tool_use_id":"toolu_01GzVwR6LeGiNHSdyF3MSye5"}]},"uuid":"2524e1b0-f32f-4dd2-a76d-fba2781a4c81","timestamp":"2026-01-09T03:08:45.243Z","toolUseResult":"Error: File content (34227 tokens) exceeds maximum allowed tokens (25000). Please use offset and limit parameters to read specific portions of the file, or use the GrepTool to search for specific content.","sourceToolAssistantUUID":"466c9be0-0fb3-4b35-b4e9-7c6d193bd21f"}
{"parentUuid":"2524e1b0-f32f-4dd2-a76d-fba2781a4c81","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01X1Fd3asvediK46tGJsrQtY","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"The file is very large. Let me search for work package sections to understand the structure.","signature":"EoQCCkYICxgCKkDWOQr1bdDGYPLHA0PKw7VDpl4IHG9AsjhgPNNVshcs1mTXgr3r+eIiagnTDfwSDuGi81/oE/Z8aSDUi0agWgr+Egw13RrTly2tQaIBXGcaDNvhIi6imzlbSduCmSIwf+B+ByAE7gISW7i9LMNGxj7fTlHC3IqBhpLp1pig4Z3R2BbqQ/99WzWDrsLZ+2xDKmw7oCwiBMeDqd4CR+ruS8Of7kFuY3OUY98bcTUFt52ZjobYOgK+8Ez5ZxqSf143tnqNKE/KMyBN6fu1hfIvgg6xPfCyHQBNUaTEzXY7ZuT5sVYNN6bRkMOtvC9CixiwiWfJyFop3IuV8AZElfoYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":14,"cache_creation_input_tokens":214,"cache_read_input_tokens":24734,"cache_creation":{"ephemeral_5m_input_tokens":214,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWw4vKzRfWw6SeqdSxFub","type":"assistant","uuid":"78b5540f-7654-41d9-b231-dc7a9ef8774c","timestamp":"2026-01-09T03:08:49.087Z"}
{"parentUuid":"78b5540f-7654-41d9-b231-dc7a9ef8774c","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01X1Fd3asvediK46tGJsrQtY","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01BAv5FFJvNho9ekj6VRnUDK","name":"Grep","input":{"pattern":"^=+ Work Package","path":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","output_mode":"content"}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":14,"cache_creation_input_tokens":214,"cache_read_input_tokens":24734,"cache_creation":{"ephemeral_5m_input_tokens":214,"ephemeral_1h_input_tokens":0},"output_tokens":147,"service_tier":"standard"}},"requestId":"req_011CWw4vKzRfWw6SeqdSxFub","type":"assistant","uuid":"f3a40ebf-799d-4716-8ed1-4fdd9c7054fe","timestamp":"2026-01-09T03:08:50.507Z"}
{"parentUuid":"f3a40ebf-799d-4716-8ed1-4fdd9c7054fe","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01BAv5FFJvNho9ekj6VRnUDK","type":"tool_result","content":"1473:== Work Packages\n1477:=== Work Package Overview\n2185:=== Work Package Sequencing"}]},"uuid":"814444c5-9aab-44d5-9d08-4efabdcdfb14","timestamp":"2026-01-09T03:08:53.224Z","toolUseResult":{"mode":"content","numFiles":0,"filenames":[],"content":"1473:== Work Packages\n1477:=== Work Package Overview\n2185:=== Work Package Sequencing","numLines":3},"sourceToolAssistantUUID":"f3a40ebf-799d-4716-8ed1-4fdd9c7054fe"}
{"parentUuid":"814444c5-9aab-44d5-9d08-4efabdcdfb14","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01AJEiBmjnR6tcdi93zonEHg","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"I need to find the individual work packages. Let me search for work package headings differently.","signature":"EokCCkYICxgCKkDuPoVPk9W/zPt15JPc4qssAiL76qubRQclJaliXiSOaMkZVB0K90isWf/epmchW8bBi50n9e7eZ3d50kjh1378Egxi+iJhilmep61c+4MaDHvjqRpAX/dbSoy/HiIw65ZilJy4P7z3K3S31IqJmFJydDGVXIqVV9OihtZxZ4asdXVxsaHwVjd/a46GCrb+KnE1585fyOcleFcVgUAoB1I7/OW+SGDeupL1mLFCqgkzRo8uQfRZQ62IGaHbJO48XQQBikGVCrYwpgZ/Uo4USpo/OEz0ULNff0BV1UiQKVX4uRzakTfSu3eyF7/aLDaYeWc6yV1VxWgtvOY9u/41BWa5fRgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":194,"cache_read_input_tokens":24948,"cache_creation":{"ephemeral_5m_input_tokens":194,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CWw4vv62Z7GS5s2UVPaff","type":"assistant","uuid":"ae025b0e-4953-46c8-8ea4-6f1957689229","timestamp":"2026-01-09T03:08:56.320Z"}
{"parentUuid":"ae025b0e-4953-46c8-8ea4-6f1957689229","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01AJEiBmjnR6tcdi93zonEHg","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_012X5pjMPwknTa5b6TcgjK9v","name":"Grep","input":{"pattern":"^==== (WP|Work Package \\d)","path":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","output_mode":"content"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":194,"cache_read_input_tokens":24948,"cache_creation":{"ephemeral_5m_input_tokens":194,"ephemeral_1h_input_tokens":0},"output_tokens":154,"service_tier":"standard"}},"requestId":"req_011CWw4vv62Z7GS5s2UVPaff","type":"assistant","uuid":"8dcc8058-5fcd-4add-8059-a13ce7460b45","timestamp":"2026-01-09T03:08:57.406Z"}
{"parentUuid":"8dcc8058-5fcd-4add-8059-a13ce7460b45","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_012X5pjMPwknTa5b6TcgjK9v","type":"tool_result","content":"No matches found"}]},"uuid":"2f58bb7a-df37-49bf-890c-904f67dc31c2","timestamp":"2026-01-09T03:08:59.149Z","toolUseResult":{"mode":"content","numFiles":0,"filenames":[],"content":"","numLines":0},"sourceToolAssistantUUID":"8dcc8058-5fcd-4add-8059-a13ce7460b45"}
{"parentUuid":"2f58bb7a-df37-49bf-890c-904f67dc31c2","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_017U467uYMw2GiBstjYZkUus","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Let me search for WP acronyms or numbered work packages.","signature":"EuABCkYICxgCKkCXPV5LSjn/RkZN8xCfWtJ8XZCNjVDhU0icBePu1n7jclpfzbvOrSwgASNxkUIMGPZkssdHntUrzOz6EfYXMu7yEgzBWhrTgGfdpJ/oosUaDEgz+2V5PTQROa5K4SIwN7JOkK+MYw33yryoJCbdFkYgOkB5S24nWhs2xkVM3LluwojVRv1AWjHamjo0IPZFKkjmyYoqPAvhS7DceppSdv6HGmHmIeCm9bLTS0a31ISbxx7ybkF/C28HJxhkuS8o7luyvJP7yqyiXSVQMZc7NHi9HbyxamZy2owYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":176,"cache_read_input_tokens":25142,"cache_creation":{"ephemeral_5m_input_tokens":176,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWw4wMB94jxciXChygdNb","type":"assistant","uuid":"639a753d-459d-4451-9b93-baee1938ec6d","timestamp":"2026-01-09T03:09:02.139Z"}
{"parentUuid":"639a753d-459d-4451-9b93-baee1938ec6d","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_017U467uYMw2GiBstjYZkUus","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01QjTJDyazd2oLNHrh8DGSPy","name":"Grep","input":{"pattern":"^==== WP","path":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","output_mode":"content"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":176,"cache_read_input_tokens":25142,"cache_creation":{"ephemeral_5m_input_tokens":176,"ephemeral_1h_input_tokens":0},"output_tokens":143,"service_tier":"standard"}},"requestId":"req_011CWw4wMB94jxciXChygdNb","type":"assistant","uuid":"0b81a289-8a47-4054-9338-043032737c13","timestamp":"2026-01-09T03:09:02.850Z"}
{"parentUuid":"0b81a289-8a47-4054-9338-043032737c13","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01QjTJDyazd2oLNHrh8DGSPy","type":"tool_result","content":"No matches found"}]},"uuid":"783d763b-3e7c-4fd6-8208-dfd607985d6e","timestamp":"2026-01-09T03:09:03.921Z","toolUseResult":{"mode":"content","numFiles":0,"filenames":[],"content":"","numLines":0},"sourceToolAssistantUUID":"0b81a289-8a47-4054-9338-043032737c13"}
{"parentUuid":"783d763b-3e7c-4fd6-8208-dfd607985d6e","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_018dMB4UEpYMUANW8TtVC6a5","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Let me read the work packages section to see what's there.","signature":"EuIBCkYICxgCKkC1qtrnE5pSi5Ryh491RkbZaL3Xckl2gA75TceAOmWyi183kkjeBj9h930SGDUhsW9M8we9oGxyO0gJrSSyknr8EgyZpc7RM9+FoNXi958aDCBGskj/Lf9zQxHidSIwFN0G1aFr3Hju2dtNXDTnXw1ZlvCWJxWeKVfwV8UWZXdrj9y7UGt01JcahimUk4vQKkpQCE4KkGPVCiQy7C2yhwSErluny4pSSC+n6ra8Eo7mSB3NDHf14J/BxeqfJTsNyYSMnBgJR2QdPoZRVDSlpVl1BfmJMUPORSOkWBgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":165,"cache_read_input_tokens":25318,"cache_creation":{"ephemeral_5m_input_tokens":165,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CWw4whfgeHnaQ9BN4fRBY","type":"assistant","uuid":"97da60fc-d92c-4a08-81d8-1e1eb4f83bbd","timestamp":"2026-01-09T03:09:07.249Z"}
{"parentUuid":"97da60fc-d92c-4a08-81d8-1e1eb4f83bbd","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_018dMB4UEpYMUANW8TtVC6a5","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_0129iaPV8vknxYqeZhXNgmSn","name":"Read","input":{"file_path":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","offset":1473,"limit":100}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":165,"cache_read_input_tokens":25318,"cache_creation":{"ephemeral_5m_input_tokens":165,"ephemeral_1h_input_tokens":0},"output_tokens":138,"service_tier":"standard"}},"requestId":"req_011CWw4whfgeHnaQ9BN4fRBY","type":"assistant","uuid":"8d08c624-a7ee-4046-854e-f6d917c10a6b","timestamp":"2026-01-09T03:09:07.931Z"}
{"parentUuid":"8d08c624-a7ee-4046-854e-f6d917c10a6b","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_0129iaPV8vknxYqeZhXNgmSn","type":"tool_result","content":"  1473→== Work Packages\n  1474→\n  1475→This section consolidates gaps and activities into implementable work packages aligned with TOGAF Phase E requirements.\n  1476→\n  1477→=== Work Package Overview\n  1478→\n  1479→[width=\"100%\",cols=\"15%,35%,25%,25%\",options=\"header\",]\n  1480→|===\n  1481→|Work Package ID |Name |Transition State |Key Deliverables\n  1482→\n  1483→|WP-CS-001\n  1484→|ProfileService Development\n  1485→|TS-1 (Build & Test)\n  1486→|ProfileService microservice, Salesforce Contact integration, REST API\n  1487→\n  1488→|WP-CS-002\n  1489→|EngagementService Development\n  1490→|TS-1 (Build & Test)\n  1491→|EngagementService microservice, Anti-Corruption Layer, Braze integration\n  1492→\n  1493→|WP-CS-003\n  1494→|Event Bus Infrastructure\n  1495→|TS-1 (Build & Test)\n  1496→|Event Bus configuration, CloudEvents schemas, monitoring\n  1497→\n  1498→|WP-CS-004\n  1499→|Contact Migration Tooling\n  1500→|TS-1 (Build & Test)\n  1501→|Migration tool, validation scripts, reconciliation reporting\n  1502→\n  1503→|WP-CS-005\n  1504→|Mobile App Integration\n  1505→|TS-1 (Build & Test)\n  1506→|Mobile App API integration, feedback form enhancements, testing\n  1507→\n  1508→|WP-CS-006\n  1509→|Integration Testing\n  1510→|TS-1 (Build & Test)\n  1511→|Test environments, integration test suites, UAT execution\n  1512→\n  1513→|WP-CS-007\n  1514→|Salesforce Configuration\n  1515→|TS-1 (Build & Test)\n  1516→|Salesforce field mapping, data isolation, webhook configuration\n  1517→\n  1518→|WP-CS-008\n  1519→|Contact Data Migration\n  1520→|TS-2 (Contact Migration)\n  1521→|Contact migration execution, validation, reconciliation\n  1522→\n  1523→|WP-CS-009\n  1524→|Production Deployment\n  1525→|TS-3 (Cutover)\n  1526→|Production deployment, smoke testing, go-live execution\n  1527→\n  1528→|WP-CS-010\n  1529→|Post-Cutover Support\n  1530→|TS-4 (Target State)\n  1531→|Monitoring, issue resolution, D365 CE retirement\n  1532→\n  1533→|===\n  1534→\n  1535→=== WP-CS-001: ProfileService Development\n  1536→\n  1537→==== Description\n  1538→\n  1539→Build ProfileService bounded context microservice implementing Just-In-Time Contact reconciliation with Salesforce Service Cloud.\n  1540→\n  1541→==== Deliverables\n  1542→\n  1543→* ProfileService microservice application\n  1544→** REST API implementation (OpenAPI 3.0 specification)\n  1545→** `GET /contact-id` endpoint (Salesforce Contact reconciliation)\n  1546→** Authentication/authorization with Microsoft Entra External ID\n  1547→** Caching layer (15-minute TTL for Contact IDs)\n  1548→* Salesforce integration\n  1549→** Salesforce REST API client\n  1550→** Contact upsert by email (external key matching)\n  1551→** Error handling and retry logic\n  1552→* Unit tests (>80% code coverage)\n  1553→* Integration tests with Salesforce sandbox\n  1554→* API documentation\n  1555→* Deployment configuration (IaC - Infrastructure as Code)\n  1556→\n  1557→==== Dependencies\n  1558→\n  1559→*Prerequisites*:\n  1560→\n  1561→* Salesforce sandbox environment provisioned\n  1562→* Microsoft Entra External ID OAuth configuration\n  1563→* Development environment setup (AWS dev account, CI/CD pipeline)\n  1564→\n  1565→*Dependent Work Packages*:\n  1566→\n  1567→* None (can start immediately after prerequisites met)\n  1568→\n  1569→==== Skills Required\n  1570→\n  1571→* Backend development (.NET Core or Node.js)\n  1572→* REST API design and implementation\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"265ab560-71bf-494a-b510-2ccfb47163a9","timestamp":"2026-01-09T03:09:08.093Z","toolUseResult":{"type":"text","file":{"filePath":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","content":"== Work Packages\n\nThis section consolidates gaps and activities into implementable work packages aligned with TOGAF Phase E requirements.\n\n=== Work Package Overview\n\n[width=\"100%\",cols=\"15%,35%,25%,25%\",options=\"header\",]\n|===\n|Work Package ID |Name |Transition State |Key Deliverables\n\n|WP-CS-001\n|ProfileService Development\n|TS-1 (Build & Test)\n|ProfileService microservice, Salesforce Contact integration, REST API\n\n|WP-CS-002\n|EngagementService Development\n|TS-1 (Build & Test)\n|EngagementService microservice, Anti-Corruption Layer, Braze integration\n\n|WP-CS-003\n|Event Bus Infrastructure\n|TS-1 (Build & Test)\n|Event Bus configuration, CloudEvents schemas, monitoring\n\n|WP-CS-004\n|Contact Migration Tooling\n|TS-1 (Build & Test)\n|Migration tool, validation scripts, reconciliation reporting\n\n|WP-CS-005\n|Mobile App Integration\n|TS-1 (Build & Test)\n|Mobile App API integration, feedback form enhancements, testing\n\n|WP-CS-006\n|Integration Testing\n|TS-1 (Build & Test)\n|Test environments, integration test suites, UAT execution\n\n|WP-CS-007\n|Salesforce Configuration\n|TS-1 (Build & Test)\n|Salesforce field mapping, data isolation, webhook configuration\n\n|WP-CS-008\n|Contact Data Migration\n|TS-2 (Contact Migration)\n|Contact migration execution, validation, reconciliation\n\n|WP-CS-009\n|Production Deployment\n|TS-3 (Cutover)\n|Production deployment, smoke testing, go-live execution\n\n|WP-CS-010\n|Post-Cutover Support\n|TS-4 (Target State)\n|Monitoring, issue resolution, D365 CE retirement\n\n|===\n\n=== WP-CS-001: ProfileService Development\n\n==== Description\n\nBuild ProfileService bounded context microservice implementing Just-In-Time Contact reconciliation with Salesforce Service Cloud.\n\n==== Deliverables\n\n* ProfileService microservice application\n** REST API implementation (OpenAPI 3.0 specification)\n** `GET /contact-id` endpoint (Salesforce Contact reconciliation)\n** Authentication/authorization with Microsoft Entra External ID\n** Caching layer (15-minute TTL for Contact IDs)\n* Salesforce integration\n** Salesforce REST API client\n** Contact upsert by email (external key matching)\n** Error handling and retry logic\n* Unit tests (>80% code coverage)\n* Integration tests with Salesforce sandbox\n* API documentation\n* Deployment configuration (IaC - Infrastructure as Code)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* Salesforce sandbox environment provisioned\n* Microsoft Entra External ID OAuth configuration\n* Development environment setup (AWS dev account, CI/CD pipeline)\n\n*Dependent Work Packages*:\n\n* None (can start immediately after prerequisites met)\n\n==== Skills Required\n\n* Backend development (.NET Core or Node.js)\n* REST API design and implementation","numLines":100,"startLine":1473,"totalLines":3319}},"sourceToolAssistantUUID":"8d08c624-a7ee-4046-854e-f6d917c10a6b"}
{"parentUuid":"265ab560-71bf-494a-b510-2ccfb47163a9","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_015z6uDLK7ArsgiUaTQPq7Em","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Good! I can see there are work packages with IDs like WP-CS-001, WP-CS-002, etc. Now let me read more to see the full structure and identify where internal links should be added. Let me continue reading to see more work packages.","signature":"Eo4DCkYICxgCKkApVVXgfB0KFE4sN6LNfzU2R35v0WYsHmhDBy9S0hj37HiK1LU6vTlVsZMrQmKPaz8CRV+WOftepuvlBHWoMHshEgwb6ukXrXe8mfKd3U0aDNGrP5NeRYUKfjSzNCIwYg+cYPccUhAacb5vIHygBoP4HlmmYtWwFqJ9GETJPduqT9cgznWf243LqMvO1U+/KvUB8mT/MF2nR84GO/oRwnXt7fOcCWO9xiOwx+DjeHFx+pLe6JoMtgm/4eTpQY4cFARJlJILRa2fI6v57mhbVwo4nqEyRr0dRP2DkoXoqmYMMpg4Ttu0kg6avehRyTWhLIcSjqrVa6PKPtLc1iAajG488GUSJg9IwAtOQzmzyjhvHKLC9ejLh3g3Sr49Ka4HhAd1SdoToV+SaPdwdSqu6loccW4elZS2oXcMIZ0649bnrQhHBHvGFVlMMVaPDdmDDh3zG4Ayq75lp7ppmeIQnexWib8411wwrDvhuloKjNbw8D+DJao0BHrkjlg6hV3jZXaJdzlrvfEYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":1408,"cache_read_input_tokens":25483,"cache_creation":{"ephemeral_5m_input_tokens":1408,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWw4x1aTJdMJa1sd7b2yG","type":"assistant","uuid":"695d907e-e4c6-433e-bba1-1b6467669ab9","timestamp":"2026-01-09T03:09:12.044Z"}
{"parentUuid":"695d907e-e4c6-433e-bba1-1b6467669ab9","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_015z6uDLK7ArsgiUaTQPq7Em","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01CBNMNFFDbxPFpZHo9jGEfK","name":"Grep","input":{"pattern":"^=== WP-CS-","path":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","output_mode":"content"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":1408,"cache_read_input_tokens":25483,"cache_creation":{"ephemeral_5m_input_tokens":1408,"ephemeral_1h_input_tokens":0},"output_tokens":190,"service_tier":"standard"}},"requestId":"req_011CWw4x1aTJdMJa1sd7b2yG","type":"assistant","uuid":"fa8f775b-d795-45e4-baf1-ff021c334f0a","timestamp":"2026-01-09T03:09:12.810Z"}
{"parentUuid":"fa8f775b-d795-45e4-baf1-ff021c334f0a","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01CBNMNFFDbxPFpZHo9jGEfK","type":"tool_result","content":"1535:=== WP-CS-001: ProfileService Development\n1588:=== WP-CS-002: EngagementService Development\n1662:=== WP-CS-003: Event Bus Infrastructure\n1723:=== WP-CS-004: Contact Migration Tooling\n1786:=== WP-CS-005: Mobile App Integration\n1852:=== WP-CS-006: Integration Testing\n1922:=== WP-CS-007: Salesforce Configuration\n1994:=== WP-CS-008: Contact Data Migration\n2060:=== WP-CS-009: Production Deployment\n2127:=== WP-CS-010: Post-Cutover Support"}]},"uuid":"58def72b-d192-4011-8317-af759fc4a22f","timestamp":"2026-01-09T03:09:13.835Z","toolUseResult":{"mode":"content","numFiles":0,"filenames":[],"content":"1535:=== WP-CS-001: ProfileService Development\n1588:=== WP-CS-002: EngagementService Development\n1662:=== WP-CS-003: Event Bus Infrastructure\n1723:=== WP-CS-004: Contact Migration Tooling\n1786:=== WP-CS-005: Mobile App Integration\n1852:=== WP-CS-006: Integration Testing\n1922:=== WP-CS-007: Salesforce Configuration\n1994:=== WP-CS-008: Contact Data Migration\n2060:=== WP-CS-009: Production Deployment\n2127:=== WP-CS-010: Post-Cutover Support","numLines":10},"sourceToolAssistantUUID":"fa8f775b-d795-45e4-baf1-ff021c334f0a"}
{"parentUuid":"58def72b-d192-4011-8317-af759fc4a22f","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01KSK9mACiwTYdbDB7TD5nsi","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Perfect! I can see all 10 work packages. Now I need to:\n1. Check if there are any existing cross-references to these work packages\n2. Add anchor IDs to each work package section\n3. Add cross-references where dependencies are mentioned\n\nLet me search for existing xrefs or references to work packages.","signature":"EtMDCkYICxgCKkBRsYwlx+yEVRCIX7JJ5d2w1NyWawNQ3ebpCdGABWgLJ6n7bjY022rI2YF4LqFkGnJYOe5qjyMLTBWCHZICVuPxEgwykdOV6pUTsCCJ6poaDEMAzmIryR9zzuYFrCIwSet/iTK0UTcmYaDEHezesMqFVED/QrxiK/q2viaIuwNMhDJibt4Z/CHaMZgHfQzfKroCFdchg0SJIhYe87tgojPmfiJMmD1cM80aft0tdd5B+vn7nB597ylxne18sbvZmIfwirXURWSX2bJCjqjT3/nnsLFjoPHejjHtdiUEtBhymxWtB2k0mujeKbDXjkD4+5eA5y9B5OiAZiG/bIxVoHkxx0oIHarod7XmGZwB85Pw6AdeErdEklUtBo3DXgkLvKh0+9J7X+FuknK0FCacF2SEnLipMKfiyK5sIROOaESDB4Ea2LQ1jTO6LwrpNlJhPlLTy/1Sx5wR01+OxjrjmGvCF3oP9FZiHDzwKXCjXqhKseER3wbQ3qtzUDKdwxw+bSj9FoTX5xUF44fAgc3JdWW6HTsKBNCjAR0n3n0uDd60T4+6tx1Iderx/HQLFLysWq6FUnllzNIZ9IskIlO3sAiwHPA73y6uDIC+eNcYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":376,"cache_read_input_tokens":26891,"cache_creation":{"ephemeral_5m_input_tokens":376,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWw4xRtw69CH9iKECL7GX","type":"assistant","uuid":"d2ea04e1-755b-4eaa-97fc-b22d9aeab5b1","timestamp":"2026-01-09T03:09:18.349Z"}
{"parentUuid":"d2ea04e1-755b-4eaa-97fc-b22d9aeab5b1","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01KSK9mACiwTYdbDB7TD5nsi","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01NhMXetEurwcuXWCfag58Rb","name":"Grep","input":{"pattern":"WP-CS-\\d{3}","path":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","output_mode":"content","head_limit":50}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":376,"cache_read_input_tokens":26891,"cache_creation":{"ephemeral_5m_input_tokens":376,"ephemeral_1h_input_tokens":0},"output_tokens":223,"service_tier":"standard"}},"requestId":"req_011CWw4xRtw69CH9iKECL7GX","type":"assistant","uuid":"5bd551c5-d2dc-4b80-8871-58f74021a1c3","timestamp":"2026-01-09T03:09:19.477Z"}
{"parentUuid":"5bd551c5-d2dc-4b80-8871-58f74021a1c3","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01NhMXetEurwcuXWCfag58Rb","type":"tool_result","content":"1483:|WP-CS-001\n1488:|WP-CS-002\n1493:|WP-CS-003\n1498:|WP-CS-004\n1503:|WP-CS-005\n1508:|WP-CS-006\n1513:|WP-CS-007\n1518:|WP-CS-008\n1523:|WP-CS-009\n1528:|WP-CS-010\n1535:=== WP-CS-001: ProfileService Development\n1588:=== WP-CS-002: EngagementService Development\n1627:* WP-CS-003 (Event Bus Infrastructure) completed\n1634:* WP-CS-003 must be completed first (Event Bus required for async processing)\n1635:* WP-CS-007 (Salesforce Configuration) must be in progress (field mapping needed)\n1662:=== WP-CS-003: Event Bus Infrastructure\n1723:=== WP-CS-004: Contact Migration Tooling\n1758:* WP-CS-001 (ProfileService Development) completed (reuses Salesforce integration code)\n1765:* WP-CS-001 provides Salesforce Contact upsert logic to reuse\n1786:=== WP-CS-005: Mobile App Integration\n1821:* WP-CS-001 (ProfileService Development) completed and deployed to dev/staging\n1822:* WP-CS-002 (EngagementService Development) completed and deployed to dev/staging\n1828:* Must complete after WP-CS-001 and WP-CS-002 (requires API endpoints available for integration testing)\n1852:=== WP-CS-006: Integration Testing\n1893:* WP-CS-001 (ProfileService Development) completed\n1894:* WP-CS-002 (EngagementService Development) completed\n1895:* WP-CS-003 (Event Bus Infrastructure) completed\n1896:* WP-CS-005 (Mobile App Integration) completed\n1897:* WP-CS-007 (Salesforce Configuration) sandbox configuration completed\n1901:* Must complete after WP-CS-001, WP-CS-002, WP-CS-003, WP-CS-005 (requires all components available)\n1922:=== WP-CS-007: Salesforce Configuration\n1973:* Required for WP-CS-002 (EngagementService needs field mapping)\n1974:* Required for WP-CS-006 (Integration Testing needs sandbox configuration)\n1994:=== WP-CS-008: Contact Data Migration\n2032:* WP-CS-004 (Contact Migration Tooling) completed\n2033:* WP-CS-001 (ProfileService Development) deployed to production (not yet integrated with Mobile App)\n2034:* WP-CS-007 (Salesforce Configuration) production configuration completed\n2040:* Must complete after WP-CS-001, WP-CS-004, WP-CS-007\n2041:* Must complete before WP-CS-009 (Production Deployment)\n2060:=== WP-CS-009: Production Deployment\n2096:* WP-CS-001 (ProfileService Development) completed\n2097:* WP-CS-002 (EngagementService Development) completed\n2098:* WP-CS-003 (Event Bus Infrastructure) completed\n2099:* WP-CS-005 (Mobile App Integration) completed\n2100:* WP-CS-006 (Integration Testing) completed with UAT sign-off\n2101:* WP-CS-007 (Salesforce Configuration) production configuration completed\n2102:* WP-CS-008 (Contact Data Migration) completed successfully\n2127:=== WP-CS-010: Post-Cutover Support\n2160:* WP-CS-009 (Production Deployment) completed\n2191:* WP-CS-003 (Event Bus Infrastructure)\n\n[Showing results with pagination = limit: 50, offset: 0]"}]},"uuid":"8eb77c0d-41c6-4bc2-9aa9-f7e0a3edbc4a","timestamp":"2026-01-09T03:09:20.954Z","toolUseResult":{"mode":"content","numFiles":0,"filenames":[],"content":"1483:|WP-CS-001\n1488:|WP-CS-002\n1493:|WP-CS-003\n1498:|WP-CS-004\n1503:|WP-CS-005\n1508:|WP-CS-006\n1513:|WP-CS-007\n1518:|WP-CS-008\n1523:|WP-CS-009\n1528:|WP-CS-010\n1535:=== WP-CS-001: ProfileService Development\n1588:=== WP-CS-002: EngagementService Development\n1627:* WP-CS-003 (Event Bus Infrastructure) completed\n1634:* WP-CS-003 must be completed first (Event Bus required for async processing)\n1635:* WP-CS-007 (Salesforce Configuration) must be in progress (field mapping needed)\n1662:=== WP-CS-003: Event Bus Infrastructure\n1723:=== WP-CS-004: Contact Migration Tooling\n1758:* WP-CS-001 (ProfileService Development) completed (reuses Salesforce integration code)\n1765:* WP-CS-001 provides Salesforce Contact upsert logic to reuse\n1786:=== WP-CS-005: Mobile App Integration\n1821:* WP-CS-001 (ProfileService Development) completed and deployed to dev/staging\n1822:* WP-CS-002 (EngagementService Development) completed and deployed to dev/staging\n1828:* Must complete after WP-CS-001 and WP-CS-002 (requires API endpoints available for integration testing)\n1852:=== WP-CS-006: Integration Testing\n1893:* WP-CS-001 (ProfileService Development) completed\n1894:* WP-CS-002 (EngagementService Development) completed\n1895:* WP-CS-003 (Event Bus Infrastructure) completed\n1896:* WP-CS-005 (Mobile App Integration) completed\n1897:* WP-CS-007 (Salesforce Configuration) sandbox configuration completed\n1901:* Must complete after WP-CS-001, WP-CS-002, WP-CS-003, WP-CS-005 (requires all components available)\n1922:=== WP-CS-007: Salesforce Configuration\n1973:* Required for WP-CS-002 (EngagementService needs field mapping)\n1974:* Required for WP-CS-006 (Integration Testing needs sandbox configuration)\n1994:=== WP-CS-008: Contact Data Migration\n2032:* WP-CS-004 (Contact Migration Tooling) completed\n2033:* WP-CS-001 (ProfileService Development) deployed to production (not yet integrated with Mobile App)\n2034:* WP-CS-007 (Salesforce Configuration) production configuration completed\n2040:* Must complete after WP-CS-001, WP-CS-004, WP-CS-007\n2041:* Must complete before WP-CS-009 (Production Deployment)\n2060:=== WP-CS-009: Production Deployment\n2096:* WP-CS-001 (ProfileService Development) completed\n2097:* WP-CS-002 (EngagementService Development) completed\n2098:* WP-CS-003 (Event Bus Infrastructure) completed\n2099:* WP-CS-005 (Mobile App Integration) completed\n2100:* WP-CS-006 (Integration Testing) completed with UAT sign-off\n2101:* WP-CS-007 (Salesforce Configuration) production configuration completed\n2102:* WP-CS-008 (Contact Data Migration) completed successfully\n2127:=== WP-CS-010: Post-Cutover Support\n2160:* WP-CS-009 (Production Deployment) completed\n2191:* WP-CS-003 (Event Bus Infrastructure)","numLines":50,"appliedLimit":50},"sourceToolAssistantUUID":"5bd551c5-d2dc-4b80-8871-58f74021a1c3"}
{"parentUuid":"8eb77c0d-41c6-4bc2-9aa9-f7e0a3edbc4a","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01XfBx3N1dS3dXGQj5yjzPBz","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Great! I can see that work packages are already referenced in dependency sections throughout the document. Now I need to:\n\n1. Add anchor IDs to each work package heading so they can be linked to\n2. Replace the plain text references to work packages with xref links\n\nIn AsciiDoc, I need to:\n1. Add `[[wp-cs-001]]` (or similar) before each work package heading\n2. Replace references like `WP-CS-001 (ProfileService Development)` with `<<wp-cs-001,WP-CS-001>> (ProfileService Development)`\n\nLet me read a section to understand the exact format better.","signature":"EsUFCkYICxgCKkCkDP+Gi4so46QBM5ovgMX6sEQD9XruLHhogspAfmLUxARofCvDcYjUDESUT0X2zovvjNaMwYHqzyNM1m7a22UwEgwEgML2ql8q1SJnDVkaDEme+eeEul2YbvZ3uiIwsWnmi8HlNBFqIKt5K7wi5kq81m67LITpxkoRyLcPSmMYGLVM+0Yz6NnnFCE2u8xoKqwENJ89HKWT7qV585vwYRnQ0kOssV0y3uX1jcn2BsqyhrjfSlKj6CHSjNJrvmQvYbAtsHJH7MBvUZDnMIuIWwR2qMawkqYqngSpK7IIIVObA+z1551st3WaMt4inobE1nzplNXV1rd8+1GV+7mq4GwEN6MKOZb756pud80PC/vdV/Td9m8gznfAvT6dN80Ka7rMA4oBPR4DotAnlV4C4pWMEE92ddJRyZM+xbOr12OybdAPgzAqyoyCqm10c5abYnFeBINfscdz1Lw8WZ0J0dx8PsXhQvokL1wabPzoXPmFh20c1gj4qpKHZtDduOKtZTiMHXMdwX/hWznQ/XBhAKEg4cAqDGff7VgT+x4U+eV0W4EoWwNXq9QEITHnaApdbgO1ZCngMUNZyocLW1XtOnupFH8SZNob0gg/4lXaAICJ1lp8tGo/XnEKbrvxJEoQ4eE22DoLtygKuQfSqtfW6S1kACAYPQl66JgG+8wa9sQyaiAFDEGqYr9De+mmlhJeI5Pqa9FA4RY1ZXM3TS2jXNQzqhOVMcEOdIIG3/YqPCsbGIumIy7RIN+xK9WgW2vN1365lihDdkms6jVHRjM0j777sIedAtnT9vywwEW3X63yj2bbZWGVRrp8e7g7JY82Cy/NuMHErgFdXUx7Gw4Ot9208w73XTCJVIOImZwnfo8dyk9aQqi7Zh4hSslcUeT2aU38mAyMQhdDlQItO3vgWwrfz2TlV8Mljd+pqV/nmhgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":1305,"cache_read_input_tokens":27267,"cache_creation":{"ephemeral_5m_input_tokens":1305,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWw4xxWBo2rv1W8shFhZd","type":"assistant","uuid":"c6cc4d6a-9e90-465e-a4e1-583cb8bdcc97","timestamp":"2026-01-09T03:09:27.304Z"}
{"parentUuid":"c6cc4d6a-9e90-465e-a4e1-583cb8bdcc97","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01XfBx3N1dS3dXGQj5yjzPBz","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_012A8S9HfrYvNsa6trApWACJ","name":"Read","input":{"file_path":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","offset":1620,"limit":50}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":1305,"cache_read_input_tokens":27267,"cache_creation":{"ephemeral_5m_input_tokens":1305,"ephemeral_1h_input_tokens":0},"output_tokens":268,"service_tier":"standard"}},"requestId":"req_011CWw4xxWBo2rv1W8shFhZd","type":"assistant","uuid":"f543458d-a1ac-4810-aa38-c083e28b2f64","timestamp":"2026-01-09T03:09:27.929Z"}
{"parentUuid":"f543458d-a1ac-4810-aa38-c083e28b2f64","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_012A8S9HfrYvNsa6trApWACJ","type":"tool_result","content":"  1620→* API documentation\n  1621→* Deployment configuration (IaC)\n  1622→\n  1623→==== Dependencies\n  1624→\n  1625→*Prerequisites*:\n  1626→\n  1627→* WP-CS-003 (Event Bus Infrastructure) completed\n  1628→* Salesforce sandbox environment provisioned\n  1629→* Braze API credentials and campaign templates configured\n  1630→* Microsoft Entra External ID OAuth configuration\n  1631→\n  1632→*Dependent Work Packages*:\n  1633→\n  1634→* WP-CS-003 must be completed first (Event Bus required for async processing)\n  1635→* WP-CS-007 (Salesforce Configuration) must be in progress (field mapping needed)\n  1636→\n  1637→==== Skills Required\n  1638→\n  1639→* Backend development (.NET Core or Node.js)\n  1640→* REST API design and implementation\n  1641→* Salesforce REST API integration\n  1642→* Event-driven architecture patterns\n  1643→* Async/background processing (queues, workers)\n  1644→* Braze API integration\n  1645→* Webhook design and security\n  1646→* OAuth 2.0 / JWT authentication\n  1647→* Domain-Driven Design (DDD) - Anti-Corruption Layer pattern\n  1648→* Unit/integration testing frameworks\n  1649→* Infrastructure as Code (Terraform/CloudFormation)\n  1650→\n  1651→==== Acceptance Criteria\n  1652→\n  1653→* Feedback submission endpoint returns 202 Accepted within p95 < 200ms\n  1654→* Async Case creation succeeds with >99.5% success rate (including retries)\n  1655→* Anti-Corruption Layer correctly maps all feedback categories to Salesforce Case fields\n  1656→* Webhook receiver processes Salesforce Case updates and publishes domain events\n  1657→* Braze push notifications sent successfully for Case updates\n  1658→* Failed Case creation moves to Dead Letter Queue after 5 retry attempts\n  1659→* Unit test coverage > 80%\n  1660→* Integration tests pass with Salesforce sandbox and Braze staging environment\n  1661→\n  1662→=== WP-CS-003: Event Bus Infrastructure\n  1663→\n  1664→==== Description\n  1665→\n  1666→Implement Event Bus infrastructure for domain event publishing using existing AWS infrastructure (SNS+SQS, EventBridge, or Kinesis).\n  1667→\n  1668→==== Deliverables\n  1669→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"8bc34939-bab8-40b0-942a-1b8c113533af","timestamp":"2026-01-09T03:09:28.132Z","toolUseResult":{"type":"text","file":{"filePath":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","content":"* API documentation\n* Deployment configuration (IaC)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-003 (Event Bus Infrastructure) completed\n* Salesforce sandbox environment provisioned\n* Braze API credentials and campaign templates configured\n* Microsoft Entra External ID OAuth configuration\n\n*Dependent Work Packages*:\n\n* WP-CS-003 must be completed first (Event Bus required for async processing)\n* WP-CS-007 (Salesforce Configuration) must be in progress (field mapping needed)\n\n==== Skills Required\n\n* Backend development (.NET Core or Node.js)\n* REST API design and implementation\n* Salesforce REST API integration\n* Event-driven architecture patterns\n* Async/background processing (queues, workers)\n* Braze API integration\n* Webhook design and security\n* OAuth 2.0 / JWT authentication\n* Domain-Driven Design (DDD) - Anti-Corruption Layer pattern\n* Unit/integration testing frameworks\n* Infrastructure as Code (Terraform/CloudFormation)\n\n==== Acceptance Criteria\n\n* Feedback submission endpoint returns 202 Accepted within p95 < 200ms\n* Async Case creation succeeds with >99.5% success rate (including retries)\n* Anti-Corruption Layer correctly maps all feedback categories to Salesforce Case fields\n* Webhook receiver processes Salesforce Case updates and publishes domain events\n* Braze push notifications sent successfully for Case updates\n* Failed Case creation moves to Dead Letter Queue after 5 retry attempts\n* Unit test coverage > 80%\n* Integration tests pass with Salesforce sandbox and Braze staging environment\n\n=== WP-CS-003: Event Bus Infrastructure\n\n==== Description\n\nImplement Event Bus infrastructure for domain event publishing using existing AWS infrastructure (SNS+SQS, EventBridge, or Kinesis).\n\n==== Deliverables\n","numLines":50,"startLine":1620,"totalLines":3319}},"sourceToolAssistantUUID":"f543458d-a1ac-4810-aa38-c083e28b2f64"}
{"parentUuid":"8bc34939-bab8-40b0-942a-1b8c113533af","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01UJi1ZmHje2gNeF6YzKdzys","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Perfect! I can see the structure now. I need to:\n\n1. Add anchors before each work package heading (=== WP-CS-XXX)\n2. Convert the plain text references to xrefs\n\nFor example:\n- Before: `=== WP-CS-003: Event Bus Infrastructure`\n- After: \n```\n[[wp-cs-003]]\n=== WP-CS-003: Event Bus Infrastructure\n```\n\nAnd convert references like:\n- Before: `WP-CS-003 (Event Bus Infrastructure) completed`\n- After: `<<wp-cs-003,WP-CS-003>> (Event Bus Infrastructure) completed`\n\nLet me create a todo list for this task and then make the changes systematically.","signature":"Er8FCkYICxgCKkCoA1ZOCvffcpjVBxyVChihDxSsE8SNQZcH60Vh4ybxXoLSD4IZ3PibSNZx48sqIDwrDOnNHXuzQR8Pz3fZNCkWEgxgWHyuKW5ualHXFZYaDLRhqIxGKab2na02qSIwEhUsMML4Y6V9X+cn0l7BJTdAsvaYfkjxRIuhC7dmZ7tBNzripE7UbDREaVoyD3mBKqYEHBQd9lH9y500KIsQ4Y6Mqa2vEf4u1AP4PIWEbPXaruIHHwXAJ34sDAuWMWihahTsdqaS4RH7rTWOSvgD6WSPbob97gyq1cE6aGWR3WCHJZ3bwmUVbLMAbpgrAZbFpcqMzHXVypATR8KwI4gD/MJJc0GW4FRGt0P/U0cbcQOGaFAxuSu5ouoSnfiMj3p00yZy6YOYH2K2cP0WFexiR3j5A3OXxegnJqswEy0l04n7Oxob7eI/8Ct9ZhxsaJRBxFAOPkbR+FHQywJunHWstvWKmvQJ7a97/SzYmnvR3B6RNkts8v7zp1qQaEPXzpvSM0tIIPMIQJwEWQ0e9sGENGfQsT378QYSCSuMDs9+JRG3EpG3fCUqJUC/7bbGi3/CNNfqKWSphFJLzHk98LFIEDcZC3tW96IPPTamNhjAEUTXKytRfqFWu4t6sGw9Qxq8Ex4oVP4/46Ge0G4wbBztLkUPaYSRNypKNodJdr9nIJW3LRTa+cerfFcy+JfI9zfMQMYtBjSkT59CkJS+uCAGd/bOZdbv4XfaFzc12jNMWiE1ZhksYFtwL2bVTkcwpMwap8EhW7lIljQ7AcWhh2F1gcdC8lsb5KwIqNT9590RovJMlrXvlTA2ORl4cLVXErSGZv4M1MjdkonZgVM5HaSU2cPE00bYGAl3uaDe4tIfMTJxsCH//8jW3HNKYp715WMY6v3A2c02RaP5jlqVPuG/E+2FIBEqV6cLERgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":1003,"cache_read_input_tokens":28572,"cache_creation":{"ephemeral_5m_input_tokens":1003,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWw4yV5Cq2LfmvTmVxK4y","type":"assistant","uuid":"5e456f97-6fc9-4d2a-8ce2-a68685650d8a","timestamp":"2026-01-09T03:09:33.104Z"}
{"parentUuid":"5e456f97-6fc9-4d2a-8ce2-a68685650d8a","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01UJi1ZmHje2gNeF6YzKdzys","type":"message","role":"assistant","content":[{"type":"text","text":"I'll add internal cross-references to link the work packages throughout the Salesforce solution architecture document."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":1003,"cache_read_input_tokens":28572,"cache_creation":{"ephemeral_5m_input_tokens":1003,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWw4yV5Cq2LfmvTmVxK4y","type":"assistant","uuid":"e0f2e146-c44f-4c5e-9991-4f61ccf69faf","timestamp":"2026-01-09T03:09:33.845Z"}
{"parentUuid":"e0f2e146-c44f-4c5e-9991-4f61ccf69faf","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01UJi1ZmHje2gNeF6YzKdzys","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01CNzCKKGGJNuEfHx1JbX38a","name":"TodoWrite","input":{"todos":[{"content":"Add anchor IDs to all 10 work package headings","activeForm":"Adding anchor IDs to work package headings","status":"in_progress"},{"content":"Convert plain text work package references to xrefs","activeForm":"Converting work package references to xrefs","status":"pending"}]}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":1003,"cache_read_input_tokens":28572,"cache_creation":{"ephemeral_5m_input_tokens":1003,"ephemeral_1h_input_tokens":0},"output_tokens":352,"service_tier":"standard"}},"requestId":"req_011CWw4yV5Cq2LfmvTmVxK4y","type":"assistant","uuid":"2bcb0112-14de-4b28-8e26-3c0f045fb59e","timestamp":"2026-01-09T03:09:35.528Z"}
{"parentUuid":"2bcb0112-14de-4b28-8e26-3c0f045fb59e","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01CNzCKKGGJNuEfHx1JbX38a","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"uuid":"7dc29a1a-d591-44e5-b669-0c6b8b765da2","timestamp":"2026-01-09T03:09:35.612Z","toolUseResult":{"oldTodos":[],"newTodos":[{"content":"Add anchor IDs to all 10 work package headings","status":"in_progress","activeForm":"Adding anchor IDs to work package headings"},{"content":"Convert plain text work package references to xrefs","status":"pending","activeForm":"Converting work package references to xrefs"}]},"sourceToolAssistantUUID":"2bcb0112-14de-4b28-8e26-3c0f045fb59e"}
{"parentUuid":"7dc29a1a-d591-44e5-b669-0c6b8b765da2","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01QcFajYDENe8f9Cp8rZgZfd","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now let me add anchors before each work package heading. I'll start by adding them one by one using the Edit tool.","signature":"EpsCCkYICxgCKkD+KZIf1BiDrGdu5VHmfO0V129H7T+gD0h/66duNhI5Sd8CNEwPiR91uCfy4wJr37DY1dLtbcCz9VuthAoA/Vb/EgwcQ6aFfHbtXPl7QSQaDBmacRZSpgM8jC1HNSIwb9/w6/1OhPM1OokrWe7PSsTNnNJ7U6aEzHEczDkzyEOvqKO3Ks+8M0tzknTP454MKoIBTVJmnUCgKFS03KLZdlJfeB7qB24pw+8SVyDxuwI4hInqAJ7M9R8eurXSTYMUv2pXZX5/6vXOvwBMWD52GtnP2/CbQ6no8AwpmT9/JLB6eh4mQWsLtq7wLpXMZ0cYixs0iTaGy7AajX1tA7rNPF/ZDwp9xzLOeHmNQVjgh9jkIOwg9hgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":371,"cache_read_input_tokens":29575,"cache_creation":{"ephemeral_5m_input_tokens":371,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWw4z3CVQ6DbUtkbeac4S","type":"assistant","uuid":"2e7a69bf-e256-46db-8577-e4b3748f7783","timestamp":"2026-01-09T03:09:39.362Z"}
{"parentUuid":"2e7a69bf-e256-46db-8577-e4b3748f7783","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01QcFajYDENe8f9Cp8rZgZfd","type":"message","role":"assistant","content":[{"type":"text","text":"Now I'll add anchor IDs and convert references to cross-links. Let me start by adding anchors to each work package heading."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":371,"cache_read_input_tokens":29575,"cache_creation":{"ephemeral_5m_input_tokens":371,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWw4z3CVQ6DbUtkbeac4S","type":"assistant","uuid":"852462e1-5ddd-4cc6-b655-ecb8e6a3dafd","timestamp":"2026-01-09T03:09:39.938Z"}
{"parentUuid":"852462e1-5ddd-4cc6-b655-ecb8e6a3dafd","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01QcFajYDENe8f9Cp8rZgZfd","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01FTBcFae8wVfvPu88NvCvM9","name":"Edit","input":{"replace_all":false,"file_path":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","old_string":"=== WP-CS-001: ProfileService Development\n\n==== Description","new_string":"[[wp-cs-001]]\n=== WP-CS-001: ProfileService Development\n\n==== Description"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":371,"cache_read_input_tokens":29575,"cache_creation":{"ephemeral_5m_input_tokens":371,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWw4z3CVQ6DbUtkbeac4S","type":"assistant","uuid":"e7bc75bc-9cd3-46f3-a6d6-7ed7d035abf2","timestamp":"2026-01-09T03:09:41.254Z"}
{"parentUuid":"e7bc75bc-9cd3-46f3-a6d6-7ed7d035abf2","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01QcFajYDENe8f9Cp8rZgZfd","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01WTq9oRWFxWRPeHZSsycCZB","name":"Edit","input":{"replace_all":false,"file_path":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","old_string":"=== WP-CS-002: EngagementService Development\n\n==== Description","new_string":"[[wp-cs-002]]\n=== WP-CS-002: EngagementService Development\n\n==== Description"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":371,"cache_read_input_tokens":29575,"cache_creation":{"ephemeral_5m_input_tokens":371,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWw4z3CVQ6DbUtkbeac4S","type":"assistant","uuid":"97bd92e9-4fe7-4821-8725-bbe5035b0268","timestamp":"2026-01-09T03:09:42.352Z"}
{"parentUuid":"97bd92e9-4fe7-4821-8725-bbe5035b0268","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01QcFajYDENe8f9Cp8rZgZfd","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01YaSWH8PNdwJUKLCzWrQ7yS","name":"Edit","input":{"replace_all":false,"file_path":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","old_string":"=== WP-CS-003: Event Bus Infrastructure\n\n==== Description","new_string":"[[wp-cs-003]]\n=== WP-CS-003: Event Bus Infrastructure\n\n==== Description"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":371,"cache_read_input_tokens":29575,"cache_creation":{"ephemeral_5m_input_tokens":371,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWw4z3CVQ6DbUtkbeac4S","type":"assistant","uuid":"555f081d-5003-40a8-870a-d278039b28d2","timestamp":"2026-01-09T03:09:43.403Z"}
{"parentUuid":"555f081d-5003-40a8-870a-d278039b28d2","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01QcFajYDENe8f9Cp8rZgZfd","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_014oSKkcQhHxTkf7PTG7ZgXA","name":"Edit","input":{"replace_all":false,"file_path":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","old_string":"=== WP-CS-004: Contact Migration Tooling\n\n==== Description","new_string":"[[wp-cs-004]]\n=== WP-CS-004: Contact Migration Tooling\n\n==== Description"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":371,"cache_read_input_tokens":29575,"cache_creation":{"ephemeral_5m_input_tokens":371,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWw4z3CVQ6DbUtkbeac4S","type":"assistant","uuid":"8fbea35b-b0bc-42f9-be33-d8757a5ecc76","timestamp":"2026-01-09T03:09:44.468Z"}
{"parentUuid":"8fbea35b-b0bc-42f9-be33-d8757a5ecc76","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01QcFajYDENe8f9Cp8rZgZfd","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01WmE7d1UeKNDFFvLq1fRCUT","name":"Edit","input":{"replace_all":false,"file_path":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","old_string":"=== WP-CS-005: Mobile App Integration\n\n==== Description","new_string":"[[wp-cs-005]]\n=== WP-CS-005: Mobile App Integration\n\n==== Description"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":371,"cache_read_input_tokens":29575,"cache_creation":{"ephemeral_5m_input_tokens":371,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWw4z3CVQ6DbUtkbeac4S","type":"assistant","uuid":"089add43-e042-4a2a-8c0f-d395cb8cee37","timestamp":"2026-01-09T03:09:45.527Z"}
{"parentUuid":"089add43-e042-4a2a-8c0f-d395cb8cee37","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01QcFajYDENe8f9Cp8rZgZfd","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_014QeqD6DGAPXoZpohv5cj9f","name":"Edit","input":{"replace_all":false,"file_path":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","old_string":"=== WP-CS-006: Integration Testing\n\n==== Description","new_string":"[[wp-cs-006]]\n=== WP-CS-006: Integration Testing\n\n==== Description"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":371,"cache_read_input_tokens":29575,"cache_creation":{"ephemeral_5m_input_tokens":371,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWw4z3CVQ6DbUtkbeac4S","type":"assistant","uuid":"dceaeabf-9e7c-4d2d-84fd-34df01f4c7e0","timestamp":"2026-01-09T03:09:46.514Z"}
{"parentUuid":"dceaeabf-9e7c-4d2d-84fd-34df01f4c7e0","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01QcFajYDENe8f9Cp8rZgZfd","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_017RfdD2xHiVBHaP4VaK4stH","name":"Edit","input":{"replace_all":false,"file_path":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","old_string":"=== WP-CS-007: Salesforce Configuration\n\n==== Description","new_string":"[[wp-cs-007]]\n=== WP-CS-007: Salesforce Configuration\n\n==== Description"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":371,"cache_read_input_tokens":29575,"cache_creation":{"ephemeral_5m_input_tokens":371,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWw4z3CVQ6DbUtkbeac4S","type":"assistant","uuid":"a93bc670-aa2d-448a-bff2-6b8d97f382ca","timestamp":"2026-01-09T03:09:47.594Z"}
{"parentUuid":"a93bc670-aa2d-448a-bff2-6b8d97f382ca","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01QcFajYDENe8f9Cp8rZgZfd","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01S5G6uq7XBa3wMUcpkXoEB3","name":"Edit","input":{"replace_all":false,"file_path":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","old_string":"=== WP-CS-008: Contact Data Migration\n\n==== Description","new_string":"[[wp-cs-008]]\n=== WP-CS-008: Contact Data Migration\n\n==== Description"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":371,"cache_read_input_tokens":29575,"cache_creation":{"ephemeral_5m_input_tokens":371,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWw4z3CVQ6DbUtkbeac4S","type":"assistant","uuid":"ba9ad111-e145-4570-95ed-7ec780917cb9","timestamp":"2026-01-09T03:09:48.639Z"}
{"parentUuid":"ba9ad111-e145-4570-95ed-7ec780917cb9","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01QcFajYDENe8f9Cp8rZgZfd","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_018g4kzLPQhT1fzypNNTnige","name":"Edit","input":{"replace_all":false,"file_path":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","old_string":"=== WP-CS-009: Production Deployment\n\n==== Description","new_string":"[[wp-cs-009]]\n=== WP-CS-009: Production Deployment\n\n==== Description"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":371,"cache_read_input_tokens":29575,"cache_creation":{"ephemeral_5m_input_tokens":371,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWw4z3CVQ6DbUtkbeac4S","type":"assistant","uuid":"9fd0d5cf-438f-4dea-99fb-7dcb91943a38","timestamp":"2026-01-09T03:09:49.648Z"}
{"parentUuid":"9fd0d5cf-438f-4dea-99fb-7dcb91943a38","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01QcFajYDENe8f9Cp8rZgZfd","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_012Z8dA689J5jKv4Q4sQyRFk","name":"Edit","input":{"replace_all":false,"file_path":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","old_string":"=== WP-CS-010: Post-Cutover Support\n\n==== Description","new_string":"[[wp-cs-010]]\n=== WP-CS-010: Post-Cutover Support\n\n==== Description"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":371,"cache_read_input_tokens":29575,"cache_creation":{"ephemeral_5m_input_tokens":371,"ephemeral_1h_input_tokens":0},"output_tokens":1506,"service_tier":"standard"}},"requestId":"req_011CWw4z3CVQ6DbUtkbeac4S","type":"assistant","uuid":"802822d6-07e1-41c7-b190-d3974ee3dd86","timestamp":"2026-01-09T03:09:50.742Z"}
{"type":"file-history-snapshot","messageId":"e7bc75bc-9cd3-46f3-a6d6-7ed7d035abf2","snapshot":{"messageId":"e17cae10-3f59-40e7-acba-e9f3a007d772","trackedFileBackups":{"solution_architectures/salesforce_customer_support.adoc":{"backupFileName":"ef19bf3282a777f7@v1","version":1,"backupTime":"2026-01-09T03:10:43.442Z"}},"timestamp":"2026-01-09T03:08:25.579Z"},"isSnapshotUpdate":true}
{"parentUuid":"e7bc75bc-9cd3-46f3-a6d6-7ed7d035abf2","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01FTBcFae8wVfvPu88NvCvM9","type":"tool_result","content":"The file /mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n  1531→|Monitoring, issue resolution, D365 CE retirement\n  1532→\n  1533→|===\n  1534→\n  1535→[[wp-cs-001]]\n  1536→=== WP-CS-001: ProfileService Development\n  1537→\n  1538→==== Description\n  1539→\n  1540→Build ProfileService bounded context microservice implementing Just-In-Time Contact reconciliation with Salesforce Service Cloud.\n  1541→\n  1542→==== Deliverables"}]},"uuid":"b7ffcd9c-aab9-4c12-9191-316b935603e0","timestamp":"2026-01-09T03:10:43.422Z","toolUseResult":{"filePath":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","oldString":"=== WP-CS-001: ProfileService Development\n\n==== Description","newString":"[[wp-cs-001]]\n=== WP-CS-001: ProfileService Development\n\n==== Description","originalFile":"= Salesforce Customer Support - Solution Architecture\n:project-name: Salesforce Customer Support\n:togaf-adm-phase: Phase E: Opportunities & Solutions\n:last-updated: 2026-01-07\n:document-type: Solution Architecture Document\n:status: Discovery\n:version: 0.1\n:domain: Customer Support & Engagement\n:programme-lead:\n:domain-architect: O.Young@otr.com.au\n:architecture-definition: xref:architecture-definitions:salesforce_customer_support.adoc[Architecture Definitions/Salesforce Customer Support]\n:doctype: article\n:toc: left\n:toclevels: 4\n:sectanchors:\n:sectlinks:\n:sectnums:\n:icons: font\n:source-highlighter: highlightjs\n:experimental:\n:description:\n:keywords:\n\n<<<\n== Purpose and Scope\n\n=== Purpose\n\nThis Solution Architecture defines how the Salesforce Customer Support consolidation will be implemented - the specific technology products, configurations, interfaces, and deployment architecture that realise the xref:architecture-definitions:salesforce_customer_support.adoc[Salesforce Customer Support Architecture Definition].\n\nThis solution establishes the **first implementation of OTR's target Domain-Driven Design (DDD) architecture** by deploying two new bounded contexts (`ProfileService` and `EngagementService`) as microservices, consolidating customer support onto Salesforce Service Cloud, and implementing event-driven integration patterns that will serve as the foundation for future bounded contexts (including Flybuys integration).\n\n=== Vision\n\n> Unify customer support across all OTRG channels by consolidating OTR digital customer feedback onto Salesforce Service Cloud, establishing the foundational DDD architecture with ProfileService and EngagementService bounded contexts that protect digital channels from external system changes while enabling support agents to deliver exceptional customer experiences with complete interaction history.\n\n=== Architectural Approach\n\nThis architecture establishes OTR's **first bounded context implementation** using Domain-Driven Design strategic patterns:\n\n* *link:../bounded_context/profile.adoc[ProfileService]* (NEW bounded context): Just-In-Time Contact reconciliation with Salesforce, upsert by email, returns Salesforce Contact ID to digital channels - foundation for future Flybuys partner linking\n* *link:../bounded_context/engagement.adoc[EngagementService]* (NEW bounded context): Customer feedback submission facade, Anti-Corruption Layer for Salesforce Case creation, Braze integration for all outbound customer communications (push, email, SMS), async Case processing via Event Bus\n* *Event-driven integration* (NEW pattern): Domain event publishing using existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis) - first implementation establishing pattern for future bounded contexts\n* *Anti-Corruption Layer*: EngagementService isolates digital channels from Salesforce API changes, translates between OTR domain language and Salesforce Service Cloud API\n* *Conformist Pattern*: ProfileService and EngagementService conform to existing Salesforce configuration (shared Viva Energy instance, multi-tenant governance)\n* *Big bang cutover*: Single deployment after Contact migration, no phased rollout, D365 CE retirement post-cutover\n\n=== Scope\n\n==== In Scope\n\n* Solution Building Blocks (SBBs) - specific technology products and versions\n* Interface specifications (APIs, events, data formats)\n* Data architecture and schema specifications\n* Deployment architecture and infrastructure configuration\n* Transition architecture with migration phases\n* Technical validation criteria and testing approach\n* External system integration specifications\n* Physical data models and API schemas\n\n==== Out of Scope\n\n===== Covered in xref:architecture-definitions:salesforce_customer_support.adoc[Architecture Definition]\n\n* Business requirements and stakeholder analysis\n* Architecture decisions and rationale (ADRs)\n* Bounded context definitions and responsibilities\n* High-level integration patterns (ACL, Conformist, OHS+PL)\n* Business capability mapping and value streams\n* Architecture principles and governance\n\n===== Covered in Other Documents\n\n* Detailed design (class diagrams, sequence diagrams for all flows)\n* Implementation code and unit tests\n* Business case and return-on-investment analysis\n* Operational run books and support procedures\n\n<<<\n=== Architecture Overview\n\n[mermaid]\n----\n---\nconfig:\n  layout: elk\n---\nflowchart TB\n    Customer([\"Customer\"]) -- Uses --> MobileApp[\"Mobile App<br>iOS/Android\"]\n    Customer -- Shops at --> POS[\"OTR/OTR+ POS<br>D365 Commerce\"]\n    MobileApp -- Authenticate --> EntraID[\"Microsoft Entra\"]\n    MobileApp -- Identifies & Reconciles --> ProfileService[\"ProfileService\"]\n    ProfileService <-- Reconcile App User as Salesforce Contact --> Salesforce[\"Salesforce\"]\n    ProfileService -- On Create --> EventBus[\"EventBus\"]\n    EventBus -- Emits CreateUser Event --> LoyaltyService[\"LoyaltyService\"] & EngagementService[\"EngagementService\"]\n    LoyaltyService -- Reconcile Wallet --> EagleEye[\"EagleEye\"]\n    EngagementService -- Reconcile Braze Profile --> Braze[\"Braze\"]\n    EngagementService --> Salesforce\n    D365CE[\"D365CE\"] -- Data Migration --> Salesforce\n    MobileApp -- Submits Feedback --> EngagementService\n\n    Customer:::customer\n    MobileApp:::presentation\n    POS:::presentation\n    EntraID:::external\n    ProfileService:::newService\n    Salesforce:::external\n    EventBus:::infrastructure\n    LoyaltyService:::newService\n    EngagementService:::newService\n    EagleEye:::external\n    Braze:::external\n    D365CE:::external\n    classDef newService fill:#4CAF50,stroke:#2E7D32,stroke-width:3px,color:#fff\n    classDef external fill:#FF9800,stroke:#E65100,stroke-width:2px,color:#fff\n    classDef infrastructure fill:#2196F3,stroke:#0D47A1,stroke-width:2px,color:#fff\n    classDef presentation fill:#9C27B0,stroke:#4A148C,stroke-width:2px,color:#fff\n    classDef customer fill:#607D8B,stroke:#263238,stroke-width:2px,color:#fff\n----\n\n\n==== Key Architectural Patterns\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Pattern |Application |Rationale\n\n|*Anti-Corruption Layer (ACL)*\n|EngagementService → Salesforce Service Cloud\n|Protects digital channels (Mobile App, Web) from Salesforce API changes, translates between OTR domain language and Salesforce Case/Contact model, enables independent evolution of internal domain model\n\n|*Conformist*\n|ProfileService → Salesforce, EngagementService → Salesforce\n|Shared Viva Energy Salesforce instance - we conform to existing configuration, governance, and API contracts (external system we don't control)\n\n|*Backend-for-Frontend (BFF)*\n|EngagementService\n|Aggregates customer feedback submission, Contact lookup, async Case creation, and Braze notification orchestration for digital channel clients\n\n|*Event-Driven Architecture (OHS+PL)*\n|Event Bus (SNS+SQS/EventBridge/Kinesis)\n|Loose coupling between bounded contexts, async domain event publishing (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`), foundation for future bounded contexts\n\n|*Just-In-Time (JIT) Integration*\n|ProfileService → Salesforce Contact reconciliation\n|Reconcile app users as Salesforce Contacts on-demand (upsert by email), no pre-sync required, ensures Salesforce has current Contact data\n\n|*Async Processing*\n|EngagementService Case creation via Event Bus\n|Non-blocking user experience, resilience to Salesforce downtime, automatic retry with exponential backoff, dead letter queue for operations team intervention\n\n|*Strangler Fig*\n|Not applicable\n|Big bang cutover (no gradual migration) - D365 CE fully replaced, not incrementally strangled\n\n|===\n\n<<<\n== Solution Approach\n\n* Deploy xref:bounded-contexts:profile.adoc[ProfileService] and xref:bounded-contexts:engagement.adoc[EngagementService] as bounded context microservices\n* Implement Anti-Corruption Layers (ACLs) for Salesforce and Braze integration\n* Establish event-driven architecture as the foundational integration pattern\n* Big bang cutover (TS-1 → TS-4)\n\n=== Related Documentation\n\nThis solution architecture references detailed technical specifications:\n\n==== Architecture Definition\n\n* xref:architecture-definitions:salesforce_customer_support.adoc[Salesforce Customer Support - Architecture Definition] - Business requirements, architecture decisions (ADRs), bounded context definitions, high-level integration patterns\n\n==== Bounded Context Specifications\n\n* xref:bounded-contexts:profile.adoc[ProfileService Bounded Context] - JIT Contact reconciliation, aggregate definitions\n* xref:bounded-contexts:engagement.adoc[EngagementService Bounded Context] - Customer feedback facade, Anti-Corruption Layer\n\n==== Interface Specifications\n\nDetailed API specifications available in the specifications directory:\n\n* link:../../specifications/rest/profile-service-v1.yaml[ProfileService REST API v1] - OpenAPI 3.0 specification for `/profile/v1` endpoints (includes Salesforce Contact reconciliation `GET /contact-id`)\n* link:../../specifications/rest/engagement-service-v1.yaml[EngagementService REST API v1] - OpenAPI 3.0 specification for `/engagement/v1` endpoints (includes `POST /feedback`)\n* link:../../specifications/events/engagement-events.json[Engagement Domain Events] - CloudEvents 1.0 JSON Schema for `SupportCaseCreated`, `SupportCaseUpdated`, `SupportCaseResolved`, `CustomerFeedbackSubmitted`\n\n==== External System Documentation\n\n* https://developer.salesforce.com/docs/atlas.en-us.api_rest.meta/api_rest/[Salesforce REST API Documentation] - Contact and Case object APIs\n* https://www.braze.com/docs/api/endpoints/messaging/send_messages/post_send_triggered_campaigns/[Braze Campaign Trigger API] - Push notification campaigns\n\n<<<\n== Executive Summary\n\n=== Challenge\n\nOTR digital customers (Mobile App, Web) currently submit feedback and support requests to D365 Customer Engagement, while Viva Energy's broader business units (fuel wholesale, Shell Card customers, other retail channels) use Salesforce Service Cloud. This creates:\n\n* *Fragmented customer support platform*: Customer support data split across two systems, preventing support agents from having a unified view of customer interactions across all channels\n* *Operational inefficiency*: Maintaining two separate customer support platforms increases operational overhead and costs\n* *Poor support experience*: D365 CE is not working well for digital customer support, impacting customer satisfaction and case resolution times\n* *Post-merger consolidation opportunity*: Following Viva Energy's acquisition of OTR, strategic alignment on Salesforce as the enterprise customer support platform\n\n=== Solution\n\nThis architecture establishes the **foundational Domain-Driven Design (DDD) implementation** for OTR's target state architecture by introducing two new bounded contexts (link:../bounded_context/profile.adoc[ProfileService], link:../bounded_context/engagement.adoc[EngagementService]) and event-driven integration patterns:\n\n==== New Bounded Contexts\n\n* *link:../bounded_context/profile.adoc[ProfileService]* (NEW): Just-In-Time (JIT) Contact reconciliation with Salesforce, upsert by email, returns Salesforce Contact ID to Mobile App\n* *link:../bounded_context/engagement.adoc[EngagementService]* (NEW): Customer feedback submission, Anti-Corruption Layer (ACL) for Salesforce Case creation, Braze integration for all outbound customer communications (push, email, SMS), async Case processing via Event Bus\n* *Event Bus* (NEW pattern): Domain event publishing using existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis) - first implementation of event-driven architecture pattern\n\n==== Integration Architecture\n\n* *Salesforce = System of Record*: Salesforce Service Cloud (shared Viva Energy instance) owns Contact and Case data\n* *Conformist Pattern*: ProfileService and EngagementService conform to existing Salesforce configuration and API contracts\n* *Anti-Corruption Layer*: EngagementService protects digital channels from Salesforce API changes, translates between OTR domain language and Salesforce\n* *Async Case Creation*: Non-blocking user experience, resilience to Salesforce downtime, automatic retry with exponential backoff, dead letter queue for failed Cases\n* *Event-Driven Notifications*: Salesforce webhook → EngagementService → Braze for all customer communications (push, email, SMS) on Case status updates\n\n==== Migration Approach\n\n* *Contact Migration*: One-time migration from app-specific database → Salesforce (upsert with flexible matching by email/phone/VCI)\n* *No Case Migration*: Historical D365 CE Cases not migrated (fresh start in Salesforce)\n* *Big Bang Cutover*: Single deployment, no phased rollout or parallel run\n* *D365 CE Retirement*: Complete decommissioning of D365 Customer Engagement post-cutover\n\n=== Key Architectural Significance\n\nThis migration establishes the first implementation of OTR's target DDD architecture:\n\n* First bounded contexts implemented (ProfileService, EngagementService)\n* First event-driven domain event pattern (foundation for future bounded contexts)\n* Foundation for Flybuys integration (ProfileService Contact reconciliation reused)\n* Establishes integration patterns (Conformist, ACL, Event-Driven) for future services\n\n=== Success Criteria\n\n* All digital customer feedback routed to Salesforce Service Cloud within 30 days of launch\n* Support agents have unified customer view across all Viva Energy channels (digital, wholesale, Shell Card, other retail)\n* D365 Customer Engagement decommissioned within 90 days post-cutover\n* Customer satisfaction score improves by 15% within 6 months\n* Average case resolution time decreases by 20% within 6 months\n* Zero data loss during Contact migration (100% validation pass rate)\n* Mobile App feedback submission success rate > 99.5% (including async Case creation)\n\n=== Technical Constraints\n\n* Shared Salesforce instance (Viva Energy multi-tenant environment)\n* Conform to existing Salesforce configuration and governance (data isolation strategy TBD with Salesforce admin team)\n* Contact migration must complete before cutover (no parallel run)\n* Async Case creation mandatory (non-blocking user experience)\n* Expected volume: 100-150 feedback submissions/day from 20k DAU (~0.5-0.75% submission rate), architecture capacity planned for 3x-10x growth\n\n=== Open Technical Decisions (TBD)\n\n* Salesforce Case field mapping for digital feedback categories (App, Service, Order, Rewards, Refund, Delete Account)\n* Salesforce data isolation strategy (Record Types, custom fields, queues)\n* Salesforce REST API authentication method (OAuth 2.0, Connected App, JWT bearer flow)\n* Salesforce webhook mechanism for Case updates (Outbound Messages, Platform Events, Process Builder)\n* Retry policy configuration (attempts, backoff intervals)\n* Salesforce API rate limit strategy (expected volume: 100-150 submissions/day from 20k DAU, capacity planning for 3x-10x growth)\n\n== Technical Requirements\n\n[width=\"100%\",cols=\"8%,92%\",options=\"header\",]\n|===\n|ID |Description\n\n|TR-CS-001\n|Every Mobile App user must have a Salesforce Contact record in Salesforce Service Cloud (shared Viva Energy instance)\n\n|TR-CS-002\n|ProfileService must reconcile Mobile App users as Salesforce Contacts using Just-In-Time (JIT) upsert by email address\n\n|TR-CS-003\n|ProfileService must return Salesforce Contact ID to Mobile App for feedback submission\n\n|TR-CS-004\n|Mobile App must support customer feedback submission with fields: Category (App, Service, Order, Rewards, Refund, Delete Account), Store Name, Time of Visit, Contact Phone Number, Free Text Message\n\n|TR-CS-005\n|EngagementService must create Salesforce Cases asynchronously via Event Bus (non-blocking user experience)\n\n|TR-CS-006\n|EngagementService must acknowledge feedback submission immediately to Mobile App user (\"Feedback submitted\" confirmation)\n\n|TR-CS-007\n|EngagementService must send push notification to customer via Braze when Case is successfully created in Salesforce\n\n|TR-CS-008\n|EngagementService must retry failed Case creation with configurable exponential backoff and dead letter queue for operations team intervention\n\n|TR-CS-009\n|Salesforce must be the System of Record for Contact and Case data (no local persistence in ProfileService or EngagementService)\n\n|TR-CS-010\n|Contact migration from app-specific database to Salesforce must complete before Mobile App cutover (upsert with flexible matching by email/phone/VCI)\n\n|TR-CS-011\n|No Case migration from D365 Customer Engagement to Salesforce (fresh start, historical Cases not migrated)\n\n|TR-CS-012\n|EngagementService must publish domain events (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`) to Event Bus for consumption by other bounded contexts\n\n|TR-CS-013\n|EngagementService must receive Salesforce webhook notifications when Cases are updated/resolved by support agents\n\n|TR-CS-014\n|EngagementService must trigger Braze push notifications to customers when Cases are updated/resolved (via Salesforce webhook → EngagementService → Braze)\n\n|TR-CS-015\n|ProfileService and EngagementService must conform to existing Salesforce configuration and API contracts (Conformist pattern)\n\n|TR-CS-016\n|All changes must be communicated using event-driven architecture via Event Bus (using existing AWS infrastructure: SNS+SQS/EventBridge/Kinesis)\n\n|TR-CS-017\n|Mobile App feedback submission success rate must exceed 99.5% (including async Case creation completion)\n\n|TR-CS-018\n|Contact migration must achieve 100% validation pass rate (zero data loss)\n\n|TR-CS-019\n|D365 Customer Engagement must be fully decommissioned within 90 days post-cutover\n\n|===\n\n== Technical Architecture\n\n=== Technical Capability Requirements\n\n==== Requirements Traceability\n\n[width=\"100%\",cols=\"15%,50%,35%\",options=\"header\",]\n|===\n|Requirement ID |Requirement Summary |Architectural Building Blocks\n\n|TR-CS-001\n|Every Mobile App user must have Salesforce Contact record\n|ABB-CS-001 (ProfileService), ABB-CS-004 (Salesforce), ABB-CS-007 (Contact Migration Tool)\n\n|TR-CS-002\n|ProfileService JIT Contact reconciliation via upsert by email\n|ABB-CS-001 (ProfileService), ABB-CS-004 (Salesforce)\n\n|TR-CS-003\n|ProfileService returns Salesforce Contact ID to Mobile App\n|ABB-CS-001 (ProfileService), ABB-CS-006 (Mobile App)\n\n|TR-CS-004\n|Mobile App supports feedback submission with structured fields\n|ABB-CS-006 (Mobile App), ABB-CS-002 (EngagementService)\n\n|TR-CS-005\n|EngagementService creates Salesforce Cases asynchronously\n|ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus), ABB-CS-004 (Salesforce)\n\n|TR-CS-006\n|EngagementService immediate acknowledgment to Mobile App\n|ABB-CS-002 (EngagementService), ABB-CS-006 (Mobile App)\n\n|TR-CS-007\n|EngagementService sends push notification via Braze on Case creation\n|ABB-CS-002 (EngagementService), ABB-CS-005 (Braze)\n\n|TR-CS-008\n|EngagementService retry logic with exponential backoff and DLQ\n|ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus)\n\n|TR-CS-009\n|Salesforce is System of Record for Contact and Case data\n|ABB-CS-004 (Salesforce), ABB-CS-001 (ProfileService - stateless), ABB-CS-002 (EngagementService - stateless)\n\n|TR-CS-010\n|Contact migration before Mobile App cutover\n|ABB-CS-007 (Contact Migration Tool), ABB-CS-004 (Salesforce)\n\n|TR-CS-011\n|No Case migration from D365 CE (fresh start)\n|ABB-CS-004 (Salesforce) - no migration tooling required\n\n|TR-CS-012\n|EngagementService publishes domain events to Event Bus\n|ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus)\n\n|TR-CS-013\n|EngagementService receives Salesforce webhook notifications\n|ABB-CS-002 (EngagementService), ABB-CS-004 (Salesforce)\n\n|TR-CS-014\n|EngagementService triggers Braze notifications on Case updates\n|ABB-CS-002 (EngagementService), ABB-CS-004 (Salesforce), ABB-CS-005 (Braze)\n\n|TR-CS-015\n|ProfileService and EngagementService conform to Salesforce config\n|ABB-CS-001 (ProfileService), ABB-CS-002 (EngagementService), ABB-CS-004 (Salesforce)\n\n|TR-CS-016\n|Event-driven architecture via Event Bus\n|ABB-CS-003 (Event Bus), ABB-CS-002 (EngagementService)\n\n|TR-CS-017\n|Mobile App feedback submission success rate > 99.5%\n|ABB-CS-006 (Mobile App), ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus), ABB-CS-004 (Salesforce)\n\n|TR-CS-018\n|Contact migration 100% validation pass rate\n|ABB-CS-007 (Contact Migration Tool), ABB-CS-004 (Salesforce)\n\n|TR-CS-019\n|D365 CE decommissioned within 90 days post-cutover\n|All ABBs (replacement system operational)\n\n|===\n\n=== Service Catalogues\n\n==== Application Portfolio Catalogue\n\n[width=\"100%\",cols=\"20%,15%,15%,15%,35%\",options=\"header\",]\n|===\n|Application |Lifecycle State |Owner |Hosting Platform |Description\n\n|*ProfileService*\n|NEW\n|OTR Platform Team\n|AWS (TBD: Lambda/ECS/EKS)\n|JIT Contact reconciliation with Salesforce, returns Salesforce Contact ID, foundation for Flybuys integration\n\n|*EngagementService*\n|NEW\n|OTR Platform Team\n|AWS (TBD: Lambda/ECS/EKS)\n|Customer feedback submission facade, ACL for Salesforce Case creation, Braze integration for all outbound communications (push, email, SMS), webhook receiver\n\n|*Mobile App (iOS)*\n|ACTIVE (UPDATE)\n|OTR Mobile Team\n|Apple App Store\n|iOS native app with feedback form, integrate with ProfileService and EngagementService APIs\n\n|*Mobile App (Android)*\n|ACTIVE (UPDATE)\n|OTR Mobile Team\n|Google Play Store\n|Android native app with feedback form, integrate with ProfileService and EngagementService APIs\n\n|*Salesforce Service Cloud*\n|ACTIVE (EXPAND)\n|Viva Energy Salesforce Admin Team\n|Salesforce (SaaS)\n|Shared Viva Energy instance, System of Record for Contact and Case data, adding OTR digital customer support\n\n|*Braze*\n|ACTIVE (EXTEND)\n|OTR Marketing Team\n|Braze (SaaS)\n|Marketing automation platform, EngagementService triggers push notifications for Case updates\n\n|*D365 Customer Engagement*\n|RETIRE\n|OTR Support Team\n|Microsoft Azure (SaaS)\n|Legacy customer support platform, decommissioned within 90 days post-cutover\n\n|*App-Specific Customer Database*\n|RETIRE\n|OTR Platform Team\n|AWS (RDS/DynamoDB)\n|Legacy customer contact storage, one-time migration to Salesforce, then deprecated\n\n|*Event Bus*\n|NEW\n|OTR Platform Team\n|AWS (SNS+SQS/EventBridge/Kinesis)\n|Domain event publishing infrastructure for bounded context integration\n\n|*Contact Migration Tool*\n|TEMPORARY\n|OTR Platform Team\n|AWS (Script/Lambda)\n|One-time migration app database → Salesforce with upsert logic, retired after migration complete\n\n|===\n\n==== Technology Capability Requirements\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Technology Capability |Implementation Technology (TBD in detailed design) |Requirements\n\n|*Microservice Hosting*\n|AWS Lambda / ECS / EKS\n|Host ProfileService and EngagementService with auto-scaling, high availability, monitoring\n\n|*API Gateway*\n|AWS API Gateway / Application Load Balancer\n|REST API routing, authentication, rate limiting, request validation for ProfileService and EngagementService\n\n|*Event Bus*\n|AWS SNS+SQS / EventBridge / Kinesis\n|Domain event publishing, async message processing, retry logic, dead letter queue\n\n|*Salesforce Integration*\n|Salesforce REST API / SOAP API\n|Contact CRUD operations, Case creation, webhook notifications, OAuth 2.0 authentication\n\n|*Braze Integration*\n|Braze REST API / SDK\n|Push notification campaign triggers, customer profile reconciliation\n\n|*Authentication & Authorisation*\n|Microsoft Entra External ID / AWS Cognito\n|Mobile App user authentication, API authorisation, JWT token validation\n\n|*Observability & Monitoring*\n|AWS CloudWatch / Datadog / New Relic\n|Application metrics, logs, traces, dashboards, alerting (feedback submission rate, queue depth, API errors)\n\n|*Secret Management*\n|AWS Secrets Manager / Parameter Store\n|Salesforce credentials, Braze API keys, OAuth tokens, encryption keys\n\n|*Database (Migration Tool)*\n|AWS RDS / DynamoDB (read-only access)\n|Contact migration from app-specific database\n\n|*CI/CD Pipeline*\n|GitHub Actions / AWS CodePipeline\n|Automated build, test, deployment for ProfileService, EngagementService, Mobile App\n\n|*Infrastructure as Code*\n|Terraform / AWS CloudFormation / CDK\n|Declarative infrastructure provisioning for Event Bus, microservices, monitoring\n\n|*API Documentation*\n|OpenAPI / Swagger\n|ProfileService and EngagementService API specifications for Mobile App integration\n\n|===\n\n==== Feature Flag Register\n\n*Note*: Per ADR-CS-006 (big bang cutover, not phased rollout), feature flags are minimal and used primarily for emergency rollback/kill switches.\n\n[width=\"100%\",cols=\"20%,15%,35%,30%\",options=\"header\",]\n|===\n|Feature Flag |Default State |Purpose |Rollback Scenario\n\n|*enable_salesforce_feedback_submission*\n|OFF (pre-cutover), ON (post-cutover)\n|Enable/disable feedback submission to EngagementService → Salesforce (kill switch for emergency rollback to D365 CE)\n|Feedback submission success rate < 95%, Salesforce API failures, critical bugs - revert to D365 CE integration\n\n|*enable_async_case_creation*\n|ON\n|Enable/disable async Case creation via Event Bus (fallback to synchronous processing if Event Bus issues)\n|Event Bus infrastructure failures, queue backlog unmanageable - temporary synchronous processing\n\n|*enable_braze_notifications*\n|ON\n|Enable/disable Braze push notifications for Case updates (degrade gracefully if Braze integration fails)\n|Braze API failures, notification delivery rate < 80% - disable notifications temporarily\n\n|*enable_jit_contact_reconciliation*\n|ON\n|Enable/disable ProfileService JIT Contact reconciliation (fallback to cached Contact IDs if Salesforce unavailable)\n|Salesforce API downtime, Contact reconciliation failures > 5% - use cached Contact IDs temporarily\n\n|*enable_salesforce_webhook_processing*\n|ON\n|Enable/disable Salesforce webhook processing for Case updates (fallback to polling if webhook failures)\n|Webhook delivery failures, authentication issues - temporary polling fallback\n\n|===\n\n*Feature Flag Management*:\n\n* Feature flags managed via AWS AppConfig / LaunchDarkly / custom feature flag service (TBD in detailed design)\n* Mobile App feature flags controlled server-side (no app release required for flag changes)\n* Backend service feature flags configured via environment variables / configuration service\n* Feature flag changes logged and audited (who changed, when, reason)\n* Post-cutover monitoring: Gradual removal of feature flags once system stability confirmed (30-60 days)\n\n==== Data Entity Catalogue\n\n[width=\"100%\",cols=\"20%,15%,35%,30%\",options=\"header\",]\n|===\n|Data Entity |System of Record |Key Attributes |Lifecycle\n\n|*Contact*\n|Salesforce Service Cloud\n|• Contact ID (Salesforce 15/18-char ID) +\n• Email (primary matching key) +\n• First Name, Last Name +\n• Phone Number +\n• Viva Consumer ID (VCI) +\n• Account (Viva Energy customer account) +\n• Record Type (OTR Digital vs other channels)\n|Created: ProfileService JIT reconciliation or Contact Migration Tool +\nUpdated: ProfileService JIT upsert (email changes), Salesforce (manual updates by support agents) +\nDeleted: Salesforce retention policy (GDPR/compliance)\n\n|*Case*\n|Salesforce Service Cloud\n|• Case Number (Salesforce auto-generated) +\n• Contact ID (reference to Contact) +\n• Subject (derived from Category) +\n• Description (Free Text Message) +\n• Category (App, Service, Order, Rewards, Refund, Delete Account) +\n• Store Name (OTR location) +\n• Time of Visit +\n• Status (New, In Progress, Resolved, Closed) +\n• Priority, Origin (Mobile App) +\n• Owner (support agent/queue)\n|Created: EngagementService async Case creation +\nUpdated: Support agents (Salesforce UI), EngagementService (webhook processing) +\nDeleted: Salesforce retention policy (archive after X years)\n\n|*Feedback Submission (transient)*\n|None (not persisted)\n|• Salesforce Contact ID +\n• Category +\n• Store Name +\n• Time of Visit +\n• Contact Phone Number +\n• Free Text Message\n|Created: Mobile App user submission +\nProcessed: EngagementService publishes to Event Bus, Case created in Salesforce +\nNot persisted in ProfileService/EngagementService (stateless)\n\n|*Domain Events*\n|Event Bus (ephemeral)\n|**SupportCaseCreated**: +\n• Case Number, Contact ID, Category, Timestamp +\n**SupportCaseUpdated**: +\n• Case Number, Status, Updated By, Timestamp +\n**SupportCaseResolved**: +\n• Case Number, Resolution, Resolved By, Timestamp +\n**CustomerFeedbackSubmitted**: +\n• Contact ID, Category, Timestamp\n|Published: EngagementService +\nConsumed: Other bounded contexts (future), Braze notification triggers +\nRetention: Short-lived (minutes to hours), not persisted for event sourcing\n\n|*Braze Customer Profile*\n|Braze\n|• External User ID (VCI or Email) +\n• Push Notification Tokens (iOS/Android) +\n• Notification Preferences +\n• Campaign Engagement History\n|Created/Updated: EngagementService on Case creation/update +\nManaged: Braze (external SaaS)\n\n|===\n\n*Data Migration Entities*:\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Source Entity |Target Entity |Migration Strategy\n\n|*App Database Contact*\n|Salesforce Contact\n|One-time migration via Contact Migration Tool: +\n• Upsert by email (primary), phone (secondary), VCI (tertiary) +\n• Map: Email → Email, Name → First/Last Name, Phone → Phone, VCI → External ID +\n• Validation: 100% data integrity check, reconciliation report\n\n|*D365 CE Case*\n|Not migrated\n|ADR-CS-005: No Case migration (fresh start in Salesforce) +\nD365 CE Cases archived separately for compliance if needed\n\n|===\n\n==== Data Quality & Validation\n\n*Contact Migration Validation Rules*:\n\n* Email format validation (RFC 5322 compliance)\n* Phone number format validation (E.164 international format)\n* VCI format validation (alphanumeric, length constraints)\n* Duplicate detection: Flag potential duplicates for manual review (same email/phone combination)\n* Mandatory fields: Email (required), First Name, Last Name (required for Salesforce Contact)\n\n*Case Creation Validation Rules*:\n\n* Contact ID must exist in Salesforce (validated by EngagementService before Case creation)\n* Category must be one of: App, Service, Order, Rewards, Refund, Delete Account\n* Free Text Message maximum length: 32,000 characters (Salesforce Case Description limit)\n* Store Name validated against OTR location master data (optional - warn if not found)\n\n<<<\n== Solution Building Blocks\n\nThis section defines the specific technology products, configurations, and implementation details for each Solution Building Block (SBB).\n\n=== Technology Portfolio Catalogue\n\n[width=\"100%\",cols=\"10%,20%,25%,25%,20%\",options=\"header\",]\n|===\n|SBB ID |Component |Technology Product |Version/Configuration |Deployment Platform\n\n|SBB-CS-001\n|ProfileService Microservice\n|.NET 8 / Node.js 20 LTS\n|RESTful API, containerised\n|AWS ECS Fargate / Lambda\n\n|SBB-CS-002\n|EngagementService Microservice\n|.NET 8 / Node.js 20 LTS\n|RESTful API, containerised, async workers\n|AWS ECS Fargate / Lambda\n\n|SBB-CS-003\n|Event Bus\n|AWS SNS + SQS / EventBridge\n|Standard queues, FIFO for ordering\n|AWS (managed service)\n\n|SBB-CS-004\n|API Gateway\n|AWS API Gateway / ALB\n|REST API, JWT validation\n|AWS (managed service)\n\n|SBB-CS-005\n|Salesforce Integration Layer\n|Salesforce REST API Client\n|OAuth 2.0 JWT bearer flow\n|Embedded in SBB-CS-001/002\n\n|SBB-CS-006\n|Braze Integration Layer\n|Braze REST API SDK\n|API key authentication\n|Embedded in SBB-CS-002\n\n|SBB-CS-007\n|Contact Migration Tool\n|Python 3.11 / .NET 8\n|One-time batch script\n|AWS Lambda / EC2\n\n|SBB-CS-008\n|Application Monitoring\n|AWS CloudWatch / Datadog\n|Metrics, logs, traces, dashboards\n|AWS / SaaS\n\n|SBB-CS-009\n|Secret Management\n|AWS Secrets Manager\n|KMS encryption\n|AWS (managed service)\n\n|SBB-CS-010\n|Mobile App (iOS)\n|SwiftUI, Kotlin Multiplatform\n|iOS 15+\n|Apple App Store\n\n|SBB-CS-011\n|Mobile App (Android)\n|Jetpack Compose, Kotlin Multiplatform\n|Android 8+\n|Google Play Store\n\n|SBB-CS-012\n|Feature Flag Service\n|AWS AppConfig / LaunchDarkly\n|Server-side flags, real-time updates\n|AWS / SaaS\n\n|===\n\n<<<\n== Data Architecture\n\nThis section defines the physical data models, event schemas, and API request/response formats.\n\n=== Domain Event Schemas\n\nAll domain events follow the https://cloudevents.io/[CloudEvents 1.0] specification for consistency and interoperability.\n\n*Event Schema Specifications*: See // TODO: Add to Antora - specifications/events/engagement-events.json[Engagement Service Event Schemas] for complete JSON schemas and examples.\n\n==== Event Catalogue\n\n[width=\"100%\",cols=\"30%,20%,50%\",options=\"header\",]\n|===\n|Event Type |Publisher |Description\n\n|`SupportCaseCreated`\n|EngagementService\n|Published when EngagementService successfully creates a Case in Salesforce after async processing\n\n|`SupportCaseUpdated`\n|EngagementService (via Salesforce webhook)\n|Published when a support agent updates a Case in Salesforce (status, priority, comment changes)\n\n|`SupportCaseResolved`\n|EngagementService (via Salesforce webhook)\n|Published when a support agent resolves/closes a Case in Salesforce\n\n|`CustomerFeedbackSubmitted`\n|EngagementService\n|Published when customer submits feedback via Mobile App (before async Case creation)\n\n|===\n\n*Event Format*: All events use CloudEvents 1.0 envelope with event-specific payload in the `data` field.\n\n*Schema Location*: `specifications/events/engagement-events.json`\n\n=== API Request/Response Schemas\n\n==== ProfileService: GET /profile/contact-id\n\n*Response* (200 OK):\n[source,json]\n----\n{\n  \"contactId\": \"0034X00000ABCDEFG\",\n  \"email\": \"customer@example.com\",\n  \"firstName\": \"John\",\n  \"lastName\": \"Smith\"\n}\n----\n\n==== EngagementService: POST /feedback\n\n*Request*:\n[source,json]\n----\n{\n  \"contactId\": \"0034X00000ABCDEFG\",\n  \"category\": \"App\",\n  \"storeName\": \"OTR Adelaide\",\n  \"timeOfVisit\": \"2026-01-07T12:00:00Z\",\n  \"contactPhoneNumber\": \"+61412345678\",\n  \"message\": \"App crashed when submitting feedback\"\n}\n----\n\n*Response* (202 Accepted):\n[source,json]\n----\n{\n  \"feedbackId\": \"fb-2026-01-07-12345\",\n  \"status\": \"submitted\",\n  \"message\": \"Your feedback has been submitted!\"\n}\n----\n\n=== Salesforce Field Mappings\n\n==== Case Object Mapping\n\n[width=\"100%\",cols=\"25%,25%,25%,25%\",options=\"header\",]\n|===\n|OTR Field |Salesforce Field |Data Type |Notes\n\n|Category\n|Feedback_Category__c\n|Picklist\n|App, Service, Order, Rewards, Refund, Delete Account\n\n|Store Name\n|Store_Name__c\n|String (255)\n|OTR location name\n\n|Time of Visit\n|Time_of_Visit__c\n|DateTime\n|When customer visited store\n\n|Free Text Message\n|Description\n|Long Text (32,000)\n|Customer feedback message\n\n|===\n\n<<<\n=== Baseline Architecture\n\n==== Existing System Components\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Component |Current State |Status\n\n|*D365 Customer Engagement*\n|Customer support platform for OTR digital customers (Mobile App, Web), handles feedback submission and case management\n|**DEPRECATED** - Being replaced by Salesforce Service Cloud\n\n|*App-Specific Customer Database*\n|Stores customer contact data for Mobile App users, separate from Viva Energy systems\n|**MIGRATING** - One-time migration to Salesforce, then deprecated\n\n|*Mobile App*\n|iOS/Android native apps with feedback submission form including Category, Store Name, Time of Visit, Contact Phone Number, and Free Text Message fields\n|**REQUIRES UPDATE** - Integrate with ProfileService and EngagementService APIs (feedback form UI already complete)\n\n|*Salesforce Service Cloud*\n|Shared Viva Energy instance handling customer support for fuel wholesale, Shell Card customers, other retail channels\n|**EXPANDING** - Adding OTR digital customer support Cases and Contacts\n\n|*Existing AWS Infrastructure*\n|SNS+SQS / EventBridge / Kinesis available for event-driven architecture\n|**REUSING** - Event Bus implementation leverages existing infrastructure\n\n|===\n\n==== Integration Architecture\n\n*Current state:*\n\n* Mobile App → D365 Customer Engagement (direct integration)\n* App-specific customer database → standalone (no Salesforce integration)\n* No event-driven architecture (synchronous, tightly coupled)\n* No Anti-Corruption Layer protecting digital channels\n* Viva Energy support teams use Salesforce, OTR digital support uses D365 CE (fragmented)\n\n==== Technical Debt\n\n*No longer relevant* - D365 CE being deprecated, not documenting technical debt of system being retired.\n\n*New technical debt introduced by this migration:*\n\n* Salesforce field mapping TBD (requires coordination with Viva Energy Salesforce admin team)\n* Data isolation strategy TBD (Record Types, custom fields, queues - multi-tenant governance)\n* Salesforce webhook mechanism TBD (Outbound Messages vs Platform Events vs Process Builder)\n* Expected feedback volume unknown (gathering data for rate limit planning)\n\n=== Gap Analysis\n\n==== Missing Capabilities\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Missing Capability |Description\n\n|*ProfileService bounded context*\n|No existing service for Contact reconciliation with Salesforce - requires new microservice implementing JIT upsert by email, returning Salesforce Contact ID\n\n|*EngagementService bounded context*\n|No existing service for customer feedback facade - requires new microservice implementing Anti-Corruption Layer for Salesforce Case creation, Braze integration, async processing via Event Bus\n\n|*Event Bus domain event pattern*\n|No existing domain event publishing infrastructure - requires implementing event-driven architecture pattern using existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis)\n\n|*Async Case creation workflow*\n|Current D365 CE integration is synchronous - requires implementing async processing with retry logic, exponential backoff, dead letter queue\n\n|*Salesforce webhook integration*\n|No existing capability to receive Salesforce notifications - requires implementing webhook receiver in EngagementService for Case update notifications\n\n|*Braze push notification orchestration*\n|No existing integration for Case-related push notifications - requires implementing Braze campaign triggers from EngagementService\n\n|*Contact migration tooling*\n|No existing tooling for app database → Salesforce Contact migration with upsert logic (match by email/phone/VCI)\n\n|*Feedback form enhancements*\n|Mobile App feedback form lacks structured fields (Category, Store Name, Time of Visit, Contact Phone Number) - requires UI updates\n\n|===\n\n==== Missing Bounded Contexts\n\n[width=\"100%\",cols=\"30%,30%,40%\",options=\"header\",]\n|===\n|Bounded Context |Responsibilities |Implementation Status\n\n|*link:../bounded_context/profile.adoc[ProfileService]*\n|JIT Contact reconciliation with Salesforce (upsert by email), return Salesforce Contact ID to digital channels, foundation for future Flybuys partner linking\n|**NEW** - First bounded context implementation\n\n|*link:../bounded_context/engagement.adoc[EngagementService]*\n|Customer feedback submission facade, Anti-Corruption Layer for Salesforce Case creation, Braze integration for push notifications, async Case processing, webhook receiver for Case updates\n|**NEW** - First bounded context implementation\n\n|===\n\n==== Missing Integration Patterns\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Integration Pattern |Description\n\n|*Anti-Corruption Layer (ACL)*\n|EngagementService → Salesforce Service Cloud - protects digital channels from Salesforce API changes, translates between OTR domain language and Salesforce\n\n|*Conformist*\n|ProfileService/EngagementService → Salesforce - conform to existing Salesforce configuration and API contracts (shared Viva Energy instance)\n\n|*Event-Driven Architecture (OHS+PL)*\n|Event Bus publishing domain events (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`) for loose coupling between bounded contexts\n\n|*Just-In-Time (JIT) Integration*\n|ProfileService → Salesforce Contact reconciliation on-demand (no pre-sync)\n\n|*Async Processing*\n|EngagementService Case creation via Event Bus with retry, exponential backoff, dead letter queue\n\n|===\n\n=== Target State Architecture\n\n==== Architectural Building Blocks (ABB)\n\n[width=\"100%\",cols=\"20%,25%,30%,25%\",options=\"header\",]\n|===\n|ABB ID |Bounded Context |Responsibilities |Technology (TBD in Solution Architecture)\n\n|ABB-CS-001\n|*link:../bounded_context/profile.adoc[ProfileService]*\n|JIT Contact reconciliation with Salesforce (upsert by email), return Salesforce Contact ID, foundation for Flybuys partner linking\n|Microservice (.NET/Node.js), REST API, Salesforce REST API client\n\n|ABB-CS-002\n|*link:../bounded_context/engagement.adoc[EngagementService]*\n|Customer feedback submission facade, ACL for Salesforce Case creation, Braze integration, async processing, webhook receiver\n|Microservice (.NET/Node.js), REST API, Event Bus publisher/subscriber, Salesforce webhook receiver\n\n|ABB-CS-003\n|*Event Bus*\n|Domain event publishing infrastructure (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`)\n|AWS SNS+SQS / EventBridge / Kinesis\n\n|ABB-CS-004\n|*Salesforce Service Cloud*\n|System of Record for Contact and Case data (shared Viva Energy instance)\n|Salesforce Service Cloud (external SaaS)\n\n|ABB-CS-005\n|*Braze*\n|Marketing automation platform for push notifications\n|Braze (external SaaS) - existing integration\n\n|ABB-CS-006\n|*Mobile App*\n|iOS/Android native apps with enhanced feedback form (Category, Store Name, Time of Visit, Contact Phone Number, Free Text Message)\n|Kotlin Multiplatform, SwiftUI, Jetpack Compose\n\n|ABB-CS-007\n|*Contact Migration Tool*\n|One-time migration app database → Salesforce with upsert logic (match by email/phone/VCI)\n|Script/tool (.NET/Python/Node.js)\n\n|===\n\n==== Integration Architecture\n\n===== Integration Flows\n\n*Customer Feedback Submission (Async):*\n\n1. *Mobile App* → ProfileService: Authenticate user, get Salesforce Contact ID (JIT reconciliation)\n2. *Mobile App* → EngagementService: Submit feedback (POST /feedback with Contact ID, Category, Store Name, Time of Visit, Phone, Message)\n3. *EngagementService* → Mobile App: Immediate acknowledgment (\"Feedback submitted\")\n4. *EngagementService* → Event Bus: Publish work item for async Case creation\n5. *Background Worker* (EngagementService) → Salesforce: Create Case via REST API\n6. *Success*: EngagementService → Event Bus: Publish `SupportCaseCreated` event\n7. *EngagementService* → Braze: Trigger push notification campaign (\"Your feedback has been received, Case #12345\")\n8. *Failure*: Retry with exponential backoff → Dead Letter Queue → Ops team alert\n\n*Case Update Notification (Bidirectional):*\n\n1. *Support Agent* updates/resolves Case in Salesforce\n2. *Salesforce* → EngagementService: Webhook notification (Case updated)\n3. *EngagementService* → Event Bus: Publish `SupportCaseUpdated` or `SupportCaseResolved` event\n4. *EngagementService* → Braze: Trigger push notification campaign (\"Your case has been resolved\")\n\n*Contact Reconciliation (JIT):*\n\n1. *Mobile App user* authenticates\n2. *Mobile App* → ProfileService: GET /profile/contact-id\n3. *ProfileService* → Salesforce: Query Contact by email\n4. *Match found*: Return existing Salesforce Contact ID\n5. *No match*: Create new Contact in Salesforce, return new Contact ID\n6. *ProfileService* → Mobile App: Return Salesforce Contact ID (cached by Mobile App)\n\n===== System of Record Boundaries\n\n[width=\"100%\",cols=\"30%,35%,35%\",options=\"header\",]\n|===\n|Data Entity |System of Record |Rationale\n\n|*Contact*\n|Salesforce Service Cloud\n|Shared Viva Energy instance, unified customer profile across all channels (digital, wholesale, Shell Card, retail)\n\n|*Case*\n|Salesforce Service Cloud\n|Support agents manage Cases in Salesforce, digital channels submit via EngagementService ACL\n\n|*Feedback Submission (transient)*\n|None (no persistence)\n|EngagementService processes feedback and creates Case in Salesforce, no local storage\n\n|*Domain Events*\n|Event Bus (ephemeral)\n|Events published to Event Bus, consumed by subscribers, not persisted long-term (event sourcing not in scope)\n\n|===\n\n==== Data Architecture Principles\n\n===== Aggregate Persistence\n\n*ProfileService:*\n\n* **No local aggregate persistence** - ProfileService is stateless, queries Salesforce on-demand\n* Salesforce Contact is the aggregate root (owned by Salesforce)\n* ProfileService acts as facade/translator, not system of record\n\n*EngagementService:*\n\n* **No local aggregate persistence** - EngagementService is stateless, creates Cases in Salesforce via ACL\n* Salesforce Case is the aggregate root (owned by Salesforce)\n* EngagementService maintains no local Case state (Conformist pattern - trust Salesforce as source of truth)\n* Async processing state managed via Event Bus (work items in queue, not database)\n\n===== Event Store\n\n* **Event Bus** (SNS+SQS/EventBridge/Kinesis) handles domain event publishing\n* Events are **ephemeral** (consumed and discarded, not persisted for event sourcing)\n* No Event Store implementation in this architecture (future enhancement if needed)\n* Event schema versioning TBD in Solution Architecture\n\n\n=== Architecture Decisions\n\n==== ADR-CS-001: Consolidate onto Salesforce Service Cloud (not build custom solution)\n\n*Status*: Accepted\n\n*Context*:\n\n* D365 Customer Engagement not working well for digital customer support\n* Viva Energy already uses Salesforce Service Cloud for fuel wholesale, Shell Card, other retail channels\n* Post-merger opportunity to consolidate onto single platform\n* Alternative: Build custom support platform or use different SaaS\n\n*Decision*:\n\nConsolidate OTR digital customer support onto Salesforce Service Cloud (shared Viva Energy instance).\n\n*Rationale*:\n\n* **Unified customer view**: Support agents see all interactions across channels (digital, wholesale, Shell Card, retail)\n* **Platform consolidation**: Single support platform reduces operational overhead and costs\n* **Proven solution**: Salesforce Service Cloud is established, feature-rich, well-supported\n* **Post-merger alignment**: Strategic decision to standardize on Viva Energy platforms\n* **Avoid custom development**: Building custom support platform would be costly and high-risk\n\n*Consequences*:\n\n* Unified customer support across Viva Energy Group\n* Reduced operational complexity (single platform vs two)\n* Leverage Salesforce capabilities (case routing, knowledge base, AI, omnichannel)\n* ⚠️ Conformist pattern required (shared instance, conform to existing configuration)\n* ⚠️ Multi-tenant governance needed (data isolation, security, queues)\n* ❌ Less control over platform evolution (SaaS vendor, shared instance)\n\n==== ADR-CS-002: Implement ProfileService and EngagementService as first DDD bounded contexts\n\n*Status*: Accepted\n\n*Context*:\n\n* OTR target architecture uses Domain-Driven Design with bounded contexts\n* This migration is opportunity to establish first implementation\n* Alternative: Direct Mobile App → Salesforce integration (no bounded contexts)\n* Alternative: Single monolithic service for all customer-facing APIs\n\n*Decision*:\n\nImplement ProfileService and EngagementService as separate bounded contexts following DDD strategic patterns.\n\n*Rationale*:\n\n* **Foundation for target architecture**: First implementation of DDD pattern for future bounded contexts (Flybuys, LocationService, PaymentService)\n* **Separation of concerns**: ProfileService handles identity/Contact reconciliation, EngagementService handles support/feedback (different responsibilities, different change rates)\n* **Anti-Corruption Layer**: EngagementService protects digital channels from Salesforce API changes\n* **Reusability**: ProfileService Contact reconciliation reused for Flybuys integration\n* **Event-driven architecture**: Establishes pattern for loose coupling between bounded contexts\n\n*Consequences*:\n\n* Establishes DDD architecture foundation for OTR\n* Reusable ProfileService for Flybuys and future integrations\n* Digital channels protected from Salesforce API changes (ACL)\n* Clear bounded context boundaries and responsibilities\n* ⚠️ Increased initial complexity (two new microservices vs direct integration)\n* ⚠️ Requires Event Bus infrastructure implementation\n* ⚠️ Team must learn DDD patterns and bounded context design\n\n==== ADR-CS-003: Async Case creation via Event Bus (not synchronous)\n\n*Status*: Accepted\n\n*Context*:\n\n* Current D365 CE integration is synchronous (user waits for Case creation)\n* Alternative: Keep synchronous integration (Mobile App → EngagementService → Salesforce synchronously)\n* Salesforce API may experience downtime or latency\n\n*Decision*:\n\nImplement async Case creation via Event Bus with immediate user acknowledgment, retry logic, exponential backoff, and dead letter queue.\n\n*Rationale*:\n\n* **Non-blocking user experience**: User gets immediate \"Feedback submitted\" confirmation, not waiting for Salesforce API\n* **Resilience**: If Salesforce is down, feedback still accepted, Case created when Salesforce recovers\n* **Retry logic**: Automatic retry with exponential backoff handles transient failures\n* **Operational visibility**: Dead letter queue alerts ops team to persistent failures\n* **Scalability**: Queue buffering handles traffic spikes\n\n*Consequences*:\n\n* Better user experience (no waiting for Salesforce API)\n* Resilient to Salesforce downtime (queue buffers work)\n* Automatic retry reduces manual intervention\n* Queue depth monitoring provides operational visibility\n* ⚠️ Eventual consistency (user gets success notification after Case created, not immediately)\n* ⚠️ Increased complexity (Event Bus, background workers, retry logic, DLQ)\n* ⚠️ Requires monitoring and alerting for DLQ\n\n==== ADR-CS-004: ProfileService uses email as primary matching key (not VCI)\n\n*Status*: Accepted\n\n*Context*:\n\n* ProfileService needs to reconcile Mobile App users as Salesforce Contacts\n* Alternative matching keys: VCI (Viva Consumer ID), email, phone, Salesforce External ID\n* Email changes are rare but possible\n\n*Decision*:\n\nUse email address as primary matching key for Contact reconciliation (JIT upsert by email).\n\n*Rationale*:\n\n* **Availability**: Email always available for authenticated users\n* **Uniqueness**: Email is unique identifier in Salesforce and Mobile App\n* **Salesforce standard**: Salesforce Contact uses email as standard lookup field\n* **Simplicity**: Single matching key simplifies upsert logic\n* **Edge case acceptable**: Email changes are rare, manual cleanup acceptable\n\n*Consequences*:\n\n* Simple upsert logic (query by email, create if not found)\n* Leverages Salesforce standard email field\n* Email always available from authentication\n* ⚠️ Email changes create duplicate Contacts (rare edge case, manual cleanup)\n* ⚠️ Future enhancement: Add VCI as Salesforce External ID for stable matching\n\n==== ADR-CS-005: No Case migration from D365 CE (fresh start)\n\n*Status*: Accepted\n\n*Context*:\n\n* D365 CE contains historical customer support Cases\n* Alternative: Migrate historical Cases to Salesforce (preserve support history)\n* Alternative: Archive D365 CE Cases separately (read-only access)\n\n*Decision*:\n\nDo not migrate historical Cases from D365 CE to Salesforce. Start fresh in Salesforce.\n\n*Rationale*:\n\n* **Limited value**: Historical D365 CE Cases not critical for future support\n* **Data quality**: D365 CE Case data may be inconsistent or incomplete\n* **Complexity**: Case migration requires mapping D365 CE schema to Salesforce, data transformation, validation\n* **Cost-benefit**: Migration effort outweighs value of historical data\n* **Archive option**: D365 CE Cases can be archived separately if needed (read-only access for auditing)\n\n*Consequences*:\n\n* Simpler migration (Contacts only, no Case migration)\n* Faster time to value (no Case migration delay)\n* Clean start in Salesforce (no legacy data quality issues)\n* ⚠️ Historical Cases not visible in Salesforce (support agents can't see old Cases)\n* ⚠️ D365 CE must remain accessible temporarily for historical Case lookups (if needed)\n* ❌ Loss of historical Case insights (reporting, analytics on old Cases)\n\n==== ADR-CS-006: Big bang cutover (not phased rollout)\n\n*Status*: Accepted\n\n*Context*:\n\n* Alternative: Phased rollout with feature flags (pilot users first, gradual enablement)\n* Alternative: Parallel run (submit to both D365 CE and Salesforce temporarily)\n* Flybuys integration uses phased rollout (AS-1, AS-2, AS-3 architecture states)\n\n*Decision*:\n\nBig bang cutover - migrate Contacts, deploy ProfileService and EngagementService, switch Mobile App, retire D365 CE.\n\n*Rationale*:\n\n* **Simplicity**: No parallel run complexity, no feature flag management\n* **Faster D365 CE retirement**: No extended transition period maintaining two systems\n* **Limited risk**: Customer support not mission-critical (not payment processing), rollback possible\n* **User base manageable**: OTR digital customers smaller than Flybuys integration scope\n* **Different use case**: Flybuys phased rollout manages points accrual complexity, support feedback is simpler\n\n*Consequences*:\n\n* Simpler deployment (single cutover, no AS-1/AS-2/AS-3 states)\n* Faster D365 CE retirement (no extended parallel run)\n* No feature flag complexity or pilot user management\n* ⚠️ Higher cutover risk (all users switch at once)\n* ⚠️ Requires comprehensive testing before cutover\n* ⚠️ Rollback plan required (revert to D365 CE if critical issues)\n\n==== ADR-CS-007: EngagementService receives Salesforce webhooks for Case updates\n\n*Status*: Accepted\n\n*Context*:\n\n* Support agents update/resolve Cases in Salesforce\n* Need to notify customers of Case status changes via push notifications\n* Alternative: Poll Salesforce API for Case updates (inefficient)\n* Alternative: No customer notifications (agents contact customers directly)\n\n*Decision*:\n\nSalesforce sends webhook notifications to EngagementService when Cases are updated/resolved. EngagementService triggers Braze push notifications.\n\n*Rationale*:\n\n* **Real-time notifications**: Customer notified immediately when agent resolves Case\n* **Efficient**: Webhook push model (not polling)\n* **Event-driven**: Aligns with event-driven architecture pattern\n* **Better customer experience**: Proactive notification vs waiting for agent contact\n\n*Consequences*:\n\n* Real-time customer notifications for Case updates\n* Efficient push model (no polling overhead)\n* Bidirectional integration (Mobile App → Salesforce → Mobile App)\n* ⚠️ Salesforce webhook mechanism TBD (Outbound Messages vs Platform Events vs Process Builder)\n* ⚠️ Webhook authentication and security required\n* ⚠️ EngagementService must handle webhook retries and failures\n\n<<<\n== Interface Specifications\n\nThis section provides references to the complete API specifications and event catalogue for ProfileService and EngagementService.\n\n=== REST API Specifications\n\nComplete OpenAPI 3.0 specifications are maintained in the `specifications/rest/` directory:\n\n==== ProfileService API v1\n\n*Specification*: link:../../specifications/rest/profile-service-v1.yaml[profile-service-v1.yaml]\n\n*Base URL*: `https://api.otr.com.au/profile/v1`\n\n*Authentication*: Bearer token (Microsoft Entra External ID JWT)\n\n*Key Endpoints*:\n\n* `GET /contact-id` - Retrieve or create Salesforce Contact ID for authenticated user (Just-In-Time reconciliation)\n** Used by Mobile App before submitting feedback to EngagementService\n** Upserts Salesforce Contact record using email as external key\n** Returns 18-character Salesforce Contact ID with caching (15-minute TTL)\n** Performance SLA: p95 < 300ms (uncached), p95 < 50ms (cached)\n\n==== EngagementService API v1\n\n*Specification*: link:../../specifications/rest/engagement-service-v1.yaml[engagement-service-v1.yaml]\n\n*Base URL*: `https://api.otr.com.au/engagement/v1`\n\n*Authentication*: Bearer token (Microsoft Entra External ID JWT)\n\n*Key Endpoints*:\n\n* `POST /feedback` - Submit customer feedback for async Case creation in Salesforce\n** Accepts contactId, category, storeName, timeOfVisit, contactPhoneNumber, message\n** Returns 202 Accepted immediately (async Case creation in background)\n** Publishes `CustomerFeedbackSubmitted` event for analytics\n** Creates Salesforce Case via Anti-Corruption Layer with retry logic\n** Performance SLA: p95 < 200ms (feedback accepted, not Case creation)\n\n=== Domain Events (AsyncAPI)\n\nComplete CloudEvents 1.0 JSON Schema specifications are maintained in the `specifications/events/` directory:\n\n*Specification*: link:../../specifications/events/engagement-events.json[engagement-events.json]\n\n==== Event Catalogue\n\n[width=\"100%\",cols=\"30%,20%,50%\",options=\"header\",]\n|===\n|Event Type |Publisher |Consumers\n\n|`CustomerFeedbackSubmitted`\n|EngagementService\n|Future bounded contexts, analytics, sentiment analysis\n\n|`SupportCaseCreated`\n|EngagementService\n|Future bounded contexts, analytics\n\n|`SupportCaseUpdated`\n|EngagementService (via Salesforce webhook)\n|Future bounded contexts, analytics\n\n|`SupportCaseResolved`\n|EngagementService (via Salesforce webhook)\n|Future bounded contexts, analytics\n\n|===\n\n==== Event Delivery Guarantees\n\n* **At-least-once delivery**: Events may be delivered multiple times, consumers must handle idempotency\n* **Ordering**: FIFO queues guarantee ordering for events with same `contactId`\n* **Retention**: 4 days (96 hours) in Event Bus\n* **Dead Letter Queue**: Failed events after 5 retries moved to DLQ for manual intervention\n* **Format**: CloudEvents 1.0 specification with JSON payload\n\n=== API Versioning Policy\n\n==== Version Numbering\n\n* **Format**: `/v{major}` in URL path (e.g., `/profile/v1`, `/engagement/v1`)\n* **Semantic Versioning**: Major version incremented for breaking changes only\n* **Backwards Compatibility**: Minor changes (new optional fields, new endpoints) don't require version bump\n\n==== When to Version\n\n*Breaking changes requiring new major version*:\n\n- Removing or renaming fields in request/response\n- Changing field data types (e.g., string → number)\n- Changing authentication mechanism\n- Removing endpoints\n\n*Non-breaking changes not requiring version bump*:\n\n- Adding new optional fields to request/response\n- Adding new endpoints\n- Expanding enum values (e.g., adding new feedback category)\n- Improving error messages\n\n==== Parallel Version Support\n\n* Support N and N-1 versions concurrently for 6 months\n* Deprecation notice: 3 months before sunsetting old version\n* Mobile App must upgrade to new version within deprecation window\n\n<<<\n== Work Packages\n\nThis section consolidates gaps and activities into implementable work packages aligned with TOGAF Phase E requirements.\n\n=== Work Package Overview\n\n[width=\"100%\",cols=\"15%,35%,25%,25%\",options=\"header\",]\n|===\n|Work Package ID |Name |Transition State |Key Deliverables\n\n|WP-CS-001\n|ProfileService Development\n|TS-1 (Build & Test)\n|ProfileService microservice, Salesforce Contact integration, REST API\n\n|WP-CS-002\n|EngagementService Development\n|TS-1 (Build & Test)\n|EngagementService microservice, Anti-Corruption Layer, Braze integration\n\n|WP-CS-003\n|Event Bus Infrastructure\n|TS-1 (Build & Test)\n|Event Bus configuration, CloudEvents schemas, monitoring\n\n|WP-CS-004\n|Contact Migration Tooling\n|TS-1 (Build & Test)\n|Migration tool, validation scripts, reconciliation reporting\n\n|WP-CS-005\n|Mobile App Integration\n|TS-1 (Build & Test)\n|Mobile App API integration, feedback form enhancements, testing\n\n|WP-CS-006\n|Integration Testing\n|TS-1 (Build & Test)\n|Test environments, integration test suites, UAT execution\n\n|WP-CS-007\n|Salesforce Configuration\n|TS-1 (Build & Test)\n|Salesforce field mapping, data isolation, webhook configuration\n\n|WP-CS-008\n|Contact Data Migration\n|TS-2 (Contact Migration)\n|Contact migration execution, validation, reconciliation\n\n|WP-CS-009\n|Production Deployment\n|TS-3 (Cutover)\n|Production deployment, smoke testing, go-live execution\n\n|WP-CS-010\n|Post-Cutover Support\n|TS-4 (Target State)\n|Monitoring, issue resolution, D365 CE retirement\n\n|===\n\n=== WP-CS-001: ProfileService Development\n\n==== Description\n\nBuild ProfileService bounded context microservice implementing Just-In-Time Contact reconciliation with Salesforce Service Cloud.\n\n==== Deliverables\n\n* ProfileService microservice application\n** REST API implementation (OpenAPI 3.0 specification)\n** `GET /contact-id` endpoint (Salesforce Contact reconciliation)\n** Authentication/authorization with Microsoft Entra External ID\n** Caching layer (15-minute TTL for Contact IDs)\n* Salesforce integration\n** Salesforce REST API client\n** Contact upsert by email (external key matching)\n** Error handling and retry logic\n* Unit tests (>80% code coverage)\n* Integration tests with Salesforce sandbox\n* API documentation\n* Deployment configuration (IaC - Infrastructure as Code)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* Salesforce sandbox environment provisioned\n* Microsoft Entra External ID OAuth configuration\n* Development environment setup (AWS dev account, CI/CD pipeline)\n\n*Dependent Work Packages*:\n\n* None (can start immediately after prerequisites met)\n\n==== Skills Required\n\n* Backend development (.NET Core or Node.js)\n* REST API design and implementation\n* Salesforce REST API integration\n* OAuth 2.0 / JWT authentication\n* Caching strategies (Redis/ElastiCache)\n* Unit/integration testing frameworks\n* Infrastructure as Code (Terraform/CloudFormation)\n\n==== Acceptance Criteria\n\n* All API endpoints return correct HTTP status codes per OpenAPI specification\n* Contact ID retrieval achieves p95 < 300ms (uncached), p95 < 50ms (cached)\n* Salesforce Contact upsert succeeds with 100% accuracy in sandbox testing\n* Unit test coverage > 80%\n* Integration tests pass in sandbox environment\n* API documentation generated from OpenAPI specification\n\n=== WP-CS-002: EngagementService Development\n\n==== Description\n\nBuild EngagementService bounded context microservice implementing customer feedback submission, Anti-Corruption Layer for Salesforce Case creation, Braze integration, and webhook receiver for Case updates.\n\n==== Deliverables\n\n* EngagementService microservice application\n** REST API implementation (OpenAPI 3.0 specification)\n** `POST /feedback` endpoint (async feedback submission)\n** Authentication/authorization with Microsoft Entra External ID\n** Webhook receiver endpoint for Salesforce Case updates\n* Anti-Corruption Layer (ACL)\n** OTR domain model to Salesforce API translation\n** Category enum mapping (App/Service/Order/Rewards → Salesforce Case fields)\n** Salesforce REST API client for Case creation\n* Async processing infrastructure\n** Event Bus publisher integration\n** Background worker for Case creation\n** Retry logic with exponential backoff (5 attempts)\n** Dead Letter Queue integration\n* Braze integration\n** Braze campaign trigger API client\n** Push notification orchestration for Case updates\n* Domain event publishing\n** `CustomerFeedbackSubmitted` event publisher\n** `SupportCaseCreated` event publisher\n** `SupportCaseUpdated` event translator (Salesforce webhook → domain event)\n** `SupportCaseResolved` event translator (Salesforce webhook → domain event)\n* Unit tests (>80% code coverage)\n* Integration tests (EngagementService ↔ Salesforce, EngagementService ↔ Braze)\n* API documentation\n* Deployment configuration (IaC)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-003 (Event Bus Infrastructure) completed\n* Salesforce sandbox environment provisioned\n* Braze API credentials and campaign templates configured\n* Microsoft Entra External ID OAuth configuration\n\n*Dependent Work Packages*:\n\n* WP-CS-003 must be completed first (Event Bus required for async processing)\n* WP-CS-007 (Salesforce Configuration) must be in progress (field mapping needed)\n\n==== Skills Required\n\n* Backend development (.NET Core or Node.js)\n* REST API design and implementation\n* Salesforce REST API integration\n* Event-driven architecture patterns\n* Async/background processing (queues, workers)\n* Braze API integration\n* Webhook design and security\n* OAuth 2.0 / JWT authentication\n* Domain-Driven Design (DDD) - Anti-Corruption Layer pattern\n* Unit/integration testing frameworks\n* Infrastructure as Code (Terraform/CloudFormation)\n\n==== Acceptance Criteria\n\n* Feedback submission endpoint returns 202 Accepted within p95 < 200ms\n* Async Case creation succeeds with >99.5% success rate (including retries)\n* Anti-Corruption Layer correctly maps all feedback categories to Salesforce Case fields\n* Webhook receiver processes Salesforce Case updates and publishes domain events\n* Braze push notifications sent successfully for Case updates\n* Failed Case creation moves to Dead Letter Queue after 5 retry attempts\n* Unit test coverage > 80%\n* Integration tests pass with Salesforce sandbox and Braze staging environment\n\n=== WP-CS-003: Event Bus Infrastructure\n\n==== Description\n\nImplement Event Bus infrastructure for domain event publishing using existing AWS infrastructure (SNS+SQS, EventBridge, or Kinesis).\n\n==== Deliverables\n\n* Event Bus infrastructure configuration\n** Topic/stream provisioning (technology choice: SNS+SQS / EventBridge / Kinesis)\n** FIFO queue configuration (ordering by `contactId`)\n** Dead Letter Queue (DLQ) setup\n** Retention policy (4 days / 96 hours)\n** Access control policies (IAM roles, permissions)\n* CloudEvents 1.0 schema definitions\n** JSON Schema specifications for all domain events\n** Schema validation configuration\n** Schema registry (if using EventBridge/Kinesis)\n* Monitoring and alerting\n** CloudWatch dashboards for queue metrics\n** Alarms for DLQ depth, queue age, processing failures\n** Event Bus throughput monitoring\n* Documentation\n** Event Bus architecture diagram\n** Event publishing guidelines\n** Consumer integration guide\n* Infrastructure as Code (IaC)\n** Terraform/CloudFormation templates for all infrastructure\n\n==== Dependencies\n\n*Prerequisites*:\n\n* AWS account access (existing infrastructure)\n* Technology selection decision (SNS+SQS vs EventBridge vs Kinesis)\n* CloudEvents 1.0 schema design approval\n\n*Dependent Work Packages*:\n\n* None (foundational infrastructure, can start early)\n\n==== Skills Required\n\n* AWS messaging services (SNS, SQS, EventBridge, Kinesis)\n* Event-driven architecture patterns\n* CloudEvents specification\n* JSON Schema design\n* Infrastructure as Code (Terraform/CloudFormation)\n* AWS IAM security configuration\n* CloudWatch monitoring and alerting\n\n==== Acceptance Criteria\n\n* Event Bus infrastructure provisioned in all environments (dev, staging, production)\n* FIFO ordering validated for events with same `contactId`\n* Dead Letter Queue triggers alarms when messages arrive\n* Event retention policy enforced (4 days)\n* CloudEvents 1.0 schema validation enabled\n* Monitoring dashboards operational\n* Infrastructure fully codified (IaC)\n\n=== WP-CS-004: Contact Migration Tooling\n\n==== Description\n\nDevelop Contact migration tool for one-time migration from app-specific database to Salesforce Service Cloud with upsert logic and validation.\n\n==== Deliverables\n\n* Contact migration tool\n** Extract Contacts from app-specific database\n** Transform to Salesforce Contact API format\n** Upsert to Salesforce using email as external key\n** Fallback matching by phone number or Viva Consumer ID\n** Batch processing with rate limiting (respect Salesforce API limits)\n** Idempotent operation (can be re-run safely)\n* Validation scripts\n** Pre-migration validation (data quality checks)\n** Post-migration validation (100% Contact reconciliation)\n** Email/phone/VCI matching accuracy report\n* Reconciliation reporting\n** Contacts created vs updated statistics\n** Failed upserts with error details\n** Matching accuracy metrics\n* Rollback capability\n** Export snapshot of Salesforce Contacts before migration\n** Rollback procedure documentation\n* Documentation\n** Migration tool user guide\n** Troubleshooting guide\n** Runbook for migration execution\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-001 (ProfileService Development) completed (reuses Salesforce integration code)\n* Salesforce sandbox environment for migration testing\n* App-specific database access (read-only sufficient)\n* Salesforce production access granted\n\n*Dependent Work Packages*:\n\n* WP-CS-001 provides Salesforce Contact upsert logic to reuse\n\n==== Skills Required\n\n* Database development (SQL, data extraction)\n* Salesforce REST API integration\n* Batch processing and ETL patterns\n* Data validation and reconciliation\n* Error handling and logging\n* Scripting (Python, PowerShell, or similar)\n\n==== Acceptance Criteria\n\n* Migration tool successfully migrates 100% of Contacts in sandbox with zero data loss\n* Email/phone/VCI matching accuracy > 95% in sandbox testing\n* Failed upserts captured with actionable error messages\n* Reconciliation report matches actual Salesforce Contact counts\n* Migration tool execution time acceptable for production (freezes app database for minimum time)\n* Rollback procedure validated in sandbox\n* Documentation complete and approved\n\n=== WP-CS-005: Mobile App Integration\n\n==== Description\n\nUpdate Mobile App to integrate with ProfileService and EngagementService APIs, replacing D365 CE integration.\n\n==== Deliverables\n\n* Feedback form UI enhancements\n** Add Category dropdown (App, Service, Order, Rewards, Refund, Delete Account)\n** Add Store Name field (optional)\n** Add Time of Visit field (optional, datetime picker)\n** Add Contact Phone Number field (optional, E.164 validation)\n** Update Message field (1-2000 character limit with counter)\n* API integration (Kotlin Multiplatform shared code)\n** ProfileService client (`GET /contact-id`)\n** EngagementService client (`POST /feedback`)\n** JWT token management (Microsoft Entra External ID)\n** Error handling (network failures, API errors, validation errors)\n** Retry logic for transient failures\n* Platform-specific UI (SwiftUI for iOS, Jetpack Compose for Android)\n** Feedback form screens\n** Success/error confirmation screens\n** Loading states and progress indicators\n* Feature flag integration\n** `enable_salesforce_feedback_submission` flag\n** Fallback to D365 CE if flag disabled (during rollout)\n* Unit tests for shared business logic\n* UI tests for platform-specific screens\n* API integration tests (mocked APIs)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-001 (ProfileService Development) completed and deployed to dev/staging\n* WP-CS-002 (EngagementService Development) completed and deployed to dev/staging\n* ProfileService and EngagementService OpenAPI specifications finalized\n* Feature flag service configured\n\n*Dependent Work Packages*:\n\n* Must complete after WP-CS-001 and WP-CS-002 (requires API endpoints available for integration testing)\n\n==== Skills Required\n\n* Kotlin Multiplatform development\n* SwiftUI (iOS native UI)\n* Jetpack Compose (Android native UI)\n* REST API client development\n* OAuth 2.0 / JWT authentication\n* Form validation and UX design\n* Unit testing (Kotlin, Swift)\n* UI testing frameworks (XCTest, Espresso)\n\n==== Acceptance Criteria\n\n* Feedback form UI matches UX design specifications\n* All form fields validate correctly (client-side validation)\n* API integration successfully calls ProfileService and EngagementService in dev/staging\n* Error handling provides user-friendly error messages\n* Feature flag correctly toggles between Salesforce and D365 CE integration\n* Unit test coverage > 80% for shared business logic\n* UI tests pass for all feedback form workflows (happy path, error states)\n* App builds and deploys successfully to TestFlight (iOS) and Google Play Internal Testing (Android)\n\n=== WP-CS-006: Integration Testing\n\n==== Description\n\nExecute comprehensive integration testing across all system components in non-production environments.\n\n==== Deliverables\n\n* Test environment setup\n** Salesforce sandbox configured with test data\n** ProfileService deployed to staging\n** EngagementService deployed to staging\n** Event Bus staging infrastructure\n** Braze staging environment configured\n** Mobile App TestFlight/Internal Testing builds\n* Integration test suites\n** ProfileService ↔ Salesforce (Contact upsert scenarios)\n** EngagementService ↔ Salesforce (Case creation scenarios)\n** EngagementService ↔ Braze (push notification scenarios)\n** Mobile App ↔ ProfileService ↔ EngagementService (end-to-end workflows)\n** Event Bus publishing and consumption\n** Webhook receiver (Salesforce → EngagementService)\n* Test scenarios\n** Happy path: Successful feedback submission and Case creation\n** Error scenarios: Salesforce API failures, Braze API failures, network timeouts\n** Retry scenarios: Async Case creation retries, DLQ validation\n** Performance testing: p95 latency validation for ProfileService and EngagementService\n** Load testing: Simulate 3x-10x expected volume\n* UAT execution\n** Business stakeholder UAT sessions\n** UAT test cases covering all feedback categories\n** UAT sign-off documentation\n* Test results documentation\n** Test execution reports\n** Defect tracking and resolution\n** Performance test results\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-001 (ProfileService Development) completed\n* WP-CS-002 (EngagementService Development) completed\n* WP-CS-003 (Event Bus Infrastructure) completed\n* WP-CS-005 (Mobile App Integration) completed\n* WP-CS-007 (Salesforce Configuration) sandbox configuration completed\n\n*Dependent Work Packages*:\n\n* Must complete after WP-CS-001, WP-CS-002, WP-CS-003, WP-CS-005 (requires all components available)\n\n==== Skills Required\n\n* Integration testing strategy and execution\n* Test automation frameworks (Postman, Newman, Selenium)\n* Performance testing tools (JMeter, k6, Gatling)\n* Salesforce sandbox administration\n* Test data management\n* Defect tracking and triage\n* UAT facilitation\n\n==== Acceptance Criteria\n\n* All integration test scenarios pass (happy path, error scenarios, retry scenarios)\n* Performance SLAs validated (ProfileService p95 < 300ms, EngagementService p95 < 200ms)\n* Load testing confirms system handles 3x expected volume without degradation\n* UAT sign-off obtained from business stakeholders\n* Zero critical defects (P1/P2) open before moving to Contact Migration\n* Test results documented and approved\n\n=== WP-CS-007: Salesforce Configuration\n\n==== Description\n\nConfigure Salesforce Service Cloud for OTR digital customer support integration, including field mapping, data isolation, and webhook setup.\n\n==== Deliverables\n\n* Salesforce Contact configuration\n** Custom fields for OTR-specific data (if needed)\n** Email as external key configuration\n** Record Type for OTR digital customers (data isolation)\n** Validation rules\n* Salesforce Case configuration\n** Custom fields for feedback categories (App, Service, Order, Rewards, Refund, Delete Account)\n** Case Type and Reason picklist mapping\n** Queue assignment rules (OTR digital support queue)\n** Case escalation rules\n** Case routing rules\n* Salesforce webhook configuration\n** Platform Events / Outbound Messages for Case updates\n** Webhook authentication (API key, JWT, or OAuth)\n** Case status change triggers (New → In Progress, Resolved, Closed)\n** Webhook payload format (JSON)\n* Data isolation strategy\n** Record Types for OTR vs other Viva Energy business units\n** Queues for OTR-specific Cases\n** Reporting and dashboards scoped to OTR data\n* Salesforce API access\n** Connected App configuration\n** OAuth 2.0 JWT bearer flow setup\n** API user credentials\n** API rate limit monitoring\n* Documentation\n** Salesforce field mapping specification\n** Webhook configuration guide\n** Data isolation architecture diagram\n** API authentication setup guide\n\n==== Dependencies\n\n*Prerequisites*:\n\n* Viva Energy Salesforce admin team engagement\n* Salesforce governance approval (multi-tenant environment)\n* Technical decision on webhook mechanism (Platform Events vs Outbound Messages)\n* Technical decision on authentication method (OAuth 2.0 JWT bearer flow recommended)\n\n*Dependent Work Packages*:\n\n* None (can start in parallel with development work packages)\n* Required for WP-CS-002 (EngagementService needs field mapping)\n* Required for WP-CS-006 (Integration Testing needs sandbox configuration)\n\n==== Skills Required\n\n* Salesforce administration\n* Salesforce configuration (Record Types, Queues, Validation Rules)\n* Salesforce API integration (REST API, Platform Events, Outbound Messages)\n* Salesforce security and authentication (OAuth, Connected Apps)\n* Multi-tenant data isolation patterns\n\n==== Acceptance Criteria\n\n* Salesforce sandbox configured with all custom fields, Record Types, Queues\n* Field mapping documented and approved by OTR business stakeholders\n* Webhook configuration tested and delivering Case update notifications\n* Data isolation validated (OTR data separate from other Viva Energy business units)\n* API authentication working for ProfileService and EngagementService\n* Salesforce API rate limits monitored and acceptable for expected volume\n* Configuration replicated to Salesforce production environment\n\n=== WP-CS-008: Contact Data Migration\n\n==== Description\n\nExecute one-time Contact migration from app-specific database to Salesforce Service Cloud production.\n\n==== Deliverables\n\n* Pre-migration activities\n** Final validation of migration tool in sandbox\n** Communication plan (notify users of maintenance window if needed)\n** Freeze app-specific database Contact updates\n** Backup app-specific database\n** Export snapshot of Salesforce Contacts (rollback preparation)\n* Migration execution\n** Execute migration tool against Salesforce production\n** Monitor migration progress\n** Handle failed upserts (manual intervention if needed)\n* Post-migration validation\n** 100% Contact reconciliation (app database vs Salesforce)\n** Email/phone/VCI matching accuracy report\n** Reconciliation report (Contacts created vs updated)\n** Data integrity checks (no duplicate Contacts, no missing Contacts)\n* ProfileService smoke testing\n** Verify Contact ID retrieval works in production\n** Test cache behavior\n** Validate Salesforce Contact upserts from ProfileService\n* Migration report\n** Total Contacts migrated\n** Contacts created vs updated\n** Failed upserts (if any) with resolution\n** Matching accuracy metrics\n** Migration execution time\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-004 (Contact Migration Tooling) completed\n* WP-CS-001 (ProfileService Development) deployed to production (not yet integrated with Mobile App)\n* WP-CS-007 (Salesforce Configuration) production configuration completed\n* Salesforce production access granted\n* Migration approved by business stakeholders\n\n*Dependent Work Packages*:\n\n* Must complete after WP-CS-001, WP-CS-004, WP-CS-007\n* Must complete before WP-CS-009 (Production Deployment)\n\n==== Skills Required\n\n* Data migration execution\n* Salesforce administration\n* Database operations\n* Data validation and reconciliation\n* Incident management (if issues arise)\n\n==== Acceptance Criteria\n\n* 100% of Contacts migrated with zero data loss\n* Email/phone/VCI matching accuracy > 95%\n* ProfileService smoke tests pass in production\n* Reconciliation report approved by business stakeholders\n* App-specific database Contact updates frozen (read-only mode)\n* Rollback procedure ready (but not executed if migration successful)\n\n=== WP-CS-009: Production Deployment\n\n==== Description\n\nDeploy all solution components to production and execute cutover from D365 CE to Salesforce Service Cloud.\n\n==== Deliverables\n\n* Production deployment\n** EngagementService deployed to production\n** Event Bus production infrastructure validated\n** Salesforce webhook configured in production\n** Mobile App released to production (App Store, Google Play)\n* Go-live activities\n** Smoke testing (end-to-end feedback submission)\n** Feature flag enabled: `enable_salesforce_feedback_submission = ON`\n** D365 CE integration disabled in Mobile App\n** Monitor Event Bus queue depth, DLQ, Salesforce API rate limits\n** Monitor Mobile App feedback submission success rate\n* Go/No-Go decision\n** Validate success criteria before final cutover\n** Business stakeholder approval\n** Technical validation (smoke tests pass, monitoring healthy)\n* Cutover communication\n** Notify support agents of new Salesforce integration\n** Provide training materials for support agents\n** Customer communication (if visible change)\n* Rollback plan\n** Documented rollback procedure\n** Feature flag can disable Salesforce integration and re-enable D365 CE\n** Rollback decision criteria (P1/P2 incidents, feedback submission success rate < 99%)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-001 (ProfileService Development) completed\n* WP-CS-002 (EngagementService Development) completed\n* WP-CS-003 (Event Bus Infrastructure) completed\n* WP-CS-005 (Mobile App Integration) completed\n* WP-CS-006 (Integration Testing) completed with UAT sign-off\n* WP-CS-007 (Salesforce Configuration) production configuration completed\n* WP-CS-008 (Contact Data Migration) completed successfully\n* Mobile App release approval (App Store, Google Play)\n\n*Dependent Work Packages*:\n\n* Must complete after all prior work packages (final cutover)\n\n==== Skills Required\n\n* Production deployment and release management\n* Incident management and troubleshooting\n* Monitoring and observability\n* Change management and communication\n* Rollback execution (if needed)\n\n==== Acceptance Criteria\n\n* Mobile App feedback submission success rate > 99.5%\n* End-to-end flow validated (Mobile App → ProfileService → EngagementService → Salesforce Case created)\n* Braze push notifications delivered successfully\n* Event Bus queue depth normal, DLQ empty\n* No critical incidents (P1/P2) in first 24 hours\n* D365 CE integration disabled\n* Support agents successfully using Salesforce for OTR digital customer Cases\n\n=== WP-CS-010: Post-Cutover Support\n\n==== Description\n\nMonitor production stability, resolve issues, validate success criteria, and execute D365 CE retirement.\n\n==== Deliverables\n\n* Monitoring and support\n** 24/7 on-call support for first week post-cutover\n** Daily monitoring reports (feedback submission success rate, Case creation success rate)\n** Incident response and resolution\n** Performance tuning (if needed)\n* Success criteria validation\n** Validate feedback submission success rate > 99.5%\n** Monitor customer satisfaction score (target: +15% improvement within 6 months)\n** Monitor average case resolution time (target: -20% improvement within 6 months)\n** Support agent feedback survey\n* D365 CE retirement\n** D365 CE set to read-only mode (historical Case lookups only)\n** Archive D365 CE data for compliance/auditing\n** Decommission D365 CE infrastructure (after 90-day stabilization period)\n** Remove D365 CE integration code from Mobile App\n* Documentation updates\n** Production runbook\n** Troubleshooting guide (based on incidents resolved)\n** Operational procedures for support team\n** Lessons learned document\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-009 (Production Deployment) completed\n* Cutover successful with no critical incidents\n\n*Dependent Work Packages*:\n\n* Final work package in sequence\n\n==== Skills Required\n\n* Production support and incident management\n* Performance monitoring and tuning\n* Data archival and compliance\n* Infrastructure decommissioning\n* Documentation\n\n==== Acceptance Criteria\n\n* Zero critical incidents (P1/P2) in first 30 days post-cutover\n* Feedback submission success rate sustained > 99.5%\n* Customer satisfaction improvement validated (baseline established, ongoing measurement)\n* Support agents reporting positive experience with Salesforce unified view\n* D365 CE successfully decommissioned\n* All production documentation complete and approved\n* Lessons learned document published\n\n=== Work Package Sequencing\n\n==== Parallel Track 1: Infrastructure & Configuration\n\nCan start immediately and run in parallel:\n\n* WP-CS-003 (Event Bus Infrastructure)\n* WP-CS-007 (Salesforce Configuration)\n\n==== Parallel Track 2: Development\n\nCan start after Track 1 infrastructure decisions made:\n\n* WP-CS-001 (ProfileService Development) - Independent\n* WP-CS-002 (EngagementService Development) - Requires WP-CS-003 completed\n* WP-CS-004 (Contact Migration Tooling) - Requires WP-CS-001 completed (reuses code)\n\n==== Sequential Track 3: Integration & Testing\n\nMust complete after development:\n\n* WP-CS-005 (Mobile App Integration) - Requires WP-CS-001, WP-CS-002\n* WP-CS-006 (Integration Testing) - Requires WP-CS-001, WP-CS-002, WP-CS-003, WP-CS-005, WP-CS-007\n\n==== Sequential Track 4: Migration & Cutover\n\nMust complete sequentially:\n\n* WP-CS-008 (Contact Data Migration) - Requires WP-CS-001, WP-CS-004, WP-CS-006 UAT sign-off\n* WP-CS-009 (Production Deployment) - Requires all prior work packages completed\n* WP-CS-010 (Post-Cutover Support) - Requires WP-CS-009\n\n==== Critical Path\n\nThe critical path for this project is:\n\n. WP-CS-003 (Event Bus Infrastructure)\n. WP-CS-002 (EngagementService Development) - blocks on WP-CS-003\n. WP-CS-005 (Mobile App Integration) - blocks on WP-CS-001, WP-CS-002\n. WP-CS-006 (Integration Testing) - blocks on WP-CS-001 through WP-CS-005, WP-CS-007\n. WP-CS-008 (Contact Data Migration) - blocks on WP-CS-006 UAT sign-off\n. WP-CS-009 (Production Deployment) - blocks on WP-CS-008\n. WP-CS-010 (Post-Cutover Support) - final deliverable\n\nAny delays in critical path work packages will delay the overall cutover date.\n\n<<<\n== Transition Architecture\n\nThis section defines the evolution from baseline (D365 CE) to target state (Salesforce Service Cloud + ProfileService + EngagementService).\n\n=== Transition Approach\n\n*Big Bang Cutover*: Per ADR-CS-006, this transition uses a single cutover approach rather than phased rollout. All users switch from D365 CE to Salesforce simultaneously after Contact migration completion.\n\n=== Transition States\n\n==== TS-0: Baseline State (Current)\n\n===== Characteristics\n\n* D365 Customer Engagement handles all digital customer feedback\n* App-specific database stores customer Contact data\n* No ProfileService or EngagementService\n* No event-driven architecture\n* Synchronous feedback submission\n\n===== Components Active\n\n- D365 Customer Engagement\n- App-specific customer database\n- Mobile App (current version with D365 CE integration)\n\n==== TS-1: Build & Test\n\n===== Activities\n\n* Build ProfileService microservice (JIT Contact reconciliation API)\n* Build EngagementService microservice (feedback submission API, ACL for Salesforce Case creation, Braze integration, webhook receiver)\n* Implement Event Bus infrastructure (SNS+SQS/EventBridge/Kinesis)\n* Develop Contact migration tool (app database → Salesforce upsert by email/phone/VCI)\n* Update Mobile App API integration (ProfileService + EngagementService endpoints - feedback form UI already complete)\n* Integration testing (ProfileService ↔ Salesforce, EngagementService ↔ Salesforce, EngagementService ↔ Braze)\n* UAT with test Salesforce sandbox environment\n\n===== Components Active\n\n- D365 Customer Engagement (still active, unchanged)\n- App-specific customer database (still active)\n- ProfileService (non-production, testing only)\n- EngagementService (non-production, testing only)\n- Event Bus (non-production)\n- Salesforce Sandbox (testing)\n\n===== Exit Criteria\n\n- All integration tests pass\n- UAT sign-off from business stakeholders\n- Contact migration tool validated in sandbox\n- Mobile App updates tested with non-production APIs\n\n==== TS-2: Contact Migration\n\n===== Activities\n* Execute Contact migration (app database → Salesforce production)\n* Validation: 100% data integrity check (email/phone/VCI matching)\n* Reconciliation report: New Contacts created vs existing Contacts updated\n* Freeze app database Contact updates during migration window\n* ProfileService smoke testing (verify Contact lookups work in Salesforce production)\n\n===== Components Active\n- D365 Customer Engagement (still active, users unaffected)\n- Salesforce Production (Contacts migrated, no Cases yet)\n- ProfileService (production deployed, not integrated with Mobile App yet)\n- App-specific customer database (frozen, read-only)\n\n===== Exit Criteria\n- 100% of Contacts migrated with zero data loss\n- Email/phone/VCI matching accuracy > 95%\n- ProfileService smoke tests pass (JIT lookups return correct Contact IDs)\n- Reconciliation report approved\n\n==== TS-3: Cutover (Go-Live)\n\n===== Go-Live Activities\n\n* Deploy EngagementService to production\n* Deploy Mobile App updates (ProfileService + EngagementService API integration)\n* Configure Salesforce webhook (Case update notifications → EngagementService)\n* Smoke testing: End-to-end feedback submission (Mobile App → EngagementService → Salesforce → Braze notification)\n* Monitor Event Bus queue depth, dead letter queue, Salesforce API rate limits\n* **Go/No-Go decision**: Validate success criteria before final cutover\n* Enable feature flag: `enable_salesforce_feedback_submission = ON`\n* Disable D365 CE integration in Mobile App\n\n===== Components Active\n\n- ProfileService (production, integrated with Mobile App)\n- EngagementService (production, integrated with Mobile App)\n- Event Bus (production, processing async Case creation)\n- Salesforce Production (receiving Cases from digital customers)\n- Braze (sending push notifications)\n- Mobile App (new version with Salesforce integration)\n- D365 Customer Engagement (disabled, read-only for historical lookups)\n\n===== Exit Criteria\n\n- Mobile App feedback submission success rate > 99.5%\n- End-to-end flow validated (Mobile App → Salesforce Case created)\n- Braze push notifications delivered successfully\n- Event Bus queue depth normal, DLQ empty\n- No critical incidents (P1/P2) in first 24 hours\n\n==== TS-4: Target State (Stable Production)\n\n===== Characteristics\n\n* ProfileService and EngagementService fully operational\n* All digital customer feedback routed to Salesforce\n* Event-driven architecture established\n* D365 CE decommissioned\n* First DDD bounded contexts implemented successfully\n\n===== Monitoring Period\n\n* Validate success criteria: feedback submission rate > 99.5%, no data loss\n* Monitor customer satisfaction score (target: +15% improvement)\n* Monitor average case resolution time (target: -20% improvement)\n* Support agents using unified Salesforce view across all channels\n\n===== D365 CE Retirement\n\n* D365 CE read-only access for historical Case lookups (if needed)\n* Decommission D365 CE infrastructure after 90 days\n* Archive D365 CE data for compliance/auditing\n\n===== Components Active\n\n- ProfileService (production)\n- EngagementService (production)\n- Event Bus (production)\n- Salesforce Production (system of record)\n- Braze (push notifications)\n- Mobile App (Salesforce integration)\n- App-specific database (deprecated, Contact data no longer updated)\n\n===== Success Criteria Achieved\n\n- All digital customer feedback routed to Salesforce\n- Support agents have unified customer view\n- D365 CE decommissioned\n- Customer satisfaction improved by 15%\n- Average case resolution time decreased by 20%\n- Zero data loss during transition\n\n=== Transition Dependencies\n\n[width=\"100%\",cols=\"40%,60%\",options=\"header\",]\n|===\n|Dependency |Owner/Status\n\n|*Salesforce production access*\n|Viva Energy Salesforce admin team - TBD\n\n|*Salesforce Case field mapping*\n|Viva Energy Salesforce admin team - TBD (map OTR feedback categories to Salesforce fields)\n\n|*Salesforce data isolation strategy*\n|Viva Energy Salesforce admin team - TBD (Record Types, queues, custom fields)\n\n|*Salesforce webhook configuration*\n|Viva Energy Salesforce admin team - TBD (Outbound Messages vs Platform Events)\n\n|*Event Bus infrastructure*\n|OTR Platform team - Existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis)\n\n|*Braze integration*\n|OTR Marketing team - Existing Braze account, EngagementService creates new campaigns\n\n|*Mobile App release window*\n|OTR Mobile team - Coordinate cutover timing with app release schedule\n\n|*App database access*\n|OTR Platform team - Read access for Contact migration\n\n|===\n\n=== Transition Validation Criteria\n\n==== Contact Migration Validation\n\n* 100% of app database Contacts migrated to Salesforce (zero data loss)\n* Email/phone/VCI matching accuracy > 95% (minimize duplicate Contacts)\n* ProfileService JIT lookups return correct Salesforce Contact IDs (smoke test sample)\n* Reconciliation report shows: X new Contacts created, Y existing Contacts updated\n\n==== Cutover Validation\n\n* Mobile App feedback submission success rate > 99.5% (including async Case creation)\n* End-to-end flow validated: Mobile App → ProfileService → EngagementService → Salesforce Case created\n* Braze push notifications delivered for Case creation and Case resolution\n* Event Bus queue depth within normal range (no backlog)\n* Dead letter queue empty (no failed Case creations)\n* Salesforce API rate limits not exceeded\n\n==== Production Monitoring (30 days)\n\n* Customer satisfaction score improves by 15% (compared to D365 CE baseline)\n* Average case resolution time decreases by 20% (Salesforce vs D365 CE)\n* Support agents confirm unified customer view across all channels\n* Zero critical incidents (P1 outages, data loss)\n\n=== Rollback Plan\n\n==== Rollback Triggers\n\n* Feedback submission success rate < 95% (below acceptable threshold)\n* Data loss or corruption detected in Salesforce\n* Salesforce API rate limits exceeded (Cases not created within SLA)\n* Critical bug blocking customer feedback submission\n\n==== Rollback Procedure\n\n1. **Revert Mobile App** to previous version (remove ProfileService/EngagementService integration, restore D365 CE integration)\n2. **Stop EngagementService** Case creation (prevent duplicate Cases in Salesforce)\n3. **Re-enable D365 CE** for customer feedback submission\n4. **Investigate root cause** (EngagementService logs, Salesforce API errors, Event Bus queue issues)\n5. **Fix and re-test** in sandbox environment\n6. **Retry cutover** when issues resolved\n\n==== Rollback Limitations\n\n* Cases created in Salesforce during cutover period remain in Salesforce (no reverse migration)\n* Contacts migrated to Salesforce remain (no rollback to app database)\n* Rollback only affects Mobile App integration (not data migration)\n\n=== Architectural Scope Boundaries\n\n==== Capabilities Included\n\n===== Business Capabilities\n\n* **Customer Feedback Submission**: Mobile App users can submit structured feedback (Category, Store Name, Time of Visit, Phone, Free Text Message) via EngagementService\n* **Customer Contact Management**: Just-In-Time (JIT) Contact reconciliation with Salesforce via ProfileService, ensuring every Mobile App user has a Salesforce Contact record\n* **Case Management Integration**: EngagementService creates Salesforce Cases asynchronously for customer feedback, support agents manage Cases in Salesforce Service Cloud\n* **Customer Notifications**: Push notifications via Braze when Cases are created, updated, or resolved (bidirectional integration: Mobile App → Salesforce → Mobile App)\n* **Unified Customer View**: Support agents see OTR digital customer feedback alongside other Viva Energy channels (fuel wholesale, Shell Card, retail) in single Salesforce instance\n* **Contact Data Migration**: One-time migration of app-specific customer database Contacts to Salesforce with upsert logic (email/phone/VCI matching)\n\n===== Technical Capabilities\n\n* **ProfileService Bounded Context**: First DDD bounded context implementation - JIT Contact reconciliation, Salesforce API facade, foundation for Flybuys integration\n* **EngagementService Bounded Context**: First DDD bounded context implementation - Customer feedback submission BFF, Anti-Corruption Layer for Salesforce, Braze integration orchestration\n* **Event-Driven Architecture**: Domain event publishing via Event Bus (SNS+SQS/EventBridge/Kinesis) for `SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted` events\n* **Async Processing Pattern**: Non-blocking Case creation with retry logic, exponential backoff, dead letter queue for operational resilience\n* **Anti-Corruption Layer Pattern**: EngagementService protects digital channels from Salesforce API changes, translates between OTR domain language and Salesforce\n* **Conformist Pattern**: ProfileService and EngagementService conform to existing Salesforce configuration (shared Viva Energy instance, multi-tenant governance)\n* **Salesforce Integration**: REST API integration for Contact CRUD and Case creation, webhook receiver for Case update notifications\n* **Braze Integration**: Push notification campaign triggers for Case lifecycle events (created, updated, resolved)\n* **Observability & Monitoring**: Dashboards, metrics, alerting for feedback submission rate, queue depth, API errors, Case creation latency\n* **Feature Flag Management**: Kill switches for emergency rollback (enable_salesforce_feedback_submission, enable_async_case_creation, etc.)\n\n==== Capabilities Excluded\n\n===== Business Capabilities Explicitly Out of Scope\n\n* **Historical Case Migration**: D365 CE Cases not migrated to Salesforce (ADR-CS-005 - fresh start, no Case migration)\n* **Multi-Channel Feedback Submission**: Web app, POS, call centre, email feedback channels not included (Mobile App only in this phase)\n* **Case Resolution by Digital Channels**: Support agents resolve Cases in Salesforce, not via Mobile App self-service\n* **Knowledge Base Integration**: Salesforce Knowledge Base articles not surfaced in Mobile App (future enhancement)\n* **Live Chat/Messaging**: Real-time chat support not included (Salesforce omnichannel capabilities not activated)\n* **Sentiment Analysis**: Automated feedback sentiment analysis not included (future enhancement with AI/ML)\n* **Customer Satisfaction Surveys**: Post-resolution CSAT surveys not included (separate initiative)\n* **Case Attachments**: Mobile App feedback submission does not support file uploads (photos, receipts) - text only\n* **Agent Desktop Integration**: Custom Salesforce UI for support agents not included (use standard Salesforce Service Console)\n* **Social Media Feedback**: Facebook, Twitter, Instagram feedback channels not integrated\n\n===== Technical Capabilities Explicitly Out of Scope\n\n* **Event Sourcing**: Domain events are ephemeral (not persisted for event sourcing/replay) - Event Bus only, no Event Store\n* **CQRS (Command Query Responsibility Segregation)**: ProfileService and EngagementService use same data model for reads/writes (no separate read models)\n* **Local Aggregate Persistence**: ProfileService and EngagementService are stateless (Salesforce is System of Record, no local database for Contact/Case)\n* **Saga Orchestration**: No distributed transactions or saga patterns required (single-step Case creation, not multi-step workflow)\n* **API Gateway Advanced Features**: Rate limiting, API versioning, API key management deferred to detailed design (basic routing only)\n* **GraphQL API**: ProfileService and EngagementService expose REST APIs only (GraphQL not required)\n* **Real-Time Sync**: Salesforce Contact updates by support agents not synced back to ProfileService (eventual consistency acceptable via JIT reconciliation)\n* **Multi-Region Deployment**: Single AWS region deployment (no multi-region failover/disaster recovery in this phase)\n* **Blue-Green Deployment**: Big bang cutover (ADR-CS-006), not blue-green or canary deployment strategy\n* **A/B Testing Framework**: Feature flags for rollback only, not for A/B testing or experimentation\n* **Custom Authentication**: Microsoft Entra External ID used for Mobile App authentication (no custom authentication logic in ProfileService/EngagementService)\n* **Data Residency Compliance**: Salesforce data residency governed by Viva Energy Salesforce configuration (no OTR-specific data residency requirements)\n\n===== Future Bounded Contexts Not in Scope\n\n* **LoyaltyService**: Flybuys integration, reward preferences, transaction adjudication (separate initiative)\n* **LocationService**: Store finder, proximity features, geofencing (separate initiative)\n* **PaymentService**: Payment processing, subscription billing (separate initiative)\n* **RecommendationService**: Personalized recommendations, next-best offers (separate initiative)\n\n===== Integration Patterns Not in Scope\n\n* **Shared Kernel**: No shared domain model between ProfileService and EngagementService (separate bounded contexts with clear boundaries)\n* **Partnership**: No joint development or coordination with external teams (Conformist pattern - we conform to Salesforce)\n* **Customer-Supplier (we're upstream)**: No downstream systems depend on ProfileService/EngagementService APIs yet (future bounded contexts will consume domain events)\n\n==== Architectural Dependencies on Future Initiatives\n\n*This Architecture Enables Future Initiatives*:\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Future Initiative |Architectural Enablement\n\n|*Flybuys Integration*\n|**ProfileService Contact Reconciliation Reused**: ProfileService establishes pattern for JIT Contact reconciliation with Salesforce, which will be extended for Flybuys partner linking (link:../architecture_definitions/flybuys_integration.adoc[see Flybuys Integration architecture]) +\n**Event Bus Infrastructure**: Domain event publishing pattern (`CustomerEnrolledInLoyalty`, `PartnerLinked`, etc.) reuses Event Bus established for EngagementService\n\n|*LoyaltyService Bounded Context*\n|**Event Bus Subscription**: LoyaltyService will consume `CustomerProfileCreated` events published by ProfileService (future enhancement) +\n**Salesforce Contact Integration**: LoyaltyService may query Salesforce Contacts for customer reward preferences (via ProfileService facade or direct Salesforce API)\n\n|*Web App Feedback Submission*\n|**EngagementService API Reuse**: Web app will call same EngagementService REST API for feedback submission (multi-channel support) +\n**Conformist Pattern**: Web app conforms to EngagementService API contract (no translation required)\n\n|*Multi-Channel Customer Support*\n|**EngagementService Extension**: Add support for email, call centre, POS feedback channels (extend EngagementService to handle multiple origins) +\n**Salesforce Case Origin Field**: Cases already tagged with Origin=Mobile App, extend to Origin=Web, POS, Call Centre, Email\n\n|*Knowledge Base Integration*\n|**EngagementService API Extension**: Add endpoint to query Salesforce Knowledge Base articles, surface in Mobile App for self-service support +\n**Anti-Corruption Layer**: EngagementService translates Salesforce Knowledge API to OTR domain language\n\n|*Customer Satisfaction Surveys*\n|**Event-Driven Trigger**: Subscribe to `SupportCaseResolved` events published by EngagementService, trigger CSAT survey via Braze +\n**Braze Integration Pattern**: Reuse EngagementService → Braze integration pattern for survey campaigns\n\n|*Sentiment Analysis*\n|**Event Subscription**: Subscribe to `CustomerFeedbackSubmitted` events, analyse feedback sentiment (AI/ML service) +\n**EngagementService Extension**: Enrich Case with sentiment score before creating in Salesforce\n\n|*RecommendationService Bounded Context*\n|**Event Subscription**: RecommendationService subscribes to `SupportCaseCreated` events to understand customer pain points and personalize recommendations +\n**Domain Event Pattern**: Reuse Event Bus publishing pattern established by EngagementService\n\n|===\n\n*This Architecture Depends on Future Initiatives*:\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Future Initiative |Dependency Description\n\n|*Salesforce Data Isolation Strategy*\n|**BLOCKER**: Viva Energy Salesforce admin team must define data isolation strategy (Record Types, custom fields, queues) before production deployment +\n**Impact**: Multi-tenant data visibility and security governance\n\n|*Salesforce Case Field Mapping*\n|**BLOCKER**: Viva Energy Salesforce admin team must define field mapping for OTR feedback categories (App, Service, Order, Rewards, Refund, Delete Account) +\n**Impact**: Case creation logic in EngagementService depends on finalized Salesforce schema\n\n|*Salesforce Webhook Mechanism*\n|**BLOCKER**: Viva Energy Salesforce admin team must configure webhook mechanism (Outbound Messages vs Platform Events vs Process Builder) for Case update notifications +\n**Impact**: EngagementService webhook receiver implementation depends on chosen mechanism\n\n|*Event Bus Technology Selection*\n|**DECISION REQUIRED**: Choose Event Bus implementation (SNS+SQS vs EventBridge vs Kinesis) for domain event publishing +\n**Impact**: Infrastructure provisioning, event schema design, consumer implementation\n\n|*Microservice Hosting Platform*\n|**DECISION REQUIRED**: Choose hosting platform for ProfileService and EngagementService (AWS Lambda vs ECS vs EKS) +\n**Impact**: Deployment architecture, auto-scaling strategy, operational overhead\n\n|*Observability Platform*\n|**DECISION REQUIRED**: Choose observability platform (AWS CloudWatch vs Datadog vs New Relic) for monitoring and alerting +\n**Impact**: Dashboard configuration, metric collection, alerting setup\n\n|===\n\n*Future Work After This Initiative*:\n\n* **Event Schema Registry**: Implement event schema versioning and registry for domain events (currently ad-hoc schemas)\n* **API Versioning Strategy**: Define API versioning approach for ProfileService and EngagementService (currently v1 only)\n* **Multi-Region Deployment**: Extend to multi-region for disaster recovery and global availability\n* **Event Store**: Persist domain events for event sourcing and audit trail (currently ephemeral Event Bus only)\n* **CQRS Pattern**: Separate read models for high-volume queries (currently same model for reads/writes)\n* **GraphQL API**: Expose GraphQL API for flexible client queries (currently REST only)\n* **Real-Time Sync**: Bi-directional sync between Salesforce and ProfileService for Contact updates (currently JIT reconciliation only)\n\n=== Technical Risks and Mitigation\n\n[width=\"100%\",cols=\"5%,20%,25%,25%,25%\",options=\"header\",]\n|===\n|ID |Risk |Impact |Likelihood |Mitigation\n\n|RISK-CS-001\n|*Salesforce API rate limits exceeded*: High feedback volume exceeds Salesforce API limits, Cases not created\n|HIGH (customers don't receive Case confirmation, support tickets lost)\n|MEDIUM (volume unknown, rate limits TBD)\n|• Gather expected feedback volume data before cutover +\n• Implement Event Bus queue throttling/rate limiting +\n• Monitor queue depth and API usage +\n• Scale background workers based on queue depth +\n• Alert ops team when approaching rate limits\n\n|RISK-CS-002\n|*Salesforce downtime*: Salesforce Service Cloud outage prevents Case creation\n|MEDIUM (Cases delayed but queued, customers wait for confirmation)\n|LOW (Salesforce SLA 99.9% uptime)\n|• Async Case creation with retry logic +\n• Event Bus queues buffer work during outage +\n• Customers get immediate \"Feedback submitted\" (not blocked) +\n• Monitor Salesforce status page, alert ops team +\n• Automatic retry when Salesforce recovers\n\n|RISK-CS-003\n|*Contact migration data quality issues*: App database Contact data incomplete or invalid\n|HIGH (migration fails validation, cutover delayed)\n|MEDIUM (legacy data quality unknown)\n|• Pre-migration data quality assessment +\n• Flexible upsert logic (match by email/phone/VCI) +\n• Validation report identifies data issues before production migration +\n• Manual cleanup for invalid records +\n• Dry-run migration in sandbox environment\n\n|RISK-CS-004\n|*Duplicate Contacts created*: Email matching fails, ProfileService creates duplicate Contacts\n|MEDIUM (support agents see multiple profiles for same customer)\n|MEDIUM (email changes, data quality issues)\n|• Salesforce duplicate detection rules (if available) +\n• ProfileService logs Contact creation for audit trail +\n• Manual duplicate cleanup process (support team) +\n• Future enhancement: VCI as Salesforce External ID for stable matching\n\n|RISK-CS-005\n|*Dead letter queue accumulation*: Failed Case creations not processed, queue grows\n|HIGH (customers don't receive Case confirmation, feedback lost)\n|LOW (retry logic handles most failures)\n|• Dead letter queue monitoring and alerting +\n• Ops team dashboard showing DLQ depth +\n• Manual intervention process (investigate and reprocess) +\n• Automated alerts when DLQ depth exceeds threshold +\n• Root cause analysis for recurring failures\n\n|RISK-CS-006\n|*Salesforce webhook failures*: Salesforce can't deliver Case update notifications to EngagementService\n|MEDIUM (customers don't get push notifications for Case resolution)\n|LOW (webhook mechanism reliable)\n|• Webhook retry logic and exponential backoff +\n• EngagementService logs webhook deliveries +\n• Monitor webhook delivery success rate +\n• Fallback: Poll Salesforce API for Case updates (if webhook fails persistently) +\n• Alert ops team when webhook delivery rate drops\n\n|RISK-CS-007\n|*Multi-tenant data isolation breach*: OTR digital Cases visible to other Viva Energy support teams\n|HIGH (privacy violation, compliance risk)\n|LOW (Salesforce governance controls)\n|• Work with Viva Energy Salesforce admin team on data isolation strategy +\n• Test data visibility in Salesforce sandbox (UAT with different user roles) +\n• Validate Record Types, queues, field-level security before production +\n• Audit Salesforce user permissions and sharing rules\n\n|RISK-CS-008\n|*Mobile App release coordination*: App release delayed, cutover window missed\n|MEDIUM (cutover delayed, D365 CE retirement delayed)\n|MEDIUM (release schedule conflicts)\n|• Coordinate cutover timing with Mobile team early +\n• Buffer time in migration plan (2-week contingency) +\n• Decouple backend deployment from Mobile App release (backend deployed first, app follows) +\n• Feature flag for feedback submission (enable when ready)\n\n|RISK-CS-009\n|*Event Bus infrastructure issues*: SNS/SQS/EventBridge downtime or misconfiguration\n|HIGH (Case creation blocked, domain events not published)\n|LOW (AWS SLA 99.99% uptime)\n|• Leverage existing AWS infrastructure (proven, reliable) +\n• Infrastructure as Code (IaC) for Event Bus configuration +\n• Integration testing in non-production environment +\n• Monitor Event Bus metrics (queue depth, throughput, errors) +\n• Alert ops team on Event Bus failures\n\n|RISK-CS-010\n|*Team DDD knowledge gap*: Team unfamiliar with DDD patterns, bounded contexts, event-driven architecture\n|MEDIUM (implementation delays, architectural inconsistencies)\n|HIGH (first DDD implementation)\n|• DDD training for development team (workshops, documentation) +\n• Architecture review sessions (validate bounded context design) +\n• Pair programming with experienced DDD practitioners +\n• Incremental implementation (start small, iterate) +\n• Document architectural patterns in CLAUDE.md\n\n|===\n\n== Assumptions and Constraints\n\n=== Assumptions\n\n[width=\"100%\",cols=\"8%,92%\",options=\"header\",]\n|===\n|ID |Assumption\n\n|ASM-CS-001\n|Viva Energy Salesforce admin team will provide Salesforce production access, sandbox environment, and support for Case field mapping and data isolation configuration\n\n|ASM-CS-002\n|App database Contact data is sufficiently complete for migration (email/phone/VCI available for matching)\n\n|ASM-CS-003\n|Expected customer feedback volume (100-150 submissions/day from 20k DAU) is well within Salesforce API rate limits, with capacity planning for 3x-10x growth\n\n|ASM-CS-004\n|Existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis) is sufficient for Event Bus implementation (no additional infrastructure provisioning required)\n\n|ASM-CS-005\n|Braze integration already exists and can be extended for Case-related push notifications (no new Braze account or major configuration changes)\n\n|ASM-CS-006\n|Mobile App users have email addresses associated with their accounts (required for ProfileService Contact reconciliation)\n\n|ASM-CS-007\n|D365 Customer Engagement historical Cases have limited business value and do not require migration to Salesforce\n\n|ASM-CS-008\n|Support agents are trained on Salesforce Service Cloud and require minimal additional training for OTR digital customer Cases\n\n|ASM-CS-009\n|Salesforce Service Cloud shared instance has capacity for OTR digital customer Contacts and Cases (no additional licensing or storage costs)\n\n|ASM-CS-010\n|Mobile App release schedule can accommodate cutover timing (Week 10 in migration plan)\n\n|===\n\n=== Constraints\n\n[width=\"100%\",cols=\"8%,92%\",options=\"header\",]\n|===\n|ID |Constraint\n\n|CON-CS-001\n|Must use shared Viva Energy Salesforce Service Cloud instance (cannot deploy separate OTR-specific instance)\n\n|CON-CS-002\n|Must conform to existing Salesforce configuration and governance (Record Types, custom fields, queues, data isolation strategy defined by Viva Energy admin team)\n\n|CON-CS-003\n|Contact migration must complete before Mobile App cutover (no parallel run of D365 CE and Salesforce)\n\n|CON-CS-004\n|Big bang cutover only (no phased rollout with feature flags or pilot users)\n\n|CON-CS-005\n|Salesforce API rate limits and authentication method constrained by Viva Energy Salesforce configuration (TBD)\n\n|CON-CS-006\n|Event Bus implementation must use existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis - cannot introduce new infrastructure components)\n\n|CON-CS-007\n|Mobile App feedback form must include specific fields: Category, Store Name, Time of Visit, Contact Phone Number, Free Text Message (no attachments)\n\n|CON-CS-008\n|D365 Customer Engagement must be decommissioned within 90 days post-cutover (ADR-CS-006)\n\n|CON-CS-009\n|ProfileService and EngagementService must be stateless (no local aggregate persistence, Salesforce is System of Record)\n\n|CON-CS-010\n|First DDD bounded context implementation (team learning curve, architectural patterns must be documented for future bounded contexts)\n\n|===\n\n== Non-Functional Requirements\n\n=== Performance Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-PERF-001\n|Mobile App feedback submission API response time (ProfileService + EngagementService)\n|p95 < 1 second, p99 < 2 seconds\n\n|NFR-PERF-002\n|ProfileService Contact reconciliation API response time (JIT lookup)\n|p95 < 500ms, p99 < 1 second\n\n|NFR-PERF-003\n|EngagementService async Case creation latency (end-to-end: feedback submitted → Case created in Salesforce)\n|p95 < 5 minutes, p99 < 10 minutes\n\n|NFR-PERF-004\n|Salesforce API call latency (Contact query, Contact create, Case create)\n|p95 < 2 seconds, p99 < 5 seconds\n\n|NFR-PERF-005\n|Event Bus message processing throughput\n|> 100 messages/second (support peak feedback volume)\n\n|NFR-PERF-006\n|Braze push notification delivery latency (Case created → notification delivered)\n|p95 < 30 seconds, p99 < 60 seconds\n\n|===\n\n=== Availability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-AVAIL-001\n|ProfileService availability\n|99.9% uptime (8.76 hours downtime/year)\n\n|NFR-AVAIL-002\n|EngagementService availability\n|99.9% uptime (8.76 hours downtime/year)\n\n|NFR-AVAIL-003\n|Feedback submission success rate (including async Case creation)\n|> 99.5% (includes retry logic for transient failures)\n\n|NFR-AVAIL-004\n|Graceful degradation: Salesforce downtime handling\n|Feedback submission still succeeds, Cases queued for async creation when Salesforce recovers\n\n|NFR-AVAIL-005\n|Graceful degradation: Braze downtime handling\n|Case creation proceeds, push notifications disabled temporarily (feature flag)\n\n|NFR-AVAIL-006\n|Planned maintenance window\n|< 4 hours/month, scheduled during low-traffic periods (2-6am ACST)\n\n|===\n\n=== Scalability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-SCALE-001\n|Concurrent Mobile App users (peak)\n|Support 20,000 DAU (Daily Active Users), ~150 concurrent users submitting feedback during peak hours\n\n|NFR-SCALE-002\n|Feedback submissions per day\n|Expected: 100-150 submissions/day based on 20k DAU (~0.5-0.75% submission rate) +\nCapacity: Support 500 submissions/day (3x expected volume for growth), 2,000 submissions/day (peak/incident scenarios)\n\n|NFR-SCALE-003\n|Auto-scaling: ProfileService and EngagementService\n|Auto-scale based on CPU/memory/request rate, scale up within 2 minutes\n\n|NFR-SCALE-004\n|Event Bus queue capacity\n|Support 100,000 queued messages (buffer for Salesforce downtime)\n\n|NFR-SCALE-005\n|Salesforce API rate limit compliance\n|Stay within 80% of Salesforce API rate limits (buffer for spikes)\n\n|NFR-SCALE-006\n|Future growth capacity\n|Architecture supports 10x growth (1,000-1,500 submissions/day based on 200k DAU) without major redesign\n\n|===\n\n=== Security Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-SEC-001\n|Mobile App authentication\n|Microsoft Entra External ID OAuth 2.0 with JWT tokens (existing CIAM)\n\n|NFR-SEC-002\n|API authorisation: ProfileService and EngagementService\n|JWT token validation, authenticated users only, user context propagation\n\n|NFR-SEC-003\n|Salesforce API authentication\n|OAuth 2.0 with Connected App and JWT bearer flow (service account)\n\n|NFR-SEC-004\n|Data encryption in transit\n|TLS 1.2+ for all API calls (Mobile App ↔ ProfileService/EngagementService ↔ Salesforce ↔ Braze)\n\n|NFR-SEC-005\n|Data encryption at rest\n|Salesforce encryption at rest (managed by Salesforce), Event Bus message encryption (AWS KMS)\n\n|NFR-SEC-006\n|Secret management\n|AWS Secrets Manager for Salesforce credentials, Braze API keys, OAuth tokens (no hardcoded secrets)\n\n|NFR-SEC-007\n|PII data handling\n|Contact data (email, phone, name) treated as PII, GDPR-compliant retention policies (Salesforce governance)\n\n|NFR-SEC-008\n|API rate limiting and throttling\n|API Gateway rate limiting (100 requests/second per user), prevent abuse and DoS\n\n|NFR-SEC-009\n|Logging and auditing\n|Log all API calls, Salesforce Contact/Case creates/updates, Event Bus publishes (no PII in logs)\n\n|NFR-SEC-010\n|Salesforce data isolation\n|Multi-tenant data isolation via Salesforce Record Types, queues, sharing rules (defined by Viva Energy admin team)\n\n|===\n\n=== Reliability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-REL-001\n|Retry logic: EngagementService → Salesforce Case creation\n|Exponential backoff (1s, 2s, 4s, 8s, 16s), max 5 retries, then dead letter queue\n\n|NFR-REL-002\n|Dead letter queue monitoring\n|Alert ops team immediately when DLQ depth > 0 (failed Case creations require manual intervention)\n\n|NFR-REL-003\n|Event Bus message durability\n|Messages persisted in Event Bus (SNS+SQS/EventBridge/Kinesis), not lost on service restart\n\n|NFR-REL-004\n|Idempotency: Case creation\n|EngagementService ensures duplicate feedback submissions don't create duplicate Cases (idempotency key)\n\n|NFR-REL-005\n|Circuit breaker: Salesforce API calls\n|Open circuit after 5 consecutive failures, half-open retry after 30 seconds\n\n|NFR-REL-006\n|Health checks: ProfileService and EngagementService\n|Health endpoints for load balancer checks, readiness and liveness probes\n\n|NFR-REL-007\n|Disaster recovery: Event Bus\n|Event Bus messages replicated across AWS availability zones (SQS/EventBridge/Kinesis HA)\n\n|===\n\n=== Maintainability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-MAINT-001\n|Code quality: ProfileService and EngagementService\n|> 80% test coverage (unit + integration tests), automated CI/CD pipeline\n\n|NFR-MAINT-002\n|API documentation\n|OpenAPI/Swagger specs for ProfileService and EngagementService, auto-generated API docs\n\n|NFR-MAINT-003\n|Deployment automation\n|Infrastructure as Code (Terraform/CloudFormation/CDK), zero-downtime deployments\n\n|NFR-MAINT-004\n|Logging: structured logs\n|JSON-formatted logs with correlation IDs, log levels (DEBUG, INFO, WARN, ERROR), centralized log aggregation\n\n|NFR-MAINT-005\n|Monitoring dashboards\n|Real-time dashboards for ProfileService, EngagementService, Event Bus (see Monitoring and Observability section)\n\n|NFR-MAINT-006\n|Alerting and on-call\n|PagerDuty/Opsgenie integration for P1/P2 alerts, on-call rotation for ops team\n\n|NFR-MAINT-007\n|Configuration management\n|Externalized configuration (environment variables, AWS Parameter Store), no hardcoded config\n\n|NFR-MAINT-008\n|Versioning: API and events\n|Semantic versioning (v1, v2), backward compatibility for API changes, event schema evolution\n\n|===\n\n=== Usability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-USE-001\n|Feedback submission UX\n|Mobile App user receives immediate \"Feedback submitted\" confirmation (< 1 second), not blocked by async Case creation\n\n|NFR-USE-002\n|Push notification delivery\n|Customer receives \"Your feedback has been received\" notification within 30 seconds of Case creation in Salesforce\n\n|NFR-USE-003\n|Case resolution notification\n|Customer receives \"Your case has been resolved\" notification within 30 seconds of support agent resolving Case\n\n|NFR-USE-004\n|Error messaging\n|User-friendly error messages for failed feedback submission (not technical errors), retry prompts\n\n|NFR-USE-005\n|Accessibility\n|Mobile App feedback form meets WCAG 2.1 AA accessibility standards (existing Mobile App compliance)\n\n|===\n\n=== Compliance Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-COMP-001\n|GDPR compliance: PII data\n|Customer Contact data (email, phone, name) managed per GDPR retention policies (Salesforce governance)\n\n|NFR-COMP-002\n|GDPR compliance: Right to erasure\n|Support \"Delete Account\" feedback category, trigger Contact deletion in Salesforce per GDPR Article 17\n\n|NFR-COMP-003\n|Data residency\n|Salesforce data residency governed by Viva Energy Salesforce configuration (regional compliance)\n\n|NFR-COMP-004\n|Audit trail\n|All Contact creates/updates, Case creates/updates logged for compliance auditing (Salesforce audit logs)\n\n|NFR-COMP-005\n|API security standards\n|OWASP API Security Top 10 compliance (injection prevention, authentication, authorisation, data exposure)\n\n|===\n\n== Monitoring and Observability\n\n=== Key Metrics\n\n[width=\"100%\",cols=\"25%,40%,35%\",options=\"header\",]\n|===\n|Metric Category |Metric |Target/Threshold\n\n|*Feedback Submission*\n|Feedback submission success rate (Mobile App → EngagementService)\n|> 99.5%\n\n|*Async Case Creation*\n|Case creation success rate (EngagementService → Salesforce)\n|> 99%\n\n|*Async Case Creation*\n|Case creation latency (time from feedback submission to Case created in Salesforce)\n|p95 < 5 minutes\n\n|*Event Bus*\n|Event Bus queue depth (pending Case creations)\n|< 100 messages\n\n|*Event Bus*\n|Dead letter queue depth (failed Case creations)\n|= 0 (alert on any failures)\n\n|*Salesforce API*\n|Salesforce API error rate\n|< 1%\n\n|*Salesforce API*\n|Salesforce API latency (Case creation)\n|p95 < 2 seconds\n\n|*Salesforce API*\n|Salesforce API rate limit utilization\n|< 80% of limit\n\n|*ProfileService*\n|Contact reconciliation success rate (JIT lookups)\n|> 99.5%\n\n|*ProfileService*\n|Contact reconciliation latency\n|p95 < 500ms\n\n|*Braze Notifications*\n|Push notification delivery rate (Case created/updated)\n|> 95%\n\n|*Salesforce Webhook*\n|Webhook delivery success rate (Salesforce → EngagementService)\n|> 99%\n\n|*Customer Satisfaction*\n|Customer satisfaction score (CSAT)\n|> 4.0/5.0 (improve by 15% from D365 CE baseline)\n\n|*Support Operations*\n|Average case resolution time\n|Decrease by 20% from D365 CE baseline\n\n|===\n\n=== Alerting Thresholds\n\n[width=\"100%\",cols=\"25%,50%,25%\",options=\"header\",]\n|===\n|Alert |Condition |Severity\n\n|*Feedback submission failures*\n|Feedback submission success rate < 95% over 5-minute window\n|P1 - Critical\n\n|*Dead letter queue accumulation*\n|Dead letter queue depth > 0 (any failed Case creations)\n|P2 - High\n\n|*Event Bus queue backlog*\n|Event Bus queue depth > 100 messages for > 15 minutes\n|P2 - High\n\n|*Salesforce API errors*\n|Salesforce API error rate > 5% over 5-minute window\n|P1 - Critical\n\n|*Salesforce API rate limits*\n|Salesforce API rate limit utilization > 90%\n|P2 - High\n\n|*Contact reconciliation failures*\n|ProfileService Contact reconciliation failure rate > 5% over 5-minute window\n|P2 - High\n\n|*Braze notification failures*\n|Braze push notification delivery rate < 80% over 15-minute window\n|P3 - Medium\n\n|*Salesforce webhook failures*\n|Salesforce webhook delivery success rate < 90% over 15-minute window\n|P2 - High\n\n|*Case creation latency*\n|Case creation latency p95 > 10 minutes\n|P3 - Medium\n\n|===\n\n=== Dashboards\n\n*ProfileService Dashboard:*\n\n* Contact reconciliation success rate (JIT lookups)\n* Contact reconciliation latency (p50, p95, p99)\n* Contact creation vs update ratio (new Contacts created vs existing Contacts updated)\n* Salesforce API error rate (Contact queries and creates)\n* Request rate and throughput\n\n*EngagementService Dashboard:*\n\n* Feedback submission success rate\n* Case creation success rate (async workflow)\n* Case creation latency (p50, p95, p99)\n* Event Bus queue depth (pending Case creations)\n* Dead letter queue depth (failed Case creations)\n* Salesforce API error rate (Case creation)\n* Salesforce API latency\n* Salesforce API rate limit utilization\n* Braze push notification delivery rate\n* Salesforce webhook delivery success rate\n\n*Event Bus Dashboard:*\n\n* Queue depth (pending messages)\n* Throughput (messages published/consumed per minute)\n* Dead letter queue depth (failed messages)\n* Consumer lag (time between publish and consume)\n\n*Customer Support Dashboard (Business Metrics):*\n\n* Total feedback submissions per day/week/month\n* Feedback category breakdown (App, Service, Order, Rewards, Refund, Delete Account)\n* Customer satisfaction score (CSAT) trend\n* Average case resolution time trend\n* Case volume by support team/queue\n* Unified customer view adoption (support agent feedback)\n<<<\n== Solution Validation\n\nThis section defines the validation criteria and testing approach for the solution.\n\n=== Functional Validation\n\n==== ProfileService API Testing\n\n*Test Scenarios*:\n1. **Happy Path**: Authenticated user requests Contact ID, existing Contact found in Salesforce, Contact ID returned\n2. **JIT Creation**: Authenticated user requests Contact ID, no existing Contact, new Contact created in Salesforce, Contact ID returned\n3. **Salesforce API Failure**: Salesforce unavailable, ProfileService returns 500 error, user retries\n4. **Invalid JWT**: Unauthenticated request, ProfileService returns 401 error\n\n*Acceptance Criteria*:\n- Contact reconciliation success rate > 99.5%\n- JIT Contact creation completes within 500ms (p95)\n\n==== EngagementService API Testing\n\n*Test Scenarios*:\n1. **Happy Path**: Valid feedback submission, immediate 202 Accepted response, Case created in Salesforce within 5 minutes, Braze notification delivered\n2. **Invalid Category**: Invalid feedback category, 400 Bad Request response with validation error\n3. **Salesforce Downtime**: Salesforce unavailable during async Case creation, message queued, retry logic executes, Case created when Salesforce recovers\n4. **Dead Letter Queue**: Case creation fails after 5 retries, message moved to DLQ, ops team alerted\n5. **Webhook Notification**: Support agent resolves Case in Salesforce, webhook triggers EngagementService, Braze push notification sent to customer\n\n*Acceptance Criteria*:\n- Feedback submission success rate > 99.5% (including async Case creation)\n- Async Case creation completes within 5 minutes (p95)\n- Webhook delivery success rate > 99%\n\n=== Non-Functional Validation\n\n==== Performance Testing\n\n*Load Testing*:\n\n*Baseline*: Expected 100-150 submissions/day from 20k DAU (~0.5-0.75% submission rate)\n\n- **Normal Load**: 1 submission/minute sustained for 2 hours (simulate typical daily pattern)\n- **3x Load**: 3 submissions/minute sustained for 1 hour (simulate busy period, 450 submissions/day)\n- **Peak Load (10x)**: 10 submissions/minute for 15 minutes (simulate incident scenario, app outage causing backlog)\n- **Stress Test**: 50 submissions/minute for 5 minutes (find breaking point, 20x normal)\n\n*Validation*:\n- API response time p95 < 1 second under 10x load\n- Event Bus queue depth remains manageable (< 100 messages)\n- No Case creation failures, all submissions processed successfully\n- Auto-scaling triggers appropriately for sustained load > 3x baseline\n\n*Acceptance Criteria*:\n- NFR-PERF-001 through NFR-PERF-006 validated under realistic load (3x and 10x baseline)\n- Auto-scaling triggers within 2 minutes of load increase\n- System handles 10x peak gracefully, 20x stress test identifies limits\n\n==== Resilience Testing\n\n*Salesforce API Failure Scenarios*:\n1. **Complete Outage**: Salesforce unavailable for 2 hours, Event Bus queues buffer work, Cases created when Salesforce recovers\n2. **Rate Limit Exceeded**: Salesforce rate limit hit, queue throttling activates, Cases created within SLA\n\n*Acceptance Criteria*:\n- NFR-AVAIL-004 validated (graceful degradation during Salesforce downtime)\n- Circuit breaker activates after 5 consecutive failures\n\n==== Security Validation\n\n*Penetration Testing*:\n- API authentication bypass attempts\n- SQL injection attempts\n- Webhook signature validation bypass\n\n*Acceptance Criteria*:\n- NFR-SEC-001 through NFR-SEC-010 validated\n- OWASP API Security Top 10 compliance verified\n\n=== Integration Validation\n\n==== End-to-End Testing\n\n*Full User Journey*:\n1. User authenticates via Microsoft Entra External ID\n2. Mobile App requests Contact ID from ProfileService (JIT reconciliation)\n3. User submits feedback via EngagementService\n4. Background worker creates Case in Salesforce\n5. Braze notification delivered to user\n6. Support agent resolves Case in Salesforce\n7. Salesforce webhook triggers EngagementService\n8. Braze notification delivered to user\n\n*Acceptance Criteria*:\n- End-to-end flow completes successfully in UAT\n- User receives both \"feedback submitted\" and \"case resolved\" notifications\n","structuredPatch":[{"oldStart":1532,"oldLines":6,"newStart":1532,"newLines":7,"lines":[" "," |==="," ","+[[wp-cs-001]]"," === WP-CS-001: ProfileService Development"," "," ==== Description"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"e7bc75bc-9cd3-46f3-a6d6-7ed7d035abf2"}
{"parentUuid":"97bd92e9-4fe7-4821-8725-bbe5035b0268","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01WTq9oRWFxWRPeHZSsycCZB","type":"tool_result","content":"The file /mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n  1585→* Unit test coverage > 80%\n  1586→* Integration tests pass in sandbox environment\n  1587→* API documentation generated from OpenAPI specification\n  1588→\n  1589→[[wp-cs-002]]\n  1590→=== WP-CS-002: EngagementService Development\n  1591→\n  1592→==== Description\n  1593→\n  1594→Build EngagementService bounded context microservice implementing customer feedback submission, Anti-Corruption Layer for Salesforce Case creation, Braze integration, and webhook receiver for Case updates.\n  1595→\n  1596→==== Deliverables"}]},"uuid":"3a33d56e-aa6a-47d9-a851-d8bb07e38d3d","timestamp":"2026-01-09T03:10:43.982Z","toolUseResult":{"filePath":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","oldString":"=== WP-CS-002: EngagementService Development\n\n==== Description","newString":"[[wp-cs-002]]\n=== WP-CS-002: EngagementService Development\n\n==== Description","originalFile":"= Salesforce Customer Support - Solution Architecture\n:project-name: Salesforce Customer Support\n:togaf-adm-phase: Phase E: Opportunities & Solutions\n:last-updated: 2026-01-07\n:document-type: Solution Architecture Document\n:status: Discovery\n:version: 0.1\n:domain: Customer Support & Engagement\n:programme-lead:\n:domain-architect: O.Young@otr.com.au\n:architecture-definition: xref:architecture-definitions:salesforce_customer_support.adoc[Architecture Definitions/Salesforce Customer Support]\n:doctype: article\n:toc: left\n:toclevels: 4\n:sectanchors:\n:sectlinks:\n:sectnums:\n:icons: font\n:source-highlighter: highlightjs\n:experimental:\n:description:\n:keywords:\n\n<<<\n== Purpose and Scope\n\n=== Purpose\n\nThis Solution Architecture defines how the Salesforce Customer Support consolidation will be implemented - the specific technology products, configurations, interfaces, and deployment architecture that realise the xref:architecture-definitions:salesforce_customer_support.adoc[Salesforce Customer Support Architecture Definition].\n\nThis solution establishes the **first implementation of OTR's target Domain-Driven Design (DDD) architecture** by deploying two new bounded contexts (`ProfileService` and `EngagementService`) as microservices, consolidating customer support onto Salesforce Service Cloud, and implementing event-driven integration patterns that will serve as the foundation for future bounded contexts (including Flybuys integration).\n\n=== Vision\n\n> Unify customer support across all OTRG channels by consolidating OTR digital customer feedback onto Salesforce Service Cloud, establishing the foundational DDD architecture with ProfileService and EngagementService bounded contexts that protect digital channels from external system changes while enabling support agents to deliver exceptional customer experiences with complete interaction history.\n\n=== Architectural Approach\n\nThis architecture establishes OTR's **first bounded context implementation** using Domain-Driven Design strategic patterns:\n\n* *link:../bounded_context/profile.adoc[ProfileService]* (NEW bounded context): Just-In-Time Contact reconciliation with Salesforce, upsert by email, returns Salesforce Contact ID to digital channels - foundation for future Flybuys partner linking\n* *link:../bounded_context/engagement.adoc[EngagementService]* (NEW bounded context): Customer feedback submission facade, Anti-Corruption Layer for Salesforce Case creation, Braze integration for all outbound customer communications (push, email, SMS), async Case processing via Event Bus\n* *Event-driven integration* (NEW pattern): Domain event publishing using existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis) - first implementation establishing pattern for future bounded contexts\n* *Anti-Corruption Layer*: EngagementService isolates digital channels from Salesforce API changes, translates between OTR domain language and Salesforce Service Cloud API\n* *Conformist Pattern*: ProfileService and EngagementService conform to existing Salesforce configuration (shared Viva Energy instance, multi-tenant governance)\n* *Big bang cutover*: Single deployment after Contact migration, no phased rollout, D365 CE retirement post-cutover\n\n=== Scope\n\n==== In Scope\n\n* Solution Building Blocks (SBBs) - specific technology products and versions\n* Interface specifications (APIs, events, data formats)\n* Data architecture and schema specifications\n* Deployment architecture and infrastructure configuration\n* Transition architecture with migration phases\n* Technical validation criteria and testing approach\n* External system integration specifications\n* Physical data models and API schemas\n\n==== Out of Scope\n\n===== Covered in xref:architecture-definitions:salesforce_customer_support.adoc[Architecture Definition]\n\n* Business requirements and stakeholder analysis\n* Architecture decisions and rationale (ADRs)\n* Bounded context definitions and responsibilities\n* High-level integration patterns (ACL, Conformist, OHS+PL)\n* Business capability mapping and value streams\n* Architecture principles and governance\n\n===== Covered in Other Documents\n\n* Detailed design (class diagrams, sequence diagrams for all flows)\n* Implementation code and unit tests\n* Business case and return-on-investment analysis\n* Operational run books and support procedures\n\n<<<\n=== Architecture Overview\n\n[mermaid]\n----\n---\nconfig:\n  layout: elk\n---\nflowchart TB\n    Customer([\"Customer\"]) -- Uses --> MobileApp[\"Mobile App<br>iOS/Android\"]\n    Customer -- Shops at --> POS[\"OTR/OTR+ POS<br>D365 Commerce\"]\n    MobileApp -- Authenticate --> EntraID[\"Microsoft Entra\"]\n    MobileApp -- Identifies & Reconciles --> ProfileService[\"ProfileService\"]\n    ProfileService <-- Reconcile App User as Salesforce Contact --> Salesforce[\"Salesforce\"]\n    ProfileService -- On Create --> EventBus[\"EventBus\"]\n    EventBus -- Emits CreateUser Event --> LoyaltyService[\"LoyaltyService\"] & EngagementService[\"EngagementService\"]\n    LoyaltyService -- Reconcile Wallet --> EagleEye[\"EagleEye\"]\n    EngagementService -- Reconcile Braze Profile --> Braze[\"Braze\"]\n    EngagementService --> Salesforce\n    D365CE[\"D365CE\"] -- Data Migration --> Salesforce\n    MobileApp -- Submits Feedback --> EngagementService\n\n    Customer:::customer\n    MobileApp:::presentation\n    POS:::presentation\n    EntraID:::external\n    ProfileService:::newService\n    Salesforce:::external\n    EventBus:::infrastructure\n    LoyaltyService:::newService\n    EngagementService:::newService\n    EagleEye:::external\n    Braze:::external\n    D365CE:::external\n    classDef newService fill:#4CAF50,stroke:#2E7D32,stroke-width:3px,color:#fff\n    classDef external fill:#FF9800,stroke:#E65100,stroke-width:2px,color:#fff\n    classDef infrastructure fill:#2196F3,stroke:#0D47A1,stroke-width:2px,color:#fff\n    classDef presentation fill:#9C27B0,stroke:#4A148C,stroke-width:2px,color:#fff\n    classDef customer fill:#607D8B,stroke:#263238,stroke-width:2px,color:#fff\n----\n\n\n==== Key Architectural Patterns\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Pattern |Application |Rationale\n\n|*Anti-Corruption Layer (ACL)*\n|EngagementService → Salesforce Service Cloud\n|Protects digital channels (Mobile App, Web) from Salesforce API changes, translates between OTR domain language and Salesforce Case/Contact model, enables independent evolution of internal domain model\n\n|*Conformist*\n|ProfileService → Salesforce, EngagementService → Salesforce\n|Shared Viva Energy Salesforce instance - we conform to existing configuration, governance, and API contracts (external system we don't control)\n\n|*Backend-for-Frontend (BFF)*\n|EngagementService\n|Aggregates customer feedback submission, Contact lookup, async Case creation, and Braze notification orchestration for digital channel clients\n\n|*Event-Driven Architecture (OHS+PL)*\n|Event Bus (SNS+SQS/EventBridge/Kinesis)\n|Loose coupling between bounded contexts, async domain event publishing (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`), foundation for future bounded contexts\n\n|*Just-In-Time (JIT) Integration*\n|ProfileService → Salesforce Contact reconciliation\n|Reconcile app users as Salesforce Contacts on-demand (upsert by email), no pre-sync required, ensures Salesforce has current Contact data\n\n|*Async Processing*\n|EngagementService Case creation via Event Bus\n|Non-blocking user experience, resilience to Salesforce downtime, automatic retry with exponential backoff, dead letter queue for operations team intervention\n\n|*Strangler Fig*\n|Not applicable\n|Big bang cutover (no gradual migration) - D365 CE fully replaced, not incrementally strangled\n\n|===\n\n<<<\n== Solution Approach\n\n* Deploy xref:bounded-contexts:profile.adoc[ProfileService] and xref:bounded-contexts:engagement.adoc[EngagementService] as bounded context microservices\n* Implement Anti-Corruption Layers (ACLs) for Salesforce and Braze integration\n* Establish event-driven architecture as the foundational integration pattern\n* Big bang cutover (TS-1 → TS-4)\n\n=== Related Documentation\n\nThis solution architecture references detailed technical specifications:\n\n==== Architecture Definition\n\n* xref:architecture-definitions:salesforce_customer_support.adoc[Salesforce Customer Support - Architecture Definition] - Business requirements, architecture decisions (ADRs), bounded context definitions, high-level integration patterns\n\n==== Bounded Context Specifications\n\n* xref:bounded-contexts:profile.adoc[ProfileService Bounded Context] - JIT Contact reconciliation, aggregate definitions\n* xref:bounded-contexts:engagement.adoc[EngagementService Bounded Context] - Customer feedback facade, Anti-Corruption Layer\n\n==== Interface Specifications\n\nDetailed API specifications available in the specifications directory:\n\n* link:../../specifications/rest/profile-service-v1.yaml[ProfileService REST API v1] - OpenAPI 3.0 specification for `/profile/v1` endpoints (includes Salesforce Contact reconciliation `GET /contact-id`)\n* link:../../specifications/rest/engagement-service-v1.yaml[EngagementService REST API v1] - OpenAPI 3.0 specification for `/engagement/v1` endpoints (includes `POST /feedback`)\n* link:../../specifications/events/engagement-events.json[Engagement Domain Events] - CloudEvents 1.0 JSON Schema for `SupportCaseCreated`, `SupportCaseUpdated`, `SupportCaseResolved`, `CustomerFeedbackSubmitted`\n\n==== External System Documentation\n\n* https://developer.salesforce.com/docs/atlas.en-us.api_rest.meta/api_rest/[Salesforce REST API Documentation] - Contact and Case object APIs\n* https://www.braze.com/docs/api/endpoints/messaging/send_messages/post_send_triggered_campaigns/[Braze Campaign Trigger API] - Push notification campaigns\n\n<<<\n== Executive Summary\n\n=== Challenge\n\nOTR digital customers (Mobile App, Web) currently submit feedback and support requests to D365 Customer Engagement, while Viva Energy's broader business units (fuel wholesale, Shell Card customers, other retail channels) use Salesforce Service Cloud. This creates:\n\n* *Fragmented customer support platform*: Customer support data split across two systems, preventing support agents from having a unified view of customer interactions across all channels\n* *Operational inefficiency*: Maintaining two separate customer support platforms increases operational overhead and costs\n* *Poor support experience*: D365 CE is not working well for digital customer support, impacting customer satisfaction and case resolution times\n* *Post-merger consolidation opportunity*: Following Viva Energy's acquisition of OTR, strategic alignment on Salesforce as the enterprise customer support platform\n\n=== Solution\n\nThis architecture establishes the **foundational Domain-Driven Design (DDD) implementation** for OTR's target state architecture by introducing two new bounded contexts (link:../bounded_context/profile.adoc[ProfileService], link:../bounded_context/engagement.adoc[EngagementService]) and event-driven integration patterns:\n\n==== New Bounded Contexts\n\n* *link:../bounded_context/profile.adoc[ProfileService]* (NEW): Just-In-Time (JIT) Contact reconciliation with Salesforce, upsert by email, returns Salesforce Contact ID to Mobile App\n* *link:../bounded_context/engagement.adoc[EngagementService]* (NEW): Customer feedback submission, Anti-Corruption Layer (ACL) for Salesforce Case creation, Braze integration for all outbound customer communications (push, email, SMS), async Case processing via Event Bus\n* *Event Bus* (NEW pattern): Domain event publishing using existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis) - first implementation of event-driven architecture pattern\n\n==== Integration Architecture\n\n* *Salesforce = System of Record*: Salesforce Service Cloud (shared Viva Energy instance) owns Contact and Case data\n* *Conformist Pattern*: ProfileService and EngagementService conform to existing Salesforce configuration and API contracts\n* *Anti-Corruption Layer*: EngagementService protects digital channels from Salesforce API changes, translates between OTR domain language and Salesforce\n* *Async Case Creation*: Non-blocking user experience, resilience to Salesforce downtime, automatic retry with exponential backoff, dead letter queue for failed Cases\n* *Event-Driven Notifications*: Salesforce webhook → EngagementService → Braze for all customer communications (push, email, SMS) on Case status updates\n\n==== Migration Approach\n\n* *Contact Migration*: One-time migration from app-specific database → Salesforce (upsert with flexible matching by email/phone/VCI)\n* *No Case Migration*: Historical D365 CE Cases not migrated (fresh start in Salesforce)\n* *Big Bang Cutover*: Single deployment, no phased rollout or parallel run\n* *D365 CE Retirement*: Complete decommissioning of D365 Customer Engagement post-cutover\n\n=== Key Architectural Significance\n\nThis migration establishes the first implementation of OTR's target DDD architecture:\n\n* First bounded contexts implemented (ProfileService, EngagementService)\n* First event-driven domain event pattern (foundation for future bounded contexts)\n* Foundation for Flybuys integration (ProfileService Contact reconciliation reused)\n* Establishes integration patterns (Conformist, ACL, Event-Driven) for future services\n\n=== Success Criteria\n\n* All digital customer feedback routed to Salesforce Service Cloud within 30 days of launch\n* Support agents have unified customer view across all Viva Energy channels (digital, wholesale, Shell Card, other retail)\n* D365 Customer Engagement decommissioned within 90 days post-cutover\n* Customer satisfaction score improves by 15% within 6 months\n* Average case resolution time decreases by 20% within 6 months\n* Zero data loss during Contact migration (100% validation pass rate)\n* Mobile App feedback submission success rate > 99.5% (including async Case creation)\n\n=== Technical Constraints\n\n* Shared Salesforce instance (Viva Energy multi-tenant environment)\n* Conform to existing Salesforce configuration and governance (data isolation strategy TBD with Salesforce admin team)\n* Contact migration must complete before cutover (no parallel run)\n* Async Case creation mandatory (non-blocking user experience)\n* Expected volume: 100-150 feedback submissions/day from 20k DAU (~0.5-0.75% submission rate), architecture capacity planned for 3x-10x growth\n\n=== Open Technical Decisions (TBD)\n\n* Salesforce Case field mapping for digital feedback categories (App, Service, Order, Rewards, Refund, Delete Account)\n* Salesforce data isolation strategy (Record Types, custom fields, queues)\n* Salesforce REST API authentication method (OAuth 2.0, Connected App, JWT bearer flow)\n* Salesforce webhook mechanism for Case updates (Outbound Messages, Platform Events, Process Builder)\n* Retry policy configuration (attempts, backoff intervals)\n* Salesforce API rate limit strategy (expected volume: 100-150 submissions/day from 20k DAU, capacity planning for 3x-10x growth)\n\n== Technical Requirements\n\n[width=\"100%\",cols=\"8%,92%\",options=\"header\",]\n|===\n|ID |Description\n\n|TR-CS-001\n|Every Mobile App user must have a Salesforce Contact record in Salesforce Service Cloud (shared Viva Energy instance)\n\n|TR-CS-002\n|ProfileService must reconcile Mobile App users as Salesforce Contacts using Just-In-Time (JIT) upsert by email address\n\n|TR-CS-003\n|ProfileService must return Salesforce Contact ID to Mobile App for feedback submission\n\n|TR-CS-004\n|Mobile App must support customer feedback submission with fields: Category (App, Service, Order, Rewards, Refund, Delete Account), Store Name, Time of Visit, Contact Phone Number, Free Text Message\n\n|TR-CS-005\n|EngagementService must create Salesforce Cases asynchronously via Event Bus (non-blocking user experience)\n\n|TR-CS-006\n|EngagementService must acknowledge feedback submission immediately to Mobile App user (\"Feedback submitted\" confirmation)\n\n|TR-CS-007\n|EngagementService must send push notification to customer via Braze when Case is successfully created in Salesforce\n\n|TR-CS-008\n|EngagementService must retry failed Case creation with configurable exponential backoff and dead letter queue for operations team intervention\n\n|TR-CS-009\n|Salesforce must be the System of Record for Contact and Case data (no local persistence in ProfileService or EngagementService)\n\n|TR-CS-010\n|Contact migration from app-specific database to Salesforce must complete before Mobile App cutover (upsert with flexible matching by email/phone/VCI)\n\n|TR-CS-011\n|No Case migration from D365 Customer Engagement to Salesforce (fresh start, historical Cases not migrated)\n\n|TR-CS-012\n|EngagementService must publish domain events (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`) to Event Bus for consumption by other bounded contexts\n\n|TR-CS-013\n|EngagementService must receive Salesforce webhook notifications when Cases are updated/resolved by support agents\n\n|TR-CS-014\n|EngagementService must trigger Braze push notifications to customers when Cases are updated/resolved (via Salesforce webhook → EngagementService → Braze)\n\n|TR-CS-015\n|ProfileService and EngagementService must conform to existing Salesforce configuration and API contracts (Conformist pattern)\n\n|TR-CS-016\n|All changes must be communicated using event-driven architecture via Event Bus (using existing AWS infrastructure: SNS+SQS/EventBridge/Kinesis)\n\n|TR-CS-017\n|Mobile App feedback submission success rate must exceed 99.5% (including async Case creation completion)\n\n|TR-CS-018\n|Contact migration must achieve 100% validation pass rate (zero data loss)\n\n|TR-CS-019\n|D365 Customer Engagement must be fully decommissioned within 90 days post-cutover\n\n|===\n\n== Technical Architecture\n\n=== Technical Capability Requirements\n\n==== Requirements Traceability\n\n[width=\"100%\",cols=\"15%,50%,35%\",options=\"header\",]\n|===\n|Requirement ID |Requirement Summary |Architectural Building Blocks\n\n|TR-CS-001\n|Every Mobile App user must have Salesforce Contact record\n|ABB-CS-001 (ProfileService), ABB-CS-004 (Salesforce), ABB-CS-007 (Contact Migration Tool)\n\n|TR-CS-002\n|ProfileService JIT Contact reconciliation via upsert by email\n|ABB-CS-001 (ProfileService), ABB-CS-004 (Salesforce)\n\n|TR-CS-003\n|ProfileService returns Salesforce Contact ID to Mobile App\n|ABB-CS-001 (ProfileService), ABB-CS-006 (Mobile App)\n\n|TR-CS-004\n|Mobile App supports feedback submission with structured fields\n|ABB-CS-006 (Mobile App), ABB-CS-002 (EngagementService)\n\n|TR-CS-005\n|EngagementService creates Salesforce Cases asynchronously\n|ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus), ABB-CS-004 (Salesforce)\n\n|TR-CS-006\n|EngagementService immediate acknowledgment to Mobile App\n|ABB-CS-002 (EngagementService), ABB-CS-006 (Mobile App)\n\n|TR-CS-007\n|EngagementService sends push notification via Braze on Case creation\n|ABB-CS-002 (EngagementService), ABB-CS-005 (Braze)\n\n|TR-CS-008\n|EngagementService retry logic with exponential backoff and DLQ\n|ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus)\n\n|TR-CS-009\n|Salesforce is System of Record for Contact and Case data\n|ABB-CS-004 (Salesforce), ABB-CS-001 (ProfileService - stateless), ABB-CS-002 (EngagementService - stateless)\n\n|TR-CS-010\n|Contact migration before Mobile App cutover\n|ABB-CS-007 (Contact Migration Tool), ABB-CS-004 (Salesforce)\n\n|TR-CS-011\n|No Case migration from D365 CE (fresh start)\n|ABB-CS-004 (Salesforce) - no migration tooling required\n\n|TR-CS-012\n|EngagementService publishes domain events to Event Bus\n|ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus)\n\n|TR-CS-013\n|EngagementService receives Salesforce webhook notifications\n|ABB-CS-002 (EngagementService), ABB-CS-004 (Salesforce)\n\n|TR-CS-014\n|EngagementService triggers Braze notifications on Case updates\n|ABB-CS-002 (EngagementService), ABB-CS-004 (Salesforce), ABB-CS-005 (Braze)\n\n|TR-CS-015\n|ProfileService and EngagementService conform to Salesforce config\n|ABB-CS-001 (ProfileService), ABB-CS-002 (EngagementService), ABB-CS-004 (Salesforce)\n\n|TR-CS-016\n|Event-driven architecture via Event Bus\n|ABB-CS-003 (Event Bus), ABB-CS-002 (EngagementService)\n\n|TR-CS-017\n|Mobile App feedback submission success rate > 99.5%\n|ABB-CS-006 (Mobile App), ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus), ABB-CS-004 (Salesforce)\n\n|TR-CS-018\n|Contact migration 100% validation pass rate\n|ABB-CS-007 (Contact Migration Tool), ABB-CS-004 (Salesforce)\n\n|TR-CS-019\n|D365 CE decommissioned within 90 days post-cutover\n|All ABBs (replacement system operational)\n\n|===\n\n=== Service Catalogues\n\n==== Application Portfolio Catalogue\n\n[width=\"100%\",cols=\"20%,15%,15%,15%,35%\",options=\"header\",]\n|===\n|Application |Lifecycle State |Owner |Hosting Platform |Description\n\n|*ProfileService*\n|NEW\n|OTR Platform Team\n|AWS (TBD: Lambda/ECS/EKS)\n|JIT Contact reconciliation with Salesforce, returns Salesforce Contact ID, foundation for Flybuys integration\n\n|*EngagementService*\n|NEW\n|OTR Platform Team\n|AWS (TBD: Lambda/ECS/EKS)\n|Customer feedback submission facade, ACL for Salesforce Case creation, Braze integration for all outbound communications (push, email, SMS), webhook receiver\n\n|*Mobile App (iOS)*\n|ACTIVE (UPDATE)\n|OTR Mobile Team\n|Apple App Store\n|iOS native app with feedback form, integrate with ProfileService and EngagementService APIs\n\n|*Mobile App (Android)*\n|ACTIVE (UPDATE)\n|OTR Mobile Team\n|Google Play Store\n|Android native app with feedback form, integrate with ProfileService and EngagementService APIs\n\n|*Salesforce Service Cloud*\n|ACTIVE (EXPAND)\n|Viva Energy Salesforce Admin Team\n|Salesforce (SaaS)\n|Shared Viva Energy instance, System of Record for Contact and Case data, adding OTR digital customer support\n\n|*Braze*\n|ACTIVE (EXTEND)\n|OTR Marketing Team\n|Braze (SaaS)\n|Marketing automation platform, EngagementService triggers push notifications for Case updates\n\n|*D365 Customer Engagement*\n|RETIRE\n|OTR Support Team\n|Microsoft Azure (SaaS)\n|Legacy customer support platform, decommissioned within 90 days post-cutover\n\n|*App-Specific Customer Database*\n|RETIRE\n|OTR Platform Team\n|AWS (RDS/DynamoDB)\n|Legacy customer contact storage, one-time migration to Salesforce, then deprecated\n\n|*Event Bus*\n|NEW\n|OTR Platform Team\n|AWS (SNS+SQS/EventBridge/Kinesis)\n|Domain event publishing infrastructure for bounded context integration\n\n|*Contact Migration Tool*\n|TEMPORARY\n|OTR Platform Team\n|AWS (Script/Lambda)\n|One-time migration app database → Salesforce with upsert logic, retired after migration complete\n\n|===\n\n==== Technology Capability Requirements\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Technology Capability |Implementation Technology (TBD in detailed design) |Requirements\n\n|*Microservice Hosting*\n|AWS Lambda / ECS / EKS\n|Host ProfileService and EngagementService with auto-scaling, high availability, monitoring\n\n|*API Gateway*\n|AWS API Gateway / Application Load Balancer\n|REST API routing, authentication, rate limiting, request validation for ProfileService and EngagementService\n\n|*Event Bus*\n|AWS SNS+SQS / EventBridge / Kinesis\n|Domain event publishing, async message processing, retry logic, dead letter queue\n\n|*Salesforce Integration*\n|Salesforce REST API / SOAP API\n|Contact CRUD operations, Case creation, webhook notifications, OAuth 2.0 authentication\n\n|*Braze Integration*\n|Braze REST API / SDK\n|Push notification campaign triggers, customer profile reconciliation\n\n|*Authentication & Authorisation*\n|Microsoft Entra External ID / AWS Cognito\n|Mobile App user authentication, API authorisation, JWT token validation\n\n|*Observability & Monitoring*\n|AWS CloudWatch / Datadog / New Relic\n|Application metrics, logs, traces, dashboards, alerting (feedback submission rate, queue depth, API errors)\n\n|*Secret Management*\n|AWS Secrets Manager / Parameter Store\n|Salesforce credentials, Braze API keys, OAuth tokens, encryption keys\n\n|*Database (Migration Tool)*\n|AWS RDS / DynamoDB (read-only access)\n|Contact migration from app-specific database\n\n|*CI/CD Pipeline*\n|GitHub Actions / AWS CodePipeline\n|Automated build, test, deployment for ProfileService, EngagementService, Mobile App\n\n|*Infrastructure as Code*\n|Terraform / AWS CloudFormation / CDK\n|Declarative infrastructure provisioning for Event Bus, microservices, monitoring\n\n|*API Documentation*\n|OpenAPI / Swagger\n|ProfileService and EngagementService API specifications for Mobile App integration\n\n|===\n\n==== Feature Flag Register\n\n*Note*: Per ADR-CS-006 (big bang cutover, not phased rollout), feature flags are minimal and used primarily for emergency rollback/kill switches.\n\n[width=\"100%\",cols=\"20%,15%,35%,30%\",options=\"header\",]\n|===\n|Feature Flag |Default State |Purpose |Rollback Scenario\n\n|*enable_salesforce_feedback_submission*\n|OFF (pre-cutover), ON (post-cutover)\n|Enable/disable feedback submission to EngagementService → Salesforce (kill switch for emergency rollback to D365 CE)\n|Feedback submission success rate < 95%, Salesforce API failures, critical bugs - revert to D365 CE integration\n\n|*enable_async_case_creation*\n|ON\n|Enable/disable async Case creation via Event Bus (fallback to synchronous processing if Event Bus issues)\n|Event Bus infrastructure failures, queue backlog unmanageable - temporary synchronous processing\n\n|*enable_braze_notifications*\n|ON\n|Enable/disable Braze push notifications for Case updates (degrade gracefully if Braze integration fails)\n|Braze API failures, notification delivery rate < 80% - disable notifications temporarily\n\n|*enable_jit_contact_reconciliation*\n|ON\n|Enable/disable ProfileService JIT Contact reconciliation (fallback to cached Contact IDs if Salesforce unavailable)\n|Salesforce API downtime, Contact reconciliation failures > 5% - use cached Contact IDs temporarily\n\n|*enable_salesforce_webhook_processing*\n|ON\n|Enable/disable Salesforce webhook processing for Case updates (fallback to polling if webhook failures)\n|Webhook delivery failures, authentication issues - temporary polling fallback\n\n|===\n\n*Feature Flag Management*:\n\n* Feature flags managed via AWS AppConfig / LaunchDarkly / custom feature flag service (TBD in detailed design)\n* Mobile App feature flags controlled server-side (no app release required for flag changes)\n* Backend service feature flags configured via environment variables / configuration service\n* Feature flag changes logged and audited (who changed, when, reason)\n* Post-cutover monitoring: Gradual removal of feature flags once system stability confirmed (30-60 days)\n\n==== Data Entity Catalogue\n\n[width=\"100%\",cols=\"20%,15%,35%,30%\",options=\"header\",]\n|===\n|Data Entity |System of Record |Key Attributes |Lifecycle\n\n|*Contact*\n|Salesforce Service Cloud\n|• Contact ID (Salesforce 15/18-char ID) +\n• Email (primary matching key) +\n• First Name, Last Name +\n• Phone Number +\n• Viva Consumer ID (VCI) +\n• Account (Viva Energy customer account) +\n• Record Type (OTR Digital vs other channels)\n|Created: ProfileService JIT reconciliation or Contact Migration Tool +\nUpdated: ProfileService JIT upsert (email changes), Salesforce (manual updates by support agents) +\nDeleted: Salesforce retention policy (GDPR/compliance)\n\n|*Case*\n|Salesforce Service Cloud\n|• Case Number (Salesforce auto-generated) +\n• Contact ID (reference to Contact) +\n• Subject (derived from Category) +\n• Description (Free Text Message) +\n• Category (App, Service, Order, Rewards, Refund, Delete Account) +\n• Store Name (OTR location) +\n• Time of Visit +\n• Status (New, In Progress, Resolved, Closed) +\n• Priority, Origin (Mobile App) +\n• Owner (support agent/queue)\n|Created: EngagementService async Case creation +\nUpdated: Support agents (Salesforce UI), EngagementService (webhook processing) +\nDeleted: Salesforce retention policy (archive after X years)\n\n|*Feedback Submission (transient)*\n|None (not persisted)\n|• Salesforce Contact ID +\n• Category +\n• Store Name +\n• Time of Visit +\n• Contact Phone Number +\n• Free Text Message\n|Created: Mobile App user submission +\nProcessed: EngagementService publishes to Event Bus, Case created in Salesforce +\nNot persisted in ProfileService/EngagementService (stateless)\n\n|*Domain Events*\n|Event Bus (ephemeral)\n|**SupportCaseCreated**: +\n• Case Number, Contact ID, Category, Timestamp +\n**SupportCaseUpdated**: +\n• Case Number, Status, Updated By, Timestamp +\n**SupportCaseResolved**: +\n• Case Number, Resolution, Resolved By, Timestamp +\n**CustomerFeedbackSubmitted**: +\n• Contact ID, Category, Timestamp\n|Published: EngagementService +\nConsumed: Other bounded contexts (future), Braze notification triggers +\nRetention: Short-lived (minutes to hours), not persisted for event sourcing\n\n|*Braze Customer Profile*\n|Braze\n|• External User ID (VCI or Email) +\n• Push Notification Tokens (iOS/Android) +\n• Notification Preferences +\n• Campaign Engagement History\n|Created/Updated: EngagementService on Case creation/update +\nManaged: Braze (external SaaS)\n\n|===\n\n*Data Migration Entities*:\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Source Entity |Target Entity |Migration Strategy\n\n|*App Database Contact*\n|Salesforce Contact\n|One-time migration via Contact Migration Tool: +\n• Upsert by email (primary), phone (secondary), VCI (tertiary) +\n• Map: Email → Email, Name → First/Last Name, Phone → Phone, VCI → External ID +\n• Validation: 100% data integrity check, reconciliation report\n\n|*D365 CE Case*\n|Not migrated\n|ADR-CS-005: No Case migration (fresh start in Salesforce) +\nD365 CE Cases archived separately for compliance if needed\n\n|===\n\n==== Data Quality & Validation\n\n*Contact Migration Validation Rules*:\n\n* Email format validation (RFC 5322 compliance)\n* Phone number format validation (E.164 international format)\n* VCI format validation (alphanumeric, length constraints)\n* Duplicate detection: Flag potential duplicates for manual review (same email/phone combination)\n* Mandatory fields: Email (required), First Name, Last Name (required for Salesforce Contact)\n\n*Case Creation Validation Rules*:\n\n* Contact ID must exist in Salesforce (validated by EngagementService before Case creation)\n* Category must be one of: App, Service, Order, Rewards, Refund, Delete Account\n* Free Text Message maximum length: 32,000 characters (Salesforce Case Description limit)\n* Store Name validated against OTR location master data (optional - warn if not found)\n\n<<<\n== Solution Building Blocks\n\nThis section defines the specific technology products, configurations, and implementation details for each Solution Building Block (SBB).\n\n=== Technology Portfolio Catalogue\n\n[width=\"100%\",cols=\"10%,20%,25%,25%,20%\",options=\"header\",]\n|===\n|SBB ID |Component |Technology Product |Version/Configuration |Deployment Platform\n\n|SBB-CS-001\n|ProfileService Microservice\n|.NET 8 / Node.js 20 LTS\n|RESTful API, containerised\n|AWS ECS Fargate / Lambda\n\n|SBB-CS-002\n|EngagementService Microservice\n|.NET 8 / Node.js 20 LTS\n|RESTful API, containerised, async workers\n|AWS ECS Fargate / Lambda\n\n|SBB-CS-003\n|Event Bus\n|AWS SNS + SQS / EventBridge\n|Standard queues, FIFO for ordering\n|AWS (managed service)\n\n|SBB-CS-004\n|API Gateway\n|AWS API Gateway / ALB\n|REST API, JWT validation\n|AWS (managed service)\n\n|SBB-CS-005\n|Salesforce Integration Layer\n|Salesforce REST API Client\n|OAuth 2.0 JWT bearer flow\n|Embedded in SBB-CS-001/002\n\n|SBB-CS-006\n|Braze Integration Layer\n|Braze REST API SDK\n|API key authentication\n|Embedded in SBB-CS-002\n\n|SBB-CS-007\n|Contact Migration Tool\n|Python 3.11 / .NET 8\n|One-time batch script\n|AWS Lambda / EC2\n\n|SBB-CS-008\n|Application Monitoring\n|AWS CloudWatch / Datadog\n|Metrics, logs, traces, dashboards\n|AWS / SaaS\n\n|SBB-CS-009\n|Secret Management\n|AWS Secrets Manager\n|KMS encryption\n|AWS (managed service)\n\n|SBB-CS-010\n|Mobile App (iOS)\n|SwiftUI, Kotlin Multiplatform\n|iOS 15+\n|Apple App Store\n\n|SBB-CS-011\n|Mobile App (Android)\n|Jetpack Compose, Kotlin Multiplatform\n|Android 8+\n|Google Play Store\n\n|SBB-CS-012\n|Feature Flag Service\n|AWS AppConfig / LaunchDarkly\n|Server-side flags, real-time updates\n|AWS / SaaS\n\n|===\n\n<<<\n== Data Architecture\n\nThis section defines the physical data models, event schemas, and API request/response formats.\n\n=== Domain Event Schemas\n\nAll domain events follow the https://cloudevents.io/[CloudEvents 1.0] specification for consistency and interoperability.\n\n*Event Schema Specifications*: See // TODO: Add to Antora - specifications/events/engagement-events.json[Engagement Service Event Schemas] for complete JSON schemas and examples.\n\n==== Event Catalogue\n\n[width=\"100%\",cols=\"30%,20%,50%\",options=\"header\",]\n|===\n|Event Type |Publisher |Description\n\n|`SupportCaseCreated`\n|EngagementService\n|Published when EngagementService successfully creates a Case in Salesforce after async processing\n\n|`SupportCaseUpdated`\n|EngagementService (via Salesforce webhook)\n|Published when a support agent updates a Case in Salesforce (status, priority, comment changes)\n\n|`SupportCaseResolved`\n|EngagementService (via Salesforce webhook)\n|Published when a support agent resolves/closes a Case in Salesforce\n\n|`CustomerFeedbackSubmitted`\n|EngagementService\n|Published when customer submits feedback via Mobile App (before async Case creation)\n\n|===\n\n*Event Format*: All events use CloudEvents 1.0 envelope with event-specific payload in the `data` field.\n\n*Schema Location*: `specifications/events/engagement-events.json`\n\n=== API Request/Response Schemas\n\n==== ProfileService: GET /profile/contact-id\n\n*Response* (200 OK):\n[source,json]\n----\n{\n  \"contactId\": \"0034X00000ABCDEFG\",\n  \"email\": \"customer@example.com\",\n  \"firstName\": \"John\",\n  \"lastName\": \"Smith\"\n}\n----\n\n==== EngagementService: POST /feedback\n\n*Request*:\n[source,json]\n----\n{\n  \"contactId\": \"0034X00000ABCDEFG\",\n  \"category\": \"App\",\n  \"storeName\": \"OTR Adelaide\",\n  \"timeOfVisit\": \"2026-01-07T12:00:00Z\",\n  \"contactPhoneNumber\": \"+61412345678\",\n  \"message\": \"App crashed when submitting feedback\"\n}\n----\n\n*Response* (202 Accepted):\n[source,json]\n----\n{\n  \"feedbackId\": \"fb-2026-01-07-12345\",\n  \"status\": \"submitted\",\n  \"message\": \"Your feedback has been submitted!\"\n}\n----\n\n=== Salesforce Field Mappings\n\n==== Case Object Mapping\n\n[width=\"100%\",cols=\"25%,25%,25%,25%\",options=\"header\",]\n|===\n|OTR Field |Salesforce Field |Data Type |Notes\n\n|Category\n|Feedback_Category__c\n|Picklist\n|App, Service, Order, Rewards, Refund, Delete Account\n\n|Store Name\n|Store_Name__c\n|String (255)\n|OTR location name\n\n|Time of Visit\n|Time_of_Visit__c\n|DateTime\n|When customer visited store\n\n|Free Text Message\n|Description\n|Long Text (32,000)\n|Customer feedback message\n\n|===\n\n<<<\n=== Baseline Architecture\n\n==== Existing System Components\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Component |Current State |Status\n\n|*D365 Customer Engagement*\n|Customer support platform for OTR digital customers (Mobile App, Web), handles feedback submission and case management\n|**DEPRECATED** - Being replaced by Salesforce Service Cloud\n\n|*App-Specific Customer Database*\n|Stores customer contact data for Mobile App users, separate from Viva Energy systems\n|**MIGRATING** - One-time migration to Salesforce, then deprecated\n\n|*Mobile App*\n|iOS/Android native apps with feedback submission form including Category, Store Name, Time of Visit, Contact Phone Number, and Free Text Message fields\n|**REQUIRES UPDATE** - Integrate with ProfileService and EngagementService APIs (feedback form UI already complete)\n\n|*Salesforce Service Cloud*\n|Shared Viva Energy instance handling customer support for fuel wholesale, Shell Card customers, other retail channels\n|**EXPANDING** - Adding OTR digital customer support Cases and Contacts\n\n|*Existing AWS Infrastructure*\n|SNS+SQS / EventBridge / Kinesis available for event-driven architecture\n|**REUSING** - Event Bus implementation leverages existing infrastructure\n\n|===\n\n==== Integration Architecture\n\n*Current state:*\n\n* Mobile App → D365 Customer Engagement (direct integration)\n* App-specific customer database → standalone (no Salesforce integration)\n* No event-driven architecture (synchronous, tightly coupled)\n* No Anti-Corruption Layer protecting digital channels\n* Viva Energy support teams use Salesforce, OTR digital support uses D365 CE (fragmented)\n\n==== Technical Debt\n\n*No longer relevant* - D365 CE being deprecated, not documenting technical debt of system being retired.\n\n*New technical debt introduced by this migration:*\n\n* Salesforce field mapping TBD (requires coordination with Viva Energy Salesforce admin team)\n* Data isolation strategy TBD (Record Types, custom fields, queues - multi-tenant governance)\n* Salesforce webhook mechanism TBD (Outbound Messages vs Platform Events vs Process Builder)\n* Expected feedback volume unknown (gathering data for rate limit planning)\n\n=== Gap Analysis\n\n==== Missing Capabilities\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Missing Capability |Description\n\n|*ProfileService bounded context*\n|No existing service for Contact reconciliation with Salesforce - requires new microservice implementing JIT upsert by email, returning Salesforce Contact ID\n\n|*EngagementService bounded context*\n|No existing service for customer feedback facade - requires new microservice implementing Anti-Corruption Layer for Salesforce Case creation, Braze integration, async processing via Event Bus\n\n|*Event Bus domain event pattern*\n|No existing domain event publishing infrastructure - requires implementing event-driven architecture pattern using existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis)\n\n|*Async Case creation workflow*\n|Current D365 CE integration is synchronous - requires implementing async processing with retry logic, exponential backoff, dead letter queue\n\n|*Salesforce webhook integration*\n|No existing capability to receive Salesforce notifications - requires implementing webhook receiver in EngagementService for Case update notifications\n\n|*Braze push notification orchestration*\n|No existing integration for Case-related push notifications - requires implementing Braze campaign triggers from EngagementService\n\n|*Contact migration tooling*\n|No existing tooling for app database → Salesforce Contact migration with upsert logic (match by email/phone/VCI)\n\n|*Feedback form enhancements*\n|Mobile App feedback form lacks structured fields (Category, Store Name, Time of Visit, Contact Phone Number) - requires UI updates\n\n|===\n\n==== Missing Bounded Contexts\n\n[width=\"100%\",cols=\"30%,30%,40%\",options=\"header\",]\n|===\n|Bounded Context |Responsibilities |Implementation Status\n\n|*link:../bounded_context/profile.adoc[ProfileService]*\n|JIT Contact reconciliation with Salesforce (upsert by email), return Salesforce Contact ID to digital channels, foundation for future Flybuys partner linking\n|**NEW** - First bounded context implementation\n\n|*link:../bounded_context/engagement.adoc[EngagementService]*\n|Customer feedback submission facade, Anti-Corruption Layer for Salesforce Case creation, Braze integration for push notifications, async Case processing, webhook receiver for Case updates\n|**NEW** - First bounded context implementation\n\n|===\n\n==== Missing Integration Patterns\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Integration Pattern |Description\n\n|*Anti-Corruption Layer (ACL)*\n|EngagementService → Salesforce Service Cloud - protects digital channels from Salesforce API changes, translates between OTR domain language and Salesforce\n\n|*Conformist*\n|ProfileService/EngagementService → Salesforce - conform to existing Salesforce configuration and API contracts (shared Viva Energy instance)\n\n|*Event-Driven Architecture (OHS+PL)*\n|Event Bus publishing domain events (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`) for loose coupling between bounded contexts\n\n|*Just-In-Time (JIT) Integration*\n|ProfileService → Salesforce Contact reconciliation on-demand (no pre-sync)\n\n|*Async Processing*\n|EngagementService Case creation via Event Bus with retry, exponential backoff, dead letter queue\n\n|===\n\n=== Target State Architecture\n\n==== Architectural Building Blocks (ABB)\n\n[width=\"100%\",cols=\"20%,25%,30%,25%\",options=\"header\",]\n|===\n|ABB ID |Bounded Context |Responsibilities |Technology (TBD in Solution Architecture)\n\n|ABB-CS-001\n|*link:../bounded_context/profile.adoc[ProfileService]*\n|JIT Contact reconciliation with Salesforce (upsert by email), return Salesforce Contact ID, foundation for Flybuys partner linking\n|Microservice (.NET/Node.js), REST API, Salesforce REST API client\n\n|ABB-CS-002\n|*link:../bounded_context/engagement.adoc[EngagementService]*\n|Customer feedback submission facade, ACL for Salesforce Case creation, Braze integration, async processing, webhook receiver\n|Microservice (.NET/Node.js), REST API, Event Bus publisher/subscriber, Salesforce webhook receiver\n\n|ABB-CS-003\n|*Event Bus*\n|Domain event publishing infrastructure (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`)\n|AWS SNS+SQS / EventBridge / Kinesis\n\n|ABB-CS-004\n|*Salesforce Service Cloud*\n|System of Record for Contact and Case data (shared Viva Energy instance)\n|Salesforce Service Cloud (external SaaS)\n\n|ABB-CS-005\n|*Braze*\n|Marketing automation platform for push notifications\n|Braze (external SaaS) - existing integration\n\n|ABB-CS-006\n|*Mobile App*\n|iOS/Android native apps with enhanced feedback form (Category, Store Name, Time of Visit, Contact Phone Number, Free Text Message)\n|Kotlin Multiplatform, SwiftUI, Jetpack Compose\n\n|ABB-CS-007\n|*Contact Migration Tool*\n|One-time migration app database → Salesforce with upsert logic (match by email/phone/VCI)\n|Script/tool (.NET/Python/Node.js)\n\n|===\n\n==== Integration Architecture\n\n===== Integration Flows\n\n*Customer Feedback Submission (Async):*\n\n1. *Mobile App* → ProfileService: Authenticate user, get Salesforce Contact ID (JIT reconciliation)\n2. *Mobile App* → EngagementService: Submit feedback (POST /feedback with Contact ID, Category, Store Name, Time of Visit, Phone, Message)\n3. *EngagementService* → Mobile App: Immediate acknowledgment (\"Feedback submitted\")\n4. *EngagementService* → Event Bus: Publish work item for async Case creation\n5. *Background Worker* (EngagementService) → Salesforce: Create Case via REST API\n6. *Success*: EngagementService → Event Bus: Publish `SupportCaseCreated` event\n7. *EngagementService* → Braze: Trigger push notification campaign (\"Your feedback has been received, Case #12345\")\n8. *Failure*: Retry with exponential backoff → Dead Letter Queue → Ops team alert\n\n*Case Update Notification (Bidirectional):*\n\n1. *Support Agent* updates/resolves Case in Salesforce\n2. *Salesforce* → EngagementService: Webhook notification (Case updated)\n3. *EngagementService* → Event Bus: Publish `SupportCaseUpdated` or `SupportCaseResolved` event\n4. *EngagementService* → Braze: Trigger push notification campaign (\"Your case has been resolved\")\n\n*Contact Reconciliation (JIT):*\n\n1. *Mobile App user* authenticates\n2. *Mobile App* → ProfileService: GET /profile/contact-id\n3. *ProfileService* → Salesforce: Query Contact by email\n4. *Match found*: Return existing Salesforce Contact ID\n5. *No match*: Create new Contact in Salesforce, return new Contact ID\n6. *ProfileService* → Mobile App: Return Salesforce Contact ID (cached by Mobile App)\n\n===== System of Record Boundaries\n\n[width=\"100%\",cols=\"30%,35%,35%\",options=\"header\",]\n|===\n|Data Entity |System of Record |Rationale\n\n|*Contact*\n|Salesforce Service Cloud\n|Shared Viva Energy instance, unified customer profile across all channels (digital, wholesale, Shell Card, retail)\n\n|*Case*\n|Salesforce Service Cloud\n|Support agents manage Cases in Salesforce, digital channels submit via EngagementService ACL\n\n|*Feedback Submission (transient)*\n|None (no persistence)\n|EngagementService processes feedback and creates Case in Salesforce, no local storage\n\n|*Domain Events*\n|Event Bus (ephemeral)\n|Events published to Event Bus, consumed by subscribers, not persisted long-term (event sourcing not in scope)\n\n|===\n\n==== Data Architecture Principles\n\n===== Aggregate Persistence\n\n*ProfileService:*\n\n* **No local aggregate persistence** - ProfileService is stateless, queries Salesforce on-demand\n* Salesforce Contact is the aggregate root (owned by Salesforce)\n* ProfileService acts as facade/translator, not system of record\n\n*EngagementService:*\n\n* **No local aggregate persistence** - EngagementService is stateless, creates Cases in Salesforce via ACL\n* Salesforce Case is the aggregate root (owned by Salesforce)\n* EngagementService maintains no local Case state (Conformist pattern - trust Salesforce as source of truth)\n* Async processing state managed via Event Bus (work items in queue, not database)\n\n===== Event Store\n\n* **Event Bus** (SNS+SQS/EventBridge/Kinesis) handles domain event publishing\n* Events are **ephemeral** (consumed and discarded, not persisted for event sourcing)\n* No Event Store implementation in this architecture (future enhancement if needed)\n* Event schema versioning TBD in Solution Architecture\n\n\n=== Architecture Decisions\n\n==== ADR-CS-001: Consolidate onto Salesforce Service Cloud (not build custom solution)\n\n*Status*: Accepted\n\n*Context*:\n\n* D365 Customer Engagement not working well for digital customer support\n* Viva Energy already uses Salesforce Service Cloud for fuel wholesale, Shell Card, other retail channels\n* Post-merger opportunity to consolidate onto single platform\n* Alternative: Build custom support platform or use different SaaS\n\n*Decision*:\n\nConsolidate OTR digital customer support onto Salesforce Service Cloud (shared Viva Energy instance).\n\n*Rationale*:\n\n* **Unified customer view**: Support agents see all interactions across channels (digital, wholesale, Shell Card, retail)\n* **Platform consolidation**: Single support platform reduces operational overhead and costs\n* **Proven solution**: Salesforce Service Cloud is established, feature-rich, well-supported\n* **Post-merger alignment**: Strategic decision to standardize on Viva Energy platforms\n* **Avoid custom development**: Building custom support platform would be costly and high-risk\n\n*Consequences*:\n\n* Unified customer support across Viva Energy Group\n* Reduced operational complexity (single platform vs two)\n* Leverage Salesforce capabilities (case routing, knowledge base, AI, omnichannel)\n* ⚠️ Conformist pattern required (shared instance, conform to existing configuration)\n* ⚠️ Multi-tenant governance needed (data isolation, security, queues)\n* ❌ Less control over platform evolution (SaaS vendor, shared instance)\n\n==== ADR-CS-002: Implement ProfileService and EngagementService as first DDD bounded contexts\n\n*Status*: Accepted\n\n*Context*:\n\n* OTR target architecture uses Domain-Driven Design with bounded contexts\n* This migration is opportunity to establish first implementation\n* Alternative: Direct Mobile App → Salesforce integration (no bounded contexts)\n* Alternative: Single monolithic service for all customer-facing APIs\n\n*Decision*:\n\nImplement ProfileService and EngagementService as separate bounded contexts following DDD strategic patterns.\n\n*Rationale*:\n\n* **Foundation for target architecture**: First implementation of DDD pattern for future bounded contexts (Flybuys, LocationService, PaymentService)\n* **Separation of concerns**: ProfileService handles identity/Contact reconciliation, EngagementService handles support/feedback (different responsibilities, different change rates)\n* **Anti-Corruption Layer**: EngagementService protects digital channels from Salesforce API changes\n* **Reusability**: ProfileService Contact reconciliation reused for Flybuys integration\n* **Event-driven architecture**: Establishes pattern for loose coupling between bounded contexts\n\n*Consequences*:\n\n* Establishes DDD architecture foundation for OTR\n* Reusable ProfileService for Flybuys and future integrations\n* Digital channels protected from Salesforce API changes (ACL)\n* Clear bounded context boundaries and responsibilities\n* ⚠️ Increased initial complexity (two new microservices vs direct integration)\n* ⚠️ Requires Event Bus infrastructure implementation\n* ⚠️ Team must learn DDD patterns and bounded context design\n\n==== ADR-CS-003: Async Case creation via Event Bus (not synchronous)\n\n*Status*: Accepted\n\n*Context*:\n\n* Current D365 CE integration is synchronous (user waits for Case creation)\n* Alternative: Keep synchronous integration (Mobile App → EngagementService → Salesforce synchronously)\n* Salesforce API may experience downtime or latency\n\n*Decision*:\n\nImplement async Case creation via Event Bus with immediate user acknowledgment, retry logic, exponential backoff, and dead letter queue.\n\n*Rationale*:\n\n* **Non-blocking user experience**: User gets immediate \"Feedback submitted\" confirmation, not waiting for Salesforce API\n* **Resilience**: If Salesforce is down, feedback still accepted, Case created when Salesforce recovers\n* **Retry logic**: Automatic retry with exponential backoff handles transient failures\n* **Operational visibility**: Dead letter queue alerts ops team to persistent failures\n* **Scalability**: Queue buffering handles traffic spikes\n\n*Consequences*:\n\n* Better user experience (no waiting for Salesforce API)\n* Resilient to Salesforce downtime (queue buffers work)\n* Automatic retry reduces manual intervention\n* Queue depth monitoring provides operational visibility\n* ⚠️ Eventual consistency (user gets success notification after Case created, not immediately)\n* ⚠️ Increased complexity (Event Bus, background workers, retry logic, DLQ)\n* ⚠️ Requires monitoring and alerting for DLQ\n\n==== ADR-CS-004: ProfileService uses email as primary matching key (not VCI)\n\n*Status*: Accepted\n\n*Context*:\n\n* ProfileService needs to reconcile Mobile App users as Salesforce Contacts\n* Alternative matching keys: VCI (Viva Consumer ID), email, phone, Salesforce External ID\n* Email changes are rare but possible\n\n*Decision*:\n\nUse email address as primary matching key for Contact reconciliation (JIT upsert by email).\n\n*Rationale*:\n\n* **Availability**: Email always available for authenticated users\n* **Uniqueness**: Email is unique identifier in Salesforce and Mobile App\n* **Salesforce standard**: Salesforce Contact uses email as standard lookup field\n* **Simplicity**: Single matching key simplifies upsert logic\n* **Edge case acceptable**: Email changes are rare, manual cleanup acceptable\n\n*Consequences*:\n\n* Simple upsert logic (query by email, create if not found)\n* Leverages Salesforce standard email field\n* Email always available from authentication\n* ⚠️ Email changes create duplicate Contacts (rare edge case, manual cleanup)\n* ⚠️ Future enhancement: Add VCI as Salesforce External ID for stable matching\n\n==== ADR-CS-005: No Case migration from D365 CE (fresh start)\n\n*Status*: Accepted\n\n*Context*:\n\n* D365 CE contains historical customer support Cases\n* Alternative: Migrate historical Cases to Salesforce (preserve support history)\n* Alternative: Archive D365 CE Cases separately (read-only access)\n\n*Decision*:\n\nDo not migrate historical Cases from D365 CE to Salesforce. Start fresh in Salesforce.\n\n*Rationale*:\n\n* **Limited value**: Historical D365 CE Cases not critical for future support\n* **Data quality**: D365 CE Case data may be inconsistent or incomplete\n* **Complexity**: Case migration requires mapping D365 CE schema to Salesforce, data transformation, validation\n* **Cost-benefit**: Migration effort outweighs value of historical data\n* **Archive option**: D365 CE Cases can be archived separately if needed (read-only access for auditing)\n\n*Consequences*:\n\n* Simpler migration (Contacts only, no Case migration)\n* Faster time to value (no Case migration delay)\n* Clean start in Salesforce (no legacy data quality issues)\n* ⚠️ Historical Cases not visible in Salesforce (support agents can't see old Cases)\n* ⚠️ D365 CE must remain accessible temporarily for historical Case lookups (if needed)\n* ❌ Loss of historical Case insights (reporting, analytics on old Cases)\n\n==== ADR-CS-006: Big bang cutover (not phased rollout)\n\n*Status*: Accepted\n\n*Context*:\n\n* Alternative: Phased rollout with feature flags (pilot users first, gradual enablement)\n* Alternative: Parallel run (submit to both D365 CE and Salesforce temporarily)\n* Flybuys integration uses phased rollout (AS-1, AS-2, AS-3 architecture states)\n\n*Decision*:\n\nBig bang cutover - migrate Contacts, deploy ProfileService and EngagementService, switch Mobile App, retire D365 CE.\n\n*Rationale*:\n\n* **Simplicity**: No parallel run complexity, no feature flag management\n* **Faster D365 CE retirement**: No extended transition period maintaining two systems\n* **Limited risk**: Customer support not mission-critical (not payment processing), rollback possible\n* **User base manageable**: OTR digital customers smaller than Flybuys integration scope\n* **Different use case**: Flybuys phased rollout manages points accrual complexity, support feedback is simpler\n\n*Consequences*:\n\n* Simpler deployment (single cutover, no AS-1/AS-2/AS-3 states)\n* Faster D365 CE retirement (no extended parallel run)\n* No feature flag complexity or pilot user management\n* ⚠️ Higher cutover risk (all users switch at once)\n* ⚠️ Requires comprehensive testing before cutover\n* ⚠️ Rollback plan required (revert to D365 CE if critical issues)\n\n==== ADR-CS-007: EngagementService receives Salesforce webhooks for Case updates\n\n*Status*: Accepted\n\n*Context*:\n\n* Support agents update/resolve Cases in Salesforce\n* Need to notify customers of Case status changes via push notifications\n* Alternative: Poll Salesforce API for Case updates (inefficient)\n* Alternative: No customer notifications (agents contact customers directly)\n\n*Decision*:\n\nSalesforce sends webhook notifications to EngagementService when Cases are updated/resolved. EngagementService triggers Braze push notifications.\n\n*Rationale*:\n\n* **Real-time notifications**: Customer notified immediately when agent resolves Case\n* **Efficient**: Webhook push model (not polling)\n* **Event-driven**: Aligns with event-driven architecture pattern\n* **Better customer experience**: Proactive notification vs waiting for agent contact\n\n*Consequences*:\n\n* Real-time customer notifications for Case updates\n* Efficient push model (no polling overhead)\n* Bidirectional integration (Mobile App → Salesforce → Mobile App)\n* ⚠️ Salesforce webhook mechanism TBD (Outbound Messages vs Platform Events vs Process Builder)\n* ⚠️ Webhook authentication and security required\n* ⚠️ EngagementService must handle webhook retries and failures\n\n<<<\n== Interface Specifications\n\nThis section provides references to the complete API specifications and event catalogue for ProfileService and EngagementService.\n\n=== REST API Specifications\n\nComplete OpenAPI 3.0 specifications are maintained in the `specifications/rest/` directory:\n\n==== ProfileService API v1\n\n*Specification*: link:../../specifications/rest/profile-service-v1.yaml[profile-service-v1.yaml]\n\n*Base URL*: `https://api.otr.com.au/profile/v1`\n\n*Authentication*: Bearer token (Microsoft Entra External ID JWT)\n\n*Key Endpoints*:\n\n* `GET /contact-id` - Retrieve or create Salesforce Contact ID for authenticated user (Just-In-Time reconciliation)\n** Used by Mobile App before submitting feedback to EngagementService\n** Upserts Salesforce Contact record using email as external key\n** Returns 18-character Salesforce Contact ID with caching (15-minute TTL)\n** Performance SLA: p95 < 300ms (uncached), p95 < 50ms (cached)\n\n==== EngagementService API v1\n\n*Specification*: link:../../specifications/rest/engagement-service-v1.yaml[engagement-service-v1.yaml]\n\n*Base URL*: `https://api.otr.com.au/engagement/v1`\n\n*Authentication*: Bearer token (Microsoft Entra External ID JWT)\n\n*Key Endpoints*:\n\n* `POST /feedback` - Submit customer feedback for async Case creation in Salesforce\n** Accepts contactId, category, storeName, timeOfVisit, contactPhoneNumber, message\n** Returns 202 Accepted immediately (async Case creation in background)\n** Publishes `CustomerFeedbackSubmitted` event for analytics\n** Creates Salesforce Case via Anti-Corruption Layer with retry logic\n** Performance SLA: p95 < 200ms (feedback accepted, not Case creation)\n\n=== Domain Events (AsyncAPI)\n\nComplete CloudEvents 1.0 JSON Schema specifications are maintained in the `specifications/events/` directory:\n\n*Specification*: link:../../specifications/events/engagement-events.json[engagement-events.json]\n\n==== Event Catalogue\n\n[width=\"100%\",cols=\"30%,20%,50%\",options=\"header\",]\n|===\n|Event Type |Publisher |Consumers\n\n|`CustomerFeedbackSubmitted`\n|EngagementService\n|Future bounded contexts, analytics, sentiment analysis\n\n|`SupportCaseCreated`\n|EngagementService\n|Future bounded contexts, analytics\n\n|`SupportCaseUpdated`\n|EngagementService (via Salesforce webhook)\n|Future bounded contexts, analytics\n\n|`SupportCaseResolved`\n|EngagementService (via Salesforce webhook)\n|Future bounded contexts, analytics\n\n|===\n\n==== Event Delivery Guarantees\n\n* **At-least-once delivery**: Events may be delivered multiple times, consumers must handle idempotency\n* **Ordering**: FIFO queues guarantee ordering for events with same `contactId`\n* **Retention**: 4 days (96 hours) in Event Bus\n* **Dead Letter Queue**: Failed events after 5 retries moved to DLQ for manual intervention\n* **Format**: CloudEvents 1.0 specification with JSON payload\n\n=== API Versioning Policy\n\n==== Version Numbering\n\n* **Format**: `/v{major}` in URL path (e.g., `/profile/v1`, `/engagement/v1`)\n* **Semantic Versioning**: Major version incremented for breaking changes only\n* **Backwards Compatibility**: Minor changes (new optional fields, new endpoints) don't require version bump\n\n==== When to Version\n\n*Breaking changes requiring new major version*:\n\n- Removing or renaming fields in request/response\n- Changing field data types (e.g., string → number)\n- Changing authentication mechanism\n- Removing endpoints\n\n*Non-breaking changes not requiring version bump*:\n\n- Adding new optional fields to request/response\n- Adding new endpoints\n- Expanding enum values (e.g., adding new feedback category)\n- Improving error messages\n\n==== Parallel Version Support\n\n* Support N and N-1 versions concurrently for 6 months\n* Deprecation notice: 3 months before sunsetting old version\n* Mobile App must upgrade to new version within deprecation window\n\n<<<\n== Work Packages\n\nThis section consolidates gaps and activities into implementable work packages aligned with TOGAF Phase E requirements.\n\n=== Work Package Overview\n\n[width=\"100%\",cols=\"15%,35%,25%,25%\",options=\"header\",]\n|===\n|Work Package ID |Name |Transition State |Key Deliverables\n\n|WP-CS-001\n|ProfileService Development\n|TS-1 (Build & Test)\n|ProfileService microservice, Salesforce Contact integration, REST API\n\n|WP-CS-002\n|EngagementService Development\n|TS-1 (Build & Test)\n|EngagementService microservice, Anti-Corruption Layer, Braze integration\n\n|WP-CS-003\n|Event Bus Infrastructure\n|TS-1 (Build & Test)\n|Event Bus configuration, CloudEvents schemas, monitoring\n\n|WP-CS-004\n|Contact Migration Tooling\n|TS-1 (Build & Test)\n|Migration tool, validation scripts, reconciliation reporting\n\n|WP-CS-005\n|Mobile App Integration\n|TS-1 (Build & Test)\n|Mobile App API integration, feedback form enhancements, testing\n\n|WP-CS-006\n|Integration Testing\n|TS-1 (Build & Test)\n|Test environments, integration test suites, UAT execution\n\n|WP-CS-007\n|Salesforce Configuration\n|TS-1 (Build & Test)\n|Salesforce field mapping, data isolation, webhook configuration\n\n|WP-CS-008\n|Contact Data Migration\n|TS-2 (Contact Migration)\n|Contact migration execution, validation, reconciliation\n\n|WP-CS-009\n|Production Deployment\n|TS-3 (Cutover)\n|Production deployment, smoke testing, go-live execution\n\n|WP-CS-010\n|Post-Cutover Support\n|TS-4 (Target State)\n|Monitoring, issue resolution, D365 CE retirement\n\n|===\n\n[[wp-cs-001]]\n=== WP-CS-001: ProfileService Development\n\n==== Description\n\nBuild ProfileService bounded context microservice implementing Just-In-Time Contact reconciliation with Salesforce Service Cloud.\n\n==== Deliverables\n\n* ProfileService microservice application\n** REST API implementation (OpenAPI 3.0 specification)\n** `GET /contact-id` endpoint (Salesforce Contact reconciliation)\n** Authentication/authorization with Microsoft Entra External ID\n** Caching layer (15-minute TTL for Contact IDs)\n* Salesforce integration\n** Salesforce REST API client\n** Contact upsert by email (external key matching)\n** Error handling and retry logic\n* Unit tests (>80% code coverage)\n* Integration tests with Salesforce sandbox\n* API documentation\n* Deployment configuration (IaC - Infrastructure as Code)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* Salesforce sandbox environment provisioned\n* Microsoft Entra External ID OAuth configuration\n* Development environment setup (AWS dev account, CI/CD pipeline)\n\n*Dependent Work Packages*:\n\n* None (can start immediately after prerequisites met)\n\n==== Skills Required\n\n* Backend development (.NET Core or Node.js)\n* REST API design and implementation\n* Salesforce REST API integration\n* OAuth 2.0 / JWT authentication\n* Caching strategies (Redis/ElastiCache)\n* Unit/integration testing frameworks\n* Infrastructure as Code (Terraform/CloudFormation)\n\n==== Acceptance Criteria\n\n* All API endpoints return correct HTTP status codes per OpenAPI specification\n* Contact ID retrieval achieves p95 < 300ms (uncached), p95 < 50ms (cached)\n* Salesforce Contact upsert succeeds with 100% accuracy in sandbox testing\n* Unit test coverage > 80%\n* Integration tests pass in sandbox environment\n* API documentation generated from OpenAPI specification\n\n=== WP-CS-002: EngagementService Development\n\n==== Description\n\nBuild EngagementService bounded context microservice implementing customer feedback submission, Anti-Corruption Layer for Salesforce Case creation, Braze integration, and webhook receiver for Case updates.\n\n==== Deliverables\n\n* EngagementService microservice application\n** REST API implementation (OpenAPI 3.0 specification)\n** `POST /feedback` endpoint (async feedback submission)\n** Authentication/authorization with Microsoft Entra External ID\n** Webhook receiver endpoint for Salesforce Case updates\n* Anti-Corruption Layer (ACL)\n** OTR domain model to Salesforce API translation\n** Category enum mapping (App/Service/Order/Rewards → Salesforce Case fields)\n** Salesforce REST API client for Case creation\n* Async processing infrastructure\n** Event Bus publisher integration\n** Background worker for Case creation\n** Retry logic with exponential backoff (5 attempts)\n** Dead Letter Queue integration\n* Braze integration\n** Braze campaign trigger API client\n** Push notification orchestration for Case updates\n* Domain event publishing\n** `CustomerFeedbackSubmitted` event publisher\n** `SupportCaseCreated` event publisher\n** `SupportCaseUpdated` event translator (Salesforce webhook → domain event)\n** `SupportCaseResolved` event translator (Salesforce webhook → domain event)\n* Unit tests (>80% code coverage)\n* Integration tests (EngagementService ↔ Salesforce, EngagementService ↔ Braze)\n* API documentation\n* Deployment configuration (IaC)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-003 (Event Bus Infrastructure) completed\n* Salesforce sandbox environment provisioned\n* Braze API credentials and campaign templates configured\n* Microsoft Entra External ID OAuth configuration\n\n*Dependent Work Packages*:\n\n* WP-CS-003 must be completed first (Event Bus required for async processing)\n* WP-CS-007 (Salesforce Configuration) must be in progress (field mapping needed)\n\n==== Skills Required\n\n* Backend development (.NET Core or Node.js)\n* REST API design and implementation\n* Salesforce REST API integration\n* Event-driven architecture patterns\n* Async/background processing (queues, workers)\n* Braze API integration\n* Webhook design and security\n* OAuth 2.0 / JWT authentication\n* Domain-Driven Design (DDD) - Anti-Corruption Layer pattern\n* Unit/integration testing frameworks\n* Infrastructure as Code (Terraform/CloudFormation)\n\n==== Acceptance Criteria\n\n* Feedback submission endpoint returns 202 Accepted within p95 < 200ms\n* Async Case creation succeeds with >99.5% success rate (including retries)\n* Anti-Corruption Layer correctly maps all feedback categories to Salesforce Case fields\n* Webhook receiver processes Salesforce Case updates and publishes domain events\n* Braze push notifications sent successfully for Case updates\n* Failed Case creation moves to Dead Letter Queue after 5 retry attempts\n* Unit test coverage > 80%\n* Integration tests pass with Salesforce sandbox and Braze staging environment\n\n=== WP-CS-003: Event Bus Infrastructure\n\n==== Description\n\nImplement Event Bus infrastructure for domain event publishing using existing AWS infrastructure (SNS+SQS, EventBridge, or Kinesis).\n\n==== Deliverables\n\n* Event Bus infrastructure configuration\n** Topic/stream provisioning (technology choice: SNS+SQS / EventBridge / Kinesis)\n** FIFO queue configuration (ordering by `contactId`)\n** Dead Letter Queue (DLQ) setup\n** Retention policy (4 days / 96 hours)\n** Access control policies (IAM roles, permissions)\n* CloudEvents 1.0 schema definitions\n** JSON Schema specifications for all domain events\n** Schema validation configuration\n** Schema registry (if using EventBridge/Kinesis)\n* Monitoring and alerting\n** CloudWatch dashboards for queue metrics\n** Alarms for DLQ depth, queue age, processing failures\n** Event Bus throughput monitoring\n* Documentation\n** Event Bus architecture diagram\n** Event publishing guidelines\n** Consumer integration guide\n* Infrastructure as Code (IaC)\n** Terraform/CloudFormation templates for all infrastructure\n\n==== Dependencies\n\n*Prerequisites*:\n\n* AWS account access (existing infrastructure)\n* Technology selection decision (SNS+SQS vs EventBridge vs Kinesis)\n* CloudEvents 1.0 schema design approval\n\n*Dependent Work Packages*:\n\n* None (foundational infrastructure, can start early)\n\n==== Skills Required\n\n* AWS messaging services (SNS, SQS, EventBridge, Kinesis)\n* Event-driven architecture patterns\n* CloudEvents specification\n* JSON Schema design\n* Infrastructure as Code (Terraform/CloudFormation)\n* AWS IAM security configuration\n* CloudWatch monitoring and alerting\n\n==== Acceptance Criteria\n\n* Event Bus infrastructure provisioned in all environments (dev, staging, production)\n* FIFO ordering validated for events with same `contactId`\n* Dead Letter Queue triggers alarms when messages arrive\n* Event retention policy enforced (4 days)\n* CloudEvents 1.0 schema validation enabled\n* Monitoring dashboards operational\n* Infrastructure fully codified (IaC)\n\n=== WP-CS-004: Contact Migration Tooling\n\n==== Description\n\nDevelop Contact migration tool for one-time migration from app-specific database to Salesforce Service Cloud with upsert logic and validation.\n\n==== Deliverables\n\n* Contact migration tool\n** Extract Contacts from app-specific database\n** Transform to Salesforce Contact API format\n** Upsert to Salesforce using email as external key\n** Fallback matching by phone number or Viva Consumer ID\n** Batch processing with rate limiting (respect Salesforce API limits)\n** Idempotent operation (can be re-run safely)\n* Validation scripts\n** Pre-migration validation (data quality checks)\n** Post-migration validation (100% Contact reconciliation)\n** Email/phone/VCI matching accuracy report\n* Reconciliation reporting\n** Contacts created vs updated statistics\n** Failed upserts with error details\n** Matching accuracy metrics\n* Rollback capability\n** Export snapshot of Salesforce Contacts before migration\n** Rollback procedure documentation\n* Documentation\n** Migration tool user guide\n** Troubleshooting guide\n** Runbook for migration execution\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-001 (ProfileService Development) completed (reuses Salesforce integration code)\n* Salesforce sandbox environment for migration testing\n* App-specific database access (read-only sufficient)\n* Salesforce production access granted\n\n*Dependent Work Packages*:\n\n* WP-CS-001 provides Salesforce Contact upsert logic to reuse\n\n==== Skills Required\n\n* Database development (SQL, data extraction)\n* Salesforce REST API integration\n* Batch processing and ETL patterns\n* Data validation and reconciliation\n* Error handling and logging\n* Scripting (Python, PowerShell, or similar)\n\n==== Acceptance Criteria\n\n* Migration tool successfully migrates 100% of Contacts in sandbox with zero data loss\n* Email/phone/VCI matching accuracy > 95% in sandbox testing\n* Failed upserts captured with actionable error messages\n* Reconciliation report matches actual Salesforce Contact counts\n* Migration tool execution time acceptable for production (freezes app database for minimum time)\n* Rollback procedure validated in sandbox\n* Documentation complete and approved\n\n=== WP-CS-005: Mobile App Integration\n\n==== Description\n\nUpdate Mobile App to integrate with ProfileService and EngagementService APIs, replacing D365 CE integration.\n\n==== Deliverables\n\n* Feedback form UI enhancements\n** Add Category dropdown (App, Service, Order, Rewards, Refund, Delete Account)\n** Add Store Name field (optional)\n** Add Time of Visit field (optional, datetime picker)\n** Add Contact Phone Number field (optional, E.164 validation)\n** Update Message field (1-2000 character limit with counter)\n* API integration (Kotlin Multiplatform shared code)\n** ProfileService client (`GET /contact-id`)\n** EngagementService client (`POST /feedback`)\n** JWT token management (Microsoft Entra External ID)\n** Error handling (network failures, API errors, validation errors)\n** Retry logic for transient failures\n* Platform-specific UI (SwiftUI for iOS, Jetpack Compose for Android)\n** Feedback form screens\n** Success/error confirmation screens\n** Loading states and progress indicators\n* Feature flag integration\n** `enable_salesforce_feedback_submission` flag\n** Fallback to D365 CE if flag disabled (during rollout)\n* Unit tests for shared business logic\n* UI tests for platform-specific screens\n* API integration tests (mocked APIs)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-001 (ProfileService Development) completed and deployed to dev/staging\n* WP-CS-002 (EngagementService Development) completed and deployed to dev/staging\n* ProfileService and EngagementService OpenAPI specifications finalized\n* Feature flag service configured\n\n*Dependent Work Packages*:\n\n* Must complete after WP-CS-001 and WP-CS-002 (requires API endpoints available for integration testing)\n\n==== Skills Required\n\n* Kotlin Multiplatform development\n* SwiftUI (iOS native UI)\n* Jetpack Compose (Android native UI)\n* REST API client development\n* OAuth 2.0 / JWT authentication\n* Form validation and UX design\n* Unit testing (Kotlin, Swift)\n* UI testing frameworks (XCTest, Espresso)\n\n==== Acceptance Criteria\n\n* Feedback form UI matches UX design specifications\n* All form fields validate correctly (client-side validation)\n* API integration successfully calls ProfileService and EngagementService in dev/staging\n* Error handling provides user-friendly error messages\n* Feature flag correctly toggles between Salesforce and D365 CE integration\n* Unit test coverage > 80% for shared business logic\n* UI tests pass for all feedback form workflows (happy path, error states)\n* App builds and deploys successfully to TestFlight (iOS) and Google Play Internal Testing (Android)\n\n=== WP-CS-006: Integration Testing\n\n==== Description\n\nExecute comprehensive integration testing across all system components in non-production environments.\n\n==== Deliverables\n\n* Test environment setup\n** Salesforce sandbox configured with test data\n** ProfileService deployed to staging\n** EngagementService deployed to staging\n** Event Bus staging infrastructure\n** Braze staging environment configured\n** Mobile App TestFlight/Internal Testing builds\n* Integration test suites\n** ProfileService ↔ Salesforce (Contact upsert scenarios)\n** EngagementService ↔ Salesforce (Case creation scenarios)\n** EngagementService ↔ Braze (push notification scenarios)\n** Mobile App ↔ ProfileService ↔ EngagementService (end-to-end workflows)\n** Event Bus publishing and consumption\n** Webhook receiver (Salesforce → EngagementService)\n* Test scenarios\n** Happy path: Successful feedback submission and Case creation\n** Error scenarios: Salesforce API failures, Braze API failures, network timeouts\n** Retry scenarios: Async Case creation retries, DLQ validation\n** Performance testing: p95 latency validation for ProfileService and EngagementService\n** Load testing: Simulate 3x-10x expected volume\n* UAT execution\n** Business stakeholder UAT sessions\n** UAT test cases covering all feedback categories\n** UAT sign-off documentation\n* Test results documentation\n** Test execution reports\n** Defect tracking and resolution\n** Performance test results\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-001 (ProfileService Development) completed\n* WP-CS-002 (EngagementService Development) completed\n* WP-CS-003 (Event Bus Infrastructure) completed\n* WP-CS-005 (Mobile App Integration) completed\n* WP-CS-007 (Salesforce Configuration) sandbox configuration completed\n\n*Dependent Work Packages*:\n\n* Must complete after WP-CS-001, WP-CS-002, WP-CS-003, WP-CS-005 (requires all components available)\n\n==== Skills Required\n\n* Integration testing strategy and execution\n* Test automation frameworks (Postman, Newman, Selenium)\n* Performance testing tools (JMeter, k6, Gatling)\n* Salesforce sandbox administration\n* Test data management\n* Defect tracking and triage\n* UAT facilitation\n\n==== Acceptance Criteria\n\n* All integration test scenarios pass (happy path, error scenarios, retry scenarios)\n* Performance SLAs validated (ProfileService p95 < 300ms, EngagementService p95 < 200ms)\n* Load testing confirms system handles 3x expected volume without degradation\n* UAT sign-off obtained from business stakeholders\n* Zero critical defects (P1/P2) open before moving to Contact Migration\n* Test results documented and approved\n\n=== WP-CS-007: Salesforce Configuration\n\n==== Description\n\nConfigure Salesforce Service Cloud for OTR digital customer support integration, including field mapping, data isolation, and webhook setup.\n\n==== Deliverables\n\n* Salesforce Contact configuration\n** Custom fields for OTR-specific data (if needed)\n** Email as external key configuration\n** Record Type for OTR digital customers (data isolation)\n** Validation rules\n* Salesforce Case configuration\n** Custom fields for feedback categories (App, Service, Order, Rewards, Refund, Delete Account)\n** Case Type and Reason picklist mapping\n** Queue assignment rules (OTR digital support queue)\n** Case escalation rules\n** Case routing rules\n* Salesforce webhook configuration\n** Platform Events / Outbound Messages for Case updates\n** Webhook authentication (API key, JWT, or OAuth)\n** Case status change triggers (New → In Progress, Resolved, Closed)\n** Webhook payload format (JSON)\n* Data isolation strategy\n** Record Types for OTR vs other Viva Energy business units\n** Queues for OTR-specific Cases\n** Reporting and dashboards scoped to OTR data\n* Salesforce API access\n** Connected App configuration\n** OAuth 2.0 JWT bearer flow setup\n** API user credentials\n** API rate limit monitoring\n* Documentation\n** Salesforce field mapping specification\n** Webhook configuration guide\n** Data isolation architecture diagram\n** API authentication setup guide\n\n==== Dependencies\n\n*Prerequisites*:\n\n* Viva Energy Salesforce admin team engagement\n* Salesforce governance approval (multi-tenant environment)\n* Technical decision on webhook mechanism (Platform Events vs Outbound Messages)\n* Technical decision on authentication method (OAuth 2.0 JWT bearer flow recommended)\n\n*Dependent Work Packages*:\n\n* None (can start in parallel with development work packages)\n* Required for WP-CS-002 (EngagementService needs field mapping)\n* Required for WP-CS-006 (Integration Testing needs sandbox configuration)\n\n==== Skills Required\n\n* Salesforce administration\n* Salesforce configuration (Record Types, Queues, Validation Rules)\n* Salesforce API integration (REST API, Platform Events, Outbound Messages)\n* Salesforce security and authentication (OAuth, Connected Apps)\n* Multi-tenant data isolation patterns\n\n==== Acceptance Criteria\n\n* Salesforce sandbox configured with all custom fields, Record Types, Queues\n* Field mapping documented and approved by OTR business stakeholders\n* Webhook configuration tested and delivering Case update notifications\n* Data isolation validated (OTR data separate from other Viva Energy business units)\n* API authentication working for ProfileService and EngagementService\n* Salesforce API rate limits monitored and acceptable for expected volume\n* Configuration replicated to Salesforce production environment\n\n=== WP-CS-008: Contact Data Migration\n\n==== Description\n\nExecute one-time Contact migration from app-specific database to Salesforce Service Cloud production.\n\n==== Deliverables\n\n* Pre-migration activities\n** Final validation of migration tool in sandbox\n** Communication plan (notify users of maintenance window if needed)\n** Freeze app-specific database Contact updates\n** Backup app-specific database\n** Export snapshot of Salesforce Contacts (rollback preparation)\n* Migration execution\n** Execute migration tool against Salesforce production\n** Monitor migration progress\n** Handle failed upserts (manual intervention if needed)\n* Post-migration validation\n** 100% Contact reconciliation (app database vs Salesforce)\n** Email/phone/VCI matching accuracy report\n** Reconciliation report (Contacts created vs updated)\n** Data integrity checks (no duplicate Contacts, no missing Contacts)\n* ProfileService smoke testing\n** Verify Contact ID retrieval works in production\n** Test cache behavior\n** Validate Salesforce Contact upserts from ProfileService\n* Migration report\n** Total Contacts migrated\n** Contacts created vs updated\n** Failed upserts (if any) with resolution\n** Matching accuracy metrics\n** Migration execution time\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-004 (Contact Migration Tooling) completed\n* WP-CS-001 (ProfileService Development) deployed to production (not yet integrated with Mobile App)\n* WP-CS-007 (Salesforce Configuration) production configuration completed\n* Salesforce production access granted\n* Migration approved by business stakeholders\n\n*Dependent Work Packages*:\n\n* Must complete after WP-CS-001, WP-CS-004, WP-CS-007\n* Must complete before WP-CS-009 (Production Deployment)\n\n==== Skills Required\n\n* Data migration execution\n* Salesforce administration\n* Database operations\n* Data validation and reconciliation\n* Incident management (if issues arise)\n\n==== Acceptance Criteria\n\n* 100% of Contacts migrated with zero data loss\n* Email/phone/VCI matching accuracy > 95%\n* ProfileService smoke tests pass in production\n* Reconciliation report approved by business stakeholders\n* App-specific database Contact updates frozen (read-only mode)\n* Rollback procedure ready (but not executed if migration successful)\n\n=== WP-CS-009: Production Deployment\n\n==== Description\n\nDeploy all solution components to production and execute cutover from D365 CE to Salesforce Service Cloud.\n\n==== Deliverables\n\n* Production deployment\n** EngagementService deployed to production\n** Event Bus production infrastructure validated\n** Salesforce webhook configured in production\n** Mobile App released to production (App Store, Google Play)\n* Go-live activities\n** Smoke testing (end-to-end feedback submission)\n** Feature flag enabled: `enable_salesforce_feedback_submission = ON`\n** D365 CE integration disabled in Mobile App\n** Monitor Event Bus queue depth, DLQ, Salesforce API rate limits\n** Monitor Mobile App feedback submission success rate\n* Go/No-Go decision\n** Validate success criteria before final cutover\n** Business stakeholder approval\n** Technical validation (smoke tests pass, monitoring healthy)\n* Cutover communication\n** Notify support agents of new Salesforce integration\n** Provide training materials for support agents\n** Customer communication (if visible change)\n* Rollback plan\n** Documented rollback procedure\n** Feature flag can disable Salesforce integration and re-enable D365 CE\n** Rollback decision criteria (P1/P2 incidents, feedback submission success rate < 99%)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-001 (ProfileService Development) completed\n* WP-CS-002 (EngagementService Development) completed\n* WP-CS-003 (Event Bus Infrastructure) completed\n* WP-CS-005 (Mobile App Integration) completed\n* WP-CS-006 (Integration Testing) completed with UAT sign-off\n* WP-CS-007 (Salesforce Configuration) production configuration completed\n* WP-CS-008 (Contact Data Migration) completed successfully\n* Mobile App release approval (App Store, Google Play)\n\n*Dependent Work Packages*:\n\n* Must complete after all prior work packages (final cutover)\n\n==== Skills Required\n\n* Production deployment and release management\n* Incident management and troubleshooting\n* Monitoring and observability\n* Change management and communication\n* Rollback execution (if needed)\n\n==== Acceptance Criteria\n\n* Mobile App feedback submission success rate > 99.5%\n* End-to-end flow validated (Mobile App → ProfileService → EngagementService → Salesforce Case created)\n* Braze push notifications delivered successfully\n* Event Bus queue depth normal, DLQ empty\n* No critical incidents (P1/P2) in first 24 hours\n* D365 CE integration disabled\n* Support agents successfully using Salesforce for OTR digital customer Cases\n\n=== WP-CS-010: Post-Cutover Support\n\n==== Description\n\nMonitor production stability, resolve issues, validate success criteria, and execute D365 CE retirement.\n\n==== Deliverables\n\n* Monitoring and support\n** 24/7 on-call support for first week post-cutover\n** Daily monitoring reports (feedback submission success rate, Case creation success rate)\n** Incident response and resolution\n** Performance tuning (if needed)\n* Success criteria validation\n** Validate feedback submission success rate > 99.5%\n** Monitor customer satisfaction score (target: +15% improvement within 6 months)\n** Monitor average case resolution time (target: -20% improvement within 6 months)\n** Support agent feedback survey\n* D365 CE retirement\n** D365 CE set to read-only mode (historical Case lookups only)\n** Archive D365 CE data for compliance/auditing\n** Decommission D365 CE infrastructure (after 90-day stabilization period)\n** Remove D365 CE integration code from Mobile App\n* Documentation updates\n** Production runbook\n** Troubleshooting guide (based on incidents resolved)\n** Operational procedures for support team\n** Lessons learned document\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-009 (Production Deployment) completed\n* Cutover successful with no critical incidents\n\n*Dependent Work Packages*:\n\n* Final work package in sequence\n\n==== Skills Required\n\n* Production support and incident management\n* Performance monitoring and tuning\n* Data archival and compliance\n* Infrastructure decommissioning\n* Documentation\n\n==== Acceptance Criteria\n\n* Zero critical incidents (P1/P2) in first 30 days post-cutover\n* Feedback submission success rate sustained > 99.5%\n* Customer satisfaction improvement validated (baseline established, ongoing measurement)\n* Support agents reporting positive experience with Salesforce unified view\n* D365 CE successfully decommissioned\n* All production documentation complete and approved\n* Lessons learned document published\n\n=== Work Package Sequencing\n\n==== Parallel Track 1: Infrastructure & Configuration\n\nCan start immediately and run in parallel:\n\n* WP-CS-003 (Event Bus Infrastructure)\n* WP-CS-007 (Salesforce Configuration)\n\n==== Parallel Track 2: Development\n\nCan start after Track 1 infrastructure decisions made:\n\n* WP-CS-001 (ProfileService Development) - Independent\n* WP-CS-002 (EngagementService Development) - Requires WP-CS-003 completed\n* WP-CS-004 (Contact Migration Tooling) - Requires WP-CS-001 completed (reuses code)\n\n==== Sequential Track 3: Integration & Testing\n\nMust complete after development:\n\n* WP-CS-005 (Mobile App Integration) - Requires WP-CS-001, WP-CS-002\n* WP-CS-006 (Integration Testing) - Requires WP-CS-001, WP-CS-002, WP-CS-003, WP-CS-005, WP-CS-007\n\n==== Sequential Track 4: Migration & Cutover\n\nMust complete sequentially:\n\n* WP-CS-008 (Contact Data Migration) - Requires WP-CS-001, WP-CS-004, WP-CS-006 UAT sign-off\n* WP-CS-009 (Production Deployment) - Requires all prior work packages completed\n* WP-CS-010 (Post-Cutover Support) - Requires WP-CS-009\n\n==== Critical Path\n\nThe critical path for this project is:\n\n. WP-CS-003 (Event Bus Infrastructure)\n. WP-CS-002 (EngagementService Development) - blocks on WP-CS-003\n. WP-CS-005 (Mobile App Integration) - blocks on WP-CS-001, WP-CS-002\n. WP-CS-006 (Integration Testing) - blocks on WP-CS-001 through WP-CS-005, WP-CS-007\n. WP-CS-008 (Contact Data Migration) - blocks on WP-CS-006 UAT sign-off\n. WP-CS-009 (Production Deployment) - blocks on WP-CS-008\n. WP-CS-010 (Post-Cutover Support) - final deliverable\n\nAny delays in critical path work packages will delay the overall cutover date.\n\n<<<\n== Transition Architecture\n\nThis section defines the evolution from baseline (D365 CE) to target state (Salesforce Service Cloud + ProfileService + EngagementService).\n\n=== Transition Approach\n\n*Big Bang Cutover*: Per ADR-CS-006, this transition uses a single cutover approach rather than phased rollout. All users switch from D365 CE to Salesforce simultaneously after Contact migration completion.\n\n=== Transition States\n\n==== TS-0: Baseline State (Current)\n\n===== Characteristics\n\n* D365 Customer Engagement handles all digital customer feedback\n* App-specific database stores customer Contact data\n* No ProfileService or EngagementService\n* No event-driven architecture\n* Synchronous feedback submission\n\n===== Components Active\n\n- D365 Customer Engagement\n- App-specific customer database\n- Mobile App (current version with D365 CE integration)\n\n==== TS-1: Build & Test\n\n===== Activities\n\n* Build ProfileService microservice (JIT Contact reconciliation API)\n* Build EngagementService microservice (feedback submission API, ACL for Salesforce Case creation, Braze integration, webhook receiver)\n* Implement Event Bus infrastructure (SNS+SQS/EventBridge/Kinesis)\n* Develop Contact migration tool (app database → Salesforce upsert by email/phone/VCI)\n* Update Mobile App API integration (ProfileService + EngagementService endpoints - feedback form UI already complete)\n* Integration testing (ProfileService ↔ Salesforce, EngagementService ↔ Salesforce, EngagementService ↔ Braze)\n* UAT with test Salesforce sandbox environment\n\n===== Components Active\n\n- D365 Customer Engagement (still active, unchanged)\n- App-specific customer database (still active)\n- ProfileService (non-production, testing only)\n- EngagementService (non-production, testing only)\n- Event Bus (non-production)\n- Salesforce Sandbox (testing)\n\n===== Exit Criteria\n\n- All integration tests pass\n- UAT sign-off from business stakeholders\n- Contact migration tool validated in sandbox\n- Mobile App updates tested with non-production APIs\n\n==== TS-2: Contact Migration\n\n===== Activities\n* Execute Contact migration (app database → Salesforce production)\n* Validation: 100% data integrity check (email/phone/VCI matching)\n* Reconciliation report: New Contacts created vs existing Contacts updated\n* Freeze app database Contact updates during migration window\n* ProfileService smoke testing (verify Contact lookups work in Salesforce production)\n\n===== Components Active\n- D365 Customer Engagement (still active, users unaffected)\n- Salesforce Production (Contacts migrated, no Cases yet)\n- ProfileService (production deployed, not integrated with Mobile App yet)\n- App-specific customer database (frozen, read-only)\n\n===== Exit Criteria\n- 100% of Contacts migrated with zero data loss\n- Email/phone/VCI matching accuracy > 95%\n- ProfileService smoke tests pass (JIT lookups return correct Contact IDs)\n- Reconciliation report approved\n\n==== TS-3: Cutover (Go-Live)\n\n===== Go-Live Activities\n\n* Deploy EngagementService to production\n* Deploy Mobile App updates (ProfileService + EngagementService API integration)\n* Configure Salesforce webhook (Case update notifications → EngagementService)\n* Smoke testing: End-to-end feedback submission (Mobile App → EngagementService → Salesforce → Braze notification)\n* Monitor Event Bus queue depth, dead letter queue, Salesforce API rate limits\n* **Go/No-Go decision**: Validate success criteria before final cutover\n* Enable feature flag: `enable_salesforce_feedback_submission = ON`\n* Disable D365 CE integration in Mobile App\n\n===== Components Active\n\n- ProfileService (production, integrated with Mobile App)\n- EngagementService (production, integrated with Mobile App)\n- Event Bus (production, processing async Case creation)\n- Salesforce Production (receiving Cases from digital customers)\n- Braze (sending push notifications)\n- Mobile App (new version with Salesforce integration)\n- D365 Customer Engagement (disabled, read-only for historical lookups)\n\n===== Exit Criteria\n\n- Mobile App feedback submission success rate > 99.5%\n- End-to-end flow validated (Mobile App → Salesforce Case created)\n- Braze push notifications delivered successfully\n- Event Bus queue depth normal, DLQ empty\n- No critical incidents (P1/P2) in first 24 hours\n\n==== TS-4: Target State (Stable Production)\n\n===== Characteristics\n\n* ProfileService and EngagementService fully operational\n* All digital customer feedback routed to Salesforce\n* Event-driven architecture established\n* D365 CE decommissioned\n* First DDD bounded contexts implemented successfully\n\n===== Monitoring Period\n\n* Validate success criteria: feedback submission rate > 99.5%, no data loss\n* Monitor customer satisfaction score (target: +15% improvement)\n* Monitor average case resolution time (target: -20% improvement)\n* Support agents using unified Salesforce view across all channels\n\n===== D365 CE Retirement\n\n* D365 CE read-only access for historical Case lookups (if needed)\n* Decommission D365 CE infrastructure after 90 days\n* Archive D365 CE data for compliance/auditing\n\n===== Components Active\n\n- ProfileService (production)\n- EngagementService (production)\n- Event Bus (production)\n- Salesforce Production (system of record)\n- Braze (push notifications)\n- Mobile App (Salesforce integration)\n- App-specific database (deprecated, Contact data no longer updated)\n\n===== Success Criteria Achieved\n\n- All digital customer feedback routed to Salesforce\n- Support agents have unified customer view\n- D365 CE decommissioned\n- Customer satisfaction improved by 15%\n- Average case resolution time decreased by 20%\n- Zero data loss during transition\n\n=== Transition Dependencies\n\n[width=\"100%\",cols=\"40%,60%\",options=\"header\",]\n|===\n|Dependency |Owner/Status\n\n|*Salesforce production access*\n|Viva Energy Salesforce admin team - TBD\n\n|*Salesforce Case field mapping*\n|Viva Energy Salesforce admin team - TBD (map OTR feedback categories to Salesforce fields)\n\n|*Salesforce data isolation strategy*\n|Viva Energy Salesforce admin team - TBD (Record Types, queues, custom fields)\n\n|*Salesforce webhook configuration*\n|Viva Energy Salesforce admin team - TBD (Outbound Messages vs Platform Events)\n\n|*Event Bus infrastructure*\n|OTR Platform team - Existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis)\n\n|*Braze integration*\n|OTR Marketing team - Existing Braze account, EngagementService creates new campaigns\n\n|*Mobile App release window*\n|OTR Mobile team - Coordinate cutover timing with app release schedule\n\n|*App database access*\n|OTR Platform team - Read access for Contact migration\n\n|===\n\n=== Transition Validation Criteria\n\n==== Contact Migration Validation\n\n* 100% of app database Contacts migrated to Salesforce (zero data loss)\n* Email/phone/VCI matching accuracy > 95% (minimize duplicate Contacts)\n* ProfileService JIT lookups return correct Salesforce Contact IDs (smoke test sample)\n* Reconciliation report shows: X new Contacts created, Y existing Contacts updated\n\n==== Cutover Validation\n\n* Mobile App feedback submission success rate > 99.5% (including async Case creation)\n* End-to-end flow validated: Mobile App → ProfileService → EngagementService → Salesforce Case created\n* Braze push notifications delivered for Case creation and Case resolution\n* Event Bus queue depth within normal range (no backlog)\n* Dead letter queue empty (no failed Case creations)\n* Salesforce API rate limits not exceeded\n\n==== Production Monitoring (30 days)\n\n* Customer satisfaction score improves by 15% (compared to D365 CE baseline)\n* Average case resolution time decreases by 20% (Salesforce vs D365 CE)\n* Support agents confirm unified customer view across all channels\n* Zero critical incidents (P1 outages, data loss)\n\n=== Rollback Plan\n\n==== Rollback Triggers\n\n* Feedback submission success rate < 95% (below acceptable threshold)\n* Data loss or corruption detected in Salesforce\n* Salesforce API rate limits exceeded (Cases not created within SLA)\n* Critical bug blocking customer feedback submission\n\n==== Rollback Procedure\n\n1. **Revert Mobile App** to previous version (remove ProfileService/EngagementService integration, restore D365 CE integration)\n2. **Stop EngagementService** Case creation (prevent duplicate Cases in Salesforce)\n3. **Re-enable D365 CE** for customer feedback submission\n4. **Investigate root cause** (EngagementService logs, Salesforce API errors, Event Bus queue issues)\n5. **Fix and re-test** in sandbox environment\n6. **Retry cutover** when issues resolved\n\n==== Rollback Limitations\n\n* Cases created in Salesforce during cutover period remain in Salesforce (no reverse migration)\n* Contacts migrated to Salesforce remain (no rollback to app database)\n* Rollback only affects Mobile App integration (not data migration)\n\n=== Architectural Scope Boundaries\n\n==== Capabilities Included\n\n===== Business Capabilities\n\n* **Customer Feedback Submission**: Mobile App users can submit structured feedback (Category, Store Name, Time of Visit, Phone, Free Text Message) via EngagementService\n* **Customer Contact Management**: Just-In-Time (JIT) Contact reconciliation with Salesforce via ProfileService, ensuring every Mobile App user has a Salesforce Contact record\n* **Case Management Integration**: EngagementService creates Salesforce Cases asynchronously for customer feedback, support agents manage Cases in Salesforce Service Cloud\n* **Customer Notifications**: Push notifications via Braze when Cases are created, updated, or resolved (bidirectional integration: Mobile App → Salesforce → Mobile App)\n* **Unified Customer View**: Support agents see OTR digital customer feedback alongside other Viva Energy channels (fuel wholesale, Shell Card, retail) in single Salesforce instance\n* **Contact Data Migration**: One-time migration of app-specific customer database Contacts to Salesforce with upsert logic (email/phone/VCI matching)\n\n===== Technical Capabilities\n\n* **ProfileService Bounded Context**: First DDD bounded context implementation - JIT Contact reconciliation, Salesforce API facade, foundation for Flybuys integration\n* **EngagementService Bounded Context**: First DDD bounded context implementation - Customer feedback submission BFF, Anti-Corruption Layer for Salesforce, Braze integration orchestration\n* **Event-Driven Architecture**: Domain event publishing via Event Bus (SNS+SQS/EventBridge/Kinesis) for `SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted` events\n* **Async Processing Pattern**: Non-blocking Case creation with retry logic, exponential backoff, dead letter queue for operational resilience\n* **Anti-Corruption Layer Pattern**: EngagementService protects digital channels from Salesforce API changes, translates between OTR domain language and Salesforce\n* **Conformist Pattern**: ProfileService and EngagementService conform to existing Salesforce configuration (shared Viva Energy instance, multi-tenant governance)\n* **Salesforce Integration**: REST API integration for Contact CRUD and Case creation, webhook receiver for Case update notifications\n* **Braze Integration**: Push notification campaign triggers for Case lifecycle events (created, updated, resolved)\n* **Observability & Monitoring**: Dashboards, metrics, alerting for feedback submission rate, queue depth, API errors, Case creation latency\n* **Feature Flag Management**: Kill switches for emergency rollback (enable_salesforce_feedback_submission, enable_async_case_creation, etc.)\n\n==== Capabilities Excluded\n\n===== Business Capabilities Explicitly Out of Scope\n\n* **Historical Case Migration**: D365 CE Cases not migrated to Salesforce (ADR-CS-005 - fresh start, no Case migration)\n* **Multi-Channel Feedback Submission**: Web app, POS, call centre, email feedback channels not included (Mobile App only in this phase)\n* **Case Resolution by Digital Channels**: Support agents resolve Cases in Salesforce, not via Mobile App self-service\n* **Knowledge Base Integration**: Salesforce Knowledge Base articles not surfaced in Mobile App (future enhancement)\n* **Live Chat/Messaging**: Real-time chat support not included (Salesforce omnichannel capabilities not activated)\n* **Sentiment Analysis**: Automated feedback sentiment analysis not included (future enhancement with AI/ML)\n* **Customer Satisfaction Surveys**: Post-resolution CSAT surveys not included (separate initiative)\n* **Case Attachments**: Mobile App feedback submission does not support file uploads (photos, receipts) - text only\n* **Agent Desktop Integration**: Custom Salesforce UI for support agents not included (use standard Salesforce Service Console)\n* **Social Media Feedback**: Facebook, Twitter, Instagram feedback channels not integrated\n\n===== Technical Capabilities Explicitly Out of Scope\n\n* **Event Sourcing**: Domain events are ephemeral (not persisted for event sourcing/replay) - Event Bus only, no Event Store\n* **CQRS (Command Query Responsibility Segregation)**: ProfileService and EngagementService use same data model for reads/writes (no separate read models)\n* **Local Aggregate Persistence**: ProfileService and EngagementService are stateless (Salesforce is System of Record, no local database for Contact/Case)\n* **Saga Orchestration**: No distributed transactions or saga patterns required (single-step Case creation, not multi-step workflow)\n* **API Gateway Advanced Features**: Rate limiting, API versioning, API key management deferred to detailed design (basic routing only)\n* **GraphQL API**: ProfileService and EngagementService expose REST APIs only (GraphQL not required)\n* **Real-Time Sync**: Salesforce Contact updates by support agents not synced back to ProfileService (eventual consistency acceptable via JIT reconciliation)\n* **Multi-Region Deployment**: Single AWS region deployment (no multi-region failover/disaster recovery in this phase)\n* **Blue-Green Deployment**: Big bang cutover (ADR-CS-006), not blue-green or canary deployment strategy\n* **A/B Testing Framework**: Feature flags for rollback only, not for A/B testing or experimentation\n* **Custom Authentication**: Microsoft Entra External ID used for Mobile App authentication (no custom authentication logic in ProfileService/EngagementService)\n* **Data Residency Compliance**: Salesforce data residency governed by Viva Energy Salesforce configuration (no OTR-specific data residency requirements)\n\n===== Future Bounded Contexts Not in Scope\n\n* **LoyaltyService**: Flybuys integration, reward preferences, transaction adjudication (separate initiative)\n* **LocationService**: Store finder, proximity features, geofencing (separate initiative)\n* **PaymentService**: Payment processing, subscription billing (separate initiative)\n* **RecommendationService**: Personalized recommendations, next-best offers (separate initiative)\n\n===== Integration Patterns Not in Scope\n\n* **Shared Kernel**: No shared domain model between ProfileService and EngagementService (separate bounded contexts with clear boundaries)\n* **Partnership**: No joint development or coordination with external teams (Conformist pattern - we conform to Salesforce)\n* **Customer-Supplier (we're upstream)**: No downstream systems depend on ProfileService/EngagementService APIs yet (future bounded contexts will consume domain events)\n\n==== Architectural Dependencies on Future Initiatives\n\n*This Architecture Enables Future Initiatives*:\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Future Initiative |Architectural Enablement\n\n|*Flybuys Integration*\n|**ProfileService Contact Reconciliation Reused**: ProfileService establishes pattern for JIT Contact reconciliation with Salesforce, which will be extended for Flybuys partner linking (link:../architecture_definitions/flybuys_integration.adoc[see Flybuys Integration architecture]) +\n**Event Bus Infrastructure**: Domain event publishing pattern (`CustomerEnrolledInLoyalty`, `PartnerLinked`, etc.) reuses Event Bus established for EngagementService\n\n|*LoyaltyService Bounded Context*\n|**Event Bus Subscription**: LoyaltyService will consume `CustomerProfileCreated` events published by ProfileService (future enhancement) +\n**Salesforce Contact Integration**: LoyaltyService may query Salesforce Contacts for customer reward preferences (via ProfileService facade or direct Salesforce API)\n\n|*Web App Feedback Submission*\n|**EngagementService API Reuse**: Web app will call same EngagementService REST API for feedback submission (multi-channel support) +\n**Conformist Pattern**: Web app conforms to EngagementService API contract (no translation required)\n\n|*Multi-Channel Customer Support*\n|**EngagementService Extension**: Add support for email, call centre, POS feedback channels (extend EngagementService to handle multiple origins) +\n**Salesforce Case Origin Field**: Cases already tagged with Origin=Mobile App, extend to Origin=Web, POS, Call Centre, Email\n\n|*Knowledge Base Integration*\n|**EngagementService API Extension**: Add endpoint to query Salesforce Knowledge Base articles, surface in Mobile App for self-service support +\n**Anti-Corruption Layer**: EngagementService translates Salesforce Knowledge API to OTR domain language\n\n|*Customer Satisfaction Surveys*\n|**Event-Driven Trigger**: Subscribe to `SupportCaseResolved` events published by EngagementService, trigger CSAT survey via Braze +\n**Braze Integration Pattern**: Reuse EngagementService → Braze integration pattern for survey campaigns\n\n|*Sentiment Analysis*\n|**Event Subscription**: Subscribe to `CustomerFeedbackSubmitted` events, analyse feedback sentiment (AI/ML service) +\n**EngagementService Extension**: Enrich Case with sentiment score before creating in Salesforce\n\n|*RecommendationService Bounded Context*\n|**Event Subscription**: RecommendationService subscribes to `SupportCaseCreated` events to understand customer pain points and personalize recommendations +\n**Domain Event Pattern**: Reuse Event Bus publishing pattern established by EngagementService\n\n|===\n\n*This Architecture Depends on Future Initiatives*:\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Future Initiative |Dependency Description\n\n|*Salesforce Data Isolation Strategy*\n|**BLOCKER**: Viva Energy Salesforce admin team must define data isolation strategy (Record Types, custom fields, queues) before production deployment +\n**Impact**: Multi-tenant data visibility and security governance\n\n|*Salesforce Case Field Mapping*\n|**BLOCKER**: Viva Energy Salesforce admin team must define field mapping for OTR feedback categories (App, Service, Order, Rewards, Refund, Delete Account) +\n**Impact**: Case creation logic in EngagementService depends on finalized Salesforce schema\n\n|*Salesforce Webhook Mechanism*\n|**BLOCKER**: Viva Energy Salesforce admin team must configure webhook mechanism (Outbound Messages vs Platform Events vs Process Builder) for Case update notifications +\n**Impact**: EngagementService webhook receiver implementation depends on chosen mechanism\n\n|*Event Bus Technology Selection*\n|**DECISION REQUIRED**: Choose Event Bus implementation (SNS+SQS vs EventBridge vs Kinesis) for domain event publishing +\n**Impact**: Infrastructure provisioning, event schema design, consumer implementation\n\n|*Microservice Hosting Platform*\n|**DECISION REQUIRED**: Choose hosting platform for ProfileService and EngagementService (AWS Lambda vs ECS vs EKS) +\n**Impact**: Deployment architecture, auto-scaling strategy, operational overhead\n\n|*Observability Platform*\n|**DECISION REQUIRED**: Choose observability platform (AWS CloudWatch vs Datadog vs New Relic) for monitoring and alerting +\n**Impact**: Dashboard configuration, metric collection, alerting setup\n\n|===\n\n*Future Work After This Initiative*:\n\n* **Event Schema Registry**: Implement event schema versioning and registry for domain events (currently ad-hoc schemas)\n* **API Versioning Strategy**: Define API versioning approach for ProfileService and EngagementService (currently v1 only)\n* **Multi-Region Deployment**: Extend to multi-region for disaster recovery and global availability\n* **Event Store**: Persist domain events for event sourcing and audit trail (currently ephemeral Event Bus only)\n* **CQRS Pattern**: Separate read models for high-volume queries (currently same model for reads/writes)\n* **GraphQL API**: Expose GraphQL API for flexible client queries (currently REST only)\n* **Real-Time Sync**: Bi-directional sync between Salesforce and ProfileService for Contact updates (currently JIT reconciliation only)\n\n=== Technical Risks and Mitigation\n\n[width=\"100%\",cols=\"5%,20%,25%,25%,25%\",options=\"header\",]\n|===\n|ID |Risk |Impact |Likelihood |Mitigation\n\n|RISK-CS-001\n|*Salesforce API rate limits exceeded*: High feedback volume exceeds Salesforce API limits, Cases not created\n|HIGH (customers don't receive Case confirmation, support tickets lost)\n|MEDIUM (volume unknown, rate limits TBD)\n|• Gather expected feedback volume data before cutover +\n• Implement Event Bus queue throttling/rate limiting +\n• Monitor queue depth and API usage +\n• Scale background workers based on queue depth +\n• Alert ops team when approaching rate limits\n\n|RISK-CS-002\n|*Salesforce downtime*: Salesforce Service Cloud outage prevents Case creation\n|MEDIUM (Cases delayed but queued, customers wait for confirmation)\n|LOW (Salesforce SLA 99.9% uptime)\n|• Async Case creation with retry logic +\n• Event Bus queues buffer work during outage +\n• Customers get immediate \"Feedback submitted\" (not blocked) +\n• Monitor Salesforce status page, alert ops team +\n• Automatic retry when Salesforce recovers\n\n|RISK-CS-003\n|*Contact migration data quality issues*: App database Contact data incomplete or invalid\n|HIGH (migration fails validation, cutover delayed)\n|MEDIUM (legacy data quality unknown)\n|• Pre-migration data quality assessment +\n• Flexible upsert logic (match by email/phone/VCI) +\n• Validation report identifies data issues before production migration +\n• Manual cleanup for invalid records +\n• Dry-run migration in sandbox environment\n\n|RISK-CS-004\n|*Duplicate Contacts created*: Email matching fails, ProfileService creates duplicate Contacts\n|MEDIUM (support agents see multiple profiles for same customer)\n|MEDIUM (email changes, data quality issues)\n|• Salesforce duplicate detection rules (if available) +\n• ProfileService logs Contact creation for audit trail +\n• Manual duplicate cleanup process (support team) +\n• Future enhancement: VCI as Salesforce External ID for stable matching\n\n|RISK-CS-005\n|*Dead letter queue accumulation*: Failed Case creations not processed, queue grows\n|HIGH (customers don't receive Case confirmation, feedback lost)\n|LOW (retry logic handles most failures)\n|• Dead letter queue monitoring and alerting +\n• Ops team dashboard showing DLQ depth +\n• Manual intervention process (investigate and reprocess) +\n• Automated alerts when DLQ depth exceeds threshold +\n• Root cause analysis for recurring failures\n\n|RISK-CS-006\n|*Salesforce webhook failures*: Salesforce can't deliver Case update notifications to EngagementService\n|MEDIUM (customers don't get push notifications for Case resolution)\n|LOW (webhook mechanism reliable)\n|• Webhook retry logic and exponential backoff +\n• EngagementService logs webhook deliveries +\n• Monitor webhook delivery success rate +\n• Fallback: Poll Salesforce API for Case updates (if webhook fails persistently) +\n• Alert ops team when webhook delivery rate drops\n\n|RISK-CS-007\n|*Multi-tenant data isolation breach*: OTR digital Cases visible to other Viva Energy support teams\n|HIGH (privacy violation, compliance risk)\n|LOW (Salesforce governance controls)\n|• Work with Viva Energy Salesforce admin team on data isolation strategy +\n• Test data visibility in Salesforce sandbox (UAT with different user roles) +\n• Validate Record Types, queues, field-level security before production +\n• Audit Salesforce user permissions and sharing rules\n\n|RISK-CS-008\n|*Mobile App release coordination*: App release delayed, cutover window missed\n|MEDIUM (cutover delayed, D365 CE retirement delayed)\n|MEDIUM (release schedule conflicts)\n|• Coordinate cutover timing with Mobile team early +\n• Buffer time in migration plan (2-week contingency) +\n• Decouple backend deployment from Mobile App release (backend deployed first, app follows) +\n• Feature flag for feedback submission (enable when ready)\n\n|RISK-CS-009\n|*Event Bus infrastructure issues*: SNS/SQS/EventBridge downtime or misconfiguration\n|HIGH (Case creation blocked, domain events not published)\n|LOW (AWS SLA 99.99% uptime)\n|• Leverage existing AWS infrastructure (proven, reliable) +\n• Infrastructure as Code (IaC) for Event Bus configuration +\n• Integration testing in non-production environment +\n• Monitor Event Bus metrics (queue depth, throughput, errors) +\n• Alert ops team on Event Bus failures\n\n|RISK-CS-010\n|*Team DDD knowledge gap*: Team unfamiliar with DDD patterns, bounded contexts, event-driven architecture\n|MEDIUM (implementation delays, architectural inconsistencies)\n|HIGH (first DDD implementation)\n|• DDD training for development team (workshops, documentation) +\n• Architecture review sessions (validate bounded context design) +\n• Pair programming with experienced DDD practitioners +\n• Incremental implementation (start small, iterate) +\n• Document architectural patterns in CLAUDE.md\n\n|===\n\n== Assumptions and Constraints\n\n=== Assumptions\n\n[width=\"100%\",cols=\"8%,92%\",options=\"header\",]\n|===\n|ID |Assumption\n\n|ASM-CS-001\n|Viva Energy Salesforce admin team will provide Salesforce production access, sandbox environment, and support for Case field mapping and data isolation configuration\n\n|ASM-CS-002\n|App database Contact data is sufficiently complete for migration (email/phone/VCI available for matching)\n\n|ASM-CS-003\n|Expected customer feedback volume (100-150 submissions/day from 20k DAU) is well within Salesforce API rate limits, with capacity planning for 3x-10x growth\n\n|ASM-CS-004\n|Existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis) is sufficient for Event Bus implementation (no additional infrastructure provisioning required)\n\n|ASM-CS-005\n|Braze integration already exists and can be extended for Case-related push notifications (no new Braze account or major configuration changes)\n\n|ASM-CS-006\n|Mobile App users have email addresses associated with their accounts (required for ProfileService Contact reconciliation)\n\n|ASM-CS-007\n|D365 Customer Engagement historical Cases have limited business value and do not require migration to Salesforce\n\n|ASM-CS-008\n|Support agents are trained on Salesforce Service Cloud and require minimal additional training for OTR digital customer Cases\n\n|ASM-CS-009\n|Salesforce Service Cloud shared instance has capacity for OTR digital customer Contacts and Cases (no additional licensing or storage costs)\n\n|ASM-CS-010\n|Mobile App release schedule can accommodate cutover timing (Week 10 in migration plan)\n\n|===\n\n=== Constraints\n\n[width=\"100%\",cols=\"8%,92%\",options=\"header\",]\n|===\n|ID |Constraint\n\n|CON-CS-001\n|Must use shared Viva Energy Salesforce Service Cloud instance (cannot deploy separate OTR-specific instance)\n\n|CON-CS-002\n|Must conform to existing Salesforce configuration and governance (Record Types, custom fields, queues, data isolation strategy defined by Viva Energy admin team)\n\n|CON-CS-003\n|Contact migration must complete before Mobile App cutover (no parallel run of D365 CE and Salesforce)\n\n|CON-CS-004\n|Big bang cutover only (no phased rollout with feature flags or pilot users)\n\n|CON-CS-005\n|Salesforce API rate limits and authentication method constrained by Viva Energy Salesforce configuration (TBD)\n\n|CON-CS-006\n|Event Bus implementation must use existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis - cannot introduce new infrastructure components)\n\n|CON-CS-007\n|Mobile App feedback form must include specific fields: Category, Store Name, Time of Visit, Contact Phone Number, Free Text Message (no attachments)\n\n|CON-CS-008\n|D365 Customer Engagement must be decommissioned within 90 days post-cutover (ADR-CS-006)\n\n|CON-CS-009\n|ProfileService and EngagementService must be stateless (no local aggregate persistence, Salesforce is System of Record)\n\n|CON-CS-010\n|First DDD bounded context implementation (team learning curve, architectural patterns must be documented for future bounded contexts)\n\n|===\n\n== Non-Functional Requirements\n\n=== Performance Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-PERF-001\n|Mobile App feedback submission API response time (ProfileService + EngagementService)\n|p95 < 1 second, p99 < 2 seconds\n\n|NFR-PERF-002\n|ProfileService Contact reconciliation API response time (JIT lookup)\n|p95 < 500ms, p99 < 1 second\n\n|NFR-PERF-003\n|EngagementService async Case creation latency (end-to-end: feedback submitted → Case created in Salesforce)\n|p95 < 5 minutes, p99 < 10 minutes\n\n|NFR-PERF-004\n|Salesforce API call latency (Contact query, Contact create, Case create)\n|p95 < 2 seconds, p99 < 5 seconds\n\n|NFR-PERF-005\n|Event Bus message processing throughput\n|> 100 messages/second (support peak feedback volume)\n\n|NFR-PERF-006\n|Braze push notification delivery latency (Case created → notification delivered)\n|p95 < 30 seconds, p99 < 60 seconds\n\n|===\n\n=== Availability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-AVAIL-001\n|ProfileService availability\n|99.9% uptime (8.76 hours downtime/year)\n\n|NFR-AVAIL-002\n|EngagementService availability\n|99.9% uptime (8.76 hours downtime/year)\n\n|NFR-AVAIL-003\n|Feedback submission success rate (including async Case creation)\n|> 99.5% (includes retry logic for transient failures)\n\n|NFR-AVAIL-004\n|Graceful degradation: Salesforce downtime handling\n|Feedback submission still succeeds, Cases queued for async creation when Salesforce recovers\n\n|NFR-AVAIL-005\n|Graceful degradation: Braze downtime handling\n|Case creation proceeds, push notifications disabled temporarily (feature flag)\n\n|NFR-AVAIL-006\n|Planned maintenance window\n|< 4 hours/month, scheduled during low-traffic periods (2-6am ACST)\n\n|===\n\n=== Scalability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-SCALE-001\n|Concurrent Mobile App users (peak)\n|Support 20,000 DAU (Daily Active Users), ~150 concurrent users submitting feedback during peak hours\n\n|NFR-SCALE-002\n|Feedback submissions per day\n|Expected: 100-150 submissions/day based on 20k DAU (~0.5-0.75% submission rate) +\nCapacity: Support 500 submissions/day (3x expected volume for growth), 2,000 submissions/day (peak/incident scenarios)\n\n|NFR-SCALE-003\n|Auto-scaling: ProfileService and EngagementService\n|Auto-scale based on CPU/memory/request rate, scale up within 2 minutes\n\n|NFR-SCALE-004\n|Event Bus queue capacity\n|Support 100,000 queued messages (buffer for Salesforce downtime)\n\n|NFR-SCALE-005\n|Salesforce API rate limit compliance\n|Stay within 80% of Salesforce API rate limits (buffer for spikes)\n\n|NFR-SCALE-006\n|Future growth capacity\n|Architecture supports 10x growth (1,000-1,500 submissions/day based on 200k DAU) without major redesign\n\n|===\n\n=== Security Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-SEC-001\n|Mobile App authentication\n|Microsoft Entra External ID OAuth 2.0 with JWT tokens (existing CIAM)\n\n|NFR-SEC-002\n|API authorisation: ProfileService and EngagementService\n|JWT token validation, authenticated users only, user context propagation\n\n|NFR-SEC-003\n|Salesforce API authentication\n|OAuth 2.0 with Connected App and JWT bearer flow (service account)\n\n|NFR-SEC-004\n|Data encryption in transit\n|TLS 1.2+ for all API calls (Mobile App ↔ ProfileService/EngagementService ↔ Salesforce ↔ Braze)\n\n|NFR-SEC-005\n|Data encryption at rest\n|Salesforce encryption at rest (managed by Salesforce), Event Bus message encryption (AWS KMS)\n\n|NFR-SEC-006\n|Secret management\n|AWS Secrets Manager for Salesforce credentials, Braze API keys, OAuth tokens (no hardcoded secrets)\n\n|NFR-SEC-007\n|PII data handling\n|Contact data (email, phone, name) treated as PII, GDPR-compliant retention policies (Salesforce governance)\n\n|NFR-SEC-008\n|API rate limiting and throttling\n|API Gateway rate limiting (100 requests/second per user), prevent abuse and DoS\n\n|NFR-SEC-009\n|Logging and auditing\n|Log all API calls, Salesforce Contact/Case creates/updates, Event Bus publishes (no PII in logs)\n\n|NFR-SEC-010\n|Salesforce data isolation\n|Multi-tenant data isolation via Salesforce Record Types, queues, sharing rules (defined by Viva Energy admin team)\n\n|===\n\n=== Reliability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-REL-001\n|Retry logic: EngagementService → Salesforce Case creation\n|Exponential backoff (1s, 2s, 4s, 8s, 16s), max 5 retries, then dead letter queue\n\n|NFR-REL-002\n|Dead letter queue monitoring\n|Alert ops team immediately when DLQ depth > 0 (failed Case creations require manual intervention)\n\n|NFR-REL-003\n|Event Bus message durability\n|Messages persisted in Event Bus (SNS+SQS/EventBridge/Kinesis), not lost on service restart\n\n|NFR-REL-004\n|Idempotency: Case creation\n|EngagementService ensures duplicate feedback submissions don't create duplicate Cases (idempotency key)\n\n|NFR-REL-005\n|Circuit breaker: Salesforce API calls\n|Open circuit after 5 consecutive failures, half-open retry after 30 seconds\n\n|NFR-REL-006\n|Health checks: ProfileService and EngagementService\n|Health endpoints for load balancer checks, readiness and liveness probes\n\n|NFR-REL-007\n|Disaster recovery: Event Bus\n|Event Bus messages replicated across AWS availability zones (SQS/EventBridge/Kinesis HA)\n\n|===\n\n=== Maintainability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-MAINT-001\n|Code quality: ProfileService and EngagementService\n|> 80% test coverage (unit + integration tests), automated CI/CD pipeline\n\n|NFR-MAINT-002\n|API documentation\n|OpenAPI/Swagger specs for ProfileService and EngagementService, auto-generated API docs\n\n|NFR-MAINT-003\n|Deployment automation\n|Infrastructure as Code (Terraform/CloudFormation/CDK), zero-downtime deployments\n\n|NFR-MAINT-004\n|Logging: structured logs\n|JSON-formatted logs with correlation IDs, log levels (DEBUG, INFO, WARN, ERROR), centralized log aggregation\n\n|NFR-MAINT-005\n|Monitoring dashboards\n|Real-time dashboards for ProfileService, EngagementService, Event Bus (see Monitoring and Observability section)\n\n|NFR-MAINT-006\n|Alerting and on-call\n|PagerDuty/Opsgenie integration for P1/P2 alerts, on-call rotation for ops team\n\n|NFR-MAINT-007\n|Configuration management\n|Externalized configuration (environment variables, AWS Parameter Store), no hardcoded config\n\n|NFR-MAINT-008\n|Versioning: API and events\n|Semantic versioning (v1, v2), backward compatibility for API changes, event schema evolution\n\n|===\n\n=== Usability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-USE-001\n|Feedback submission UX\n|Mobile App user receives immediate \"Feedback submitted\" confirmation (< 1 second), not blocked by async Case creation\n\n|NFR-USE-002\n|Push notification delivery\n|Customer receives \"Your feedback has been received\" notification within 30 seconds of Case creation in Salesforce\n\n|NFR-USE-003\n|Case resolution notification\n|Customer receives \"Your case has been resolved\" notification within 30 seconds of support agent resolving Case\n\n|NFR-USE-004\n|Error messaging\n|User-friendly error messages for failed feedback submission (not technical errors), retry prompts\n\n|NFR-USE-005\n|Accessibility\n|Mobile App feedback form meets WCAG 2.1 AA accessibility standards (existing Mobile App compliance)\n\n|===\n\n=== Compliance Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-COMP-001\n|GDPR compliance: PII data\n|Customer Contact data (email, phone, name) managed per GDPR retention policies (Salesforce governance)\n\n|NFR-COMP-002\n|GDPR compliance: Right to erasure\n|Support \"Delete Account\" feedback category, trigger Contact deletion in Salesforce per GDPR Article 17\n\n|NFR-COMP-003\n|Data residency\n|Salesforce data residency governed by Viva Energy Salesforce configuration (regional compliance)\n\n|NFR-COMP-004\n|Audit trail\n|All Contact creates/updates, Case creates/updates logged for compliance auditing (Salesforce audit logs)\n\n|NFR-COMP-005\n|API security standards\n|OWASP API Security Top 10 compliance (injection prevention, authentication, authorisation, data exposure)\n\n|===\n\n== Monitoring and Observability\n\n=== Key Metrics\n\n[width=\"100%\",cols=\"25%,40%,35%\",options=\"header\",]\n|===\n|Metric Category |Metric |Target/Threshold\n\n|*Feedback Submission*\n|Feedback submission success rate (Mobile App → EngagementService)\n|> 99.5%\n\n|*Async Case Creation*\n|Case creation success rate (EngagementService → Salesforce)\n|> 99%\n\n|*Async Case Creation*\n|Case creation latency (time from feedback submission to Case created in Salesforce)\n|p95 < 5 minutes\n\n|*Event Bus*\n|Event Bus queue depth (pending Case creations)\n|< 100 messages\n\n|*Event Bus*\n|Dead letter queue depth (failed Case creations)\n|= 0 (alert on any failures)\n\n|*Salesforce API*\n|Salesforce API error rate\n|< 1%\n\n|*Salesforce API*\n|Salesforce API latency (Case creation)\n|p95 < 2 seconds\n\n|*Salesforce API*\n|Salesforce API rate limit utilization\n|< 80% of limit\n\n|*ProfileService*\n|Contact reconciliation success rate (JIT lookups)\n|> 99.5%\n\n|*ProfileService*\n|Contact reconciliation latency\n|p95 < 500ms\n\n|*Braze Notifications*\n|Push notification delivery rate (Case created/updated)\n|> 95%\n\n|*Salesforce Webhook*\n|Webhook delivery success rate (Salesforce → EngagementService)\n|> 99%\n\n|*Customer Satisfaction*\n|Customer satisfaction score (CSAT)\n|> 4.0/5.0 (improve by 15% from D365 CE baseline)\n\n|*Support Operations*\n|Average case resolution time\n|Decrease by 20% from D365 CE baseline\n\n|===\n\n=== Alerting Thresholds\n\n[width=\"100%\",cols=\"25%,50%,25%\",options=\"header\",]\n|===\n|Alert |Condition |Severity\n\n|*Feedback submission failures*\n|Feedback submission success rate < 95% over 5-minute window\n|P1 - Critical\n\n|*Dead letter queue accumulation*\n|Dead letter queue depth > 0 (any failed Case creations)\n|P2 - High\n\n|*Event Bus queue backlog*\n|Event Bus queue depth > 100 messages for > 15 minutes\n|P2 - High\n\n|*Salesforce API errors*\n|Salesforce API error rate > 5% over 5-minute window\n|P1 - Critical\n\n|*Salesforce API rate limits*\n|Salesforce API rate limit utilization > 90%\n|P2 - High\n\n|*Contact reconciliation failures*\n|ProfileService Contact reconciliation failure rate > 5% over 5-minute window\n|P2 - High\n\n|*Braze notification failures*\n|Braze push notification delivery rate < 80% over 15-minute window\n|P3 - Medium\n\n|*Salesforce webhook failures*\n|Salesforce webhook delivery success rate < 90% over 15-minute window\n|P2 - High\n\n|*Case creation latency*\n|Case creation latency p95 > 10 minutes\n|P3 - Medium\n\n|===\n\n=== Dashboards\n\n*ProfileService Dashboard:*\n\n* Contact reconciliation success rate (JIT lookups)\n* Contact reconciliation latency (p50, p95, p99)\n* Contact creation vs update ratio (new Contacts created vs existing Contacts updated)\n* Salesforce API error rate (Contact queries and creates)\n* Request rate and throughput\n\n*EngagementService Dashboard:*\n\n* Feedback submission success rate\n* Case creation success rate (async workflow)\n* Case creation latency (p50, p95, p99)\n* Event Bus queue depth (pending Case creations)\n* Dead letter queue depth (failed Case creations)\n* Salesforce API error rate (Case creation)\n* Salesforce API latency\n* Salesforce API rate limit utilization\n* Braze push notification delivery rate\n* Salesforce webhook delivery success rate\n\n*Event Bus Dashboard:*\n\n* Queue depth (pending messages)\n* Throughput (messages published/consumed per minute)\n* Dead letter queue depth (failed messages)\n* Consumer lag (time between publish and consume)\n\n*Customer Support Dashboard (Business Metrics):*\n\n* Total feedback submissions per day/week/month\n* Feedback category breakdown (App, Service, Order, Rewards, Refund, Delete Account)\n* Customer satisfaction score (CSAT) trend\n* Average case resolution time trend\n* Case volume by support team/queue\n* Unified customer view adoption (support agent feedback)\n<<<\n== Solution Validation\n\nThis section defines the validation criteria and testing approach for the solution.\n\n=== Functional Validation\n\n==== ProfileService API Testing\n\n*Test Scenarios*:\n1. **Happy Path**: Authenticated user requests Contact ID, existing Contact found in Salesforce, Contact ID returned\n2. **JIT Creation**: Authenticated user requests Contact ID, no existing Contact, new Contact created in Salesforce, Contact ID returned\n3. **Salesforce API Failure**: Salesforce unavailable, ProfileService returns 500 error, user retries\n4. **Invalid JWT**: Unauthenticated request, ProfileService returns 401 error\n\n*Acceptance Criteria*:\n- Contact reconciliation success rate > 99.5%\n- JIT Contact creation completes within 500ms (p95)\n\n==== EngagementService API Testing\n\n*Test Scenarios*:\n1. **Happy Path**: Valid feedback submission, immediate 202 Accepted response, Case created in Salesforce within 5 minutes, Braze notification delivered\n2. **Invalid Category**: Invalid feedback category, 400 Bad Request response with validation error\n3. **Salesforce Downtime**: Salesforce unavailable during async Case creation, message queued, retry logic executes, Case created when Salesforce recovers\n4. **Dead Letter Queue**: Case creation fails after 5 retries, message moved to DLQ, ops team alerted\n5. **Webhook Notification**: Support agent resolves Case in Salesforce, webhook triggers EngagementService, Braze push notification sent to customer\n\n*Acceptance Criteria*:\n- Feedback submission success rate > 99.5% (including async Case creation)\n- Async Case creation completes within 5 minutes (p95)\n- Webhook delivery success rate > 99%\n\n=== Non-Functional Validation\n\n==== Performance Testing\n\n*Load Testing*:\n\n*Baseline*: Expected 100-150 submissions/day from 20k DAU (~0.5-0.75% submission rate)\n\n- **Normal Load**: 1 submission/minute sustained for 2 hours (simulate typical daily pattern)\n- **3x Load**: 3 submissions/minute sustained for 1 hour (simulate busy period, 450 submissions/day)\n- **Peak Load (10x)**: 10 submissions/minute for 15 minutes (simulate incident scenario, app outage causing backlog)\n- **Stress Test**: 50 submissions/minute for 5 minutes (find breaking point, 20x normal)\n\n*Validation*:\n- API response time p95 < 1 second under 10x load\n- Event Bus queue depth remains manageable (< 100 messages)\n- No Case creation failures, all submissions processed successfully\n- Auto-scaling triggers appropriately for sustained load > 3x baseline\n\n*Acceptance Criteria*:\n- NFR-PERF-001 through NFR-PERF-006 validated under realistic load (3x and 10x baseline)\n- Auto-scaling triggers within 2 minutes of load increase\n- System handles 10x peak gracefully, 20x stress test identifies limits\n\n==== Resilience Testing\n\n*Salesforce API Failure Scenarios*:\n1. **Complete Outage**: Salesforce unavailable for 2 hours, Event Bus queues buffer work, Cases created when Salesforce recovers\n2. **Rate Limit Exceeded**: Salesforce rate limit hit, queue throttling activates, Cases created within SLA\n\n*Acceptance Criteria*:\n- NFR-AVAIL-004 validated (graceful degradation during Salesforce downtime)\n- Circuit breaker activates after 5 consecutive failures\n\n==== Security Validation\n\n*Penetration Testing*:\n- API authentication bypass attempts\n- SQL injection attempts\n- Webhook signature validation bypass\n\n*Acceptance Criteria*:\n- NFR-SEC-001 through NFR-SEC-010 validated\n- OWASP API Security Top 10 compliance verified\n\n=== Integration Validation\n\n==== End-to-End Testing\n\n*Full User Journey*:\n1. User authenticates via Microsoft Entra External ID\n2. Mobile App requests Contact ID from ProfileService (JIT reconciliation)\n3. User submits feedback via EngagementService\n4. Background worker creates Case in Salesforce\n5. Braze notification delivered to user\n6. Support agent resolves Case in Salesforce\n7. Salesforce webhook triggers EngagementService\n8. Braze notification delivered to user\n\n*Acceptance Criteria*:\n- End-to-end flow completes successfully in UAT\n- User receives both \"feedback submitted\" and \"case resolved\" notifications\n","structuredPatch":[{"oldStart":1586,"oldLines":6,"newStart":1586,"newLines":7,"lines":[" * Integration tests pass in sandbox environment"," * API documentation generated from OpenAPI specification"," ","+[[wp-cs-002]]"," === WP-CS-002: EngagementService Development"," "," ==== Description"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"97bd92e9-4fe7-4821-8725-bbe5035b0268"}
{"parentUuid":"555f081d-5003-40a8-870a-d278039b28d2","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01YaSWH8PNdwJUKLCzWrQ7yS","type":"tool_result","content":"The file /mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n  1660→* Failed Case creation moves to Dead Letter Queue after 5 retry attempts\n  1661→* Unit test coverage > 80%\n  1662→* Integration tests pass with Salesforce sandbox and Braze staging environment\n  1663→\n  1664→[[wp-cs-003]]\n  1665→=== WP-CS-003: Event Bus Infrastructure\n  1666→\n  1667→==== Description\n  1668→\n  1669→Implement Event Bus infrastructure for domain event publishing using existing AWS infrastructure (SNS+SQS, EventBridge, or Kinesis).\n  1670→\n  1671→==== Deliverables"}]},"uuid":"8d1861a0-55d0-4a4b-ab20-6cc2c0cb659a","timestamp":"2026-01-09T03:10:44.866Z","toolUseResult":{"filePath":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","oldString":"=== WP-CS-003: Event Bus Infrastructure\n\n==== Description","newString":"[[wp-cs-003]]\n=== WP-CS-003: Event Bus Infrastructure\n\n==== Description","originalFile":"= Salesforce Customer Support - Solution Architecture\n:project-name: Salesforce Customer Support\n:togaf-adm-phase: Phase E: Opportunities & Solutions\n:last-updated: 2026-01-07\n:document-type: Solution Architecture Document\n:status: Discovery\n:version: 0.1\n:domain: Customer Support & Engagement\n:programme-lead:\n:domain-architect: O.Young@otr.com.au\n:architecture-definition: xref:architecture-definitions:salesforce_customer_support.adoc[Architecture Definitions/Salesforce Customer Support]\n:doctype: article\n:toc: left\n:toclevels: 4\n:sectanchors:\n:sectlinks:\n:sectnums:\n:icons: font\n:source-highlighter: highlightjs\n:experimental:\n:description:\n:keywords:\n\n<<<\n== Purpose and Scope\n\n=== Purpose\n\nThis Solution Architecture defines how the Salesforce Customer Support consolidation will be implemented - the specific technology products, configurations, interfaces, and deployment architecture that realise the xref:architecture-definitions:salesforce_customer_support.adoc[Salesforce Customer Support Architecture Definition].\n\nThis solution establishes the **first implementation of OTR's target Domain-Driven Design (DDD) architecture** by deploying two new bounded contexts (`ProfileService` and `EngagementService`) as microservices, consolidating customer support onto Salesforce Service Cloud, and implementing event-driven integration patterns that will serve as the foundation for future bounded contexts (including Flybuys integration).\n\n=== Vision\n\n> Unify customer support across all OTRG channels by consolidating OTR digital customer feedback onto Salesforce Service Cloud, establishing the foundational DDD architecture with ProfileService and EngagementService bounded contexts that protect digital channels from external system changes while enabling support agents to deliver exceptional customer experiences with complete interaction history.\n\n=== Architectural Approach\n\nThis architecture establishes OTR's **first bounded context implementation** using Domain-Driven Design strategic patterns:\n\n* *link:../bounded_context/profile.adoc[ProfileService]* (NEW bounded context): Just-In-Time Contact reconciliation with Salesforce, upsert by email, returns Salesforce Contact ID to digital channels - foundation for future Flybuys partner linking\n* *link:../bounded_context/engagement.adoc[EngagementService]* (NEW bounded context): Customer feedback submission facade, Anti-Corruption Layer for Salesforce Case creation, Braze integration for all outbound customer communications (push, email, SMS), async Case processing via Event Bus\n* *Event-driven integration* (NEW pattern): Domain event publishing using existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis) - first implementation establishing pattern for future bounded contexts\n* *Anti-Corruption Layer*: EngagementService isolates digital channels from Salesforce API changes, translates between OTR domain language and Salesforce Service Cloud API\n* *Conformist Pattern*: ProfileService and EngagementService conform to existing Salesforce configuration (shared Viva Energy instance, multi-tenant governance)\n* *Big bang cutover*: Single deployment after Contact migration, no phased rollout, D365 CE retirement post-cutover\n\n=== Scope\n\n==== In Scope\n\n* Solution Building Blocks (SBBs) - specific technology products and versions\n* Interface specifications (APIs, events, data formats)\n* Data architecture and schema specifications\n* Deployment architecture and infrastructure configuration\n* Transition architecture with migration phases\n* Technical validation criteria and testing approach\n* External system integration specifications\n* Physical data models and API schemas\n\n==== Out of Scope\n\n===== Covered in xref:architecture-definitions:salesforce_customer_support.adoc[Architecture Definition]\n\n* Business requirements and stakeholder analysis\n* Architecture decisions and rationale (ADRs)\n* Bounded context definitions and responsibilities\n* High-level integration patterns (ACL, Conformist, OHS+PL)\n* Business capability mapping and value streams\n* Architecture principles and governance\n\n===== Covered in Other Documents\n\n* Detailed design (class diagrams, sequence diagrams for all flows)\n* Implementation code and unit tests\n* Business case and return-on-investment analysis\n* Operational run books and support procedures\n\n<<<\n=== Architecture Overview\n\n[mermaid]\n----\n---\nconfig:\n  layout: elk\n---\nflowchart TB\n    Customer([\"Customer\"]) -- Uses --> MobileApp[\"Mobile App<br>iOS/Android\"]\n    Customer -- Shops at --> POS[\"OTR/OTR+ POS<br>D365 Commerce\"]\n    MobileApp -- Authenticate --> EntraID[\"Microsoft Entra\"]\n    MobileApp -- Identifies & Reconciles --> ProfileService[\"ProfileService\"]\n    ProfileService <-- Reconcile App User as Salesforce Contact --> Salesforce[\"Salesforce\"]\n    ProfileService -- On Create --> EventBus[\"EventBus\"]\n    EventBus -- Emits CreateUser Event --> LoyaltyService[\"LoyaltyService\"] & EngagementService[\"EngagementService\"]\n    LoyaltyService -- Reconcile Wallet --> EagleEye[\"EagleEye\"]\n    EngagementService -- Reconcile Braze Profile --> Braze[\"Braze\"]\n    EngagementService --> Salesforce\n    D365CE[\"D365CE\"] -- Data Migration --> Salesforce\n    MobileApp -- Submits Feedback --> EngagementService\n\n    Customer:::customer\n    MobileApp:::presentation\n    POS:::presentation\n    EntraID:::external\n    ProfileService:::newService\n    Salesforce:::external\n    EventBus:::infrastructure\n    LoyaltyService:::newService\n    EngagementService:::newService\n    EagleEye:::external\n    Braze:::external\n    D365CE:::external\n    classDef newService fill:#4CAF50,stroke:#2E7D32,stroke-width:3px,color:#fff\n    classDef external fill:#FF9800,stroke:#E65100,stroke-width:2px,color:#fff\n    classDef infrastructure fill:#2196F3,stroke:#0D47A1,stroke-width:2px,color:#fff\n    classDef presentation fill:#9C27B0,stroke:#4A148C,stroke-width:2px,color:#fff\n    classDef customer fill:#607D8B,stroke:#263238,stroke-width:2px,color:#fff\n----\n\n\n==== Key Architectural Patterns\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Pattern |Application |Rationale\n\n|*Anti-Corruption Layer (ACL)*\n|EngagementService → Salesforce Service Cloud\n|Protects digital channels (Mobile App, Web) from Salesforce API changes, translates between OTR domain language and Salesforce Case/Contact model, enables independent evolution of internal domain model\n\n|*Conformist*\n|ProfileService → Salesforce, EngagementService → Salesforce\n|Shared Viva Energy Salesforce instance - we conform to existing configuration, governance, and API contracts (external system we don't control)\n\n|*Backend-for-Frontend (BFF)*\n|EngagementService\n|Aggregates customer feedback submission, Contact lookup, async Case creation, and Braze notification orchestration for digital channel clients\n\n|*Event-Driven Architecture (OHS+PL)*\n|Event Bus (SNS+SQS/EventBridge/Kinesis)\n|Loose coupling between bounded contexts, async domain event publishing (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`), foundation for future bounded contexts\n\n|*Just-In-Time (JIT) Integration*\n|ProfileService → Salesforce Contact reconciliation\n|Reconcile app users as Salesforce Contacts on-demand (upsert by email), no pre-sync required, ensures Salesforce has current Contact data\n\n|*Async Processing*\n|EngagementService Case creation via Event Bus\n|Non-blocking user experience, resilience to Salesforce downtime, automatic retry with exponential backoff, dead letter queue for operations team intervention\n\n|*Strangler Fig*\n|Not applicable\n|Big bang cutover (no gradual migration) - D365 CE fully replaced, not incrementally strangled\n\n|===\n\n<<<\n== Solution Approach\n\n* Deploy xref:bounded-contexts:profile.adoc[ProfileService] and xref:bounded-contexts:engagement.adoc[EngagementService] as bounded context microservices\n* Implement Anti-Corruption Layers (ACLs) for Salesforce and Braze integration\n* Establish event-driven architecture as the foundational integration pattern\n* Big bang cutover (TS-1 → TS-4)\n\n=== Related Documentation\n\nThis solution architecture references detailed technical specifications:\n\n==== Architecture Definition\n\n* xref:architecture-definitions:salesforce_customer_support.adoc[Salesforce Customer Support - Architecture Definition] - Business requirements, architecture decisions (ADRs), bounded context definitions, high-level integration patterns\n\n==== Bounded Context Specifications\n\n* xref:bounded-contexts:profile.adoc[ProfileService Bounded Context] - JIT Contact reconciliation, aggregate definitions\n* xref:bounded-contexts:engagement.adoc[EngagementService Bounded Context] - Customer feedback facade, Anti-Corruption Layer\n\n==== Interface Specifications\n\nDetailed API specifications available in the specifications directory:\n\n* link:../../specifications/rest/profile-service-v1.yaml[ProfileService REST API v1] - OpenAPI 3.0 specification for `/profile/v1` endpoints (includes Salesforce Contact reconciliation `GET /contact-id`)\n* link:../../specifications/rest/engagement-service-v1.yaml[EngagementService REST API v1] - OpenAPI 3.0 specification for `/engagement/v1` endpoints (includes `POST /feedback`)\n* link:../../specifications/events/engagement-events.json[Engagement Domain Events] - CloudEvents 1.0 JSON Schema for `SupportCaseCreated`, `SupportCaseUpdated`, `SupportCaseResolved`, `CustomerFeedbackSubmitted`\n\n==== External System Documentation\n\n* https://developer.salesforce.com/docs/atlas.en-us.api_rest.meta/api_rest/[Salesforce REST API Documentation] - Contact and Case object APIs\n* https://www.braze.com/docs/api/endpoints/messaging/send_messages/post_send_triggered_campaigns/[Braze Campaign Trigger API] - Push notification campaigns\n\n<<<\n== Executive Summary\n\n=== Challenge\n\nOTR digital customers (Mobile App, Web) currently submit feedback and support requests to D365 Customer Engagement, while Viva Energy's broader business units (fuel wholesale, Shell Card customers, other retail channels) use Salesforce Service Cloud. This creates:\n\n* *Fragmented customer support platform*: Customer support data split across two systems, preventing support agents from having a unified view of customer interactions across all channels\n* *Operational inefficiency*: Maintaining two separate customer support platforms increases operational overhead and costs\n* *Poor support experience*: D365 CE is not working well for digital customer support, impacting customer satisfaction and case resolution times\n* *Post-merger consolidation opportunity*: Following Viva Energy's acquisition of OTR, strategic alignment on Salesforce as the enterprise customer support platform\n\n=== Solution\n\nThis architecture establishes the **foundational Domain-Driven Design (DDD) implementation** for OTR's target state architecture by introducing two new bounded contexts (link:../bounded_context/profile.adoc[ProfileService], link:../bounded_context/engagement.adoc[EngagementService]) and event-driven integration patterns:\n\n==== New Bounded Contexts\n\n* *link:../bounded_context/profile.adoc[ProfileService]* (NEW): Just-In-Time (JIT) Contact reconciliation with Salesforce, upsert by email, returns Salesforce Contact ID to Mobile App\n* *link:../bounded_context/engagement.adoc[EngagementService]* (NEW): Customer feedback submission, Anti-Corruption Layer (ACL) for Salesforce Case creation, Braze integration for all outbound customer communications (push, email, SMS), async Case processing via Event Bus\n* *Event Bus* (NEW pattern): Domain event publishing using existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis) - first implementation of event-driven architecture pattern\n\n==== Integration Architecture\n\n* *Salesforce = System of Record*: Salesforce Service Cloud (shared Viva Energy instance) owns Contact and Case data\n* *Conformist Pattern*: ProfileService and EngagementService conform to existing Salesforce configuration and API contracts\n* *Anti-Corruption Layer*: EngagementService protects digital channels from Salesforce API changes, translates between OTR domain language and Salesforce\n* *Async Case Creation*: Non-blocking user experience, resilience to Salesforce downtime, automatic retry with exponential backoff, dead letter queue for failed Cases\n* *Event-Driven Notifications*: Salesforce webhook → EngagementService → Braze for all customer communications (push, email, SMS) on Case status updates\n\n==== Migration Approach\n\n* *Contact Migration*: One-time migration from app-specific database → Salesforce (upsert with flexible matching by email/phone/VCI)\n* *No Case Migration*: Historical D365 CE Cases not migrated (fresh start in Salesforce)\n* *Big Bang Cutover*: Single deployment, no phased rollout or parallel run\n* *D365 CE Retirement*: Complete decommissioning of D365 Customer Engagement post-cutover\n\n=== Key Architectural Significance\n\nThis migration establishes the first implementation of OTR's target DDD architecture:\n\n* First bounded contexts implemented (ProfileService, EngagementService)\n* First event-driven domain event pattern (foundation for future bounded contexts)\n* Foundation for Flybuys integration (ProfileService Contact reconciliation reused)\n* Establishes integration patterns (Conformist, ACL, Event-Driven) for future services\n\n=== Success Criteria\n\n* All digital customer feedback routed to Salesforce Service Cloud within 30 days of launch\n* Support agents have unified customer view across all Viva Energy channels (digital, wholesale, Shell Card, other retail)\n* D365 Customer Engagement decommissioned within 90 days post-cutover\n* Customer satisfaction score improves by 15% within 6 months\n* Average case resolution time decreases by 20% within 6 months\n* Zero data loss during Contact migration (100% validation pass rate)\n* Mobile App feedback submission success rate > 99.5% (including async Case creation)\n\n=== Technical Constraints\n\n* Shared Salesforce instance (Viva Energy multi-tenant environment)\n* Conform to existing Salesforce configuration and governance (data isolation strategy TBD with Salesforce admin team)\n* Contact migration must complete before cutover (no parallel run)\n* Async Case creation mandatory (non-blocking user experience)\n* Expected volume: 100-150 feedback submissions/day from 20k DAU (~0.5-0.75% submission rate), architecture capacity planned for 3x-10x growth\n\n=== Open Technical Decisions (TBD)\n\n* Salesforce Case field mapping for digital feedback categories (App, Service, Order, Rewards, Refund, Delete Account)\n* Salesforce data isolation strategy (Record Types, custom fields, queues)\n* Salesforce REST API authentication method (OAuth 2.0, Connected App, JWT bearer flow)\n* Salesforce webhook mechanism for Case updates (Outbound Messages, Platform Events, Process Builder)\n* Retry policy configuration (attempts, backoff intervals)\n* Salesforce API rate limit strategy (expected volume: 100-150 submissions/day from 20k DAU, capacity planning for 3x-10x growth)\n\n== Technical Requirements\n\n[width=\"100%\",cols=\"8%,92%\",options=\"header\",]\n|===\n|ID |Description\n\n|TR-CS-001\n|Every Mobile App user must have a Salesforce Contact record in Salesforce Service Cloud (shared Viva Energy instance)\n\n|TR-CS-002\n|ProfileService must reconcile Mobile App users as Salesforce Contacts using Just-In-Time (JIT) upsert by email address\n\n|TR-CS-003\n|ProfileService must return Salesforce Contact ID to Mobile App for feedback submission\n\n|TR-CS-004\n|Mobile App must support customer feedback submission with fields: Category (App, Service, Order, Rewards, Refund, Delete Account), Store Name, Time of Visit, Contact Phone Number, Free Text Message\n\n|TR-CS-005\n|EngagementService must create Salesforce Cases asynchronously via Event Bus (non-blocking user experience)\n\n|TR-CS-006\n|EngagementService must acknowledge feedback submission immediately to Mobile App user (\"Feedback submitted\" confirmation)\n\n|TR-CS-007\n|EngagementService must send push notification to customer via Braze when Case is successfully created in Salesforce\n\n|TR-CS-008\n|EngagementService must retry failed Case creation with configurable exponential backoff and dead letter queue for operations team intervention\n\n|TR-CS-009\n|Salesforce must be the System of Record for Contact and Case data (no local persistence in ProfileService or EngagementService)\n\n|TR-CS-010\n|Contact migration from app-specific database to Salesforce must complete before Mobile App cutover (upsert with flexible matching by email/phone/VCI)\n\n|TR-CS-011\n|No Case migration from D365 Customer Engagement to Salesforce (fresh start, historical Cases not migrated)\n\n|TR-CS-012\n|EngagementService must publish domain events (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`) to Event Bus for consumption by other bounded contexts\n\n|TR-CS-013\n|EngagementService must receive Salesforce webhook notifications when Cases are updated/resolved by support agents\n\n|TR-CS-014\n|EngagementService must trigger Braze push notifications to customers when Cases are updated/resolved (via Salesforce webhook → EngagementService → Braze)\n\n|TR-CS-015\n|ProfileService and EngagementService must conform to existing Salesforce configuration and API contracts (Conformist pattern)\n\n|TR-CS-016\n|All changes must be communicated using event-driven architecture via Event Bus (using existing AWS infrastructure: SNS+SQS/EventBridge/Kinesis)\n\n|TR-CS-017\n|Mobile App feedback submission success rate must exceed 99.5% (including async Case creation completion)\n\n|TR-CS-018\n|Contact migration must achieve 100% validation pass rate (zero data loss)\n\n|TR-CS-019\n|D365 Customer Engagement must be fully decommissioned within 90 days post-cutover\n\n|===\n\n== Technical Architecture\n\n=== Technical Capability Requirements\n\n==== Requirements Traceability\n\n[width=\"100%\",cols=\"15%,50%,35%\",options=\"header\",]\n|===\n|Requirement ID |Requirement Summary |Architectural Building Blocks\n\n|TR-CS-001\n|Every Mobile App user must have Salesforce Contact record\n|ABB-CS-001 (ProfileService), ABB-CS-004 (Salesforce), ABB-CS-007 (Contact Migration Tool)\n\n|TR-CS-002\n|ProfileService JIT Contact reconciliation via upsert by email\n|ABB-CS-001 (ProfileService), ABB-CS-004 (Salesforce)\n\n|TR-CS-003\n|ProfileService returns Salesforce Contact ID to Mobile App\n|ABB-CS-001 (ProfileService), ABB-CS-006 (Mobile App)\n\n|TR-CS-004\n|Mobile App supports feedback submission with structured fields\n|ABB-CS-006 (Mobile App), ABB-CS-002 (EngagementService)\n\n|TR-CS-005\n|EngagementService creates Salesforce Cases asynchronously\n|ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus), ABB-CS-004 (Salesforce)\n\n|TR-CS-006\n|EngagementService immediate acknowledgment to Mobile App\n|ABB-CS-002 (EngagementService), ABB-CS-006 (Mobile App)\n\n|TR-CS-007\n|EngagementService sends push notification via Braze on Case creation\n|ABB-CS-002 (EngagementService), ABB-CS-005 (Braze)\n\n|TR-CS-008\n|EngagementService retry logic with exponential backoff and DLQ\n|ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus)\n\n|TR-CS-009\n|Salesforce is System of Record for Contact and Case data\n|ABB-CS-004 (Salesforce), ABB-CS-001 (ProfileService - stateless), ABB-CS-002 (EngagementService - stateless)\n\n|TR-CS-010\n|Contact migration before Mobile App cutover\n|ABB-CS-007 (Contact Migration Tool), ABB-CS-004 (Salesforce)\n\n|TR-CS-011\n|No Case migration from D365 CE (fresh start)\n|ABB-CS-004 (Salesforce) - no migration tooling required\n\n|TR-CS-012\n|EngagementService publishes domain events to Event Bus\n|ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus)\n\n|TR-CS-013\n|EngagementService receives Salesforce webhook notifications\n|ABB-CS-002 (EngagementService), ABB-CS-004 (Salesforce)\n\n|TR-CS-014\n|EngagementService triggers Braze notifications on Case updates\n|ABB-CS-002 (EngagementService), ABB-CS-004 (Salesforce), ABB-CS-005 (Braze)\n\n|TR-CS-015\n|ProfileService and EngagementService conform to Salesforce config\n|ABB-CS-001 (ProfileService), ABB-CS-002 (EngagementService), ABB-CS-004 (Salesforce)\n\n|TR-CS-016\n|Event-driven architecture via Event Bus\n|ABB-CS-003 (Event Bus), ABB-CS-002 (EngagementService)\n\n|TR-CS-017\n|Mobile App feedback submission success rate > 99.5%\n|ABB-CS-006 (Mobile App), ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus), ABB-CS-004 (Salesforce)\n\n|TR-CS-018\n|Contact migration 100% validation pass rate\n|ABB-CS-007 (Contact Migration Tool), ABB-CS-004 (Salesforce)\n\n|TR-CS-019\n|D365 CE decommissioned within 90 days post-cutover\n|All ABBs (replacement system operational)\n\n|===\n\n=== Service Catalogues\n\n==== Application Portfolio Catalogue\n\n[width=\"100%\",cols=\"20%,15%,15%,15%,35%\",options=\"header\",]\n|===\n|Application |Lifecycle State |Owner |Hosting Platform |Description\n\n|*ProfileService*\n|NEW\n|OTR Platform Team\n|AWS (TBD: Lambda/ECS/EKS)\n|JIT Contact reconciliation with Salesforce, returns Salesforce Contact ID, foundation for Flybuys integration\n\n|*EngagementService*\n|NEW\n|OTR Platform Team\n|AWS (TBD: Lambda/ECS/EKS)\n|Customer feedback submission facade, ACL for Salesforce Case creation, Braze integration for all outbound communications (push, email, SMS), webhook receiver\n\n|*Mobile App (iOS)*\n|ACTIVE (UPDATE)\n|OTR Mobile Team\n|Apple App Store\n|iOS native app with feedback form, integrate with ProfileService and EngagementService APIs\n\n|*Mobile App (Android)*\n|ACTIVE (UPDATE)\n|OTR Mobile Team\n|Google Play Store\n|Android native app with feedback form, integrate with ProfileService and EngagementService APIs\n\n|*Salesforce Service Cloud*\n|ACTIVE (EXPAND)\n|Viva Energy Salesforce Admin Team\n|Salesforce (SaaS)\n|Shared Viva Energy instance, System of Record for Contact and Case data, adding OTR digital customer support\n\n|*Braze*\n|ACTIVE (EXTEND)\n|OTR Marketing Team\n|Braze (SaaS)\n|Marketing automation platform, EngagementService triggers push notifications for Case updates\n\n|*D365 Customer Engagement*\n|RETIRE\n|OTR Support Team\n|Microsoft Azure (SaaS)\n|Legacy customer support platform, decommissioned within 90 days post-cutover\n\n|*App-Specific Customer Database*\n|RETIRE\n|OTR Platform Team\n|AWS (RDS/DynamoDB)\n|Legacy customer contact storage, one-time migration to Salesforce, then deprecated\n\n|*Event Bus*\n|NEW\n|OTR Platform Team\n|AWS (SNS+SQS/EventBridge/Kinesis)\n|Domain event publishing infrastructure for bounded context integration\n\n|*Contact Migration Tool*\n|TEMPORARY\n|OTR Platform Team\n|AWS (Script/Lambda)\n|One-time migration app database → Salesforce with upsert logic, retired after migration complete\n\n|===\n\n==== Technology Capability Requirements\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Technology Capability |Implementation Technology (TBD in detailed design) |Requirements\n\n|*Microservice Hosting*\n|AWS Lambda / ECS / EKS\n|Host ProfileService and EngagementService with auto-scaling, high availability, monitoring\n\n|*API Gateway*\n|AWS API Gateway / Application Load Balancer\n|REST API routing, authentication, rate limiting, request validation for ProfileService and EngagementService\n\n|*Event Bus*\n|AWS SNS+SQS / EventBridge / Kinesis\n|Domain event publishing, async message processing, retry logic, dead letter queue\n\n|*Salesforce Integration*\n|Salesforce REST API / SOAP API\n|Contact CRUD operations, Case creation, webhook notifications, OAuth 2.0 authentication\n\n|*Braze Integration*\n|Braze REST API / SDK\n|Push notification campaign triggers, customer profile reconciliation\n\n|*Authentication & Authorisation*\n|Microsoft Entra External ID / AWS Cognito\n|Mobile App user authentication, API authorisation, JWT token validation\n\n|*Observability & Monitoring*\n|AWS CloudWatch / Datadog / New Relic\n|Application metrics, logs, traces, dashboards, alerting (feedback submission rate, queue depth, API errors)\n\n|*Secret Management*\n|AWS Secrets Manager / Parameter Store\n|Salesforce credentials, Braze API keys, OAuth tokens, encryption keys\n\n|*Database (Migration Tool)*\n|AWS RDS / DynamoDB (read-only access)\n|Contact migration from app-specific database\n\n|*CI/CD Pipeline*\n|GitHub Actions / AWS CodePipeline\n|Automated build, test, deployment for ProfileService, EngagementService, Mobile App\n\n|*Infrastructure as Code*\n|Terraform / AWS CloudFormation / CDK\n|Declarative infrastructure provisioning for Event Bus, microservices, monitoring\n\n|*API Documentation*\n|OpenAPI / Swagger\n|ProfileService and EngagementService API specifications for Mobile App integration\n\n|===\n\n==== Feature Flag Register\n\n*Note*: Per ADR-CS-006 (big bang cutover, not phased rollout), feature flags are minimal and used primarily for emergency rollback/kill switches.\n\n[width=\"100%\",cols=\"20%,15%,35%,30%\",options=\"header\",]\n|===\n|Feature Flag |Default State |Purpose |Rollback Scenario\n\n|*enable_salesforce_feedback_submission*\n|OFF (pre-cutover), ON (post-cutover)\n|Enable/disable feedback submission to EngagementService → Salesforce (kill switch for emergency rollback to D365 CE)\n|Feedback submission success rate < 95%, Salesforce API failures, critical bugs - revert to D365 CE integration\n\n|*enable_async_case_creation*\n|ON\n|Enable/disable async Case creation via Event Bus (fallback to synchronous processing if Event Bus issues)\n|Event Bus infrastructure failures, queue backlog unmanageable - temporary synchronous processing\n\n|*enable_braze_notifications*\n|ON\n|Enable/disable Braze push notifications for Case updates (degrade gracefully if Braze integration fails)\n|Braze API failures, notification delivery rate < 80% - disable notifications temporarily\n\n|*enable_jit_contact_reconciliation*\n|ON\n|Enable/disable ProfileService JIT Contact reconciliation (fallback to cached Contact IDs if Salesforce unavailable)\n|Salesforce API downtime, Contact reconciliation failures > 5% - use cached Contact IDs temporarily\n\n|*enable_salesforce_webhook_processing*\n|ON\n|Enable/disable Salesforce webhook processing for Case updates (fallback to polling if webhook failures)\n|Webhook delivery failures, authentication issues - temporary polling fallback\n\n|===\n\n*Feature Flag Management*:\n\n* Feature flags managed via AWS AppConfig / LaunchDarkly / custom feature flag service (TBD in detailed design)\n* Mobile App feature flags controlled server-side (no app release required for flag changes)\n* Backend service feature flags configured via environment variables / configuration service\n* Feature flag changes logged and audited (who changed, when, reason)\n* Post-cutover monitoring: Gradual removal of feature flags once system stability confirmed (30-60 days)\n\n==== Data Entity Catalogue\n\n[width=\"100%\",cols=\"20%,15%,35%,30%\",options=\"header\",]\n|===\n|Data Entity |System of Record |Key Attributes |Lifecycle\n\n|*Contact*\n|Salesforce Service Cloud\n|• Contact ID (Salesforce 15/18-char ID) +\n• Email (primary matching key) +\n• First Name, Last Name +\n• Phone Number +\n• Viva Consumer ID (VCI) +\n• Account (Viva Energy customer account) +\n• Record Type (OTR Digital vs other channels)\n|Created: ProfileService JIT reconciliation or Contact Migration Tool +\nUpdated: ProfileService JIT upsert (email changes), Salesforce (manual updates by support agents) +\nDeleted: Salesforce retention policy (GDPR/compliance)\n\n|*Case*\n|Salesforce Service Cloud\n|• Case Number (Salesforce auto-generated) +\n• Contact ID (reference to Contact) +\n• Subject (derived from Category) +\n• Description (Free Text Message) +\n• Category (App, Service, Order, Rewards, Refund, Delete Account) +\n• Store Name (OTR location) +\n• Time of Visit +\n• Status (New, In Progress, Resolved, Closed) +\n• Priority, Origin (Mobile App) +\n• Owner (support agent/queue)\n|Created: EngagementService async Case creation +\nUpdated: Support agents (Salesforce UI), EngagementService (webhook processing) +\nDeleted: Salesforce retention policy (archive after X years)\n\n|*Feedback Submission (transient)*\n|None (not persisted)\n|• Salesforce Contact ID +\n• Category +\n• Store Name +\n• Time of Visit +\n• Contact Phone Number +\n• Free Text Message\n|Created: Mobile App user submission +\nProcessed: EngagementService publishes to Event Bus, Case created in Salesforce +\nNot persisted in ProfileService/EngagementService (stateless)\n\n|*Domain Events*\n|Event Bus (ephemeral)\n|**SupportCaseCreated**: +\n• Case Number, Contact ID, Category, Timestamp +\n**SupportCaseUpdated**: +\n• Case Number, Status, Updated By, Timestamp +\n**SupportCaseResolved**: +\n• Case Number, Resolution, Resolved By, Timestamp +\n**CustomerFeedbackSubmitted**: +\n• Contact ID, Category, Timestamp\n|Published: EngagementService +\nConsumed: Other bounded contexts (future), Braze notification triggers +\nRetention: Short-lived (minutes to hours), not persisted for event sourcing\n\n|*Braze Customer Profile*\n|Braze\n|• External User ID (VCI or Email) +\n• Push Notification Tokens (iOS/Android) +\n• Notification Preferences +\n• Campaign Engagement History\n|Created/Updated: EngagementService on Case creation/update +\nManaged: Braze (external SaaS)\n\n|===\n\n*Data Migration Entities*:\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Source Entity |Target Entity |Migration Strategy\n\n|*App Database Contact*\n|Salesforce Contact\n|One-time migration via Contact Migration Tool: +\n• Upsert by email (primary), phone (secondary), VCI (tertiary) +\n• Map: Email → Email, Name → First/Last Name, Phone → Phone, VCI → External ID +\n• Validation: 100% data integrity check, reconciliation report\n\n|*D365 CE Case*\n|Not migrated\n|ADR-CS-005: No Case migration (fresh start in Salesforce) +\nD365 CE Cases archived separately for compliance if needed\n\n|===\n\n==== Data Quality & Validation\n\n*Contact Migration Validation Rules*:\n\n* Email format validation (RFC 5322 compliance)\n* Phone number format validation (E.164 international format)\n* VCI format validation (alphanumeric, length constraints)\n* Duplicate detection: Flag potential duplicates for manual review (same email/phone combination)\n* Mandatory fields: Email (required), First Name, Last Name (required for Salesforce Contact)\n\n*Case Creation Validation Rules*:\n\n* Contact ID must exist in Salesforce (validated by EngagementService before Case creation)\n* Category must be one of: App, Service, Order, Rewards, Refund, Delete Account\n* Free Text Message maximum length: 32,000 characters (Salesforce Case Description limit)\n* Store Name validated against OTR location master data (optional - warn if not found)\n\n<<<\n== Solution Building Blocks\n\nThis section defines the specific technology products, configurations, and implementation details for each Solution Building Block (SBB).\n\n=== Technology Portfolio Catalogue\n\n[width=\"100%\",cols=\"10%,20%,25%,25%,20%\",options=\"header\",]\n|===\n|SBB ID |Component |Technology Product |Version/Configuration |Deployment Platform\n\n|SBB-CS-001\n|ProfileService Microservice\n|.NET 8 / Node.js 20 LTS\n|RESTful API, containerised\n|AWS ECS Fargate / Lambda\n\n|SBB-CS-002\n|EngagementService Microservice\n|.NET 8 / Node.js 20 LTS\n|RESTful API, containerised, async workers\n|AWS ECS Fargate / Lambda\n\n|SBB-CS-003\n|Event Bus\n|AWS SNS + SQS / EventBridge\n|Standard queues, FIFO for ordering\n|AWS (managed service)\n\n|SBB-CS-004\n|API Gateway\n|AWS API Gateway / ALB\n|REST API, JWT validation\n|AWS (managed service)\n\n|SBB-CS-005\n|Salesforce Integration Layer\n|Salesforce REST API Client\n|OAuth 2.0 JWT bearer flow\n|Embedded in SBB-CS-001/002\n\n|SBB-CS-006\n|Braze Integration Layer\n|Braze REST API SDK\n|API key authentication\n|Embedded in SBB-CS-002\n\n|SBB-CS-007\n|Contact Migration Tool\n|Python 3.11 / .NET 8\n|One-time batch script\n|AWS Lambda / EC2\n\n|SBB-CS-008\n|Application Monitoring\n|AWS CloudWatch / Datadog\n|Metrics, logs, traces, dashboards\n|AWS / SaaS\n\n|SBB-CS-009\n|Secret Management\n|AWS Secrets Manager\n|KMS encryption\n|AWS (managed service)\n\n|SBB-CS-010\n|Mobile App (iOS)\n|SwiftUI, Kotlin Multiplatform\n|iOS 15+\n|Apple App Store\n\n|SBB-CS-011\n|Mobile App (Android)\n|Jetpack Compose, Kotlin Multiplatform\n|Android 8+\n|Google Play Store\n\n|SBB-CS-012\n|Feature Flag Service\n|AWS AppConfig / LaunchDarkly\n|Server-side flags, real-time updates\n|AWS / SaaS\n\n|===\n\n<<<\n== Data Architecture\n\nThis section defines the physical data models, event schemas, and API request/response formats.\n\n=== Domain Event Schemas\n\nAll domain events follow the https://cloudevents.io/[CloudEvents 1.0] specification for consistency and interoperability.\n\n*Event Schema Specifications*: See // TODO: Add to Antora - specifications/events/engagement-events.json[Engagement Service Event Schemas] for complete JSON schemas and examples.\n\n==== Event Catalogue\n\n[width=\"100%\",cols=\"30%,20%,50%\",options=\"header\",]\n|===\n|Event Type |Publisher |Description\n\n|`SupportCaseCreated`\n|EngagementService\n|Published when EngagementService successfully creates a Case in Salesforce after async processing\n\n|`SupportCaseUpdated`\n|EngagementService (via Salesforce webhook)\n|Published when a support agent updates a Case in Salesforce (status, priority, comment changes)\n\n|`SupportCaseResolved`\n|EngagementService (via Salesforce webhook)\n|Published when a support agent resolves/closes a Case in Salesforce\n\n|`CustomerFeedbackSubmitted`\n|EngagementService\n|Published when customer submits feedback via Mobile App (before async Case creation)\n\n|===\n\n*Event Format*: All events use CloudEvents 1.0 envelope with event-specific payload in the `data` field.\n\n*Schema Location*: `specifications/events/engagement-events.json`\n\n=== API Request/Response Schemas\n\n==== ProfileService: GET /profile/contact-id\n\n*Response* (200 OK):\n[source,json]\n----\n{\n  \"contactId\": \"0034X00000ABCDEFG\",\n  \"email\": \"customer@example.com\",\n  \"firstName\": \"John\",\n  \"lastName\": \"Smith\"\n}\n----\n\n==== EngagementService: POST /feedback\n\n*Request*:\n[source,json]\n----\n{\n  \"contactId\": \"0034X00000ABCDEFG\",\n  \"category\": \"App\",\n  \"storeName\": \"OTR Adelaide\",\n  \"timeOfVisit\": \"2026-01-07T12:00:00Z\",\n  \"contactPhoneNumber\": \"+61412345678\",\n  \"message\": \"App crashed when submitting feedback\"\n}\n----\n\n*Response* (202 Accepted):\n[source,json]\n----\n{\n  \"feedbackId\": \"fb-2026-01-07-12345\",\n  \"status\": \"submitted\",\n  \"message\": \"Your feedback has been submitted!\"\n}\n----\n\n=== Salesforce Field Mappings\n\n==== Case Object Mapping\n\n[width=\"100%\",cols=\"25%,25%,25%,25%\",options=\"header\",]\n|===\n|OTR Field |Salesforce Field |Data Type |Notes\n\n|Category\n|Feedback_Category__c\n|Picklist\n|App, Service, Order, Rewards, Refund, Delete Account\n\n|Store Name\n|Store_Name__c\n|String (255)\n|OTR location name\n\n|Time of Visit\n|Time_of_Visit__c\n|DateTime\n|When customer visited store\n\n|Free Text Message\n|Description\n|Long Text (32,000)\n|Customer feedback message\n\n|===\n\n<<<\n=== Baseline Architecture\n\n==== Existing System Components\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Component |Current State |Status\n\n|*D365 Customer Engagement*\n|Customer support platform for OTR digital customers (Mobile App, Web), handles feedback submission and case management\n|**DEPRECATED** - Being replaced by Salesforce Service Cloud\n\n|*App-Specific Customer Database*\n|Stores customer contact data for Mobile App users, separate from Viva Energy systems\n|**MIGRATING** - One-time migration to Salesforce, then deprecated\n\n|*Mobile App*\n|iOS/Android native apps with feedback submission form including Category, Store Name, Time of Visit, Contact Phone Number, and Free Text Message fields\n|**REQUIRES UPDATE** - Integrate with ProfileService and EngagementService APIs (feedback form UI already complete)\n\n|*Salesforce Service Cloud*\n|Shared Viva Energy instance handling customer support for fuel wholesale, Shell Card customers, other retail channels\n|**EXPANDING** - Adding OTR digital customer support Cases and Contacts\n\n|*Existing AWS Infrastructure*\n|SNS+SQS / EventBridge / Kinesis available for event-driven architecture\n|**REUSING** - Event Bus implementation leverages existing infrastructure\n\n|===\n\n==== Integration Architecture\n\n*Current state:*\n\n* Mobile App → D365 Customer Engagement (direct integration)\n* App-specific customer database → standalone (no Salesforce integration)\n* No event-driven architecture (synchronous, tightly coupled)\n* No Anti-Corruption Layer protecting digital channels\n* Viva Energy support teams use Salesforce, OTR digital support uses D365 CE (fragmented)\n\n==== Technical Debt\n\n*No longer relevant* - D365 CE being deprecated, not documenting technical debt of system being retired.\n\n*New technical debt introduced by this migration:*\n\n* Salesforce field mapping TBD (requires coordination with Viva Energy Salesforce admin team)\n* Data isolation strategy TBD (Record Types, custom fields, queues - multi-tenant governance)\n* Salesforce webhook mechanism TBD (Outbound Messages vs Platform Events vs Process Builder)\n* Expected feedback volume unknown (gathering data for rate limit planning)\n\n=== Gap Analysis\n\n==== Missing Capabilities\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Missing Capability |Description\n\n|*ProfileService bounded context*\n|No existing service for Contact reconciliation with Salesforce - requires new microservice implementing JIT upsert by email, returning Salesforce Contact ID\n\n|*EngagementService bounded context*\n|No existing service for customer feedback facade - requires new microservice implementing Anti-Corruption Layer for Salesforce Case creation, Braze integration, async processing via Event Bus\n\n|*Event Bus domain event pattern*\n|No existing domain event publishing infrastructure - requires implementing event-driven architecture pattern using existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis)\n\n|*Async Case creation workflow*\n|Current D365 CE integration is synchronous - requires implementing async processing with retry logic, exponential backoff, dead letter queue\n\n|*Salesforce webhook integration*\n|No existing capability to receive Salesforce notifications - requires implementing webhook receiver in EngagementService for Case update notifications\n\n|*Braze push notification orchestration*\n|No existing integration for Case-related push notifications - requires implementing Braze campaign triggers from EngagementService\n\n|*Contact migration tooling*\n|No existing tooling for app database → Salesforce Contact migration with upsert logic (match by email/phone/VCI)\n\n|*Feedback form enhancements*\n|Mobile App feedback form lacks structured fields (Category, Store Name, Time of Visit, Contact Phone Number) - requires UI updates\n\n|===\n\n==== Missing Bounded Contexts\n\n[width=\"100%\",cols=\"30%,30%,40%\",options=\"header\",]\n|===\n|Bounded Context |Responsibilities |Implementation Status\n\n|*link:../bounded_context/profile.adoc[ProfileService]*\n|JIT Contact reconciliation with Salesforce (upsert by email), return Salesforce Contact ID to digital channels, foundation for future Flybuys partner linking\n|**NEW** - First bounded context implementation\n\n|*link:../bounded_context/engagement.adoc[EngagementService]*\n|Customer feedback submission facade, Anti-Corruption Layer for Salesforce Case creation, Braze integration for push notifications, async Case processing, webhook receiver for Case updates\n|**NEW** - First bounded context implementation\n\n|===\n\n==== Missing Integration Patterns\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Integration Pattern |Description\n\n|*Anti-Corruption Layer (ACL)*\n|EngagementService → Salesforce Service Cloud - protects digital channels from Salesforce API changes, translates between OTR domain language and Salesforce\n\n|*Conformist*\n|ProfileService/EngagementService → Salesforce - conform to existing Salesforce configuration and API contracts (shared Viva Energy instance)\n\n|*Event-Driven Architecture (OHS+PL)*\n|Event Bus publishing domain events (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`) for loose coupling between bounded contexts\n\n|*Just-In-Time (JIT) Integration*\n|ProfileService → Salesforce Contact reconciliation on-demand (no pre-sync)\n\n|*Async Processing*\n|EngagementService Case creation via Event Bus with retry, exponential backoff, dead letter queue\n\n|===\n\n=== Target State Architecture\n\n==== Architectural Building Blocks (ABB)\n\n[width=\"100%\",cols=\"20%,25%,30%,25%\",options=\"header\",]\n|===\n|ABB ID |Bounded Context |Responsibilities |Technology (TBD in Solution Architecture)\n\n|ABB-CS-001\n|*link:../bounded_context/profile.adoc[ProfileService]*\n|JIT Contact reconciliation with Salesforce (upsert by email), return Salesforce Contact ID, foundation for Flybuys partner linking\n|Microservice (.NET/Node.js), REST API, Salesforce REST API client\n\n|ABB-CS-002\n|*link:../bounded_context/engagement.adoc[EngagementService]*\n|Customer feedback submission facade, ACL for Salesforce Case creation, Braze integration, async processing, webhook receiver\n|Microservice (.NET/Node.js), REST API, Event Bus publisher/subscriber, Salesforce webhook receiver\n\n|ABB-CS-003\n|*Event Bus*\n|Domain event publishing infrastructure (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`)\n|AWS SNS+SQS / EventBridge / Kinesis\n\n|ABB-CS-004\n|*Salesforce Service Cloud*\n|System of Record for Contact and Case data (shared Viva Energy instance)\n|Salesforce Service Cloud (external SaaS)\n\n|ABB-CS-005\n|*Braze*\n|Marketing automation platform for push notifications\n|Braze (external SaaS) - existing integration\n\n|ABB-CS-006\n|*Mobile App*\n|iOS/Android native apps with enhanced feedback form (Category, Store Name, Time of Visit, Contact Phone Number, Free Text Message)\n|Kotlin Multiplatform, SwiftUI, Jetpack Compose\n\n|ABB-CS-007\n|*Contact Migration Tool*\n|One-time migration app database → Salesforce with upsert logic (match by email/phone/VCI)\n|Script/tool (.NET/Python/Node.js)\n\n|===\n\n==== Integration Architecture\n\n===== Integration Flows\n\n*Customer Feedback Submission (Async):*\n\n1. *Mobile App* → ProfileService: Authenticate user, get Salesforce Contact ID (JIT reconciliation)\n2. *Mobile App* → EngagementService: Submit feedback (POST /feedback with Contact ID, Category, Store Name, Time of Visit, Phone, Message)\n3. *EngagementService* → Mobile App: Immediate acknowledgment (\"Feedback submitted\")\n4. *EngagementService* → Event Bus: Publish work item for async Case creation\n5. *Background Worker* (EngagementService) → Salesforce: Create Case via REST API\n6. *Success*: EngagementService → Event Bus: Publish `SupportCaseCreated` event\n7. *EngagementService* → Braze: Trigger push notification campaign (\"Your feedback has been received, Case #12345\")\n8. *Failure*: Retry with exponential backoff → Dead Letter Queue → Ops team alert\n\n*Case Update Notification (Bidirectional):*\n\n1. *Support Agent* updates/resolves Case in Salesforce\n2. *Salesforce* → EngagementService: Webhook notification (Case updated)\n3. *EngagementService* → Event Bus: Publish `SupportCaseUpdated` or `SupportCaseResolved` event\n4. *EngagementService* → Braze: Trigger push notification campaign (\"Your case has been resolved\")\n\n*Contact Reconciliation (JIT):*\n\n1. *Mobile App user* authenticates\n2. *Mobile App* → ProfileService: GET /profile/contact-id\n3. *ProfileService* → Salesforce: Query Contact by email\n4. *Match found*: Return existing Salesforce Contact ID\n5. *No match*: Create new Contact in Salesforce, return new Contact ID\n6. *ProfileService* → Mobile App: Return Salesforce Contact ID (cached by Mobile App)\n\n===== System of Record Boundaries\n\n[width=\"100%\",cols=\"30%,35%,35%\",options=\"header\",]\n|===\n|Data Entity |System of Record |Rationale\n\n|*Contact*\n|Salesforce Service Cloud\n|Shared Viva Energy instance, unified customer profile across all channels (digital, wholesale, Shell Card, retail)\n\n|*Case*\n|Salesforce Service Cloud\n|Support agents manage Cases in Salesforce, digital channels submit via EngagementService ACL\n\n|*Feedback Submission (transient)*\n|None (no persistence)\n|EngagementService processes feedback and creates Case in Salesforce, no local storage\n\n|*Domain Events*\n|Event Bus (ephemeral)\n|Events published to Event Bus, consumed by subscribers, not persisted long-term (event sourcing not in scope)\n\n|===\n\n==== Data Architecture Principles\n\n===== Aggregate Persistence\n\n*ProfileService:*\n\n* **No local aggregate persistence** - ProfileService is stateless, queries Salesforce on-demand\n* Salesforce Contact is the aggregate root (owned by Salesforce)\n* ProfileService acts as facade/translator, not system of record\n\n*EngagementService:*\n\n* **No local aggregate persistence** - EngagementService is stateless, creates Cases in Salesforce via ACL\n* Salesforce Case is the aggregate root (owned by Salesforce)\n* EngagementService maintains no local Case state (Conformist pattern - trust Salesforce as source of truth)\n* Async processing state managed via Event Bus (work items in queue, not database)\n\n===== Event Store\n\n* **Event Bus** (SNS+SQS/EventBridge/Kinesis) handles domain event publishing\n* Events are **ephemeral** (consumed and discarded, not persisted for event sourcing)\n* No Event Store implementation in this architecture (future enhancement if needed)\n* Event schema versioning TBD in Solution Architecture\n\n\n=== Architecture Decisions\n\n==== ADR-CS-001: Consolidate onto Salesforce Service Cloud (not build custom solution)\n\n*Status*: Accepted\n\n*Context*:\n\n* D365 Customer Engagement not working well for digital customer support\n* Viva Energy already uses Salesforce Service Cloud for fuel wholesale, Shell Card, other retail channels\n* Post-merger opportunity to consolidate onto single platform\n* Alternative: Build custom support platform or use different SaaS\n\n*Decision*:\n\nConsolidate OTR digital customer support onto Salesforce Service Cloud (shared Viva Energy instance).\n\n*Rationale*:\n\n* **Unified customer view**: Support agents see all interactions across channels (digital, wholesale, Shell Card, retail)\n* **Platform consolidation**: Single support platform reduces operational overhead and costs\n* **Proven solution**: Salesforce Service Cloud is established, feature-rich, well-supported\n* **Post-merger alignment**: Strategic decision to standardize on Viva Energy platforms\n* **Avoid custom development**: Building custom support platform would be costly and high-risk\n\n*Consequences*:\n\n* Unified customer support across Viva Energy Group\n* Reduced operational complexity (single platform vs two)\n* Leverage Salesforce capabilities (case routing, knowledge base, AI, omnichannel)\n* ⚠️ Conformist pattern required (shared instance, conform to existing configuration)\n* ⚠️ Multi-tenant governance needed (data isolation, security, queues)\n* ❌ Less control over platform evolution (SaaS vendor, shared instance)\n\n==== ADR-CS-002: Implement ProfileService and EngagementService as first DDD bounded contexts\n\n*Status*: Accepted\n\n*Context*:\n\n* OTR target architecture uses Domain-Driven Design with bounded contexts\n* This migration is opportunity to establish first implementation\n* Alternative: Direct Mobile App → Salesforce integration (no bounded contexts)\n* Alternative: Single monolithic service for all customer-facing APIs\n\n*Decision*:\n\nImplement ProfileService and EngagementService as separate bounded contexts following DDD strategic patterns.\n\n*Rationale*:\n\n* **Foundation for target architecture**: First implementation of DDD pattern for future bounded contexts (Flybuys, LocationService, PaymentService)\n* **Separation of concerns**: ProfileService handles identity/Contact reconciliation, EngagementService handles support/feedback (different responsibilities, different change rates)\n* **Anti-Corruption Layer**: EngagementService protects digital channels from Salesforce API changes\n* **Reusability**: ProfileService Contact reconciliation reused for Flybuys integration\n* **Event-driven architecture**: Establishes pattern for loose coupling between bounded contexts\n\n*Consequences*:\n\n* Establishes DDD architecture foundation for OTR\n* Reusable ProfileService for Flybuys and future integrations\n* Digital channels protected from Salesforce API changes (ACL)\n* Clear bounded context boundaries and responsibilities\n* ⚠️ Increased initial complexity (two new microservices vs direct integration)\n* ⚠️ Requires Event Bus infrastructure implementation\n* ⚠️ Team must learn DDD patterns and bounded context design\n\n==== ADR-CS-003: Async Case creation via Event Bus (not synchronous)\n\n*Status*: Accepted\n\n*Context*:\n\n* Current D365 CE integration is synchronous (user waits for Case creation)\n* Alternative: Keep synchronous integration (Mobile App → EngagementService → Salesforce synchronously)\n* Salesforce API may experience downtime or latency\n\n*Decision*:\n\nImplement async Case creation via Event Bus with immediate user acknowledgment, retry logic, exponential backoff, and dead letter queue.\n\n*Rationale*:\n\n* **Non-blocking user experience**: User gets immediate \"Feedback submitted\" confirmation, not waiting for Salesforce API\n* **Resilience**: If Salesforce is down, feedback still accepted, Case created when Salesforce recovers\n* **Retry logic**: Automatic retry with exponential backoff handles transient failures\n* **Operational visibility**: Dead letter queue alerts ops team to persistent failures\n* **Scalability**: Queue buffering handles traffic spikes\n\n*Consequences*:\n\n* Better user experience (no waiting for Salesforce API)\n* Resilient to Salesforce downtime (queue buffers work)\n* Automatic retry reduces manual intervention\n* Queue depth monitoring provides operational visibility\n* ⚠️ Eventual consistency (user gets success notification after Case created, not immediately)\n* ⚠️ Increased complexity (Event Bus, background workers, retry logic, DLQ)\n* ⚠️ Requires monitoring and alerting for DLQ\n\n==== ADR-CS-004: ProfileService uses email as primary matching key (not VCI)\n\n*Status*: Accepted\n\n*Context*:\n\n* ProfileService needs to reconcile Mobile App users as Salesforce Contacts\n* Alternative matching keys: VCI (Viva Consumer ID), email, phone, Salesforce External ID\n* Email changes are rare but possible\n\n*Decision*:\n\nUse email address as primary matching key for Contact reconciliation (JIT upsert by email).\n\n*Rationale*:\n\n* **Availability**: Email always available for authenticated users\n* **Uniqueness**: Email is unique identifier in Salesforce and Mobile App\n* **Salesforce standard**: Salesforce Contact uses email as standard lookup field\n* **Simplicity**: Single matching key simplifies upsert logic\n* **Edge case acceptable**: Email changes are rare, manual cleanup acceptable\n\n*Consequences*:\n\n* Simple upsert logic (query by email, create if not found)\n* Leverages Salesforce standard email field\n* Email always available from authentication\n* ⚠️ Email changes create duplicate Contacts (rare edge case, manual cleanup)\n* ⚠️ Future enhancement: Add VCI as Salesforce External ID for stable matching\n\n==== ADR-CS-005: No Case migration from D365 CE (fresh start)\n\n*Status*: Accepted\n\n*Context*:\n\n* D365 CE contains historical customer support Cases\n* Alternative: Migrate historical Cases to Salesforce (preserve support history)\n* Alternative: Archive D365 CE Cases separately (read-only access)\n\n*Decision*:\n\nDo not migrate historical Cases from D365 CE to Salesforce. Start fresh in Salesforce.\n\n*Rationale*:\n\n* **Limited value**: Historical D365 CE Cases not critical for future support\n* **Data quality**: D365 CE Case data may be inconsistent or incomplete\n* **Complexity**: Case migration requires mapping D365 CE schema to Salesforce, data transformation, validation\n* **Cost-benefit**: Migration effort outweighs value of historical data\n* **Archive option**: D365 CE Cases can be archived separately if needed (read-only access for auditing)\n\n*Consequences*:\n\n* Simpler migration (Contacts only, no Case migration)\n* Faster time to value (no Case migration delay)\n* Clean start in Salesforce (no legacy data quality issues)\n* ⚠️ Historical Cases not visible in Salesforce (support agents can't see old Cases)\n* ⚠️ D365 CE must remain accessible temporarily for historical Case lookups (if needed)\n* ❌ Loss of historical Case insights (reporting, analytics on old Cases)\n\n==== ADR-CS-006: Big bang cutover (not phased rollout)\n\n*Status*: Accepted\n\n*Context*:\n\n* Alternative: Phased rollout with feature flags (pilot users first, gradual enablement)\n* Alternative: Parallel run (submit to both D365 CE and Salesforce temporarily)\n* Flybuys integration uses phased rollout (AS-1, AS-2, AS-3 architecture states)\n\n*Decision*:\n\nBig bang cutover - migrate Contacts, deploy ProfileService and EngagementService, switch Mobile App, retire D365 CE.\n\n*Rationale*:\n\n* **Simplicity**: No parallel run complexity, no feature flag management\n* **Faster D365 CE retirement**: No extended transition period maintaining two systems\n* **Limited risk**: Customer support not mission-critical (not payment processing), rollback possible\n* **User base manageable**: OTR digital customers smaller than Flybuys integration scope\n* **Different use case**: Flybuys phased rollout manages points accrual complexity, support feedback is simpler\n\n*Consequences*:\n\n* Simpler deployment (single cutover, no AS-1/AS-2/AS-3 states)\n* Faster D365 CE retirement (no extended parallel run)\n* No feature flag complexity or pilot user management\n* ⚠️ Higher cutover risk (all users switch at once)\n* ⚠️ Requires comprehensive testing before cutover\n* ⚠️ Rollback plan required (revert to D365 CE if critical issues)\n\n==== ADR-CS-007: EngagementService receives Salesforce webhooks for Case updates\n\n*Status*: Accepted\n\n*Context*:\n\n* Support agents update/resolve Cases in Salesforce\n* Need to notify customers of Case status changes via push notifications\n* Alternative: Poll Salesforce API for Case updates (inefficient)\n* Alternative: No customer notifications (agents contact customers directly)\n\n*Decision*:\n\nSalesforce sends webhook notifications to EngagementService when Cases are updated/resolved. EngagementService triggers Braze push notifications.\n\n*Rationale*:\n\n* **Real-time notifications**: Customer notified immediately when agent resolves Case\n* **Efficient**: Webhook push model (not polling)\n* **Event-driven**: Aligns with event-driven architecture pattern\n* **Better customer experience**: Proactive notification vs waiting for agent contact\n\n*Consequences*:\n\n* Real-time customer notifications for Case updates\n* Efficient push model (no polling overhead)\n* Bidirectional integration (Mobile App → Salesforce → Mobile App)\n* ⚠️ Salesforce webhook mechanism TBD (Outbound Messages vs Platform Events vs Process Builder)\n* ⚠️ Webhook authentication and security required\n* ⚠️ EngagementService must handle webhook retries and failures\n\n<<<\n== Interface Specifications\n\nThis section provides references to the complete API specifications and event catalogue for ProfileService and EngagementService.\n\n=== REST API Specifications\n\nComplete OpenAPI 3.0 specifications are maintained in the `specifications/rest/` directory:\n\n==== ProfileService API v1\n\n*Specification*: link:../../specifications/rest/profile-service-v1.yaml[profile-service-v1.yaml]\n\n*Base URL*: `https://api.otr.com.au/profile/v1`\n\n*Authentication*: Bearer token (Microsoft Entra External ID JWT)\n\n*Key Endpoints*:\n\n* `GET /contact-id` - Retrieve or create Salesforce Contact ID for authenticated user (Just-In-Time reconciliation)\n** Used by Mobile App before submitting feedback to EngagementService\n** Upserts Salesforce Contact record using email as external key\n** Returns 18-character Salesforce Contact ID with caching (15-minute TTL)\n** Performance SLA: p95 < 300ms (uncached), p95 < 50ms (cached)\n\n==== EngagementService API v1\n\n*Specification*: link:../../specifications/rest/engagement-service-v1.yaml[engagement-service-v1.yaml]\n\n*Base URL*: `https://api.otr.com.au/engagement/v1`\n\n*Authentication*: Bearer token (Microsoft Entra External ID JWT)\n\n*Key Endpoints*:\n\n* `POST /feedback` - Submit customer feedback for async Case creation in Salesforce\n** Accepts contactId, category, storeName, timeOfVisit, contactPhoneNumber, message\n** Returns 202 Accepted immediately (async Case creation in background)\n** Publishes `CustomerFeedbackSubmitted` event for analytics\n** Creates Salesforce Case via Anti-Corruption Layer with retry logic\n** Performance SLA: p95 < 200ms (feedback accepted, not Case creation)\n\n=== Domain Events (AsyncAPI)\n\nComplete CloudEvents 1.0 JSON Schema specifications are maintained in the `specifications/events/` directory:\n\n*Specification*: link:../../specifications/events/engagement-events.json[engagement-events.json]\n\n==== Event Catalogue\n\n[width=\"100%\",cols=\"30%,20%,50%\",options=\"header\",]\n|===\n|Event Type |Publisher |Consumers\n\n|`CustomerFeedbackSubmitted`\n|EngagementService\n|Future bounded contexts, analytics, sentiment analysis\n\n|`SupportCaseCreated`\n|EngagementService\n|Future bounded contexts, analytics\n\n|`SupportCaseUpdated`\n|EngagementService (via Salesforce webhook)\n|Future bounded contexts, analytics\n\n|`SupportCaseResolved`\n|EngagementService (via Salesforce webhook)\n|Future bounded contexts, analytics\n\n|===\n\n==== Event Delivery Guarantees\n\n* **At-least-once delivery**: Events may be delivered multiple times, consumers must handle idempotency\n* **Ordering**: FIFO queues guarantee ordering for events with same `contactId`\n* **Retention**: 4 days (96 hours) in Event Bus\n* **Dead Letter Queue**: Failed events after 5 retries moved to DLQ for manual intervention\n* **Format**: CloudEvents 1.0 specification with JSON payload\n\n=== API Versioning Policy\n\n==== Version Numbering\n\n* **Format**: `/v{major}` in URL path (e.g., `/profile/v1`, `/engagement/v1`)\n* **Semantic Versioning**: Major version incremented for breaking changes only\n* **Backwards Compatibility**: Minor changes (new optional fields, new endpoints) don't require version bump\n\n==== When to Version\n\n*Breaking changes requiring new major version*:\n\n- Removing or renaming fields in request/response\n- Changing field data types (e.g., string → number)\n- Changing authentication mechanism\n- Removing endpoints\n\n*Non-breaking changes not requiring version bump*:\n\n- Adding new optional fields to request/response\n- Adding new endpoints\n- Expanding enum values (e.g., adding new feedback category)\n- Improving error messages\n\n==== Parallel Version Support\n\n* Support N and N-1 versions concurrently for 6 months\n* Deprecation notice: 3 months before sunsetting old version\n* Mobile App must upgrade to new version within deprecation window\n\n<<<\n== Work Packages\n\nThis section consolidates gaps and activities into implementable work packages aligned with TOGAF Phase E requirements.\n\n=== Work Package Overview\n\n[width=\"100%\",cols=\"15%,35%,25%,25%\",options=\"header\",]\n|===\n|Work Package ID |Name |Transition State |Key Deliverables\n\n|WP-CS-001\n|ProfileService Development\n|TS-1 (Build & Test)\n|ProfileService microservice, Salesforce Contact integration, REST API\n\n|WP-CS-002\n|EngagementService Development\n|TS-1 (Build & Test)\n|EngagementService microservice, Anti-Corruption Layer, Braze integration\n\n|WP-CS-003\n|Event Bus Infrastructure\n|TS-1 (Build & Test)\n|Event Bus configuration, CloudEvents schemas, monitoring\n\n|WP-CS-004\n|Contact Migration Tooling\n|TS-1 (Build & Test)\n|Migration tool, validation scripts, reconciliation reporting\n\n|WP-CS-005\n|Mobile App Integration\n|TS-1 (Build & Test)\n|Mobile App API integration, feedback form enhancements, testing\n\n|WP-CS-006\n|Integration Testing\n|TS-1 (Build & Test)\n|Test environments, integration test suites, UAT execution\n\n|WP-CS-007\n|Salesforce Configuration\n|TS-1 (Build & Test)\n|Salesforce field mapping, data isolation, webhook configuration\n\n|WP-CS-008\n|Contact Data Migration\n|TS-2 (Contact Migration)\n|Contact migration execution, validation, reconciliation\n\n|WP-CS-009\n|Production Deployment\n|TS-3 (Cutover)\n|Production deployment, smoke testing, go-live execution\n\n|WP-CS-010\n|Post-Cutover Support\n|TS-4 (Target State)\n|Monitoring, issue resolution, D365 CE retirement\n\n|===\n\n[[wp-cs-001]]\n=== WP-CS-001: ProfileService Development\n\n==== Description\n\nBuild ProfileService bounded context microservice implementing Just-In-Time Contact reconciliation with Salesforce Service Cloud.\n\n==== Deliverables\n\n* ProfileService microservice application\n** REST API implementation (OpenAPI 3.0 specification)\n** `GET /contact-id` endpoint (Salesforce Contact reconciliation)\n** Authentication/authorization with Microsoft Entra External ID\n** Caching layer (15-minute TTL for Contact IDs)\n* Salesforce integration\n** Salesforce REST API client\n** Contact upsert by email (external key matching)\n** Error handling and retry logic\n* Unit tests (>80% code coverage)\n* Integration tests with Salesforce sandbox\n* API documentation\n* Deployment configuration (IaC - Infrastructure as Code)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* Salesforce sandbox environment provisioned\n* Microsoft Entra External ID OAuth configuration\n* Development environment setup (AWS dev account, CI/CD pipeline)\n\n*Dependent Work Packages*:\n\n* None (can start immediately after prerequisites met)\n\n==== Skills Required\n\n* Backend development (.NET Core or Node.js)\n* REST API design and implementation\n* Salesforce REST API integration\n* OAuth 2.0 / JWT authentication\n* Caching strategies (Redis/ElastiCache)\n* Unit/integration testing frameworks\n* Infrastructure as Code (Terraform/CloudFormation)\n\n==== Acceptance Criteria\n\n* All API endpoints return correct HTTP status codes per OpenAPI specification\n* Contact ID retrieval achieves p95 < 300ms (uncached), p95 < 50ms (cached)\n* Salesforce Contact upsert succeeds with 100% accuracy in sandbox testing\n* Unit test coverage > 80%\n* Integration tests pass in sandbox environment\n* API documentation generated from OpenAPI specification\n\n[[wp-cs-002]]\n=== WP-CS-002: EngagementService Development\n\n==== Description\n\nBuild EngagementService bounded context microservice implementing customer feedback submission, Anti-Corruption Layer for Salesforce Case creation, Braze integration, and webhook receiver for Case updates.\n\n==== Deliverables\n\n* EngagementService microservice application\n** REST API implementation (OpenAPI 3.0 specification)\n** `POST /feedback` endpoint (async feedback submission)\n** Authentication/authorization with Microsoft Entra External ID\n** Webhook receiver endpoint for Salesforce Case updates\n* Anti-Corruption Layer (ACL)\n** OTR domain model to Salesforce API translation\n** Category enum mapping (App/Service/Order/Rewards → Salesforce Case fields)\n** Salesforce REST API client for Case creation\n* Async processing infrastructure\n** Event Bus publisher integration\n** Background worker for Case creation\n** Retry logic with exponential backoff (5 attempts)\n** Dead Letter Queue integration\n* Braze integration\n** Braze campaign trigger API client\n** Push notification orchestration for Case updates\n* Domain event publishing\n** `CustomerFeedbackSubmitted` event publisher\n** `SupportCaseCreated` event publisher\n** `SupportCaseUpdated` event translator (Salesforce webhook → domain event)\n** `SupportCaseResolved` event translator (Salesforce webhook → domain event)\n* Unit tests (>80% code coverage)\n* Integration tests (EngagementService ↔ Salesforce, EngagementService ↔ Braze)\n* API documentation\n* Deployment configuration (IaC)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-003 (Event Bus Infrastructure) completed\n* Salesforce sandbox environment provisioned\n* Braze API credentials and campaign templates configured\n* Microsoft Entra External ID OAuth configuration\n\n*Dependent Work Packages*:\n\n* WP-CS-003 must be completed first (Event Bus required for async processing)\n* WP-CS-007 (Salesforce Configuration) must be in progress (field mapping needed)\n\n==== Skills Required\n\n* Backend development (.NET Core or Node.js)\n* REST API design and implementation\n* Salesforce REST API integration\n* Event-driven architecture patterns\n* Async/background processing (queues, workers)\n* Braze API integration\n* Webhook design and security\n* OAuth 2.0 / JWT authentication\n* Domain-Driven Design (DDD) - Anti-Corruption Layer pattern\n* Unit/integration testing frameworks\n* Infrastructure as Code (Terraform/CloudFormation)\n\n==== Acceptance Criteria\n\n* Feedback submission endpoint returns 202 Accepted within p95 < 200ms\n* Async Case creation succeeds with >99.5% success rate (including retries)\n* Anti-Corruption Layer correctly maps all feedback categories to Salesforce Case fields\n* Webhook receiver processes Salesforce Case updates and publishes domain events\n* Braze push notifications sent successfully for Case updates\n* Failed Case creation moves to Dead Letter Queue after 5 retry attempts\n* Unit test coverage > 80%\n* Integration tests pass with Salesforce sandbox and Braze staging environment\n\n=== WP-CS-003: Event Bus Infrastructure\n\n==== Description\n\nImplement Event Bus infrastructure for domain event publishing using existing AWS infrastructure (SNS+SQS, EventBridge, or Kinesis).\n\n==== Deliverables\n\n* Event Bus infrastructure configuration\n** Topic/stream provisioning (technology choice: SNS+SQS / EventBridge / Kinesis)\n** FIFO queue configuration (ordering by `contactId`)\n** Dead Letter Queue (DLQ) setup\n** Retention policy (4 days / 96 hours)\n** Access control policies (IAM roles, permissions)\n* CloudEvents 1.0 schema definitions\n** JSON Schema specifications for all domain events\n** Schema validation configuration\n** Schema registry (if using EventBridge/Kinesis)\n* Monitoring and alerting\n** CloudWatch dashboards for queue metrics\n** Alarms for DLQ depth, queue age, processing failures\n** Event Bus throughput monitoring\n* Documentation\n** Event Bus architecture diagram\n** Event publishing guidelines\n** Consumer integration guide\n* Infrastructure as Code (IaC)\n** Terraform/CloudFormation templates for all infrastructure\n\n==== Dependencies\n\n*Prerequisites*:\n\n* AWS account access (existing infrastructure)\n* Technology selection decision (SNS+SQS vs EventBridge vs Kinesis)\n* CloudEvents 1.0 schema design approval\n\n*Dependent Work Packages*:\n\n* None (foundational infrastructure, can start early)\n\n==== Skills Required\n\n* AWS messaging services (SNS, SQS, EventBridge, Kinesis)\n* Event-driven architecture patterns\n* CloudEvents specification\n* JSON Schema design\n* Infrastructure as Code (Terraform/CloudFormation)\n* AWS IAM security configuration\n* CloudWatch monitoring and alerting\n\n==== Acceptance Criteria\n\n* Event Bus infrastructure provisioned in all environments (dev, staging, production)\n* FIFO ordering validated for events with same `contactId`\n* Dead Letter Queue triggers alarms when messages arrive\n* Event retention policy enforced (4 days)\n* CloudEvents 1.0 schema validation enabled\n* Monitoring dashboards operational\n* Infrastructure fully codified (IaC)\n\n=== WP-CS-004: Contact Migration Tooling\n\n==== Description\n\nDevelop Contact migration tool for one-time migration from app-specific database to Salesforce Service Cloud with upsert logic and validation.\n\n==== Deliverables\n\n* Contact migration tool\n** Extract Contacts from app-specific database\n** Transform to Salesforce Contact API format\n** Upsert to Salesforce using email as external key\n** Fallback matching by phone number or Viva Consumer ID\n** Batch processing with rate limiting (respect Salesforce API limits)\n** Idempotent operation (can be re-run safely)\n* Validation scripts\n** Pre-migration validation (data quality checks)\n** Post-migration validation (100% Contact reconciliation)\n** Email/phone/VCI matching accuracy report\n* Reconciliation reporting\n** Contacts created vs updated statistics\n** Failed upserts with error details\n** Matching accuracy metrics\n* Rollback capability\n** Export snapshot of Salesforce Contacts before migration\n** Rollback procedure documentation\n* Documentation\n** Migration tool user guide\n** Troubleshooting guide\n** Runbook for migration execution\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-001 (ProfileService Development) completed (reuses Salesforce integration code)\n* Salesforce sandbox environment for migration testing\n* App-specific database access (read-only sufficient)\n* Salesforce production access granted\n\n*Dependent Work Packages*:\n\n* WP-CS-001 provides Salesforce Contact upsert logic to reuse\n\n==== Skills Required\n\n* Database development (SQL, data extraction)\n* Salesforce REST API integration\n* Batch processing and ETL patterns\n* Data validation and reconciliation\n* Error handling and logging\n* Scripting (Python, PowerShell, or similar)\n\n==== Acceptance Criteria\n\n* Migration tool successfully migrates 100% of Contacts in sandbox with zero data loss\n* Email/phone/VCI matching accuracy > 95% in sandbox testing\n* Failed upserts captured with actionable error messages\n* Reconciliation report matches actual Salesforce Contact counts\n* Migration tool execution time acceptable for production (freezes app database for minimum time)\n* Rollback procedure validated in sandbox\n* Documentation complete and approved\n\n=== WP-CS-005: Mobile App Integration\n\n==== Description\n\nUpdate Mobile App to integrate with ProfileService and EngagementService APIs, replacing D365 CE integration.\n\n==== Deliverables\n\n* Feedback form UI enhancements\n** Add Category dropdown (App, Service, Order, Rewards, Refund, Delete Account)\n** Add Store Name field (optional)\n** Add Time of Visit field (optional, datetime picker)\n** Add Contact Phone Number field (optional, E.164 validation)\n** Update Message field (1-2000 character limit with counter)\n* API integration (Kotlin Multiplatform shared code)\n** ProfileService client (`GET /contact-id`)\n** EngagementService client (`POST /feedback`)\n** JWT token management (Microsoft Entra External ID)\n** Error handling (network failures, API errors, validation errors)\n** Retry logic for transient failures\n* Platform-specific UI (SwiftUI for iOS, Jetpack Compose for Android)\n** Feedback form screens\n** Success/error confirmation screens\n** Loading states and progress indicators\n* Feature flag integration\n** `enable_salesforce_feedback_submission` flag\n** Fallback to D365 CE if flag disabled (during rollout)\n* Unit tests for shared business logic\n* UI tests for platform-specific screens\n* API integration tests (mocked APIs)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-001 (ProfileService Development) completed and deployed to dev/staging\n* WP-CS-002 (EngagementService Development) completed and deployed to dev/staging\n* ProfileService and EngagementService OpenAPI specifications finalized\n* Feature flag service configured\n\n*Dependent Work Packages*:\n\n* Must complete after WP-CS-001 and WP-CS-002 (requires API endpoints available for integration testing)\n\n==== Skills Required\n\n* Kotlin Multiplatform development\n* SwiftUI (iOS native UI)\n* Jetpack Compose (Android native UI)\n* REST API client development\n* OAuth 2.0 / JWT authentication\n* Form validation and UX design\n* Unit testing (Kotlin, Swift)\n* UI testing frameworks (XCTest, Espresso)\n\n==== Acceptance Criteria\n\n* Feedback form UI matches UX design specifications\n* All form fields validate correctly (client-side validation)\n* API integration successfully calls ProfileService and EngagementService in dev/staging\n* Error handling provides user-friendly error messages\n* Feature flag correctly toggles between Salesforce and D365 CE integration\n* Unit test coverage > 80% for shared business logic\n* UI tests pass for all feedback form workflows (happy path, error states)\n* App builds and deploys successfully to TestFlight (iOS) and Google Play Internal Testing (Android)\n\n=== WP-CS-006: Integration Testing\n\n==== Description\n\nExecute comprehensive integration testing across all system components in non-production environments.\n\n==== Deliverables\n\n* Test environment setup\n** Salesforce sandbox configured with test data\n** ProfileService deployed to staging\n** EngagementService deployed to staging\n** Event Bus staging infrastructure\n** Braze staging environment configured\n** Mobile App TestFlight/Internal Testing builds\n* Integration test suites\n** ProfileService ↔ Salesforce (Contact upsert scenarios)\n** EngagementService ↔ Salesforce (Case creation scenarios)\n** EngagementService ↔ Braze (push notification scenarios)\n** Mobile App ↔ ProfileService ↔ EngagementService (end-to-end workflows)\n** Event Bus publishing and consumption\n** Webhook receiver (Salesforce → EngagementService)\n* Test scenarios\n** Happy path: Successful feedback submission and Case creation\n** Error scenarios: Salesforce API failures, Braze API failures, network timeouts\n** Retry scenarios: Async Case creation retries, DLQ validation\n** Performance testing: p95 latency validation for ProfileService and EngagementService\n** Load testing: Simulate 3x-10x expected volume\n* UAT execution\n** Business stakeholder UAT sessions\n** UAT test cases covering all feedback categories\n** UAT sign-off documentation\n* Test results documentation\n** Test execution reports\n** Defect tracking and resolution\n** Performance test results\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-001 (ProfileService Development) completed\n* WP-CS-002 (EngagementService Development) completed\n* WP-CS-003 (Event Bus Infrastructure) completed\n* WP-CS-005 (Mobile App Integration) completed\n* WP-CS-007 (Salesforce Configuration) sandbox configuration completed\n\n*Dependent Work Packages*:\n\n* Must complete after WP-CS-001, WP-CS-002, WP-CS-003, WP-CS-005 (requires all components available)\n\n==== Skills Required\n\n* Integration testing strategy and execution\n* Test automation frameworks (Postman, Newman, Selenium)\n* Performance testing tools (JMeter, k6, Gatling)\n* Salesforce sandbox administration\n* Test data management\n* Defect tracking and triage\n* UAT facilitation\n\n==== Acceptance Criteria\n\n* All integration test scenarios pass (happy path, error scenarios, retry scenarios)\n* Performance SLAs validated (ProfileService p95 < 300ms, EngagementService p95 < 200ms)\n* Load testing confirms system handles 3x expected volume without degradation\n* UAT sign-off obtained from business stakeholders\n* Zero critical defects (P1/P2) open before moving to Contact Migration\n* Test results documented and approved\n\n=== WP-CS-007: Salesforce Configuration\n\n==== Description\n\nConfigure Salesforce Service Cloud for OTR digital customer support integration, including field mapping, data isolation, and webhook setup.\n\n==== Deliverables\n\n* Salesforce Contact configuration\n** Custom fields for OTR-specific data (if needed)\n** Email as external key configuration\n** Record Type for OTR digital customers (data isolation)\n** Validation rules\n* Salesforce Case configuration\n** Custom fields for feedback categories (App, Service, Order, Rewards, Refund, Delete Account)\n** Case Type and Reason picklist mapping\n** Queue assignment rules (OTR digital support queue)\n** Case escalation rules\n** Case routing rules\n* Salesforce webhook configuration\n** Platform Events / Outbound Messages for Case updates\n** Webhook authentication (API key, JWT, or OAuth)\n** Case status change triggers (New → In Progress, Resolved, Closed)\n** Webhook payload format (JSON)\n* Data isolation strategy\n** Record Types for OTR vs other Viva Energy business units\n** Queues for OTR-specific Cases\n** Reporting and dashboards scoped to OTR data\n* Salesforce API access\n** Connected App configuration\n** OAuth 2.0 JWT bearer flow setup\n** API user credentials\n** API rate limit monitoring\n* Documentation\n** Salesforce field mapping specification\n** Webhook configuration guide\n** Data isolation architecture diagram\n** API authentication setup guide\n\n==== Dependencies\n\n*Prerequisites*:\n\n* Viva Energy Salesforce admin team engagement\n* Salesforce governance approval (multi-tenant environment)\n* Technical decision on webhook mechanism (Platform Events vs Outbound Messages)\n* Technical decision on authentication method (OAuth 2.0 JWT bearer flow recommended)\n\n*Dependent Work Packages*:\n\n* None (can start in parallel with development work packages)\n* Required for WP-CS-002 (EngagementService needs field mapping)\n* Required for WP-CS-006 (Integration Testing needs sandbox configuration)\n\n==== Skills Required\n\n* Salesforce administration\n* Salesforce configuration (Record Types, Queues, Validation Rules)\n* Salesforce API integration (REST API, Platform Events, Outbound Messages)\n* Salesforce security and authentication (OAuth, Connected Apps)\n* Multi-tenant data isolation patterns\n\n==== Acceptance Criteria\n\n* Salesforce sandbox configured with all custom fields, Record Types, Queues\n* Field mapping documented and approved by OTR business stakeholders\n* Webhook configuration tested and delivering Case update notifications\n* Data isolation validated (OTR data separate from other Viva Energy business units)\n* API authentication working for ProfileService and EngagementService\n* Salesforce API rate limits monitored and acceptable for expected volume\n* Configuration replicated to Salesforce production environment\n\n=== WP-CS-008: Contact Data Migration\n\n==== Description\n\nExecute one-time Contact migration from app-specific database to Salesforce Service Cloud production.\n\n==== Deliverables\n\n* Pre-migration activities\n** Final validation of migration tool in sandbox\n** Communication plan (notify users of maintenance window if needed)\n** Freeze app-specific database Contact updates\n** Backup app-specific database\n** Export snapshot of Salesforce Contacts (rollback preparation)\n* Migration execution\n** Execute migration tool against Salesforce production\n** Monitor migration progress\n** Handle failed upserts (manual intervention if needed)\n* Post-migration validation\n** 100% Contact reconciliation (app database vs Salesforce)\n** Email/phone/VCI matching accuracy report\n** Reconciliation report (Contacts created vs updated)\n** Data integrity checks (no duplicate Contacts, no missing Contacts)\n* ProfileService smoke testing\n** Verify Contact ID retrieval works in production\n** Test cache behavior\n** Validate Salesforce Contact upserts from ProfileService\n* Migration report\n** Total Contacts migrated\n** Contacts created vs updated\n** Failed upserts (if any) with resolution\n** Matching accuracy metrics\n** Migration execution time\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-004 (Contact Migration Tooling) completed\n* WP-CS-001 (ProfileService Development) deployed to production (not yet integrated with Mobile App)\n* WP-CS-007 (Salesforce Configuration) production configuration completed\n* Salesforce production access granted\n* Migration approved by business stakeholders\n\n*Dependent Work Packages*:\n\n* Must complete after WP-CS-001, WP-CS-004, WP-CS-007\n* Must complete before WP-CS-009 (Production Deployment)\n\n==== Skills Required\n\n* Data migration execution\n* Salesforce administration\n* Database operations\n* Data validation and reconciliation\n* Incident management (if issues arise)\n\n==== Acceptance Criteria\n\n* 100% of Contacts migrated with zero data loss\n* Email/phone/VCI matching accuracy > 95%\n* ProfileService smoke tests pass in production\n* Reconciliation report approved by business stakeholders\n* App-specific database Contact updates frozen (read-only mode)\n* Rollback procedure ready (but not executed if migration successful)\n\n=== WP-CS-009: Production Deployment\n\n==== Description\n\nDeploy all solution components to production and execute cutover from D365 CE to Salesforce Service Cloud.\n\n==== Deliverables\n\n* Production deployment\n** EngagementService deployed to production\n** Event Bus production infrastructure validated\n** Salesforce webhook configured in production\n** Mobile App released to production (App Store, Google Play)\n* Go-live activities\n** Smoke testing (end-to-end feedback submission)\n** Feature flag enabled: `enable_salesforce_feedback_submission = ON`\n** D365 CE integration disabled in Mobile App\n** Monitor Event Bus queue depth, DLQ, Salesforce API rate limits\n** Monitor Mobile App feedback submission success rate\n* Go/No-Go decision\n** Validate success criteria before final cutover\n** Business stakeholder approval\n** Technical validation (smoke tests pass, monitoring healthy)\n* Cutover communication\n** Notify support agents of new Salesforce integration\n** Provide training materials for support agents\n** Customer communication (if visible change)\n* Rollback plan\n** Documented rollback procedure\n** Feature flag can disable Salesforce integration and re-enable D365 CE\n** Rollback decision criteria (P1/P2 incidents, feedback submission success rate < 99%)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-001 (ProfileService Development) completed\n* WP-CS-002 (EngagementService Development) completed\n* WP-CS-003 (Event Bus Infrastructure) completed\n* WP-CS-005 (Mobile App Integration) completed\n* WP-CS-006 (Integration Testing) completed with UAT sign-off\n* WP-CS-007 (Salesforce Configuration) production configuration completed\n* WP-CS-008 (Contact Data Migration) completed successfully\n* Mobile App release approval (App Store, Google Play)\n\n*Dependent Work Packages*:\n\n* Must complete after all prior work packages (final cutover)\n\n==== Skills Required\n\n* Production deployment and release management\n* Incident management and troubleshooting\n* Monitoring and observability\n* Change management and communication\n* Rollback execution (if needed)\n\n==== Acceptance Criteria\n\n* Mobile App feedback submission success rate > 99.5%\n* End-to-end flow validated (Mobile App → ProfileService → EngagementService → Salesforce Case created)\n* Braze push notifications delivered successfully\n* Event Bus queue depth normal, DLQ empty\n* No critical incidents (P1/P2) in first 24 hours\n* D365 CE integration disabled\n* Support agents successfully using Salesforce for OTR digital customer Cases\n\n=== WP-CS-010: Post-Cutover Support\n\n==== Description\n\nMonitor production stability, resolve issues, validate success criteria, and execute D365 CE retirement.\n\n==== Deliverables\n\n* Monitoring and support\n** 24/7 on-call support for first week post-cutover\n** Daily monitoring reports (feedback submission success rate, Case creation success rate)\n** Incident response and resolution\n** Performance tuning (if needed)\n* Success criteria validation\n** Validate feedback submission success rate > 99.5%\n** Monitor customer satisfaction score (target: +15% improvement within 6 months)\n** Monitor average case resolution time (target: -20% improvement within 6 months)\n** Support agent feedback survey\n* D365 CE retirement\n** D365 CE set to read-only mode (historical Case lookups only)\n** Archive D365 CE data for compliance/auditing\n** Decommission D365 CE infrastructure (after 90-day stabilization period)\n** Remove D365 CE integration code from Mobile App\n* Documentation updates\n** Production runbook\n** Troubleshooting guide (based on incidents resolved)\n** Operational procedures for support team\n** Lessons learned document\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-009 (Production Deployment) completed\n* Cutover successful with no critical incidents\n\n*Dependent Work Packages*:\n\n* Final work package in sequence\n\n==== Skills Required\n\n* Production support and incident management\n* Performance monitoring and tuning\n* Data archival and compliance\n* Infrastructure decommissioning\n* Documentation\n\n==== Acceptance Criteria\n\n* Zero critical incidents (P1/P2) in first 30 days post-cutover\n* Feedback submission success rate sustained > 99.5%\n* Customer satisfaction improvement validated (baseline established, ongoing measurement)\n* Support agents reporting positive experience with Salesforce unified view\n* D365 CE successfully decommissioned\n* All production documentation complete and approved\n* Lessons learned document published\n\n=== Work Package Sequencing\n\n==== Parallel Track 1: Infrastructure & Configuration\n\nCan start immediately and run in parallel:\n\n* WP-CS-003 (Event Bus Infrastructure)\n* WP-CS-007 (Salesforce Configuration)\n\n==== Parallel Track 2: Development\n\nCan start after Track 1 infrastructure decisions made:\n\n* WP-CS-001 (ProfileService Development) - Independent\n* WP-CS-002 (EngagementService Development) - Requires WP-CS-003 completed\n* WP-CS-004 (Contact Migration Tooling) - Requires WP-CS-001 completed (reuses code)\n\n==== Sequential Track 3: Integration & Testing\n\nMust complete after development:\n\n* WP-CS-005 (Mobile App Integration) - Requires WP-CS-001, WP-CS-002\n* WP-CS-006 (Integration Testing) - Requires WP-CS-001, WP-CS-002, WP-CS-003, WP-CS-005, WP-CS-007\n\n==== Sequential Track 4: Migration & Cutover\n\nMust complete sequentially:\n\n* WP-CS-008 (Contact Data Migration) - Requires WP-CS-001, WP-CS-004, WP-CS-006 UAT sign-off\n* WP-CS-009 (Production Deployment) - Requires all prior work packages completed\n* WP-CS-010 (Post-Cutover Support) - Requires WP-CS-009\n\n==== Critical Path\n\nThe critical path for this project is:\n\n. WP-CS-003 (Event Bus Infrastructure)\n. WP-CS-002 (EngagementService Development) - blocks on WP-CS-003\n. WP-CS-005 (Mobile App Integration) - blocks on WP-CS-001, WP-CS-002\n. WP-CS-006 (Integration Testing) - blocks on WP-CS-001 through WP-CS-005, WP-CS-007\n. WP-CS-008 (Contact Data Migration) - blocks on WP-CS-006 UAT sign-off\n. WP-CS-009 (Production Deployment) - blocks on WP-CS-008\n. WP-CS-010 (Post-Cutover Support) - final deliverable\n\nAny delays in critical path work packages will delay the overall cutover date.\n\n<<<\n== Transition Architecture\n\nThis section defines the evolution from baseline (D365 CE) to target state (Salesforce Service Cloud + ProfileService + EngagementService).\n\n=== Transition Approach\n\n*Big Bang Cutover*: Per ADR-CS-006, this transition uses a single cutover approach rather than phased rollout. All users switch from D365 CE to Salesforce simultaneously after Contact migration completion.\n\n=== Transition States\n\n==== TS-0: Baseline State (Current)\n\n===== Characteristics\n\n* D365 Customer Engagement handles all digital customer feedback\n* App-specific database stores customer Contact data\n* No ProfileService or EngagementService\n* No event-driven architecture\n* Synchronous feedback submission\n\n===== Components Active\n\n- D365 Customer Engagement\n- App-specific customer database\n- Mobile App (current version with D365 CE integration)\n\n==== TS-1: Build & Test\n\n===== Activities\n\n* Build ProfileService microservice (JIT Contact reconciliation API)\n* Build EngagementService microservice (feedback submission API, ACL for Salesforce Case creation, Braze integration, webhook receiver)\n* Implement Event Bus infrastructure (SNS+SQS/EventBridge/Kinesis)\n* Develop Contact migration tool (app database → Salesforce upsert by email/phone/VCI)\n* Update Mobile App API integration (ProfileService + EngagementService endpoints - feedback form UI already complete)\n* Integration testing (ProfileService ↔ Salesforce, EngagementService ↔ Salesforce, EngagementService ↔ Braze)\n* UAT with test Salesforce sandbox environment\n\n===== Components Active\n\n- D365 Customer Engagement (still active, unchanged)\n- App-specific customer database (still active)\n- ProfileService (non-production, testing only)\n- EngagementService (non-production, testing only)\n- Event Bus (non-production)\n- Salesforce Sandbox (testing)\n\n===== Exit Criteria\n\n- All integration tests pass\n- UAT sign-off from business stakeholders\n- Contact migration tool validated in sandbox\n- Mobile App updates tested with non-production APIs\n\n==== TS-2: Contact Migration\n\n===== Activities\n* Execute Contact migration (app database → Salesforce production)\n* Validation: 100% data integrity check (email/phone/VCI matching)\n* Reconciliation report: New Contacts created vs existing Contacts updated\n* Freeze app database Contact updates during migration window\n* ProfileService smoke testing (verify Contact lookups work in Salesforce production)\n\n===== Components Active\n- D365 Customer Engagement (still active, users unaffected)\n- Salesforce Production (Contacts migrated, no Cases yet)\n- ProfileService (production deployed, not integrated with Mobile App yet)\n- App-specific customer database (frozen, read-only)\n\n===== Exit Criteria\n- 100% of Contacts migrated with zero data loss\n- Email/phone/VCI matching accuracy > 95%\n- ProfileService smoke tests pass (JIT lookups return correct Contact IDs)\n- Reconciliation report approved\n\n==== TS-3: Cutover (Go-Live)\n\n===== Go-Live Activities\n\n* Deploy EngagementService to production\n* Deploy Mobile App updates (ProfileService + EngagementService API integration)\n* Configure Salesforce webhook (Case update notifications → EngagementService)\n* Smoke testing: End-to-end feedback submission (Mobile App → EngagementService → Salesforce → Braze notification)\n* Monitor Event Bus queue depth, dead letter queue, Salesforce API rate limits\n* **Go/No-Go decision**: Validate success criteria before final cutover\n* Enable feature flag: `enable_salesforce_feedback_submission = ON`\n* Disable D365 CE integration in Mobile App\n\n===== Components Active\n\n- ProfileService (production, integrated with Mobile App)\n- EngagementService (production, integrated with Mobile App)\n- Event Bus (production, processing async Case creation)\n- Salesforce Production (receiving Cases from digital customers)\n- Braze (sending push notifications)\n- Mobile App (new version with Salesforce integration)\n- D365 Customer Engagement (disabled, read-only for historical lookups)\n\n===== Exit Criteria\n\n- Mobile App feedback submission success rate > 99.5%\n- End-to-end flow validated (Mobile App → Salesforce Case created)\n- Braze push notifications delivered successfully\n- Event Bus queue depth normal, DLQ empty\n- No critical incidents (P1/P2) in first 24 hours\n\n==== TS-4: Target State (Stable Production)\n\n===== Characteristics\n\n* ProfileService and EngagementService fully operational\n* All digital customer feedback routed to Salesforce\n* Event-driven architecture established\n* D365 CE decommissioned\n* First DDD bounded contexts implemented successfully\n\n===== Monitoring Period\n\n* Validate success criteria: feedback submission rate > 99.5%, no data loss\n* Monitor customer satisfaction score (target: +15% improvement)\n* Monitor average case resolution time (target: -20% improvement)\n* Support agents using unified Salesforce view across all channels\n\n===== D365 CE Retirement\n\n* D365 CE read-only access for historical Case lookups (if needed)\n* Decommission D365 CE infrastructure after 90 days\n* Archive D365 CE data for compliance/auditing\n\n===== Components Active\n\n- ProfileService (production)\n- EngagementService (production)\n- Event Bus (production)\n- Salesforce Production (system of record)\n- Braze (push notifications)\n- Mobile App (Salesforce integration)\n- App-specific database (deprecated, Contact data no longer updated)\n\n===== Success Criteria Achieved\n\n- All digital customer feedback routed to Salesforce\n- Support agents have unified customer view\n- D365 CE decommissioned\n- Customer satisfaction improved by 15%\n- Average case resolution time decreased by 20%\n- Zero data loss during transition\n\n=== Transition Dependencies\n\n[width=\"100%\",cols=\"40%,60%\",options=\"header\",]\n|===\n|Dependency |Owner/Status\n\n|*Salesforce production access*\n|Viva Energy Salesforce admin team - TBD\n\n|*Salesforce Case field mapping*\n|Viva Energy Salesforce admin team - TBD (map OTR feedback categories to Salesforce fields)\n\n|*Salesforce data isolation strategy*\n|Viva Energy Salesforce admin team - TBD (Record Types, queues, custom fields)\n\n|*Salesforce webhook configuration*\n|Viva Energy Salesforce admin team - TBD (Outbound Messages vs Platform Events)\n\n|*Event Bus infrastructure*\n|OTR Platform team - Existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis)\n\n|*Braze integration*\n|OTR Marketing team - Existing Braze account, EngagementService creates new campaigns\n\n|*Mobile App release window*\n|OTR Mobile team - Coordinate cutover timing with app release schedule\n\n|*App database access*\n|OTR Platform team - Read access for Contact migration\n\n|===\n\n=== Transition Validation Criteria\n\n==== Contact Migration Validation\n\n* 100% of app database Contacts migrated to Salesforce (zero data loss)\n* Email/phone/VCI matching accuracy > 95% (minimize duplicate Contacts)\n* ProfileService JIT lookups return correct Salesforce Contact IDs (smoke test sample)\n* Reconciliation report shows: X new Contacts created, Y existing Contacts updated\n\n==== Cutover Validation\n\n* Mobile App feedback submission success rate > 99.5% (including async Case creation)\n* End-to-end flow validated: Mobile App → ProfileService → EngagementService → Salesforce Case created\n* Braze push notifications delivered for Case creation and Case resolution\n* Event Bus queue depth within normal range (no backlog)\n* Dead letter queue empty (no failed Case creations)\n* Salesforce API rate limits not exceeded\n\n==== Production Monitoring (30 days)\n\n* Customer satisfaction score improves by 15% (compared to D365 CE baseline)\n* Average case resolution time decreases by 20% (Salesforce vs D365 CE)\n* Support agents confirm unified customer view across all channels\n* Zero critical incidents (P1 outages, data loss)\n\n=== Rollback Plan\n\n==== Rollback Triggers\n\n* Feedback submission success rate < 95% (below acceptable threshold)\n* Data loss or corruption detected in Salesforce\n* Salesforce API rate limits exceeded (Cases not created within SLA)\n* Critical bug blocking customer feedback submission\n\n==== Rollback Procedure\n\n1. **Revert Mobile App** to previous version (remove ProfileService/EngagementService integration, restore D365 CE integration)\n2. **Stop EngagementService** Case creation (prevent duplicate Cases in Salesforce)\n3. **Re-enable D365 CE** for customer feedback submission\n4. **Investigate root cause** (EngagementService logs, Salesforce API errors, Event Bus queue issues)\n5. **Fix and re-test** in sandbox environment\n6. **Retry cutover** when issues resolved\n\n==== Rollback Limitations\n\n* Cases created in Salesforce during cutover period remain in Salesforce (no reverse migration)\n* Contacts migrated to Salesforce remain (no rollback to app database)\n* Rollback only affects Mobile App integration (not data migration)\n\n=== Architectural Scope Boundaries\n\n==== Capabilities Included\n\n===== Business Capabilities\n\n* **Customer Feedback Submission**: Mobile App users can submit structured feedback (Category, Store Name, Time of Visit, Phone, Free Text Message) via EngagementService\n* **Customer Contact Management**: Just-In-Time (JIT) Contact reconciliation with Salesforce via ProfileService, ensuring every Mobile App user has a Salesforce Contact record\n* **Case Management Integration**: EngagementService creates Salesforce Cases asynchronously for customer feedback, support agents manage Cases in Salesforce Service Cloud\n* **Customer Notifications**: Push notifications via Braze when Cases are created, updated, or resolved (bidirectional integration: Mobile App → Salesforce → Mobile App)\n* **Unified Customer View**: Support agents see OTR digital customer feedback alongside other Viva Energy channels (fuel wholesale, Shell Card, retail) in single Salesforce instance\n* **Contact Data Migration**: One-time migration of app-specific customer database Contacts to Salesforce with upsert logic (email/phone/VCI matching)\n\n===== Technical Capabilities\n\n* **ProfileService Bounded Context**: First DDD bounded context implementation - JIT Contact reconciliation, Salesforce API facade, foundation for Flybuys integration\n* **EngagementService Bounded Context**: First DDD bounded context implementation - Customer feedback submission BFF, Anti-Corruption Layer for Salesforce, Braze integration orchestration\n* **Event-Driven Architecture**: Domain event publishing via Event Bus (SNS+SQS/EventBridge/Kinesis) for `SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted` events\n* **Async Processing Pattern**: Non-blocking Case creation with retry logic, exponential backoff, dead letter queue for operational resilience\n* **Anti-Corruption Layer Pattern**: EngagementService protects digital channels from Salesforce API changes, translates between OTR domain language and Salesforce\n* **Conformist Pattern**: ProfileService and EngagementService conform to existing Salesforce configuration (shared Viva Energy instance, multi-tenant governance)\n* **Salesforce Integration**: REST API integration for Contact CRUD and Case creation, webhook receiver for Case update notifications\n* **Braze Integration**: Push notification campaign triggers for Case lifecycle events (created, updated, resolved)\n* **Observability & Monitoring**: Dashboards, metrics, alerting for feedback submission rate, queue depth, API errors, Case creation latency\n* **Feature Flag Management**: Kill switches for emergency rollback (enable_salesforce_feedback_submission, enable_async_case_creation, etc.)\n\n==== Capabilities Excluded\n\n===== Business Capabilities Explicitly Out of Scope\n\n* **Historical Case Migration**: D365 CE Cases not migrated to Salesforce (ADR-CS-005 - fresh start, no Case migration)\n* **Multi-Channel Feedback Submission**: Web app, POS, call centre, email feedback channels not included (Mobile App only in this phase)\n* **Case Resolution by Digital Channels**: Support agents resolve Cases in Salesforce, not via Mobile App self-service\n* **Knowledge Base Integration**: Salesforce Knowledge Base articles not surfaced in Mobile App (future enhancement)\n* **Live Chat/Messaging**: Real-time chat support not included (Salesforce omnichannel capabilities not activated)\n* **Sentiment Analysis**: Automated feedback sentiment analysis not included (future enhancement with AI/ML)\n* **Customer Satisfaction Surveys**: Post-resolution CSAT surveys not included (separate initiative)\n* **Case Attachments**: Mobile App feedback submission does not support file uploads (photos, receipts) - text only\n* **Agent Desktop Integration**: Custom Salesforce UI for support agents not included (use standard Salesforce Service Console)\n* **Social Media Feedback**: Facebook, Twitter, Instagram feedback channels not integrated\n\n===== Technical Capabilities Explicitly Out of Scope\n\n* **Event Sourcing**: Domain events are ephemeral (not persisted for event sourcing/replay) - Event Bus only, no Event Store\n* **CQRS (Command Query Responsibility Segregation)**: ProfileService and EngagementService use same data model for reads/writes (no separate read models)\n* **Local Aggregate Persistence**: ProfileService and EngagementService are stateless (Salesforce is System of Record, no local database for Contact/Case)\n* **Saga Orchestration**: No distributed transactions or saga patterns required (single-step Case creation, not multi-step workflow)\n* **API Gateway Advanced Features**: Rate limiting, API versioning, API key management deferred to detailed design (basic routing only)\n* **GraphQL API**: ProfileService and EngagementService expose REST APIs only (GraphQL not required)\n* **Real-Time Sync**: Salesforce Contact updates by support agents not synced back to ProfileService (eventual consistency acceptable via JIT reconciliation)\n* **Multi-Region Deployment**: Single AWS region deployment (no multi-region failover/disaster recovery in this phase)\n* **Blue-Green Deployment**: Big bang cutover (ADR-CS-006), not blue-green or canary deployment strategy\n* **A/B Testing Framework**: Feature flags for rollback only, not for A/B testing or experimentation\n* **Custom Authentication**: Microsoft Entra External ID used for Mobile App authentication (no custom authentication logic in ProfileService/EngagementService)\n* **Data Residency Compliance**: Salesforce data residency governed by Viva Energy Salesforce configuration (no OTR-specific data residency requirements)\n\n===== Future Bounded Contexts Not in Scope\n\n* **LoyaltyService**: Flybuys integration, reward preferences, transaction adjudication (separate initiative)\n* **LocationService**: Store finder, proximity features, geofencing (separate initiative)\n* **PaymentService**: Payment processing, subscription billing (separate initiative)\n* **RecommendationService**: Personalized recommendations, next-best offers (separate initiative)\n\n===== Integration Patterns Not in Scope\n\n* **Shared Kernel**: No shared domain model between ProfileService and EngagementService (separate bounded contexts with clear boundaries)\n* **Partnership**: No joint development or coordination with external teams (Conformist pattern - we conform to Salesforce)\n* **Customer-Supplier (we're upstream)**: No downstream systems depend on ProfileService/EngagementService APIs yet (future bounded contexts will consume domain events)\n\n==== Architectural Dependencies on Future Initiatives\n\n*This Architecture Enables Future Initiatives*:\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Future Initiative |Architectural Enablement\n\n|*Flybuys Integration*\n|**ProfileService Contact Reconciliation Reused**: ProfileService establishes pattern for JIT Contact reconciliation with Salesforce, which will be extended for Flybuys partner linking (link:../architecture_definitions/flybuys_integration.adoc[see Flybuys Integration architecture]) +\n**Event Bus Infrastructure**: Domain event publishing pattern (`CustomerEnrolledInLoyalty`, `PartnerLinked`, etc.) reuses Event Bus established for EngagementService\n\n|*LoyaltyService Bounded Context*\n|**Event Bus Subscription**: LoyaltyService will consume `CustomerProfileCreated` events published by ProfileService (future enhancement) +\n**Salesforce Contact Integration**: LoyaltyService may query Salesforce Contacts for customer reward preferences (via ProfileService facade or direct Salesforce API)\n\n|*Web App Feedback Submission*\n|**EngagementService API Reuse**: Web app will call same EngagementService REST API for feedback submission (multi-channel support) +\n**Conformist Pattern**: Web app conforms to EngagementService API contract (no translation required)\n\n|*Multi-Channel Customer Support*\n|**EngagementService Extension**: Add support for email, call centre, POS feedback channels (extend EngagementService to handle multiple origins) +\n**Salesforce Case Origin Field**: Cases already tagged with Origin=Mobile App, extend to Origin=Web, POS, Call Centre, Email\n\n|*Knowledge Base Integration*\n|**EngagementService API Extension**: Add endpoint to query Salesforce Knowledge Base articles, surface in Mobile App for self-service support +\n**Anti-Corruption Layer**: EngagementService translates Salesforce Knowledge API to OTR domain language\n\n|*Customer Satisfaction Surveys*\n|**Event-Driven Trigger**: Subscribe to `SupportCaseResolved` events published by EngagementService, trigger CSAT survey via Braze +\n**Braze Integration Pattern**: Reuse EngagementService → Braze integration pattern for survey campaigns\n\n|*Sentiment Analysis*\n|**Event Subscription**: Subscribe to `CustomerFeedbackSubmitted` events, analyse feedback sentiment (AI/ML service) +\n**EngagementService Extension**: Enrich Case with sentiment score before creating in Salesforce\n\n|*RecommendationService Bounded Context*\n|**Event Subscription**: RecommendationService subscribes to `SupportCaseCreated` events to understand customer pain points and personalize recommendations +\n**Domain Event Pattern**: Reuse Event Bus publishing pattern established by EngagementService\n\n|===\n\n*This Architecture Depends on Future Initiatives*:\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Future Initiative |Dependency Description\n\n|*Salesforce Data Isolation Strategy*\n|**BLOCKER**: Viva Energy Salesforce admin team must define data isolation strategy (Record Types, custom fields, queues) before production deployment +\n**Impact**: Multi-tenant data visibility and security governance\n\n|*Salesforce Case Field Mapping*\n|**BLOCKER**: Viva Energy Salesforce admin team must define field mapping for OTR feedback categories (App, Service, Order, Rewards, Refund, Delete Account) +\n**Impact**: Case creation logic in EngagementService depends on finalized Salesforce schema\n\n|*Salesforce Webhook Mechanism*\n|**BLOCKER**: Viva Energy Salesforce admin team must configure webhook mechanism (Outbound Messages vs Platform Events vs Process Builder) for Case update notifications +\n**Impact**: EngagementService webhook receiver implementation depends on chosen mechanism\n\n|*Event Bus Technology Selection*\n|**DECISION REQUIRED**: Choose Event Bus implementation (SNS+SQS vs EventBridge vs Kinesis) for domain event publishing +\n**Impact**: Infrastructure provisioning, event schema design, consumer implementation\n\n|*Microservice Hosting Platform*\n|**DECISION REQUIRED**: Choose hosting platform for ProfileService and EngagementService (AWS Lambda vs ECS vs EKS) +\n**Impact**: Deployment architecture, auto-scaling strategy, operational overhead\n\n|*Observability Platform*\n|**DECISION REQUIRED**: Choose observability platform (AWS CloudWatch vs Datadog vs New Relic) for monitoring and alerting +\n**Impact**: Dashboard configuration, metric collection, alerting setup\n\n|===\n\n*Future Work After This Initiative*:\n\n* **Event Schema Registry**: Implement event schema versioning and registry for domain events (currently ad-hoc schemas)\n* **API Versioning Strategy**: Define API versioning approach for ProfileService and EngagementService (currently v1 only)\n* **Multi-Region Deployment**: Extend to multi-region for disaster recovery and global availability\n* **Event Store**: Persist domain events for event sourcing and audit trail (currently ephemeral Event Bus only)\n* **CQRS Pattern**: Separate read models for high-volume queries (currently same model for reads/writes)\n* **GraphQL API**: Expose GraphQL API for flexible client queries (currently REST only)\n* **Real-Time Sync**: Bi-directional sync between Salesforce and ProfileService for Contact updates (currently JIT reconciliation only)\n\n=== Technical Risks and Mitigation\n\n[width=\"100%\",cols=\"5%,20%,25%,25%,25%\",options=\"header\",]\n|===\n|ID |Risk |Impact |Likelihood |Mitigation\n\n|RISK-CS-001\n|*Salesforce API rate limits exceeded*: High feedback volume exceeds Salesforce API limits, Cases not created\n|HIGH (customers don't receive Case confirmation, support tickets lost)\n|MEDIUM (volume unknown, rate limits TBD)\n|• Gather expected feedback volume data before cutover +\n• Implement Event Bus queue throttling/rate limiting +\n• Monitor queue depth and API usage +\n• Scale background workers based on queue depth +\n• Alert ops team when approaching rate limits\n\n|RISK-CS-002\n|*Salesforce downtime*: Salesforce Service Cloud outage prevents Case creation\n|MEDIUM (Cases delayed but queued, customers wait for confirmation)\n|LOW (Salesforce SLA 99.9% uptime)\n|• Async Case creation with retry logic +\n• Event Bus queues buffer work during outage +\n• Customers get immediate \"Feedback submitted\" (not blocked) +\n• Monitor Salesforce status page, alert ops team +\n• Automatic retry when Salesforce recovers\n\n|RISK-CS-003\n|*Contact migration data quality issues*: App database Contact data incomplete or invalid\n|HIGH (migration fails validation, cutover delayed)\n|MEDIUM (legacy data quality unknown)\n|• Pre-migration data quality assessment +\n• Flexible upsert logic (match by email/phone/VCI) +\n• Validation report identifies data issues before production migration +\n• Manual cleanup for invalid records +\n• Dry-run migration in sandbox environment\n\n|RISK-CS-004\n|*Duplicate Contacts created*: Email matching fails, ProfileService creates duplicate Contacts\n|MEDIUM (support agents see multiple profiles for same customer)\n|MEDIUM (email changes, data quality issues)\n|• Salesforce duplicate detection rules (if available) +\n• ProfileService logs Contact creation for audit trail +\n• Manual duplicate cleanup process (support team) +\n• Future enhancement: VCI as Salesforce External ID for stable matching\n\n|RISK-CS-005\n|*Dead letter queue accumulation*: Failed Case creations not processed, queue grows\n|HIGH (customers don't receive Case confirmation, feedback lost)\n|LOW (retry logic handles most failures)\n|• Dead letter queue monitoring and alerting +\n• Ops team dashboard showing DLQ depth +\n• Manual intervention process (investigate and reprocess) +\n• Automated alerts when DLQ depth exceeds threshold +\n• Root cause analysis for recurring failures\n\n|RISK-CS-006\n|*Salesforce webhook failures*: Salesforce can't deliver Case update notifications to EngagementService\n|MEDIUM (customers don't get push notifications for Case resolution)\n|LOW (webhook mechanism reliable)\n|• Webhook retry logic and exponential backoff +\n• EngagementService logs webhook deliveries +\n• Monitor webhook delivery success rate +\n• Fallback: Poll Salesforce API for Case updates (if webhook fails persistently) +\n• Alert ops team when webhook delivery rate drops\n\n|RISK-CS-007\n|*Multi-tenant data isolation breach*: OTR digital Cases visible to other Viva Energy support teams\n|HIGH (privacy violation, compliance risk)\n|LOW (Salesforce governance controls)\n|• Work with Viva Energy Salesforce admin team on data isolation strategy +\n• Test data visibility in Salesforce sandbox (UAT with different user roles) +\n• Validate Record Types, queues, field-level security before production +\n• Audit Salesforce user permissions and sharing rules\n\n|RISK-CS-008\n|*Mobile App release coordination*: App release delayed, cutover window missed\n|MEDIUM (cutover delayed, D365 CE retirement delayed)\n|MEDIUM (release schedule conflicts)\n|• Coordinate cutover timing with Mobile team early +\n• Buffer time in migration plan (2-week contingency) +\n• Decouple backend deployment from Mobile App release (backend deployed first, app follows) +\n• Feature flag for feedback submission (enable when ready)\n\n|RISK-CS-009\n|*Event Bus infrastructure issues*: SNS/SQS/EventBridge downtime or misconfiguration\n|HIGH (Case creation blocked, domain events not published)\n|LOW (AWS SLA 99.99% uptime)\n|• Leverage existing AWS infrastructure (proven, reliable) +\n• Infrastructure as Code (IaC) for Event Bus configuration +\n• Integration testing in non-production environment +\n• Monitor Event Bus metrics (queue depth, throughput, errors) +\n• Alert ops team on Event Bus failures\n\n|RISK-CS-010\n|*Team DDD knowledge gap*: Team unfamiliar with DDD patterns, bounded contexts, event-driven architecture\n|MEDIUM (implementation delays, architectural inconsistencies)\n|HIGH (first DDD implementation)\n|• DDD training for development team (workshops, documentation) +\n• Architecture review sessions (validate bounded context design) +\n• Pair programming with experienced DDD practitioners +\n• Incremental implementation (start small, iterate) +\n• Document architectural patterns in CLAUDE.md\n\n|===\n\n== Assumptions and Constraints\n\n=== Assumptions\n\n[width=\"100%\",cols=\"8%,92%\",options=\"header\",]\n|===\n|ID |Assumption\n\n|ASM-CS-001\n|Viva Energy Salesforce admin team will provide Salesforce production access, sandbox environment, and support for Case field mapping and data isolation configuration\n\n|ASM-CS-002\n|App database Contact data is sufficiently complete for migration (email/phone/VCI available for matching)\n\n|ASM-CS-003\n|Expected customer feedback volume (100-150 submissions/day from 20k DAU) is well within Salesforce API rate limits, with capacity planning for 3x-10x growth\n\n|ASM-CS-004\n|Existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis) is sufficient for Event Bus implementation (no additional infrastructure provisioning required)\n\n|ASM-CS-005\n|Braze integration already exists and can be extended for Case-related push notifications (no new Braze account or major configuration changes)\n\n|ASM-CS-006\n|Mobile App users have email addresses associated with their accounts (required for ProfileService Contact reconciliation)\n\n|ASM-CS-007\n|D365 Customer Engagement historical Cases have limited business value and do not require migration to Salesforce\n\n|ASM-CS-008\n|Support agents are trained on Salesforce Service Cloud and require minimal additional training for OTR digital customer Cases\n\n|ASM-CS-009\n|Salesforce Service Cloud shared instance has capacity for OTR digital customer Contacts and Cases (no additional licensing or storage costs)\n\n|ASM-CS-010\n|Mobile App release schedule can accommodate cutover timing (Week 10 in migration plan)\n\n|===\n\n=== Constraints\n\n[width=\"100%\",cols=\"8%,92%\",options=\"header\",]\n|===\n|ID |Constraint\n\n|CON-CS-001\n|Must use shared Viva Energy Salesforce Service Cloud instance (cannot deploy separate OTR-specific instance)\n\n|CON-CS-002\n|Must conform to existing Salesforce configuration and governance (Record Types, custom fields, queues, data isolation strategy defined by Viva Energy admin team)\n\n|CON-CS-003\n|Contact migration must complete before Mobile App cutover (no parallel run of D365 CE and Salesforce)\n\n|CON-CS-004\n|Big bang cutover only (no phased rollout with feature flags or pilot users)\n\n|CON-CS-005\n|Salesforce API rate limits and authentication method constrained by Viva Energy Salesforce configuration (TBD)\n\n|CON-CS-006\n|Event Bus implementation must use existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis - cannot introduce new infrastructure components)\n\n|CON-CS-007\n|Mobile App feedback form must include specific fields: Category, Store Name, Time of Visit, Contact Phone Number, Free Text Message (no attachments)\n\n|CON-CS-008\n|D365 Customer Engagement must be decommissioned within 90 days post-cutover (ADR-CS-006)\n\n|CON-CS-009\n|ProfileService and EngagementService must be stateless (no local aggregate persistence, Salesforce is System of Record)\n\n|CON-CS-010\n|First DDD bounded context implementation (team learning curve, architectural patterns must be documented for future bounded contexts)\n\n|===\n\n== Non-Functional Requirements\n\n=== Performance Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-PERF-001\n|Mobile App feedback submission API response time (ProfileService + EngagementService)\n|p95 < 1 second, p99 < 2 seconds\n\n|NFR-PERF-002\n|ProfileService Contact reconciliation API response time (JIT lookup)\n|p95 < 500ms, p99 < 1 second\n\n|NFR-PERF-003\n|EngagementService async Case creation latency (end-to-end: feedback submitted → Case created in Salesforce)\n|p95 < 5 minutes, p99 < 10 minutes\n\n|NFR-PERF-004\n|Salesforce API call latency (Contact query, Contact create, Case create)\n|p95 < 2 seconds, p99 < 5 seconds\n\n|NFR-PERF-005\n|Event Bus message processing throughput\n|> 100 messages/second (support peak feedback volume)\n\n|NFR-PERF-006\n|Braze push notification delivery latency (Case created → notification delivered)\n|p95 < 30 seconds, p99 < 60 seconds\n\n|===\n\n=== Availability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-AVAIL-001\n|ProfileService availability\n|99.9% uptime (8.76 hours downtime/year)\n\n|NFR-AVAIL-002\n|EngagementService availability\n|99.9% uptime (8.76 hours downtime/year)\n\n|NFR-AVAIL-003\n|Feedback submission success rate (including async Case creation)\n|> 99.5% (includes retry logic for transient failures)\n\n|NFR-AVAIL-004\n|Graceful degradation: Salesforce downtime handling\n|Feedback submission still succeeds, Cases queued for async creation when Salesforce recovers\n\n|NFR-AVAIL-005\n|Graceful degradation: Braze downtime handling\n|Case creation proceeds, push notifications disabled temporarily (feature flag)\n\n|NFR-AVAIL-006\n|Planned maintenance window\n|< 4 hours/month, scheduled during low-traffic periods (2-6am ACST)\n\n|===\n\n=== Scalability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-SCALE-001\n|Concurrent Mobile App users (peak)\n|Support 20,000 DAU (Daily Active Users), ~150 concurrent users submitting feedback during peak hours\n\n|NFR-SCALE-002\n|Feedback submissions per day\n|Expected: 100-150 submissions/day based on 20k DAU (~0.5-0.75% submission rate) +\nCapacity: Support 500 submissions/day (3x expected volume for growth), 2,000 submissions/day (peak/incident scenarios)\n\n|NFR-SCALE-003\n|Auto-scaling: ProfileService and EngagementService\n|Auto-scale based on CPU/memory/request rate, scale up within 2 minutes\n\n|NFR-SCALE-004\n|Event Bus queue capacity\n|Support 100,000 queued messages (buffer for Salesforce downtime)\n\n|NFR-SCALE-005\n|Salesforce API rate limit compliance\n|Stay within 80% of Salesforce API rate limits (buffer for spikes)\n\n|NFR-SCALE-006\n|Future growth capacity\n|Architecture supports 10x growth (1,000-1,500 submissions/day based on 200k DAU) without major redesign\n\n|===\n\n=== Security Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-SEC-001\n|Mobile App authentication\n|Microsoft Entra External ID OAuth 2.0 with JWT tokens (existing CIAM)\n\n|NFR-SEC-002\n|API authorisation: ProfileService and EngagementService\n|JWT token validation, authenticated users only, user context propagation\n\n|NFR-SEC-003\n|Salesforce API authentication\n|OAuth 2.0 with Connected App and JWT bearer flow (service account)\n\n|NFR-SEC-004\n|Data encryption in transit\n|TLS 1.2+ for all API calls (Mobile App ↔ ProfileService/EngagementService ↔ Salesforce ↔ Braze)\n\n|NFR-SEC-005\n|Data encryption at rest\n|Salesforce encryption at rest (managed by Salesforce), Event Bus message encryption (AWS KMS)\n\n|NFR-SEC-006\n|Secret management\n|AWS Secrets Manager for Salesforce credentials, Braze API keys, OAuth tokens (no hardcoded secrets)\n\n|NFR-SEC-007\n|PII data handling\n|Contact data (email, phone, name) treated as PII, GDPR-compliant retention policies (Salesforce governance)\n\n|NFR-SEC-008\n|API rate limiting and throttling\n|API Gateway rate limiting (100 requests/second per user), prevent abuse and DoS\n\n|NFR-SEC-009\n|Logging and auditing\n|Log all API calls, Salesforce Contact/Case creates/updates, Event Bus publishes (no PII in logs)\n\n|NFR-SEC-010\n|Salesforce data isolation\n|Multi-tenant data isolation via Salesforce Record Types, queues, sharing rules (defined by Viva Energy admin team)\n\n|===\n\n=== Reliability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-REL-001\n|Retry logic: EngagementService → Salesforce Case creation\n|Exponential backoff (1s, 2s, 4s, 8s, 16s), max 5 retries, then dead letter queue\n\n|NFR-REL-002\n|Dead letter queue monitoring\n|Alert ops team immediately when DLQ depth > 0 (failed Case creations require manual intervention)\n\n|NFR-REL-003\n|Event Bus message durability\n|Messages persisted in Event Bus (SNS+SQS/EventBridge/Kinesis), not lost on service restart\n\n|NFR-REL-004\n|Idempotency: Case creation\n|EngagementService ensures duplicate feedback submissions don't create duplicate Cases (idempotency key)\n\n|NFR-REL-005\n|Circuit breaker: Salesforce API calls\n|Open circuit after 5 consecutive failures, half-open retry after 30 seconds\n\n|NFR-REL-006\n|Health checks: ProfileService and EngagementService\n|Health endpoints for load balancer checks, readiness and liveness probes\n\n|NFR-REL-007\n|Disaster recovery: Event Bus\n|Event Bus messages replicated across AWS availability zones (SQS/EventBridge/Kinesis HA)\n\n|===\n\n=== Maintainability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-MAINT-001\n|Code quality: ProfileService and EngagementService\n|> 80% test coverage (unit + integration tests), automated CI/CD pipeline\n\n|NFR-MAINT-002\n|API documentation\n|OpenAPI/Swagger specs for ProfileService and EngagementService, auto-generated API docs\n\n|NFR-MAINT-003\n|Deployment automation\n|Infrastructure as Code (Terraform/CloudFormation/CDK), zero-downtime deployments\n\n|NFR-MAINT-004\n|Logging: structured logs\n|JSON-formatted logs with correlation IDs, log levels (DEBUG, INFO, WARN, ERROR), centralized log aggregation\n\n|NFR-MAINT-005\n|Monitoring dashboards\n|Real-time dashboards for ProfileService, EngagementService, Event Bus (see Monitoring and Observability section)\n\n|NFR-MAINT-006\n|Alerting and on-call\n|PagerDuty/Opsgenie integration for P1/P2 alerts, on-call rotation for ops team\n\n|NFR-MAINT-007\n|Configuration management\n|Externalized configuration (environment variables, AWS Parameter Store), no hardcoded config\n\n|NFR-MAINT-008\n|Versioning: API and events\n|Semantic versioning (v1, v2), backward compatibility for API changes, event schema evolution\n\n|===\n\n=== Usability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-USE-001\n|Feedback submission UX\n|Mobile App user receives immediate \"Feedback submitted\" confirmation (< 1 second), not blocked by async Case creation\n\n|NFR-USE-002\n|Push notification delivery\n|Customer receives \"Your feedback has been received\" notification within 30 seconds of Case creation in Salesforce\n\n|NFR-USE-003\n|Case resolution notification\n|Customer receives \"Your case has been resolved\" notification within 30 seconds of support agent resolving Case\n\n|NFR-USE-004\n|Error messaging\n|User-friendly error messages for failed feedback submission (not technical errors), retry prompts\n\n|NFR-USE-005\n|Accessibility\n|Mobile App feedback form meets WCAG 2.1 AA accessibility standards (existing Mobile App compliance)\n\n|===\n\n=== Compliance Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-COMP-001\n|GDPR compliance: PII data\n|Customer Contact data (email, phone, name) managed per GDPR retention policies (Salesforce governance)\n\n|NFR-COMP-002\n|GDPR compliance: Right to erasure\n|Support \"Delete Account\" feedback category, trigger Contact deletion in Salesforce per GDPR Article 17\n\n|NFR-COMP-003\n|Data residency\n|Salesforce data residency governed by Viva Energy Salesforce configuration (regional compliance)\n\n|NFR-COMP-004\n|Audit trail\n|All Contact creates/updates, Case creates/updates logged for compliance auditing (Salesforce audit logs)\n\n|NFR-COMP-005\n|API security standards\n|OWASP API Security Top 10 compliance (injection prevention, authentication, authorisation, data exposure)\n\n|===\n\n== Monitoring and Observability\n\n=== Key Metrics\n\n[width=\"100%\",cols=\"25%,40%,35%\",options=\"header\",]\n|===\n|Metric Category |Metric |Target/Threshold\n\n|*Feedback Submission*\n|Feedback submission success rate (Mobile App → EngagementService)\n|> 99.5%\n\n|*Async Case Creation*\n|Case creation success rate (EngagementService → Salesforce)\n|> 99%\n\n|*Async Case Creation*\n|Case creation latency (time from feedback submission to Case created in Salesforce)\n|p95 < 5 minutes\n\n|*Event Bus*\n|Event Bus queue depth (pending Case creations)\n|< 100 messages\n\n|*Event Bus*\n|Dead letter queue depth (failed Case creations)\n|= 0 (alert on any failures)\n\n|*Salesforce API*\n|Salesforce API error rate\n|< 1%\n\n|*Salesforce API*\n|Salesforce API latency (Case creation)\n|p95 < 2 seconds\n\n|*Salesforce API*\n|Salesforce API rate limit utilization\n|< 80% of limit\n\n|*ProfileService*\n|Contact reconciliation success rate (JIT lookups)\n|> 99.5%\n\n|*ProfileService*\n|Contact reconciliation latency\n|p95 < 500ms\n\n|*Braze Notifications*\n|Push notification delivery rate (Case created/updated)\n|> 95%\n\n|*Salesforce Webhook*\n|Webhook delivery success rate (Salesforce → EngagementService)\n|> 99%\n\n|*Customer Satisfaction*\n|Customer satisfaction score (CSAT)\n|> 4.0/5.0 (improve by 15% from D365 CE baseline)\n\n|*Support Operations*\n|Average case resolution time\n|Decrease by 20% from D365 CE baseline\n\n|===\n\n=== Alerting Thresholds\n\n[width=\"100%\",cols=\"25%,50%,25%\",options=\"header\",]\n|===\n|Alert |Condition |Severity\n\n|*Feedback submission failures*\n|Feedback submission success rate < 95% over 5-minute window\n|P1 - Critical\n\n|*Dead letter queue accumulation*\n|Dead letter queue depth > 0 (any failed Case creations)\n|P2 - High\n\n|*Event Bus queue backlog*\n|Event Bus queue depth > 100 messages for > 15 minutes\n|P2 - High\n\n|*Salesforce API errors*\n|Salesforce API error rate > 5% over 5-minute window\n|P1 - Critical\n\n|*Salesforce API rate limits*\n|Salesforce API rate limit utilization > 90%\n|P2 - High\n\n|*Contact reconciliation failures*\n|ProfileService Contact reconciliation failure rate > 5% over 5-minute window\n|P2 - High\n\n|*Braze notification failures*\n|Braze push notification delivery rate < 80% over 15-minute window\n|P3 - Medium\n\n|*Salesforce webhook failures*\n|Salesforce webhook delivery success rate < 90% over 15-minute window\n|P2 - High\n\n|*Case creation latency*\n|Case creation latency p95 > 10 minutes\n|P3 - Medium\n\n|===\n\n=== Dashboards\n\n*ProfileService Dashboard:*\n\n* Contact reconciliation success rate (JIT lookups)\n* Contact reconciliation latency (p50, p95, p99)\n* Contact creation vs update ratio (new Contacts created vs existing Contacts updated)\n* Salesforce API error rate (Contact queries and creates)\n* Request rate and throughput\n\n*EngagementService Dashboard:*\n\n* Feedback submission success rate\n* Case creation success rate (async workflow)\n* Case creation latency (p50, p95, p99)\n* Event Bus queue depth (pending Case creations)\n* Dead letter queue depth (failed Case creations)\n* Salesforce API error rate (Case creation)\n* Salesforce API latency\n* Salesforce API rate limit utilization\n* Braze push notification delivery rate\n* Salesforce webhook delivery success rate\n\n*Event Bus Dashboard:*\n\n* Queue depth (pending messages)\n* Throughput (messages published/consumed per minute)\n* Dead letter queue depth (failed messages)\n* Consumer lag (time between publish and consume)\n\n*Customer Support Dashboard (Business Metrics):*\n\n* Total feedback submissions per day/week/month\n* Feedback category breakdown (App, Service, Order, Rewards, Refund, Delete Account)\n* Customer satisfaction score (CSAT) trend\n* Average case resolution time trend\n* Case volume by support team/queue\n* Unified customer view adoption (support agent feedback)\n<<<\n== Solution Validation\n\nThis section defines the validation criteria and testing approach for the solution.\n\n=== Functional Validation\n\n==== ProfileService API Testing\n\n*Test Scenarios*:\n1. **Happy Path**: Authenticated user requests Contact ID, existing Contact found in Salesforce, Contact ID returned\n2. **JIT Creation**: Authenticated user requests Contact ID, no existing Contact, new Contact created in Salesforce, Contact ID returned\n3. **Salesforce API Failure**: Salesforce unavailable, ProfileService returns 500 error, user retries\n4. **Invalid JWT**: Unauthenticated request, ProfileService returns 401 error\n\n*Acceptance Criteria*:\n- Contact reconciliation success rate > 99.5%\n- JIT Contact creation completes within 500ms (p95)\n\n==== EngagementService API Testing\n\n*Test Scenarios*:\n1. **Happy Path**: Valid feedback submission, immediate 202 Accepted response, Case created in Salesforce within 5 minutes, Braze notification delivered\n2. **Invalid Category**: Invalid feedback category, 400 Bad Request response with validation error\n3. **Salesforce Downtime**: Salesforce unavailable during async Case creation, message queued, retry logic executes, Case created when Salesforce recovers\n4. **Dead Letter Queue**: Case creation fails after 5 retries, message moved to DLQ, ops team alerted\n5. **Webhook Notification**: Support agent resolves Case in Salesforce, webhook triggers EngagementService, Braze push notification sent to customer\n\n*Acceptance Criteria*:\n- Feedback submission success rate > 99.5% (including async Case creation)\n- Async Case creation completes within 5 minutes (p95)\n- Webhook delivery success rate > 99%\n\n=== Non-Functional Validation\n\n==== Performance Testing\n\n*Load Testing*:\n\n*Baseline*: Expected 100-150 submissions/day from 20k DAU (~0.5-0.75% submission rate)\n\n- **Normal Load**: 1 submission/minute sustained for 2 hours (simulate typical daily pattern)\n- **3x Load**: 3 submissions/minute sustained for 1 hour (simulate busy period, 450 submissions/day)\n- **Peak Load (10x)**: 10 submissions/minute for 15 minutes (simulate incident scenario, app outage causing backlog)\n- **Stress Test**: 50 submissions/minute for 5 minutes (find breaking point, 20x normal)\n\n*Validation*:\n- API response time p95 < 1 second under 10x load\n- Event Bus queue depth remains manageable (< 100 messages)\n- No Case creation failures, all submissions processed successfully\n- Auto-scaling triggers appropriately for sustained load > 3x baseline\n\n*Acceptance Criteria*:\n- NFR-PERF-001 through NFR-PERF-006 validated under realistic load (3x and 10x baseline)\n- Auto-scaling triggers within 2 minutes of load increase\n- System handles 10x peak gracefully, 20x stress test identifies limits\n\n==== Resilience Testing\n\n*Salesforce API Failure Scenarios*:\n1. **Complete Outage**: Salesforce unavailable for 2 hours, Event Bus queues buffer work, Cases created when Salesforce recovers\n2. **Rate Limit Exceeded**: Salesforce rate limit hit, queue throttling activates, Cases created within SLA\n\n*Acceptance Criteria*:\n- NFR-AVAIL-004 validated (graceful degradation during Salesforce downtime)\n- Circuit breaker activates after 5 consecutive failures\n\n==== Security Validation\n\n*Penetration Testing*:\n- API authentication bypass attempts\n- SQL injection attempts\n- Webhook signature validation bypass\n\n*Acceptance Criteria*:\n- NFR-SEC-001 through NFR-SEC-010 validated\n- OWASP API Security Top 10 compliance verified\n\n=== Integration Validation\n\n==== End-to-End Testing\n\n*Full User Journey*:\n1. User authenticates via Microsoft Entra External ID\n2. Mobile App requests Contact ID from ProfileService (JIT reconciliation)\n3. User submits feedback via EngagementService\n4. Background worker creates Case in Salesforce\n5. Braze notification delivered to user\n6. Support agent resolves Case in Salesforce\n7. Salesforce webhook triggers EngagementService\n8. Braze notification delivered to user\n\n*Acceptance Criteria*:\n- End-to-end flow completes successfully in UAT\n- User receives both \"feedback submitted\" and \"case resolved\" notifications\n","structuredPatch":[{"oldStart":1661,"oldLines":6,"newStart":1661,"newLines":7,"lines":[" * Unit test coverage > 80%"," * Integration tests pass with Salesforce sandbox and Braze staging environment"," ","+[[wp-cs-003]]"," === WP-CS-003: Event Bus Infrastructure"," "," ==== Description"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"555f081d-5003-40a8-870a-d278039b28d2"}
{"parentUuid":"8fbea35b-b0bc-42f9-be33-d8757a5ecc76","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_014oSKkcQhHxTkf7PTG7ZgXA","type":"tool_result","content":"The file /mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n  1722→* CloudEvents 1.0 schema validation enabled\n  1723→* Monitoring dashboards operational\n  1724→* Infrastructure fully codified (IaC)\n  1725→\n  1726→[[wp-cs-004]]\n  1727→=== WP-CS-004: Contact Migration Tooling\n  1728→\n  1729→==== Description\n  1730→\n  1731→Develop Contact migration tool for one-time migration from app-specific database to Salesforce Service Cloud with upsert logic and validation.\n  1732→\n  1733→==== Deliverables"}]},"uuid":"1927858d-d7a8-4dab-9f23-d1637ef9c8fb","timestamp":"2026-01-09T03:10:45.391Z","toolUseResult":{"filePath":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","oldString":"=== WP-CS-004: Contact Migration Tooling\n\n==== Description","newString":"[[wp-cs-004]]\n=== WP-CS-004: Contact Migration Tooling\n\n==== Description","originalFile":"= Salesforce Customer Support - Solution Architecture\n:project-name: Salesforce Customer Support\n:togaf-adm-phase: Phase E: Opportunities & Solutions\n:last-updated: 2026-01-07\n:document-type: Solution Architecture Document\n:status: Discovery\n:version: 0.1\n:domain: Customer Support & Engagement\n:programme-lead:\n:domain-architect: O.Young@otr.com.au\n:architecture-definition: xref:architecture-definitions:salesforce_customer_support.adoc[Architecture Definitions/Salesforce Customer Support]\n:doctype: article\n:toc: left\n:toclevels: 4\n:sectanchors:\n:sectlinks:\n:sectnums:\n:icons: font\n:source-highlighter: highlightjs\n:experimental:\n:description:\n:keywords:\n\n<<<\n== Purpose and Scope\n\n=== Purpose\n\nThis Solution Architecture defines how the Salesforce Customer Support consolidation will be implemented - the specific technology products, configurations, interfaces, and deployment architecture that realise the xref:architecture-definitions:salesforce_customer_support.adoc[Salesforce Customer Support Architecture Definition].\n\nThis solution establishes the **first implementation of OTR's target Domain-Driven Design (DDD) architecture** by deploying two new bounded contexts (`ProfileService` and `EngagementService`) as microservices, consolidating customer support onto Salesforce Service Cloud, and implementing event-driven integration patterns that will serve as the foundation for future bounded contexts (including Flybuys integration).\n\n=== Vision\n\n> Unify customer support across all OTRG channels by consolidating OTR digital customer feedback onto Salesforce Service Cloud, establishing the foundational DDD architecture with ProfileService and EngagementService bounded contexts that protect digital channels from external system changes while enabling support agents to deliver exceptional customer experiences with complete interaction history.\n\n=== Architectural Approach\n\nThis architecture establishes OTR's **first bounded context implementation** using Domain-Driven Design strategic patterns:\n\n* *link:../bounded_context/profile.adoc[ProfileService]* (NEW bounded context): Just-In-Time Contact reconciliation with Salesforce, upsert by email, returns Salesforce Contact ID to digital channels - foundation for future Flybuys partner linking\n* *link:../bounded_context/engagement.adoc[EngagementService]* (NEW bounded context): Customer feedback submission facade, Anti-Corruption Layer for Salesforce Case creation, Braze integration for all outbound customer communications (push, email, SMS), async Case processing via Event Bus\n* *Event-driven integration* (NEW pattern): Domain event publishing using existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis) - first implementation establishing pattern for future bounded contexts\n* *Anti-Corruption Layer*: EngagementService isolates digital channels from Salesforce API changes, translates between OTR domain language and Salesforce Service Cloud API\n* *Conformist Pattern*: ProfileService and EngagementService conform to existing Salesforce configuration (shared Viva Energy instance, multi-tenant governance)\n* *Big bang cutover*: Single deployment after Contact migration, no phased rollout, D365 CE retirement post-cutover\n\n=== Scope\n\n==== In Scope\n\n* Solution Building Blocks (SBBs) - specific technology products and versions\n* Interface specifications (APIs, events, data formats)\n* Data architecture and schema specifications\n* Deployment architecture and infrastructure configuration\n* Transition architecture with migration phases\n* Technical validation criteria and testing approach\n* External system integration specifications\n* Physical data models and API schemas\n\n==== Out of Scope\n\n===== Covered in xref:architecture-definitions:salesforce_customer_support.adoc[Architecture Definition]\n\n* Business requirements and stakeholder analysis\n* Architecture decisions and rationale (ADRs)\n* Bounded context definitions and responsibilities\n* High-level integration patterns (ACL, Conformist, OHS+PL)\n* Business capability mapping and value streams\n* Architecture principles and governance\n\n===== Covered in Other Documents\n\n* Detailed design (class diagrams, sequence diagrams for all flows)\n* Implementation code and unit tests\n* Business case and return-on-investment analysis\n* Operational run books and support procedures\n\n<<<\n=== Architecture Overview\n\n[mermaid]\n----\n---\nconfig:\n  layout: elk\n---\nflowchart TB\n    Customer([\"Customer\"]) -- Uses --> MobileApp[\"Mobile App<br>iOS/Android\"]\n    Customer -- Shops at --> POS[\"OTR/OTR+ POS<br>D365 Commerce\"]\n    MobileApp -- Authenticate --> EntraID[\"Microsoft Entra\"]\n    MobileApp -- Identifies & Reconciles --> ProfileService[\"ProfileService\"]\n    ProfileService <-- Reconcile App User as Salesforce Contact --> Salesforce[\"Salesforce\"]\n    ProfileService -- On Create --> EventBus[\"EventBus\"]\n    EventBus -- Emits CreateUser Event --> LoyaltyService[\"LoyaltyService\"] & EngagementService[\"EngagementService\"]\n    LoyaltyService -- Reconcile Wallet --> EagleEye[\"EagleEye\"]\n    EngagementService -- Reconcile Braze Profile --> Braze[\"Braze\"]\n    EngagementService --> Salesforce\n    D365CE[\"D365CE\"] -- Data Migration --> Salesforce\n    MobileApp -- Submits Feedback --> EngagementService\n\n    Customer:::customer\n    MobileApp:::presentation\n    POS:::presentation\n    EntraID:::external\n    ProfileService:::newService\n    Salesforce:::external\n    EventBus:::infrastructure\n    LoyaltyService:::newService\n    EngagementService:::newService\n    EagleEye:::external\n    Braze:::external\n    D365CE:::external\n    classDef newService fill:#4CAF50,stroke:#2E7D32,stroke-width:3px,color:#fff\n    classDef external fill:#FF9800,stroke:#E65100,stroke-width:2px,color:#fff\n    classDef infrastructure fill:#2196F3,stroke:#0D47A1,stroke-width:2px,color:#fff\n    classDef presentation fill:#9C27B0,stroke:#4A148C,stroke-width:2px,color:#fff\n    classDef customer fill:#607D8B,stroke:#263238,stroke-width:2px,color:#fff\n----\n\n\n==== Key Architectural Patterns\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Pattern |Application |Rationale\n\n|*Anti-Corruption Layer (ACL)*\n|EngagementService → Salesforce Service Cloud\n|Protects digital channels (Mobile App, Web) from Salesforce API changes, translates between OTR domain language and Salesforce Case/Contact model, enables independent evolution of internal domain model\n\n|*Conformist*\n|ProfileService → Salesforce, EngagementService → Salesforce\n|Shared Viva Energy Salesforce instance - we conform to existing configuration, governance, and API contracts (external system we don't control)\n\n|*Backend-for-Frontend (BFF)*\n|EngagementService\n|Aggregates customer feedback submission, Contact lookup, async Case creation, and Braze notification orchestration for digital channel clients\n\n|*Event-Driven Architecture (OHS+PL)*\n|Event Bus (SNS+SQS/EventBridge/Kinesis)\n|Loose coupling between bounded contexts, async domain event publishing (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`), foundation for future bounded contexts\n\n|*Just-In-Time (JIT) Integration*\n|ProfileService → Salesforce Contact reconciliation\n|Reconcile app users as Salesforce Contacts on-demand (upsert by email), no pre-sync required, ensures Salesforce has current Contact data\n\n|*Async Processing*\n|EngagementService Case creation via Event Bus\n|Non-blocking user experience, resilience to Salesforce downtime, automatic retry with exponential backoff, dead letter queue for operations team intervention\n\n|*Strangler Fig*\n|Not applicable\n|Big bang cutover (no gradual migration) - D365 CE fully replaced, not incrementally strangled\n\n|===\n\n<<<\n== Solution Approach\n\n* Deploy xref:bounded-contexts:profile.adoc[ProfileService] and xref:bounded-contexts:engagement.adoc[EngagementService] as bounded context microservices\n* Implement Anti-Corruption Layers (ACLs) for Salesforce and Braze integration\n* Establish event-driven architecture as the foundational integration pattern\n* Big bang cutover (TS-1 → TS-4)\n\n=== Related Documentation\n\nThis solution architecture references detailed technical specifications:\n\n==== Architecture Definition\n\n* xref:architecture-definitions:salesforce_customer_support.adoc[Salesforce Customer Support - Architecture Definition] - Business requirements, architecture decisions (ADRs), bounded context definitions, high-level integration patterns\n\n==== Bounded Context Specifications\n\n* xref:bounded-contexts:profile.adoc[ProfileService Bounded Context] - JIT Contact reconciliation, aggregate definitions\n* xref:bounded-contexts:engagement.adoc[EngagementService Bounded Context] - Customer feedback facade, Anti-Corruption Layer\n\n==== Interface Specifications\n\nDetailed API specifications available in the specifications directory:\n\n* link:../../specifications/rest/profile-service-v1.yaml[ProfileService REST API v1] - OpenAPI 3.0 specification for `/profile/v1` endpoints (includes Salesforce Contact reconciliation `GET /contact-id`)\n* link:../../specifications/rest/engagement-service-v1.yaml[EngagementService REST API v1] - OpenAPI 3.0 specification for `/engagement/v1` endpoints (includes `POST /feedback`)\n* link:../../specifications/events/engagement-events.json[Engagement Domain Events] - CloudEvents 1.0 JSON Schema for `SupportCaseCreated`, `SupportCaseUpdated`, `SupportCaseResolved`, `CustomerFeedbackSubmitted`\n\n==== External System Documentation\n\n* https://developer.salesforce.com/docs/atlas.en-us.api_rest.meta/api_rest/[Salesforce REST API Documentation] - Contact and Case object APIs\n* https://www.braze.com/docs/api/endpoints/messaging/send_messages/post_send_triggered_campaigns/[Braze Campaign Trigger API] - Push notification campaigns\n\n<<<\n== Executive Summary\n\n=== Challenge\n\nOTR digital customers (Mobile App, Web) currently submit feedback and support requests to D365 Customer Engagement, while Viva Energy's broader business units (fuel wholesale, Shell Card customers, other retail channels) use Salesforce Service Cloud. This creates:\n\n* *Fragmented customer support platform*: Customer support data split across two systems, preventing support agents from having a unified view of customer interactions across all channels\n* *Operational inefficiency*: Maintaining two separate customer support platforms increases operational overhead and costs\n* *Poor support experience*: D365 CE is not working well for digital customer support, impacting customer satisfaction and case resolution times\n* *Post-merger consolidation opportunity*: Following Viva Energy's acquisition of OTR, strategic alignment on Salesforce as the enterprise customer support platform\n\n=== Solution\n\nThis architecture establishes the **foundational Domain-Driven Design (DDD) implementation** for OTR's target state architecture by introducing two new bounded contexts (link:../bounded_context/profile.adoc[ProfileService], link:../bounded_context/engagement.adoc[EngagementService]) and event-driven integration patterns:\n\n==== New Bounded Contexts\n\n* *link:../bounded_context/profile.adoc[ProfileService]* (NEW): Just-In-Time (JIT) Contact reconciliation with Salesforce, upsert by email, returns Salesforce Contact ID to Mobile App\n* *link:../bounded_context/engagement.adoc[EngagementService]* (NEW): Customer feedback submission, Anti-Corruption Layer (ACL) for Salesforce Case creation, Braze integration for all outbound customer communications (push, email, SMS), async Case processing via Event Bus\n* *Event Bus* (NEW pattern): Domain event publishing using existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis) - first implementation of event-driven architecture pattern\n\n==== Integration Architecture\n\n* *Salesforce = System of Record*: Salesforce Service Cloud (shared Viva Energy instance) owns Contact and Case data\n* *Conformist Pattern*: ProfileService and EngagementService conform to existing Salesforce configuration and API contracts\n* *Anti-Corruption Layer*: EngagementService protects digital channels from Salesforce API changes, translates between OTR domain language and Salesforce\n* *Async Case Creation*: Non-blocking user experience, resilience to Salesforce downtime, automatic retry with exponential backoff, dead letter queue for failed Cases\n* *Event-Driven Notifications*: Salesforce webhook → EngagementService → Braze for all customer communications (push, email, SMS) on Case status updates\n\n==== Migration Approach\n\n* *Contact Migration*: One-time migration from app-specific database → Salesforce (upsert with flexible matching by email/phone/VCI)\n* *No Case Migration*: Historical D365 CE Cases not migrated (fresh start in Salesforce)\n* *Big Bang Cutover*: Single deployment, no phased rollout or parallel run\n* *D365 CE Retirement*: Complete decommissioning of D365 Customer Engagement post-cutover\n\n=== Key Architectural Significance\n\nThis migration establishes the first implementation of OTR's target DDD architecture:\n\n* First bounded contexts implemented (ProfileService, EngagementService)\n* First event-driven domain event pattern (foundation for future bounded contexts)\n* Foundation for Flybuys integration (ProfileService Contact reconciliation reused)\n* Establishes integration patterns (Conformist, ACL, Event-Driven) for future services\n\n=== Success Criteria\n\n* All digital customer feedback routed to Salesforce Service Cloud within 30 days of launch\n* Support agents have unified customer view across all Viva Energy channels (digital, wholesale, Shell Card, other retail)\n* D365 Customer Engagement decommissioned within 90 days post-cutover\n* Customer satisfaction score improves by 15% within 6 months\n* Average case resolution time decreases by 20% within 6 months\n* Zero data loss during Contact migration (100% validation pass rate)\n* Mobile App feedback submission success rate > 99.5% (including async Case creation)\n\n=== Technical Constraints\n\n* Shared Salesforce instance (Viva Energy multi-tenant environment)\n* Conform to existing Salesforce configuration and governance (data isolation strategy TBD with Salesforce admin team)\n* Contact migration must complete before cutover (no parallel run)\n* Async Case creation mandatory (non-blocking user experience)\n* Expected volume: 100-150 feedback submissions/day from 20k DAU (~0.5-0.75% submission rate), architecture capacity planned for 3x-10x growth\n\n=== Open Technical Decisions (TBD)\n\n* Salesforce Case field mapping for digital feedback categories (App, Service, Order, Rewards, Refund, Delete Account)\n* Salesforce data isolation strategy (Record Types, custom fields, queues)\n* Salesforce REST API authentication method (OAuth 2.0, Connected App, JWT bearer flow)\n* Salesforce webhook mechanism for Case updates (Outbound Messages, Platform Events, Process Builder)\n* Retry policy configuration (attempts, backoff intervals)\n* Salesforce API rate limit strategy (expected volume: 100-150 submissions/day from 20k DAU, capacity planning for 3x-10x growth)\n\n== Technical Requirements\n\n[width=\"100%\",cols=\"8%,92%\",options=\"header\",]\n|===\n|ID |Description\n\n|TR-CS-001\n|Every Mobile App user must have a Salesforce Contact record in Salesforce Service Cloud (shared Viva Energy instance)\n\n|TR-CS-002\n|ProfileService must reconcile Mobile App users as Salesforce Contacts using Just-In-Time (JIT) upsert by email address\n\n|TR-CS-003\n|ProfileService must return Salesforce Contact ID to Mobile App for feedback submission\n\n|TR-CS-004\n|Mobile App must support customer feedback submission with fields: Category (App, Service, Order, Rewards, Refund, Delete Account), Store Name, Time of Visit, Contact Phone Number, Free Text Message\n\n|TR-CS-005\n|EngagementService must create Salesforce Cases asynchronously via Event Bus (non-blocking user experience)\n\n|TR-CS-006\n|EngagementService must acknowledge feedback submission immediately to Mobile App user (\"Feedback submitted\" confirmation)\n\n|TR-CS-007\n|EngagementService must send push notification to customer via Braze when Case is successfully created in Salesforce\n\n|TR-CS-008\n|EngagementService must retry failed Case creation with configurable exponential backoff and dead letter queue for operations team intervention\n\n|TR-CS-009\n|Salesforce must be the System of Record for Contact and Case data (no local persistence in ProfileService or EngagementService)\n\n|TR-CS-010\n|Contact migration from app-specific database to Salesforce must complete before Mobile App cutover (upsert with flexible matching by email/phone/VCI)\n\n|TR-CS-011\n|No Case migration from D365 Customer Engagement to Salesforce (fresh start, historical Cases not migrated)\n\n|TR-CS-012\n|EngagementService must publish domain events (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`) to Event Bus for consumption by other bounded contexts\n\n|TR-CS-013\n|EngagementService must receive Salesforce webhook notifications when Cases are updated/resolved by support agents\n\n|TR-CS-014\n|EngagementService must trigger Braze push notifications to customers when Cases are updated/resolved (via Salesforce webhook → EngagementService → Braze)\n\n|TR-CS-015\n|ProfileService and EngagementService must conform to existing Salesforce configuration and API contracts (Conformist pattern)\n\n|TR-CS-016\n|All changes must be communicated using event-driven architecture via Event Bus (using existing AWS infrastructure: SNS+SQS/EventBridge/Kinesis)\n\n|TR-CS-017\n|Mobile App feedback submission success rate must exceed 99.5% (including async Case creation completion)\n\n|TR-CS-018\n|Contact migration must achieve 100% validation pass rate (zero data loss)\n\n|TR-CS-019\n|D365 Customer Engagement must be fully decommissioned within 90 days post-cutover\n\n|===\n\n== Technical Architecture\n\n=== Technical Capability Requirements\n\n==== Requirements Traceability\n\n[width=\"100%\",cols=\"15%,50%,35%\",options=\"header\",]\n|===\n|Requirement ID |Requirement Summary |Architectural Building Blocks\n\n|TR-CS-001\n|Every Mobile App user must have Salesforce Contact record\n|ABB-CS-001 (ProfileService), ABB-CS-004 (Salesforce), ABB-CS-007 (Contact Migration Tool)\n\n|TR-CS-002\n|ProfileService JIT Contact reconciliation via upsert by email\n|ABB-CS-001 (ProfileService), ABB-CS-004 (Salesforce)\n\n|TR-CS-003\n|ProfileService returns Salesforce Contact ID to Mobile App\n|ABB-CS-001 (ProfileService), ABB-CS-006 (Mobile App)\n\n|TR-CS-004\n|Mobile App supports feedback submission with structured fields\n|ABB-CS-006 (Mobile App), ABB-CS-002 (EngagementService)\n\n|TR-CS-005\n|EngagementService creates Salesforce Cases asynchronously\n|ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus), ABB-CS-004 (Salesforce)\n\n|TR-CS-006\n|EngagementService immediate acknowledgment to Mobile App\n|ABB-CS-002 (EngagementService), ABB-CS-006 (Mobile App)\n\n|TR-CS-007\n|EngagementService sends push notification via Braze on Case creation\n|ABB-CS-002 (EngagementService), ABB-CS-005 (Braze)\n\n|TR-CS-008\n|EngagementService retry logic with exponential backoff and DLQ\n|ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus)\n\n|TR-CS-009\n|Salesforce is System of Record for Contact and Case data\n|ABB-CS-004 (Salesforce), ABB-CS-001 (ProfileService - stateless), ABB-CS-002 (EngagementService - stateless)\n\n|TR-CS-010\n|Contact migration before Mobile App cutover\n|ABB-CS-007 (Contact Migration Tool), ABB-CS-004 (Salesforce)\n\n|TR-CS-011\n|No Case migration from D365 CE (fresh start)\n|ABB-CS-004 (Salesforce) - no migration tooling required\n\n|TR-CS-012\n|EngagementService publishes domain events to Event Bus\n|ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus)\n\n|TR-CS-013\n|EngagementService receives Salesforce webhook notifications\n|ABB-CS-002 (EngagementService), ABB-CS-004 (Salesforce)\n\n|TR-CS-014\n|EngagementService triggers Braze notifications on Case updates\n|ABB-CS-002 (EngagementService), ABB-CS-004 (Salesforce), ABB-CS-005 (Braze)\n\n|TR-CS-015\n|ProfileService and EngagementService conform to Salesforce config\n|ABB-CS-001 (ProfileService), ABB-CS-002 (EngagementService), ABB-CS-004 (Salesforce)\n\n|TR-CS-016\n|Event-driven architecture via Event Bus\n|ABB-CS-003 (Event Bus), ABB-CS-002 (EngagementService)\n\n|TR-CS-017\n|Mobile App feedback submission success rate > 99.5%\n|ABB-CS-006 (Mobile App), ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus), ABB-CS-004 (Salesforce)\n\n|TR-CS-018\n|Contact migration 100% validation pass rate\n|ABB-CS-007 (Contact Migration Tool), ABB-CS-004 (Salesforce)\n\n|TR-CS-019\n|D365 CE decommissioned within 90 days post-cutover\n|All ABBs (replacement system operational)\n\n|===\n\n=== Service Catalogues\n\n==== Application Portfolio Catalogue\n\n[width=\"100%\",cols=\"20%,15%,15%,15%,35%\",options=\"header\",]\n|===\n|Application |Lifecycle State |Owner |Hosting Platform |Description\n\n|*ProfileService*\n|NEW\n|OTR Platform Team\n|AWS (TBD: Lambda/ECS/EKS)\n|JIT Contact reconciliation with Salesforce, returns Salesforce Contact ID, foundation for Flybuys integration\n\n|*EngagementService*\n|NEW\n|OTR Platform Team\n|AWS (TBD: Lambda/ECS/EKS)\n|Customer feedback submission facade, ACL for Salesforce Case creation, Braze integration for all outbound communications (push, email, SMS), webhook receiver\n\n|*Mobile App (iOS)*\n|ACTIVE (UPDATE)\n|OTR Mobile Team\n|Apple App Store\n|iOS native app with feedback form, integrate with ProfileService and EngagementService APIs\n\n|*Mobile App (Android)*\n|ACTIVE (UPDATE)\n|OTR Mobile Team\n|Google Play Store\n|Android native app with feedback form, integrate with ProfileService and EngagementService APIs\n\n|*Salesforce Service Cloud*\n|ACTIVE (EXPAND)\n|Viva Energy Salesforce Admin Team\n|Salesforce (SaaS)\n|Shared Viva Energy instance, System of Record for Contact and Case data, adding OTR digital customer support\n\n|*Braze*\n|ACTIVE (EXTEND)\n|OTR Marketing Team\n|Braze (SaaS)\n|Marketing automation platform, EngagementService triggers push notifications for Case updates\n\n|*D365 Customer Engagement*\n|RETIRE\n|OTR Support Team\n|Microsoft Azure (SaaS)\n|Legacy customer support platform, decommissioned within 90 days post-cutover\n\n|*App-Specific Customer Database*\n|RETIRE\n|OTR Platform Team\n|AWS (RDS/DynamoDB)\n|Legacy customer contact storage, one-time migration to Salesforce, then deprecated\n\n|*Event Bus*\n|NEW\n|OTR Platform Team\n|AWS (SNS+SQS/EventBridge/Kinesis)\n|Domain event publishing infrastructure for bounded context integration\n\n|*Contact Migration Tool*\n|TEMPORARY\n|OTR Platform Team\n|AWS (Script/Lambda)\n|One-time migration app database → Salesforce with upsert logic, retired after migration complete\n\n|===\n\n==== Technology Capability Requirements\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Technology Capability |Implementation Technology (TBD in detailed design) |Requirements\n\n|*Microservice Hosting*\n|AWS Lambda / ECS / EKS\n|Host ProfileService and EngagementService with auto-scaling, high availability, monitoring\n\n|*API Gateway*\n|AWS API Gateway / Application Load Balancer\n|REST API routing, authentication, rate limiting, request validation for ProfileService and EngagementService\n\n|*Event Bus*\n|AWS SNS+SQS / EventBridge / Kinesis\n|Domain event publishing, async message processing, retry logic, dead letter queue\n\n|*Salesforce Integration*\n|Salesforce REST API / SOAP API\n|Contact CRUD operations, Case creation, webhook notifications, OAuth 2.0 authentication\n\n|*Braze Integration*\n|Braze REST API / SDK\n|Push notification campaign triggers, customer profile reconciliation\n\n|*Authentication & Authorisation*\n|Microsoft Entra External ID / AWS Cognito\n|Mobile App user authentication, API authorisation, JWT token validation\n\n|*Observability & Monitoring*\n|AWS CloudWatch / Datadog / New Relic\n|Application metrics, logs, traces, dashboards, alerting (feedback submission rate, queue depth, API errors)\n\n|*Secret Management*\n|AWS Secrets Manager / Parameter Store\n|Salesforce credentials, Braze API keys, OAuth tokens, encryption keys\n\n|*Database (Migration Tool)*\n|AWS RDS / DynamoDB (read-only access)\n|Contact migration from app-specific database\n\n|*CI/CD Pipeline*\n|GitHub Actions / AWS CodePipeline\n|Automated build, test, deployment for ProfileService, EngagementService, Mobile App\n\n|*Infrastructure as Code*\n|Terraform / AWS CloudFormation / CDK\n|Declarative infrastructure provisioning for Event Bus, microservices, monitoring\n\n|*API Documentation*\n|OpenAPI / Swagger\n|ProfileService and EngagementService API specifications for Mobile App integration\n\n|===\n\n==== Feature Flag Register\n\n*Note*: Per ADR-CS-006 (big bang cutover, not phased rollout), feature flags are minimal and used primarily for emergency rollback/kill switches.\n\n[width=\"100%\",cols=\"20%,15%,35%,30%\",options=\"header\",]\n|===\n|Feature Flag |Default State |Purpose |Rollback Scenario\n\n|*enable_salesforce_feedback_submission*\n|OFF (pre-cutover), ON (post-cutover)\n|Enable/disable feedback submission to EngagementService → Salesforce (kill switch for emergency rollback to D365 CE)\n|Feedback submission success rate < 95%, Salesforce API failures, critical bugs - revert to D365 CE integration\n\n|*enable_async_case_creation*\n|ON\n|Enable/disable async Case creation via Event Bus (fallback to synchronous processing if Event Bus issues)\n|Event Bus infrastructure failures, queue backlog unmanageable - temporary synchronous processing\n\n|*enable_braze_notifications*\n|ON\n|Enable/disable Braze push notifications for Case updates (degrade gracefully if Braze integration fails)\n|Braze API failures, notification delivery rate < 80% - disable notifications temporarily\n\n|*enable_jit_contact_reconciliation*\n|ON\n|Enable/disable ProfileService JIT Contact reconciliation (fallback to cached Contact IDs if Salesforce unavailable)\n|Salesforce API downtime, Contact reconciliation failures > 5% - use cached Contact IDs temporarily\n\n|*enable_salesforce_webhook_processing*\n|ON\n|Enable/disable Salesforce webhook processing for Case updates (fallback to polling if webhook failures)\n|Webhook delivery failures, authentication issues - temporary polling fallback\n\n|===\n\n*Feature Flag Management*:\n\n* Feature flags managed via AWS AppConfig / LaunchDarkly / custom feature flag service (TBD in detailed design)\n* Mobile App feature flags controlled server-side (no app release required for flag changes)\n* Backend service feature flags configured via environment variables / configuration service\n* Feature flag changes logged and audited (who changed, when, reason)\n* Post-cutover monitoring: Gradual removal of feature flags once system stability confirmed (30-60 days)\n\n==== Data Entity Catalogue\n\n[width=\"100%\",cols=\"20%,15%,35%,30%\",options=\"header\",]\n|===\n|Data Entity |System of Record |Key Attributes |Lifecycle\n\n|*Contact*\n|Salesforce Service Cloud\n|• Contact ID (Salesforce 15/18-char ID) +\n• Email (primary matching key) +\n• First Name, Last Name +\n• Phone Number +\n• Viva Consumer ID (VCI) +\n• Account (Viva Energy customer account) +\n• Record Type (OTR Digital vs other channels)\n|Created: ProfileService JIT reconciliation or Contact Migration Tool +\nUpdated: ProfileService JIT upsert (email changes), Salesforce (manual updates by support agents) +\nDeleted: Salesforce retention policy (GDPR/compliance)\n\n|*Case*\n|Salesforce Service Cloud\n|• Case Number (Salesforce auto-generated) +\n• Contact ID (reference to Contact) +\n• Subject (derived from Category) +\n• Description (Free Text Message) +\n• Category (App, Service, Order, Rewards, Refund, Delete Account) +\n• Store Name (OTR location) +\n• Time of Visit +\n• Status (New, In Progress, Resolved, Closed) +\n• Priority, Origin (Mobile App) +\n• Owner (support agent/queue)\n|Created: EngagementService async Case creation +\nUpdated: Support agents (Salesforce UI), EngagementService (webhook processing) +\nDeleted: Salesforce retention policy (archive after X years)\n\n|*Feedback Submission (transient)*\n|None (not persisted)\n|• Salesforce Contact ID +\n• Category +\n• Store Name +\n• Time of Visit +\n• Contact Phone Number +\n• Free Text Message\n|Created: Mobile App user submission +\nProcessed: EngagementService publishes to Event Bus, Case created in Salesforce +\nNot persisted in ProfileService/EngagementService (stateless)\n\n|*Domain Events*\n|Event Bus (ephemeral)\n|**SupportCaseCreated**: +\n• Case Number, Contact ID, Category, Timestamp +\n**SupportCaseUpdated**: +\n• Case Number, Status, Updated By, Timestamp +\n**SupportCaseResolved**: +\n• Case Number, Resolution, Resolved By, Timestamp +\n**CustomerFeedbackSubmitted**: +\n• Contact ID, Category, Timestamp\n|Published: EngagementService +\nConsumed: Other bounded contexts (future), Braze notification triggers +\nRetention: Short-lived (minutes to hours), not persisted for event sourcing\n\n|*Braze Customer Profile*\n|Braze\n|• External User ID (VCI or Email) +\n• Push Notification Tokens (iOS/Android) +\n• Notification Preferences +\n• Campaign Engagement History\n|Created/Updated: EngagementService on Case creation/update +\nManaged: Braze (external SaaS)\n\n|===\n\n*Data Migration Entities*:\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Source Entity |Target Entity |Migration Strategy\n\n|*App Database Contact*\n|Salesforce Contact\n|One-time migration via Contact Migration Tool: +\n• Upsert by email (primary), phone (secondary), VCI (tertiary) +\n• Map: Email → Email, Name → First/Last Name, Phone → Phone, VCI → External ID +\n• Validation: 100% data integrity check, reconciliation report\n\n|*D365 CE Case*\n|Not migrated\n|ADR-CS-005: No Case migration (fresh start in Salesforce) +\nD365 CE Cases archived separately for compliance if needed\n\n|===\n\n==== Data Quality & Validation\n\n*Contact Migration Validation Rules*:\n\n* Email format validation (RFC 5322 compliance)\n* Phone number format validation (E.164 international format)\n* VCI format validation (alphanumeric, length constraints)\n* Duplicate detection: Flag potential duplicates for manual review (same email/phone combination)\n* Mandatory fields: Email (required), First Name, Last Name (required for Salesforce Contact)\n\n*Case Creation Validation Rules*:\n\n* Contact ID must exist in Salesforce (validated by EngagementService before Case creation)\n* Category must be one of: App, Service, Order, Rewards, Refund, Delete Account\n* Free Text Message maximum length: 32,000 characters (Salesforce Case Description limit)\n* Store Name validated against OTR location master data (optional - warn if not found)\n\n<<<\n== Solution Building Blocks\n\nThis section defines the specific technology products, configurations, and implementation details for each Solution Building Block (SBB).\n\n=== Technology Portfolio Catalogue\n\n[width=\"100%\",cols=\"10%,20%,25%,25%,20%\",options=\"header\",]\n|===\n|SBB ID |Component |Technology Product |Version/Configuration |Deployment Platform\n\n|SBB-CS-001\n|ProfileService Microservice\n|.NET 8 / Node.js 20 LTS\n|RESTful API, containerised\n|AWS ECS Fargate / Lambda\n\n|SBB-CS-002\n|EngagementService Microservice\n|.NET 8 / Node.js 20 LTS\n|RESTful API, containerised, async workers\n|AWS ECS Fargate / Lambda\n\n|SBB-CS-003\n|Event Bus\n|AWS SNS + SQS / EventBridge\n|Standard queues, FIFO for ordering\n|AWS (managed service)\n\n|SBB-CS-004\n|API Gateway\n|AWS API Gateway / ALB\n|REST API, JWT validation\n|AWS (managed service)\n\n|SBB-CS-005\n|Salesforce Integration Layer\n|Salesforce REST API Client\n|OAuth 2.0 JWT bearer flow\n|Embedded in SBB-CS-001/002\n\n|SBB-CS-006\n|Braze Integration Layer\n|Braze REST API SDK\n|API key authentication\n|Embedded in SBB-CS-002\n\n|SBB-CS-007\n|Contact Migration Tool\n|Python 3.11 / .NET 8\n|One-time batch script\n|AWS Lambda / EC2\n\n|SBB-CS-008\n|Application Monitoring\n|AWS CloudWatch / Datadog\n|Metrics, logs, traces, dashboards\n|AWS / SaaS\n\n|SBB-CS-009\n|Secret Management\n|AWS Secrets Manager\n|KMS encryption\n|AWS (managed service)\n\n|SBB-CS-010\n|Mobile App (iOS)\n|SwiftUI, Kotlin Multiplatform\n|iOS 15+\n|Apple App Store\n\n|SBB-CS-011\n|Mobile App (Android)\n|Jetpack Compose, Kotlin Multiplatform\n|Android 8+\n|Google Play Store\n\n|SBB-CS-012\n|Feature Flag Service\n|AWS AppConfig / LaunchDarkly\n|Server-side flags, real-time updates\n|AWS / SaaS\n\n|===\n\n<<<\n== Data Architecture\n\nThis section defines the physical data models, event schemas, and API request/response formats.\n\n=== Domain Event Schemas\n\nAll domain events follow the https://cloudevents.io/[CloudEvents 1.0] specification for consistency and interoperability.\n\n*Event Schema Specifications*: See // TODO: Add to Antora - specifications/events/engagement-events.json[Engagement Service Event Schemas] for complete JSON schemas and examples.\n\n==== Event Catalogue\n\n[width=\"100%\",cols=\"30%,20%,50%\",options=\"header\",]\n|===\n|Event Type |Publisher |Description\n\n|`SupportCaseCreated`\n|EngagementService\n|Published when EngagementService successfully creates a Case in Salesforce after async processing\n\n|`SupportCaseUpdated`\n|EngagementService (via Salesforce webhook)\n|Published when a support agent updates a Case in Salesforce (status, priority, comment changes)\n\n|`SupportCaseResolved`\n|EngagementService (via Salesforce webhook)\n|Published when a support agent resolves/closes a Case in Salesforce\n\n|`CustomerFeedbackSubmitted`\n|EngagementService\n|Published when customer submits feedback via Mobile App (before async Case creation)\n\n|===\n\n*Event Format*: All events use CloudEvents 1.0 envelope with event-specific payload in the `data` field.\n\n*Schema Location*: `specifications/events/engagement-events.json`\n\n=== API Request/Response Schemas\n\n==== ProfileService: GET /profile/contact-id\n\n*Response* (200 OK):\n[source,json]\n----\n{\n  \"contactId\": \"0034X00000ABCDEFG\",\n  \"email\": \"customer@example.com\",\n  \"firstName\": \"John\",\n  \"lastName\": \"Smith\"\n}\n----\n\n==== EngagementService: POST /feedback\n\n*Request*:\n[source,json]\n----\n{\n  \"contactId\": \"0034X00000ABCDEFG\",\n  \"category\": \"App\",\n  \"storeName\": \"OTR Adelaide\",\n  \"timeOfVisit\": \"2026-01-07T12:00:00Z\",\n  \"contactPhoneNumber\": \"+61412345678\",\n  \"message\": \"App crashed when submitting feedback\"\n}\n----\n\n*Response* (202 Accepted):\n[source,json]\n----\n{\n  \"feedbackId\": \"fb-2026-01-07-12345\",\n  \"status\": \"submitted\",\n  \"message\": \"Your feedback has been submitted!\"\n}\n----\n\n=== Salesforce Field Mappings\n\n==== Case Object Mapping\n\n[width=\"100%\",cols=\"25%,25%,25%,25%\",options=\"header\",]\n|===\n|OTR Field |Salesforce Field |Data Type |Notes\n\n|Category\n|Feedback_Category__c\n|Picklist\n|App, Service, Order, Rewards, Refund, Delete Account\n\n|Store Name\n|Store_Name__c\n|String (255)\n|OTR location name\n\n|Time of Visit\n|Time_of_Visit__c\n|DateTime\n|When customer visited store\n\n|Free Text Message\n|Description\n|Long Text (32,000)\n|Customer feedback message\n\n|===\n\n<<<\n=== Baseline Architecture\n\n==== Existing System Components\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Component |Current State |Status\n\n|*D365 Customer Engagement*\n|Customer support platform for OTR digital customers (Mobile App, Web), handles feedback submission and case management\n|**DEPRECATED** - Being replaced by Salesforce Service Cloud\n\n|*App-Specific Customer Database*\n|Stores customer contact data for Mobile App users, separate from Viva Energy systems\n|**MIGRATING** - One-time migration to Salesforce, then deprecated\n\n|*Mobile App*\n|iOS/Android native apps with feedback submission form including Category, Store Name, Time of Visit, Contact Phone Number, and Free Text Message fields\n|**REQUIRES UPDATE** - Integrate with ProfileService and EngagementService APIs (feedback form UI already complete)\n\n|*Salesforce Service Cloud*\n|Shared Viva Energy instance handling customer support for fuel wholesale, Shell Card customers, other retail channels\n|**EXPANDING** - Adding OTR digital customer support Cases and Contacts\n\n|*Existing AWS Infrastructure*\n|SNS+SQS / EventBridge / Kinesis available for event-driven architecture\n|**REUSING** - Event Bus implementation leverages existing infrastructure\n\n|===\n\n==== Integration Architecture\n\n*Current state:*\n\n* Mobile App → D365 Customer Engagement (direct integration)\n* App-specific customer database → standalone (no Salesforce integration)\n* No event-driven architecture (synchronous, tightly coupled)\n* No Anti-Corruption Layer protecting digital channels\n* Viva Energy support teams use Salesforce, OTR digital support uses D365 CE (fragmented)\n\n==== Technical Debt\n\n*No longer relevant* - D365 CE being deprecated, not documenting technical debt of system being retired.\n\n*New technical debt introduced by this migration:*\n\n* Salesforce field mapping TBD (requires coordination with Viva Energy Salesforce admin team)\n* Data isolation strategy TBD (Record Types, custom fields, queues - multi-tenant governance)\n* Salesforce webhook mechanism TBD (Outbound Messages vs Platform Events vs Process Builder)\n* Expected feedback volume unknown (gathering data for rate limit planning)\n\n=== Gap Analysis\n\n==== Missing Capabilities\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Missing Capability |Description\n\n|*ProfileService bounded context*\n|No existing service for Contact reconciliation with Salesforce - requires new microservice implementing JIT upsert by email, returning Salesforce Contact ID\n\n|*EngagementService bounded context*\n|No existing service for customer feedback facade - requires new microservice implementing Anti-Corruption Layer for Salesforce Case creation, Braze integration, async processing via Event Bus\n\n|*Event Bus domain event pattern*\n|No existing domain event publishing infrastructure - requires implementing event-driven architecture pattern using existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis)\n\n|*Async Case creation workflow*\n|Current D365 CE integration is synchronous - requires implementing async processing with retry logic, exponential backoff, dead letter queue\n\n|*Salesforce webhook integration*\n|No existing capability to receive Salesforce notifications - requires implementing webhook receiver in EngagementService for Case update notifications\n\n|*Braze push notification orchestration*\n|No existing integration for Case-related push notifications - requires implementing Braze campaign triggers from EngagementService\n\n|*Contact migration tooling*\n|No existing tooling for app database → Salesforce Contact migration with upsert logic (match by email/phone/VCI)\n\n|*Feedback form enhancements*\n|Mobile App feedback form lacks structured fields (Category, Store Name, Time of Visit, Contact Phone Number) - requires UI updates\n\n|===\n\n==== Missing Bounded Contexts\n\n[width=\"100%\",cols=\"30%,30%,40%\",options=\"header\",]\n|===\n|Bounded Context |Responsibilities |Implementation Status\n\n|*link:../bounded_context/profile.adoc[ProfileService]*\n|JIT Contact reconciliation with Salesforce (upsert by email), return Salesforce Contact ID to digital channels, foundation for future Flybuys partner linking\n|**NEW** - First bounded context implementation\n\n|*link:../bounded_context/engagement.adoc[EngagementService]*\n|Customer feedback submission facade, Anti-Corruption Layer for Salesforce Case creation, Braze integration for push notifications, async Case processing, webhook receiver for Case updates\n|**NEW** - First bounded context implementation\n\n|===\n\n==== Missing Integration Patterns\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Integration Pattern |Description\n\n|*Anti-Corruption Layer (ACL)*\n|EngagementService → Salesforce Service Cloud - protects digital channels from Salesforce API changes, translates between OTR domain language and Salesforce\n\n|*Conformist*\n|ProfileService/EngagementService → Salesforce - conform to existing Salesforce configuration and API contracts (shared Viva Energy instance)\n\n|*Event-Driven Architecture (OHS+PL)*\n|Event Bus publishing domain events (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`) for loose coupling between bounded contexts\n\n|*Just-In-Time (JIT) Integration*\n|ProfileService → Salesforce Contact reconciliation on-demand (no pre-sync)\n\n|*Async Processing*\n|EngagementService Case creation via Event Bus with retry, exponential backoff, dead letter queue\n\n|===\n\n=== Target State Architecture\n\n==== Architectural Building Blocks (ABB)\n\n[width=\"100%\",cols=\"20%,25%,30%,25%\",options=\"header\",]\n|===\n|ABB ID |Bounded Context |Responsibilities |Technology (TBD in Solution Architecture)\n\n|ABB-CS-001\n|*link:../bounded_context/profile.adoc[ProfileService]*\n|JIT Contact reconciliation with Salesforce (upsert by email), return Salesforce Contact ID, foundation for Flybuys partner linking\n|Microservice (.NET/Node.js), REST API, Salesforce REST API client\n\n|ABB-CS-002\n|*link:../bounded_context/engagement.adoc[EngagementService]*\n|Customer feedback submission facade, ACL for Salesforce Case creation, Braze integration, async processing, webhook receiver\n|Microservice (.NET/Node.js), REST API, Event Bus publisher/subscriber, Salesforce webhook receiver\n\n|ABB-CS-003\n|*Event Bus*\n|Domain event publishing infrastructure (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`)\n|AWS SNS+SQS / EventBridge / Kinesis\n\n|ABB-CS-004\n|*Salesforce Service Cloud*\n|System of Record for Contact and Case data (shared Viva Energy instance)\n|Salesforce Service Cloud (external SaaS)\n\n|ABB-CS-005\n|*Braze*\n|Marketing automation platform for push notifications\n|Braze (external SaaS) - existing integration\n\n|ABB-CS-006\n|*Mobile App*\n|iOS/Android native apps with enhanced feedback form (Category, Store Name, Time of Visit, Contact Phone Number, Free Text Message)\n|Kotlin Multiplatform, SwiftUI, Jetpack Compose\n\n|ABB-CS-007\n|*Contact Migration Tool*\n|One-time migration app database → Salesforce with upsert logic (match by email/phone/VCI)\n|Script/tool (.NET/Python/Node.js)\n\n|===\n\n==== Integration Architecture\n\n===== Integration Flows\n\n*Customer Feedback Submission (Async):*\n\n1. *Mobile App* → ProfileService: Authenticate user, get Salesforce Contact ID (JIT reconciliation)\n2. *Mobile App* → EngagementService: Submit feedback (POST /feedback with Contact ID, Category, Store Name, Time of Visit, Phone, Message)\n3. *EngagementService* → Mobile App: Immediate acknowledgment (\"Feedback submitted\")\n4. *EngagementService* → Event Bus: Publish work item for async Case creation\n5. *Background Worker* (EngagementService) → Salesforce: Create Case via REST API\n6. *Success*: EngagementService → Event Bus: Publish `SupportCaseCreated` event\n7. *EngagementService* → Braze: Trigger push notification campaign (\"Your feedback has been received, Case #12345\")\n8. *Failure*: Retry with exponential backoff → Dead Letter Queue → Ops team alert\n\n*Case Update Notification (Bidirectional):*\n\n1. *Support Agent* updates/resolves Case in Salesforce\n2. *Salesforce* → EngagementService: Webhook notification (Case updated)\n3. *EngagementService* → Event Bus: Publish `SupportCaseUpdated` or `SupportCaseResolved` event\n4. *EngagementService* → Braze: Trigger push notification campaign (\"Your case has been resolved\")\n\n*Contact Reconciliation (JIT):*\n\n1. *Mobile App user* authenticates\n2. *Mobile App* → ProfileService: GET /profile/contact-id\n3. *ProfileService* → Salesforce: Query Contact by email\n4. *Match found*: Return existing Salesforce Contact ID\n5. *No match*: Create new Contact in Salesforce, return new Contact ID\n6. *ProfileService* → Mobile App: Return Salesforce Contact ID (cached by Mobile App)\n\n===== System of Record Boundaries\n\n[width=\"100%\",cols=\"30%,35%,35%\",options=\"header\",]\n|===\n|Data Entity |System of Record |Rationale\n\n|*Contact*\n|Salesforce Service Cloud\n|Shared Viva Energy instance, unified customer profile across all channels (digital, wholesale, Shell Card, retail)\n\n|*Case*\n|Salesforce Service Cloud\n|Support agents manage Cases in Salesforce, digital channels submit via EngagementService ACL\n\n|*Feedback Submission (transient)*\n|None (no persistence)\n|EngagementService processes feedback and creates Case in Salesforce, no local storage\n\n|*Domain Events*\n|Event Bus (ephemeral)\n|Events published to Event Bus, consumed by subscribers, not persisted long-term (event sourcing not in scope)\n\n|===\n\n==== Data Architecture Principles\n\n===== Aggregate Persistence\n\n*ProfileService:*\n\n* **No local aggregate persistence** - ProfileService is stateless, queries Salesforce on-demand\n* Salesforce Contact is the aggregate root (owned by Salesforce)\n* ProfileService acts as facade/translator, not system of record\n\n*EngagementService:*\n\n* **No local aggregate persistence** - EngagementService is stateless, creates Cases in Salesforce via ACL\n* Salesforce Case is the aggregate root (owned by Salesforce)\n* EngagementService maintains no local Case state (Conformist pattern - trust Salesforce as source of truth)\n* Async processing state managed via Event Bus (work items in queue, not database)\n\n===== Event Store\n\n* **Event Bus** (SNS+SQS/EventBridge/Kinesis) handles domain event publishing\n* Events are **ephemeral** (consumed and discarded, not persisted for event sourcing)\n* No Event Store implementation in this architecture (future enhancement if needed)\n* Event schema versioning TBD in Solution Architecture\n\n\n=== Architecture Decisions\n\n==== ADR-CS-001: Consolidate onto Salesforce Service Cloud (not build custom solution)\n\n*Status*: Accepted\n\n*Context*:\n\n* D365 Customer Engagement not working well for digital customer support\n* Viva Energy already uses Salesforce Service Cloud for fuel wholesale, Shell Card, other retail channels\n* Post-merger opportunity to consolidate onto single platform\n* Alternative: Build custom support platform or use different SaaS\n\n*Decision*:\n\nConsolidate OTR digital customer support onto Salesforce Service Cloud (shared Viva Energy instance).\n\n*Rationale*:\n\n* **Unified customer view**: Support agents see all interactions across channels (digital, wholesale, Shell Card, retail)\n* **Platform consolidation**: Single support platform reduces operational overhead and costs\n* **Proven solution**: Salesforce Service Cloud is established, feature-rich, well-supported\n* **Post-merger alignment**: Strategic decision to standardize on Viva Energy platforms\n* **Avoid custom development**: Building custom support platform would be costly and high-risk\n\n*Consequences*:\n\n* Unified customer support across Viva Energy Group\n* Reduced operational complexity (single platform vs two)\n* Leverage Salesforce capabilities (case routing, knowledge base, AI, omnichannel)\n* ⚠️ Conformist pattern required (shared instance, conform to existing configuration)\n* ⚠️ Multi-tenant governance needed (data isolation, security, queues)\n* ❌ Less control over platform evolution (SaaS vendor, shared instance)\n\n==== ADR-CS-002: Implement ProfileService and EngagementService as first DDD bounded contexts\n\n*Status*: Accepted\n\n*Context*:\n\n* OTR target architecture uses Domain-Driven Design with bounded contexts\n* This migration is opportunity to establish first implementation\n* Alternative: Direct Mobile App → Salesforce integration (no bounded contexts)\n* Alternative: Single monolithic service for all customer-facing APIs\n\n*Decision*:\n\nImplement ProfileService and EngagementService as separate bounded contexts following DDD strategic patterns.\n\n*Rationale*:\n\n* **Foundation for target architecture**: First implementation of DDD pattern for future bounded contexts (Flybuys, LocationService, PaymentService)\n* **Separation of concerns**: ProfileService handles identity/Contact reconciliation, EngagementService handles support/feedback (different responsibilities, different change rates)\n* **Anti-Corruption Layer**: EngagementService protects digital channels from Salesforce API changes\n* **Reusability**: ProfileService Contact reconciliation reused for Flybuys integration\n* **Event-driven architecture**: Establishes pattern for loose coupling between bounded contexts\n\n*Consequences*:\n\n* Establishes DDD architecture foundation for OTR\n* Reusable ProfileService for Flybuys and future integrations\n* Digital channels protected from Salesforce API changes (ACL)\n* Clear bounded context boundaries and responsibilities\n* ⚠️ Increased initial complexity (two new microservices vs direct integration)\n* ⚠️ Requires Event Bus infrastructure implementation\n* ⚠️ Team must learn DDD patterns and bounded context design\n\n==== ADR-CS-003: Async Case creation via Event Bus (not synchronous)\n\n*Status*: Accepted\n\n*Context*:\n\n* Current D365 CE integration is synchronous (user waits for Case creation)\n* Alternative: Keep synchronous integration (Mobile App → EngagementService → Salesforce synchronously)\n* Salesforce API may experience downtime or latency\n\n*Decision*:\n\nImplement async Case creation via Event Bus with immediate user acknowledgment, retry logic, exponential backoff, and dead letter queue.\n\n*Rationale*:\n\n* **Non-blocking user experience**: User gets immediate \"Feedback submitted\" confirmation, not waiting for Salesforce API\n* **Resilience**: If Salesforce is down, feedback still accepted, Case created when Salesforce recovers\n* **Retry logic**: Automatic retry with exponential backoff handles transient failures\n* **Operational visibility**: Dead letter queue alerts ops team to persistent failures\n* **Scalability**: Queue buffering handles traffic spikes\n\n*Consequences*:\n\n* Better user experience (no waiting for Salesforce API)\n* Resilient to Salesforce downtime (queue buffers work)\n* Automatic retry reduces manual intervention\n* Queue depth monitoring provides operational visibility\n* ⚠️ Eventual consistency (user gets success notification after Case created, not immediately)\n* ⚠️ Increased complexity (Event Bus, background workers, retry logic, DLQ)\n* ⚠️ Requires monitoring and alerting for DLQ\n\n==== ADR-CS-004: ProfileService uses email as primary matching key (not VCI)\n\n*Status*: Accepted\n\n*Context*:\n\n* ProfileService needs to reconcile Mobile App users as Salesforce Contacts\n* Alternative matching keys: VCI (Viva Consumer ID), email, phone, Salesforce External ID\n* Email changes are rare but possible\n\n*Decision*:\n\nUse email address as primary matching key for Contact reconciliation (JIT upsert by email).\n\n*Rationale*:\n\n* **Availability**: Email always available for authenticated users\n* **Uniqueness**: Email is unique identifier in Salesforce and Mobile App\n* **Salesforce standard**: Salesforce Contact uses email as standard lookup field\n* **Simplicity**: Single matching key simplifies upsert logic\n* **Edge case acceptable**: Email changes are rare, manual cleanup acceptable\n\n*Consequences*:\n\n* Simple upsert logic (query by email, create if not found)\n* Leverages Salesforce standard email field\n* Email always available from authentication\n* ⚠️ Email changes create duplicate Contacts (rare edge case, manual cleanup)\n* ⚠️ Future enhancement: Add VCI as Salesforce External ID for stable matching\n\n==== ADR-CS-005: No Case migration from D365 CE (fresh start)\n\n*Status*: Accepted\n\n*Context*:\n\n* D365 CE contains historical customer support Cases\n* Alternative: Migrate historical Cases to Salesforce (preserve support history)\n* Alternative: Archive D365 CE Cases separately (read-only access)\n\n*Decision*:\n\nDo not migrate historical Cases from D365 CE to Salesforce. Start fresh in Salesforce.\n\n*Rationale*:\n\n* **Limited value**: Historical D365 CE Cases not critical for future support\n* **Data quality**: D365 CE Case data may be inconsistent or incomplete\n* **Complexity**: Case migration requires mapping D365 CE schema to Salesforce, data transformation, validation\n* **Cost-benefit**: Migration effort outweighs value of historical data\n* **Archive option**: D365 CE Cases can be archived separately if needed (read-only access for auditing)\n\n*Consequences*:\n\n* Simpler migration (Contacts only, no Case migration)\n* Faster time to value (no Case migration delay)\n* Clean start in Salesforce (no legacy data quality issues)\n* ⚠️ Historical Cases not visible in Salesforce (support agents can't see old Cases)\n* ⚠️ D365 CE must remain accessible temporarily for historical Case lookups (if needed)\n* ❌ Loss of historical Case insights (reporting, analytics on old Cases)\n\n==== ADR-CS-006: Big bang cutover (not phased rollout)\n\n*Status*: Accepted\n\n*Context*:\n\n* Alternative: Phased rollout with feature flags (pilot users first, gradual enablement)\n* Alternative: Parallel run (submit to both D365 CE and Salesforce temporarily)\n* Flybuys integration uses phased rollout (AS-1, AS-2, AS-3 architecture states)\n\n*Decision*:\n\nBig bang cutover - migrate Contacts, deploy ProfileService and EngagementService, switch Mobile App, retire D365 CE.\n\n*Rationale*:\n\n* **Simplicity**: No parallel run complexity, no feature flag management\n* **Faster D365 CE retirement**: No extended transition period maintaining two systems\n* **Limited risk**: Customer support not mission-critical (not payment processing), rollback possible\n* **User base manageable**: OTR digital customers smaller than Flybuys integration scope\n* **Different use case**: Flybuys phased rollout manages points accrual complexity, support feedback is simpler\n\n*Consequences*:\n\n* Simpler deployment (single cutover, no AS-1/AS-2/AS-3 states)\n* Faster D365 CE retirement (no extended parallel run)\n* No feature flag complexity or pilot user management\n* ⚠️ Higher cutover risk (all users switch at once)\n* ⚠️ Requires comprehensive testing before cutover\n* ⚠️ Rollback plan required (revert to D365 CE if critical issues)\n\n==== ADR-CS-007: EngagementService receives Salesforce webhooks for Case updates\n\n*Status*: Accepted\n\n*Context*:\n\n* Support agents update/resolve Cases in Salesforce\n* Need to notify customers of Case status changes via push notifications\n* Alternative: Poll Salesforce API for Case updates (inefficient)\n* Alternative: No customer notifications (agents contact customers directly)\n\n*Decision*:\n\nSalesforce sends webhook notifications to EngagementService when Cases are updated/resolved. EngagementService triggers Braze push notifications.\n\n*Rationale*:\n\n* **Real-time notifications**: Customer notified immediately when agent resolves Case\n* **Efficient**: Webhook push model (not polling)\n* **Event-driven**: Aligns with event-driven architecture pattern\n* **Better customer experience**: Proactive notification vs waiting for agent contact\n\n*Consequences*:\n\n* Real-time customer notifications for Case updates\n* Efficient push model (no polling overhead)\n* Bidirectional integration (Mobile App → Salesforce → Mobile App)\n* ⚠️ Salesforce webhook mechanism TBD (Outbound Messages vs Platform Events vs Process Builder)\n* ⚠️ Webhook authentication and security required\n* ⚠️ EngagementService must handle webhook retries and failures\n\n<<<\n== Interface Specifications\n\nThis section provides references to the complete API specifications and event catalogue for ProfileService and EngagementService.\n\n=== REST API Specifications\n\nComplete OpenAPI 3.0 specifications are maintained in the `specifications/rest/` directory:\n\n==== ProfileService API v1\n\n*Specification*: link:../../specifications/rest/profile-service-v1.yaml[profile-service-v1.yaml]\n\n*Base URL*: `https://api.otr.com.au/profile/v1`\n\n*Authentication*: Bearer token (Microsoft Entra External ID JWT)\n\n*Key Endpoints*:\n\n* `GET /contact-id` - Retrieve or create Salesforce Contact ID for authenticated user (Just-In-Time reconciliation)\n** Used by Mobile App before submitting feedback to EngagementService\n** Upserts Salesforce Contact record using email as external key\n** Returns 18-character Salesforce Contact ID with caching (15-minute TTL)\n** Performance SLA: p95 < 300ms (uncached), p95 < 50ms (cached)\n\n==== EngagementService API v1\n\n*Specification*: link:../../specifications/rest/engagement-service-v1.yaml[engagement-service-v1.yaml]\n\n*Base URL*: `https://api.otr.com.au/engagement/v1`\n\n*Authentication*: Bearer token (Microsoft Entra External ID JWT)\n\n*Key Endpoints*:\n\n* `POST /feedback` - Submit customer feedback for async Case creation in Salesforce\n** Accepts contactId, category, storeName, timeOfVisit, contactPhoneNumber, message\n** Returns 202 Accepted immediately (async Case creation in background)\n** Publishes `CustomerFeedbackSubmitted` event for analytics\n** Creates Salesforce Case via Anti-Corruption Layer with retry logic\n** Performance SLA: p95 < 200ms (feedback accepted, not Case creation)\n\n=== Domain Events (AsyncAPI)\n\nComplete CloudEvents 1.0 JSON Schema specifications are maintained in the `specifications/events/` directory:\n\n*Specification*: link:../../specifications/events/engagement-events.json[engagement-events.json]\n\n==== Event Catalogue\n\n[width=\"100%\",cols=\"30%,20%,50%\",options=\"header\",]\n|===\n|Event Type |Publisher |Consumers\n\n|`CustomerFeedbackSubmitted`\n|EngagementService\n|Future bounded contexts, analytics, sentiment analysis\n\n|`SupportCaseCreated`\n|EngagementService\n|Future bounded contexts, analytics\n\n|`SupportCaseUpdated`\n|EngagementService (via Salesforce webhook)\n|Future bounded contexts, analytics\n\n|`SupportCaseResolved`\n|EngagementService (via Salesforce webhook)\n|Future bounded contexts, analytics\n\n|===\n\n==== Event Delivery Guarantees\n\n* **At-least-once delivery**: Events may be delivered multiple times, consumers must handle idempotency\n* **Ordering**: FIFO queues guarantee ordering for events with same `contactId`\n* **Retention**: 4 days (96 hours) in Event Bus\n* **Dead Letter Queue**: Failed events after 5 retries moved to DLQ for manual intervention\n* **Format**: CloudEvents 1.0 specification with JSON payload\n\n=== API Versioning Policy\n\n==== Version Numbering\n\n* **Format**: `/v{major}` in URL path (e.g., `/profile/v1`, `/engagement/v1`)\n* **Semantic Versioning**: Major version incremented for breaking changes only\n* **Backwards Compatibility**: Minor changes (new optional fields, new endpoints) don't require version bump\n\n==== When to Version\n\n*Breaking changes requiring new major version*:\n\n- Removing or renaming fields in request/response\n- Changing field data types (e.g., string → number)\n- Changing authentication mechanism\n- Removing endpoints\n\n*Non-breaking changes not requiring version bump*:\n\n- Adding new optional fields to request/response\n- Adding new endpoints\n- Expanding enum values (e.g., adding new feedback category)\n- Improving error messages\n\n==== Parallel Version Support\n\n* Support N and N-1 versions concurrently for 6 months\n* Deprecation notice: 3 months before sunsetting old version\n* Mobile App must upgrade to new version within deprecation window\n\n<<<\n== Work Packages\n\nThis section consolidates gaps and activities into implementable work packages aligned with TOGAF Phase E requirements.\n\n=== Work Package Overview\n\n[width=\"100%\",cols=\"15%,35%,25%,25%\",options=\"header\",]\n|===\n|Work Package ID |Name |Transition State |Key Deliverables\n\n|WP-CS-001\n|ProfileService Development\n|TS-1 (Build & Test)\n|ProfileService microservice, Salesforce Contact integration, REST API\n\n|WP-CS-002\n|EngagementService Development\n|TS-1 (Build & Test)\n|EngagementService microservice, Anti-Corruption Layer, Braze integration\n\n|WP-CS-003\n|Event Bus Infrastructure\n|TS-1 (Build & Test)\n|Event Bus configuration, CloudEvents schemas, monitoring\n\n|WP-CS-004\n|Contact Migration Tooling\n|TS-1 (Build & Test)\n|Migration tool, validation scripts, reconciliation reporting\n\n|WP-CS-005\n|Mobile App Integration\n|TS-1 (Build & Test)\n|Mobile App API integration, feedback form enhancements, testing\n\n|WP-CS-006\n|Integration Testing\n|TS-1 (Build & Test)\n|Test environments, integration test suites, UAT execution\n\n|WP-CS-007\n|Salesforce Configuration\n|TS-1 (Build & Test)\n|Salesforce field mapping, data isolation, webhook configuration\n\n|WP-CS-008\n|Contact Data Migration\n|TS-2 (Contact Migration)\n|Contact migration execution, validation, reconciliation\n\n|WP-CS-009\n|Production Deployment\n|TS-3 (Cutover)\n|Production deployment, smoke testing, go-live execution\n\n|WP-CS-010\n|Post-Cutover Support\n|TS-4 (Target State)\n|Monitoring, issue resolution, D365 CE retirement\n\n|===\n\n[[wp-cs-001]]\n=== WP-CS-001: ProfileService Development\n\n==== Description\n\nBuild ProfileService bounded context microservice implementing Just-In-Time Contact reconciliation with Salesforce Service Cloud.\n\n==== Deliverables\n\n* ProfileService microservice application\n** REST API implementation (OpenAPI 3.0 specification)\n** `GET /contact-id` endpoint (Salesforce Contact reconciliation)\n** Authentication/authorization with Microsoft Entra External ID\n** Caching layer (15-minute TTL for Contact IDs)\n* Salesforce integration\n** Salesforce REST API client\n** Contact upsert by email (external key matching)\n** Error handling and retry logic\n* Unit tests (>80% code coverage)\n* Integration tests with Salesforce sandbox\n* API documentation\n* Deployment configuration (IaC - Infrastructure as Code)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* Salesforce sandbox environment provisioned\n* Microsoft Entra External ID OAuth configuration\n* Development environment setup (AWS dev account, CI/CD pipeline)\n\n*Dependent Work Packages*:\n\n* None (can start immediately after prerequisites met)\n\n==== Skills Required\n\n* Backend development (.NET Core or Node.js)\n* REST API design and implementation\n* Salesforce REST API integration\n* OAuth 2.0 / JWT authentication\n* Caching strategies (Redis/ElastiCache)\n* Unit/integration testing frameworks\n* Infrastructure as Code (Terraform/CloudFormation)\n\n==== Acceptance Criteria\n\n* All API endpoints return correct HTTP status codes per OpenAPI specification\n* Contact ID retrieval achieves p95 < 300ms (uncached), p95 < 50ms (cached)\n* Salesforce Contact upsert succeeds with 100% accuracy in sandbox testing\n* Unit test coverage > 80%\n* Integration tests pass in sandbox environment\n* API documentation generated from OpenAPI specification\n\n[[wp-cs-002]]\n=== WP-CS-002: EngagementService Development\n\n==== Description\n\nBuild EngagementService bounded context microservice implementing customer feedback submission, Anti-Corruption Layer for Salesforce Case creation, Braze integration, and webhook receiver for Case updates.\n\n==== Deliverables\n\n* EngagementService microservice application\n** REST API implementation (OpenAPI 3.0 specification)\n** `POST /feedback` endpoint (async feedback submission)\n** Authentication/authorization with Microsoft Entra External ID\n** Webhook receiver endpoint for Salesforce Case updates\n* Anti-Corruption Layer (ACL)\n** OTR domain model to Salesforce API translation\n** Category enum mapping (App/Service/Order/Rewards → Salesforce Case fields)\n** Salesforce REST API client for Case creation\n* Async processing infrastructure\n** Event Bus publisher integration\n** Background worker for Case creation\n** Retry logic with exponential backoff (5 attempts)\n** Dead Letter Queue integration\n* Braze integration\n** Braze campaign trigger API client\n** Push notification orchestration for Case updates\n* Domain event publishing\n** `CustomerFeedbackSubmitted` event publisher\n** `SupportCaseCreated` event publisher\n** `SupportCaseUpdated` event translator (Salesforce webhook → domain event)\n** `SupportCaseResolved` event translator (Salesforce webhook → domain event)\n* Unit tests (>80% code coverage)\n* Integration tests (EngagementService ↔ Salesforce, EngagementService ↔ Braze)\n* API documentation\n* Deployment configuration (IaC)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-003 (Event Bus Infrastructure) completed\n* Salesforce sandbox environment provisioned\n* Braze API credentials and campaign templates configured\n* Microsoft Entra External ID OAuth configuration\n\n*Dependent Work Packages*:\n\n* WP-CS-003 must be completed first (Event Bus required for async processing)\n* WP-CS-007 (Salesforce Configuration) must be in progress (field mapping needed)\n\n==== Skills Required\n\n* Backend development (.NET Core or Node.js)\n* REST API design and implementation\n* Salesforce REST API integration\n* Event-driven architecture patterns\n* Async/background processing (queues, workers)\n* Braze API integration\n* Webhook design and security\n* OAuth 2.0 / JWT authentication\n* Domain-Driven Design (DDD) - Anti-Corruption Layer pattern\n* Unit/integration testing frameworks\n* Infrastructure as Code (Terraform/CloudFormation)\n\n==== Acceptance Criteria\n\n* Feedback submission endpoint returns 202 Accepted within p95 < 200ms\n* Async Case creation succeeds with >99.5% success rate (including retries)\n* Anti-Corruption Layer correctly maps all feedback categories to Salesforce Case fields\n* Webhook receiver processes Salesforce Case updates and publishes domain events\n* Braze push notifications sent successfully for Case updates\n* Failed Case creation moves to Dead Letter Queue after 5 retry attempts\n* Unit test coverage > 80%\n* Integration tests pass with Salesforce sandbox and Braze staging environment\n\n[[wp-cs-003]]\n=== WP-CS-003: Event Bus Infrastructure\n\n==== Description\n\nImplement Event Bus infrastructure for domain event publishing using existing AWS infrastructure (SNS+SQS, EventBridge, or Kinesis).\n\n==== Deliverables\n\n* Event Bus infrastructure configuration\n** Topic/stream provisioning (technology choice: SNS+SQS / EventBridge / Kinesis)\n** FIFO queue configuration (ordering by `contactId`)\n** Dead Letter Queue (DLQ) setup\n** Retention policy (4 days / 96 hours)\n** Access control policies (IAM roles, permissions)\n* CloudEvents 1.0 schema definitions\n** JSON Schema specifications for all domain events\n** Schema validation configuration\n** Schema registry (if using EventBridge/Kinesis)\n* Monitoring and alerting\n** CloudWatch dashboards for queue metrics\n** Alarms for DLQ depth, queue age, processing failures\n** Event Bus throughput monitoring\n* Documentation\n** Event Bus architecture diagram\n** Event publishing guidelines\n** Consumer integration guide\n* Infrastructure as Code (IaC)\n** Terraform/CloudFormation templates for all infrastructure\n\n==== Dependencies\n\n*Prerequisites*:\n\n* AWS account access (existing infrastructure)\n* Technology selection decision (SNS+SQS vs EventBridge vs Kinesis)\n* CloudEvents 1.0 schema design approval\n\n*Dependent Work Packages*:\n\n* None (foundational infrastructure, can start early)\n\n==== Skills Required\n\n* AWS messaging services (SNS, SQS, EventBridge, Kinesis)\n* Event-driven architecture patterns\n* CloudEvents specification\n* JSON Schema design\n* Infrastructure as Code (Terraform/CloudFormation)\n* AWS IAM security configuration\n* CloudWatch monitoring and alerting\n\n==== Acceptance Criteria\n\n* Event Bus infrastructure provisioned in all environments (dev, staging, production)\n* FIFO ordering validated for events with same `contactId`\n* Dead Letter Queue triggers alarms when messages arrive\n* Event retention policy enforced (4 days)\n* CloudEvents 1.0 schema validation enabled\n* Monitoring dashboards operational\n* Infrastructure fully codified (IaC)\n\n=== WP-CS-004: Contact Migration Tooling\n\n==== Description\n\nDevelop Contact migration tool for one-time migration from app-specific database to Salesforce Service Cloud with upsert logic and validation.\n\n==== Deliverables\n\n* Contact migration tool\n** Extract Contacts from app-specific database\n** Transform to Salesforce Contact API format\n** Upsert to Salesforce using email as external key\n** Fallback matching by phone number or Viva Consumer ID\n** Batch processing with rate limiting (respect Salesforce API limits)\n** Idempotent operation (can be re-run safely)\n* Validation scripts\n** Pre-migration validation (data quality checks)\n** Post-migration validation (100% Contact reconciliation)\n** Email/phone/VCI matching accuracy report\n* Reconciliation reporting\n** Contacts created vs updated statistics\n** Failed upserts with error details\n** Matching accuracy metrics\n* Rollback capability\n** Export snapshot of Salesforce Contacts before migration\n** Rollback procedure documentation\n* Documentation\n** Migration tool user guide\n** Troubleshooting guide\n** Runbook for migration execution\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-001 (ProfileService Development) completed (reuses Salesforce integration code)\n* Salesforce sandbox environment for migration testing\n* App-specific database access (read-only sufficient)\n* Salesforce production access granted\n\n*Dependent Work Packages*:\n\n* WP-CS-001 provides Salesforce Contact upsert logic to reuse\n\n==== Skills Required\n\n* Database development (SQL, data extraction)\n* Salesforce REST API integration\n* Batch processing and ETL patterns\n* Data validation and reconciliation\n* Error handling and logging\n* Scripting (Python, PowerShell, or similar)\n\n==== Acceptance Criteria\n\n* Migration tool successfully migrates 100% of Contacts in sandbox with zero data loss\n* Email/phone/VCI matching accuracy > 95% in sandbox testing\n* Failed upserts captured with actionable error messages\n* Reconciliation report matches actual Salesforce Contact counts\n* Migration tool execution time acceptable for production (freezes app database for minimum time)\n* Rollback procedure validated in sandbox\n* Documentation complete and approved\n\n=== WP-CS-005: Mobile App Integration\n\n==== Description\n\nUpdate Mobile App to integrate with ProfileService and EngagementService APIs, replacing D365 CE integration.\n\n==== Deliverables\n\n* Feedback form UI enhancements\n** Add Category dropdown (App, Service, Order, Rewards, Refund, Delete Account)\n** Add Store Name field (optional)\n** Add Time of Visit field (optional, datetime picker)\n** Add Contact Phone Number field (optional, E.164 validation)\n** Update Message field (1-2000 character limit with counter)\n* API integration (Kotlin Multiplatform shared code)\n** ProfileService client (`GET /contact-id`)\n** EngagementService client (`POST /feedback`)\n** JWT token management (Microsoft Entra External ID)\n** Error handling (network failures, API errors, validation errors)\n** Retry logic for transient failures\n* Platform-specific UI (SwiftUI for iOS, Jetpack Compose for Android)\n** Feedback form screens\n** Success/error confirmation screens\n** Loading states and progress indicators\n* Feature flag integration\n** `enable_salesforce_feedback_submission` flag\n** Fallback to D365 CE if flag disabled (during rollout)\n* Unit tests for shared business logic\n* UI tests for platform-specific screens\n* API integration tests (mocked APIs)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-001 (ProfileService Development) completed and deployed to dev/staging\n* WP-CS-002 (EngagementService Development) completed and deployed to dev/staging\n* ProfileService and EngagementService OpenAPI specifications finalized\n* Feature flag service configured\n\n*Dependent Work Packages*:\n\n* Must complete after WP-CS-001 and WP-CS-002 (requires API endpoints available for integration testing)\n\n==== Skills Required\n\n* Kotlin Multiplatform development\n* SwiftUI (iOS native UI)\n* Jetpack Compose (Android native UI)\n* REST API client development\n* OAuth 2.0 / JWT authentication\n* Form validation and UX design\n* Unit testing (Kotlin, Swift)\n* UI testing frameworks (XCTest, Espresso)\n\n==== Acceptance Criteria\n\n* Feedback form UI matches UX design specifications\n* All form fields validate correctly (client-side validation)\n* API integration successfully calls ProfileService and EngagementService in dev/staging\n* Error handling provides user-friendly error messages\n* Feature flag correctly toggles between Salesforce and D365 CE integration\n* Unit test coverage > 80% for shared business logic\n* UI tests pass for all feedback form workflows (happy path, error states)\n* App builds and deploys successfully to TestFlight (iOS) and Google Play Internal Testing (Android)\n\n=== WP-CS-006: Integration Testing\n\n==== Description\n\nExecute comprehensive integration testing across all system components in non-production environments.\n\n==== Deliverables\n\n* Test environment setup\n** Salesforce sandbox configured with test data\n** ProfileService deployed to staging\n** EngagementService deployed to staging\n** Event Bus staging infrastructure\n** Braze staging environment configured\n** Mobile App TestFlight/Internal Testing builds\n* Integration test suites\n** ProfileService ↔ Salesforce (Contact upsert scenarios)\n** EngagementService ↔ Salesforce (Case creation scenarios)\n** EngagementService ↔ Braze (push notification scenarios)\n** Mobile App ↔ ProfileService ↔ EngagementService (end-to-end workflows)\n** Event Bus publishing and consumption\n** Webhook receiver (Salesforce → EngagementService)\n* Test scenarios\n** Happy path: Successful feedback submission and Case creation\n** Error scenarios: Salesforce API failures, Braze API failures, network timeouts\n** Retry scenarios: Async Case creation retries, DLQ validation\n** Performance testing: p95 latency validation for ProfileService and EngagementService\n** Load testing: Simulate 3x-10x expected volume\n* UAT execution\n** Business stakeholder UAT sessions\n** UAT test cases covering all feedback categories\n** UAT sign-off documentation\n* Test results documentation\n** Test execution reports\n** Defect tracking and resolution\n** Performance test results\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-001 (ProfileService Development) completed\n* WP-CS-002 (EngagementService Development) completed\n* WP-CS-003 (Event Bus Infrastructure) completed\n* WP-CS-005 (Mobile App Integration) completed\n* WP-CS-007 (Salesforce Configuration) sandbox configuration completed\n\n*Dependent Work Packages*:\n\n* Must complete after WP-CS-001, WP-CS-002, WP-CS-003, WP-CS-005 (requires all components available)\n\n==== Skills Required\n\n* Integration testing strategy and execution\n* Test automation frameworks (Postman, Newman, Selenium)\n* Performance testing tools (JMeter, k6, Gatling)\n* Salesforce sandbox administration\n* Test data management\n* Defect tracking and triage\n* UAT facilitation\n\n==== Acceptance Criteria\n\n* All integration test scenarios pass (happy path, error scenarios, retry scenarios)\n* Performance SLAs validated (ProfileService p95 < 300ms, EngagementService p95 < 200ms)\n* Load testing confirms system handles 3x expected volume without degradation\n* UAT sign-off obtained from business stakeholders\n* Zero critical defects (P1/P2) open before moving to Contact Migration\n* Test results documented and approved\n\n=== WP-CS-007: Salesforce Configuration\n\n==== Description\n\nConfigure Salesforce Service Cloud for OTR digital customer support integration, including field mapping, data isolation, and webhook setup.\n\n==== Deliverables\n\n* Salesforce Contact configuration\n** Custom fields for OTR-specific data (if needed)\n** Email as external key configuration\n** Record Type for OTR digital customers (data isolation)\n** Validation rules\n* Salesforce Case configuration\n** Custom fields for feedback categories (App, Service, Order, Rewards, Refund, Delete Account)\n** Case Type and Reason picklist mapping\n** Queue assignment rules (OTR digital support queue)\n** Case escalation rules\n** Case routing rules\n* Salesforce webhook configuration\n** Platform Events / Outbound Messages for Case updates\n** Webhook authentication (API key, JWT, or OAuth)\n** Case status change triggers (New → In Progress, Resolved, Closed)\n** Webhook payload format (JSON)\n* Data isolation strategy\n** Record Types for OTR vs other Viva Energy business units\n** Queues for OTR-specific Cases\n** Reporting and dashboards scoped to OTR data\n* Salesforce API access\n** Connected App configuration\n** OAuth 2.0 JWT bearer flow setup\n** API user credentials\n** API rate limit monitoring\n* Documentation\n** Salesforce field mapping specification\n** Webhook configuration guide\n** Data isolation architecture diagram\n** API authentication setup guide\n\n==== Dependencies\n\n*Prerequisites*:\n\n* Viva Energy Salesforce admin team engagement\n* Salesforce governance approval (multi-tenant environment)\n* Technical decision on webhook mechanism (Platform Events vs Outbound Messages)\n* Technical decision on authentication method (OAuth 2.0 JWT bearer flow recommended)\n\n*Dependent Work Packages*:\n\n* None (can start in parallel with development work packages)\n* Required for WP-CS-002 (EngagementService needs field mapping)\n* Required for WP-CS-006 (Integration Testing needs sandbox configuration)\n\n==== Skills Required\n\n* Salesforce administration\n* Salesforce configuration (Record Types, Queues, Validation Rules)\n* Salesforce API integration (REST API, Platform Events, Outbound Messages)\n* Salesforce security and authentication (OAuth, Connected Apps)\n* Multi-tenant data isolation patterns\n\n==== Acceptance Criteria\n\n* Salesforce sandbox configured with all custom fields, Record Types, Queues\n* Field mapping documented and approved by OTR business stakeholders\n* Webhook configuration tested and delivering Case update notifications\n* Data isolation validated (OTR data separate from other Viva Energy business units)\n* API authentication working for ProfileService and EngagementService\n* Salesforce API rate limits monitored and acceptable for expected volume\n* Configuration replicated to Salesforce production environment\n\n=== WP-CS-008: Contact Data Migration\n\n==== Description\n\nExecute one-time Contact migration from app-specific database to Salesforce Service Cloud production.\n\n==== Deliverables\n\n* Pre-migration activities\n** Final validation of migration tool in sandbox\n** Communication plan (notify users of maintenance window if needed)\n** Freeze app-specific database Contact updates\n** Backup app-specific database\n** Export snapshot of Salesforce Contacts (rollback preparation)\n* Migration execution\n** Execute migration tool against Salesforce production\n** Monitor migration progress\n** Handle failed upserts (manual intervention if needed)\n* Post-migration validation\n** 100% Contact reconciliation (app database vs Salesforce)\n** Email/phone/VCI matching accuracy report\n** Reconciliation report (Contacts created vs updated)\n** Data integrity checks (no duplicate Contacts, no missing Contacts)\n* ProfileService smoke testing\n** Verify Contact ID retrieval works in production\n** Test cache behavior\n** Validate Salesforce Contact upserts from ProfileService\n* Migration report\n** Total Contacts migrated\n** Contacts created vs updated\n** Failed upserts (if any) with resolution\n** Matching accuracy metrics\n** Migration execution time\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-004 (Contact Migration Tooling) completed\n* WP-CS-001 (ProfileService Development) deployed to production (not yet integrated with Mobile App)\n* WP-CS-007 (Salesforce Configuration) production configuration completed\n* Salesforce production access granted\n* Migration approved by business stakeholders\n\n*Dependent Work Packages*:\n\n* Must complete after WP-CS-001, WP-CS-004, WP-CS-007\n* Must complete before WP-CS-009 (Production Deployment)\n\n==== Skills Required\n\n* Data migration execution\n* Salesforce administration\n* Database operations\n* Data validation and reconciliation\n* Incident management (if issues arise)\n\n==== Acceptance Criteria\n\n* 100% of Contacts migrated with zero data loss\n* Email/phone/VCI matching accuracy > 95%\n* ProfileService smoke tests pass in production\n* Reconciliation report approved by business stakeholders\n* App-specific database Contact updates frozen (read-only mode)\n* Rollback procedure ready (but not executed if migration successful)\n\n=== WP-CS-009: Production Deployment\n\n==== Description\n\nDeploy all solution components to production and execute cutover from D365 CE to Salesforce Service Cloud.\n\n==== Deliverables\n\n* Production deployment\n** EngagementService deployed to production\n** Event Bus production infrastructure validated\n** Salesforce webhook configured in production\n** Mobile App released to production (App Store, Google Play)\n* Go-live activities\n** Smoke testing (end-to-end feedback submission)\n** Feature flag enabled: `enable_salesforce_feedback_submission = ON`\n** D365 CE integration disabled in Mobile App\n** Monitor Event Bus queue depth, DLQ, Salesforce API rate limits\n** Monitor Mobile App feedback submission success rate\n* Go/No-Go decision\n** Validate success criteria before final cutover\n** Business stakeholder approval\n** Technical validation (smoke tests pass, monitoring healthy)\n* Cutover communication\n** Notify support agents of new Salesforce integration\n** Provide training materials for support agents\n** Customer communication (if visible change)\n* Rollback plan\n** Documented rollback procedure\n** Feature flag can disable Salesforce integration and re-enable D365 CE\n** Rollback decision criteria (P1/P2 incidents, feedback submission success rate < 99%)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-001 (ProfileService Development) completed\n* WP-CS-002 (EngagementService Development) completed\n* WP-CS-003 (Event Bus Infrastructure) completed\n* WP-CS-005 (Mobile App Integration) completed\n* WP-CS-006 (Integration Testing) completed with UAT sign-off\n* WP-CS-007 (Salesforce Configuration) production configuration completed\n* WP-CS-008 (Contact Data Migration) completed successfully\n* Mobile App release approval (App Store, Google Play)\n\n*Dependent Work Packages*:\n\n* Must complete after all prior work packages (final cutover)\n\n==== Skills Required\n\n* Production deployment and release management\n* Incident management and troubleshooting\n* Monitoring and observability\n* Change management and communication\n* Rollback execution (if needed)\n\n==== Acceptance Criteria\n\n* Mobile App feedback submission success rate > 99.5%\n* End-to-end flow validated (Mobile App → ProfileService → EngagementService → Salesforce Case created)\n* Braze push notifications delivered successfully\n* Event Bus queue depth normal, DLQ empty\n* No critical incidents (P1/P2) in first 24 hours\n* D365 CE integration disabled\n* Support agents successfully using Salesforce for OTR digital customer Cases\n\n=== WP-CS-010: Post-Cutover Support\n\n==== Description\n\nMonitor production stability, resolve issues, validate success criteria, and execute D365 CE retirement.\n\n==== Deliverables\n\n* Monitoring and support\n** 24/7 on-call support for first week post-cutover\n** Daily monitoring reports (feedback submission success rate, Case creation success rate)\n** Incident response and resolution\n** Performance tuning (if needed)\n* Success criteria validation\n** Validate feedback submission success rate > 99.5%\n** Monitor customer satisfaction score (target: +15% improvement within 6 months)\n** Monitor average case resolution time (target: -20% improvement within 6 months)\n** Support agent feedback survey\n* D365 CE retirement\n** D365 CE set to read-only mode (historical Case lookups only)\n** Archive D365 CE data for compliance/auditing\n** Decommission D365 CE infrastructure (after 90-day stabilization period)\n** Remove D365 CE integration code from Mobile App\n* Documentation updates\n** Production runbook\n** Troubleshooting guide (based on incidents resolved)\n** Operational procedures for support team\n** Lessons learned document\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-009 (Production Deployment) completed\n* Cutover successful with no critical incidents\n\n*Dependent Work Packages*:\n\n* Final work package in sequence\n\n==== Skills Required\n\n* Production support and incident management\n* Performance monitoring and tuning\n* Data archival and compliance\n* Infrastructure decommissioning\n* Documentation\n\n==== Acceptance Criteria\n\n* Zero critical incidents (P1/P2) in first 30 days post-cutover\n* Feedback submission success rate sustained > 99.5%\n* Customer satisfaction improvement validated (baseline established, ongoing measurement)\n* Support agents reporting positive experience with Salesforce unified view\n* D365 CE successfully decommissioned\n* All production documentation complete and approved\n* Lessons learned document published\n\n=== Work Package Sequencing\n\n==== Parallel Track 1: Infrastructure & Configuration\n\nCan start immediately and run in parallel:\n\n* WP-CS-003 (Event Bus Infrastructure)\n* WP-CS-007 (Salesforce Configuration)\n\n==== Parallel Track 2: Development\n\nCan start after Track 1 infrastructure decisions made:\n\n* WP-CS-001 (ProfileService Development) - Independent\n* WP-CS-002 (EngagementService Development) - Requires WP-CS-003 completed\n* WP-CS-004 (Contact Migration Tooling) - Requires WP-CS-001 completed (reuses code)\n\n==== Sequential Track 3: Integration & Testing\n\nMust complete after development:\n\n* WP-CS-005 (Mobile App Integration) - Requires WP-CS-001, WP-CS-002\n* WP-CS-006 (Integration Testing) - Requires WP-CS-001, WP-CS-002, WP-CS-003, WP-CS-005, WP-CS-007\n\n==== Sequential Track 4: Migration & Cutover\n\nMust complete sequentially:\n\n* WP-CS-008 (Contact Data Migration) - Requires WP-CS-001, WP-CS-004, WP-CS-006 UAT sign-off\n* WP-CS-009 (Production Deployment) - Requires all prior work packages completed\n* WP-CS-010 (Post-Cutover Support) - Requires WP-CS-009\n\n==== Critical Path\n\nThe critical path for this project is:\n\n. WP-CS-003 (Event Bus Infrastructure)\n. WP-CS-002 (EngagementService Development) - blocks on WP-CS-003\n. WP-CS-005 (Mobile App Integration) - blocks on WP-CS-001, WP-CS-002\n. WP-CS-006 (Integration Testing) - blocks on WP-CS-001 through WP-CS-005, WP-CS-007\n. WP-CS-008 (Contact Data Migration) - blocks on WP-CS-006 UAT sign-off\n. WP-CS-009 (Production Deployment) - blocks on WP-CS-008\n. WP-CS-010 (Post-Cutover Support) - final deliverable\n\nAny delays in critical path work packages will delay the overall cutover date.\n\n<<<\n== Transition Architecture\n\nThis section defines the evolution from baseline (D365 CE) to target state (Salesforce Service Cloud + ProfileService + EngagementService).\n\n=== Transition Approach\n\n*Big Bang Cutover*: Per ADR-CS-006, this transition uses a single cutover approach rather than phased rollout. All users switch from D365 CE to Salesforce simultaneously after Contact migration completion.\n\n=== Transition States\n\n==== TS-0: Baseline State (Current)\n\n===== Characteristics\n\n* D365 Customer Engagement handles all digital customer feedback\n* App-specific database stores customer Contact data\n* No ProfileService or EngagementService\n* No event-driven architecture\n* Synchronous feedback submission\n\n===== Components Active\n\n- D365 Customer Engagement\n- App-specific customer database\n- Mobile App (current version with D365 CE integration)\n\n==== TS-1: Build & Test\n\n===== Activities\n\n* Build ProfileService microservice (JIT Contact reconciliation API)\n* Build EngagementService microservice (feedback submission API, ACL for Salesforce Case creation, Braze integration, webhook receiver)\n* Implement Event Bus infrastructure (SNS+SQS/EventBridge/Kinesis)\n* Develop Contact migration tool (app database → Salesforce upsert by email/phone/VCI)\n* Update Mobile App API integration (ProfileService + EngagementService endpoints - feedback form UI already complete)\n* Integration testing (ProfileService ↔ Salesforce, EngagementService ↔ Salesforce, EngagementService ↔ Braze)\n* UAT with test Salesforce sandbox environment\n\n===== Components Active\n\n- D365 Customer Engagement (still active, unchanged)\n- App-specific customer database (still active)\n- ProfileService (non-production, testing only)\n- EngagementService (non-production, testing only)\n- Event Bus (non-production)\n- Salesforce Sandbox (testing)\n\n===== Exit Criteria\n\n- All integration tests pass\n- UAT sign-off from business stakeholders\n- Contact migration tool validated in sandbox\n- Mobile App updates tested with non-production APIs\n\n==== TS-2: Contact Migration\n\n===== Activities\n* Execute Contact migration (app database → Salesforce production)\n* Validation: 100% data integrity check (email/phone/VCI matching)\n* Reconciliation report: New Contacts created vs existing Contacts updated\n* Freeze app database Contact updates during migration window\n* ProfileService smoke testing (verify Contact lookups work in Salesforce production)\n\n===== Components Active\n- D365 Customer Engagement (still active, users unaffected)\n- Salesforce Production (Contacts migrated, no Cases yet)\n- ProfileService (production deployed, not integrated with Mobile App yet)\n- App-specific customer database (frozen, read-only)\n\n===== Exit Criteria\n- 100% of Contacts migrated with zero data loss\n- Email/phone/VCI matching accuracy > 95%\n- ProfileService smoke tests pass (JIT lookups return correct Contact IDs)\n- Reconciliation report approved\n\n==== TS-3: Cutover (Go-Live)\n\n===== Go-Live Activities\n\n* Deploy EngagementService to production\n* Deploy Mobile App updates (ProfileService + EngagementService API integration)\n* Configure Salesforce webhook (Case update notifications → EngagementService)\n* Smoke testing: End-to-end feedback submission (Mobile App → EngagementService → Salesforce → Braze notification)\n* Monitor Event Bus queue depth, dead letter queue, Salesforce API rate limits\n* **Go/No-Go decision**: Validate success criteria before final cutover\n* Enable feature flag: `enable_salesforce_feedback_submission = ON`\n* Disable D365 CE integration in Mobile App\n\n===== Components Active\n\n- ProfileService (production, integrated with Mobile App)\n- EngagementService (production, integrated with Mobile App)\n- Event Bus (production, processing async Case creation)\n- Salesforce Production (receiving Cases from digital customers)\n- Braze (sending push notifications)\n- Mobile App (new version with Salesforce integration)\n- D365 Customer Engagement (disabled, read-only for historical lookups)\n\n===== Exit Criteria\n\n- Mobile App feedback submission success rate > 99.5%\n- End-to-end flow validated (Mobile App → Salesforce Case created)\n- Braze push notifications delivered successfully\n- Event Bus queue depth normal, DLQ empty\n- No critical incidents (P1/P2) in first 24 hours\n\n==== TS-4: Target State (Stable Production)\n\n===== Characteristics\n\n* ProfileService and EngagementService fully operational\n* All digital customer feedback routed to Salesforce\n* Event-driven architecture established\n* D365 CE decommissioned\n* First DDD bounded contexts implemented successfully\n\n===== Monitoring Period\n\n* Validate success criteria: feedback submission rate > 99.5%, no data loss\n* Monitor customer satisfaction score (target: +15% improvement)\n* Monitor average case resolution time (target: -20% improvement)\n* Support agents using unified Salesforce view across all channels\n\n===== D365 CE Retirement\n\n* D365 CE read-only access for historical Case lookups (if needed)\n* Decommission D365 CE infrastructure after 90 days\n* Archive D365 CE data for compliance/auditing\n\n===== Components Active\n\n- ProfileService (production)\n- EngagementService (production)\n- Event Bus (production)\n- Salesforce Production (system of record)\n- Braze (push notifications)\n- Mobile App (Salesforce integration)\n- App-specific database (deprecated, Contact data no longer updated)\n\n===== Success Criteria Achieved\n\n- All digital customer feedback routed to Salesforce\n- Support agents have unified customer view\n- D365 CE decommissioned\n- Customer satisfaction improved by 15%\n- Average case resolution time decreased by 20%\n- Zero data loss during transition\n\n=== Transition Dependencies\n\n[width=\"100%\",cols=\"40%,60%\",options=\"header\",]\n|===\n|Dependency |Owner/Status\n\n|*Salesforce production access*\n|Viva Energy Salesforce admin team - TBD\n\n|*Salesforce Case field mapping*\n|Viva Energy Salesforce admin team - TBD (map OTR feedback categories to Salesforce fields)\n\n|*Salesforce data isolation strategy*\n|Viva Energy Salesforce admin team - TBD (Record Types, queues, custom fields)\n\n|*Salesforce webhook configuration*\n|Viva Energy Salesforce admin team - TBD (Outbound Messages vs Platform Events)\n\n|*Event Bus infrastructure*\n|OTR Platform team - Existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis)\n\n|*Braze integration*\n|OTR Marketing team - Existing Braze account, EngagementService creates new campaigns\n\n|*Mobile App release window*\n|OTR Mobile team - Coordinate cutover timing with app release schedule\n\n|*App database access*\n|OTR Platform team - Read access for Contact migration\n\n|===\n\n=== Transition Validation Criteria\n\n==== Contact Migration Validation\n\n* 100% of app database Contacts migrated to Salesforce (zero data loss)\n* Email/phone/VCI matching accuracy > 95% (minimize duplicate Contacts)\n* ProfileService JIT lookups return correct Salesforce Contact IDs (smoke test sample)\n* Reconciliation report shows: X new Contacts created, Y existing Contacts updated\n\n==== Cutover Validation\n\n* Mobile App feedback submission success rate > 99.5% (including async Case creation)\n* End-to-end flow validated: Mobile App → ProfileService → EngagementService → Salesforce Case created\n* Braze push notifications delivered for Case creation and Case resolution\n* Event Bus queue depth within normal range (no backlog)\n* Dead letter queue empty (no failed Case creations)\n* Salesforce API rate limits not exceeded\n\n==== Production Monitoring (30 days)\n\n* Customer satisfaction score improves by 15% (compared to D365 CE baseline)\n* Average case resolution time decreases by 20% (Salesforce vs D365 CE)\n* Support agents confirm unified customer view across all channels\n* Zero critical incidents (P1 outages, data loss)\n\n=== Rollback Plan\n\n==== Rollback Triggers\n\n* Feedback submission success rate < 95% (below acceptable threshold)\n* Data loss or corruption detected in Salesforce\n* Salesforce API rate limits exceeded (Cases not created within SLA)\n* Critical bug blocking customer feedback submission\n\n==== Rollback Procedure\n\n1. **Revert Mobile App** to previous version (remove ProfileService/EngagementService integration, restore D365 CE integration)\n2. **Stop EngagementService** Case creation (prevent duplicate Cases in Salesforce)\n3. **Re-enable D365 CE** for customer feedback submission\n4. **Investigate root cause** (EngagementService logs, Salesforce API errors, Event Bus queue issues)\n5. **Fix and re-test** in sandbox environment\n6. **Retry cutover** when issues resolved\n\n==== Rollback Limitations\n\n* Cases created in Salesforce during cutover period remain in Salesforce (no reverse migration)\n* Contacts migrated to Salesforce remain (no rollback to app database)\n* Rollback only affects Mobile App integration (not data migration)\n\n=== Architectural Scope Boundaries\n\n==== Capabilities Included\n\n===== Business Capabilities\n\n* **Customer Feedback Submission**: Mobile App users can submit structured feedback (Category, Store Name, Time of Visit, Phone, Free Text Message) via EngagementService\n* **Customer Contact Management**: Just-In-Time (JIT) Contact reconciliation with Salesforce via ProfileService, ensuring every Mobile App user has a Salesforce Contact record\n* **Case Management Integration**: EngagementService creates Salesforce Cases asynchronously for customer feedback, support agents manage Cases in Salesforce Service Cloud\n* **Customer Notifications**: Push notifications via Braze when Cases are created, updated, or resolved (bidirectional integration: Mobile App → Salesforce → Mobile App)\n* **Unified Customer View**: Support agents see OTR digital customer feedback alongside other Viva Energy channels (fuel wholesale, Shell Card, retail) in single Salesforce instance\n* **Contact Data Migration**: One-time migration of app-specific customer database Contacts to Salesforce with upsert logic (email/phone/VCI matching)\n\n===== Technical Capabilities\n\n* **ProfileService Bounded Context**: First DDD bounded context implementation - JIT Contact reconciliation, Salesforce API facade, foundation for Flybuys integration\n* **EngagementService Bounded Context**: First DDD bounded context implementation - Customer feedback submission BFF, Anti-Corruption Layer for Salesforce, Braze integration orchestration\n* **Event-Driven Architecture**: Domain event publishing via Event Bus (SNS+SQS/EventBridge/Kinesis) for `SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted` events\n* **Async Processing Pattern**: Non-blocking Case creation with retry logic, exponential backoff, dead letter queue for operational resilience\n* **Anti-Corruption Layer Pattern**: EngagementService protects digital channels from Salesforce API changes, translates between OTR domain language and Salesforce\n* **Conformist Pattern**: ProfileService and EngagementService conform to existing Salesforce configuration (shared Viva Energy instance, multi-tenant governance)\n* **Salesforce Integration**: REST API integration for Contact CRUD and Case creation, webhook receiver for Case update notifications\n* **Braze Integration**: Push notification campaign triggers for Case lifecycle events (created, updated, resolved)\n* **Observability & Monitoring**: Dashboards, metrics, alerting for feedback submission rate, queue depth, API errors, Case creation latency\n* **Feature Flag Management**: Kill switches for emergency rollback (enable_salesforce_feedback_submission, enable_async_case_creation, etc.)\n\n==== Capabilities Excluded\n\n===== Business Capabilities Explicitly Out of Scope\n\n* **Historical Case Migration**: D365 CE Cases not migrated to Salesforce (ADR-CS-005 - fresh start, no Case migration)\n* **Multi-Channel Feedback Submission**: Web app, POS, call centre, email feedback channels not included (Mobile App only in this phase)\n* **Case Resolution by Digital Channels**: Support agents resolve Cases in Salesforce, not via Mobile App self-service\n* **Knowledge Base Integration**: Salesforce Knowledge Base articles not surfaced in Mobile App (future enhancement)\n* **Live Chat/Messaging**: Real-time chat support not included (Salesforce omnichannel capabilities not activated)\n* **Sentiment Analysis**: Automated feedback sentiment analysis not included (future enhancement with AI/ML)\n* **Customer Satisfaction Surveys**: Post-resolution CSAT surveys not included (separate initiative)\n* **Case Attachments**: Mobile App feedback submission does not support file uploads (photos, receipts) - text only\n* **Agent Desktop Integration**: Custom Salesforce UI for support agents not included (use standard Salesforce Service Console)\n* **Social Media Feedback**: Facebook, Twitter, Instagram feedback channels not integrated\n\n===== Technical Capabilities Explicitly Out of Scope\n\n* **Event Sourcing**: Domain events are ephemeral (not persisted for event sourcing/replay) - Event Bus only, no Event Store\n* **CQRS (Command Query Responsibility Segregation)**: ProfileService and EngagementService use same data model for reads/writes (no separate read models)\n* **Local Aggregate Persistence**: ProfileService and EngagementService are stateless (Salesforce is System of Record, no local database for Contact/Case)\n* **Saga Orchestration**: No distributed transactions or saga patterns required (single-step Case creation, not multi-step workflow)\n* **API Gateway Advanced Features**: Rate limiting, API versioning, API key management deferred to detailed design (basic routing only)\n* **GraphQL API**: ProfileService and EngagementService expose REST APIs only (GraphQL not required)\n* **Real-Time Sync**: Salesforce Contact updates by support agents not synced back to ProfileService (eventual consistency acceptable via JIT reconciliation)\n* **Multi-Region Deployment**: Single AWS region deployment (no multi-region failover/disaster recovery in this phase)\n* **Blue-Green Deployment**: Big bang cutover (ADR-CS-006), not blue-green or canary deployment strategy\n* **A/B Testing Framework**: Feature flags for rollback only, not for A/B testing or experimentation\n* **Custom Authentication**: Microsoft Entra External ID used for Mobile App authentication (no custom authentication logic in ProfileService/EngagementService)\n* **Data Residency Compliance**: Salesforce data residency governed by Viva Energy Salesforce configuration (no OTR-specific data residency requirements)\n\n===== Future Bounded Contexts Not in Scope\n\n* **LoyaltyService**: Flybuys integration, reward preferences, transaction adjudication (separate initiative)\n* **LocationService**: Store finder, proximity features, geofencing (separate initiative)\n* **PaymentService**: Payment processing, subscription billing (separate initiative)\n* **RecommendationService**: Personalized recommendations, next-best offers (separate initiative)\n\n===== Integration Patterns Not in Scope\n\n* **Shared Kernel**: No shared domain model between ProfileService and EngagementService (separate bounded contexts with clear boundaries)\n* **Partnership**: No joint development or coordination with external teams (Conformist pattern - we conform to Salesforce)\n* **Customer-Supplier (we're upstream)**: No downstream systems depend on ProfileService/EngagementService APIs yet (future bounded contexts will consume domain events)\n\n==== Architectural Dependencies on Future Initiatives\n\n*This Architecture Enables Future Initiatives*:\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Future Initiative |Architectural Enablement\n\n|*Flybuys Integration*\n|**ProfileService Contact Reconciliation Reused**: ProfileService establishes pattern for JIT Contact reconciliation with Salesforce, which will be extended for Flybuys partner linking (link:../architecture_definitions/flybuys_integration.adoc[see Flybuys Integration architecture]) +\n**Event Bus Infrastructure**: Domain event publishing pattern (`CustomerEnrolledInLoyalty`, `PartnerLinked`, etc.) reuses Event Bus established for EngagementService\n\n|*LoyaltyService Bounded Context*\n|**Event Bus Subscription**: LoyaltyService will consume `CustomerProfileCreated` events published by ProfileService (future enhancement) +\n**Salesforce Contact Integration**: LoyaltyService may query Salesforce Contacts for customer reward preferences (via ProfileService facade or direct Salesforce API)\n\n|*Web App Feedback Submission*\n|**EngagementService API Reuse**: Web app will call same EngagementService REST API for feedback submission (multi-channel support) +\n**Conformist Pattern**: Web app conforms to EngagementService API contract (no translation required)\n\n|*Multi-Channel Customer Support*\n|**EngagementService Extension**: Add support for email, call centre, POS feedback channels (extend EngagementService to handle multiple origins) +\n**Salesforce Case Origin Field**: Cases already tagged with Origin=Mobile App, extend to Origin=Web, POS, Call Centre, Email\n\n|*Knowledge Base Integration*\n|**EngagementService API Extension**: Add endpoint to query Salesforce Knowledge Base articles, surface in Mobile App for self-service support +\n**Anti-Corruption Layer**: EngagementService translates Salesforce Knowledge API to OTR domain language\n\n|*Customer Satisfaction Surveys*\n|**Event-Driven Trigger**: Subscribe to `SupportCaseResolved` events published by EngagementService, trigger CSAT survey via Braze +\n**Braze Integration Pattern**: Reuse EngagementService → Braze integration pattern for survey campaigns\n\n|*Sentiment Analysis*\n|**Event Subscription**: Subscribe to `CustomerFeedbackSubmitted` events, analyse feedback sentiment (AI/ML service) +\n**EngagementService Extension**: Enrich Case with sentiment score before creating in Salesforce\n\n|*RecommendationService Bounded Context*\n|**Event Subscription**: RecommendationService subscribes to `SupportCaseCreated` events to understand customer pain points and personalize recommendations +\n**Domain Event Pattern**: Reuse Event Bus publishing pattern established by EngagementService\n\n|===\n\n*This Architecture Depends on Future Initiatives*:\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Future Initiative |Dependency Description\n\n|*Salesforce Data Isolation Strategy*\n|**BLOCKER**: Viva Energy Salesforce admin team must define data isolation strategy (Record Types, custom fields, queues) before production deployment +\n**Impact**: Multi-tenant data visibility and security governance\n\n|*Salesforce Case Field Mapping*\n|**BLOCKER**: Viva Energy Salesforce admin team must define field mapping for OTR feedback categories (App, Service, Order, Rewards, Refund, Delete Account) +\n**Impact**: Case creation logic in EngagementService depends on finalized Salesforce schema\n\n|*Salesforce Webhook Mechanism*\n|**BLOCKER**: Viva Energy Salesforce admin team must configure webhook mechanism (Outbound Messages vs Platform Events vs Process Builder) for Case update notifications +\n**Impact**: EngagementService webhook receiver implementation depends on chosen mechanism\n\n|*Event Bus Technology Selection*\n|**DECISION REQUIRED**: Choose Event Bus implementation (SNS+SQS vs EventBridge vs Kinesis) for domain event publishing +\n**Impact**: Infrastructure provisioning, event schema design, consumer implementation\n\n|*Microservice Hosting Platform*\n|**DECISION REQUIRED**: Choose hosting platform for ProfileService and EngagementService (AWS Lambda vs ECS vs EKS) +\n**Impact**: Deployment architecture, auto-scaling strategy, operational overhead\n\n|*Observability Platform*\n|**DECISION REQUIRED**: Choose observability platform (AWS CloudWatch vs Datadog vs New Relic) for monitoring and alerting +\n**Impact**: Dashboard configuration, metric collection, alerting setup\n\n|===\n\n*Future Work After This Initiative*:\n\n* **Event Schema Registry**: Implement event schema versioning and registry for domain events (currently ad-hoc schemas)\n* **API Versioning Strategy**: Define API versioning approach for ProfileService and EngagementService (currently v1 only)\n* **Multi-Region Deployment**: Extend to multi-region for disaster recovery and global availability\n* **Event Store**: Persist domain events for event sourcing and audit trail (currently ephemeral Event Bus only)\n* **CQRS Pattern**: Separate read models for high-volume queries (currently same model for reads/writes)\n* **GraphQL API**: Expose GraphQL API for flexible client queries (currently REST only)\n* **Real-Time Sync**: Bi-directional sync between Salesforce and ProfileService for Contact updates (currently JIT reconciliation only)\n\n=== Technical Risks and Mitigation\n\n[width=\"100%\",cols=\"5%,20%,25%,25%,25%\",options=\"header\",]\n|===\n|ID |Risk |Impact |Likelihood |Mitigation\n\n|RISK-CS-001\n|*Salesforce API rate limits exceeded*: High feedback volume exceeds Salesforce API limits, Cases not created\n|HIGH (customers don't receive Case confirmation, support tickets lost)\n|MEDIUM (volume unknown, rate limits TBD)\n|• Gather expected feedback volume data before cutover +\n• Implement Event Bus queue throttling/rate limiting +\n• Monitor queue depth and API usage +\n• Scale background workers based on queue depth +\n• Alert ops team when approaching rate limits\n\n|RISK-CS-002\n|*Salesforce downtime*: Salesforce Service Cloud outage prevents Case creation\n|MEDIUM (Cases delayed but queued, customers wait for confirmation)\n|LOW (Salesforce SLA 99.9% uptime)\n|• Async Case creation with retry logic +\n• Event Bus queues buffer work during outage +\n• Customers get immediate \"Feedback submitted\" (not blocked) +\n• Monitor Salesforce status page, alert ops team +\n• Automatic retry when Salesforce recovers\n\n|RISK-CS-003\n|*Contact migration data quality issues*: App database Contact data incomplete or invalid\n|HIGH (migration fails validation, cutover delayed)\n|MEDIUM (legacy data quality unknown)\n|• Pre-migration data quality assessment +\n• Flexible upsert logic (match by email/phone/VCI) +\n• Validation report identifies data issues before production migration +\n• Manual cleanup for invalid records +\n• Dry-run migration in sandbox environment\n\n|RISK-CS-004\n|*Duplicate Contacts created*: Email matching fails, ProfileService creates duplicate Contacts\n|MEDIUM (support agents see multiple profiles for same customer)\n|MEDIUM (email changes, data quality issues)\n|• Salesforce duplicate detection rules (if available) +\n• ProfileService logs Contact creation for audit trail +\n• Manual duplicate cleanup process (support team) +\n• Future enhancement: VCI as Salesforce External ID for stable matching\n\n|RISK-CS-005\n|*Dead letter queue accumulation*: Failed Case creations not processed, queue grows\n|HIGH (customers don't receive Case confirmation, feedback lost)\n|LOW (retry logic handles most failures)\n|• Dead letter queue monitoring and alerting +\n• Ops team dashboard showing DLQ depth +\n• Manual intervention process (investigate and reprocess) +\n• Automated alerts when DLQ depth exceeds threshold +\n• Root cause analysis for recurring failures\n\n|RISK-CS-006\n|*Salesforce webhook failures*: Salesforce can't deliver Case update notifications to EngagementService\n|MEDIUM (customers don't get push notifications for Case resolution)\n|LOW (webhook mechanism reliable)\n|• Webhook retry logic and exponential backoff +\n• EngagementService logs webhook deliveries +\n• Monitor webhook delivery success rate +\n• Fallback: Poll Salesforce API for Case updates (if webhook fails persistently) +\n• Alert ops team when webhook delivery rate drops\n\n|RISK-CS-007\n|*Multi-tenant data isolation breach*: OTR digital Cases visible to other Viva Energy support teams\n|HIGH (privacy violation, compliance risk)\n|LOW (Salesforce governance controls)\n|• Work with Viva Energy Salesforce admin team on data isolation strategy +\n• Test data visibility in Salesforce sandbox (UAT with different user roles) +\n• Validate Record Types, queues, field-level security before production +\n• Audit Salesforce user permissions and sharing rules\n\n|RISK-CS-008\n|*Mobile App release coordination*: App release delayed, cutover window missed\n|MEDIUM (cutover delayed, D365 CE retirement delayed)\n|MEDIUM (release schedule conflicts)\n|• Coordinate cutover timing with Mobile team early +\n• Buffer time in migration plan (2-week contingency) +\n• Decouple backend deployment from Mobile App release (backend deployed first, app follows) +\n• Feature flag for feedback submission (enable when ready)\n\n|RISK-CS-009\n|*Event Bus infrastructure issues*: SNS/SQS/EventBridge downtime or misconfiguration\n|HIGH (Case creation blocked, domain events not published)\n|LOW (AWS SLA 99.99% uptime)\n|• Leverage existing AWS infrastructure (proven, reliable) +\n• Infrastructure as Code (IaC) for Event Bus configuration +\n• Integration testing in non-production environment +\n• Monitor Event Bus metrics (queue depth, throughput, errors) +\n• Alert ops team on Event Bus failures\n\n|RISK-CS-010\n|*Team DDD knowledge gap*: Team unfamiliar with DDD patterns, bounded contexts, event-driven architecture\n|MEDIUM (implementation delays, architectural inconsistencies)\n|HIGH (first DDD implementation)\n|• DDD training for development team (workshops, documentation) +\n• Architecture review sessions (validate bounded context design) +\n• Pair programming with experienced DDD practitioners +\n• Incremental implementation (start small, iterate) +\n• Document architectural patterns in CLAUDE.md\n\n|===\n\n== Assumptions and Constraints\n\n=== Assumptions\n\n[width=\"100%\",cols=\"8%,92%\",options=\"header\",]\n|===\n|ID |Assumption\n\n|ASM-CS-001\n|Viva Energy Salesforce admin team will provide Salesforce production access, sandbox environment, and support for Case field mapping and data isolation configuration\n\n|ASM-CS-002\n|App database Contact data is sufficiently complete for migration (email/phone/VCI available for matching)\n\n|ASM-CS-003\n|Expected customer feedback volume (100-150 submissions/day from 20k DAU) is well within Salesforce API rate limits, with capacity planning for 3x-10x growth\n\n|ASM-CS-004\n|Existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis) is sufficient for Event Bus implementation (no additional infrastructure provisioning required)\n\n|ASM-CS-005\n|Braze integration already exists and can be extended for Case-related push notifications (no new Braze account or major configuration changes)\n\n|ASM-CS-006\n|Mobile App users have email addresses associated with their accounts (required for ProfileService Contact reconciliation)\n\n|ASM-CS-007\n|D365 Customer Engagement historical Cases have limited business value and do not require migration to Salesforce\n\n|ASM-CS-008\n|Support agents are trained on Salesforce Service Cloud and require minimal additional training for OTR digital customer Cases\n\n|ASM-CS-009\n|Salesforce Service Cloud shared instance has capacity for OTR digital customer Contacts and Cases (no additional licensing or storage costs)\n\n|ASM-CS-010\n|Mobile App release schedule can accommodate cutover timing (Week 10 in migration plan)\n\n|===\n\n=== Constraints\n\n[width=\"100%\",cols=\"8%,92%\",options=\"header\",]\n|===\n|ID |Constraint\n\n|CON-CS-001\n|Must use shared Viva Energy Salesforce Service Cloud instance (cannot deploy separate OTR-specific instance)\n\n|CON-CS-002\n|Must conform to existing Salesforce configuration and governance (Record Types, custom fields, queues, data isolation strategy defined by Viva Energy admin team)\n\n|CON-CS-003\n|Contact migration must complete before Mobile App cutover (no parallel run of D365 CE and Salesforce)\n\n|CON-CS-004\n|Big bang cutover only (no phased rollout with feature flags or pilot users)\n\n|CON-CS-005\n|Salesforce API rate limits and authentication method constrained by Viva Energy Salesforce configuration (TBD)\n\n|CON-CS-006\n|Event Bus implementation must use existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis - cannot introduce new infrastructure components)\n\n|CON-CS-007\n|Mobile App feedback form must include specific fields: Category, Store Name, Time of Visit, Contact Phone Number, Free Text Message (no attachments)\n\n|CON-CS-008\n|D365 Customer Engagement must be decommissioned within 90 days post-cutover (ADR-CS-006)\n\n|CON-CS-009\n|ProfileService and EngagementService must be stateless (no local aggregate persistence, Salesforce is System of Record)\n\n|CON-CS-010\n|First DDD bounded context implementation (team learning curve, architectural patterns must be documented for future bounded contexts)\n\n|===\n\n== Non-Functional Requirements\n\n=== Performance Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-PERF-001\n|Mobile App feedback submission API response time (ProfileService + EngagementService)\n|p95 < 1 second, p99 < 2 seconds\n\n|NFR-PERF-002\n|ProfileService Contact reconciliation API response time (JIT lookup)\n|p95 < 500ms, p99 < 1 second\n\n|NFR-PERF-003\n|EngagementService async Case creation latency (end-to-end: feedback submitted → Case created in Salesforce)\n|p95 < 5 minutes, p99 < 10 minutes\n\n|NFR-PERF-004\n|Salesforce API call latency (Contact query, Contact create, Case create)\n|p95 < 2 seconds, p99 < 5 seconds\n\n|NFR-PERF-005\n|Event Bus message processing throughput\n|> 100 messages/second (support peak feedback volume)\n\n|NFR-PERF-006\n|Braze push notification delivery latency (Case created → notification delivered)\n|p95 < 30 seconds, p99 < 60 seconds\n\n|===\n\n=== Availability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-AVAIL-001\n|ProfileService availability\n|99.9% uptime (8.76 hours downtime/year)\n\n|NFR-AVAIL-002\n|EngagementService availability\n|99.9% uptime (8.76 hours downtime/year)\n\n|NFR-AVAIL-003\n|Feedback submission success rate (including async Case creation)\n|> 99.5% (includes retry logic for transient failures)\n\n|NFR-AVAIL-004\n|Graceful degradation: Salesforce downtime handling\n|Feedback submission still succeeds, Cases queued for async creation when Salesforce recovers\n\n|NFR-AVAIL-005\n|Graceful degradation: Braze downtime handling\n|Case creation proceeds, push notifications disabled temporarily (feature flag)\n\n|NFR-AVAIL-006\n|Planned maintenance window\n|< 4 hours/month, scheduled during low-traffic periods (2-6am ACST)\n\n|===\n\n=== Scalability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-SCALE-001\n|Concurrent Mobile App users (peak)\n|Support 20,000 DAU (Daily Active Users), ~150 concurrent users submitting feedback during peak hours\n\n|NFR-SCALE-002\n|Feedback submissions per day\n|Expected: 100-150 submissions/day based on 20k DAU (~0.5-0.75% submission rate) +\nCapacity: Support 500 submissions/day (3x expected volume for growth), 2,000 submissions/day (peak/incident scenarios)\n\n|NFR-SCALE-003\n|Auto-scaling: ProfileService and EngagementService\n|Auto-scale based on CPU/memory/request rate, scale up within 2 minutes\n\n|NFR-SCALE-004\n|Event Bus queue capacity\n|Support 100,000 queued messages (buffer for Salesforce downtime)\n\n|NFR-SCALE-005\n|Salesforce API rate limit compliance\n|Stay within 80% of Salesforce API rate limits (buffer for spikes)\n\n|NFR-SCALE-006\n|Future growth capacity\n|Architecture supports 10x growth (1,000-1,500 submissions/day based on 200k DAU) without major redesign\n\n|===\n\n=== Security Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-SEC-001\n|Mobile App authentication\n|Microsoft Entra External ID OAuth 2.0 with JWT tokens (existing CIAM)\n\n|NFR-SEC-002\n|API authorisation: ProfileService and EngagementService\n|JWT token validation, authenticated users only, user context propagation\n\n|NFR-SEC-003\n|Salesforce API authentication\n|OAuth 2.0 with Connected App and JWT bearer flow (service account)\n\n|NFR-SEC-004\n|Data encryption in transit\n|TLS 1.2+ for all API calls (Mobile App ↔ ProfileService/EngagementService ↔ Salesforce ↔ Braze)\n\n|NFR-SEC-005\n|Data encryption at rest\n|Salesforce encryption at rest (managed by Salesforce), Event Bus message encryption (AWS KMS)\n\n|NFR-SEC-006\n|Secret management\n|AWS Secrets Manager for Salesforce credentials, Braze API keys, OAuth tokens (no hardcoded secrets)\n\n|NFR-SEC-007\n|PII data handling\n|Contact data (email, phone, name) treated as PII, GDPR-compliant retention policies (Salesforce governance)\n\n|NFR-SEC-008\n|API rate limiting and throttling\n|API Gateway rate limiting (100 requests/second per user), prevent abuse and DoS\n\n|NFR-SEC-009\n|Logging and auditing\n|Log all API calls, Salesforce Contact/Case creates/updates, Event Bus publishes (no PII in logs)\n\n|NFR-SEC-010\n|Salesforce data isolation\n|Multi-tenant data isolation via Salesforce Record Types, queues, sharing rules (defined by Viva Energy admin team)\n\n|===\n\n=== Reliability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-REL-001\n|Retry logic: EngagementService → Salesforce Case creation\n|Exponential backoff (1s, 2s, 4s, 8s, 16s), max 5 retries, then dead letter queue\n\n|NFR-REL-002\n|Dead letter queue monitoring\n|Alert ops team immediately when DLQ depth > 0 (failed Case creations require manual intervention)\n\n|NFR-REL-003\n|Event Bus message durability\n|Messages persisted in Event Bus (SNS+SQS/EventBridge/Kinesis), not lost on service restart\n\n|NFR-REL-004\n|Idempotency: Case creation\n|EngagementService ensures duplicate feedback submissions don't create duplicate Cases (idempotency key)\n\n|NFR-REL-005\n|Circuit breaker: Salesforce API calls\n|Open circuit after 5 consecutive failures, half-open retry after 30 seconds\n\n|NFR-REL-006\n|Health checks: ProfileService and EngagementService\n|Health endpoints for load balancer checks, readiness and liveness probes\n\n|NFR-REL-007\n|Disaster recovery: Event Bus\n|Event Bus messages replicated across AWS availability zones (SQS/EventBridge/Kinesis HA)\n\n|===\n\n=== Maintainability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-MAINT-001\n|Code quality: ProfileService and EngagementService\n|> 80% test coverage (unit + integration tests), automated CI/CD pipeline\n\n|NFR-MAINT-002\n|API documentation\n|OpenAPI/Swagger specs for ProfileService and EngagementService, auto-generated API docs\n\n|NFR-MAINT-003\n|Deployment automation\n|Infrastructure as Code (Terraform/CloudFormation/CDK), zero-downtime deployments\n\n|NFR-MAINT-004\n|Logging: structured logs\n|JSON-formatted logs with correlation IDs, log levels (DEBUG, INFO, WARN, ERROR), centralized log aggregation\n\n|NFR-MAINT-005\n|Monitoring dashboards\n|Real-time dashboards for ProfileService, EngagementService, Event Bus (see Monitoring and Observability section)\n\n|NFR-MAINT-006\n|Alerting and on-call\n|PagerDuty/Opsgenie integration for P1/P2 alerts, on-call rotation for ops team\n\n|NFR-MAINT-007\n|Configuration management\n|Externalized configuration (environment variables, AWS Parameter Store), no hardcoded config\n\n|NFR-MAINT-008\n|Versioning: API and events\n|Semantic versioning (v1, v2), backward compatibility for API changes, event schema evolution\n\n|===\n\n=== Usability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-USE-001\n|Feedback submission UX\n|Mobile App user receives immediate \"Feedback submitted\" confirmation (< 1 second), not blocked by async Case creation\n\n|NFR-USE-002\n|Push notification delivery\n|Customer receives \"Your feedback has been received\" notification within 30 seconds of Case creation in Salesforce\n\n|NFR-USE-003\n|Case resolution notification\n|Customer receives \"Your case has been resolved\" notification within 30 seconds of support agent resolving Case\n\n|NFR-USE-004\n|Error messaging\n|User-friendly error messages for failed feedback submission (not technical errors), retry prompts\n\n|NFR-USE-005\n|Accessibility\n|Mobile App feedback form meets WCAG 2.1 AA accessibility standards (existing Mobile App compliance)\n\n|===\n\n=== Compliance Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-COMP-001\n|GDPR compliance: PII data\n|Customer Contact data (email, phone, name) managed per GDPR retention policies (Salesforce governance)\n\n|NFR-COMP-002\n|GDPR compliance: Right to erasure\n|Support \"Delete Account\" feedback category, trigger Contact deletion in Salesforce per GDPR Article 17\n\n|NFR-COMP-003\n|Data residency\n|Salesforce data residency governed by Viva Energy Salesforce configuration (regional compliance)\n\n|NFR-COMP-004\n|Audit trail\n|All Contact creates/updates, Case creates/updates logged for compliance auditing (Salesforce audit logs)\n\n|NFR-COMP-005\n|API security standards\n|OWASP API Security Top 10 compliance (injection prevention, authentication, authorisation, data exposure)\n\n|===\n\n== Monitoring and Observability\n\n=== Key Metrics\n\n[width=\"100%\",cols=\"25%,40%,35%\",options=\"header\",]\n|===\n|Metric Category |Metric |Target/Threshold\n\n|*Feedback Submission*\n|Feedback submission success rate (Mobile App → EngagementService)\n|> 99.5%\n\n|*Async Case Creation*\n|Case creation success rate (EngagementService → Salesforce)\n|> 99%\n\n|*Async Case Creation*\n|Case creation latency (time from feedback submission to Case created in Salesforce)\n|p95 < 5 minutes\n\n|*Event Bus*\n|Event Bus queue depth (pending Case creations)\n|< 100 messages\n\n|*Event Bus*\n|Dead letter queue depth (failed Case creations)\n|= 0 (alert on any failures)\n\n|*Salesforce API*\n|Salesforce API error rate\n|< 1%\n\n|*Salesforce API*\n|Salesforce API latency (Case creation)\n|p95 < 2 seconds\n\n|*Salesforce API*\n|Salesforce API rate limit utilization\n|< 80% of limit\n\n|*ProfileService*\n|Contact reconciliation success rate (JIT lookups)\n|> 99.5%\n\n|*ProfileService*\n|Contact reconciliation latency\n|p95 < 500ms\n\n|*Braze Notifications*\n|Push notification delivery rate (Case created/updated)\n|> 95%\n\n|*Salesforce Webhook*\n|Webhook delivery success rate (Salesforce → EngagementService)\n|> 99%\n\n|*Customer Satisfaction*\n|Customer satisfaction score (CSAT)\n|> 4.0/5.0 (improve by 15% from D365 CE baseline)\n\n|*Support Operations*\n|Average case resolution time\n|Decrease by 20% from D365 CE baseline\n\n|===\n\n=== Alerting Thresholds\n\n[width=\"100%\",cols=\"25%,50%,25%\",options=\"header\",]\n|===\n|Alert |Condition |Severity\n\n|*Feedback submission failures*\n|Feedback submission success rate < 95% over 5-minute window\n|P1 - Critical\n\n|*Dead letter queue accumulation*\n|Dead letter queue depth > 0 (any failed Case creations)\n|P2 - High\n\n|*Event Bus queue backlog*\n|Event Bus queue depth > 100 messages for > 15 minutes\n|P2 - High\n\n|*Salesforce API errors*\n|Salesforce API error rate > 5% over 5-minute window\n|P1 - Critical\n\n|*Salesforce API rate limits*\n|Salesforce API rate limit utilization > 90%\n|P2 - High\n\n|*Contact reconciliation failures*\n|ProfileService Contact reconciliation failure rate > 5% over 5-minute window\n|P2 - High\n\n|*Braze notification failures*\n|Braze push notification delivery rate < 80% over 15-minute window\n|P3 - Medium\n\n|*Salesforce webhook failures*\n|Salesforce webhook delivery success rate < 90% over 15-minute window\n|P2 - High\n\n|*Case creation latency*\n|Case creation latency p95 > 10 minutes\n|P3 - Medium\n\n|===\n\n=== Dashboards\n\n*ProfileService Dashboard:*\n\n* Contact reconciliation success rate (JIT lookups)\n* Contact reconciliation latency (p50, p95, p99)\n* Contact creation vs update ratio (new Contacts created vs existing Contacts updated)\n* Salesforce API error rate (Contact queries and creates)\n* Request rate and throughput\n\n*EngagementService Dashboard:*\n\n* Feedback submission success rate\n* Case creation success rate (async workflow)\n* Case creation latency (p50, p95, p99)\n* Event Bus queue depth (pending Case creations)\n* Dead letter queue depth (failed Case creations)\n* Salesforce API error rate (Case creation)\n* Salesforce API latency\n* Salesforce API rate limit utilization\n* Braze push notification delivery rate\n* Salesforce webhook delivery success rate\n\n*Event Bus Dashboard:*\n\n* Queue depth (pending messages)\n* Throughput (messages published/consumed per minute)\n* Dead letter queue depth (failed messages)\n* Consumer lag (time between publish and consume)\n\n*Customer Support Dashboard (Business Metrics):*\n\n* Total feedback submissions per day/week/month\n* Feedback category breakdown (App, Service, Order, Rewards, Refund, Delete Account)\n* Customer satisfaction score (CSAT) trend\n* Average case resolution time trend\n* Case volume by support team/queue\n* Unified customer view adoption (support agent feedback)\n<<<\n== Solution Validation\n\nThis section defines the validation criteria and testing approach for the solution.\n\n=== Functional Validation\n\n==== ProfileService API Testing\n\n*Test Scenarios*:\n1. **Happy Path**: Authenticated user requests Contact ID, existing Contact found in Salesforce, Contact ID returned\n2. **JIT Creation**: Authenticated user requests Contact ID, no existing Contact, new Contact created in Salesforce, Contact ID returned\n3. **Salesforce API Failure**: Salesforce unavailable, ProfileService returns 500 error, user retries\n4. **Invalid JWT**: Unauthenticated request, ProfileService returns 401 error\n\n*Acceptance Criteria*:\n- Contact reconciliation success rate > 99.5%\n- JIT Contact creation completes within 500ms (p95)\n\n==== EngagementService API Testing\n\n*Test Scenarios*:\n1. **Happy Path**: Valid feedback submission, immediate 202 Accepted response, Case created in Salesforce within 5 minutes, Braze notification delivered\n2. **Invalid Category**: Invalid feedback category, 400 Bad Request response with validation error\n3. **Salesforce Downtime**: Salesforce unavailable during async Case creation, message queued, retry logic executes, Case created when Salesforce recovers\n4. **Dead Letter Queue**: Case creation fails after 5 retries, message moved to DLQ, ops team alerted\n5. **Webhook Notification**: Support agent resolves Case in Salesforce, webhook triggers EngagementService, Braze push notification sent to customer\n\n*Acceptance Criteria*:\n- Feedback submission success rate > 99.5% (including async Case creation)\n- Async Case creation completes within 5 minutes (p95)\n- Webhook delivery success rate > 99%\n\n=== Non-Functional Validation\n\n==== Performance Testing\n\n*Load Testing*:\n\n*Baseline*: Expected 100-150 submissions/day from 20k DAU (~0.5-0.75% submission rate)\n\n- **Normal Load**: 1 submission/minute sustained for 2 hours (simulate typical daily pattern)\n- **3x Load**: 3 submissions/minute sustained for 1 hour (simulate busy period, 450 submissions/day)\n- **Peak Load (10x)**: 10 submissions/minute for 15 minutes (simulate incident scenario, app outage causing backlog)\n- **Stress Test**: 50 submissions/minute for 5 minutes (find breaking point, 20x normal)\n\n*Validation*:\n- API response time p95 < 1 second under 10x load\n- Event Bus queue depth remains manageable (< 100 messages)\n- No Case creation failures, all submissions processed successfully\n- Auto-scaling triggers appropriately for sustained load > 3x baseline\n\n*Acceptance Criteria*:\n- NFR-PERF-001 through NFR-PERF-006 validated under realistic load (3x and 10x baseline)\n- Auto-scaling triggers within 2 minutes of load increase\n- System handles 10x peak gracefully, 20x stress test identifies limits\n\n==== Resilience Testing\n\n*Salesforce API Failure Scenarios*:\n1. **Complete Outage**: Salesforce unavailable for 2 hours, Event Bus queues buffer work, Cases created when Salesforce recovers\n2. **Rate Limit Exceeded**: Salesforce rate limit hit, queue throttling activates, Cases created within SLA\n\n*Acceptance Criteria*:\n- NFR-AVAIL-004 validated (graceful degradation during Salesforce downtime)\n- Circuit breaker activates after 5 consecutive failures\n\n==== Security Validation\n\n*Penetration Testing*:\n- API authentication bypass attempts\n- SQL injection attempts\n- Webhook signature validation bypass\n\n*Acceptance Criteria*:\n- NFR-SEC-001 through NFR-SEC-010 validated\n- OWASP API Security Top 10 compliance verified\n\n=== Integration Validation\n\n==== End-to-End Testing\n\n*Full User Journey*:\n1. User authenticates via Microsoft Entra External ID\n2. Mobile App requests Contact ID from ProfileService (JIT reconciliation)\n3. User submits feedback via EngagementService\n4. Background worker creates Case in Salesforce\n5. Braze notification delivered to user\n6. Support agent resolves Case in Salesforce\n7. Salesforce webhook triggers EngagementService\n8. Braze notification delivered to user\n\n*Acceptance Criteria*:\n- End-to-end flow completes successfully in UAT\n- User receives both \"feedback submitted\" and \"case resolved\" notifications\n","structuredPatch":[{"oldStart":1723,"oldLines":6,"newStart":1723,"newLines":7,"lines":[" * Monitoring dashboards operational"," * Infrastructure fully codified (IaC)"," ","+[[wp-cs-004]]"," === WP-CS-004: Contact Migration Tooling"," "," ==== Description"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"8fbea35b-b0bc-42f9-be33-d8757a5ecc76"}
{"parentUuid":"089add43-e042-4a2a-8c0f-d395cb8cee37","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01WmE7d1UeKNDFFvLq1fRCUT","type":"tool_result","content":"The file /mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n  1786→* Migration tool execution time acceptable for production (freezes app database for minimum time)\n  1787→* Rollback procedure validated in sandbox\n  1788→* Documentation complete and approved\n  1789→\n  1790→[[wp-cs-005]]\n  1791→=== WP-CS-005: Mobile App Integration\n  1792→\n  1793→==== Description\n  1794→\n  1795→Update Mobile App to integrate with ProfileService and EngagementService APIs, replacing D365 CE integration.\n  1796→\n  1797→==== Deliverables"}]},"uuid":"266e8575-bb2c-4c33-9bb9-dbd8ead4be48","timestamp":"2026-01-09T03:10:46.013Z","toolUseResult":{"filePath":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","oldString":"=== WP-CS-005: Mobile App Integration\n\n==== Description","newString":"[[wp-cs-005]]\n=== WP-CS-005: Mobile App Integration\n\n==== Description","originalFile":"= Salesforce Customer Support - Solution Architecture\n:project-name: Salesforce Customer Support\n:togaf-adm-phase: Phase E: Opportunities & Solutions\n:last-updated: 2026-01-07\n:document-type: Solution Architecture Document\n:status: Discovery\n:version: 0.1\n:domain: Customer Support & Engagement\n:programme-lead:\n:domain-architect: O.Young@otr.com.au\n:architecture-definition: xref:architecture-definitions:salesforce_customer_support.adoc[Architecture Definitions/Salesforce Customer Support]\n:doctype: article\n:toc: left\n:toclevels: 4\n:sectanchors:\n:sectlinks:\n:sectnums:\n:icons: font\n:source-highlighter: highlightjs\n:experimental:\n:description:\n:keywords:\n\n<<<\n== Purpose and Scope\n\n=== Purpose\n\nThis Solution Architecture defines how the Salesforce Customer Support consolidation will be implemented - the specific technology products, configurations, interfaces, and deployment architecture that realise the xref:architecture-definitions:salesforce_customer_support.adoc[Salesforce Customer Support Architecture Definition].\n\nThis solution establishes the **first implementation of OTR's target Domain-Driven Design (DDD) architecture** by deploying two new bounded contexts (`ProfileService` and `EngagementService`) as microservices, consolidating customer support onto Salesforce Service Cloud, and implementing event-driven integration patterns that will serve as the foundation for future bounded contexts (including Flybuys integration).\n\n=== Vision\n\n> Unify customer support across all OTRG channels by consolidating OTR digital customer feedback onto Salesforce Service Cloud, establishing the foundational DDD architecture with ProfileService and EngagementService bounded contexts that protect digital channels from external system changes while enabling support agents to deliver exceptional customer experiences with complete interaction history.\n\n=== Architectural Approach\n\nThis architecture establishes OTR's **first bounded context implementation** using Domain-Driven Design strategic patterns:\n\n* *link:../bounded_context/profile.adoc[ProfileService]* (NEW bounded context): Just-In-Time Contact reconciliation with Salesforce, upsert by email, returns Salesforce Contact ID to digital channels - foundation for future Flybuys partner linking\n* *link:../bounded_context/engagement.adoc[EngagementService]* (NEW bounded context): Customer feedback submission facade, Anti-Corruption Layer for Salesforce Case creation, Braze integration for all outbound customer communications (push, email, SMS), async Case processing via Event Bus\n* *Event-driven integration* (NEW pattern): Domain event publishing using existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis) - first implementation establishing pattern for future bounded contexts\n* *Anti-Corruption Layer*: EngagementService isolates digital channels from Salesforce API changes, translates between OTR domain language and Salesforce Service Cloud API\n* *Conformist Pattern*: ProfileService and EngagementService conform to existing Salesforce configuration (shared Viva Energy instance, multi-tenant governance)\n* *Big bang cutover*: Single deployment after Contact migration, no phased rollout, D365 CE retirement post-cutover\n\n=== Scope\n\n==== In Scope\n\n* Solution Building Blocks (SBBs) - specific technology products and versions\n* Interface specifications (APIs, events, data formats)\n* Data architecture and schema specifications\n* Deployment architecture and infrastructure configuration\n* Transition architecture with migration phases\n* Technical validation criteria and testing approach\n* External system integration specifications\n* Physical data models and API schemas\n\n==== Out of Scope\n\n===== Covered in xref:architecture-definitions:salesforce_customer_support.adoc[Architecture Definition]\n\n* Business requirements and stakeholder analysis\n* Architecture decisions and rationale (ADRs)\n* Bounded context definitions and responsibilities\n* High-level integration patterns (ACL, Conformist, OHS+PL)\n* Business capability mapping and value streams\n* Architecture principles and governance\n\n===== Covered in Other Documents\n\n* Detailed design (class diagrams, sequence diagrams for all flows)\n* Implementation code and unit tests\n* Business case and return-on-investment analysis\n* Operational run books and support procedures\n\n<<<\n=== Architecture Overview\n\n[mermaid]\n----\n---\nconfig:\n  layout: elk\n---\nflowchart TB\n    Customer([\"Customer\"]) -- Uses --> MobileApp[\"Mobile App<br>iOS/Android\"]\n    Customer -- Shops at --> POS[\"OTR/OTR+ POS<br>D365 Commerce\"]\n    MobileApp -- Authenticate --> EntraID[\"Microsoft Entra\"]\n    MobileApp -- Identifies & Reconciles --> ProfileService[\"ProfileService\"]\n    ProfileService <-- Reconcile App User as Salesforce Contact --> Salesforce[\"Salesforce\"]\n    ProfileService -- On Create --> EventBus[\"EventBus\"]\n    EventBus -- Emits CreateUser Event --> LoyaltyService[\"LoyaltyService\"] & EngagementService[\"EngagementService\"]\n    LoyaltyService -- Reconcile Wallet --> EagleEye[\"EagleEye\"]\n    EngagementService -- Reconcile Braze Profile --> Braze[\"Braze\"]\n    EngagementService --> Salesforce\n    D365CE[\"D365CE\"] -- Data Migration --> Salesforce\n    MobileApp -- Submits Feedback --> EngagementService\n\n    Customer:::customer\n    MobileApp:::presentation\n    POS:::presentation\n    EntraID:::external\n    ProfileService:::newService\n    Salesforce:::external\n    EventBus:::infrastructure\n    LoyaltyService:::newService\n    EngagementService:::newService\n    EagleEye:::external\n    Braze:::external\n    D365CE:::external\n    classDef newService fill:#4CAF50,stroke:#2E7D32,stroke-width:3px,color:#fff\n    classDef external fill:#FF9800,stroke:#E65100,stroke-width:2px,color:#fff\n    classDef infrastructure fill:#2196F3,stroke:#0D47A1,stroke-width:2px,color:#fff\n    classDef presentation fill:#9C27B0,stroke:#4A148C,stroke-width:2px,color:#fff\n    classDef customer fill:#607D8B,stroke:#263238,stroke-width:2px,color:#fff\n----\n\n\n==== Key Architectural Patterns\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Pattern |Application |Rationale\n\n|*Anti-Corruption Layer (ACL)*\n|EngagementService → Salesforce Service Cloud\n|Protects digital channels (Mobile App, Web) from Salesforce API changes, translates between OTR domain language and Salesforce Case/Contact model, enables independent evolution of internal domain model\n\n|*Conformist*\n|ProfileService → Salesforce, EngagementService → Salesforce\n|Shared Viva Energy Salesforce instance - we conform to existing configuration, governance, and API contracts (external system we don't control)\n\n|*Backend-for-Frontend (BFF)*\n|EngagementService\n|Aggregates customer feedback submission, Contact lookup, async Case creation, and Braze notification orchestration for digital channel clients\n\n|*Event-Driven Architecture (OHS+PL)*\n|Event Bus (SNS+SQS/EventBridge/Kinesis)\n|Loose coupling between bounded contexts, async domain event publishing (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`), foundation for future bounded contexts\n\n|*Just-In-Time (JIT) Integration*\n|ProfileService → Salesforce Contact reconciliation\n|Reconcile app users as Salesforce Contacts on-demand (upsert by email), no pre-sync required, ensures Salesforce has current Contact data\n\n|*Async Processing*\n|EngagementService Case creation via Event Bus\n|Non-blocking user experience, resilience to Salesforce downtime, automatic retry with exponential backoff, dead letter queue for operations team intervention\n\n|*Strangler Fig*\n|Not applicable\n|Big bang cutover (no gradual migration) - D365 CE fully replaced, not incrementally strangled\n\n|===\n\n<<<\n== Solution Approach\n\n* Deploy xref:bounded-contexts:profile.adoc[ProfileService] and xref:bounded-contexts:engagement.adoc[EngagementService] as bounded context microservices\n* Implement Anti-Corruption Layers (ACLs) for Salesforce and Braze integration\n* Establish event-driven architecture as the foundational integration pattern\n* Big bang cutover (TS-1 → TS-4)\n\n=== Related Documentation\n\nThis solution architecture references detailed technical specifications:\n\n==== Architecture Definition\n\n* xref:architecture-definitions:salesforce_customer_support.adoc[Salesforce Customer Support - Architecture Definition] - Business requirements, architecture decisions (ADRs), bounded context definitions, high-level integration patterns\n\n==== Bounded Context Specifications\n\n* xref:bounded-contexts:profile.adoc[ProfileService Bounded Context] - JIT Contact reconciliation, aggregate definitions\n* xref:bounded-contexts:engagement.adoc[EngagementService Bounded Context] - Customer feedback facade, Anti-Corruption Layer\n\n==== Interface Specifications\n\nDetailed API specifications available in the specifications directory:\n\n* link:../../specifications/rest/profile-service-v1.yaml[ProfileService REST API v1] - OpenAPI 3.0 specification for `/profile/v1` endpoints (includes Salesforce Contact reconciliation `GET /contact-id`)\n* link:../../specifications/rest/engagement-service-v1.yaml[EngagementService REST API v1] - OpenAPI 3.0 specification for `/engagement/v1` endpoints (includes `POST /feedback`)\n* link:../../specifications/events/engagement-events.json[Engagement Domain Events] - CloudEvents 1.0 JSON Schema for `SupportCaseCreated`, `SupportCaseUpdated`, `SupportCaseResolved`, `CustomerFeedbackSubmitted`\n\n==== External System Documentation\n\n* https://developer.salesforce.com/docs/atlas.en-us.api_rest.meta/api_rest/[Salesforce REST API Documentation] - Contact and Case object APIs\n* https://www.braze.com/docs/api/endpoints/messaging/send_messages/post_send_triggered_campaigns/[Braze Campaign Trigger API] - Push notification campaigns\n\n<<<\n== Executive Summary\n\n=== Challenge\n\nOTR digital customers (Mobile App, Web) currently submit feedback and support requests to D365 Customer Engagement, while Viva Energy's broader business units (fuel wholesale, Shell Card customers, other retail channels) use Salesforce Service Cloud. This creates:\n\n* *Fragmented customer support platform*: Customer support data split across two systems, preventing support agents from having a unified view of customer interactions across all channels\n* *Operational inefficiency*: Maintaining two separate customer support platforms increases operational overhead and costs\n* *Poor support experience*: D365 CE is not working well for digital customer support, impacting customer satisfaction and case resolution times\n* *Post-merger consolidation opportunity*: Following Viva Energy's acquisition of OTR, strategic alignment on Salesforce as the enterprise customer support platform\n\n=== Solution\n\nThis architecture establishes the **foundational Domain-Driven Design (DDD) implementation** for OTR's target state architecture by introducing two new bounded contexts (link:../bounded_context/profile.adoc[ProfileService], link:../bounded_context/engagement.adoc[EngagementService]) and event-driven integration patterns:\n\n==== New Bounded Contexts\n\n* *link:../bounded_context/profile.adoc[ProfileService]* (NEW): Just-In-Time (JIT) Contact reconciliation with Salesforce, upsert by email, returns Salesforce Contact ID to Mobile App\n* *link:../bounded_context/engagement.adoc[EngagementService]* (NEW): Customer feedback submission, Anti-Corruption Layer (ACL) for Salesforce Case creation, Braze integration for all outbound customer communications (push, email, SMS), async Case processing via Event Bus\n* *Event Bus* (NEW pattern): Domain event publishing using existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis) - first implementation of event-driven architecture pattern\n\n==== Integration Architecture\n\n* *Salesforce = System of Record*: Salesforce Service Cloud (shared Viva Energy instance) owns Contact and Case data\n* *Conformist Pattern*: ProfileService and EngagementService conform to existing Salesforce configuration and API contracts\n* *Anti-Corruption Layer*: EngagementService protects digital channels from Salesforce API changes, translates between OTR domain language and Salesforce\n* *Async Case Creation*: Non-blocking user experience, resilience to Salesforce downtime, automatic retry with exponential backoff, dead letter queue for failed Cases\n* *Event-Driven Notifications*: Salesforce webhook → EngagementService → Braze for all customer communications (push, email, SMS) on Case status updates\n\n==== Migration Approach\n\n* *Contact Migration*: One-time migration from app-specific database → Salesforce (upsert with flexible matching by email/phone/VCI)\n* *No Case Migration*: Historical D365 CE Cases not migrated (fresh start in Salesforce)\n* *Big Bang Cutover*: Single deployment, no phased rollout or parallel run\n* *D365 CE Retirement*: Complete decommissioning of D365 Customer Engagement post-cutover\n\n=== Key Architectural Significance\n\nThis migration establishes the first implementation of OTR's target DDD architecture:\n\n* First bounded contexts implemented (ProfileService, EngagementService)\n* First event-driven domain event pattern (foundation for future bounded contexts)\n* Foundation for Flybuys integration (ProfileService Contact reconciliation reused)\n* Establishes integration patterns (Conformist, ACL, Event-Driven) for future services\n\n=== Success Criteria\n\n* All digital customer feedback routed to Salesforce Service Cloud within 30 days of launch\n* Support agents have unified customer view across all Viva Energy channels (digital, wholesale, Shell Card, other retail)\n* D365 Customer Engagement decommissioned within 90 days post-cutover\n* Customer satisfaction score improves by 15% within 6 months\n* Average case resolution time decreases by 20% within 6 months\n* Zero data loss during Contact migration (100% validation pass rate)\n* Mobile App feedback submission success rate > 99.5% (including async Case creation)\n\n=== Technical Constraints\n\n* Shared Salesforce instance (Viva Energy multi-tenant environment)\n* Conform to existing Salesforce configuration and governance (data isolation strategy TBD with Salesforce admin team)\n* Contact migration must complete before cutover (no parallel run)\n* Async Case creation mandatory (non-blocking user experience)\n* Expected volume: 100-150 feedback submissions/day from 20k DAU (~0.5-0.75% submission rate), architecture capacity planned for 3x-10x growth\n\n=== Open Technical Decisions (TBD)\n\n* Salesforce Case field mapping for digital feedback categories (App, Service, Order, Rewards, Refund, Delete Account)\n* Salesforce data isolation strategy (Record Types, custom fields, queues)\n* Salesforce REST API authentication method (OAuth 2.0, Connected App, JWT bearer flow)\n* Salesforce webhook mechanism for Case updates (Outbound Messages, Platform Events, Process Builder)\n* Retry policy configuration (attempts, backoff intervals)\n* Salesforce API rate limit strategy (expected volume: 100-150 submissions/day from 20k DAU, capacity planning for 3x-10x growth)\n\n== Technical Requirements\n\n[width=\"100%\",cols=\"8%,92%\",options=\"header\",]\n|===\n|ID |Description\n\n|TR-CS-001\n|Every Mobile App user must have a Salesforce Contact record in Salesforce Service Cloud (shared Viva Energy instance)\n\n|TR-CS-002\n|ProfileService must reconcile Mobile App users as Salesforce Contacts using Just-In-Time (JIT) upsert by email address\n\n|TR-CS-003\n|ProfileService must return Salesforce Contact ID to Mobile App for feedback submission\n\n|TR-CS-004\n|Mobile App must support customer feedback submission with fields: Category (App, Service, Order, Rewards, Refund, Delete Account), Store Name, Time of Visit, Contact Phone Number, Free Text Message\n\n|TR-CS-005\n|EngagementService must create Salesforce Cases asynchronously via Event Bus (non-blocking user experience)\n\n|TR-CS-006\n|EngagementService must acknowledge feedback submission immediately to Mobile App user (\"Feedback submitted\" confirmation)\n\n|TR-CS-007\n|EngagementService must send push notification to customer via Braze when Case is successfully created in Salesforce\n\n|TR-CS-008\n|EngagementService must retry failed Case creation with configurable exponential backoff and dead letter queue for operations team intervention\n\n|TR-CS-009\n|Salesforce must be the System of Record for Contact and Case data (no local persistence in ProfileService or EngagementService)\n\n|TR-CS-010\n|Contact migration from app-specific database to Salesforce must complete before Mobile App cutover (upsert with flexible matching by email/phone/VCI)\n\n|TR-CS-011\n|No Case migration from D365 Customer Engagement to Salesforce (fresh start, historical Cases not migrated)\n\n|TR-CS-012\n|EngagementService must publish domain events (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`) to Event Bus for consumption by other bounded contexts\n\n|TR-CS-013\n|EngagementService must receive Salesforce webhook notifications when Cases are updated/resolved by support agents\n\n|TR-CS-014\n|EngagementService must trigger Braze push notifications to customers when Cases are updated/resolved (via Salesforce webhook → EngagementService → Braze)\n\n|TR-CS-015\n|ProfileService and EngagementService must conform to existing Salesforce configuration and API contracts (Conformist pattern)\n\n|TR-CS-016\n|All changes must be communicated using event-driven architecture via Event Bus (using existing AWS infrastructure: SNS+SQS/EventBridge/Kinesis)\n\n|TR-CS-017\n|Mobile App feedback submission success rate must exceed 99.5% (including async Case creation completion)\n\n|TR-CS-018\n|Contact migration must achieve 100% validation pass rate (zero data loss)\n\n|TR-CS-019\n|D365 Customer Engagement must be fully decommissioned within 90 days post-cutover\n\n|===\n\n== Technical Architecture\n\n=== Technical Capability Requirements\n\n==== Requirements Traceability\n\n[width=\"100%\",cols=\"15%,50%,35%\",options=\"header\",]\n|===\n|Requirement ID |Requirement Summary |Architectural Building Blocks\n\n|TR-CS-001\n|Every Mobile App user must have Salesforce Contact record\n|ABB-CS-001 (ProfileService), ABB-CS-004 (Salesforce), ABB-CS-007 (Contact Migration Tool)\n\n|TR-CS-002\n|ProfileService JIT Contact reconciliation via upsert by email\n|ABB-CS-001 (ProfileService), ABB-CS-004 (Salesforce)\n\n|TR-CS-003\n|ProfileService returns Salesforce Contact ID to Mobile App\n|ABB-CS-001 (ProfileService), ABB-CS-006 (Mobile App)\n\n|TR-CS-004\n|Mobile App supports feedback submission with structured fields\n|ABB-CS-006 (Mobile App), ABB-CS-002 (EngagementService)\n\n|TR-CS-005\n|EngagementService creates Salesforce Cases asynchronously\n|ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus), ABB-CS-004 (Salesforce)\n\n|TR-CS-006\n|EngagementService immediate acknowledgment to Mobile App\n|ABB-CS-002 (EngagementService), ABB-CS-006 (Mobile App)\n\n|TR-CS-007\n|EngagementService sends push notification via Braze on Case creation\n|ABB-CS-002 (EngagementService), ABB-CS-005 (Braze)\n\n|TR-CS-008\n|EngagementService retry logic with exponential backoff and DLQ\n|ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus)\n\n|TR-CS-009\n|Salesforce is System of Record for Contact and Case data\n|ABB-CS-004 (Salesforce), ABB-CS-001 (ProfileService - stateless), ABB-CS-002 (EngagementService - stateless)\n\n|TR-CS-010\n|Contact migration before Mobile App cutover\n|ABB-CS-007 (Contact Migration Tool), ABB-CS-004 (Salesforce)\n\n|TR-CS-011\n|No Case migration from D365 CE (fresh start)\n|ABB-CS-004 (Salesforce) - no migration tooling required\n\n|TR-CS-012\n|EngagementService publishes domain events to Event Bus\n|ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus)\n\n|TR-CS-013\n|EngagementService receives Salesforce webhook notifications\n|ABB-CS-002 (EngagementService), ABB-CS-004 (Salesforce)\n\n|TR-CS-014\n|EngagementService triggers Braze notifications on Case updates\n|ABB-CS-002 (EngagementService), ABB-CS-004 (Salesforce), ABB-CS-005 (Braze)\n\n|TR-CS-015\n|ProfileService and EngagementService conform to Salesforce config\n|ABB-CS-001 (ProfileService), ABB-CS-002 (EngagementService), ABB-CS-004 (Salesforce)\n\n|TR-CS-016\n|Event-driven architecture via Event Bus\n|ABB-CS-003 (Event Bus), ABB-CS-002 (EngagementService)\n\n|TR-CS-017\n|Mobile App feedback submission success rate > 99.5%\n|ABB-CS-006 (Mobile App), ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus), ABB-CS-004 (Salesforce)\n\n|TR-CS-018\n|Contact migration 100% validation pass rate\n|ABB-CS-007 (Contact Migration Tool), ABB-CS-004 (Salesforce)\n\n|TR-CS-019\n|D365 CE decommissioned within 90 days post-cutover\n|All ABBs (replacement system operational)\n\n|===\n\n=== Service Catalogues\n\n==== Application Portfolio Catalogue\n\n[width=\"100%\",cols=\"20%,15%,15%,15%,35%\",options=\"header\",]\n|===\n|Application |Lifecycle State |Owner |Hosting Platform |Description\n\n|*ProfileService*\n|NEW\n|OTR Platform Team\n|AWS (TBD: Lambda/ECS/EKS)\n|JIT Contact reconciliation with Salesforce, returns Salesforce Contact ID, foundation for Flybuys integration\n\n|*EngagementService*\n|NEW\n|OTR Platform Team\n|AWS (TBD: Lambda/ECS/EKS)\n|Customer feedback submission facade, ACL for Salesforce Case creation, Braze integration for all outbound communications (push, email, SMS), webhook receiver\n\n|*Mobile App (iOS)*\n|ACTIVE (UPDATE)\n|OTR Mobile Team\n|Apple App Store\n|iOS native app with feedback form, integrate with ProfileService and EngagementService APIs\n\n|*Mobile App (Android)*\n|ACTIVE (UPDATE)\n|OTR Mobile Team\n|Google Play Store\n|Android native app with feedback form, integrate with ProfileService and EngagementService APIs\n\n|*Salesforce Service Cloud*\n|ACTIVE (EXPAND)\n|Viva Energy Salesforce Admin Team\n|Salesforce (SaaS)\n|Shared Viva Energy instance, System of Record for Contact and Case data, adding OTR digital customer support\n\n|*Braze*\n|ACTIVE (EXTEND)\n|OTR Marketing Team\n|Braze (SaaS)\n|Marketing automation platform, EngagementService triggers push notifications for Case updates\n\n|*D365 Customer Engagement*\n|RETIRE\n|OTR Support Team\n|Microsoft Azure (SaaS)\n|Legacy customer support platform, decommissioned within 90 days post-cutover\n\n|*App-Specific Customer Database*\n|RETIRE\n|OTR Platform Team\n|AWS (RDS/DynamoDB)\n|Legacy customer contact storage, one-time migration to Salesforce, then deprecated\n\n|*Event Bus*\n|NEW\n|OTR Platform Team\n|AWS (SNS+SQS/EventBridge/Kinesis)\n|Domain event publishing infrastructure for bounded context integration\n\n|*Contact Migration Tool*\n|TEMPORARY\n|OTR Platform Team\n|AWS (Script/Lambda)\n|One-time migration app database → Salesforce with upsert logic, retired after migration complete\n\n|===\n\n==== Technology Capability Requirements\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Technology Capability |Implementation Technology (TBD in detailed design) |Requirements\n\n|*Microservice Hosting*\n|AWS Lambda / ECS / EKS\n|Host ProfileService and EngagementService with auto-scaling, high availability, monitoring\n\n|*API Gateway*\n|AWS API Gateway / Application Load Balancer\n|REST API routing, authentication, rate limiting, request validation for ProfileService and EngagementService\n\n|*Event Bus*\n|AWS SNS+SQS / EventBridge / Kinesis\n|Domain event publishing, async message processing, retry logic, dead letter queue\n\n|*Salesforce Integration*\n|Salesforce REST API / SOAP API\n|Contact CRUD operations, Case creation, webhook notifications, OAuth 2.0 authentication\n\n|*Braze Integration*\n|Braze REST API / SDK\n|Push notification campaign triggers, customer profile reconciliation\n\n|*Authentication & Authorisation*\n|Microsoft Entra External ID / AWS Cognito\n|Mobile App user authentication, API authorisation, JWT token validation\n\n|*Observability & Monitoring*\n|AWS CloudWatch / Datadog / New Relic\n|Application metrics, logs, traces, dashboards, alerting (feedback submission rate, queue depth, API errors)\n\n|*Secret Management*\n|AWS Secrets Manager / Parameter Store\n|Salesforce credentials, Braze API keys, OAuth tokens, encryption keys\n\n|*Database (Migration Tool)*\n|AWS RDS / DynamoDB (read-only access)\n|Contact migration from app-specific database\n\n|*CI/CD Pipeline*\n|GitHub Actions / AWS CodePipeline\n|Automated build, test, deployment for ProfileService, EngagementService, Mobile App\n\n|*Infrastructure as Code*\n|Terraform / AWS CloudFormation / CDK\n|Declarative infrastructure provisioning for Event Bus, microservices, monitoring\n\n|*API Documentation*\n|OpenAPI / Swagger\n|ProfileService and EngagementService API specifications for Mobile App integration\n\n|===\n\n==== Feature Flag Register\n\n*Note*: Per ADR-CS-006 (big bang cutover, not phased rollout), feature flags are minimal and used primarily for emergency rollback/kill switches.\n\n[width=\"100%\",cols=\"20%,15%,35%,30%\",options=\"header\",]\n|===\n|Feature Flag |Default State |Purpose |Rollback Scenario\n\n|*enable_salesforce_feedback_submission*\n|OFF (pre-cutover), ON (post-cutover)\n|Enable/disable feedback submission to EngagementService → Salesforce (kill switch for emergency rollback to D365 CE)\n|Feedback submission success rate < 95%, Salesforce API failures, critical bugs - revert to D365 CE integration\n\n|*enable_async_case_creation*\n|ON\n|Enable/disable async Case creation via Event Bus (fallback to synchronous processing if Event Bus issues)\n|Event Bus infrastructure failures, queue backlog unmanageable - temporary synchronous processing\n\n|*enable_braze_notifications*\n|ON\n|Enable/disable Braze push notifications for Case updates (degrade gracefully if Braze integration fails)\n|Braze API failures, notification delivery rate < 80% - disable notifications temporarily\n\n|*enable_jit_contact_reconciliation*\n|ON\n|Enable/disable ProfileService JIT Contact reconciliation (fallback to cached Contact IDs if Salesforce unavailable)\n|Salesforce API downtime, Contact reconciliation failures > 5% - use cached Contact IDs temporarily\n\n|*enable_salesforce_webhook_processing*\n|ON\n|Enable/disable Salesforce webhook processing for Case updates (fallback to polling if webhook failures)\n|Webhook delivery failures, authentication issues - temporary polling fallback\n\n|===\n\n*Feature Flag Management*:\n\n* Feature flags managed via AWS AppConfig / LaunchDarkly / custom feature flag service (TBD in detailed design)\n* Mobile App feature flags controlled server-side (no app release required for flag changes)\n* Backend service feature flags configured via environment variables / configuration service\n* Feature flag changes logged and audited (who changed, when, reason)\n* Post-cutover monitoring: Gradual removal of feature flags once system stability confirmed (30-60 days)\n\n==== Data Entity Catalogue\n\n[width=\"100%\",cols=\"20%,15%,35%,30%\",options=\"header\",]\n|===\n|Data Entity |System of Record |Key Attributes |Lifecycle\n\n|*Contact*\n|Salesforce Service Cloud\n|• Contact ID (Salesforce 15/18-char ID) +\n• Email (primary matching key) +\n• First Name, Last Name +\n• Phone Number +\n• Viva Consumer ID (VCI) +\n• Account (Viva Energy customer account) +\n• Record Type (OTR Digital vs other channels)\n|Created: ProfileService JIT reconciliation or Contact Migration Tool +\nUpdated: ProfileService JIT upsert (email changes), Salesforce (manual updates by support agents) +\nDeleted: Salesforce retention policy (GDPR/compliance)\n\n|*Case*\n|Salesforce Service Cloud\n|• Case Number (Salesforce auto-generated) +\n• Contact ID (reference to Contact) +\n• Subject (derived from Category) +\n• Description (Free Text Message) +\n• Category (App, Service, Order, Rewards, Refund, Delete Account) +\n• Store Name (OTR location) +\n• Time of Visit +\n• Status (New, In Progress, Resolved, Closed) +\n• Priority, Origin (Mobile App) +\n• Owner (support agent/queue)\n|Created: EngagementService async Case creation +\nUpdated: Support agents (Salesforce UI), EngagementService (webhook processing) +\nDeleted: Salesforce retention policy (archive after X years)\n\n|*Feedback Submission (transient)*\n|None (not persisted)\n|• Salesforce Contact ID +\n• Category +\n• Store Name +\n• Time of Visit +\n• Contact Phone Number +\n• Free Text Message\n|Created: Mobile App user submission +\nProcessed: EngagementService publishes to Event Bus, Case created in Salesforce +\nNot persisted in ProfileService/EngagementService (stateless)\n\n|*Domain Events*\n|Event Bus (ephemeral)\n|**SupportCaseCreated**: +\n• Case Number, Contact ID, Category, Timestamp +\n**SupportCaseUpdated**: +\n• Case Number, Status, Updated By, Timestamp +\n**SupportCaseResolved**: +\n• Case Number, Resolution, Resolved By, Timestamp +\n**CustomerFeedbackSubmitted**: +\n• Contact ID, Category, Timestamp\n|Published: EngagementService +\nConsumed: Other bounded contexts (future), Braze notification triggers +\nRetention: Short-lived (minutes to hours), not persisted for event sourcing\n\n|*Braze Customer Profile*\n|Braze\n|• External User ID (VCI or Email) +\n• Push Notification Tokens (iOS/Android) +\n• Notification Preferences +\n• Campaign Engagement History\n|Created/Updated: EngagementService on Case creation/update +\nManaged: Braze (external SaaS)\n\n|===\n\n*Data Migration Entities*:\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Source Entity |Target Entity |Migration Strategy\n\n|*App Database Contact*\n|Salesforce Contact\n|One-time migration via Contact Migration Tool: +\n• Upsert by email (primary), phone (secondary), VCI (tertiary) +\n• Map: Email → Email, Name → First/Last Name, Phone → Phone, VCI → External ID +\n• Validation: 100% data integrity check, reconciliation report\n\n|*D365 CE Case*\n|Not migrated\n|ADR-CS-005: No Case migration (fresh start in Salesforce) +\nD365 CE Cases archived separately for compliance if needed\n\n|===\n\n==== Data Quality & Validation\n\n*Contact Migration Validation Rules*:\n\n* Email format validation (RFC 5322 compliance)\n* Phone number format validation (E.164 international format)\n* VCI format validation (alphanumeric, length constraints)\n* Duplicate detection: Flag potential duplicates for manual review (same email/phone combination)\n* Mandatory fields: Email (required), First Name, Last Name (required for Salesforce Contact)\n\n*Case Creation Validation Rules*:\n\n* Contact ID must exist in Salesforce (validated by EngagementService before Case creation)\n* Category must be one of: App, Service, Order, Rewards, Refund, Delete Account\n* Free Text Message maximum length: 32,000 characters (Salesforce Case Description limit)\n* Store Name validated against OTR location master data (optional - warn if not found)\n\n<<<\n== Solution Building Blocks\n\nThis section defines the specific technology products, configurations, and implementation details for each Solution Building Block (SBB).\n\n=== Technology Portfolio Catalogue\n\n[width=\"100%\",cols=\"10%,20%,25%,25%,20%\",options=\"header\",]\n|===\n|SBB ID |Component |Technology Product |Version/Configuration |Deployment Platform\n\n|SBB-CS-001\n|ProfileService Microservice\n|.NET 8 / Node.js 20 LTS\n|RESTful API, containerised\n|AWS ECS Fargate / Lambda\n\n|SBB-CS-002\n|EngagementService Microservice\n|.NET 8 / Node.js 20 LTS\n|RESTful API, containerised, async workers\n|AWS ECS Fargate / Lambda\n\n|SBB-CS-003\n|Event Bus\n|AWS SNS + SQS / EventBridge\n|Standard queues, FIFO for ordering\n|AWS (managed service)\n\n|SBB-CS-004\n|API Gateway\n|AWS API Gateway / ALB\n|REST API, JWT validation\n|AWS (managed service)\n\n|SBB-CS-005\n|Salesforce Integration Layer\n|Salesforce REST API Client\n|OAuth 2.0 JWT bearer flow\n|Embedded in SBB-CS-001/002\n\n|SBB-CS-006\n|Braze Integration Layer\n|Braze REST API SDK\n|API key authentication\n|Embedded in SBB-CS-002\n\n|SBB-CS-007\n|Contact Migration Tool\n|Python 3.11 / .NET 8\n|One-time batch script\n|AWS Lambda / EC2\n\n|SBB-CS-008\n|Application Monitoring\n|AWS CloudWatch / Datadog\n|Metrics, logs, traces, dashboards\n|AWS / SaaS\n\n|SBB-CS-009\n|Secret Management\n|AWS Secrets Manager\n|KMS encryption\n|AWS (managed service)\n\n|SBB-CS-010\n|Mobile App (iOS)\n|SwiftUI, Kotlin Multiplatform\n|iOS 15+\n|Apple App Store\n\n|SBB-CS-011\n|Mobile App (Android)\n|Jetpack Compose, Kotlin Multiplatform\n|Android 8+\n|Google Play Store\n\n|SBB-CS-012\n|Feature Flag Service\n|AWS AppConfig / LaunchDarkly\n|Server-side flags, real-time updates\n|AWS / SaaS\n\n|===\n\n<<<\n== Data Architecture\n\nThis section defines the physical data models, event schemas, and API request/response formats.\n\n=== Domain Event Schemas\n\nAll domain events follow the https://cloudevents.io/[CloudEvents 1.0] specification for consistency and interoperability.\n\n*Event Schema Specifications*: See // TODO: Add to Antora - specifications/events/engagement-events.json[Engagement Service Event Schemas] for complete JSON schemas and examples.\n\n==== Event Catalogue\n\n[width=\"100%\",cols=\"30%,20%,50%\",options=\"header\",]\n|===\n|Event Type |Publisher |Description\n\n|`SupportCaseCreated`\n|EngagementService\n|Published when EngagementService successfully creates a Case in Salesforce after async processing\n\n|`SupportCaseUpdated`\n|EngagementService (via Salesforce webhook)\n|Published when a support agent updates a Case in Salesforce (status, priority, comment changes)\n\n|`SupportCaseResolved`\n|EngagementService (via Salesforce webhook)\n|Published when a support agent resolves/closes a Case in Salesforce\n\n|`CustomerFeedbackSubmitted`\n|EngagementService\n|Published when customer submits feedback via Mobile App (before async Case creation)\n\n|===\n\n*Event Format*: All events use CloudEvents 1.0 envelope with event-specific payload in the `data` field.\n\n*Schema Location*: `specifications/events/engagement-events.json`\n\n=== API Request/Response Schemas\n\n==== ProfileService: GET /profile/contact-id\n\n*Response* (200 OK):\n[source,json]\n----\n{\n  \"contactId\": \"0034X00000ABCDEFG\",\n  \"email\": \"customer@example.com\",\n  \"firstName\": \"John\",\n  \"lastName\": \"Smith\"\n}\n----\n\n==== EngagementService: POST /feedback\n\n*Request*:\n[source,json]\n----\n{\n  \"contactId\": \"0034X00000ABCDEFG\",\n  \"category\": \"App\",\n  \"storeName\": \"OTR Adelaide\",\n  \"timeOfVisit\": \"2026-01-07T12:00:00Z\",\n  \"contactPhoneNumber\": \"+61412345678\",\n  \"message\": \"App crashed when submitting feedback\"\n}\n----\n\n*Response* (202 Accepted):\n[source,json]\n----\n{\n  \"feedbackId\": \"fb-2026-01-07-12345\",\n  \"status\": \"submitted\",\n  \"message\": \"Your feedback has been submitted!\"\n}\n----\n\n=== Salesforce Field Mappings\n\n==== Case Object Mapping\n\n[width=\"100%\",cols=\"25%,25%,25%,25%\",options=\"header\",]\n|===\n|OTR Field |Salesforce Field |Data Type |Notes\n\n|Category\n|Feedback_Category__c\n|Picklist\n|App, Service, Order, Rewards, Refund, Delete Account\n\n|Store Name\n|Store_Name__c\n|String (255)\n|OTR location name\n\n|Time of Visit\n|Time_of_Visit__c\n|DateTime\n|When customer visited store\n\n|Free Text Message\n|Description\n|Long Text (32,000)\n|Customer feedback message\n\n|===\n\n<<<\n=== Baseline Architecture\n\n==== Existing System Components\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Component |Current State |Status\n\n|*D365 Customer Engagement*\n|Customer support platform for OTR digital customers (Mobile App, Web), handles feedback submission and case management\n|**DEPRECATED** - Being replaced by Salesforce Service Cloud\n\n|*App-Specific Customer Database*\n|Stores customer contact data for Mobile App users, separate from Viva Energy systems\n|**MIGRATING** - One-time migration to Salesforce, then deprecated\n\n|*Mobile App*\n|iOS/Android native apps with feedback submission form including Category, Store Name, Time of Visit, Contact Phone Number, and Free Text Message fields\n|**REQUIRES UPDATE** - Integrate with ProfileService and EngagementService APIs (feedback form UI already complete)\n\n|*Salesforce Service Cloud*\n|Shared Viva Energy instance handling customer support for fuel wholesale, Shell Card customers, other retail channels\n|**EXPANDING** - Adding OTR digital customer support Cases and Contacts\n\n|*Existing AWS Infrastructure*\n|SNS+SQS / EventBridge / Kinesis available for event-driven architecture\n|**REUSING** - Event Bus implementation leverages existing infrastructure\n\n|===\n\n==== Integration Architecture\n\n*Current state:*\n\n* Mobile App → D365 Customer Engagement (direct integration)\n* App-specific customer database → standalone (no Salesforce integration)\n* No event-driven architecture (synchronous, tightly coupled)\n* No Anti-Corruption Layer protecting digital channels\n* Viva Energy support teams use Salesforce, OTR digital support uses D365 CE (fragmented)\n\n==== Technical Debt\n\n*No longer relevant* - D365 CE being deprecated, not documenting technical debt of system being retired.\n\n*New technical debt introduced by this migration:*\n\n* Salesforce field mapping TBD (requires coordination with Viva Energy Salesforce admin team)\n* Data isolation strategy TBD (Record Types, custom fields, queues - multi-tenant governance)\n* Salesforce webhook mechanism TBD (Outbound Messages vs Platform Events vs Process Builder)\n* Expected feedback volume unknown (gathering data for rate limit planning)\n\n=== Gap Analysis\n\n==== Missing Capabilities\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Missing Capability |Description\n\n|*ProfileService bounded context*\n|No existing service for Contact reconciliation with Salesforce - requires new microservice implementing JIT upsert by email, returning Salesforce Contact ID\n\n|*EngagementService bounded context*\n|No existing service for customer feedback facade - requires new microservice implementing Anti-Corruption Layer for Salesforce Case creation, Braze integration, async processing via Event Bus\n\n|*Event Bus domain event pattern*\n|No existing domain event publishing infrastructure - requires implementing event-driven architecture pattern using existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis)\n\n|*Async Case creation workflow*\n|Current D365 CE integration is synchronous - requires implementing async processing with retry logic, exponential backoff, dead letter queue\n\n|*Salesforce webhook integration*\n|No existing capability to receive Salesforce notifications - requires implementing webhook receiver in EngagementService for Case update notifications\n\n|*Braze push notification orchestration*\n|No existing integration for Case-related push notifications - requires implementing Braze campaign triggers from EngagementService\n\n|*Contact migration tooling*\n|No existing tooling for app database → Salesforce Contact migration with upsert logic (match by email/phone/VCI)\n\n|*Feedback form enhancements*\n|Mobile App feedback form lacks structured fields (Category, Store Name, Time of Visit, Contact Phone Number) - requires UI updates\n\n|===\n\n==== Missing Bounded Contexts\n\n[width=\"100%\",cols=\"30%,30%,40%\",options=\"header\",]\n|===\n|Bounded Context |Responsibilities |Implementation Status\n\n|*link:../bounded_context/profile.adoc[ProfileService]*\n|JIT Contact reconciliation with Salesforce (upsert by email), return Salesforce Contact ID to digital channels, foundation for future Flybuys partner linking\n|**NEW** - First bounded context implementation\n\n|*link:../bounded_context/engagement.adoc[EngagementService]*\n|Customer feedback submission facade, Anti-Corruption Layer for Salesforce Case creation, Braze integration for push notifications, async Case processing, webhook receiver for Case updates\n|**NEW** - First bounded context implementation\n\n|===\n\n==== Missing Integration Patterns\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Integration Pattern |Description\n\n|*Anti-Corruption Layer (ACL)*\n|EngagementService → Salesforce Service Cloud - protects digital channels from Salesforce API changes, translates between OTR domain language and Salesforce\n\n|*Conformist*\n|ProfileService/EngagementService → Salesforce - conform to existing Salesforce configuration and API contracts (shared Viva Energy instance)\n\n|*Event-Driven Architecture (OHS+PL)*\n|Event Bus publishing domain events (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`) for loose coupling between bounded contexts\n\n|*Just-In-Time (JIT) Integration*\n|ProfileService → Salesforce Contact reconciliation on-demand (no pre-sync)\n\n|*Async Processing*\n|EngagementService Case creation via Event Bus with retry, exponential backoff, dead letter queue\n\n|===\n\n=== Target State Architecture\n\n==== Architectural Building Blocks (ABB)\n\n[width=\"100%\",cols=\"20%,25%,30%,25%\",options=\"header\",]\n|===\n|ABB ID |Bounded Context |Responsibilities |Technology (TBD in Solution Architecture)\n\n|ABB-CS-001\n|*link:../bounded_context/profile.adoc[ProfileService]*\n|JIT Contact reconciliation with Salesforce (upsert by email), return Salesforce Contact ID, foundation for Flybuys partner linking\n|Microservice (.NET/Node.js), REST API, Salesforce REST API client\n\n|ABB-CS-002\n|*link:../bounded_context/engagement.adoc[EngagementService]*\n|Customer feedback submission facade, ACL for Salesforce Case creation, Braze integration, async processing, webhook receiver\n|Microservice (.NET/Node.js), REST API, Event Bus publisher/subscriber, Salesforce webhook receiver\n\n|ABB-CS-003\n|*Event Bus*\n|Domain event publishing infrastructure (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`)\n|AWS SNS+SQS / EventBridge / Kinesis\n\n|ABB-CS-004\n|*Salesforce Service Cloud*\n|System of Record for Contact and Case data (shared Viva Energy instance)\n|Salesforce Service Cloud (external SaaS)\n\n|ABB-CS-005\n|*Braze*\n|Marketing automation platform for push notifications\n|Braze (external SaaS) - existing integration\n\n|ABB-CS-006\n|*Mobile App*\n|iOS/Android native apps with enhanced feedback form (Category, Store Name, Time of Visit, Contact Phone Number, Free Text Message)\n|Kotlin Multiplatform, SwiftUI, Jetpack Compose\n\n|ABB-CS-007\n|*Contact Migration Tool*\n|One-time migration app database → Salesforce with upsert logic (match by email/phone/VCI)\n|Script/tool (.NET/Python/Node.js)\n\n|===\n\n==== Integration Architecture\n\n===== Integration Flows\n\n*Customer Feedback Submission (Async):*\n\n1. *Mobile App* → ProfileService: Authenticate user, get Salesforce Contact ID (JIT reconciliation)\n2. *Mobile App* → EngagementService: Submit feedback (POST /feedback with Contact ID, Category, Store Name, Time of Visit, Phone, Message)\n3. *EngagementService* → Mobile App: Immediate acknowledgment (\"Feedback submitted\")\n4. *EngagementService* → Event Bus: Publish work item for async Case creation\n5. *Background Worker* (EngagementService) → Salesforce: Create Case via REST API\n6. *Success*: EngagementService → Event Bus: Publish `SupportCaseCreated` event\n7. *EngagementService* → Braze: Trigger push notification campaign (\"Your feedback has been received, Case #12345\")\n8. *Failure*: Retry with exponential backoff → Dead Letter Queue → Ops team alert\n\n*Case Update Notification (Bidirectional):*\n\n1. *Support Agent* updates/resolves Case in Salesforce\n2. *Salesforce* → EngagementService: Webhook notification (Case updated)\n3. *EngagementService* → Event Bus: Publish `SupportCaseUpdated` or `SupportCaseResolved` event\n4. *EngagementService* → Braze: Trigger push notification campaign (\"Your case has been resolved\")\n\n*Contact Reconciliation (JIT):*\n\n1. *Mobile App user* authenticates\n2. *Mobile App* → ProfileService: GET /profile/contact-id\n3. *ProfileService* → Salesforce: Query Contact by email\n4. *Match found*: Return existing Salesforce Contact ID\n5. *No match*: Create new Contact in Salesforce, return new Contact ID\n6. *ProfileService* → Mobile App: Return Salesforce Contact ID (cached by Mobile App)\n\n===== System of Record Boundaries\n\n[width=\"100%\",cols=\"30%,35%,35%\",options=\"header\",]\n|===\n|Data Entity |System of Record |Rationale\n\n|*Contact*\n|Salesforce Service Cloud\n|Shared Viva Energy instance, unified customer profile across all channels (digital, wholesale, Shell Card, retail)\n\n|*Case*\n|Salesforce Service Cloud\n|Support agents manage Cases in Salesforce, digital channels submit via EngagementService ACL\n\n|*Feedback Submission (transient)*\n|None (no persistence)\n|EngagementService processes feedback and creates Case in Salesforce, no local storage\n\n|*Domain Events*\n|Event Bus (ephemeral)\n|Events published to Event Bus, consumed by subscribers, not persisted long-term (event sourcing not in scope)\n\n|===\n\n==== Data Architecture Principles\n\n===== Aggregate Persistence\n\n*ProfileService:*\n\n* **No local aggregate persistence** - ProfileService is stateless, queries Salesforce on-demand\n* Salesforce Contact is the aggregate root (owned by Salesforce)\n* ProfileService acts as facade/translator, not system of record\n\n*EngagementService:*\n\n* **No local aggregate persistence** - EngagementService is stateless, creates Cases in Salesforce via ACL\n* Salesforce Case is the aggregate root (owned by Salesforce)\n* EngagementService maintains no local Case state (Conformist pattern - trust Salesforce as source of truth)\n* Async processing state managed via Event Bus (work items in queue, not database)\n\n===== Event Store\n\n* **Event Bus** (SNS+SQS/EventBridge/Kinesis) handles domain event publishing\n* Events are **ephemeral** (consumed and discarded, not persisted for event sourcing)\n* No Event Store implementation in this architecture (future enhancement if needed)\n* Event schema versioning TBD in Solution Architecture\n\n\n=== Architecture Decisions\n\n==== ADR-CS-001: Consolidate onto Salesforce Service Cloud (not build custom solution)\n\n*Status*: Accepted\n\n*Context*:\n\n* D365 Customer Engagement not working well for digital customer support\n* Viva Energy already uses Salesforce Service Cloud for fuel wholesale, Shell Card, other retail channels\n* Post-merger opportunity to consolidate onto single platform\n* Alternative: Build custom support platform or use different SaaS\n\n*Decision*:\n\nConsolidate OTR digital customer support onto Salesforce Service Cloud (shared Viva Energy instance).\n\n*Rationale*:\n\n* **Unified customer view**: Support agents see all interactions across channels (digital, wholesale, Shell Card, retail)\n* **Platform consolidation**: Single support platform reduces operational overhead and costs\n* **Proven solution**: Salesforce Service Cloud is established, feature-rich, well-supported\n* **Post-merger alignment**: Strategic decision to standardize on Viva Energy platforms\n* **Avoid custom development**: Building custom support platform would be costly and high-risk\n\n*Consequences*:\n\n* Unified customer support across Viva Energy Group\n* Reduced operational complexity (single platform vs two)\n* Leverage Salesforce capabilities (case routing, knowledge base, AI, omnichannel)\n* ⚠️ Conformist pattern required (shared instance, conform to existing configuration)\n* ⚠️ Multi-tenant governance needed (data isolation, security, queues)\n* ❌ Less control over platform evolution (SaaS vendor, shared instance)\n\n==== ADR-CS-002: Implement ProfileService and EngagementService as first DDD bounded contexts\n\n*Status*: Accepted\n\n*Context*:\n\n* OTR target architecture uses Domain-Driven Design with bounded contexts\n* This migration is opportunity to establish first implementation\n* Alternative: Direct Mobile App → Salesforce integration (no bounded contexts)\n* Alternative: Single monolithic service for all customer-facing APIs\n\n*Decision*:\n\nImplement ProfileService and EngagementService as separate bounded contexts following DDD strategic patterns.\n\n*Rationale*:\n\n* **Foundation for target architecture**: First implementation of DDD pattern for future bounded contexts (Flybuys, LocationService, PaymentService)\n* **Separation of concerns**: ProfileService handles identity/Contact reconciliation, EngagementService handles support/feedback (different responsibilities, different change rates)\n* **Anti-Corruption Layer**: EngagementService protects digital channels from Salesforce API changes\n* **Reusability**: ProfileService Contact reconciliation reused for Flybuys integration\n* **Event-driven architecture**: Establishes pattern for loose coupling between bounded contexts\n\n*Consequences*:\n\n* Establishes DDD architecture foundation for OTR\n* Reusable ProfileService for Flybuys and future integrations\n* Digital channels protected from Salesforce API changes (ACL)\n* Clear bounded context boundaries and responsibilities\n* ⚠️ Increased initial complexity (two new microservices vs direct integration)\n* ⚠️ Requires Event Bus infrastructure implementation\n* ⚠️ Team must learn DDD patterns and bounded context design\n\n==== ADR-CS-003: Async Case creation via Event Bus (not synchronous)\n\n*Status*: Accepted\n\n*Context*:\n\n* Current D365 CE integration is synchronous (user waits for Case creation)\n* Alternative: Keep synchronous integration (Mobile App → EngagementService → Salesforce synchronously)\n* Salesforce API may experience downtime or latency\n\n*Decision*:\n\nImplement async Case creation via Event Bus with immediate user acknowledgment, retry logic, exponential backoff, and dead letter queue.\n\n*Rationale*:\n\n* **Non-blocking user experience**: User gets immediate \"Feedback submitted\" confirmation, not waiting for Salesforce API\n* **Resilience**: If Salesforce is down, feedback still accepted, Case created when Salesforce recovers\n* **Retry logic**: Automatic retry with exponential backoff handles transient failures\n* **Operational visibility**: Dead letter queue alerts ops team to persistent failures\n* **Scalability**: Queue buffering handles traffic spikes\n\n*Consequences*:\n\n* Better user experience (no waiting for Salesforce API)\n* Resilient to Salesforce downtime (queue buffers work)\n* Automatic retry reduces manual intervention\n* Queue depth monitoring provides operational visibility\n* ⚠️ Eventual consistency (user gets success notification after Case created, not immediately)\n* ⚠️ Increased complexity (Event Bus, background workers, retry logic, DLQ)\n* ⚠️ Requires monitoring and alerting for DLQ\n\n==== ADR-CS-004: ProfileService uses email as primary matching key (not VCI)\n\n*Status*: Accepted\n\n*Context*:\n\n* ProfileService needs to reconcile Mobile App users as Salesforce Contacts\n* Alternative matching keys: VCI (Viva Consumer ID), email, phone, Salesforce External ID\n* Email changes are rare but possible\n\n*Decision*:\n\nUse email address as primary matching key for Contact reconciliation (JIT upsert by email).\n\n*Rationale*:\n\n* **Availability**: Email always available for authenticated users\n* **Uniqueness**: Email is unique identifier in Salesforce and Mobile App\n* **Salesforce standard**: Salesforce Contact uses email as standard lookup field\n* **Simplicity**: Single matching key simplifies upsert logic\n* **Edge case acceptable**: Email changes are rare, manual cleanup acceptable\n\n*Consequences*:\n\n* Simple upsert logic (query by email, create if not found)\n* Leverages Salesforce standard email field\n* Email always available from authentication\n* ⚠️ Email changes create duplicate Contacts (rare edge case, manual cleanup)\n* ⚠️ Future enhancement: Add VCI as Salesforce External ID for stable matching\n\n==== ADR-CS-005: No Case migration from D365 CE (fresh start)\n\n*Status*: Accepted\n\n*Context*:\n\n* D365 CE contains historical customer support Cases\n* Alternative: Migrate historical Cases to Salesforce (preserve support history)\n* Alternative: Archive D365 CE Cases separately (read-only access)\n\n*Decision*:\n\nDo not migrate historical Cases from D365 CE to Salesforce. Start fresh in Salesforce.\n\n*Rationale*:\n\n* **Limited value**: Historical D365 CE Cases not critical for future support\n* **Data quality**: D365 CE Case data may be inconsistent or incomplete\n* **Complexity**: Case migration requires mapping D365 CE schema to Salesforce, data transformation, validation\n* **Cost-benefit**: Migration effort outweighs value of historical data\n* **Archive option**: D365 CE Cases can be archived separately if needed (read-only access for auditing)\n\n*Consequences*:\n\n* Simpler migration (Contacts only, no Case migration)\n* Faster time to value (no Case migration delay)\n* Clean start in Salesforce (no legacy data quality issues)\n* ⚠️ Historical Cases not visible in Salesforce (support agents can't see old Cases)\n* ⚠️ D365 CE must remain accessible temporarily for historical Case lookups (if needed)\n* ❌ Loss of historical Case insights (reporting, analytics on old Cases)\n\n==== ADR-CS-006: Big bang cutover (not phased rollout)\n\n*Status*: Accepted\n\n*Context*:\n\n* Alternative: Phased rollout with feature flags (pilot users first, gradual enablement)\n* Alternative: Parallel run (submit to both D365 CE and Salesforce temporarily)\n* Flybuys integration uses phased rollout (AS-1, AS-2, AS-3 architecture states)\n\n*Decision*:\n\nBig bang cutover - migrate Contacts, deploy ProfileService and EngagementService, switch Mobile App, retire D365 CE.\n\n*Rationale*:\n\n* **Simplicity**: No parallel run complexity, no feature flag management\n* **Faster D365 CE retirement**: No extended transition period maintaining two systems\n* **Limited risk**: Customer support not mission-critical (not payment processing), rollback possible\n* **User base manageable**: OTR digital customers smaller than Flybuys integration scope\n* **Different use case**: Flybuys phased rollout manages points accrual complexity, support feedback is simpler\n\n*Consequences*:\n\n* Simpler deployment (single cutover, no AS-1/AS-2/AS-3 states)\n* Faster D365 CE retirement (no extended parallel run)\n* No feature flag complexity or pilot user management\n* ⚠️ Higher cutover risk (all users switch at once)\n* ⚠️ Requires comprehensive testing before cutover\n* ⚠️ Rollback plan required (revert to D365 CE if critical issues)\n\n==== ADR-CS-007: EngagementService receives Salesforce webhooks for Case updates\n\n*Status*: Accepted\n\n*Context*:\n\n* Support agents update/resolve Cases in Salesforce\n* Need to notify customers of Case status changes via push notifications\n* Alternative: Poll Salesforce API for Case updates (inefficient)\n* Alternative: No customer notifications (agents contact customers directly)\n\n*Decision*:\n\nSalesforce sends webhook notifications to EngagementService when Cases are updated/resolved. EngagementService triggers Braze push notifications.\n\n*Rationale*:\n\n* **Real-time notifications**: Customer notified immediately when agent resolves Case\n* **Efficient**: Webhook push model (not polling)\n* **Event-driven**: Aligns with event-driven architecture pattern\n* **Better customer experience**: Proactive notification vs waiting for agent contact\n\n*Consequences*:\n\n* Real-time customer notifications for Case updates\n* Efficient push model (no polling overhead)\n* Bidirectional integration (Mobile App → Salesforce → Mobile App)\n* ⚠️ Salesforce webhook mechanism TBD (Outbound Messages vs Platform Events vs Process Builder)\n* ⚠️ Webhook authentication and security required\n* ⚠️ EngagementService must handle webhook retries and failures\n\n<<<\n== Interface Specifications\n\nThis section provides references to the complete API specifications and event catalogue for ProfileService and EngagementService.\n\n=== REST API Specifications\n\nComplete OpenAPI 3.0 specifications are maintained in the `specifications/rest/` directory:\n\n==== ProfileService API v1\n\n*Specification*: link:../../specifications/rest/profile-service-v1.yaml[profile-service-v1.yaml]\n\n*Base URL*: `https://api.otr.com.au/profile/v1`\n\n*Authentication*: Bearer token (Microsoft Entra External ID JWT)\n\n*Key Endpoints*:\n\n* `GET /contact-id` - Retrieve or create Salesforce Contact ID for authenticated user (Just-In-Time reconciliation)\n** Used by Mobile App before submitting feedback to EngagementService\n** Upserts Salesforce Contact record using email as external key\n** Returns 18-character Salesforce Contact ID with caching (15-minute TTL)\n** Performance SLA: p95 < 300ms (uncached), p95 < 50ms (cached)\n\n==== EngagementService API v1\n\n*Specification*: link:../../specifications/rest/engagement-service-v1.yaml[engagement-service-v1.yaml]\n\n*Base URL*: `https://api.otr.com.au/engagement/v1`\n\n*Authentication*: Bearer token (Microsoft Entra External ID JWT)\n\n*Key Endpoints*:\n\n* `POST /feedback` - Submit customer feedback for async Case creation in Salesforce\n** Accepts contactId, category, storeName, timeOfVisit, contactPhoneNumber, message\n** Returns 202 Accepted immediately (async Case creation in background)\n** Publishes `CustomerFeedbackSubmitted` event for analytics\n** Creates Salesforce Case via Anti-Corruption Layer with retry logic\n** Performance SLA: p95 < 200ms (feedback accepted, not Case creation)\n\n=== Domain Events (AsyncAPI)\n\nComplete CloudEvents 1.0 JSON Schema specifications are maintained in the `specifications/events/` directory:\n\n*Specification*: link:../../specifications/events/engagement-events.json[engagement-events.json]\n\n==== Event Catalogue\n\n[width=\"100%\",cols=\"30%,20%,50%\",options=\"header\",]\n|===\n|Event Type |Publisher |Consumers\n\n|`CustomerFeedbackSubmitted`\n|EngagementService\n|Future bounded contexts, analytics, sentiment analysis\n\n|`SupportCaseCreated`\n|EngagementService\n|Future bounded contexts, analytics\n\n|`SupportCaseUpdated`\n|EngagementService (via Salesforce webhook)\n|Future bounded contexts, analytics\n\n|`SupportCaseResolved`\n|EngagementService (via Salesforce webhook)\n|Future bounded contexts, analytics\n\n|===\n\n==== Event Delivery Guarantees\n\n* **At-least-once delivery**: Events may be delivered multiple times, consumers must handle idempotency\n* **Ordering**: FIFO queues guarantee ordering for events with same `contactId`\n* **Retention**: 4 days (96 hours) in Event Bus\n* **Dead Letter Queue**: Failed events after 5 retries moved to DLQ for manual intervention\n* **Format**: CloudEvents 1.0 specification with JSON payload\n\n=== API Versioning Policy\n\n==== Version Numbering\n\n* **Format**: `/v{major}` in URL path (e.g., `/profile/v1`, `/engagement/v1`)\n* **Semantic Versioning**: Major version incremented for breaking changes only\n* **Backwards Compatibility**: Minor changes (new optional fields, new endpoints) don't require version bump\n\n==== When to Version\n\n*Breaking changes requiring new major version*:\n\n- Removing or renaming fields in request/response\n- Changing field data types (e.g., string → number)\n- Changing authentication mechanism\n- Removing endpoints\n\n*Non-breaking changes not requiring version bump*:\n\n- Adding new optional fields to request/response\n- Adding new endpoints\n- Expanding enum values (e.g., adding new feedback category)\n- Improving error messages\n\n==== Parallel Version Support\n\n* Support N and N-1 versions concurrently for 6 months\n* Deprecation notice: 3 months before sunsetting old version\n* Mobile App must upgrade to new version within deprecation window\n\n<<<\n== Work Packages\n\nThis section consolidates gaps and activities into implementable work packages aligned with TOGAF Phase E requirements.\n\n=== Work Package Overview\n\n[width=\"100%\",cols=\"15%,35%,25%,25%\",options=\"header\",]\n|===\n|Work Package ID |Name |Transition State |Key Deliverables\n\n|WP-CS-001\n|ProfileService Development\n|TS-1 (Build & Test)\n|ProfileService microservice, Salesforce Contact integration, REST API\n\n|WP-CS-002\n|EngagementService Development\n|TS-1 (Build & Test)\n|EngagementService microservice, Anti-Corruption Layer, Braze integration\n\n|WP-CS-003\n|Event Bus Infrastructure\n|TS-1 (Build & Test)\n|Event Bus configuration, CloudEvents schemas, monitoring\n\n|WP-CS-004\n|Contact Migration Tooling\n|TS-1 (Build & Test)\n|Migration tool, validation scripts, reconciliation reporting\n\n|WP-CS-005\n|Mobile App Integration\n|TS-1 (Build & Test)\n|Mobile App API integration, feedback form enhancements, testing\n\n|WP-CS-006\n|Integration Testing\n|TS-1 (Build & Test)\n|Test environments, integration test suites, UAT execution\n\n|WP-CS-007\n|Salesforce Configuration\n|TS-1 (Build & Test)\n|Salesforce field mapping, data isolation, webhook configuration\n\n|WP-CS-008\n|Contact Data Migration\n|TS-2 (Contact Migration)\n|Contact migration execution, validation, reconciliation\n\n|WP-CS-009\n|Production Deployment\n|TS-3 (Cutover)\n|Production deployment, smoke testing, go-live execution\n\n|WP-CS-010\n|Post-Cutover Support\n|TS-4 (Target State)\n|Monitoring, issue resolution, D365 CE retirement\n\n|===\n\n[[wp-cs-001]]\n=== WP-CS-001: ProfileService Development\n\n==== Description\n\nBuild ProfileService bounded context microservice implementing Just-In-Time Contact reconciliation with Salesforce Service Cloud.\n\n==== Deliverables\n\n* ProfileService microservice application\n** REST API implementation (OpenAPI 3.0 specification)\n** `GET /contact-id` endpoint (Salesforce Contact reconciliation)\n** Authentication/authorization with Microsoft Entra External ID\n** Caching layer (15-minute TTL for Contact IDs)\n* Salesforce integration\n** Salesforce REST API client\n** Contact upsert by email (external key matching)\n** Error handling and retry logic\n* Unit tests (>80% code coverage)\n* Integration tests with Salesforce sandbox\n* API documentation\n* Deployment configuration (IaC - Infrastructure as Code)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* Salesforce sandbox environment provisioned\n* Microsoft Entra External ID OAuth configuration\n* Development environment setup (AWS dev account, CI/CD pipeline)\n\n*Dependent Work Packages*:\n\n* None (can start immediately after prerequisites met)\n\n==== Skills Required\n\n* Backend development (.NET Core or Node.js)\n* REST API design and implementation\n* Salesforce REST API integration\n* OAuth 2.0 / JWT authentication\n* Caching strategies (Redis/ElastiCache)\n* Unit/integration testing frameworks\n* Infrastructure as Code (Terraform/CloudFormation)\n\n==== Acceptance Criteria\n\n* All API endpoints return correct HTTP status codes per OpenAPI specification\n* Contact ID retrieval achieves p95 < 300ms (uncached), p95 < 50ms (cached)\n* Salesforce Contact upsert succeeds with 100% accuracy in sandbox testing\n* Unit test coverage > 80%\n* Integration tests pass in sandbox environment\n* API documentation generated from OpenAPI specification\n\n[[wp-cs-002]]\n=== WP-CS-002: EngagementService Development\n\n==== Description\n\nBuild EngagementService bounded context microservice implementing customer feedback submission, Anti-Corruption Layer for Salesforce Case creation, Braze integration, and webhook receiver for Case updates.\n\n==== Deliverables\n\n* EngagementService microservice application\n** REST API implementation (OpenAPI 3.0 specification)\n** `POST /feedback` endpoint (async feedback submission)\n** Authentication/authorization with Microsoft Entra External ID\n** Webhook receiver endpoint for Salesforce Case updates\n* Anti-Corruption Layer (ACL)\n** OTR domain model to Salesforce API translation\n** Category enum mapping (App/Service/Order/Rewards → Salesforce Case fields)\n** Salesforce REST API client for Case creation\n* Async processing infrastructure\n** Event Bus publisher integration\n** Background worker for Case creation\n** Retry logic with exponential backoff (5 attempts)\n** Dead Letter Queue integration\n* Braze integration\n** Braze campaign trigger API client\n** Push notification orchestration for Case updates\n* Domain event publishing\n** `CustomerFeedbackSubmitted` event publisher\n** `SupportCaseCreated` event publisher\n** `SupportCaseUpdated` event translator (Salesforce webhook → domain event)\n** `SupportCaseResolved` event translator (Salesforce webhook → domain event)\n* Unit tests (>80% code coverage)\n* Integration tests (EngagementService ↔ Salesforce, EngagementService ↔ Braze)\n* API documentation\n* Deployment configuration (IaC)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-003 (Event Bus Infrastructure) completed\n* Salesforce sandbox environment provisioned\n* Braze API credentials and campaign templates configured\n* Microsoft Entra External ID OAuth configuration\n\n*Dependent Work Packages*:\n\n* WP-CS-003 must be completed first (Event Bus required for async processing)\n* WP-CS-007 (Salesforce Configuration) must be in progress (field mapping needed)\n\n==== Skills Required\n\n* Backend development (.NET Core or Node.js)\n* REST API design and implementation\n* Salesforce REST API integration\n* Event-driven architecture patterns\n* Async/background processing (queues, workers)\n* Braze API integration\n* Webhook design and security\n* OAuth 2.0 / JWT authentication\n* Domain-Driven Design (DDD) - Anti-Corruption Layer pattern\n* Unit/integration testing frameworks\n* Infrastructure as Code (Terraform/CloudFormation)\n\n==== Acceptance Criteria\n\n* Feedback submission endpoint returns 202 Accepted within p95 < 200ms\n* Async Case creation succeeds with >99.5% success rate (including retries)\n* Anti-Corruption Layer correctly maps all feedback categories to Salesforce Case fields\n* Webhook receiver processes Salesforce Case updates and publishes domain events\n* Braze push notifications sent successfully for Case updates\n* Failed Case creation moves to Dead Letter Queue after 5 retry attempts\n* Unit test coverage > 80%\n* Integration tests pass with Salesforce sandbox and Braze staging environment\n\n[[wp-cs-003]]\n=== WP-CS-003: Event Bus Infrastructure\n\n==== Description\n\nImplement Event Bus infrastructure for domain event publishing using existing AWS infrastructure (SNS+SQS, EventBridge, or Kinesis).\n\n==== Deliverables\n\n* Event Bus infrastructure configuration\n** Topic/stream provisioning (technology choice: SNS+SQS / EventBridge / Kinesis)\n** FIFO queue configuration (ordering by `contactId`)\n** Dead Letter Queue (DLQ) setup\n** Retention policy (4 days / 96 hours)\n** Access control policies (IAM roles, permissions)\n* CloudEvents 1.0 schema definitions\n** JSON Schema specifications for all domain events\n** Schema validation configuration\n** Schema registry (if using EventBridge/Kinesis)\n* Monitoring and alerting\n** CloudWatch dashboards for queue metrics\n** Alarms for DLQ depth, queue age, processing failures\n** Event Bus throughput monitoring\n* Documentation\n** Event Bus architecture diagram\n** Event publishing guidelines\n** Consumer integration guide\n* Infrastructure as Code (IaC)\n** Terraform/CloudFormation templates for all infrastructure\n\n==== Dependencies\n\n*Prerequisites*:\n\n* AWS account access (existing infrastructure)\n* Technology selection decision (SNS+SQS vs EventBridge vs Kinesis)\n* CloudEvents 1.0 schema design approval\n\n*Dependent Work Packages*:\n\n* None (foundational infrastructure, can start early)\n\n==== Skills Required\n\n* AWS messaging services (SNS, SQS, EventBridge, Kinesis)\n* Event-driven architecture patterns\n* CloudEvents specification\n* JSON Schema design\n* Infrastructure as Code (Terraform/CloudFormation)\n* AWS IAM security configuration\n* CloudWatch monitoring and alerting\n\n==== Acceptance Criteria\n\n* Event Bus infrastructure provisioned in all environments (dev, staging, production)\n* FIFO ordering validated for events with same `contactId`\n* Dead Letter Queue triggers alarms when messages arrive\n* Event retention policy enforced (4 days)\n* CloudEvents 1.0 schema validation enabled\n* Monitoring dashboards operational\n* Infrastructure fully codified (IaC)\n\n[[wp-cs-004]]\n=== WP-CS-004: Contact Migration Tooling\n\n==== Description\n\nDevelop Contact migration tool for one-time migration from app-specific database to Salesforce Service Cloud with upsert logic and validation.\n\n==== Deliverables\n\n* Contact migration tool\n** Extract Contacts from app-specific database\n** Transform to Salesforce Contact API format\n** Upsert to Salesforce using email as external key\n** Fallback matching by phone number or Viva Consumer ID\n** Batch processing with rate limiting (respect Salesforce API limits)\n** Idempotent operation (can be re-run safely)\n* Validation scripts\n** Pre-migration validation (data quality checks)\n** Post-migration validation (100% Contact reconciliation)\n** Email/phone/VCI matching accuracy report\n* Reconciliation reporting\n** Contacts created vs updated statistics\n** Failed upserts with error details\n** Matching accuracy metrics\n* Rollback capability\n** Export snapshot of Salesforce Contacts before migration\n** Rollback procedure documentation\n* Documentation\n** Migration tool user guide\n** Troubleshooting guide\n** Runbook for migration execution\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-001 (ProfileService Development) completed (reuses Salesforce integration code)\n* Salesforce sandbox environment for migration testing\n* App-specific database access (read-only sufficient)\n* Salesforce production access granted\n\n*Dependent Work Packages*:\n\n* WP-CS-001 provides Salesforce Contact upsert logic to reuse\n\n==== Skills Required\n\n* Database development (SQL, data extraction)\n* Salesforce REST API integration\n* Batch processing and ETL patterns\n* Data validation and reconciliation\n* Error handling and logging\n* Scripting (Python, PowerShell, or similar)\n\n==== Acceptance Criteria\n\n* Migration tool successfully migrates 100% of Contacts in sandbox with zero data loss\n* Email/phone/VCI matching accuracy > 95% in sandbox testing\n* Failed upserts captured with actionable error messages\n* Reconciliation report matches actual Salesforce Contact counts\n* Migration tool execution time acceptable for production (freezes app database for minimum time)\n* Rollback procedure validated in sandbox\n* Documentation complete and approved\n\n=== WP-CS-005: Mobile App Integration\n\n==== Description\n\nUpdate Mobile App to integrate with ProfileService and EngagementService APIs, replacing D365 CE integration.\n\n==== Deliverables\n\n* Feedback form UI enhancements\n** Add Category dropdown (App, Service, Order, Rewards, Refund, Delete Account)\n** Add Store Name field (optional)\n** Add Time of Visit field (optional, datetime picker)\n** Add Contact Phone Number field (optional, E.164 validation)\n** Update Message field (1-2000 character limit with counter)\n* API integration (Kotlin Multiplatform shared code)\n** ProfileService client (`GET /contact-id`)\n** EngagementService client (`POST /feedback`)\n** JWT token management (Microsoft Entra External ID)\n** Error handling (network failures, API errors, validation errors)\n** Retry logic for transient failures\n* Platform-specific UI (SwiftUI for iOS, Jetpack Compose for Android)\n** Feedback form screens\n** Success/error confirmation screens\n** Loading states and progress indicators\n* Feature flag integration\n** `enable_salesforce_feedback_submission` flag\n** Fallback to D365 CE if flag disabled (during rollout)\n* Unit tests for shared business logic\n* UI tests for platform-specific screens\n* API integration tests (mocked APIs)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-001 (ProfileService Development) completed and deployed to dev/staging\n* WP-CS-002 (EngagementService Development) completed and deployed to dev/staging\n* ProfileService and EngagementService OpenAPI specifications finalized\n* Feature flag service configured\n\n*Dependent Work Packages*:\n\n* Must complete after WP-CS-001 and WP-CS-002 (requires API endpoints available for integration testing)\n\n==== Skills Required\n\n* Kotlin Multiplatform development\n* SwiftUI (iOS native UI)\n* Jetpack Compose (Android native UI)\n* REST API client development\n* OAuth 2.0 / JWT authentication\n* Form validation and UX design\n* Unit testing (Kotlin, Swift)\n* UI testing frameworks (XCTest, Espresso)\n\n==== Acceptance Criteria\n\n* Feedback form UI matches UX design specifications\n* All form fields validate correctly (client-side validation)\n* API integration successfully calls ProfileService and EngagementService in dev/staging\n* Error handling provides user-friendly error messages\n* Feature flag correctly toggles between Salesforce and D365 CE integration\n* Unit test coverage > 80% for shared business logic\n* UI tests pass for all feedback form workflows (happy path, error states)\n* App builds and deploys successfully to TestFlight (iOS) and Google Play Internal Testing (Android)\n\n=== WP-CS-006: Integration Testing\n\n==== Description\n\nExecute comprehensive integration testing across all system components in non-production environments.\n\n==== Deliverables\n\n* Test environment setup\n** Salesforce sandbox configured with test data\n** ProfileService deployed to staging\n** EngagementService deployed to staging\n** Event Bus staging infrastructure\n** Braze staging environment configured\n** Mobile App TestFlight/Internal Testing builds\n* Integration test suites\n** ProfileService ↔ Salesforce (Contact upsert scenarios)\n** EngagementService ↔ Salesforce (Case creation scenarios)\n** EngagementService ↔ Braze (push notification scenarios)\n** Mobile App ↔ ProfileService ↔ EngagementService (end-to-end workflows)\n** Event Bus publishing and consumption\n** Webhook receiver (Salesforce → EngagementService)\n* Test scenarios\n** Happy path: Successful feedback submission and Case creation\n** Error scenarios: Salesforce API failures, Braze API failures, network timeouts\n** Retry scenarios: Async Case creation retries, DLQ validation\n** Performance testing: p95 latency validation for ProfileService and EngagementService\n** Load testing: Simulate 3x-10x expected volume\n* UAT execution\n** Business stakeholder UAT sessions\n** UAT test cases covering all feedback categories\n** UAT sign-off documentation\n* Test results documentation\n** Test execution reports\n** Defect tracking and resolution\n** Performance test results\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-001 (ProfileService Development) completed\n* WP-CS-002 (EngagementService Development) completed\n* WP-CS-003 (Event Bus Infrastructure) completed\n* WP-CS-005 (Mobile App Integration) completed\n* WP-CS-007 (Salesforce Configuration) sandbox configuration completed\n\n*Dependent Work Packages*:\n\n* Must complete after WP-CS-001, WP-CS-002, WP-CS-003, WP-CS-005 (requires all components available)\n\n==== Skills Required\n\n* Integration testing strategy and execution\n* Test automation frameworks (Postman, Newman, Selenium)\n* Performance testing tools (JMeter, k6, Gatling)\n* Salesforce sandbox administration\n* Test data management\n* Defect tracking and triage\n* UAT facilitation\n\n==== Acceptance Criteria\n\n* All integration test scenarios pass (happy path, error scenarios, retry scenarios)\n* Performance SLAs validated (ProfileService p95 < 300ms, EngagementService p95 < 200ms)\n* Load testing confirms system handles 3x expected volume without degradation\n* UAT sign-off obtained from business stakeholders\n* Zero critical defects (P1/P2) open before moving to Contact Migration\n* Test results documented and approved\n\n=== WP-CS-007: Salesforce Configuration\n\n==== Description\n\nConfigure Salesforce Service Cloud for OTR digital customer support integration, including field mapping, data isolation, and webhook setup.\n\n==== Deliverables\n\n* Salesforce Contact configuration\n** Custom fields for OTR-specific data (if needed)\n** Email as external key configuration\n** Record Type for OTR digital customers (data isolation)\n** Validation rules\n* Salesforce Case configuration\n** Custom fields for feedback categories (App, Service, Order, Rewards, Refund, Delete Account)\n** Case Type and Reason picklist mapping\n** Queue assignment rules (OTR digital support queue)\n** Case escalation rules\n** Case routing rules\n* Salesforce webhook configuration\n** Platform Events / Outbound Messages for Case updates\n** Webhook authentication (API key, JWT, or OAuth)\n** Case status change triggers (New → In Progress, Resolved, Closed)\n** Webhook payload format (JSON)\n* Data isolation strategy\n** Record Types for OTR vs other Viva Energy business units\n** Queues for OTR-specific Cases\n** Reporting and dashboards scoped to OTR data\n* Salesforce API access\n** Connected App configuration\n** OAuth 2.0 JWT bearer flow setup\n** API user credentials\n** API rate limit monitoring\n* Documentation\n** Salesforce field mapping specification\n** Webhook configuration guide\n** Data isolation architecture diagram\n** API authentication setup guide\n\n==== Dependencies\n\n*Prerequisites*:\n\n* Viva Energy Salesforce admin team engagement\n* Salesforce governance approval (multi-tenant environment)\n* Technical decision on webhook mechanism (Platform Events vs Outbound Messages)\n* Technical decision on authentication method (OAuth 2.0 JWT bearer flow recommended)\n\n*Dependent Work Packages*:\n\n* None (can start in parallel with development work packages)\n* Required for WP-CS-002 (EngagementService needs field mapping)\n* Required for WP-CS-006 (Integration Testing needs sandbox configuration)\n\n==== Skills Required\n\n* Salesforce administration\n* Salesforce configuration (Record Types, Queues, Validation Rules)\n* Salesforce API integration (REST API, Platform Events, Outbound Messages)\n* Salesforce security and authentication (OAuth, Connected Apps)\n* Multi-tenant data isolation patterns\n\n==== Acceptance Criteria\n\n* Salesforce sandbox configured with all custom fields, Record Types, Queues\n* Field mapping documented and approved by OTR business stakeholders\n* Webhook configuration tested and delivering Case update notifications\n* Data isolation validated (OTR data separate from other Viva Energy business units)\n* API authentication working for ProfileService and EngagementService\n* Salesforce API rate limits monitored and acceptable for expected volume\n* Configuration replicated to Salesforce production environment\n\n=== WP-CS-008: Contact Data Migration\n\n==== Description\n\nExecute one-time Contact migration from app-specific database to Salesforce Service Cloud production.\n\n==== Deliverables\n\n* Pre-migration activities\n** Final validation of migration tool in sandbox\n** Communication plan (notify users of maintenance window if needed)\n** Freeze app-specific database Contact updates\n** Backup app-specific database\n** Export snapshot of Salesforce Contacts (rollback preparation)\n* Migration execution\n** Execute migration tool against Salesforce production\n** Monitor migration progress\n** Handle failed upserts (manual intervention if needed)\n* Post-migration validation\n** 100% Contact reconciliation (app database vs Salesforce)\n** Email/phone/VCI matching accuracy report\n** Reconciliation report (Contacts created vs updated)\n** Data integrity checks (no duplicate Contacts, no missing Contacts)\n* ProfileService smoke testing\n** Verify Contact ID retrieval works in production\n** Test cache behavior\n** Validate Salesforce Contact upserts from ProfileService\n* Migration report\n** Total Contacts migrated\n** Contacts created vs updated\n** Failed upserts (if any) with resolution\n** Matching accuracy metrics\n** Migration execution time\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-004 (Contact Migration Tooling) completed\n* WP-CS-001 (ProfileService Development) deployed to production (not yet integrated with Mobile App)\n* WP-CS-007 (Salesforce Configuration) production configuration completed\n* Salesforce production access granted\n* Migration approved by business stakeholders\n\n*Dependent Work Packages*:\n\n* Must complete after WP-CS-001, WP-CS-004, WP-CS-007\n* Must complete before WP-CS-009 (Production Deployment)\n\n==== Skills Required\n\n* Data migration execution\n* Salesforce administration\n* Database operations\n* Data validation and reconciliation\n* Incident management (if issues arise)\n\n==== Acceptance Criteria\n\n* 100% of Contacts migrated with zero data loss\n* Email/phone/VCI matching accuracy > 95%\n* ProfileService smoke tests pass in production\n* Reconciliation report approved by business stakeholders\n* App-specific database Contact updates frozen (read-only mode)\n* Rollback procedure ready (but not executed if migration successful)\n\n=== WP-CS-009: Production Deployment\n\n==== Description\n\nDeploy all solution components to production and execute cutover from D365 CE to Salesforce Service Cloud.\n\n==== Deliverables\n\n* Production deployment\n** EngagementService deployed to production\n** Event Bus production infrastructure validated\n** Salesforce webhook configured in production\n** Mobile App released to production (App Store, Google Play)\n* Go-live activities\n** Smoke testing (end-to-end feedback submission)\n** Feature flag enabled: `enable_salesforce_feedback_submission = ON`\n** D365 CE integration disabled in Mobile App\n** Monitor Event Bus queue depth, DLQ, Salesforce API rate limits\n** Monitor Mobile App feedback submission success rate\n* Go/No-Go decision\n** Validate success criteria before final cutover\n** Business stakeholder approval\n** Technical validation (smoke tests pass, monitoring healthy)\n* Cutover communication\n** Notify support agents of new Salesforce integration\n** Provide training materials for support agents\n** Customer communication (if visible change)\n* Rollback plan\n** Documented rollback procedure\n** Feature flag can disable Salesforce integration and re-enable D365 CE\n** Rollback decision criteria (P1/P2 incidents, feedback submission success rate < 99%)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-001 (ProfileService Development) completed\n* WP-CS-002 (EngagementService Development) completed\n* WP-CS-003 (Event Bus Infrastructure) completed\n* WP-CS-005 (Mobile App Integration) completed\n* WP-CS-006 (Integration Testing) completed with UAT sign-off\n* WP-CS-007 (Salesforce Configuration) production configuration completed\n* WP-CS-008 (Contact Data Migration) completed successfully\n* Mobile App release approval (App Store, Google Play)\n\n*Dependent Work Packages*:\n\n* Must complete after all prior work packages (final cutover)\n\n==== Skills Required\n\n* Production deployment and release management\n* Incident management and troubleshooting\n* Monitoring and observability\n* Change management and communication\n* Rollback execution (if needed)\n\n==== Acceptance Criteria\n\n* Mobile App feedback submission success rate > 99.5%\n* End-to-end flow validated (Mobile App → ProfileService → EngagementService → Salesforce Case created)\n* Braze push notifications delivered successfully\n* Event Bus queue depth normal, DLQ empty\n* No critical incidents (P1/P2) in first 24 hours\n* D365 CE integration disabled\n* Support agents successfully using Salesforce for OTR digital customer Cases\n\n=== WP-CS-010: Post-Cutover Support\n\n==== Description\n\nMonitor production stability, resolve issues, validate success criteria, and execute D365 CE retirement.\n\n==== Deliverables\n\n* Monitoring and support\n** 24/7 on-call support for first week post-cutover\n** Daily monitoring reports (feedback submission success rate, Case creation success rate)\n** Incident response and resolution\n** Performance tuning (if needed)\n* Success criteria validation\n** Validate feedback submission success rate > 99.5%\n** Monitor customer satisfaction score (target: +15% improvement within 6 months)\n** Monitor average case resolution time (target: -20% improvement within 6 months)\n** Support agent feedback survey\n* D365 CE retirement\n** D365 CE set to read-only mode (historical Case lookups only)\n** Archive D365 CE data for compliance/auditing\n** Decommission D365 CE infrastructure (after 90-day stabilization period)\n** Remove D365 CE integration code from Mobile App\n* Documentation updates\n** Production runbook\n** Troubleshooting guide (based on incidents resolved)\n** Operational procedures for support team\n** Lessons learned document\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-009 (Production Deployment) completed\n* Cutover successful with no critical incidents\n\n*Dependent Work Packages*:\n\n* Final work package in sequence\n\n==== Skills Required\n\n* Production support and incident management\n* Performance monitoring and tuning\n* Data archival and compliance\n* Infrastructure decommissioning\n* Documentation\n\n==== Acceptance Criteria\n\n* Zero critical incidents (P1/P2) in first 30 days post-cutover\n* Feedback submission success rate sustained > 99.5%\n* Customer satisfaction improvement validated (baseline established, ongoing measurement)\n* Support agents reporting positive experience with Salesforce unified view\n* D365 CE successfully decommissioned\n* All production documentation complete and approved\n* Lessons learned document published\n\n=== Work Package Sequencing\n\n==== Parallel Track 1: Infrastructure & Configuration\n\nCan start immediately and run in parallel:\n\n* WP-CS-003 (Event Bus Infrastructure)\n* WP-CS-007 (Salesforce Configuration)\n\n==== Parallel Track 2: Development\n\nCan start after Track 1 infrastructure decisions made:\n\n* WP-CS-001 (ProfileService Development) - Independent\n* WP-CS-002 (EngagementService Development) - Requires WP-CS-003 completed\n* WP-CS-004 (Contact Migration Tooling) - Requires WP-CS-001 completed (reuses code)\n\n==== Sequential Track 3: Integration & Testing\n\nMust complete after development:\n\n* WP-CS-005 (Mobile App Integration) - Requires WP-CS-001, WP-CS-002\n* WP-CS-006 (Integration Testing) - Requires WP-CS-001, WP-CS-002, WP-CS-003, WP-CS-005, WP-CS-007\n\n==== Sequential Track 4: Migration & Cutover\n\nMust complete sequentially:\n\n* WP-CS-008 (Contact Data Migration) - Requires WP-CS-001, WP-CS-004, WP-CS-006 UAT sign-off\n* WP-CS-009 (Production Deployment) - Requires all prior work packages completed\n* WP-CS-010 (Post-Cutover Support) - Requires WP-CS-009\n\n==== Critical Path\n\nThe critical path for this project is:\n\n. WP-CS-003 (Event Bus Infrastructure)\n. WP-CS-002 (EngagementService Development) - blocks on WP-CS-003\n. WP-CS-005 (Mobile App Integration) - blocks on WP-CS-001, WP-CS-002\n. WP-CS-006 (Integration Testing) - blocks on WP-CS-001 through WP-CS-005, WP-CS-007\n. WP-CS-008 (Contact Data Migration) - blocks on WP-CS-006 UAT sign-off\n. WP-CS-009 (Production Deployment) - blocks on WP-CS-008\n. WP-CS-010 (Post-Cutover Support) - final deliverable\n\nAny delays in critical path work packages will delay the overall cutover date.\n\n<<<\n== Transition Architecture\n\nThis section defines the evolution from baseline (D365 CE) to target state (Salesforce Service Cloud + ProfileService + EngagementService).\n\n=== Transition Approach\n\n*Big Bang Cutover*: Per ADR-CS-006, this transition uses a single cutover approach rather than phased rollout. All users switch from D365 CE to Salesforce simultaneously after Contact migration completion.\n\n=== Transition States\n\n==== TS-0: Baseline State (Current)\n\n===== Characteristics\n\n* D365 Customer Engagement handles all digital customer feedback\n* App-specific database stores customer Contact data\n* No ProfileService or EngagementService\n* No event-driven architecture\n* Synchronous feedback submission\n\n===== Components Active\n\n- D365 Customer Engagement\n- App-specific customer database\n- Mobile App (current version with D365 CE integration)\n\n==== TS-1: Build & Test\n\n===== Activities\n\n* Build ProfileService microservice (JIT Contact reconciliation API)\n* Build EngagementService microservice (feedback submission API, ACL for Salesforce Case creation, Braze integration, webhook receiver)\n* Implement Event Bus infrastructure (SNS+SQS/EventBridge/Kinesis)\n* Develop Contact migration tool (app database → Salesforce upsert by email/phone/VCI)\n* Update Mobile App API integration (ProfileService + EngagementService endpoints - feedback form UI already complete)\n* Integration testing (ProfileService ↔ Salesforce, EngagementService ↔ Salesforce, EngagementService ↔ Braze)\n* UAT with test Salesforce sandbox environment\n\n===== Components Active\n\n- D365 Customer Engagement (still active, unchanged)\n- App-specific customer database (still active)\n- ProfileService (non-production, testing only)\n- EngagementService (non-production, testing only)\n- Event Bus (non-production)\n- Salesforce Sandbox (testing)\n\n===== Exit Criteria\n\n- All integration tests pass\n- UAT sign-off from business stakeholders\n- Contact migration tool validated in sandbox\n- Mobile App updates tested with non-production APIs\n\n==== TS-2: Contact Migration\n\n===== Activities\n* Execute Contact migration (app database → Salesforce production)\n* Validation: 100% data integrity check (email/phone/VCI matching)\n* Reconciliation report: New Contacts created vs existing Contacts updated\n* Freeze app database Contact updates during migration window\n* ProfileService smoke testing (verify Contact lookups work in Salesforce production)\n\n===== Components Active\n- D365 Customer Engagement (still active, users unaffected)\n- Salesforce Production (Contacts migrated, no Cases yet)\n- ProfileService (production deployed, not integrated with Mobile App yet)\n- App-specific customer database (frozen, read-only)\n\n===== Exit Criteria\n- 100% of Contacts migrated with zero data loss\n- Email/phone/VCI matching accuracy > 95%\n- ProfileService smoke tests pass (JIT lookups return correct Contact IDs)\n- Reconciliation report approved\n\n==== TS-3: Cutover (Go-Live)\n\n===== Go-Live Activities\n\n* Deploy EngagementService to production\n* Deploy Mobile App updates (ProfileService + EngagementService API integration)\n* Configure Salesforce webhook (Case update notifications → EngagementService)\n* Smoke testing: End-to-end feedback submission (Mobile App → EngagementService → Salesforce → Braze notification)\n* Monitor Event Bus queue depth, dead letter queue, Salesforce API rate limits\n* **Go/No-Go decision**: Validate success criteria before final cutover\n* Enable feature flag: `enable_salesforce_feedback_submission = ON`\n* Disable D365 CE integration in Mobile App\n\n===== Components Active\n\n- ProfileService (production, integrated with Mobile App)\n- EngagementService (production, integrated with Mobile App)\n- Event Bus (production, processing async Case creation)\n- Salesforce Production (receiving Cases from digital customers)\n- Braze (sending push notifications)\n- Mobile App (new version with Salesforce integration)\n- D365 Customer Engagement (disabled, read-only for historical lookups)\n\n===== Exit Criteria\n\n- Mobile App feedback submission success rate > 99.5%\n- End-to-end flow validated (Mobile App → Salesforce Case created)\n- Braze push notifications delivered successfully\n- Event Bus queue depth normal, DLQ empty\n- No critical incidents (P1/P2) in first 24 hours\n\n==== TS-4: Target State (Stable Production)\n\n===== Characteristics\n\n* ProfileService and EngagementService fully operational\n* All digital customer feedback routed to Salesforce\n* Event-driven architecture established\n* D365 CE decommissioned\n* First DDD bounded contexts implemented successfully\n\n===== Monitoring Period\n\n* Validate success criteria: feedback submission rate > 99.5%, no data loss\n* Monitor customer satisfaction score (target: +15% improvement)\n* Monitor average case resolution time (target: -20% improvement)\n* Support agents using unified Salesforce view across all channels\n\n===== D365 CE Retirement\n\n* D365 CE read-only access for historical Case lookups (if needed)\n* Decommission D365 CE infrastructure after 90 days\n* Archive D365 CE data for compliance/auditing\n\n===== Components Active\n\n- ProfileService (production)\n- EngagementService (production)\n- Event Bus (production)\n- Salesforce Production (system of record)\n- Braze (push notifications)\n- Mobile App (Salesforce integration)\n- App-specific database (deprecated, Contact data no longer updated)\n\n===== Success Criteria Achieved\n\n- All digital customer feedback routed to Salesforce\n- Support agents have unified customer view\n- D365 CE decommissioned\n- Customer satisfaction improved by 15%\n- Average case resolution time decreased by 20%\n- Zero data loss during transition\n\n=== Transition Dependencies\n\n[width=\"100%\",cols=\"40%,60%\",options=\"header\",]\n|===\n|Dependency |Owner/Status\n\n|*Salesforce production access*\n|Viva Energy Salesforce admin team - TBD\n\n|*Salesforce Case field mapping*\n|Viva Energy Salesforce admin team - TBD (map OTR feedback categories to Salesforce fields)\n\n|*Salesforce data isolation strategy*\n|Viva Energy Salesforce admin team - TBD (Record Types, queues, custom fields)\n\n|*Salesforce webhook configuration*\n|Viva Energy Salesforce admin team - TBD (Outbound Messages vs Platform Events)\n\n|*Event Bus infrastructure*\n|OTR Platform team - Existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis)\n\n|*Braze integration*\n|OTR Marketing team - Existing Braze account, EngagementService creates new campaigns\n\n|*Mobile App release window*\n|OTR Mobile team - Coordinate cutover timing with app release schedule\n\n|*App database access*\n|OTR Platform team - Read access for Contact migration\n\n|===\n\n=== Transition Validation Criteria\n\n==== Contact Migration Validation\n\n* 100% of app database Contacts migrated to Salesforce (zero data loss)\n* Email/phone/VCI matching accuracy > 95% (minimize duplicate Contacts)\n* ProfileService JIT lookups return correct Salesforce Contact IDs (smoke test sample)\n* Reconciliation report shows: X new Contacts created, Y existing Contacts updated\n\n==== Cutover Validation\n\n* Mobile App feedback submission success rate > 99.5% (including async Case creation)\n* End-to-end flow validated: Mobile App → ProfileService → EngagementService → Salesforce Case created\n* Braze push notifications delivered for Case creation and Case resolution\n* Event Bus queue depth within normal range (no backlog)\n* Dead letter queue empty (no failed Case creations)\n* Salesforce API rate limits not exceeded\n\n==== Production Monitoring (30 days)\n\n* Customer satisfaction score improves by 15% (compared to D365 CE baseline)\n* Average case resolution time decreases by 20% (Salesforce vs D365 CE)\n* Support agents confirm unified customer view across all channels\n* Zero critical incidents (P1 outages, data loss)\n\n=== Rollback Plan\n\n==== Rollback Triggers\n\n* Feedback submission success rate < 95% (below acceptable threshold)\n* Data loss or corruption detected in Salesforce\n* Salesforce API rate limits exceeded (Cases not created within SLA)\n* Critical bug blocking customer feedback submission\n\n==== Rollback Procedure\n\n1. **Revert Mobile App** to previous version (remove ProfileService/EngagementService integration, restore D365 CE integration)\n2. **Stop EngagementService** Case creation (prevent duplicate Cases in Salesforce)\n3. **Re-enable D365 CE** for customer feedback submission\n4. **Investigate root cause** (EngagementService logs, Salesforce API errors, Event Bus queue issues)\n5. **Fix and re-test** in sandbox environment\n6. **Retry cutover** when issues resolved\n\n==== Rollback Limitations\n\n* Cases created in Salesforce during cutover period remain in Salesforce (no reverse migration)\n* Contacts migrated to Salesforce remain (no rollback to app database)\n* Rollback only affects Mobile App integration (not data migration)\n\n=== Architectural Scope Boundaries\n\n==== Capabilities Included\n\n===== Business Capabilities\n\n* **Customer Feedback Submission**: Mobile App users can submit structured feedback (Category, Store Name, Time of Visit, Phone, Free Text Message) via EngagementService\n* **Customer Contact Management**: Just-In-Time (JIT) Contact reconciliation with Salesforce via ProfileService, ensuring every Mobile App user has a Salesforce Contact record\n* **Case Management Integration**: EngagementService creates Salesforce Cases asynchronously for customer feedback, support agents manage Cases in Salesforce Service Cloud\n* **Customer Notifications**: Push notifications via Braze when Cases are created, updated, or resolved (bidirectional integration: Mobile App → Salesforce → Mobile App)\n* **Unified Customer View**: Support agents see OTR digital customer feedback alongside other Viva Energy channels (fuel wholesale, Shell Card, retail) in single Salesforce instance\n* **Contact Data Migration**: One-time migration of app-specific customer database Contacts to Salesforce with upsert logic (email/phone/VCI matching)\n\n===== Technical Capabilities\n\n* **ProfileService Bounded Context**: First DDD bounded context implementation - JIT Contact reconciliation, Salesforce API facade, foundation for Flybuys integration\n* **EngagementService Bounded Context**: First DDD bounded context implementation - Customer feedback submission BFF, Anti-Corruption Layer for Salesforce, Braze integration orchestration\n* **Event-Driven Architecture**: Domain event publishing via Event Bus (SNS+SQS/EventBridge/Kinesis) for `SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted` events\n* **Async Processing Pattern**: Non-blocking Case creation with retry logic, exponential backoff, dead letter queue for operational resilience\n* **Anti-Corruption Layer Pattern**: EngagementService protects digital channels from Salesforce API changes, translates between OTR domain language and Salesforce\n* **Conformist Pattern**: ProfileService and EngagementService conform to existing Salesforce configuration (shared Viva Energy instance, multi-tenant governance)\n* **Salesforce Integration**: REST API integration for Contact CRUD and Case creation, webhook receiver for Case update notifications\n* **Braze Integration**: Push notification campaign triggers for Case lifecycle events (created, updated, resolved)\n* **Observability & Monitoring**: Dashboards, metrics, alerting for feedback submission rate, queue depth, API errors, Case creation latency\n* **Feature Flag Management**: Kill switches for emergency rollback (enable_salesforce_feedback_submission, enable_async_case_creation, etc.)\n\n==== Capabilities Excluded\n\n===== Business Capabilities Explicitly Out of Scope\n\n* **Historical Case Migration**: D365 CE Cases not migrated to Salesforce (ADR-CS-005 - fresh start, no Case migration)\n* **Multi-Channel Feedback Submission**: Web app, POS, call centre, email feedback channels not included (Mobile App only in this phase)\n* **Case Resolution by Digital Channels**: Support agents resolve Cases in Salesforce, not via Mobile App self-service\n* **Knowledge Base Integration**: Salesforce Knowledge Base articles not surfaced in Mobile App (future enhancement)\n* **Live Chat/Messaging**: Real-time chat support not included (Salesforce omnichannel capabilities not activated)\n* **Sentiment Analysis**: Automated feedback sentiment analysis not included (future enhancement with AI/ML)\n* **Customer Satisfaction Surveys**: Post-resolution CSAT surveys not included (separate initiative)\n* **Case Attachments**: Mobile App feedback submission does not support file uploads (photos, receipts) - text only\n* **Agent Desktop Integration**: Custom Salesforce UI for support agents not included (use standard Salesforce Service Console)\n* **Social Media Feedback**: Facebook, Twitter, Instagram feedback channels not integrated\n\n===== Technical Capabilities Explicitly Out of Scope\n\n* **Event Sourcing**: Domain events are ephemeral (not persisted for event sourcing/replay) - Event Bus only, no Event Store\n* **CQRS (Command Query Responsibility Segregation)**: ProfileService and EngagementService use same data model for reads/writes (no separate read models)\n* **Local Aggregate Persistence**: ProfileService and EngagementService are stateless (Salesforce is System of Record, no local database for Contact/Case)\n* **Saga Orchestration**: No distributed transactions or saga patterns required (single-step Case creation, not multi-step workflow)\n* **API Gateway Advanced Features**: Rate limiting, API versioning, API key management deferred to detailed design (basic routing only)\n* **GraphQL API**: ProfileService and EngagementService expose REST APIs only (GraphQL not required)\n* **Real-Time Sync**: Salesforce Contact updates by support agents not synced back to ProfileService (eventual consistency acceptable via JIT reconciliation)\n* **Multi-Region Deployment**: Single AWS region deployment (no multi-region failover/disaster recovery in this phase)\n* **Blue-Green Deployment**: Big bang cutover (ADR-CS-006), not blue-green or canary deployment strategy\n* **A/B Testing Framework**: Feature flags for rollback only, not for A/B testing or experimentation\n* **Custom Authentication**: Microsoft Entra External ID used for Mobile App authentication (no custom authentication logic in ProfileService/EngagementService)\n* **Data Residency Compliance**: Salesforce data residency governed by Viva Energy Salesforce configuration (no OTR-specific data residency requirements)\n\n===== Future Bounded Contexts Not in Scope\n\n* **LoyaltyService**: Flybuys integration, reward preferences, transaction adjudication (separate initiative)\n* **LocationService**: Store finder, proximity features, geofencing (separate initiative)\n* **PaymentService**: Payment processing, subscription billing (separate initiative)\n* **RecommendationService**: Personalized recommendations, next-best offers (separate initiative)\n\n===== Integration Patterns Not in Scope\n\n* **Shared Kernel**: No shared domain model between ProfileService and EngagementService (separate bounded contexts with clear boundaries)\n* **Partnership**: No joint development or coordination with external teams (Conformist pattern - we conform to Salesforce)\n* **Customer-Supplier (we're upstream)**: No downstream systems depend on ProfileService/EngagementService APIs yet (future bounded contexts will consume domain events)\n\n==== Architectural Dependencies on Future Initiatives\n\n*This Architecture Enables Future Initiatives*:\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Future Initiative |Architectural Enablement\n\n|*Flybuys Integration*\n|**ProfileService Contact Reconciliation Reused**: ProfileService establishes pattern for JIT Contact reconciliation with Salesforce, which will be extended for Flybuys partner linking (link:../architecture_definitions/flybuys_integration.adoc[see Flybuys Integration architecture]) +\n**Event Bus Infrastructure**: Domain event publishing pattern (`CustomerEnrolledInLoyalty`, `PartnerLinked`, etc.) reuses Event Bus established for EngagementService\n\n|*LoyaltyService Bounded Context*\n|**Event Bus Subscription**: LoyaltyService will consume `CustomerProfileCreated` events published by ProfileService (future enhancement) +\n**Salesforce Contact Integration**: LoyaltyService may query Salesforce Contacts for customer reward preferences (via ProfileService facade or direct Salesforce API)\n\n|*Web App Feedback Submission*\n|**EngagementService API Reuse**: Web app will call same EngagementService REST API for feedback submission (multi-channel support) +\n**Conformist Pattern**: Web app conforms to EngagementService API contract (no translation required)\n\n|*Multi-Channel Customer Support*\n|**EngagementService Extension**: Add support for email, call centre, POS feedback channels (extend EngagementService to handle multiple origins) +\n**Salesforce Case Origin Field**: Cases already tagged with Origin=Mobile App, extend to Origin=Web, POS, Call Centre, Email\n\n|*Knowledge Base Integration*\n|**EngagementService API Extension**: Add endpoint to query Salesforce Knowledge Base articles, surface in Mobile App for self-service support +\n**Anti-Corruption Layer**: EngagementService translates Salesforce Knowledge API to OTR domain language\n\n|*Customer Satisfaction Surveys*\n|**Event-Driven Trigger**: Subscribe to `SupportCaseResolved` events published by EngagementService, trigger CSAT survey via Braze +\n**Braze Integration Pattern**: Reuse EngagementService → Braze integration pattern for survey campaigns\n\n|*Sentiment Analysis*\n|**Event Subscription**: Subscribe to `CustomerFeedbackSubmitted` events, analyse feedback sentiment (AI/ML service) +\n**EngagementService Extension**: Enrich Case with sentiment score before creating in Salesforce\n\n|*RecommendationService Bounded Context*\n|**Event Subscription**: RecommendationService subscribes to `SupportCaseCreated` events to understand customer pain points and personalize recommendations +\n**Domain Event Pattern**: Reuse Event Bus publishing pattern established by EngagementService\n\n|===\n\n*This Architecture Depends on Future Initiatives*:\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Future Initiative |Dependency Description\n\n|*Salesforce Data Isolation Strategy*\n|**BLOCKER**: Viva Energy Salesforce admin team must define data isolation strategy (Record Types, custom fields, queues) before production deployment +\n**Impact**: Multi-tenant data visibility and security governance\n\n|*Salesforce Case Field Mapping*\n|**BLOCKER**: Viva Energy Salesforce admin team must define field mapping for OTR feedback categories (App, Service, Order, Rewards, Refund, Delete Account) +\n**Impact**: Case creation logic in EngagementService depends on finalized Salesforce schema\n\n|*Salesforce Webhook Mechanism*\n|**BLOCKER**: Viva Energy Salesforce admin team must configure webhook mechanism (Outbound Messages vs Platform Events vs Process Builder) for Case update notifications +\n**Impact**: EngagementService webhook receiver implementation depends on chosen mechanism\n\n|*Event Bus Technology Selection*\n|**DECISION REQUIRED**: Choose Event Bus implementation (SNS+SQS vs EventBridge vs Kinesis) for domain event publishing +\n**Impact**: Infrastructure provisioning, event schema design, consumer implementation\n\n|*Microservice Hosting Platform*\n|**DECISION REQUIRED**: Choose hosting platform for ProfileService and EngagementService (AWS Lambda vs ECS vs EKS) +\n**Impact**: Deployment architecture, auto-scaling strategy, operational overhead\n\n|*Observability Platform*\n|**DECISION REQUIRED**: Choose observability platform (AWS CloudWatch vs Datadog vs New Relic) for monitoring and alerting +\n**Impact**: Dashboard configuration, metric collection, alerting setup\n\n|===\n\n*Future Work After This Initiative*:\n\n* **Event Schema Registry**: Implement event schema versioning and registry for domain events (currently ad-hoc schemas)\n* **API Versioning Strategy**: Define API versioning approach for ProfileService and EngagementService (currently v1 only)\n* **Multi-Region Deployment**: Extend to multi-region for disaster recovery and global availability\n* **Event Store**: Persist domain events for event sourcing and audit trail (currently ephemeral Event Bus only)\n* **CQRS Pattern**: Separate read models for high-volume queries (currently same model for reads/writes)\n* **GraphQL API**: Expose GraphQL API for flexible client queries (currently REST only)\n* **Real-Time Sync**: Bi-directional sync between Salesforce and ProfileService for Contact updates (currently JIT reconciliation only)\n\n=== Technical Risks and Mitigation\n\n[width=\"100%\",cols=\"5%,20%,25%,25%,25%\",options=\"header\",]\n|===\n|ID |Risk |Impact |Likelihood |Mitigation\n\n|RISK-CS-001\n|*Salesforce API rate limits exceeded*: High feedback volume exceeds Salesforce API limits, Cases not created\n|HIGH (customers don't receive Case confirmation, support tickets lost)\n|MEDIUM (volume unknown, rate limits TBD)\n|• Gather expected feedback volume data before cutover +\n• Implement Event Bus queue throttling/rate limiting +\n• Monitor queue depth and API usage +\n• Scale background workers based on queue depth +\n• Alert ops team when approaching rate limits\n\n|RISK-CS-002\n|*Salesforce downtime*: Salesforce Service Cloud outage prevents Case creation\n|MEDIUM (Cases delayed but queued, customers wait for confirmation)\n|LOW (Salesforce SLA 99.9% uptime)\n|• Async Case creation with retry logic +\n• Event Bus queues buffer work during outage +\n• Customers get immediate \"Feedback submitted\" (not blocked) +\n• Monitor Salesforce status page, alert ops team +\n• Automatic retry when Salesforce recovers\n\n|RISK-CS-003\n|*Contact migration data quality issues*: App database Contact data incomplete or invalid\n|HIGH (migration fails validation, cutover delayed)\n|MEDIUM (legacy data quality unknown)\n|• Pre-migration data quality assessment +\n• Flexible upsert logic (match by email/phone/VCI) +\n• Validation report identifies data issues before production migration +\n• Manual cleanup for invalid records +\n• Dry-run migration in sandbox environment\n\n|RISK-CS-004\n|*Duplicate Contacts created*: Email matching fails, ProfileService creates duplicate Contacts\n|MEDIUM (support agents see multiple profiles for same customer)\n|MEDIUM (email changes, data quality issues)\n|• Salesforce duplicate detection rules (if available) +\n• ProfileService logs Contact creation for audit trail +\n• Manual duplicate cleanup process (support team) +\n• Future enhancement: VCI as Salesforce External ID for stable matching\n\n|RISK-CS-005\n|*Dead letter queue accumulation*: Failed Case creations not processed, queue grows\n|HIGH (customers don't receive Case confirmation, feedback lost)\n|LOW (retry logic handles most failures)\n|• Dead letter queue monitoring and alerting +\n• Ops team dashboard showing DLQ depth +\n• Manual intervention process (investigate and reprocess) +\n• Automated alerts when DLQ depth exceeds threshold +\n• Root cause analysis for recurring failures\n\n|RISK-CS-006\n|*Salesforce webhook failures*: Salesforce can't deliver Case update notifications to EngagementService\n|MEDIUM (customers don't get push notifications for Case resolution)\n|LOW (webhook mechanism reliable)\n|• Webhook retry logic and exponential backoff +\n• EngagementService logs webhook deliveries +\n• Monitor webhook delivery success rate +\n• Fallback: Poll Salesforce API for Case updates (if webhook fails persistently) +\n• Alert ops team when webhook delivery rate drops\n\n|RISK-CS-007\n|*Multi-tenant data isolation breach*: OTR digital Cases visible to other Viva Energy support teams\n|HIGH (privacy violation, compliance risk)\n|LOW (Salesforce governance controls)\n|• Work with Viva Energy Salesforce admin team on data isolation strategy +\n• Test data visibility in Salesforce sandbox (UAT with different user roles) +\n• Validate Record Types, queues, field-level security before production +\n• Audit Salesforce user permissions and sharing rules\n\n|RISK-CS-008\n|*Mobile App release coordination*: App release delayed, cutover window missed\n|MEDIUM (cutover delayed, D365 CE retirement delayed)\n|MEDIUM (release schedule conflicts)\n|• Coordinate cutover timing with Mobile team early +\n• Buffer time in migration plan (2-week contingency) +\n• Decouple backend deployment from Mobile App release (backend deployed first, app follows) +\n• Feature flag for feedback submission (enable when ready)\n\n|RISK-CS-009\n|*Event Bus infrastructure issues*: SNS/SQS/EventBridge downtime or misconfiguration\n|HIGH (Case creation blocked, domain events not published)\n|LOW (AWS SLA 99.99% uptime)\n|• Leverage existing AWS infrastructure (proven, reliable) +\n• Infrastructure as Code (IaC) for Event Bus configuration +\n• Integration testing in non-production environment +\n• Monitor Event Bus metrics (queue depth, throughput, errors) +\n• Alert ops team on Event Bus failures\n\n|RISK-CS-010\n|*Team DDD knowledge gap*: Team unfamiliar with DDD patterns, bounded contexts, event-driven architecture\n|MEDIUM (implementation delays, architectural inconsistencies)\n|HIGH (first DDD implementation)\n|• DDD training for development team (workshops, documentation) +\n• Architecture review sessions (validate bounded context design) +\n• Pair programming with experienced DDD practitioners +\n• Incremental implementation (start small, iterate) +\n• Document architectural patterns in CLAUDE.md\n\n|===\n\n== Assumptions and Constraints\n\n=== Assumptions\n\n[width=\"100%\",cols=\"8%,92%\",options=\"header\",]\n|===\n|ID |Assumption\n\n|ASM-CS-001\n|Viva Energy Salesforce admin team will provide Salesforce production access, sandbox environment, and support for Case field mapping and data isolation configuration\n\n|ASM-CS-002\n|App database Contact data is sufficiently complete for migration (email/phone/VCI available for matching)\n\n|ASM-CS-003\n|Expected customer feedback volume (100-150 submissions/day from 20k DAU) is well within Salesforce API rate limits, with capacity planning for 3x-10x growth\n\n|ASM-CS-004\n|Existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis) is sufficient for Event Bus implementation (no additional infrastructure provisioning required)\n\n|ASM-CS-005\n|Braze integration already exists and can be extended for Case-related push notifications (no new Braze account or major configuration changes)\n\n|ASM-CS-006\n|Mobile App users have email addresses associated with their accounts (required for ProfileService Contact reconciliation)\n\n|ASM-CS-007\n|D365 Customer Engagement historical Cases have limited business value and do not require migration to Salesforce\n\n|ASM-CS-008\n|Support agents are trained on Salesforce Service Cloud and require minimal additional training for OTR digital customer Cases\n\n|ASM-CS-009\n|Salesforce Service Cloud shared instance has capacity for OTR digital customer Contacts and Cases (no additional licensing or storage costs)\n\n|ASM-CS-010\n|Mobile App release schedule can accommodate cutover timing (Week 10 in migration plan)\n\n|===\n\n=== Constraints\n\n[width=\"100%\",cols=\"8%,92%\",options=\"header\",]\n|===\n|ID |Constraint\n\n|CON-CS-001\n|Must use shared Viva Energy Salesforce Service Cloud instance (cannot deploy separate OTR-specific instance)\n\n|CON-CS-002\n|Must conform to existing Salesforce configuration and governance (Record Types, custom fields, queues, data isolation strategy defined by Viva Energy admin team)\n\n|CON-CS-003\n|Contact migration must complete before Mobile App cutover (no parallel run of D365 CE and Salesforce)\n\n|CON-CS-004\n|Big bang cutover only (no phased rollout with feature flags or pilot users)\n\n|CON-CS-005\n|Salesforce API rate limits and authentication method constrained by Viva Energy Salesforce configuration (TBD)\n\n|CON-CS-006\n|Event Bus implementation must use existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis - cannot introduce new infrastructure components)\n\n|CON-CS-007\n|Mobile App feedback form must include specific fields: Category, Store Name, Time of Visit, Contact Phone Number, Free Text Message (no attachments)\n\n|CON-CS-008\n|D365 Customer Engagement must be decommissioned within 90 days post-cutover (ADR-CS-006)\n\n|CON-CS-009\n|ProfileService and EngagementService must be stateless (no local aggregate persistence, Salesforce is System of Record)\n\n|CON-CS-010\n|First DDD bounded context implementation (team learning curve, architectural patterns must be documented for future bounded contexts)\n\n|===\n\n== Non-Functional Requirements\n\n=== Performance Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-PERF-001\n|Mobile App feedback submission API response time (ProfileService + EngagementService)\n|p95 < 1 second, p99 < 2 seconds\n\n|NFR-PERF-002\n|ProfileService Contact reconciliation API response time (JIT lookup)\n|p95 < 500ms, p99 < 1 second\n\n|NFR-PERF-003\n|EngagementService async Case creation latency (end-to-end: feedback submitted → Case created in Salesforce)\n|p95 < 5 minutes, p99 < 10 minutes\n\n|NFR-PERF-004\n|Salesforce API call latency (Contact query, Contact create, Case create)\n|p95 < 2 seconds, p99 < 5 seconds\n\n|NFR-PERF-005\n|Event Bus message processing throughput\n|> 100 messages/second (support peak feedback volume)\n\n|NFR-PERF-006\n|Braze push notification delivery latency (Case created → notification delivered)\n|p95 < 30 seconds, p99 < 60 seconds\n\n|===\n\n=== Availability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-AVAIL-001\n|ProfileService availability\n|99.9% uptime (8.76 hours downtime/year)\n\n|NFR-AVAIL-002\n|EngagementService availability\n|99.9% uptime (8.76 hours downtime/year)\n\n|NFR-AVAIL-003\n|Feedback submission success rate (including async Case creation)\n|> 99.5% (includes retry logic for transient failures)\n\n|NFR-AVAIL-004\n|Graceful degradation: Salesforce downtime handling\n|Feedback submission still succeeds, Cases queued for async creation when Salesforce recovers\n\n|NFR-AVAIL-005\n|Graceful degradation: Braze downtime handling\n|Case creation proceeds, push notifications disabled temporarily (feature flag)\n\n|NFR-AVAIL-006\n|Planned maintenance window\n|< 4 hours/month, scheduled during low-traffic periods (2-6am ACST)\n\n|===\n\n=== Scalability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-SCALE-001\n|Concurrent Mobile App users (peak)\n|Support 20,000 DAU (Daily Active Users), ~150 concurrent users submitting feedback during peak hours\n\n|NFR-SCALE-002\n|Feedback submissions per day\n|Expected: 100-150 submissions/day based on 20k DAU (~0.5-0.75% submission rate) +\nCapacity: Support 500 submissions/day (3x expected volume for growth), 2,000 submissions/day (peak/incident scenarios)\n\n|NFR-SCALE-003\n|Auto-scaling: ProfileService and EngagementService\n|Auto-scale based on CPU/memory/request rate, scale up within 2 minutes\n\n|NFR-SCALE-004\n|Event Bus queue capacity\n|Support 100,000 queued messages (buffer for Salesforce downtime)\n\n|NFR-SCALE-005\n|Salesforce API rate limit compliance\n|Stay within 80% of Salesforce API rate limits (buffer for spikes)\n\n|NFR-SCALE-006\n|Future growth capacity\n|Architecture supports 10x growth (1,000-1,500 submissions/day based on 200k DAU) without major redesign\n\n|===\n\n=== Security Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-SEC-001\n|Mobile App authentication\n|Microsoft Entra External ID OAuth 2.0 with JWT tokens (existing CIAM)\n\n|NFR-SEC-002\n|API authorisation: ProfileService and EngagementService\n|JWT token validation, authenticated users only, user context propagation\n\n|NFR-SEC-003\n|Salesforce API authentication\n|OAuth 2.0 with Connected App and JWT bearer flow (service account)\n\n|NFR-SEC-004\n|Data encryption in transit\n|TLS 1.2+ for all API calls (Mobile App ↔ ProfileService/EngagementService ↔ Salesforce ↔ Braze)\n\n|NFR-SEC-005\n|Data encryption at rest\n|Salesforce encryption at rest (managed by Salesforce), Event Bus message encryption (AWS KMS)\n\n|NFR-SEC-006\n|Secret management\n|AWS Secrets Manager for Salesforce credentials, Braze API keys, OAuth tokens (no hardcoded secrets)\n\n|NFR-SEC-007\n|PII data handling\n|Contact data (email, phone, name) treated as PII, GDPR-compliant retention policies (Salesforce governance)\n\n|NFR-SEC-008\n|API rate limiting and throttling\n|API Gateway rate limiting (100 requests/second per user), prevent abuse and DoS\n\n|NFR-SEC-009\n|Logging and auditing\n|Log all API calls, Salesforce Contact/Case creates/updates, Event Bus publishes (no PII in logs)\n\n|NFR-SEC-010\n|Salesforce data isolation\n|Multi-tenant data isolation via Salesforce Record Types, queues, sharing rules (defined by Viva Energy admin team)\n\n|===\n\n=== Reliability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-REL-001\n|Retry logic: EngagementService → Salesforce Case creation\n|Exponential backoff (1s, 2s, 4s, 8s, 16s), max 5 retries, then dead letter queue\n\n|NFR-REL-002\n|Dead letter queue monitoring\n|Alert ops team immediately when DLQ depth > 0 (failed Case creations require manual intervention)\n\n|NFR-REL-003\n|Event Bus message durability\n|Messages persisted in Event Bus (SNS+SQS/EventBridge/Kinesis), not lost on service restart\n\n|NFR-REL-004\n|Idempotency: Case creation\n|EngagementService ensures duplicate feedback submissions don't create duplicate Cases (idempotency key)\n\n|NFR-REL-005\n|Circuit breaker: Salesforce API calls\n|Open circuit after 5 consecutive failures, half-open retry after 30 seconds\n\n|NFR-REL-006\n|Health checks: ProfileService and EngagementService\n|Health endpoints for load balancer checks, readiness and liveness probes\n\n|NFR-REL-007\n|Disaster recovery: Event Bus\n|Event Bus messages replicated across AWS availability zones (SQS/EventBridge/Kinesis HA)\n\n|===\n\n=== Maintainability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-MAINT-001\n|Code quality: ProfileService and EngagementService\n|> 80% test coverage (unit + integration tests), automated CI/CD pipeline\n\n|NFR-MAINT-002\n|API documentation\n|OpenAPI/Swagger specs for ProfileService and EngagementService, auto-generated API docs\n\n|NFR-MAINT-003\n|Deployment automation\n|Infrastructure as Code (Terraform/CloudFormation/CDK), zero-downtime deployments\n\n|NFR-MAINT-004\n|Logging: structured logs\n|JSON-formatted logs with correlation IDs, log levels (DEBUG, INFO, WARN, ERROR), centralized log aggregation\n\n|NFR-MAINT-005\n|Monitoring dashboards\n|Real-time dashboards for ProfileService, EngagementService, Event Bus (see Monitoring and Observability section)\n\n|NFR-MAINT-006\n|Alerting and on-call\n|PagerDuty/Opsgenie integration for P1/P2 alerts, on-call rotation for ops team\n\n|NFR-MAINT-007\n|Configuration management\n|Externalized configuration (environment variables, AWS Parameter Store), no hardcoded config\n\n|NFR-MAINT-008\n|Versioning: API and events\n|Semantic versioning (v1, v2), backward compatibility for API changes, event schema evolution\n\n|===\n\n=== Usability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-USE-001\n|Feedback submission UX\n|Mobile App user receives immediate \"Feedback submitted\" confirmation (< 1 second), not blocked by async Case creation\n\n|NFR-USE-002\n|Push notification delivery\n|Customer receives \"Your feedback has been received\" notification within 30 seconds of Case creation in Salesforce\n\n|NFR-USE-003\n|Case resolution notification\n|Customer receives \"Your case has been resolved\" notification within 30 seconds of support agent resolving Case\n\n|NFR-USE-004\n|Error messaging\n|User-friendly error messages for failed feedback submission (not technical errors), retry prompts\n\n|NFR-USE-005\n|Accessibility\n|Mobile App feedback form meets WCAG 2.1 AA accessibility standards (existing Mobile App compliance)\n\n|===\n\n=== Compliance Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-COMP-001\n|GDPR compliance: PII data\n|Customer Contact data (email, phone, name) managed per GDPR retention policies (Salesforce governance)\n\n|NFR-COMP-002\n|GDPR compliance: Right to erasure\n|Support \"Delete Account\" feedback category, trigger Contact deletion in Salesforce per GDPR Article 17\n\n|NFR-COMP-003\n|Data residency\n|Salesforce data residency governed by Viva Energy Salesforce configuration (regional compliance)\n\n|NFR-COMP-004\n|Audit trail\n|All Contact creates/updates, Case creates/updates logged for compliance auditing (Salesforce audit logs)\n\n|NFR-COMP-005\n|API security standards\n|OWASP API Security Top 10 compliance (injection prevention, authentication, authorisation, data exposure)\n\n|===\n\n== Monitoring and Observability\n\n=== Key Metrics\n\n[width=\"100%\",cols=\"25%,40%,35%\",options=\"header\",]\n|===\n|Metric Category |Metric |Target/Threshold\n\n|*Feedback Submission*\n|Feedback submission success rate (Mobile App → EngagementService)\n|> 99.5%\n\n|*Async Case Creation*\n|Case creation success rate (EngagementService → Salesforce)\n|> 99%\n\n|*Async Case Creation*\n|Case creation latency (time from feedback submission to Case created in Salesforce)\n|p95 < 5 minutes\n\n|*Event Bus*\n|Event Bus queue depth (pending Case creations)\n|< 100 messages\n\n|*Event Bus*\n|Dead letter queue depth (failed Case creations)\n|= 0 (alert on any failures)\n\n|*Salesforce API*\n|Salesforce API error rate\n|< 1%\n\n|*Salesforce API*\n|Salesforce API latency (Case creation)\n|p95 < 2 seconds\n\n|*Salesforce API*\n|Salesforce API rate limit utilization\n|< 80% of limit\n\n|*ProfileService*\n|Contact reconciliation success rate (JIT lookups)\n|> 99.5%\n\n|*ProfileService*\n|Contact reconciliation latency\n|p95 < 500ms\n\n|*Braze Notifications*\n|Push notification delivery rate (Case created/updated)\n|> 95%\n\n|*Salesforce Webhook*\n|Webhook delivery success rate (Salesforce → EngagementService)\n|> 99%\n\n|*Customer Satisfaction*\n|Customer satisfaction score (CSAT)\n|> 4.0/5.0 (improve by 15% from D365 CE baseline)\n\n|*Support Operations*\n|Average case resolution time\n|Decrease by 20% from D365 CE baseline\n\n|===\n\n=== Alerting Thresholds\n\n[width=\"100%\",cols=\"25%,50%,25%\",options=\"header\",]\n|===\n|Alert |Condition |Severity\n\n|*Feedback submission failures*\n|Feedback submission success rate < 95% over 5-minute window\n|P1 - Critical\n\n|*Dead letter queue accumulation*\n|Dead letter queue depth > 0 (any failed Case creations)\n|P2 - High\n\n|*Event Bus queue backlog*\n|Event Bus queue depth > 100 messages for > 15 minutes\n|P2 - High\n\n|*Salesforce API errors*\n|Salesforce API error rate > 5% over 5-minute window\n|P1 - Critical\n\n|*Salesforce API rate limits*\n|Salesforce API rate limit utilization > 90%\n|P2 - High\n\n|*Contact reconciliation failures*\n|ProfileService Contact reconciliation failure rate > 5% over 5-minute window\n|P2 - High\n\n|*Braze notification failures*\n|Braze push notification delivery rate < 80% over 15-minute window\n|P3 - Medium\n\n|*Salesforce webhook failures*\n|Salesforce webhook delivery success rate < 90% over 15-minute window\n|P2 - High\n\n|*Case creation latency*\n|Case creation latency p95 > 10 minutes\n|P3 - Medium\n\n|===\n\n=== Dashboards\n\n*ProfileService Dashboard:*\n\n* Contact reconciliation success rate (JIT lookups)\n* Contact reconciliation latency (p50, p95, p99)\n* Contact creation vs update ratio (new Contacts created vs existing Contacts updated)\n* Salesforce API error rate (Contact queries and creates)\n* Request rate and throughput\n\n*EngagementService Dashboard:*\n\n* Feedback submission success rate\n* Case creation success rate (async workflow)\n* Case creation latency (p50, p95, p99)\n* Event Bus queue depth (pending Case creations)\n* Dead letter queue depth (failed Case creations)\n* Salesforce API error rate (Case creation)\n* Salesforce API latency\n* Salesforce API rate limit utilization\n* Braze push notification delivery rate\n* Salesforce webhook delivery success rate\n\n*Event Bus Dashboard:*\n\n* Queue depth (pending messages)\n* Throughput (messages published/consumed per minute)\n* Dead letter queue depth (failed messages)\n* Consumer lag (time between publish and consume)\n\n*Customer Support Dashboard (Business Metrics):*\n\n* Total feedback submissions per day/week/month\n* Feedback category breakdown (App, Service, Order, Rewards, Refund, Delete Account)\n* Customer satisfaction score (CSAT) trend\n* Average case resolution time trend\n* Case volume by support team/queue\n* Unified customer view adoption (support agent feedback)\n<<<\n== Solution Validation\n\nThis section defines the validation criteria and testing approach for the solution.\n\n=== Functional Validation\n\n==== ProfileService API Testing\n\n*Test Scenarios*:\n1. **Happy Path**: Authenticated user requests Contact ID, existing Contact found in Salesforce, Contact ID returned\n2. **JIT Creation**: Authenticated user requests Contact ID, no existing Contact, new Contact created in Salesforce, Contact ID returned\n3. **Salesforce API Failure**: Salesforce unavailable, ProfileService returns 500 error, user retries\n4. **Invalid JWT**: Unauthenticated request, ProfileService returns 401 error\n\n*Acceptance Criteria*:\n- Contact reconciliation success rate > 99.5%\n- JIT Contact creation completes within 500ms (p95)\n\n==== EngagementService API Testing\n\n*Test Scenarios*:\n1. **Happy Path**: Valid feedback submission, immediate 202 Accepted response, Case created in Salesforce within 5 minutes, Braze notification delivered\n2. **Invalid Category**: Invalid feedback category, 400 Bad Request response with validation error\n3. **Salesforce Downtime**: Salesforce unavailable during async Case creation, message queued, retry logic executes, Case created when Salesforce recovers\n4. **Dead Letter Queue**: Case creation fails after 5 retries, message moved to DLQ, ops team alerted\n5. **Webhook Notification**: Support agent resolves Case in Salesforce, webhook triggers EngagementService, Braze push notification sent to customer\n\n*Acceptance Criteria*:\n- Feedback submission success rate > 99.5% (including async Case creation)\n- Async Case creation completes within 5 minutes (p95)\n- Webhook delivery success rate > 99%\n\n=== Non-Functional Validation\n\n==== Performance Testing\n\n*Load Testing*:\n\n*Baseline*: Expected 100-150 submissions/day from 20k DAU (~0.5-0.75% submission rate)\n\n- **Normal Load**: 1 submission/minute sustained for 2 hours (simulate typical daily pattern)\n- **3x Load**: 3 submissions/minute sustained for 1 hour (simulate busy period, 450 submissions/day)\n- **Peak Load (10x)**: 10 submissions/minute for 15 minutes (simulate incident scenario, app outage causing backlog)\n- **Stress Test**: 50 submissions/minute for 5 minutes (find breaking point, 20x normal)\n\n*Validation*:\n- API response time p95 < 1 second under 10x load\n- Event Bus queue depth remains manageable (< 100 messages)\n- No Case creation failures, all submissions processed successfully\n- Auto-scaling triggers appropriately for sustained load > 3x baseline\n\n*Acceptance Criteria*:\n- NFR-PERF-001 through NFR-PERF-006 validated under realistic load (3x and 10x baseline)\n- Auto-scaling triggers within 2 minutes of load increase\n- System handles 10x peak gracefully, 20x stress test identifies limits\n\n==== Resilience Testing\n\n*Salesforce API Failure Scenarios*:\n1. **Complete Outage**: Salesforce unavailable for 2 hours, Event Bus queues buffer work, Cases created when Salesforce recovers\n2. **Rate Limit Exceeded**: Salesforce rate limit hit, queue throttling activates, Cases created within SLA\n\n*Acceptance Criteria*:\n- NFR-AVAIL-004 validated (graceful degradation during Salesforce downtime)\n- Circuit breaker activates after 5 consecutive failures\n\n==== Security Validation\n\n*Penetration Testing*:\n- API authentication bypass attempts\n- SQL injection attempts\n- Webhook signature validation bypass\n\n*Acceptance Criteria*:\n- NFR-SEC-001 through NFR-SEC-010 validated\n- OWASP API Security Top 10 compliance verified\n\n=== Integration Validation\n\n==== End-to-End Testing\n\n*Full User Journey*:\n1. User authenticates via Microsoft Entra External ID\n2. Mobile App requests Contact ID from ProfileService (JIT reconciliation)\n3. User submits feedback via EngagementService\n4. Background worker creates Case in Salesforce\n5. Braze notification delivered to user\n6. Support agent resolves Case in Salesforce\n7. Salesforce webhook triggers EngagementService\n8. Braze notification delivered to user\n\n*Acceptance Criteria*:\n- End-to-end flow completes successfully in UAT\n- User receives both \"feedback submitted\" and \"case resolved\" notifications\n","structuredPatch":[{"oldStart":1787,"oldLines":6,"newStart":1787,"newLines":7,"lines":[" * Rollback procedure validated in sandbox"," * Documentation complete and approved"," ","+[[wp-cs-005]]"," === WP-CS-005: Mobile App Integration"," "," ==== Description"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"089add43-e042-4a2a-8c0f-d395cb8cee37"}
{"parentUuid":"dceaeabf-9e7c-4d2d-84fd-34df01f4c7e0","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_014QeqD6DGAPXoZpohv5cj9f","type":"tool_result","content":"The file /mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n  1853→* Unit test coverage > 80% for shared business logic\n  1854→* UI tests pass for all feedback form workflows (happy path, error states)\n  1855→* App builds and deploys successfully to TestFlight (iOS) and Google Play Internal Testing (Android)\n  1856→\n  1857→[[wp-cs-006]]\n  1858→=== WP-CS-006: Integration Testing\n  1859→\n  1860→==== Description\n  1861→\n  1862→Execute comprehensive integration testing across all system components in non-production environments.\n  1863→\n  1864→==== Deliverables"}]},"uuid":"408a45e5-e652-4fc4-97bf-c9ef6e63162a","timestamp":"2026-01-09T03:10:46.811Z","toolUseResult":{"filePath":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","oldString":"=== WP-CS-006: Integration Testing\n\n==== Description","newString":"[[wp-cs-006]]\n=== WP-CS-006: Integration Testing\n\n==== Description","originalFile":"= Salesforce Customer Support - Solution Architecture\n:project-name: Salesforce Customer Support\n:togaf-adm-phase: Phase E: Opportunities & Solutions\n:last-updated: 2026-01-07\n:document-type: Solution Architecture Document\n:status: Discovery\n:version: 0.1\n:domain: Customer Support & Engagement\n:programme-lead:\n:domain-architect: O.Young@otr.com.au\n:architecture-definition: xref:architecture-definitions:salesforce_customer_support.adoc[Architecture Definitions/Salesforce Customer Support]\n:doctype: article\n:toc: left\n:toclevels: 4\n:sectanchors:\n:sectlinks:\n:sectnums:\n:icons: font\n:source-highlighter: highlightjs\n:experimental:\n:description:\n:keywords:\n\n<<<\n== Purpose and Scope\n\n=== Purpose\n\nThis Solution Architecture defines how the Salesforce Customer Support consolidation will be implemented - the specific technology products, configurations, interfaces, and deployment architecture that realise the xref:architecture-definitions:salesforce_customer_support.adoc[Salesforce Customer Support Architecture Definition].\n\nThis solution establishes the **first implementation of OTR's target Domain-Driven Design (DDD) architecture** by deploying two new bounded contexts (`ProfileService` and `EngagementService`) as microservices, consolidating customer support onto Salesforce Service Cloud, and implementing event-driven integration patterns that will serve as the foundation for future bounded contexts (including Flybuys integration).\n\n=== Vision\n\n> Unify customer support across all OTRG channels by consolidating OTR digital customer feedback onto Salesforce Service Cloud, establishing the foundational DDD architecture with ProfileService and EngagementService bounded contexts that protect digital channels from external system changes while enabling support agents to deliver exceptional customer experiences with complete interaction history.\n\n=== Architectural Approach\n\nThis architecture establishes OTR's **first bounded context implementation** using Domain-Driven Design strategic patterns:\n\n* *link:../bounded_context/profile.adoc[ProfileService]* (NEW bounded context): Just-In-Time Contact reconciliation with Salesforce, upsert by email, returns Salesforce Contact ID to digital channels - foundation for future Flybuys partner linking\n* *link:../bounded_context/engagement.adoc[EngagementService]* (NEW bounded context): Customer feedback submission facade, Anti-Corruption Layer for Salesforce Case creation, Braze integration for all outbound customer communications (push, email, SMS), async Case processing via Event Bus\n* *Event-driven integration* (NEW pattern): Domain event publishing using existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis) - first implementation establishing pattern for future bounded contexts\n* *Anti-Corruption Layer*: EngagementService isolates digital channels from Salesforce API changes, translates between OTR domain language and Salesforce Service Cloud API\n* *Conformist Pattern*: ProfileService and EngagementService conform to existing Salesforce configuration (shared Viva Energy instance, multi-tenant governance)\n* *Big bang cutover*: Single deployment after Contact migration, no phased rollout, D365 CE retirement post-cutover\n\n=== Scope\n\n==== In Scope\n\n* Solution Building Blocks (SBBs) - specific technology products and versions\n* Interface specifications (APIs, events, data formats)\n* Data architecture and schema specifications\n* Deployment architecture and infrastructure configuration\n* Transition architecture with migration phases\n* Technical validation criteria and testing approach\n* External system integration specifications\n* Physical data models and API schemas\n\n==== Out of Scope\n\n===== Covered in xref:architecture-definitions:salesforce_customer_support.adoc[Architecture Definition]\n\n* Business requirements and stakeholder analysis\n* Architecture decisions and rationale (ADRs)\n* Bounded context definitions and responsibilities\n* High-level integration patterns (ACL, Conformist, OHS+PL)\n* Business capability mapping and value streams\n* Architecture principles and governance\n\n===== Covered in Other Documents\n\n* Detailed design (class diagrams, sequence diagrams for all flows)\n* Implementation code and unit tests\n* Business case and return-on-investment analysis\n* Operational run books and support procedures\n\n<<<\n=== Architecture Overview\n\n[mermaid]\n----\n---\nconfig:\n  layout: elk\n---\nflowchart TB\n    Customer([\"Customer\"]) -- Uses --> MobileApp[\"Mobile App<br>iOS/Android\"]\n    Customer -- Shops at --> POS[\"OTR/OTR+ POS<br>D365 Commerce\"]\n    MobileApp -- Authenticate --> EntraID[\"Microsoft Entra\"]\n    MobileApp -- Identifies & Reconciles --> ProfileService[\"ProfileService\"]\n    ProfileService <-- Reconcile App User as Salesforce Contact --> Salesforce[\"Salesforce\"]\n    ProfileService -- On Create --> EventBus[\"EventBus\"]\n    EventBus -- Emits CreateUser Event --> LoyaltyService[\"LoyaltyService\"] & EngagementService[\"EngagementService\"]\n    LoyaltyService -- Reconcile Wallet --> EagleEye[\"EagleEye\"]\n    EngagementService -- Reconcile Braze Profile --> Braze[\"Braze\"]\n    EngagementService --> Salesforce\n    D365CE[\"D365CE\"] -- Data Migration --> Salesforce\n    MobileApp -- Submits Feedback --> EngagementService\n\n    Customer:::customer\n    MobileApp:::presentation\n    POS:::presentation\n    EntraID:::external\n    ProfileService:::newService\n    Salesforce:::external\n    EventBus:::infrastructure\n    LoyaltyService:::newService\n    EngagementService:::newService\n    EagleEye:::external\n    Braze:::external\n    D365CE:::external\n    classDef newService fill:#4CAF50,stroke:#2E7D32,stroke-width:3px,color:#fff\n    classDef external fill:#FF9800,stroke:#E65100,stroke-width:2px,color:#fff\n    classDef infrastructure fill:#2196F3,stroke:#0D47A1,stroke-width:2px,color:#fff\n    classDef presentation fill:#9C27B0,stroke:#4A148C,stroke-width:2px,color:#fff\n    classDef customer fill:#607D8B,stroke:#263238,stroke-width:2px,color:#fff\n----\n\n\n==== Key Architectural Patterns\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Pattern |Application |Rationale\n\n|*Anti-Corruption Layer (ACL)*\n|EngagementService → Salesforce Service Cloud\n|Protects digital channels (Mobile App, Web) from Salesforce API changes, translates between OTR domain language and Salesforce Case/Contact model, enables independent evolution of internal domain model\n\n|*Conformist*\n|ProfileService → Salesforce, EngagementService → Salesforce\n|Shared Viva Energy Salesforce instance - we conform to existing configuration, governance, and API contracts (external system we don't control)\n\n|*Backend-for-Frontend (BFF)*\n|EngagementService\n|Aggregates customer feedback submission, Contact lookup, async Case creation, and Braze notification orchestration for digital channel clients\n\n|*Event-Driven Architecture (OHS+PL)*\n|Event Bus (SNS+SQS/EventBridge/Kinesis)\n|Loose coupling between bounded contexts, async domain event publishing (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`), foundation for future bounded contexts\n\n|*Just-In-Time (JIT) Integration*\n|ProfileService → Salesforce Contact reconciliation\n|Reconcile app users as Salesforce Contacts on-demand (upsert by email), no pre-sync required, ensures Salesforce has current Contact data\n\n|*Async Processing*\n|EngagementService Case creation via Event Bus\n|Non-blocking user experience, resilience to Salesforce downtime, automatic retry with exponential backoff, dead letter queue for operations team intervention\n\n|*Strangler Fig*\n|Not applicable\n|Big bang cutover (no gradual migration) - D365 CE fully replaced, not incrementally strangled\n\n|===\n\n<<<\n== Solution Approach\n\n* Deploy xref:bounded-contexts:profile.adoc[ProfileService] and xref:bounded-contexts:engagement.adoc[EngagementService] as bounded context microservices\n* Implement Anti-Corruption Layers (ACLs) for Salesforce and Braze integration\n* Establish event-driven architecture as the foundational integration pattern\n* Big bang cutover (TS-1 → TS-4)\n\n=== Related Documentation\n\nThis solution architecture references detailed technical specifications:\n\n==== Architecture Definition\n\n* xref:architecture-definitions:salesforce_customer_support.adoc[Salesforce Customer Support - Architecture Definition] - Business requirements, architecture decisions (ADRs), bounded context definitions, high-level integration patterns\n\n==== Bounded Context Specifications\n\n* xref:bounded-contexts:profile.adoc[ProfileService Bounded Context] - JIT Contact reconciliation, aggregate definitions\n* xref:bounded-contexts:engagement.adoc[EngagementService Bounded Context] - Customer feedback facade, Anti-Corruption Layer\n\n==== Interface Specifications\n\nDetailed API specifications available in the specifications directory:\n\n* link:../../specifications/rest/profile-service-v1.yaml[ProfileService REST API v1] - OpenAPI 3.0 specification for `/profile/v1` endpoints (includes Salesforce Contact reconciliation `GET /contact-id`)\n* link:../../specifications/rest/engagement-service-v1.yaml[EngagementService REST API v1] - OpenAPI 3.0 specification for `/engagement/v1` endpoints (includes `POST /feedback`)\n* link:../../specifications/events/engagement-events.json[Engagement Domain Events] - CloudEvents 1.0 JSON Schema for `SupportCaseCreated`, `SupportCaseUpdated`, `SupportCaseResolved`, `CustomerFeedbackSubmitted`\n\n==== External System Documentation\n\n* https://developer.salesforce.com/docs/atlas.en-us.api_rest.meta/api_rest/[Salesforce REST API Documentation] - Contact and Case object APIs\n* https://www.braze.com/docs/api/endpoints/messaging/send_messages/post_send_triggered_campaigns/[Braze Campaign Trigger API] - Push notification campaigns\n\n<<<\n== Executive Summary\n\n=== Challenge\n\nOTR digital customers (Mobile App, Web) currently submit feedback and support requests to D365 Customer Engagement, while Viva Energy's broader business units (fuel wholesale, Shell Card customers, other retail channels) use Salesforce Service Cloud. This creates:\n\n* *Fragmented customer support platform*: Customer support data split across two systems, preventing support agents from having a unified view of customer interactions across all channels\n* *Operational inefficiency*: Maintaining two separate customer support platforms increases operational overhead and costs\n* *Poor support experience*: D365 CE is not working well for digital customer support, impacting customer satisfaction and case resolution times\n* *Post-merger consolidation opportunity*: Following Viva Energy's acquisition of OTR, strategic alignment on Salesforce as the enterprise customer support platform\n\n=== Solution\n\nThis architecture establishes the **foundational Domain-Driven Design (DDD) implementation** for OTR's target state architecture by introducing two new bounded contexts (link:../bounded_context/profile.adoc[ProfileService], link:../bounded_context/engagement.adoc[EngagementService]) and event-driven integration patterns:\n\n==== New Bounded Contexts\n\n* *link:../bounded_context/profile.adoc[ProfileService]* (NEW): Just-In-Time (JIT) Contact reconciliation with Salesforce, upsert by email, returns Salesforce Contact ID to Mobile App\n* *link:../bounded_context/engagement.adoc[EngagementService]* (NEW): Customer feedback submission, Anti-Corruption Layer (ACL) for Salesforce Case creation, Braze integration for all outbound customer communications (push, email, SMS), async Case processing via Event Bus\n* *Event Bus* (NEW pattern): Domain event publishing using existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis) - first implementation of event-driven architecture pattern\n\n==== Integration Architecture\n\n* *Salesforce = System of Record*: Salesforce Service Cloud (shared Viva Energy instance) owns Contact and Case data\n* *Conformist Pattern*: ProfileService and EngagementService conform to existing Salesforce configuration and API contracts\n* *Anti-Corruption Layer*: EngagementService protects digital channels from Salesforce API changes, translates between OTR domain language and Salesforce\n* *Async Case Creation*: Non-blocking user experience, resilience to Salesforce downtime, automatic retry with exponential backoff, dead letter queue for failed Cases\n* *Event-Driven Notifications*: Salesforce webhook → EngagementService → Braze for all customer communications (push, email, SMS) on Case status updates\n\n==== Migration Approach\n\n* *Contact Migration*: One-time migration from app-specific database → Salesforce (upsert with flexible matching by email/phone/VCI)\n* *No Case Migration*: Historical D365 CE Cases not migrated (fresh start in Salesforce)\n* *Big Bang Cutover*: Single deployment, no phased rollout or parallel run\n* *D365 CE Retirement*: Complete decommissioning of D365 Customer Engagement post-cutover\n\n=== Key Architectural Significance\n\nThis migration establishes the first implementation of OTR's target DDD architecture:\n\n* First bounded contexts implemented (ProfileService, EngagementService)\n* First event-driven domain event pattern (foundation for future bounded contexts)\n* Foundation for Flybuys integration (ProfileService Contact reconciliation reused)\n* Establishes integration patterns (Conformist, ACL, Event-Driven) for future services\n\n=== Success Criteria\n\n* All digital customer feedback routed to Salesforce Service Cloud within 30 days of launch\n* Support agents have unified customer view across all Viva Energy channels (digital, wholesale, Shell Card, other retail)\n* D365 Customer Engagement decommissioned within 90 days post-cutover\n* Customer satisfaction score improves by 15% within 6 months\n* Average case resolution time decreases by 20% within 6 months\n* Zero data loss during Contact migration (100% validation pass rate)\n* Mobile App feedback submission success rate > 99.5% (including async Case creation)\n\n=== Technical Constraints\n\n* Shared Salesforce instance (Viva Energy multi-tenant environment)\n* Conform to existing Salesforce configuration and governance (data isolation strategy TBD with Salesforce admin team)\n* Contact migration must complete before cutover (no parallel run)\n* Async Case creation mandatory (non-blocking user experience)\n* Expected volume: 100-150 feedback submissions/day from 20k DAU (~0.5-0.75% submission rate), architecture capacity planned for 3x-10x growth\n\n=== Open Technical Decisions (TBD)\n\n* Salesforce Case field mapping for digital feedback categories (App, Service, Order, Rewards, Refund, Delete Account)\n* Salesforce data isolation strategy (Record Types, custom fields, queues)\n* Salesforce REST API authentication method (OAuth 2.0, Connected App, JWT bearer flow)\n* Salesforce webhook mechanism for Case updates (Outbound Messages, Platform Events, Process Builder)\n* Retry policy configuration (attempts, backoff intervals)\n* Salesforce API rate limit strategy (expected volume: 100-150 submissions/day from 20k DAU, capacity planning for 3x-10x growth)\n\n== Technical Requirements\n\n[width=\"100%\",cols=\"8%,92%\",options=\"header\",]\n|===\n|ID |Description\n\n|TR-CS-001\n|Every Mobile App user must have a Salesforce Contact record in Salesforce Service Cloud (shared Viva Energy instance)\n\n|TR-CS-002\n|ProfileService must reconcile Mobile App users as Salesforce Contacts using Just-In-Time (JIT) upsert by email address\n\n|TR-CS-003\n|ProfileService must return Salesforce Contact ID to Mobile App for feedback submission\n\n|TR-CS-004\n|Mobile App must support customer feedback submission with fields: Category (App, Service, Order, Rewards, Refund, Delete Account), Store Name, Time of Visit, Contact Phone Number, Free Text Message\n\n|TR-CS-005\n|EngagementService must create Salesforce Cases asynchronously via Event Bus (non-blocking user experience)\n\n|TR-CS-006\n|EngagementService must acknowledge feedback submission immediately to Mobile App user (\"Feedback submitted\" confirmation)\n\n|TR-CS-007\n|EngagementService must send push notification to customer via Braze when Case is successfully created in Salesforce\n\n|TR-CS-008\n|EngagementService must retry failed Case creation with configurable exponential backoff and dead letter queue for operations team intervention\n\n|TR-CS-009\n|Salesforce must be the System of Record for Contact and Case data (no local persistence in ProfileService or EngagementService)\n\n|TR-CS-010\n|Contact migration from app-specific database to Salesforce must complete before Mobile App cutover (upsert with flexible matching by email/phone/VCI)\n\n|TR-CS-011\n|No Case migration from D365 Customer Engagement to Salesforce (fresh start, historical Cases not migrated)\n\n|TR-CS-012\n|EngagementService must publish domain events (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`) to Event Bus for consumption by other bounded contexts\n\n|TR-CS-013\n|EngagementService must receive Salesforce webhook notifications when Cases are updated/resolved by support agents\n\n|TR-CS-014\n|EngagementService must trigger Braze push notifications to customers when Cases are updated/resolved (via Salesforce webhook → EngagementService → Braze)\n\n|TR-CS-015\n|ProfileService and EngagementService must conform to existing Salesforce configuration and API contracts (Conformist pattern)\n\n|TR-CS-016\n|All changes must be communicated using event-driven architecture via Event Bus (using existing AWS infrastructure: SNS+SQS/EventBridge/Kinesis)\n\n|TR-CS-017\n|Mobile App feedback submission success rate must exceed 99.5% (including async Case creation completion)\n\n|TR-CS-018\n|Contact migration must achieve 100% validation pass rate (zero data loss)\n\n|TR-CS-019\n|D365 Customer Engagement must be fully decommissioned within 90 days post-cutover\n\n|===\n\n== Technical Architecture\n\n=== Technical Capability Requirements\n\n==== Requirements Traceability\n\n[width=\"100%\",cols=\"15%,50%,35%\",options=\"header\",]\n|===\n|Requirement ID |Requirement Summary |Architectural Building Blocks\n\n|TR-CS-001\n|Every Mobile App user must have Salesforce Contact record\n|ABB-CS-001 (ProfileService), ABB-CS-004 (Salesforce), ABB-CS-007 (Contact Migration Tool)\n\n|TR-CS-002\n|ProfileService JIT Contact reconciliation via upsert by email\n|ABB-CS-001 (ProfileService), ABB-CS-004 (Salesforce)\n\n|TR-CS-003\n|ProfileService returns Salesforce Contact ID to Mobile App\n|ABB-CS-001 (ProfileService), ABB-CS-006 (Mobile App)\n\n|TR-CS-004\n|Mobile App supports feedback submission with structured fields\n|ABB-CS-006 (Mobile App), ABB-CS-002 (EngagementService)\n\n|TR-CS-005\n|EngagementService creates Salesforce Cases asynchronously\n|ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus), ABB-CS-004 (Salesforce)\n\n|TR-CS-006\n|EngagementService immediate acknowledgment to Mobile App\n|ABB-CS-002 (EngagementService), ABB-CS-006 (Mobile App)\n\n|TR-CS-007\n|EngagementService sends push notification via Braze on Case creation\n|ABB-CS-002 (EngagementService), ABB-CS-005 (Braze)\n\n|TR-CS-008\n|EngagementService retry logic with exponential backoff and DLQ\n|ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus)\n\n|TR-CS-009\n|Salesforce is System of Record for Contact and Case data\n|ABB-CS-004 (Salesforce), ABB-CS-001 (ProfileService - stateless), ABB-CS-002 (EngagementService - stateless)\n\n|TR-CS-010\n|Contact migration before Mobile App cutover\n|ABB-CS-007 (Contact Migration Tool), ABB-CS-004 (Salesforce)\n\n|TR-CS-011\n|No Case migration from D365 CE (fresh start)\n|ABB-CS-004 (Salesforce) - no migration tooling required\n\n|TR-CS-012\n|EngagementService publishes domain events to Event Bus\n|ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus)\n\n|TR-CS-013\n|EngagementService receives Salesforce webhook notifications\n|ABB-CS-002 (EngagementService), ABB-CS-004 (Salesforce)\n\n|TR-CS-014\n|EngagementService triggers Braze notifications on Case updates\n|ABB-CS-002 (EngagementService), ABB-CS-004 (Salesforce), ABB-CS-005 (Braze)\n\n|TR-CS-015\n|ProfileService and EngagementService conform to Salesforce config\n|ABB-CS-001 (ProfileService), ABB-CS-002 (EngagementService), ABB-CS-004 (Salesforce)\n\n|TR-CS-016\n|Event-driven architecture via Event Bus\n|ABB-CS-003 (Event Bus), ABB-CS-002 (EngagementService)\n\n|TR-CS-017\n|Mobile App feedback submission success rate > 99.5%\n|ABB-CS-006 (Mobile App), ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus), ABB-CS-004 (Salesforce)\n\n|TR-CS-018\n|Contact migration 100% validation pass rate\n|ABB-CS-007 (Contact Migration Tool), ABB-CS-004 (Salesforce)\n\n|TR-CS-019\n|D365 CE decommissioned within 90 days post-cutover\n|All ABBs (replacement system operational)\n\n|===\n\n=== Service Catalogues\n\n==== Application Portfolio Catalogue\n\n[width=\"100%\",cols=\"20%,15%,15%,15%,35%\",options=\"header\",]\n|===\n|Application |Lifecycle State |Owner |Hosting Platform |Description\n\n|*ProfileService*\n|NEW\n|OTR Platform Team\n|AWS (TBD: Lambda/ECS/EKS)\n|JIT Contact reconciliation with Salesforce, returns Salesforce Contact ID, foundation for Flybuys integration\n\n|*EngagementService*\n|NEW\n|OTR Platform Team\n|AWS (TBD: Lambda/ECS/EKS)\n|Customer feedback submission facade, ACL for Salesforce Case creation, Braze integration for all outbound communications (push, email, SMS), webhook receiver\n\n|*Mobile App (iOS)*\n|ACTIVE (UPDATE)\n|OTR Mobile Team\n|Apple App Store\n|iOS native app with feedback form, integrate with ProfileService and EngagementService APIs\n\n|*Mobile App (Android)*\n|ACTIVE (UPDATE)\n|OTR Mobile Team\n|Google Play Store\n|Android native app with feedback form, integrate with ProfileService and EngagementService APIs\n\n|*Salesforce Service Cloud*\n|ACTIVE (EXPAND)\n|Viva Energy Salesforce Admin Team\n|Salesforce (SaaS)\n|Shared Viva Energy instance, System of Record for Contact and Case data, adding OTR digital customer support\n\n|*Braze*\n|ACTIVE (EXTEND)\n|OTR Marketing Team\n|Braze (SaaS)\n|Marketing automation platform, EngagementService triggers push notifications for Case updates\n\n|*D365 Customer Engagement*\n|RETIRE\n|OTR Support Team\n|Microsoft Azure (SaaS)\n|Legacy customer support platform, decommissioned within 90 days post-cutover\n\n|*App-Specific Customer Database*\n|RETIRE\n|OTR Platform Team\n|AWS (RDS/DynamoDB)\n|Legacy customer contact storage, one-time migration to Salesforce, then deprecated\n\n|*Event Bus*\n|NEW\n|OTR Platform Team\n|AWS (SNS+SQS/EventBridge/Kinesis)\n|Domain event publishing infrastructure for bounded context integration\n\n|*Contact Migration Tool*\n|TEMPORARY\n|OTR Platform Team\n|AWS (Script/Lambda)\n|One-time migration app database → Salesforce with upsert logic, retired after migration complete\n\n|===\n\n==== Technology Capability Requirements\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Technology Capability |Implementation Technology (TBD in detailed design) |Requirements\n\n|*Microservice Hosting*\n|AWS Lambda / ECS / EKS\n|Host ProfileService and EngagementService with auto-scaling, high availability, monitoring\n\n|*API Gateway*\n|AWS API Gateway / Application Load Balancer\n|REST API routing, authentication, rate limiting, request validation for ProfileService and EngagementService\n\n|*Event Bus*\n|AWS SNS+SQS / EventBridge / Kinesis\n|Domain event publishing, async message processing, retry logic, dead letter queue\n\n|*Salesforce Integration*\n|Salesforce REST API / SOAP API\n|Contact CRUD operations, Case creation, webhook notifications, OAuth 2.0 authentication\n\n|*Braze Integration*\n|Braze REST API / SDK\n|Push notification campaign triggers, customer profile reconciliation\n\n|*Authentication & Authorisation*\n|Microsoft Entra External ID / AWS Cognito\n|Mobile App user authentication, API authorisation, JWT token validation\n\n|*Observability & Monitoring*\n|AWS CloudWatch / Datadog / New Relic\n|Application metrics, logs, traces, dashboards, alerting (feedback submission rate, queue depth, API errors)\n\n|*Secret Management*\n|AWS Secrets Manager / Parameter Store\n|Salesforce credentials, Braze API keys, OAuth tokens, encryption keys\n\n|*Database (Migration Tool)*\n|AWS RDS / DynamoDB (read-only access)\n|Contact migration from app-specific database\n\n|*CI/CD Pipeline*\n|GitHub Actions / AWS CodePipeline\n|Automated build, test, deployment for ProfileService, EngagementService, Mobile App\n\n|*Infrastructure as Code*\n|Terraform / AWS CloudFormation / CDK\n|Declarative infrastructure provisioning for Event Bus, microservices, monitoring\n\n|*API Documentation*\n|OpenAPI / Swagger\n|ProfileService and EngagementService API specifications for Mobile App integration\n\n|===\n\n==== Feature Flag Register\n\n*Note*: Per ADR-CS-006 (big bang cutover, not phased rollout), feature flags are minimal and used primarily for emergency rollback/kill switches.\n\n[width=\"100%\",cols=\"20%,15%,35%,30%\",options=\"header\",]\n|===\n|Feature Flag |Default State |Purpose |Rollback Scenario\n\n|*enable_salesforce_feedback_submission*\n|OFF (pre-cutover), ON (post-cutover)\n|Enable/disable feedback submission to EngagementService → Salesforce (kill switch for emergency rollback to D365 CE)\n|Feedback submission success rate < 95%, Salesforce API failures, critical bugs - revert to D365 CE integration\n\n|*enable_async_case_creation*\n|ON\n|Enable/disable async Case creation via Event Bus (fallback to synchronous processing if Event Bus issues)\n|Event Bus infrastructure failures, queue backlog unmanageable - temporary synchronous processing\n\n|*enable_braze_notifications*\n|ON\n|Enable/disable Braze push notifications for Case updates (degrade gracefully if Braze integration fails)\n|Braze API failures, notification delivery rate < 80% - disable notifications temporarily\n\n|*enable_jit_contact_reconciliation*\n|ON\n|Enable/disable ProfileService JIT Contact reconciliation (fallback to cached Contact IDs if Salesforce unavailable)\n|Salesforce API downtime, Contact reconciliation failures > 5% - use cached Contact IDs temporarily\n\n|*enable_salesforce_webhook_processing*\n|ON\n|Enable/disable Salesforce webhook processing for Case updates (fallback to polling if webhook failures)\n|Webhook delivery failures, authentication issues - temporary polling fallback\n\n|===\n\n*Feature Flag Management*:\n\n* Feature flags managed via AWS AppConfig / LaunchDarkly / custom feature flag service (TBD in detailed design)\n* Mobile App feature flags controlled server-side (no app release required for flag changes)\n* Backend service feature flags configured via environment variables / configuration service\n* Feature flag changes logged and audited (who changed, when, reason)\n* Post-cutover monitoring: Gradual removal of feature flags once system stability confirmed (30-60 days)\n\n==== Data Entity Catalogue\n\n[width=\"100%\",cols=\"20%,15%,35%,30%\",options=\"header\",]\n|===\n|Data Entity |System of Record |Key Attributes |Lifecycle\n\n|*Contact*\n|Salesforce Service Cloud\n|• Contact ID (Salesforce 15/18-char ID) +\n• Email (primary matching key) +\n• First Name, Last Name +\n• Phone Number +\n• Viva Consumer ID (VCI) +\n• Account (Viva Energy customer account) +\n• Record Type (OTR Digital vs other channels)\n|Created: ProfileService JIT reconciliation or Contact Migration Tool +\nUpdated: ProfileService JIT upsert (email changes), Salesforce (manual updates by support agents) +\nDeleted: Salesforce retention policy (GDPR/compliance)\n\n|*Case*\n|Salesforce Service Cloud\n|• Case Number (Salesforce auto-generated) +\n• Contact ID (reference to Contact) +\n• Subject (derived from Category) +\n• Description (Free Text Message) +\n• Category (App, Service, Order, Rewards, Refund, Delete Account) +\n• Store Name (OTR location) +\n• Time of Visit +\n• Status (New, In Progress, Resolved, Closed) +\n• Priority, Origin (Mobile App) +\n• Owner (support agent/queue)\n|Created: EngagementService async Case creation +\nUpdated: Support agents (Salesforce UI), EngagementService (webhook processing) +\nDeleted: Salesforce retention policy (archive after X years)\n\n|*Feedback Submission (transient)*\n|None (not persisted)\n|• Salesforce Contact ID +\n• Category +\n• Store Name +\n• Time of Visit +\n• Contact Phone Number +\n• Free Text Message\n|Created: Mobile App user submission +\nProcessed: EngagementService publishes to Event Bus, Case created in Salesforce +\nNot persisted in ProfileService/EngagementService (stateless)\n\n|*Domain Events*\n|Event Bus (ephemeral)\n|**SupportCaseCreated**: +\n• Case Number, Contact ID, Category, Timestamp +\n**SupportCaseUpdated**: +\n• Case Number, Status, Updated By, Timestamp +\n**SupportCaseResolved**: +\n• Case Number, Resolution, Resolved By, Timestamp +\n**CustomerFeedbackSubmitted**: +\n• Contact ID, Category, Timestamp\n|Published: EngagementService +\nConsumed: Other bounded contexts (future), Braze notification triggers +\nRetention: Short-lived (minutes to hours), not persisted for event sourcing\n\n|*Braze Customer Profile*\n|Braze\n|• External User ID (VCI or Email) +\n• Push Notification Tokens (iOS/Android) +\n• Notification Preferences +\n• Campaign Engagement History\n|Created/Updated: EngagementService on Case creation/update +\nManaged: Braze (external SaaS)\n\n|===\n\n*Data Migration Entities*:\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Source Entity |Target Entity |Migration Strategy\n\n|*App Database Contact*\n|Salesforce Contact\n|One-time migration via Contact Migration Tool: +\n• Upsert by email (primary), phone (secondary), VCI (tertiary) +\n• Map: Email → Email, Name → First/Last Name, Phone → Phone, VCI → External ID +\n• Validation: 100% data integrity check, reconciliation report\n\n|*D365 CE Case*\n|Not migrated\n|ADR-CS-005: No Case migration (fresh start in Salesforce) +\nD365 CE Cases archived separately for compliance if needed\n\n|===\n\n==== Data Quality & Validation\n\n*Contact Migration Validation Rules*:\n\n* Email format validation (RFC 5322 compliance)\n* Phone number format validation (E.164 international format)\n* VCI format validation (alphanumeric, length constraints)\n* Duplicate detection: Flag potential duplicates for manual review (same email/phone combination)\n* Mandatory fields: Email (required), First Name, Last Name (required for Salesforce Contact)\n\n*Case Creation Validation Rules*:\n\n* Contact ID must exist in Salesforce (validated by EngagementService before Case creation)\n* Category must be one of: App, Service, Order, Rewards, Refund, Delete Account\n* Free Text Message maximum length: 32,000 characters (Salesforce Case Description limit)\n* Store Name validated against OTR location master data (optional - warn if not found)\n\n<<<\n== Solution Building Blocks\n\nThis section defines the specific technology products, configurations, and implementation details for each Solution Building Block (SBB).\n\n=== Technology Portfolio Catalogue\n\n[width=\"100%\",cols=\"10%,20%,25%,25%,20%\",options=\"header\",]\n|===\n|SBB ID |Component |Technology Product |Version/Configuration |Deployment Platform\n\n|SBB-CS-001\n|ProfileService Microservice\n|.NET 8 / Node.js 20 LTS\n|RESTful API, containerised\n|AWS ECS Fargate / Lambda\n\n|SBB-CS-002\n|EngagementService Microservice\n|.NET 8 / Node.js 20 LTS\n|RESTful API, containerised, async workers\n|AWS ECS Fargate / Lambda\n\n|SBB-CS-003\n|Event Bus\n|AWS SNS + SQS / EventBridge\n|Standard queues, FIFO for ordering\n|AWS (managed service)\n\n|SBB-CS-004\n|API Gateway\n|AWS API Gateway / ALB\n|REST API, JWT validation\n|AWS (managed service)\n\n|SBB-CS-005\n|Salesforce Integration Layer\n|Salesforce REST API Client\n|OAuth 2.0 JWT bearer flow\n|Embedded in SBB-CS-001/002\n\n|SBB-CS-006\n|Braze Integration Layer\n|Braze REST API SDK\n|API key authentication\n|Embedded in SBB-CS-002\n\n|SBB-CS-007\n|Contact Migration Tool\n|Python 3.11 / .NET 8\n|One-time batch script\n|AWS Lambda / EC2\n\n|SBB-CS-008\n|Application Monitoring\n|AWS CloudWatch / Datadog\n|Metrics, logs, traces, dashboards\n|AWS / SaaS\n\n|SBB-CS-009\n|Secret Management\n|AWS Secrets Manager\n|KMS encryption\n|AWS (managed service)\n\n|SBB-CS-010\n|Mobile App (iOS)\n|SwiftUI, Kotlin Multiplatform\n|iOS 15+\n|Apple App Store\n\n|SBB-CS-011\n|Mobile App (Android)\n|Jetpack Compose, Kotlin Multiplatform\n|Android 8+\n|Google Play Store\n\n|SBB-CS-012\n|Feature Flag Service\n|AWS AppConfig / LaunchDarkly\n|Server-side flags, real-time updates\n|AWS / SaaS\n\n|===\n\n<<<\n== Data Architecture\n\nThis section defines the physical data models, event schemas, and API request/response formats.\n\n=== Domain Event Schemas\n\nAll domain events follow the https://cloudevents.io/[CloudEvents 1.0] specification for consistency and interoperability.\n\n*Event Schema Specifications*: See // TODO: Add to Antora - specifications/events/engagement-events.json[Engagement Service Event Schemas] for complete JSON schemas and examples.\n\n==== Event Catalogue\n\n[width=\"100%\",cols=\"30%,20%,50%\",options=\"header\",]\n|===\n|Event Type |Publisher |Description\n\n|`SupportCaseCreated`\n|EngagementService\n|Published when EngagementService successfully creates a Case in Salesforce after async processing\n\n|`SupportCaseUpdated`\n|EngagementService (via Salesforce webhook)\n|Published when a support agent updates a Case in Salesforce (status, priority, comment changes)\n\n|`SupportCaseResolved`\n|EngagementService (via Salesforce webhook)\n|Published when a support agent resolves/closes a Case in Salesforce\n\n|`CustomerFeedbackSubmitted`\n|EngagementService\n|Published when customer submits feedback via Mobile App (before async Case creation)\n\n|===\n\n*Event Format*: All events use CloudEvents 1.0 envelope with event-specific payload in the `data` field.\n\n*Schema Location*: `specifications/events/engagement-events.json`\n\n=== API Request/Response Schemas\n\n==== ProfileService: GET /profile/contact-id\n\n*Response* (200 OK):\n[source,json]\n----\n{\n  \"contactId\": \"0034X00000ABCDEFG\",\n  \"email\": \"customer@example.com\",\n  \"firstName\": \"John\",\n  \"lastName\": \"Smith\"\n}\n----\n\n==== EngagementService: POST /feedback\n\n*Request*:\n[source,json]\n----\n{\n  \"contactId\": \"0034X00000ABCDEFG\",\n  \"category\": \"App\",\n  \"storeName\": \"OTR Adelaide\",\n  \"timeOfVisit\": \"2026-01-07T12:00:00Z\",\n  \"contactPhoneNumber\": \"+61412345678\",\n  \"message\": \"App crashed when submitting feedback\"\n}\n----\n\n*Response* (202 Accepted):\n[source,json]\n----\n{\n  \"feedbackId\": \"fb-2026-01-07-12345\",\n  \"status\": \"submitted\",\n  \"message\": \"Your feedback has been submitted!\"\n}\n----\n\n=== Salesforce Field Mappings\n\n==== Case Object Mapping\n\n[width=\"100%\",cols=\"25%,25%,25%,25%\",options=\"header\",]\n|===\n|OTR Field |Salesforce Field |Data Type |Notes\n\n|Category\n|Feedback_Category__c\n|Picklist\n|App, Service, Order, Rewards, Refund, Delete Account\n\n|Store Name\n|Store_Name__c\n|String (255)\n|OTR location name\n\n|Time of Visit\n|Time_of_Visit__c\n|DateTime\n|When customer visited store\n\n|Free Text Message\n|Description\n|Long Text (32,000)\n|Customer feedback message\n\n|===\n\n<<<\n=== Baseline Architecture\n\n==== Existing System Components\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Component |Current State |Status\n\n|*D365 Customer Engagement*\n|Customer support platform for OTR digital customers (Mobile App, Web), handles feedback submission and case management\n|**DEPRECATED** - Being replaced by Salesforce Service Cloud\n\n|*App-Specific Customer Database*\n|Stores customer contact data for Mobile App users, separate from Viva Energy systems\n|**MIGRATING** - One-time migration to Salesforce, then deprecated\n\n|*Mobile App*\n|iOS/Android native apps with feedback submission form including Category, Store Name, Time of Visit, Contact Phone Number, and Free Text Message fields\n|**REQUIRES UPDATE** - Integrate with ProfileService and EngagementService APIs (feedback form UI already complete)\n\n|*Salesforce Service Cloud*\n|Shared Viva Energy instance handling customer support for fuel wholesale, Shell Card customers, other retail channels\n|**EXPANDING** - Adding OTR digital customer support Cases and Contacts\n\n|*Existing AWS Infrastructure*\n|SNS+SQS / EventBridge / Kinesis available for event-driven architecture\n|**REUSING** - Event Bus implementation leverages existing infrastructure\n\n|===\n\n==== Integration Architecture\n\n*Current state:*\n\n* Mobile App → D365 Customer Engagement (direct integration)\n* App-specific customer database → standalone (no Salesforce integration)\n* No event-driven architecture (synchronous, tightly coupled)\n* No Anti-Corruption Layer protecting digital channels\n* Viva Energy support teams use Salesforce, OTR digital support uses D365 CE (fragmented)\n\n==== Technical Debt\n\n*No longer relevant* - D365 CE being deprecated, not documenting technical debt of system being retired.\n\n*New technical debt introduced by this migration:*\n\n* Salesforce field mapping TBD (requires coordination with Viva Energy Salesforce admin team)\n* Data isolation strategy TBD (Record Types, custom fields, queues - multi-tenant governance)\n* Salesforce webhook mechanism TBD (Outbound Messages vs Platform Events vs Process Builder)\n* Expected feedback volume unknown (gathering data for rate limit planning)\n\n=== Gap Analysis\n\n==== Missing Capabilities\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Missing Capability |Description\n\n|*ProfileService bounded context*\n|No existing service for Contact reconciliation with Salesforce - requires new microservice implementing JIT upsert by email, returning Salesforce Contact ID\n\n|*EngagementService bounded context*\n|No existing service for customer feedback facade - requires new microservice implementing Anti-Corruption Layer for Salesforce Case creation, Braze integration, async processing via Event Bus\n\n|*Event Bus domain event pattern*\n|No existing domain event publishing infrastructure - requires implementing event-driven architecture pattern using existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis)\n\n|*Async Case creation workflow*\n|Current D365 CE integration is synchronous - requires implementing async processing with retry logic, exponential backoff, dead letter queue\n\n|*Salesforce webhook integration*\n|No existing capability to receive Salesforce notifications - requires implementing webhook receiver in EngagementService for Case update notifications\n\n|*Braze push notification orchestration*\n|No existing integration for Case-related push notifications - requires implementing Braze campaign triggers from EngagementService\n\n|*Contact migration tooling*\n|No existing tooling for app database → Salesforce Contact migration with upsert logic (match by email/phone/VCI)\n\n|*Feedback form enhancements*\n|Mobile App feedback form lacks structured fields (Category, Store Name, Time of Visit, Contact Phone Number) - requires UI updates\n\n|===\n\n==== Missing Bounded Contexts\n\n[width=\"100%\",cols=\"30%,30%,40%\",options=\"header\",]\n|===\n|Bounded Context |Responsibilities |Implementation Status\n\n|*link:../bounded_context/profile.adoc[ProfileService]*\n|JIT Contact reconciliation with Salesforce (upsert by email), return Salesforce Contact ID to digital channels, foundation for future Flybuys partner linking\n|**NEW** - First bounded context implementation\n\n|*link:../bounded_context/engagement.adoc[EngagementService]*\n|Customer feedback submission facade, Anti-Corruption Layer for Salesforce Case creation, Braze integration for push notifications, async Case processing, webhook receiver for Case updates\n|**NEW** - First bounded context implementation\n\n|===\n\n==== Missing Integration Patterns\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Integration Pattern |Description\n\n|*Anti-Corruption Layer (ACL)*\n|EngagementService → Salesforce Service Cloud - protects digital channels from Salesforce API changes, translates between OTR domain language and Salesforce\n\n|*Conformist*\n|ProfileService/EngagementService → Salesforce - conform to existing Salesforce configuration and API contracts (shared Viva Energy instance)\n\n|*Event-Driven Architecture (OHS+PL)*\n|Event Bus publishing domain events (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`) for loose coupling between bounded contexts\n\n|*Just-In-Time (JIT) Integration*\n|ProfileService → Salesforce Contact reconciliation on-demand (no pre-sync)\n\n|*Async Processing*\n|EngagementService Case creation via Event Bus with retry, exponential backoff, dead letter queue\n\n|===\n\n=== Target State Architecture\n\n==== Architectural Building Blocks (ABB)\n\n[width=\"100%\",cols=\"20%,25%,30%,25%\",options=\"header\",]\n|===\n|ABB ID |Bounded Context |Responsibilities |Technology (TBD in Solution Architecture)\n\n|ABB-CS-001\n|*link:../bounded_context/profile.adoc[ProfileService]*\n|JIT Contact reconciliation with Salesforce (upsert by email), return Salesforce Contact ID, foundation for Flybuys partner linking\n|Microservice (.NET/Node.js), REST API, Salesforce REST API client\n\n|ABB-CS-002\n|*link:../bounded_context/engagement.adoc[EngagementService]*\n|Customer feedback submission facade, ACL for Salesforce Case creation, Braze integration, async processing, webhook receiver\n|Microservice (.NET/Node.js), REST API, Event Bus publisher/subscriber, Salesforce webhook receiver\n\n|ABB-CS-003\n|*Event Bus*\n|Domain event publishing infrastructure (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`)\n|AWS SNS+SQS / EventBridge / Kinesis\n\n|ABB-CS-004\n|*Salesforce Service Cloud*\n|System of Record for Contact and Case data (shared Viva Energy instance)\n|Salesforce Service Cloud (external SaaS)\n\n|ABB-CS-005\n|*Braze*\n|Marketing automation platform for push notifications\n|Braze (external SaaS) - existing integration\n\n|ABB-CS-006\n|*Mobile App*\n|iOS/Android native apps with enhanced feedback form (Category, Store Name, Time of Visit, Contact Phone Number, Free Text Message)\n|Kotlin Multiplatform, SwiftUI, Jetpack Compose\n\n|ABB-CS-007\n|*Contact Migration Tool*\n|One-time migration app database → Salesforce with upsert logic (match by email/phone/VCI)\n|Script/tool (.NET/Python/Node.js)\n\n|===\n\n==== Integration Architecture\n\n===== Integration Flows\n\n*Customer Feedback Submission (Async):*\n\n1. *Mobile App* → ProfileService: Authenticate user, get Salesforce Contact ID (JIT reconciliation)\n2. *Mobile App* → EngagementService: Submit feedback (POST /feedback with Contact ID, Category, Store Name, Time of Visit, Phone, Message)\n3. *EngagementService* → Mobile App: Immediate acknowledgment (\"Feedback submitted\")\n4. *EngagementService* → Event Bus: Publish work item for async Case creation\n5. *Background Worker* (EngagementService) → Salesforce: Create Case via REST API\n6. *Success*: EngagementService → Event Bus: Publish `SupportCaseCreated` event\n7. *EngagementService* → Braze: Trigger push notification campaign (\"Your feedback has been received, Case #12345\")\n8. *Failure*: Retry with exponential backoff → Dead Letter Queue → Ops team alert\n\n*Case Update Notification (Bidirectional):*\n\n1. *Support Agent* updates/resolves Case in Salesforce\n2. *Salesforce* → EngagementService: Webhook notification (Case updated)\n3. *EngagementService* → Event Bus: Publish `SupportCaseUpdated` or `SupportCaseResolved` event\n4. *EngagementService* → Braze: Trigger push notification campaign (\"Your case has been resolved\")\n\n*Contact Reconciliation (JIT):*\n\n1. *Mobile App user* authenticates\n2. *Mobile App* → ProfileService: GET /profile/contact-id\n3. *ProfileService* → Salesforce: Query Contact by email\n4. *Match found*: Return existing Salesforce Contact ID\n5. *No match*: Create new Contact in Salesforce, return new Contact ID\n6. *ProfileService* → Mobile App: Return Salesforce Contact ID (cached by Mobile App)\n\n===== System of Record Boundaries\n\n[width=\"100%\",cols=\"30%,35%,35%\",options=\"header\",]\n|===\n|Data Entity |System of Record |Rationale\n\n|*Contact*\n|Salesforce Service Cloud\n|Shared Viva Energy instance, unified customer profile across all channels (digital, wholesale, Shell Card, retail)\n\n|*Case*\n|Salesforce Service Cloud\n|Support agents manage Cases in Salesforce, digital channels submit via EngagementService ACL\n\n|*Feedback Submission (transient)*\n|None (no persistence)\n|EngagementService processes feedback and creates Case in Salesforce, no local storage\n\n|*Domain Events*\n|Event Bus (ephemeral)\n|Events published to Event Bus, consumed by subscribers, not persisted long-term (event sourcing not in scope)\n\n|===\n\n==== Data Architecture Principles\n\n===== Aggregate Persistence\n\n*ProfileService:*\n\n* **No local aggregate persistence** - ProfileService is stateless, queries Salesforce on-demand\n* Salesforce Contact is the aggregate root (owned by Salesforce)\n* ProfileService acts as facade/translator, not system of record\n\n*EngagementService:*\n\n* **No local aggregate persistence** - EngagementService is stateless, creates Cases in Salesforce via ACL\n* Salesforce Case is the aggregate root (owned by Salesforce)\n* EngagementService maintains no local Case state (Conformist pattern - trust Salesforce as source of truth)\n* Async processing state managed via Event Bus (work items in queue, not database)\n\n===== Event Store\n\n* **Event Bus** (SNS+SQS/EventBridge/Kinesis) handles domain event publishing\n* Events are **ephemeral** (consumed and discarded, not persisted for event sourcing)\n* No Event Store implementation in this architecture (future enhancement if needed)\n* Event schema versioning TBD in Solution Architecture\n\n\n=== Architecture Decisions\n\n==== ADR-CS-001: Consolidate onto Salesforce Service Cloud (not build custom solution)\n\n*Status*: Accepted\n\n*Context*:\n\n* D365 Customer Engagement not working well for digital customer support\n* Viva Energy already uses Salesforce Service Cloud for fuel wholesale, Shell Card, other retail channels\n* Post-merger opportunity to consolidate onto single platform\n* Alternative: Build custom support platform or use different SaaS\n\n*Decision*:\n\nConsolidate OTR digital customer support onto Salesforce Service Cloud (shared Viva Energy instance).\n\n*Rationale*:\n\n* **Unified customer view**: Support agents see all interactions across channels (digital, wholesale, Shell Card, retail)\n* **Platform consolidation**: Single support platform reduces operational overhead and costs\n* **Proven solution**: Salesforce Service Cloud is established, feature-rich, well-supported\n* **Post-merger alignment**: Strategic decision to standardize on Viva Energy platforms\n* **Avoid custom development**: Building custom support platform would be costly and high-risk\n\n*Consequences*:\n\n* Unified customer support across Viva Energy Group\n* Reduced operational complexity (single platform vs two)\n* Leverage Salesforce capabilities (case routing, knowledge base, AI, omnichannel)\n* ⚠️ Conformist pattern required (shared instance, conform to existing configuration)\n* ⚠️ Multi-tenant governance needed (data isolation, security, queues)\n* ❌ Less control over platform evolution (SaaS vendor, shared instance)\n\n==== ADR-CS-002: Implement ProfileService and EngagementService as first DDD bounded contexts\n\n*Status*: Accepted\n\n*Context*:\n\n* OTR target architecture uses Domain-Driven Design with bounded contexts\n* This migration is opportunity to establish first implementation\n* Alternative: Direct Mobile App → Salesforce integration (no bounded contexts)\n* Alternative: Single monolithic service for all customer-facing APIs\n\n*Decision*:\n\nImplement ProfileService and EngagementService as separate bounded contexts following DDD strategic patterns.\n\n*Rationale*:\n\n* **Foundation for target architecture**: First implementation of DDD pattern for future bounded contexts (Flybuys, LocationService, PaymentService)\n* **Separation of concerns**: ProfileService handles identity/Contact reconciliation, EngagementService handles support/feedback (different responsibilities, different change rates)\n* **Anti-Corruption Layer**: EngagementService protects digital channels from Salesforce API changes\n* **Reusability**: ProfileService Contact reconciliation reused for Flybuys integration\n* **Event-driven architecture**: Establishes pattern for loose coupling between bounded contexts\n\n*Consequences*:\n\n* Establishes DDD architecture foundation for OTR\n* Reusable ProfileService for Flybuys and future integrations\n* Digital channels protected from Salesforce API changes (ACL)\n* Clear bounded context boundaries and responsibilities\n* ⚠️ Increased initial complexity (two new microservices vs direct integration)\n* ⚠️ Requires Event Bus infrastructure implementation\n* ⚠️ Team must learn DDD patterns and bounded context design\n\n==== ADR-CS-003: Async Case creation via Event Bus (not synchronous)\n\n*Status*: Accepted\n\n*Context*:\n\n* Current D365 CE integration is synchronous (user waits for Case creation)\n* Alternative: Keep synchronous integration (Mobile App → EngagementService → Salesforce synchronously)\n* Salesforce API may experience downtime or latency\n\n*Decision*:\n\nImplement async Case creation via Event Bus with immediate user acknowledgment, retry logic, exponential backoff, and dead letter queue.\n\n*Rationale*:\n\n* **Non-blocking user experience**: User gets immediate \"Feedback submitted\" confirmation, not waiting for Salesforce API\n* **Resilience**: If Salesforce is down, feedback still accepted, Case created when Salesforce recovers\n* **Retry logic**: Automatic retry with exponential backoff handles transient failures\n* **Operational visibility**: Dead letter queue alerts ops team to persistent failures\n* **Scalability**: Queue buffering handles traffic spikes\n\n*Consequences*:\n\n* Better user experience (no waiting for Salesforce API)\n* Resilient to Salesforce downtime (queue buffers work)\n* Automatic retry reduces manual intervention\n* Queue depth monitoring provides operational visibility\n* ⚠️ Eventual consistency (user gets success notification after Case created, not immediately)\n* ⚠️ Increased complexity (Event Bus, background workers, retry logic, DLQ)\n* ⚠️ Requires monitoring and alerting for DLQ\n\n==== ADR-CS-004: ProfileService uses email as primary matching key (not VCI)\n\n*Status*: Accepted\n\n*Context*:\n\n* ProfileService needs to reconcile Mobile App users as Salesforce Contacts\n* Alternative matching keys: VCI (Viva Consumer ID), email, phone, Salesforce External ID\n* Email changes are rare but possible\n\n*Decision*:\n\nUse email address as primary matching key for Contact reconciliation (JIT upsert by email).\n\n*Rationale*:\n\n* **Availability**: Email always available for authenticated users\n* **Uniqueness**: Email is unique identifier in Salesforce and Mobile App\n* **Salesforce standard**: Salesforce Contact uses email as standard lookup field\n* **Simplicity**: Single matching key simplifies upsert logic\n* **Edge case acceptable**: Email changes are rare, manual cleanup acceptable\n\n*Consequences*:\n\n* Simple upsert logic (query by email, create if not found)\n* Leverages Salesforce standard email field\n* Email always available from authentication\n* ⚠️ Email changes create duplicate Contacts (rare edge case, manual cleanup)\n* ⚠️ Future enhancement: Add VCI as Salesforce External ID for stable matching\n\n==== ADR-CS-005: No Case migration from D365 CE (fresh start)\n\n*Status*: Accepted\n\n*Context*:\n\n* D365 CE contains historical customer support Cases\n* Alternative: Migrate historical Cases to Salesforce (preserve support history)\n* Alternative: Archive D365 CE Cases separately (read-only access)\n\n*Decision*:\n\nDo not migrate historical Cases from D365 CE to Salesforce. Start fresh in Salesforce.\n\n*Rationale*:\n\n* **Limited value**: Historical D365 CE Cases not critical for future support\n* **Data quality**: D365 CE Case data may be inconsistent or incomplete\n* **Complexity**: Case migration requires mapping D365 CE schema to Salesforce, data transformation, validation\n* **Cost-benefit**: Migration effort outweighs value of historical data\n* **Archive option**: D365 CE Cases can be archived separately if needed (read-only access for auditing)\n\n*Consequences*:\n\n* Simpler migration (Contacts only, no Case migration)\n* Faster time to value (no Case migration delay)\n* Clean start in Salesforce (no legacy data quality issues)\n* ⚠️ Historical Cases not visible in Salesforce (support agents can't see old Cases)\n* ⚠️ D365 CE must remain accessible temporarily for historical Case lookups (if needed)\n* ❌ Loss of historical Case insights (reporting, analytics on old Cases)\n\n==== ADR-CS-006: Big bang cutover (not phased rollout)\n\n*Status*: Accepted\n\n*Context*:\n\n* Alternative: Phased rollout with feature flags (pilot users first, gradual enablement)\n* Alternative: Parallel run (submit to both D365 CE and Salesforce temporarily)\n* Flybuys integration uses phased rollout (AS-1, AS-2, AS-3 architecture states)\n\n*Decision*:\n\nBig bang cutover - migrate Contacts, deploy ProfileService and EngagementService, switch Mobile App, retire D365 CE.\n\n*Rationale*:\n\n* **Simplicity**: No parallel run complexity, no feature flag management\n* **Faster D365 CE retirement**: No extended transition period maintaining two systems\n* **Limited risk**: Customer support not mission-critical (not payment processing), rollback possible\n* **User base manageable**: OTR digital customers smaller than Flybuys integration scope\n* **Different use case**: Flybuys phased rollout manages points accrual complexity, support feedback is simpler\n\n*Consequences*:\n\n* Simpler deployment (single cutover, no AS-1/AS-2/AS-3 states)\n* Faster D365 CE retirement (no extended parallel run)\n* No feature flag complexity or pilot user management\n* ⚠️ Higher cutover risk (all users switch at once)\n* ⚠️ Requires comprehensive testing before cutover\n* ⚠️ Rollback plan required (revert to D365 CE if critical issues)\n\n==== ADR-CS-007: EngagementService receives Salesforce webhooks for Case updates\n\n*Status*: Accepted\n\n*Context*:\n\n* Support agents update/resolve Cases in Salesforce\n* Need to notify customers of Case status changes via push notifications\n* Alternative: Poll Salesforce API for Case updates (inefficient)\n* Alternative: No customer notifications (agents contact customers directly)\n\n*Decision*:\n\nSalesforce sends webhook notifications to EngagementService when Cases are updated/resolved. EngagementService triggers Braze push notifications.\n\n*Rationale*:\n\n* **Real-time notifications**: Customer notified immediately when agent resolves Case\n* **Efficient**: Webhook push model (not polling)\n* **Event-driven**: Aligns with event-driven architecture pattern\n* **Better customer experience**: Proactive notification vs waiting for agent contact\n\n*Consequences*:\n\n* Real-time customer notifications for Case updates\n* Efficient push model (no polling overhead)\n* Bidirectional integration (Mobile App → Salesforce → Mobile App)\n* ⚠️ Salesforce webhook mechanism TBD (Outbound Messages vs Platform Events vs Process Builder)\n* ⚠️ Webhook authentication and security required\n* ⚠️ EngagementService must handle webhook retries and failures\n\n<<<\n== Interface Specifications\n\nThis section provides references to the complete API specifications and event catalogue for ProfileService and EngagementService.\n\n=== REST API Specifications\n\nComplete OpenAPI 3.0 specifications are maintained in the `specifications/rest/` directory:\n\n==== ProfileService API v1\n\n*Specification*: link:../../specifications/rest/profile-service-v1.yaml[profile-service-v1.yaml]\n\n*Base URL*: `https://api.otr.com.au/profile/v1`\n\n*Authentication*: Bearer token (Microsoft Entra External ID JWT)\n\n*Key Endpoints*:\n\n* `GET /contact-id` - Retrieve or create Salesforce Contact ID for authenticated user (Just-In-Time reconciliation)\n** Used by Mobile App before submitting feedback to EngagementService\n** Upserts Salesforce Contact record using email as external key\n** Returns 18-character Salesforce Contact ID with caching (15-minute TTL)\n** Performance SLA: p95 < 300ms (uncached), p95 < 50ms (cached)\n\n==== EngagementService API v1\n\n*Specification*: link:../../specifications/rest/engagement-service-v1.yaml[engagement-service-v1.yaml]\n\n*Base URL*: `https://api.otr.com.au/engagement/v1`\n\n*Authentication*: Bearer token (Microsoft Entra External ID JWT)\n\n*Key Endpoints*:\n\n* `POST /feedback` - Submit customer feedback for async Case creation in Salesforce\n** Accepts contactId, category, storeName, timeOfVisit, contactPhoneNumber, message\n** Returns 202 Accepted immediately (async Case creation in background)\n** Publishes `CustomerFeedbackSubmitted` event for analytics\n** Creates Salesforce Case via Anti-Corruption Layer with retry logic\n** Performance SLA: p95 < 200ms (feedback accepted, not Case creation)\n\n=== Domain Events (AsyncAPI)\n\nComplete CloudEvents 1.0 JSON Schema specifications are maintained in the `specifications/events/` directory:\n\n*Specification*: link:../../specifications/events/engagement-events.json[engagement-events.json]\n\n==== Event Catalogue\n\n[width=\"100%\",cols=\"30%,20%,50%\",options=\"header\",]\n|===\n|Event Type |Publisher |Consumers\n\n|`CustomerFeedbackSubmitted`\n|EngagementService\n|Future bounded contexts, analytics, sentiment analysis\n\n|`SupportCaseCreated`\n|EngagementService\n|Future bounded contexts, analytics\n\n|`SupportCaseUpdated`\n|EngagementService (via Salesforce webhook)\n|Future bounded contexts, analytics\n\n|`SupportCaseResolved`\n|EngagementService (via Salesforce webhook)\n|Future bounded contexts, analytics\n\n|===\n\n==== Event Delivery Guarantees\n\n* **At-least-once delivery**: Events may be delivered multiple times, consumers must handle idempotency\n* **Ordering**: FIFO queues guarantee ordering for events with same `contactId`\n* **Retention**: 4 days (96 hours) in Event Bus\n* **Dead Letter Queue**: Failed events after 5 retries moved to DLQ for manual intervention\n* **Format**: CloudEvents 1.0 specification with JSON payload\n\n=== API Versioning Policy\n\n==== Version Numbering\n\n* **Format**: `/v{major}` in URL path (e.g., `/profile/v1`, `/engagement/v1`)\n* **Semantic Versioning**: Major version incremented for breaking changes only\n* **Backwards Compatibility**: Minor changes (new optional fields, new endpoints) don't require version bump\n\n==== When to Version\n\n*Breaking changes requiring new major version*:\n\n- Removing or renaming fields in request/response\n- Changing field data types (e.g., string → number)\n- Changing authentication mechanism\n- Removing endpoints\n\n*Non-breaking changes not requiring version bump*:\n\n- Adding new optional fields to request/response\n- Adding new endpoints\n- Expanding enum values (e.g., adding new feedback category)\n- Improving error messages\n\n==== Parallel Version Support\n\n* Support N and N-1 versions concurrently for 6 months\n* Deprecation notice: 3 months before sunsetting old version\n* Mobile App must upgrade to new version within deprecation window\n\n<<<\n== Work Packages\n\nThis section consolidates gaps and activities into implementable work packages aligned with TOGAF Phase E requirements.\n\n=== Work Package Overview\n\n[width=\"100%\",cols=\"15%,35%,25%,25%\",options=\"header\",]\n|===\n|Work Package ID |Name |Transition State |Key Deliverables\n\n|WP-CS-001\n|ProfileService Development\n|TS-1 (Build & Test)\n|ProfileService microservice, Salesforce Contact integration, REST API\n\n|WP-CS-002\n|EngagementService Development\n|TS-1 (Build & Test)\n|EngagementService microservice, Anti-Corruption Layer, Braze integration\n\n|WP-CS-003\n|Event Bus Infrastructure\n|TS-1 (Build & Test)\n|Event Bus configuration, CloudEvents schemas, monitoring\n\n|WP-CS-004\n|Contact Migration Tooling\n|TS-1 (Build & Test)\n|Migration tool, validation scripts, reconciliation reporting\n\n|WP-CS-005\n|Mobile App Integration\n|TS-1 (Build & Test)\n|Mobile App API integration, feedback form enhancements, testing\n\n|WP-CS-006\n|Integration Testing\n|TS-1 (Build & Test)\n|Test environments, integration test suites, UAT execution\n\n|WP-CS-007\n|Salesforce Configuration\n|TS-1 (Build & Test)\n|Salesforce field mapping, data isolation, webhook configuration\n\n|WP-CS-008\n|Contact Data Migration\n|TS-2 (Contact Migration)\n|Contact migration execution, validation, reconciliation\n\n|WP-CS-009\n|Production Deployment\n|TS-3 (Cutover)\n|Production deployment, smoke testing, go-live execution\n\n|WP-CS-010\n|Post-Cutover Support\n|TS-4 (Target State)\n|Monitoring, issue resolution, D365 CE retirement\n\n|===\n\n[[wp-cs-001]]\n=== WP-CS-001: ProfileService Development\n\n==== Description\n\nBuild ProfileService bounded context microservice implementing Just-In-Time Contact reconciliation with Salesforce Service Cloud.\n\n==== Deliverables\n\n* ProfileService microservice application\n** REST API implementation (OpenAPI 3.0 specification)\n** `GET /contact-id` endpoint (Salesforce Contact reconciliation)\n** Authentication/authorization with Microsoft Entra External ID\n** Caching layer (15-minute TTL for Contact IDs)\n* Salesforce integration\n** Salesforce REST API client\n** Contact upsert by email (external key matching)\n** Error handling and retry logic\n* Unit tests (>80% code coverage)\n* Integration tests with Salesforce sandbox\n* API documentation\n* Deployment configuration (IaC - Infrastructure as Code)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* Salesforce sandbox environment provisioned\n* Microsoft Entra External ID OAuth configuration\n* Development environment setup (AWS dev account, CI/CD pipeline)\n\n*Dependent Work Packages*:\n\n* None (can start immediately after prerequisites met)\n\n==== Skills Required\n\n* Backend development (.NET Core or Node.js)\n* REST API design and implementation\n* Salesforce REST API integration\n* OAuth 2.0 / JWT authentication\n* Caching strategies (Redis/ElastiCache)\n* Unit/integration testing frameworks\n* Infrastructure as Code (Terraform/CloudFormation)\n\n==== Acceptance Criteria\n\n* All API endpoints return correct HTTP status codes per OpenAPI specification\n* Contact ID retrieval achieves p95 < 300ms (uncached), p95 < 50ms (cached)\n* Salesforce Contact upsert succeeds with 100% accuracy in sandbox testing\n* Unit test coverage > 80%\n* Integration tests pass in sandbox environment\n* API documentation generated from OpenAPI specification\n\n[[wp-cs-002]]\n=== WP-CS-002: EngagementService Development\n\n==== Description\n\nBuild EngagementService bounded context microservice implementing customer feedback submission, Anti-Corruption Layer for Salesforce Case creation, Braze integration, and webhook receiver for Case updates.\n\n==== Deliverables\n\n* EngagementService microservice application\n** REST API implementation (OpenAPI 3.0 specification)\n** `POST /feedback` endpoint (async feedback submission)\n** Authentication/authorization with Microsoft Entra External ID\n** Webhook receiver endpoint for Salesforce Case updates\n* Anti-Corruption Layer (ACL)\n** OTR domain model to Salesforce API translation\n** Category enum mapping (App/Service/Order/Rewards → Salesforce Case fields)\n** Salesforce REST API client for Case creation\n* Async processing infrastructure\n** Event Bus publisher integration\n** Background worker for Case creation\n** Retry logic with exponential backoff (5 attempts)\n** Dead Letter Queue integration\n* Braze integration\n** Braze campaign trigger API client\n** Push notification orchestration for Case updates\n* Domain event publishing\n** `CustomerFeedbackSubmitted` event publisher\n** `SupportCaseCreated` event publisher\n** `SupportCaseUpdated` event translator (Salesforce webhook → domain event)\n** `SupportCaseResolved` event translator (Salesforce webhook → domain event)\n* Unit tests (>80% code coverage)\n* Integration tests (EngagementService ↔ Salesforce, EngagementService ↔ Braze)\n* API documentation\n* Deployment configuration (IaC)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-003 (Event Bus Infrastructure) completed\n* Salesforce sandbox environment provisioned\n* Braze API credentials and campaign templates configured\n* Microsoft Entra External ID OAuth configuration\n\n*Dependent Work Packages*:\n\n* WP-CS-003 must be completed first (Event Bus required for async processing)\n* WP-CS-007 (Salesforce Configuration) must be in progress (field mapping needed)\n\n==== Skills Required\n\n* Backend development (.NET Core or Node.js)\n* REST API design and implementation\n* Salesforce REST API integration\n* Event-driven architecture patterns\n* Async/background processing (queues, workers)\n* Braze API integration\n* Webhook design and security\n* OAuth 2.0 / JWT authentication\n* Domain-Driven Design (DDD) - Anti-Corruption Layer pattern\n* Unit/integration testing frameworks\n* Infrastructure as Code (Terraform/CloudFormation)\n\n==== Acceptance Criteria\n\n* Feedback submission endpoint returns 202 Accepted within p95 < 200ms\n* Async Case creation succeeds with >99.5% success rate (including retries)\n* Anti-Corruption Layer correctly maps all feedback categories to Salesforce Case fields\n* Webhook receiver processes Salesforce Case updates and publishes domain events\n* Braze push notifications sent successfully for Case updates\n* Failed Case creation moves to Dead Letter Queue after 5 retry attempts\n* Unit test coverage > 80%\n* Integration tests pass with Salesforce sandbox and Braze staging environment\n\n[[wp-cs-003]]\n=== WP-CS-003: Event Bus Infrastructure\n\n==== Description\n\nImplement Event Bus infrastructure for domain event publishing using existing AWS infrastructure (SNS+SQS, EventBridge, or Kinesis).\n\n==== Deliverables\n\n* Event Bus infrastructure configuration\n** Topic/stream provisioning (technology choice: SNS+SQS / EventBridge / Kinesis)\n** FIFO queue configuration (ordering by `contactId`)\n** Dead Letter Queue (DLQ) setup\n** Retention policy (4 days / 96 hours)\n** Access control policies (IAM roles, permissions)\n* CloudEvents 1.0 schema definitions\n** JSON Schema specifications for all domain events\n** Schema validation configuration\n** Schema registry (if using EventBridge/Kinesis)\n* Monitoring and alerting\n** CloudWatch dashboards for queue metrics\n** Alarms for DLQ depth, queue age, processing failures\n** Event Bus throughput monitoring\n* Documentation\n** Event Bus architecture diagram\n** Event publishing guidelines\n** Consumer integration guide\n* Infrastructure as Code (IaC)\n** Terraform/CloudFormation templates for all infrastructure\n\n==== Dependencies\n\n*Prerequisites*:\n\n* AWS account access (existing infrastructure)\n* Technology selection decision (SNS+SQS vs EventBridge vs Kinesis)\n* CloudEvents 1.0 schema design approval\n\n*Dependent Work Packages*:\n\n* None (foundational infrastructure, can start early)\n\n==== Skills Required\n\n* AWS messaging services (SNS, SQS, EventBridge, Kinesis)\n* Event-driven architecture patterns\n* CloudEvents specification\n* JSON Schema design\n* Infrastructure as Code (Terraform/CloudFormation)\n* AWS IAM security configuration\n* CloudWatch monitoring and alerting\n\n==== Acceptance Criteria\n\n* Event Bus infrastructure provisioned in all environments (dev, staging, production)\n* FIFO ordering validated for events with same `contactId`\n* Dead Letter Queue triggers alarms when messages arrive\n* Event retention policy enforced (4 days)\n* CloudEvents 1.0 schema validation enabled\n* Monitoring dashboards operational\n* Infrastructure fully codified (IaC)\n\n[[wp-cs-004]]\n=== WP-CS-004: Contact Migration Tooling\n\n==== Description\n\nDevelop Contact migration tool for one-time migration from app-specific database to Salesforce Service Cloud with upsert logic and validation.\n\n==== Deliverables\n\n* Contact migration tool\n** Extract Contacts from app-specific database\n** Transform to Salesforce Contact API format\n** Upsert to Salesforce using email as external key\n** Fallback matching by phone number or Viva Consumer ID\n** Batch processing with rate limiting (respect Salesforce API limits)\n** Idempotent operation (can be re-run safely)\n* Validation scripts\n** Pre-migration validation (data quality checks)\n** Post-migration validation (100% Contact reconciliation)\n** Email/phone/VCI matching accuracy report\n* Reconciliation reporting\n** Contacts created vs updated statistics\n** Failed upserts with error details\n** Matching accuracy metrics\n* Rollback capability\n** Export snapshot of Salesforce Contacts before migration\n** Rollback procedure documentation\n* Documentation\n** Migration tool user guide\n** Troubleshooting guide\n** Runbook for migration execution\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-001 (ProfileService Development) completed (reuses Salesforce integration code)\n* Salesforce sandbox environment for migration testing\n* App-specific database access (read-only sufficient)\n* Salesforce production access granted\n\n*Dependent Work Packages*:\n\n* WP-CS-001 provides Salesforce Contact upsert logic to reuse\n\n==== Skills Required\n\n* Database development (SQL, data extraction)\n* Salesforce REST API integration\n* Batch processing and ETL patterns\n* Data validation and reconciliation\n* Error handling and logging\n* Scripting (Python, PowerShell, or similar)\n\n==== Acceptance Criteria\n\n* Migration tool successfully migrates 100% of Contacts in sandbox with zero data loss\n* Email/phone/VCI matching accuracy > 95% in sandbox testing\n* Failed upserts captured with actionable error messages\n* Reconciliation report matches actual Salesforce Contact counts\n* Migration tool execution time acceptable for production (freezes app database for minimum time)\n* Rollback procedure validated in sandbox\n* Documentation complete and approved\n\n[[wp-cs-005]]\n=== WP-CS-005: Mobile App Integration\n\n==== Description\n\nUpdate Mobile App to integrate with ProfileService and EngagementService APIs, replacing D365 CE integration.\n\n==== Deliverables\n\n* Feedback form UI enhancements\n** Add Category dropdown (App, Service, Order, Rewards, Refund, Delete Account)\n** Add Store Name field (optional)\n** Add Time of Visit field (optional, datetime picker)\n** Add Contact Phone Number field (optional, E.164 validation)\n** Update Message field (1-2000 character limit with counter)\n* API integration (Kotlin Multiplatform shared code)\n** ProfileService client (`GET /contact-id`)\n** EngagementService client (`POST /feedback`)\n** JWT token management (Microsoft Entra External ID)\n** Error handling (network failures, API errors, validation errors)\n** Retry logic for transient failures\n* Platform-specific UI (SwiftUI for iOS, Jetpack Compose for Android)\n** Feedback form screens\n** Success/error confirmation screens\n** Loading states and progress indicators\n* Feature flag integration\n** `enable_salesforce_feedback_submission` flag\n** Fallback to D365 CE if flag disabled (during rollout)\n* Unit tests for shared business logic\n* UI tests for platform-specific screens\n* API integration tests (mocked APIs)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-001 (ProfileService Development) completed and deployed to dev/staging\n* WP-CS-002 (EngagementService Development) completed and deployed to dev/staging\n* ProfileService and EngagementService OpenAPI specifications finalized\n* Feature flag service configured\n\n*Dependent Work Packages*:\n\n* Must complete after WP-CS-001 and WP-CS-002 (requires API endpoints available for integration testing)\n\n==== Skills Required\n\n* Kotlin Multiplatform development\n* SwiftUI (iOS native UI)\n* Jetpack Compose (Android native UI)\n* REST API client development\n* OAuth 2.0 / JWT authentication\n* Form validation and UX design\n* Unit testing (Kotlin, Swift)\n* UI testing frameworks (XCTest, Espresso)\n\n==== Acceptance Criteria\n\n* Feedback form UI matches UX design specifications\n* All form fields validate correctly (client-side validation)\n* API integration successfully calls ProfileService and EngagementService in dev/staging\n* Error handling provides user-friendly error messages\n* Feature flag correctly toggles between Salesforce and D365 CE integration\n* Unit test coverage > 80% for shared business logic\n* UI tests pass for all feedback form workflows (happy path, error states)\n* App builds and deploys successfully to TestFlight (iOS) and Google Play Internal Testing (Android)\n\n=== WP-CS-006: Integration Testing\n\n==== Description\n\nExecute comprehensive integration testing across all system components in non-production environments.\n\n==== Deliverables\n\n* Test environment setup\n** Salesforce sandbox configured with test data\n** ProfileService deployed to staging\n** EngagementService deployed to staging\n** Event Bus staging infrastructure\n** Braze staging environment configured\n** Mobile App TestFlight/Internal Testing builds\n* Integration test suites\n** ProfileService ↔ Salesforce (Contact upsert scenarios)\n** EngagementService ↔ Salesforce (Case creation scenarios)\n** EngagementService ↔ Braze (push notification scenarios)\n** Mobile App ↔ ProfileService ↔ EngagementService (end-to-end workflows)\n** Event Bus publishing and consumption\n** Webhook receiver (Salesforce → EngagementService)\n* Test scenarios\n** Happy path: Successful feedback submission and Case creation\n** Error scenarios: Salesforce API failures, Braze API failures, network timeouts\n** Retry scenarios: Async Case creation retries, DLQ validation\n** Performance testing: p95 latency validation for ProfileService and EngagementService\n** Load testing: Simulate 3x-10x expected volume\n* UAT execution\n** Business stakeholder UAT sessions\n** UAT test cases covering all feedback categories\n** UAT sign-off documentation\n* Test results documentation\n** Test execution reports\n** Defect tracking and resolution\n** Performance test results\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-001 (ProfileService Development) completed\n* WP-CS-002 (EngagementService Development) completed\n* WP-CS-003 (Event Bus Infrastructure) completed\n* WP-CS-005 (Mobile App Integration) completed\n* WP-CS-007 (Salesforce Configuration) sandbox configuration completed\n\n*Dependent Work Packages*:\n\n* Must complete after WP-CS-001, WP-CS-002, WP-CS-003, WP-CS-005 (requires all components available)\n\n==== Skills Required\n\n* Integration testing strategy and execution\n* Test automation frameworks (Postman, Newman, Selenium)\n* Performance testing tools (JMeter, k6, Gatling)\n* Salesforce sandbox administration\n* Test data management\n* Defect tracking and triage\n* UAT facilitation\n\n==== Acceptance Criteria\n\n* All integration test scenarios pass (happy path, error scenarios, retry scenarios)\n* Performance SLAs validated (ProfileService p95 < 300ms, EngagementService p95 < 200ms)\n* Load testing confirms system handles 3x expected volume without degradation\n* UAT sign-off obtained from business stakeholders\n* Zero critical defects (P1/P2) open before moving to Contact Migration\n* Test results documented and approved\n\n=== WP-CS-007: Salesforce Configuration\n\n==== Description\n\nConfigure Salesforce Service Cloud for OTR digital customer support integration, including field mapping, data isolation, and webhook setup.\n\n==== Deliverables\n\n* Salesforce Contact configuration\n** Custom fields for OTR-specific data (if needed)\n** Email as external key configuration\n** Record Type for OTR digital customers (data isolation)\n** Validation rules\n* Salesforce Case configuration\n** Custom fields for feedback categories (App, Service, Order, Rewards, Refund, Delete Account)\n** Case Type and Reason picklist mapping\n** Queue assignment rules (OTR digital support queue)\n** Case escalation rules\n** Case routing rules\n* Salesforce webhook configuration\n** Platform Events / Outbound Messages for Case updates\n** Webhook authentication (API key, JWT, or OAuth)\n** Case status change triggers (New → In Progress, Resolved, Closed)\n** Webhook payload format (JSON)\n* Data isolation strategy\n** Record Types for OTR vs other Viva Energy business units\n** Queues for OTR-specific Cases\n** Reporting and dashboards scoped to OTR data\n* Salesforce API access\n** Connected App configuration\n** OAuth 2.0 JWT bearer flow setup\n** API user credentials\n** API rate limit monitoring\n* Documentation\n** Salesforce field mapping specification\n** Webhook configuration guide\n** Data isolation architecture diagram\n** API authentication setup guide\n\n==== Dependencies\n\n*Prerequisites*:\n\n* Viva Energy Salesforce admin team engagement\n* Salesforce governance approval (multi-tenant environment)\n* Technical decision on webhook mechanism (Platform Events vs Outbound Messages)\n* Technical decision on authentication method (OAuth 2.0 JWT bearer flow recommended)\n\n*Dependent Work Packages*:\n\n* None (can start in parallel with development work packages)\n* Required for WP-CS-002 (EngagementService needs field mapping)\n* Required for WP-CS-006 (Integration Testing needs sandbox configuration)\n\n==== Skills Required\n\n* Salesforce administration\n* Salesforce configuration (Record Types, Queues, Validation Rules)\n* Salesforce API integration (REST API, Platform Events, Outbound Messages)\n* Salesforce security and authentication (OAuth, Connected Apps)\n* Multi-tenant data isolation patterns\n\n==== Acceptance Criteria\n\n* Salesforce sandbox configured with all custom fields, Record Types, Queues\n* Field mapping documented and approved by OTR business stakeholders\n* Webhook configuration tested and delivering Case update notifications\n* Data isolation validated (OTR data separate from other Viva Energy business units)\n* API authentication working for ProfileService and EngagementService\n* Salesforce API rate limits monitored and acceptable for expected volume\n* Configuration replicated to Salesforce production environment\n\n=== WP-CS-008: Contact Data Migration\n\n==== Description\n\nExecute one-time Contact migration from app-specific database to Salesforce Service Cloud production.\n\n==== Deliverables\n\n* Pre-migration activities\n** Final validation of migration tool in sandbox\n** Communication plan (notify users of maintenance window if needed)\n** Freeze app-specific database Contact updates\n** Backup app-specific database\n** Export snapshot of Salesforce Contacts (rollback preparation)\n* Migration execution\n** Execute migration tool against Salesforce production\n** Monitor migration progress\n** Handle failed upserts (manual intervention if needed)\n* Post-migration validation\n** 100% Contact reconciliation (app database vs Salesforce)\n** Email/phone/VCI matching accuracy report\n** Reconciliation report (Contacts created vs updated)\n** Data integrity checks (no duplicate Contacts, no missing Contacts)\n* ProfileService smoke testing\n** Verify Contact ID retrieval works in production\n** Test cache behavior\n** Validate Salesforce Contact upserts from ProfileService\n* Migration report\n** Total Contacts migrated\n** Contacts created vs updated\n** Failed upserts (if any) with resolution\n** Matching accuracy metrics\n** Migration execution time\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-004 (Contact Migration Tooling) completed\n* WP-CS-001 (ProfileService Development) deployed to production (not yet integrated with Mobile App)\n* WP-CS-007 (Salesforce Configuration) production configuration completed\n* Salesforce production access granted\n* Migration approved by business stakeholders\n\n*Dependent Work Packages*:\n\n* Must complete after WP-CS-001, WP-CS-004, WP-CS-007\n* Must complete before WP-CS-009 (Production Deployment)\n\n==== Skills Required\n\n* Data migration execution\n* Salesforce administration\n* Database operations\n* Data validation and reconciliation\n* Incident management (if issues arise)\n\n==== Acceptance Criteria\n\n* 100% of Contacts migrated with zero data loss\n* Email/phone/VCI matching accuracy > 95%\n* ProfileService smoke tests pass in production\n* Reconciliation report approved by business stakeholders\n* App-specific database Contact updates frozen (read-only mode)\n* Rollback procedure ready (but not executed if migration successful)\n\n=== WP-CS-009: Production Deployment\n\n==== Description\n\nDeploy all solution components to production and execute cutover from D365 CE to Salesforce Service Cloud.\n\n==== Deliverables\n\n* Production deployment\n** EngagementService deployed to production\n** Event Bus production infrastructure validated\n** Salesforce webhook configured in production\n** Mobile App released to production (App Store, Google Play)\n* Go-live activities\n** Smoke testing (end-to-end feedback submission)\n** Feature flag enabled: `enable_salesforce_feedback_submission = ON`\n** D365 CE integration disabled in Mobile App\n** Monitor Event Bus queue depth, DLQ, Salesforce API rate limits\n** Monitor Mobile App feedback submission success rate\n* Go/No-Go decision\n** Validate success criteria before final cutover\n** Business stakeholder approval\n** Technical validation (smoke tests pass, monitoring healthy)\n* Cutover communication\n** Notify support agents of new Salesforce integration\n** Provide training materials for support agents\n** Customer communication (if visible change)\n* Rollback plan\n** Documented rollback procedure\n** Feature flag can disable Salesforce integration and re-enable D365 CE\n** Rollback decision criteria (P1/P2 incidents, feedback submission success rate < 99%)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-001 (ProfileService Development) completed\n* WP-CS-002 (EngagementService Development) completed\n* WP-CS-003 (Event Bus Infrastructure) completed\n* WP-CS-005 (Mobile App Integration) completed\n* WP-CS-006 (Integration Testing) completed with UAT sign-off\n* WP-CS-007 (Salesforce Configuration) production configuration completed\n* WP-CS-008 (Contact Data Migration) completed successfully\n* Mobile App release approval (App Store, Google Play)\n\n*Dependent Work Packages*:\n\n* Must complete after all prior work packages (final cutover)\n\n==== Skills Required\n\n* Production deployment and release management\n* Incident management and troubleshooting\n* Monitoring and observability\n* Change management and communication\n* Rollback execution (if needed)\n\n==== Acceptance Criteria\n\n* Mobile App feedback submission success rate > 99.5%\n* End-to-end flow validated (Mobile App → ProfileService → EngagementService → Salesforce Case created)\n* Braze push notifications delivered successfully\n* Event Bus queue depth normal, DLQ empty\n* No critical incidents (P1/P2) in first 24 hours\n* D365 CE integration disabled\n* Support agents successfully using Salesforce for OTR digital customer Cases\n\n=== WP-CS-010: Post-Cutover Support\n\n==== Description\n\nMonitor production stability, resolve issues, validate success criteria, and execute D365 CE retirement.\n\n==== Deliverables\n\n* Monitoring and support\n** 24/7 on-call support for first week post-cutover\n** Daily monitoring reports (feedback submission success rate, Case creation success rate)\n** Incident response and resolution\n** Performance tuning (if needed)\n* Success criteria validation\n** Validate feedback submission success rate > 99.5%\n** Monitor customer satisfaction score (target: +15% improvement within 6 months)\n** Monitor average case resolution time (target: -20% improvement within 6 months)\n** Support agent feedback survey\n* D365 CE retirement\n** D365 CE set to read-only mode (historical Case lookups only)\n** Archive D365 CE data for compliance/auditing\n** Decommission D365 CE infrastructure (after 90-day stabilization period)\n** Remove D365 CE integration code from Mobile App\n* Documentation updates\n** Production runbook\n** Troubleshooting guide (based on incidents resolved)\n** Operational procedures for support team\n** Lessons learned document\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-009 (Production Deployment) completed\n* Cutover successful with no critical incidents\n\n*Dependent Work Packages*:\n\n* Final work package in sequence\n\n==== Skills Required\n\n* Production support and incident management\n* Performance monitoring and tuning\n* Data archival and compliance\n* Infrastructure decommissioning\n* Documentation\n\n==== Acceptance Criteria\n\n* Zero critical incidents (P1/P2) in first 30 days post-cutover\n* Feedback submission success rate sustained > 99.5%\n* Customer satisfaction improvement validated (baseline established, ongoing measurement)\n* Support agents reporting positive experience with Salesforce unified view\n* D365 CE successfully decommissioned\n* All production documentation complete and approved\n* Lessons learned document published\n\n=== Work Package Sequencing\n\n==== Parallel Track 1: Infrastructure & Configuration\n\nCan start immediately and run in parallel:\n\n* WP-CS-003 (Event Bus Infrastructure)\n* WP-CS-007 (Salesforce Configuration)\n\n==== Parallel Track 2: Development\n\nCan start after Track 1 infrastructure decisions made:\n\n* WP-CS-001 (ProfileService Development) - Independent\n* WP-CS-002 (EngagementService Development) - Requires WP-CS-003 completed\n* WP-CS-004 (Contact Migration Tooling) - Requires WP-CS-001 completed (reuses code)\n\n==== Sequential Track 3: Integration & Testing\n\nMust complete after development:\n\n* WP-CS-005 (Mobile App Integration) - Requires WP-CS-001, WP-CS-002\n* WP-CS-006 (Integration Testing) - Requires WP-CS-001, WP-CS-002, WP-CS-003, WP-CS-005, WP-CS-007\n\n==== Sequential Track 4: Migration & Cutover\n\nMust complete sequentially:\n\n* WP-CS-008 (Contact Data Migration) - Requires WP-CS-001, WP-CS-004, WP-CS-006 UAT sign-off\n* WP-CS-009 (Production Deployment) - Requires all prior work packages completed\n* WP-CS-010 (Post-Cutover Support) - Requires WP-CS-009\n\n==== Critical Path\n\nThe critical path for this project is:\n\n. WP-CS-003 (Event Bus Infrastructure)\n. WP-CS-002 (EngagementService Development) - blocks on WP-CS-003\n. WP-CS-005 (Mobile App Integration) - blocks on WP-CS-001, WP-CS-002\n. WP-CS-006 (Integration Testing) - blocks on WP-CS-001 through WP-CS-005, WP-CS-007\n. WP-CS-008 (Contact Data Migration) - blocks on WP-CS-006 UAT sign-off\n. WP-CS-009 (Production Deployment) - blocks on WP-CS-008\n. WP-CS-010 (Post-Cutover Support) - final deliverable\n\nAny delays in critical path work packages will delay the overall cutover date.\n\n<<<\n== Transition Architecture\n\nThis section defines the evolution from baseline (D365 CE) to target state (Salesforce Service Cloud + ProfileService + EngagementService).\n\n=== Transition Approach\n\n*Big Bang Cutover*: Per ADR-CS-006, this transition uses a single cutover approach rather than phased rollout. All users switch from D365 CE to Salesforce simultaneously after Contact migration completion.\n\n=== Transition States\n\n==== TS-0: Baseline State (Current)\n\n===== Characteristics\n\n* D365 Customer Engagement handles all digital customer feedback\n* App-specific database stores customer Contact data\n* No ProfileService or EngagementService\n* No event-driven architecture\n* Synchronous feedback submission\n\n===== Components Active\n\n- D365 Customer Engagement\n- App-specific customer database\n- Mobile App (current version with D365 CE integration)\n\n==== TS-1: Build & Test\n\n===== Activities\n\n* Build ProfileService microservice (JIT Contact reconciliation API)\n* Build EngagementService microservice (feedback submission API, ACL for Salesforce Case creation, Braze integration, webhook receiver)\n* Implement Event Bus infrastructure (SNS+SQS/EventBridge/Kinesis)\n* Develop Contact migration tool (app database → Salesforce upsert by email/phone/VCI)\n* Update Mobile App API integration (ProfileService + EngagementService endpoints - feedback form UI already complete)\n* Integration testing (ProfileService ↔ Salesforce, EngagementService ↔ Salesforce, EngagementService ↔ Braze)\n* UAT with test Salesforce sandbox environment\n\n===== Components Active\n\n- D365 Customer Engagement (still active, unchanged)\n- App-specific customer database (still active)\n- ProfileService (non-production, testing only)\n- EngagementService (non-production, testing only)\n- Event Bus (non-production)\n- Salesforce Sandbox (testing)\n\n===== Exit Criteria\n\n- All integration tests pass\n- UAT sign-off from business stakeholders\n- Contact migration tool validated in sandbox\n- Mobile App updates tested with non-production APIs\n\n==== TS-2: Contact Migration\n\n===== Activities\n* Execute Contact migration (app database → Salesforce production)\n* Validation: 100% data integrity check (email/phone/VCI matching)\n* Reconciliation report: New Contacts created vs existing Contacts updated\n* Freeze app database Contact updates during migration window\n* ProfileService smoke testing (verify Contact lookups work in Salesforce production)\n\n===== Components Active\n- D365 Customer Engagement (still active, users unaffected)\n- Salesforce Production (Contacts migrated, no Cases yet)\n- ProfileService (production deployed, not integrated with Mobile App yet)\n- App-specific customer database (frozen, read-only)\n\n===== Exit Criteria\n- 100% of Contacts migrated with zero data loss\n- Email/phone/VCI matching accuracy > 95%\n- ProfileService smoke tests pass (JIT lookups return correct Contact IDs)\n- Reconciliation report approved\n\n==== TS-3: Cutover (Go-Live)\n\n===== Go-Live Activities\n\n* Deploy EngagementService to production\n* Deploy Mobile App updates (ProfileService + EngagementService API integration)\n* Configure Salesforce webhook (Case update notifications → EngagementService)\n* Smoke testing: End-to-end feedback submission (Mobile App → EngagementService → Salesforce → Braze notification)\n* Monitor Event Bus queue depth, dead letter queue, Salesforce API rate limits\n* **Go/No-Go decision**: Validate success criteria before final cutover\n* Enable feature flag: `enable_salesforce_feedback_submission = ON`\n* Disable D365 CE integration in Mobile App\n\n===== Components Active\n\n- ProfileService (production, integrated with Mobile App)\n- EngagementService (production, integrated with Mobile App)\n- Event Bus (production, processing async Case creation)\n- Salesforce Production (receiving Cases from digital customers)\n- Braze (sending push notifications)\n- Mobile App (new version with Salesforce integration)\n- D365 Customer Engagement (disabled, read-only for historical lookups)\n\n===== Exit Criteria\n\n- Mobile App feedback submission success rate > 99.5%\n- End-to-end flow validated (Mobile App → Salesforce Case created)\n- Braze push notifications delivered successfully\n- Event Bus queue depth normal, DLQ empty\n- No critical incidents (P1/P2) in first 24 hours\n\n==== TS-4: Target State (Stable Production)\n\n===== Characteristics\n\n* ProfileService and EngagementService fully operational\n* All digital customer feedback routed to Salesforce\n* Event-driven architecture established\n* D365 CE decommissioned\n* First DDD bounded contexts implemented successfully\n\n===== Monitoring Period\n\n* Validate success criteria: feedback submission rate > 99.5%, no data loss\n* Monitor customer satisfaction score (target: +15% improvement)\n* Monitor average case resolution time (target: -20% improvement)\n* Support agents using unified Salesforce view across all channels\n\n===== D365 CE Retirement\n\n* D365 CE read-only access for historical Case lookups (if needed)\n* Decommission D365 CE infrastructure after 90 days\n* Archive D365 CE data for compliance/auditing\n\n===== Components Active\n\n- ProfileService (production)\n- EngagementService (production)\n- Event Bus (production)\n- Salesforce Production (system of record)\n- Braze (push notifications)\n- Mobile App (Salesforce integration)\n- App-specific database (deprecated, Contact data no longer updated)\n\n===== Success Criteria Achieved\n\n- All digital customer feedback routed to Salesforce\n- Support agents have unified customer view\n- D365 CE decommissioned\n- Customer satisfaction improved by 15%\n- Average case resolution time decreased by 20%\n- Zero data loss during transition\n\n=== Transition Dependencies\n\n[width=\"100%\",cols=\"40%,60%\",options=\"header\",]\n|===\n|Dependency |Owner/Status\n\n|*Salesforce production access*\n|Viva Energy Salesforce admin team - TBD\n\n|*Salesforce Case field mapping*\n|Viva Energy Salesforce admin team - TBD (map OTR feedback categories to Salesforce fields)\n\n|*Salesforce data isolation strategy*\n|Viva Energy Salesforce admin team - TBD (Record Types, queues, custom fields)\n\n|*Salesforce webhook configuration*\n|Viva Energy Salesforce admin team - TBD (Outbound Messages vs Platform Events)\n\n|*Event Bus infrastructure*\n|OTR Platform team - Existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis)\n\n|*Braze integration*\n|OTR Marketing team - Existing Braze account, EngagementService creates new campaigns\n\n|*Mobile App release window*\n|OTR Mobile team - Coordinate cutover timing with app release schedule\n\n|*App database access*\n|OTR Platform team - Read access for Contact migration\n\n|===\n\n=== Transition Validation Criteria\n\n==== Contact Migration Validation\n\n* 100% of app database Contacts migrated to Salesforce (zero data loss)\n* Email/phone/VCI matching accuracy > 95% (minimize duplicate Contacts)\n* ProfileService JIT lookups return correct Salesforce Contact IDs (smoke test sample)\n* Reconciliation report shows: X new Contacts created, Y existing Contacts updated\n\n==== Cutover Validation\n\n* Mobile App feedback submission success rate > 99.5% (including async Case creation)\n* End-to-end flow validated: Mobile App → ProfileService → EngagementService → Salesforce Case created\n* Braze push notifications delivered for Case creation and Case resolution\n* Event Bus queue depth within normal range (no backlog)\n* Dead letter queue empty (no failed Case creations)\n* Salesforce API rate limits not exceeded\n\n==== Production Monitoring (30 days)\n\n* Customer satisfaction score improves by 15% (compared to D365 CE baseline)\n* Average case resolution time decreases by 20% (Salesforce vs D365 CE)\n* Support agents confirm unified customer view across all channels\n* Zero critical incidents (P1 outages, data loss)\n\n=== Rollback Plan\n\n==== Rollback Triggers\n\n* Feedback submission success rate < 95% (below acceptable threshold)\n* Data loss or corruption detected in Salesforce\n* Salesforce API rate limits exceeded (Cases not created within SLA)\n* Critical bug blocking customer feedback submission\n\n==== Rollback Procedure\n\n1. **Revert Mobile App** to previous version (remove ProfileService/EngagementService integration, restore D365 CE integration)\n2. **Stop EngagementService** Case creation (prevent duplicate Cases in Salesforce)\n3. **Re-enable D365 CE** for customer feedback submission\n4. **Investigate root cause** (EngagementService logs, Salesforce API errors, Event Bus queue issues)\n5. **Fix and re-test** in sandbox environment\n6. **Retry cutover** when issues resolved\n\n==== Rollback Limitations\n\n* Cases created in Salesforce during cutover period remain in Salesforce (no reverse migration)\n* Contacts migrated to Salesforce remain (no rollback to app database)\n* Rollback only affects Mobile App integration (not data migration)\n\n=== Architectural Scope Boundaries\n\n==== Capabilities Included\n\n===== Business Capabilities\n\n* **Customer Feedback Submission**: Mobile App users can submit structured feedback (Category, Store Name, Time of Visit, Phone, Free Text Message) via EngagementService\n* **Customer Contact Management**: Just-In-Time (JIT) Contact reconciliation with Salesforce via ProfileService, ensuring every Mobile App user has a Salesforce Contact record\n* **Case Management Integration**: EngagementService creates Salesforce Cases asynchronously for customer feedback, support agents manage Cases in Salesforce Service Cloud\n* **Customer Notifications**: Push notifications via Braze when Cases are created, updated, or resolved (bidirectional integration: Mobile App → Salesforce → Mobile App)\n* **Unified Customer View**: Support agents see OTR digital customer feedback alongside other Viva Energy channels (fuel wholesale, Shell Card, retail) in single Salesforce instance\n* **Contact Data Migration**: One-time migration of app-specific customer database Contacts to Salesforce with upsert logic (email/phone/VCI matching)\n\n===== Technical Capabilities\n\n* **ProfileService Bounded Context**: First DDD bounded context implementation - JIT Contact reconciliation, Salesforce API facade, foundation for Flybuys integration\n* **EngagementService Bounded Context**: First DDD bounded context implementation - Customer feedback submission BFF, Anti-Corruption Layer for Salesforce, Braze integration orchestration\n* **Event-Driven Architecture**: Domain event publishing via Event Bus (SNS+SQS/EventBridge/Kinesis) for `SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted` events\n* **Async Processing Pattern**: Non-blocking Case creation with retry logic, exponential backoff, dead letter queue for operational resilience\n* **Anti-Corruption Layer Pattern**: EngagementService protects digital channels from Salesforce API changes, translates between OTR domain language and Salesforce\n* **Conformist Pattern**: ProfileService and EngagementService conform to existing Salesforce configuration (shared Viva Energy instance, multi-tenant governance)\n* **Salesforce Integration**: REST API integration for Contact CRUD and Case creation, webhook receiver for Case update notifications\n* **Braze Integration**: Push notification campaign triggers for Case lifecycle events (created, updated, resolved)\n* **Observability & Monitoring**: Dashboards, metrics, alerting for feedback submission rate, queue depth, API errors, Case creation latency\n* **Feature Flag Management**: Kill switches for emergency rollback (enable_salesforce_feedback_submission, enable_async_case_creation, etc.)\n\n==== Capabilities Excluded\n\n===== Business Capabilities Explicitly Out of Scope\n\n* **Historical Case Migration**: D365 CE Cases not migrated to Salesforce (ADR-CS-005 - fresh start, no Case migration)\n* **Multi-Channel Feedback Submission**: Web app, POS, call centre, email feedback channels not included (Mobile App only in this phase)\n* **Case Resolution by Digital Channels**: Support agents resolve Cases in Salesforce, not via Mobile App self-service\n* **Knowledge Base Integration**: Salesforce Knowledge Base articles not surfaced in Mobile App (future enhancement)\n* **Live Chat/Messaging**: Real-time chat support not included (Salesforce omnichannel capabilities not activated)\n* **Sentiment Analysis**: Automated feedback sentiment analysis not included (future enhancement with AI/ML)\n* **Customer Satisfaction Surveys**: Post-resolution CSAT surveys not included (separate initiative)\n* **Case Attachments**: Mobile App feedback submission does not support file uploads (photos, receipts) - text only\n* **Agent Desktop Integration**: Custom Salesforce UI for support agents not included (use standard Salesforce Service Console)\n* **Social Media Feedback**: Facebook, Twitter, Instagram feedback channels not integrated\n\n===== Technical Capabilities Explicitly Out of Scope\n\n* **Event Sourcing**: Domain events are ephemeral (not persisted for event sourcing/replay) - Event Bus only, no Event Store\n* **CQRS (Command Query Responsibility Segregation)**: ProfileService and EngagementService use same data model for reads/writes (no separate read models)\n* **Local Aggregate Persistence**: ProfileService and EngagementService are stateless (Salesforce is System of Record, no local database for Contact/Case)\n* **Saga Orchestration**: No distributed transactions or saga patterns required (single-step Case creation, not multi-step workflow)\n* **API Gateway Advanced Features**: Rate limiting, API versioning, API key management deferred to detailed design (basic routing only)\n* **GraphQL API**: ProfileService and EngagementService expose REST APIs only (GraphQL not required)\n* **Real-Time Sync**: Salesforce Contact updates by support agents not synced back to ProfileService (eventual consistency acceptable via JIT reconciliation)\n* **Multi-Region Deployment**: Single AWS region deployment (no multi-region failover/disaster recovery in this phase)\n* **Blue-Green Deployment**: Big bang cutover (ADR-CS-006), not blue-green or canary deployment strategy\n* **A/B Testing Framework**: Feature flags for rollback only, not for A/B testing or experimentation\n* **Custom Authentication**: Microsoft Entra External ID used for Mobile App authentication (no custom authentication logic in ProfileService/EngagementService)\n* **Data Residency Compliance**: Salesforce data residency governed by Viva Energy Salesforce configuration (no OTR-specific data residency requirements)\n\n===== Future Bounded Contexts Not in Scope\n\n* **LoyaltyService**: Flybuys integration, reward preferences, transaction adjudication (separate initiative)\n* **LocationService**: Store finder, proximity features, geofencing (separate initiative)\n* **PaymentService**: Payment processing, subscription billing (separate initiative)\n* **RecommendationService**: Personalized recommendations, next-best offers (separate initiative)\n\n===== Integration Patterns Not in Scope\n\n* **Shared Kernel**: No shared domain model between ProfileService and EngagementService (separate bounded contexts with clear boundaries)\n* **Partnership**: No joint development or coordination with external teams (Conformist pattern - we conform to Salesforce)\n* **Customer-Supplier (we're upstream)**: No downstream systems depend on ProfileService/EngagementService APIs yet (future bounded contexts will consume domain events)\n\n==== Architectural Dependencies on Future Initiatives\n\n*This Architecture Enables Future Initiatives*:\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Future Initiative |Architectural Enablement\n\n|*Flybuys Integration*\n|**ProfileService Contact Reconciliation Reused**: ProfileService establishes pattern for JIT Contact reconciliation with Salesforce, which will be extended for Flybuys partner linking (link:../architecture_definitions/flybuys_integration.adoc[see Flybuys Integration architecture]) +\n**Event Bus Infrastructure**: Domain event publishing pattern (`CustomerEnrolledInLoyalty`, `PartnerLinked`, etc.) reuses Event Bus established for EngagementService\n\n|*LoyaltyService Bounded Context*\n|**Event Bus Subscription**: LoyaltyService will consume `CustomerProfileCreated` events published by ProfileService (future enhancement) +\n**Salesforce Contact Integration**: LoyaltyService may query Salesforce Contacts for customer reward preferences (via ProfileService facade or direct Salesforce API)\n\n|*Web App Feedback Submission*\n|**EngagementService API Reuse**: Web app will call same EngagementService REST API for feedback submission (multi-channel support) +\n**Conformist Pattern**: Web app conforms to EngagementService API contract (no translation required)\n\n|*Multi-Channel Customer Support*\n|**EngagementService Extension**: Add support for email, call centre, POS feedback channels (extend EngagementService to handle multiple origins) +\n**Salesforce Case Origin Field**: Cases already tagged with Origin=Mobile App, extend to Origin=Web, POS, Call Centre, Email\n\n|*Knowledge Base Integration*\n|**EngagementService API Extension**: Add endpoint to query Salesforce Knowledge Base articles, surface in Mobile App for self-service support +\n**Anti-Corruption Layer**: EngagementService translates Salesforce Knowledge API to OTR domain language\n\n|*Customer Satisfaction Surveys*\n|**Event-Driven Trigger**: Subscribe to `SupportCaseResolved` events published by EngagementService, trigger CSAT survey via Braze +\n**Braze Integration Pattern**: Reuse EngagementService → Braze integration pattern for survey campaigns\n\n|*Sentiment Analysis*\n|**Event Subscription**: Subscribe to `CustomerFeedbackSubmitted` events, analyse feedback sentiment (AI/ML service) +\n**EngagementService Extension**: Enrich Case with sentiment score before creating in Salesforce\n\n|*RecommendationService Bounded Context*\n|**Event Subscription**: RecommendationService subscribes to `SupportCaseCreated` events to understand customer pain points and personalize recommendations +\n**Domain Event Pattern**: Reuse Event Bus publishing pattern established by EngagementService\n\n|===\n\n*This Architecture Depends on Future Initiatives*:\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Future Initiative |Dependency Description\n\n|*Salesforce Data Isolation Strategy*\n|**BLOCKER**: Viva Energy Salesforce admin team must define data isolation strategy (Record Types, custom fields, queues) before production deployment +\n**Impact**: Multi-tenant data visibility and security governance\n\n|*Salesforce Case Field Mapping*\n|**BLOCKER**: Viva Energy Salesforce admin team must define field mapping for OTR feedback categories (App, Service, Order, Rewards, Refund, Delete Account) +\n**Impact**: Case creation logic in EngagementService depends on finalized Salesforce schema\n\n|*Salesforce Webhook Mechanism*\n|**BLOCKER**: Viva Energy Salesforce admin team must configure webhook mechanism (Outbound Messages vs Platform Events vs Process Builder) for Case update notifications +\n**Impact**: EngagementService webhook receiver implementation depends on chosen mechanism\n\n|*Event Bus Technology Selection*\n|**DECISION REQUIRED**: Choose Event Bus implementation (SNS+SQS vs EventBridge vs Kinesis) for domain event publishing +\n**Impact**: Infrastructure provisioning, event schema design, consumer implementation\n\n|*Microservice Hosting Platform*\n|**DECISION REQUIRED**: Choose hosting platform for ProfileService and EngagementService (AWS Lambda vs ECS vs EKS) +\n**Impact**: Deployment architecture, auto-scaling strategy, operational overhead\n\n|*Observability Platform*\n|**DECISION REQUIRED**: Choose observability platform (AWS CloudWatch vs Datadog vs New Relic) for monitoring and alerting +\n**Impact**: Dashboard configuration, metric collection, alerting setup\n\n|===\n\n*Future Work After This Initiative*:\n\n* **Event Schema Registry**: Implement event schema versioning and registry for domain events (currently ad-hoc schemas)\n* **API Versioning Strategy**: Define API versioning approach for ProfileService and EngagementService (currently v1 only)\n* **Multi-Region Deployment**: Extend to multi-region for disaster recovery and global availability\n* **Event Store**: Persist domain events for event sourcing and audit trail (currently ephemeral Event Bus only)\n* **CQRS Pattern**: Separate read models for high-volume queries (currently same model for reads/writes)\n* **GraphQL API**: Expose GraphQL API for flexible client queries (currently REST only)\n* **Real-Time Sync**: Bi-directional sync between Salesforce and ProfileService for Contact updates (currently JIT reconciliation only)\n\n=== Technical Risks and Mitigation\n\n[width=\"100%\",cols=\"5%,20%,25%,25%,25%\",options=\"header\",]\n|===\n|ID |Risk |Impact |Likelihood |Mitigation\n\n|RISK-CS-001\n|*Salesforce API rate limits exceeded*: High feedback volume exceeds Salesforce API limits, Cases not created\n|HIGH (customers don't receive Case confirmation, support tickets lost)\n|MEDIUM (volume unknown, rate limits TBD)\n|• Gather expected feedback volume data before cutover +\n• Implement Event Bus queue throttling/rate limiting +\n• Monitor queue depth and API usage +\n• Scale background workers based on queue depth +\n• Alert ops team when approaching rate limits\n\n|RISK-CS-002\n|*Salesforce downtime*: Salesforce Service Cloud outage prevents Case creation\n|MEDIUM (Cases delayed but queued, customers wait for confirmation)\n|LOW (Salesforce SLA 99.9% uptime)\n|• Async Case creation with retry logic +\n• Event Bus queues buffer work during outage +\n• Customers get immediate \"Feedback submitted\" (not blocked) +\n• Monitor Salesforce status page, alert ops team +\n• Automatic retry when Salesforce recovers\n\n|RISK-CS-003\n|*Contact migration data quality issues*: App database Contact data incomplete or invalid\n|HIGH (migration fails validation, cutover delayed)\n|MEDIUM (legacy data quality unknown)\n|• Pre-migration data quality assessment +\n• Flexible upsert logic (match by email/phone/VCI) +\n• Validation report identifies data issues before production migration +\n• Manual cleanup for invalid records +\n• Dry-run migration in sandbox environment\n\n|RISK-CS-004\n|*Duplicate Contacts created*: Email matching fails, ProfileService creates duplicate Contacts\n|MEDIUM (support agents see multiple profiles for same customer)\n|MEDIUM (email changes, data quality issues)\n|• Salesforce duplicate detection rules (if available) +\n• ProfileService logs Contact creation for audit trail +\n• Manual duplicate cleanup process (support team) +\n• Future enhancement: VCI as Salesforce External ID for stable matching\n\n|RISK-CS-005\n|*Dead letter queue accumulation*: Failed Case creations not processed, queue grows\n|HIGH (customers don't receive Case confirmation, feedback lost)\n|LOW (retry logic handles most failures)\n|• Dead letter queue monitoring and alerting +\n• Ops team dashboard showing DLQ depth +\n• Manual intervention process (investigate and reprocess) +\n• Automated alerts when DLQ depth exceeds threshold +\n• Root cause analysis for recurring failures\n\n|RISK-CS-006\n|*Salesforce webhook failures*: Salesforce can't deliver Case update notifications to EngagementService\n|MEDIUM (customers don't get push notifications for Case resolution)\n|LOW (webhook mechanism reliable)\n|• Webhook retry logic and exponential backoff +\n• EngagementService logs webhook deliveries +\n• Monitor webhook delivery success rate +\n• Fallback: Poll Salesforce API for Case updates (if webhook fails persistently) +\n• Alert ops team when webhook delivery rate drops\n\n|RISK-CS-007\n|*Multi-tenant data isolation breach*: OTR digital Cases visible to other Viva Energy support teams\n|HIGH (privacy violation, compliance risk)\n|LOW (Salesforce governance controls)\n|• Work with Viva Energy Salesforce admin team on data isolation strategy +\n• Test data visibility in Salesforce sandbox (UAT with different user roles) +\n• Validate Record Types, queues, field-level security before production +\n• Audit Salesforce user permissions and sharing rules\n\n|RISK-CS-008\n|*Mobile App release coordination*: App release delayed, cutover window missed\n|MEDIUM (cutover delayed, D365 CE retirement delayed)\n|MEDIUM (release schedule conflicts)\n|• Coordinate cutover timing with Mobile team early +\n• Buffer time in migration plan (2-week contingency) +\n• Decouple backend deployment from Mobile App release (backend deployed first, app follows) +\n• Feature flag for feedback submission (enable when ready)\n\n|RISK-CS-009\n|*Event Bus infrastructure issues*: SNS/SQS/EventBridge downtime or misconfiguration\n|HIGH (Case creation blocked, domain events not published)\n|LOW (AWS SLA 99.99% uptime)\n|• Leverage existing AWS infrastructure (proven, reliable) +\n• Infrastructure as Code (IaC) for Event Bus configuration +\n• Integration testing in non-production environment +\n• Monitor Event Bus metrics (queue depth, throughput, errors) +\n• Alert ops team on Event Bus failures\n\n|RISK-CS-010\n|*Team DDD knowledge gap*: Team unfamiliar with DDD patterns, bounded contexts, event-driven architecture\n|MEDIUM (implementation delays, architectural inconsistencies)\n|HIGH (first DDD implementation)\n|• DDD training for development team (workshops, documentation) +\n• Architecture review sessions (validate bounded context design) +\n• Pair programming with experienced DDD practitioners +\n• Incremental implementation (start small, iterate) +\n• Document architectural patterns in CLAUDE.md\n\n|===\n\n== Assumptions and Constraints\n\n=== Assumptions\n\n[width=\"100%\",cols=\"8%,92%\",options=\"header\",]\n|===\n|ID |Assumption\n\n|ASM-CS-001\n|Viva Energy Salesforce admin team will provide Salesforce production access, sandbox environment, and support for Case field mapping and data isolation configuration\n\n|ASM-CS-002\n|App database Contact data is sufficiently complete for migration (email/phone/VCI available for matching)\n\n|ASM-CS-003\n|Expected customer feedback volume (100-150 submissions/day from 20k DAU) is well within Salesforce API rate limits, with capacity planning for 3x-10x growth\n\n|ASM-CS-004\n|Existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis) is sufficient for Event Bus implementation (no additional infrastructure provisioning required)\n\n|ASM-CS-005\n|Braze integration already exists and can be extended for Case-related push notifications (no new Braze account or major configuration changes)\n\n|ASM-CS-006\n|Mobile App users have email addresses associated with their accounts (required for ProfileService Contact reconciliation)\n\n|ASM-CS-007\n|D365 Customer Engagement historical Cases have limited business value and do not require migration to Salesforce\n\n|ASM-CS-008\n|Support agents are trained on Salesforce Service Cloud and require minimal additional training for OTR digital customer Cases\n\n|ASM-CS-009\n|Salesforce Service Cloud shared instance has capacity for OTR digital customer Contacts and Cases (no additional licensing or storage costs)\n\n|ASM-CS-010\n|Mobile App release schedule can accommodate cutover timing (Week 10 in migration plan)\n\n|===\n\n=== Constraints\n\n[width=\"100%\",cols=\"8%,92%\",options=\"header\",]\n|===\n|ID |Constraint\n\n|CON-CS-001\n|Must use shared Viva Energy Salesforce Service Cloud instance (cannot deploy separate OTR-specific instance)\n\n|CON-CS-002\n|Must conform to existing Salesforce configuration and governance (Record Types, custom fields, queues, data isolation strategy defined by Viva Energy admin team)\n\n|CON-CS-003\n|Contact migration must complete before Mobile App cutover (no parallel run of D365 CE and Salesforce)\n\n|CON-CS-004\n|Big bang cutover only (no phased rollout with feature flags or pilot users)\n\n|CON-CS-005\n|Salesforce API rate limits and authentication method constrained by Viva Energy Salesforce configuration (TBD)\n\n|CON-CS-006\n|Event Bus implementation must use existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis - cannot introduce new infrastructure components)\n\n|CON-CS-007\n|Mobile App feedback form must include specific fields: Category, Store Name, Time of Visit, Contact Phone Number, Free Text Message (no attachments)\n\n|CON-CS-008\n|D365 Customer Engagement must be decommissioned within 90 days post-cutover (ADR-CS-006)\n\n|CON-CS-009\n|ProfileService and EngagementService must be stateless (no local aggregate persistence, Salesforce is System of Record)\n\n|CON-CS-010\n|First DDD bounded context implementation (team learning curve, architectural patterns must be documented for future bounded contexts)\n\n|===\n\n== Non-Functional Requirements\n\n=== Performance Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-PERF-001\n|Mobile App feedback submission API response time (ProfileService + EngagementService)\n|p95 < 1 second, p99 < 2 seconds\n\n|NFR-PERF-002\n|ProfileService Contact reconciliation API response time (JIT lookup)\n|p95 < 500ms, p99 < 1 second\n\n|NFR-PERF-003\n|EngagementService async Case creation latency (end-to-end: feedback submitted → Case created in Salesforce)\n|p95 < 5 minutes, p99 < 10 minutes\n\n|NFR-PERF-004\n|Salesforce API call latency (Contact query, Contact create, Case create)\n|p95 < 2 seconds, p99 < 5 seconds\n\n|NFR-PERF-005\n|Event Bus message processing throughput\n|> 100 messages/second (support peak feedback volume)\n\n|NFR-PERF-006\n|Braze push notification delivery latency (Case created → notification delivered)\n|p95 < 30 seconds, p99 < 60 seconds\n\n|===\n\n=== Availability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-AVAIL-001\n|ProfileService availability\n|99.9% uptime (8.76 hours downtime/year)\n\n|NFR-AVAIL-002\n|EngagementService availability\n|99.9% uptime (8.76 hours downtime/year)\n\n|NFR-AVAIL-003\n|Feedback submission success rate (including async Case creation)\n|> 99.5% (includes retry logic for transient failures)\n\n|NFR-AVAIL-004\n|Graceful degradation: Salesforce downtime handling\n|Feedback submission still succeeds, Cases queued for async creation when Salesforce recovers\n\n|NFR-AVAIL-005\n|Graceful degradation: Braze downtime handling\n|Case creation proceeds, push notifications disabled temporarily (feature flag)\n\n|NFR-AVAIL-006\n|Planned maintenance window\n|< 4 hours/month, scheduled during low-traffic periods (2-6am ACST)\n\n|===\n\n=== Scalability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-SCALE-001\n|Concurrent Mobile App users (peak)\n|Support 20,000 DAU (Daily Active Users), ~150 concurrent users submitting feedback during peak hours\n\n|NFR-SCALE-002\n|Feedback submissions per day\n|Expected: 100-150 submissions/day based on 20k DAU (~0.5-0.75% submission rate) +\nCapacity: Support 500 submissions/day (3x expected volume for growth), 2,000 submissions/day (peak/incident scenarios)\n\n|NFR-SCALE-003\n|Auto-scaling: ProfileService and EngagementService\n|Auto-scale based on CPU/memory/request rate, scale up within 2 minutes\n\n|NFR-SCALE-004\n|Event Bus queue capacity\n|Support 100,000 queued messages (buffer for Salesforce downtime)\n\n|NFR-SCALE-005\n|Salesforce API rate limit compliance\n|Stay within 80% of Salesforce API rate limits (buffer for spikes)\n\n|NFR-SCALE-006\n|Future growth capacity\n|Architecture supports 10x growth (1,000-1,500 submissions/day based on 200k DAU) without major redesign\n\n|===\n\n=== Security Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-SEC-001\n|Mobile App authentication\n|Microsoft Entra External ID OAuth 2.0 with JWT tokens (existing CIAM)\n\n|NFR-SEC-002\n|API authorisation: ProfileService and EngagementService\n|JWT token validation, authenticated users only, user context propagation\n\n|NFR-SEC-003\n|Salesforce API authentication\n|OAuth 2.0 with Connected App and JWT bearer flow (service account)\n\n|NFR-SEC-004\n|Data encryption in transit\n|TLS 1.2+ for all API calls (Mobile App ↔ ProfileService/EngagementService ↔ Salesforce ↔ Braze)\n\n|NFR-SEC-005\n|Data encryption at rest\n|Salesforce encryption at rest (managed by Salesforce), Event Bus message encryption (AWS KMS)\n\n|NFR-SEC-006\n|Secret management\n|AWS Secrets Manager for Salesforce credentials, Braze API keys, OAuth tokens (no hardcoded secrets)\n\n|NFR-SEC-007\n|PII data handling\n|Contact data (email, phone, name) treated as PII, GDPR-compliant retention policies (Salesforce governance)\n\n|NFR-SEC-008\n|API rate limiting and throttling\n|API Gateway rate limiting (100 requests/second per user), prevent abuse and DoS\n\n|NFR-SEC-009\n|Logging and auditing\n|Log all API calls, Salesforce Contact/Case creates/updates, Event Bus publishes (no PII in logs)\n\n|NFR-SEC-010\n|Salesforce data isolation\n|Multi-tenant data isolation via Salesforce Record Types, queues, sharing rules (defined by Viva Energy admin team)\n\n|===\n\n=== Reliability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-REL-001\n|Retry logic: EngagementService → Salesforce Case creation\n|Exponential backoff (1s, 2s, 4s, 8s, 16s), max 5 retries, then dead letter queue\n\n|NFR-REL-002\n|Dead letter queue monitoring\n|Alert ops team immediately when DLQ depth > 0 (failed Case creations require manual intervention)\n\n|NFR-REL-003\n|Event Bus message durability\n|Messages persisted in Event Bus (SNS+SQS/EventBridge/Kinesis), not lost on service restart\n\n|NFR-REL-004\n|Idempotency: Case creation\n|EngagementService ensures duplicate feedback submissions don't create duplicate Cases (idempotency key)\n\n|NFR-REL-005\n|Circuit breaker: Salesforce API calls\n|Open circuit after 5 consecutive failures, half-open retry after 30 seconds\n\n|NFR-REL-006\n|Health checks: ProfileService and EngagementService\n|Health endpoints for load balancer checks, readiness and liveness probes\n\n|NFR-REL-007\n|Disaster recovery: Event Bus\n|Event Bus messages replicated across AWS availability zones (SQS/EventBridge/Kinesis HA)\n\n|===\n\n=== Maintainability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-MAINT-001\n|Code quality: ProfileService and EngagementService\n|> 80% test coverage (unit + integration tests), automated CI/CD pipeline\n\n|NFR-MAINT-002\n|API documentation\n|OpenAPI/Swagger specs for ProfileService and EngagementService, auto-generated API docs\n\n|NFR-MAINT-003\n|Deployment automation\n|Infrastructure as Code (Terraform/CloudFormation/CDK), zero-downtime deployments\n\n|NFR-MAINT-004\n|Logging: structured logs\n|JSON-formatted logs with correlation IDs, log levels (DEBUG, INFO, WARN, ERROR), centralized log aggregation\n\n|NFR-MAINT-005\n|Monitoring dashboards\n|Real-time dashboards for ProfileService, EngagementService, Event Bus (see Monitoring and Observability section)\n\n|NFR-MAINT-006\n|Alerting and on-call\n|PagerDuty/Opsgenie integration for P1/P2 alerts, on-call rotation for ops team\n\n|NFR-MAINT-007\n|Configuration management\n|Externalized configuration (environment variables, AWS Parameter Store), no hardcoded config\n\n|NFR-MAINT-008\n|Versioning: API and events\n|Semantic versioning (v1, v2), backward compatibility for API changes, event schema evolution\n\n|===\n\n=== Usability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-USE-001\n|Feedback submission UX\n|Mobile App user receives immediate \"Feedback submitted\" confirmation (< 1 second), not blocked by async Case creation\n\n|NFR-USE-002\n|Push notification delivery\n|Customer receives \"Your feedback has been received\" notification within 30 seconds of Case creation in Salesforce\n\n|NFR-USE-003\n|Case resolution notification\n|Customer receives \"Your case has been resolved\" notification within 30 seconds of support agent resolving Case\n\n|NFR-USE-004\n|Error messaging\n|User-friendly error messages for failed feedback submission (not technical errors), retry prompts\n\n|NFR-USE-005\n|Accessibility\n|Mobile App feedback form meets WCAG 2.1 AA accessibility standards (existing Mobile App compliance)\n\n|===\n\n=== Compliance Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-COMP-001\n|GDPR compliance: PII data\n|Customer Contact data (email, phone, name) managed per GDPR retention policies (Salesforce governance)\n\n|NFR-COMP-002\n|GDPR compliance: Right to erasure\n|Support \"Delete Account\" feedback category, trigger Contact deletion in Salesforce per GDPR Article 17\n\n|NFR-COMP-003\n|Data residency\n|Salesforce data residency governed by Viva Energy Salesforce configuration (regional compliance)\n\n|NFR-COMP-004\n|Audit trail\n|All Contact creates/updates, Case creates/updates logged for compliance auditing (Salesforce audit logs)\n\n|NFR-COMP-005\n|API security standards\n|OWASP API Security Top 10 compliance (injection prevention, authentication, authorisation, data exposure)\n\n|===\n\n== Monitoring and Observability\n\n=== Key Metrics\n\n[width=\"100%\",cols=\"25%,40%,35%\",options=\"header\",]\n|===\n|Metric Category |Metric |Target/Threshold\n\n|*Feedback Submission*\n|Feedback submission success rate (Mobile App → EngagementService)\n|> 99.5%\n\n|*Async Case Creation*\n|Case creation success rate (EngagementService → Salesforce)\n|> 99%\n\n|*Async Case Creation*\n|Case creation latency (time from feedback submission to Case created in Salesforce)\n|p95 < 5 minutes\n\n|*Event Bus*\n|Event Bus queue depth (pending Case creations)\n|< 100 messages\n\n|*Event Bus*\n|Dead letter queue depth (failed Case creations)\n|= 0 (alert on any failures)\n\n|*Salesforce API*\n|Salesforce API error rate\n|< 1%\n\n|*Salesforce API*\n|Salesforce API latency (Case creation)\n|p95 < 2 seconds\n\n|*Salesforce API*\n|Salesforce API rate limit utilization\n|< 80% of limit\n\n|*ProfileService*\n|Contact reconciliation success rate (JIT lookups)\n|> 99.5%\n\n|*ProfileService*\n|Contact reconciliation latency\n|p95 < 500ms\n\n|*Braze Notifications*\n|Push notification delivery rate (Case created/updated)\n|> 95%\n\n|*Salesforce Webhook*\n|Webhook delivery success rate (Salesforce → EngagementService)\n|> 99%\n\n|*Customer Satisfaction*\n|Customer satisfaction score (CSAT)\n|> 4.0/5.0 (improve by 15% from D365 CE baseline)\n\n|*Support Operations*\n|Average case resolution time\n|Decrease by 20% from D365 CE baseline\n\n|===\n\n=== Alerting Thresholds\n\n[width=\"100%\",cols=\"25%,50%,25%\",options=\"header\",]\n|===\n|Alert |Condition |Severity\n\n|*Feedback submission failures*\n|Feedback submission success rate < 95% over 5-minute window\n|P1 - Critical\n\n|*Dead letter queue accumulation*\n|Dead letter queue depth > 0 (any failed Case creations)\n|P2 - High\n\n|*Event Bus queue backlog*\n|Event Bus queue depth > 100 messages for > 15 minutes\n|P2 - High\n\n|*Salesforce API errors*\n|Salesforce API error rate > 5% over 5-minute window\n|P1 - Critical\n\n|*Salesforce API rate limits*\n|Salesforce API rate limit utilization > 90%\n|P2 - High\n\n|*Contact reconciliation failures*\n|ProfileService Contact reconciliation failure rate > 5% over 5-minute window\n|P2 - High\n\n|*Braze notification failures*\n|Braze push notification delivery rate < 80% over 15-minute window\n|P3 - Medium\n\n|*Salesforce webhook failures*\n|Salesforce webhook delivery success rate < 90% over 15-minute window\n|P2 - High\n\n|*Case creation latency*\n|Case creation latency p95 > 10 minutes\n|P3 - Medium\n\n|===\n\n=== Dashboards\n\n*ProfileService Dashboard:*\n\n* Contact reconciliation success rate (JIT lookups)\n* Contact reconciliation latency (p50, p95, p99)\n* Contact creation vs update ratio (new Contacts created vs existing Contacts updated)\n* Salesforce API error rate (Contact queries and creates)\n* Request rate and throughput\n\n*EngagementService Dashboard:*\n\n* Feedback submission success rate\n* Case creation success rate (async workflow)\n* Case creation latency (p50, p95, p99)\n* Event Bus queue depth (pending Case creations)\n* Dead letter queue depth (failed Case creations)\n* Salesforce API error rate (Case creation)\n* Salesforce API latency\n* Salesforce API rate limit utilization\n* Braze push notification delivery rate\n* Salesforce webhook delivery success rate\n\n*Event Bus Dashboard:*\n\n* Queue depth (pending messages)\n* Throughput (messages published/consumed per minute)\n* Dead letter queue depth (failed messages)\n* Consumer lag (time between publish and consume)\n\n*Customer Support Dashboard (Business Metrics):*\n\n* Total feedback submissions per day/week/month\n* Feedback category breakdown (App, Service, Order, Rewards, Refund, Delete Account)\n* Customer satisfaction score (CSAT) trend\n* Average case resolution time trend\n* Case volume by support team/queue\n* Unified customer view adoption (support agent feedback)\n<<<\n== Solution Validation\n\nThis section defines the validation criteria and testing approach for the solution.\n\n=== Functional Validation\n\n==== ProfileService API Testing\n\n*Test Scenarios*:\n1. **Happy Path**: Authenticated user requests Contact ID, existing Contact found in Salesforce, Contact ID returned\n2. **JIT Creation**: Authenticated user requests Contact ID, no existing Contact, new Contact created in Salesforce, Contact ID returned\n3. **Salesforce API Failure**: Salesforce unavailable, ProfileService returns 500 error, user retries\n4. **Invalid JWT**: Unauthenticated request, ProfileService returns 401 error\n\n*Acceptance Criteria*:\n- Contact reconciliation success rate > 99.5%\n- JIT Contact creation completes within 500ms (p95)\n\n==== EngagementService API Testing\n\n*Test Scenarios*:\n1. **Happy Path**: Valid feedback submission, immediate 202 Accepted response, Case created in Salesforce within 5 minutes, Braze notification delivered\n2. **Invalid Category**: Invalid feedback category, 400 Bad Request response with validation error\n3. **Salesforce Downtime**: Salesforce unavailable during async Case creation, message queued, retry logic executes, Case created when Salesforce recovers\n4. **Dead Letter Queue**: Case creation fails after 5 retries, message moved to DLQ, ops team alerted\n5. **Webhook Notification**: Support agent resolves Case in Salesforce, webhook triggers EngagementService, Braze push notification sent to customer\n\n*Acceptance Criteria*:\n- Feedback submission success rate > 99.5% (including async Case creation)\n- Async Case creation completes within 5 minutes (p95)\n- Webhook delivery success rate > 99%\n\n=== Non-Functional Validation\n\n==== Performance Testing\n\n*Load Testing*:\n\n*Baseline*: Expected 100-150 submissions/day from 20k DAU (~0.5-0.75% submission rate)\n\n- **Normal Load**: 1 submission/minute sustained for 2 hours (simulate typical daily pattern)\n- **3x Load**: 3 submissions/minute sustained for 1 hour (simulate busy period, 450 submissions/day)\n- **Peak Load (10x)**: 10 submissions/minute for 15 minutes (simulate incident scenario, app outage causing backlog)\n- **Stress Test**: 50 submissions/minute for 5 minutes (find breaking point, 20x normal)\n\n*Validation*:\n- API response time p95 < 1 second under 10x load\n- Event Bus queue depth remains manageable (< 100 messages)\n- No Case creation failures, all submissions processed successfully\n- Auto-scaling triggers appropriately for sustained load > 3x baseline\n\n*Acceptance Criteria*:\n- NFR-PERF-001 through NFR-PERF-006 validated under realistic load (3x and 10x baseline)\n- Auto-scaling triggers within 2 minutes of load increase\n- System handles 10x peak gracefully, 20x stress test identifies limits\n\n==== Resilience Testing\n\n*Salesforce API Failure Scenarios*:\n1. **Complete Outage**: Salesforce unavailable for 2 hours, Event Bus queues buffer work, Cases created when Salesforce recovers\n2. **Rate Limit Exceeded**: Salesforce rate limit hit, queue throttling activates, Cases created within SLA\n\n*Acceptance Criteria*:\n- NFR-AVAIL-004 validated (graceful degradation during Salesforce downtime)\n- Circuit breaker activates after 5 consecutive failures\n\n==== Security Validation\n\n*Penetration Testing*:\n- API authentication bypass attempts\n- SQL injection attempts\n- Webhook signature validation bypass\n\n*Acceptance Criteria*:\n- NFR-SEC-001 through NFR-SEC-010 validated\n- OWASP API Security Top 10 compliance verified\n\n=== Integration Validation\n\n==== End-to-End Testing\n\n*Full User Journey*:\n1. User authenticates via Microsoft Entra External ID\n2. Mobile App requests Contact ID from ProfileService (JIT reconciliation)\n3. User submits feedback via EngagementService\n4. Background worker creates Case in Salesforce\n5. Braze notification delivered to user\n6. Support agent resolves Case in Salesforce\n7. Salesforce webhook triggers EngagementService\n8. Braze notification delivered to user\n\n*Acceptance Criteria*:\n- End-to-end flow completes successfully in UAT\n- User receives both \"feedback submitted\" and \"case resolved\" notifications\n","structuredPatch":[{"oldStart":1854,"oldLines":6,"newStart":1854,"newLines":7,"lines":[" * UI tests pass for all feedback form workflows (happy path, error states)"," * App builds and deploys successfully to TestFlight (iOS) and Google Play Internal Testing (Android)"," ","+[[wp-cs-006]]"," === WP-CS-006: Integration Testing"," "," ==== Description"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"dceaeabf-9e7c-4d2d-84fd-34df01f4c7e0"}
{"parentUuid":"a93bc670-aa2d-448a-bff2-6b8d97f382ca","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_017RfdD2xHiVBHaP4VaK4stH","type":"tool_result","content":"The file /mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n  1924→* UAT sign-off obtained from business stakeholders\n  1925→* Zero critical defects (P1/P2) open before moving to Contact Migration\n  1926→* Test results documented and approved\n  1927→\n  1928→[[wp-cs-007]]\n  1929→=== WP-CS-007: Salesforce Configuration\n  1930→\n  1931→==== Description\n  1932→\n  1933→Configure Salesforce Service Cloud for OTR digital customer support integration, including field mapping, data isolation, and webhook setup.\n  1934→\n  1935→==== Deliverables"}]},"uuid":"bdd98c8a-fcff-4f18-9b1e-52536c3a676b","timestamp":"2026-01-09T03:10:48.951Z","toolUseResult":{"filePath":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","oldString":"=== WP-CS-007: Salesforce Configuration\n\n==== Description","newString":"[[wp-cs-007]]\n=== WP-CS-007: Salesforce Configuration\n\n==== Description","originalFile":"= Salesforce Customer Support - Solution Architecture\n:project-name: Salesforce Customer Support\n:togaf-adm-phase: Phase E: Opportunities & Solutions\n:last-updated: 2026-01-07\n:document-type: Solution Architecture Document\n:status: Discovery\n:version: 0.1\n:domain: Customer Support & Engagement\n:programme-lead:\n:domain-architect: O.Young@otr.com.au\n:architecture-definition: xref:architecture-definitions:salesforce_customer_support.adoc[Architecture Definitions/Salesforce Customer Support]\n:doctype: article\n:toc: left\n:toclevels: 4\n:sectanchors:\n:sectlinks:\n:sectnums:\n:icons: font\n:source-highlighter: highlightjs\n:experimental:\n:description:\n:keywords:\n\n<<<\n== Purpose and Scope\n\n=== Purpose\n\nThis Solution Architecture defines how the Salesforce Customer Support consolidation will be implemented - the specific technology products, configurations, interfaces, and deployment architecture that realise the xref:architecture-definitions:salesforce_customer_support.adoc[Salesforce Customer Support Architecture Definition].\n\nThis solution establishes the **first implementation of OTR's target Domain-Driven Design (DDD) architecture** by deploying two new bounded contexts (`ProfileService` and `EngagementService`) as microservices, consolidating customer support onto Salesforce Service Cloud, and implementing event-driven integration patterns that will serve as the foundation for future bounded contexts (including Flybuys integration).\n\n=== Vision\n\n> Unify customer support across all OTRG channels by consolidating OTR digital customer feedback onto Salesforce Service Cloud, establishing the foundational DDD architecture with ProfileService and EngagementService bounded contexts that protect digital channels from external system changes while enabling support agents to deliver exceptional customer experiences with complete interaction history.\n\n=== Architectural Approach\n\nThis architecture establishes OTR's **first bounded context implementation** using Domain-Driven Design strategic patterns:\n\n* *link:../bounded_context/profile.adoc[ProfileService]* (NEW bounded context): Just-In-Time Contact reconciliation with Salesforce, upsert by email, returns Salesforce Contact ID to digital channels - foundation for future Flybuys partner linking\n* *link:../bounded_context/engagement.adoc[EngagementService]* (NEW bounded context): Customer feedback submission facade, Anti-Corruption Layer for Salesforce Case creation, Braze integration for all outbound customer communications (push, email, SMS), async Case processing via Event Bus\n* *Event-driven integration* (NEW pattern): Domain event publishing using existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis) - first implementation establishing pattern for future bounded contexts\n* *Anti-Corruption Layer*: EngagementService isolates digital channels from Salesforce API changes, translates between OTR domain language and Salesforce Service Cloud API\n* *Conformist Pattern*: ProfileService and EngagementService conform to existing Salesforce configuration (shared Viva Energy instance, multi-tenant governance)\n* *Big bang cutover*: Single deployment after Contact migration, no phased rollout, D365 CE retirement post-cutover\n\n=== Scope\n\n==== In Scope\n\n* Solution Building Blocks (SBBs) - specific technology products and versions\n* Interface specifications (APIs, events, data formats)\n* Data architecture and schema specifications\n* Deployment architecture and infrastructure configuration\n* Transition architecture with migration phases\n* Technical validation criteria and testing approach\n* External system integration specifications\n* Physical data models and API schemas\n\n==== Out of Scope\n\n===== Covered in xref:architecture-definitions:salesforce_customer_support.adoc[Architecture Definition]\n\n* Business requirements and stakeholder analysis\n* Architecture decisions and rationale (ADRs)\n* Bounded context definitions and responsibilities\n* High-level integration patterns (ACL, Conformist, OHS+PL)\n* Business capability mapping and value streams\n* Architecture principles and governance\n\n===== Covered in Other Documents\n\n* Detailed design (class diagrams, sequence diagrams for all flows)\n* Implementation code and unit tests\n* Business case and return-on-investment analysis\n* Operational run books and support procedures\n\n<<<\n=== Architecture Overview\n\n[mermaid]\n----\n---\nconfig:\n  layout: elk\n---\nflowchart TB\n    Customer([\"Customer\"]) -- Uses --> MobileApp[\"Mobile App<br>iOS/Android\"]\n    Customer -- Shops at --> POS[\"OTR/OTR+ POS<br>D365 Commerce\"]\n    MobileApp -- Authenticate --> EntraID[\"Microsoft Entra\"]\n    MobileApp -- Identifies & Reconciles --> ProfileService[\"ProfileService\"]\n    ProfileService <-- Reconcile App User as Salesforce Contact --> Salesforce[\"Salesforce\"]\n    ProfileService -- On Create --> EventBus[\"EventBus\"]\n    EventBus -- Emits CreateUser Event --> LoyaltyService[\"LoyaltyService\"] & EngagementService[\"EngagementService\"]\n    LoyaltyService -- Reconcile Wallet --> EagleEye[\"EagleEye\"]\n    EngagementService -- Reconcile Braze Profile --> Braze[\"Braze\"]\n    EngagementService --> Salesforce\n    D365CE[\"D365CE\"] -- Data Migration --> Salesforce\n    MobileApp -- Submits Feedback --> EngagementService\n\n    Customer:::customer\n    MobileApp:::presentation\n    POS:::presentation\n    EntraID:::external\n    ProfileService:::newService\n    Salesforce:::external\n    EventBus:::infrastructure\n    LoyaltyService:::newService\n    EngagementService:::newService\n    EagleEye:::external\n    Braze:::external\n    D365CE:::external\n    classDef newService fill:#4CAF50,stroke:#2E7D32,stroke-width:3px,color:#fff\n    classDef external fill:#FF9800,stroke:#E65100,stroke-width:2px,color:#fff\n    classDef infrastructure fill:#2196F3,stroke:#0D47A1,stroke-width:2px,color:#fff\n    classDef presentation fill:#9C27B0,stroke:#4A148C,stroke-width:2px,color:#fff\n    classDef customer fill:#607D8B,stroke:#263238,stroke-width:2px,color:#fff\n----\n\n\n==== Key Architectural Patterns\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Pattern |Application |Rationale\n\n|*Anti-Corruption Layer (ACL)*\n|EngagementService → Salesforce Service Cloud\n|Protects digital channels (Mobile App, Web) from Salesforce API changes, translates between OTR domain language and Salesforce Case/Contact model, enables independent evolution of internal domain model\n\n|*Conformist*\n|ProfileService → Salesforce, EngagementService → Salesforce\n|Shared Viva Energy Salesforce instance - we conform to existing configuration, governance, and API contracts (external system we don't control)\n\n|*Backend-for-Frontend (BFF)*\n|EngagementService\n|Aggregates customer feedback submission, Contact lookup, async Case creation, and Braze notification orchestration for digital channel clients\n\n|*Event-Driven Architecture (OHS+PL)*\n|Event Bus (SNS+SQS/EventBridge/Kinesis)\n|Loose coupling between bounded contexts, async domain event publishing (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`), foundation for future bounded contexts\n\n|*Just-In-Time (JIT) Integration*\n|ProfileService → Salesforce Contact reconciliation\n|Reconcile app users as Salesforce Contacts on-demand (upsert by email), no pre-sync required, ensures Salesforce has current Contact data\n\n|*Async Processing*\n|EngagementService Case creation via Event Bus\n|Non-blocking user experience, resilience to Salesforce downtime, automatic retry with exponential backoff, dead letter queue for operations team intervention\n\n|*Strangler Fig*\n|Not applicable\n|Big bang cutover (no gradual migration) - D365 CE fully replaced, not incrementally strangled\n\n|===\n\n<<<\n== Solution Approach\n\n* Deploy xref:bounded-contexts:profile.adoc[ProfileService] and xref:bounded-contexts:engagement.adoc[EngagementService] as bounded context microservices\n* Implement Anti-Corruption Layers (ACLs) for Salesforce and Braze integration\n* Establish event-driven architecture as the foundational integration pattern\n* Big bang cutover (TS-1 → TS-4)\n\n=== Related Documentation\n\nThis solution architecture references detailed technical specifications:\n\n==== Architecture Definition\n\n* xref:architecture-definitions:salesforce_customer_support.adoc[Salesforce Customer Support - Architecture Definition] - Business requirements, architecture decisions (ADRs), bounded context definitions, high-level integration patterns\n\n==== Bounded Context Specifications\n\n* xref:bounded-contexts:profile.adoc[ProfileService Bounded Context] - JIT Contact reconciliation, aggregate definitions\n* xref:bounded-contexts:engagement.adoc[EngagementService Bounded Context] - Customer feedback facade, Anti-Corruption Layer\n\n==== Interface Specifications\n\nDetailed API specifications available in the specifications directory:\n\n* link:../../specifications/rest/profile-service-v1.yaml[ProfileService REST API v1] - OpenAPI 3.0 specification for `/profile/v1` endpoints (includes Salesforce Contact reconciliation `GET /contact-id`)\n* link:../../specifications/rest/engagement-service-v1.yaml[EngagementService REST API v1] - OpenAPI 3.0 specification for `/engagement/v1` endpoints (includes `POST /feedback`)\n* link:../../specifications/events/engagement-events.json[Engagement Domain Events] - CloudEvents 1.0 JSON Schema for `SupportCaseCreated`, `SupportCaseUpdated`, `SupportCaseResolved`, `CustomerFeedbackSubmitted`\n\n==== External System Documentation\n\n* https://developer.salesforce.com/docs/atlas.en-us.api_rest.meta/api_rest/[Salesforce REST API Documentation] - Contact and Case object APIs\n* https://www.braze.com/docs/api/endpoints/messaging/send_messages/post_send_triggered_campaigns/[Braze Campaign Trigger API] - Push notification campaigns\n\n<<<\n== Executive Summary\n\n=== Challenge\n\nOTR digital customers (Mobile App, Web) currently submit feedback and support requests to D365 Customer Engagement, while Viva Energy's broader business units (fuel wholesale, Shell Card customers, other retail channels) use Salesforce Service Cloud. This creates:\n\n* *Fragmented customer support platform*: Customer support data split across two systems, preventing support agents from having a unified view of customer interactions across all channels\n* *Operational inefficiency*: Maintaining two separate customer support platforms increases operational overhead and costs\n* *Poor support experience*: D365 CE is not working well for digital customer support, impacting customer satisfaction and case resolution times\n* *Post-merger consolidation opportunity*: Following Viva Energy's acquisition of OTR, strategic alignment on Salesforce as the enterprise customer support platform\n\n=== Solution\n\nThis architecture establishes the **foundational Domain-Driven Design (DDD) implementation** for OTR's target state architecture by introducing two new bounded contexts (link:../bounded_context/profile.adoc[ProfileService], link:../bounded_context/engagement.adoc[EngagementService]) and event-driven integration patterns:\n\n==== New Bounded Contexts\n\n* *link:../bounded_context/profile.adoc[ProfileService]* (NEW): Just-In-Time (JIT) Contact reconciliation with Salesforce, upsert by email, returns Salesforce Contact ID to Mobile App\n* *link:../bounded_context/engagement.adoc[EngagementService]* (NEW): Customer feedback submission, Anti-Corruption Layer (ACL) for Salesforce Case creation, Braze integration for all outbound customer communications (push, email, SMS), async Case processing via Event Bus\n* *Event Bus* (NEW pattern): Domain event publishing using existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis) - first implementation of event-driven architecture pattern\n\n==== Integration Architecture\n\n* *Salesforce = System of Record*: Salesforce Service Cloud (shared Viva Energy instance) owns Contact and Case data\n* *Conformist Pattern*: ProfileService and EngagementService conform to existing Salesforce configuration and API contracts\n* *Anti-Corruption Layer*: EngagementService protects digital channels from Salesforce API changes, translates between OTR domain language and Salesforce\n* *Async Case Creation*: Non-blocking user experience, resilience to Salesforce downtime, automatic retry with exponential backoff, dead letter queue for failed Cases\n* *Event-Driven Notifications*: Salesforce webhook → EngagementService → Braze for all customer communications (push, email, SMS) on Case status updates\n\n==== Migration Approach\n\n* *Contact Migration*: One-time migration from app-specific database → Salesforce (upsert with flexible matching by email/phone/VCI)\n* *No Case Migration*: Historical D365 CE Cases not migrated (fresh start in Salesforce)\n* *Big Bang Cutover*: Single deployment, no phased rollout or parallel run\n* *D365 CE Retirement*: Complete decommissioning of D365 Customer Engagement post-cutover\n\n=== Key Architectural Significance\n\nThis migration establishes the first implementation of OTR's target DDD architecture:\n\n* First bounded contexts implemented (ProfileService, EngagementService)\n* First event-driven domain event pattern (foundation for future bounded contexts)\n* Foundation for Flybuys integration (ProfileService Contact reconciliation reused)\n* Establishes integration patterns (Conformist, ACL, Event-Driven) for future services\n\n=== Success Criteria\n\n* All digital customer feedback routed to Salesforce Service Cloud within 30 days of launch\n* Support agents have unified customer view across all Viva Energy channels (digital, wholesale, Shell Card, other retail)\n* D365 Customer Engagement decommissioned within 90 days post-cutover\n* Customer satisfaction score improves by 15% within 6 months\n* Average case resolution time decreases by 20% within 6 months\n* Zero data loss during Contact migration (100% validation pass rate)\n* Mobile App feedback submission success rate > 99.5% (including async Case creation)\n\n=== Technical Constraints\n\n* Shared Salesforce instance (Viva Energy multi-tenant environment)\n* Conform to existing Salesforce configuration and governance (data isolation strategy TBD with Salesforce admin team)\n* Contact migration must complete before cutover (no parallel run)\n* Async Case creation mandatory (non-blocking user experience)\n* Expected volume: 100-150 feedback submissions/day from 20k DAU (~0.5-0.75% submission rate), architecture capacity planned for 3x-10x growth\n\n=== Open Technical Decisions (TBD)\n\n* Salesforce Case field mapping for digital feedback categories (App, Service, Order, Rewards, Refund, Delete Account)\n* Salesforce data isolation strategy (Record Types, custom fields, queues)\n* Salesforce REST API authentication method (OAuth 2.0, Connected App, JWT bearer flow)\n* Salesforce webhook mechanism for Case updates (Outbound Messages, Platform Events, Process Builder)\n* Retry policy configuration (attempts, backoff intervals)\n* Salesforce API rate limit strategy (expected volume: 100-150 submissions/day from 20k DAU, capacity planning for 3x-10x growth)\n\n== Technical Requirements\n\n[width=\"100%\",cols=\"8%,92%\",options=\"header\",]\n|===\n|ID |Description\n\n|TR-CS-001\n|Every Mobile App user must have a Salesforce Contact record in Salesforce Service Cloud (shared Viva Energy instance)\n\n|TR-CS-002\n|ProfileService must reconcile Mobile App users as Salesforce Contacts using Just-In-Time (JIT) upsert by email address\n\n|TR-CS-003\n|ProfileService must return Salesforce Contact ID to Mobile App for feedback submission\n\n|TR-CS-004\n|Mobile App must support customer feedback submission with fields: Category (App, Service, Order, Rewards, Refund, Delete Account), Store Name, Time of Visit, Contact Phone Number, Free Text Message\n\n|TR-CS-005\n|EngagementService must create Salesforce Cases asynchronously via Event Bus (non-blocking user experience)\n\n|TR-CS-006\n|EngagementService must acknowledge feedback submission immediately to Mobile App user (\"Feedback submitted\" confirmation)\n\n|TR-CS-007\n|EngagementService must send push notification to customer via Braze when Case is successfully created in Salesforce\n\n|TR-CS-008\n|EngagementService must retry failed Case creation with configurable exponential backoff and dead letter queue for operations team intervention\n\n|TR-CS-009\n|Salesforce must be the System of Record for Contact and Case data (no local persistence in ProfileService or EngagementService)\n\n|TR-CS-010\n|Contact migration from app-specific database to Salesforce must complete before Mobile App cutover (upsert with flexible matching by email/phone/VCI)\n\n|TR-CS-011\n|No Case migration from D365 Customer Engagement to Salesforce (fresh start, historical Cases not migrated)\n\n|TR-CS-012\n|EngagementService must publish domain events (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`) to Event Bus for consumption by other bounded contexts\n\n|TR-CS-013\n|EngagementService must receive Salesforce webhook notifications when Cases are updated/resolved by support agents\n\n|TR-CS-014\n|EngagementService must trigger Braze push notifications to customers when Cases are updated/resolved (via Salesforce webhook → EngagementService → Braze)\n\n|TR-CS-015\n|ProfileService and EngagementService must conform to existing Salesforce configuration and API contracts (Conformist pattern)\n\n|TR-CS-016\n|All changes must be communicated using event-driven architecture via Event Bus (using existing AWS infrastructure: SNS+SQS/EventBridge/Kinesis)\n\n|TR-CS-017\n|Mobile App feedback submission success rate must exceed 99.5% (including async Case creation completion)\n\n|TR-CS-018\n|Contact migration must achieve 100% validation pass rate (zero data loss)\n\n|TR-CS-019\n|D365 Customer Engagement must be fully decommissioned within 90 days post-cutover\n\n|===\n\n== Technical Architecture\n\n=== Technical Capability Requirements\n\n==== Requirements Traceability\n\n[width=\"100%\",cols=\"15%,50%,35%\",options=\"header\",]\n|===\n|Requirement ID |Requirement Summary |Architectural Building Blocks\n\n|TR-CS-001\n|Every Mobile App user must have Salesforce Contact record\n|ABB-CS-001 (ProfileService), ABB-CS-004 (Salesforce), ABB-CS-007 (Contact Migration Tool)\n\n|TR-CS-002\n|ProfileService JIT Contact reconciliation via upsert by email\n|ABB-CS-001 (ProfileService), ABB-CS-004 (Salesforce)\n\n|TR-CS-003\n|ProfileService returns Salesforce Contact ID to Mobile App\n|ABB-CS-001 (ProfileService), ABB-CS-006 (Mobile App)\n\n|TR-CS-004\n|Mobile App supports feedback submission with structured fields\n|ABB-CS-006 (Mobile App), ABB-CS-002 (EngagementService)\n\n|TR-CS-005\n|EngagementService creates Salesforce Cases asynchronously\n|ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus), ABB-CS-004 (Salesforce)\n\n|TR-CS-006\n|EngagementService immediate acknowledgment to Mobile App\n|ABB-CS-002 (EngagementService), ABB-CS-006 (Mobile App)\n\n|TR-CS-007\n|EngagementService sends push notification via Braze on Case creation\n|ABB-CS-002 (EngagementService), ABB-CS-005 (Braze)\n\n|TR-CS-008\n|EngagementService retry logic with exponential backoff and DLQ\n|ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus)\n\n|TR-CS-009\n|Salesforce is System of Record for Contact and Case data\n|ABB-CS-004 (Salesforce), ABB-CS-001 (ProfileService - stateless), ABB-CS-002 (EngagementService - stateless)\n\n|TR-CS-010\n|Contact migration before Mobile App cutover\n|ABB-CS-007 (Contact Migration Tool), ABB-CS-004 (Salesforce)\n\n|TR-CS-011\n|No Case migration from D365 CE (fresh start)\n|ABB-CS-004 (Salesforce) - no migration tooling required\n\n|TR-CS-012\n|EngagementService publishes domain events to Event Bus\n|ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus)\n\n|TR-CS-013\n|EngagementService receives Salesforce webhook notifications\n|ABB-CS-002 (EngagementService), ABB-CS-004 (Salesforce)\n\n|TR-CS-014\n|EngagementService triggers Braze notifications on Case updates\n|ABB-CS-002 (EngagementService), ABB-CS-004 (Salesforce), ABB-CS-005 (Braze)\n\n|TR-CS-015\n|ProfileService and EngagementService conform to Salesforce config\n|ABB-CS-001 (ProfileService), ABB-CS-002 (EngagementService), ABB-CS-004 (Salesforce)\n\n|TR-CS-016\n|Event-driven architecture via Event Bus\n|ABB-CS-003 (Event Bus), ABB-CS-002 (EngagementService)\n\n|TR-CS-017\n|Mobile App feedback submission success rate > 99.5%\n|ABB-CS-006 (Mobile App), ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus), ABB-CS-004 (Salesforce)\n\n|TR-CS-018\n|Contact migration 100% validation pass rate\n|ABB-CS-007 (Contact Migration Tool), ABB-CS-004 (Salesforce)\n\n|TR-CS-019\n|D365 CE decommissioned within 90 days post-cutover\n|All ABBs (replacement system operational)\n\n|===\n\n=== Service Catalogues\n\n==== Application Portfolio Catalogue\n\n[width=\"100%\",cols=\"20%,15%,15%,15%,35%\",options=\"header\",]\n|===\n|Application |Lifecycle State |Owner |Hosting Platform |Description\n\n|*ProfileService*\n|NEW\n|OTR Platform Team\n|AWS (TBD: Lambda/ECS/EKS)\n|JIT Contact reconciliation with Salesforce, returns Salesforce Contact ID, foundation for Flybuys integration\n\n|*EngagementService*\n|NEW\n|OTR Platform Team\n|AWS (TBD: Lambda/ECS/EKS)\n|Customer feedback submission facade, ACL for Salesforce Case creation, Braze integration for all outbound communications (push, email, SMS), webhook receiver\n\n|*Mobile App (iOS)*\n|ACTIVE (UPDATE)\n|OTR Mobile Team\n|Apple App Store\n|iOS native app with feedback form, integrate with ProfileService and EngagementService APIs\n\n|*Mobile App (Android)*\n|ACTIVE (UPDATE)\n|OTR Mobile Team\n|Google Play Store\n|Android native app with feedback form, integrate with ProfileService and EngagementService APIs\n\n|*Salesforce Service Cloud*\n|ACTIVE (EXPAND)\n|Viva Energy Salesforce Admin Team\n|Salesforce (SaaS)\n|Shared Viva Energy instance, System of Record for Contact and Case data, adding OTR digital customer support\n\n|*Braze*\n|ACTIVE (EXTEND)\n|OTR Marketing Team\n|Braze (SaaS)\n|Marketing automation platform, EngagementService triggers push notifications for Case updates\n\n|*D365 Customer Engagement*\n|RETIRE\n|OTR Support Team\n|Microsoft Azure (SaaS)\n|Legacy customer support platform, decommissioned within 90 days post-cutover\n\n|*App-Specific Customer Database*\n|RETIRE\n|OTR Platform Team\n|AWS (RDS/DynamoDB)\n|Legacy customer contact storage, one-time migration to Salesforce, then deprecated\n\n|*Event Bus*\n|NEW\n|OTR Platform Team\n|AWS (SNS+SQS/EventBridge/Kinesis)\n|Domain event publishing infrastructure for bounded context integration\n\n|*Contact Migration Tool*\n|TEMPORARY\n|OTR Platform Team\n|AWS (Script/Lambda)\n|One-time migration app database → Salesforce with upsert logic, retired after migration complete\n\n|===\n\n==== Technology Capability Requirements\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Technology Capability |Implementation Technology (TBD in detailed design) |Requirements\n\n|*Microservice Hosting*\n|AWS Lambda / ECS / EKS\n|Host ProfileService and EngagementService with auto-scaling, high availability, monitoring\n\n|*API Gateway*\n|AWS API Gateway / Application Load Balancer\n|REST API routing, authentication, rate limiting, request validation for ProfileService and EngagementService\n\n|*Event Bus*\n|AWS SNS+SQS / EventBridge / Kinesis\n|Domain event publishing, async message processing, retry logic, dead letter queue\n\n|*Salesforce Integration*\n|Salesforce REST API / SOAP API\n|Contact CRUD operations, Case creation, webhook notifications, OAuth 2.0 authentication\n\n|*Braze Integration*\n|Braze REST API / SDK\n|Push notification campaign triggers, customer profile reconciliation\n\n|*Authentication & Authorisation*\n|Microsoft Entra External ID / AWS Cognito\n|Mobile App user authentication, API authorisation, JWT token validation\n\n|*Observability & Monitoring*\n|AWS CloudWatch / Datadog / New Relic\n|Application metrics, logs, traces, dashboards, alerting (feedback submission rate, queue depth, API errors)\n\n|*Secret Management*\n|AWS Secrets Manager / Parameter Store\n|Salesforce credentials, Braze API keys, OAuth tokens, encryption keys\n\n|*Database (Migration Tool)*\n|AWS RDS / DynamoDB (read-only access)\n|Contact migration from app-specific database\n\n|*CI/CD Pipeline*\n|GitHub Actions / AWS CodePipeline\n|Automated build, test, deployment for ProfileService, EngagementService, Mobile App\n\n|*Infrastructure as Code*\n|Terraform / AWS CloudFormation / CDK\n|Declarative infrastructure provisioning for Event Bus, microservices, monitoring\n\n|*API Documentation*\n|OpenAPI / Swagger\n|ProfileService and EngagementService API specifications for Mobile App integration\n\n|===\n\n==== Feature Flag Register\n\n*Note*: Per ADR-CS-006 (big bang cutover, not phased rollout), feature flags are minimal and used primarily for emergency rollback/kill switches.\n\n[width=\"100%\",cols=\"20%,15%,35%,30%\",options=\"header\",]\n|===\n|Feature Flag |Default State |Purpose |Rollback Scenario\n\n|*enable_salesforce_feedback_submission*\n|OFF (pre-cutover), ON (post-cutover)\n|Enable/disable feedback submission to EngagementService → Salesforce (kill switch for emergency rollback to D365 CE)\n|Feedback submission success rate < 95%, Salesforce API failures, critical bugs - revert to D365 CE integration\n\n|*enable_async_case_creation*\n|ON\n|Enable/disable async Case creation via Event Bus (fallback to synchronous processing if Event Bus issues)\n|Event Bus infrastructure failures, queue backlog unmanageable - temporary synchronous processing\n\n|*enable_braze_notifications*\n|ON\n|Enable/disable Braze push notifications for Case updates (degrade gracefully if Braze integration fails)\n|Braze API failures, notification delivery rate < 80% - disable notifications temporarily\n\n|*enable_jit_contact_reconciliation*\n|ON\n|Enable/disable ProfileService JIT Contact reconciliation (fallback to cached Contact IDs if Salesforce unavailable)\n|Salesforce API downtime, Contact reconciliation failures > 5% - use cached Contact IDs temporarily\n\n|*enable_salesforce_webhook_processing*\n|ON\n|Enable/disable Salesforce webhook processing for Case updates (fallback to polling if webhook failures)\n|Webhook delivery failures, authentication issues - temporary polling fallback\n\n|===\n\n*Feature Flag Management*:\n\n* Feature flags managed via AWS AppConfig / LaunchDarkly / custom feature flag service (TBD in detailed design)\n* Mobile App feature flags controlled server-side (no app release required for flag changes)\n* Backend service feature flags configured via environment variables / configuration service\n* Feature flag changes logged and audited (who changed, when, reason)\n* Post-cutover monitoring: Gradual removal of feature flags once system stability confirmed (30-60 days)\n\n==== Data Entity Catalogue\n\n[width=\"100%\",cols=\"20%,15%,35%,30%\",options=\"header\",]\n|===\n|Data Entity |System of Record |Key Attributes |Lifecycle\n\n|*Contact*\n|Salesforce Service Cloud\n|• Contact ID (Salesforce 15/18-char ID) +\n• Email (primary matching key) +\n• First Name, Last Name +\n• Phone Number +\n• Viva Consumer ID (VCI) +\n• Account (Viva Energy customer account) +\n• Record Type (OTR Digital vs other channels)\n|Created: ProfileService JIT reconciliation or Contact Migration Tool +\nUpdated: ProfileService JIT upsert (email changes), Salesforce (manual updates by support agents) +\nDeleted: Salesforce retention policy (GDPR/compliance)\n\n|*Case*\n|Salesforce Service Cloud\n|• Case Number (Salesforce auto-generated) +\n• Contact ID (reference to Contact) +\n• Subject (derived from Category) +\n• Description (Free Text Message) +\n• Category (App, Service, Order, Rewards, Refund, Delete Account) +\n• Store Name (OTR location) +\n• Time of Visit +\n• Status (New, In Progress, Resolved, Closed) +\n• Priority, Origin (Mobile App) +\n• Owner (support agent/queue)\n|Created: EngagementService async Case creation +\nUpdated: Support agents (Salesforce UI), EngagementService (webhook processing) +\nDeleted: Salesforce retention policy (archive after X years)\n\n|*Feedback Submission (transient)*\n|None (not persisted)\n|• Salesforce Contact ID +\n• Category +\n• Store Name +\n• Time of Visit +\n• Contact Phone Number +\n• Free Text Message\n|Created: Mobile App user submission +\nProcessed: EngagementService publishes to Event Bus, Case created in Salesforce +\nNot persisted in ProfileService/EngagementService (stateless)\n\n|*Domain Events*\n|Event Bus (ephemeral)\n|**SupportCaseCreated**: +\n• Case Number, Contact ID, Category, Timestamp +\n**SupportCaseUpdated**: +\n• Case Number, Status, Updated By, Timestamp +\n**SupportCaseResolved**: +\n• Case Number, Resolution, Resolved By, Timestamp +\n**CustomerFeedbackSubmitted**: +\n• Contact ID, Category, Timestamp\n|Published: EngagementService +\nConsumed: Other bounded contexts (future), Braze notification triggers +\nRetention: Short-lived (minutes to hours), not persisted for event sourcing\n\n|*Braze Customer Profile*\n|Braze\n|• External User ID (VCI or Email) +\n• Push Notification Tokens (iOS/Android) +\n• Notification Preferences +\n• Campaign Engagement History\n|Created/Updated: EngagementService on Case creation/update +\nManaged: Braze (external SaaS)\n\n|===\n\n*Data Migration Entities*:\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Source Entity |Target Entity |Migration Strategy\n\n|*App Database Contact*\n|Salesforce Contact\n|One-time migration via Contact Migration Tool: +\n• Upsert by email (primary), phone (secondary), VCI (tertiary) +\n• Map: Email → Email, Name → First/Last Name, Phone → Phone, VCI → External ID +\n• Validation: 100% data integrity check, reconciliation report\n\n|*D365 CE Case*\n|Not migrated\n|ADR-CS-005: No Case migration (fresh start in Salesforce) +\nD365 CE Cases archived separately for compliance if needed\n\n|===\n\n==== Data Quality & Validation\n\n*Contact Migration Validation Rules*:\n\n* Email format validation (RFC 5322 compliance)\n* Phone number format validation (E.164 international format)\n* VCI format validation (alphanumeric, length constraints)\n* Duplicate detection: Flag potential duplicates for manual review (same email/phone combination)\n* Mandatory fields: Email (required), First Name, Last Name (required for Salesforce Contact)\n\n*Case Creation Validation Rules*:\n\n* Contact ID must exist in Salesforce (validated by EngagementService before Case creation)\n* Category must be one of: App, Service, Order, Rewards, Refund, Delete Account\n* Free Text Message maximum length: 32,000 characters (Salesforce Case Description limit)\n* Store Name validated against OTR location master data (optional - warn if not found)\n\n<<<\n== Solution Building Blocks\n\nThis section defines the specific technology products, configurations, and implementation details for each Solution Building Block (SBB).\n\n=== Technology Portfolio Catalogue\n\n[width=\"100%\",cols=\"10%,20%,25%,25%,20%\",options=\"header\",]\n|===\n|SBB ID |Component |Technology Product |Version/Configuration |Deployment Platform\n\n|SBB-CS-001\n|ProfileService Microservice\n|.NET 8 / Node.js 20 LTS\n|RESTful API, containerised\n|AWS ECS Fargate / Lambda\n\n|SBB-CS-002\n|EngagementService Microservice\n|.NET 8 / Node.js 20 LTS\n|RESTful API, containerised, async workers\n|AWS ECS Fargate / Lambda\n\n|SBB-CS-003\n|Event Bus\n|AWS SNS + SQS / EventBridge\n|Standard queues, FIFO for ordering\n|AWS (managed service)\n\n|SBB-CS-004\n|API Gateway\n|AWS API Gateway / ALB\n|REST API, JWT validation\n|AWS (managed service)\n\n|SBB-CS-005\n|Salesforce Integration Layer\n|Salesforce REST API Client\n|OAuth 2.0 JWT bearer flow\n|Embedded in SBB-CS-001/002\n\n|SBB-CS-006\n|Braze Integration Layer\n|Braze REST API SDK\n|API key authentication\n|Embedded in SBB-CS-002\n\n|SBB-CS-007\n|Contact Migration Tool\n|Python 3.11 / .NET 8\n|One-time batch script\n|AWS Lambda / EC2\n\n|SBB-CS-008\n|Application Monitoring\n|AWS CloudWatch / Datadog\n|Metrics, logs, traces, dashboards\n|AWS / SaaS\n\n|SBB-CS-009\n|Secret Management\n|AWS Secrets Manager\n|KMS encryption\n|AWS (managed service)\n\n|SBB-CS-010\n|Mobile App (iOS)\n|SwiftUI, Kotlin Multiplatform\n|iOS 15+\n|Apple App Store\n\n|SBB-CS-011\n|Mobile App (Android)\n|Jetpack Compose, Kotlin Multiplatform\n|Android 8+\n|Google Play Store\n\n|SBB-CS-012\n|Feature Flag Service\n|AWS AppConfig / LaunchDarkly\n|Server-side flags, real-time updates\n|AWS / SaaS\n\n|===\n\n<<<\n== Data Architecture\n\nThis section defines the physical data models, event schemas, and API request/response formats.\n\n=== Domain Event Schemas\n\nAll domain events follow the https://cloudevents.io/[CloudEvents 1.0] specification for consistency and interoperability.\n\n*Event Schema Specifications*: See // TODO: Add to Antora - specifications/events/engagement-events.json[Engagement Service Event Schemas] for complete JSON schemas and examples.\n\n==== Event Catalogue\n\n[width=\"100%\",cols=\"30%,20%,50%\",options=\"header\",]\n|===\n|Event Type |Publisher |Description\n\n|`SupportCaseCreated`\n|EngagementService\n|Published when EngagementService successfully creates a Case in Salesforce after async processing\n\n|`SupportCaseUpdated`\n|EngagementService (via Salesforce webhook)\n|Published when a support agent updates a Case in Salesforce (status, priority, comment changes)\n\n|`SupportCaseResolved`\n|EngagementService (via Salesforce webhook)\n|Published when a support agent resolves/closes a Case in Salesforce\n\n|`CustomerFeedbackSubmitted`\n|EngagementService\n|Published when customer submits feedback via Mobile App (before async Case creation)\n\n|===\n\n*Event Format*: All events use CloudEvents 1.0 envelope with event-specific payload in the `data` field.\n\n*Schema Location*: `specifications/events/engagement-events.json`\n\n=== API Request/Response Schemas\n\n==== ProfileService: GET /profile/contact-id\n\n*Response* (200 OK):\n[source,json]\n----\n{\n  \"contactId\": \"0034X00000ABCDEFG\",\n  \"email\": \"customer@example.com\",\n  \"firstName\": \"John\",\n  \"lastName\": \"Smith\"\n}\n----\n\n==== EngagementService: POST /feedback\n\n*Request*:\n[source,json]\n----\n{\n  \"contactId\": \"0034X00000ABCDEFG\",\n  \"category\": \"App\",\n  \"storeName\": \"OTR Adelaide\",\n  \"timeOfVisit\": \"2026-01-07T12:00:00Z\",\n  \"contactPhoneNumber\": \"+61412345678\",\n  \"message\": \"App crashed when submitting feedback\"\n}\n----\n\n*Response* (202 Accepted):\n[source,json]\n----\n{\n  \"feedbackId\": \"fb-2026-01-07-12345\",\n  \"status\": \"submitted\",\n  \"message\": \"Your feedback has been submitted!\"\n}\n----\n\n=== Salesforce Field Mappings\n\n==== Case Object Mapping\n\n[width=\"100%\",cols=\"25%,25%,25%,25%\",options=\"header\",]\n|===\n|OTR Field |Salesforce Field |Data Type |Notes\n\n|Category\n|Feedback_Category__c\n|Picklist\n|App, Service, Order, Rewards, Refund, Delete Account\n\n|Store Name\n|Store_Name__c\n|String (255)\n|OTR location name\n\n|Time of Visit\n|Time_of_Visit__c\n|DateTime\n|When customer visited store\n\n|Free Text Message\n|Description\n|Long Text (32,000)\n|Customer feedback message\n\n|===\n\n<<<\n=== Baseline Architecture\n\n==== Existing System Components\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Component |Current State |Status\n\n|*D365 Customer Engagement*\n|Customer support platform for OTR digital customers (Mobile App, Web), handles feedback submission and case management\n|**DEPRECATED** - Being replaced by Salesforce Service Cloud\n\n|*App-Specific Customer Database*\n|Stores customer contact data for Mobile App users, separate from Viva Energy systems\n|**MIGRATING** - One-time migration to Salesforce, then deprecated\n\n|*Mobile App*\n|iOS/Android native apps with feedback submission form including Category, Store Name, Time of Visit, Contact Phone Number, and Free Text Message fields\n|**REQUIRES UPDATE** - Integrate with ProfileService and EngagementService APIs (feedback form UI already complete)\n\n|*Salesforce Service Cloud*\n|Shared Viva Energy instance handling customer support for fuel wholesale, Shell Card customers, other retail channels\n|**EXPANDING** - Adding OTR digital customer support Cases and Contacts\n\n|*Existing AWS Infrastructure*\n|SNS+SQS / EventBridge / Kinesis available for event-driven architecture\n|**REUSING** - Event Bus implementation leverages existing infrastructure\n\n|===\n\n==== Integration Architecture\n\n*Current state:*\n\n* Mobile App → D365 Customer Engagement (direct integration)\n* App-specific customer database → standalone (no Salesforce integration)\n* No event-driven architecture (synchronous, tightly coupled)\n* No Anti-Corruption Layer protecting digital channels\n* Viva Energy support teams use Salesforce, OTR digital support uses D365 CE (fragmented)\n\n==== Technical Debt\n\n*No longer relevant* - D365 CE being deprecated, not documenting technical debt of system being retired.\n\n*New technical debt introduced by this migration:*\n\n* Salesforce field mapping TBD (requires coordination with Viva Energy Salesforce admin team)\n* Data isolation strategy TBD (Record Types, custom fields, queues - multi-tenant governance)\n* Salesforce webhook mechanism TBD (Outbound Messages vs Platform Events vs Process Builder)\n* Expected feedback volume unknown (gathering data for rate limit planning)\n\n=== Gap Analysis\n\n==== Missing Capabilities\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Missing Capability |Description\n\n|*ProfileService bounded context*\n|No existing service for Contact reconciliation with Salesforce - requires new microservice implementing JIT upsert by email, returning Salesforce Contact ID\n\n|*EngagementService bounded context*\n|No existing service for customer feedback facade - requires new microservice implementing Anti-Corruption Layer for Salesforce Case creation, Braze integration, async processing via Event Bus\n\n|*Event Bus domain event pattern*\n|No existing domain event publishing infrastructure - requires implementing event-driven architecture pattern using existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis)\n\n|*Async Case creation workflow*\n|Current D365 CE integration is synchronous - requires implementing async processing with retry logic, exponential backoff, dead letter queue\n\n|*Salesforce webhook integration*\n|No existing capability to receive Salesforce notifications - requires implementing webhook receiver in EngagementService for Case update notifications\n\n|*Braze push notification orchestration*\n|No existing integration for Case-related push notifications - requires implementing Braze campaign triggers from EngagementService\n\n|*Contact migration tooling*\n|No existing tooling for app database → Salesforce Contact migration with upsert logic (match by email/phone/VCI)\n\n|*Feedback form enhancements*\n|Mobile App feedback form lacks structured fields (Category, Store Name, Time of Visit, Contact Phone Number) - requires UI updates\n\n|===\n\n==== Missing Bounded Contexts\n\n[width=\"100%\",cols=\"30%,30%,40%\",options=\"header\",]\n|===\n|Bounded Context |Responsibilities |Implementation Status\n\n|*link:../bounded_context/profile.adoc[ProfileService]*\n|JIT Contact reconciliation with Salesforce (upsert by email), return Salesforce Contact ID to digital channels, foundation for future Flybuys partner linking\n|**NEW** - First bounded context implementation\n\n|*link:../bounded_context/engagement.adoc[EngagementService]*\n|Customer feedback submission facade, Anti-Corruption Layer for Salesforce Case creation, Braze integration for push notifications, async Case processing, webhook receiver for Case updates\n|**NEW** - First bounded context implementation\n\n|===\n\n==== Missing Integration Patterns\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Integration Pattern |Description\n\n|*Anti-Corruption Layer (ACL)*\n|EngagementService → Salesforce Service Cloud - protects digital channels from Salesforce API changes, translates between OTR domain language and Salesforce\n\n|*Conformist*\n|ProfileService/EngagementService → Salesforce - conform to existing Salesforce configuration and API contracts (shared Viva Energy instance)\n\n|*Event-Driven Architecture (OHS+PL)*\n|Event Bus publishing domain events (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`) for loose coupling between bounded contexts\n\n|*Just-In-Time (JIT) Integration*\n|ProfileService → Salesforce Contact reconciliation on-demand (no pre-sync)\n\n|*Async Processing*\n|EngagementService Case creation via Event Bus with retry, exponential backoff, dead letter queue\n\n|===\n\n=== Target State Architecture\n\n==== Architectural Building Blocks (ABB)\n\n[width=\"100%\",cols=\"20%,25%,30%,25%\",options=\"header\",]\n|===\n|ABB ID |Bounded Context |Responsibilities |Technology (TBD in Solution Architecture)\n\n|ABB-CS-001\n|*link:../bounded_context/profile.adoc[ProfileService]*\n|JIT Contact reconciliation with Salesforce (upsert by email), return Salesforce Contact ID, foundation for Flybuys partner linking\n|Microservice (.NET/Node.js), REST API, Salesforce REST API client\n\n|ABB-CS-002\n|*link:../bounded_context/engagement.adoc[EngagementService]*\n|Customer feedback submission facade, ACL for Salesforce Case creation, Braze integration, async processing, webhook receiver\n|Microservice (.NET/Node.js), REST API, Event Bus publisher/subscriber, Salesforce webhook receiver\n\n|ABB-CS-003\n|*Event Bus*\n|Domain event publishing infrastructure (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`)\n|AWS SNS+SQS / EventBridge / Kinesis\n\n|ABB-CS-004\n|*Salesforce Service Cloud*\n|System of Record for Contact and Case data (shared Viva Energy instance)\n|Salesforce Service Cloud (external SaaS)\n\n|ABB-CS-005\n|*Braze*\n|Marketing automation platform for push notifications\n|Braze (external SaaS) - existing integration\n\n|ABB-CS-006\n|*Mobile App*\n|iOS/Android native apps with enhanced feedback form (Category, Store Name, Time of Visit, Contact Phone Number, Free Text Message)\n|Kotlin Multiplatform, SwiftUI, Jetpack Compose\n\n|ABB-CS-007\n|*Contact Migration Tool*\n|One-time migration app database → Salesforce with upsert logic (match by email/phone/VCI)\n|Script/tool (.NET/Python/Node.js)\n\n|===\n\n==== Integration Architecture\n\n===== Integration Flows\n\n*Customer Feedback Submission (Async):*\n\n1. *Mobile App* → ProfileService: Authenticate user, get Salesforce Contact ID (JIT reconciliation)\n2. *Mobile App* → EngagementService: Submit feedback (POST /feedback with Contact ID, Category, Store Name, Time of Visit, Phone, Message)\n3. *EngagementService* → Mobile App: Immediate acknowledgment (\"Feedback submitted\")\n4. *EngagementService* → Event Bus: Publish work item for async Case creation\n5. *Background Worker* (EngagementService) → Salesforce: Create Case via REST API\n6. *Success*: EngagementService → Event Bus: Publish `SupportCaseCreated` event\n7. *EngagementService* → Braze: Trigger push notification campaign (\"Your feedback has been received, Case #12345\")\n8. *Failure*: Retry with exponential backoff → Dead Letter Queue → Ops team alert\n\n*Case Update Notification (Bidirectional):*\n\n1. *Support Agent* updates/resolves Case in Salesforce\n2. *Salesforce* → EngagementService: Webhook notification (Case updated)\n3. *EngagementService* → Event Bus: Publish `SupportCaseUpdated` or `SupportCaseResolved` event\n4. *EngagementService* → Braze: Trigger push notification campaign (\"Your case has been resolved\")\n\n*Contact Reconciliation (JIT):*\n\n1. *Mobile App user* authenticates\n2. *Mobile App* → ProfileService: GET /profile/contact-id\n3. *ProfileService* → Salesforce: Query Contact by email\n4. *Match found*: Return existing Salesforce Contact ID\n5. *No match*: Create new Contact in Salesforce, return new Contact ID\n6. *ProfileService* → Mobile App: Return Salesforce Contact ID (cached by Mobile App)\n\n===== System of Record Boundaries\n\n[width=\"100%\",cols=\"30%,35%,35%\",options=\"header\",]\n|===\n|Data Entity |System of Record |Rationale\n\n|*Contact*\n|Salesforce Service Cloud\n|Shared Viva Energy instance, unified customer profile across all channels (digital, wholesale, Shell Card, retail)\n\n|*Case*\n|Salesforce Service Cloud\n|Support agents manage Cases in Salesforce, digital channels submit via EngagementService ACL\n\n|*Feedback Submission (transient)*\n|None (no persistence)\n|EngagementService processes feedback and creates Case in Salesforce, no local storage\n\n|*Domain Events*\n|Event Bus (ephemeral)\n|Events published to Event Bus, consumed by subscribers, not persisted long-term (event sourcing not in scope)\n\n|===\n\n==== Data Architecture Principles\n\n===== Aggregate Persistence\n\n*ProfileService:*\n\n* **No local aggregate persistence** - ProfileService is stateless, queries Salesforce on-demand\n* Salesforce Contact is the aggregate root (owned by Salesforce)\n* ProfileService acts as facade/translator, not system of record\n\n*EngagementService:*\n\n* **No local aggregate persistence** - EngagementService is stateless, creates Cases in Salesforce via ACL\n* Salesforce Case is the aggregate root (owned by Salesforce)\n* EngagementService maintains no local Case state (Conformist pattern - trust Salesforce as source of truth)\n* Async processing state managed via Event Bus (work items in queue, not database)\n\n===== Event Store\n\n* **Event Bus** (SNS+SQS/EventBridge/Kinesis) handles domain event publishing\n* Events are **ephemeral** (consumed and discarded, not persisted for event sourcing)\n* No Event Store implementation in this architecture (future enhancement if needed)\n* Event schema versioning TBD in Solution Architecture\n\n\n=== Architecture Decisions\n\n==== ADR-CS-001: Consolidate onto Salesforce Service Cloud (not build custom solution)\n\n*Status*: Accepted\n\n*Context*:\n\n* D365 Customer Engagement not working well for digital customer support\n* Viva Energy already uses Salesforce Service Cloud for fuel wholesale, Shell Card, other retail channels\n* Post-merger opportunity to consolidate onto single platform\n* Alternative: Build custom support platform or use different SaaS\n\n*Decision*:\n\nConsolidate OTR digital customer support onto Salesforce Service Cloud (shared Viva Energy instance).\n\n*Rationale*:\n\n* **Unified customer view**: Support agents see all interactions across channels (digital, wholesale, Shell Card, retail)\n* **Platform consolidation**: Single support platform reduces operational overhead and costs\n* **Proven solution**: Salesforce Service Cloud is established, feature-rich, well-supported\n* **Post-merger alignment**: Strategic decision to standardize on Viva Energy platforms\n* **Avoid custom development**: Building custom support platform would be costly and high-risk\n\n*Consequences*:\n\n* Unified customer support across Viva Energy Group\n* Reduced operational complexity (single platform vs two)\n* Leverage Salesforce capabilities (case routing, knowledge base, AI, omnichannel)\n* ⚠️ Conformist pattern required (shared instance, conform to existing configuration)\n* ⚠️ Multi-tenant governance needed (data isolation, security, queues)\n* ❌ Less control over platform evolution (SaaS vendor, shared instance)\n\n==== ADR-CS-002: Implement ProfileService and EngagementService as first DDD bounded contexts\n\n*Status*: Accepted\n\n*Context*:\n\n* OTR target architecture uses Domain-Driven Design with bounded contexts\n* This migration is opportunity to establish first implementation\n* Alternative: Direct Mobile App → Salesforce integration (no bounded contexts)\n* Alternative: Single monolithic service for all customer-facing APIs\n\n*Decision*:\n\nImplement ProfileService and EngagementService as separate bounded contexts following DDD strategic patterns.\n\n*Rationale*:\n\n* **Foundation for target architecture**: First implementation of DDD pattern for future bounded contexts (Flybuys, LocationService, PaymentService)\n* **Separation of concerns**: ProfileService handles identity/Contact reconciliation, EngagementService handles support/feedback (different responsibilities, different change rates)\n* **Anti-Corruption Layer**: EngagementService protects digital channels from Salesforce API changes\n* **Reusability**: ProfileService Contact reconciliation reused for Flybuys integration\n* **Event-driven architecture**: Establishes pattern for loose coupling between bounded contexts\n\n*Consequences*:\n\n* Establishes DDD architecture foundation for OTR\n* Reusable ProfileService for Flybuys and future integrations\n* Digital channels protected from Salesforce API changes (ACL)\n* Clear bounded context boundaries and responsibilities\n* ⚠️ Increased initial complexity (two new microservices vs direct integration)\n* ⚠️ Requires Event Bus infrastructure implementation\n* ⚠️ Team must learn DDD patterns and bounded context design\n\n==== ADR-CS-003: Async Case creation via Event Bus (not synchronous)\n\n*Status*: Accepted\n\n*Context*:\n\n* Current D365 CE integration is synchronous (user waits for Case creation)\n* Alternative: Keep synchronous integration (Mobile App → EngagementService → Salesforce synchronously)\n* Salesforce API may experience downtime or latency\n\n*Decision*:\n\nImplement async Case creation via Event Bus with immediate user acknowledgment, retry logic, exponential backoff, and dead letter queue.\n\n*Rationale*:\n\n* **Non-blocking user experience**: User gets immediate \"Feedback submitted\" confirmation, not waiting for Salesforce API\n* **Resilience**: If Salesforce is down, feedback still accepted, Case created when Salesforce recovers\n* **Retry logic**: Automatic retry with exponential backoff handles transient failures\n* **Operational visibility**: Dead letter queue alerts ops team to persistent failures\n* **Scalability**: Queue buffering handles traffic spikes\n\n*Consequences*:\n\n* Better user experience (no waiting for Salesforce API)\n* Resilient to Salesforce downtime (queue buffers work)\n* Automatic retry reduces manual intervention\n* Queue depth monitoring provides operational visibility\n* ⚠️ Eventual consistency (user gets success notification after Case created, not immediately)\n* ⚠️ Increased complexity (Event Bus, background workers, retry logic, DLQ)\n* ⚠️ Requires monitoring and alerting for DLQ\n\n==== ADR-CS-004: ProfileService uses email as primary matching key (not VCI)\n\n*Status*: Accepted\n\n*Context*:\n\n* ProfileService needs to reconcile Mobile App users as Salesforce Contacts\n* Alternative matching keys: VCI (Viva Consumer ID), email, phone, Salesforce External ID\n* Email changes are rare but possible\n\n*Decision*:\n\nUse email address as primary matching key for Contact reconciliation (JIT upsert by email).\n\n*Rationale*:\n\n* **Availability**: Email always available for authenticated users\n* **Uniqueness**: Email is unique identifier in Salesforce and Mobile App\n* **Salesforce standard**: Salesforce Contact uses email as standard lookup field\n* **Simplicity**: Single matching key simplifies upsert logic\n* **Edge case acceptable**: Email changes are rare, manual cleanup acceptable\n\n*Consequences*:\n\n* Simple upsert logic (query by email, create if not found)\n* Leverages Salesforce standard email field\n* Email always available from authentication\n* ⚠️ Email changes create duplicate Contacts (rare edge case, manual cleanup)\n* ⚠️ Future enhancement: Add VCI as Salesforce External ID for stable matching\n\n==== ADR-CS-005: No Case migration from D365 CE (fresh start)\n\n*Status*: Accepted\n\n*Context*:\n\n* D365 CE contains historical customer support Cases\n* Alternative: Migrate historical Cases to Salesforce (preserve support history)\n* Alternative: Archive D365 CE Cases separately (read-only access)\n\n*Decision*:\n\nDo not migrate historical Cases from D365 CE to Salesforce. Start fresh in Salesforce.\n\n*Rationale*:\n\n* **Limited value**: Historical D365 CE Cases not critical for future support\n* **Data quality**: D365 CE Case data may be inconsistent or incomplete\n* **Complexity**: Case migration requires mapping D365 CE schema to Salesforce, data transformation, validation\n* **Cost-benefit**: Migration effort outweighs value of historical data\n* **Archive option**: D365 CE Cases can be archived separately if needed (read-only access for auditing)\n\n*Consequences*:\n\n* Simpler migration (Contacts only, no Case migration)\n* Faster time to value (no Case migration delay)\n* Clean start in Salesforce (no legacy data quality issues)\n* ⚠️ Historical Cases not visible in Salesforce (support agents can't see old Cases)\n* ⚠️ D365 CE must remain accessible temporarily for historical Case lookups (if needed)\n* ❌ Loss of historical Case insights (reporting, analytics on old Cases)\n\n==== ADR-CS-006: Big bang cutover (not phased rollout)\n\n*Status*: Accepted\n\n*Context*:\n\n* Alternative: Phased rollout with feature flags (pilot users first, gradual enablement)\n* Alternative: Parallel run (submit to both D365 CE and Salesforce temporarily)\n* Flybuys integration uses phased rollout (AS-1, AS-2, AS-3 architecture states)\n\n*Decision*:\n\nBig bang cutover - migrate Contacts, deploy ProfileService and EngagementService, switch Mobile App, retire D365 CE.\n\n*Rationale*:\n\n* **Simplicity**: No parallel run complexity, no feature flag management\n* **Faster D365 CE retirement**: No extended transition period maintaining two systems\n* **Limited risk**: Customer support not mission-critical (not payment processing), rollback possible\n* **User base manageable**: OTR digital customers smaller than Flybuys integration scope\n* **Different use case**: Flybuys phased rollout manages points accrual complexity, support feedback is simpler\n\n*Consequences*:\n\n* Simpler deployment (single cutover, no AS-1/AS-2/AS-3 states)\n* Faster D365 CE retirement (no extended parallel run)\n* No feature flag complexity or pilot user management\n* ⚠️ Higher cutover risk (all users switch at once)\n* ⚠️ Requires comprehensive testing before cutover\n* ⚠️ Rollback plan required (revert to D365 CE if critical issues)\n\n==== ADR-CS-007: EngagementService receives Salesforce webhooks for Case updates\n\n*Status*: Accepted\n\n*Context*:\n\n* Support agents update/resolve Cases in Salesforce\n* Need to notify customers of Case status changes via push notifications\n* Alternative: Poll Salesforce API for Case updates (inefficient)\n* Alternative: No customer notifications (agents contact customers directly)\n\n*Decision*:\n\nSalesforce sends webhook notifications to EngagementService when Cases are updated/resolved. EngagementService triggers Braze push notifications.\n\n*Rationale*:\n\n* **Real-time notifications**: Customer notified immediately when agent resolves Case\n* **Efficient**: Webhook push model (not polling)\n* **Event-driven**: Aligns with event-driven architecture pattern\n* **Better customer experience**: Proactive notification vs waiting for agent contact\n\n*Consequences*:\n\n* Real-time customer notifications for Case updates\n* Efficient push model (no polling overhead)\n* Bidirectional integration (Mobile App → Salesforce → Mobile App)\n* ⚠️ Salesforce webhook mechanism TBD (Outbound Messages vs Platform Events vs Process Builder)\n* ⚠️ Webhook authentication and security required\n* ⚠️ EngagementService must handle webhook retries and failures\n\n<<<\n== Interface Specifications\n\nThis section provides references to the complete API specifications and event catalogue for ProfileService and EngagementService.\n\n=== REST API Specifications\n\nComplete OpenAPI 3.0 specifications are maintained in the `specifications/rest/` directory:\n\n==== ProfileService API v1\n\n*Specification*: link:../../specifications/rest/profile-service-v1.yaml[profile-service-v1.yaml]\n\n*Base URL*: `https://api.otr.com.au/profile/v1`\n\n*Authentication*: Bearer token (Microsoft Entra External ID JWT)\n\n*Key Endpoints*:\n\n* `GET /contact-id` - Retrieve or create Salesforce Contact ID for authenticated user (Just-In-Time reconciliation)\n** Used by Mobile App before submitting feedback to EngagementService\n** Upserts Salesforce Contact record using email as external key\n** Returns 18-character Salesforce Contact ID with caching (15-minute TTL)\n** Performance SLA: p95 < 300ms (uncached), p95 < 50ms (cached)\n\n==== EngagementService API v1\n\n*Specification*: link:../../specifications/rest/engagement-service-v1.yaml[engagement-service-v1.yaml]\n\n*Base URL*: `https://api.otr.com.au/engagement/v1`\n\n*Authentication*: Bearer token (Microsoft Entra External ID JWT)\n\n*Key Endpoints*:\n\n* `POST /feedback` - Submit customer feedback for async Case creation in Salesforce\n** Accepts contactId, category, storeName, timeOfVisit, contactPhoneNumber, message\n** Returns 202 Accepted immediately (async Case creation in background)\n** Publishes `CustomerFeedbackSubmitted` event for analytics\n** Creates Salesforce Case via Anti-Corruption Layer with retry logic\n** Performance SLA: p95 < 200ms (feedback accepted, not Case creation)\n\n=== Domain Events (AsyncAPI)\n\nComplete CloudEvents 1.0 JSON Schema specifications are maintained in the `specifications/events/` directory:\n\n*Specification*: link:../../specifications/events/engagement-events.json[engagement-events.json]\n\n==== Event Catalogue\n\n[width=\"100%\",cols=\"30%,20%,50%\",options=\"header\",]\n|===\n|Event Type |Publisher |Consumers\n\n|`CustomerFeedbackSubmitted`\n|EngagementService\n|Future bounded contexts, analytics, sentiment analysis\n\n|`SupportCaseCreated`\n|EngagementService\n|Future bounded contexts, analytics\n\n|`SupportCaseUpdated`\n|EngagementService (via Salesforce webhook)\n|Future bounded contexts, analytics\n\n|`SupportCaseResolved`\n|EngagementService (via Salesforce webhook)\n|Future bounded contexts, analytics\n\n|===\n\n==== Event Delivery Guarantees\n\n* **At-least-once delivery**: Events may be delivered multiple times, consumers must handle idempotency\n* **Ordering**: FIFO queues guarantee ordering for events with same `contactId`\n* **Retention**: 4 days (96 hours) in Event Bus\n* **Dead Letter Queue**: Failed events after 5 retries moved to DLQ for manual intervention\n* **Format**: CloudEvents 1.0 specification with JSON payload\n\n=== API Versioning Policy\n\n==== Version Numbering\n\n* **Format**: `/v{major}` in URL path (e.g., `/profile/v1`, `/engagement/v1`)\n* **Semantic Versioning**: Major version incremented for breaking changes only\n* **Backwards Compatibility**: Minor changes (new optional fields, new endpoints) don't require version bump\n\n==== When to Version\n\n*Breaking changes requiring new major version*:\n\n- Removing or renaming fields in request/response\n- Changing field data types (e.g., string → number)\n- Changing authentication mechanism\n- Removing endpoints\n\n*Non-breaking changes not requiring version bump*:\n\n- Adding new optional fields to request/response\n- Adding new endpoints\n- Expanding enum values (e.g., adding new feedback category)\n- Improving error messages\n\n==== Parallel Version Support\n\n* Support N and N-1 versions concurrently for 6 months\n* Deprecation notice: 3 months before sunsetting old version\n* Mobile App must upgrade to new version within deprecation window\n\n<<<\n== Work Packages\n\nThis section consolidates gaps and activities into implementable work packages aligned with TOGAF Phase E requirements.\n\n=== Work Package Overview\n\n[width=\"100%\",cols=\"15%,35%,25%,25%\",options=\"header\",]\n|===\n|Work Package ID |Name |Transition State |Key Deliverables\n\n|WP-CS-001\n|ProfileService Development\n|TS-1 (Build & Test)\n|ProfileService microservice, Salesforce Contact integration, REST API\n\n|WP-CS-002\n|EngagementService Development\n|TS-1 (Build & Test)\n|EngagementService microservice, Anti-Corruption Layer, Braze integration\n\n|WP-CS-003\n|Event Bus Infrastructure\n|TS-1 (Build & Test)\n|Event Bus configuration, CloudEvents schemas, monitoring\n\n|WP-CS-004\n|Contact Migration Tooling\n|TS-1 (Build & Test)\n|Migration tool, validation scripts, reconciliation reporting\n\n|WP-CS-005\n|Mobile App Integration\n|TS-1 (Build & Test)\n|Mobile App API integration, feedback form enhancements, testing\n\n|WP-CS-006\n|Integration Testing\n|TS-1 (Build & Test)\n|Test environments, integration test suites, UAT execution\n\n|WP-CS-007\n|Salesforce Configuration\n|TS-1 (Build & Test)\n|Salesforce field mapping, data isolation, webhook configuration\n\n|WP-CS-008\n|Contact Data Migration\n|TS-2 (Contact Migration)\n|Contact migration execution, validation, reconciliation\n\n|WP-CS-009\n|Production Deployment\n|TS-3 (Cutover)\n|Production deployment, smoke testing, go-live execution\n\n|WP-CS-010\n|Post-Cutover Support\n|TS-4 (Target State)\n|Monitoring, issue resolution, D365 CE retirement\n\n|===\n\n[[wp-cs-001]]\n=== WP-CS-001: ProfileService Development\n\n==== Description\n\nBuild ProfileService bounded context microservice implementing Just-In-Time Contact reconciliation with Salesforce Service Cloud.\n\n==== Deliverables\n\n* ProfileService microservice application\n** REST API implementation (OpenAPI 3.0 specification)\n** `GET /contact-id` endpoint (Salesforce Contact reconciliation)\n** Authentication/authorization with Microsoft Entra External ID\n** Caching layer (15-minute TTL for Contact IDs)\n* Salesforce integration\n** Salesforce REST API client\n** Contact upsert by email (external key matching)\n** Error handling and retry logic\n* Unit tests (>80% code coverage)\n* Integration tests with Salesforce sandbox\n* API documentation\n* Deployment configuration (IaC - Infrastructure as Code)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* Salesforce sandbox environment provisioned\n* Microsoft Entra External ID OAuth configuration\n* Development environment setup (AWS dev account, CI/CD pipeline)\n\n*Dependent Work Packages*:\n\n* None (can start immediately after prerequisites met)\n\n==== Skills Required\n\n* Backend development (.NET Core or Node.js)\n* REST API design and implementation\n* Salesforce REST API integration\n* OAuth 2.0 / JWT authentication\n* Caching strategies (Redis/ElastiCache)\n* Unit/integration testing frameworks\n* Infrastructure as Code (Terraform/CloudFormation)\n\n==== Acceptance Criteria\n\n* All API endpoints return correct HTTP status codes per OpenAPI specification\n* Contact ID retrieval achieves p95 < 300ms (uncached), p95 < 50ms (cached)\n* Salesforce Contact upsert succeeds with 100% accuracy in sandbox testing\n* Unit test coverage > 80%\n* Integration tests pass in sandbox environment\n* API documentation generated from OpenAPI specification\n\n[[wp-cs-002]]\n=== WP-CS-002: EngagementService Development\n\n==== Description\n\nBuild EngagementService bounded context microservice implementing customer feedback submission, Anti-Corruption Layer for Salesforce Case creation, Braze integration, and webhook receiver for Case updates.\n\n==== Deliverables\n\n* EngagementService microservice application\n** REST API implementation (OpenAPI 3.0 specification)\n** `POST /feedback` endpoint (async feedback submission)\n** Authentication/authorization with Microsoft Entra External ID\n** Webhook receiver endpoint for Salesforce Case updates\n* Anti-Corruption Layer (ACL)\n** OTR domain model to Salesforce API translation\n** Category enum mapping (App/Service/Order/Rewards → Salesforce Case fields)\n** Salesforce REST API client for Case creation\n* Async processing infrastructure\n** Event Bus publisher integration\n** Background worker for Case creation\n** Retry logic with exponential backoff (5 attempts)\n** Dead Letter Queue integration\n* Braze integration\n** Braze campaign trigger API client\n** Push notification orchestration for Case updates\n* Domain event publishing\n** `CustomerFeedbackSubmitted` event publisher\n** `SupportCaseCreated` event publisher\n** `SupportCaseUpdated` event translator (Salesforce webhook → domain event)\n** `SupportCaseResolved` event translator (Salesforce webhook → domain event)\n* Unit tests (>80% code coverage)\n* Integration tests (EngagementService ↔ Salesforce, EngagementService ↔ Braze)\n* API documentation\n* Deployment configuration (IaC)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-003 (Event Bus Infrastructure) completed\n* Salesforce sandbox environment provisioned\n* Braze API credentials and campaign templates configured\n* Microsoft Entra External ID OAuth configuration\n\n*Dependent Work Packages*:\n\n* WP-CS-003 must be completed first (Event Bus required for async processing)\n* WP-CS-007 (Salesforce Configuration) must be in progress (field mapping needed)\n\n==== Skills Required\n\n* Backend development (.NET Core or Node.js)\n* REST API design and implementation\n* Salesforce REST API integration\n* Event-driven architecture patterns\n* Async/background processing (queues, workers)\n* Braze API integration\n* Webhook design and security\n* OAuth 2.0 / JWT authentication\n* Domain-Driven Design (DDD) - Anti-Corruption Layer pattern\n* Unit/integration testing frameworks\n* Infrastructure as Code (Terraform/CloudFormation)\n\n==== Acceptance Criteria\n\n* Feedback submission endpoint returns 202 Accepted within p95 < 200ms\n* Async Case creation succeeds with >99.5% success rate (including retries)\n* Anti-Corruption Layer correctly maps all feedback categories to Salesforce Case fields\n* Webhook receiver processes Salesforce Case updates and publishes domain events\n* Braze push notifications sent successfully for Case updates\n* Failed Case creation moves to Dead Letter Queue after 5 retry attempts\n* Unit test coverage > 80%\n* Integration tests pass with Salesforce sandbox and Braze staging environment\n\n[[wp-cs-003]]\n=== WP-CS-003: Event Bus Infrastructure\n\n==== Description\n\nImplement Event Bus infrastructure for domain event publishing using existing AWS infrastructure (SNS+SQS, EventBridge, or Kinesis).\n\n==== Deliverables\n\n* Event Bus infrastructure configuration\n** Topic/stream provisioning (technology choice: SNS+SQS / EventBridge / Kinesis)\n** FIFO queue configuration (ordering by `contactId`)\n** Dead Letter Queue (DLQ) setup\n** Retention policy (4 days / 96 hours)\n** Access control policies (IAM roles, permissions)\n* CloudEvents 1.0 schema definitions\n** JSON Schema specifications for all domain events\n** Schema validation configuration\n** Schema registry (if using EventBridge/Kinesis)\n* Monitoring and alerting\n** CloudWatch dashboards for queue metrics\n** Alarms for DLQ depth, queue age, processing failures\n** Event Bus throughput monitoring\n* Documentation\n** Event Bus architecture diagram\n** Event publishing guidelines\n** Consumer integration guide\n* Infrastructure as Code (IaC)\n** Terraform/CloudFormation templates for all infrastructure\n\n==== Dependencies\n\n*Prerequisites*:\n\n* AWS account access (existing infrastructure)\n* Technology selection decision (SNS+SQS vs EventBridge vs Kinesis)\n* CloudEvents 1.0 schema design approval\n\n*Dependent Work Packages*:\n\n* None (foundational infrastructure, can start early)\n\n==== Skills Required\n\n* AWS messaging services (SNS, SQS, EventBridge, Kinesis)\n* Event-driven architecture patterns\n* CloudEvents specification\n* JSON Schema design\n* Infrastructure as Code (Terraform/CloudFormation)\n* AWS IAM security configuration\n* CloudWatch monitoring and alerting\n\n==== Acceptance Criteria\n\n* Event Bus infrastructure provisioned in all environments (dev, staging, production)\n* FIFO ordering validated for events with same `contactId`\n* Dead Letter Queue triggers alarms when messages arrive\n* Event retention policy enforced (4 days)\n* CloudEvents 1.0 schema validation enabled\n* Monitoring dashboards operational\n* Infrastructure fully codified (IaC)\n\n[[wp-cs-004]]\n=== WP-CS-004: Contact Migration Tooling\n\n==== Description\n\nDevelop Contact migration tool for one-time migration from app-specific database to Salesforce Service Cloud with upsert logic and validation.\n\n==== Deliverables\n\n* Contact migration tool\n** Extract Contacts from app-specific database\n** Transform to Salesforce Contact API format\n** Upsert to Salesforce using email as external key\n** Fallback matching by phone number or Viva Consumer ID\n** Batch processing with rate limiting (respect Salesforce API limits)\n** Idempotent operation (can be re-run safely)\n* Validation scripts\n** Pre-migration validation (data quality checks)\n** Post-migration validation (100% Contact reconciliation)\n** Email/phone/VCI matching accuracy report\n* Reconciliation reporting\n** Contacts created vs updated statistics\n** Failed upserts with error details\n** Matching accuracy metrics\n* Rollback capability\n** Export snapshot of Salesforce Contacts before migration\n** Rollback procedure documentation\n* Documentation\n** Migration tool user guide\n** Troubleshooting guide\n** Runbook for migration execution\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-001 (ProfileService Development) completed (reuses Salesforce integration code)\n* Salesforce sandbox environment for migration testing\n* App-specific database access (read-only sufficient)\n* Salesforce production access granted\n\n*Dependent Work Packages*:\n\n* WP-CS-001 provides Salesforce Contact upsert logic to reuse\n\n==== Skills Required\n\n* Database development (SQL, data extraction)\n* Salesforce REST API integration\n* Batch processing and ETL patterns\n* Data validation and reconciliation\n* Error handling and logging\n* Scripting (Python, PowerShell, or similar)\n\n==== Acceptance Criteria\n\n* Migration tool successfully migrates 100% of Contacts in sandbox with zero data loss\n* Email/phone/VCI matching accuracy > 95% in sandbox testing\n* Failed upserts captured with actionable error messages\n* Reconciliation report matches actual Salesforce Contact counts\n* Migration tool execution time acceptable for production (freezes app database for minimum time)\n* Rollback procedure validated in sandbox\n* Documentation complete and approved\n\n[[wp-cs-005]]\n=== WP-CS-005: Mobile App Integration\n\n==== Description\n\nUpdate Mobile App to integrate with ProfileService and EngagementService APIs, replacing D365 CE integration.\n\n==== Deliverables\n\n* Feedback form UI enhancements\n** Add Category dropdown (App, Service, Order, Rewards, Refund, Delete Account)\n** Add Store Name field (optional)\n** Add Time of Visit field (optional, datetime picker)\n** Add Contact Phone Number field (optional, E.164 validation)\n** Update Message field (1-2000 character limit with counter)\n* API integration (Kotlin Multiplatform shared code)\n** ProfileService client (`GET /contact-id`)\n** EngagementService client (`POST /feedback`)\n** JWT token management (Microsoft Entra External ID)\n** Error handling (network failures, API errors, validation errors)\n** Retry logic for transient failures\n* Platform-specific UI (SwiftUI for iOS, Jetpack Compose for Android)\n** Feedback form screens\n** Success/error confirmation screens\n** Loading states and progress indicators\n* Feature flag integration\n** `enable_salesforce_feedback_submission` flag\n** Fallback to D365 CE if flag disabled (during rollout)\n* Unit tests for shared business logic\n* UI tests for platform-specific screens\n* API integration tests (mocked APIs)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-001 (ProfileService Development) completed and deployed to dev/staging\n* WP-CS-002 (EngagementService Development) completed and deployed to dev/staging\n* ProfileService and EngagementService OpenAPI specifications finalized\n* Feature flag service configured\n\n*Dependent Work Packages*:\n\n* Must complete after WP-CS-001 and WP-CS-002 (requires API endpoints available for integration testing)\n\n==== Skills Required\n\n* Kotlin Multiplatform development\n* SwiftUI (iOS native UI)\n* Jetpack Compose (Android native UI)\n* REST API client development\n* OAuth 2.0 / JWT authentication\n* Form validation and UX design\n* Unit testing (Kotlin, Swift)\n* UI testing frameworks (XCTest, Espresso)\n\n==== Acceptance Criteria\n\n* Feedback form UI matches UX design specifications\n* All form fields validate correctly (client-side validation)\n* API integration successfully calls ProfileService and EngagementService in dev/staging\n* Error handling provides user-friendly error messages\n* Feature flag correctly toggles between Salesforce and D365 CE integration\n* Unit test coverage > 80% for shared business logic\n* UI tests pass for all feedback form workflows (happy path, error states)\n* App builds and deploys successfully to TestFlight (iOS) and Google Play Internal Testing (Android)\n\n[[wp-cs-006]]\n=== WP-CS-006: Integration Testing\n\n==== Description\n\nExecute comprehensive integration testing across all system components in non-production environments.\n\n==== Deliverables\n\n* Test environment setup\n** Salesforce sandbox configured with test data\n** ProfileService deployed to staging\n** EngagementService deployed to staging\n** Event Bus staging infrastructure\n** Braze staging environment configured\n** Mobile App TestFlight/Internal Testing builds\n* Integration test suites\n** ProfileService ↔ Salesforce (Contact upsert scenarios)\n** EngagementService ↔ Salesforce (Case creation scenarios)\n** EngagementService ↔ Braze (push notification scenarios)\n** Mobile App ↔ ProfileService ↔ EngagementService (end-to-end workflows)\n** Event Bus publishing and consumption\n** Webhook receiver (Salesforce → EngagementService)\n* Test scenarios\n** Happy path: Successful feedback submission and Case creation\n** Error scenarios: Salesforce API failures, Braze API failures, network timeouts\n** Retry scenarios: Async Case creation retries, DLQ validation\n** Performance testing: p95 latency validation for ProfileService and EngagementService\n** Load testing: Simulate 3x-10x expected volume\n* UAT execution\n** Business stakeholder UAT sessions\n** UAT test cases covering all feedback categories\n** UAT sign-off documentation\n* Test results documentation\n** Test execution reports\n** Defect tracking and resolution\n** Performance test results\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-001 (ProfileService Development) completed\n* WP-CS-002 (EngagementService Development) completed\n* WP-CS-003 (Event Bus Infrastructure) completed\n* WP-CS-005 (Mobile App Integration) completed\n* WP-CS-007 (Salesforce Configuration) sandbox configuration completed\n\n*Dependent Work Packages*:\n\n* Must complete after WP-CS-001, WP-CS-002, WP-CS-003, WP-CS-005 (requires all components available)\n\n==== Skills Required\n\n* Integration testing strategy and execution\n* Test automation frameworks (Postman, Newman, Selenium)\n* Performance testing tools (JMeter, k6, Gatling)\n* Salesforce sandbox administration\n* Test data management\n* Defect tracking and triage\n* UAT facilitation\n\n==== Acceptance Criteria\n\n* All integration test scenarios pass (happy path, error scenarios, retry scenarios)\n* Performance SLAs validated (ProfileService p95 < 300ms, EngagementService p95 < 200ms)\n* Load testing confirms system handles 3x expected volume without degradation\n* UAT sign-off obtained from business stakeholders\n* Zero critical defects (P1/P2) open before moving to Contact Migration\n* Test results documented and approved\n\n=== WP-CS-007: Salesforce Configuration\n\n==== Description\n\nConfigure Salesforce Service Cloud for OTR digital customer support integration, including field mapping, data isolation, and webhook setup.\n\n==== Deliverables\n\n* Salesforce Contact configuration\n** Custom fields for OTR-specific data (if needed)\n** Email as external key configuration\n** Record Type for OTR digital customers (data isolation)\n** Validation rules\n* Salesforce Case configuration\n** Custom fields for feedback categories (App, Service, Order, Rewards, Refund, Delete Account)\n** Case Type and Reason picklist mapping\n** Queue assignment rules (OTR digital support queue)\n** Case escalation rules\n** Case routing rules\n* Salesforce webhook configuration\n** Platform Events / Outbound Messages for Case updates\n** Webhook authentication (API key, JWT, or OAuth)\n** Case status change triggers (New → In Progress, Resolved, Closed)\n** Webhook payload format (JSON)\n* Data isolation strategy\n** Record Types for OTR vs other Viva Energy business units\n** Queues for OTR-specific Cases\n** Reporting and dashboards scoped to OTR data\n* Salesforce API access\n** Connected App configuration\n** OAuth 2.0 JWT bearer flow setup\n** API user credentials\n** API rate limit monitoring\n* Documentation\n** Salesforce field mapping specification\n** Webhook configuration guide\n** Data isolation architecture diagram\n** API authentication setup guide\n\n==== Dependencies\n\n*Prerequisites*:\n\n* Viva Energy Salesforce admin team engagement\n* Salesforce governance approval (multi-tenant environment)\n* Technical decision on webhook mechanism (Platform Events vs Outbound Messages)\n* Technical decision on authentication method (OAuth 2.0 JWT bearer flow recommended)\n\n*Dependent Work Packages*:\n\n* None (can start in parallel with development work packages)\n* Required for WP-CS-002 (EngagementService needs field mapping)\n* Required for WP-CS-006 (Integration Testing needs sandbox configuration)\n\n==== Skills Required\n\n* Salesforce administration\n* Salesforce configuration (Record Types, Queues, Validation Rules)\n* Salesforce API integration (REST API, Platform Events, Outbound Messages)\n* Salesforce security and authentication (OAuth, Connected Apps)\n* Multi-tenant data isolation patterns\n\n==== Acceptance Criteria\n\n* Salesforce sandbox configured with all custom fields, Record Types, Queues\n* Field mapping documented and approved by OTR business stakeholders\n* Webhook configuration tested and delivering Case update notifications\n* Data isolation validated (OTR data separate from other Viva Energy business units)\n* API authentication working for ProfileService and EngagementService\n* Salesforce API rate limits monitored and acceptable for expected volume\n* Configuration replicated to Salesforce production environment\n\n=== WP-CS-008: Contact Data Migration\n\n==== Description\n\nExecute one-time Contact migration from app-specific database to Salesforce Service Cloud production.\n\n==== Deliverables\n\n* Pre-migration activities\n** Final validation of migration tool in sandbox\n** Communication plan (notify users of maintenance window if needed)\n** Freeze app-specific database Contact updates\n** Backup app-specific database\n** Export snapshot of Salesforce Contacts (rollback preparation)\n* Migration execution\n** Execute migration tool against Salesforce production\n** Monitor migration progress\n** Handle failed upserts (manual intervention if needed)\n* Post-migration validation\n** 100% Contact reconciliation (app database vs Salesforce)\n** Email/phone/VCI matching accuracy report\n** Reconciliation report (Contacts created vs updated)\n** Data integrity checks (no duplicate Contacts, no missing Contacts)\n* ProfileService smoke testing\n** Verify Contact ID retrieval works in production\n** Test cache behavior\n** Validate Salesforce Contact upserts from ProfileService\n* Migration report\n** Total Contacts migrated\n** Contacts created vs updated\n** Failed upserts (if any) with resolution\n** Matching accuracy metrics\n** Migration execution time\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-004 (Contact Migration Tooling) completed\n* WP-CS-001 (ProfileService Development) deployed to production (not yet integrated with Mobile App)\n* WP-CS-007 (Salesforce Configuration) production configuration completed\n* Salesforce production access granted\n* Migration approved by business stakeholders\n\n*Dependent Work Packages*:\n\n* Must complete after WP-CS-001, WP-CS-004, WP-CS-007\n* Must complete before WP-CS-009 (Production Deployment)\n\n==== Skills Required\n\n* Data migration execution\n* Salesforce administration\n* Database operations\n* Data validation and reconciliation\n* Incident management (if issues arise)\n\n==== Acceptance Criteria\n\n* 100% of Contacts migrated with zero data loss\n* Email/phone/VCI matching accuracy > 95%\n* ProfileService smoke tests pass in production\n* Reconciliation report approved by business stakeholders\n* App-specific database Contact updates frozen (read-only mode)\n* Rollback procedure ready (but not executed if migration successful)\n\n=== WP-CS-009: Production Deployment\n\n==== Description\n\nDeploy all solution components to production and execute cutover from D365 CE to Salesforce Service Cloud.\n\n==== Deliverables\n\n* Production deployment\n** EngagementService deployed to production\n** Event Bus production infrastructure validated\n** Salesforce webhook configured in production\n** Mobile App released to production (App Store, Google Play)\n* Go-live activities\n** Smoke testing (end-to-end feedback submission)\n** Feature flag enabled: `enable_salesforce_feedback_submission = ON`\n** D365 CE integration disabled in Mobile App\n** Monitor Event Bus queue depth, DLQ, Salesforce API rate limits\n** Monitor Mobile App feedback submission success rate\n* Go/No-Go decision\n** Validate success criteria before final cutover\n** Business stakeholder approval\n** Technical validation (smoke tests pass, monitoring healthy)\n* Cutover communication\n** Notify support agents of new Salesforce integration\n** Provide training materials for support agents\n** Customer communication (if visible change)\n* Rollback plan\n** Documented rollback procedure\n** Feature flag can disable Salesforce integration and re-enable D365 CE\n** Rollback decision criteria (P1/P2 incidents, feedback submission success rate < 99%)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-001 (ProfileService Development) completed\n* WP-CS-002 (EngagementService Development) completed\n* WP-CS-003 (Event Bus Infrastructure) completed\n* WP-CS-005 (Mobile App Integration) completed\n* WP-CS-006 (Integration Testing) completed with UAT sign-off\n* WP-CS-007 (Salesforce Configuration) production configuration completed\n* WP-CS-008 (Contact Data Migration) completed successfully\n* Mobile App release approval (App Store, Google Play)\n\n*Dependent Work Packages*:\n\n* Must complete after all prior work packages (final cutover)\n\n==== Skills Required\n\n* Production deployment and release management\n* Incident management and troubleshooting\n* Monitoring and observability\n* Change management and communication\n* Rollback execution (if needed)\n\n==== Acceptance Criteria\n\n* Mobile App feedback submission success rate > 99.5%\n* End-to-end flow validated (Mobile App → ProfileService → EngagementService → Salesforce Case created)\n* Braze push notifications delivered successfully\n* Event Bus queue depth normal, DLQ empty\n* No critical incidents (P1/P2) in first 24 hours\n* D365 CE integration disabled\n* Support agents successfully using Salesforce for OTR digital customer Cases\n\n=== WP-CS-010: Post-Cutover Support\n\n==== Description\n\nMonitor production stability, resolve issues, validate success criteria, and execute D365 CE retirement.\n\n==== Deliverables\n\n* Monitoring and support\n** 24/7 on-call support for first week post-cutover\n** Daily monitoring reports (feedback submission success rate, Case creation success rate)\n** Incident response and resolution\n** Performance tuning (if needed)\n* Success criteria validation\n** Validate feedback submission success rate > 99.5%\n** Monitor customer satisfaction score (target: +15% improvement within 6 months)\n** Monitor average case resolution time (target: -20% improvement within 6 months)\n** Support agent feedback survey\n* D365 CE retirement\n** D365 CE set to read-only mode (historical Case lookups only)\n** Archive D365 CE data for compliance/auditing\n** Decommission D365 CE infrastructure (after 90-day stabilization period)\n** Remove D365 CE integration code from Mobile App\n* Documentation updates\n** Production runbook\n** Troubleshooting guide (based on incidents resolved)\n** Operational procedures for support team\n** Lessons learned document\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-009 (Production Deployment) completed\n* Cutover successful with no critical incidents\n\n*Dependent Work Packages*:\n\n* Final work package in sequence\n\n==== Skills Required\n\n* Production support and incident management\n* Performance monitoring and tuning\n* Data archival and compliance\n* Infrastructure decommissioning\n* Documentation\n\n==== Acceptance Criteria\n\n* Zero critical incidents (P1/P2) in first 30 days post-cutover\n* Feedback submission success rate sustained > 99.5%\n* Customer satisfaction improvement validated (baseline established, ongoing measurement)\n* Support agents reporting positive experience with Salesforce unified view\n* D365 CE successfully decommissioned\n* All production documentation complete and approved\n* Lessons learned document published\n\n=== Work Package Sequencing\n\n==== Parallel Track 1: Infrastructure & Configuration\n\nCan start immediately and run in parallel:\n\n* WP-CS-003 (Event Bus Infrastructure)\n* WP-CS-007 (Salesforce Configuration)\n\n==== Parallel Track 2: Development\n\nCan start after Track 1 infrastructure decisions made:\n\n* WP-CS-001 (ProfileService Development) - Independent\n* WP-CS-002 (EngagementService Development) - Requires WP-CS-003 completed\n* WP-CS-004 (Contact Migration Tooling) - Requires WP-CS-001 completed (reuses code)\n\n==== Sequential Track 3: Integration & Testing\n\nMust complete after development:\n\n* WP-CS-005 (Mobile App Integration) - Requires WP-CS-001, WP-CS-002\n* WP-CS-006 (Integration Testing) - Requires WP-CS-001, WP-CS-002, WP-CS-003, WP-CS-005, WP-CS-007\n\n==== Sequential Track 4: Migration & Cutover\n\nMust complete sequentially:\n\n* WP-CS-008 (Contact Data Migration) - Requires WP-CS-001, WP-CS-004, WP-CS-006 UAT sign-off\n* WP-CS-009 (Production Deployment) - Requires all prior work packages completed\n* WP-CS-010 (Post-Cutover Support) - Requires WP-CS-009\n\n==== Critical Path\n\nThe critical path for this project is:\n\n. WP-CS-003 (Event Bus Infrastructure)\n. WP-CS-002 (EngagementService Development) - blocks on WP-CS-003\n. WP-CS-005 (Mobile App Integration) - blocks on WP-CS-001, WP-CS-002\n. WP-CS-006 (Integration Testing) - blocks on WP-CS-001 through WP-CS-005, WP-CS-007\n. WP-CS-008 (Contact Data Migration) - blocks on WP-CS-006 UAT sign-off\n. WP-CS-009 (Production Deployment) - blocks on WP-CS-008\n. WP-CS-010 (Post-Cutover Support) - final deliverable\n\nAny delays in critical path work packages will delay the overall cutover date.\n\n<<<\n== Transition Architecture\n\nThis section defines the evolution from baseline (D365 CE) to target state (Salesforce Service Cloud + ProfileService + EngagementService).\n\n=== Transition Approach\n\n*Big Bang Cutover*: Per ADR-CS-006, this transition uses a single cutover approach rather than phased rollout. All users switch from D365 CE to Salesforce simultaneously after Contact migration completion.\n\n=== Transition States\n\n==== TS-0: Baseline State (Current)\n\n===== Characteristics\n\n* D365 Customer Engagement handles all digital customer feedback\n* App-specific database stores customer Contact data\n* No ProfileService or EngagementService\n* No event-driven architecture\n* Synchronous feedback submission\n\n===== Components Active\n\n- D365 Customer Engagement\n- App-specific customer database\n- Mobile App (current version with D365 CE integration)\n\n==== TS-1: Build & Test\n\n===== Activities\n\n* Build ProfileService microservice (JIT Contact reconciliation API)\n* Build EngagementService microservice (feedback submission API, ACL for Salesforce Case creation, Braze integration, webhook receiver)\n* Implement Event Bus infrastructure (SNS+SQS/EventBridge/Kinesis)\n* Develop Contact migration tool (app database → Salesforce upsert by email/phone/VCI)\n* Update Mobile App API integration (ProfileService + EngagementService endpoints - feedback form UI already complete)\n* Integration testing (ProfileService ↔ Salesforce, EngagementService ↔ Salesforce, EngagementService ↔ Braze)\n* UAT with test Salesforce sandbox environment\n\n===== Components Active\n\n- D365 Customer Engagement (still active, unchanged)\n- App-specific customer database (still active)\n- ProfileService (non-production, testing only)\n- EngagementService (non-production, testing only)\n- Event Bus (non-production)\n- Salesforce Sandbox (testing)\n\n===== Exit Criteria\n\n- All integration tests pass\n- UAT sign-off from business stakeholders\n- Contact migration tool validated in sandbox\n- Mobile App updates tested with non-production APIs\n\n==== TS-2: Contact Migration\n\n===== Activities\n* Execute Contact migration (app database → Salesforce production)\n* Validation: 100% data integrity check (email/phone/VCI matching)\n* Reconciliation report: New Contacts created vs existing Contacts updated\n* Freeze app database Contact updates during migration window\n* ProfileService smoke testing (verify Contact lookups work in Salesforce production)\n\n===== Components Active\n- D365 Customer Engagement (still active, users unaffected)\n- Salesforce Production (Contacts migrated, no Cases yet)\n- ProfileService (production deployed, not integrated with Mobile App yet)\n- App-specific customer database (frozen, read-only)\n\n===== Exit Criteria\n- 100% of Contacts migrated with zero data loss\n- Email/phone/VCI matching accuracy > 95%\n- ProfileService smoke tests pass (JIT lookups return correct Contact IDs)\n- Reconciliation report approved\n\n==== TS-3: Cutover (Go-Live)\n\n===== Go-Live Activities\n\n* Deploy EngagementService to production\n* Deploy Mobile App updates (ProfileService + EngagementService API integration)\n* Configure Salesforce webhook (Case update notifications → EngagementService)\n* Smoke testing: End-to-end feedback submission (Mobile App → EngagementService → Salesforce → Braze notification)\n* Monitor Event Bus queue depth, dead letter queue, Salesforce API rate limits\n* **Go/No-Go decision**: Validate success criteria before final cutover\n* Enable feature flag: `enable_salesforce_feedback_submission = ON`\n* Disable D365 CE integration in Mobile App\n\n===== Components Active\n\n- ProfileService (production, integrated with Mobile App)\n- EngagementService (production, integrated with Mobile App)\n- Event Bus (production, processing async Case creation)\n- Salesforce Production (receiving Cases from digital customers)\n- Braze (sending push notifications)\n- Mobile App (new version with Salesforce integration)\n- D365 Customer Engagement (disabled, read-only for historical lookups)\n\n===== Exit Criteria\n\n- Mobile App feedback submission success rate > 99.5%\n- End-to-end flow validated (Mobile App → Salesforce Case created)\n- Braze push notifications delivered successfully\n- Event Bus queue depth normal, DLQ empty\n- No critical incidents (P1/P2) in first 24 hours\n\n==== TS-4: Target State (Stable Production)\n\n===== Characteristics\n\n* ProfileService and EngagementService fully operational\n* All digital customer feedback routed to Salesforce\n* Event-driven architecture established\n* D365 CE decommissioned\n* First DDD bounded contexts implemented successfully\n\n===== Monitoring Period\n\n* Validate success criteria: feedback submission rate > 99.5%, no data loss\n* Monitor customer satisfaction score (target: +15% improvement)\n* Monitor average case resolution time (target: -20% improvement)\n* Support agents using unified Salesforce view across all channels\n\n===== D365 CE Retirement\n\n* D365 CE read-only access for historical Case lookups (if needed)\n* Decommission D365 CE infrastructure after 90 days\n* Archive D365 CE data for compliance/auditing\n\n===== Components Active\n\n- ProfileService (production)\n- EngagementService (production)\n- Event Bus (production)\n- Salesforce Production (system of record)\n- Braze (push notifications)\n- Mobile App (Salesforce integration)\n- App-specific database (deprecated, Contact data no longer updated)\n\n===== Success Criteria Achieved\n\n- All digital customer feedback routed to Salesforce\n- Support agents have unified customer view\n- D365 CE decommissioned\n- Customer satisfaction improved by 15%\n- Average case resolution time decreased by 20%\n- Zero data loss during transition\n\n=== Transition Dependencies\n\n[width=\"100%\",cols=\"40%,60%\",options=\"header\",]\n|===\n|Dependency |Owner/Status\n\n|*Salesforce production access*\n|Viva Energy Salesforce admin team - TBD\n\n|*Salesforce Case field mapping*\n|Viva Energy Salesforce admin team - TBD (map OTR feedback categories to Salesforce fields)\n\n|*Salesforce data isolation strategy*\n|Viva Energy Salesforce admin team - TBD (Record Types, queues, custom fields)\n\n|*Salesforce webhook configuration*\n|Viva Energy Salesforce admin team - TBD (Outbound Messages vs Platform Events)\n\n|*Event Bus infrastructure*\n|OTR Platform team - Existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis)\n\n|*Braze integration*\n|OTR Marketing team - Existing Braze account, EngagementService creates new campaigns\n\n|*Mobile App release window*\n|OTR Mobile team - Coordinate cutover timing with app release schedule\n\n|*App database access*\n|OTR Platform team - Read access for Contact migration\n\n|===\n\n=== Transition Validation Criteria\n\n==== Contact Migration Validation\n\n* 100% of app database Contacts migrated to Salesforce (zero data loss)\n* Email/phone/VCI matching accuracy > 95% (minimize duplicate Contacts)\n* ProfileService JIT lookups return correct Salesforce Contact IDs (smoke test sample)\n* Reconciliation report shows: X new Contacts created, Y existing Contacts updated\n\n==== Cutover Validation\n\n* Mobile App feedback submission success rate > 99.5% (including async Case creation)\n* End-to-end flow validated: Mobile App → ProfileService → EngagementService → Salesforce Case created\n* Braze push notifications delivered for Case creation and Case resolution\n* Event Bus queue depth within normal range (no backlog)\n* Dead letter queue empty (no failed Case creations)\n* Salesforce API rate limits not exceeded\n\n==== Production Monitoring (30 days)\n\n* Customer satisfaction score improves by 15% (compared to D365 CE baseline)\n* Average case resolution time decreases by 20% (Salesforce vs D365 CE)\n* Support agents confirm unified customer view across all channels\n* Zero critical incidents (P1 outages, data loss)\n\n=== Rollback Plan\n\n==== Rollback Triggers\n\n* Feedback submission success rate < 95% (below acceptable threshold)\n* Data loss or corruption detected in Salesforce\n* Salesforce API rate limits exceeded (Cases not created within SLA)\n* Critical bug blocking customer feedback submission\n\n==== Rollback Procedure\n\n1. **Revert Mobile App** to previous version (remove ProfileService/EngagementService integration, restore D365 CE integration)\n2. **Stop EngagementService** Case creation (prevent duplicate Cases in Salesforce)\n3. **Re-enable D365 CE** for customer feedback submission\n4. **Investigate root cause** (EngagementService logs, Salesforce API errors, Event Bus queue issues)\n5. **Fix and re-test** in sandbox environment\n6. **Retry cutover** when issues resolved\n\n==== Rollback Limitations\n\n* Cases created in Salesforce during cutover period remain in Salesforce (no reverse migration)\n* Contacts migrated to Salesforce remain (no rollback to app database)\n* Rollback only affects Mobile App integration (not data migration)\n\n=== Architectural Scope Boundaries\n\n==== Capabilities Included\n\n===== Business Capabilities\n\n* **Customer Feedback Submission**: Mobile App users can submit structured feedback (Category, Store Name, Time of Visit, Phone, Free Text Message) via EngagementService\n* **Customer Contact Management**: Just-In-Time (JIT) Contact reconciliation with Salesforce via ProfileService, ensuring every Mobile App user has a Salesforce Contact record\n* **Case Management Integration**: EngagementService creates Salesforce Cases asynchronously for customer feedback, support agents manage Cases in Salesforce Service Cloud\n* **Customer Notifications**: Push notifications via Braze when Cases are created, updated, or resolved (bidirectional integration: Mobile App → Salesforce → Mobile App)\n* **Unified Customer View**: Support agents see OTR digital customer feedback alongside other Viva Energy channels (fuel wholesale, Shell Card, retail) in single Salesforce instance\n* **Contact Data Migration**: One-time migration of app-specific customer database Contacts to Salesforce with upsert logic (email/phone/VCI matching)\n\n===== Technical Capabilities\n\n* **ProfileService Bounded Context**: First DDD bounded context implementation - JIT Contact reconciliation, Salesforce API facade, foundation for Flybuys integration\n* **EngagementService Bounded Context**: First DDD bounded context implementation - Customer feedback submission BFF, Anti-Corruption Layer for Salesforce, Braze integration orchestration\n* **Event-Driven Architecture**: Domain event publishing via Event Bus (SNS+SQS/EventBridge/Kinesis) for `SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted` events\n* **Async Processing Pattern**: Non-blocking Case creation with retry logic, exponential backoff, dead letter queue for operational resilience\n* **Anti-Corruption Layer Pattern**: EngagementService protects digital channels from Salesforce API changes, translates between OTR domain language and Salesforce\n* **Conformist Pattern**: ProfileService and EngagementService conform to existing Salesforce configuration (shared Viva Energy instance, multi-tenant governance)\n* **Salesforce Integration**: REST API integration for Contact CRUD and Case creation, webhook receiver for Case update notifications\n* **Braze Integration**: Push notification campaign triggers for Case lifecycle events (created, updated, resolved)\n* **Observability & Monitoring**: Dashboards, metrics, alerting for feedback submission rate, queue depth, API errors, Case creation latency\n* **Feature Flag Management**: Kill switches for emergency rollback (enable_salesforce_feedback_submission, enable_async_case_creation, etc.)\n\n==== Capabilities Excluded\n\n===== Business Capabilities Explicitly Out of Scope\n\n* **Historical Case Migration**: D365 CE Cases not migrated to Salesforce (ADR-CS-005 - fresh start, no Case migration)\n* **Multi-Channel Feedback Submission**: Web app, POS, call centre, email feedback channels not included (Mobile App only in this phase)\n* **Case Resolution by Digital Channels**: Support agents resolve Cases in Salesforce, not via Mobile App self-service\n* **Knowledge Base Integration**: Salesforce Knowledge Base articles not surfaced in Mobile App (future enhancement)\n* **Live Chat/Messaging**: Real-time chat support not included (Salesforce omnichannel capabilities not activated)\n* **Sentiment Analysis**: Automated feedback sentiment analysis not included (future enhancement with AI/ML)\n* **Customer Satisfaction Surveys**: Post-resolution CSAT surveys not included (separate initiative)\n* **Case Attachments**: Mobile App feedback submission does not support file uploads (photos, receipts) - text only\n* **Agent Desktop Integration**: Custom Salesforce UI for support agents not included (use standard Salesforce Service Console)\n* **Social Media Feedback**: Facebook, Twitter, Instagram feedback channels not integrated\n\n===== Technical Capabilities Explicitly Out of Scope\n\n* **Event Sourcing**: Domain events are ephemeral (not persisted for event sourcing/replay) - Event Bus only, no Event Store\n* **CQRS (Command Query Responsibility Segregation)**: ProfileService and EngagementService use same data model for reads/writes (no separate read models)\n* **Local Aggregate Persistence**: ProfileService and EngagementService are stateless (Salesforce is System of Record, no local database for Contact/Case)\n* **Saga Orchestration**: No distributed transactions or saga patterns required (single-step Case creation, not multi-step workflow)\n* **API Gateway Advanced Features**: Rate limiting, API versioning, API key management deferred to detailed design (basic routing only)\n* **GraphQL API**: ProfileService and EngagementService expose REST APIs only (GraphQL not required)\n* **Real-Time Sync**: Salesforce Contact updates by support agents not synced back to ProfileService (eventual consistency acceptable via JIT reconciliation)\n* **Multi-Region Deployment**: Single AWS region deployment (no multi-region failover/disaster recovery in this phase)\n* **Blue-Green Deployment**: Big bang cutover (ADR-CS-006), not blue-green or canary deployment strategy\n* **A/B Testing Framework**: Feature flags for rollback only, not for A/B testing or experimentation\n* **Custom Authentication**: Microsoft Entra External ID used for Mobile App authentication (no custom authentication logic in ProfileService/EngagementService)\n* **Data Residency Compliance**: Salesforce data residency governed by Viva Energy Salesforce configuration (no OTR-specific data residency requirements)\n\n===== Future Bounded Contexts Not in Scope\n\n* **LoyaltyService**: Flybuys integration, reward preferences, transaction adjudication (separate initiative)\n* **LocationService**: Store finder, proximity features, geofencing (separate initiative)\n* **PaymentService**: Payment processing, subscription billing (separate initiative)\n* **RecommendationService**: Personalized recommendations, next-best offers (separate initiative)\n\n===== Integration Patterns Not in Scope\n\n* **Shared Kernel**: No shared domain model between ProfileService and EngagementService (separate bounded contexts with clear boundaries)\n* **Partnership**: No joint development or coordination with external teams (Conformist pattern - we conform to Salesforce)\n* **Customer-Supplier (we're upstream)**: No downstream systems depend on ProfileService/EngagementService APIs yet (future bounded contexts will consume domain events)\n\n==== Architectural Dependencies on Future Initiatives\n\n*This Architecture Enables Future Initiatives*:\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Future Initiative |Architectural Enablement\n\n|*Flybuys Integration*\n|**ProfileService Contact Reconciliation Reused**: ProfileService establishes pattern for JIT Contact reconciliation with Salesforce, which will be extended for Flybuys partner linking (link:../architecture_definitions/flybuys_integration.adoc[see Flybuys Integration architecture]) +\n**Event Bus Infrastructure**: Domain event publishing pattern (`CustomerEnrolledInLoyalty`, `PartnerLinked`, etc.) reuses Event Bus established for EngagementService\n\n|*LoyaltyService Bounded Context*\n|**Event Bus Subscription**: LoyaltyService will consume `CustomerProfileCreated` events published by ProfileService (future enhancement) +\n**Salesforce Contact Integration**: LoyaltyService may query Salesforce Contacts for customer reward preferences (via ProfileService facade or direct Salesforce API)\n\n|*Web App Feedback Submission*\n|**EngagementService API Reuse**: Web app will call same EngagementService REST API for feedback submission (multi-channel support) +\n**Conformist Pattern**: Web app conforms to EngagementService API contract (no translation required)\n\n|*Multi-Channel Customer Support*\n|**EngagementService Extension**: Add support for email, call centre, POS feedback channels (extend EngagementService to handle multiple origins) +\n**Salesforce Case Origin Field**: Cases already tagged with Origin=Mobile App, extend to Origin=Web, POS, Call Centre, Email\n\n|*Knowledge Base Integration*\n|**EngagementService API Extension**: Add endpoint to query Salesforce Knowledge Base articles, surface in Mobile App for self-service support +\n**Anti-Corruption Layer**: EngagementService translates Salesforce Knowledge API to OTR domain language\n\n|*Customer Satisfaction Surveys*\n|**Event-Driven Trigger**: Subscribe to `SupportCaseResolved` events published by EngagementService, trigger CSAT survey via Braze +\n**Braze Integration Pattern**: Reuse EngagementService → Braze integration pattern for survey campaigns\n\n|*Sentiment Analysis*\n|**Event Subscription**: Subscribe to `CustomerFeedbackSubmitted` events, analyse feedback sentiment (AI/ML service) +\n**EngagementService Extension**: Enrich Case with sentiment score before creating in Salesforce\n\n|*RecommendationService Bounded Context*\n|**Event Subscription**: RecommendationService subscribes to `SupportCaseCreated` events to understand customer pain points and personalize recommendations +\n**Domain Event Pattern**: Reuse Event Bus publishing pattern established by EngagementService\n\n|===\n\n*This Architecture Depends on Future Initiatives*:\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Future Initiative |Dependency Description\n\n|*Salesforce Data Isolation Strategy*\n|**BLOCKER**: Viva Energy Salesforce admin team must define data isolation strategy (Record Types, custom fields, queues) before production deployment +\n**Impact**: Multi-tenant data visibility and security governance\n\n|*Salesforce Case Field Mapping*\n|**BLOCKER**: Viva Energy Salesforce admin team must define field mapping for OTR feedback categories (App, Service, Order, Rewards, Refund, Delete Account) +\n**Impact**: Case creation logic in EngagementService depends on finalized Salesforce schema\n\n|*Salesforce Webhook Mechanism*\n|**BLOCKER**: Viva Energy Salesforce admin team must configure webhook mechanism (Outbound Messages vs Platform Events vs Process Builder) for Case update notifications +\n**Impact**: EngagementService webhook receiver implementation depends on chosen mechanism\n\n|*Event Bus Technology Selection*\n|**DECISION REQUIRED**: Choose Event Bus implementation (SNS+SQS vs EventBridge vs Kinesis) for domain event publishing +\n**Impact**: Infrastructure provisioning, event schema design, consumer implementation\n\n|*Microservice Hosting Platform*\n|**DECISION REQUIRED**: Choose hosting platform for ProfileService and EngagementService (AWS Lambda vs ECS vs EKS) +\n**Impact**: Deployment architecture, auto-scaling strategy, operational overhead\n\n|*Observability Platform*\n|**DECISION REQUIRED**: Choose observability platform (AWS CloudWatch vs Datadog vs New Relic) for monitoring and alerting +\n**Impact**: Dashboard configuration, metric collection, alerting setup\n\n|===\n\n*Future Work After This Initiative*:\n\n* **Event Schema Registry**: Implement event schema versioning and registry for domain events (currently ad-hoc schemas)\n* **API Versioning Strategy**: Define API versioning approach for ProfileService and EngagementService (currently v1 only)\n* **Multi-Region Deployment**: Extend to multi-region for disaster recovery and global availability\n* **Event Store**: Persist domain events for event sourcing and audit trail (currently ephemeral Event Bus only)\n* **CQRS Pattern**: Separate read models for high-volume queries (currently same model for reads/writes)\n* **GraphQL API**: Expose GraphQL API for flexible client queries (currently REST only)\n* **Real-Time Sync**: Bi-directional sync between Salesforce and ProfileService for Contact updates (currently JIT reconciliation only)\n\n=== Technical Risks and Mitigation\n\n[width=\"100%\",cols=\"5%,20%,25%,25%,25%\",options=\"header\",]\n|===\n|ID |Risk |Impact |Likelihood |Mitigation\n\n|RISK-CS-001\n|*Salesforce API rate limits exceeded*: High feedback volume exceeds Salesforce API limits, Cases not created\n|HIGH (customers don't receive Case confirmation, support tickets lost)\n|MEDIUM (volume unknown, rate limits TBD)\n|• Gather expected feedback volume data before cutover +\n• Implement Event Bus queue throttling/rate limiting +\n• Monitor queue depth and API usage +\n• Scale background workers based on queue depth +\n• Alert ops team when approaching rate limits\n\n|RISK-CS-002\n|*Salesforce downtime*: Salesforce Service Cloud outage prevents Case creation\n|MEDIUM (Cases delayed but queued, customers wait for confirmation)\n|LOW (Salesforce SLA 99.9% uptime)\n|• Async Case creation with retry logic +\n• Event Bus queues buffer work during outage +\n• Customers get immediate \"Feedback submitted\" (not blocked) +\n• Monitor Salesforce status page, alert ops team +\n• Automatic retry when Salesforce recovers\n\n|RISK-CS-003\n|*Contact migration data quality issues*: App database Contact data incomplete or invalid\n|HIGH (migration fails validation, cutover delayed)\n|MEDIUM (legacy data quality unknown)\n|• Pre-migration data quality assessment +\n• Flexible upsert logic (match by email/phone/VCI) +\n• Validation report identifies data issues before production migration +\n• Manual cleanup for invalid records +\n• Dry-run migration in sandbox environment\n\n|RISK-CS-004\n|*Duplicate Contacts created*: Email matching fails, ProfileService creates duplicate Contacts\n|MEDIUM (support agents see multiple profiles for same customer)\n|MEDIUM (email changes, data quality issues)\n|• Salesforce duplicate detection rules (if available) +\n• ProfileService logs Contact creation for audit trail +\n• Manual duplicate cleanup process (support team) +\n• Future enhancement: VCI as Salesforce External ID for stable matching\n\n|RISK-CS-005\n|*Dead letter queue accumulation*: Failed Case creations not processed, queue grows\n|HIGH (customers don't receive Case confirmation, feedback lost)\n|LOW (retry logic handles most failures)\n|• Dead letter queue monitoring and alerting +\n• Ops team dashboard showing DLQ depth +\n• Manual intervention process (investigate and reprocess) +\n• Automated alerts when DLQ depth exceeds threshold +\n• Root cause analysis for recurring failures\n\n|RISK-CS-006\n|*Salesforce webhook failures*: Salesforce can't deliver Case update notifications to EngagementService\n|MEDIUM (customers don't get push notifications for Case resolution)\n|LOW (webhook mechanism reliable)\n|• Webhook retry logic and exponential backoff +\n• EngagementService logs webhook deliveries +\n• Monitor webhook delivery success rate +\n• Fallback: Poll Salesforce API for Case updates (if webhook fails persistently) +\n• Alert ops team when webhook delivery rate drops\n\n|RISK-CS-007\n|*Multi-tenant data isolation breach*: OTR digital Cases visible to other Viva Energy support teams\n|HIGH (privacy violation, compliance risk)\n|LOW (Salesforce governance controls)\n|• Work with Viva Energy Salesforce admin team on data isolation strategy +\n• Test data visibility in Salesforce sandbox (UAT with different user roles) +\n• Validate Record Types, queues, field-level security before production +\n• Audit Salesforce user permissions and sharing rules\n\n|RISK-CS-008\n|*Mobile App release coordination*: App release delayed, cutover window missed\n|MEDIUM (cutover delayed, D365 CE retirement delayed)\n|MEDIUM (release schedule conflicts)\n|• Coordinate cutover timing with Mobile team early +\n• Buffer time in migration plan (2-week contingency) +\n• Decouple backend deployment from Mobile App release (backend deployed first, app follows) +\n• Feature flag for feedback submission (enable when ready)\n\n|RISK-CS-009\n|*Event Bus infrastructure issues*: SNS/SQS/EventBridge downtime or misconfiguration\n|HIGH (Case creation blocked, domain events not published)\n|LOW (AWS SLA 99.99% uptime)\n|• Leverage existing AWS infrastructure (proven, reliable) +\n• Infrastructure as Code (IaC) for Event Bus configuration +\n• Integration testing in non-production environment +\n• Monitor Event Bus metrics (queue depth, throughput, errors) +\n• Alert ops team on Event Bus failures\n\n|RISK-CS-010\n|*Team DDD knowledge gap*: Team unfamiliar with DDD patterns, bounded contexts, event-driven architecture\n|MEDIUM (implementation delays, architectural inconsistencies)\n|HIGH (first DDD implementation)\n|• DDD training for development team (workshops, documentation) +\n• Architecture review sessions (validate bounded context design) +\n• Pair programming with experienced DDD practitioners +\n• Incremental implementation (start small, iterate) +\n• Document architectural patterns in CLAUDE.md\n\n|===\n\n== Assumptions and Constraints\n\n=== Assumptions\n\n[width=\"100%\",cols=\"8%,92%\",options=\"header\",]\n|===\n|ID |Assumption\n\n|ASM-CS-001\n|Viva Energy Salesforce admin team will provide Salesforce production access, sandbox environment, and support for Case field mapping and data isolation configuration\n\n|ASM-CS-002\n|App database Contact data is sufficiently complete for migration (email/phone/VCI available for matching)\n\n|ASM-CS-003\n|Expected customer feedback volume (100-150 submissions/day from 20k DAU) is well within Salesforce API rate limits, with capacity planning for 3x-10x growth\n\n|ASM-CS-004\n|Existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis) is sufficient for Event Bus implementation (no additional infrastructure provisioning required)\n\n|ASM-CS-005\n|Braze integration already exists and can be extended for Case-related push notifications (no new Braze account or major configuration changes)\n\n|ASM-CS-006\n|Mobile App users have email addresses associated with their accounts (required for ProfileService Contact reconciliation)\n\n|ASM-CS-007\n|D365 Customer Engagement historical Cases have limited business value and do not require migration to Salesforce\n\n|ASM-CS-008\n|Support agents are trained on Salesforce Service Cloud and require minimal additional training for OTR digital customer Cases\n\n|ASM-CS-009\n|Salesforce Service Cloud shared instance has capacity for OTR digital customer Contacts and Cases (no additional licensing or storage costs)\n\n|ASM-CS-010\n|Mobile App release schedule can accommodate cutover timing (Week 10 in migration plan)\n\n|===\n\n=== Constraints\n\n[width=\"100%\",cols=\"8%,92%\",options=\"header\",]\n|===\n|ID |Constraint\n\n|CON-CS-001\n|Must use shared Viva Energy Salesforce Service Cloud instance (cannot deploy separate OTR-specific instance)\n\n|CON-CS-002\n|Must conform to existing Salesforce configuration and governance (Record Types, custom fields, queues, data isolation strategy defined by Viva Energy admin team)\n\n|CON-CS-003\n|Contact migration must complete before Mobile App cutover (no parallel run of D365 CE and Salesforce)\n\n|CON-CS-004\n|Big bang cutover only (no phased rollout with feature flags or pilot users)\n\n|CON-CS-005\n|Salesforce API rate limits and authentication method constrained by Viva Energy Salesforce configuration (TBD)\n\n|CON-CS-006\n|Event Bus implementation must use existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis - cannot introduce new infrastructure components)\n\n|CON-CS-007\n|Mobile App feedback form must include specific fields: Category, Store Name, Time of Visit, Contact Phone Number, Free Text Message (no attachments)\n\n|CON-CS-008\n|D365 Customer Engagement must be decommissioned within 90 days post-cutover (ADR-CS-006)\n\n|CON-CS-009\n|ProfileService and EngagementService must be stateless (no local aggregate persistence, Salesforce is System of Record)\n\n|CON-CS-010\n|First DDD bounded context implementation (team learning curve, architectural patterns must be documented for future bounded contexts)\n\n|===\n\n== Non-Functional Requirements\n\n=== Performance Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-PERF-001\n|Mobile App feedback submission API response time (ProfileService + EngagementService)\n|p95 < 1 second, p99 < 2 seconds\n\n|NFR-PERF-002\n|ProfileService Contact reconciliation API response time (JIT lookup)\n|p95 < 500ms, p99 < 1 second\n\n|NFR-PERF-003\n|EngagementService async Case creation latency (end-to-end: feedback submitted → Case created in Salesforce)\n|p95 < 5 minutes, p99 < 10 minutes\n\n|NFR-PERF-004\n|Salesforce API call latency (Contact query, Contact create, Case create)\n|p95 < 2 seconds, p99 < 5 seconds\n\n|NFR-PERF-005\n|Event Bus message processing throughput\n|> 100 messages/second (support peak feedback volume)\n\n|NFR-PERF-006\n|Braze push notification delivery latency (Case created → notification delivered)\n|p95 < 30 seconds, p99 < 60 seconds\n\n|===\n\n=== Availability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-AVAIL-001\n|ProfileService availability\n|99.9% uptime (8.76 hours downtime/year)\n\n|NFR-AVAIL-002\n|EngagementService availability\n|99.9% uptime (8.76 hours downtime/year)\n\n|NFR-AVAIL-003\n|Feedback submission success rate (including async Case creation)\n|> 99.5% (includes retry logic for transient failures)\n\n|NFR-AVAIL-004\n|Graceful degradation: Salesforce downtime handling\n|Feedback submission still succeeds, Cases queued for async creation when Salesforce recovers\n\n|NFR-AVAIL-005\n|Graceful degradation: Braze downtime handling\n|Case creation proceeds, push notifications disabled temporarily (feature flag)\n\n|NFR-AVAIL-006\n|Planned maintenance window\n|< 4 hours/month, scheduled during low-traffic periods (2-6am ACST)\n\n|===\n\n=== Scalability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-SCALE-001\n|Concurrent Mobile App users (peak)\n|Support 20,000 DAU (Daily Active Users), ~150 concurrent users submitting feedback during peak hours\n\n|NFR-SCALE-002\n|Feedback submissions per day\n|Expected: 100-150 submissions/day based on 20k DAU (~0.5-0.75% submission rate) +\nCapacity: Support 500 submissions/day (3x expected volume for growth), 2,000 submissions/day (peak/incident scenarios)\n\n|NFR-SCALE-003\n|Auto-scaling: ProfileService and EngagementService\n|Auto-scale based on CPU/memory/request rate, scale up within 2 minutes\n\n|NFR-SCALE-004\n|Event Bus queue capacity\n|Support 100,000 queued messages (buffer for Salesforce downtime)\n\n|NFR-SCALE-005\n|Salesforce API rate limit compliance\n|Stay within 80% of Salesforce API rate limits (buffer for spikes)\n\n|NFR-SCALE-006\n|Future growth capacity\n|Architecture supports 10x growth (1,000-1,500 submissions/day based on 200k DAU) without major redesign\n\n|===\n\n=== Security Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-SEC-001\n|Mobile App authentication\n|Microsoft Entra External ID OAuth 2.0 with JWT tokens (existing CIAM)\n\n|NFR-SEC-002\n|API authorisation: ProfileService and EngagementService\n|JWT token validation, authenticated users only, user context propagation\n\n|NFR-SEC-003\n|Salesforce API authentication\n|OAuth 2.0 with Connected App and JWT bearer flow (service account)\n\n|NFR-SEC-004\n|Data encryption in transit\n|TLS 1.2+ for all API calls (Mobile App ↔ ProfileService/EngagementService ↔ Salesforce ↔ Braze)\n\n|NFR-SEC-005\n|Data encryption at rest\n|Salesforce encryption at rest (managed by Salesforce), Event Bus message encryption (AWS KMS)\n\n|NFR-SEC-006\n|Secret management\n|AWS Secrets Manager for Salesforce credentials, Braze API keys, OAuth tokens (no hardcoded secrets)\n\n|NFR-SEC-007\n|PII data handling\n|Contact data (email, phone, name) treated as PII, GDPR-compliant retention policies (Salesforce governance)\n\n|NFR-SEC-008\n|API rate limiting and throttling\n|API Gateway rate limiting (100 requests/second per user), prevent abuse and DoS\n\n|NFR-SEC-009\n|Logging and auditing\n|Log all API calls, Salesforce Contact/Case creates/updates, Event Bus publishes (no PII in logs)\n\n|NFR-SEC-010\n|Salesforce data isolation\n|Multi-tenant data isolation via Salesforce Record Types, queues, sharing rules (defined by Viva Energy admin team)\n\n|===\n\n=== Reliability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-REL-001\n|Retry logic: EngagementService → Salesforce Case creation\n|Exponential backoff (1s, 2s, 4s, 8s, 16s), max 5 retries, then dead letter queue\n\n|NFR-REL-002\n|Dead letter queue monitoring\n|Alert ops team immediately when DLQ depth > 0 (failed Case creations require manual intervention)\n\n|NFR-REL-003\n|Event Bus message durability\n|Messages persisted in Event Bus (SNS+SQS/EventBridge/Kinesis), not lost on service restart\n\n|NFR-REL-004\n|Idempotency: Case creation\n|EngagementService ensures duplicate feedback submissions don't create duplicate Cases (idempotency key)\n\n|NFR-REL-005\n|Circuit breaker: Salesforce API calls\n|Open circuit after 5 consecutive failures, half-open retry after 30 seconds\n\n|NFR-REL-006\n|Health checks: ProfileService and EngagementService\n|Health endpoints for load balancer checks, readiness and liveness probes\n\n|NFR-REL-007\n|Disaster recovery: Event Bus\n|Event Bus messages replicated across AWS availability zones (SQS/EventBridge/Kinesis HA)\n\n|===\n\n=== Maintainability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-MAINT-001\n|Code quality: ProfileService and EngagementService\n|> 80% test coverage (unit + integration tests), automated CI/CD pipeline\n\n|NFR-MAINT-002\n|API documentation\n|OpenAPI/Swagger specs for ProfileService and EngagementService, auto-generated API docs\n\n|NFR-MAINT-003\n|Deployment automation\n|Infrastructure as Code (Terraform/CloudFormation/CDK), zero-downtime deployments\n\n|NFR-MAINT-004\n|Logging: structured logs\n|JSON-formatted logs with correlation IDs, log levels (DEBUG, INFO, WARN, ERROR), centralized log aggregation\n\n|NFR-MAINT-005\n|Monitoring dashboards\n|Real-time dashboards for ProfileService, EngagementService, Event Bus (see Monitoring and Observability section)\n\n|NFR-MAINT-006\n|Alerting and on-call\n|PagerDuty/Opsgenie integration for P1/P2 alerts, on-call rotation for ops team\n\n|NFR-MAINT-007\n|Configuration management\n|Externalized configuration (environment variables, AWS Parameter Store), no hardcoded config\n\n|NFR-MAINT-008\n|Versioning: API and events\n|Semantic versioning (v1, v2), backward compatibility for API changes, event schema evolution\n\n|===\n\n=== Usability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-USE-001\n|Feedback submission UX\n|Mobile App user receives immediate \"Feedback submitted\" confirmation (< 1 second), not blocked by async Case creation\n\n|NFR-USE-002\n|Push notification delivery\n|Customer receives \"Your feedback has been received\" notification within 30 seconds of Case creation in Salesforce\n\n|NFR-USE-003\n|Case resolution notification\n|Customer receives \"Your case has been resolved\" notification within 30 seconds of support agent resolving Case\n\n|NFR-USE-004\n|Error messaging\n|User-friendly error messages for failed feedback submission (not technical errors), retry prompts\n\n|NFR-USE-005\n|Accessibility\n|Mobile App feedback form meets WCAG 2.1 AA accessibility standards (existing Mobile App compliance)\n\n|===\n\n=== Compliance Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-COMP-001\n|GDPR compliance: PII data\n|Customer Contact data (email, phone, name) managed per GDPR retention policies (Salesforce governance)\n\n|NFR-COMP-002\n|GDPR compliance: Right to erasure\n|Support \"Delete Account\" feedback category, trigger Contact deletion in Salesforce per GDPR Article 17\n\n|NFR-COMP-003\n|Data residency\n|Salesforce data residency governed by Viva Energy Salesforce configuration (regional compliance)\n\n|NFR-COMP-004\n|Audit trail\n|All Contact creates/updates, Case creates/updates logged for compliance auditing (Salesforce audit logs)\n\n|NFR-COMP-005\n|API security standards\n|OWASP API Security Top 10 compliance (injection prevention, authentication, authorisation, data exposure)\n\n|===\n\n== Monitoring and Observability\n\n=== Key Metrics\n\n[width=\"100%\",cols=\"25%,40%,35%\",options=\"header\",]\n|===\n|Metric Category |Metric |Target/Threshold\n\n|*Feedback Submission*\n|Feedback submission success rate (Mobile App → EngagementService)\n|> 99.5%\n\n|*Async Case Creation*\n|Case creation success rate (EngagementService → Salesforce)\n|> 99%\n\n|*Async Case Creation*\n|Case creation latency (time from feedback submission to Case created in Salesforce)\n|p95 < 5 minutes\n\n|*Event Bus*\n|Event Bus queue depth (pending Case creations)\n|< 100 messages\n\n|*Event Bus*\n|Dead letter queue depth (failed Case creations)\n|= 0 (alert on any failures)\n\n|*Salesforce API*\n|Salesforce API error rate\n|< 1%\n\n|*Salesforce API*\n|Salesforce API latency (Case creation)\n|p95 < 2 seconds\n\n|*Salesforce API*\n|Salesforce API rate limit utilization\n|< 80% of limit\n\n|*ProfileService*\n|Contact reconciliation success rate (JIT lookups)\n|> 99.5%\n\n|*ProfileService*\n|Contact reconciliation latency\n|p95 < 500ms\n\n|*Braze Notifications*\n|Push notification delivery rate (Case created/updated)\n|> 95%\n\n|*Salesforce Webhook*\n|Webhook delivery success rate (Salesforce → EngagementService)\n|> 99%\n\n|*Customer Satisfaction*\n|Customer satisfaction score (CSAT)\n|> 4.0/5.0 (improve by 15% from D365 CE baseline)\n\n|*Support Operations*\n|Average case resolution time\n|Decrease by 20% from D365 CE baseline\n\n|===\n\n=== Alerting Thresholds\n\n[width=\"100%\",cols=\"25%,50%,25%\",options=\"header\",]\n|===\n|Alert |Condition |Severity\n\n|*Feedback submission failures*\n|Feedback submission success rate < 95% over 5-minute window\n|P1 - Critical\n\n|*Dead letter queue accumulation*\n|Dead letter queue depth > 0 (any failed Case creations)\n|P2 - High\n\n|*Event Bus queue backlog*\n|Event Bus queue depth > 100 messages for > 15 minutes\n|P2 - High\n\n|*Salesforce API errors*\n|Salesforce API error rate > 5% over 5-minute window\n|P1 - Critical\n\n|*Salesforce API rate limits*\n|Salesforce API rate limit utilization > 90%\n|P2 - High\n\n|*Contact reconciliation failures*\n|ProfileService Contact reconciliation failure rate > 5% over 5-minute window\n|P2 - High\n\n|*Braze notification failures*\n|Braze push notification delivery rate < 80% over 15-minute window\n|P3 - Medium\n\n|*Salesforce webhook failures*\n|Salesforce webhook delivery success rate < 90% over 15-minute window\n|P2 - High\n\n|*Case creation latency*\n|Case creation latency p95 > 10 minutes\n|P3 - Medium\n\n|===\n\n=== Dashboards\n\n*ProfileService Dashboard:*\n\n* Contact reconciliation success rate (JIT lookups)\n* Contact reconciliation latency (p50, p95, p99)\n* Contact creation vs update ratio (new Contacts created vs existing Contacts updated)\n* Salesforce API error rate (Contact queries and creates)\n* Request rate and throughput\n\n*EngagementService Dashboard:*\n\n* Feedback submission success rate\n* Case creation success rate (async workflow)\n* Case creation latency (p50, p95, p99)\n* Event Bus queue depth (pending Case creations)\n* Dead letter queue depth (failed Case creations)\n* Salesforce API error rate (Case creation)\n* Salesforce API latency\n* Salesforce API rate limit utilization\n* Braze push notification delivery rate\n* Salesforce webhook delivery success rate\n\n*Event Bus Dashboard:*\n\n* Queue depth (pending messages)\n* Throughput (messages published/consumed per minute)\n* Dead letter queue depth (failed messages)\n* Consumer lag (time between publish and consume)\n\n*Customer Support Dashboard (Business Metrics):*\n\n* Total feedback submissions per day/week/month\n* Feedback category breakdown (App, Service, Order, Rewards, Refund, Delete Account)\n* Customer satisfaction score (CSAT) trend\n* Average case resolution time trend\n* Case volume by support team/queue\n* Unified customer view adoption (support agent feedback)\n<<<\n== Solution Validation\n\nThis section defines the validation criteria and testing approach for the solution.\n\n=== Functional Validation\n\n==== ProfileService API Testing\n\n*Test Scenarios*:\n1. **Happy Path**: Authenticated user requests Contact ID, existing Contact found in Salesforce, Contact ID returned\n2. **JIT Creation**: Authenticated user requests Contact ID, no existing Contact, new Contact created in Salesforce, Contact ID returned\n3. **Salesforce API Failure**: Salesforce unavailable, ProfileService returns 500 error, user retries\n4. **Invalid JWT**: Unauthenticated request, ProfileService returns 401 error\n\n*Acceptance Criteria*:\n- Contact reconciliation success rate > 99.5%\n- JIT Contact creation completes within 500ms (p95)\n\n==== EngagementService API Testing\n\n*Test Scenarios*:\n1. **Happy Path**: Valid feedback submission, immediate 202 Accepted response, Case created in Salesforce within 5 minutes, Braze notification delivered\n2. **Invalid Category**: Invalid feedback category, 400 Bad Request response with validation error\n3. **Salesforce Downtime**: Salesforce unavailable during async Case creation, message queued, retry logic executes, Case created when Salesforce recovers\n4. **Dead Letter Queue**: Case creation fails after 5 retries, message moved to DLQ, ops team alerted\n5. **Webhook Notification**: Support agent resolves Case in Salesforce, webhook triggers EngagementService, Braze push notification sent to customer\n\n*Acceptance Criteria*:\n- Feedback submission success rate > 99.5% (including async Case creation)\n- Async Case creation completes within 5 minutes (p95)\n- Webhook delivery success rate > 99%\n\n=== Non-Functional Validation\n\n==== Performance Testing\n\n*Load Testing*:\n\n*Baseline*: Expected 100-150 submissions/day from 20k DAU (~0.5-0.75% submission rate)\n\n- **Normal Load**: 1 submission/minute sustained for 2 hours (simulate typical daily pattern)\n- **3x Load**: 3 submissions/minute sustained for 1 hour (simulate busy period, 450 submissions/day)\n- **Peak Load (10x)**: 10 submissions/minute for 15 minutes (simulate incident scenario, app outage causing backlog)\n- **Stress Test**: 50 submissions/minute for 5 minutes (find breaking point, 20x normal)\n\n*Validation*:\n- API response time p95 < 1 second under 10x load\n- Event Bus queue depth remains manageable (< 100 messages)\n- No Case creation failures, all submissions processed successfully\n- Auto-scaling triggers appropriately for sustained load > 3x baseline\n\n*Acceptance Criteria*:\n- NFR-PERF-001 through NFR-PERF-006 validated under realistic load (3x and 10x baseline)\n- Auto-scaling triggers within 2 minutes of load increase\n- System handles 10x peak gracefully, 20x stress test identifies limits\n\n==== Resilience Testing\n\n*Salesforce API Failure Scenarios*:\n1. **Complete Outage**: Salesforce unavailable for 2 hours, Event Bus queues buffer work, Cases created when Salesforce recovers\n2. **Rate Limit Exceeded**: Salesforce rate limit hit, queue throttling activates, Cases created within SLA\n\n*Acceptance Criteria*:\n- NFR-AVAIL-004 validated (graceful degradation during Salesforce downtime)\n- Circuit breaker activates after 5 consecutive failures\n\n==== Security Validation\n\n*Penetration Testing*:\n- API authentication bypass attempts\n- SQL injection attempts\n- Webhook signature validation bypass\n\n*Acceptance Criteria*:\n- NFR-SEC-001 through NFR-SEC-010 validated\n- OWASP API Security Top 10 compliance verified\n\n=== Integration Validation\n\n==== End-to-End Testing\n\n*Full User Journey*:\n1. User authenticates via Microsoft Entra External ID\n2. Mobile App requests Contact ID from ProfileService (JIT reconciliation)\n3. User submits feedback via EngagementService\n4. Background worker creates Case in Salesforce\n5. Braze notification delivered to user\n6. Support agent resolves Case in Salesforce\n7. Salesforce webhook triggers EngagementService\n8. Braze notification delivered to user\n\n*Acceptance Criteria*:\n- End-to-end flow completes successfully in UAT\n- User receives both \"feedback submitted\" and \"case resolved\" notifications\n","structuredPatch":[{"oldStart":1925,"oldLines":6,"newStart":1925,"newLines":7,"lines":[" * Zero critical defects (P1/P2) open before moving to Contact Migration"," * Test results documented and approved"," ","+[[wp-cs-007]]"," === WP-CS-007: Salesforce Configuration"," "," ==== Description"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"a93bc670-aa2d-448a-bff2-6b8d97f382ca"}
{"parentUuid":"ba9ad111-e145-4570-95ed-7ec780917cb9","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01S5G6uq7XBa3wMUcpkXoEB3","type":"tool_result","content":"The file /mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n  1997→* API authentication working for ProfileService and EngagementService\n  1998→* Salesforce API rate limits monitored and acceptable for expected volume\n  1999→* Configuration replicated to Salesforce production environment\n  2000→\n  2001→[[wp-cs-008]]\n  2002→=== WP-CS-008: Contact Data Migration\n  2003→\n  2004→==== Description\n  2005→\n  2006→Execute one-time Contact migration from app-specific database to Salesforce Service Cloud production.\n  2007→\n  2008→==== Deliverables"}]},"uuid":"b4939797-b66d-43fa-9998-0220fa7317d7","timestamp":"2026-01-09T03:10:50.025Z","toolUseResult":{"filePath":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","oldString":"=== WP-CS-008: Contact Data Migration\n\n==== Description","newString":"[[wp-cs-008]]\n=== WP-CS-008: Contact Data Migration\n\n==== Description","originalFile":"= Salesforce Customer Support - Solution Architecture\n:project-name: Salesforce Customer Support\n:togaf-adm-phase: Phase E: Opportunities & Solutions\n:last-updated: 2026-01-07\n:document-type: Solution Architecture Document\n:status: Discovery\n:version: 0.1\n:domain: Customer Support & Engagement\n:programme-lead:\n:domain-architect: O.Young@otr.com.au\n:architecture-definition: xref:architecture-definitions:salesforce_customer_support.adoc[Architecture Definitions/Salesforce Customer Support]\n:doctype: article\n:toc: left\n:toclevels: 4\n:sectanchors:\n:sectlinks:\n:sectnums:\n:icons: font\n:source-highlighter: highlightjs\n:experimental:\n:description:\n:keywords:\n\n<<<\n== Purpose and Scope\n\n=== Purpose\n\nThis Solution Architecture defines how the Salesforce Customer Support consolidation will be implemented - the specific technology products, configurations, interfaces, and deployment architecture that realise the xref:architecture-definitions:salesforce_customer_support.adoc[Salesforce Customer Support Architecture Definition].\n\nThis solution establishes the **first implementation of OTR's target Domain-Driven Design (DDD) architecture** by deploying two new bounded contexts (`ProfileService` and `EngagementService`) as microservices, consolidating customer support onto Salesforce Service Cloud, and implementing event-driven integration patterns that will serve as the foundation for future bounded contexts (including Flybuys integration).\n\n=== Vision\n\n> Unify customer support across all OTRG channels by consolidating OTR digital customer feedback onto Salesforce Service Cloud, establishing the foundational DDD architecture with ProfileService and EngagementService bounded contexts that protect digital channels from external system changes while enabling support agents to deliver exceptional customer experiences with complete interaction history.\n\n=== Architectural Approach\n\nThis architecture establishes OTR's **first bounded context implementation** using Domain-Driven Design strategic patterns:\n\n* *link:../bounded_context/profile.adoc[ProfileService]* (NEW bounded context): Just-In-Time Contact reconciliation with Salesforce, upsert by email, returns Salesforce Contact ID to digital channels - foundation for future Flybuys partner linking\n* *link:../bounded_context/engagement.adoc[EngagementService]* (NEW bounded context): Customer feedback submission facade, Anti-Corruption Layer for Salesforce Case creation, Braze integration for all outbound customer communications (push, email, SMS), async Case processing via Event Bus\n* *Event-driven integration* (NEW pattern): Domain event publishing using existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis) - first implementation establishing pattern for future bounded contexts\n* *Anti-Corruption Layer*: EngagementService isolates digital channels from Salesforce API changes, translates between OTR domain language and Salesforce Service Cloud API\n* *Conformist Pattern*: ProfileService and EngagementService conform to existing Salesforce configuration (shared Viva Energy instance, multi-tenant governance)\n* *Big bang cutover*: Single deployment after Contact migration, no phased rollout, D365 CE retirement post-cutover\n\n=== Scope\n\n==== In Scope\n\n* Solution Building Blocks (SBBs) - specific technology products and versions\n* Interface specifications (APIs, events, data formats)\n* Data architecture and schema specifications\n* Deployment architecture and infrastructure configuration\n* Transition architecture with migration phases\n* Technical validation criteria and testing approach\n* External system integration specifications\n* Physical data models and API schemas\n\n==== Out of Scope\n\n===== Covered in xref:architecture-definitions:salesforce_customer_support.adoc[Architecture Definition]\n\n* Business requirements and stakeholder analysis\n* Architecture decisions and rationale (ADRs)\n* Bounded context definitions and responsibilities\n* High-level integration patterns (ACL, Conformist, OHS+PL)\n* Business capability mapping and value streams\n* Architecture principles and governance\n\n===== Covered in Other Documents\n\n* Detailed design (class diagrams, sequence diagrams for all flows)\n* Implementation code and unit tests\n* Business case and return-on-investment analysis\n* Operational run books and support procedures\n\n<<<\n=== Architecture Overview\n\n[mermaid]\n----\n---\nconfig:\n  layout: elk\n---\nflowchart TB\n    Customer([\"Customer\"]) -- Uses --> MobileApp[\"Mobile App<br>iOS/Android\"]\n    Customer -- Shops at --> POS[\"OTR/OTR+ POS<br>D365 Commerce\"]\n    MobileApp -- Authenticate --> EntraID[\"Microsoft Entra\"]\n    MobileApp -- Identifies & Reconciles --> ProfileService[\"ProfileService\"]\n    ProfileService <-- Reconcile App User as Salesforce Contact --> Salesforce[\"Salesforce\"]\n    ProfileService -- On Create --> EventBus[\"EventBus\"]\n    EventBus -- Emits CreateUser Event --> LoyaltyService[\"LoyaltyService\"] & EngagementService[\"EngagementService\"]\n    LoyaltyService -- Reconcile Wallet --> EagleEye[\"EagleEye\"]\n    EngagementService -- Reconcile Braze Profile --> Braze[\"Braze\"]\n    EngagementService --> Salesforce\n    D365CE[\"D365CE\"] -- Data Migration --> Salesforce\n    MobileApp -- Submits Feedback --> EngagementService\n\n    Customer:::customer\n    MobileApp:::presentation\n    POS:::presentation\n    EntraID:::external\n    ProfileService:::newService\n    Salesforce:::external\n    EventBus:::infrastructure\n    LoyaltyService:::newService\n    EngagementService:::newService\n    EagleEye:::external\n    Braze:::external\n    D365CE:::external\n    classDef newService fill:#4CAF50,stroke:#2E7D32,stroke-width:3px,color:#fff\n    classDef external fill:#FF9800,stroke:#E65100,stroke-width:2px,color:#fff\n    classDef infrastructure fill:#2196F3,stroke:#0D47A1,stroke-width:2px,color:#fff\n    classDef presentation fill:#9C27B0,stroke:#4A148C,stroke-width:2px,color:#fff\n    classDef customer fill:#607D8B,stroke:#263238,stroke-width:2px,color:#fff\n----\n\n\n==== Key Architectural Patterns\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Pattern |Application |Rationale\n\n|*Anti-Corruption Layer (ACL)*\n|EngagementService → Salesforce Service Cloud\n|Protects digital channels (Mobile App, Web) from Salesforce API changes, translates between OTR domain language and Salesforce Case/Contact model, enables independent evolution of internal domain model\n\n|*Conformist*\n|ProfileService → Salesforce, EngagementService → Salesforce\n|Shared Viva Energy Salesforce instance - we conform to existing configuration, governance, and API contracts (external system we don't control)\n\n|*Backend-for-Frontend (BFF)*\n|EngagementService\n|Aggregates customer feedback submission, Contact lookup, async Case creation, and Braze notification orchestration for digital channel clients\n\n|*Event-Driven Architecture (OHS+PL)*\n|Event Bus (SNS+SQS/EventBridge/Kinesis)\n|Loose coupling between bounded contexts, async domain event publishing (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`), foundation for future bounded contexts\n\n|*Just-In-Time (JIT) Integration*\n|ProfileService → Salesforce Contact reconciliation\n|Reconcile app users as Salesforce Contacts on-demand (upsert by email), no pre-sync required, ensures Salesforce has current Contact data\n\n|*Async Processing*\n|EngagementService Case creation via Event Bus\n|Non-blocking user experience, resilience to Salesforce downtime, automatic retry with exponential backoff, dead letter queue for operations team intervention\n\n|*Strangler Fig*\n|Not applicable\n|Big bang cutover (no gradual migration) - D365 CE fully replaced, not incrementally strangled\n\n|===\n\n<<<\n== Solution Approach\n\n* Deploy xref:bounded-contexts:profile.adoc[ProfileService] and xref:bounded-contexts:engagement.adoc[EngagementService] as bounded context microservices\n* Implement Anti-Corruption Layers (ACLs) for Salesforce and Braze integration\n* Establish event-driven architecture as the foundational integration pattern\n* Big bang cutover (TS-1 → TS-4)\n\n=== Related Documentation\n\nThis solution architecture references detailed technical specifications:\n\n==== Architecture Definition\n\n* xref:architecture-definitions:salesforce_customer_support.adoc[Salesforce Customer Support - Architecture Definition] - Business requirements, architecture decisions (ADRs), bounded context definitions, high-level integration patterns\n\n==== Bounded Context Specifications\n\n* xref:bounded-contexts:profile.adoc[ProfileService Bounded Context] - JIT Contact reconciliation, aggregate definitions\n* xref:bounded-contexts:engagement.adoc[EngagementService Bounded Context] - Customer feedback facade, Anti-Corruption Layer\n\n==== Interface Specifications\n\nDetailed API specifications available in the specifications directory:\n\n* link:../../specifications/rest/profile-service-v1.yaml[ProfileService REST API v1] - OpenAPI 3.0 specification for `/profile/v1` endpoints (includes Salesforce Contact reconciliation `GET /contact-id`)\n* link:../../specifications/rest/engagement-service-v1.yaml[EngagementService REST API v1] - OpenAPI 3.0 specification for `/engagement/v1` endpoints (includes `POST /feedback`)\n* link:../../specifications/events/engagement-events.json[Engagement Domain Events] - CloudEvents 1.0 JSON Schema for `SupportCaseCreated`, `SupportCaseUpdated`, `SupportCaseResolved`, `CustomerFeedbackSubmitted`\n\n==== External System Documentation\n\n* https://developer.salesforce.com/docs/atlas.en-us.api_rest.meta/api_rest/[Salesforce REST API Documentation] - Contact and Case object APIs\n* https://www.braze.com/docs/api/endpoints/messaging/send_messages/post_send_triggered_campaigns/[Braze Campaign Trigger API] - Push notification campaigns\n\n<<<\n== Executive Summary\n\n=== Challenge\n\nOTR digital customers (Mobile App, Web) currently submit feedback and support requests to D365 Customer Engagement, while Viva Energy's broader business units (fuel wholesale, Shell Card customers, other retail channels) use Salesforce Service Cloud. This creates:\n\n* *Fragmented customer support platform*: Customer support data split across two systems, preventing support agents from having a unified view of customer interactions across all channels\n* *Operational inefficiency*: Maintaining two separate customer support platforms increases operational overhead and costs\n* *Poor support experience*: D365 CE is not working well for digital customer support, impacting customer satisfaction and case resolution times\n* *Post-merger consolidation opportunity*: Following Viva Energy's acquisition of OTR, strategic alignment on Salesforce as the enterprise customer support platform\n\n=== Solution\n\nThis architecture establishes the **foundational Domain-Driven Design (DDD) implementation** for OTR's target state architecture by introducing two new bounded contexts (link:../bounded_context/profile.adoc[ProfileService], link:../bounded_context/engagement.adoc[EngagementService]) and event-driven integration patterns:\n\n==== New Bounded Contexts\n\n* *link:../bounded_context/profile.adoc[ProfileService]* (NEW): Just-In-Time (JIT) Contact reconciliation with Salesforce, upsert by email, returns Salesforce Contact ID to Mobile App\n* *link:../bounded_context/engagement.adoc[EngagementService]* (NEW): Customer feedback submission, Anti-Corruption Layer (ACL) for Salesforce Case creation, Braze integration for all outbound customer communications (push, email, SMS), async Case processing via Event Bus\n* *Event Bus* (NEW pattern): Domain event publishing using existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis) - first implementation of event-driven architecture pattern\n\n==== Integration Architecture\n\n* *Salesforce = System of Record*: Salesforce Service Cloud (shared Viva Energy instance) owns Contact and Case data\n* *Conformist Pattern*: ProfileService and EngagementService conform to existing Salesforce configuration and API contracts\n* *Anti-Corruption Layer*: EngagementService protects digital channels from Salesforce API changes, translates between OTR domain language and Salesforce\n* *Async Case Creation*: Non-blocking user experience, resilience to Salesforce downtime, automatic retry with exponential backoff, dead letter queue for failed Cases\n* *Event-Driven Notifications*: Salesforce webhook → EngagementService → Braze for all customer communications (push, email, SMS) on Case status updates\n\n==== Migration Approach\n\n* *Contact Migration*: One-time migration from app-specific database → Salesforce (upsert with flexible matching by email/phone/VCI)\n* *No Case Migration*: Historical D365 CE Cases not migrated (fresh start in Salesforce)\n* *Big Bang Cutover*: Single deployment, no phased rollout or parallel run\n* *D365 CE Retirement*: Complete decommissioning of D365 Customer Engagement post-cutover\n\n=== Key Architectural Significance\n\nThis migration establishes the first implementation of OTR's target DDD architecture:\n\n* First bounded contexts implemented (ProfileService, EngagementService)\n* First event-driven domain event pattern (foundation for future bounded contexts)\n* Foundation for Flybuys integration (ProfileService Contact reconciliation reused)\n* Establishes integration patterns (Conformist, ACL, Event-Driven) for future services\n\n=== Success Criteria\n\n* All digital customer feedback routed to Salesforce Service Cloud within 30 days of launch\n* Support agents have unified customer view across all Viva Energy channels (digital, wholesale, Shell Card, other retail)\n* D365 Customer Engagement decommissioned within 90 days post-cutover\n* Customer satisfaction score improves by 15% within 6 months\n* Average case resolution time decreases by 20% within 6 months\n* Zero data loss during Contact migration (100% validation pass rate)\n* Mobile App feedback submission success rate > 99.5% (including async Case creation)\n\n=== Technical Constraints\n\n* Shared Salesforce instance (Viva Energy multi-tenant environment)\n* Conform to existing Salesforce configuration and governance (data isolation strategy TBD with Salesforce admin team)\n* Contact migration must complete before cutover (no parallel run)\n* Async Case creation mandatory (non-blocking user experience)\n* Expected volume: 100-150 feedback submissions/day from 20k DAU (~0.5-0.75% submission rate), architecture capacity planned for 3x-10x growth\n\n=== Open Technical Decisions (TBD)\n\n* Salesforce Case field mapping for digital feedback categories (App, Service, Order, Rewards, Refund, Delete Account)\n* Salesforce data isolation strategy (Record Types, custom fields, queues)\n* Salesforce REST API authentication method (OAuth 2.0, Connected App, JWT bearer flow)\n* Salesforce webhook mechanism for Case updates (Outbound Messages, Platform Events, Process Builder)\n* Retry policy configuration (attempts, backoff intervals)\n* Salesforce API rate limit strategy (expected volume: 100-150 submissions/day from 20k DAU, capacity planning for 3x-10x growth)\n\n== Technical Requirements\n\n[width=\"100%\",cols=\"8%,92%\",options=\"header\",]\n|===\n|ID |Description\n\n|TR-CS-001\n|Every Mobile App user must have a Salesforce Contact record in Salesforce Service Cloud (shared Viva Energy instance)\n\n|TR-CS-002\n|ProfileService must reconcile Mobile App users as Salesforce Contacts using Just-In-Time (JIT) upsert by email address\n\n|TR-CS-003\n|ProfileService must return Salesforce Contact ID to Mobile App for feedback submission\n\n|TR-CS-004\n|Mobile App must support customer feedback submission with fields: Category (App, Service, Order, Rewards, Refund, Delete Account), Store Name, Time of Visit, Contact Phone Number, Free Text Message\n\n|TR-CS-005\n|EngagementService must create Salesforce Cases asynchronously via Event Bus (non-blocking user experience)\n\n|TR-CS-006\n|EngagementService must acknowledge feedback submission immediately to Mobile App user (\"Feedback submitted\" confirmation)\n\n|TR-CS-007\n|EngagementService must send push notification to customer via Braze when Case is successfully created in Salesforce\n\n|TR-CS-008\n|EngagementService must retry failed Case creation with configurable exponential backoff and dead letter queue for operations team intervention\n\n|TR-CS-009\n|Salesforce must be the System of Record for Contact and Case data (no local persistence in ProfileService or EngagementService)\n\n|TR-CS-010\n|Contact migration from app-specific database to Salesforce must complete before Mobile App cutover (upsert with flexible matching by email/phone/VCI)\n\n|TR-CS-011\n|No Case migration from D365 Customer Engagement to Salesforce (fresh start, historical Cases not migrated)\n\n|TR-CS-012\n|EngagementService must publish domain events (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`) to Event Bus for consumption by other bounded contexts\n\n|TR-CS-013\n|EngagementService must receive Salesforce webhook notifications when Cases are updated/resolved by support agents\n\n|TR-CS-014\n|EngagementService must trigger Braze push notifications to customers when Cases are updated/resolved (via Salesforce webhook → EngagementService → Braze)\n\n|TR-CS-015\n|ProfileService and EngagementService must conform to existing Salesforce configuration and API contracts (Conformist pattern)\n\n|TR-CS-016\n|All changes must be communicated using event-driven architecture via Event Bus (using existing AWS infrastructure: SNS+SQS/EventBridge/Kinesis)\n\n|TR-CS-017\n|Mobile App feedback submission success rate must exceed 99.5% (including async Case creation completion)\n\n|TR-CS-018\n|Contact migration must achieve 100% validation pass rate (zero data loss)\n\n|TR-CS-019\n|D365 Customer Engagement must be fully decommissioned within 90 days post-cutover\n\n|===\n\n== Technical Architecture\n\n=== Technical Capability Requirements\n\n==== Requirements Traceability\n\n[width=\"100%\",cols=\"15%,50%,35%\",options=\"header\",]\n|===\n|Requirement ID |Requirement Summary |Architectural Building Blocks\n\n|TR-CS-001\n|Every Mobile App user must have Salesforce Contact record\n|ABB-CS-001 (ProfileService), ABB-CS-004 (Salesforce), ABB-CS-007 (Contact Migration Tool)\n\n|TR-CS-002\n|ProfileService JIT Contact reconciliation via upsert by email\n|ABB-CS-001 (ProfileService), ABB-CS-004 (Salesforce)\n\n|TR-CS-003\n|ProfileService returns Salesforce Contact ID to Mobile App\n|ABB-CS-001 (ProfileService), ABB-CS-006 (Mobile App)\n\n|TR-CS-004\n|Mobile App supports feedback submission with structured fields\n|ABB-CS-006 (Mobile App), ABB-CS-002 (EngagementService)\n\n|TR-CS-005\n|EngagementService creates Salesforce Cases asynchronously\n|ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus), ABB-CS-004 (Salesforce)\n\n|TR-CS-006\n|EngagementService immediate acknowledgment to Mobile App\n|ABB-CS-002 (EngagementService), ABB-CS-006 (Mobile App)\n\n|TR-CS-007\n|EngagementService sends push notification via Braze on Case creation\n|ABB-CS-002 (EngagementService), ABB-CS-005 (Braze)\n\n|TR-CS-008\n|EngagementService retry logic with exponential backoff and DLQ\n|ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus)\n\n|TR-CS-009\n|Salesforce is System of Record for Contact and Case data\n|ABB-CS-004 (Salesforce), ABB-CS-001 (ProfileService - stateless), ABB-CS-002 (EngagementService - stateless)\n\n|TR-CS-010\n|Contact migration before Mobile App cutover\n|ABB-CS-007 (Contact Migration Tool), ABB-CS-004 (Salesforce)\n\n|TR-CS-011\n|No Case migration from D365 CE (fresh start)\n|ABB-CS-004 (Salesforce) - no migration tooling required\n\n|TR-CS-012\n|EngagementService publishes domain events to Event Bus\n|ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus)\n\n|TR-CS-013\n|EngagementService receives Salesforce webhook notifications\n|ABB-CS-002 (EngagementService), ABB-CS-004 (Salesforce)\n\n|TR-CS-014\n|EngagementService triggers Braze notifications on Case updates\n|ABB-CS-002 (EngagementService), ABB-CS-004 (Salesforce), ABB-CS-005 (Braze)\n\n|TR-CS-015\n|ProfileService and EngagementService conform to Salesforce config\n|ABB-CS-001 (ProfileService), ABB-CS-002 (EngagementService), ABB-CS-004 (Salesforce)\n\n|TR-CS-016\n|Event-driven architecture via Event Bus\n|ABB-CS-003 (Event Bus), ABB-CS-002 (EngagementService)\n\n|TR-CS-017\n|Mobile App feedback submission success rate > 99.5%\n|ABB-CS-006 (Mobile App), ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus), ABB-CS-004 (Salesforce)\n\n|TR-CS-018\n|Contact migration 100% validation pass rate\n|ABB-CS-007 (Contact Migration Tool), ABB-CS-004 (Salesforce)\n\n|TR-CS-019\n|D365 CE decommissioned within 90 days post-cutover\n|All ABBs (replacement system operational)\n\n|===\n\n=== Service Catalogues\n\n==== Application Portfolio Catalogue\n\n[width=\"100%\",cols=\"20%,15%,15%,15%,35%\",options=\"header\",]\n|===\n|Application |Lifecycle State |Owner |Hosting Platform |Description\n\n|*ProfileService*\n|NEW\n|OTR Platform Team\n|AWS (TBD: Lambda/ECS/EKS)\n|JIT Contact reconciliation with Salesforce, returns Salesforce Contact ID, foundation for Flybuys integration\n\n|*EngagementService*\n|NEW\n|OTR Platform Team\n|AWS (TBD: Lambda/ECS/EKS)\n|Customer feedback submission facade, ACL for Salesforce Case creation, Braze integration for all outbound communications (push, email, SMS), webhook receiver\n\n|*Mobile App (iOS)*\n|ACTIVE (UPDATE)\n|OTR Mobile Team\n|Apple App Store\n|iOS native app with feedback form, integrate with ProfileService and EngagementService APIs\n\n|*Mobile App (Android)*\n|ACTIVE (UPDATE)\n|OTR Mobile Team\n|Google Play Store\n|Android native app with feedback form, integrate with ProfileService and EngagementService APIs\n\n|*Salesforce Service Cloud*\n|ACTIVE (EXPAND)\n|Viva Energy Salesforce Admin Team\n|Salesforce (SaaS)\n|Shared Viva Energy instance, System of Record for Contact and Case data, adding OTR digital customer support\n\n|*Braze*\n|ACTIVE (EXTEND)\n|OTR Marketing Team\n|Braze (SaaS)\n|Marketing automation platform, EngagementService triggers push notifications for Case updates\n\n|*D365 Customer Engagement*\n|RETIRE\n|OTR Support Team\n|Microsoft Azure (SaaS)\n|Legacy customer support platform, decommissioned within 90 days post-cutover\n\n|*App-Specific Customer Database*\n|RETIRE\n|OTR Platform Team\n|AWS (RDS/DynamoDB)\n|Legacy customer contact storage, one-time migration to Salesforce, then deprecated\n\n|*Event Bus*\n|NEW\n|OTR Platform Team\n|AWS (SNS+SQS/EventBridge/Kinesis)\n|Domain event publishing infrastructure for bounded context integration\n\n|*Contact Migration Tool*\n|TEMPORARY\n|OTR Platform Team\n|AWS (Script/Lambda)\n|One-time migration app database → Salesforce with upsert logic, retired after migration complete\n\n|===\n\n==== Technology Capability Requirements\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Technology Capability |Implementation Technology (TBD in detailed design) |Requirements\n\n|*Microservice Hosting*\n|AWS Lambda / ECS / EKS\n|Host ProfileService and EngagementService with auto-scaling, high availability, monitoring\n\n|*API Gateway*\n|AWS API Gateway / Application Load Balancer\n|REST API routing, authentication, rate limiting, request validation for ProfileService and EngagementService\n\n|*Event Bus*\n|AWS SNS+SQS / EventBridge / Kinesis\n|Domain event publishing, async message processing, retry logic, dead letter queue\n\n|*Salesforce Integration*\n|Salesforce REST API / SOAP API\n|Contact CRUD operations, Case creation, webhook notifications, OAuth 2.0 authentication\n\n|*Braze Integration*\n|Braze REST API / SDK\n|Push notification campaign triggers, customer profile reconciliation\n\n|*Authentication & Authorisation*\n|Microsoft Entra External ID / AWS Cognito\n|Mobile App user authentication, API authorisation, JWT token validation\n\n|*Observability & Monitoring*\n|AWS CloudWatch / Datadog / New Relic\n|Application metrics, logs, traces, dashboards, alerting (feedback submission rate, queue depth, API errors)\n\n|*Secret Management*\n|AWS Secrets Manager / Parameter Store\n|Salesforce credentials, Braze API keys, OAuth tokens, encryption keys\n\n|*Database (Migration Tool)*\n|AWS RDS / DynamoDB (read-only access)\n|Contact migration from app-specific database\n\n|*CI/CD Pipeline*\n|GitHub Actions / AWS CodePipeline\n|Automated build, test, deployment for ProfileService, EngagementService, Mobile App\n\n|*Infrastructure as Code*\n|Terraform / AWS CloudFormation / CDK\n|Declarative infrastructure provisioning for Event Bus, microservices, monitoring\n\n|*API Documentation*\n|OpenAPI / Swagger\n|ProfileService and EngagementService API specifications for Mobile App integration\n\n|===\n\n==== Feature Flag Register\n\n*Note*: Per ADR-CS-006 (big bang cutover, not phased rollout), feature flags are minimal and used primarily for emergency rollback/kill switches.\n\n[width=\"100%\",cols=\"20%,15%,35%,30%\",options=\"header\",]\n|===\n|Feature Flag |Default State |Purpose |Rollback Scenario\n\n|*enable_salesforce_feedback_submission*\n|OFF (pre-cutover), ON (post-cutover)\n|Enable/disable feedback submission to EngagementService → Salesforce (kill switch for emergency rollback to D365 CE)\n|Feedback submission success rate < 95%, Salesforce API failures, critical bugs - revert to D365 CE integration\n\n|*enable_async_case_creation*\n|ON\n|Enable/disable async Case creation via Event Bus (fallback to synchronous processing if Event Bus issues)\n|Event Bus infrastructure failures, queue backlog unmanageable - temporary synchronous processing\n\n|*enable_braze_notifications*\n|ON\n|Enable/disable Braze push notifications for Case updates (degrade gracefully if Braze integration fails)\n|Braze API failures, notification delivery rate < 80% - disable notifications temporarily\n\n|*enable_jit_contact_reconciliation*\n|ON\n|Enable/disable ProfileService JIT Contact reconciliation (fallback to cached Contact IDs if Salesforce unavailable)\n|Salesforce API downtime, Contact reconciliation failures > 5% - use cached Contact IDs temporarily\n\n|*enable_salesforce_webhook_processing*\n|ON\n|Enable/disable Salesforce webhook processing for Case updates (fallback to polling if webhook failures)\n|Webhook delivery failures, authentication issues - temporary polling fallback\n\n|===\n\n*Feature Flag Management*:\n\n* Feature flags managed via AWS AppConfig / LaunchDarkly / custom feature flag service (TBD in detailed design)\n* Mobile App feature flags controlled server-side (no app release required for flag changes)\n* Backend service feature flags configured via environment variables / configuration service\n* Feature flag changes logged and audited (who changed, when, reason)\n* Post-cutover monitoring: Gradual removal of feature flags once system stability confirmed (30-60 days)\n\n==== Data Entity Catalogue\n\n[width=\"100%\",cols=\"20%,15%,35%,30%\",options=\"header\",]\n|===\n|Data Entity |System of Record |Key Attributes |Lifecycle\n\n|*Contact*\n|Salesforce Service Cloud\n|• Contact ID (Salesforce 15/18-char ID) +\n• Email (primary matching key) +\n• First Name, Last Name +\n• Phone Number +\n• Viva Consumer ID (VCI) +\n• Account (Viva Energy customer account) +\n• Record Type (OTR Digital vs other channels)\n|Created: ProfileService JIT reconciliation or Contact Migration Tool +\nUpdated: ProfileService JIT upsert (email changes), Salesforce (manual updates by support agents) +\nDeleted: Salesforce retention policy (GDPR/compliance)\n\n|*Case*\n|Salesforce Service Cloud\n|• Case Number (Salesforce auto-generated) +\n• Contact ID (reference to Contact) +\n• Subject (derived from Category) +\n• Description (Free Text Message) +\n• Category (App, Service, Order, Rewards, Refund, Delete Account) +\n• Store Name (OTR location) +\n• Time of Visit +\n• Status (New, In Progress, Resolved, Closed) +\n• Priority, Origin (Mobile App) +\n• Owner (support agent/queue)\n|Created: EngagementService async Case creation +\nUpdated: Support agents (Salesforce UI), EngagementService (webhook processing) +\nDeleted: Salesforce retention policy (archive after X years)\n\n|*Feedback Submission (transient)*\n|None (not persisted)\n|• Salesforce Contact ID +\n• Category +\n• Store Name +\n• Time of Visit +\n• Contact Phone Number +\n• Free Text Message\n|Created: Mobile App user submission +\nProcessed: EngagementService publishes to Event Bus, Case created in Salesforce +\nNot persisted in ProfileService/EngagementService (stateless)\n\n|*Domain Events*\n|Event Bus (ephemeral)\n|**SupportCaseCreated**: +\n• Case Number, Contact ID, Category, Timestamp +\n**SupportCaseUpdated**: +\n• Case Number, Status, Updated By, Timestamp +\n**SupportCaseResolved**: +\n• Case Number, Resolution, Resolved By, Timestamp +\n**CustomerFeedbackSubmitted**: +\n• Contact ID, Category, Timestamp\n|Published: EngagementService +\nConsumed: Other bounded contexts (future), Braze notification triggers +\nRetention: Short-lived (minutes to hours), not persisted for event sourcing\n\n|*Braze Customer Profile*\n|Braze\n|• External User ID (VCI or Email) +\n• Push Notification Tokens (iOS/Android) +\n• Notification Preferences +\n• Campaign Engagement History\n|Created/Updated: EngagementService on Case creation/update +\nManaged: Braze (external SaaS)\n\n|===\n\n*Data Migration Entities*:\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Source Entity |Target Entity |Migration Strategy\n\n|*App Database Contact*\n|Salesforce Contact\n|One-time migration via Contact Migration Tool: +\n• Upsert by email (primary), phone (secondary), VCI (tertiary) +\n• Map: Email → Email, Name → First/Last Name, Phone → Phone, VCI → External ID +\n• Validation: 100% data integrity check, reconciliation report\n\n|*D365 CE Case*\n|Not migrated\n|ADR-CS-005: No Case migration (fresh start in Salesforce) +\nD365 CE Cases archived separately for compliance if needed\n\n|===\n\n==== Data Quality & Validation\n\n*Contact Migration Validation Rules*:\n\n* Email format validation (RFC 5322 compliance)\n* Phone number format validation (E.164 international format)\n* VCI format validation (alphanumeric, length constraints)\n* Duplicate detection: Flag potential duplicates for manual review (same email/phone combination)\n* Mandatory fields: Email (required), First Name, Last Name (required for Salesforce Contact)\n\n*Case Creation Validation Rules*:\n\n* Contact ID must exist in Salesforce (validated by EngagementService before Case creation)\n* Category must be one of: App, Service, Order, Rewards, Refund, Delete Account\n* Free Text Message maximum length: 32,000 characters (Salesforce Case Description limit)\n* Store Name validated against OTR location master data (optional - warn if not found)\n\n<<<\n== Solution Building Blocks\n\nThis section defines the specific technology products, configurations, and implementation details for each Solution Building Block (SBB).\n\n=== Technology Portfolio Catalogue\n\n[width=\"100%\",cols=\"10%,20%,25%,25%,20%\",options=\"header\",]\n|===\n|SBB ID |Component |Technology Product |Version/Configuration |Deployment Platform\n\n|SBB-CS-001\n|ProfileService Microservice\n|.NET 8 / Node.js 20 LTS\n|RESTful API, containerised\n|AWS ECS Fargate / Lambda\n\n|SBB-CS-002\n|EngagementService Microservice\n|.NET 8 / Node.js 20 LTS\n|RESTful API, containerised, async workers\n|AWS ECS Fargate / Lambda\n\n|SBB-CS-003\n|Event Bus\n|AWS SNS + SQS / EventBridge\n|Standard queues, FIFO for ordering\n|AWS (managed service)\n\n|SBB-CS-004\n|API Gateway\n|AWS API Gateway / ALB\n|REST API, JWT validation\n|AWS (managed service)\n\n|SBB-CS-005\n|Salesforce Integration Layer\n|Salesforce REST API Client\n|OAuth 2.0 JWT bearer flow\n|Embedded in SBB-CS-001/002\n\n|SBB-CS-006\n|Braze Integration Layer\n|Braze REST API SDK\n|API key authentication\n|Embedded in SBB-CS-002\n\n|SBB-CS-007\n|Contact Migration Tool\n|Python 3.11 / .NET 8\n|One-time batch script\n|AWS Lambda / EC2\n\n|SBB-CS-008\n|Application Monitoring\n|AWS CloudWatch / Datadog\n|Metrics, logs, traces, dashboards\n|AWS / SaaS\n\n|SBB-CS-009\n|Secret Management\n|AWS Secrets Manager\n|KMS encryption\n|AWS (managed service)\n\n|SBB-CS-010\n|Mobile App (iOS)\n|SwiftUI, Kotlin Multiplatform\n|iOS 15+\n|Apple App Store\n\n|SBB-CS-011\n|Mobile App (Android)\n|Jetpack Compose, Kotlin Multiplatform\n|Android 8+\n|Google Play Store\n\n|SBB-CS-012\n|Feature Flag Service\n|AWS AppConfig / LaunchDarkly\n|Server-side flags, real-time updates\n|AWS / SaaS\n\n|===\n\n<<<\n== Data Architecture\n\nThis section defines the physical data models, event schemas, and API request/response formats.\n\n=== Domain Event Schemas\n\nAll domain events follow the https://cloudevents.io/[CloudEvents 1.0] specification for consistency and interoperability.\n\n*Event Schema Specifications*: See // TODO: Add to Antora - specifications/events/engagement-events.json[Engagement Service Event Schemas] for complete JSON schemas and examples.\n\n==== Event Catalogue\n\n[width=\"100%\",cols=\"30%,20%,50%\",options=\"header\",]\n|===\n|Event Type |Publisher |Description\n\n|`SupportCaseCreated`\n|EngagementService\n|Published when EngagementService successfully creates a Case in Salesforce after async processing\n\n|`SupportCaseUpdated`\n|EngagementService (via Salesforce webhook)\n|Published when a support agent updates a Case in Salesforce (status, priority, comment changes)\n\n|`SupportCaseResolved`\n|EngagementService (via Salesforce webhook)\n|Published when a support agent resolves/closes a Case in Salesforce\n\n|`CustomerFeedbackSubmitted`\n|EngagementService\n|Published when customer submits feedback via Mobile App (before async Case creation)\n\n|===\n\n*Event Format*: All events use CloudEvents 1.0 envelope with event-specific payload in the `data` field.\n\n*Schema Location*: `specifications/events/engagement-events.json`\n\n=== API Request/Response Schemas\n\n==== ProfileService: GET /profile/contact-id\n\n*Response* (200 OK):\n[source,json]\n----\n{\n  \"contactId\": \"0034X00000ABCDEFG\",\n  \"email\": \"customer@example.com\",\n  \"firstName\": \"John\",\n  \"lastName\": \"Smith\"\n}\n----\n\n==== EngagementService: POST /feedback\n\n*Request*:\n[source,json]\n----\n{\n  \"contactId\": \"0034X00000ABCDEFG\",\n  \"category\": \"App\",\n  \"storeName\": \"OTR Adelaide\",\n  \"timeOfVisit\": \"2026-01-07T12:00:00Z\",\n  \"contactPhoneNumber\": \"+61412345678\",\n  \"message\": \"App crashed when submitting feedback\"\n}\n----\n\n*Response* (202 Accepted):\n[source,json]\n----\n{\n  \"feedbackId\": \"fb-2026-01-07-12345\",\n  \"status\": \"submitted\",\n  \"message\": \"Your feedback has been submitted!\"\n}\n----\n\n=== Salesforce Field Mappings\n\n==== Case Object Mapping\n\n[width=\"100%\",cols=\"25%,25%,25%,25%\",options=\"header\",]\n|===\n|OTR Field |Salesforce Field |Data Type |Notes\n\n|Category\n|Feedback_Category__c\n|Picklist\n|App, Service, Order, Rewards, Refund, Delete Account\n\n|Store Name\n|Store_Name__c\n|String (255)\n|OTR location name\n\n|Time of Visit\n|Time_of_Visit__c\n|DateTime\n|When customer visited store\n\n|Free Text Message\n|Description\n|Long Text (32,000)\n|Customer feedback message\n\n|===\n\n<<<\n=== Baseline Architecture\n\n==== Existing System Components\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Component |Current State |Status\n\n|*D365 Customer Engagement*\n|Customer support platform for OTR digital customers (Mobile App, Web), handles feedback submission and case management\n|**DEPRECATED** - Being replaced by Salesforce Service Cloud\n\n|*App-Specific Customer Database*\n|Stores customer contact data for Mobile App users, separate from Viva Energy systems\n|**MIGRATING** - One-time migration to Salesforce, then deprecated\n\n|*Mobile App*\n|iOS/Android native apps with feedback submission form including Category, Store Name, Time of Visit, Contact Phone Number, and Free Text Message fields\n|**REQUIRES UPDATE** - Integrate with ProfileService and EngagementService APIs (feedback form UI already complete)\n\n|*Salesforce Service Cloud*\n|Shared Viva Energy instance handling customer support for fuel wholesale, Shell Card customers, other retail channels\n|**EXPANDING** - Adding OTR digital customer support Cases and Contacts\n\n|*Existing AWS Infrastructure*\n|SNS+SQS / EventBridge / Kinesis available for event-driven architecture\n|**REUSING** - Event Bus implementation leverages existing infrastructure\n\n|===\n\n==== Integration Architecture\n\n*Current state:*\n\n* Mobile App → D365 Customer Engagement (direct integration)\n* App-specific customer database → standalone (no Salesforce integration)\n* No event-driven architecture (synchronous, tightly coupled)\n* No Anti-Corruption Layer protecting digital channels\n* Viva Energy support teams use Salesforce, OTR digital support uses D365 CE (fragmented)\n\n==== Technical Debt\n\n*No longer relevant* - D365 CE being deprecated, not documenting technical debt of system being retired.\n\n*New technical debt introduced by this migration:*\n\n* Salesforce field mapping TBD (requires coordination with Viva Energy Salesforce admin team)\n* Data isolation strategy TBD (Record Types, custom fields, queues - multi-tenant governance)\n* Salesforce webhook mechanism TBD (Outbound Messages vs Platform Events vs Process Builder)\n* Expected feedback volume unknown (gathering data for rate limit planning)\n\n=== Gap Analysis\n\n==== Missing Capabilities\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Missing Capability |Description\n\n|*ProfileService bounded context*\n|No existing service for Contact reconciliation with Salesforce - requires new microservice implementing JIT upsert by email, returning Salesforce Contact ID\n\n|*EngagementService bounded context*\n|No existing service for customer feedback facade - requires new microservice implementing Anti-Corruption Layer for Salesforce Case creation, Braze integration, async processing via Event Bus\n\n|*Event Bus domain event pattern*\n|No existing domain event publishing infrastructure - requires implementing event-driven architecture pattern using existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis)\n\n|*Async Case creation workflow*\n|Current D365 CE integration is synchronous - requires implementing async processing with retry logic, exponential backoff, dead letter queue\n\n|*Salesforce webhook integration*\n|No existing capability to receive Salesforce notifications - requires implementing webhook receiver in EngagementService for Case update notifications\n\n|*Braze push notification orchestration*\n|No existing integration for Case-related push notifications - requires implementing Braze campaign triggers from EngagementService\n\n|*Contact migration tooling*\n|No existing tooling for app database → Salesforce Contact migration with upsert logic (match by email/phone/VCI)\n\n|*Feedback form enhancements*\n|Mobile App feedback form lacks structured fields (Category, Store Name, Time of Visit, Contact Phone Number) - requires UI updates\n\n|===\n\n==== Missing Bounded Contexts\n\n[width=\"100%\",cols=\"30%,30%,40%\",options=\"header\",]\n|===\n|Bounded Context |Responsibilities |Implementation Status\n\n|*link:../bounded_context/profile.adoc[ProfileService]*\n|JIT Contact reconciliation with Salesforce (upsert by email), return Salesforce Contact ID to digital channels, foundation for future Flybuys partner linking\n|**NEW** - First bounded context implementation\n\n|*link:../bounded_context/engagement.adoc[EngagementService]*\n|Customer feedback submission facade, Anti-Corruption Layer for Salesforce Case creation, Braze integration for push notifications, async Case processing, webhook receiver for Case updates\n|**NEW** - First bounded context implementation\n\n|===\n\n==== Missing Integration Patterns\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Integration Pattern |Description\n\n|*Anti-Corruption Layer (ACL)*\n|EngagementService → Salesforce Service Cloud - protects digital channels from Salesforce API changes, translates between OTR domain language and Salesforce\n\n|*Conformist*\n|ProfileService/EngagementService → Salesforce - conform to existing Salesforce configuration and API contracts (shared Viva Energy instance)\n\n|*Event-Driven Architecture (OHS+PL)*\n|Event Bus publishing domain events (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`) for loose coupling between bounded contexts\n\n|*Just-In-Time (JIT) Integration*\n|ProfileService → Salesforce Contact reconciliation on-demand (no pre-sync)\n\n|*Async Processing*\n|EngagementService Case creation via Event Bus with retry, exponential backoff, dead letter queue\n\n|===\n\n=== Target State Architecture\n\n==== Architectural Building Blocks (ABB)\n\n[width=\"100%\",cols=\"20%,25%,30%,25%\",options=\"header\",]\n|===\n|ABB ID |Bounded Context |Responsibilities |Technology (TBD in Solution Architecture)\n\n|ABB-CS-001\n|*link:../bounded_context/profile.adoc[ProfileService]*\n|JIT Contact reconciliation with Salesforce (upsert by email), return Salesforce Contact ID, foundation for Flybuys partner linking\n|Microservice (.NET/Node.js), REST API, Salesforce REST API client\n\n|ABB-CS-002\n|*link:../bounded_context/engagement.adoc[EngagementService]*\n|Customer feedback submission facade, ACL for Salesforce Case creation, Braze integration, async processing, webhook receiver\n|Microservice (.NET/Node.js), REST API, Event Bus publisher/subscriber, Salesforce webhook receiver\n\n|ABB-CS-003\n|*Event Bus*\n|Domain event publishing infrastructure (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`)\n|AWS SNS+SQS / EventBridge / Kinesis\n\n|ABB-CS-004\n|*Salesforce Service Cloud*\n|System of Record for Contact and Case data (shared Viva Energy instance)\n|Salesforce Service Cloud (external SaaS)\n\n|ABB-CS-005\n|*Braze*\n|Marketing automation platform for push notifications\n|Braze (external SaaS) - existing integration\n\n|ABB-CS-006\n|*Mobile App*\n|iOS/Android native apps with enhanced feedback form (Category, Store Name, Time of Visit, Contact Phone Number, Free Text Message)\n|Kotlin Multiplatform, SwiftUI, Jetpack Compose\n\n|ABB-CS-007\n|*Contact Migration Tool*\n|One-time migration app database → Salesforce with upsert logic (match by email/phone/VCI)\n|Script/tool (.NET/Python/Node.js)\n\n|===\n\n==== Integration Architecture\n\n===== Integration Flows\n\n*Customer Feedback Submission (Async):*\n\n1. *Mobile App* → ProfileService: Authenticate user, get Salesforce Contact ID (JIT reconciliation)\n2. *Mobile App* → EngagementService: Submit feedback (POST /feedback with Contact ID, Category, Store Name, Time of Visit, Phone, Message)\n3. *EngagementService* → Mobile App: Immediate acknowledgment (\"Feedback submitted\")\n4. *EngagementService* → Event Bus: Publish work item for async Case creation\n5. *Background Worker* (EngagementService) → Salesforce: Create Case via REST API\n6. *Success*: EngagementService → Event Bus: Publish `SupportCaseCreated` event\n7. *EngagementService* → Braze: Trigger push notification campaign (\"Your feedback has been received, Case #12345\")\n8. *Failure*: Retry with exponential backoff → Dead Letter Queue → Ops team alert\n\n*Case Update Notification (Bidirectional):*\n\n1. *Support Agent* updates/resolves Case in Salesforce\n2. *Salesforce* → EngagementService: Webhook notification (Case updated)\n3. *EngagementService* → Event Bus: Publish `SupportCaseUpdated` or `SupportCaseResolved` event\n4. *EngagementService* → Braze: Trigger push notification campaign (\"Your case has been resolved\")\n\n*Contact Reconciliation (JIT):*\n\n1. *Mobile App user* authenticates\n2. *Mobile App* → ProfileService: GET /profile/contact-id\n3. *ProfileService* → Salesforce: Query Contact by email\n4. *Match found*: Return existing Salesforce Contact ID\n5. *No match*: Create new Contact in Salesforce, return new Contact ID\n6. *ProfileService* → Mobile App: Return Salesforce Contact ID (cached by Mobile App)\n\n===== System of Record Boundaries\n\n[width=\"100%\",cols=\"30%,35%,35%\",options=\"header\",]\n|===\n|Data Entity |System of Record |Rationale\n\n|*Contact*\n|Salesforce Service Cloud\n|Shared Viva Energy instance, unified customer profile across all channels (digital, wholesale, Shell Card, retail)\n\n|*Case*\n|Salesforce Service Cloud\n|Support agents manage Cases in Salesforce, digital channels submit via EngagementService ACL\n\n|*Feedback Submission (transient)*\n|None (no persistence)\n|EngagementService processes feedback and creates Case in Salesforce, no local storage\n\n|*Domain Events*\n|Event Bus (ephemeral)\n|Events published to Event Bus, consumed by subscribers, not persisted long-term (event sourcing not in scope)\n\n|===\n\n==== Data Architecture Principles\n\n===== Aggregate Persistence\n\n*ProfileService:*\n\n* **No local aggregate persistence** - ProfileService is stateless, queries Salesforce on-demand\n* Salesforce Contact is the aggregate root (owned by Salesforce)\n* ProfileService acts as facade/translator, not system of record\n\n*EngagementService:*\n\n* **No local aggregate persistence** - EngagementService is stateless, creates Cases in Salesforce via ACL\n* Salesforce Case is the aggregate root (owned by Salesforce)\n* EngagementService maintains no local Case state (Conformist pattern - trust Salesforce as source of truth)\n* Async processing state managed via Event Bus (work items in queue, not database)\n\n===== Event Store\n\n* **Event Bus** (SNS+SQS/EventBridge/Kinesis) handles domain event publishing\n* Events are **ephemeral** (consumed and discarded, not persisted for event sourcing)\n* No Event Store implementation in this architecture (future enhancement if needed)\n* Event schema versioning TBD in Solution Architecture\n\n\n=== Architecture Decisions\n\n==== ADR-CS-001: Consolidate onto Salesforce Service Cloud (not build custom solution)\n\n*Status*: Accepted\n\n*Context*:\n\n* D365 Customer Engagement not working well for digital customer support\n* Viva Energy already uses Salesforce Service Cloud for fuel wholesale, Shell Card, other retail channels\n* Post-merger opportunity to consolidate onto single platform\n* Alternative: Build custom support platform or use different SaaS\n\n*Decision*:\n\nConsolidate OTR digital customer support onto Salesforce Service Cloud (shared Viva Energy instance).\n\n*Rationale*:\n\n* **Unified customer view**: Support agents see all interactions across channels (digital, wholesale, Shell Card, retail)\n* **Platform consolidation**: Single support platform reduces operational overhead and costs\n* **Proven solution**: Salesforce Service Cloud is established, feature-rich, well-supported\n* **Post-merger alignment**: Strategic decision to standardize on Viva Energy platforms\n* **Avoid custom development**: Building custom support platform would be costly and high-risk\n\n*Consequences*:\n\n* Unified customer support across Viva Energy Group\n* Reduced operational complexity (single platform vs two)\n* Leverage Salesforce capabilities (case routing, knowledge base, AI, omnichannel)\n* ⚠️ Conformist pattern required (shared instance, conform to existing configuration)\n* ⚠️ Multi-tenant governance needed (data isolation, security, queues)\n* ❌ Less control over platform evolution (SaaS vendor, shared instance)\n\n==== ADR-CS-002: Implement ProfileService and EngagementService as first DDD bounded contexts\n\n*Status*: Accepted\n\n*Context*:\n\n* OTR target architecture uses Domain-Driven Design with bounded contexts\n* This migration is opportunity to establish first implementation\n* Alternative: Direct Mobile App → Salesforce integration (no bounded contexts)\n* Alternative: Single monolithic service for all customer-facing APIs\n\n*Decision*:\n\nImplement ProfileService and EngagementService as separate bounded contexts following DDD strategic patterns.\n\n*Rationale*:\n\n* **Foundation for target architecture**: First implementation of DDD pattern for future bounded contexts (Flybuys, LocationService, PaymentService)\n* **Separation of concerns**: ProfileService handles identity/Contact reconciliation, EngagementService handles support/feedback (different responsibilities, different change rates)\n* **Anti-Corruption Layer**: EngagementService protects digital channels from Salesforce API changes\n* **Reusability**: ProfileService Contact reconciliation reused for Flybuys integration\n* **Event-driven architecture**: Establishes pattern for loose coupling between bounded contexts\n\n*Consequences*:\n\n* Establishes DDD architecture foundation for OTR\n* Reusable ProfileService for Flybuys and future integrations\n* Digital channels protected from Salesforce API changes (ACL)\n* Clear bounded context boundaries and responsibilities\n* ⚠️ Increased initial complexity (two new microservices vs direct integration)\n* ⚠️ Requires Event Bus infrastructure implementation\n* ⚠️ Team must learn DDD patterns and bounded context design\n\n==== ADR-CS-003: Async Case creation via Event Bus (not synchronous)\n\n*Status*: Accepted\n\n*Context*:\n\n* Current D365 CE integration is synchronous (user waits for Case creation)\n* Alternative: Keep synchronous integration (Mobile App → EngagementService → Salesforce synchronously)\n* Salesforce API may experience downtime or latency\n\n*Decision*:\n\nImplement async Case creation via Event Bus with immediate user acknowledgment, retry logic, exponential backoff, and dead letter queue.\n\n*Rationale*:\n\n* **Non-blocking user experience**: User gets immediate \"Feedback submitted\" confirmation, not waiting for Salesforce API\n* **Resilience**: If Salesforce is down, feedback still accepted, Case created when Salesforce recovers\n* **Retry logic**: Automatic retry with exponential backoff handles transient failures\n* **Operational visibility**: Dead letter queue alerts ops team to persistent failures\n* **Scalability**: Queue buffering handles traffic spikes\n\n*Consequences*:\n\n* Better user experience (no waiting for Salesforce API)\n* Resilient to Salesforce downtime (queue buffers work)\n* Automatic retry reduces manual intervention\n* Queue depth monitoring provides operational visibility\n* ⚠️ Eventual consistency (user gets success notification after Case created, not immediately)\n* ⚠️ Increased complexity (Event Bus, background workers, retry logic, DLQ)\n* ⚠️ Requires monitoring and alerting for DLQ\n\n==== ADR-CS-004: ProfileService uses email as primary matching key (not VCI)\n\n*Status*: Accepted\n\n*Context*:\n\n* ProfileService needs to reconcile Mobile App users as Salesforce Contacts\n* Alternative matching keys: VCI (Viva Consumer ID), email, phone, Salesforce External ID\n* Email changes are rare but possible\n\n*Decision*:\n\nUse email address as primary matching key for Contact reconciliation (JIT upsert by email).\n\n*Rationale*:\n\n* **Availability**: Email always available for authenticated users\n* **Uniqueness**: Email is unique identifier in Salesforce and Mobile App\n* **Salesforce standard**: Salesforce Contact uses email as standard lookup field\n* **Simplicity**: Single matching key simplifies upsert logic\n* **Edge case acceptable**: Email changes are rare, manual cleanup acceptable\n\n*Consequences*:\n\n* Simple upsert logic (query by email, create if not found)\n* Leverages Salesforce standard email field\n* Email always available from authentication\n* ⚠️ Email changes create duplicate Contacts (rare edge case, manual cleanup)\n* ⚠️ Future enhancement: Add VCI as Salesforce External ID for stable matching\n\n==== ADR-CS-005: No Case migration from D365 CE (fresh start)\n\n*Status*: Accepted\n\n*Context*:\n\n* D365 CE contains historical customer support Cases\n* Alternative: Migrate historical Cases to Salesforce (preserve support history)\n* Alternative: Archive D365 CE Cases separately (read-only access)\n\n*Decision*:\n\nDo not migrate historical Cases from D365 CE to Salesforce. Start fresh in Salesforce.\n\n*Rationale*:\n\n* **Limited value**: Historical D365 CE Cases not critical for future support\n* **Data quality**: D365 CE Case data may be inconsistent or incomplete\n* **Complexity**: Case migration requires mapping D365 CE schema to Salesforce, data transformation, validation\n* **Cost-benefit**: Migration effort outweighs value of historical data\n* **Archive option**: D365 CE Cases can be archived separately if needed (read-only access for auditing)\n\n*Consequences*:\n\n* Simpler migration (Contacts only, no Case migration)\n* Faster time to value (no Case migration delay)\n* Clean start in Salesforce (no legacy data quality issues)\n* ⚠️ Historical Cases not visible in Salesforce (support agents can't see old Cases)\n* ⚠️ D365 CE must remain accessible temporarily for historical Case lookups (if needed)\n* ❌ Loss of historical Case insights (reporting, analytics on old Cases)\n\n==== ADR-CS-006: Big bang cutover (not phased rollout)\n\n*Status*: Accepted\n\n*Context*:\n\n* Alternative: Phased rollout with feature flags (pilot users first, gradual enablement)\n* Alternative: Parallel run (submit to both D365 CE and Salesforce temporarily)\n* Flybuys integration uses phased rollout (AS-1, AS-2, AS-3 architecture states)\n\n*Decision*:\n\nBig bang cutover - migrate Contacts, deploy ProfileService and EngagementService, switch Mobile App, retire D365 CE.\n\n*Rationale*:\n\n* **Simplicity**: No parallel run complexity, no feature flag management\n* **Faster D365 CE retirement**: No extended transition period maintaining two systems\n* **Limited risk**: Customer support not mission-critical (not payment processing), rollback possible\n* **User base manageable**: OTR digital customers smaller than Flybuys integration scope\n* **Different use case**: Flybuys phased rollout manages points accrual complexity, support feedback is simpler\n\n*Consequences*:\n\n* Simpler deployment (single cutover, no AS-1/AS-2/AS-3 states)\n* Faster D365 CE retirement (no extended parallel run)\n* No feature flag complexity or pilot user management\n* ⚠️ Higher cutover risk (all users switch at once)\n* ⚠️ Requires comprehensive testing before cutover\n* ⚠️ Rollback plan required (revert to D365 CE if critical issues)\n\n==== ADR-CS-007: EngagementService receives Salesforce webhooks for Case updates\n\n*Status*: Accepted\n\n*Context*:\n\n* Support agents update/resolve Cases in Salesforce\n* Need to notify customers of Case status changes via push notifications\n* Alternative: Poll Salesforce API for Case updates (inefficient)\n* Alternative: No customer notifications (agents contact customers directly)\n\n*Decision*:\n\nSalesforce sends webhook notifications to EngagementService when Cases are updated/resolved. EngagementService triggers Braze push notifications.\n\n*Rationale*:\n\n* **Real-time notifications**: Customer notified immediately when agent resolves Case\n* **Efficient**: Webhook push model (not polling)\n* **Event-driven**: Aligns with event-driven architecture pattern\n* **Better customer experience**: Proactive notification vs waiting for agent contact\n\n*Consequences*:\n\n* Real-time customer notifications for Case updates\n* Efficient push model (no polling overhead)\n* Bidirectional integration (Mobile App → Salesforce → Mobile App)\n* ⚠️ Salesforce webhook mechanism TBD (Outbound Messages vs Platform Events vs Process Builder)\n* ⚠️ Webhook authentication and security required\n* ⚠️ EngagementService must handle webhook retries and failures\n\n<<<\n== Interface Specifications\n\nThis section provides references to the complete API specifications and event catalogue for ProfileService and EngagementService.\n\n=== REST API Specifications\n\nComplete OpenAPI 3.0 specifications are maintained in the `specifications/rest/` directory:\n\n==== ProfileService API v1\n\n*Specification*: link:../../specifications/rest/profile-service-v1.yaml[profile-service-v1.yaml]\n\n*Base URL*: `https://api.otr.com.au/profile/v1`\n\n*Authentication*: Bearer token (Microsoft Entra External ID JWT)\n\n*Key Endpoints*:\n\n* `GET /contact-id` - Retrieve or create Salesforce Contact ID for authenticated user (Just-In-Time reconciliation)\n** Used by Mobile App before submitting feedback to EngagementService\n** Upserts Salesforce Contact record using email as external key\n** Returns 18-character Salesforce Contact ID with caching (15-minute TTL)\n** Performance SLA: p95 < 300ms (uncached), p95 < 50ms (cached)\n\n==== EngagementService API v1\n\n*Specification*: link:../../specifications/rest/engagement-service-v1.yaml[engagement-service-v1.yaml]\n\n*Base URL*: `https://api.otr.com.au/engagement/v1`\n\n*Authentication*: Bearer token (Microsoft Entra External ID JWT)\n\n*Key Endpoints*:\n\n* `POST /feedback` - Submit customer feedback for async Case creation in Salesforce\n** Accepts contactId, category, storeName, timeOfVisit, contactPhoneNumber, message\n** Returns 202 Accepted immediately (async Case creation in background)\n** Publishes `CustomerFeedbackSubmitted` event for analytics\n** Creates Salesforce Case via Anti-Corruption Layer with retry logic\n** Performance SLA: p95 < 200ms (feedback accepted, not Case creation)\n\n=== Domain Events (AsyncAPI)\n\nComplete CloudEvents 1.0 JSON Schema specifications are maintained in the `specifications/events/` directory:\n\n*Specification*: link:../../specifications/events/engagement-events.json[engagement-events.json]\n\n==== Event Catalogue\n\n[width=\"100%\",cols=\"30%,20%,50%\",options=\"header\",]\n|===\n|Event Type |Publisher |Consumers\n\n|`CustomerFeedbackSubmitted`\n|EngagementService\n|Future bounded contexts, analytics, sentiment analysis\n\n|`SupportCaseCreated`\n|EngagementService\n|Future bounded contexts, analytics\n\n|`SupportCaseUpdated`\n|EngagementService (via Salesforce webhook)\n|Future bounded contexts, analytics\n\n|`SupportCaseResolved`\n|EngagementService (via Salesforce webhook)\n|Future bounded contexts, analytics\n\n|===\n\n==== Event Delivery Guarantees\n\n* **At-least-once delivery**: Events may be delivered multiple times, consumers must handle idempotency\n* **Ordering**: FIFO queues guarantee ordering for events with same `contactId`\n* **Retention**: 4 days (96 hours) in Event Bus\n* **Dead Letter Queue**: Failed events after 5 retries moved to DLQ for manual intervention\n* **Format**: CloudEvents 1.0 specification with JSON payload\n\n=== API Versioning Policy\n\n==== Version Numbering\n\n* **Format**: `/v{major}` in URL path (e.g., `/profile/v1`, `/engagement/v1`)\n* **Semantic Versioning**: Major version incremented for breaking changes only\n* **Backwards Compatibility**: Minor changes (new optional fields, new endpoints) don't require version bump\n\n==== When to Version\n\n*Breaking changes requiring new major version*:\n\n- Removing or renaming fields in request/response\n- Changing field data types (e.g., string → number)\n- Changing authentication mechanism\n- Removing endpoints\n\n*Non-breaking changes not requiring version bump*:\n\n- Adding new optional fields to request/response\n- Adding new endpoints\n- Expanding enum values (e.g., adding new feedback category)\n- Improving error messages\n\n==== Parallel Version Support\n\n* Support N and N-1 versions concurrently for 6 months\n* Deprecation notice: 3 months before sunsetting old version\n* Mobile App must upgrade to new version within deprecation window\n\n<<<\n== Work Packages\n\nThis section consolidates gaps and activities into implementable work packages aligned with TOGAF Phase E requirements.\n\n=== Work Package Overview\n\n[width=\"100%\",cols=\"15%,35%,25%,25%\",options=\"header\",]\n|===\n|Work Package ID |Name |Transition State |Key Deliverables\n\n|WP-CS-001\n|ProfileService Development\n|TS-1 (Build & Test)\n|ProfileService microservice, Salesforce Contact integration, REST API\n\n|WP-CS-002\n|EngagementService Development\n|TS-1 (Build & Test)\n|EngagementService microservice, Anti-Corruption Layer, Braze integration\n\n|WP-CS-003\n|Event Bus Infrastructure\n|TS-1 (Build & Test)\n|Event Bus configuration, CloudEvents schemas, monitoring\n\n|WP-CS-004\n|Contact Migration Tooling\n|TS-1 (Build & Test)\n|Migration tool, validation scripts, reconciliation reporting\n\n|WP-CS-005\n|Mobile App Integration\n|TS-1 (Build & Test)\n|Mobile App API integration, feedback form enhancements, testing\n\n|WP-CS-006\n|Integration Testing\n|TS-1 (Build & Test)\n|Test environments, integration test suites, UAT execution\n\n|WP-CS-007\n|Salesforce Configuration\n|TS-1 (Build & Test)\n|Salesforce field mapping, data isolation, webhook configuration\n\n|WP-CS-008\n|Contact Data Migration\n|TS-2 (Contact Migration)\n|Contact migration execution, validation, reconciliation\n\n|WP-CS-009\n|Production Deployment\n|TS-3 (Cutover)\n|Production deployment, smoke testing, go-live execution\n\n|WP-CS-010\n|Post-Cutover Support\n|TS-4 (Target State)\n|Monitoring, issue resolution, D365 CE retirement\n\n|===\n\n[[wp-cs-001]]\n=== WP-CS-001: ProfileService Development\n\n==== Description\n\nBuild ProfileService bounded context microservice implementing Just-In-Time Contact reconciliation with Salesforce Service Cloud.\n\n==== Deliverables\n\n* ProfileService microservice application\n** REST API implementation (OpenAPI 3.0 specification)\n** `GET /contact-id` endpoint (Salesforce Contact reconciliation)\n** Authentication/authorization with Microsoft Entra External ID\n** Caching layer (15-minute TTL for Contact IDs)\n* Salesforce integration\n** Salesforce REST API client\n** Contact upsert by email (external key matching)\n** Error handling and retry logic\n* Unit tests (>80% code coverage)\n* Integration tests with Salesforce sandbox\n* API documentation\n* Deployment configuration (IaC - Infrastructure as Code)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* Salesforce sandbox environment provisioned\n* Microsoft Entra External ID OAuth configuration\n* Development environment setup (AWS dev account, CI/CD pipeline)\n\n*Dependent Work Packages*:\n\n* None (can start immediately after prerequisites met)\n\n==== Skills Required\n\n* Backend development (.NET Core or Node.js)\n* REST API design and implementation\n* Salesforce REST API integration\n* OAuth 2.0 / JWT authentication\n* Caching strategies (Redis/ElastiCache)\n* Unit/integration testing frameworks\n* Infrastructure as Code (Terraform/CloudFormation)\n\n==== Acceptance Criteria\n\n* All API endpoints return correct HTTP status codes per OpenAPI specification\n* Contact ID retrieval achieves p95 < 300ms (uncached), p95 < 50ms (cached)\n* Salesforce Contact upsert succeeds with 100% accuracy in sandbox testing\n* Unit test coverage > 80%\n* Integration tests pass in sandbox environment\n* API documentation generated from OpenAPI specification\n\n[[wp-cs-002]]\n=== WP-CS-002: EngagementService Development\n\n==== Description\n\nBuild EngagementService bounded context microservice implementing customer feedback submission, Anti-Corruption Layer for Salesforce Case creation, Braze integration, and webhook receiver for Case updates.\n\n==== Deliverables\n\n* EngagementService microservice application\n** REST API implementation (OpenAPI 3.0 specification)\n** `POST /feedback` endpoint (async feedback submission)\n** Authentication/authorization with Microsoft Entra External ID\n** Webhook receiver endpoint for Salesforce Case updates\n* Anti-Corruption Layer (ACL)\n** OTR domain model to Salesforce API translation\n** Category enum mapping (App/Service/Order/Rewards → Salesforce Case fields)\n** Salesforce REST API client for Case creation\n* Async processing infrastructure\n** Event Bus publisher integration\n** Background worker for Case creation\n** Retry logic with exponential backoff (5 attempts)\n** Dead Letter Queue integration\n* Braze integration\n** Braze campaign trigger API client\n** Push notification orchestration for Case updates\n* Domain event publishing\n** `CustomerFeedbackSubmitted` event publisher\n** `SupportCaseCreated` event publisher\n** `SupportCaseUpdated` event translator (Salesforce webhook → domain event)\n** `SupportCaseResolved` event translator (Salesforce webhook → domain event)\n* Unit tests (>80% code coverage)\n* Integration tests (EngagementService ↔ Salesforce, EngagementService ↔ Braze)\n* API documentation\n* Deployment configuration (IaC)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-003 (Event Bus Infrastructure) completed\n* Salesforce sandbox environment provisioned\n* Braze API credentials and campaign templates configured\n* Microsoft Entra External ID OAuth configuration\n\n*Dependent Work Packages*:\n\n* WP-CS-003 must be completed first (Event Bus required for async processing)\n* WP-CS-007 (Salesforce Configuration) must be in progress (field mapping needed)\n\n==== Skills Required\n\n* Backend development (.NET Core or Node.js)\n* REST API design and implementation\n* Salesforce REST API integration\n* Event-driven architecture patterns\n* Async/background processing (queues, workers)\n* Braze API integration\n* Webhook design and security\n* OAuth 2.0 / JWT authentication\n* Domain-Driven Design (DDD) - Anti-Corruption Layer pattern\n* Unit/integration testing frameworks\n* Infrastructure as Code (Terraform/CloudFormation)\n\n==== Acceptance Criteria\n\n* Feedback submission endpoint returns 202 Accepted within p95 < 200ms\n* Async Case creation succeeds with >99.5% success rate (including retries)\n* Anti-Corruption Layer correctly maps all feedback categories to Salesforce Case fields\n* Webhook receiver processes Salesforce Case updates and publishes domain events\n* Braze push notifications sent successfully for Case updates\n* Failed Case creation moves to Dead Letter Queue after 5 retry attempts\n* Unit test coverage > 80%\n* Integration tests pass with Salesforce sandbox and Braze staging environment\n\n[[wp-cs-003]]\n=== WP-CS-003: Event Bus Infrastructure\n\n==== Description\n\nImplement Event Bus infrastructure for domain event publishing using existing AWS infrastructure (SNS+SQS, EventBridge, or Kinesis).\n\n==== Deliverables\n\n* Event Bus infrastructure configuration\n** Topic/stream provisioning (technology choice: SNS+SQS / EventBridge / Kinesis)\n** FIFO queue configuration (ordering by `contactId`)\n** Dead Letter Queue (DLQ) setup\n** Retention policy (4 days / 96 hours)\n** Access control policies (IAM roles, permissions)\n* CloudEvents 1.0 schema definitions\n** JSON Schema specifications for all domain events\n** Schema validation configuration\n** Schema registry (if using EventBridge/Kinesis)\n* Monitoring and alerting\n** CloudWatch dashboards for queue metrics\n** Alarms for DLQ depth, queue age, processing failures\n** Event Bus throughput monitoring\n* Documentation\n** Event Bus architecture diagram\n** Event publishing guidelines\n** Consumer integration guide\n* Infrastructure as Code (IaC)\n** Terraform/CloudFormation templates for all infrastructure\n\n==== Dependencies\n\n*Prerequisites*:\n\n* AWS account access (existing infrastructure)\n* Technology selection decision (SNS+SQS vs EventBridge vs Kinesis)\n* CloudEvents 1.0 schema design approval\n\n*Dependent Work Packages*:\n\n* None (foundational infrastructure, can start early)\n\n==== Skills Required\n\n* AWS messaging services (SNS, SQS, EventBridge, Kinesis)\n* Event-driven architecture patterns\n* CloudEvents specification\n* JSON Schema design\n* Infrastructure as Code (Terraform/CloudFormation)\n* AWS IAM security configuration\n* CloudWatch monitoring and alerting\n\n==== Acceptance Criteria\n\n* Event Bus infrastructure provisioned in all environments (dev, staging, production)\n* FIFO ordering validated for events with same `contactId`\n* Dead Letter Queue triggers alarms when messages arrive\n* Event retention policy enforced (4 days)\n* CloudEvents 1.0 schema validation enabled\n* Monitoring dashboards operational\n* Infrastructure fully codified (IaC)\n\n[[wp-cs-004]]\n=== WP-CS-004: Contact Migration Tooling\n\n==== Description\n\nDevelop Contact migration tool for one-time migration from app-specific database to Salesforce Service Cloud with upsert logic and validation.\n\n==== Deliverables\n\n* Contact migration tool\n** Extract Contacts from app-specific database\n** Transform to Salesforce Contact API format\n** Upsert to Salesforce using email as external key\n** Fallback matching by phone number or Viva Consumer ID\n** Batch processing with rate limiting (respect Salesforce API limits)\n** Idempotent operation (can be re-run safely)\n* Validation scripts\n** Pre-migration validation (data quality checks)\n** Post-migration validation (100% Contact reconciliation)\n** Email/phone/VCI matching accuracy report\n* Reconciliation reporting\n** Contacts created vs updated statistics\n** Failed upserts with error details\n** Matching accuracy metrics\n* Rollback capability\n** Export snapshot of Salesforce Contacts before migration\n** Rollback procedure documentation\n* Documentation\n** Migration tool user guide\n** Troubleshooting guide\n** Runbook for migration execution\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-001 (ProfileService Development) completed (reuses Salesforce integration code)\n* Salesforce sandbox environment for migration testing\n* App-specific database access (read-only sufficient)\n* Salesforce production access granted\n\n*Dependent Work Packages*:\n\n* WP-CS-001 provides Salesforce Contact upsert logic to reuse\n\n==== Skills Required\n\n* Database development (SQL, data extraction)\n* Salesforce REST API integration\n* Batch processing and ETL patterns\n* Data validation and reconciliation\n* Error handling and logging\n* Scripting (Python, PowerShell, or similar)\n\n==== Acceptance Criteria\n\n* Migration tool successfully migrates 100% of Contacts in sandbox with zero data loss\n* Email/phone/VCI matching accuracy > 95% in sandbox testing\n* Failed upserts captured with actionable error messages\n* Reconciliation report matches actual Salesforce Contact counts\n* Migration tool execution time acceptable for production (freezes app database for minimum time)\n* Rollback procedure validated in sandbox\n* Documentation complete and approved\n\n[[wp-cs-005]]\n=== WP-CS-005: Mobile App Integration\n\n==== Description\n\nUpdate Mobile App to integrate with ProfileService and EngagementService APIs, replacing D365 CE integration.\n\n==== Deliverables\n\n* Feedback form UI enhancements\n** Add Category dropdown (App, Service, Order, Rewards, Refund, Delete Account)\n** Add Store Name field (optional)\n** Add Time of Visit field (optional, datetime picker)\n** Add Contact Phone Number field (optional, E.164 validation)\n** Update Message field (1-2000 character limit with counter)\n* API integration (Kotlin Multiplatform shared code)\n** ProfileService client (`GET /contact-id`)\n** EngagementService client (`POST /feedback`)\n** JWT token management (Microsoft Entra External ID)\n** Error handling (network failures, API errors, validation errors)\n** Retry logic for transient failures\n* Platform-specific UI (SwiftUI for iOS, Jetpack Compose for Android)\n** Feedback form screens\n** Success/error confirmation screens\n** Loading states and progress indicators\n* Feature flag integration\n** `enable_salesforce_feedback_submission` flag\n** Fallback to D365 CE if flag disabled (during rollout)\n* Unit tests for shared business logic\n* UI tests for platform-specific screens\n* API integration tests (mocked APIs)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-001 (ProfileService Development) completed and deployed to dev/staging\n* WP-CS-002 (EngagementService Development) completed and deployed to dev/staging\n* ProfileService and EngagementService OpenAPI specifications finalized\n* Feature flag service configured\n\n*Dependent Work Packages*:\n\n* Must complete after WP-CS-001 and WP-CS-002 (requires API endpoints available for integration testing)\n\n==== Skills Required\n\n* Kotlin Multiplatform development\n* SwiftUI (iOS native UI)\n* Jetpack Compose (Android native UI)\n* REST API client development\n* OAuth 2.0 / JWT authentication\n* Form validation and UX design\n* Unit testing (Kotlin, Swift)\n* UI testing frameworks (XCTest, Espresso)\n\n==== Acceptance Criteria\n\n* Feedback form UI matches UX design specifications\n* All form fields validate correctly (client-side validation)\n* API integration successfully calls ProfileService and EngagementService in dev/staging\n* Error handling provides user-friendly error messages\n* Feature flag correctly toggles between Salesforce and D365 CE integration\n* Unit test coverage > 80% for shared business logic\n* UI tests pass for all feedback form workflows (happy path, error states)\n* App builds and deploys successfully to TestFlight (iOS) and Google Play Internal Testing (Android)\n\n[[wp-cs-006]]\n=== WP-CS-006: Integration Testing\n\n==== Description\n\nExecute comprehensive integration testing across all system components in non-production environments.\n\n==== Deliverables\n\n* Test environment setup\n** Salesforce sandbox configured with test data\n** ProfileService deployed to staging\n** EngagementService deployed to staging\n** Event Bus staging infrastructure\n** Braze staging environment configured\n** Mobile App TestFlight/Internal Testing builds\n* Integration test suites\n** ProfileService ↔ Salesforce (Contact upsert scenarios)\n** EngagementService ↔ Salesforce (Case creation scenarios)\n** EngagementService ↔ Braze (push notification scenarios)\n** Mobile App ↔ ProfileService ↔ EngagementService (end-to-end workflows)\n** Event Bus publishing and consumption\n** Webhook receiver (Salesforce → EngagementService)\n* Test scenarios\n** Happy path: Successful feedback submission and Case creation\n** Error scenarios: Salesforce API failures, Braze API failures, network timeouts\n** Retry scenarios: Async Case creation retries, DLQ validation\n** Performance testing: p95 latency validation for ProfileService and EngagementService\n** Load testing: Simulate 3x-10x expected volume\n* UAT execution\n** Business stakeholder UAT sessions\n** UAT test cases covering all feedback categories\n** UAT sign-off documentation\n* Test results documentation\n** Test execution reports\n** Defect tracking and resolution\n** Performance test results\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-001 (ProfileService Development) completed\n* WP-CS-002 (EngagementService Development) completed\n* WP-CS-003 (Event Bus Infrastructure) completed\n* WP-CS-005 (Mobile App Integration) completed\n* WP-CS-007 (Salesforce Configuration) sandbox configuration completed\n\n*Dependent Work Packages*:\n\n* Must complete after WP-CS-001, WP-CS-002, WP-CS-003, WP-CS-005 (requires all components available)\n\n==== Skills Required\n\n* Integration testing strategy and execution\n* Test automation frameworks (Postman, Newman, Selenium)\n* Performance testing tools (JMeter, k6, Gatling)\n* Salesforce sandbox administration\n* Test data management\n* Defect tracking and triage\n* UAT facilitation\n\n==== Acceptance Criteria\n\n* All integration test scenarios pass (happy path, error scenarios, retry scenarios)\n* Performance SLAs validated (ProfileService p95 < 300ms, EngagementService p95 < 200ms)\n* Load testing confirms system handles 3x expected volume without degradation\n* UAT sign-off obtained from business stakeholders\n* Zero critical defects (P1/P2) open before moving to Contact Migration\n* Test results documented and approved\n\n[[wp-cs-007]]\n=== WP-CS-007: Salesforce Configuration\n\n==== Description\n\nConfigure Salesforce Service Cloud for OTR digital customer support integration, including field mapping, data isolation, and webhook setup.\n\n==== Deliverables\n\n* Salesforce Contact configuration\n** Custom fields for OTR-specific data (if needed)\n** Email as external key configuration\n** Record Type for OTR digital customers (data isolation)\n** Validation rules\n* Salesforce Case configuration\n** Custom fields for feedback categories (App, Service, Order, Rewards, Refund, Delete Account)\n** Case Type and Reason picklist mapping\n** Queue assignment rules (OTR digital support queue)\n** Case escalation rules\n** Case routing rules\n* Salesforce webhook configuration\n** Platform Events / Outbound Messages for Case updates\n** Webhook authentication (API key, JWT, or OAuth)\n** Case status change triggers (New → In Progress, Resolved, Closed)\n** Webhook payload format (JSON)\n* Data isolation strategy\n** Record Types for OTR vs other Viva Energy business units\n** Queues for OTR-specific Cases\n** Reporting and dashboards scoped to OTR data\n* Salesforce API access\n** Connected App configuration\n** OAuth 2.0 JWT bearer flow setup\n** API user credentials\n** API rate limit monitoring\n* Documentation\n** Salesforce field mapping specification\n** Webhook configuration guide\n** Data isolation architecture diagram\n** API authentication setup guide\n\n==== Dependencies\n\n*Prerequisites*:\n\n* Viva Energy Salesforce admin team engagement\n* Salesforce governance approval (multi-tenant environment)\n* Technical decision on webhook mechanism (Platform Events vs Outbound Messages)\n* Technical decision on authentication method (OAuth 2.0 JWT bearer flow recommended)\n\n*Dependent Work Packages*:\n\n* None (can start in parallel with development work packages)\n* Required for WP-CS-002 (EngagementService needs field mapping)\n* Required for WP-CS-006 (Integration Testing needs sandbox configuration)\n\n==== Skills Required\n\n* Salesforce administration\n* Salesforce configuration (Record Types, Queues, Validation Rules)\n* Salesforce API integration (REST API, Platform Events, Outbound Messages)\n* Salesforce security and authentication (OAuth, Connected Apps)\n* Multi-tenant data isolation patterns\n\n==== Acceptance Criteria\n\n* Salesforce sandbox configured with all custom fields, Record Types, Queues\n* Field mapping documented and approved by OTR business stakeholders\n* Webhook configuration tested and delivering Case update notifications\n* Data isolation validated (OTR data separate from other Viva Energy business units)\n* API authentication working for ProfileService and EngagementService\n* Salesforce API rate limits monitored and acceptable for expected volume\n* Configuration replicated to Salesforce production environment\n\n=== WP-CS-008: Contact Data Migration\n\n==== Description\n\nExecute one-time Contact migration from app-specific database to Salesforce Service Cloud production.\n\n==== Deliverables\n\n* Pre-migration activities\n** Final validation of migration tool in sandbox\n** Communication plan (notify users of maintenance window if needed)\n** Freeze app-specific database Contact updates\n** Backup app-specific database\n** Export snapshot of Salesforce Contacts (rollback preparation)\n* Migration execution\n** Execute migration tool against Salesforce production\n** Monitor migration progress\n** Handle failed upserts (manual intervention if needed)\n* Post-migration validation\n** 100% Contact reconciliation (app database vs Salesforce)\n** Email/phone/VCI matching accuracy report\n** Reconciliation report (Contacts created vs updated)\n** Data integrity checks (no duplicate Contacts, no missing Contacts)\n* ProfileService smoke testing\n** Verify Contact ID retrieval works in production\n** Test cache behavior\n** Validate Salesforce Contact upserts from ProfileService\n* Migration report\n** Total Contacts migrated\n** Contacts created vs updated\n** Failed upserts (if any) with resolution\n** Matching accuracy metrics\n** Migration execution time\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-004 (Contact Migration Tooling) completed\n* WP-CS-001 (ProfileService Development) deployed to production (not yet integrated with Mobile App)\n* WP-CS-007 (Salesforce Configuration) production configuration completed\n* Salesforce production access granted\n* Migration approved by business stakeholders\n\n*Dependent Work Packages*:\n\n* Must complete after WP-CS-001, WP-CS-004, WP-CS-007\n* Must complete before WP-CS-009 (Production Deployment)\n\n==== Skills Required\n\n* Data migration execution\n* Salesforce administration\n* Database operations\n* Data validation and reconciliation\n* Incident management (if issues arise)\n\n==== Acceptance Criteria\n\n* 100% of Contacts migrated with zero data loss\n* Email/phone/VCI matching accuracy > 95%\n* ProfileService smoke tests pass in production\n* Reconciliation report approved by business stakeholders\n* App-specific database Contact updates frozen (read-only mode)\n* Rollback procedure ready (but not executed if migration successful)\n\n=== WP-CS-009: Production Deployment\n\n==== Description\n\nDeploy all solution components to production and execute cutover from D365 CE to Salesforce Service Cloud.\n\n==== Deliverables\n\n* Production deployment\n** EngagementService deployed to production\n** Event Bus production infrastructure validated\n** Salesforce webhook configured in production\n** Mobile App released to production (App Store, Google Play)\n* Go-live activities\n** Smoke testing (end-to-end feedback submission)\n** Feature flag enabled: `enable_salesforce_feedback_submission = ON`\n** D365 CE integration disabled in Mobile App\n** Monitor Event Bus queue depth, DLQ, Salesforce API rate limits\n** Monitor Mobile App feedback submission success rate\n* Go/No-Go decision\n** Validate success criteria before final cutover\n** Business stakeholder approval\n** Technical validation (smoke tests pass, monitoring healthy)\n* Cutover communication\n** Notify support agents of new Salesforce integration\n** Provide training materials for support agents\n** Customer communication (if visible change)\n* Rollback plan\n** Documented rollback procedure\n** Feature flag can disable Salesforce integration and re-enable D365 CE\n** Rollback decision criteria (P1/P2 incidents, feedback submission success rate < 99%)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-001 (ProfileService Development) completed\n* WP-CS-002 (EngagementService Development) completed\n* WP-CS-003 (Event Bus Infrastructure) completed\n* WP-CS-005 (Mobile App Integration) completed\n* WP-CS-006 (Integration Testing) completed with UAT sign-off\n* WP-CS-007 (Salesforce Configuration) production configuration completed\n* WP-CS-008 (Contact Data Migration) completed successfully\n* Mobile App release approval (App Store, Google Play)\n\n*Dependent Work Packages*:\n\n* Must complete after all prior work packages (final cutover)\n\n==== Skills Required\n\n* Production deployment and release management\n* Incident management and troubleshooting\n* Monitoring and observability\n* Change management and communication\n* Rollback execution (if needed)\n\n==== Acceptance Criteria\n\n* Mobile App feedback submission success rate > 99.5%\n* End-to-end flow validated (Mobile App → ProfileService → EngagementService → Salesforce Case created)\n* Braze push notifications delivered successfully\n* Event Bus queue depth normal, DLQ empty\n* No critical incidents (P1/P2) in first 24 hours\n* D365 CE integration disabled\n* Support agents successfully using Salesforce for OTR digital customer Cases\n\n=== WP-CS-010: Post-Cutover Support\n\n==== Description\n\nMonitor production stability, resolve issues, validate success criteria, and execute D365 CE retirement.\n\n==== Deliverables\n\n* Monitoring and support\n** 24/7 on-call support for first week post-cutover\n** Daily monitoring reports (feedback submission success rate, Case creation success rate)\n** Incident response and resolution\n** Performance tuning (if needed)\n* Success criteria validation\n** Validate feedback submission success rate > 99.5%\n** Monitor customer satisfaction score (target: +15% improvement within 6 months)\n** Monitor average case resolution time (target: -20% improvement within 6 months)\n** Support agent feedback survey\n* D365 CE retirement\n** D365 CE set to read-only mode (historical Case lookups only)\n** Archive D365 CE data for compliance/auditing\n** Decommission D365 CE infrastructure (after 90-day stabilization period)\n** Remove D365 CE integration code from Mobile App\n* Documentation updates\n** Production runbook\n** Troubleshooting guide (based on incidents resolved)\n** Operational procedures for support team\n** Lessons learned document\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-009 (Production Deployment) completed\n* Cutover successful with no critical incidents\n\n*Dependent Work Packages*:\n\n* Final work package in sequence\n\n==== Skills Required\n\n* Production support and incident management\n* Performance monitoring and tuning\n* Data archival and compliance\n* Infrastructure decommissioning\n* Documentation\n\n==== Acceptance Criteria\n\n* Zero critical incidents (P1/P2) in first 30 days post-cutover\n* Feedback submission success rate sustained > 99.5%\n* Customer satisfaction improvement validated (baseline established, ongoing measurement)\n* Support agents reporting positive experience with Salesforce unified view\n* D365 CE successfully decommissioned\n* All production documentation complete and approved\n* Lessons learned document published\n\n=== Work Package Sequencing\n\n==== Parallel Track 1: Infrastructure & Configuration\n\nCan start immediately and run in parallel:\n\n* WP-CS-003 (Event Bus Infrastructure)\n* WP-CS-007 (Salesforce Configuration)\n\n==== Parallel Track 2: Development\n\nCan start after Track 1 infrastructure decisions made:\n\n* WP-CS-001 (ProfileService Development) - Independent\n* WP-CS-002 (EngagementService Development) - Requires WP-CS-003 completed\n* WP-CS-004 (Contact Migration Tooling) - Requires WP-CS-001 completed (reuses code)\n\n==== Sequential Track 3: Integration & Testing\n\nMust complete after development:\n\n* WP-CS-005 (Mobile App Integration) - Requires WP-CS-001, WP-CS-002\n* WP-CS-006 (Integration Testing) - Requires WP-CS-001, WP-CS-002, WP-CS-003, WP-CS-005, WP-CS-007\n\n==== Sequential Track 4: Migration & Cutover\n\nMust complete sequentially:\n\n* WP-CS-008 (Contact Data Migration) - Requires WP-CS-001, WP-CS-004, WP-CS-006 UAT sign-off\n* WP-CS-009 (Production Deployment) - Requires all prior work packages completed\n* WP-CS-010 (Post-Cutover Support) - Requires WP-CS-009\n\n==== Critical Path\n\nThe critical path for this project is:\n\n. WP-CS-003 (Event Bus Infrastructure)\n. WP-CS-002 (EngagementService Development) - blocks on WP-CS-003\n. WP-CS-005 (Mobile App Integration) - blocks on WP-CS-001, WP-CS-002\n. WP-CS-006 (Integration Testing) - blocks on WP-CS-001 through WP-CS-005, WP-CS-007\n. WP-CS-008 (Contact Data Migration) - blocks on WP-CS-006 UAT sign-off\n. WP-CS-009 (Production Deployment) - blocks on WP-CS-008\n. WP-CS-010 (Post-Cutover Support) - final deliverable\n\nAny delays in critical path work packages will delay the overall cutover date.\n\n<<<\n== Transition Architecture\n\nThis section defines the evolution from baseline (D365 CE) to target state (Salesforce Service Cloud + ProfileService + EngagementService).\n\n=== Transition Approach\n\n*Big Bang Cutover*: Per ADR-CS-006, this transition uses a single cutover approach rather than phased rollout. All users switch from D365 CE to Salesforce simultaneously after Contact migration completion.\n\n=== Transition States\n\n==== TS-0: Baseline State (Current)\n\n===== Characteristics\n\n* D365 Customer Engagement handles all digital customer feedback\n* App-specific database stores customer Contact data\n* No ProfileService or EngagementService\n* No event-driven architecture\n* Synchronous feedback submission\n\n===== Components Active\n\n- D365 Customer Engagement\n- App-specific customer database\n- Mobile App (current version with D365 CE integration)\n\n==== TS-1: Build & Test\n\n===== Activities\n\n* Build ProfileService microservice (JIT Contact reconciliation API)\n* Build EngagementService microservice (feedback submission API, ACL for Salesforce Case creation, Braze integration, webhook receiver)\n* Implement Event Bus infrastructure (SNS+SQS/EventBridge/Kinesis)\n* Develop Contact migration tool (app database → Salesforce upsert by email/phone/VCI)\n* Update Mobile App API integration (ProfileService + EngagementService endpoints - feedback form UI already complete)\n* Integration testing (ProfileService ↔ Salesforce, EngagementService ↔ Salesforce, EngagementService ↔ Braze)\n* UAT with test Salesforce sandbox environment\n\n===== Components Active\n\n- D365 Customer Engagement (still active, unchanged)\n- App-specific customer database (still active)\n- ProfileService (non-production, testing only)\n- EngagementService (non-production, testing only)\n- Event Bus (non-production)\n- Salesforce Sandbox (testing)\n\n===== Exit Criteria\n\n- All integration tests pass\n- UAT sign-off from business stakeholders\n- Contact migration tool validated in sandbox\n- Mobile App updates tested with non-production APIs\n\n==== TS-2: Contact Migration\n\n===== Activities\n* Execute Contact migration (app database → Salesforce production)\n* Validation: 100% data integrity check (email/phone/VCI matching)\n* Reconciliation report: New Contacts created vs existing Contacts updated\n* Freeze app database Contact updates during migration window\n* ProfileService smoke testing (verify Contact lookups work in Salesforce production)\n\n===== Components Active\n- D365 Customer Engagement (still active, users unaffected)\n- Salesforce Production (Contacts migrated, no Cases yet)\n- ProfileService (production deployed, not integrated with Mobile App yet)\n- App-specific customer database (frozen, read-only)\n\n===== Exit Criteria\n- 100% of Contacts migrated with zero data loss\n- Email/phone/VCI matching accuracy > 95%\n- ProfileService smoke tests pass (JIT lookups return correct Contact IDs)\n- Reconciliation report approved\n\n==== TS-3: Cutover (Go-Live)\n\n===== Go-Live Activities\n\n* Deploy EngagementService to production\n* Deploy Mobile App updates (ProfileService + EngagementService API integration)\n* Configure Salesforce webhook (Case update notifications → EngagementService)\n* Smoke testing: End-to-end feedback submission (Mobile App → EngagementService → Salesforce → Braze notification)\n* Monitor Event Bus queue depth, dead letter queue, Salesforce API rate limits\n* **Go/No-Go decision**: Validate success criteria before final cutover\n* Enable feature flag: `enable_salesforce_feedback_submission = ON`\n* Disable D365 CE integration in Mobile App\n\n===== Components Active\n\n- ProfileService (production, integrated with Mobile App)\n- EngagementService (production, integrated with Mobile App)\n- Event Bus (production, processing async Case creation)\n- Salesforce Production (receiving Cases from digital customers)\n- Braze (sending push notifications)\n- Mobile App (new version with Salesforce integration)\n- D365 Customer Engagement (disabled, read-only for historical lookups)\n\n===== Exit Criteria\n\n- Mobile App feedback submission success rate > 99.5%\n- End-to-end flow validated (Mobile App → Salesforce Case created)\n- Braze push notifications delivered successfully\n- Event Bus queue depth normal, DLQ empty\n- No critical incidents (P1/P2) in first 24 hours\n\n==== TS-4: Target State (Stable Production)\n\n===== Characteristics\n\n* ProfileService and EngagementService fully operational\n* All digital customer feedback routed to Salesforce\n* Event-driven architecture established\n* D365 CE decommissioned\n* First DDD bounded contexts implemented successfully\n\n===== Monitoring Period\n\n* Validate success criteria: feedback submission rate > 99.5%, no data loss\n* Monitor customer satisfaction score (target: +15% improvement)\n* Monitor average case resolution time (target: -20% improvement)\n* Support agents using unified Salesforce view across all channels\n\n===== D365 CE Retirement\n\n* D365 CE read-only access for historical Case lookups (if needed)\n* Decommission D365 CE infrastructure after 90 days\n* Archive D365 CE data for compliance/auditing\n\n===== Components Active\n\n- ProfileService (production)\n- EngagementService (production)\n- Event Bus (production)\n- Salesforce Production (system of record)\n- Braze (push notifications)\n- Mobile App (Salesforce integration)\n- App-specific database (deprecated, Contact data no longer updated)\n\n===== Success Criteria Achieved\n\n- All digital customer feedback routed to Salesforce\n- Support agents have unified customer view\n- D365 CE decommissioned\n- Customer satisfaction improved by 15%\n- Average case resolution time decreased by 20%\n- Zero data loss during transition\n\n=== Transition Dependencies\n\n[width=\"100%\",cols=\"40%,60%\",options=\"header\",]\n|===\n|Dependency |Owner/Status\n\n|*Salesforce production access*\n|Viva Energy Salesforce admin team - TBD\n\n|*Salesforce Case field mapping*\n|Viva Energy Salesforce admin team - TBD (map OTR feedback categories to Salesforce fields)\n\n|*Salesforce data isolation strategy*\n|Viva Energy Salesforce admin team - TBD (Record Types, queues, custom fields)\n\n|*Salesforce webhook configuration*\n|Viva Energy Salesforce admin team - TBD (Outbound Messages vs Platform Events)\n\n|*Event Bus infrastructure*\n|OTR Platform team - Existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis)\n\n|*Braze integration*\n|OTR Marketing team - Existing Braze account, EngagementService creates new campaigns\n\n|*Mobile App release window*\n|OTR Mobile team - Coordinate cutover timing with app release schedule\n\n|*App database access*\n|OTR Platform team - Read access for Contact migration\n\n|===\n\n=== Transition Validation Criteria\n\n==== Contact Migration Validation\n\n* 100% of app database Contacts migrated to Salesforce (zero data loss)\n* Email/phone/VCI matching accuracy > 95% (minimize duplicate Contacts)\n* ProfileService JIT lookups return correct Salesforce Contact IDs (smoke test sample)\n* Reconciliation report shows: X new Contacts created, Y existing Contacts updated\n\n==== Cutover Validation\n\n* Mobile App feedback submission success rate > 99.5% (including async Case creation)\n* End-to-end flow validated: Mobile App → ProfileService → EngagementService → Salesforce Case created\n* Braze push notifications delivered for Case creation and Case resolution\n* Event Bus queue depth within normal range (no backlog)\n* Dead letter queue empty (no failed Case creations)\n* Salesforce API rate limits not exceeded\n\n==== Production Monitoring (30 days)\n\n* Customer satisfaction score improves by 15% (compared to D365 CE baseline)\n* Average case resolution time decreases by 20% (Salesforce vs D365 CE)\n* Support agents confirm unified customer view across all channels\n* Zero critical incidents (P1 outages, data loss)\n\n=== Rollback Plan\n\n==== Rollback Triggers\n\n* Feedback submission success rate < 95% (below acceptable threshold)\n* Data loss or corruption detected in Salesforce\n* Salesforce API rate limits exceeded (Cases not created within SLA)\n* Critical bug blocking customer feedback submission\n\n==== Rollback Procedure\n\n1. **Revert Mobile App** to previous version (remove ProfileService/EngagementService integration, restore D365 CE integration)\n2. **Stop EngagementService** Case creation (prevent duplicate Cases in Salesforce)\n3. **Re-enable D365 CE** for customer feedback submission\n4. **Investigate root cause** (EngagementService logs, Salesforce API errors, Event Bus queue issues)\n5. **Fix and re-test** in sandbox environment\n6. **Retry cutover** when issues resolved\n\n==== Rollback Limitations\n\n* Cases created in Salesforce during cutover period remain in Salesforce (no reverse migration)\n* Contacts migrated to Salesforce remain (no rollback to app database)\n* Rollback only affects Mobile App integration (not data migration)\n\n=== Architectural Scope Boundaries\n\n==== Capabilities Included\n\n===== Business Capabilities\n\n* **Customer Feedback Submission**: Mobile App users can submit structured feedback (Category, Store Name, Time of Visit, Phone, Free Text Message) via EngagementService\n* **Customer Contact Management**: Just-In-Time (JIT) Contact reconciliation with Salesforce via ProfileService, ensuring every Mobile App user has a Salesforce Contact record\n* **Case Management Integration**: EngagementService creates Salesforce Cases asynchronously for customer feedback, support agents manage Cases in Salesforce Service Cloud\n* **Customer Notifications**: Push notifications via Braze when Cases are created, updated, or resolved (bidirectional integration: Mobile App → Salesforce → Mobile App)\n* **Unified Customer View**: Support agents see OTR digital customer feedback alongside other Viva Energy channels (fuel wholesale, Shell Card, retail) in single Salesforce instance\n* **Contact Data Migration**: One-time migration of app-specific customer database Contacts to Salesforce with upsert logic (email/phone/VCI matching)\n\n===== Technical Capabilities\n\n* **ProfileService Bounded Context**: First DDD bounded context implementation - JIT Contact reconciliation, Salesforce API facade, foundation for Flybuys integration\n* **EngagementService Bounded Context**: First DDD bounded context implementation - Customer feedback submission BFF, Anti-Corruption Layer for Salesforce, Braze integration orchestration\n* **Event-Driven Architecture**: Domain event publishing via Event Bus (SNS+SQS/EventBridge/Kinesis) for `SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted` events\n* **Async Processing Pattern**: Non-blocking Case creation with retry logic, exponential backoff, dead letter queue for operational resilience\n* **Anti-Corruption Layer Pattern**: EngagementService protects digital channels from Salesforce API changes, translates between OTR domain language and Salesforce\n* **Conformist Pattern**: ProfileService and EngagementService conform to existing Salesforce configuration (shared Viva Energy instance, multi-tenant governance)\n* **Salesforce Integration**: REST API integration for Contact CRUD and Case creation, webhook receiver for Case update notifications\n* **Braze Integration**: Push notification campaign triggers for Case lifecycle events (created, updated, resolved)\n* **Observability & Monitoring**: Dashboards, metrics, alerting for feedback submission rate, queue depth, API errors, Case creation latency\n* **Feature Flag Management**: Kill switches for emergency rollback (enable_salesforce_feedback_submission, enable_async_case_creation, etc.)\n\n==== Capabilities Excluded\n\n===== Business Capabilities Explicitly Out of Scope\n\n* **Historical Case Migration**: D365 CE Cases not migrated to Salesforce (ADR-CS-005 - fresh start, no Case migration)\n* **Multi-Channel Feedback Submission**: Web app, POS, call centre, email feedback channels not included (Mobile App only in this phase)\n* **Case Resolution by Digital Channels**: Support agents resolve Cases in Salesforce, not via Mobile App self-service\n* **Knowledge Base Integration**: Salesforce Knowledge Base articles not surfaced in Mobile App (future enhancement)\n* **Live Chat/Messaging**: Real-time chat support not included (Salesforce omnichannel capabilities not activated)\n* **Sentiment Analysis**: Automated feedback sentiment analysis not included (future enhancement with AI/ML)\n* **Customer Satisfaction Surveys**: Post-resolution CSAT surveys not included (separate initiative)\n* **Case Attachments**: Mobile App feedback submission does not support file uploads (photos, receipts) - text only\n* **Agent Desktop Integration**: Custom Salesforce UI for support agents not included (use standard Salesforce Service Console)\n* **Social Media Feedback**: Facebook, Twitter, Instagram feedback channels not integrated\n\n===== Technical Capabilities Explicitly Out of Scope\n\n* **Event Sourcing**: Domain events are ephemeral (not persisted for event sourcing/replay) - Event Bus only, no Event Store\n* **CQRS (Command Query Responsibility Segregation)**: ProfileService and EngagementService use same data model for reads/writes (no separate read models)\n* **Local Aggregate Persistence**: ProfileService and EngagementService are stateless (Salesforce is System of Record, no local database for Contact/Case)\n* **Saga Orchestration**: No distributed transactions or saga patterns required (single-step Case creation, not multi-step workflow)\n* **API Gateway Advanced Features**: Rate limiting, API versioning, API key management deferred to detailed design (basic routing only)\n* **GraphQL API**: ProfileService and EngagementService expose REST APIs only (GraphQL not required)\n* **Real-Time Sync**: Salesforce Contact updates by support agents not synced back to ProfileService (eventual consistency acceptable via JIT reconciliation)\n* **Multi-Region Deployment**: Single AWS region deployment (no multi-region failover/disaster recovery in this phase)\n* **Blue-Green Deployment**: Big bang cutover (ADR-CS-006), not blue-green or canary deployment strategy\n* **A/B Testing Framework**: Feature flags for rollback only, not for A/B testing or experimentation\n* **Custom Authentication**: Microsoft Entra External ID used for Mobile App authentication (no custom authentication logic in ProfileService/EngagementService)\n* **Data Residency Compliance**: Salesforce data residency governed by Viva Energy Salesforce configuration (no OTR-specific data residency requirements)\n\n===== Future Bounded Contexts Not in Scope\n\n* **LoyaltyService**: Flybuys integration, reward preferences, transaction adjudication (separate initiative)\n* **LocationService**: Store finder, proximity features, geofencing (separate initiative)\n* **PaymentService**: Payment processing, subscription billing (separate initiative)\n* **RecommendationService**: Personalized recommendations, next-best offers (separate initiative)\n\n===== Integration Patterns Not in Scope\n\n* **Shared Kernel**: No shared domain model between ProfileService and EngagementService (separate bounded contexts with clear boundaries)\n* **Partnership**: No joint development or coordination with external teams (Conformist pattern - we conform to Salesforce)\n* **Customer-Supplier (we're upstream)**: No downstream systems depend on ProfileService/EngagementService APIs yet (future bounded contexts will consume domain events)\n\n==== Architectural Dependencies on Future Initiatives\n\n*This Architecture Enables Future Initiatives*:\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Future Initiative |Architectural Enablement\n\n|*Flybuys Integration*\n|**ProfileService Contact Reconciliation Reused**: ProfileService establishes pattern for JIT Contact reconciliation with Salesforce, which will be extended for Flybuys partner linking (link:../architecture_definitions/flybuys_integration.adoc[see Flybuys Integration architecture]) +\n**Event Bus Infrastructure**: Domain event publishing pattern (`CustomerEnrolledInLoyalty`, `PartnerLinked`, etc.) reuses Event Bus established for EngagementService\n\n|*LoyaltyService Bounded Context*\n|**Event Bus Subscription**: LoyaltyService will consume `CustomerProfileCreated` events published by ProfileService (future enhancement) +\n**Salesforce Contact Integration**: LoyaltyService may query Salesforce Contacts for customer reward preferences (via ProfileService facade or direct Salesforce API)\n\n|*Web App Feedback Submission*\n|**EngagementService API Reuse**: Web app will call same EngagementService REST API for feedback submission (multi-channel support) +\n**Conformist Pattern**: Web app conforms to EngagementService API contract (no translation required)\n\n|*Multi-Channel Customer Support*\n|**EngagementService Extension**: Add support for email, call centre, POS feedback channels (extend EngagementService to handle multiple origins) +\n**Salesforce Case Origin Field**: Cases already tagged with Origin=Mobile App, extend to Origin=Web, POS, Call Centre, Email\n\n|*Knowledge Base Integration*\n|**EngagementService API Extension**: Add endpoint to query Salesforce Knowledge Base articles, surface in Mobile App for self-service support +\n**Anti-Corruption Layer**: EngagementService translates Salesforce Knowledge API to OTR domain language\n\n|*Customer Satisfaction Surveys*\n|**Event-Driven Trigger**: Subscribe to `SupportCaseResolved` events published by EngagementService, trigger CSAT survey via Braze +\n**Braze Integration Pattern**: Reuse EngagementService → Braze integration pattern for survey campaigns\n\n|*Sentiment Analysis*\n|**Event Subscription**: Subscribe to `CustomerFeedbackSubmitted` events, analyse feedback sentiment (AI/ML service) +\n**EngagementService Extension**: Enrich Case with sentiment score before creating in Salesforce\n\n|*RecommendationService Bounded Context*\n|**Event Subscription**: RecommendationService subscribes to `SupportCaseCreated` events to understand customer pain points and personalize recommendations +\n**Domain Event Pattern**: Reuse Event Bus publishing pattern established by EngagementService\n\n|===\n\n*This Architecture Depends on Future Initiatives*:\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Future Initiative |Dependency Description\n\n|*Salesforce Data Isolation Strategy*\n|**BLOCKER**: Viva Energy Salesforce admin team must define data isolation strategy (Record Types, custom fields, queues) before production deployment +\n**Impact**: Multi-tenant data visibility and security governance\n\n|*Salesforce Case Field Mapping*\n|**BLOCKER**: Viva Energy Salesforce admin team must define field mapping for OTR feedback categories (App, Service, Order, Rewards, Refund, Delete Account) +\n**Impact**: Case creation logic in EngagementService depends on finalized Salesforce schema\n\n|*Salesforce Webhook Mechanism*\n|**BLOCKER**: Viva Energy Salesforce admin team must configure webhook mechanism (Outbound Messages vs Platform Events vs Process Builder) for Case update notifications +\n**Impact**: EngagementService webhook receiver implementation depends on chosen mechanism\n\n|*Event Bus Technology Selection*\n|**DECISION REQUIRED**: Choose Event Bus implementation (SNS+SQS vs EventBridge vs Kinesis) for domain event publishing +\n**Impact**: Infrastructure provisioning, event schema design, consumer implementation\n\n|*Microservice Hosting Platform*\n|**DECISION REQUIRED**: Choose hosting platform for ProfileService and EngagementService (AWS Lambda vs ECS vs EKS) +\n**Impact**: Deployment architecture, auto-scaling strategy, operational overhead\n\n|*Observability Platform*\n|**DECISION REQUIRED**: Choose observability platform (AWS CloudWatch vs Datadog vs New Relic) for monitoring and alerting +\n**Impact**: Dashboard configuration, metric collection, alerting setup\n\n|===\n\n*Future Work After This Initiative*:\n\n* **Event Schema Registry**: Implement event schema versioning and registry for domain events (currently ad-hoc schemas)\n* **API Versioning Strategy**: Define API versioning approach for ProfileService and EngagementService (currently v1 only)\n* **Multi-Region Deployment**: Extend to multi-region for disaster recovery and global availability\n* **Event Store**: Persist domain events for event sourcing and audit trail (currently ephemeral Event Bus only)\n* **CQRS Pattern**: Separate read models for high-volume queries (currently same model for reads/writes)\n* **GraphQL API**: Expose GraphQL API for flexible client queries (currently REST only)\n* **Real-Time Sync**: Bi-directional sync between Salesforce and ProfileService for Contact updates (currently JIT reconciliation only)\n\n=== Technical Risks and Mitigation\n\n[width=\"100%\",cols=\"5%,20%,25%,25%,25%\",options=\"header\",]\n|===\n|ID |Risk |Impact |Likelihood |Mitigation\n\n|RISK-CS-001\n|*Salesforce API rate limits exceeded*: High feedback volume exceeds Salesforce API limits, Cases not created\n|HIGH (customers don't receive Case confirmation, support tickets lost)\n|MEDIUM (volume unknown, rate limits TBD)\n|• Gather expected feedback volume data before cutover +\n• Implement Event Bus queue throttling/rate limiting +\n• Monitor queue depth and API usage +\n• Scale background workers based on queue depth +\n• Alert ops team when approaching rate limits\n\n|RISK-CS-002\n|*Salesforce downtime*: Salesforce Service Cloud outage prevents Case creation\n|MEDIUM (Cases delayed but queued, customers wait for confirmation)\n|LOW (Salesforce SLA 99.9% uptime)\n|• Async Case creation with retry logic +\n• Event Bus queues buffer work during outage +\n• Customers get immediate \"Feedback submitted\" (not blocked) +\n• Monitor Salesforce status page, alert ops team +\n• Automatic retry when Salesforce recovers\n\n|RISK-CS-003\n|*Contact migration data quality issues*: App database Contact data incomplete or invalid\n|HIGH (migration fails validation, cutover delayed)\n|MEDIUM (legacy data quality unknown)\n|• Pre-migration data quality assessment +\n• Flexible upsert logic (match by email/phone/VCI) +\n• Validation report identifies data issues before production migration +\n• Manual cleanup for invalid records +\n• Dry-run migration in sandbox environment\n\n|RISK-CS-004\n|*Duplicate Contacts created*: Email matching fails, ProfileService creates duplicate Contacts\n|MEDIUM (support agents see multiple profiles for same customer)\n|MEDIUM (email changes, data quality issues)\n|• Salesforce duplicate detection rules (if available) +\n• ProfileService logs Contact creation for audit trail +\n• Manual duplicate cleanup process (support team) +\n• Future enhancement: VCI as Salesforce External ID for stable matching\n\n|RISK-CS-005\n|*Dead letter queue accumulation*: Failed Case creations not processed, queue grows\n|HIGH (customers don't receive Case confirmation, feedback lost)\n|LOW (retry logic handles most failures)\n|• Dead letter queue monitoring and alerting +\n• Ops team dashboard showing DLQ depth +\n• Manual intervention process (investigate and reprocess) +\n• Automated alerts when DLQ depth exceeds threshold +\n• Root cause analysis for recurring failures\n\n|RISK-CS-006\n|*Salesforce webhook failures*: Salesforce can't deliver Case update notifications to EngagementService\n|MEDIUM (customers don't get push notifications for Case resolution)\n|LOW (webhook mechanism reliable)\n|• Webhook retry logic and exponential backoff +\n• EngagementService logs webhook deliveries +\n• Monitor webhook delivery success rate +\n• Fallback: Poll Salesforce API for Case updates (if webhook fails persistently) +\n• Alert ops team when webhook delivery rate drops\n\n|RISK-CS-007\n|*Multi-tenant data isolation breach*: OTR digital Cases visible to other Viva Energy support teams\n|HIGH (privacy violation, compliance risk)\n|LOW (Salesforce governance controls)\n|• Work with Viva Energy Salesforce admin team on data isolation strategy +\n• Test data visibility in Salesforce sandbox (UAT with different user roles) +\n• Validate Record Types, queues, field-level security before production +\n• Audit Salesforce user permissions and sharing rules\n\n|RISK-CS-008\n|*Mobile App release coordination*: App release delayed, cutover window missed\n|MEDIUM (cutover delayed, D365 CE retirement delayed)\n|MEDIUM (release schedule conflicts)\n|• Coordinate cutover timing with Mobile team early +\n• Buffer time in migration plan (2-week contingency) +\n• Decouple backend deployment from Mobile App release (backend deployed first, app follows) +\n• Feature flag for feedback submission (enable when ready)\n\n|RISK-CS-009\n|*Event Bus infrastructure issues*: SNS/SQS/EventBridge downtime or misconfiguration\n|HIGH (Case creation blocked, domain events not published)\n|LOW (AWS SLA 99.99% uptime)\n|• Leverage existing AWS infrastructure (proven, reliable) +\n• Infrastructure as Code (IaC) for Event Bus configuration +\n• Integration testing in non-production environment +\n• Monitor Event Bus metrics (queue depth, throughput, errors) +\n• Alert ops team on Event Bus failures\n\n|RISK-CS-010\n|*Team DDD knowledge gap*: Team unfamiliar with DDD patterns, bounded contexts, event-driven architecture\n|MEDIUM (implementation delays, architectural inconsistencies)\n|HIGH (first DDD implementation)\n|• DDD training for development team (workshops, documentation) +\n• Architecture review sessions (validate bounded context design) +\n• Pair programming with experienced DDD practitioners +\n• Incremental implementation (start small, iterate) +\n• Document architectural patterns in CLAUDE.md\n\n|===\n\n== Assumptions and Constraints\n\n=== Assumptions\n\n[width=\"100%\",cols=\"8%,92%\",options=\"header\",]\n|===\n|ID |Assumption\n\n|ASM-CS-001\n|Viva Energy Salesforce admin team will provide Salesforce production access, sandbox environment, and support for Case field mapping and data isolation configuration\n\n|ASM-CS-002\n|App database Contact data is sufficiently complete for migration (email/phone/VCI available for matching)\n\n|ASM-CS-003\n|Expected customer feedback volume (100-150 submissions/day from 20k DAU) is well within Salesforce API rate limits, with capacity planning for 3x-10x growth\n\n|ASM-CS-004\n|Existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis) is sufficient for Event Bus implementation (no additional infrastructure provisioning required)\n\n|ASM-CS-005\n|Braze integration already exists and can be extended for Case-related push notifications (no new Braze account or major configuration changes)\n\n|ASM-CS-006\n|Mobile App users have email addresses associated with their accounts (required for ProfileService Contact reconciliation)\n\n|ASM-CS-007\n|D365 Customer Engagement historical Cases have limited business value and do not require migration to Salesforce\n\n|ASM-CS-008\n|Support agents are trained on Salesforce Service Cloud and require minimal additional training for OTR digital customer Cases\n\n|ASM-CS-009\n|Salesforce Service Cloud shared instance has capacity for OTR digital customer Contacts and Cases (no additional licensing or storage costs)\n\n|ASM-CS-010\n|Mobile App release schedule can accommodate cutover timing (Week 10 in migration plan)\n\n|===\n\n=== Constraints\n\n[width=\"100%\",cols=\"8%,92%\",options=\"header\",]\n|===\n|ID |Constraint\n\n|CON-CS-001\n|Must use shared Viva Energy Salesforce Service Cloud instance (cannot deploy separate OTR-specific instance)\n\n|CON-CS-002\n|Must conform to existing Salesforce configuration and governance (Record Types, custom fields, queues, data isolation strategy defined by Viva Energy admin team)\n\n|CON-CS-003\n|Contact migration must complete before Mobile App cutover (no parallel run of D365 CE and Salesforce)\n\n|CON-CS-004\n|Big bang cutover only (no phased rollout with feature flags or pilot users)\n\n|CON-CS-005\n|Salesforce API rate limits and authentication method constrained by Viva Energy Salesforce configuration (TBD)\n\n|CON-CS-006\n|Event Bus implementation must use existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis - cannot introduce new infrastructure components)\n\n|CON-CS-007\n|Mobile App feedback form must include specific fields: Category, Store Name, Time of Visit, Contact Phone Number, Free Text Message (no attachments)\n\n|CON-CS-008\n|D365 Customer Engagement must be decommissioned within 90 days post-cutover (ADR-CS-006)\n\n|CON-CS-009\n|ProfileService and EngagementService must be stateless (no local aggregate persistence, Salesforce is System of Record)\n\n|CON-CS-010\n|First DDD bounded context implementation (team learning curve, architectural patterns must be documented for future bounded contexts)\n\n|===\n\n== Non-Functional Requirements\n\n=== Performance Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-PERF-001\n|Mobile App feedback submission API response time (ProfileService + EngagementService)\n|p95 < 1 second, p99 < 2 seconds\n\n|NFR-PERF-002\n|ProfileService Contact reconciliation API response time (JIT lookup)\n|p95 < 500ms, p99 < 1 second\n\n|NFR-PERF-003\n|EngagementService async Case creation latency (end-to-end: feedback submitted → Case created in Salesforce)\n|p95 < 5 minutes, p99 < 10 minutes\n\n|NFR-PERF-004\n|Salesforce API call latency (Contact query, Contact create, Case create)\n|p95 < 2 seconds, p99 < 5 seconds\n\n|NFR-PERF-005\n|Event Bus message processing throughput\n|> 100 messages/second (support peak feedback volume)\n\n|NFR-PERF-006\n|Braze push notification delivery latency (Case created → notification delivered)\n|p95 < 30 seconds, p99 < 60 seconds\n\n|===\n\n=== Availability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-AVAIL-001\n|ProfileService availability\n|99.9% uptime (8.76 hours downtime/year)\n\n|NFR-AVAIL-002\n|EngagementService availability\n|99.9% uptime (8.76 hours downtime/year)\n\n|NFR-AVAIL-003\n|Feedback submission success rate (including async Case creation)\n|> 99.5% (includes retry logic for transient failures)\n\n|NFR-AVAIL-004\n|Graceful degradation: Salesforce downtime handling\n|Feedback submission still succeeds, Cases queued for async creation when Salesforce recovers\n\n|NFR-AVAIL-005\n|Graceful degradation: Braze downtime handling\n|Case creation proceeds, push notifications disabled temporarily (feature flag)\n\n|NFR-AVAIL-006\n|Planned maintenance window\n|< 4 hours/month, scheduled during low-traffic periods (2-6am ACST)\n\n|===\n\n=== Scalability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-SCALE-001\n|Concurrent Mobile App users (peak)\n|Support 20,000 DAU (Daily Active Users), ~150 concurrent users submitting feedback during peak hours\n\n|NFR-SCALE-002\n|Feedback submissions per day\n|Expected: 100-150 submissions/day based on 20k DAU (~0.5-0.75% submission rate) +\nCapacity: Support 500 submissions/day (3x expected volume for growth), 2,000 submissions/day (peak/incident scenarios)\n\n|NFR-SCALE-003\n|Auto-scaling: ProfileService and EngagementService\n|Auto-scale based on CPU/memory/request rate, scale up within 2 minutes\n\n|NFR-SCALE-004\n|Event Bus queue capacity\n|Support 100,000 queued messages (buffer for Salesforce downtime)\n\n|NFR-SCALE-005\n|Salesforce API rate limit compliance\n|Stay within 80% of Salesforce API rate limits (buffer for spikes)\n\n|NFR-SCALE-006\n|Future growth capacity\n|Architecture supports 10x growth (1,000-1,500 submissions/day based on 200k DAU) without major redesign\n\n|===\n\n=== Security Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-SEC-001\n|Mobile App authentication\n|Microsoft Entra External ID OAuth 2.0 with JWT tokens (existing CIAM)\n\n|NFR-SEC-002\n|API authorisation: ProfileService and EngagementService\n|JWT token validation, authenticated users only, user context propagation\n\n|NFR-SEC-003\n|Salesforce API authentication\n|OAuth 2.0 with Connected App and JWT bearer flow (service account)\n\n|NFR-SEC-004\n|Data encryption in transit\n|TLS 1.2+ for all API calls (Mobile App ↔ ProfileService/EngagementService ↔ Salesforce ↔ Braze)\n\n|NFR-SEC-005\n|Data encryption at rest\n|Salesforce encryption at rest (managed by Salesforce), Event Bus message encryption (AWS KMS)\n\n|NFR-SEC-006\n|Secret management\n|AWS Secrets Manager for Salesforce credentials, Braze API keys, OAuth tokens (no hardcoded secrets)\n\n|NFR-SEC-007\n|PII data handling\n|Contact data (email, phone, name) treated as PII, GDPR-compliant retention policies (Salesforce governance)\n\n|NFR-SEC-008\n|API rate limiting and throttling\n|API Gateway rate limiting (100 requests/second per user), prevent abuse and DoS\n\n|NFR-SEC-009\n|Logging and auditing\n|Log all API calls, Salesforce Contact/Case creates/updates, Event Bus publishes (no PII in logs)\n\n|NFR-SEC-010\n|Salesforce data isolation\n|Multi-tenant data isolation via Salesforce Record Types, queues, sharing rules (defined by Viva Energy admin team)\n\n|===\n\n=== Reliability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-REL-001\n|Retry logic: EngagementService → Salesforce Case creation\n|Exponential backoff (1s, 2s, 4s, 8s, 16s), max 5 retries, then dead letter queue\n\n|NFR-REL-002\n|Dead letter queue monitoring\n|Alert ops team immediately when DLQ depth > 0 (failed Case creations require manual intervention)\n\n|NFR-REL-003\n|Event Bus message durability\n|Messages persisted in Event Bus (SNS+SQS/EventBridge/Kinesis), not lost on service restart\n\n|NFR-REL-004\n|Idempotency: Case creation\n|EngagementService ensures duplicate feedback submissions don't create duplicate Cases (idempotency key)\n\n|NFR-REL-005\n|Circuit breaker: Salesforce API calls\n|Open circuit after 5 consecutive failures, half-open retry after 30 seconds\n\n|NFR-REL-006\n|Health checks: ProfileService and EngagementService\n|Health endpoints for load balancer checks, readiness and liveness probes\n\n|NFR-REL-007\n|Disaster recovery: Event Bus\n|Event Bus messages replicated across AWS availability zones (SQS/EventBridge/Kinesis HA)\n\n|===\n\n=== Maintainability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-MAINT-001\n|Code quality: ProfileService and EngagementService\n|> 80% test coverage (unit + integration tests), automated CI/CD pipeline\n\n|NFR-MAINT-002\n|API documentation\n|OpenAPI/Swagger specs for ProfileService and EngagementService, auto-generated API docs\n\n|NFR-MAINT-003\n|Deployment automation\n|Infrastructure as Code (Terraform/CloudFormation/CDK), zero-downtime deployments\n\n|NFR-MAINT-004\n|Logging: structured logs\n|JSON-formatted logs with correlation IDs, log levels (DEBUG, INFO, WARN, ERROR), centralized log aggregation\n\n|NFR-MAINT-005\n|Monitoring dashboards\n|Real-time dashboards for ProfileService, EngagementService, Event Bus (see Monitoring and Observability section)\n\n|NFR-MAINT-006\n|Alerting and on-call\n|PagerDuty/Opsgenie integration for P1/P2 alerts, on-call rotation for ops team\n\n|NFR-MAINT-007\n|Configuration management\n|Externalized configuration (environment variables, AWS Parameter Store), no hardcoded config\n\n|NFR-MAINT-008\n|Versioning: API and events\n|Semantic versioning (v1, v2), backward compatibility for API changes, event schema evolution\n\n|===\n\n=== Usability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-USE-001\n|Feedback submission UX\n|Mobile App user receives immediate \"Feedback submitted\" confirmation (< 1 second), not blocked by async Case creation\n\n|NFR-USE-002\n|Push notification delivery\n|Customer receives \"Your feedback has been received\" notification within 30 seconds of Case creation in Salesforce\n\n|NFR-USE-003\n|Case resolution notification\n|Customer receives \"Your case has been resolved\" notification within 30 seconds of support agent resolving Case\n\n|NFR-USE-004\n|Error messaging\n|User-friendly error messages for failed feedback submission (not technical errors), retry prompts\n\n|NFR-USE-005\n|Accessibility\n|Mobile App feedback form meets WCAG 2.1 AA accessibility standards (existing Mobile App compliance)\n\n|===\n\n=== Compliance Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-COMP-001\n|GDPR compliance: PII data\n|Customer Contact data (email, phone, name) managed per GDPR retention policies (Salesforce governance)\n\n|NFR-COMP-002\n|GDPR compliance: Right to erasure\n|Support \"Delete Account\" feedback category, trigger Contact deletion in Salesforce per GDPR Article 17\n\n|NFR-COMP-003\n|Data residency\n|Salesforce data residency governed by Viva Energy Salesforce configuration (regional compliance)\n\n|NFR-COMP-004\n|Audit trail\n|All Contact creates/updates, Case creates/updates logged for compliance auditing (Salesforce audit logs)\n\n|NFR-COMP-005\n|API security standards\n|OWASP API Security Top 10 compliance (injection prevention, authentication, authorisation, data exposure)\n\n|===\n\n== Monitoring and Observability\n\n=== Key Metrics\n\n[width=\"100%\",cols=\"25%,40%,35%\",options=\"header\",]\n|===\n|Metric Category |Metric |Target/Threshold\n\n|*Feedback Submission*\n|Feedback submission success rate (Mobile App → EngagementService)\n|> 99.5%\n\n|*Async Case Creation*\n|Case creation success rate (EngagementService → Salesforce)\n|> 99%\n\n|*Async Case Creation*\n|Case creation latency (time from feedback submission to Case created in Salesforce)\n|p95 < 5 minutes\n\n|*Event Bus*\n|Event Bus queue depth (pending Case creations)\n|< 100 messages\n\n|*Event Bus*\n|Dead letter queue depth (failed Case creations)\n|= 0 (alert on any failures)\n\n|*Salesforce API*\n|Salesforce API error rate\n|< 1%\n\n|*Salesforce API*\n|Salesforce API latency (Case creation)\n|p95 < 2 seconds\n\n|*Salesforce API*\n|Salesforce API rate limit utilization\n|< 80% of limit\n\n|*ProfileService*\n|Contact reconciliation success rate (JIT lookups)\n|> 99.5%\n\n|*ProfileService*\n|Contact reconciliation latency\n|p95 < 500ms\n\n|*Braze Notifications*\n|Push notification delivery rate (Case created/updated)\n|> 95%\n\n|*Salesforce Webhook*\n|Webhook delivery success rate (Salesforce → EngagementService)\n|> 99%\n\n|*Customer Satisfaction*\n|Customer satisfaction score (CSAT)\n|> 4.0/5.0 (improve by 15% from D365 CE baseline)\n\n|*Support Operations*\n|Average case resolution time\n|Decrease by 20% from D365 CE baseline\n\n|===\n\n=== Alerting Thresholds\n\n[width=\"100%\",cols=\"25%,50%,25%\",options=\"header\",]\n|===\n|Alert |Condition |Severity\n\n|*Feedback submission failures*\n|Feedback submission success rate < 95% over 5-minute window\n|P1 - Critical\n\n|*Dead letter queue accumulation*\n|Dead letter queue depth > 0 (any failed Case creations)\n|P2 - High\n\n|*Event Bus queue backlog*\n|Event Bus queue depth > 100 messages for > 15 minutes\n|P2 - High\n\n|*Salesforce API errors*\n|Salesforce API error rate > 5% over 5-minute window\n|P1 - Critical\n\n|*Salesforce API rate limits*\n|Salesforce API rate limit utilization > 90%\n|P2 - High\n\n|*Contact reconciliation failures*\n|ProfileService Contact reconciliation failure rate > 5% over 5-minute window\n|P2 - High\n\n|*Braze notification failures*\n|Braze push notification delivery rate < 80% over 15-minute window\n|P3 - Medium\n\n|*Salesforce webhook failures*\n|Salesforce webhook delivery success rate < 90% over 15-minute window\n|P2 - High\n\n|*Case creation latency*\n|Case creation latency p95 > 10 minutes\n|P3 - Medium\n\n|===\n\n=== Dashboards\n\n*ProfileService Dashboard:*\n\n* Contact reconciliation success rate (JIT lookups)\n* Contact reconciliation latency (p50, p95, p99)\n* Contact creation vs update ratio (new Contacts created vs existing Contacts updated)\n* Salesforce API error rate (Contact queries and creates)\n* Request rate and throughput\n\n*EngagementService Dashboard:*\n\n* Feedback submission success rate\n* Case creation success rate (async workflow)\n* Case creation latency (p50, p95, p99)\n* Event Bus queue depth (pending Case creations)\n* Dead letter queue depth (failed Case creations)\n* Salesforce API error rate (Case creation)\n* Salesforce API latency\n* Salesforce API rate limit utilization\n* Braze push notification delivery rate\n* Salesforce webhook delivery success rate\n\n*Event Bus Dashboard:*\n\n* Queue depth (pending messages)\n* Throughput (messages published/consumed per minute)\n* Dead letter queue depth (failed messages)\n* Consumer lag (time between publish and consume)\n\n*Customer Support Dashboard (Business Metrics):*\n\n* Total feedback submissions per day/week/month\n* Feedback category breakdown (App, Service, Order, Rewards, Refund, Delete Account)\n* Customer satisfaction score (CSAT) trend\n* Average case resolution time trend\n* Case volume by support team/queue\n* Unified customer view adoption (support agent feedback)\n<<<\n== Solution Validation\n\nThis section defines the validation criteria and testing approach for the solution.\n\n=== Functional Validation\n\n==== ProfileService API Testing\n\n*Test Scenarios*:\n1. **Happy Path**: Authenticated user requests Contact ID, existing Contact found in Salesforce, Contact ID returned\n2. **JIT Creation**: Authenticated user requests Contact ID, no existing Contact, new Contact created in Salesforce, Contact ID returned\n3. **Salesforce API Failure**: Salesforce unavailable, ProfileService returns 500 error, user retries\n4. **Invalid JWT**: Unauthenticated request, ProfileService returns 401 error\n\n*Acceptance Criteria*:\n- Contact reconciliation success rate > 99.5%\n- JIT Contact creation completes within 500ms (p95)\n\n==== EngagementService API Testing\n\n*Test Scenarios*:\n1. **Happy Path**: Valid feedback submission, immediate 202 Accepted response, Case created in Salesforce within 5 minutes, Braze notification delivered\n2. **Invalid Category**: Invalid feedback category, 400 Bad Request response with validation error\n3. **Salesforce Downtime**: Salesforce unavailable during async Case creation, message queued, retry logic executes, Case created when Salesforce recovers\n4. **Dead Letter Queue**: Case creation fails after 5 retries, message moved to DLQ, ops team alerted\n5. **Webhook Notification**: Support agent resolves Case in Salesforce, webhook triggers EngagementService, Braze push notification sent to customer\n\n*Acceptance Criteria*:\n- Feedback submission success rate > 99.5% (including async Case creation)\n- Async Case creation completes within 5 minutes (p95)\n- Webhook delivery success rate > 99%\n\n=== Non-Functional Validation\n\n==== Performance Testing\n\n*Load Testing*:\n\n*Baseline*: Expected 100-150 submissions/day from 20k DAU (~0.5-0.75% submission rate)\n\n- **Normal Load**: 1 submission/minute sustained for 2 hours (simulate typical daily pattern)\n- **3x Load**: 3 submissions/minute sustained for 1 hour (simulate busy period, 450 submissions/day)\n- **Peak Load (10x)**: 10 submissions/minute for 15 minutes (simulate incident scenario, app outage causing backlog)\n- **Stress Test**: 50 submissions/minute for 5 minutes (find breaking point, 20x normal)\n\n*Validation*:\n- API response time p95 < 1 second under 10x load\n- Event Bus queue depth remains manageable (< 100 messages)\n- No Case creation failures, all submissions processed successfully\n- Auto-scaling triggers appropriately for sustained load > 3x baseline\n\n*Acceptance Criteria*:\n- NFR-PERF-001 through NFR-PERF-006 validated under realistic load (3x and 10x baseline)\n- Auto-scaling triggers within 2 minutes of load increase\n- System handles 10x peak gracefully, 20x stress test identifies limits\n\n==== Resilience Testing\n\n*Salesforce API Failure Scenarios*:\n1. **Complete Outage**: Salesforce unavailable for 2 hours, Event Bus queues buffer work, Cases created when Salesforce recovers\n2. **Rate Limit Exceeded**: Salesforce rate limit hit, queue throttling activates, Cases created within SLA\n\n*Acceptance Criteria*:\n- NFR-AVAIL-004 validated (graceful degradation during Salesforce downtime)\n- Circuit breaker activates after 5 consecutive failures\n\n==== Security Validation\n\n*Penetration Testing*:\n- API authentication bypass attempts\n- SQL injection attempts\n- Webhook signature validation bypass\n\n*Acceptance Criteria*:\n- NFR-SEC-001 through NFR-SEC-010 validated\n- OWASP API Security Top 10 compliance verified\n\n=== Integration Validation\n\n==== End-to-End Testing\n\n*Full User Journey*:\n1. User authenticates via Microsoft Entra External ID\n2. Mobile App requests Contact ID from ProfileService (JIT reconciliation)\n3. User submits feedback via EngagementService\n4. Background worker creates Case in Salesforce\n5. Braze notification delivered to user\n6. Support agent resolves Case in Salesforce\n7. Salesforce webhook triggers EngagementService\n8. Braze notification delivered to user\n\n*Acceptance Criteria*:\n- End-to-end flow completes successfully in UAT\n- User receives both \"feedback submitted\" and \"case resolved\" notifications\n","structuredPatch":[{"oldStart":1998,"oldLines":6,"newStart":1998,"newLines":7,"lines":[" * Salesforce API rate limits monitored and acceptable for expected volume"," * Configuration replicated to Salesforce production environment"," ","+[[wp-cs-008]]"," === WP-CS-008: Contact Data Migration"," "," ==== Description"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"ba9ad111-e145-4570-95ed-7ec780917cb9"}
{"parentUuid":"9fd0d5cf-438f-4dea-99fb-7dcb91943a38","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_018g4kzLPQhT1fzypNNTnige","type":"tool_result","content":"The file /mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n  2064→* Reconciliation report approved by business stakeholders\n  2065→* App-specific database Contact updates frozen (read-only mode)\n  2066→* Rollback procedure ready (but not executed if migration successful)\n  2067→\n  2068→[[wp-cs-009]]\n  2069→=== WP-CS-009: Production Deployment\n  2070→\n  2071→==== Description\n  2072→\n  2073→Deploy all solution components to production and execute cutover from D365 CE to Salesforce Service Cloud.\n  2074→\n  2075→==== Deliverables"}]},"uuid":"80edea09-063d-44d3-bfef-a1fdc7e4158c","timestamp":"2026-01-09T03:10:50.944Z","toolUseResult":{"filePath":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","oldString":"=== WP-CS-009: Production Deployment\n\n==== Description","newString":"[[wp-cs-009]]\n=== WP-CS-009: Production Deployment\n\n==== Description","originalFile":"= Salesforce Customer Support - Solution Architecture\n:project-name: Salesforce Customer Support\n:togaf-adm-phase: Phase E: Opportunities & Solutions\n:last-updated: 2026-01-07\n:document-type: Solution Architecture Document\n:status: Discovery\n:version: 0.1\n:domain: Customer Support & Engagement\n:programme-lead:\n:domain-architect: O.Young@otr.com.au\n:architecture-definition: xref:architecture-definitions:salesforce_customer_support.adoc[Architecture Definitions/Salesforce Customer Support]\n:doctype: article\n:toc: left\n:toclevels: 4\n:sectanchors:\n:sectlinks:\n:sectnums:\n:icons: font\n:source-highlighter: highlightjs\n:experimental:\n:description:\n:keywords:\n\n<<<\n== Purpose and Scope\n\n=== Purpose\n\nThis Solution Architecture defines how the Salesforce Customer Support consolidation will be implemented - the specific technology products, configurations, interfaces, and deployment architecture that realise the xref:architecture-definitions:salesforce_customer_support.adoc[Salesforce Customer Support Architecture Definition].\n\nThis solution establishes the **first implementation of OTR's target Domain-Driven Design (DDD) architecture** by deploying two new bounded contexts (`ProfileService` and `EngagementService`) as microservices, consolidating customer support onto Salesforce Service Cloud, and implementing event-driven integration patterns that will serve as the foundation for future bounded contexts (including Flybuys integration).\n\n=== Vision\n\n> Unify customer support across all OTRG channels by consolidating OTR digital customer feedback onto Salesforce Service Cloud, establishing the foundational DDD architecture with ProfileService and EngagementService bounded contexts that protect digital channels from external system changes while enabling support agents to deliver exceptional customer experiences with complete interaction history.\n\n=== Architectural Approach\n\nThis architecture establishes OTR's **first bounded context implementation** using Domain-Driven Design strategic patterns:\n\n* *link:../bounded_context/profile.adoc[ProfileService]* (NEW bounded context): Just-In-Time Contact reconciliation with Salesforce, upsert by email, returns Salesforce Contact ID to digital channels - foundation for future Flybuys partner linking\n* *link:../bounded_context/engagement.adoc[EngagementService]* (NEW bounded context): Customer feedback submission facade, Anti-Corruption Layer for Salesforce Case creation, Braze integration for all outbound customer communications (push, email, SMS), async Case processing via Event Bus\n* *Event-driven integration* (NEW pattern): Domain event publishing using existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis) - first implementation establishing pattern for future bounded contexts\n* *Anti-Corruption Layer*: EngagementService isolates digital channels from Salesforce API changes, translates between OTR domain language and Salesforce Service Cloud API\n* *Conformist Pattern*: ProfileService and EngagementService conform to existing Salesforce configuration (shared Viva Energy instance, multi-tenant governance)\n* *Big bang cutover*: Single deployment after Contact migration, no phased rollout, D365 CE retirement post-cutover\n\n=== Scope\n\n==== In Scope\n\n* Solution Building Blocks (SBBs) - specific technology products and versions\n* Interface specifications (APIs, events, data formats)\n* Data architecture and schema specifications\n* Deployment architecture and infrastructure configuration\n* Transition architecture with migration phases\n* Technical validation criteria and testing approach\n* External system integration specifications\n* Physical data models and API schemas\n\n==== Out of Scope\n\n===== Covered in xref:architecture-definitions:salesforce_customer_support.adoc[Architecture Definition]\n\n* Business requirements and stakeholder analysis\n* Architecture decisions and rationale (ADRs)\n* Bounded context definitions and responsibilities\n* High-level integration patterns (ACL, Conformist, OHS+PL)\n* Business capability mapping and value streams\n* Architecture principles and governance\n\n===== Covered in Other Documents\n\n* Detailed design (class diagrams, sequence diagrams for all flows)\n* Implementation code and unit tests\n* Business case and return-on-investment analysis\n* Operational run books and support procedures\n\n<<<\n=== Architecture Overview\n\n[mermaid]\n----\n---\nconfig:\n  layout: elk\n---\nflowchart TB\n    Customer([\"Customer\"]) -- Uses --> MobileApp[\"Mobile App<br>iOS/Android\"]\n    Customer -- Shops at --> POS[\"OTR/OTR+ POS<br>D365 Commerce\"]\n    MobileApp -- Authenticate --> EntraID[\"Microsoft Entra\"]\n    MobileApp -- Identifies & Reconciles --> ProfileService[\"ProfileService\"]\n    ProfileService <-- Reconcile App User as Salesforce Contact --> Salesforce[\"Salesforce\"]\n    ProfileService -- On Create --> EventBus[\"EventBus\"]\n    EventBus -- Emits CreateUser Event --> LoyaltyService[\"LoyaltyService\"] & EngagementService[\"EngagementService\"]\n    LoyaltyService -- Reconcile Wallet --> EagleEye[\"EagleEye\"]\n    EngagementService -- Reconcile Braze Profile --> Braze[\"Braze\"]\n    EngagementService --> Salesforce\n    D365CE[\"D365CE\"] -- Data Migration --> Salesforce\n    MobileApp -- Submits Feedback --> EngagementService\n\n    Customer:::customer\n    MobileApp:::presentation\n    POS:::presentation\n    EntraID:::external\n    ProfileService:::newService\n    Salesforce:::external\n    EventBus:::infrastructure\n    LoyaltyService:::newService\n    EngagementService:::newService\n    EagleEye:::external\n    Braze:::external\n    D365CE:::external\n    classDef newService fill:#4CAF50,stroke:#2E7D32,stroke-width:3px,color:#fff\n    classDef external fill:#FF9800,stroke:#E65100,stroke-width:2px,color:#fff\n    classDef infrastructure fill:#2196F3,stroke:#0D47A1,stroke-width:2px,color:#fff\n    classDef presentation fill:#9C27B0,stroke:#4A148C,stroke-width:2px,color:#fff\n    classDef customer fill:#607D8B,stroke:#263238,stroke-width:2px,color:#fff\n----\n\n\n==== Key Architectural Patterns\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Pattern |Application |Rationale\n\n|*Anti-Corruption Layer (ACL)*\n|EngagementService → Salesforce Service Cloud\n|Protects digital channels (Mobile App, Web) from Salesforce API changes, translates between OTR domain language and Salesforce Case/Contact model, enables independent evolution of internal domain model\n\n|*Conformist*\n|ProfileService → Salesforce, EngagementService → Salesforce\n|Shared Viva Energy Salesforce instance - we conform to existing configuration, governance, and API contracts (external system we don't control)\n\n|*Backend-for-Frontend (BFF)*\n|EngagementService\n|Aggregates customer feedback submission, Contact lookup, async Case creation, and Braze notification orchestration for digital channel clients\n\n|*Event-Driven Architecture (OHS+PL)*\n|Event Bus (SNS+SQS/EventBridge/Kinesis)\n|Loose coupling between bounded contexts, async domain event publishing (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`), foundation for future bounded contexts\n\n|*Just-In-Time (JIT) Integration*\n|ProfileService → Salesforce Contact reconciliation\n|Reconcile app users as Salesforce Contacts on-demand (upsert by email), no pre-sync required, ensures Salesforce has current Contact data\n\n|*Async Processing*\n|EngagementService Case creation via Event Bus\n|Non-blocking user experience, resilience to Salesforce downtime, automatic retry with exponential backoff, dead letter queue for operations team intervention\n\n|*Strangler Fig*\n|Not applicable\n|Big bang cutover (no gradual migration) - D365 CE fully replaced, not incrementally strangled\n\n|===\n\n<<<\n== Solution Approach\n\n* Deploy xref:bounded-contexts:profile.adoc[ProfileService] and xref:bounded-contexts:engagement.adoc[EngagementService] as bounded context microservices\n* Implement Anti-Corruption Layers (ACLs) for Salesforce and Braze integration\n* Establish event-driven architecture as the foundational integration pattern\n* Big bang cutover (TS-1 → TS-4)\n\n=== Related Documentation\n\nThis solution architecture references detailed technical specifications:\n\n==== Architecture Definition\n\n* xref:architecture-definitions:salesforce_customer_support.adoc[Salesforce Customer Support - Architecture Definition] - Business requirements, architecture decisions (ADRs), bounded context definitions, high-level integration patterns\n\n==== Bounded Context Specifications\n\n* xref:bounded-contexts:profile.adoc[ProfileService Bounded Context] - JIT Contact reconciliation, aggregate definitions\n* xref:bounded-contexts:engagement.adoc[EngagementService Bounded Context] - Customer feedback facade, Anti-Corruption Layer\n\n==== Interface Specifications\n\nDetailed API specifications available in the specifications directory:\n\n* link:../../specifications/rest/profile-service-v1.yaml[ProfileService REST API v1] - OpenAPI 3.0 specification for `/profile/v1` endpoints (includes Salesforce Contact reconciliation `GET /contact-id`)\n* link:../../specifications/rest/engagement-service-v1.yaml[EngagementService REST API v1] - OpenAPI 3.0 specification for `/engagement/v1` endpoints (includes `POST /feedback`)\n* link:../../specifications/events/engagement-events.json[Engagement Domain Events] - CloudEvents 1.0 JSON Schema for `SupportCaseCreated`, `SupportCaseUpdated`, `SupportCaseResolved`, `CustomerFeedbackSubmitted`\n\n==== External System Documentation\n\n* https://developer.salesforce.com/docs/atlas.en-us.api_rest.meta/api_rest/[Salesforce REST API Documentation] - Contact and Case object APIs\n* https://www.braze.com/docs/api/endpoints/messaging/send_messages/post_send_triggered_campaigns/[Braze Campaign Trigger API] - Push notification campaigns\n\n<<<\n== Executive Summary\n\n=== Challenge\n\nOTR digital customers (Mobile App, Web) currently submit feedback and support requests to D365 Customer Engagement, while Viva Energy's broader business units (fuel wholesale, Shell Card customers, other retail channels) use Salesforce Service Cloud. This creates:\n\n* *Fragmented customer support platform*: Customer support data split across two systems, preventing support agents from having a unified view of customer interactions across all channels\n* *Operational inefficiency*: Maintaining two separate customer support platforms increases operational overhead and costs\n* *Poor support experience*: D365 CE is not working well for digital customer support, impacting customer satisfaction and case resolution times\n* *Post-merger consolidation opportunity*: Following Viva Energy's acquisition of OTR, strategic alignment on Salesforce as the enterprise customer support platform\n\n=== Solution\n\nThis architecture establishes the **foundational Domain-Driven Design (DDD) implementation** for OTR's target state architecture by introducing two new bounded contexts (link:../bounded_context/profile.adoc[ProfileService], link:../bounded_context/engagement.adoc[EngagementService]) and event-driven integration patterns:\n\n==== New Bounded Contexts\n\n* *link:../bounded_context/profile.adoc[ProfileService]* (NEW): Just-In-Time (JIT) Contact reconciliation with Salesforce, upsert by email, returns Salesforce Contact ID to Mobile App\n* *link:../bounded_context/engagement.adoc[EngagementService]* (NEW): Customer feedback submission, Anti-Corruption Layer (ACL) for Salesforce Case creation, Braze integration for all outbound customer communications (push, email, SMS), async Case processing via Event Bus\n* *Event Bus* (NEW pattern): Domain event publishing using existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis) - first implementation of event-driven architecture pattern\n\n==== Integration Architecture\n\n* *Salesforce = System of Record*: Salesforce Service Cloud (shared Viva Energy instance) owns Contact and Case data\n* *Conformist Pattern*: ProfileService and EngagementService conform to existing Salesforce configuration and API contracts\n* *Anti-Corruption Layer*: EngagementService protects digital channels from Salesforce API changes, translates between OTR domain language and Salesforce\n* *Async Case Creation*: Non-blocking user experience, resilience to Salesforce downtime, automatic retry with exponential backoff, dead letter queue for failed Cases\n* *Event-Driven Notifications*: Salesforce webhook → EngagementService → Braze for all customer communications (push, email, SMS) on Case status updates\n\n==== Migration Approach\n\n* *Contact Migration*: One-time migration from app-specific database → Salesforce (upsert with flexible matching by email/phone/VCI)\n* *No Case Migration*: Historical D365 CE Cases not migrated (fresh start in Salesforce)\n* *Big Bang Cutover*: Single deployment, no phased rollout or parallel run\n* *D365 CE Retirement*: Complete decommissioning of D365 Customer Engagement post-cutover\n\n=== Key Architectural Significance\n\nThis migration establishes the first implementation of OTR's target DDD architecture:\n\n* First bounded contexts implemented (ProfileService, EngagementService)\n* First event-driven domain event pattern (foundation for future bounded contexts)\n* Foundation for Flybuys integration (ProfileService Contact reconciliation reused)\n* Establishes integration patterns (Conformist, ACL, Event-Driven) for future services\n\n=== Success Criteria\n\n* All digital customer feedback routed to Salesforce Service Cloud within 30 days of launch\n* Support agents have unified customer view across all Viva Energy channels (digital, wholesale, Shell Card, other retail)\n* D365 Customer Engagement decommissioned within 90 days post-cutover\n* Customer satisfaction score improves by 15% within 6 months\n* Average case resolution time decreases by 20% within 6 months\n* Zero data loss during Contact migration (100% validation pass rate)\n* Mobile App feedback submission success rate > 99.5% (including async Case creation)\n\n=== Technical Constraints\n\n* Shared Salesforce instance (Viva Energy multi-tenant environment)\n* Conform to existing Salesforce configuration and governance (data isolation strategy TBD with Salesforce admin team)\n* Contact migration must complete before cutover (no parallel run)\n* Async Case creation mandatory (non-blocking user experience)\n* Expected volume: 100-150 feedback submissions/day from 20k DAU (~0.5-0.75% submission rate), architecture capacity planned for 3x-10x growth\n\n=== Open Technical Decisions (TBD)\n\n* Salesforce Case field mapping for digital feedback categories (App, Service, Order, Rewards, Refund, Delete Account)\n* Salesforce data isolation strategy (Record Types, custom fields, queues)\n* Salesforce REST API authentication method (OAuth 2.0, Connected App, JWT bearer flow)\n* Salesforce webhook mechanism for Case updates (Outbound Messages, Platform Events, Process Builder)\n* Retry policy configuration (attempts, backoff intervals)\n* Salesforce API rate limit strategy (expected volume: 100-150 submissions/day from 20k DAU, capacity planning for 3x-10x growth)\n\n== Technical Requirements\n\n[width=\"100%\",cols=\"8%,92%\",options=\"header\",]\n|===\n|ID |Description\n\n|TR-CS-001\n|Every Mobile App user must have a Salesforce Contact record in Salesforce Service Cloud (shared Viva Energy instance)\n\n|TR-CS-002\n|ProfileService must reconcile Mobile App users as Salesforce Contacts using Just-In-Time (JIT) upsert by email address\n\n|TR-CS-003\n|ProfileService must return Salesforce Contact ID to Mobile App for feedback submission\n\n|TR-CS-004\n|Mobile App must support customer feedback submission with fields: Category (App, Service, Order, Rewards, Refund, Delete Account), Store Name, Time of Visit, Contact Phone Number, Free Text Message\n\n|TR-CS-005\n|EngagementService must create Salesforce Cases asynchronously via Event Bus (non-blocking user experience)\n\n|TR-CS-006\n|EngagementService must acknowledge feedback submission immediately to Mobile App user (\"Feedback submitted\" confirmation)\n\n|TR-CS-007\n|EngagementService must send push notification to customer via Braze when Case is successfully created in Salesforce\n\n|TR-CS-008\n|EngagementService must retry failed Case creation with configurable exponential backoff and dead letter queue for operations team intervention\n\n|TR-CS-009\n|Salesforce must be the System of Record for Contact and Case data (no local persistence in ProfileService or EngagementService)\n\n|TR-CS-010\n|Contact migration from app-specific database to Salesforce must complete before Mobile App cutover (upsert with flexible matching by email/phone/VCI)\n\n|TR-CS-011\n|No Case migration from D365 Customer Engagement to Salesforce (fresh start, historical Cases not migrated)\n\n|TR-CS-012\n|EngagementService must publish domain events (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`) to Event Bus for consumption by other bounded contexts\n\n|TR-CS-013\n|EngagementService must receive Salesforce webhook notifications when Cases are updated/resolved by support agents\n\n|TR-CS-014\n|EngagementService must trigger Braze push notifications to customers when Cases are updated/resolved (via Salesforce webhook → EngagementService → Braze)\n\n|TR-CS-015\n|ProfileService and EngagementService must conform to existing Salesforce configuration and API contracts (Conformist pattern)\n\n|TR-CS-016\n|All changes must be communicated using event-driven architecture via Event Bus (using existing AWS infrastructure: SNS+SQS/EventBridge/Kinesis)\n\n|TR-CS-017\n|Mobile App feedback submission success rate must exceed 99.5% (including async Case creation completion)\n\n|TR-CS-018\n|Contact migration must achieve 100% validation pass rate (zero data loss)\n\n|TR-CS-019\n|D365 Customer Engagement must be fully decommissioned within 90 days post-cutover\n\n|===\n\n== Technical Architecture\n\n=== Technical Capability Requirements\n\n==== Requirements Traceability\n\n[width=\"100%\",cols=\"15%,50%,35%\",options=\"header\",]\n|===\n|Requirement ID |Requirement Summary |Architectural Building Blocks\n\n|TR-CS-001\n|Every Mobile App user must have Salesforce Contact record\n|ABB-CS-001 (ProfileService), ABB-CS-004 (Salesforce), ABB-CS-007 (Contact Migration Tool)\n\n|TR-CS-002\n|ProfileService JIT Contact reconciliation via upsert by email\n|ABB-CS-001 (ProfileService), ABB-CS-004 (Salesforce)\n\n|TR-CS-003\n|ProfileService returns Salesforce Contact ID to Mobile App\n|ABB-CS-001 (ProfileService), ABB-CS-006 (Mobile App)\n\n|TR-CS-004\n|Mobile App supports feedback submission with structured fields\n|ABB-CS-006 (Mobile App), ABB-CS-002 (EngagementService)\n\n|TR-CS-005\n|EngagementService creates Salesforce Cases asynchronously\n|ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus), ABB-CS-004 (Salesforce)\n\n|TR-CS-006\n|EngagementService immediate acknowledgment to Mobile App\n|ABB-CS-002 (EngagementService), ABB-CS-006 (Mobile App)\n\n|TR-CS-007\n|EngagementService sends push notification via Braze on Case creation\n|ABB-CS-002 (EngagementService), ABB-CS-005 (Braze)\n\n|TR-CS-008\n|EngagementService retry logic with exponential backoff and DLQ\n|ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus)\n\n|TR-CS-009\n|Salesforce is System of Record for Contact and Case data\n|ABB-CS-004 (Salesforce), ABB-CS-001 (ProfileService - stateless), ABB-CS-002 (EngagementService - stateless)\n\n|TR-CS-010\n|Contact migration before Mobile App cutover\n|ABB-CS-007 (Contact Migration Tool), ABB-CS-004 (Salesforce)\n\n|TR-CS-011\n|No Case migration from D365 CE (fresh start)\n|ABB-CS-004 (Salesforce) - no migration tooling required\n\n|TR-CS-012\n|EngagementService publishes domain events to Event Bus\n|ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus)\n\n|TR-CS-013\n|EngagementService receives Salesforce webhook notifications\n|ABB-CS-002 (EngagementService), ABB-CS-004 (Salesforce)\n\n|TR-CS-014\n|EngagementService triggers Braze notifications on Case updates\n|ABB-CS-002 (EngagementService), ABB-CS-004 (Salesforce), ABB-CS-005 (Braze)\n\n|TR-CS-015\n|ProfileService and EngagementService conform to Salesforce config\n|ABB-CS-001 (ProfileService), ABB-CS-002 (EngagementService), ABB-CS-004 (Salesforce)\n\n|TR-CS-016\n|Event-driven architecture via Event Bus\n|ABB-CS-003 (Event Bus), ABB-CS-002 (EngagementService)\n\n|TR-CS-017\n|Mobile App feedback submission success rate > 99.5%\n|ABB-CS-006 (Mobile App), ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus), ABB-CS-004 (Salesforce)\n\n|TR-CS-018\n|Contact migration 100% validation pass rate\n|ABB-CS-007 (Contact Migration Tool), ABB-CS-004 (Salesforce)\n\n|TR-CS-019\n|D365 CE decommissioned within 90 days post-cutover\n|All ABBs (replacement system operational)\n\n|===\n\n=== Service Catalogues\n\n==== Application Portfolio Catalogue\n\n[width=\"100%\",cols=\"20%,15%,15%,15%,35%\",options=\"header\",]\n|===\n|Application |Lifecycle State |Owner |Hosting Platform |Description\n\n|*ProfileService*\n|NEW\n|OTR Platform Team\n|AWS (TBD: Lambda/ECS/EKS)\n|JIT Contact reconciliation with Salesforce, returns Salesforce Contact ID, foundation for Flybuys integration\n\n|*EngagementService*\n|NEW\n|OTR Platform Team\n|AWS (TBD: Lambda/ECS/EKS)\n|Customer feedback submission facade, ACL for Salesforce Case creation, Braze integration for all outbound communications (push, email, SMS), webhook receiver\n\n|*Mobile App (iOS)*\n|ACTIVE (UPDATE)\n|OTR Mobile Team\n|Apple App Store\n|iOS native app with feedback form, integrate with ProfileService and EngagementService APIs\n\n|*Mobile App (Android)*\n|ACTIVE (UPDATE)\n|OTR Mobile Team\n|Google Play Store\n|Android native app with feedback form, integrate with ProfileService and EngagementService APIs\n\n|*Salesforce Service Cloud*\n|ACTIVE (EXPAND)\n|Viva Energy Salesforce Admin Team\n|Salesforce (SaaS)\n|Shared Viva Energy instance, System of Record for Contact and Case data, adding OTR digital customer support\n\n|*Braze*\n|ACTIVE (EXTEND)\n|OTR Marketing Team\n|Braze (SaaS)\n|Marketing automation platform, EngagementService triggers push notifications for Case updates\n\n|*D365 Customer Engagement*\n|RETIRE\n|OTR Support Team\n|Microsoft Azure (SaaS)\n|Legacy customer support platform, decommissioned within 90 days post-cutover\n\n|*App-Specific Customer Database*\n|RETIRE\n|OTR Platform Team\n|AWS (RDS/DynamoDB)\n|Legacy customer contact storage, one-time migration to Salesforce, then deprecated\n\n|*Event Bus*\n|NEW\n|OTR Platform Team\n|AWS (SNS+SQS/EventBridge/Kinesis)\n|Domain event publishing infrastructure for bounded context integration\n\n|*Contact Migration Tool*\n|TEMPORARY\n|OTR Platform Team\n|AWS (Script/Lambda)\n|One-time migration app database → Salesforce with upsert logic, retired after migration complete\n\n|===\n\n==== Technology Capability Requirements\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Technology Capability |Implementation Technology (TBD in detailed design) |Requirements\n\n|*Microservice Hosting*\n|AWS Lambda / ECS / EKS\n|Host ProfileService and EngagementService with auto-scaling, high availability, monitoring\n\n|*API Gateway*\n|AWS API Gateway / Application Load Balancer\n|REST API routing, authentication, rate limiting, request validation for ProfileService and EngagementService\n\n|*Event Bus*\n|AWS SNS+SQS / EventBridge / Kinesis\n|Domain event publishing, async message processing, retry logic, dead letter queue\n\n|*Salesforce Integration*\n|Salesforce REST API / SOAP API\n|Contact CRUD operations, Case creation, webhook notifications, OAuth 2.0 authentication\n\n|*Braze Integration*\n|Braze REST API / SDK\n|Push notification campaign triggers, customer profile reconciliation\n\n|*Authentication & Authorisation*\n|Microsoft Entra External ID / AWS Cognito\n|Mobile App user authentication, API authorisation, JWT token validation\n\n|*Observability & Monitoring*\n|AWS CloudWatch / Datadog / New Relic\n|Application metrics, logs, traces, dashboards, alerting (feedback submission rate, queue depth, API errors)\n\n|*Secret Management*\n|AWS Secrets Manager / Parameter Store\n|Salesforce credentials, Braze API keys, OAuth tokens, encryption keys\n\n|*Database (Migration Tool)*\n|AWS RDS / DynamoDB (read-only access)\n|Contact migration from app-specific database\n\n|*CI/CD Pipeline*\n|GitHub Actions / AWS CodePipeline\n|Automated build, test, deployment for ProfileService, EngagementService, Mobile App\n\n|*Infrastructure as Code*\n|Terraform / AWS CloudFormation / CDK\n|Declarative infrastructure provisioning for Event Bus, microservices, monitoring\n\n|*API Documentation*\n|OpenAPI / Swagger\n|ProfileService and EngagementService API specifications for Mobile App integration\n\n|===\n\n==== Feature Flag Register\n\n*Note*: Per ADR-CS-006 (big bang cutover, not phased rollout), feature flags are minimal and used primarily for emergency rollback/kill switches.\n\n[width=\"100%\",cols=\"20%,15%,35%,30%\",options=\"header\",]\n|===\n|Feature Flag |Default State |Purpose |Rollback Scenario\n\n|*enable_salesforce_feedback_submission*\n|OFF (pre-cutover), ON (post-cutover)\n|Enable/disable feedback submission to EngagementService → Salesforce (kill switch for emergency rollback to D365 CE)\n|Feedback submission success rate < 95%, Salesforce API failures, critical bugs - revert to D365 CE integration\n\n|*enable_async_case_creation*\n|ON\n|Enable/disable async Case creation via Event Bus (fallback to synchronous processing if Event Bus issues)\n|Event Bus infrastructure failures, queue backlog unmanageable - temporary synchronous processing\n\n|*enable_braze_notifications*\n|ON\n|Enable/disable Braze push notifications for Case updates (degrade gracefully if Braze integration fails)\n|Braze API failures, notification delivery rate < 80% - disable notifications temporarily\n\n|*enable_jit_contact_reconciliation*\n|ON\n|Enable/disable ProfileService JIT Contact reconciliation (fallback to cached Contact IDs if Salesforce unavailable)\n|Salesforce API downtime, Contact reconciliation failures > 5% - use cached Contact IDs temporarily\n\n|*enable_salesforce_webhook_processing*\n|ON\n|Enable/disable Salesforce webhook processing for Case updates (fallback to polling if webhook failures)\n|Webhook delivery failures, authentication issues - temporary polling fallback\n\n|===\n\n*Feature Flag Management*:\n\n* Feature flags managed via AWS AppConfig / LaunchDarkly / custom feature flag service (TBD in detailed design)\n* Mobile App feature flags controlled server-side (no app release required for flag changes)\n* Backend service feature flags configured via environment variables / configuration service\n* Feature flag changes logged and audited (who changed, when, reason)\n* Post-cutover monitoring: Gradual removal of feature flags once system stability confirmed (30-60 days)\n\n==== Data Entity Catalogue\n\n[width=\"100%\",cols=\"20%,15%,35%,30%\",options=\"header\",]\n|===\n|Data Entity |System of Record |Key Attributes |Lifecycle\n\n|*Contact*\n|Salesforce Service Cloud\n|• Contact ID (Salesforce 15/18-char ID) +\n• Email (primary matching key) +\n• First Name, Last Name +\n• Phone Number +\n• Viva Consumer ID (VCI) +\n• Account (Viva Energy customer account) +\n• Record Type (OTR Digital vs other channels)\n|Created: ProfileService JIT reconciliation or Contact Migration Tool +\nUpdated: ProfileService JIT upsert (email changes), Salesforce (manual updates by support agents) +\nDeleted: Salesforce retention policy (GDPR/compliance)\n\n|*Case*\n|Salesforce Service Cloud\n|• Case Number (Salesforce auto-generated) +\n• Contact ID (reference to Contact) +\n• Subject (derived from Category) +\n• Description (Free Text Message) +\n• Category (App, Service, Order, Rewards, Refund, Delete Account) +\n• Store Name (OTR location) +\n• Time of Visit +\n• Status (New, In Progress, Resolved, Closed) +\n• Priority, Origin (Mobile App) +\n• Owner (support agent/queue)\n|Created: EngagementService async Case creation +\nUpdated: Support agents (Salesforce UI), EngagementService (webhook processing) +\nDeleted: Salesforce retention policy (archive after X years)\n\n|*Feedback Submission (transient)*\n|None (not persisted)\n|• Salesforce Contact ID +\n• Category +\n• Store Name +\n• Time of Visit +\n• Contact Phone Number +\n• Free Text Message\n|Created: Mobile App user submission +\nProcessed: EngagementService publishes to Event Bus, Case created in Salesforce +\nNot persisted in ProfileService/EngagementService (stateless)\n\n|*Domain Events*\n|Event Bus (ephemeral)\n|**SupportCaseCreated**: +\n• Case Number, Contact ID, Category, Timestamp +\n**SupportCaseUpdated**: +\n• Case Number, Status, Updated By, Timestamp +\n**SupportCaseResolved**: +\n• Case Number, Resolution, Resolved By, Timestamp +\n**CustomerFeedbackSubmitted**: +\n• Contact ID, Category, Timestamp\n|Published: EngagementService +\nConsumed: Other bounded contexts (future), Braze notification triggers +\nRetention: Short-lived (minutes to hours), not persisted for event sourcing\n\n|*Braze Customer Profile*\n|Braze\n|• External User ID (VCI or Email) +\n• Push Notification Tokens (iOS/Android) +\n• Notification Preferences +\n• Campaign Engagement History\n|Created/Updated: EngagementService on Case creation/update +\nManaged: Braze (external SaaS)\n\n|===\n\n*Data Migration Entities*:\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Source Entity |Target Entity |Migration Strategy\n\n|*App Database Contact*\n|Salesforce Contact\n|One-time migration via Contact Migration Tool: +\n• Upsert by email (primary), phone (secondary), VCI (tertiary) +\n• Map: Email → Email, Name → First/Last Name, Phone → Phone, VCI → External ID +\n• Validation: 100% data integrity check, reconciliation report\n\n|*D365 CE Case*\n|Not migrated\n|ADR-CS-005: No Case migration (fresh start in Salesforce) +\nD365 CE Cases archived separately for compliance if needed\n\n|===\n\n==== Data Quality & Validation\n\n*Contact Migration Validation Rules*:\n\n* Email format validation (RFC 5322 compliance)\n* Phone number format validation (E.164 international format)\n* VCI format validation (alphanumeric, length constraints)\n* Duplicate detection: Flag potential duplicates for manual review (same email/phone combination)\n* Mandatory fields: Email (required), First Name, Last Name (required for Salesforce Contact)\n\n*Case Creation Validation Rules*:\n\n* Contact ID must exist in Salesforce (validated by EngagementService before Case creation)\n* Category must be one of: App, Service, Order, Rewards, Refund, Delete Account\n* Free Text Message maximum length: 32,000 characters (Salesforce Case Description limit)\n* Store Name validated against OTR location master data (optional - warn if not found)\n\n<<<\n== Solution Building Blocks\n\nThis section defines the specific technology products, configurations, and implementation details for each Solution Building Block (SBB).\n\n=== Technology Portfolio Catalogue\n\n[width=\"100%\",cols=\"10%,20%,25%,25%,20%\",options=\"header\",]\n|===\n|SBB ID |Component |Technology Product |Version/Configuration |Deployment Platform\n\n|SBB-CS-001\n|ProfileService Microservice\n|.NET 8 / Node.js 20 LTS\n|RESTful API, containerised\n|AWS ECS Fargate / Lambda\n\n|SBB-CS-002\n|EngagementService Microservice\n|.NET 8 / Node.js 20 LTS\n|RESTful API, containerised, async workers\n|AWS ECS Fargate / Lambda\n\n|SBB-CS-003\n|Event Bus\n|AWS SNS + SQS / EventBridge\n|Standard queues, FIFO for ordering\n|AWS (managed service)\n\n|SBB-CS-004\n|API Gateway\n|AWS API Gateway / ALB\n|REST API, JWT validation\n|AWS (managed service)\n\n|SBB-CS-005\n|Salesforce Integration Layer\n|Salesforce REST API Client\n|OAuth 2.0 JWT bearer flow\n|Embedded in SBB-CS-001/002\n\n|SBB-CS-006\n|Braze Integration Layer\n|Braze REST API SDK\n|API key authentication\n|Embedded in SBB-CS-002\n\n|SBB-CS-007\n|Contact Migration Tool\n|Python 3.11 / .NET 8\n|One-time batch script\n|AWS Lambda / EC2\n\n|SBB-CS-008\n|Application Monitoring\n|AWS CloudWatch / Datadog\n|Metrics, logs, traces, dashboards\n|AWS / SaaS\n\n|SBB-CS-009\n|Secret Management\n|AWS Secrets Manager\n|KMS encryption\n|AWS (managed service)\n\n|SBB-CS-010\n|Mobile App (iOS)\n|SwiftUI, Kotlin Multiplatform\n|iOS 15+\n|Apple App Store\n\n|SBB-CS-011\n|Mobile App (Android)\n|Jetpack Compose, Kotlin Multiplatform\n|Android 8+\n|Google Play Store\n\n|SBB-CS-012\n|Feature Flag Service\n|AWS AppConfig / LaunchDarkly\n|Server-side flags, real-time updates\n|AWS / SaaS\n\n|===\n\n<<<\n== Data Architecture\n\nThis section defines the physical data models, event schemas, and API request/response formats.\n\n=== Domain Event Schemas\n\nAll domain events follow the https://cloudevents.io/[CloudEvents 1.0] specification for consistency and interoperability.\n\n*Event Schema Specifications*: See // TODO: Add to Antora - specifications/events/engagement-events.json[Engagement Service Event Schemas] for complete JSON schemas and examples.\n\n==== Event Catalogue\n\n[width=\"100%\",cols=\"30%,20%,50%\",options=\"header\",]\n|===\n|Event Type |Publisher |Description\n\n|`SupportCaseCreated`\n|EngagementService\n|Published when EngagementService successfully creates a Case in Salesforce after async processing\n\n|`SupportCaseUpdated`\n|EngagementService (via Salesforce webhook)\n|Published when a support agent updates a Case in Salesforce (status, priority, comment changes)\n\n|`SupportCaseResolved`\n|EngagementService (via Salesforce webhook)\n|Published when a support agent resolves/closes a Case in Salesforce\n\n|`CustomerFeedbackSubmitted`\n|EngagementService\n|Published when customer submits feedback via Mobile App (before async Case creation)\n\n|===\n\n*Event Format*: All events use CloudEvents 1.0 envelope with event-specific payload in the `data` field.\n\n*Schema Location*: `specifications/events/engagement-events.json`\n\n=== API Request/Response Schemas\n\n==== ProfileService: GET /profile/contact-id\n\n*Response* (200 OK):\n[source,json]\n----\n{\n  \"contactId\": \"0034X00000ABCDEFG\",\n  \"email\": \"customer@example.com\",\n  \"firstName\": \"John\",\n  \"lastName\": \"Smith\"\n}\n----\n\n==== EngagementService: POST /feedback\n\n*Request*:\n[source,json]\n----\n{\n  \"contactId\": \"0034X00000ABCDEFG\",\n  \"category\": \"App\",\n  \"storeName\": \"OTR Adelaide\",\n  \"timeOfVisit\": \"2026-01-07T12:00:00Z\",\n  \"contactPhoneNumber\": \"+61412345678\",\n  \"message\": \"App crashed when submitting feedback\"\n}\n----\n\n*Response* (202 Accepted):\n[source,json]\n----\n{\n  \"feedbackId\": \"fb-2026-01-07-12345\",\n  \"status\": \"submitted\",\n  \"message\": \"Your feedback has been submitted!\"\n}\n----\n\n=== Salesforce Field Mappings\n\n==== Case Object Mapping\n\n[width=\"100%\",cols=\"25%,25%,25%,25%\",options=\"header\",]\n|===\n|OTR Field |Salesforce Field |Data Type |Notes\n\n|Category\n|Feedback_Category__c\n|Picklist\n|App, Service, Order, Rewards, Refund, Delete Account\n\n|Store Name\n|Store_Name__c\n|String (255)\n|OTR location name\n\n|Time of Visit\n|Time_of_Visit__c\n|DateTime\n|When customer visited store\n\n|Free Text Message\n|Description\n|Long Text (32,000)\n|Customer feedback message\n\n|===\n\n<<<\n=== Baseline Architecture\n\n==== Existing System Components\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Component |Current State |Status\n\n|*D365 Customer Engagement*\n|Customer support platform for OTR digital customers (Mobile App, Web), handles feedback submission and case management\n|**DEPRECATED** - Being replaced by Salesforce Service Cloud\n\n|*App-Specific Customer Database*\n|Stores customer contact data for Mobile App users, separate from Viva Energy systems\n|**MIGRATING** - One-time migration to Salesforce, then deprecated\n\n|*Mobile App*\n|iOS/Android native apps with feedback submission form including Category, Store Name, Time of Visit, Contact Phone Number, and Free Text Message fields\n|**REQUIRES UPDATE** - Integrate with ProfileService and EngagementService APIs (feedback form UI already complete)\n\n|*Salesforce Service Cloud*\n|Shared Viva Energy instance handling customer support for fuel wholesale, Shell Card customers, other retail channels\n|**EXPANDING** - Adding OTR digital customer support Cases and Contacts\n\n|*Existing AWS Infrastructure*\n|SNS+SQS / EventBridge / Kinesis available for event-driven architecture\n|**REUSING** - Event Bus implementation leverages existing infrastructure\n\n|===\n\n==== Integration Architecture\n\n*Current state:*\n\n* Mobile App → D365 Customer Engagement (direct integration)\n* App-specific customer database → standalone (no Salesforce integration)\n* No event-driven architecture (synchronous, tightly coupled)\n* No Anti-Corruption Layer protecting digital channels\n* Viva Energy support teams use Salesforce, OTR digital support uses D365 CE (fragmented)\n\n==== Technical Debt\n\n*No longer relevant* - D365 CE being deprecated, not documenting technical debt of system being retired.\n\n*New technical debt introduced by this migration:*\n\n* Salesforce field mapping TBD (requires coordination with Viva Energy Salesforce admin team)\n* Data isolation strategy TBD (Record Types, custom fields, queues - multi-tenant governance)\n* Salesforce webhook mechanism TBD (Outbound Messages vs Platform Events vs Process Builder)\n* Expected feedback volume unknown (gathering data for rate limit planning)\n\n=== Gap Analysis\n\n==== Missing Capabilities\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Missing Capability |Description\n\n|*ProfileService bounded context*\n|No existing service for Contact reconciliation with Salesforce - requires new microservice implementing JIT upsert by email, returning Salesforce Contact ID\n\n|*EngagementService bounded context*\n|No existing service for customer feedback facade - requires new microservice implementing Anti-Corruption Layer for Salesforce Case creation, Braze integration, async processing via Event Bus\n\n|*Event Bus domain event pattern*\n|No existing domain event publishing infrastructure - requires implementing event-driven architecture pattern using existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis)\n\n|*Async Case creation workflow*\n|Current D365 CE integration is synchronous - requires implementing async processing with retry logic, exponential backoff, dead letter queue\n\n|*Salesforce webhook integration*\n|No existing capability to receive Salesforce notifications - requires implementing webhook receiver in EngagementService for Case update notifications\n\n|*Braze push notification orchestration*\n|No existing integration for Case-related push notifications - requires implementing Braze campaign triggers from EngagementService\n\n|*Contact migration tooling*\n|No existing tooling for app database → Salesforce Contact migration with upsert logic (match by email/phone/VCI)\n\n|*Feedback form enhancements*\n|Mobile App feedback form lacks structured fields (Category, Store Name, Time of Visit, Contact Phone Number) - requires UI updates\n\n|===\n\n==== Missing Bounded Contexts\n\n[width=\"100%\",cols=\"30%,30%,40%\",options=\"header\",]\n|===\n|Bounded Context |Responsibilities |Implementation Status\n\n|*link:../bounded_context/profile.adoc[ProfileService]*\n|JIT Contact reconciliation with Salesforce (upsert by email), return Salesforce Contact ID to digital channels, foundation for future Flybuys partner linking\n|**NEW** - First bounded context implementation\n\n|*link:../bounded_context/engagement.adoc[EngagementService]*\n|Customer feedback submission facade, Anti-Corruption Layer for Salesforce Case creation, Braze integration for push notifications, async Case processing, webhook receiver for Case updates\n|**NEW** - First bounded context implementation\n\n|===\n\n==== Missing Integration Patterns\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Integration Pattern |Description\n\n|*Anti-Corruption Layer (ACL)*\n|EngagementService → Salesforce Service Cloud - protects digital channels from Salesforce API changes, translates between OTR domain language and Salesforce\n\n|*Conformist*\n|ProfileService/EngagementService → Salesforce - conform to existing Salesforce configuration and API contracts (shared Viva Energy instance)\n\n|*Event-Driven Architecture (OHS+PL)*\n|Event Bus publishing domain events (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`) for loose coupling between bounded contexts\n\n|*Just-In-Time (JIT) Integration*\n|ProfileService → Salesforce Contact reconciliation on-demand (no pre-sync)\n\n|*Async Processing*\n|EngagementService Case creation via Event Bus with retry, exponential backoff, dead letter queue\n\n|===\n\n=== Target State Architecture\n\n==== Architectural Building Blocks (ABB)\n\n[width=\"100%\",cols=\"20%,25%,30%,25%\",options=\"header\",]\n|===\n|ABB ID |Bounded Context |Responsibilities |Technology (TBD in Solution Architecture)\n\n|ABB-CS-001\n|*link:../bounded_context/profile.adoc[ProfileService]*\n|JIT Contact reconciliation with Salesforce (upsert by email), return Salesforce Contact ID, foundation for Flybuys partner linking\n|Microservice (.NET/Node.js), REST API, Salesforce REST API client\n\n|ABB-CS-002\n|*link:../bounded_context/engagement.adoc[EngagementService]*\n|Customer feedback submission facade, ACL for Salesforce Case creation, Braze integration, async processing, webhook receiver\n|Microservice (.NET/Node.js), REST API, Event Bus publisher/subscriber, Salesforce webhook receiver\n\n|ABB-CS-003\n|*Event Bus*\n|Domain event publishing infrastructure (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`)\n|AWS SNS+SQS / EventBridge / Kinesis\n\n|ABB-CS-004\n|*Salesforce Service Cloud*\n|System of Record for Contact and Case data (shared Viva Energy instance)\n|Salesforce Service Cloud (external SaaS)\n\n|ABB-CS-005\n|*Braze*\n|Marketing automation platform for push notifications\n|Braze (external SaaS) - existing integration\n\n|ABB-CS-006\n|*Mobile App*\n|iOS/Android native apps with enhanced feedback form (Category, Store Name, Time of Visit, Contact Phone Number, Free Text Message)\n|Kotlin Multiplatform, SwiftUI, Jetpack Compose\n\n|ABB-CS-007\n|*Contact Migration Tool*\n|One-time migration app database → Salesforce with upsert logic (match by email/phone/VCI)\n|Script/tool (.NET/Python/Node.js)\n\n|===\n\n==== Integration Architecture\n\n===== Integration Flows\n\n*Customer Feedback Submission (Async):*\n\n1. *Mobile App* → ProfileService: Authenticate user, get Salesforce Contact ID (JIT reconciliation)\n2. *Mobile App* → EngagementService: Submit feedback (POST /feedback with Contact ID, Category, Store Name, Time of Visit, Phone, Message)\n3. *EngagementService* → Mobile App: Immediate acknowledgment (\"Feedback submitted\")\n4. *EngagementService* → Event Bus: Publish work item for async Case creation\n5. *Background Worker* (EngagementService) → Salesforce: Create Case via REST API\n6. *Success*: EngagementService → Event Bus: Publish `SupportCaseCreated` event\n7. *EngagementService* → Braze: Trigger push notification campaign (\"Your feedback has been received, Case #12345\")\n8. *Failure*: Retry with exponential backoff → Dead Letter Queue → Ops team alert\n\n*Case Update Notification (Bidirectional):*\n\n1. *Support Agent* updates/resolves Case in Salesforce\n2. *Salesforce* → EngagementService: Webhook notification (Case updated)\n3. *EngagementService* → Event Bus: Publish `SupportCaseUpdated` or `SupportCaseResolved` event\n4. *EngagementService* → Braze: Trigger push notification campaign (\"Your case has been resolved\")\n\n*Contact Reconciliation (JIT):*\n\n1. *Mobile App user* authenticates\n2. *Mobile App* → ProfileService: GET /profile/contact-id\n3. *ProfileService* → Salesforce: Query Contact by email\n4. *Match found*: Return existing Salesforce Contact ID\n5. *No match*: Create new Contact in Salesforce, return new Contact ID\n6. *ProfileService* → Mobile App: Return Salesforce Contact ID (cached by Mobile App)\n\n===== System of Record Boundaries\n\n[width=\"100%\",cols=\"30%,35%,35%\",options=\"header\",]\n|===\n|Data Entity |System of Record |Rationale\n\n|*Contact*\n|Salesforce Service Cloud\n|Shared Viva Energy instance, unified customer profile across all channels (digital, wholesale, Shell Card, retail)\n\n|*Case*\n|Salesforce Service Cloud\n|Support agents manage Cases in Salesforce, digital channels submit via EngagementService ACL\n\n|*Feedback Submission (transient)*\n|None (no persistence)\n|EngagementService processes feedback and creates Case in Salesforce, no local storage\n\n|*Domain Events*\n|Event Bus (ephemeral)\n|Events published to Event Bus, consumed by subscribers, not persisted long-term (event sourcing not in scope)\n\n|===\n\n==== Data Architecture Principles\n\n===== Aggregate Persistence\n\n*ProfileService:*\n\n* **No local aggregate persistence** - ProfileService is stateless, queries Salesforce on-demand\n* Salesforce Contact is the aggregate root (owned by Salesforce)\n* ProfileService acts as facade/translator, not system of record\n\n*EngagementService:*\n\n* **No local aggregate persistence** - EngagementService is stateless, creates Cases in Salesforce via ACL\n* Salesforce Case is the aggregate root (owned by Salesforce)\n* EngagementService maintains no local Case state (Conformist pattern - trust Salesforce as source of truth)\n* Async processing state managed via Event Bus (work items in queue, not database)\n\n===== Event Store\n\n* **Event Bus** (SNS+SQS/EventBridge/Kinesis) handles domain event publishing\n* Events are **ephemeral** (consumed and discarded, not persisted for event sourcing)\n* No Event Store implementation in this architecture (future enhancement if needed)\n* Event schema versioning TBD in Solution Architecture\n\n\n=== Architecture Decisions\n\n==== ADR-CS-001: Consolidate onto Salesforce Service Cloud (not build custom solution)\n\n*Status*: Accepted\n\n*Context*:\n\n* D365 Customer Engagement not working well for digital customer support\n* Viva Energy already uses Salesforce Service Cloud for fuel wholesale, Shell Card, other retail channels\n* Post-merger opportunity to consolidate onto single platform\n* Alternative: Build custom support platform or use different SaaS\n\n*Decision*:\n\nConsolidate OTR digital customer support onto Salesforce Service Cloud (shared Viva Energy instance).\n\n*Rationale*:\n\n* **Unified customer view**: Support agents see all interactions across channels (digital, wholesale, Shell Card, retail)\n* **Platform consolidation**: Single support platform reduces operational overhead and costs\n* **Proven solution**: Salesforce Service Cloud is established, feature-rich, well-supported\n* **Post-merger alignment**: Strategic decision to standardize on Viva Energy platforms\n* **Avoid custom development**: Building custom support platform would be costly and high-risk\n\n*Consequences*:\n\n* Unified customer support across Viva Energy Group\n* Reduced operational complexity (single platform vs two)\n* Leverage Salesforce capabilities (case routing, knowledge base, AI, omnichannel)\n* ⚠️ Conformist pattern required (shared instance, conform to existing configuration)\n* ⚠️ Multi-tenant governance needed (data isolation, security, queues)\n* ❌ Less control over platform evolution (SaaS vendor, shared instance)\n\n==== ADR-CS-002: Implement ProfileService and EngagementService as first DDD bounded contexts\n\n*Status*: Accepted\n\n*Context*:\n\n* OTR target architecture uses Domain-Driven Design with bounded contexts\n* This migration is opportunity to establish first implementation\n* Alternative: Direct Mobile App → Salesforce integration (no bounded contexts)\n* Alternative: Single monolithic service for all customer-facing APIs\n\n*Decision*:\n\nImplement ProfileService and EngagementService as separate bounded contexts following DDD strategic patterns.\n\n*Rationale*:\n\n* **Foundation for target architecture**: First implementation of DDD pattern for future bounded contexts (Flybuys, LocationService, PaymentService)\n* **Separation of concerns**: ProfileService handles identity/Contact reconciliation, EngagementService handles support/feedback (different responsibilities, different change rates)\n* **Anti-Corruption Layer**: EngagementService protects digital channels from Salesforce API changes\n* **Reusability**: ProfileService Contact reconciliation reused for Flybuys integration\n* **Event-driven architecture**: Establishes pattern for loose coupling between bounded contexts\n\n*Consequences*:\n\n* Establishes DDD architecture foundation for OTR\n* Reusable ProfileService for Flybuys and future integrations\n* Digital channels protected from Salesforce API changes (ACL)\n* Clear bounded context boundaries and responsibilities\n* ⚠️ Increased initial complexity (two new microservices vs direct integration)\n* ⚠️ Requires Event Bus infrastructure implementation\n* ⚠️ Team must learn DDD patterns and bounded context design\n\n==== ADR-CS-003: Async Case creation via Event Bus (not synchronous)\n\n*Status*: Accepted\n\n*Context*:\n\n* Current D365 CE integration is synchronous (user waits for Case creation)\n* Alternative: Keep synchronous integration (Mobile App → EngagementService → Salesforce synchronously)\n* Salesforce API may experience downtime or latency\n\n*Decision*:\n\nImplement async Case creation via Event Bus with immediate user acknowledgment, retry logic, exponential backoff, and dead letter queue.\n\n*Rationale*:\n\n* **Non-blocking user experience**: User gets immediate \"Feedback submitted\" confirmation, not waiting for Salesforce API\n* **Resilience**: If Salesforce is down, feedback still accepted, Case created when Salesforce recovers\n* **Retry logic**: Automatic retry with exponential backoff handles transient failures\n* **Operational visibility**: Dead letter queue alerts ops team to persistent failures\n* **Scalability**: Queue buffering handles traffic spikes\n\n*Consequences*:\n\n* Better user experience (no waiting for Salesforce API)\n* Resilient to Salesforce downtime (queue buffers work)\n* Automatic retry reduces manual intervention\n* Queue depth monitoring provides operational visibility\n* ⚠️ Eventual consistency (user gets success notification after Case created, not immediately)\n* ⚠️ Increased complexity (Event Bus, background workers, retry logic, DLQ)\n* ⚠️ Requires monitoring and alerting for DLQ\n\n==== ADR-CS-004: ProfileService uses email as primary matching key (not VCI)\n\n*Status*: Accepted\n\n*Context*:\n\n* ProfileService needs to reconcile Mobile App users as Salesforce Contacts\n* Alternative matching keys: VCI (Viva Consumer ID), email, phone, Salesforce External ID\n* Email changes are rare but possible\n\n*Decision*:\n\nUse email address as primary matching key for Contact reconciliation (JIT upsert by email).\n\n*Rationale*:\n\n* **Availability**: Email always available for authenticated users\n* **Uniqueness**: Email is unique identifier in Salesforce and Mobile App\n* **Salesforce standard**: Salesforce Contact uses email as standard lookup field\n* **Simplicity**: Single matching key simplifies upsert logic\n* **Edge case acceptable**: Email changes are rare, manual cleanup acceptable\n\n*Consequences*:\n\n* Simple upsert logic (query by email, create if not found)\n* Leverages Salesforce standard email field\n* Email always available from authentication\n* ⚠️ Email changes create duplicate Contacts (rare edge case, manual cleanup)\n* ⚠️ Future enhancement: Add VCI as Salesforce External ID for stable matching\n\n==== ADR-CS-005: No Case migration from D365 CE (fresh start)\n\n*Status*: Accepted\n\n*Context*:\n\n* D365 CE contains historical customer support Cases\n* Alternative: Migrate historical Cases to Salesforce (preserve support history)\n* Alternative: Archive D365 CE Cases separately (read-only access)\n\n*Decision*:\n\nDo not migrate historical Cases from D365 CE to Salesforce. Start fresh in Salesforce.\n\n*Rationale*:\n\n* **Limited value**: Historical D365 CE Cases not critical for future support\n* **Data quality**: D365 CE Case data may be inconsistent or incomplete\n* **Complexity**: Case migration requires mapping D365 CE schema to Salesforce, data transformation, validation\n* **Cost-benefit**: Migration effort outweighs value of historical data\n* **Archive option**: D365 CE Cases can be archived separately if needed (read-only access for auditing)\n\n*Consequences*:\n\n* Simpler migration (Contacts only, no Case migration)\n* Faster time to value (no Case migration delay)\n* Clean start in Salesforce (no legacy data quality issues)\n* ⚠️ Historical Cases not visible in Salesforce (support agents can't see old Cases)\n* ⚠️ D365 CE must remain accessible temporarily for historical Case lookups (if needed)\n* ❌ Loss of historical Case insights (reporting, analytics on old Cases)\n\n==== ADR-CS-006: Big bang cutover (not phased rollout)\n\n*Status*: Accepted\n\n*Context*:\n\n* Alternative: Phased rollout with feature flags (pilot users first, gradual enablement)\n* Alternative: Parallel run (submit to both D365 CE and Salesforce temporarily)\n* Flybuys integration uses phased rollout (AS-1, AS-2, AS-3 architecture states)\n\n*Decision*:\n\nBig bang cutover - migrate Contacts, deploy ProfileService and EngagementService, switch Mobile App, retire D365 CE.\n\n*Rationale*:\n\n* **Simplicity**: No parallel run complexity, no feature flag management\n* **Faster D365 CE retirement**: No extended transition period maintaining two systems\n* **Limited risk**: Customer support not mission-critical (not payment processing), rollback possible\n* **User base manageable**: OTR digital customers smaller than Flybuys integration scope\n* **Different use case**: Flybuys phased rollout manages points accrual complexity, support feedback is simpler\n\n*Consequences*:\n\n* Simpler deployment (single cutover, no AS-1/AS-2/AS-3 states)\n* Faster D365 CE retirement (no extended parallel run)\n* No feature flag complexity or pilot user management\n* ⚠️ Higher cutover risk (all users switch at once)\n* ⚠️ Requires comprehensive testing before cutover\n* ⚠️ Rollback plan required (revert to D365 CE if critical issues)\n\n==== ADR-CS-007: EngagementService receives Salesforce webhooks for Case updates\n\n*Status*: Accepted\n\n*Context*:\n\n* Support agents update/resolve Cases in Salesforce\n* Need to notify customers of Case status changes via push notifications\n* Alternative: Poll Salesforce API for Case updates (inefficient)\n* Alternative: No customer notifications (agents contact customers directly)\n\n*Decision*:\n\nSalesforce sends webhook notifications to EngagementService when Cases are updated/resolved. EngagementService triggers Braze push notifications.\n\n*Rationale*:\n\n* **Real-time notifications**: Customer notified immediately when agent resolves Case\n* **Efficient**: Webhook push model (not polling)\n* **Event-driven**: Aligns with event-driven architecture pattern\n* **Better customer experience**: Proactive notification vs waiting for agent contact\n\n*Consequences*:\n\n* Real-time customer notifications for Case updates\n* Efficient push model (no polling overhead)\n* Bidirectional integration (Mobile App → Salesforce → Mobile App)\n* ⚠️ Salesforce webhook mechanism TBD (Outbound Messages vs Platform Events vs Process Builder)\n* ⚠️ Webhook authentication and security required\n* ⚠️ EngagementService must handle webhook retries and failures\n\n<<<\n== Interface Specifications\n\nThis section provides references to the complete API specifications and event catalogue for ProfileService and EngagementService.\n\n=== REST API Specifications\n\nComplete OpenAPI 3.0 specifications are maintained in the `specifications/rest/` directory:\n\n==== ProfileService API v1\n\n*Specification*: link:../../specifications/rest/profile-service-v1.yaml[profile-service-v1.yaml]\n\n*Base URL*: `https://api.otr.com.au/profile/v1`\n\n*Authentication*: Bearer token (Microsoft Entra External ID JWT)\n\n*Key Endpoints*:\n\n* `GET /contact-id` - Retrieve or create Salesforce Contact ID for authenticated user (Just-In-Time reconciliation)\n** Used by Mobile App before submitting feedback to EngagementService\n** Upserts Salesforce Contact record using email as external key\n** Returns 18-character Salesforce Contact ID with caching (15-minute TTL)\n** Performance SLA: p95 < 300ms (uncached), p95 < 50ms (cached)\n\n==== EngagementService API v1\n\n*Specification*: link:../../specifications/rest/engagement-service-v1.yaml[engagement-service-v1.yaml]\n\n*Base URL*: `https://api.otr.com.au/engagement/v1`\n\n*Authentication*: Bearer token (Microsoft Entra External ID JWT)\n\n*Key Endpoints*:\n\n* `POST /feedback` - Submit customer feedback for async Case creation in Salesforce\n** Accepts contactId, category, storeName, timeOfVisit, contactPhoneNumber, message\n** Returns 202 Accepted immediately (async Case creation in background)\n** Publishes `CustomerFeedbackSubmitted` event for analytics\n** Creates Salesforce Case via Anti-Corruption Layer with retry logic\n** Performance SLA: p95 < 200ms (feedback accepted, not Case creation)\n\n=== Domain Events (AsyncAPI)\n\nComplete CloudEvents 1.0 JSON Schema specifications are maintained in the `specifications/events/` directory:\n\n*Specification*: link:../../specifications/events/engagement-events.json[engagement-events.json]\n\n==== Event Catalogue\n\n[width=\"100%\",cols=\"30%,20%,50%\",options=\"header\",]\n|===\n|Event Type |Publisher |Consumers\n\n|`CustomerFeedbackSubmitted`\n|EngagementService\n|Future bounded contexts, analytics, sentiment analysis\n\n|`SupportCaseCreated`\n|EngagementService\n|Future bounded contexts, analytics\n\n|`SupportCaseUpdated`\n|EngagementService (via Salesforce webhook)\n|Future bounded contexts, analytics\n\n|`SupportCaseResolved`\n|EngagementService (via Salesforce webhook)\n|Future bounded contexts, analytics\n\n|===\n\n==== Event Delivery Guarantees\n\n* **At-least-once delivery**: Events may be delivered multiple times, consumers must handle idempotency\n* **Ordering**: FIFO queues guarantee ordering for events with same `contactId`\n* **Retention**: 4 days (96 hours) in Event Bus\n* **Dead Letter Queue**: Failed events after 5 retries moved to DLQ for manual intervention\n* **Format**: CloudEvents 1.0 specification with JSON payload\n\n=== API Versioning Policy\n\n==== Version Numbering\n\n* **Format**: `/v{major}` in URL path (e.g., `/profile/v1`, `/engagement/v1`)\n* **Semantic Versioning**: Major version incremented for breaking changes only\n* **Backwards Compatibility**: Minor changes (new optional fields, new endpoints) don't require version bump\n\n==== When to Version\n\n*Breaking changes requiring new major version*:\n\n- Removing or renaming fields in request/response\n- Changing field data types (e.g., string → number)\n- Changing authentication mechanism\n- Removing endpoints\n\n*Non-breaking changes not requiring version bump*:\n\n- Adding new optional fields to request/response\n- Adding new endpoints\n- Expanding enum values (e.g., adding new feedback category)\n- Improving error messages\n\n==== Parallel Version Support\n\n* Support N and N-1 versions concurrently for 6 months\n* Deprecation notice: 3 months before sunsetting old version\n* Mobile App must upgrade to new version within deprecation window\n\n<<<\n== Work Packages\n\nThis section consolidates gaps and activities into implementable work packages aligned with TOGAF Phase E requirements.\n\n=== Work Package Overview\n\n[width=\"100%\",cols=\"15%,35%,25%,25%\",options=\"header\",]\n|===\n|Work Package ID |Name |Transition State |Key Deliverables\n\n|WP-CS-001\n|ProfileService Development\n|TS-1 (Build & Test)\n|ProfileService microservice, Salesforce Contact integration, REST API\n\n|WP-CS-002\n|EngagementService Development\n|TS-1 (Build & Test)\n|EngagementService microservice, Anti-Corruption Layer, Braze integration\n\n|WP-CS-003\n|Event Bus Infrastructure\n|TS-1 (Build & Test)\n|Event Bus configuration, CloudEvents schemas, monitoring\n\n|WP-CS-004\n|Contact Migration Tooling\n|TS-1 (Build & Test)\n|Migration tool, validation scripts, reconciliation reporting\n\n|WP-CS-005\n|Mobile App Integration\n|TS-1 (Build & Test)\n|Mobile App API integration, feedback form enhancements, testing\n\n|WP-CS-006\n|Integration Testing\n|TS-1 (Build & Test)\n|Test environments, integration test suites, UAT execution\n\n|WP-CS-007\n|Salesforce Configuration\n|TS-1 (Build & Test)\n|Salesforce field mapping, data isolation, webhook configuration\n\n|WP-CS-008\n|Contact Data Migration\n|TS-2 (Contact Migration)\n|Contact migration execution, validation, reconciliation\n\n|WP-CS-009\n|Production Deployment\n|TS-3 (Cutover)\n|Production deployment, smoke testing, go-live execution\n\n|WP-CS-010\n|Post-Cutover Support\n|TS-4 (Target State)\n|Monitoring, issue resolution, D365 CE retirement\n\n|===\n\n[[wp-cs-001]]\n=== WP-CS-001: ProfileService Development\n\n==== Description\n\nBuild ProfileService bounded context microservice implementing Just-In-Time Contact reconciliation with Salesforce Service Cloud.\n\n==== Deliverables\n\n* ProfileService microservice application\n** REST API implementation (OpenAPI 3.0 specification)\n** `GET /contact-id` endpoint (Salesforce Contact reconciliation)\n** Authentication/authorization with Microsoft Entra External ID\n** Caching layer (15-minute TTL for Contact IDs)\n* Salesforce integration\n** Salesforce REST API client\n** Contact upsert by email (external key matching)\n** Error handling and retry logic\n* Unit tests (>80% code coverage)\n* Integration tests with Salesforce sandbox\n* API documentation\n* Deployment configuration (IaC - Infrastructure as Code)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* Salesforce sandbox environment provisioned\n* Microsoft Entra External ID OAuth configuration\n* Development environment setup (AWS dev account, CI/CD pipeline)\n\n*Dependent Work Packages*:\n\n* None (can start immediately after prerequisites met)\n\n==== Skills Required\n\n* Backend development (.NET Core or Node.js)\n* REST API design and implementation\n* Salesforce REST API integration\n* OAuth 2.0 / JWT authentication\n* Caching strategies (Redis/ElastiCache)\n* Unit/integration testing frameworks\n* Infrastructure as Code (Terraform/CloudFormation)\n\n==== Acceptance Criteria\n\n* All API endpoints return correct HTTP status codes per OpenAPI specification\n* Contact ID retrieval achieves p95 < 300ms (uncached), p95 < 50ms (cached)\n* Salesforce Contact upsert succeeds with 100% accuracy in sandbox testing\n* Unit test coverage > 80%\n* Integration tests pass in sandbox environment\n* API documentation generated from OpenAPI specification\n\n[[wp-cs-002]]\n=== WP-CS-002: EngagementService Development\n\n==== Description\n\nBuild EngagementService bounded context microservice implementing customer feedback submission, Anti-Corruption Layer for Salesforce Case creation, Braze integration, and webhook receiver for Case updates.\n\n==== Deliverables\n\n* EngagementService microservice application\n** REST API implementation (OpenAPI 3.0 specification)\n** `POST /feedback` endpoint (async feedback submission)\n** Authentication/authorization with Microsoft Entra External ID\n** Webhook receiver endpoint for Salesforce Case updates\n* Anti-Corruption Layer (ACL)\n** OTR domain model to Salesforce API translation\n** Category enum mapping (App/Service/Order/Rewards → Salesforce Case fields)\n** Salesforce REST API client for Case creation\n* Async processing infrastructure\n** Event Bus publisher integration\n** Background worker for Case creation\n** Retry logic with exponential backoff (5 attempts)\n** Dead Letter Queue integration\n* Braze integration\n** Braze campaign trigger API client\n** Push notification orchestration for Case updates\n* Domain event publishing\n** `CustomerFeedbackSubmitted` event publisher\n** `SupportCaseCreated` event publisher\n** `SupportCaseUpdated` event translator (Salesforce webhook → domain event)\n** `SupportCaseResolved` event translator (Salesforce webhook → domain event)\n* Unit tests (>80% code coverage)\n* Integration tests (EngagementService ↔ Salesforce, EngagementService ↔ Braze)\n* API documentation\n* Deployment configuration (IaC)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-003 (Event Bus Infrastructure) completed\n* Salesforce sandbox environment provisioned\n* Braze API credentials and campaign templates configured\n* Microsoft Entra External ID OAuth configuration\n\n*Dependent Work Packages*:\n\n* WP-CS-003 must be completed first (Event Bus required for async processing)\n* WP-CS-007 (Salesforce Configuration) must be in progress (field mapping needed)\n\n==== Skills Required\n\n* Backend development (.NET Core or Node.js)\n* REST API design and implementation\n* Salesforce REST API integration\n* Event-driven architecture patterns\n* Async/background processing (queues, workers)\n* Braze API integration\n* Webhook design and security\n* OAuth 2.0 / JWT authentication\n* Domain-Driven Design (DDD) - Anti-Corruption Layer pattern\n* Unit/integration testing frameworks\n* Infrastructure as Code (Terraform/CloudFormation)\n\n==== Acceptance Criteria\n\n* Feedback submission endpoint returns 202 Accepted within p95 < 200ms\n* Async Case creation succeeds with >99.5% success rate (including retries)\n* Anti-Corruption Layer correctly maps all feedback categories to Salesforce Case fields\n* Webhook receiver processes Salesforce Case updates and publishes domain events\n* Braze push notifications sent successfully for Case updates\n* Failed Case creation moves to Dead Letter Queue after 5 retry attempts\n* Unit test coverage > 80%\n* Integration tests pass with Salesforce sandbox and Braze staging environment\n\n[[wp-cs-003]]\n=== WP-CS-003: Event Bus Infrastructure\n\n==== Description\n\nImplement Event Bus infrastructure for domain event publishing using existing AWS infrastructure (SNS+SQS, EventBridge, or Kinesis).\n\n==== Deliverables\n\n* Event Bus infrastructure configuration\n** Topic/stream provisioning (technology choice: SNS+SQS / EventBridge / Kinesis)\n** FIFO queue configuration (ordering by `contactId`)\n** Dead Letter Queue (DLQ) setup\n** Retention policy (4 days / 96 hours)\n** Access control policies (IAM roles, permissions)\n* CloudEvents 1.0 schema definitions\n** JSON Schema specifications for all domain events\n** Schema validation configuration\n** Schema registry (if using EventBridge/Kinesis)\n* Monitoring and alerting\n** CloudWatch dashboards for queue metrics\n** Alarms for DLQ depth, queue age, processing failures\n** Event Bus throughput monitoring\n* Documentation\n** Event Bus architecture diagram\n** Event publishing guidelines\n** Consumer integration guide\n* Infrastructure as Code (IaC)\n** Terraform/CloudFormation templates for all infrastructure\n\n==== Dependencies\n\n*Prerequisites*:\n\n* AWS account access (existing infrastructure)\n* Technology selection decision (SNS+SQS vs EventBridge vs Kinesis)\n* CloudEvents 1.0 schema design approval\n\n*Dependent Work Packages*:\n\n* None (foundational infrastructure, can start early)\n\n==== Skills Required\n\n* AWS messaging services (SNS, SQS, EventBridge, Kinesis)\n* Event-driven architecture patterns\n* CloudEvents specification\n* JSON Schema design\n* Infrastructure as Code (Terraform/CloudFormation)\n* AWS IAM security configuration\n* CloudWatch monitoring and alerting\n\n==== Acceptance Criteria\n\n* Event Bus infrastructure provisioned in all environments (dev, staging, production)\n* FIFO ordering validated for events with same `contactId`\n* Dead Letter Queue triggers alarms when messages arrive\n* Event retention policy enforced (4 days)\n* CloudEvents 1.0 schema validation enabled\n* Monitoring dashboards operational\n* Infrastructure fully codified (IaC)\n\n[[wp-cs-004]]\n=== WP-CS-004: Contact Migration Tooling\n\n==== Description\n\nDevelop Contact migration tool for one-time migration from app-specific database to Salesforce Service Cloud with upsert logic and validation.\n\n==== Deliverables\n\n* Contact migration tool\n** Extract Contacts from app-specific database\n** Transform to Salesforce Contact API format\n** Upsert to Salesforce using email as external key\n** Fallback matching by phone number or Viva Consumer ID\n** Batch processing with rate limiting (respect Salesforce API limits)\n** Idempotent operation (can be re-run safely)\n* Validation scripts\n** Pre-migration validation (data quality checks)\n** Post-migration validation (100% Contact reconciliation)\n** Email/phone/VCI matching accuracy report\n* Reconciliation reporting\n** Contacts created vs updated statistics\n** Failed upserts with error details\n** Matching accuracy metrics\n* Rollback capability\n** Export snapshot of Salesforce Contacts before migration\n** Rollback procedure documentation\n* Documentation\n** Migration tool user guide\n** Troubleshooting guide\n** Runbook for migration execution\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-001 (ProfileService Development) completed (reuses Salesforce integration code)\n* Salesforce sandbox environment for migration testing\n* App-specific database access (read-only sufficient)\n* Salesforce production access granted\n\n*Dependent Work Packages*:\n\n* WP-CS-001 provides Salesforce Contact upsert logic to reuse\n\n==== Skills Required\n\n* Database development (SQL, data extraction)\n* Salesforce REST API integration\n* Batch processing and ETL patterns\n* Data validation and reconciliation\n* Error handling and logging\n* Scripting (Python, PowerShell, or similar)\n\n==== Acceptance Criteria\n\n* Migration tool successfully migrates 100% of Contacts in sandbox with zero data loss\n* Email/phone/VCI matching accuracy > 95% in sandbox testing\n* Failed upserts captured with actionable error messages\n* Reconciliation report matches actual Salesforce Contact counts\n* Migration tool execution time acceptable for production (freezes app database for minimum time)\n* Rollback procedure validated in sandbox\n* Documentation complete and approved\n\n[[wp-cs-005]]\n=== WP-CS-005: Mobile App Integration\n\n==== Description\n\nUpdate Mobile App to integrate with ProfileService and EngagementService APIs, replacing D365 CE integration.\n\n==== Deliverables\n\n* Feedback form UI enhancements\n** Add Category dropdown (App, Service, Order, Rewards, Refund, Delete Account)\n** Add Store Name field (optional)\n** Add Time of Visit field (optional, datetime picker)\n** Add Contact Phone Number field (optional, E.164 validation)\n** Update Message field (1-2000 character limit with counter)\n* API integration (Kotlin Multiplatform shared code)\n** ProfileService client (`GET /contact-id`)\n** EngagementService client (`POST /feedback`)\n** JWT token management (Microsoft Entra External ID)\n** Error handling (network failures, API errors, validation errors)\n** Retry logic for transient failures\n* Platform-specific UI (SwiftUI for iOS, Jetpack Compose for Android)\n** Feedback form screens\n** Success/error confirmation screens\n** Loading states and progress indicators\n* Feature flag integration\n** `enable_salesforce_feedback_submission` flag\n** Fallback to D365 CE if flag disabled (during rollout)\n* Unit tests for shared business logic\n* UI tests for platform-specific screens\n* API integration tests (mocked APIs)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-001 (ProfileService Development) completed and deployed to dev/staging\n* WP-CS-002 (EngagementService Development) completed and deployed to dev/staging\n* ProfileService and EngagementService OpenAPI specifications finalized\n* Feature flag service configured\n\n*Dependent Work Packages*:\n\n* Must complete after WP-CS-001 and WP-CS-002 (requires API endpoints available for integration testing)\n\n==== Skills Required\n\n* Kotlin Multiplatform development\n* SwiftUI (iOS native UI)\n* Jetpack Compose (Android native UI)\n* REST API client development\n* OAuth 2.0 / JWT authentication\n* Form validation and UX design\n* Unit testing (Kotlin, Swift)\n* UI testing frameworks (XCTest, Espresso)\n\n==== Acceptance Criteria\n\n* Feedback form UI matches UX design specifications\n* All form fields validate correctly (client-side validation)\n* API integration successfully calls ProfileService and EngagementService in dev/staging\n* Error handling provides user-friendly error messages\n* Feature flag correctly toggles between Salesforce and D365 CE integration\n* Unit test coverage > 80% for shared business logic\n* UI tests pass for all feedback form workflows (happy path, error states)\n* App builds and deploys successfully to TestFlight (iOS) and Google Play Internal Testing (Android)\n\n[[wp-cs-006]]\n=== WP-CS-006: Integration Testing\n\n==== Description\n\nExecute comprehensive integration testing across all system components in non-production environments.\n\n==== Deliverables\n\n* Test environment setup\n** Salesforce sandbox configured with test data\n** ProfileService deployed to staging\n** EngagementService deployed to staging\n** Event Bus staging infrastructure\n** Braze staging environment configured\n** Mobile App TestFlight/Internal Testing builds\n* Integration test suites\n** ProfileService ↔ Salesforce (Contact upsert scenarios)\n** EngagementService ↔ Salesforce (Case creation scenarios)\n** EngagementService ↔ Braze (push notification scenarios)\n** Mobile App ↔ ProfileService ↔ EngagementService (end-to-end workflows)\n** Event Bus publishing and consumption\n** Webhook receiver (Salesforce → EngagementService)\n* Test scenarios\n** Happy path: Successful feedback submission and Case creation\n** Error scenarios: Salesforce API failures, Braze API failures, network timeouts\n** Retry scenarios: Async Case creation retries, DLQ validation\n** Performance testing: p95 latency validation for ProfileService and EngagementService\n** Load testing: Simulate 3x-10x expected volume\n* UAT execution\n** Business stakeholder UAT sessions\n** UAT test cases covering all feedback categories\n** UAT sign-off documentation\n* Test results documentation\n** Test execution reports\n** Defect tracking and resolution\n** Performance test results\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-001 (ProfileService Development) completed\n* WP-CS-002 (EngagementService Development) completed\n* WP-CS-003 (Event Bus Infrastructure) completed\n* WP-CS-005 (Mobile App Integration) completed\n* WP-CS-007 (Salesforce Configuration) sandbox configuration completed\n\n*Dependent Work Packages*:\n\n* Must complete after WP-CS-001, WP-CS-002, WP-CS-003, WP-CS-005 (requires all components available)\n\n==== Skills Required\n\n* Integration testing strategy and execution\n* Test automation frameworks (Postman, Newman, Selenium)\n* Performance testing tools (JMeter, k6, Gatling)\n* Salesforce sandbox administration\n* Test data management\n* Defect tracking and triage\n* UAT facilitation\n\n==== Acceptance Criteria\n\n* All integration test scenarios pass (happy path, error scenarios, retry scenarios)\n* Performance SLAs validated (ProfileService p95 < 300ms, EngagementService p95 < 200ms)\n* Load testing confirms system handles 3x expected volume without degradation\n* UAT sign-off obtained from business stakeholders\n* Zero critical defects (P1/P2) open before moving to Contact Migration\n* Test results documented and approved\n\n[[wp-cs-007]]\n=== WP-CS-007: Salesforce Configuration\n\n==== Description\n\nConfigure Salesforce Service Cloud for OTR digital customer support integration, including field mapping, data isolation, and webhook setup.\n\n==== Deliverables\n\n* Salesforce Contact configuration\n** Custom fields for OTR-specific data (if needed)\n** Email as external key configuration\n** Record Type for OTR digital customers (data isolation)\n** Validation rules\n* Salesforce Case configuration\n** Custom fields for feedback categories (App, Service, Order, Rewards, Refund, Delete Account)\n** Case Type and Reason picklist mapping\n** Queue assignment rules (OTR digital support queue)\n** Case escalation rules\n** Case routing rules\n* Salesforce webhook configuration\n** Platform Events / Outbound Messages for Case updates\n** Webhook authentication (API key, JWT, or OAuth)\n** Case status change triggers (New → In Progress, Resolved, Closed)\n** Webhook payload format (JSON)\n* Data isolation strategy\n** Record Types for OTR vs other Viva Energy business units\n** Queues for OTR-specific Cases\n** Reporting and dashboards scoped to OTR data\n* Salesforce API access\n** Connected App configuration\n** OAuth 2.0 JWT bearer flow setup\n** API user credentials\n** API rate limit monitoring\n* Documentation\n** Salesforce field mapping specification\n** Webhook configuration guide\n** Data isolation architecture diagram\n** API authentication setup guide\n\n==== Dependencies\n\n*Prerequisites*:\n\n* Viva Energy Salesforce admin team engagement\n* Salesforce governance approval (multi-tenant environment)\n* Technical decision on webhook mechanism (Platform Events vs Outbound Messages)\n* Technical decision on authentication method (OAuth 2.0 JWT bearer flow recommended)\n\n*Dependent Work Packages*:\n\n* None (can start in parallel with development work packages)\n* Required for WP-CS-002 (EngagementService needs field mapping)\n* Required for WP-CS-006 (Integration Testing needs sandbox configuration)\n\n==== Skills Required\n\n* Salesforce administration\n* Salesforce configuration (Record Types, Queues, Validation Rules)\n* Salesforce API integration (REST API, Platform Events, Outbound Messages)\n* Salesforce security and authentication (OAuth, Connected Apps)\n* Multi-tenant data isolation patterns\n\n==== Acceptance Criteria\n\n* Salesforce sandbox configured with all custom fields, Record Types, Queues\n* Field mapping documented and approved by OTR business stakeholders\n* Webhook configuration tested and delivering Case update notifications\n* Data isolation validated (OTR data separate from other Viva Energy business units)\n* API authentication working for ProfileService and EngagementService\n* Salesforce API rate limits monitored and acceptable for expected volume\n* Configuration replicated to Salesforce production environment\n\n[[wp-cs-008]]\n=== WP-CS-008: Contact Data Migration\n\n==== Description\n\nExecute one-time Contact migration from app-specific database to Salesforce Service Cloud production.\n\n==== Deliverables\n\n* Pre-migration activities\n** Final validation of migration tool in sandbox\n** Communication plan (notify users of maintenance window if needed)\n** Freeze app-specific database Contact updates\n** Backup app-specific database\n** Export snapshot of Salesforce Contacts (rollback preparation)\n* Migration execution\n** Execute migration tool against Salesforce production\n** Monitor migration progress\n** Handle failed upserts (manual intervention if needed)\n* Post-migration validation\n** 100% Contact reconciliation (app database vs Salesforce)\n** Email/phone/VCI matching accuracy report\n** Reconciliation report (Contacts created vs updated)\n** Data integrity checks (no duplicate Contacts, no missing Contacts)\n* ProfileService smoke testing\n** Verify Contact ID retrieval works in production\n** Test cache behavior\n** Validate Salesforce Contact upserts from ProfileService\n* Migration report\n** Total Contacts migrated\n** Contacts created vs updated\n** Failed upserts (if any) with resolution\n** Matching accuracy metrics\n** Migration execution time\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-004 (Contact Migration Tooling) completed\n* WP-CS-001 (ProfileService Development) deployed to production (not yet integrated with Mobile App)\n* WP-CS-007 (Salesforce Configuration) production configuration completed\n* Salesforce production access granted\n* Migration approved by business stakeholders\n\n*Dependent Work Packages*:\n\n* Must complete after WP-CS-001, WP-CS-004, WP-CS-007\n* Must complete before WP-CS-009 (Production Deployment)\n\n==== Skills Required\n\n* Data migration execution\n* Salesforce administration\n* Database operations\n* Data validation and reconciliation\n* Incident management (if issues arise)\n\n==== Acceptance Criteria\n\n* 100% of Contacts migrated with zero data loss\n* Email/phone/VCI matching accuracy > 95%\n* ProfileService smoke tests pass in production\n* Reconciliation report approved by business stakeholders\n* App-specific database Contact updates frozen (read-only mode)\n* Rollback procedure ready (but not executed if migration successful)\n\n=== WP-CS-009: Production Deployment\n\n==== Description\n\nDeploy all solution components to production and execute cutover from D365 CE to Salesforce Service Cloud.\n\n==== Deliverables\n\n* Production deployment\n** EngagementService deployed to production\n** Event Bus production infrastructure validated\n** Salesforce webhook configured in production\n** Mobile App released to production (App Store, Google Play)\n* Go-live activities\n** Smoke testing (end-to-end feedback submission)\n** Feature flag enabled: `enable_salesforce_feedback_submission = ON`\n** D365 CE integration disabled in Mobile App\n** Monitor Event Bus queue depth, DLQ, Salesforce API rate limits\n** Monitor Mobile App feedback submission success rate\n* Go/No-Go decision\n** Validate success criteria before final cutover\n** Business stakeholder approval\n** Technical validation (smoke tests pass, monitoring healthy)\n* Cutover communication\n** Notify support agents of new Salesforce integration\n** Provide training materials for support agents\n** Customer communication (if visible change)\n* Rollback plan\n** Documented rollback procedure\n** Feature flag can disable Salesforce integration and re-enable D365 CE\n** Rollback decision criteria (P1/P2 incidents, feedback submission success rate < 99%)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-001 (ProfileService Development) completed\n* WP-CS-002 (EngagementService Development) completed\n* WP-CS-003 (Event Bus Infrastructure) completed\n* WP-CS-005 (Mobile App Integration) completed\n* WP-CS-006 (Integration Testing) completed with UAT sign-off\n* WP-CS-007 (Salesforce Configuration) production configuration completed\n* WP-CS-008 (Contact Data Migration) completed successfully\n* Mobile App release approval (App Store, Google Play)\n\n*Dependent Work Packages*:\n\n* Must complete after all prior work packages (final cutover)\n\n==== Skills Required\n\n* Production deployment and release management\n* Incident management and troubleshooting\n* Monitoring and observability\n* Change management and communication\n* Rollback execution (if needed)\n\n==== Acceptance Criteria\n\n* Mobile App feedback submission success rate > 99.5%\n* End-to-end flow validated (Mobile App → ProfileService → EngagementService → Salesforce Case created)\n* Braze push notifications delivered successfully\n* Event Bus queue depth normal, DLQ empty\n* No critical incidents (P1/P2) in first 24 hours\n* D365 CE integration disabled\n* Support agents successfully using Salesforce for OTR digital customer Cases\n\n=== WP-CS-010: Post-Cutover Support\n\n==== Description\n\nMonitor production stability, resolve issues, validate success criteria, and execute D365 CE retirement.\n\n==== Deliverables\n\n* Monitoring and support\n** 24/7 on-call support for first week post-cutover\n** Daily monitoring reports (feedback submission success rate, Case creation success rate)\n** Incident response and resolution\n** Performance tuning (if needed)\n* Success criteria validation\n** Validate feedback submission success rate > 99.5%\n** Monitor customer satisfaction score (target: +15% improvement within 6 months)\n** Monitor average case resolution time (target: -20% improvement within 6 months)\n** Support agent feedback survey\n* D365 CE retirement\n** D365 CE set to read-only mode (historical Case lookups only)\n** Archive D365 CE data for compliance/auditing\n** Decommission D365 CE infrastructure (after 90-day stabilization period)\n** Remove D365 CE integration code from Mobile App\n* Documentation updates\n** Production runbook\n** Troubleshooting guide (based on incidents resolved)\n** Operational procedures for support team\n** Lessons learned document\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-009 (Production Deployment) completed\n* Cutover successful with no critical incidents\n\n*Dependent Work Packages*:\n\n* Final work package in sequence\n\n==== Skills Required\n\n* Production support and incident management\n* Performance monitoring and tuning\n* Data archival and compliance\n* Infrastructure decommissioning\n* Documentation\n\n==== Acceptance Criteria\n\n* Zero critical incidents (P1/P2) in first 30 days post-cutover\n* Feedback submission success rate sustained > 99.5%\n* Customer satisfaction improvement validated (baseline established, ongoing measurement)\n* Support agents reporting positive experience with Salesforce unified view\n* D365 CE successfully decommissioned\n* All production documentation complete and approved\n* Lessons learned document published\n\n=== Work Package Sequencing\n\n==== Parallel Track 1: Infrastructure & Configuration\n\nCan start immediately and run in parallel:\n\n* WP-CS-003 (Event Bus Infrastructure)\n* WP-CS-007 (Salesforce Configuration)\n\n==== Parallel Track 2: Development\n\nCan start after Track 1 infrastructure decisions made:\n\n* WP-CS-001 (ProfileService Development) - Independent\n* WP-CS-002 (EngagementService Development) - Requires WP-CS-003 completed\n* WP-CS-004 (Contact Migration Tooling) - Requires WP-CS-001 completed (reuses code)\n\n==== Sequential Track 3: Integration & Testing\n\nMust complete after development:\n\n* WP-CS-005 (Mobile App Integration) - Requires WP-CS-001, WP-CS-002\n* WP-CS-006 (Integration Testing) - Requires WP-CS-001, WP-CS-002, WP-CS-003, WP-CS-005, WP-CS-007\n\n==== Sequential Track 4: Migration & Cutover\n\nMust complete sequentially:\n\n* WP-CS-008 (Contact Data Migration) - Requires WP-CS-001, WP-CS-004, WP-CS-006 UAT sign-off\n* WP-CS-009 (Production Deployment) - Requires all prior work packages completed\n* WP-CS-010 (Post-Cutover Support) - Requires WP-CS-009\n\n==== Critical Path\n\nThe critical path for this project is:\n\n. WP-CS-003 (Event Bus Infrastructure)\n. WP-CS-002 (EngagementService Development) - blocks on WP-CS-003\n. WP-CS-005 (Mobile App Integration) - blocks on WP-CS-001, WP-CS-002\n. WP-CS-006 (Integration Testing) - blocks on WP-CS-001 through WP-CS-005, WP-CS-007\n. WP-CS-008 (Contact Data Migration) - blocks on WP-CS-006 UAT sign-off\n. WP-CS-009 (Production Deployment) - blocks on WP-CS-008\n. WP-CS-010 (Post-Cutover Support) - final deliverable\n\nAny delays in critical path work packages will delay the overall cutover date.\n\n<<<\n== Transition Architecture\n\nThis section defines the evolution from baseline (D365 CE) to target state (Salesforce Service Cloud + ProfileService + EngagementService).\n\n=== Transition Approach\n\n*Big Bang Cutover*: Per ADR-CS-006, this transition uses a single cutover approach rather than phased rollout. All users switch from D365 CE to Salesforce simultaneously after Contact migration completion.\n\n=== Transition States\n\n==== TS-0: Baseline State (Current)\n\n===== Characteristics\n\n* D365 Customer Engagement handles all digital customer feedback\n* App-specific database stores customer Contact data\n* No ProfileService or EngagementService\n* No event-driven architecture\n* Synchronous feedback submission\n\n===== Components Active\n\n- D365 Customer Engagement\n- App-specific customer database\n- Mobile App (current version with D365 CE integration)\n\n==== TS-1: Build & Test\n\n===== Activities\n\n* Build ProfileService microservice (JIT Contact reconciliation API)\n* Build EngagementService microservice (feedback submission API, ACL for Salesforce Case creation, Braze integration, webhook receiver)\n* Implement Event Bus infrastructure (SNS+SQS/EventBridge/Kinesis)\n* Develop Contact migration tool (app database → Salesforce upsert by email/phone/VCI)\n* Update Mobile App API integration (ProfileService + EngagementService endpoints - feedback form UI already complete)\n* Integration testing (ProfileService ↔ Salesforce, EngagementService ↔ Salesforce, EngagementService ↔ Braze)\n* UAT with test Salesforce sandbox environment\n\n===== Components Active\n\n- D365 Customer Engagement (still active, unchanged)\n- App-specific customer database (still active)\n- ProfileService (non-production, testing only)\n- EngagementService (non-production, testing only)\n- Event Bus (non-production)\n- Salesforce Sandbox (testing)\n\n===== Exit Criteria\n\n- All integration tests pass\n- UAT sign-off from business stakeholders\n- Contact migration tool validated in sandbox\n- Mobile App updates tested with non-production APIs\n\n==== TS-2: Contact Migration\n\n===== Activities\n* Execute Contact migration (app database → Salesforce production)\n* Validation: 100% data integrity check (email/phone/VCI matching)\n* Reconciliation report: New Contacts created vs existing Contacts updated\n* Freeze app database Contact updates during migration window\n* ProfileService smoke testing (verify Contact lookups work in Salesforce production)\n\n===== Components Active\n- D365 Customer Engagement (still active, users unaffected)\n- Salesforce Production (Contacts migrated, no Cases yet)\n- ProfileService (production deployed, not integrated with Mobile App yet)\n- App-specific customer database (frozen, read-only)\n\n===== Exit Criteria\n- 100% of Contacts migrated with zero data loss\n- Email/phone/VCI matching accuracy > 95%\n- ProfileService smoke tests pass (JIT lookups return correct Contact IDs)\n- Reconciliation report approved\n\n==== TS-3: Cutover (Go-Live)\n\n===== Go-Live Activities\n\n* Deploy EngagementService to production\n* Deploy Mobile App updates (ProfileService + EngagementService API integration)\n* Configure Salesforce webhook (Case update notifications → EngagementService)\n* Smoke testing: End-to-end feedback submission (Mobile App → EngagementService → Salesforce → Braze notification)\n* Monitor Event Bus queue depth, dead letter queue, Salesforce API rate limits\n* **Go/No-Go decision**: Validate success criteria before final cutover\n* Enable feature flag: `enable_salesforce_feedback_submission = ON`\n* Disable D365 CE integration in Mobile App\n\n===== Components Active\n\n- ProfileService (production, integrated with Mobile App)\n- EngagementService (production, integrated with Mobile App)\n- Event Bus (production, processing async Case creation)\n- Salesforce Production (receiving Cases from digital customers)\n- Braze (sending push notifications)\n- Mobile App (new version with Salesforce integration)\n- D365 Customer Engagement (disabled, read-only for historical lookups)\n\n===== Exit Criteria\n\n- Mobile App feedback submission success rate > 99.5%\n- End-to-end flow validated (Mobile App → Salesforce Case created)\n- Braze push notifications delivered successfully\n- Event Bus queue depth normal, DLQ empty\n- No critical incidents (P1/P2) in first 24 hours\n\n==== TS-4: Target State (Stable Production)\n\n===== Characteristics\n\n* ProfileService and EngagementService fully operational\n* All digital customer feedback routed to Salesforce\n* Event-driven architecture established\n* D365 CE decommissioned\n* First DDD bounded contexts implemented successfully\n\n===== Monitoring Period\n\n* Validate success criteria: feedback submission rate > 99.5%, no data loss\n* Monitor customer satisfaction score (target: +15% improvement)\n* Monitor average case resolution time (target: -20% improvement)\n* Support agents using unified Salesforce view across all channels\n\n===== D365 CE Retirement\n\n* D365 CE read-only access for historical Case lookups (if needed)\n* Decommission D365 CE infrastructure after 90 days\n* Archive D365 CE data for compliance/auditing\n\n===== Components Active\n\n- ProfileService (production)\n- EngagementService (production)\n- Event Bus (production)\n- Salesforce Production (system of record)\n- Braze (push notifications)\n- Mobile App (Salesforce integration)\n- App-specific database (deprecated, Contact data no longer updated)\n\n===== Success Criteria Achieved\n\n- All digital customer feedback routed to Salesforce\n- Support agents have unified customer view\n- D365 CE decommissioned\n- Customer satisfaction improved by 15%\n- Average case resolution time decreased by 20%\n- Zero data loss during transition\n\n=== Transition Dependencies\n\n[width=\"100%\",cols=\"40%,60%\",options=\"header\",]\n|===\n|Dependency |Owner/Status\n\n|*Salesforce production access*\n|Viva Energy Salesforce admin team - TBD\n\n|*Salesforce Case field mapping*\n|Viva Energy Salesforce admin team - TBD (map OTR feedback categories to Salesforce fields)\n\n|*Salesforce data isolation strategy*\n|Viva Energy Salesforce admin team - TBD (Record Types, queues, custom fields)\n\n|*Salesforce webhook configuration*\n|Viva Energy Salesforce admin team - TBD (Outbound Messages vs Platform Events)\n\n|*Event Bus infrastructure*\n|OTR Platform team - Existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis)\n\n|*Braze integration*\n|OTR Marketing team - Existing Braze account, EngagementService creates new campaigns\n\n|*Mobile App release window*\n|OTR Mobile team - Coordinate cutover timing with app release schedule\n\n|*App database access*\n|OTR Platform team - Read access for Contact migration\n\n|===\n\n=== Transition Validation Criteria\n\n==== Contact Migration Validation\n\n* 100% of app database Contacts migrated to Salesforce (zero data loss)\n* Email/phone/VCI matching accuracy > 95% (minimize duplicate Contacts)\n* ProfileService JIT lookups return correct Salesforce Contact IDs (smoke test sample)\n* Reconciliation report shows: X new Contacts created, Y existing Contacts updated\n\n==== Cutover Validation\n\n* Mobile App feedback submission success rate > 99.5% (including async Case creation)\n* End-to-end flow validated: Mobile App → ProfileService → EngagementService → Salesforce Case created\n* Braze push notifications delivered for Case creation and Case resolution\n* Event Bus queue depth within normal range (no backlog)\n* Dead letter queue empty (no failed Case creations)\n* Salesforce API rate limits not exceeded\n\n==== Production Monitoring (30 days)\n\n* Customer satisfaction score improves by 15% (compared to D365 CE baseline)\n* Average case resolution time decreases by 20% (Salesforce vs D365 CE)\n* Support agents confirm unified customer view across all channels\n* Zero critical incidents (P1 outages, data loss)\n\n=== Rollback Plan\n\n==== Rollback Triggers\n\n* Feedback submission success rate < 95% (below acceptable threshold)\n* Data loss or corruption detected in Salesforce\n* Salesforce API rate limits exceeded (Cases not created within SLA)\n* Critical bug blocking customer feedback submission\n\n==== Rollback Procedure\n\n1. **Revert Mobile App** to previous version (remove ProfileService/EngagementService integration, restore D365 CE integration)\n2. **Stop EngagementService** Case creation (prevent duplicate Cases in Salesforce)\n3. **Re-enable D365 CE** for customer feedback submission\n4. **Investigate root cause** (EngagementService logs, Salesforce API errors, Event Bus queue issues)\n5. **Fix and re-test** in sandbox environment\n6. **Retry cutover** when issues resolved\n\n==== Rollback Limitations\n\n* Cases created in Salesforce during cutover period remain in Salesforce (no reverse migration)\n* Contacts migrated to Salesforce remain (no rollback to app database)\n* Rollback only affects Mobile App integration (not data migration)\n\n=== Architectural Scope Boundaries\n\n==== Capabilities Included\n\n===== Business Capabilities\n\n* **Customer Feedback Submission**: Mobile App users can submit structured feedback (Category, Store Name, Time of Visit, Phone, Free Text Message) via EngagementService\n* **Customer Contact Management**: Just-In-Time (JIT) Contact reconciliation with Salesforce via ProfileService, ensuring every Mobile App user has a Salesforce Contact record\n* **Case Management Integration**: EngagementService creates Salesforce Cases asynchronously for customer feedback, support agents manage Cases in Salesforce Service Cloud\n* **Customer Notifications**: Push notifications via Braze when Cases are created, updated, or resolved (bidirectional integration: Mobile App → Salesforce → Mobile App)\n* **Unified Customer View**: Support agents see OTR digital customer feedback alongside other Viva Energy channels (fuel wholesale, Shell Card, retail) in single Salesforce instance\n* **Contact Data Migration**: One-time migration of app-specific customer database Contacts to Salesforce with upsert logic (email/phone/VCI matching)\n\n===== Technical Capabilities\n\n* **ProfileService Bounded Context**: First DDD bounded context implementation - JIT Contact reconciliation, Salesforce API facade, foundation for Flybuys integration\n* **EngagementService Bounded Context**: First DDD bounded context implementation - Customer feedback submission BFF, Anti-Corruption Layer for Salesforce, Braze integration orchestration\n* **Event-Driven Architecture**: Domain event publishing via Event Bus (SNS+SQS/EventBridge/Kinesis) for `SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted` events\n* **Async Processing Pattern**: Non-blocking Case creation with retry logic, exponential backoff, dead letter queue for operational resilience\n* **Anti-Corruption Layer Pattern**: EngagementService protects digital channels from Salesforce API changes, translates between OTR domain language and Salesforce\n* **Conformist Pattern**: ProfileService and EngagementService conform to existing Salesforce configuration (shared Viva Energy instance, multi-tenant governance)\n* **Salesforce Integration**: REST API integration for Contact CRUD and Case creation, webhook receiver for Case update notifications\n* **Braze Integration**: Push notification campaign triggers for Case lifecycle events (created, updated, resolved)\n* **Observability & Monitoring**: Dashboards, metrics, alerting for feedback submission rate, queue depth, API errors, Case creation latency\n* **Feature Flag Management**: Kill switches for emergency rollback (enable_salesforce_feedback_submission, enable_async_case_creation, etc.)\n\n==== Capabilities Excluded\n\n===== Business Capabilities Explicitly Out of Scope\n\n* **Historical Case Migration**: D365 CE Cases not migrated to Salesforce (ADR-CS-005 - fresh start, no Case migration)\n* **Multi-Channel Feedback Submission**: Web app, POS, call centre, email feedback channels not included (Mobile App only in this phase)\n* **Case Resolution by Digital Channels**: Support agents resolve Cases in Salesforce, not via Mobile App self-service\n* **Knowledge Base Integration**: Salesforce Knowledge Base articles not surfaced in Mobile App (future enhancement)\n* **Live Chat/Messaging**: Real-time chat support not included (Salesforce omnichannel capabilities not activated)\n* **Sentiment Analysis**: Automated feedback sentiment analysis not included (future enhancement with AI/ML)\n* **Customer Satisfaction Surveys**: Post-resolution CSAT surveys not included (separate initiative)\n* **Case Attachments**: Mobile App feedback submission does not support file uploads (photos, receipts) - text only\n* **Agent Desktop Integration**: Custom Salesforce UI for support agents not included (use standard Salesforce Service Console)\n* **Social Media Feedback**: Facebook, Twitter, Instagram feedback channels not integrated\n\n===== Technical Capabilities Explicitly Out of Scope\n\n* **Event Sourcing**: Domain events are ephemeral (not persisted for event sourcing/replay) - Event Bus only, no Event Store\n* **CQRS (Command Query Responsibility Segregation)**: ProfileService and EngagementService use same data model for reads/writes (no separate read models)\n* **Local Aggregate Persistence**: ProfileService and EngagementService are stateless (Salesforce is System of Record, no local database for Contact/Case)\n* **Saga Orchestration**: No distributed transactions or saga patterns required (single-step Case creation, not multi-step workflow)\n* **API Gateway Advanced Features**: Rate limiting, API versioning, API key management deferred to detailed design (basic routing only)\n* **GraphQL API**: ProfileService and EngagementService expose REST APIs only (GraphQL not required)\n* **Real-Time Sync**: Salesforce Contact updates by support agents not synced back to ProfileService (eventual consistency acceptable via JIT reconciliation)\n* **Multi-Region Deployment**: Single AWS region deployment (no multi-region failover/disaster recovery in this phase)\n* **Blue-Green Deployment**: Big bang cutover (ADR-CS-006), not blue-green or canary deployment strategy\n* **A/B Testing Framework**: Feature flags for rollback only, not for A/B testing or experimentation\n* **Custom Authentication**: Microsoft Entra External ID used for Mobile App authentication (no custom authentication logic in ProfileService/EngagementService)\n* **Data Residency Compliance**: Salesforce data residency governed by Viva Energy Salesforce configuration (no OTR-specific data residency requirements)\n\n===== Future Bounded Contexts Not in Scope\n\n* **LoyaltyService**: Flybuys integration, reward preferences, transaction adjudication (separate initiative)\n* **LocationService**: Store finder, proximity features, geofencing (separate initiative)\n* **PaymentService**: Payment processing, subscription billing (separate initiative)\n* **RecommendationService**: Personalized recommendations, next-best offers (separate initiative)\n\n===== Integration Patterns Not in Scope\n\n* **Shared Kernel**: No shared domain model between ProfileService and EngagementService (separate bounded contexts with clear boundaries)\n* **Partnership**: No joint development or coordination with external teams (Conformist pattern - we conform to Salesforce)\n* **Customer-Supplier (we're upstream)**: No downstream systems depend on ProfileService/EngagementService APIs yet (future bounded contexts will consume domain events)\n\n==== Architectural Dependencies on Future Initiatives\n\n*This Architecture Enables Future Initiatives*:\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Future Initiative |Architectural Enablement\n\n|*Flybuys Integration*\n|**ProfileService Contact Reconciliation Reused**: ProfileService establishes pattern for JIT Contact reconciliation with Salesforce, which will be extended for Flybuys partner linking (link:../architecture_definitions/flybuys_integration.adoc[see Flybuys Integration architecture]) +\n**Event Bus Infrastructure**: Domain event publishing pattern (`CustomerEnrolledInLoyalty`, `PartnerLinked`, etc.) reuses Event Bus established for EngagementService\n\n|*LoyaltyService Bounded Context*\n|**Event Bus Subscription**: LoyaltyService will consume `CustomerProfileCreated` events published by ProfileService (future enhancement) +\n**Salesforce Contact Integration**: LoyaltyService may query Salesforce Contacts for customer reward preferences (via ProfileService facade or direct Salesforce API)\n\n|*Web App Feedback Submission*\n|**EngagementService API Reuse**: Web app will call same EngagementService REST API for feedback submission (multi-channel support) +\n**Conformist Pattern**: Web app conforms to EngagementService API contract (no translation required)\n\n|*Multi-Channel Customer Support*\n|**EngagementService Extension**: Add support for email, call centre, POS feedback channels (extend EngagementService to handle multiple origins) +\n**Salesforce Case Origin Field**: Cases already tagged with Origin=Mobile App, extend to Origin=Web, POS, Call Centre, Email\n\n|*Knowledge Base Integration*\n|**EngagementService API Extension**: Add endpoint to query Salesforce Knowledge Base articles, surface in Mobile App for self-service support +\n**Anti-Corruption Layer**: EngagementService translates Salesforce Knowledge API to OTR domain language\n\n|*Customer Satisfaction Surveys*\n|**Event-Driven Trigger**: Subscribe to `SupportCaseResolved` events published by EngagementService, trigger CSAT survey via Braze +\n**Braze Integration Pattern**: Reuse EngagementService → Braze integration pattern for survey campaigns\n\n|*Sentiment Analysis*\n|**Event Subscription**: Subscribe to `CustomerFeedbackSubmitted` events, analyse feedback sentiment (AI/ML service) +\n**EngagementService Extension**: Enrich Case with sentiment score before creating in Salesforce\n\n|*RecommendationService Bounded Context*\n|**Event Subscription**: RecommendationService subscribes to `SupportCaseCreated` events to understand customer pain points and personalize recommendations +\n**Domain Event Pattern**: Reuse Event Bus publishing pattern established by EngagementService\n\n|===\n\n*This Architecture Depends on Future Initiatives*:\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Future Initiative |Dependency Description\n\n|*Salesforce Data Isolation Strategy*\n|**BLOCKER**: Viva Energy Salesforce admin team must define data isolation strategy (Record Types, custom fields, queues) before production deployment +\n**Impact**: Multi-tenant data visibility and security governance\n\n|*Salesforce Case Field Mapping*\n|**BLOCKER**: Viva Energy Salesforce admin team must define field mapping for OTR feedback categories (App, Service, Order, Rewards, Refund, Delete Account) +\n**Impact**: Case creation logic in EngagementService depends on finalized Salesforce schema\n\n|*Salesforce Webhook Mechanism*\n|**BLOCKER**: Viva Energy Salesforce admin team must configure webhook mechanism (Outbound Messages vs Platform Events vs Process Builder) for Case update notifications +\n**Impact**: EngagementService webhook receiver implementation depends on chosen mechanism\n\n|*Event Bus Technology Selection*\n|**DECISION REQUIRED**: Choose Event Bus implementation (SNS+SQS vs EventBridge vs Kinesis) for domain event publishing +\n**Impact**: Infrastructure provisioning, event schema design, consumer implementation\n\n|*Microservice Hosting Platform*\n|**DECISION REQUIRED**: Choose hosting platform for ProfileService and EngagementService (AWS Lambda vs ECS vs EKS) +\n**Impact**: Deployment architecture, auto-scaling strategy, operational overhead\n\n|*Observability Platform*\n|**DECISION REQUIRED**: Choose observability platform (AWS CloudWatch vs Datadog vs New Relic) for monitoring and alerting +\n**Impact**: Dashboard configuration, metric collection, alerting setup\n\n|===\n\n*Future Work After This Initiative*:\n\n* **Event Schema Registry**: Implement event schema versioning and registry for domain events (currently ad-hoc schemas)\n* **API Versioning Strategy**: Define API versioning approach for ProfileService and EngagementService (currently v1 only)\n* **Multi-Region Deployment**: Extend to multi-region for disaster recovery and global availability\n* **Event Store**: Persist domain events for event sourcing and audit trail (currently ephemeral Event Bus only)\n* **CQRS Pattern**: Separate read models for high-volume queries (currently same model for reads/writes)\n* **GraphQL API**: Expose GraphQL API for flexible client queries (currently REST only)\n* **Real-Time Sync**: Bi-directional sync between Salesforce and ProfileService for Contact updates (currently JIT reconciliation only)\n\n=== Technical Risks and Mitigation\n\n[width=\"100%\",cols=\"5%,20%,25%,25%,25%\",options=\"header\",]\n|===\n|ID |Risk |Impact |Likelihood |Mitigation\n\n|RISK-CS-001\n|*Salesforce API rate limits exceeded*: High feedback volume exceeds Salesforce API limits, Cases not created\n|HIGH (customers don't receive Case confirmation, support tickets lost)\n|MEDIUM (volume unknown, rate limits TBD)\n|• Gather expected feedback volume data before cutover +\n• Implement Event Bus queue throttling/rate limiting +\n• Monitor queue depth and API usage +\n• Scale background workers based on queue depth +\n• Alert ops team when approaching rate limits\n\n|RISK-CS-002\n|*Salesforce downtime*: Salesforce Service Cloud outage prevents Case creation\n|MEDIUM (Cases delayed but queued, customers wait for confirmation)\n|LOW (Salesforce SLA 99.9% uptime)\n|• Async Case creation with retry logic +\n• Event Bus queues buffer work during outage +\n• Customers get immediate \"Feedback submitted\" (not blocked) +\n• Monitor Salesforce status page, alert ops team +\n• Automatic retry when Salesforce recovers\n\n|RISK-CS-003\n|*Contact migration data quality issues*: App database Contact data incomplete or invalid\n|HIGH (migration fails validation, cutover delayed)\n|MEDIUM (legacy data quality unknown)\n|• Pre-migration data quality assessment +\n• Flexible upsert logic (match by email/phone/VCI) +\n• Validation report identifies data issues before production migration +\n• Manual cleanup for invalid records +\n• Dry-run migration in sandbox environment\n\n|RISK-CS-004\n|*Duplicate Contacts created*: Email matching fails, ProfileService creates duplicate Contacts\n|MEDIUM (support agents see multiple profiles for same customer)\n|MEDIUM (email changes, data quality issues)\n|• Salesforce duplicate detection rules (if available) +\n• ProfileService logs Contact creation for audit trail +\n• Manual duplicate cleanup process (support team) +\n• Future enhancement: VCI as Salesforce External ID for stable matching\n\n|RISK-CS-005\n|*Dead letter queue accumulation*: Failed Case creations not processed, queue grows\n|HIGH (customers don't receive Case confirmation, feedback lost)\n|LOW (retry logic handles most failures)\n|• Dead letter queue monitoring and alerting +\n• Ops team dashboard showing DLQ depth +\n• Manual intervention process (investigate and reprocess) +\n• Automated alerts when DLQ depth exceeds threshold +\n• Root cause analysis for recurring failures\n\n|RISK-CS-006\n|*Salesforce webhook failures*: Salesforce can't deliver Case update notifications to EngagementService\n|MEDIUM (customers don't get push notifications for Case resolution)\n|LOW (webhook mechanism reliable)\n|• Webhook retry logic and exponential backoff +\n• EngagementService logs webhook deliveries +\n• Monitor webhook delivery success rate +\n• Fallback: Poll Salesforce API for Case updates (if webhook fails persistently) +\n• Alert ops team when webhook delivery rate drops\n\n|RISK-CS-007\n|*Multi-tenant data isolation breach*: OTR digital Cases visible to other Viva Energy support teams\n|HIGH (privacy violation, compliance risk)\n|LOW (Salesforce governance controls)\n|• Work with Viva Energy Salesforce admin team on data isolation strategy +\n• Test data visibility in Salesforce sandbox (UAT with different user roles) +\n• Validate Record Types, queues, field-level security before production +\n• Audit Salesforce user permissions and sharing rules\n\n|RISK-CS-008\n|*Mobile App release coordination*: App release delayed, cutover window missed\n|MEDIUM (cutover delayed, D365 CE retirement delayed)\n|MEDIUM (release schedule conflicts)\n|• Coordinate cutover timing with Mobile team early +\n• Buffer time in migration plan (2-week contingency) +\n• Decouple backend deployment from Mobile App release (backend deployed first, app follows) +\n• Feature flag for feedback submission (enable when ready)\n\n|RISK-CS-009\n|*Event Bus infrastructure issues*: SNS/SQS/EventBridge downtime or misconfiguration\n|HIGH (Case creation blocked, domain events not published)\n|LOW (AWS SLA 99.99% uptime)\n|• Leverage existing AWS infrastructure (proven, reliable) +\n• Infrastructure as Code (IaC) for Event Bus configuration +\n• Integration testing in non-production environment +\n• Monitor Event Bus metrics (queue depth, throughput, errors) +\n• Alert ops team on Event Bus failures\n\n|RISK-CS-010\n|*Team DDD knowledge gap*: Team unfamiliar with DDD patterns, bounded contexts, event-driven architecture\n|MEDIUM (implementation delays, architectural inconsistencies)\n|HIGH (first DDD implementation)\n|• DDD training for development team (workshops, documentation) +\n• Architecture review sessions (validate bounded context design) +\n• Pair programming with experienced DDD practitioners +\n• Incremental implementation (start small, iterate) +\n• Document architectural patterns in CLAUDE.md\n\n|===\n\n== Assumptions and Constraints\n\n=== Assumptions\n\n[width=\"100%\",cols=\"8%,92%\",options=\"header\",]\n|===\n|ID |Assumption\n\n|ASM-CS-001\n|Viva Energy Salesforce admin team will provide Salesforce production access, sandbox environment, and support for Case field mapping and data isolation configuration\n\n|ASM-CS-002\n|App database Contact data is sufficiently complete for migration (email/phone/VCI available for matching)\n\n|ASM-CS-003\n|Expected customer feedback volume (100-150 submissions/day from 20k DAU) is well within Salesforce API rate limits, with capacity planning for 3x-10x growth\n\n|ASM-CS-004\n|Existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis) is sufficient for Event Bus implementation (no additional infrastructure provisioning required)\n\n|ASM-CS-005\n|Braze integration already exists and can be extended for Case-related push notifications (no new Braze account or major configuration changes)\n\n|ASM-CS-006\n|Mobile App users have email addresses associated with their accounts (required for ProfileService Contact reconciliation)\n\n|ASM-CS-007\n|D365 Customer Engagement historical Cases have limited business value and do not require migration to Salesforce\n\n|ASM-CS-008\n|Support agents are trained on Salesforce Service Cloud and require minimal additional training for OTR digital customer Cases\n\n|ASM-CS-009\n|Salesforce Service Cloud shared instance has capacity for OTR digital customer Contacts and Cases (no additional licensing or storage costs)\n\n|ASM-CS-010\n|Mobile App release schedule can accommodate cutover timing (Week 10 in migration plan)\n\n|===\n\n=== Constraints\n\n[width=\"100%\",cols=\"8%,92%\",options=\"header\",]\n|===\n|ID |Constraint\n\n|CON-CS-001\n|Must use shared Viva Energy Salesforce Service Cloud instance (cannot deploy separate OTR-specific instance)\n\n|CON-CS-002\n|Must conform to existing Salesforce configuration and governance (Record Types, custom fields, queues, data isolation strategy defined by Viva Energy admin team)\n\n|CON-CS-003\n|Contact migration must complete before Mobile App cutover (no parallel run of D365 CE and Salesforce)\n\n|CON-CS-004\n|Big bang cutover only (no phased rollout with feature flags or pilot users)\n\n|CON-CS-005\n|Salesforce API rate limits and authentication method constrained by Viva Energy Salesforce configuration (TBD)\n\n|CON-CS-006\n|Event Bus implementation must use existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis - cannot introduce new infrastructure components)\n\n|CON-CS-007\n|Mobile App feedback form must include specific fields: Category, Store Name, Time of Visit, Contact Phone Number, Free Text Message (no attachments)\n\n|CON-CS-008\n|D365 Customer Engagement must be decommissioned within 90 days post-cutover (ADR-CS-006)\n\n|CON-CS-009\n|ProfileService and EngagementService must be stateless (no local aggregate persistence, Salesforce is System of Record)\n\n|CON-CS-010\n|First DDD bounded context implementation (team learning curve, architectural patterns must be documented for future bounded contexts)\n\n|===\n\n== Non-Functional Requirements\n\n=== Performance Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-PERF-001\n|Mobile App feedback submission API response time (ProfileService + EngagementService)\n|p95 < 1 second, p99 < 2 seconds\n\n|NFR-PERF-002\n|ProfileService Contact reconciliation API response time (JIT lookup)\n|p95 < 500ms, p99 < 1 second\n\n|NFR-PERF-003\n|EngagementService async Case creation latency (end-to-end: feedback submitted → Case created in Salesforce)\n|p95 < 5 minutes, p99 < 10 minutes\n\n|NFR-PERF-004\n|Salesforce API call latency (Contact query, Contact create, Case create)\n|p95 < 2 seconds, p99 < 5 seconds\n\n|NFR-PERF-005\n|Event Bus message processing throughput\n|> 100 messages/second (support peak feedback volume)\n\n|NFR-PERF-006\n|Braze push notification delivery latency (Case created → notification delivered)\n|p95 < 30 seconds, p99 < 60 seconds\n\n|===\n\n=== Availability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-AVAIL-001\n|ProfileService availability\n|99.9% uptime (8.76 hours downtime/year)\n\n|NFR-AVAIL-002\n|EngagementService availability\n|99.9% uptime (8.76 hours downtime/year)\n\n|NFR-AVAIL-003\n|Feedback submission success rate (including async Case creation)\n|> 99.5% (includes retry logic for transient failures)\n\n|NFR-AVAIL-004\n|Graceful degradation: Salesforce downtime handling\n|Feedback submission still succeeds, Cases queued for async creation when Salesforce recovers\n\n|NFR-AVAIL-005\n|Graceful degradation: Braze downtime handling\n|Case creation proceeds, push notifications disabled temporarily (feature flag)\n\n|NFR-AVAIL-006\n|Planned maintenance window\n|< 4 hours/month, scheduled during low-traffic periods (2-6am ACST)\n\n|===\n\n=== Scalability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-SCALE-001\n|Concurrent Mobile App users (peak)\n|Support 20,000 DAU (Daily Active Users), ~150 concurrent users submitting feedback during peak hours\n\n|NFR-SCALE-002\n|Feedback submissions per day\n|Expected: 100-150 submissions/day based on 20k DAU (~0.5-0.75% submission rate) +\nCapacity: Support 500 submissions/day (3x expected volume for growth), 2,000 submissions/day (peak/incident scenarios)\n\n|NFR-SCALE-003\n|Auto-scaling: ProfileService and EngagementService\n|Auto-scale based on CPU/memory/request rate, scale up within 2 minutes\n\n|NFR-SCALE-004\n|Event Bus queue capacity\n|Support 100,000 queued messages (buffer for Salesforce downtime)\n\n|NFR-SCALE-005\n|Salesforce API rate limit compliance\n|Stay within 80% of Salesforce API rate limits (buffer for spikes)\n\n|NFR-SCALE-006\n|Future growth capacity\n|Architecture supports 10x growth (1,000-1,500 submissions/day based on 200k DAU) without major redesign\n\n|===\n\n=== Security Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-SEC-001\n|Mobile App authentication\n|Microsoft Entra External ID OAuth 2.0 with JWT tokens (existing CIAM)\n\n|NFR-SEC-002\n|API authorisation: ProfileService and EngagementService\n|JWT token validation, authenticated users only, user context propagation\n\n|NFR-SEC-003\n|Salesforce API authentication\n|OAuth 2.0 with Connected App and JWT bearer flow (service account)\n\n|NFR-SEC-004\n|Data encryption in transit\n|TLS 1.2+ for all API calls (Mobile App ↔ ProfileService/EngagementService ↔ Salesforce ↔ Braze)\n\n|NFR-SEC-005\n|Data encryption at rest\n|Salesforce encryption at rest (managed by Salesforce), Event Bus message encryption (AWS KMS)\n\n|NFR-SEC-006\n|Secret management\n|AWS Secrets Manager for Salesforce credentials, Braze API keys, OAuth tokens (no hardcoded secrets)\n\n|NFR-SEC-007\n|PII data handling\n|Contact data (email, phone, name) treated as PII, GDPR-compliant retention policies (Salesforce governance)\n\n|NFR-SEC-008\n|API rate limiting and throttling\n|API Gateway rate limiting (100 requests/second per user), prevent abuse and DoS\n\n|NFR-SEC-009\n|Logging and auditing\n|Log all API calls, Salesforce Contact/Case creates/updates, Event Bus publishes (no PII in logs)\n\n|NFR-SEC-010\n|Salesforce data isolation\n|Multi-tenant data isolation via Salesforce Record Types, queues, sharing rules (defined by Viva Energy admin team)\n\n|===\n\n=== Reliability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-REL-001\n|Retry logic: EngagementService → Salesforce Case creation\n|Exponential backoff (1s, 2s, 4s, 8s, 16s), max 5 retries, then dead letter queue\n\n|NFR-REL-002\n|Dead letter queue monitoring\n|Alert ops team immediately when DLQ depth > 0 (failed Case creations require manual intervention)\n\n|NFR-REL-003\n|Event Bus message durability\n|Messages persisted in Event Bus (SNS+SQS/EventBridge/Kinesis), not lost on service restart\n\n|NFR-REL-004\n|Idempotency: Case creation\n|EngagementService ensures duplicate feedback submissions don't create duplicate Cases (idempotency key)\n\n|NFR-REL-005\n|Circuit breaker: Salesforce API calls\n|Open circuit after 5 consecutive failures, half-open retry after 30 seconds\n\n|NFR-REL-006\n|Health checks: ProfileService and EngagementService\n|Health endpoints for load balancer checks, readiness and liveness probes\n\n|NFR-REL-007\n|Disaster recovery: Event Bus\n|Event Bus messages replicated across AWS availability zones (SQS/EventBridge/Kinesis HA)\n\n|===\n\n=== Maintainability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-MAINT-001\n|Code quality: ProfileService and EngagementService\n|> 80% test coverage (unit + integration tests), automated CI/CD pipeline\n\n|NFR-MAINT-002\n|API documentation\n|OpenAPI/Swagger specs for ProfileService and EngagementService, auto-generated API docs\n\n|NFR-MAINT-003\n|Deployment automation\n|Infrastructure as Code (Terraform/CloudFormation/CDK), zero-downtime deployments\n\n|NFR-MAINT-004\n|Logging: structured logs\n|JSON-formatted logs with correlation IDs, log levels (DEBUG, INFO, WARN, ERROR), centralized log aggregation\n\n|NFR-MAINT-005\n|Monitoring dashboards\n|Real-time dashboards for ProfileService, EngagementService, Event Bus (see Monitoring and Observability section)\n\n|NFR-MAINT-006\n|Alerting and on-call\n|PagerDuty/Opsgenie integration for P1/P2 alerts, on-call rotation for ops team\n\n|NFR-MAINT-007\n|Configuration management\n|Externalized configuration (environment variables, AWS Parameter Store), no hardcoded config\n\n|NFR-MAINT-008\n|Versioning: API and events\n|Semantic versioning (v1, v2), backward compatibility for API changes, event schema evolution\n\n|===\n\n=== Usability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-USE-001\n|Feedback submission UX\n|Mobile App user receives immediate \"Feedback submitted\" confirmation (< 1 second), not blocked by async Case creation\n\n|NFR-USE-002\n|Push notification delivery\n|Customer receives \"Your feedback has been received\" notification within 30 seconds of Case creation in Salesforce\n\n|NFR-USE-003\n|Case resolution notification\n|Customer receives \"Your case has been resolved\" notification within 30 seconds of support agent resolving Case\n\n|NFR-USE-004\n|Error messaging\n|User-friendly error messages for failed feedback submission (not technical errors), retry prompts\n\n|NFR-USE-005\n|Accessibility\n|Mobile App feedback form meets WCAG 2.1 AA accessibility standards (existing Mobile App compliance)\n\n|===\n\n=== Compliance Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-COMP-001\n|GDPR compliance: PII data\n|Customer Contact data (email, phone, name) managed per GDPR retention policies (Salesforce governance)\n\n|NFR-COMP-002\n|GDPR compliance: Right to erasure\n|Support \"Delete Account\" feedback category, trigger Contact deletion in Salesforce per GDPR Article 17\n\n|NFR-COMP-003\n|Data residency\n|Salesforce data residency governed by Viva Energy Salesforce configuration (regional compliance)\n\n|NFR-COMP-004\n|Audit trail\n|All Contact creates/updates, Case creates/updates logged for compliance auditing (Salesforce audit logs)\n\n|NFR-COMP-005\n|API security standards\n|OWASP API Security Top 10 compliance (injection prevention, authentication, authorisation, data exposure)\n\n|===\n\n== Monitoring and Observability\n\n=== Key Metrics\n\n[width=\"100%\",cols=\"25%,40%,35%\",options=\"header\",]\n|===\n|Metric Category |Metric |Target/Threshold\n\n|*Feedback Submission*\n|Feedback submission success rate (Mobile App → EngagementService)\n|> 99.5%\n\n|*Async Case Creation*\n|Case creation success rate (EngagementService → Salesforce)\n|> 99%\n\n|*Async Case Creation*\n|Case creation latency (time from feedback submission to Case created in Salesforce)\n|p95 < 5 minutes\n\n|*Event Bus*\n|Event Bus queue depth (pending Case creations)\n|< 100 messages\n\n|*Event Bus*\n|Dead letter queue depth (failed Case creations)\n|= 0 (alert on any failures)\n\n|*Salesforce API*\n|Salesforce API error rate\n|< 1%\n\n|*Salesforce API*\n|Salesforce API latency (Case creation)\n|p95 < 2 seconds\n\n|*Salesforce API*\n|Salesforce API rate limit utilization\n|< 80% of limit\n\n|*ProfileService*\n|Contact reconciliation success rate (JIT lookups)\n|> 99.5%\n\n|*ProfileService*\n|Contact reconciliation latency\n|p95 < 500ms\n\n|*Braze Notifications*\n|Push notification delivery rate (Case created/updated)\n|> 95%\n\n|*Salesforce Webhook*\n|Webhook delivery success rate (Salesforce → EngagementService)\n|> 99%\n\n|*Customer Satisfaction*\n|Customer satisfaction score (CSAT)\n|> 4.0/5.0 (improve by 15% from D365 CE baseline)\n\n|*Support Operations*\n|Average case resolution time\n|Decrease by 20% from D365 CE baseline\n\n|===\n\n=== Alerting Thresholds\n\n[width=\"100%\",cols=\"25%,50%,25%\",options=\"header\",]\n|===\n|Alert |Condition |Severity\n\n|*Feedback submission failures*\n|Feedback submission success rate < 95% over 5-minute window\n|P1 - Critical\n\n|*Dead letter queue accumulation*\n|Dead letter queue depth > 0 (any failed Case creations)\n|P2 - High\n\n|*Event Bus queue backlog*\n|Event Bus queue depth > 100 messages for > 15 minutes\n|P2 - High\n\n|*Salesforce API errors*\n|Salesforce API error rate > 5% over 5-minute window\n|P1 - Critical\n\n|*Salesforce API rate limits*\n|Salesforce API rate limit utilization > 90%\n|P2 - High\n\n|*Contact reconciliation failures*\n|ProfileService Contact reconciliation failure rate > 5% over 5-minute window\n|P2 - High\n\n|*Braze notification failures*\n|Braze push notification delivery rate < 80% over 15-minute window\n|P3 - Medium\n\n|*Salesforce webhook failures*\n|Salesforce webhook delivery success rate < 90% over 15-minute window\n|P2 - High\n\n|*Case creation latency*\n|Case creation latency p95 > 10 minutes\n|P3 - Medium\n\n|===\n\n=== Dashboards\n\n*ProfileService Dashboard:*\n\n* Contact reconciliation success rate (JIT lookups)\n* Contact reconciliation latency (p50, p95, p99)\n* Contact creation vs update ratio (new Contacts created vs existing Contacts updated)\n* Salesforce API error rate (Contact queries and creates)\n* Request rate and throughput\n\n*EngagementService Dashboard:*\n\n* Feedback submission success rate\n* Case creation success rate (async workflow)\n* Case creation latency (p50, p95, p99)\n* Event Bus queue depth (pending Case creations)\n* Dead letter queue depth (failed Case creations)\n* Salesforce API error rate (Case creation)\n* Salesforce API latency\n* Salesforce API rate limit utilization\n* Braze push notification delivery rate\n* Salesforce webhook delivery success rate\n\n*Event Bus Dashboard:*\n\n* Queue depth (pending messages)\n* Throughput (messages published/consumed per minute)\n* Dead letter queue depth (failed messages)\n* Consumer lag (time between publish and consume)\n\n*Customer Support Dashboard (Business Metrics):*\n\n* Total feedback submissions per day/week/month\n* Feedback category breakdown (App, Service, Order, Rewards, Refund, Delete Account)\n* Customer satisfaction score (CSAT) trend\n* Average case resolution time trend\n* Case volume by support team/queue\n* Unified customer view adoption (support agent feedback)\n<<<\n== Solution Validation\n\nThis section defines the validation criteria and testing approach for the solution.\n\n=== Functional Validation\n\n==== ProfileService API Testing\n\n*Test Scenarios*:\n1. **Happy Path**: Authenticated user requests Contact ID, existing Contact found in Salesforce, Contact ID returned\n2. **JIT Creation**: Authenticated user requests Contact ID, no existing Contact, new Contact created in Salesforce, Contact ID returned\n3. **Salesforce API Failure**: Salesforce unavailable, ProfileService returns 500 error, user retries\n4. **Invalid JWT**: Unauthenticated request, ProfileService returns 401 error\n\n*Acceptance Criteria*:\n- Contact reconciliation success rate > 99.5%\n- JIT Contact creation completes within 500ms (p95)\n\n==== EngagementService API Testing\n\n*Test Scenarios*:\n1. **Happy Path**: Valid feedback submission, immediate 202 Accepted response, Case created in Salesforce within 5 minutes, Braze notification delivered\n2. **Invalid Category**: Invalid feedback category, 400 Bad Request response with validation error\n3. **Salesforce Downtime**: Salesforce unavailable during async Case creation, message queued, retry logic executes, Case created when Salesforce recovers\n4. **Dead Letter Queue**: Case creation fails after 5 retries, message moved to DLQ, ops team alerted\n5. **Webhook Notification**: Support agent resolves Case in Salesforce, webhook triggers EngagementService, Braze push notification sent to customer\n\n*Acceptance Criteria*:\n- Feedback submission success rate > 99.5% (including async Case creation)\n- Async Case creation completes within 5 minutes (p95)\n- Webhook delivery success rate > 99%\n\n=== Non-Functional Validation\n\n==== Performance Testing\n\n*Load Testing*:\n\n*Baseline*: Expected 100-150 submissions/day from 20k DAU (~0.5-0.75% submission rate)\n\n- **Normal Load**: 1 submission/minute sustained for 2 hours (simulate typical daily pattern)\n- **3x Load**: 3 submissions/minute sustained for 1 hour (simulate busy period, 450 submissions/day)\n- **Peak Load (10x)**: 10 submissions/minute for 15 minutes (simulate incident scenario, app outage causing backlog)\n- **Stress Test**: 50 submissions/minute for 5 minutes (find breaking point, 20x normal)\n\n*Validation*:\n- API response time p95 < 1 second under 10x load\n- Event Bus queue depth remains manageable (< 100 messages)\n- No Case creation failures, all submissions processed successfully\n- Auto-scaling triggers appropriately for sustained load > 3x baseline\n\n*Acceptance Criteria*:\n- NFR-PERF-001 through NFR-PERF-006 validated under realistic load (3x and 10x baseline)\n- Auto-scaling triggers within 2 minutes of load increase\n- System handles 10x peak gracefully, 20x stress test identifies limits\n\n==== Resilience Testing\n\n*Salesforce API Failure Scenarios*:\n1. **Complete Outage**: Salesforce unavailable for 2 hours, Event Bus queues buffer work, Cases created when Salesforce recovers\n2. **Rate Limit Exceeded**: Salesforce rate limit hit, queue throttling activates, Cases created within SLA\n\n*Acceptance Criteria*:\n- NFR-AVAIL-004 validated (graceful degradation during Salesforce downtime)\n- Circuit breaker activates after 5 consecutive failures\n\n==== Security Validation\n\n*Penetration Testing*:\n- API authentication bypass attempts\n- SQL injection attempts\n- Webhook signature validation bypass\n\n*Acceptance Criteria*:\n- NFR-SEC-001 through NFR-SEC-010 validated\n- OWASP API Security Top 10 compliance verified\n\n=== Integration Validation\n\n==== End-to-End Testing\n\n*Full User Journey*:\n1. User authenticates via Microsoft Entra External ID\n2. Mobile App requests Contact ID from ProfileService (JIT reconciliation)\n3. User submits feedback via EngagementService\n4. Background worker creates Case in Salesforce\n5. Braze notification delivered to user\n6. Support agent resolves Case in Salesforce\n7. Salesforce webhook triggers EngagementService\n8. Braze notification delivered to user\n\n*Acceptance Criteria*:\n- End-to-end flow completes successfully in UAT\n- User receives both \"feedback submitted\" and \"case resolved\" notifications\n","structuredPatch":[{"oldStart":2065,"oldLines":6,"newStart":2065,"newLines":7,"lines":[" * App-specific database Contact updates frozen (read-only mode)"," * Rollback procedure ready (but not executed if migration successful)"," ","+[[wp-cs-009]]"," === WP-CS-009: Production Deployment"," "," ==== Description"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"9fd0d5cf-438f-4dea-99fb-7dcb91943a38"}
{"parentUuid":"802822d6-07e1-41c7-b190-d3974ee3dd86","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_012Z8dA689J5jKv4Q4sQyRFk","type":"tool_result","content":"The file /mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n  2132→* No critical incidents (P1/P2) in first 24 hours\n  2133→* D365 CE integration disabled\n  2134→* Support agents successfully using Salesforce for OTR digital customer Cases\n  2135→\n  2136→[[wp-cs-010]]\n  2137→=== WP-CS-010: Post-Cutover Support\n  2138→\n  2139→==== Description\n  2140→\n  2141→Monitor production stability, resolve issues, validate success criteria, and execute D365 CE retirement.\n  2142→\n  2143→==== Deliverables"}]},"uuid":"a4d72f83-b211-44bc-b49b-a379f222190f","timestamp":"2026-01-09T03:10:51.894Z","toolUseResult":{"filePath":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","oldString":"=== WP-CS-010: Post-Cutover Support\n\n==== Description","newString":"[[wp-cs-010]]\n=== WP-CS-010: Post-Cutover Support\n\n==== Description","originalFile":"= Salesforce Customer Support - Solution Architecture\n:project-name: Salesforce Customer Support\n:togaf-adm-phase: Phase E: Opportunities & Solutions\n:last-updated: 2026-01-07\n:document-type: Solution Architecture Document\n:status: Discovery\n:version: 0.1\n:domain: Customer Support & Engagement\n:programme-lead:\n:domain-architect: O.Young@otr.com.au\n:architecture-definition: xref:architecture-definitions:salesforce_customer_support.adoc[Architecture Definitions/Salesforce Customer Support]\n:doctype: article\n:toc: left\n:toclevels: 4\n:sectanchors:\n:sectlinks:\n:sectnums:\n:icons: font\n:source-highlighter: highlightjs\n:experimental:\n:description:\n:keywords:\n\n<<<\n== Purpose and Scope\n\n=== Purpose\n\nThis Solution Architecture defines how the Salesforce Customer Support consolidation will be implemented - the specific technology products, configurations, interfaces, and deployment architecture that realise the xref:architecture-definitions:salesforce_customer_support.adoc[Salesforce Customer Support Architecture Definition].\n\nThis solution establishes the **first implementation of OTR's target Domain-Driven Design (DDD) architecture** by deploying two new bounded contexts (`ProfileService` and `EngagementService`) as microservices, consolidating customer support onto Salesforce Service Cloud, and implementing event-driven integration patterns that will serve as the foundation for future bounded contexts (including Flybuys integration).\n\n=== Vision\n\n> Unify customer support across all OTRG channels by consolidating OTR digital customer feedback onto Salesforce Service Cloud, establishing the foundational DDD architecture with ProfileService and EngagementService bounded contexts that protect digital channels from external system changes while enabling support agents to deliver exceptional customer experiences with complete interaction history.\n\n=== Architectural Approach\n\nThis architecture establishes OTR's **first bounded context implementation** using Domain-Driven Design strategic patterns:\n\n* *link:../bounded_context/profile.adoc[ProfileService]* (NEW bounded context): Just-In-Time Contact reconciliation with Salesforce, upsert by email, returns Salesforce Contact ID to digital channels - foundation for future Flybuys partner linking\n* *link:../bounded_context/engagement.adoc[EngagementService]* (NEW bounded context): Customer feedback submission facade, Anti-Corruption Layer for Salesforce Case creation, Braze integration for all outbound customer communications (push, email, SMS), async Case processing via Event Bus\n* *Event-driven integration* (NEW pattern): Domain event publishing using existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis) - first implementation establishing pattern for future bounded contexts\n* *Anti-Corruption Layer*: EngagementService isolates digital channels from Salesforce API changes, translates between OTR domain language and Salesforce Service Cloud API\n* *Conformist Pattern*: ProfileService and EngagementService conform to existing Salesforce configuration (shared Viva Energy instance, multi-tenant governance)\n* *Big bang cutover*: Single deployment after Contact migration, no phased rollout, D365 CE retirement post-cutover\n\n=== Scope\n\n==== In Scope\n\n* Solution Building Blocks (SBBs) - specific technology products and versions\n* Interface specifications (APIs, events, data formats)\n* Data architecture and schema specifications\n* Deployment architecture and infrastructure configuration\n* Transition architecture with migration phases\n* Technical validation criteria and testing approach\n* External system integration specifications\n* Physical data models and API schemas\n\n==== Out of Scope\n\n===== Covered in xref:architecture-definitions:salesforce_customer_support.adoc[Architecture Definition]\n\n* Business requirements and stakeholder analysis\n* Architecture decisions and rationale (ADRs)\n* Bounded context definitions and responsibilities\n* High-level integration patterns (ACL, Conformist, OHS+PL)\n* Business capability mapping and value streams\n* Architecture principles and governance\n\n===== Covered in Other Documents\n\n* Detailed design (class diagrams, sequence diagrams for all flows)\n* Implementation code and unit tests\n* Business case and return-on-investment analysis\n* Operational run books and support procedures\n\n<<<\n=== Architecture Overview\n\n[mermaid]\n----\n---\nconfig:\n  layout: elk\n---\nflowchart TB\n    Customer([\"Customer\"]) -- Uses --> MobileApp[\"Mobile App<br>iOS/Android\"]\n    Customer -- Shops at --> POS[\"OTR/OTR+ POS<br>D365 Commerce\"]\n    MobileApp -- Authenticate --> EntraID[\"Microsoft Entra\"]\n    MobileApp -- Identifies & Reconciles --> ProfileService[\"ProfileService\"]\n    ProfileService <-- Reconcile App User as Salesforce Contact --> Salesforce[\"Salesforce\"]\n    ProfileService -- On Create --> EventBus[\"EventBus\"]\n    EventBus -- Emits CreateUser Event --> LoyaltyService[\"LoyaltyService\"] & EngagementService[\"EngagementService\"]\n    LoyaltyService -- Reconcile Wallet --> EagleEye[\"EagleEye\"]\n    EngagementService -- Reconcile Braze Profile --> Braze[\"Braze\"]\n    EngagementService --> Salesforce\n    D365CE[\"D365CE\"] -- Data Migration --> Salesforce\n    MobileApp -- Submits Feedback --> EngagementService\n\n    Customer:::customer\n    MobileApp:::presentation\n    POS:::presentation\n    EntraID:::external\n    ProfileService:::newService\n    Salesforce:::external\n    EventBus:::infrastructure\n    LoyaltyService:::newService\n    EngagementService:::newService\n    EagleEye:::external\n    Braze:::external\n    D365CE:::external\n    classDef newService fill:#4CAF50,stroke:#2E7D32,stroke-width:3px,color:#fff\n    classDef external fill:#FF9800,stroke:#E65100,stroke-width:2px,color:#fff\n    classDef infrastructure fill:#2196F3,stroke:#0D47A1,stroke-width:2px,color:#fff\n    classDef presentation fill:#9C27B0,stroke:#4A148C,stroke-width:2px,color:#fff\n    classDef customer fill:#607D8B,stroke:#263238,stroke-width:2px,color:#fff\n----\n\n\n==== Key Architectural Patterns\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Pattern |Application |Rationale\n\n|*Anti-Corruption Layer (ACL)*\n|EngagementService → Salesforce Service Cloud\n|Protects digital channels (Mobile App, Web) from Salesforce API changes, translates between OTR domain language and Salesforce Case/Contact model, enables independent evolution of internal domain model\n\n|*Conformist*\n|ProfileService → Salesforce, EngagementService → Salesforce\n|Shared Viva Energy Salesforce instance - we conform to existing configuration, governance, and API contracts (external system we don't control)\n\n|*Backend-for-Frontend (BFF)*\n|EngagementService\n|Aggregates customer feedback submission, Contact lookup, async Case creation, and Braze notification orchestration for digital channel clients\n\n|*Event-Driven Architecture (OHS+PL)*\n|Event Bus (SNS+SQS/EventBridge/Kinesis)\n|Loose coupling between bounded contexts, async domain event publishing (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`), foundation for future bounded contexts\n\n|*Just-In-Time (JIT) Integration*\n|ProfileService → Salesforce Contact reconciliation\n|Reconcile app users as Salesforce Contacts on-demand (upsert by email), no pre-sync required, ensures Salesforce has current Contact data\n\n|*Async Processing*\n|EngagementService Case creation via Event Bus\n|Non-blocking user experience, resilience to Salesforce downtime, automatic retry with exponential backoff, dead letter queue for operations team intervention\n\n|*Strangler Fig*\n|Not applicable\n|Big bang cutover (no gradual migration) - D365 CE fully replaced, not incrementally strangled\n\n|===\n\n<<<\n== Solution Approach\n\n* Deploy xref:bounded-contexts:profile.adoc[ProfileService] and xref:bounded-contexts:engagement.adoc[EngagementService] as bounded context microservices\n* Implement Anti-Corruption Layers (ACLs) for Salesforce and Braze integration\n* Establish event-driven architecture as the foundational integration pattern\n* Big bang cutover (TS-1 → TS-4)\n\n=== Related Documentation\n\nThis solution architecture references detailed technical specifications:\n\n==== Architecture Definition\n\n* xref:architecture-definitions:salesforce_customer_support.adoc[Salesforce Customer Support - Architecture Definition] - Business requirements, architecture decisions (ADRs), bounded context definitions, high-level integration patterns\n\n==== Bounded Context Specifications\n\n* xref:bounded-contexts:profile.adoc[ProfileService Bounded Context] - JIT Contact reconciliation, aggregate definitions\n* xref:bounded-contexts:engagement.adoc[EngagementService Bounded Context] - Customer feedback facade, Anti-Corruption Layer\n\n==== Interface Specifications\n\nDetailed API specifications available in the specifications directory:\n\n* link:../../specifications/rest/profile-service-v1.yaml[ProfileService REST API v1] - OpenAPI 3.0 specification for `/profile/v1` endpoints (includes Salesforce Contact reconciliation `GET /contact-id`)\n* link:../../specifications/rest/engagement-service-v1.yaml[EngagementService REST API v1] - OpenAPI 3.0 specification for `/engagement/v1` endpoints (includes `POST /feedback`)\n* link:../../specifications/events/engagement-events.json[Engagement Domain Events] - CloudEvents 1.0 JSON Schema for `SupportCaseCreated`, `SupportCaseUpdated`, `SupportCaseResolved`, `CustomerFeedbackSubmitted`\n\n==== External System Documentation\n\n* https://developer.salesforce.com/docs/atlas.en-us.api_rest.meta/api_rest/[Salesforce REST API Documentation] - Contact and Case object APIs\n* https://www.braze.com/docs/api/endpoints/messaging/send_messages/post_send_triggered_campaigns/[Braze Campaign Trigger API] - Push notification campaigns\n\n<<<\n== Executive Summary\n\n=== Challenge\n\nOTR digital customers (Mobile App, Web) currently submit feedback and support requests to D365 Customer Engagement, while Viva Energy's broader business units (fuel wholesale, Shell Card customers, other retail channels) use Salesforce Service Cloud. This creates:\n\n* *Fragmented customer support platform*: Customer support data split across two systems, preventing support agents from having a unified view of customer interactions across all channels\n* *Operational inefficiency*: Maintaining two separate customer support platforms increases operational overhead and costs\n* *Poor support experience*: D365 CE is not working well for digital customer support, impacting customer satisfaction and case resolution times\n* *Post-merger consolidation opportunity*: Following Viva Energy's acquisition of OTR, strategic alignment on Salesforce as the enterprise customer support platform\n\n=== Solution\n\nThis architecture establishes the **foundational Domain-Driven Design (DDD) implementation** for OTR's target state architecture by introducing two new bounded contexts (link:../bounded_context/profile.adoc[ProfileService], link:../bounded_context/engagement.adoc[EngagementService]) and event-driven integration patterns:\n\n==== New Bounded Contexts\n\n* *link:../bounded_context/profile.adoc[ProfileService]* (NEW): Just-In-Time (JIT) Contact reconciliation with Salesforce, upsert by email, returns Salesforce Contact ID to Mobile App\n* *link:../bounded_context/engagement.adoc[EngagementService]* (NEW): Customer feedback submission, Anti-Corruption Layer (ACL) for Salesforce Case creation, Braze integration for all outbound customer communications (push, email, SMS), async Case processing via Event Bus\n* *Event Bus* (NEW pattern): Domain event publishing using existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis) - first implementation of event-driven architecture pattern\n\n==== Integration Architecture\n\n* *Salesforce = System of Record*: Salesforce Service Cloud (shared Viva Energy instance) owns Contact and Case data\n* *Conformist Pattern*: ProfileService and EngagementService conform to existing Salesforce configuration and API contracts\n* *Anti-Corruption Layer*: EngagementService protects digital channels from Salesforce API changes, translates between OTR domain language and Salesforce\n* *Async Case Creation*: Non-blocking user experience, resilience to Salesforce downtime, automatic retry with exponential backoff, dead letter queue for failed Cases\n* *Event-Driven Notifications*: Salesforce webhook → EngagementService → Braze for all customer communications (push, email, SMS) on Case status updates\n\n==== Migration Approach\n\n* *Contact Migration*: One-time migration from app-specific database → Salesforce (upsert with flexible matching by email/phone/VCI)\n* *No Case Migration*: Historical D365 CE Cases not migrated (fresh start in Salesforce)\n* *Big Bang Cutover*: Single deployment, no phased rollout or parallel run\n* *D365 CE Retirement*: Complete decommissioning of D365 Customer Engagement post-cutover\n\n=== Key Architectural Significance\n\nThis migration establishes the first implementation of OTR's target DDD architecture:\n\n* First bounded contexts implemented (ProfileService, EngagementService)\n* First event-driven domain event pattern (foundation for future bounded contexts)\n* Foundation for Flybuys integration (ProfileService Contact reconciliation reused)\n* Establishes integration patterns (Conformist, ACL, Event-Driven) for future services\n\n=== Success Criteria\n\n* All digital customer feedback routed to Salesforce Service Cloud within 30 days of launch\n* Support agents have unified customer view across all Viva Energy channels (digital, wholesale, Shell Card, other retail)\n* D365 Customer Engagement decommissioned within 90 days post-cutover\n* Customer satisfaction score improves by 15% within 6 months\n* Average case resolution time decreases by 20% within 6 months\n* Zero data loss during Contact migration (100% validation pass rate)\n* Mobile App feedback submission success rate > 99.5% (including async Case creation)\n\n=== Technical Constraints\n\n* Shared Salesforce instance (Viva Energy multi-tenant environment)\n* Conform to existing Salesforce configuration and governance (data isolation strategy TBD with Salesforce admin team)\n* Contact migration must complete before cutover (no parallel run)\n* Async Case creation mandatory (non-blocking user experience)\n* Expected volume: 100-150 feedback submissions/day from 20k DAU (~0.5-0.75% submission rate), architecture capacity planned for 3x-10x growth\n\n=== Open Technical Decisions (TBD)\n\n* Salesforce Case field mapping for digital feedback categories (App, Service, Order, Rewards, Refund, Delete Account)\n* Salesforce data isolation strategy (Record Types, custom fields, queues)\n* Salesforce REST API authentication method (OAuth 2.0, Connected App, JWT bearer flow)\n* Salesforce webhook mechanism for Case updates (Outbound Messages, Platform Events, Process Builder)\n* Retry policy configuration (attempts, backoff intervals)\n* Salesforce API rate limit strategy (expected volume: 100-150 submissions/day from 20k DAU, capacity planning for 3x-10x growth)\n\n== Technical Requirements\n\n[width=\"100%\",cols=\"8%,92%\",options=\"header\",]\n|===\n|ID |Description\n\n|TR-CS-001\n|Every Mobile App user must have a Salesforce Contact record in Salesforce Service Cloud (shared Viva Energy instance)\n\n|TR-CS-002\n|ProfileService must reconcile Mobile App users as Salesforce Contacts using Just-In-Time (JIT) upsert by email address\n\n|TR-CS-003\n|ProfileService must return Salesforce Contact ID to Mobile App for feedback submission\n\n|TR-CS-004\n|Mobile App must support customer feedback submission with fields: Category (App, Service, Order, Rewards, Refund, Delete Account), Store Name, Time of Visit, Contact Phone Number, Free Text Message\n\n|TR-CS-005\n|EngagementService must create Salesforce Cases asynchronously via Event Bus (non-blocking user experience)\n\n|TR-CS-006\n|EngagementService must acknowledge feedback submission immediately to Mobile App user (\"Feedback submitted\" confirmation)\n\n|TR-CS-007\n|EngagementService must send push notification to customer via Braze when Case is successfully created in Salesforce\n\n|TR-CS-008\n|EngagementService must retry failed Case creation with configurable exponential backoff and dead letter queue for operations team intervention\n\n|TR-CS-009\n|Salesforce must be the System of Record for Contact and Case data (no local persistence in ProfileService or EngagementService)\n\n|TR-CS-010\n|Contact migration from app-specific database to Salesforce must complete before Mobile App cutover (upsert with flexible matching by email/phone/VCI)\n\n|TR-CS-011\n|No Case migration from D365 Customer Engagement to Salesforce (fresh start, historical Cases not migrated)\n\n|TR-CS-012\n|EngagementService must publish domain events (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`) to Event Bus for consumption by other bounded contexts\n\n|TR-CS-013\n|EngagementService must receive Salesforce webhook notifications when Cases are updated/resolved by support agents\n\n|TR-CS-014\n|EngagementService must trigger Braze push notifications to customers when Cases are updated/resolved (via Salesforce webhook → EngagementService → Braze)\n\n|TR-CS-015\n|ProfileService and EngagementService must conform to existing Salesforce configuration and API contracts (Conformist pattern)\n\n|TR-CS-016\n|All changes must be communicated using event-driven architecture via Event Bus (using existing AWS infrastructure: SNS+SQS/EventBridge/Kinesis)\n\n|TR-CS-017\n|Mobile App feedback submission success rate must exceed 99.5% (including async Case creation completion)\n\n|TR-CS-018\n|Contact migration must achieve 100% validation pass rate (zero data loss)\n\n|TR-CS-019\n|D365 Customer Engagement must be fully decommissioned within 90 days post-cutover\n\n|===\n\n== Technical Architecture\n\n=== Technical Capability Requirements\n\n==== Requirements Traceability\n\n[width=\"100%\",cols=\"15%,50%,35%\",options=\"header\",]\n|===\n|Requirement ID |Requirement Summary |Architectural Building Blocks\n\n|TR-CS-001\n|Every Mobile App user must have Salesforce Contact record\n|ABB-CS-001 (ProfileService), ABB-CS-004 (Salesforce), ABB-CS-007 (Contact Migration Tool)\n\n|TR-CS-002\n|ProfileService JIT Contact reconciliation via upsert by email\n|ABB-CS-001 (ProfileService), ABB-CS-004 (Salesforce)\n\n|TR-CS-003\n|ProfileService returns Salesforce Contact ID to Mobile App\n|ABB-CS-001 (ProfileService), ABB-CS-006 (Mobile App)\n\n|TR-CS-004\n|Mobile App supports feedback submission with structured fields\n|ABB-CS-006 (Mobile App), ABB-CS-002 (EngagementService)\n\n|TR-CS-005\n|EngagementService creates Salesforce Cases asynchronously\n|ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus), ABB-CS-004 (Salesforce)\n\n|TR-CS-006\n|EngagementService immediate acknowledgment to Mobile App\n|ABB-CS-002 (EngagementService), ABB-CS-006 (Mobile App)\n\n|TR-CS-007\n|EngagementService sends push notification via Braze on Case creation\n|ABB-CS-002 (EngagementService), ABB-CS-005 (Braze)\n\n|TR-CS-008\n|EngagementService retry logic with exponential backoff and DLQ\n|ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus)\n\n|TR-CS-009\n|Salesforce is System of Record for Contact and Case data\n|ABB-CS-004 (Salesforce), ABB-CS-001 (ProfileService - stateless), ABB-CS-002 (EngagementService - stateless)\n\n|TR-CS-010\n|Contact migration before Mobile App cutover\n|ABB-CS-007 (Contact Migration Tool), ABB-CS-004 (Salesforce)\n\n|TR-CS-011\n|No Case migration from D365 CE (fresh start)\n|ABB-CS-004 (Salesforce) - no migration tooling required\n\n|TR-CS-012\n|EngagementService publishes domain events to Event Bus\n|ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus)\n\n|TR-CS-013\n|EngagementService receives Salesforce webhook notifications\n|ABB-CS-002 (EngagementService), ABB-CS-004 (Salesforce)\n\n|TR-CS-014\n|EngagementService triggers Braze notifications on Case updates\n|ABB-CS-002 (EngagementService), ABB-CS-004 (Salesforce), ABB-CS-005 (Braze)\n\n|TR-CS-015\n|ProfileService and EngagementService conform to Salesforce config\n|ABB-CS-001 (ProfileService), ABB-CS-002 (EngagementService), ABB-CS-004 (Salesforce)\n\n|TR-CS-016\n|Event-driven architecture via Event Bus\n|ABB-CS-003 (Event Bus), ABB-CS-002 (EngagementService)\n\n|TR-CS-017\n|Mobile App feedback submission success rate > 99.5%\n|ABB-CS-006 (Mobile App), ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus), ABB-CS-004 (Salesforce)\n\n|TR-CS-018\n|Contact migration 100% validation pass rate\n|ABB-CS-007 (Contact Migration Tool), ABB-CS-004 (Salesforce)\n\n|TR-CS-019\n|D365 CE decommissioned within 90 days post-cutover\n|All ABBs (replacement system operational)\n\n|===\n\n=== Service Catalogues\n\n==== Application Portfolio Catalogue\n\n[width=\"100%\",cols=\"20%,15%,15%,15%,35%\",options=\"header\",]\n|===\n|Application |Lifecycle State |Owner |Hosting Platform |Description\n\n|*ProfileService*\n|NEW\n|OTR Platform Team\n|AWS (TBD: Lambda/ECS/EKS)\n|JIT Contact reconciliation with Salesforce, returns Salesforce Contact ID, foundation for Flybuys integration\n\n|*EngagementService*\n|NEW\n|OTR Platform Team\n|AWS (TBD: Lambda/ECS/EKS)\n|Customer feedback submission facade, ACL for Salesforce Case creation, Braze integration for all outbound communications (push, email, SMS), webhook receiver\n\n|*Mobile App (iOS)*\n|ACTIVE (UPDATE)\n|OTR Mobile Team\n|Apple App Store\n|iOS native app with feedback form, integrate with ProfileService and EngagementService APIs\n\n|*Mobile App (Android)*\n|ACTIVE (UPDATE)\n|OTR Mobile Team\n|Google Play Store\n|Android native app with feedback form, integrate with ProfileService and EngagementService APIs\n\n|*Salesforce Service Cloud*\n|ACTIVE (EXPAND)\n|Viva Energy Salesforce Admin Team\n|Salesforce (SaaS)\n|Shared Viva Energy instance, System of Record for Contact and Case data, adding OTR digital customer support\n\n|*Braze*\n|ACTIVE (EXTEND)\n|OTR Marketing Team\n|Braze (SaaS)\n|Marketing automation platform, EngagementService triggers push notifications for Case updates\n\n|*D365 Customer Engagement*\n|RETIRE\n|OTR Support Team\n|Microsoft Azure (SaaS)\n|Legacy customer support platform, decommissioned within 90 days post-cutover\n\n|*App-Specific Customer Database*\n|RETIRE\n|OTR Platform Team\n|AWS (RDS/DynamoDB)\n|Legacy customer contact storage, one-time migration to Salesforce, then deprecated\n\n|*Event Bus*\n|NEW\n|OTR Platform Team\n|AWS (SNS+SQS/EventBridge/Kinesis)\n|Domain event publishing infrastructure for bounded context integration\n\n|*Contact Migration Tool*\n|TEMPORARY\n|OTR Platform Team\n|AWS (Script/Lambda)\n|One-time migration app database → Salesforce with upsert logic, retired after migration complete\n\n|===\n\n==== Technology Capability Requirements\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Technology Capability |Implementation Technology (TBD in detailed design) |Requirements\n\n|*Microservice Hosting*\n|AWS Lambda / ECS / EKS\n|Host ProfileService and EngagementService with auto-scaling, high availability, monitoring\n\n|*API Gateway*\n|AWS API Gateway / Application Load Balancer\n|REST API routing, authentication, rate limiting, request validation for ProfileService and EngagementService\n\n|*Event Bus*\n|AWS SNS+SQS / EventBridge / Kinesis\n|Domain event publishing, async message processing, retry logic, dead letter queue\n\n|*Salesforce Integration*\n|Salesforce REST API / SOAP API\n|Contact CRUD operations, Case creation, webhook notifications, OAuth 2.0 authentication\n\n|*Braze Integration*\n|Braze REST API / SDK\n|Push notification campaign triggers, customer profile reconciliation\n\n|*Authentication & Authorisation*\n|Microsoft Entra External ID / AWS Cognito\n|Mobile App user authentication, API authorisation, JWT token validation\n\n|*Observability & Monitoring*\n|AWS CloudWatch / Datadog / New Relic\n|Application metrics, logs, traces, dashboards, alerting (feedback submission rate, queue depth, API errors)\n\n|*Secret Management*\n|AWS Secrets Manager / Parameter Store\n|Salesforce credentials, Braze API keys, OAuth tokens, encryption keys\n\n|*Database (Migration Tool)*\n|AWS RDS / DynamoDB (read-only access)\n|Contact migration from app-specific database\n\n|*CI/CD Pipeline*\n|GitHub Actions / AWS CodePipeline\n|Automated build, test, deployment for ProfileService, EngagementService, Mobile App\n\n|*Infrastructure as Code*\n|Terraform / AWS CloudFormation / CDK\n|Declarative infrastructure provisioning for Event Bus, microservices, monitoring\n\n|*API Documentation*\n|OpenAPI / Swagger\n|ProfileService and EngagementService API specifications for Mobile App integration\n\n|===\n\n==== Feature Flag Register\n\n*Note*: Per ADR-CS-006 (big bang cutover, not phased rollout), feature flags are minimal and used primarily for emergency rollback/kill switches.\n\n[width=\"100%\",cols=\"20%,15%,35%,30%\",options=\"header\",]\n|===\n|Feature Flag |Default State |Purpose |Rollback Scenario\n\n|*enable_salesforce_feedback_submission*\n|OFF (pre-cutover), ON (post-cutover)\n|Enable/disable feedback submission to EngagementService → Salesforce (kill switch for emergency rollback to D365 CE)\n|Feedback submission success rate < 95%, Salesforce API failures, critical bugs - revert to D365 CE integration\n\n|*enable_async_case_creation*\n|ON\n|Enable/disable async Case creation via Event Bus (fallback to synchronous processing if Event Bus issues)\n|Event Bus infrastructure failures, queue backlog unmanageable - temporary synchronous processing\n\n|*enable_braze_notifications*\n|ON\n|Enable/disable Braze push notifications for Case updates (degrade gracefully if Braze integration fails)\n|Braze API failures, notification delivery rate < 80% - disable notifications temporarily\n\n|*enable_jit_contact_reconciliation*\n|ON\n|Enable/disable ProfileService JIT Contact reconciliation (fallback to cached Contact IDs if Salesforce unavailable)\n|Salesforce API downtime, Contact reconciliation failures > 5% - use cached Contact IDs temporarily\n\n|*enable_salesforce_webhook_processing*\n|ON\n|Enable/disable Salesforce webhook processing for Case updates (fallback to polling if webhook failures)\n|Webhook delivery failures, authentication issues - temporary polling fallback\n\n|===\n\n*Feature Flag Management*:\n\n* Feature flags managed via AWS AppConfig / LaunchDarkly / custom feature flag service (TBD in detailed design)\n* Mobile App feature flags controlled server-side (no app release required for flag changes)\n* Backend service feature flags configured via environment variables / configuration service\n* Feature flag changes logged and audited (who changed, when, reason)\n* Post-cutover monitoring: Gradual removal of feature flags once system stability confirmed (30-60 days)\n\n==== Data Entity Catalogue\n\n[width=\"100%\",cols=\"20%,15%,35%,30%\",options=\"header\",]\n|===\n|Data Entity |System of Record |Key Attributes |Lifecycle\n\n|*Contact*\n|Salesforce Service Cloud\n|• Contact ID (Salesforce 15/18-char ID) +\n• Email (primary matching key) +\n• First Name, Last Name +\n• Phone Number +\n• Viva Consumer ID (VCI) +\n• Account (Viva Energy customer account) +\n• Record Type (OTR Digital vs other channels)\n|Created: ProfileService JIT reconciliation or Contact Migration Tool +\nUpdated: ProfileService JIT upsert (email changes), Salesforce (manual updates by support agents) +\nDeleted: Salesforce retention policy (GDPR/compliance)\n\n|*Case*\n|Salesforce Service Cloud\n|• Case Number (Salesforce auto-generated) +\n• Contact ID (reference to Contact) +\n• Subject (derived from Category) +\n• Description (Free Text Message) +\n• Category (App, Service, Order, Rewards, Refund, Delete Account) +\n• Store Name (OTR location) +\n• Time of Visit +\n• Status (New, In Progress, Resolved, Closed) +\n• Priority, Origin (Mobile App) +\n• Owner (support agent/queue)\n|Created: EngagementService async Case creation +\nUpdated: Support agents (Salesforce UI), EngagementService (webhook processing) +\nDeleted: Salesforce retention policy (archive after X years)\n\n|*Feedback Submission (transient)*\n|None (not persisted)\n|• Salesforce Contact ID +\n• Category +\n• Store Name +\n• Time of Visit +\n• Contact Phone Number +\n• Free Text Message\n|Created: Mobile App user submission +\nProcessed: EngagementService publishes to Event Bus, Case created in Salesforce +\nNot persisted in ProfileService/EngagementService (stateless)\n\n|*Domain Events*\n|Event Bus (ephemeral)\n|**SupportCaseCreated**: +\n• Case Number, Contact ID, Category, Timestamp +\n**SupportCaseUpdated**: +\n• Case Number, Status, Updated By, Timestamp +\n**SupportCaseResolved**: +\n• Case Number, Resolution, Resolved By, Timestamp +\n**CustomerFeedbackSubmitted**: +\n• Contact ID, Category, Timestamp\n|Published: EngagementService +\nConsumed: Other bounded contexts (future), Braze notification triggers +\nRetention: Short-lived (minutes to hours), not persisted for event sourcing\n\n|*Braze Customer Profile*\n|Braze\n|• External User ID (VCI or Email) +\n• Push Notification Tokens (iOS/Android) +\n• Notification Preferences +\n• Campaign Engagement History\n|Created/Updated: EngagementService on Case creation/update +\nManaged: Braze (external SaaS)\n\n|===\n\n*Data Migration Entities*:\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Source Entity |Target Entity |Migration Strategy\n\n|*App Database Contact*\n|Salesforce Contact\n|One-time migration via Contact Migration Tool: +\n• Upsert by email (primary), phone (secondary), VCI (tertiary) +\n• Map: Email → Email, Name → First/Last Name, Phone → Phone, VCI → External ID +\n• Validation: 100% data integrity check, reconciliation report\n\n|*D365 CE Case*\n|Not migrated\n|ADR-CS-005: No Case migration (fresh start in Salesforce) +\nD365 CE Cases archived separately for compliance if needed\n\n|===\n\n==== Data Quality & Validation\n\n*Contact Migration Validation Rules*:\n\n* Email format validation (RFC 5322 compliance)\n* Phone number format validation (E.164 international format)\n* VCI format validation (alphanumeric, length constraints)\n* Duplicate detection: Flag potential duplicates for manual review (same email/phone combination)\n* Mandatory fields: Email (required), First Name, Last Name (required for Salesforce Contact)\n\n*Case Creation Validation Rules*:\n\n* Contact ID must exist in Salesforce (validated by EngagementService before Case creation)\n* Category must be one of: App, Service, Order, Rewards, Refund, Delete Account\n* Free Text Message maximum length: 32,000 characters (Salesforce Case Description limit)\n* Store Name validated against OTR location master data (optional - warn if not found)\n\n<<<\n== Solution Building Blocks\n\nThis section defines the specific technology products, configurations, and implementation details for each Solution Building Block (SBB).\n\n=== Technology Portfolio Catalogue\n\n[width=\"100%\",cols=\"10%,20%,25%,25%,20%\",options=\"header\",]\n|===\n|SBB ID |Component |Technology Product |Version/Configuration |Deployment Platform\n\n|SBB-CS-001\n|ProfileService Microservice\n|.NET 8 / Node.js 20 LTS\n|RESTful API, containerised\n|AWS ECS Fargate / Lambda\n\n|SBB-CS-002\n|EngagementService Microservice\n|.NET 8 / Node.js 20 LTS\n|RESTful API, containerised, async workers\n|AWS ECS Fargate / Lambda\n\n|SBB-CS-003\n|Event Bus\n|AWS SNS + SQS / EventBridge\n|Standard queues, FIFO for ordering\n|AWS (managed service)\n\n|SBB-CS-004\n|API Gateway\n|AWS API Gateway / ALB\n|REST API, JWT validation\n|AWS (managed service)\n\n|SBB-CS-005\n|Salesforce Integration Layer\n|Salesforce REST API Client\n|OAuth 2.0 JWT bearer flow\n|Embedded in SBB-CS-001/002\n\n|SBB-CS-006\n|Braze Integration Layer\n|Braze REST API SDK\n|API key authentication\n|Embedded in SBB-CS-002\n\n|SBB-CS-007\n|Contact Migration Tool\n|Python 3.11 / .NET 8\n|One-time batch script\n|AWS Lambda / EC2\n\n|SBB-CS-008\n|Application Monitoring\n|AWS CloudWatch / Datadog\n|Metrics, logs, traces, dashboards\n|AWS / SaaS\n\n|SBB-CS-009\n|Secret Management\n|AWS Secrets Manager\n|KMS encryption\n|AWS (managed service)\n\n|SBB-CS-010\n|Mobile App (iOS)\n|SwiftUI, Kotlin Multiplatform\n|iOS 15+\n|Apple App Store\n\n|SBB-CS-011\n|Mobile App (Android)\n|Jetpack Compose, Kotlin Multiplatform\n|Android 8+\n|Google Play Store\n\n|SBB-CS-012\n|Feature Flag Service\n|AWS AppConfig / LaunchDarkly\n|Server-side flags, real-time updates\n|AWS / SaaS\n\n|===\n\n<<<\n== Data Architecture\n\nThis section defines the physical data models, event schemas, and API request/response formats.\n\n=== Domain Event Schemas\n\nAll domain events follow the https://cloudevents.io/[CloudEvents 1.0] specification for consistency and interoperability.\n\n*Event Schema Specifications*: See // TODO: Add to Antora - specifications/events/engagement-events.json[Engagement Service Event Schemas] for complete JSON schemas and examples.\n\n==== Event Catalogue\n\n[width=\"100%\",cols=\"30%,20%,50%\",options=\"header\",]\n|===\n|Event Type |Publisher |Description\n\n|`SupportCaseCreated`\n|EngagementService\n|Published when EngagementService successfully creates a Case in Salesforce after async processing\n\n|`SupportCaseUpdated`\n|EngagementService (via Salesforce webhook)\n|Published when a support agent updates a Case in Salesforce (status, priority, comment changes)\n\n|`SupportCaseResolved`\n|EngagementService (via Salesforce webhook)\n|Published when a support agent resolves/closes a Case in Salesforce\n\n|`CustomerFeedbackSubmitted`\n|EngagementService\n|Published when customer submits feedback via Mobile App (before async Case creation)\n\n|===\n\n*Event Format*: All events use CloudEvents 1.0 envelope with event-specific payload in the `data` field.\n\n*Schema Location*: `specifications/events/engagement-events.json`\n\n=== API Request/Response Schemas\n\n==== ProfileService: GET /profile/contact-id\n\n*Response* (200 OK):\n[source,json]\n----\n{\n  \"contactId\": \"0034X00000ABCDEFG\",\n  \"email\": \"customer@example.com\",\n  \"firstName\": \"John\",\n  \"lastName\": \"Smith\"\n}\n----\n\n==== EngagementService: POST /feedback\n\n*Request*:\n[source,json]\n----\n{\n  \"contactId\": \"0034X00000ABCDEFG\",\n  \"category\": \"App\",\n  \"storeName\": \"OTR Adelaide\",\n  \"timeOfVisit\": \"2026-01-07T12:00:00Z\",\n  \"contactPhoneNumber\": \"+61412345678\",\n  \"message\": \"App crashed when submitting feedback\"\n}\n----\n\n*Response* (202 Accepted):\n[source,json]\n----\n{\n  \"feedbackId\": \"fb-2026-01-07-12345\",\n  \"status\": \"submitted\",\n  \"message\": \"Your feedback has been submitted!\"\n}\n----\n\n=== Salesforce Field Mappings\n\n==== Case Object Mapping\n\n[width=\"100%\",cols=\"25%,25%,25%,25%\",options=\"header\",]\n|===\n|OTR Field |Salesforce Field |Data Type |Notes\n\n|Category\n|Feedback_Category__c\n|Picklist\n|App, Service, Order, Rewards, Refund, Delete Account\n\n|Store Name\n|Store_Name__c\n|String (255)\n|OTR location name\n\n|Time of Visit\n|Time_of_Visit__c\n|DateTime\n|When customer visited store\n\n|Free Text Message\n|Description\n|Long Text (32,000)\n|Customer feedback message\n\n|===\n\n<<<\n=== Baseline Architecture\n\n==== Existing System Components\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Component |Current State |Status\n\n|*D365 Customer Engagement*\n|Customer support platform for OTR digital customers (Mobile App, Web), handles feedback submission and case management\n|**DEPRECATED** - Being replaced by Salesforce Service Cloud\n\n|*App-Specific Customer Database*\n|Stores customer contact data for Mobile App users, separate from Viva Energy systems\n|**MIGRATING** - One-time migration to Salesforce, then deprecated\n\n|*Mobile App*\n|iOS/Android native apps with feedback submission form including Category, Store Name, Time of Visit, Contact Phone Number, and Free Text Message fields\n|**REQUIRES UPDATE** - Integrate with ProfileService and EngagementService APIs (feedback form UI already complete)\n\n|*Salesforce Service Cloud*\n|Shared Viva Energy instance handling customer support for fuel wholesale, Shell Card customers, other retail channels\n|**EXPANDING** - Adding OTR digital customer support Cases and Contacts\n\n|*Existing AWS Infrastructure*\n|SNS+SQS / EventBridge / Kinesis available for event-driven architecture\n|**REUSING** - Event Bus implementation leverages existing infrastructure\n\n|===\n\n==== Integration Architecture\n\n*Current state:*\n\n* Mobile App → D365 Customer Engagement (direct integration)\n* App-specific customer database → standalone (no Salesforce integration)\n* No event-driven architecture (synchronous, tightly coupled)\n* No Anti-Corruption Layer protecting digital channels\n* Viva Energy support teams use Salesforce, OTR digital support uses D365 CE (fragmented)\n\n==== Technical Debt\n\n*No longer relevant* - D365 CE being deprecated, not documenting technical debt of system being retired.\n\n*New technical debt introduced by this migration:*\n\n* Salesforce field mapping TBD (requires coordination with Viva Energy Salesforce admin team)\n* Data isolation strategy TBD (Record Types, custom fields, queues - multi-tenant governance)\n* Salesforce webhook mechanism TBD (Outbound Messages vs Platform Events vs Process Builder)\n* Expected feedback volume unknown (gathering data for rate limit planning)\n\n=== Gap Analysis\n\n==== Missing Capabilities\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Missing Capability |Description\n\n|*ProfileService bounded context*\n|No existing service for Contact reconciliation with Salesforce - requires new microservice implementing JIT upsert by email, returning Salesforce Contact ID\n\n|*EngagementService bounded context*\n|No existing service for customer feedback facade - requires new microservice implementing Anti-Corruption Layer for Salesforce Case creation, Braze integration, async processing via Event Bus\n\n|*Event Bus domain event pattern*\n|No existing domain event publishing infrastructure - requires implementing event-driven architecture pattern using existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis)\n\n|*Async Case creation workflow*\n|Current D365 CE integration is synchronous - requires implementing async processing with retry logic, exponential backoff, dead letter queue\n\n|*Salesforce webhook integration*\n|No existing capability to receive Salesforce notifications - requires implementing webhook receiver in EngagementService for Case update notifications\n\n|*Braze push notification orchestration*\n|No existing integration for Case-related push notifications - requires implementing Braze campaign triggers from EngagementService\n\n|*Contact migration tooling*\n|No existing tooling for app database → Salesforce Contact migration with upsert logic (match by email/phone/VCI)\n\n|*Feedback form enhancements*\n|Mobile App feedback form lacks structured fields (Category, Store Name, Time of Visit, Contact Phone Number) - requires UI updates\n\n|===\n\n==== Missing Bounded Contexts\n\n[width=\"100%\",cols=\"30%,30%,40%\",options=\"header\",]\n|===\n|Bounded Context |Responsibilities |Implementation Status\n\n|*link:../bounded_context/profile.adoc[ProfileService]*\n|JIT Contact reconciliation with Salesforce (upsert by email), return Salesforce Contact ID to digital channels, foundation for future Flybuys partner linking\n|**NEW** - First bounded context implementation\n\n|*link:../bounded_context/engagement.adoc[EngagementService]*\n|Customer feedback submission facade, Anti-Corruption Layer for Salesforce Case creation, Braze integration for push notifications, async Case processing, webhook receiver for Case updates\n|**NEW** - First bounded context implementation\n\n|===\n\n==== Missing Integration Patterns\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Integration Pattern |Description\n\n|*Anti-Corruption Layer (ACL)*\n|EngagementService → Salesforce Service Cloud - protects digital channels from Salesforce API changes, translates between OTR domain language and Salesforce\n\n|*Conformist*\n|ProfileService/EngagementService → Salesforce - conform to existing Salesforce configuration and API contracts (shared Viva Energy instance)\n\n|*Event-Driven Architecture (OHS+PL)*\n|Event Bus publishing domain events (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`) for loose coupling between bounded contexts\n\n|*Just-In-Time (JIT) Integration*\n|ProfileService → Salesforce Contact reconciliation on-demand (no pre-sync)\n\n|*Async Processing*\n|EngagementService Case creation via Event Bus with retry, exponential backoff, dead letter queue\n\n|===\n\n=== Target State Architecture\n\n==== Architectural Building Blocks (ABB)\n\n[width=\"100%\",cols=\"20%,25%,30%,25%\",options=\"header\",]\n|===\n|ABB ID |Bounded Context |Responsibilities |Technology (TBD in Solution Architecture)\n\n|ABB-CS-001\n|*link:../bounded_context/profile.adoc[ProfileService]*\n|JIT Contact reconciliation with Salesforce (upsert by email), return Salesforce Contact ID, foundation for Flybuys partner linking\n|Microservice (.NET/Node.js), REST API, Salesforce REST API client\n\n|ABB-CS-002\n|*link:../bounded_context/engagement.adoc[EngagementService]*\n|Customer feedback submission facade, ACL for Salesforce Case creation, Braze integration, async processing, webhook receiver\n|Microservice (.NET/Node.js), REST API, Event Bus publisher/subscriber, Salesforce webhook receiver\n\n|ABB-CS-003\n|*Event Bus*\n|Domain event publishing infrastructure (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`)\n|AWS SNS+SQS / EventBridge / Kinesis\n\n|ABB-CS-004\n|*Salesforce Service Cloud*\n|System of Record for Contact and Case data (shared Viva Energy instance)\n|Salesforce Service Cloud (external SaaS)\n\n|ABB-CS-005\n|*Braze*\n|Marketing automation platform for push notifications\n|Braze (external SaaS) - existing integration\n\n|ABB-CS-006\n|*Mobile App*\n|iOS/Android native apps with enhanced feedback form (Category, Store Name, Time of Visit, Contact Phone Number, Free Text Message)\n|Kotlin Multiplatform, SwiftUI, Jetpack Compose\n\n|ABB-CS-007\n|*Contact Migration Tool*\n|One-time migration app database → Salesforce with upsert logic (match by email/phone/VCI)\n|Script/tool (.NET/Python/Node.js)\n\n|===\n\n==== Integration Architecture\n\n===== Integration Flows\n\n*Customer Feedback Submission (Async):*\n\n1. *Mobile App* → ProfileService: Authenticate user, get Salesforce Contact ID (JIT reconciliation)\n2. *Mobile App* → EngagementService: Submit feedback (POST /feedback with Contact ID, Category, Store Name, Time of Visit, Phone, Message)\n3. *EngagementService* → Mobile App: Immediate acknowledgment (\"Feedback submitted\")\n4. *EngagementService* → Event Bus: Publish work item for async Case creation\n5. *Background Worker* (EngagementService) → Salesforce: Create Case via REST API\n6. *Success*: EngagementService → Event Bus: Publish `SupportCaseCreated` event\n7. *EngagementService* → Braze: Trigger push notification campaign (\"Your feedback has been received, Case #12345\")\n8. *Failure*: Retry with exponential backoff → Dead Letter Queue → Ops team alert\n\n*Case Update Notification (Bidirectional):*\n\n1. *Support Agent* updates/resolves Case in Salesforce\n2. *Salesforce* → EngagementService: Webhook notification (Case updated)\n3. *EngagementService* → Event Bus: Publish `SupportCaseUpdated` or `SupportCaseResolved` event\n4. *EngagementService* → Braze: Trigger push notification campaign (\"Your case has been resolved\")\n\n*Contact Reconciliation (JIT):*\n\n1. *Mobile App user* authenticates\n2. *Mobile App* → ProfileService: GET /profile/contact-id\n3. *ProfileService* → Salesforce: Query Contact by email\n4. *Match found*: Return existing Salesforce Contact ID\n5. *No match*: Create new Contact in Salesforce, return new Contact ID\n6. *ProfileService* → Mobile App: Return Salesforce Contact ID (cached by Mobile App)\n\n===== System of Record Boundaries\n\n[width=\"100%\",cols=\"30%,35%,35%\",options=\"header\",]\n|===\n|Data Entity |System of Record |Rationale\n\n|*Contact*\n|Salesforce Service Cloud\n|Shared Viva Energy instance, unified customer profile across all channels (digital, wholesale, Shell Card, retail)\n\n|*Case*\n|Salesforce Service Cloud\n|Support agents manage Cases in Salesforce, digital channels submit via EngagementService ACL\n\n|*Feedback Submission (transient)*\n|None (no persistence)\n|EngagementService processes feedback and creates Case in Salesforce, no local storage\n\n|*Domain Events*\n|Event Bus (ephemeral)\n|Events published to Event Bus, consumed by subscribers, not persisted long-term (event sourcing not in scope)\n\n|===\n\n==== Data Architecture Principles\n\n===== Aggregate Persistence\n\n*ProfileService:*\n\n* **No local aggregate persistence** - ProfileService is stateless, queries Salesforce on-demand\n* Salesforce Contact is the aggregate root (owned by Salesforce)\n* ProfileService acts as facade/translator, not system of record\n\n*EngagementService:*\n\n* **No local aggregate persistence** - EngagementService is stateless, creates Cases in Salesforce via ACL\n* Salesforce Case is the aggregate root (owned by Salesforce)\n* EngagementService maintains no local Case state (Conformist pattern - trust Salesforce as source of truth)\n* Async processing state managed via Event Bus (work items in queue, not database)\n\n===== Event Store\n\n* **Event Bus** (SNS+SQS/EventBridge/Kinesis) handles domain event publishing\n* Events are **ephemeral** (consumed and discarded, not persisted for event sourcing)\n* No Event Store implementation in this architecture (future enhancement if needed)\n* Event schema versioning TBD in Solution Architecture\n\n\n=== Architecture Decisions\n\n==== ADR-CS-001: Consolidate onto Salesforce Service Cloud (not build custom solution)\n\n*Status*: Accepted\n\n*Context*:\n\n* D365 Customer Engagement not working well for digital customer support\n* Viva Energy already uses Salesforce Service Cloud for fuel wholesale, Shell Card, other retail channels\n* Post-merger opportunity to consolidate onto single platform\n* Alternative: Build custom support platform or use different SaaS\n\n*Decision*:\n\nConsolidate OTR digital customer support onto Salesforce Service Cloud (shared Viva Energy instance).\n\n*Rationale*:\n\n* **Unified customer view**: Support agents see all interactions across channels (digital, wholesale, Shell Card, retail)\n* **Platform consolidation**: Single support platform reduces operational overhead and costs\n* **Proven solution**: Salesforce Service Cloud is established, feature-rich, well-supported\n* **Post-merger alignment**: Strategic decision to standardize on Viva Energy platforms\n* **Avoid custom development**: Building custom support platform would be costly and high-risk\n\n*Consequences*:\n\n* Unified customer support across Viva Energy Group\n* Reduced operational complexity (single platform vs two)\n* Leverage Salesforce capabilities (case routing, knowledge base, AI, omnichannel)\n* ⚠️ Conformist pattern required (shared instance, conform to existing configuration)\n* ⚠️ Multi-tenant governance needed (data isolation, security, queues)\n* ❌ Less control over platform evolution (SaaS vendor, shared instance)\n\n==== ADR-CS-002: Implement ProfileService and EngagementService as first DDD bounded contexts\n\n*Status*: Accepted\n\n*Context*:\n\n* OTR target architecture uses Domain-Driven Design with bounded contexts\n* This migration is opportunity to establish first implementation\n* Alternative: Direct Mobile App → Salesforce integration (no bounded contexts)\n* Alternative: Single monolithic service for all customer-facing APIs\n\n*Decision*:\n\nImplement ProfileService and EngagementService as separate bounded contexts following DDD strategic patterns.\n\n*Rationale*:\n\n* **Foundation for target architecture**: First implementation of DDD pattern for future bounded contexts (Flybuys, LocationService, PaymentService)\n* **Separation of concerns**: ProfileService handles identity/Contact reconciliation, EngagementService handles support/feedback (different responsibilities, different change rates)\n* **Anti-Corruption Layer**: EngagementService protects digital channels from Salesforce API changes\n* **Reusability**: ProfileService Contact reconciliation reused for Flybuys integration\n* **Event-driven architecture**: Establishes pattern for loose coupling between bounded contexts\n\n*Consequences*:\n\n* Establishes DDD architecture foundation for OTR\n* Reusable ProfileService for Flybuys and future integrations\n* Digital channels protected from Salesforce API changes (ACL)\n* Clear bounded context boundaries and responsibilities\n* ⚠️ Increased initial complexity (two new microservices vs direct integration)\n* ⚠️ Requires Event Bus infrastructure implementation\n* ⚠️ Team must learn DDD patterns and bounded context design\n\n==== ADR-CS-003: Async Case creation via Event Bus (not synchronous)\n\n*Status*: Accepted\n\n*Context*:\n\n* Current D365 CE integration is synchronous (user waits for Case creation)\n* Alternative: Keep synchronous integration (Mobile App → EngagementService → Salesforce synchronously)\n* Salesforce API may experience downtime or latency\n\n*Decision*:\n\nImplement async Case creation via Event Bus with immediate user acknowledgment, retry logic, exponential backoff, and dead letter queue.\n\n*Rationale*:\n\n* **Non-blocking user experience**: User gets immediate \"Feedback submitted\" confirmation, not waiting for Salesforce API\n* **Resilience**: If Salesforce is down, feedback still accepted, Case created when Salesforce recovers\n* **Retry logic**: Automatic retry with exponential backoff handles transient failures\n* **Operational visibility**: Dead letter queue alerts ops team to persistent failures\n* **Scalability**: Queue buffering handles traffic spikes\n\n*Consequences*:\n\n* Better user experience (no waiting for Salesforce API)\n* Resilient to Salesforce downtime (queue buffers work)\n* Automatic retry reduces manual intervention\n* Queue depth monitoring provides operational visibility\n* ⚠️ Eventual consistency (user gets success notification after Case created, not immediately)\n* ⚠️ Increased complexity (Event Bus, background workers, retry logic, DLQ)\n* ⚠️ Requires monitoring and alerting for DLQ\n\n==== ADR-CS-004: ProfileService uses email as primary matching key (not VCI)\n\n*Status*: Accepted\n\n*Context*:\n\n* ProfileService needs to reconcile Mobile App users as Salesforce Contacts\n* Alternative matching keys: VCI (Viva Consumer ID), email, phone, Salesforce External ID\n* Email changes are rare but possible\n\n*Decision*:\n\nUse email address as primary matching key for Contact reconciliation (JIT upsert by email).\n\n*Rationale*:\n\n* **Availability**: Email always available for authenticated users\n* **Uniqueness**: Email is unique identifier in Salesforce and Mobile App\n* **Salesforce standard**: Salesforce Contact uses email as standard lookup field\n* **Simplicity**: Single matching key simplifies upsert logic\n* **Edge case acceptable**: Email changes are rare, manual cleanup acceptable\n\n*Consequences*:\n\n* Simple upsert logic (query by email, create if not found)\n* Leverages Salesforce standard email field\n* Email always available from authentication\n* ⚠️ Email changes create duplicate Contacts (rare edge case, manual cleanup)\n* ⚠️ Future enhancement: Add VCI as Salesforce External ID for stable matching\n\n==== ADR-CS-005: No Case migration from D365 CE (fresh start)\n\n*Status*: Accepted\n\n*Context*:\n\n* D365 CE contains historical customer support Cases\n* Alternative: Migrate historical Cases to Salesforce (preserve support history)\n* Alternative: Archive D365 CE Cases separately (read-only access)\n\n*Decision*:\n\nDo not migrate historical Cases from D365 CE to Salesforce. Start fresh in Salesforce.\n\n*Rationale*:\n\n* **Limited value**: Historical D365 CE Cases not critical for future support\n* **Data quality**: D365 CE Case data may be inconsistent or incomplete\n* **Complexity**: Case migration requires mapping D365 CE schema to Salesforce, data transformation, validation\n* **Cost-benefit**: Migration effort outweighs value of historical data\n* **Archive option**: D365 CE Cases can be archived separately if needed (read-only access for auditing)\n\n*Consequences*:\n\n* Simpler migration (Contacts only, no Case migration)\n* Faster time to value (no Case migration delay)\n* Clean start in Salesforce (no legacy data quality issues)\n* ⚠️ Historical Cases not visible in Salesforce (support agents can't see old Cases)\n* ⚠️ D365 CE must remain accessible temporarily for historical Case lookups (if needed)\n* ❌ Loss of historical Case insights (reporting, analytics on old Cases)\n\n==== ADR-CS-006: Big bang cutover (not phased rollout)\n\n*Status*: Accepted\n\n*Context*:\n\n* Alternative: Phased rollout with feature flags (pilot users first, gradual enablement)\n* Alternative: Parallel run (submit to both D365 CE and Salesforce temporarily)\n* Flybuys integration uses phased rollout (AS-1, AS-2, AS-3 architecture states)\n\n*Decision*:\n\nBig bang cutover - migrate Contacts, deploy ProfileService and EngagementService, switch Mobile App, retire D365 CE.\n\n*Rationale*:\n\n* **Simplicity**: No parallel run complexity, no feature flag management\n* **Faster D365 CE retirement**: No extended transition period maintaining two systems\n* **Limited risk**: Customer support not mission-critical (not payment processing), rollback possible\n* **User base manageable**: OTR digital customers smaller than Flybuys integration scope\n* **Different use case**: Flybuys phased rollout manages points accrual complexity, support feedback is simpler\n\n*Consequences*:\n\n* Simpler deployment (single cutover, no AS-1/AS-2/AS-3 states)\n* Faster D365 CE retirement (no extended parallel run)\n* No feature flag complexity or pilot user management\n* ⚠️ Higher cutover risk (all users switch at once)\n* ⚠️ Requires comprehensive testing before cutover\n* ⚠️ Rollback plan required (revert to D365 CE if critical issues)\n\n==== ADR-CS-007: EngagementService receives Salesforce webhooks for Case updates\n\n*Status*: Accepted\n\n*Context*:\n\n* Support agents update/resolve Cases in Salesforce\n* Need to notify customers of Case status changes via push notifications\n* Alternative: Poll Salesforce API for Case updates (inefficient)\n* Alternative: No customer notifications (agents contact customers directly)\n\n*Decision*:\n\nSalesforce sends webhook notifications to EngagementService when Cases are updated/resolved. EngagementService triggers Braze push notifications.\n\n*Rationale*:\n\n* **Real-time notifications**: Customer notified immediately when agent resolves Case\n* **Efficient**: Webhook push model (not polling)\n* **Event-driven**: Aligns with event-driven architecture pattern\n* **Better customer experience**: Proactive notification vs waiting for agent contact\n\n*Consequences*:\n\n* Real-time customer notifications for Case updates\n* Efficient push model (no polling overhead)\n* Bidirectional integration (Mobile App → Salesforce → Mobile App)\n* ⚠️ Salesforce webhook mechanism TBD (Outbound Messages vs Platform Events vs Process Builder)\n* ⚠️ Webhook authentication and security required\n* ⚠️ EngagementService must handle webhook retries and failures\n\n<<<\n== Interface Specifications\n\nThis section provides references to the complete API specifications and event catalogue for ProfileService and EngagementService.\n\n=== REST API Specifications\n\nComplete OpenAPI 3.0 specifications are maintained in the `specifications/rest/` directory:\n\n==== ProfileService API v1\n\n*Specification*: link:../../specifications/rest/profile-service-v1.yaml[profile-service-v1.yaml]\n\n*Base URL*: `https://api.otr.com.au/profile/v1`\n\n*Authentication*: Bearer token (Microsoft Entra External ID JWT)\n\n*Key Endpoints*:\n\n* `GET /contact-id` - Retrieve or create Salesforce Contact ID for authenticated user (Just-In-Time reconciliation)\n** Used by Mobile App before submitting feedback to EngagementService\n** Upserts Salesforce Contact record using email as external key\n** Returns 18-character Salesforce Contact ID with caching (15-minute TTL)\n** Performance SLA: p95 < 300ms (uncached), p95 < 50ms (cached)\n\n==== EngagementService API v1\n\n*Specification*: link:../../specifications/rest/engagement-service-v1.yaml[engagement-service-v1.yaml]\n\n*Base URL*: `https://api.otr.com.au/engagement/v1`\n\n*Authentication*: Bearer token (Microsoft Entra External ID JWT)\n\n*Key Endpoints*:\n\n* `POST /feedback` - Submit customer feedback for async Case creation in Salesforce\n** Accepts contactId, category, storeName, timeOfVisit, contactPhoneNumber, message\n** Returns 202 Accepted immediately (async Case creation in background)\n** Publishes `CustomerFeedbackSubmitted` event for analytics\n** Creates Salesforce Case via Anti-Corruption Layer with retry logic\n** Performance SLA: p95 < 200ms (feedback accepted, not Case creation)\n\n=== Domain Events (AsyncAPI)\n\nComplete CloudEvents 1.0 JSON Schema specifications are maintained in the `specifications/events/` directory:\n\n*Specification*: link:../../specifications/events/engagement-events.json[engagement-events.json]\n\n==== Event Catalogue\n\n[width=\"100%\",cols=\"30%,20%,50%\",options=\"header\",]\n|===\n|Event Type |Publisher |Consumers\n\n|`CustomerFeedbackSubmitted`\n|EngagementService\n|Future bounded contexts, analytics, sentiment analysis\n\n|`SupportCaseCreated`\n|EngagementService\n|Future bounded contexts, analytics\n\n|`SupportCaseUpdated`\n|EngagementService (via Salesforce webhook)\n|Future bounded contexts, analytics\n\n|`SupportCaseResolved`\n|EngagementService (via Salesforce webhook)\n|Future bounded contexts, analytics\n\n|===\n\n==== Event Delivery Guarantees\n\n* **At-least-once delivery**: Events may be delivered multiple times, consumers must handle idempotency\n* **Ordering**: FIFO queues guarantee ordering for events with same `contactId`\n* **Retention**: 4 days (96 hours) in Event Bus\n* **Dead Letter Queue**: Failed events after 5 retries moved to DLQ for manual intervention\n* **Format**: CloudEvents 1.0 specification with JSON payload\n\n=== API Versioning Policy\n\n==== Version Numbering\n\n* **Format**: `/v{major}` in URL path (e.g., `/profile/v1`, `/engagement/v1`)\n* **Semantic Versioning**: Major version incremented for breaking changes only\n* **Backwards Compatibility**: Minor changes (new optional fields, new endpoints) don't require version bump\n\n==== When to Version\n\n*Breaking changes requiring new major version*:\n\n- Removing or renaming fields in request/response\n- Changing field data types (e.g., string → number)\n- Changing authentication mechanism\n- Removing endpoints\n\n*Non-breaking changes not requiring version bump*:\n\n- Adding new optional fields to request/response\n- Adding new endpoints\n- Expanding enum values (e.g., adding new feedback category)\n- Improving error messages\n\n==== Parallel Version Support\n\n* Support N and N-1 versions concurrently for 6 months\n* Deprecation notice: 3 months before sunsetting old version\n* Mobile App must upgrade to new version within deprecation window\n\n<<<\n== Work Packages\n\nThis section consolidates gaps and activities into implementable work packages aligned with TOGAF Phase E requirements.\n\n=== Work Package Overview\n\n[width=\"100%\",cols=\"15%,35%,25%,25%\",options=\"header\",]\n|===\n|Work Package ID |Name |Transition State |Key Deliverables\n\n|WP-CS-001\n|ProfileService Development\n|TS-1 (Build & Test)\n|ProfileService microservice, Salesforce Contact integration, REST API\n\n|WP-CS-002\n|EngagementService Development\n|TS-1 (Build & Test)\n|EngagementService microservice, Anti-Corruption Layer, Braze integration\n\n|WP-CS-003\n|Event Bus Infrastructure\n|TS-1 (Build & Test)\n|Event Bus configuration, CloudEvents schemas, monitoring\n\n|WP-CS-004\n|Contact Migration Tooling\n|TS-1 (Build & Test)\n|Migration tool, validation scripts, reconciliation reporting\n\n|WP-CS-005\n|Mobile App Integration\n|TS-1 (Build & Test)\n|Mobile App API integration, feedback form enhancements, testing\n\n|WP-CS-006\n|Integration Testing\n|TS-1 (Build & Test)\n|Test environments, integration test suites, UAT execution\n\n|WP-CS-007\n|Salesforce Configuration\n|TS-1 (Build & Test)\n|Salesforce field mapping, data isolation, webhook configuration\n\n|WP-CS-008\n|Contact Data Migration\n|TS-2 (Contact Migration)\n|Contact migration execution, validation, reconciliation\n\n|WP-CS-009\n|Production Deployment\n|TS-3 (Cutover)\n|Production deployment, smoke testing, go-live execution\n\n|WP-CS-010\n|Post-Cutover Support\n|TS-4 (Target State)\n|Monitoring, issue resolution, D365 CE retirement\n\n|===\n\n[[wp-cs-001]]\n=== WP-CS-001: ProfileService Development\n\n==== Description\n\nBuild ProfileService bounded context microservice implementing Just-In-Time Contact reconciliation with Salesforce Service Cloud.\n\n==== Deliverables\n\n* ProfileService microservice application\n** REST API implementation (OpenAPI 3.0 specification)\n** `GET /contact-id` endpoint (Salesforce Contact reconciliation)\n** Authentication/authorization with Microsoft Entra External ID\n** Caching layer (15-minute TTL for Contact IDs)\n* Salesforce integration\n** Salesforce REST API client\n** Contact upsert by email (external key matching)\n** Error handling and retry logic\n* Unit tests (>80% code coverage)\n* Integration tests with Salesforce sandbox\n* API documentation\n* Deployment configuration (IaC - Infrastructure as Code)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* Salesforce sandbox environment provisioned\n* Microsoft Entra External ID OAuth configuration\n* Development environment setup (AWS dev account, CI/CD pipeline)\n\n*Dependent Work Packages*:\n\n* None (can start immediately after prerequisites met)\n\n==== Skills Required\n\n* Backend development (.NET Core or Node.js)\n* REST API design and implementation\n* Salesforce REST API integration\n* OAuth 2.0 / JWT authentication\n* Caching strategies (Redis/ElastiCache)\n* Unit/integration testing frameworks\n* Infrastructure as Code (Terraform/CloudFormation)\n\n==== Acceptance Criteria\n\n* All API endpoints return correct HTTP status codes per OpenAPI specification\n* Contact ID retrieval achieves p95 < 300ms (uncached), p95 < 50ms (cached)\n* Salesforce Contact upsert succeeds with 100% accuracy in sandbox testing\n* Unit test coverage > 80%\n* Integration tests pass in sandbox environment\n* API documentation generated from OpenAPI specification\n\n[[wp-cs-002]]\n=== WP-CS-002: EngagementService Development\n\n==== Description\n\nBuild EngagementService bounded context microservice implementing customer feedback submission, Anti-Corruption Layer for Salesforce Case creation, Braze integration, and webhook receiver for Case updates.\n\n==== Deliverables\n\n* EngagementService microservice application\n** REST API implementation (OpenAPI 3.0 specification)\n** `POST /feedback` endpoint (async feedback submission)\n** Authentication/authorization with Microsoft Entra External ID\n** Webhook receiver endpoint for Salesforce Case updates\n* Anti-Corruption Layer (ACL)\n** OTR domain model to Salesforce API translation\n** Category enum mapping (App/Service/Order/Rewards → Salesforce Case fields)\n** Salesforce REST API client for Case creation\n* Async processing infrastructure\n** Event Bus publisher integration\n** Background worker for Case creation\n** Retry logic with exponential backoff (5 attempts)\n** Dead Letter Queue integration\n* Braze integration\n** Braze campaign trigger API client\n** Push notification orchestration for Case updates\n* Domain event publishing\n** `CustomerFeedbackSubmitted` event publisher\n** `SupportCaseCreated` event publisher\n** `SupportCaseUpdated` event translator (Salesforce webhook → domain event)\n** `SupportCaseResolved` event translator (Salesforce webhook → domain event)\n* Unit tests (>80% code coverage)\n* Integration tests (EngagementService ↔ Salesforce, EngagementService ↔ Braze)\n* API documentation\n* Deployment configuration (IaC)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-003 (Event Bus Infrastructure) completed\n* Salesforce sandbox environment provisioned\n* Braze API credentials and campaign templates configured\n* Microsoft Entra External ID OAuth configuration\n\n*Dependent Work Packages*:\n\n* WP-CS-003 must be completed first (Event Bus required for async processing)\n* WP-CS-007 (Salesforce Configuration) must be in progress (field mapping needed)\n\n==== Skills Required\n\n* Backend development (.NET Core or Node.js)\n* REST API design and implementation\n* Salesforce REST API integration\n* Event-driven architecture patterns\n* Async/background processing (queues, workers)\n* Braze API integration\n* Webhook design and security\n* OAuth 2.0 / JWT authentication\n* Domain-Driven Design (DDD) - Anti-Corruption Layer pattern\n* Unit/integration testing frameworks\n* Infrastructure as Code (Terraform/CloudFormation)\n\n==== Acceptance Criteria\n\n* Feedback submission endpoint returns 202 Accepted within p95 < 200ms\n* Async Case creation succeeds with >99.5% success rate (including retries)\n* Anti-Corruption Layer correctly maps all feedback categories to Salesforce Case fields\n* Webhook receiver processes Salesforce Case updates and publishes domain events\n* Braze push notifications sent successfully for Case updates\n* Failed Case creation moves to Dead Letter Queue after 5 retry attempts\n* Unit test coverage > 80%\n* Integration tests pass with Salesforce sandbox and Braze staging environment\n\n[[wp-cs-003]]\n=== WP-CS-003: Event Bus Infrastructure\n\n==== Description\n\nImplement Event Bus infrastructure for domain event publishing using existing AWS infrastructure (SNS+SQS, EventBridge, or Kinesis).\n\n==== Deliverables\n\n* Event Bus infrastructure configuration\n** Topic/stream provisioning (technology choice: SNS+SQS / EventBridge / Kinesis)\n** FIFO queue configuration (ordering by `contactId`)\n** Dead Letter Queue (DLQ) setup\n** Retention policy (4 days / 96 hours)\n** Access control policies (IAM roles, permissions)\n* CloudEvents 1.0 schema definitions\n** JSON Schema specifications for all domain events\n** Schema validation configuration\n** Schema registry (if using EventBridge/Kinesis)\n* Monitoring and alerting\n** CloudWatch dashboards for queue metrics\n** Alarms for DLQ depth, queue age, processing failures\n** Event Bus throughput monitoring\n* Documentation\n** Event Bus architecture diagram\n** Event publishing guidelines\n** Consumer integration guide\n* Infrastructure as Code (IaC)\n** Terraform/CloudFormation templates for all infrastructure\n\n==== Dependencies\n\n*Prerequisites*:\n\n* AWS account access (existing infrastructure)\n* Technology selection decision (SNS+SQS vs EventBridge vs Kinesis)\n* CloudEvents 1.0 schema design approval\n\n*Dependent Work Packages*:\n\n* None (foundational infrastructure, can start early)\n\n==== Skills Required\n\n* AWS messaging services (SNS, SQS, EventBridge, Kinesis)\n* Event-driven architecture patterns\n* CloudEvents specification\n* JSON Schema design\n* Infrastructure as Code (Terraform/CloudFormation)\n* AWS IAM security configuration\n* CloudWatch monitoring and alerting\n\n==== Acceptance Criteria\n\n* Event Bus infrastructure provisioned in all environments (dev, staging, production)\n* FIFO ordering validated for events with same `contactId`\n* Dead Letter Queue triggers alarms when messages arrive\n* Event retention policy enforced (4 days)\n* CloudEvents 1.0 schema validation enabled\n* Monitoring dashboards operational\n* Infrastructure fully codified (IaC)\n\n[[wp-cs-004]]\n=== WP-CS-004: Contact Migration Tooling\n\n==== Description\n\nDevelop Contact migration tool for one-time migration from app-specific database to Salesforce Service Cloud with upsert logic and validation.\n\n==== Deliverables\n\n* Contact migration tool\n** Extract Contacts from app-specific database\n** Transform to Salesforce Contact API format\n** Upsert to Salesforce using email as external key\n** Fallback matching by phone number or Viva Consumer ID\n** Batch processing with rate limiting (respect Salesforce API limits)\n** Idempotent operation (can be re-run safely)\n* Validation scripts\n** Pre-migration validation (data quality checks)\n** Post-migration validation (100% Contact reconciliation)\n** Email/phone/VCI matching accuracy report\n* Reconciliation reporting\n** Contacts created vs updated statistics\n** Failed upserts with error details\n** Matching accuracy metrics\n* Rollback capability\n** Export snapshot of Salesforce Contacts before migration\n** Rollback procedure documentation\n* Documentation\n** Migration tool user guide\n** Troubleshooting guide\n** Runbook for migration execution\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-001 (ProfileService Development) completed (reuses Salesforce integration code)\n* Salesforce sandbox environment for migration testing\n* App-specific database access (read-only sufficient)\n* Salesforce production access granted\n\n*Dependent Work Packages*:\n\n* WP-CS-001 provides Salesforce Contact upsert logic to reuse\n\n==== Skills Required\n\n* Database development (SQL, data extraction)\n* Salesforce REST API integration\n* Batch processing and ETL patterns\n* Data validation and reconciliation\n* Error handling and logging\n* Scripting (Python, PowerShell, or similar)\n\n==== Acceptance Criteria\n\n* Migration tool successfully migrates 100% of Contacts in sandbox with zero data loss\n* Email/phone/VCI matching accuracy > 95% in sandbox testing\n* Failed upserts captured with actionable error messages\n* Reconciliation report matches actual Salesforce Contact counts\n* Migration tool execution time acceptable for production (freezes app database for minimum time)\n* Rollback procedure validated in sandbox\n* Documentation complete and approved\n\n[[wp-cs-005]]\n=== WP-CS-005: Mobile App Integration\n\n==== Description\n\nUpdate Mobile App to integrate with ProfileService and EngagementService APIs, replacing D365 CE integration.\n\n==== Deliverables\n\n* Feedback form UI enhancements\n** Add Category dropdown (App, Service, Order, Rewards, Refund, Delete Account)\n** Add Store Name field (optional)\n** Add Time of Visit field (optional, datetime picker)\n** Add Contact Phone Number field (optional, E.164 validation)\n** Update Message field (1-2000 character limit with counter)\n* API integration (Kotlin Multiplatform shared code)\n** ProfileService client (`GET /contact-id`)\n** EngagementService client (`POST /feedback`)\n** JWT token management (Microsoft Entra External ID)\n** Error handling (network failures, API errors, validation errors)\n** Retry logic for transient failures\n* Platform-specific UI (SwiftUI for iOS, Jetpack Compose for Android)\n** Feedback form screens\n** Success/error confirmation screens\n** Loading states and progress indicators\n* Feature flag integration\n** `enable_salesforce_feedback_submission` flag\n** Fallback to D365 CE if flag disabled (during rollout)\n* Unit tests for shared business logic\n* UI tests for platform-specific screens\n* API integration tests (mocked APIs)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-001 (ProfileService Development) completed and deployed to dev/staging\n* WP-CS-002 (EngagementService Development) completed and deployed to dev/staging\n* ProfileService and EngagementService OpenAPI specifications finalized\n* Feature flag service configured\n\n*Dependent Work Packages*:\n\n* Must complete after WP-CS-001 and WP-CS-002 (requires API endpoints available for integration testing)\n\n==== Skills Required\n\n* Kotlin Multiplatform development\n* SwiftUI (iOS native UI)\n* Jetpack Compose (Android native UI)\n* REST API client development\n* OAuth 2.0 / JWT authentication\n* Form validation and UX design\n* Unit testing (Kotlin, Swift)\n* UI testing frameworks (XCTest, Espresso)\n\n==== Acceptance Criteria\n\n* Feedback form UI matches UX design specifications\n* All form fields validate correctly (client-side validation)\n* API integration successfully calls ProfileService and EngagementService in dev/staging\n* Error handling provides user-friendly error messages\n* Feature flag correctly toggles between Salesforce and D365 CE integration\n* Unit test coverage > 80% for shared business logic\n* UI tests pass for all feedback form workflows (happy path, error states)\n* App builds and deploys successfully to TestFlight (iOS) and Google Play Internal Testing (Android)\n\n[[wp-cs-006]]\n=== WP-CS-006: Integration Testing\n\n==== Description\n\nExecute comprehensive integration testing across all system components in non-production environments.\n\n==== Deliverables\n\n* Test environment setup\n** Salesforce sandbox configured with test data\n** ProfileService deployed to staging\n** EngagementService deployed to staging\n** Event Bus staging infrastructure\n** Braze staging environment configured\n** Mobile App TestFlight/Internal Testing builds\n* Integration test suites\n** ProfileService ↔ Salesforce (Contact upsert scenarios)\n** EngagementService ↔ Salesforce (Case creation scenarios)\n** EngagementService ↔ Braze (push notification scenarios)\n** Mobile App ↔ ProfileService ↔ EngagementService (end-to-end workflows)\n** Event Bus publishing and consumption\n** Webhook receiver (Salesforce → EngagementService)\n* Test scenarios\n** Happy path: Successful feedback submission and Case creation\n** Error scenarios: Salesforce API failures, Braze API failures, network timeouts\n** Retry scenarios: Async Case creation retries, DLQ validation\n** Performance testing: p95 latency validation for ProfileService and EngagementService\n** Load testing: Simulate 3x-10x expected volume\n* UAT execution\n** Business stakeholder UAT sessions\n** UAT test cases covering all feedback categories\n** UAT sign-off documentation\n* Test results documentation\n** Test execution reports\n** Defect tracking and resolution\n** Performance test results\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-001 (ProfileService Development) completed\n* WP-CS-002 (EngagementService Development) completed\n* WP-CS-003 (Event Bus Infrastructure) completed\n* WP-CS-005 (Mobile App Integration) completed\n* WP-CS-007 (Salesforce Configuration) sandbox configuration completed\n\n*Dependent Work Packages*:\n\n* Must complete after WP-CS-001, WP-CS-002, WP-CS-003, WP-CS-005 (requires all components available)\n\n==== Skills Required\n\n* Integration testing strategy and execution\n* Test automation frameworks (Postman, Newman, Selenium)\n* Performance testing tools (JMeter, k6, Gatling)\n* Salesforce sandbox administration\n* Test data management\n* Defect tracking and triage\n* UAT facilitation\n\n==== Acceptance Criteria\n\n* All integration test scenarios pass (happy path, error scenarios, retry scenarios)\n* Performance SLAs validated (ProfileService p95 < 300ms, EngagementService p95 < 200ms)\n* Load testing confirms system handles 3x expected volume without degradation\n* UAT sign-off obtained from business stakeholders\n* Zero critical defects (P1/P2) open before moving to Contact Migration\n* Test results documented and approved\n\n[[wp-cs-007]]\n=== WP-CS-007: Salesforce Configuration\n\n==== Description\n\nConfigure Salesforce Service Cloud for OTR digital customer support integration, including field mapping, data isolation, and webhook setup.\n\n==== Deliverables\n\n* Salesforce Contact configuration\n** Custom fields for OTR-specific data (if needed)\n** Email as external key configuration\n** Record Type for OTR digital customers (data isolation)\n** Validation rules\n* Salesforce Case configuration\n** Custom fields for feedback categories (App, Service, Order, Rewards, Refund, Delete Account)\n** Case Type and Reason picklist mapping\n** Queue assignment rules (OTR digital support queue)\n** Case escalation rules\n** Case routing rules\n* Salesforce webhook configuration\n** Platform Events / Outbound Messages for Case updates\n** Webhook authentication (API key, JWT, or OAuth)\n** Case status change triggers (New → In Progress, Resolved, Closed)\n** Webhook payload format (JSON)\n* Data isolation strategy\n** Record Types for OTR vs other Viva Energy business units\n** Queues for OTR-specific Cases\n** Reporting and dashboards scoped to OTR data\n* Salesforce API access\n** Connected App configuration\n** OAuth 2.0 JWT bearer flow setup\n** API user credentials\n** API rate limit monitoring\n* Documentation\n** Salesforce field mapping specification\n** Webhook configuration guide\n** Data isolation architecture diagram\n** API authentication setup guide\n\n==== Dependencies\n\n*Prerequisites*:\n\n* Viva Energy Salesforce admin team engagement\n* Salesforce governance approval (multi-tenant environment)\n* Technical decision on webhook mechanism (Platform Events vs Outbound Messages)\n* Technical decision on authentication method (OAuth 2.0 JWT bearer flow recommended)\n\n*Dependent Work Packages*:\n\n* None (can start in parallel with development work packages)\n* Required for WP-CS-002 (EngagementService needs field mapping)\n* Required for WP-CS-006 (Integration Testing needs sandbox configuration)\n\n==== Skills Required\n\n* Salesforce administration\n* Salesforce configuration (Record Types, Queues, Validation Rules)\n* Salesforce API integration (REST API, Platform Events, Outbound Messages)\n* Salesforce security and authentication (OAuth, Connected Apps)\n* Multi-tenant data isolation patterns\n\n==== Acceptance Criteria\n\n* Salesforce sandbox configured with all custom fields, Record Types, Queues\n* Field mapping documented and approved by OTR business stakeholders\n* Webhook configuration tested and delivering Case update notifications\n* Data isolation validated (OTR data separate from other Viva Energy business units)\n* API authentication working for ProfileService and EngagementService\n* Salesforce API rate limits monitored and acceptable for expected volume\n* Configuration replicated to Salesforce production environment\n\n[[wp-cs-008]]\n=== WP-CS-008: Contact Data Migration\n\n==== Description\n\nExecute one-time Contact migration from app-specific database to Salesforce Service Cloud production.\n\n==== Deliverables\n\n* Pre-migration activities\n** Final validation of migration tool in sandbox\n** Communication plan (notify users of maintenance window if needed)\n** Freeze app-specific database Contact updates\n** Backup app-specific database\n** Export snapshot of Salesforce Contacts (rollback preparation)\n* Migration execution\n** Execute migration tool against Salesforce production\n** Monitor migration progress\n** Handle failed upserts (manual intervention if needed)\n* Post-migration validation\n** 100% Contact reconciliation (app database vs Salesforce)\n** Email/phone/VCI matching accuracy report\n** Reconciliation report (Contacts created vs updated)\n** Data integrity checks (no duplicate Contacts, no missing Contacts)\n* ProfileService smoke testing\n** Verify Contact ID retrieval works in production\n** Test cache behavior\n** Validate Salesforce Contact upserts from ProfileService\n* Migration report\n** Total Contacts migrated\n** Contacts created vs updated\n** Failed upserts (if any) with resolution\n** Matching accuracy metrics\n** Migration execution time\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-004 (Contact Migration Tooling) completed\n* WP-CS-001 (ProfileService Development) deployed to production (not yet integrated with Mobile App)\n* WP-CS-007 (Salesforce Configuration) production configuration completed\n* Salesforce production access granted\n* Migration approved by business stakeholders\n\n*Dependent Work Packages*:\n\n* Must complete after WP-CS-001, WP-CS-004, WP-CS-007\n* Must complete before WP-CS-009 (Production Deployment)\n\n==== Skills Required\n\n* Data migration execution\n* Salesforce administration\n* Database operations\n* Data validation and reconciliation\n* Incident management (if issues arise)\n\n==== Acceptance Criteria\n\n* 100% of Contacts migrated with zero data loss\n* Email/phone/VCI matching accuracy > 95%\n* ProfileService smoke tests pass in production\n* Reconciliation report approved by business stakeholders\n* App-specific database Contact updates frozen (read-only mode)\n* Rollback procedure ready (but not executed if migration successful)\n\n[[wp-cs-009]]\n=== WP-CS-009: Production Deployment\n\n==== Description\n\nDeploy all solution components to production and execute cutover from D365 CE to Salesforce Service Cloud.\n\n==== Deliverables\n\n* Production deployment\n** EngagementService deployed to production\n** Event Bus production infrastructure validated\n** Salesforce webhook configured in production\n** Mobile App released to production (App Store, Google Play)\n* Go-live activities\n** Smoke testing (end-to-end feedback submission)\n** Feature flag enabled: `enable_salesforce_feedback_submission = ON`\n** D365 CE integration disabled in Mobile App\n** Monitor Event Bus queue depth, DLQ, Salesforce API rate limits\n** Monitor Mobile App feedback submission success rate\n* Go/No-Go decision\n** Validate success criteria before final cutover\n** Business stakeholder approval\n** Technical validation (smoke tests pass, monitoring healthy)\n* Cutover communication\n** Notify support agents of new Salesforce integration\n** Provide training materials for support agents\n** Customer communication (if visible change)\n* Rollback plan\n** Documented rollback procedure\n** Feature flag can disable Salesforce integration and re-enable D365 CE\n** Rollback decision criteria (P1/P2 incidents, feedback submission success rate < 99%)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-001 (ProfileService Development) completed\n* WP-CS-002 (EngagementService Development) completed\n* WP-CS-003 (Event Bus Infrastructure) completed\n* WP-CS-005 (Mobile App Integration) completed\n* WP-CS-006 (Integration Testing) completed with UAT sign-off\n* WP-CS-007 (Salesforce Configuration) production configuration completed\n* WP-CS-008 (Contact Data Migration) completed successfully\n* Mobile App release approval (App Store, Google Play)\n\n*Dependent Work Packages*:\n\n* Must complete after all prior work packages (final cutover)\n\n==== Skills Required\n\n* Production deployment and release management\n* Incident management and troubleshooting\n* Monitoring and observability\n* Change management and communication\n* Rollback execution (if needed)\n\n==== Acceptance Criteria\n\n* Mobile App feedback submission success rate > 99.5%\n* End-to-end flow validated (Mobile App → ProfileService → EngagementService → Salesforce Case created)\n* Braze push notifications delivered successfully\n* Event Bus queue depth normal, DLQ empty\n* No critical incidents (P1/P2) in first 24 hours\n* D365 CE integration disabled\n* Support agents successfully using Salesforce for OTR digital customer Cases\n\n=== WP-CS-010: Post-Cutover Support\n\n==== Description\n\nMonitor production stability, resolve issues, validate success criteria, and execute D365 CE retirement.\n\n==== Deliverables\n\n* Monitoring and support\n** 24/7 on-call support for first week post-cutover\n** Daily monitoring reports (feedback submission success rate, Case creation success rate)\n** Incident response and resolution\n** Performance tuning (if needed)\n* Success criteria validation\n** Validate feedback submission success rate > 99.5%\n** Monitor customer satisfaction score (target: +15% improvement within 6 months)\n** Monitor average case resolution time (target: -20% improvement within 6 months)\n** Support agent feedback survey\n* D365 CE retirement\n** D365 CE set to read-only mode (historical Case lookups only)\n** Archive D365 CE data for compliance/auditing\n** Decommission D365 CE infrastructure (after 90-day stabilization period)\n** Remove D365 CE integration code from Mobile App\n* Documentation updates\n** Production runbook\n** Troubleshooting guide (based on incidents resolved)\n** Operational procedures for support team\n** Lessons learned document\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-009 (Production Deployment) completed\n* Cutover successful with no critical incidents\n\n*Dependent Work Packages*:\n\n* Final work package in sequence\n\n==== Skills Required\n\n* Production support and incident management\n* Performance monitoring and tuning\n* Data archival and compliance\n* Infrastructure decommissioning\n* Documentation\n\n==== Acceptance Criteria\n\n* Zero critical incidents (P1/P2) in first 30 days post-cutover\n* Feedback submission success rate sustained > 99.5%\n* Customer satisfaction improvement validated (baseline established, ongoing measurement)\n* Support agents reporting positive experience with Salesforce unified view\n* D365 CE successfully decommissioned\n* All production documentation complete and approved\n* Lessons learned document published\n\n=== Work Package Sequencing\n\n==== Parallel Track 1: Infrastructure & Configuration\n\nCan start immediately and run in parallel:\n\n* WP-CS-003 (Event Bus Infrastructure)\n* WP-CS-007 (Salesforce Configuration)\n\n==== Parallel Track 2: Development\n\nCan start after Track 1 infrastructure decisions made:\n\n* WP-CS-001 (ProfileService Development) - Independent\n* WP-CS-002 (EngagementService Development) - Requires WP-CS-003 completed\n* WP-CS-004 (Contact Migration Tooling) - Requires WP-CS-001 completed (reuses code)\n\n==== Sequential Track 3: Integration & Testing\n\nMust complete after development:\n\n* WP-CS-005 (Mobile App Integration) - Requires WP-CS-001, WP-CS-002\n* WP-CS-006 (Integration Testing) - Requires WP-CS-001, WP-CS-002, WP-CS-003, WP-CS-005, WP-CS-007\n\n==== Sequential Track 4: Migration & Cutover\n\nMust complete sequentially:\n\n* WP-CS-008 (Contact Data Migration) - Requires WP-CS-001, WP-CS-004, WP-CS-006 UAT sign-off\n* WP-CS-009 (Production Deployment) - Requires all prior work packages completed\n* WP-CS-010 (Post-Cutover Support) - Requires WP-CS-009\n\n==== Critical Path\n\nThe critical path for this project is:\n\n. WP-CS-003 (Event Bus Infrastructure)\n. WP-CS-002 (EngagementService Development) - blocks on WP-CS-003\n. WP-CS-005 (Mobile App Integration) - blocks on WP-CS-001, WP-CS-002\n. WP-CS-006 (Integration Testing) - blocks on WP-CS-001 through WP-CS-005, WP-CS-007\n. WP-CS-008 (Contact Data Migration) - blocks on WP-CS-006 UAT sign-off\n. WP-CS-009 (Production Deployment) - blocks on WP-CS-008\n. WP-CS-010 (Post-Cutover Support) - final deliverable\n\nAny delays in critical path work packages will delay the overall cutover date.\n\n<<<\n== Transition Architecture\n\nThis section defines the evolution from baseline (D365 CE) to target state (Salesforce Service Cloud + ProfileService + EngagementService).\n\n=== Transition Approach\n\n*Big Bang Cutover*: Per ADR-CS-006, this transition uses a single cutover approach rather than phased rollout. All users switch from D365 CE to Salesforce simultaneously after Contact migration completion.\n\n=== Transition States\n\n==== TS-0: Baseline State (Current)\n\n===== Characteristics\n\n* D365 Customer Engagement handles all digital customer feedback\n* App-specific database stores customer Contact data\n* No ProfileService or EngagementService\n* No event-driven architecture\n* Synchronous feedback submission\n\n===== Components Active\n\n- D365 Customer Engagement\n- App-specific customer database\n- Mobile App (current version with D365 CE integration)\n\n==== TS-1: Build & Test\n\n===== Activities\n\n* Build ProfileService microservice (JIT Contact reconciliation API)\n* Build EngagementService microservice (feedback submission API, ACL for Salesforce Case creation, Braze integration, webhook receiver)\n* Implement Event Bus infrastructure (SNS+SQS/EventBridge/Kinesis)\n* Develop Contact migration tool (app database → Salesforce upsert by email/phone/VCI)\n* Update Mobile App API integration (ProfileService + EngagementService endpoints - feedback form UI already complete)\n* Integration testing (ProfileService ↔ Salesforce, EngagementService ↔ Salesforce, EngagementService ↔ Braze)\n* UAT with test Salesforce sandbox environment\n\n===== Components Active\n\n- D365 Customer Engagement (still active, unchanged)\n- App-specific customer database (still active)\n- ProfileService (non-production, testing only)\n- EngagementService (non-production, testing only)\n- Event Bus (non-production)\n- Salesforce Sandbox (testing)\n\n===== Exit Criteria\n\n- All integration tests pass\n- UAT sign-off from business stakeholders\n- Contact migration tool validated in sandbox\n- Mobile App updates tested with non-production APIs\n\n==== TS-2: Contact Migration\n\n===== Activities\n* Execute Contact migration (app database → Salesforce production)\n* Validation: 100% data integrity check (email/phone/VCI matching)\n* Reconciliation report: New Contacts created vs existing Contacts updated\n* Freeze app database Contact updates during migration window\n* ProfileService smoke testing (verify Contact lookups work in Salesforce production)\n\n===== Components Active\n- D365 Customer Engagement (still active, users unaffected)\n- Salesforce Production (Contacts migrated, no Cases yet)\n- ProfileService (production deployed, not integrated with Mobile App yet)\n- App-specific customer database (frozen, read-only)\n\n===== Exit Criteria\n- 100% of Contacts migrated with zero data loss\n- Email/phone/VCI matching accuracy > 95%\n- ProfileService smoke tests pass (JIT lookups return correct Contact IDs)\n- Reconciliation report approved\n\n==== TS-3: Cutover (Go-Live)\n\n===== Go-Live Activities\n\n* Deploy EngagementService to production\n* Deploy Mobile App updates (ProfileService + EngagementService API integration)\n* Configure Salesforce webhook (Case update notifications → EngagementService)\n* Smoke testing: End-to-end feedback submission (Mobile App → EngagementService → Salesforce → Braze notification)\n* Monitor Event Bus queue depth, dead letter queue, Salesforce API rate limits\n* **Go/No-Go decision**: Validate success criteria before final cutover\n* Enable feature flag: `enable_salesforce_feedback_submission = ON`\n* Disable D365 CE integration in Mobile App\n\n===== Components Active\n\n- ProfileService (production, integrated with Mobile App)\n- EngagementService (production, integrated with Mobile App)\n- Event Bus (production, processing async Case creation)\n- Salesforce Production (receiving Cases from digital customers)\n- Braze (sending push notifications)\n- Mobile App (new version with Salesforce integration)\n- D365 Customer Engagement (disabled, read-only for historical lookups)\n\n===== Exit Criteria\n\n- Mobile App feedback submission success rate > 99.5%\n- End-to-end flow validated (Mobile App → Salesforce Case created)\n- Braze push notifications delivered successfully\n- Event Bus queue depth normal, DLQ empty\n- No critical incidents (P1/P2) in first 24 hours\n\n==== TS-4: Target State (Stable Production)\n\n===== Characteristics\n\n* ProfileService and EngagementService fully operational\n* All digital customer feedback routed to Salesforce\n* Event-driven architecture established\n* D365 CE decommissioned\n* First DDD bounded contexts implemented successfully\n\n===== Monitoring Period\n\n* Validate success criteria: feedback submission rate > 99.5%, no data loss\n* Monitor customer satisfaction score (target: +15% improvement)\n* Monitor average case resolution time (target: -20% improvement)\n* Support agents using unified Salesforce view across all channels\n\n===== D365 CE Retirement\n\n* D365 CE read-only access for historical Case lookups (if needed)\n* Decommission D365 CE infrastructure after 90 days\n* Archive D365 CE data for compliance/auditing\n\n===== Components Active\n\n- ProfileService (production)\n- EngagementService (production)\n- Event Bus (production)\n- Salesforce Production (system of record)\n- Braze (push notifications)\n- Mobile App (Salesforce integration)\n- App-specific database (deprecated, Contact data no longer updated)\n\n===== Success Criteria Achieved\n\n- All digital customer feedback routed to Salesforce\n- Support agents have unified customer view\n- D365 CE decommissioned\n- Customer satisfaction improved by 15%\n- Average case resolution time decreased by 20%\n- Zero data loss during transition\n\n=== Transition Dependencies\n\n[width=\"100%\",cols=\"40%,60%\",options=\"header\",]\n|===\n|Dependency |Owner/Status\n\n|*Salesforce production access*\n|Viva Energy Salesforce admin team - TBD\n\n|*Salesforce Case field mapping*\n|Viva Energy Salesforce admin team - TBD (map OTR feedback categories to Salesforce fields)\n\n|*Salesforce data isolation strategy*\n|Viva Energy Salesforce admin team - TBD (Record Types, queues, custom fields)\n\n|*Salesforce webhook configuration*\n|Viva Energy Salesforce admin team - TBD (Outbound Messages vs Platform Events)\n\n|*Event Bus infrastructure*\n|OTR Platform team - Existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis)\n\n|*Braze integration*\n|OTR Marketing team - Existing Braze account, EngagementService creates new campaigns\n\n|*Mobile App release window*\n|OTR Mobile team - Coordinate cutover timing with app release schedule\n\n|*App database access*\n|OTR Platform team - Read access for Contact migration\n\n|===\n\n=== Transition Validation Criteria\n\n==== Contact Migration Validation\n\n* 100% of app database Contacts migrated to Salesforce (zero data loss)\n* Email/phone/VCI matching accuracy > 95% (minimize duplicate Contacts)\n* ProfileService JIT lookups return correct Salesforce Contact IDs (smoke test sample)\n* Reconciliation report shows: X new Contacts created, Y existing Contacts updated\n\n==== Cutover Validation\n\n* Mobile App feedback submission success rate > 99.5% (including async Case creation)\n* End-to-end flow validated: Mobile App → ProfileService → EngagementService → Salesforce Case created\n* Braze push notifications delivered for Case creation and Case resolution\n* Event Bus queue depth within normal range (no backlog)\n* Dead letter queue empty (no failed Case creations)\n* Salesforce API rate limits not exceeded\n\n==== Production Monitoring (30 days)\n\n* Customer satisfaction score improves by 15% (compared to D365 CE baseline)\n* Average case resolution time decreases by 20% (Salesforce vs D365 CE)\n* Support agents confirm unified customer view across all channels\n* Zero critical incidents (P1 outages, data loss)\n\n=== Rollback Plan\n\n==== Rollback Triggers\n\n* Feedback submission success rate < 95% (below acceptable threshold)\n* Data loss or corruption detected in Salesforce\n* Salesforce API rate limits exceeded (Cases not created within SLA)\n* Critical bug blocking customer feedback submission\n\n==== Rollback Procedure\n\n1. **Revert Mobile App** to previous version (remove ProfileService/EngagementService integration, restore D365 CE integration)\n2. **Stop EngagementService** Case creation (prevent duplicate Cases in Salesforce)\n3. **Re-enable D365 CE** for customer feedback submission\n4. **Investigate root cause** (EngagementService logs, Salesforce API errors, Event Bus queue issues)\n5. **Fix and re-test** in sandbox environment\n6. **Retry cutover** when issues resolved\n\n==== Rollback Limitations\n\n* Cases created in Salesforce during cutover period remain in Salesforce (no reverse migration)\n* Contacts migrated to Salesforce remain (no rollback to app database)\n* Rollback only affects Mobile App integration (not data migration)\n\n=== Architectural Scope Boundaries\n\n==== Capabilities Included\n\n===== Business Capabilities\n\n* **Customer Feedback Submission**: Mobile App users can submit structured feedback (Category, Store Name, Time of Visit, Phone, Free Text Message) via EngagementService\n* **Customer Contact Management**: Just-In-Time (JIT) Contact reconciliation with Salesforce via ProfileService, ensuring every Mobile App user has a Salesforce Contact record\n* **Case Management Integration**: EngagementService creates Salesforce Cases asynchronously for customer feedback, support agents manage Cases in Salesforce Service Cloud\n* **Customer Notifications**: Push notifications via Braze when Cases are created, updated, or resolved (bidirectional integration: Mobile App → Salesforce → Mobile App)\n* **Unified Customer View**: Support agents see OTR digital customer feedback alongside other Viva Energy channels (fuel wholesale, Shell Card, retail) in single Salesforce instance\n* **Contact Data Migration**: One-time migration of app-specific customer database Contacts to Salesforce with upsert logic (email/phone/VCI matching)\n\n===== Technical Capabilities\n\n* **ProfileService Bounded Context**: First DDD bounded context implementation - JIT Contact reconciliation, Salesforce API facade, foundation for Flybuys integration\n* **EngagementService Bounded Context**: First DDD bounded context implementation - Customer feedback submission BFF, Anti-Corruption Layer for Salesforce, Braze integration orchestration\n* **Event-Driven Architecture**: Domain event publishing via Event Bus (SNS+SQS/EventBridge/Kinesis) for `SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted` events\n* **Async Processing Pattern**: Non-blocking Case creation with retry logic, exponential backoff, dead letter queue for operational resilience\n* **Anti-Corruption Layer Pattern**: EngagementService protects digital channels from Salesforce API changes, translates between OTR domain language and Salesforce\n* **Conformist Pattern**: ProfileService and EngagementService conform to existing Salesforce configuration (shared Viva Energy instance, multi-tenant governance)\n* **Salesforce Integration**: REST API integration for Contact CRUD and Case creation, webhook receiver for Case update notifications\n* **Braze Integration**: Push notification campaign triggers for Case lifecycle events (created, updated, resolved)\n* **Observability & Monitoring**: Dashboards, metrics, alerting for feedback submission rate, queue depth, API errors, Case creation latency\n* **Feature Flag Management**: Kill switches for emergency rollback (enable_salesforce_feedback_submission, enable_async_case_creation, etc.)\n\n==== Capabilities Excluded\n\n===== Business Capabilities Explicitly Out of Scope\n\n* **Historical Case Migration**: D365 CE Cases not migrated to Salesforce (ADR-CS-005 - fresh start, no Case migration)\n* **Multi-Channel Feedback Submission**: Web app, POS, call centre, email feedback channels not included (Mobile App only in this phase)\n* **Case Resolution by Digital Channels**: Support agents resolve Cases in Salesforce, not via Mobile App self-service\n* **Knowledge Base Integration**: Salesforce Knowledge Base articles not surfaced in Mobile App (future enhancement)\n* **Live Chat/Messaging**: Real-time chat support not included (Salesforce omnichannel capabilities not activated)\n* **Sentiment Analysis**: Automated feedback sentiment analysis not included (future enhancement with AI/ML)\n* **Customer Satisfaction Surveys**: Post-resolution CSAT surveys not included (separate initiative)\n* **Case Attachments**: Mobile App feedback submission does not support file uploads (photos, receipts) - text only\n* **Agent Desktop Integration**: Custom Salesforce UI for support agents not included (use standard Salesforce Service Console)\n* **Social Media Feedback**: Facebook, Twitter, Instagram feedback channels not integrated\n\n===== Technical Capabilities Explicitly Out of Scope\n\n* **Event Sourcing**: Domain events are ephemeral (not persisted for event sourcing/replay) - Event Bus only, no Event Store\n* **CQRS (Command Query Responsibility Segregation)**: ProfileService and EngagementService use same data model for reads/writes (no separate read models)\n* **Local Aggregate Persistence**: ProfileService and EngagementService are stateless (Salesforce is System of Record, no local database for Contact/Case)\n* **Saga Orchestration**: No distributed transactions or saga patterns required (single-step Case creation, not multi-step workflow)\n* **API Gateway Advanced Features**: Rate limiting, API versioning, API key management deferred to detailed design (basic routing only)\n* **GraphQL API**: ProfileService and EngagementService expose REST APIs only (GraphQL not required)\n* **Real-Time Sync**: Salesforce Contact updates by support agents not synced back to ProfileService (eventual consistency acceptable via JIT reconciliation)\n* **Multi-Region Deployment**: Single AWS region deployment (no multi-region failover/disaster recovery in this phase)\n* **Blue-Green Deployment**: Big bang cutover (ADR-CS-006), not blue-green or canary deployment strategy\n* **A/B Testing Framework**: Feature flags for rollback only, not for A/B testing or experimentation\n* **Custom Authentication**: Microsoft Entra External ID used for Mobile App authentication (no custom authentication logic in ProfileService/EngagementService)\n* **Data Residency Compliance**: Salesforce data residency governed by Viva Energy Salesforce configuration (no OTR-specific data residency requirements)\n\n===== Future Bounded Contexts Not in Scope\n\n* **LoyaltyService**: Flybuys integration, reward preferences, transaction adjudication (separate initiative)\n* **LocationService**: Store finder, proximity features, geofencing (separate initiative)\n* **PaymentService**: Payment processing, subscription billing (separate initiative)\n* **RecommendationService**: Personalized recommendations, next-best offers (separate initiative)\n\n===== Integration Patterns Not in Scope\n\n* **Shared Kernel**: No shared domain model between ProfileService and EngagementService (separate bounded contexts with clear boundaries)\n* **Partnership**: No joint development or coordination with external teams (Conformist pattern - we conform to Salesforce)\n* **Customer-Supplier (we're upstream)**: No downstream systems depend on ProfileService/EngagementService APIs yet (future bounded contexts will consume domain events)\n\n==== Architectural Dependencies on Future Initiatives\n\n*This Architecture Enables Future Initiatives*:\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Future Initiative |Architectural Enablement\n\n|*Flybuys Integration*\n|**ProfileService Contact Reconciliation Reused**: ProfileService establishes pattern for JIT Contact reconciliation with Salesforce, which will be extended for Flybuys partner linking (link:../architecture_definitions/flybuys_integration.adoc[see Flybuys Integration architecture]) +\n**Event Bus Infrastructure**: Domain event publishing pattern (`CustomerEnrolledInLoyalty`, `PartnerLinked`, etc.) reuses Event Bus established for EngagementService\n\n|*LoyaltyService Bounded Context*\n|**Event Bus Subscription**: LoyaltyService will consume `CustomerProfileCreated` events published by ProfileService (future enhancement) +\n**Salesforce Contact Integration**: LoyaltyService may query Salesforce Contacts for customer reward preferences (via ProfileService facade or direct Salesforce API)\n\n|*Web App Feedback Submission*\n|**EngagementService API Reuse**: Web app will call same EngagementService REST API for feedback submission (multi-channel support) +\n**Conformist Pattern**: Web app conforms to EngagementService API contract (no translation required)\n\n|*Multi-Channel Customer Support*\n|**EngagementService Extension**: Add support for email, call centre, POS feedback channels (extend EngagementService to handle multiple origins) +\n**Salesforce Case Origin Field**: Cases already tagged with Origin=Mobile App, extend to Origin=Web, POS, Call Centre, Email\n\n|*Knowledge Base Integration*\n|**EngagementService API Extension**: Add endpoint to query Salesforce Knowledge Base articles, surface in Mobile App for self-service support +\n**Anti-Corruption Layer**: EngagementService translates Salesforce Knowledge API to OTR domain language\n\n|*Customer Satisfaction Surveys*\n|**Event-Driven Trigger**: Subscribe to `SupportCaseResolved` events published by EngagementService, trigger CSAT survey via Braze +\n**Braze Integration Pattern**: Reuse EngagementService → Braze integration pattern for survey campaigns\n\n|*Sentiment Analysis*\n|**Event Subscription**: Subscribe to `CustomerFeedbackSubmitted` events, analyse feedback sentiment (AI/ML service) +\n**EngagementService Extension**: Enrich Case with sentiment score before creating in Salesforce\n\n|*RecommendationService Bounded Context*\n|**Event Subscription**: RecommendationService subscribes to `SupportCaseCreated` events to understand customer pain points and personalize recommendations +\n**Domain Event Pattern**: Reuse Event Bus publishing pattern established by EngagementService\n\n|===\n\n*This Architecture Depends on Future Initiatives*:\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Future Initiative |Dependency Description\n\n|*Salesforce Data Isolation Strategy*\n|**BLOCKER**: Viva Energy Salesforce admin team must define data isolation strategy (Record Types, custom fields, queues) before production deployment +\n**Impact**: Multi-tenant data visibility and security governance\n\n|*Salesforce Case Field Mapping*\n|**BLOCKER**: Viva Energy Salesforce admin team must define field mapping for OTR feedback categories (App, Service, Order, Rewards, Refund, Delete Account) +\n**Impact**: Case creation logic in EngagementService depends on finalized Salesforce schema\n\n|*Salesforce Webhook Mechanism*\n|**BLOCKER**: Viva Energy Salesforce admin team must configure webhook mechanism (Outbound Messages vs Platform Events vs Process Builder) for Case update notifications +\n**Impact**: EngagementService webhook receiver implementation depends on chosen mechanism\n\n|*Event Bus Technology Selection*\n|**DECISION REQUIRED**: Choose Event Bus implementation (SNS+SQS vs EventBridge vs Kinesis) for domain event publishing +\n**Impact**: Infrastructure provisioning, event schema design, consumer implementation\n\n|*Microservice Hosting Platform*\n|**DECISION REQUIRED**: Choose hosting platform for ProfileService and EngagementService (AWS Lambda vs ECS vs EKS) +\n**Impact**: Deployment architecture, auto-scaling strategy, operational overhead\n\n|*Observability Platform*\n|**DECISION REQUIRED**: Choose observability platform (AWS CloudWatch vs Datadog vs New Relic) for monitoring and alerting +\n**Impact**: Dashboard configuration, metric collection, alerting setup\n\n|===\n\n*Future Work After This Initiative*:\n\n* **Event Schema Registry**: Implement event schema versioning and registry for domain events (currently ad-hoc schemas)\n* **API Versioning Strategy**: Define API versioning approach for ProfileService and EngagementService (currently v1 only)\n* **Multi-Region Deployment**: Extend to multi-region for disaster recovery and global availability\n* **Event Store**: Persist domain events for event sourcing and audit trail (currently ephemeral Event Bus only)\n* **CQRS Pattern**: Separate read models for high-volume queries (currently same model for reads/writes)\n* **GraphQL API**: Expose GraphQL API for flexible client queries (currently REST only)\n* **Real-Time Sync**: Bi-directional sync between Salesforce and ProfileService for Contact updates (currently JIT reconciliation only)\n\n=== Technical Risks and Mitigation\n\n[width=\"100%\",cols=\"5%,20%,25%,25%,25%\",options=\"header\",]\n|===\n|ID |Risk |Impact |Likelihood |Mitigation\n\n|RISK-CS-001\n|*Salesforce API rate limits exceeded*: High feedback volume exceeds Salesforce API limits, Cases not created\n|HIGH (customers don't receive Case confirmation, support tickets lost)\n|MEDIUM (volume unknown, rate limits TBD)\n|• Gather expected feedback volume data before cutover +\n• Implement Event Bus queue throttling/rate limiting +\n• Monitor queue depth and API usage +\n• Scale background workers based on queue depth +\n• Alert ops team when approaching rate limits\n\n|RISK-CS-002\n|*Salesforce downtime*: Salesforce Service Cloud outage prevents Case creation\n|MEDIUM (Cases delayed but queued, customers wait for confirmation)\n|LOW (Salesforce SLA 99.9% uptime)\n|• Async Case creation with retry logic +\n• Event Bus queues buffer work during outage +\n• Customers get immediate \"Feedback submitted\" (not blocked) +\n• Monitor Salesforce status page, alert ops team +\n• Automatic retry when Salesforce recovers\n\n|RISK-CS-003\n|*Contact migration data quality issues*: App database Contact data incomplete or invalid\n|HIGH (migration fails validation, cutover delayed)\n|MEDIUM (legacy data quality unknown)\n|• Pre-migration data quality assessment +\n• Flexible upsert logic (match by email/phone/VCI) +\n• Validation report identifies data issues before production migration +\n• Manual cleanup for invalid records +\n• Dry-run migration in sandbox environment\n\n|RISK-CS-004\n|*Duplicate Contacts created*: Email matching fails, ProfileService creates duplicate Contacts\n|MEDIUM (support agents see multiple profiles for same customer)\n|MEDIUM (email changes, data quality issues)\n|• Salesforce duplicate detection rules (if available) +\n• ProfileService logs Contact creation for audit trail +\n• Manual duplicate cleanup process (support team) +\n• Future enhancement: VCI as Salesforce External ID for stable matching\n\n|RISK-CS-005\n|*Dead letter queue accumulation*: Failed Case creations not processed, queue grows\n|HIGH (customers don't receive Case confirmation, feedback lost)\n|LOW (retry logic handles most failures)\n|• Dead letter queue monitoring and alerting +\n• Ops team dashboard showing DLQ depth +\n• Manual intervention process (investigate and reprocess) +\n• Automated alerts when DLQ depth exceeds threshold +\n• Root cause analysis for recurring failures\n\n|RISK-CS-006\n|*Salesforce webhook failures*: Salesforce can't deliver Case update notifications to EngagementService\n|MEDIUM (customers don't get push notifications for Case resolution)\n|LOW (webhook mechanism reliable)\n|• Webhook retry logic and exponential backoff +\n• EngagementService logs webhook deliveries +\n• Monitor webhook delivery success rate +\n• Fallback: Poll Salesforce API for Case updates (if webhook fails persistently) +\n• Alert ops team when webhook delivery rate drops\n\n|RISK-CS-007\n|*Multi-tenant data isolation breach*: OTR digital Cases visible to other Viva Energy support teams\n|HIGH (privacy violation, compliance risk)\n|LOW (Salesforce governance controls)\n|• Work with Viva Energy Salesforce admin team on data isolation strategy +\n• Test data visibility in Salesforce sandbox (UAT with different user roles) +\n• Validate Record Types, queues, field-level security before production +\n• Audit Salesforce user permissions and sharing rules\n\n|RISK-CS-008\n|*Mobile App release coordination*: App release delayed, cutover window missed\n|MEDIUM (cutover delayed, D365 CE retirement delayed)\n|MEDIUM (release schedule conflicts)\n|• Coordinate cutover timing with Mobile team early +\n• Buffer time in migration plan (2-week contingency) +\n• Decouple backend deployment from Mobile App release (backend deployed first, app follows) +\n• Feature flag for feedback submission (enable when ready)\n\n|RISK-CS-009\n|*Event Bus infrastructure issues*: SNS/SQS/EventBridge downtime or misconfiguration\n|HIGH (Case creation blocked, domain events not published)\n|LOW (AWS SLA 99.99% uptime)\n|• Leverage existing AWS infrastructure (proven, reliable) +\n• Infrastructure as Code (IaC) for Event Bus configuration +\n• Integration testing in non-production environment +\n• Monitor Event Bus metrics (queue depth, throughput, errors) +\n• Alert ops team on Event Bus failures\n\n|RISK-CS-010\n|*Team DDD knowledge gap*: Team unfamiliar with DDD patterns, bounded contexts, event-driven architecture\n|MEDIUM (implementation delays, architectural inconsistencies)\n|HIGH (first DDD implementation)\n|• DDD training for development team (workshops, documentation) +\n• Architecture review sessions (validate bounded context design) +\n• Pair programming with experienced DDD practitioners +\n• Incremental implementation (start small, iterate) +\n• Document architectural patterns in CLAUDE.md\n\n|===\n\n== Assumptions and Constraints\n\n=== Assumptions\n\n[width=\"100%\",cols=\"8%,92%\",options=\"header\",]\n|===\n|ID |Assumption\n\n|ASM-CS-001\n|Viva Energy Salesforce admin team will provide Salesforce production access, sandbox environment, and support for Case field mapping and data isolation configuration\n\n|ASM-CS-002\n|App database Contact data is sufficiently complete for migration (email/phone/VCI available for matching)\n\n|ASM-CS-003\n|Expected customer feedback volume (100-150 submissions/day from 20k DAU) is well within Salesforce API rate limits, with capacity planning for 3x-10x growth\n\n|ASM-CS-004\n|Existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis) is sufficient for Event Bus implementation (no additional infrastructure provisioning required)\n\n|ASM-CS-005\n|Braze integration already exists and can be extended for Case-related push notifications (no new Braze account or major configuration changes)\n\n|ASM-CS-006\n|Mobile App users have email addresses associated with their accounts (required for ProfileService Contact reconciliation)\n\n|ASM-CS-007\n|D365 Customer Engagement historical Cases have limited business value and do not require migration to Salesforce\n\n|ASM-CS-008\n|Support agents are trained on Salesforce Service Cloud and require minimal additional training for OTR digital customer Cases\n\n|ASM-CS-009\n|Salesforce Service Cloud shared instance has capacity for OTR digital customer Contacts and Cases (no additional licensing or storage costs)\n\n|ASM-CS-010\n|Mobile App release schedule can accommodate cutover timing (Week 10 in migration plan)\n\n|===\n\n=== Constraints\n\n[width=\"100%\",cols=\"8%,92%\",options=\"header\",]\n|===\n|ID |Constraint\n\n|CON-CS-001\n|Must use shared Viva Energy Salesforce Service Cloud instance (cannot deploy separate OTR-specific instance)\n\n|CON-CS-002\n|Must conform to existing Salesforce configuration and governance (Record Types, custom fields, queues, data isolation strategy defined by Viva Energy admin team)\n\n|CON-CS-003\n|Contact migration must complete before Mobile App cutover (no parallel run of D365 CE and Salesforce)\n\n|CON-CS-004\n|Big bang cutover only (no phased rollout with feature flags or pilot users)\n\n|CON-CS-005\n|Salesforce API rate limits and authentication method constrained by Viva Energy Salesforce configuration (TBD)\n\n|CON-CS-006\n|Event Bus implementation must use existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis - cannot introduce new infrastructure components)\n\n|CON-CS-007\n|Mobile App feedback form must include specific fields: Category, Store Name, Time of Visit, Contact Phone Number, Free Text Message (no attachments)\n\n|CON-CS-008\n|D365 Customer Engagement must be decommissioned within 90 days post-cutover (ADR-CS-006)\n\n|CON-CS-009\n|ProfileService and EngagementService must be stateless (no local aggregate persistence, Salesforce is System of Record)\n\n|CON-CS-010\n|First DDD bounded context implementation (team learning curve, architectural patterns must be documented for future bounded contexts)\n\n|===\n\n== Non-Functional Requirements\n\n=== Performance Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-PERF-001\n|Mobile App feedback submission API response time (ProfileService + EngagementService)\n|p95 < 1 second, p99 < 2 seconds\n\n|NFR-PERF-002\n|ProfileService Contact reconciliation API response time (JIT lookup)\n|p95 < 500ms, p99 < 1 second\n\n|NFR-PERF-003\n|EngagementService async Case creation latency (end-to-end: feedback submitted → Case created in Salesforce)\n|p95 < 5 minutes, p99 < 10 minutes\n\n|NFR-PERF-004\n|Salesforce API call latency (Contact query, Contact create, Case create)\n|p95 < 2 seconds, p99 < 5 seconds\n\n|NFR-PERF-005\n|Event Bus message processing throughput\n|> 100 messages/second (support peak feedback volume)\n\n|NFR-PERF-006\n|Braze push notification delivery latency (Case created → notification delivered)\n|p95 < 30 seconds, p99 < 60 seconds\n\n|===\n\n=== Availability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-AVAIL-001\n|ProfileService availability\n|99.9% uptime (8.76 hours downtime/year)\n\n|NFR-AVAIL-002\n|EngagementService availability\n|99.9% uptime (8.76 hours downtime/year)\n\n|NFR-AVAIL-003\n|Feedback submission success rate (including async Case creation)\n|> 99.5% (includes retry logic for transient failures)\n\n|NFR-AVAIL-004\n|Graceful degradation: Salesforce downtime handling\n|Feedback submission still succeeds, Cases queued for async creation when Salesforce recovers\n\n|NFR-AVAIL-005\n|Graceful degradation: Braze downtime handling\n|Case creation proceeds, push notifications disabled temporarily (feature flag)\n\n|NFR-AVAIL-006\n|Planned maintenance window\n|< 4 hours/month, scheduled during low-traffic periods (2-6am ACST)\n\n|===\n\n=== Scalability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-SCALE-001\n|Concurrent Mobile App users (peak)\n|Support 20,000 DAU (Daily Active Users), ~150 concurrent users submitting feedback during peak hours\n\n|NFR-SCALE-002\n|Feedback submissions per day\n|Expected: 100-150 submissions/day based on 20k DAU (~0.5-0.75% submission rate) +\nCapacity: Support 500 submissions/day (3x expected volume for growth), 2,000 submissions/day (peak/incident scenarios)\n\n|NFR-SCALE-003\n|Auto-scaling: ProfileService and EngagementService\n|Auto-scale based on CPU/memory/request rate, scale up within 2 minutes\n\n|NFR-SCALE-004\n|Event Bus queue capacity\n|Support 100,000 queued messages (buffer for Salesforce downtime)\n\n|NFR-SCALE-005\n|Salesforce API rate limit compliance\n|Stay within 80% of Salesforce API rate limits (buffer for spikes)\n\n|NFR-SCALE-006\n|Future growth capacity\n|Architecture supports 10x growth (1,000-1,500 submissions/day based on 200k DAU) without major redesign\n\n|===\n\n=== Security Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-SEC-001\n|Mobile App authentication\n|Microsoft Entra External ID OAuth 2.0 with JWT tokens (existing CIAM)\n\n|NFR-SEC-002\n|API authorisation: ProfileService and EngagementService\n|JWT token validation, authenticated users only, user context propagation\n\n|NFR-SEC-003\n|Salesforce API authentication\n|OAuth 2.0 with Connected App and JWT bearer flow (service account)\n\n|NFR-SEC-004\n|Data encryption in transit\n|TLS 1.2+ for all API calls (Mobile App ↔ ProfileService/EngagementService ↔ Salesforce ↔ Braze)\n\n|NFR-SEC-005\n|Data encryption at rest\n|Salesforce encryption at rest (managed by Salesforce), Event Bus message encryption (AWS KMS)\n\n|NFR-SEC-006\n|Secret management\n|AWS Secrets Manager for Salesforce credentials, Braze API keys, OAuth tokens (no hardcoded secrets)\n\n|NFR-SEC-007\n|PII data handling\n|Contact data (email, phone, name) treated as PII, GDPR-compliant retention policies (Salesforce governance)\n\n|NFR-SEC-008\n|API rate limiting and throttling\n|API Gateway rate limiting (100 requests/second per user), prevent abuse and DoS\n\n|NFR-SEC-009\n|Logging and auditing\n|Log all API calls, Salesforce Contact/Case creates/updates, Event Bus publishes (no PII in logs)\n\n|NFR-SEC-010\n|Salesforce data isolation\n|Multi-tenant data isolation via Salesforce Record Types, queues, sharing rules (defined by Viva Energy admin team)\n\n|===\n\n=== Reliability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-REL-001\n|Retry logic: EngagementService → Salesforce Case creation\n|Exponential backoff (1s, 2s, 4s, 8s, 16s), max 5 retries, then dead letter queue\n\n|NFR-REL-002\n|Dead letter queue monitoring\n|Alert ops team immediately when DLQ depth > 0 (failed Case creations require manual intervention)\n\n|NFR-REL-003\n|Event Bus message durability\n|Messages persisted in Event Bus (SNS+SQS/EventBridge/Kinesis), not lost on service restart\n\n|NFR-REL-004\n|Idempotency: Case creation\n|EngagementService ensures duplicate feedback submissions don't create duplicate Cases (idempotency key)\n\n|NFR-REL-005\n|Circuit breaker: Salesforce API calls\n|Open circuit after 5 consecutive failures, half-open retry after 30 seconds\n\n|NFR-REL-006\n|Health checks: ProfileService and EngagementService\n|Health endpoints for load balancer checks, readiness and liveness probes\n\n|NFR-REL-007\n|Disaster recovery: Event Bus\n|Event Bus messages replicated across AWS availability zones (SQS/EventBridge/Kinesis HA)\n\n|===\n\n=== Maintainability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-MAINT-001\n|Code quality: ProfileService and EngagementService\n|> 80% test coverage (unit + integration tests), automated CI/CD pipeline\n\n|NFR-MAINT-002\n|API documentation\n|OpenAPI/Swagger specs for ProfileService and EngagementService, auto-generated API docs\n\n|NFR-MAINT-003\n|Deployment automation\n|Infrastructure as Code (Terraform/CloudFormation/CDK), zero-downtime deployments\n\n|NFR-MAINT-004\n|Logging: structured logs\n|JSON-formatted logs with correlation IDs, log levels (DEBUG, INFO, WARN, ERROR), centralized log aggregation\n\n|NFR-MAINT-005\n|Monitoring dashboards\n|Real-time dashboards for ProfileService, EngagementService, Event Bus (see Monitoring and Observability section)\n\n|NFR-MAINT-006\n|Alerting and on-call\n|PagerDuty/Opsgenie integration for P1/P2 alerts, on-call rotation for ops team\n\n|NFR-MAINT-007\n|Configuration management\n|Externalized configuration (environment variables, AWS Parameter Store), no hardcoded config\n\n|NFR-MAINT-008\n|Versioning: API and events\n|Semantic versioning (v1, v2), backward compatibility for API changes, event schema evolution\n\n|===\n\n=== Usability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-USE-001\n|Feedback submission UX\n|Mobile App user receives immediate \"Feedback submitted\" confirmation (< 1 second), not blocked by async Case creation\n\n|NFR-USE-002\n|Push notification delivery\n|Customer receives \"Your feedback has been received\" notification within 30 seconds of Case creation in Salesforce\n\n|NFR-USE-003\n|Case resolution notification\n|Customer receives \"Your case has been resolved\" notification within 30 seconds of support agent resolving Case\n\n|NFR-USE-004\n|Error messaging\n|User-friendly error messages for failed feedback submission (not technical errors), retry prompts\n\n|NFR-USE-005\n|Accessibility\n|Mobile App feedback form meets WCAG 2.1 AA accessibility standards (existing Mobile App compliance)\n\n|===\n\n=== Compliance Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-COMP-001\n|GDPR compliance: PII data\n|Customer Contact data (email, phone, name) managed per GDPR retention policies (Salesforce governance)\n\n|NFR-COMP-002\n|GDPR compliance: Right to erasure\n|Support \"Delete Account\" feedback category, trigger Contact deletion in Salesforce per GDPR Article 17\n\n|NFR-COMP-003\n|Data residency\n|Salesforce data residency governed by Viva Energy Salesforce configuration (regional compliance)\n\n|NFR-COMP-004\n|Audit trail\n|All Contact creates/updates, Case creates/updates logged for compliance auditing (Salesforce audit logs)\n\n|NFR-COMP-005\n|API security standards\n|OWASP API Security Top 10 compliance (injection prevention, authentication, authorisation, data exposure)\n\n|===\n\n== Monitoring and Observability\n\n=== Key Metrics\n\n[width=\"100%\",cols=\"25%,40%,35%\",options=\"header\",]\n|===\n|Metric Category |Metric |Target/Threshold\n\n|*Feedback Submission*\n|Feedback submission success rate (Mobile App → EngagementService)\n|> 99.5%\n\n|*Async Case Creation*\n|Case creation success rate (EngagementService → Salesforce)\n|> 99%\n\n|*Async Case Creation*\n|Case creation latency (time from feedback submission to Case created in Salesforce)\n|p95 < 5 minutes\n\n|*Event Bus*\n|Event Bus queue depth (pending Case creations)\n|< 100 messages\n\n|*Event Bus*\n|Dead letter queue depth (failed Case creations)\n|= 0 (alert on any failures)\n\n|*Salesforce API*\n|Salesforce API error rate\n|< 1%\n\n|*Salesforce API*\n|Salesforce API latency (Case creation)\n|p95 < 2 seconds\n\n|*Salesforce API*\n|Salesforce API rate limit utilization\n|< 80% of limit\n\n|*ProfileService*\n|Contact reconciliation success rate (JIT lookups)\n|> 99.5%\n\n|*ProfileService*\n|Contact reconciliation latency\n|p95 < 500ms\n\n|*Braze Notifications*\n|Push notification delivery rate (Case created/updated)\n|> 95%\n\n|*Salesforce Webhook*\n|Webhook delivery success rate (Salesforce → EngagementService)\n|> 99%\n\n|*Customer Satisfaction*\n|Customer satisfaction score (CSAT)\n|> 4.0/5.0 (improve by 15% from D365 CE baseline)\n\n|*Support Operations*\n|Average case resolution time\n|Decrease by 20% from D365 CE baseline\n\n|===\n\n=== Alerting Thresholds\n\n[width=\"100%\",cols=\"25%,50%,25%\",options=\"header\",]\n|===\n|Alert |Condition |Severity\n\n|*Feedback submission failures*\n|Feedback submission success rate < 95% over 5-minute window\n|P1 - Critical\n\n|*Dead letter queue accumulation*\n|Dead letter queue depth > 0 (any failed Case creations)\n|P2 - High\n\n|*Event Bus queue backlog*\n|Event Bus queue depth > 100 messages for > 15 minutes\n|P2 - High\n\n|*Salesforce API errors*\n|Salesforce API error rate > 5% over 5-minute window\n|P1 - Critical\n\n|*Salesforce API rate limits*\n|Salesforce API rate limit utilization > 90%\n|P2 - High\n\n|*Contact reconciliation failures*\n|ProfileService Contact reconciliation failure rate > 5% over 5-minute window\n|P2 - High\n\n|*Braze notification failures*\n|Braze push notification delivery rate < 80% over 15-minute window\n|P3 - Medium\n\n|*Salesforce webhook failures*\n|Salesforce webhook delivery success rate < 90% over 15-minute window\n|P2 - High\n\n|*Case creation latency*\n|Case creation latency p95 > 10 minutes\n|P3 - Medium\n\n|===\n\n=== Dashboards\n\n*ProfileService Dashboard:*\n\n* Contact reconciliation success rate (JIT lookups)\n* Contact reconciliation latency (p50, p95, p99)\n* Contact creation vs update ratio (new Contacts created vs existing Contacts updated)\n* Salesforce API error rate (Contact queries and creates)\n* Request rate and throughput\n\n*EngagementService Dashboard:*\n\n* Feedback submission success rate\n* Case creation success rate (async workflow)\n* Case creation latency (p50, p95, p99)\n* Event Bus queue depth (pending Case creations)\n* Dead letter queue depth (failed Case creations)\n* Salesforce API error rate (Case creation)\n* Salesforce API latency\n* Salesforce API rate limit utilization\n* Braze push notification delivery rate\n* Salesforce webhook delivery success rate\n\n*Event Bus Dashboard:*\n\n* Queue depth (pending messages)\n* Throughput (messages published/consumed per minute)\n* Dead letter queue depth (failed messages)\n* Consumer lag (time between publish and consume)\n\n*Customer Support Dashboard (Business Metrics):*\n\n* Total feedback submissions per day/week/month\n* Feedback category breakdown (App, Service, Order, Rewards, Refund, Delete Account)\n* Customer satisfaction score (CSAT) trend\n* Average case resolution time trend\n* Case volume by support team/queue\n* Unified customer view adoption (support agent feedback)\n<<<\n== Solution Validation\n\nThis section defines the validation criteria and testing approach for the solution.\n\n=== Functional Validation\n\n==== ProfileService API Testing\n\n*Test Scenarios*:\n1. **Happy Path**: Authenticated user requests Contact ID, existing Contact found in Salesforce, Contact ID returned\n2. **JIT Creation**: Authenticated user requests Contact ID, no existing Contact, new Contact created in Salesforce, Contact ID returned\n3. **Salesforce API Failure**: Salesforce unavailable, ProfileService returns 500 error, user retries\n4. **Invalid JWT**: Unauthenticated request, ProfileService returns 401 error\n\n*Acceptance Criteria*:\n- Contact reconciliation success rate > 99.5%\n- JIT Contact creation completes within 500ms (p95)\n\n==== EngagementService API Testing\n\n*Test Scenarios*:\n1. **Happy Path**: Valid feedback submission, immediate 202 Accepted response, Case created in Salesforce within 5 minutes, Braze notification delivered\n2. **Invalid Category**: Invalid feedback category, 400 Bad Request response with validation error\n3. **Salesforce Downtime**: Salesforce unavailable during async Case creation, message queued, retry logic executes, Case created when Salesforce recovers\n4. **Dead Letter Queue**: Case creation fails after 5 retries, message moved to DLQ, ops team alerted\n5. **Webhook Notification**: Support agent resolves Case in Salesforce, webhook triggers EngagementService, Braze push notification sent to customer\n\n*Acceptance Criteria*:\n- Feedback submission success rate > 99.5% (including async Case creation)\n- Async Case creation completes within 5 minutes (p95)\n- Webhook delivery success rate > 99%\n\n=== Non-Functional Validation\n\n==== Performance Testing\n\n*Load Testing*:\n\n*Baseline*: Expected 100-150 submissions/day from 20k DAU (~0.5-0.75% submission rate)\n\n- **Normal Load**: 1 submission/minute sustained for 2 hours (simulate typical daily pattern)\n- **3x Load**: 3 submissions/minute sustained for 1 hour (simulate busy period, 450 submissions/day)\n- **Peak Load (10x)**: 10 submissions/minute for 15 minutes (simulate incident scenario, app outage causing backlog)\n- **Stress Test**: 50 submissions/minute for 5 minutes (find breaking point, 20x normal)\n\n*Validation*:\n- API response time p95 < 1 second under 10x load\n- Event Bus queue depth remains manageable (< 100 messages)\n- No Case creation failures, all submissions processed successfully\n- Auto-scaling triggers appropriately for sustained load > 3x baseline\n\n*Acceptance Criteria*:\n- NFR-PERF-001 through NFR-PERF-006 validated under realistic load (3x and 10x baseline)\n- Auto-scaling triggers within 2 minutes of load increase\n- System handles 10x peak gracefully, 20x stress test identifies limits\n\n==== Resilience Testing\n\n*Salesforce API Failure Scenarios*:\n1. **Complete Outage**: Salesforce unavailable for 2 hours, Event Bus queues buffer work, Cases created when Salesforce recovers\n2. **Rate Limit Exceeded**: Salesforce rate limit hit, queue throttling activates, Cases created within SLA\n\n*Acceptance Criteria*:\n- NFR-AVAIL-004 validated (graceful degradation during Salesforce downtime)\n- Circuit breaker activates after 5 consecutive failures\n\n==== Security Validation\n\n*Penetration Testing*:\n- API authentication bypass attempts\n- SQL injection attempts\n- Webhook signature validation bypass\n\n*Acceptance Criteria*:\n- NFR-SEC-001 through NFR-SEC-010 validated\n- OWASP API Security Top 10 compliance verified\n\n=== Integration Validation\n\n==== End-to-End Testing\n\n*Full User Journey*:\n1. User authenticates via Microsoft Entra External ID\n2. Mobile App requests Contact ID from ProfileService (JIT reconciliation)\n3. User submits feedback via EngagementService\n4. Background worker creates Case in Salesforce\n5. Braze notification delivered to user\n6. Support agent resolves Case in Salesforce\n7. Salesforce webhook triggers EngagementService\n8. Braze notification delivered to user\n\n*Acceptance Criteria*:\n- End-to-end flow completes successfully in UAT\n- User receives both \"feedback submitted\" and \"case resolved\" notifications\n","structuredPatch":[{"oldStart":2133,"oldLines":6,"newStart":2133,"newLines":7,"lines":[" * D365 CE integration disabled"," * Support agents successfully using Salesforce for OTR digital customer Cases"," ","+[[wp-cs-010]]"," === WP-CS-010: Post-Cutover Support"," "," ==== Description"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"802822d6-07e1-41c7-b190-d3974ee3dd86"}
{"parentUuid":"a4d72f83-b211-44bc-b49b-a379f222190f","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_014SFy9JVtp9uCRp1X13bWSp","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Great! All 10 anchors have been added. Now I need to update the todo list and move to the second task: converting plain text references to xrefs.\n\nI need to find all references to work packages and convert them to xref links. Let me mark the first todo as complete and start working on the second.","signature":"EtIDCkYICxgCKkCUPLNf1WcfKzs77mE1+jnc0D6PcCdVoYILDiQx36L6TyYrIeBAJ/xc7pLFCH0kj8Rdu7w5LDM5J8bfBlrDhJ2jEgybBTzEoboh18CobtcaDJn85Hto/+g40bgFuiIwlybgATwpZgp9mU5Sugmnkxrb20Y+vpnYA4kl1wQf8I+2AaqHRjdJXB7LuCQTKSLgKrkCMgDa7rWvraHUBBZYDO6jpSQI1uWmM2QMPiQ1E2MUm4/PF3TGW9JBnFKLaIN4Mh2YFisHz/k/Vuumwlv9vS87E/guVxngcCxiEwz9yA5mZJqKZT8MvGlirPXVvjg9kxPnVrw8ItHFuqdKqQH9NgfusYI/o+IJuXAY8jRznEsJMeuHZwOtqy52g7Aar8iwzup7IFS8KkgV1GQVQkRFZs5qiucknZTKx3Ifmuj+bN/yoxyBuXz8GioUbLge+3cbmLfyijbFDE2k2pV2DAa6xgR/uTNkm0VL48wnpxLaFdirA8rWl6mvvvdB/YckBpBDR123Pkew4EU24y0YgrOd07ATPY5YvBy1rCb14MBOTabmkk8NVHjSgd6fFMZcYAbIYSbKVktP80bExy0CsBdZ3JNn3A7dD7NA6Kik7xgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":4111,"cache_read_input_tokens":29946,"cache_creation":{"ephemeral_5m_input_tokens":4111,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWw55gmaoAnd13UVmA9Et","type":"assistant","uuid":"c2024c9d-d2a5-4788-b01b-9cc62a6dd494","timestamp":"2026-01-09T03:10:57.593Z"}
{"parentUuid":"c2024c9d-d2a5-4788-b01b-9cc62a6dd494","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_014SFy9JVtp9uCRp1X13bWSp","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01N4b82XPDNH3cdheYsZ3LRi","name":"TodoWrite","input":{"todos":[{"content":"Add anchor IDs to all 10 work package headings","activeForm":"Adding anchor IDs to work package headings","status":"completed"},{"content":"Convert plain text work package references to xrefs","activeForm":"Converting work package references to xrefs","status":"in_progress"}]}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":4111,"cache_read_input_tokens":29946,"cache_creation":{"ephemeral_5m_input_tokens":4111,"ephemeral_1h_input_tokens":0},"output_tokens":207,"service_tier":"standard"}},"requestId":"req_011CWw55gmaoAnd13UVmA9Et","type":"assistant","uuid":"172fffbc-2bac-473b-af7c-6c2203f8039a","timestamp":"2026-01-09T03:10:59.566Z"}
{"parentUuid":"172fffbc-2bac-473b-af7c-6c2203f8039a","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01N4b82XPDNH3cdheYsZ3LRi","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"uuid":"f88676b7-27e2-4313-b701-fb2ea4647fa8","timestamp":"2026-01-09T03:10:59.669Z","toolUseResult":{"oldTodos":[{"content":"Add anchor IDs to all 10 work package headings","status":"in_progress","activeForm":"Adding anchor IDs to work package headings"},{"content":"Convert plain text work package references to xrefs","status":"pending","activeForm":"Converting work package references to xrefs"}],"newTodos":[{"content":"Add anchor IDs to all 10 work package headings","status":"completed","activeForm":"Adding anchor IDs to work package headings"},{"content":"Convert plain text work package references to xrefs","status":"in_progress","activeForm":"Converting work package references to xrefs"}]},"sourceToolAssistantUUID":"172fffbc-2bac-473b-af7c-6c2203f8039a"}
{"parentUuid":"f88676b7-27e2-4313-b701-fb2ea4647fa8","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01MB3ZzcwLcUeNs1BR68aPdz","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now I need to convert plain text references to xrefs. From the grep output earlier, I saw references like:\n- `WP-CS-003 (Event Bus Infrastructure) completed`\n- `WP-CS-001 (ProfileService Development) completed and deployed to dev/staging`\n\nI need to convert these to:\n- `<<wp-cs-003,WP-CS-003>> (Event Bus Infrastructure) completed`\n- `<<wp-cs-001,WP-CS-001>> (ProfileService Development) completed and deployed to dev/staging`\n\nLet me search for all occurrences systematically. I'll need to be careful to:\n1. Not replace the heading titles themselves\n2. Not replace references in the table (those should stay as plain text)\n3. Replace references in the Dependencies sections\n\nLet me read a few dependency sections to understand the exact patterns I need to replace.","signature":"Ep4HCkYICxgCKkBi405Vzkt3LooFOQ+cY4PXfB6ByToyY4ZR3JnT/EXdvZLNsKgdtuUBbaAxNcQmd0gs+B5Jo7TaIFg//q/gDkypEgw7965Mk+G0fJYA9OwaDKfTO1vX8fi+lt+LwyIwbtu1G47nqkuV6fC7B4aZGlvy0NoeoS/zTmbVtV+7ru5aeeBigSqp94ZNV+moorMMKoUGSrCMe9KejQSiOhi+/qv29ngEAmYZTXO9OFksWF9hPd66XSQGtN/RD/7/F3PbyN2LKp4sCs0H+E3OeL0e5T+yY1CmE34konJtyJl3FKpFlqH/def2z8V8EVKyccrF+KY+2nVGZbfFNxpZcM3If/ANT4uD1EHqmHv9OYSD+VloncdMWeJqLbtJuTbhlK1VWulieH3slcMbRaoDzf0DS8L+pwljRyzThkQKMJO23m8bNRfEeVy5+a3YVZ8yb+kAKtdhGtke2l2cMzQL33YNkIUZ11/wYhOT1ollXLX90QCHUwO3eh11Yl7Tt/NxjTmUHZcxPp8evP9/EtdoA2GafVxiJdKHq4/SDeU6j4rrnyjKmccaQCtoHHC62mW8+8j/Pe3HCR9o2cCX5F2vl/teMq8XnNFOfZmg5KGwGVQcr9YcE6t120w9zz3YktXm/Pj46v21TUxD7+3bSFN/QDjDgXDVJSSOwWPjGZmAuc0Es1haU+2b3eIW+lzoMG/BxoVv5/tdeHqw4JphjFYkkoMv8VPDd5RTsdwPK+ApiEGDwtRrl3FRLqHh2vct1ZTDVZjYWtGzzO0wyk2fDoannsoC5sifHbKejtUt989FYsZ1ahEh8L0dKqy71+3/VR92medI1J6Ap+XMKHmacXlegFtpkN5lXBUqQzRSw9ozrRPkOp1LJf3QPX465rWPFBjMOD1QbYbCftczzn5ChC9wWUplIivLkah5dN26NcpuLMXRq2fOV8mAn4ptH64v7xa7VP5RhfdVglfm0jlIG9MnqU2mkBqgWvWc1rr0YGRXhL5EUx3GEpfGps653aP3tZye5GufqxDdg9MUj55Ei+Bj2ETH2iHfZXU+Zzd6reCNDv5c+/AitYUHJKJ1Ye45zmIUJyWL22s6NvFSuMyW+SvC3LRW3aa8LqMhdWK3U72XvWmCVWfvGBTXtqK23dTa8vDuUo4pHm5M1oKTdhCq388mOmXl0Vt+fjWJ4TGYq4IqeRJ18xPsFQsoPzc2Y/iOKQD3Nx8HzhX1uqgXy/4YAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":257,"cache_read_input_tokens":34057,"cache_creation":{"ephemeral_5m_input_tokens":257,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWw56Ea2SVhhcFoLT52aJ","type":"assistant","uuid":"a23191b7-1ec6-4fd7-a44d-95561f2cf081","timestamp":"2026-01-09T03:11:06.125Z"}
{"parentUuid":"a23191b7-1ec6-4fd7-a44d-95561f2cf081","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01MB3ZzcwLcUeNs1BR68aPdz","type":"message","role":"assistant","content":[{"type":"text","text":"Now I'll convert the plain text work package references to cross-references. Let me find all the references that need to be updated."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":257,"cache_read_input_tokens":34057,"cache_creation":{"ephemeral_5m_input_tokens":257,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWw56Ea2SVhhcFoLT52aJ","type":"assistant","uuid":"86efeed8-2745-4534-a623-6a5789c93bcb","timestamp":"2026-01-09T03:11:06.757Z"}
{"parentUuid":"86efeed8-2745-4534-a623-6a5789c93bcb","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01MB3ZzcwLcUeNs1BR68aPdz","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01EyJQsdnSXCBpC7QpSiCiay","name":"Read","input":{"file_path":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","offset":1620,"limit":20}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":257,"cache_read_input_tokens":34057,"cache_creation":{"ephemeral_5m_input_tokens":257,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWw56Ea2SVhhcFoLT52aJ","type":"assistant","uuid":"7b29e2c2-5ece-412f-b3f5-0e579d29a241","timestamp":"2026-01-09T03:11:07.672Z"}
{"parentUuid":"7b29e2c2-5ece-412f-b3f5-0e579d29a241","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01MB3ZzcwLcUeNs1BR68aPdz","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01G1joELnbKMS7u6w1wmYvDg","name":"Read","input":{"file_path":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","offset":1755,"limit":20}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":257,"cache_read_input_tokens":34057,"cache_creation":{"ephemeral_5m_input_tokens":257,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWw56Ea2SVhhcFoLT52aJ","type":"assistant","uuid":"c262feef-0c4c-4cea-b35c-02392ec51d3f","timestamp":"2026-01-09T03:11:08.357Z"}
{"parentUuid":"c262feef-0c4c-4cea-b35c-02392ec51d3f","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01MB3ZzcwLcUeNs1BR68aPdz","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01FhrUKZsjdun1MtRzWwpHxq","name":"Read","input":{"file_path":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","offset":1820,"limit":20}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":257,"cache_read_input_tokens":34057,"cache_creation":{"ephemeral_5m_input_tokens":257,"ephemeral_1h_input_tokens":0},"output_tokens":552,"service_tier":"standard"}},"requestId":"req_011CWw56Ea2SVhhcFoLT52aJ","type":"assistant","uuid":"d9da1de1-625c-4a5d-96e8-0992c7d49bdb","timestamp":"2026-01-09T03:11:09.126Z"}
{"parentUuid":"7b29e2c2-5ece-412f-b3f5-0e579d29a241","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01EyJQsdnSXCBpC7QpSiCiay","type":"tool_result","content":"  1620→* Unit tests (>80% code coverage)\n  1621→* Integration tests (EngagementService ↔ Salesforce, EngagementService ↔ Braze)\n  1622→* API documentation\n  1623→* Deployment configuration (IaC)\n  1624→\n  1625→==== Dependencies\n  1626→\n  1627→*Prerequisites*:\n  1628→\n  1629→* WP-CS-003 (Event Bus Infrastructure) completed\n  1630→* Salesforce sandbox environment provisioned\n  1631→* Braze API credentials and campaign templates configured\n  1632→* Microsoft Entra External ID OAuth configuration\n  1633→\n  1634→*Dependent Work Packages*:\n  1635→\n  1636→* WP-CS-003 must be completed first (Event Bus required for async processing)\n  1637→* WP-CS-007 (Salesforce Configuration) must be in progress (field mapping needed)\n  1638→\n  1639→==== Skills Required\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"dc56de64-8da8-45a0-bcf2-9cc2f23030cb","timestamp":"2026-01-09T03:11:09.460Z","toolUseResult":{"type":"text","file":{"filePath":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","content":"* Unit tests (>80% code coverage)\n* Integration tests (EngagementService ↔ Salesforce, EngagementService ↔ Braze)\n* API documentation\n* Deployment configuration (IaC)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-003 (Event Bus Infrastructure) completed\n* Salesforce sandbox environment provisioned\n* Braze API credentials and campaign templates configured\n* Microsoft Entra External ID OAuth configuration\n\n*Dependent Work Packages*:\n\n* WP-CS-003 must be completed first (Event Bus required for async processing)\n* WP-CS-007 (Salesforce Configuration) must be in progress (field mapping needed)\n\n==== Skills Required","numLines":20,"startLine":1620,"totalLines":3329}},"sourceToolAssistantUUID":"7b29e2c2-5ece-412f-b3f5-0e579d29a241"}
{"parentUuid":"c262feef-0c4c-4cea-b35c-02392ec51d3f","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01G1joELnbKMS7u6w1wmYvDg","type":"tool_result","content":"  1755→** Troubleshooting guide\n  1756→** Runbook for migration execution\n  1757→\n  1758→==== Dependencies\n  1759→\n  1760→*Prerequisites*:\n  1761→\n  1762→* WP-CS-001 (ProfileService Development) completed (reuses Salesforce integration code)\n  1763→* Salesforce sandbox environment for migration testing\n  1764→* App-specific database access (read-only sufficient)\n  1765→* Salesforce production access granted\n  1766→\n  1767→*Dependent Work Packages*:\n  1768→\n  1769→* WP-CS-001 provides Salesforce Contact upsert logic to reuse\n  1770→\n  1771→==== Skills Required\n  1772→\n  1773→* Database development (SQL, data extraction)\n  1774→* Salesforce REST API integration\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"7282d36f-e153-4824-ba65-3e900a1fa512","timestamp":"2026-01-09T03:11:09.460Z","toolUseResult":{"type":"text","file":{"filePath":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","content":"** Troubleshooting guide\n** Runbook for migration execution\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-001 (ProfileService Development) completed (reuses Salesforce integration code)\n* Salesforce sandbox environment for migration testing\n* App-specific database access (read-only sufficient)\n* Salesforce production access granted\n\n*Dependent Work Packages*:\n\n* WP-CS-001 provides Salesforce Contact upsert logic to reuse\n\n==== Skills Required\n\n* Database development (SQL, data extraction)\n* Salesforce REST API integration","numLines":20,"startLine":1755,"totalLines":3329}},"sourceToolAssistantUUID":"c262feef-0c4c-4cea-b35c-02392ec51d3f"}
{"parentUuid":"d9da1de1-625c-4a5d-96e8-0992c7d49bdb","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01FhrUKZsjdun1MtRzWwpHxq","type":"tool_result","content":"  1820→* API integration tests (mocked APIs)\n  1821→\n  1822→==== Dependencies\n  1823→\n  1824→*Prerequisites*:\n  1825→\n  1826→* WP-CS-001 (ProfileService Development) completed and deployed to dev/staging\n  1827→* WP-CS-002 (EngagementService Development) completed and deployed to dev/staging\n  1828→* ProfileService and EngagementService OpenAPI specifications finalized\n  1829→* Feature flag service configured\n  1830→\n  1831→*Dependent Work Packages*:\n  1832→\n  1833→* Must complete after WP-CS-001 and WP-CS-002 (requires API endpoints available for integration testing)\n  1834→\n  1835→==== Skills Required\n  1836→\n  1837→* Kotlin Multiplatform development\n  1838→* SwiftUI (iOS native UI)\n  1839→* Jetpack Compose (Android native UI)\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"9554a1a7-f3e1-447b-944c-b44934c570fc","timestamp":"2026-01-09T03:11:09.461Z","toolUseResult":{"type":"text","file":{"filePath":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","content":"* API integration tests (mocked APIs)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-001 (ProfileService Development) completed and deployed to dev/staging\n* WP-CS-002 (EngagementService Development) completed and deployed to dev/staging\n* ProfileService and EngagementService OpenAPI specifications finalized\n* Feature flag service configured\n\n*Dependent Work Packages*:\n\n* Must complete after WP-CS-001 and WP-CS-002 (requires API endpoints available for integration testing)\n\n==== Skills Required\n\n* Kotlin Multiplatform development\n* SwiftUI (iOS native UI)\n* Jetpack Compose (Android native UI)","numLines":20,"startLine":1820,"totalLines":3329}},"sourceToolAssistantUUID":"d9da1de1-625c-4a5d-96e8-0992c7d49bdb"}
{"parentUuid":"9554a1a7-f3e1-447b-944c-b44934c570fc","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01856MCL4fhPzN4rqQwhPwMH","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Good! Now I have a clear picture of the patterns I need to replace. I'll convert all the work package references in the Dependencies sections to xrefs. Let me do this systematically for each work package's dependencies section.\n\nI'll use the Edit tool to replace each occurrence. Let me start with WP-CS-002's dependencies.","signature":"EuoDCkYICxgCKkBkmjfbz/WXS3KrThqe0pEXv9xDQHwsT7DYQ3QaNin6xqVFI35fKXth/zI17g5AADjQ+LPwJdndZn+vSYcWMdUCEgxyFpZ76P8TlRATHy4aDGKOR/Ro4l+5c8/XxSIwPTKPjMmKenpvFQBj8TfRHA1y6l8+Qjqr4rvkQuR9h0BELSLN+BSXqu2jnPAUEkqeKtEC2bYqPlUwDuxZQJe2tM89HWlJLbWA4deCsjSAcHSlcGDbIjPn9udhdqpWbYZGNQ2zTr8IIYEEF8GlwkmO/NSsjfxDeINzM5lc6hQyt6kdqB8+sfLj3SUKesIJSOEJ6DXLEPhbg+EzcGrn04HnZqFDfynq6yXU6eExvFpB9QGuYEpt+En15L+3k3eQQF1IHDBdv9vmUVG20A/BQTQVzkpTyPET7NNL7SVlo0wYBZ4Y2sn3IKAflkcT3wj5aDxSEvRJpNKQP6vSxHKg9Q8ixODHjHTn5CbqiqTtrcWgAP78qYb2iGmgA1a2Nwo9fh9+XQ58S2EKiz3nTgM4AuTtlocuyvGmFGxF+J9GY1fqy6KKQb3vgpoDCzmDoOiK+gxwe6DHevAlBBlv3aJ+iJhu/ZZWNeqBVDyLHdbBfCuQY14xjmZZvzKBIFe44fv9YEiKJ4EIgRgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":1594,"cache_read_input_tokens":34314,"cache_creation":{"ephemeral_5m_input_tokens":1594,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CWw56xomFz64gVUvT6CYq","type":"assistant","uuid":"61791ae6-379f-4da3-ab79-c42cecacbf7d","timestamp":"2026-01-09T03:11:14.393Z"}
{"parentUuid":"61791ae6-379f-4da3-ab79-c42cecacbf7d","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01856MCL4fhPzN4rqQwhPwMH","type":"message","role":"assistant","content":[{"type":"text","text":"Now I'll convert all work package references to cross-links. Let me update them systematically."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":1594,"cache_read_input_tokens":34314,"cache_creation":{"ephemeral_5m_input_tokens":1594,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CWw56xomFz64gVUvT6CYq","type":"assistant","uuid":"7fbc2434-2375-4f84-b0dc-c5858bf2f369","timestamp":"2026-01-09T03:11:14.898Z"}
{"parentUuid":"7fbc2434-2375-4f84-b0dc-c5858bf2f369","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01856MCL4fhPzN4rqQwhPwMH","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01QDXM25mZHY7YHG3kRHvtQt","name":"Edit","input":{"replace_all":false,"file_path":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","old_string":"*Prerequisites*:\n\n* WP-CS-003 (Event Bus Infrastructure) completed\n* Salesforce sandbox environment provisioned\n* Braze API credentials and campaign templates configured\n* Microsoft Entra External ID OAuth configuration\n\n*Dependent Work Packages*:\n\n* WP-CS-003 must be completed first (Event Bus required for async processing)\n* WP-CS-007 (Salesforce Configuration) must be in progress (field mapping needed)","new_string":"*Prerequisites*:\n\n* <<wp-cs-003,WP-CS-003>> (Event Bus Infrastructure) completed\n* Salesforce sandbox environment provisioned\n* Braze API credentials and campaign templates configured\n* Microsoft Entra External ID OAuth configuration\n\n*Dependent Work Packages*:\n\n* <<wp-cs-003,WP-CS-003>> must be completed first (Event Bus required for async processing)\n* <<wp-cs-007,WP-CS-007>> (Salesforce Configuration) must be in progress (field mapping needed)"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":1594,"cache_read_input_tokens":34314,"cache_creation":{"ephemeral_5m_input_tokens":1594,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CWw56xomFz64gVUvT6CYq","type":"assistant","uuid":"ae2ce45d-5427-4c51-8057-864251df9f11","timestamp":"2026-01-09T03:11:17.529Z"}
{"parentUuid":"ae2ce45d-5427-4c51-8057-864251df9f11","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01856MCL4fhPzN4rqQwhPwMH","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_015ZvbPRTNLhuXKaRtYqac3Y","name":"Edit","input":{"replace_all":false,"file_path":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","old_string":"*Prerequisites*:\n\n* WP-CS-001 (ProfileService Development) completed (reuses Salesforce integration code)\n* Salesforce sandbox environment for migration testing\n* App-specific database access (read-only sufficient)\n* Salesforce production access granted\n\n*Dependent Work Packages*:\n\n* WP-CS-001 provides Salesforce Contact upsert logic to reuse","new_string":"*Prerequisites*:\n\n* <<wp-cs-001,WP-CS-001>> (ProfileService Development) completed (reuses Salesforce integration code)\n* Salesforce sandbox environment for migration testing\n* App-specific database access (read-only sufficient)\n* Salesforce production access granted\n\n*Dependent Work Packages*:\n\n* <<wp-cs-001,WP-CS-001>> provides Salesforce Contact upsert logic to reuse"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":1594,"cache_read_input_tokens":34314,"cache_creation":{"ephemeral_5m_input_tokens":1594,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CWw56xomFz64gVUvT6CYq","type":"assistant","uuid":"f58f12c3-48c5-40ea-bfd7-a847a55dbed2","timestamp":"2026-01-09T03:11:19.777Z"}
{"parentUuid":"f58f12c3-48c5-40ea-bfd7-a847a55dbed2","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01856MCL4fhPzN4rqQwhPwMH","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_0157ycPWBziMrhQAdmbLTxJH","name":"Edit","input":{"replace_all":false,"file_path":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","old_string":"*Prerequisites*:\n\n* WP-CS-001 (ProfileService Development) completed and deployed to dev/staging\n* WP-CS-002 (EngagementService Development) completed and deployed to dev/staging\n* ProfileService and EngagementService OpenAPI specifications finalized\n* Feature flag service configured\n\n*Dependent Work Packages*:\n\n* Must complete after WP-CS-001 and WP-CS-002 (requires API endpoints available for integration testing)","new_string":"*Prerequisites*:\n\n* <<wp-cs-001,WP-CS-001>> (ProfileService Development) completed and deployed to dev/staging\n* <<wp-cs-002,WP-CS-002>> (EngagementService Development) completed and deployed to dev/staging\n* ProfileService and EngagementService OpenAPI specifications finalized\n* Feature flag service configured\n\n*Dependent Work Packages*:\n\n* Must complete after <<wp-cs-001,WP-CS-001>> and <<wp-cs-002,WP-CS-002>> (requires API endpoints available for integration testing)"}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":1594,"cache_read_input_tokens":34314,"cache_creation":{"ephemeral_5m_input_tokens":1594,"ephemeral_1h_input_tokens":0},"output_tokens":1080,"service_tier":"standard"}},"requestId":"req_011CWw56xomFz64gVUvT6CYq","type":"assistant","uuid":"007591f8-8a23-42d8-b973-c6e663f8d425","timestamp":"2026-01-09T03:11:22.482Z"}
{"parentUuid":"ae2ce45d-5427-4c51-8057-864251df9f11","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01QDXM25mZHY7YHG3kRHvtQt","type":"tool_result","content":"The file /mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n  1623→* Deployment configuration (IaC)\n  1624→\n  1625→==== Dependencies\n  1626→\n  1627→*Prerequisites*:\n  1628→\n  1629→* <<wp-cs-003,WP-CS-003>> (Event Bus Infrastructure) completed\n  1630→* Salesforce sandbox environment provisioned\n  1631→* Braze API credentials and campaign templates configured\n  1632→* Microsoft Entra External ID OAuth configuration\n  1633→\n  1634→*Dependent Work Packages*:\n  1635→\n  1636→* <<wp-cs-003,WP-CS-003>> must be completed first (Event Bus required for async processing)\n  1637→* <<wp-cs-007,WP-CS-007>> (Salesforce Configuration) must be in progress (field mapping needed)\n  1638→\n  1639→==== Skills Required\n  1640→\n  1641→* Backend development (.NET Core or Node.js)"}]},"uuid":"37fec5dc-7389-425d-a24a-698113b3c69c","timestamp":"2026-01-09T03:11:22.690Z","toolUseResult":{"filePath":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","oldString":"*Prerequisites*:\n\n* WP-CS-003 (Event Bus Infrastructure) completed\n* Salesforce sandbox environment provisioned\n* Braze API credentials and campaign templates configured\n* Microsoft Entra External ID OAuth configuration\n\n*Dependent Work Packages*:\n\n* WP-CS-003 must be completed first (Event Bus required for async processing)\n* WP-CS-007 (Salesforce Configuration) must be in progress (field mapping needed)","newString":"*Prerequisites*:\n\n* <<wp-cs-003,WP-CS-003>> (Event Bus Infrastructure) completed\n* Salesforce sandbox environment provisioned\n* Braze API credentials and campaign templates configured\n* Microsoft Entra External ID OAuth configuration\n\n*Dependent Work Packages*:\n\n* <<wp-cs-003,WP-CS-003>> must be completed first (Event Bus required for async processing)\n* <<wp-cs-007,WP-CS-007>> (Salesforce Configuration) must be in progress (field mapping needed)","originalFile":"= Salesforce Customer Support - Solution Architecture\n:project-name: Salesforce Customer Support\n:togaf-adm-phase: Phase E: Opportunities & Solutions\n:last-updated: 2026-01-07\n:document-type: Solution Architecture Document\n:status: Discovery\n:version: 0.1\n:domain: Customer Support & Engagement\n:programme-lead:\n:domain-architect: O.Young@otr.com.au\n:architecture-definition: xref:architecture-definitions:salesforce_customer_support.adoc[Architecture Definitions/Salesforce Customer Support]\n:doctype: article\n:toc: left\n:toclevels: 4\n:sectanchors:\n:sectlinks:\n:sectnums:\n:icons: font\n:source-highlighter: highlightjs\n:experimental:\n:description:\n:keywords:\n\n<<<\n== Purpose and Scope\n\n=== Purpose\n\nThis Solution Architecture defines how the Salesforce Customer Support consolidation will be implemented - the specific technology products, configurations, interfaces, and deployment architecture that realise the xref:architecture-definitions:salesforce_customer_support.adoc[Salesforce Customer Support Architecture Definition].\n\nThis solution establishes the **first implementation of OTR's target Domain-Driven Design (DDD) architecture** by deploying two new bounded contexts (`ProfileService` and `EngagementService`) as microservices, consolidating customer support onto Salesforce Service Cloud, and implementing event-driven integration patterns that will serve as the foundation for future bounded contexts (including Flybuys integration).\n\n=== Vision\n\n> Unify customer support across all OTRG channels by consolidating OTR digital customer feedback onto Salesforce Service Cloud, establishing the foundational DDD architecture with ProfileService and EngagementService bounded contexts that protect digital channels from external system changes while enabling support agents to deliver exceptional customer experiences with complete interaction history.\n\n=== Architectural Approach\n\nThis architecture establishes OTR's **first bounded context implementation** using Domain-Driven Design strategic patterns:\n\n* *link:../bounded_context/profile.adoc[ProfileService]* (NEW bounded context): Just-In-Time Contact reconciliation with Salesforce, upsert by email, returns Salesforce Contact ID to digital channels - foundation for future Flybuys partner linking\n* *link:../bounded_context/engagement.adoc[EngagementService]* (NEW bounded context): Customer feedback submission facade, Anti-Corruption Layer for Salesforce Case creation, Braze integration for all outbound customer communications (push, email, SMS), async Case processing via Event Bus\n* *Event-driven integration* (NEW pattern): Domain event publishing using existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis) - first implementation establishing pattern for future bounded contexts\n* *Anti-Corruption Layer*: EngagementService isolates digital channels from Salesforce API changes, translates between OTR domain language and Salesforce Service Cloud API\n* *Conformist Pattern*: ProfileService and EngagementService conform to existing Salesforce configuration (shared Viva Energy instance, multi-tenant governance)\n* *Big bang cutover*: Single deployment after Contact migration, no phased rollout, D365 CE retirement post-cutover\n\n=== Scope\n\n==== In Scope\n\n* Solution Building Blocks (SBBs) - specific technology products and versions\n* Interface specifications (APIs, events, data formats)\n* Data architecture and schema specifications\n* Deployment architecture and infrastructure configuration\n* Transition architecture with migration phases\n* Technical validation criteria and testing approach\n* External system integration specifications\n* Physical data models and API schemas\n\n==== Out of Scope\n\n===== Covered in xref:architecture-definitions:salesforce_customer_support.adoc[Architecture Definition]\n\n* Business requirements and stakeholder analysis\n* Architecture decisions and rationale (ADRs)\n* Bounded context definitions and responsibilities\n* High-level integration patterns (ACL, Conformist, OHS+PL)\n* Business capability mapping and value streams\n* Architecture principles and governance\n\n===== Covered in Other Documents\n\n* Detailed design (class diagrams, sequence diagrams for all flows)\n* Implementation code and unit tests\n* Business case and return-on-investment analysis\n* Operational run books and support procedures\n\n<<<\n=== Architecture Overview\n\n[mermaid]\n----\n---\nconfig:\n  layout: elk\n---\nflowchart TB\n    Customer([\"Customer\"]) -- Uses --> MobileApp[\"Mobile App<br>iOS/Android\"]\n    Customer -- Shops at --> POS[\"OTR/OTR+ POS<br>D365 Commerce\"]\n    MobileApp -- Authenticate --> EntraID[\"Microsoft Entra\"]\n    MobileApp -- Identifies & Reconciles --> ProfileService[\"ProfileService\"]\n    ProfileService <-- Reconcile App User as Salesforce Contact --> Salesforce[\"Salesforce\"]\n    ProfileService -- On Create --> EventBus[\"EventBus\"]\n    EventBus -- Emits CreateUser Event --> LoyaltyService[\"LoyaltyService\"] & EngagementService[\"EngagementService\"]\n    LoyaltyService -- Reconcile Wallet --> EagleEye[\"EagleEye\"]\n    EngagementService -- Reconcile Braze Profile --> Braze[\"Braze\"]\n    EngagementService --> Salesforce\n    D365CE[\"D365CE\"] -- Data Migration --> Salesforce\n    MobileApp -- Submits Feedback --> EngagementService\n\n    Customer:::customer\n    MobileApp:::presentation\n    POS:::presentation\n    EntraID:::external\n    ProfileService:::newService\n    Salesforce:::external\n    EventBus:::infrastructure\n    LoyaltyService:::newService\n    EngagementService:::newService\n    EagleEye:::external\n    Braze:::external\n    D365CE:::external\n    classDef newService fill:#4CAF50,stroke:#2E7D32,stroke-width:3px,color:#fff\n    classDef external fill:#FF9800,stroke:#E65100,stroke-width:2px,color:#fff\n    classDef infrastructure fill:#2196F3,stroke:#0D47A1,stroke-width:2px,color:#fff\n    classDef presentation fill:#9C27B0,stroke:#4A148C,stroke-width:2px,color:#fff\n    classDef customer fill:#607D8B,stroke:#263238,stroke-width:2px,color:#fff\n----\n\n\n==== Key Architectural Patterns\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Pattern |Application |Rationale\n\n|*Anti-Corruption Layer (ACL)*\n|EngagementService → Salesforce Service Cloud\n|Protects digital channels (Mobile App, Web) from Salesforce API changes, translates between OTR domain language and Salesforce Case/Contact model, enables independent evolution of internal domain model\n\n|*Conformist*\n|ProfileService → Salesforce, EngagementService → Salesforce\n|Shared Viva Energy Salesforce instance - we conform to existing configuration, governance, and API contracts (external system we don't control)\n\n|*Backend-for-Frontend (BFF)*\n|EngagementService\n|Aggregates customer feedback submission, Contact lookup, async Case creation, and Braze notification orchestration for digital channel clients\n\n|*Event-Driven Architecture (OHS+PL)*\n|Event Bus (SNS+SQS/EventBridge/Kinesis)\n|Loose coupling between bounded contexts, async domain event publishing (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`), foundation for future bounded contexts\n\n|*Just-In-Time (JIT) Integration*\n|ProfileService → Salesforce Contact reconciliation\n|Reconcile app users as Salesforce Contacts on-demand (upsert by email), no pre-sync required, ensures Salesforce has current Contact data\n\n|*Async Processing*\n|EngagementService Case creation via Event Bus\n|Non-blocking user experience, resilience to Salesforce downtime, automatic retry with exponential backoff, dead letter queue for operations team intervention\n\n|*Strangler Fig*\n|Not applicable\n|Big bang cutover (no gradual migration) - D365 CE fully replaced, not incrementally strangled\n\n|===\n\n<<<\n== Solution Approach\n\n* Deploy xref:bounded-contexts:profile.adoc[ProfileService] and xref:bounded-contexts:engagement.adoc[EngagementService] as bounded context microservices\n* Implement Anti-Corruption Layers (ACLs) for Salesforce and Braze integration\n* Establish event-driven architecture as the foundational integration pattern\n* Big bang cutover (TS-1 → TS-4)\n\n=== Related Documentation\n\nThis solution architecture references detailed technical specifications:\n\n==== Architecture Definition\n\n* xref:architecture-definitions:salesforce_customer_support.adoc[Salesforce Customer Support - Architecture Definition] - Business requirements, architecture decisions (ADRs), bounded context definitions, high-level integration patterns\n\n==== Bounded Context Specifications\n\n* xref:bounded-contexts:profile.adoc[ProfileService Bounded Context] - JIT Contact reconciliation, aggregate definitions\n* xref:bounded-contexts:engagement.adoc[EngagementService Bounded Context] - Customer feedback facade, Anti-Corruption Layer\n\n==== Interface Specifications\n\nDetailed API specifications available in the specifications directory:\n\n* link:../../specifications/rest/profile-service-v1.yaml[ProfileService REST API v1] - OpenAPI 3.0 specification for `/profile/v1` endpoints (includes Salesforce Contact reconciliation `GET /contact-id`)\n* link:../../specifications/rest/engagement-service-v1.yaml[EngagementService REST API v1] - OpenAPI 3.0 specification for `/engagement/v1` endpoints (includes `POST /feedback`)\n* link:../../specifications/events/engagement-events.json[Engagement Domain Events] - CloudEvents 1.0 JSON Schema for `SupportCaseCreated`, `SupportCaseUpdated`, `SupportCaseResolved`, `CustomerFeedbackSubmitted`\n\n==== External System Documentation\n\n* https://developer.salesforce.com/docs/atlas.en-us.api_rest.meta/api_rest/[Salesforce REST API Documentation] - Contact and Case object APIs\n* https://www.braze.com/docs/api/endpoints/messaging/send_messages/post_send_triggered_campaigns/[Braze Campaign Trigger API] - Push notification campaigns\n\n<<<\n== Executive Summary\n\n=== Challenge\n\nOTR digital customers (Mobile App, Web) currently submit feedback and support requests to D365 Customer Engagement, while Viva Energy's broader business units (fuel wholesale, Shell Card customers, other retail channels) use Salesforce Service Cloud. This creates:\n\n* *Fragmented customer support platform*: Customer support data split across two systems, preventing support agents from having a unified view of customer interactions across all channels\n* *Operational inefficiency*: Maintaining two separate customer support platforms increases operational overhead and costs\n* *Poor support experience*: D365 CE is not working well for digital customer support, impacting customer satisfaction and case resolution times\n* *Post-merger consolidation opportunity*: Following Viva Energy's acquisition of OTR, strategic alignment on Salesforce as the enterprise customer support platform\n\n=== Solution\n\nThis architecture establishes the **foundational Domain-Driven Design (DDD) implementation** for OTR's target state architecture by introducing two new bounded contexts (link:../bounded_context/profile.adoc[ProfileService], link:../bounded_context/engagement.adoc[EngagementService]) and event-driven integration patterns:\n\n==== New Bounded Contexts\n\n* *link:../bounded_context/profile.adoc[ProfileService]* (NEW): Just-In-Time (JIT) Contact reconciliation with Salesforce, upsert by email, returns Salesforce Contact ID to Mobile App\n* *link:../bounded_context/engagement.adoc[EngagementService]* (NEW): Customer feedback submission, Anti-Corruption Layer (ACL) for Salesforce Case creation, Braze integration for all outbound customer communications (push, email, SMS), async Case processing via Event Bus\n* *Event Bus* (NEW pattern): Domain event publishing using existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis) - first implementation of event-driven architecture pattern\n\n==== Integration Architecture\n\n* *Salesforce = System of Record*: Salesforce Service Cloud (shared Viva Energy instance) owns Contact and Case data\n* *Conformist Pattern*: ProfileService and EngagementService conform to existing Salesforce configuration and API contracts\n* *Anti-Corruption Layer*: EngagementService protects digital channels from Salesforce API changes, translates between OTR domain language and Salesforce\n* *Async Case Creation*: Non-blocking user experience, resilience to Salesforce downtime, automatic retry with exponential backoff, dead letter queue for failed Cases\n* *Event-Driven Notifications*: Salesforce webhook → EngagementService → Braze for all customer communications (push, email, SMS) on Case status updates\n\n==== Migration Approach\n\n* *Contact Migration*: One-time migration from app-specific database → Salesforce (upsert with flexible matching by email/phone/VCI)\n* *No Case Migration*: Historical D365 CE Cases not migrated (fresh start in Salesforce)\n* *Big Bang Cutover*: Single deployment, no phased rollout or parallel run\n* *D365 CE Retirement*: Complete decommissioning of D365 Customer Engagement post-cutover\n\n=== Key Architectural Significance\n\nThis migration establishes the first implementation of OTR's target DDD architecture:\n\n* First bounded contexts implemented (ProfileService, EngagementService)\n* First event-driven domain event pattern (foundation for future bounded contexts)\n* Foundation for Flybuys integration (ProfileService Contact reconciliation reused)\n* Establishes integration patterns (Conformist, ACL, Event-Driven) for future services\n\n=== Success Criteria\n\n* All digital customer feedback routed to Salesforce Service Cloud within 30 days of launch\n* Support agents have unified customer view across all Viva Energy channels (digital, wholesale, Shell Card, other retail)\n* D365 Customer Engagement decommissioned within 90 days post-cutover\n* Customer satisfaction score improves by 15% within 6 months\n* Average case resolution time decreases by 20% within 6 months\n* Zero data loss during Contact migration (100% validation pass rate)\n* Mobile App feedback submission success rate > 99.5% (including async Case creation)\n\n=== Technical Constraints\n\n* Shared Salesforce instance (Viva Energy multi-tenant environment)\n* Conform to existing Salesforce configuration and governance (data isolation strategy TBD with Salesforce admin team)\n* Contact migration must complete before cutover (no parallel run)\n* Async Case creation mandatory (non-blocking user experience)\n* Expected volume: 100-150 feedback submissions/day from 20k DAU (~0.5-0.75% submission rate), architecture capacity planned for 3x-10x growth\n\n=== Open Technical Decisions (TBD)\n\n* Salesforce Case field mapping for digital feedback categories (App, Service, Order, Rewards, Refund, Delete Account)\n* Salesforce data isolation strategy (Record Types, custom fields, queues)\n* Salesforce REST API authentication method (OAuth 2.0, Connected App, JWT bearer flow)\n* Salesforce webhook mechanism for Case updates (Outbound Messages, Platform Events, Process Builder)\n* Retry policy configuration (attempts, backoff intervals)\n* Salesforce API rate limit strategy (expected volume: 100-150 submissions/day from 20k DAU, capacity planning for 3x-10x growth)\n\n== Technical Requirements\n\n[width=\"100%\",cols=\"8%,92%\",options=\"header\",]\n|===\n|ID |Description\n\n|TR-CS-001\n|Every Mobile App user must have a Salesforce Contact record in Salesforce Service Cloud (shared Viva Energy instance)\n\n|TR-CS-002\n|ProfileService must reconcile Mobile App users as Salesforce Contacts using Just-In-Time (JIT) upsert by email address\n\n|TR-CS-003\n|ProfileService must return Salesforce Contact ID to Mobile App for feedback submission\n\n|TR-CS-004\n|Mobile App must support customer feedback submission with fields: Category (App, Service, Order, Rewards, Refund, Delete Account), Store Name, Time of Visit, Contact Phone Number, Free Text Message\n\n|TR-CS-005\n|EngagementService must create Salesforce Cases asynchronously via Event Bus (non-blocking user experience)\n\n|TR-CS-006\n|EngagementService must acknowledge feedback submission immediately to Mobile App user (\"Feedback submitted\" confirmation)\n\n|TR-CS-007\n|EngagementService must send push notification to customer via Braze when Case is successfully created in Salesforce\n\n|TR-CS-008\n|EngagementService must retry failed Case creation with configurable exponential backoff and dead letter queue for operations team intervention\n\n|TR-CS-009\n|Salesforce must be the System of Record for Contact and Case data (no local persistence in ProfileService or EngagementService)\n\n|TR-CS-010\n|Contact migration from app-specific database to Salesforce must complete before Mobile App cutover (upsert with flexible matching by email/phone/VCI)\n\n|TR-CS-011\n|No Case migration from D365 Customer Engagement to Salesforce (fresh start, historical Cases not migrated)\n\n|TR-CS-012\n|EngagementService must publish domain events (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`) to Event Bus for consumption by other bounded contexts\n\n|TR-CS-013\n|EngagementService must receive Salesforce webhook notifications when Cases are updated/resolved by support agents\n\n|TR-CS-014\n|EngagementService must trigger Braze push notifications to customers when Cases are updated/resolved (via Salesforce webhook → EngagementService → Braze)\n\n|TR-CS-015\n|ProfileService and EngagementService must conform to existing Salesforce configuration and API contracts (Conformist pattern)\n\n|TR-CS-016\n|All changes must be communicated using event-driven architecture via Event Bus (using existing AWS infrastructure: SNS+SQS/EventBridge/Kinesis)\n\n|TR-CS-017\n|Mobile App feedback submission success rate must exceed 99.5% (including async Case creation completion)\n\n|TR-CS-018\n|Contact migration must achieve 100% validation pass rate (zero data loss)\n\n|TR-CS-019\n|D365 Customer Engagement must be fully decommissioned within 90 days post-cutover\n\n|===\n\n== Technical Architecture\n\n=== Technical Capability Requirements\n\n==== Requirements Traceability\n\n[width=\"100%\",cols=\"15%,50%,35%\",options=\"header\",]\n|===\n|Requirement ID |Requirement Summary |Architectural Building Blocks\n\n|TR-CS-001\n|Every Mobile App user must have Salesforce Contact record\n|ABB-CS-001 (ProfileService), ABB-CS-004 (Salesforce), ABB-CS-007 (Contact Migration Tool)\n\n|TR-CS-002\n|ProfileService JIT Contact reconciliation via upsert by email\n|ABB-CS-001 (ProfileService), ABB-CS-004 (Salesforce)\n\n|TR-CS-003\n|ProfileService returns Salesforce Contact ID to Mobile App\n|ABB-CS-001 (ProfileService), ABB-CS-006 (Mobile App)\n\n|TR-CS-004\n|Mobile App supports feedback submission with structured fields\n|ABB-CS-006 (Mobile App), ABB-CS-002 (EngagementService)\n\n|TR-CS-005\n|EngagementService creates Salesforce Cases asynchronously\n|ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus), ABB-CS-004 (Salesforce)\n\n|TR-CS-006\n|EngagementService immediate acknowledgment to Mobile App\n|ABB-CS-002 (EngagementService), ABB-CS-006 (Mobile App)\n\n|TR-CS-007\n|EngagementService sends push notification via Braze on Case creation\n|ABB-CS-002 (EngagementService), ABB-CS-005 (Braze)\n\n|TR-CS-008\n|EngagementService retry logic with exponential backoff and DLQ\n|ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus)\n\n|TR-CS-009\n|Salesforce is System of Record for Contact and Case data\n|ABB-CS-004 (Salesforce), ABB-CS-001 (ProfileService - stateless), ABB-CS-002 (EngagementService - stateless)\n\n|TR-CS-010\n|Contact migration before Mobile App cutover\n|ABB-CS-007 (Contact Migration Tool), ABB-CS-004 (Salesforce)\n\n|TR-CS-011\n|No Case migration from D365 CE (fresh start)\n|ABB-CS-004 (Salesforce) - no migration tooling required\n\n|TR-CS-012\n|EngagementService publishes domain events to Event Bus\n|ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus)\n\n|TR-CS-013\n|EngagementService receives Salesforce webhook notifications\n|ABB-CS-002 (EngagementService), ABB-CS-004 (Salesforce)\n\n|TR-CS-014\n|EngagementService triggers Braze notifications on Case updates\n|ABB-CS-002 (EngagementService), ABB-CS-004 (Salesforce), ABB-CS-005 (Braze)\n\n|TR-CS-015\n|ProfileService and EngagementService conform to Salesforce config\n|ABB-CS-001 (ProfileService), ABB-CS-002 (EngagementService), ABB-CS-004 (Salesforce)\n\n|TR-CS-016\n|Event-driven architecture via Event Bus\n|ABB-CS-003 (Event Bus), ABB-CS-002 (EngagementService)\n\n|TR-CS-017\n|Mobile App feedback submission success rate > 99.5%\n|ABB-CS-006 (Mobile App), ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus), ABB-CS-004 (Salesforce)\n\n|TR-CS-018\n|Contact migration 100% validation pass rate\n|ABB-CS-007 (Contact Migration Tool), ABB-CS-004 (Salesforce)\n\n|TR-CS-019\n|D365 CE decommissioned within 90 days post-cutover\n|All ABBs (replacement system operational)\n\n|===\n\n=== Service Catalogues\n\n==== Application Portfolio Catalogue\n\n[width=\"100%\",cols=\"20%,15%,15%,15%,35%\",options=\"header\",]\n|===\n|Application |Lifecycle State |Owner |Hosting Platform |Description\n\n|*ProfileService*\n|NEW\n|OTR Platform Team\n|AWS (TBD: Lambda/ECS/EKS)\n|JIT Contact reconciliation with Salesforce, returns Salesforce Contact ID, foundation for Flybuys integration\n\n|*EngagementService*\n|NEW\n|OTR Platform Team\n|AWS (TBD: Lambda/ECS/EKS)\n|Customer feedback submission facade, ACL for Salesforce Case creation, Braze integration for all outbound communications (push, email, SMS), webhook receiver\n\n|*Mobile App (iOS)*\n|ACTIVE (UPDATE)\n|OTR Mobile Team\n|Apple App Store\n|iOS native app with feedback form, integrate with ProfileService and EngagementService APIs\n\n|*Mobile App (Android)*\n|ACTIVE (UPDATE)\n|OTR Mobile Team\n|Google Play Store\n|Android native app with feedback form, integrate with ProfileService and EngagementService APIs\n\n|*Salesforce Service Cloud*\n|ACTIVE (EXPAND)\n|Viva Energy Salesforce Admin Team\n|Salesforce (SaaS)\n|Shared Viva Energy instance, System of Record for Contact and Case data, adding OTR digital customer support\n\n|*Braze*\n|ACTIVE (EXTEND)\n|OTR Marketing Team\n|Braze (SaaS)\n|Marketing automation platform, EngagementService triggers push notifications for Case updates\n\n|*D365 Customer Engagement*\n|RETIRE\n|OTR Support Team\n|Microsoft Azure (SaaS)\n|Legacy customer support platform, decommissioned within 90 days post-cutover\n\n|*App-Specific Customer Database*\n|RETIRE\n|OTR Platform Team\n|AWS (RDS/DynamoDB)\n|Legacy customer contact storage, one-time migration to Salesforce, then deprecated\n\n|*Event Bus*\n|NEW\n|OTR Platform Team\n|AWS (SNS+SQS/EventBridge/Kinesis)\n|Domain event publishing infrastructure for bounded context integration\n\n|*Contact Migration Tool*\n|TEMPORARY\n|OTR Platform Team\n|AWS (Script/Lambda)\n|One-time migration app database → Salesforce with upsert logic, retired after migration complete\n\n|===\n\n==== Technology Capability Requirements\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Technology Capability |Implementation Technology (TBD in detailed design) |Requirements\n\n|*Microservice Hosting*\n|AWS Lambda / ECS / EKS\n|Host ProfileService and EngagementService with auto-scaling, high availability, monitoring\n\n|*API Gateway*\n|AWS API Gateway / Application Load Balancer\n|REST API routing, authentication, rate limiting, request validation for ProfileService and EngagementService\n\n|*Event Bus*\n|AWS SNS+SQS / EventBridge / Kinesis\n|Domain event publishing, async message processing, retry logic, dead letter queue\n\n|*Salesforce Integration*\n|Salesforce REST API / SOAP API\n|Contact CRUD operations, Case creation, webhook notifications, OAuth 2.0 authentication\n\n|*Braze Integration*\n|Braze REST API / SDK\n|Push notification campaign triggers, customer profile reconciliation\n\n|*Authentication & Authorisation*\n|Microsoft Entra External ID / AWS Cognito\n|Mobile App user authentication, API authorisation, JWT token validation\n\n|*Observability & Monitoring*\n|AWS CloudWatch / Datadog / New Relic\n|Application metrics, logs, traces, dashboards, alerting (feedback submission rate, queue depth, API errors)\n\n|*Secret Management*\n|AWS Secrets Manager / Parameter Store\n|Salesforce credentials, Braze API keys, OAuth tokens, encryption keys\n\n|*Database (Migration Tool)*\n|AWS RDS / DynamoDB (read-only access)\n|Contact migration from app-specific database\n\n|*CI/CD Pipeline*\n|GitHub Actions / AWS CodePipeline\n|Automated build, test, deployment for ProfileService, EngagementService, Mobile App\n\n|*Infrastructure as Code*\n|Terraform / AWS CloudFormation / CDK\n|Declarative infrastructure provisioning for Event Bus, microservices, monitoring\n\n|*API Documentation*\n|OpenAPI / Swagger\n|ProfileService and EngagementService API specifications for Mobile App integration\n\n|===\n\n==== Feature Flag Register\n\n*Note*: Per ADR-CS-006 (big bang cutover, not phased rollout), feature flags are minimal and used primarily for emergency rollback/kill switches.\n\n[width=\"100%\",cols=\"20%,15%,35%,30%\",options=\"header\",]\n|===\n|Feature Flag |Default State |Purpose |Rollback Scenario\n\n|*enable_salesforce_feedback_submission*\n|OFF (pre-cutover), ON (post-cutover)\n|Enable/disable feedback submission to EngagementService → Salesforce (kill switch for emergency rollback to D365 CE)\n|Feedback submission success rate < 95%, Salesforce API failures, critical bugs - revert to D365 CE integration\n\n|*enable_async_case_creation*\n|ON\n|Enable/disable async Case creation via Event Bus (fallback to synchronous processing if Event Bus issues)\n|Event Bus infrastructure failures, queue backlog unmanageable - temporary synchronous processing\n\n|*enable_braze_notifications*\n|ON\n|Enable/disable Braze push notifications for Case updates (degrade gracefully if Braze integration fails)\n|Braze API failures, notification delivery rate < 80% - disable notifications temporarily\n\n|*enable_jit_contact_reconciliation*\n|ON\n|Enable/disable ProfileService JIT Contact reconciliation (fallback to cached Contact IDs if Salesforce unavailable)\n|Salesforce API downtime, Contact reconciliation failures > 5% - use cached Contact IDs temporarily\n\n|*enable_salesforce_webhook_processing*\n|ON\n|Enable/disable Salesforce webhook processing for Case updates (fallback to polling if webhook failures)\n|Webhook delivery failures, authentication issues - temporary polling fallback\n\n|===\n\n*Feature Flag Management*:\n\n* Feature flags managed via AWS AppConfig / LaunchDarkly / custom feature flag service (TBD in detailed design)\n* Mobile App feature flags controlled server-side (no app release required for flag changes)\n* Backend service feature flags configured via environment variables / configuration service\n* Feature flag changes logged and audited (who changed, when, reason)\n* Post-cutover monitoring: Gradual removal of feature flags once system stability confirmed (30-60 days)\n\n==== Data Entity Catalogue\n\n[width=\"100%\",cols=\"20%,15%,35%,30%\",options=\"header\",]\n|===\n|Data Entity |System of Record |Key Attributes |Lifecycle\n\n|*Contact*\n|Salesforce Service Cloud\n|• Contact ID (Salesforce 15/18-char ID) +\n• Email (primary matching key) +\n• First Name, Last Name +\n• Phone Number +\n• Viva Consumer ID (VCI) +\n• Account (Viva Energy customer account) +\n• Record Type (OTR Digital vs other channels)\n|Created: ProfileService JIT reconciliation or Contact Migration Tool +\nUpdated: ProfileService JIT upsert (email changes), Salesforce (manual updates by support agents) +\nDeleted: Salesforce retention policy (GDPR/compliance)\n\n|*Case*\n|Salesforce Service Cloud\n|• Case Number (Salesforce auto-generated) +\n• Contact ID (reference to Contact) +\n• Subject (derived from Category) +\n• Description (Free Text Message) +\n• Category (App, Service, Order, Rewards, Refund, Delete Account) +\n• Store Name (OTR location) +\n• Time of Visit +\n• Status (New, In Progress, Resolved, Closed) +\n• Priority, Origin (Mobile App) +\n• Owner (support agent/queue)\n|Created: EngagementService async Case creation +\nUpdated: Support agents (Salesforce UI), EngagementService (webhook processing) +\nDeleted: Salesforce retention policy (archive after X years)\n\n|*Feedback Submission (transient)*\n|None (not persisted)\n|• Salesforce Contact ID +\n• Category +\n• Store Name +\n• Time of Visit +\n• Contact Phone Number +\n• Free Text Message\n|Created: Mobile App user submission +\nProcessed: EngagementService publishes to Event Bus, Case created in Salesforce +\nNot persisted in ProfileService/EngagementService (stateless)\n\n|*Domain Events*\n|Event Bus (ephemeral)\n|**SupportCaseCreated**: +\n• Case Number, Contact ID, Category, Timestamp +\n**SupportCaseUpdated**: +\n• Case Number, Status, Updated By, Timestamp +\n**SupportCaseResolved**: +\n• Case Number, Resolution, Resolved By, Timestamp +\n**CustomerFeedbackSubmitted**: +\n• Contact ID, Category, Timestamp\n|Published: EngagementService +\nConsumed: Other bounded contexts (future), Braze notification triggers +\nRetention: Short-lived (minutes to hours), not persisted for event sourcing\n\n|*Braze Customer Profile*\n|Braze\n|• External User ID (VCI or Email) +\n• Push Notification Tokens (iOS/Android) +\n• Notification Preferences +\n• Campaign Engagement History\n|Created/Updated: EngagementService on Case creation/update +\nManaged: Braze (external SaaS)\n\n|===\n\n*Data Migration Entities*:\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Source Entity |Target Entity |Migration Strategy\n\n|*App Database Contact*\n|Salesforce Contact\n|One-time migration via Contact Migration Tool: +\n• Upsert by email (primary), phone (secondary), VCI (tertiary) +\n• Map: Email → Email, Name → First/Last Name, Phone → Phone, VCI → External ID +\n• Validation: 100% data integrity check, reconciliation report\n\n|*D365 CE Case*\n|Not migrated\n|ADR-CS-005: No Case migration (fresh start in Salesforce) +\nD365 CE Cases archived separately for compliance if needed\n\n|===\n\n==== Data Quality & Validation\n\n*Contact Migration Validation Rules*:\n\n* Email format validation (RFC 5322 compliance)\n* Phone number format validation (E.164 international format)\n* VCI format validation (alphanumeric, length constraints)\n* Duplicate detection: Flag potential duplicates for manual review (same email/phone combination)\n* Mandatory fields: Email (required), First Name, Last Name (required for Salesforce Contact)\n\n*Case Creation Validation Rules*:\n\n* Contact ID must exist in Salesforce (validated by EngagementService before Case creation)\n* Category must be one of: App, Service, Order, Rewards, Refund, Delete Account\n* Free Text Message maximum length: 32,000 characters (Salesforce Case Description limit)\n* Store Name validated against OTR location master data (optional - warn if not found)\n\n<<<\n== Solution Building Blocks\n\nThis section defines the specific technology products, configurations, and implementation details for each Solution Building Block (SBB).\n\n=== Technology Portfolio Catalogue\n\n[width=\"100%\",cols=\"10%,20%,25%,25%,20%\",options=\"header\",]\n|===\n|SBB ID |Component |Technology Product |Version/Configuration |Deployment Platform\n\n|SBB-CS-001\n|ProfileService Microservice\n|.NET 8 / Node.js 20 LTS\n|RESTful API, containerised\n|AWS ECS Fargate / Lambda\n\n|SBB-CS-002\n|EngagementService Microservice\n|.NET 8 / Node.js 20 LTS\n|RESTful API, containerised, async workers\n|AWS ECS Fargate / Lambda\n\n|SBB-CS-003\n|Event Bus\n|AWS SNS + SQS / EventBridge\n|Standard queues, FIFO for ordering\n|AWS (managed service)\n\n|SBB-CS-004\n|API Gateway\n|AWS API Gateway / ALB\n|REST API, JWT validation\n|AWS (managed service)\n\n|SBB-CS-005\n|Salesforce Integration Layer\n|Salesforce REST API Client\n|OAuth 2.0 JWT bearer flow\n|Embedded in SBB-CS-001/002\n\n|SBB-CS-006\n|Braze Integration Layer\n|Braze REST API SDK\n|API key authentication\n|Embedded in SBB-CS-002\n\n|SBB-CS-007\n|Contact Migration Tool\n|Python 3.11 / .NET 8\n|One-time batch script\n|AWS Lambda / EC2\n\n|SBB-CS-008\n|Application Monitoring\n|AWS CloudWatch / Datadog\n|Metrics, logs, traces, dashboards\n|AWS / SaaS\n\n|SBB-CS-009\n|Secret Management\n|AWS Secrets Manager\n|KMS encryption\n|AWS (managed service)\n\n|SBB-CS-010\n|Mobile App (iOS)\n|SwiftUI, Kotlin Multiplatform\n|iOS 15+\n|Apple App Store\n\n|SBB-CS-011\n|Mobile App (Android)\n|Jetpack Compose, Kotlin Multiplatform\n|Android 8+\n|Google Play Store\n\n|SBB-CS-012\n|Feature Flag Service\n|AWS AppConfig / LaunchDarkly\n|Server-side flags, real-time updates\n|AWS / SaaS\n\n|===\n\n<<<\n== Data Architecture\n\nThis section defines the physical data models, event schemas, and API request/response formats.\n\n=== Domain Event Schemas\n\nAll domain events follow the https://cloudevents.io/[CloudEvents 1.0] specification for consistency and interoperability.\n\n*Event Schema Specifications*: See // TODO: Add to Antora - specifications/events/engagement-events.json[Engagement Service Event Schemas] for complete JSON schemas and examples.\n\n==== Event Catalogue\n\n[width=\"100%\",cols=\"30%,20%,50%\",options=\"header\",]\n|===\n|Event Type |Publisher |Description\n\n|`SupportCaseCreated`\n|EngagementService\n|Published when EngagementService successfully creates a Case in Salesforce after async processing\n\n|`SupportCaseUpdated`\n|EngagementService (via Salesforce webhook)\n|Published when a support agent updates a Case in Salesforce (status, priority, comment changes)\n\n|`SupportCaseResolved`\n|EngagementService (via Salesforce webhook)\n|Published when a support agent resolves/closes a Case in Salesforce\n\n|`CustomerFeedbackSubmitted`\n|EngagementService\n|Published when customer submits feedback via Mobile App (before async Case creation)\n\n|===\n\n*Event Format*: All events use CloudEvents 1.0 envelope with event-specific payload in the `data` field.\n\n*Schema Location*: `specifications/events/engagement-events.json`\n\n=== API Request/Response Schemas\n\n==== ProfileService: GET /profile/contact-id\n\n*Response* (200 OK):\n[source,json]\n----\n{\n  \"contactId\": \"0034X00000ABCDEFG\",\n  \"email\": \"customer@example.com\",\n  \"firstName\": \"John\",\n  \"lastName\": \"Smith\"\n}\n----\n\n==== EngagementService: POST /feedback\n\n*Request*:\n[source,json]\n----\n{\n  \"contactId\": \"0034X00000ABCDEFG\",\n  \"category\": \"App\",\n  \"storeName\": \"OTR Adelaide\",\n  \"timeOfVisit\": \"2026-01-07T12:00:00Z\",\n  \"contactPhoneNumber\": \"+61412345678\",\n  \"message\": \"App crashed when submitting feedback\"\n}\n----\n\n*Response* (202 Accepted):\n[source,json]\n----\n{\n  \"feedbackId\": \"fb-2026-01-07-12345\",\n  \"status\": \"submitted\",\n  \"message\": \"Your feedback has been submitted!\"\n}\n----\n\n=== Salesforce Field Mappings\n\n==== Case Object Mapping\n\n[width=\"100%\",cols=\"25%,25%,25%,25%\",options=\"header\",]\n|===\n|OTR Field |Salesforce Field |Data Type |Notes\n\n|Category\n|Feedback_Category__c\n|Picklist\n|App, Service, Order, Rewards, Refund, Delete Account\n\n|Store Name\n|Store_Name__c\n|String (255)\n|OTR location name\n\n|Time of Visit\n|Time_of_Visit__c\n|DateTime\n|When customer visited store\n\n|Free Text Message\n|Description\n|Long Text (32,000)\n|Customer feedback message\n\n|===\n\n<<<\n=== Baseline Architecture\n\n==== Existing System Components\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Component |Current State |Status\n\n|*D365 Customer Engagement*\n|Customer support platform for OTR digital customers (Mobile App, Web), handles feedback submission and case management\n|**DEPRECATED** - Being replaced by Salesforce Service Cloud\n\n|*App-Specific Customer Database*\n|Stores customer contact data for Mobile App users, separate from Viva Energy systems\n|**MIGRATING** - One-time migration to Salesforce, then deprecated\n\n|*Mobile App*\n|iOS/Android native apps with feedback submission form including Category, Store Name, Time of Visit, Contact Phone Number, and Free Text Message fields\n|**REQUIRES UPDATE** - Integrate with ProfileService and EngagementService APIs (feedback form UI already complete)\n\n|*Salesforce Service Cloud*\n|Shared Viva Energy instance handling customer support for fuel wholesale, Shell Card customers, other retail channels\n|**EXPANDING** - Adding OTR digital customer support Cases and Contacts\n\n|*Existing AWS Infrastructure*\n|SNS+SQS / EventBridge / Kinesis available for event-driven architecture\n|**REUSING** - Event Bus implementation leverages existing infrastructure\n\n|===\n\n==== Integration Architecture\n\n*Current state:*\n\n* Mobile App → D365 Customer Engagement (direct integration)\n* App-specific customer database → standalone (no Salesforce integration)\n* No event-driven architecture (synchronous, tightly coupled)\n* No Anti-Corruption Layer protecting digital channels\n* Viva Energy support teams use Salesforce, OTR digital support uses D365 CE (fragmented)\n\n==== Technical Debt\n\n*No longer relevant* - D365 CE being deprecated, not documenting technical debt of system being retired.\n\n*New technical debt introduced by this migration:*\n\n* Salesforce field mapping TBD (requires coordination with Viva Energy Salesforce admin team)\n* Data isolation strategy TBD (Record Types, custom fields, queues - multi-tenant governance)\n* Salesforce webhook mechanism TBD (Outbound Messages vs Platform Events vs Process Builder)\n* Expected feedback volume unknown (gathering data for rate limit planning)\n\n=== Gap Analysis\n\n==== Missing Capabilities\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Missing Capability |Description\n\n|*ProfileService bounded context*\n|No existing service for Contact reconciliation with Salesforce - requires new microservice implementing JIT upsert by email, returning Salesforce Contact ID\n\n|*EngagementService bounded context*\n|No existing service for customer feedback facade - requires new microservice implementing Anti-Corruption Layer for Salesforce Case creation, Braze integration, async processing via Event Bus\n\n|*Event Bus domain event pattern*\n|No existing domain event publishing infrastructure - requires implementing event-driven architecture pattern using existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis)\n\n|*Async Case creation workflow*\n|Current D365 CE integration is synchronous - requires implementing async processing with retry logic, exponential backoff, dead letter queue\n\n|*Salesforce webhook integration*\n|No existing capability to receive Salesforce notifications - requires implementing webhook receiver in EngagementService for Case update notifications\n\n|*Braze push notification orchestration*\n|No existing integration for Case-related push notifications - requires implementing Braze campaign triggers from EngagementService\n\n|*Contact migration tooling*\n|No existing tooling for app database → Salesforce Contact migration with upsert logic (match by email/phone/VCI)\n\n|*Feedback form enhancements*\n|Mobile App feedback form lacks structured fields (Category, Store Name, Time of Visit, Contact Phone Number) - requires UI updates\n\n|===\n\n==== Missing Bounded Contexts\n\n[width=\"100%\",cols=\"30%,30%,40%\",options=\"header\",]\n|===\n|Bounded Context |Responsibilities |Implementation Status\n\n|*link:../bounded_context/profile.adoc[ProfileService]*\n|JIT Contact reconciliation with Salesforce (upsert by email), return Salesforce Contact ID to digital channels, foundation for future Flybuys partner linking\n|**NEW** - First bounded context implementation\n\n|*link:../bounded_context/engagement.adoc[EngagementService]*\n|Customer feedback submission facade, Anti-Corruption Layer for Salesforce Case creation, Braze integration for push notifications, async Case processing, webhook receiver for Case updates\n|**NEW** - First bounded context implementation\n\n|===\n\n==== Missing Integration Patterns\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Integration Pattern |Description\n\n|*Anti-Corruption Layer (ACL)*\n|EngagementService → Salesforce Service Cloud - protects digital channels from Salesforce API changes, translates between OTR domain language and Salesforce\n\n|*Conformist*\n|ProfileService/EngagementService → Salesforce - conform to existing Salesforce configuration and API contracts (shared Viva Energy instance)\n\n|*Event-Driven Architecture (OHS+PL)*\n|Event Bus publishing domain events (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`) for loose coupling between bounded contexts\n\n|*Just-In-Time (JIT) Integration*\n|ProfileService → Salesforce Contact reconciliation on-demand (no pre-sync)\n\n|*Async Processing*\n|EngagementService Case creation via Event Bus with retry, exponential backoff, dead letter queue\n\n|===\n\n=== Target State Architecture\n\n==== Architectural Building Blocks (ABB)\n\n[width=\"100%\",cols=\"20%,25%,30%,25%\",options=\"header\",]\n|===\n|ABB ID |Bounded Context |Responsibilities |Technology (TBD in Solution Architecture)\n\n|ABB-CS-001\n|*link:../bounded_context/profile.adoc[ProfileService]*\n|JIT Contact reconciliation with Salesforce (upsert by email), return Salesforce Contact ID, foundation for Flybuys partner linking\n|Microservice (.NET/Node.js), REST API, Salesforce REST API client\n\n|ABB-CS-002\n|*link:../bounded_context/engagement.adoc[EngagementService]*\n|Customer feedback submission facade, ACL for Salesforce Case creation, Braze integration, async processing, webhook receiver\n|Microservice (.NET/Node.js), REST API, Event Bus publisher/subscriber, Salesforce webhook receiver\n\n|ABB-CS-003\n|*Event Bus*\n|Domain event publishing infrastructure (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`)\n|AWS SNS+SQS / EventBridge / Kinesis\n\n|ABB-CS-004\n|*Salesforce Service Cloud*\n|System of Record for Contact and Case data (shared Viva Energy instance)\n|Salesforce Service Cloud (external SaaS)\n\n|ABB-CS-005\n|*Braze*\n|Marketing automation platform for push notifications\n|Braze (external SaaS) - existing integration\n\n|ABB-CS-006\n|*Mobile App*\n|iOS/Android native apps with enhanced feedback form (Category, Store Name, Time of Visit, Contact Phone Number, Free Text Message)\n|Kotlin Multiplatform, SwiftUI, Jetpack Compose\n\n|ABB-CS-007\n|*Contact Migration Tool*\n|One-time migration app database → Salesforce with upsert logic (match by email/phone/VCI)\n|Script/tool (.NET/Python/Node.js)\n\n|===\n\n==== Integration Architecture\n\n===== Integration Flows\n\n*Customer Feedback Submission (Async):*\n\n1. *Mobile App* → ProfileService: Authenticate user, get Salesforce Contact ID (JIT reconciliation)\n2. *Mobile App* → EngagementService: Submit feedback (POST /feedback with Contact ID, Category, Store Name, Time of Visit, Phone, Message)\n3. *EngagementService* → Mobile App: Immediate acknowledgment (\"Feedback submitted\")\n4. *EngagementService* → Event Bus: Publish work item for async Case creation\n5. *Background Worker* (EngagementService) → Salesforce: Create Case via REST API\n6. *Success*: EngagementService → Event Bus: Publish `SupportCaseCreated` event\n7. *EngagementService* → Braze: Trigger push notification campaign (\"Your feedback has been received, Case #12345\")\n8. *Failure*: Retry with exponential backoff → Dead Letter Queue → Ops team alert\n\n*Case Update Notification (Bidirectional):*\n\n1. *Support Agent* updates/resolves Case in Salesforce\n2. *Salesforce* → EngagementService: Webhook notification (Case updated)\n3. *EngagementService* → Event Bus: Publish `SupportCaseUpdated` or `SupportCaseResolved` event\n4. *EngagementService* → Braze: Trigger push notification campaign (\"Your case has been resolved\")\n\n*Contact Reconciliation (JIT):*\n\n1. *Mobile App user* authenticates\n2. *Mobile App* → ProfileService: GET /profile/contact-id\n3. *ProfileService* → Salesforce: Query Contact by email\n4. *Match found*: Return existing Salesforce Contact ID\n5. *No match*: Create new Contact in Salesforce, return new Contact ID\n6. *ProfileService* → Mobile App: Return Salesforce Contact ID (cached by Mobile App)\n\n===== System of Record Boundaries\n\n[width=\"100%\",cols=\"30%,35%,35%\",options=\"header\",]\n|===\n|Data Entity |System of Record |Rationale\n\n|*Contact*\n|Salesforce Service Cloud\n|Shared Viva Energy instance, unified customer profile across all channels (digital, wholesale, Shell Card, retail)\n\n|*Case*\n|Salesforce Service Cloud\n|Support agents manage Cases in Salesforce, digital channels submit via EngagementService ACL\n\n|*Feedback Submission (transient)*\n|None (no persistence)\n|EngagementService processes feedback and creates Case in Salesforce, no local storage\n\n|*Domain Events*\n|Event Bus (ephemeral)\n|Events published to Event Bus, consumed by subscribers, not persisted long-term (event sourcing not in scope)\n\n|===\n\n==== Data Architecture Principles\n\n===== Aggregate Persistence\n\n*ProfileService:*\n\n* **No local aggregate persistence** - ProfileService is stateless, queries Salesforce on-demand\n* Salesforce Contact is the aggregate root (owned by Salesforce)\n* ProfileService acts as facade/translator, not system of record\n\n*EngagementService:*\n\n* **No local aggregate persistence** - EngagementService is stateless, creates Cases in Salesforce via ACL\n* Salesforce Case is the aggregate root (owned by Salesforce)\n* EngagementService maintains no local Case state (Conformist pattern - trust Salesforce as source of truth)\n* Async processing state managed via Event Bus (work items in queue, not database)\n\n===== Event Store\n\n* **Event Bus** (SNS+SQS/EventBridge/Kinesis) handles domain event publishing\n* Events are **ephemeral** (consumed and discarded, not persisted for event sourcing)\n* No Event Store implementation in this architecture (future enhancement if needed)\n* Event schema versioning TBD in Solution Architecture\n\n\n=== Architecture Decisions\n\n==== ADR-CS-001: Consolidate onto Salesforce Service Cloud (not build custom solution)\n\n*Status*: Accepted\n\n*Context*:\n\n* D365 Customer Engagement not working well for digital customer support\n* Viva Energy already uses Salesforce Service Cloud for fuel wholesale, Shell Card, other retail channels\n* Post-merger opportunity to consolidate onto single platform\n* Alternative: Build custom support platform or use different SaaS\n\n*Decision*:\n\nConsolidate OTR digital customer support onto Salesforce Service Cloud (shared Viva Energy instance).\n\n*Rationale*:\n\n* **Unified customer view**: Support agents see all interactions across channels (digital, wholesale, Shell Card, retail)\n* **Platform consolidation**: Single support platform reduces operational overhead and costs\n* **Proven solution**: Salesforce Service Cloud is established, feature-rich, well-supported\n* **Post-merger alignment**: Strategic decision to standardize on Viva Energy platforms\n* **Avoid custom development**: Building custom support platform would be costly and high-risk\n\n*Consequences*:\n\n* Unified customer support across Viva Energy Group\n* Reduced operational complexity (single platform vs two)\n* Leverage Salesforce capabilities (case routing, knowledge base, AI, omnichannel)\n* ⚠️ Conformist pattern required (shared instance, conform to existing configuration)\n* ⚠️ Multi-tenant governance needed (data isolation, security, queues)\n* ❌ Less control over platform evolution (SaaS vendor, shared instance)\n\n==== ADR-CS-002: Implement ProfileService and EngagementService as first DDD bounded contexts\n\n*Status*: Accepted\n\n*Context*:\n\n* OTR target architecture uses Domain-Driven Design with bounded contexts\n* This migration is opportunity to establish first implementation\n* Alternative: Direct Mobile App → Salesforce integration (no bounded contexts)\n* Alternative: Single monolithic service for all customer-facing APIs\n\n*Decision*:\n\nImplement ProfileService and EngagementService as separate bounded contexts following DDD strategic patterns.\n\n*Rationale*:\n\n* **Foundation for target architecture**: First implementation of DDD pattern for future bounded contexts (Flybuys, LocationService, PaymentService)\n* **Separation of concerns**: ProfileService handles identity/Contact reconciliation, EngagementService handles support/feedback (different responsibilities, different change rates)\n* **Anti-Corruption Layer**: EngagementService protects digital channels from Salesforce API changes\n* **Reusability**: ProfileService Contact reconciliation reused for Flybuys integration\n* **Event-driven architecture**: Establishes pattern for loose coupling between bounded contexts\n\n*Consequences*:\n\n* Establishes DDD architecture foundation for OTR\n* Reusable ProfileService for Flybuys and future integrations\n* Digital channels protected from Salesforce API changes (ACL)\n* Clear bounded context boundaries and responsibilities\n* ⚠️ Increased initial complexity (two new microservices vs direct integration)\n* ⚠️ Requires Event Bus infrastructure implementation\n* ⚠️ Team must learn DDD patterns and bounded context design\n\n==== ADR-CS-003: Async Case creation via Event Bus (not synchronous)\n\n*Status*: Accepted\n\n*Context*:\n\n* Current D365 CE integration is synchronous (user waits for Case creation)\n* Alternative: Keep synchronous integration (Mobile App → EngagementService → Salesforce synchronously)\n* Salesforce API may experience downtime or latency\n\n*Decision*:\n\nImplement async Case creation via Event Bus with immediate user acknowledgment, retry logic, exponential backoff, and dead letter queue.\n\n*Rationale*:\n\n* **Non-blocking user experience**: User gets immediate \"Feedback submitted\" confirmation, not waiting for Salesforce API\n* **Resilience**: If Salesforce is down, feedback still accepted, Case created when Salesforce recovers\n* **Retry logic**: Automatic retry with exponential backoff handles transient failures\n* **Operational visibility**: Dead letter queue alerts ops team to persistent failures\n* **Scalability**: Queue buffering handles traffic spikes\n\n*Consequences*:\n\n* Better user experience (no waiting for Salesforce API)\n* Resilient to Salesforce downtime (queue buffers work)\n* Automatic retry reduces manual intervention\n* Queue depth monitoring provides operational visibility\n* ⚠️ Eventual consistency (user gets success notification after Case created, not immediately)\n* ⚠️ Increased complexity (Event Bus, background workers, retry logic, DLQ)\n* ⚠️ Requires monitoring and alerting for DLQ\n\n==== ADR-CS-004: ProfileService uses email as primary matching key (not VCI)\n\n*Status*: Accepted\n\n*Context*:\n\n* ProfileService needs to reconcile Mobile App users as Salesforce Contacts\n* Alternative matching keys: VCI (Viva Consumer ID), email, phone, Salesforce External ID\n* Email changes are rare but possible\n\n*Decision*:\n\nUse email address as primary matching key for Contact reconciliation (JIT upsert by email).\n\n*Rationale*:\n\n* **Availability**: Email always available for authenticated users\n* **Uniqueness**: Email is unique identifier in Salesforce and Mobile App\n* **Salesforce standard**: Salesforce Contact uses email as standard lookup field\n* **Simplicity**: Single matching key simplifies upsert logic\n* **Edge case acceptable**: Email changes are rare, manual cleanup acceptable\n\n*Consequences*:\n\n* Simple upsert logic (query by email, create if not found)\n* Leverages Salesforce standard email field\n* Email always available from authentication\n* ⚠️ Email changes create duplicate Contacts (rare edge case, manual cleanup)\n* ⚠️ Future enhancement: Add VCI as Salesforce External ID for stable matching\n\n==== ADR-CS-005: No Case migration from D365 CE (fresh start)\n\n*Status*: Accepted\n\n*Context*:\n\n* D365 CE contains historical customer support Cases\n* Alternative: Migrate historical Cases to Salesforce (preserve support history)\n* Alternative: Archive D365 CE Cases separately (read-only access)\n\n*Decision*:\n\nDo not migrate historical Cases from D365 CE to Salesforce. Start fresh in Salesforce.\n\n*Rationale*:\n\n* **Limited value**: Historical D365 CE Cases not critical for future support\n* **Data quality**: D365 CE Case data may be inconsistent or incomplete\n* **Complexity**: Case migration requires mapping D365 CE schema to Salesforce, data transformation, validation\n* **Cost-benefit**: Migration effort outweighs value of historical data\n* **Archive option**: D365 CE Cases can be archived separately if needed (read-only access for auditing)\n\n*Consequences*:\n\n* Simpler migration (Contacts only, no Case migration)\n* Faster time to value (no Case migration delay)\n* Clean start in Salesforce (no legacy data quality issues)\n* ⚠️ Historical Cases not visible in Salesforce (support agents can't see old Cases)\n* ⚠️ D365 CE must remain accessible temporarily for historical Case lookups (if needed)\n* ❌ Loss of historical Case insights (reporting, analytics on old Cases)\n\n==== ADR-CS-006: Big bang cutover (not phased rollout)\n\n*Status*: Accepted\n\n*Context*:\n\n* Alternative: Phased rollout with feature flags (pilot users first, gradual enablement)\n* Alternative: Parallel run (submit to both D365 CE and Salesforce temporarily)\n* Flybuys integration uses phased rollout (AS-1, AS-2, AS-3 architecture states)\n\n*Decision*:\n\nBig bang cutover - migrate Contacts, deploy ProfileService and EngagementService, switch Mobile App, retire D365 CE.\n\n*Rationale*:\n\n* **Simplicity**: No parallel run complexity, no feature flag management\n* **Faster D365 CE retirement**: No extended transition period maintaining two systems\n* **Limited risk**: Customer support not mission-critical (not payment processing), rollback possible\n* **User base manageable**: OTR digital customers smaller than Flybuys integration scope\n* **Different use case**: Flybuys phased rollout manages points accrual complexity, support feedback is simpler\n\n*Consequences*:\n\n* Simpler deployment (single cutover, no AS-1/AS-2/AS-3 states)\n* Faster D365 CE retirement (no extended parallel run)\n* No feature flag complexity or pilot user management\n* ⚠️ Higher cutover risk (all users switch at once)\n* ⚠️ Requires comprehensive testing before cutover\n* ⚠️ Rollback plan required (revert to D365 CE if critical issues)\n\n==== ADR-CS-007: EngagementService receives Salesforce webhooks for Case updates\n\n*Status*: Accepted\n\n*Context*:\n\n* Support agents update/resolve Cases in Salesforce\n* Need to notify customers of Case status changes via push notifications\n* Alternative: Poll Salesforce API for Case updates (inefficient)\n* Alternative: No customer notifications (agents contact customers directly)\n\n*Decision*:\n\nSalesforce sends webhook notifications to EngagementService when Cases are updated/resolved. EngagementService triggers Braze push notifications.\n\n*Rationale*:\n\n* **Real-time notifications**: Customer notified immediately when agent resolves Case\n* **Efficient**: Webhook push model (not polling)\n* **Event-driven**: Aligns with event-driven architecture pattern\n* **Better customer experience**: Proactive notification vs waiting for agent contact\n\n*Consequences*:\n\n* Real-time customer notifications for Case updates\n* Efficient push model (no polling overhead)\n* Bidirectional integration (Mobile App → Salesforce → Mobile App)\n* ⚠️ Salesforce webhook mechanism TBD (Outbound Messages vs Platform Events vs Process Builder)\n* ⚠️ Webhook authentication and security required\n* ⚠️ EngagementService must handle webhook retries and failures\n\n<<<\n== Interface Specifications\n\nThis section provides references to the complete API specifications and event catalogue for ProfileService and EngagementService.\n\n=== REST API Specifications\n\nComplete OpenAPI 3.0 specifications are maintained in the `specifications/rest/` directory:\n\n==== ProfileService API v1\n\n*Specification*: link:../../specifications/rest/profile-service-v1.yaml[profile-service-v1.yaml]\n\n*Base URL*: `https://api.otr.com.au/profile/v1`\n\n*Authentication*: Bearer token (Microsoft Entra External ID JWT)\n\n*Key Endpoints*:\n\n* `GET /contact-id` - Retrieve or create Salesforce Contact ID for authenticated user (Just-In-Time reconciliation)\n** Used by Mobile App before submitting feedback to EngagementService\n** Upserts Salesforce Contact record using email as external key\n** Returns 18-character Salesforce Contact ID with caching (15-minute TTL)\n** Performance SLA: p95 < 300ms (uncached), p95 < 50ms (cached)\n\n==== EngagementService API v1\n\n*Specification*: link:../../specifications/rest/engagement-service-v1.yaml[engagement-service-v1.yaml]\n\n*Base URL*: `https://api.otr.com.au/engagement/v1`\n\n*Authentication*: Bearer token (Microsoft Entra External ID JWT)\n\n*Key Endpoints*:\n\n* `POST /feedback` - Submit customer feedback for async Case creation in Salesforce\n** Accepts contactId, category, storeName, timeOfVisit, contactPhoneNumber, message\n** Returns 202 Accepted immediately (async Case creation in background)\n** Publishes `CustomerFeedbackSubmitted` event for analytics\n** Creates Salesforce Case via Anti-Corruption Layer with retry logic\n** Performance SLA: p95 < 200ms (feedback accepted, not Case creation)\n\n=== Domain Events (AsyncAPI)\n\nComplete CloudEvents 1.0 JSON Schema specifications are maintained in the `specifications/events/` directory:\n\n*Specification*: link:../../specifications/events/engagement-events.json[engagement-events.json]\n\n==== Event Catalogue\n\n[width=\"100%\",cols=\"30%,20%,50%\",options=\"header\",]\n|===\n|Event Type |Publisher |Consumers\n\n|`CustomerFeedbackSubmitted`\n|EngagementService\n|Future bounded contexts, analytics, sentiment analysis\n\n|`SupportCaseCreated`\n|EngagementService\n|Future bounded contexts, analytics\n\n|`SupportCaseUpdated`\n|EngagementService (via Salesforce webhook)\n|Future bounded contexts, analytics\n\n|`SupportCaseResolved`\n|EngagementService (via Salesforce webhook)\n|Future bounded contexts, analytics\n\n|===\n\n==== Event Delivery Guarantees\n\n* **At-least-once delivery**: Events may be delivered multiple times, consumers must handle idempotency\n* **Ordering**: FIFO queues guarantee ordering for events with same `contactId`\n* **Retention**: 4 days (96 hours) in Event Bus\n* **Dead Letter Queue**: Failed events after 5 retries moved to DLQ for manual intervention\n* **Format**: CloudEvents 1.0 specification with JSON payload\n\n=== API Versioning Policy\n\n==== Version Numbering\n\n* **Format**: `/v{major}` in URL path (e.g., `/profile/v1`, `/engagement/v1`)\n* **Semantic Versioning**: Major version incremented for breaking changes only\n* **Backwards Compatibility**: Minor changes (new optional fields, new endpoints) don't require version bump\n\n==== When to Version\n\n*Breaking changes requiring new major version*:\n\n- Removing or renaming fields in request/response\n- Changing field data types (e.g., string → number)\n- Changing authentication mechanism\n- Removing endpoints\n\n*Non-breaking changes not requiring version bump*:\n\n- Adding new optional fields to request/response\n- Adding new endpoints\n- Expanding enum values (e.g., adding new feedback category)\n- Improving error messages\n\n==== Parallel Version Support\n\n* Support N and N-1 versions concurrently for 6 months\n* Deprecation notice: 3 months before sunsetting old version\n* Mobile App must upgrade to new version within deprecation window\n\n<<<\n== Work Packages\n\nThis section consolidates gaps and activities into implementable work packages aligned with TOGAF Phase E requirements.\n\n=== Work Package Overview\n\n[width=\"100%\",cols=\"15%,35%,25%,25%\",options=\"header\",]\n|===\n|Work Package ID |Name |Transition State |Key Deliverables\n\n|WP-CS-001\n|ProfileService Development\n|TS-1 (Build & Test)\n|ProfileService microservice, Salesforce Contact integration, REST API\n\n|WP-CS-002\n|EngagementService Development\n|TS-1 (Build & Test)\n|EngagementService microservice, Anti-Corruption Layer, Braze integration\n\n|WP-CS-003\n|Event Bus Infrastructure\n|TS-1 (Build & Test)\n|Event Bus configuration, CloudEvents schemas, monitoring\n\n|WP-CS-004\n|Contact Migration Tooling\n|TS-1 (Build & Test)\n|Migration tool, validation scripts, reconciliation reporting\n\n|WP-CS-005\n|Mobile App Integration\n|TS-1 (Build & Test)\n|Mobile App API integration, feedback form enhancements, testing\n\n|WP-CS-006\n|Integration Testing\n|TS-1 (Build & Test)\n|Test environments, integration test suites, UAT execution\n\n|WP-CS-007\n|Salesforce Configuration\n|TS-1 (Build & Test)\n|Salesforce field mapping, data isolation, webhook configuration\n\n|WP-CS-008\n|Contact Data Migration\n|TS-2 (Contact Migration)\n|Contact migration execution, validation, reconciliation\n\n|WP-CS-009\n|Production Deployment\n|TS-3 (Cutover)\n|Production deployment, smoke testing, go-live execution\n\n|WP-CS-010\n|Post-Cutover Support\n|TS-4 (Target State)\n|Monitoring, issue resolution, D365 CE retirement\n\n|===\n\n[[wp-cs-001]]\n=== WP-CS-001: ProfileService Development\n\n==== Description\n\nBuild ProfileService bounded context microservice implementing Just-In-Time Contact reconciliation with Salesforce Service Cloud.\n\n==== Deliverables\n\n* ProfileService microservice application\n** REST API implementation (OpenAPI 3.0 specification)\n** `GET /contact-id` endpoint (Salesforce Contact reconciliation)\n** Authentication/authorization with Microsoft Entra External ID\n** Caching layer (15-minute TTL for Contact IDs)\n* Salesforce integration\n** Salesforce REST API client\n** Contact upsert by email (external key matching)\n** Error handling and retry logic\n* Unit tests (>80% code coverage)\n* Integration tests with Salesforce sandbox\n* API documentation\n* Deployment configuration (IaC - Infrastructure as Code)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* Salesforce sandbox environment provisioned\n* Microsoft Entra External ID OAuth configuration\n* Development environment setup (AWS dev account, CI/CD pipeline)\n\n*Dependent Work Packages*:\n\n* None (can start immediately after prerequisites met)\n\n==== Skills Required\n\n* Backend development (.NET Core or Node.js)\n* REST API design and implementation\n* Salesforce REST API integration\n* OAuth 2.0 / JWT authentication\n* Caching strategies (Redis/ElastiCache)\n* Unit/integration testing frameworks\n* Infrastructure as Code (Terraform/CloudFormation)\n\n==== Acceptance Criteria\n\n* All API endpoints return correct HTTP status codes per OpenAPI specification\n* Contact ID retrieval achieves p95 < 300ms (uncached), p95 < 50ms (cached)\n* Salesforce Contact upsert succeeds with 100% accuracy in sandbox testing\n* Unit test coverage > 80%\n* Integration tests pass in sandbox environment\n* API documentation generated from OpenAPI specification\n\n[[wp-cs-002]]\n=== WP-CS-002: EngagementService Development\n\n==== Description\n\nBuild EngagementService bounded context microservice implementing customer feedback submission, Anti-Corruption Layer for Salesforce Case creation, Braze integration, and webhook receiver for Case updates.\n\n==== Deliverables\n\n* EngagementService microservice application\n** REST API implementation (OpenAPI 3.0 specification)\n** `POST /feedback` endpoint (async feedback submission)\n** Authentication/authorization with Microsoft Entra External ID\n** Webhook receiver endpoint for Salesforce Case updates\n* Anti-Corruption Layer (ACL)\n** OTR domain model to Salesforce API translation\n** Category enum mapping (App/Service/Order/Rewards → Salesforce Case fields)\n** Salesforce REST API client for Case creation\n* Async processing infrastructure\n** Event Bus publisher integration\n** Background worker for Case creation\n** Retry logic with exponential backoff (5 attempts)\n** Dead Letter Queue integration\n* Braze integration\n** Braze campaign trigger API client\n** Push notification orchestration for Case updates\n* Domain event publishing\n** `CustomerFeedbackSubmitted` event publisher\n** `SupportCaseCreated` event publisher\n** `SupportCaseUpdated` event translator (Salesforce webhook → domain event)\n** `SupportCaseResolved` event translator (Salesforce webhook → domain event)\n* Unit tests (>80% code coverage)\n* Integration tests (EngagementService ↔ Salesforce, EngagementService ↔ Braze)\n* API documentation\n* Deployment configuration (IaC)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-003 (Event Bus Infrastructure) completed\n* Salesforce sandbox environment provisioned\n* Braze API credentials and campaign templates configured\n* Microsoft Entra External ID OAuth configuration\n\n*Dependent Work Packages*:\n\n* WP-CS-003 must be completed first (Event Bus required for async processing)\n* WP-CS-007 (Salesforce Configuration) must be in progress (field mapping needed)\n\n==== Skills Required\n\n* Backend development (.NET Core or Node.js)\n* REST API design and implementation\n* Salesforce REST API integration\n* Event-driven architecture patterns\n* Async/background processing (queues, workers)\n* Braze API integration\n* Webhook design and security\n* OAuth 2.0 / JWT authentication\n* Domain-Driven Design (DDD) - Anti-Corruption Layer pattern\n* Unit/integration testing frameworks\n* Infrastructure as Code (Terraform/CloudFormation)\n\n==== Acceptance Criteria\n\n* Feedback submission endpoint returns 202 Accepted within p95 < 200ms\n* Async Case creation succeeds with >99.5% success rate (including retries)\n* Anti-Corruption Layer correctly maps all feedback categories to Salesforce Case fields\n* Webhook receiver processes Salesforce Case updates and publishes domain events\n* Braze push notifications sent successfully for Case updates\n* Failed Case creation moves to Dead Letter Queue after 5 retry attempts\n* Unit test coverage > 80%\n* Integration tests pass with Salesforce sandbox and Braze staging environment\n\n[[wp-cs-003]]\n=== WP-CS-003: Event Bus Infrastructure\n\n==== Description\n\nImplement Event Bus infrastructure for domain event publishing using existing AWS infrastructure (SNS+SQS, EventBridge, or Kinesis).\n\n==== Deliverables\n\n* Event Bus infrastructure configuration\n** Topic/stream provisioning (technology choice: SNS+SQS / EventBridge / Kinesis)\n** FIFO queue configuration (ordering by `contactId`)\n** Dead Letter Queue (DLQ) setup\n** Retention policy (4 days / 96 hours)\n** Access control policies (IAM roles, permissions)\n* CloudEvents 1.0 schema definitions\n** JSON Schema specifications for all domain events\n** Schema validation configuration\n** Schema registry (if using EventBridge/Kinesis)\n* Monitoring and alerting\n** CloudWatch dashboards for queue metrics\n** Alarms for DLQ depth, queue age, processing failures\n** Event Bus throughput monitoring\n* Documentation\n** Event Bus architecture diagram\n** Event publishing guidelines\n** Consumer integration guide\n* Infrastructure as Code (IaC)\n** Terraform/CloudFormation templates for all infrastructure\n\n==== Dependencies\n\n*Prerequisites*:\n\n* AWS account access (existing infrastructure)\n* Technology selection decision (SNS+SQS vs EventBridge vs Kinesis)\n* CloudEvents 1.0 schema design approval\n\n*Dependent Work Packages*:\n\n* None (foundational infrastructure, can start early)\n\n==== Skills Required\n\n* AWS messaging services (SNS, SQS, EventBridge, Kinesis)\n* Event-driven architecture patterns\n* CloudEvents specification\n* JSON Schema design\n* Infrastructure as Code (Terraform/CloudFormation)\n* AWS IAM security configuration\n* CloudWatch monitoring and alerting\n\n==== Acceptance Criteria\n\n* Event Bus infrastructure provisioned in all environments (dev, staging, production)\n* FIFO ordering validated for events with same `contactId`\n* Dead Letter Queue triggers alarms when messages arrive\n* Event retention policy enforced (4 days)\n* CloudEvents 1.0 schema validation enabled\n* Monitoring dashboards operational\n* Infrastructure fully codified (IaC)\n\n[[wp-cs-004]]\n=== WP-CS-004: Contact Migration Tooling\n\n==== Description\n\nDevelop Contact migration tool for one-time migration from app-specific database to Salesforce Service Cloud with upsert logic and validation.\n\n==== Deliverables\n\n* Contact migration tool\n** Extract Contacts from app-specific database\n** Transform to Salesforce Contact API format\n** Upsert to Salesforce using email as external key\n** Fallback matching by phone number or Viva Consumer ID\n** Batch processing with rate limiting (respect Salesforce API limits)\n** Idempotent operation (can be re-run safely)\n* Validation scripts\n** Pre-migration validation (data quality checks)\n** Post-migration validation (100% Contact reconciliation)\n** Email/phone/VCI matching accuracy report\n* Reconciliation reporting\n** Contacts created vs updated statistics\n** Failed upserts with error details\n** Matching accuracy metrics\n* Rollback capability\n** Export snapshot of Salesforce Contacts before migration\n** Rollback procedure documentation\n* Documentation\n** Migration tool user guide\n** Troubleshooting guide\n** Runbook for migration execution\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-001 (ProfileService Development) completed (reuses Salesforce integration code)\n* Salesforce sandbox environment for migration testing\n* App-specific database access (read-only sufficient)\n* Salesforce production access granted\n\n*Dependent Work Packages*:\n\n* WP-CS-001 provides Salesforce Contact upsert logic to reuse\n\n==== Skills Required\n\n* Database development (SQL, data extraction)\n* Salesforce REST API integration\n* Batch processing and ETL patterns\n* Data validation and reconciliation\n* Error handling and logging\n* Scripting (Python, PowerShell, or similar)\n\n==== Acceptance Criteria\n\n* Migration tool successfully migrates 100% of Contacts in sandbox with zero data loss\n* Email/phone/VCI matching accuracy > 95% in sandbox testing\n* Failed upserts captured with actionable error messages\n* Reconciliation report matches actual Salesforce Contact counts\n* Migration tool execution time acceptable for production (freezes app database for minimum time)\n* Rollback procedure validated in sandbox\n* Documentation complete and approved\n\n[[wp-cs-005]]\n=== WP-CS-005: Mobile App Integration\n\n==== Description\n\nUpdate Mobile App to integrate with ProfileService and EngagementService APIs, replacing D365 CE integration.\n\n==== Deliverables\n\n* Feedback form UI enhancements\n** Add Category dropdown (App, Service, Order, Rewards, Refund, Delete Account)\n** Add Store Name field (optional)\n** Add Time of Visit field (optional, datetime picker)\n** Add Contact Phone Number field (optional, E.164 validation)\n** Update Message field (1-2000 character limit with counter)\n* API integration (Kotlin Multiplatform shared code)\n** ProfileService client (`GET /contact-id`)\n** EngagementService client (`POST /feedback`)\n** JWT token management (Microsoft Entra External ID)\n** Error handling (network failures, API errors, validation errors)\n** Retry logic for transient failures\n* Platform-specific UI (SwiftUI for iOS, Jetpack Compose for Android)\n** Feedback form screens\n** Success/error confirmation screens\n** Loading states and progress indicators\n* Feature flag integration\n** `enable_salesforce_feedback_submission` flag\n** Fallback to D365 CE if flag disabled (during rollout)\n* Unit tests for shared business logic\n* UI tests for platform-specific screens\n* API integration tests (mocked APIs)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-001 (ProfileService Development) completed and deployed to dev/staging\n* WP-CS-002 (EngagementService Development) completed and deployed to dev/staging\n* ProfileService and EngagementService OpenAPI specifications finalized\n* Feature flag service configured\n\n*Dependent Work Packages*:\n\n* Must complete after WP-CS-001 and WP-CS-002 (requires API endpoints available for integration testing)\n\n==== Skills Required\n\n* Kotlin Multiplatform development\n* SwiftUI (iOS native UI)\n* Jetpack Compose (Android native UI)\n* REST API client development\n* OAuth 2.0 / JWT authentication\n* Form validation and UX design\n* Unit testing (Kotlin, Swift)\n* UI testing frameworks (XCTest, Espresso)\n\n==== Acceptance Criteria\n\n* Feedback form UI matches UX design specifications\n* All form fields validate correctly (client-side validation)\n* API integration successfully calls ProfileService and EngagementService in dev/staging\n* Error handling provides user-friendly error messages\n* Feature flag correctly toggles between Salesforce and D365 CE integration\n* Unit test coverage > 80% for shared business logic\n* UI tests pass for all feedback form workflows (happy path, error states)\n* App builds and deploys successfully to TestFlight (iOS) and Google Play Internal Testing (Android)\n\n[[wp-cs-006]]\n=== WP-CS-006: Integration Testing\n\n==== Description\n\nExecute comprehensive integration testing across all system components in non-production environments.\n\n==== Deliverables\n\n* Test environment setup\n** Salesforce sandbox configured with test data\n** ProfileService deployed to staging\n** EngagementService deployed to staging\n** Event Bus staging infrastructure\n** Braze staging environment configured\n** Mobile App TestFlight/Internal Testing builds\n* Integration test suites\n** ProfileService ↔ Salesforce (Contact upsert scenarios)\n** EngagementService ↔ Salesforce (Case creation scenarios)\n** EngagementService ↔ Braze (push notification scenarios)\n** Mobile App ↔ ProfileService ↔ EngagementService (end-to-end workflows)\n** Event Bus publishing and consumption\n** Webhook receiver (Salesforce → EngagementService)\n* Test scenarios\n** Happy path: Successful feedback submission and Case creation\n** Error scenarios: Salesforce API failures, Braze API failures, network timeouts\n** Retry scenarios: Async Case creation retries, DLQ validation\n** Performance testing: p95 latency validation for ProfileService and EngagementService\n** Load testing: Simulate 3x-10x expected volume\n* UAT execution\n** Business stakeholder UAT sessions\n** UAT test cases covering all feedback categories\n** UAT sign-off documentation\n* Test results documentation\n** Test execution reports\n** Defect tracking and resolution\n** Performance test results\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-001 (ProfileService Development) completed\n* WP-CS-002 (EngagementService Development) completed\n* WP-CS-003 (Event Bus Infrastructure) completed\n* WP-CS-005 (Mobile App Integration) completed\n* WP-CS-007 (Salesforce Configuration) sandbox configuration completed\n\n*Dependent Work Packages*:\n\n* Must complete after WP-CS-001, WP-CS-002, WP-CS-003, WP-CS-005 (requires all components available)\n\n==== Skills Required\n\n* Integration testing strategy and execution\n* Test automation frameworks (Postman, Newman, Selenium)\n* Performance testing tools (JMeter, k6, Gatling)\n* Salesforce sandbox administration\n* Test data management\n* Defect tracking and triage\n* UAT facilitation\n\n==== Acceptance Criteria\n\n* All integration test scenarios pass (happy path, error scenarios, retry scenarios)\n* Performance SLAs validated (ProfileService p95 < 300ms, EngagementService p95 < 200ms)\n* Load testing confirms system handles 3x expected volume without degradation\n* UAT sign-off obtained from business stakeholders\n* Zero critical defects (P1/P2) open before moving to Contact Migration\n* Test results documented and approved\n\n[[wp-cs-007]]\n=== WP-CS-007: Salesforce Configuration\n\n==== Description\n\nConfigure Salesforce Service Cloud for OTR digital customer support integration, including field mapping, data isolation, and webhook setup.\n\n==== Deliverables\n\n* Salesforce Contact configuration\n** Custom fields for OTR-specific data (if needed)\n** Email as external key configuration\n** Record Type for OTR digital customers (data isolation)\n** Validation rules\n* Salesforce Case configuration\n** Custom fields for feedback categories (App, Service, Order, Rewards, Refund, Delete Account)\n** Case Type and Reason picklist mapping\n** Queue assignment rules (OTR digital support queue)\n** Case escalation rules\n** Case routing rules\n* Salesforce webhook configuration\n** Platform Events / Outbound Messages for Case updates\n** Webhook authentication (API key, JWT, or OAuth)\n** Case status change triggers (New → In Progress, Resolved, Closed)\n** Webhook payload format (JSON)\n* Data isolation strategy\n** Record Types for OTR vs other Viva Energy business units\n** Queues for OTR-specific Cases\n** Reporting and dashboards scoped to OTR data\n* Salesforce API access\n** Connected App configuration\n** OAuth 2.0 JWT bearer flow setup\n** API user credentials\n** API rate limit monitoring\n* Documentation\n** Salesforce field mapping specification\n** Webhook configuration guide\n** Data isolation architecture diagram\n** API authentication setup guide\n\n==== Dependencies\n\n*Prerequisites*:\n\n* Viva Energy Salesforce admin team engagement\n* Salesforce governance approval (multi-tenant environment)\n* Technical decision on webhook mechanism (Platform Events vs Outbound Messages)\n* Technical decision on authentication method (OAuth 2.0 JWT bearer flow recommended)\n\n*Dependent Work Packages*:\n\n* None (can start in parallel with development work packages)\n* Required for WP-CS-002 (EngagementService needs field mapping)\n* Required for WP-CS-006 (Integration Testing needs sandbox configuration)\n\n==== Skills Required\n\n* Salesforce administration\n* Salesforce configuration (Record Types, Queues, Validation Rules)\n* Salesforce API integration (REST API, Platform Events, Outbound Messages)\n* Salesforce security and authentication (OAuth, Connected Apps)\n* Multi-tenant data isolation patterns\n\n==== Acceptance Criteria\n\n* Salesforce sandbox configured with all custom fields, Record Types, Queues\n* Field mapping documented and approved by OTR business stakeholders\n* Webhook configuration tested and delivering Case update notifications\n* Data isolation validated (OTR data separate from other Viva Energy business units)\n* API authentication working for ProfileService and EngagementService\n* Salesforce API rate limits monitored and acceptable for expected volume\n* Configuration replicated to Salesforce production environment\n\n[[wp-cs-008]]\n=== WP-CS-008: Contact Data Migration\n\n==== Description\n\nExecute one-time Contact migration from app-specific database to Salesforce Service Cloud production.\n\n==== Deliverables\n\n* Pre-migration activities\n** Final validation of migration tool in sandbox\n** Communication plan (notify users of maintenance window if needed)\n** Freeze app-specific database Contact updates\n** Backup app-specific database\n** Export snapshot of Salesforce Contacts (rollback preparation)\n* Migration execution\n** Execute migration tool against Salesforce production\n** Monitor migration progress\n** Handle failed upserts (manual intervention if needed)\n* Post-migration validation\n** 100% Contact reconciliation (app database vs Salesforce)\n** Email/phone/VCI matching accuracy report\n** Reconciliation report (Contacts created vs updated)\n** Data integrity checks (no duplicate Contacts, no missing Contacts)\n* ProfileService smoke testing\n** Verify Contact ID retrieval works in production\n** Test cache behavior\n** Validate Salesforce Contact upserts from ProfileService\n* Migration report\n** Total Contacts migrated\n** Contacts created vs updated\n** Failed upserts (if any) with resolution\n** Matching accuracy metrics\n** Migration execution time\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-004 (Contact Migration Tooling) completed\n* WP-CS-001 (ProfileService Development) deployed to production (not yet integrated with Mobile App)\n* WP-CS-007 (Salesforce Configuration) production configuration completed\n* Salesforce production access granted\n* Migration approved by business stakeholders\n\n*Dependent Work Packages*:\n\n* Must complete after WP-CS-001, WP-CS-004, WP-CS-007\n* Must complete before WP-CS-009 (Production Deployment)\n\n==== Skills Required\n\n* Data migration execution\n* Salesforce administration\n* Database operations\n* Data validation and reconciliation\n* Incident management (if issues arise)\n\n==== Acceptance Criteria\n\n* 100% of Contacts migrated with zero data loss\n* Email/phone/VCI matching accuracy > 95%\n* ProfileService smoke tests pass in production\n* Reconciliation report approved by business stakeholders\n* App-specific database Contact updates frozen (read-only mode)\n* Rollback procedure ready (but not executed if migration successful)\n\n[[wp-cs-009]]\n=== WP-CS-009: Production Deployment\n\n==== Description\n\nDeploy all solution components to production and execute cutover from D365 CE to Salesforce Service Cloud.\n\n==== Deliverables\n\n* Production deployment\n** EngagementService deployed to production\n** Event Bus production infrastructure validated\n** Salesforce webhook configured in production\n** Mobile App released to production (App Store, Google Play)\n* Go-live activities\n** Smoke testing (end-to-end feedback submission)\n** Feature flag enabled: `enable_salesforce_feedback_submission = ON`\n** D365 CE integration disabled in Mobile App\n** Monitor Event Bus queue depth, DLQ, Salesforce API rate limits\n** Monitor Mobile App feedback submission success rate\n* Go/No-Go decision\n** Validate success criteria before final cutover\n** Business stakeholder approval\n** Technical validation (smoke tests pass, monitoring healthy)\n* Cutover communication\n** Notify support agents of new Salesforce integration\n** Provide training materials for support agents\n** Customer communication (if visible change)\n* Rollback plan\n** Documented rollback procedure\n** Feature flag can disable Salesforce integration and re-enable D365 CE\n** Rollback decision criteria (P1/P2 incidents, feedback submission success rate < 99%)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-001 (ProfileService Development) completed\n* WP-CS-002 (EngagementService Development) completed\n* WP-CS-003 (Event Bus Infrastructure) completed\n* WP-CS-005 (Mobile App Integration) completed\n* WP-CS-006 (Integration Testing) completed with UAT sign-off\n* WP-CS-007 (Salesforce Configuration) production configuration completed\n* WP-CS-008 (Contact Data Migration) completed successfully\n* Mobile App release approval (App Store, Google Play)\n\n*Dependent Work Packages*:\n\n* Must complete after all prior work packages (final cutover)\n\n==== Skills Required\n\n* Production deployment and release management\n* Incident management and troubleshooting\n* Monitoring and observability\n* Change management and communication\n* Rollback execution (if needed)\n\n==== Acceptance Criteria\n\n* Mobile App feedback submission success rate > 99.5%\n* End-to-end flow validated (Mobile App → ProfileService → EngagementService → Salesforce Case created)\n* Braze push notifications delivered successfully\n* Event Bus queue depth normal, DLQ empty\n* No critical incidents (P1/P2) in first 24 hours\n* D365 CE integration disabled\n* Support agents successfully using Salesforce for OTR digital customer Cases\n\n[[wp-cs-010]]\n=== WP-CS-010: Post-Cutover Support\n\n==== Description\n\nMonitor production stability, resolve issues, validate success criteria, and execute D365 CE retirement.\n\n==== Deliverables\n\n* Monitoring and support\n** 24/7 on-call support for first week post-cutover\n** Daily monitoring reports (feedback submission success rate, Case creation success rate)\n** Incident response and resolution\n** Performance tuning (if needed)\n* Success criteria validation\n** Validate feedback submission success rate > 99.5%\n** Monitor customer satisfaction score (target: +15% improvement within 6 months)\n** Monitor average case resolution time (target: -20% improvement within 6 months)\n** Support agent feedback survey\n* D365 CE retirement\n** D365 CE set to read-only mode (historical Case lookups only)\n** Archive D365 CE data for compliance/auditing\n** Decommission D365 CE infrastructure (after 90-day stabilization period)\n** Remove D365 CE integration code from Mobile App\n* Documentation updates\n** Production runbook\n** Troubleshooting guide (based on incidents resolved)\n** Operational procedures for support team\n** Lessons learned document\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-009 (Production Deployment) completed\n* Cutover successful with no critical incidents\n\n*Dependent Work Packages*:\n\n* Final work package in sequence\n\n==== Skills Required\n\n* Production support and incident management\n* Performance monitoring and tuning\n* Data archival and compliance\n* Infrastructure decommissioning\n* Documentation\n\n==== Acceptance Criteria\n\n* Zero critical incidents (P1/P2) in first 30 days post-cutover\n* Feedback submission success rate sustained > 99.5%\n* Customer satisfaction improvement validated (baseline established, ongoing measurement)\n* Support agents reporting positive experience with Salesforce unified view\n* D365 CE successfully decommissioned\n* All production documentation complete and approved\n* Lessons learned document published\n\n=== Work Package Sequencing\n\n==== Parallel Track 1: Infrastructure & Configuration\n\nCan start immediately and run in parallel:\n\n* WP-CS-003 (Event Bus Infrastructure)\n* WP-CS-007 (Salesforce Configuration)\n\n==== Parallel Track 2: Development\n\nCan start after Track 1 infrastructure decisions made:\n\n* WP-CS-001 (ProfileService Development) - Independent\n* WP-CS-002 (EngagementService Development) - Requires WP-CS-003 completed\n* WP-CS-004 (Contact Migration Tooling) - Requires WP-CS-001 completed (reuses code)\n\n==== Sequential Track 3: Integration & Testing\n\nMust complete after development:\n\n* WP-CS-005 (Mobile App Integration) - Requires WP-CS-001, WP-CS-002\n* WP-CS-006 (Integration Testing) - Requires WP-CS-001, WP-CS-002, WP-CS-003, WP-CS-005, WP-CS-007\n\n==== Sequential Track 4: Migration & Cutover\n\nMust complete sequentially:\n\n* WP-CS-008 (Contact Data Migration) - Requires WP-CS-001, WP-CS-004, WP-CS-006 UAT sign-off\n* WP-CS-009 (Production Deployment) - Requires all prior work packages completed\n* WP-CS-010 (Post-Cutover Support) - Requires WP-CS-009\n\n==== Critical Path\n\nThe critical path for this project is:\n\n. WP-CS-003 (Event Bus Infrastructure)\n. WP-CS-002 (EngagementService Development) - blocks on WP-CS-003\n. WP-CS-005 (Mobile App Integration) - blocks on WP-CS-001, WP-CS-002\n. WP-CS-006 (Integration Testing) - blocks on WP-CS-001 through WP-CS-005, WP-CS-007\n. WP-CS-008 (Contact Data Migration) - blocks on WP-CS-006 UAT sign-off\n. WP-CS-009 (Production Deployment) - blocks on WP-CS-008\n. WP-CS-010 (Post-Cutover Support) - final deliverable\n\nAny delays in critical path work packages will delay the overall cutover date.\n\n<<<\n== Transition Architecture\n\nThis section defines the evolution from baseline (D365 CE) to target state (Salesforce Service Cloud + ProfileService + EngagementService).\n\n=== Transition Approach\n\n*Big Bang Cutover*: Per ADR-CS-006, this transition uses a single cutover approach rather than phased rollout. All users switch from D365 CE to Salesforce simultaneously after Contact migration completion.\n\n=== Transition States\n\n==== TS-0: Baseline State (Current)\n\n===== Characteristics\n\n* D365 Customer Engagement handles all digital customer feedback\n* App-specific database stores customer Contact data\n* No ProfileService or EngagementService\n* No event-driven architecture\n* Synchronous feedback submission\n\n===== Components Active\n\n- D365 Customer Engagement\n- App-specific customer database\n- Mobile App (current version with D365 CE integration)\n\n==== TS-1: Build & Test\n\n===== Activities\n\n* Build ProfileService microservice (JIT Contact reconciliation API)\n* Build EngagementService microservice (feedback submission API, ACL for Salesforce Case creation, Braze integration, webhook receiver)\n* Implement Event Bus infrastructure (SNS+SQS/EventBridge/Kinesis)\n* Develop Contact migration tool (app database → Salesforce upsert by email/phone/VCI)\n* Update Mobile App API integration (ProfileService + EngagementService endpoints - feedback form UI already complete)\n* Integration testing (ProfileService ↔ Salesforce, EngagementService ↔ Salesforce, EngagementService ↔ Braze)\n* UAT with test Salesforce sandbox environment\n\n===== Components Active\n\n- D365 Customer Engagement (still active, unchanged)\n- App-specific customer database (still active)\n- ProfileService (non-production, testing only)\n- EngagementService (non-production, testing only)\n- Event Bus (non-production)\n- Salesforce Sandbox (testing)\n\n===== Exit Criteria\n\n- All integration tests pass\n- UAT sign-off from business stakeholders\n- Contact migration tool validated in sandbox\n- Mobile App updates tested with non-production APIs\n\n==== TS-2: Contact Migration\n\n===== Activities\n* Execute Contact migration (app database → Salesforce production)\n* Validation: 100% data integrity check (email/phone/VCI matching)\n* Reconciliation report: New Contacts created vs existing Contacts updated\n* Freeze app database Contact updates during migration window\n* ProfileService smoke testing (verify Contact lookups work in Salesforce production)\n\n===== Components Active\n- D365 Customer Engagement (still active, users unaffected)\n- Salesforce Production (Contacts migrated, no Cases yet)\n- ProfileService (production deployed, not integrated with Mobile App yet)\n- App-specific customer database (frozen, read-only)\n\n===== Exit Criteria\n- 100% of Contacts migrated with zero data loss\n- Email/phone/VCI matching accuracy > 95%\n- ProfileService smoke tests pass (JIT lookups return correct Contact IDs)\n- Reconciliation report approved\n\n==== TS-3: Cutover (Go-Live)\n\n===== Go-Live Activities\n\n* Deploy EngagementService to production\n* Deploy Mobile App updates (ProfileService + EngagementService API integration)\n* Configure Salesforce webhook (Case update notifications → EngagementService)\n* Smoke testing: End-to-end feedback submission (Mobile App → EngagementService → Salesforce → Braze notification)\n* Monitor Event Bus queue depth, dead letter queue, Salesforce API rate limits\n* **Go/No-Go decision**: Validate success criteria before final cutover\n* Enable feature flag: `enable_salesforce_feedback_submission = ON`\n* Disable D365 CE integration in Mobile App\n\n===== Components Active\n\n- ProfileService (production, integrated with Mobile App)\n- EngagementService (production, integrated with Mobile App)\n- Event Bus (production, processing async Case creation)\n- Salesforce Production (receiving Cases from digital customers)\n- Braze (sending push notifications)\n- Mobile App (new version with Salesforce integration)\n- D365 Customer Engagement (disabled, read-only for historical lookups)\n\n===== Exit Criteria\n\n- Mobile App feedback submission success rate > 99.5%\n- End-to-end flow validated (Mobile App → Salesforce Case created)\n- Braze push notifications delivered successfully\n- Event Bus queue depth normal, DLQ empty\n- No critical incidents (P1/P2) in first 24 hours\n\n==== TS-4: Target State (Stable Production)\n\n===== Characteristics\n\n* ProfileService and EngagementService fully operational\n* All digital customer feedback routed to Salesforce\n* Event-driven architecture established\n* D365 CE decommissioned\n* First DDD bounded contexts implemented successfully\n\n===== Monitoring Period\n\n* Validate success criteria: feedback submission rate > 99.5%, no data loss\n* Monitor customer satisfaction score (target: +15% improvement)\n* Monitor average case resolution time (target: -20% improvement)\n* Support agents using unified Salesforce view across all channels\n\n===== D365 CE Retirement\n\n* D365 CE read-only access for historical Case lookups (if needed)\n* Decommission D365 CE infrastructure after 90 days\n* Archive D365 CE data for compliance/auditing\n\n===== Components Active\n\n- ProfileService (production)\n- EngagementService (production)\n- Event Bus (production)\n- Salesforce Production (system of record)\n- Braze (push notifications)\n- Mobile App (Salesforce integration)\n- App-specific database (deprecated, Contact data no longer updated)\n\n===== Success Criteria Achieved\n\n- All digital customer feedback routed to Salesforce\n- Support agents have unified customer view\n- D365 CE decommissioned\n- Customer satisfaction improved by 15%\n- Average case resolution time decreased by 20%\n- Zero data loss during transition\n\n=== Transition Dependencies\n\n[width=\"100%\",cols=\"40%,60%\",options=\"header\",]\n|===\n|Dependency |Owner/Status\n\n|*Salesforce production access*\n|Viva Energy Salesforce admin team - TBD\n\n|*Salesforce Case field mapping*\n|Viva Energy Salesforce admin team - TBD (map OTR feedback categories to Salesforce fields)\n\n|*Salesforce data isolation strategy*\n|Viva Energy Salesforce admin team - TBD (Record Types, queues, custom fields)\n\n|*Salesforce webhook configuration*\n|Viva Energy Salesforce admin team - TBD (Outbound Messages vs Platform Events)\n\n|*Event Bus infrastructure*\n|OTR Platform team - Existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis)\n\n|*Braze integration*\n|OTR Marketing team - Existing Braze account, EngagementService creates new campaigns\n\n|*Mobile App release window*\n|OTR Mobile team - Coordinate cutover timing with app release schedule\n\n|*App database access*\n|OTR Platform team - Read access for Contact migration\n\n|===\n\n=== Transition Validation Criteria\n\n==== Contact Migration Validation\n\n* 100% of app database Contacts migrated to Salesforce (zero data loss)\n* Email/phone/VCI matching accuracy > 95% (minimize duplicate Contacts)\n* ProfileService JIT lookups return correct Salesforce Contact IDs (smoke test sample)\n* Reconciliation report shows: X new Contacts created, Y existing Contacts updated\n\n==== Cutover Validation\n\n* Mobile App feedback submission success rate > 99.5% (including async Case creation)\n* End-to-end flow validated: Mobile App → ProfileService → EngagementService → Salesforce Case created\n* Braze push notifications delivered for Case creation and Case resolution\n* Event Bus queue depth within normal range (no backlog)\n* Dead letter queue empty (no failed Case creations)\n* Salesforce API rate limits not exceeded\n\n==== Production Monitoring (30 days)\n\n* Customer satisfaction score improves by 15% (compared to D365 CE baseline)\n* Average case resolution time decreases by 20% (Salesforce vs D365 CE)\n* Support agents confirm unified customer view across all channels\n* Zero critical incidents (P1 outages, data loss)\n\n=== Rollback Plan\n\n==== Rollback Triggers\n\n* Feedback submission success rate < 95% (below acceptable threshold)\n* Data loss or corruption detected in Salesforce\n* Salesforce API rate limits exceeded (Cases not created within SLA)\n* Critical bug blocking customer feedback submission\n\n==== Rollback Procedure\n\n1. **Revert Mobile App** to previous version (remove ProfileService/EngagementService integration, restore D365 CE integration)\n2. **Stop EngagementService** Case creation (prevent duplicate Cases in Salesforce)\n3. **Re-enable D365 CE** for customer feedback submission\n4. **Investigate root cause** (EngagementService logs, Salesforce API errors, Event Bus queue issues)\n5. **Fix and re-test** in sandbox environment\n6. **Retry cutover** when issues resolved\n\n==== Rollback Limitations\n\n* Cases created in Salesforce during cutover period remain in Salesforce (no reverse migration)\n* Contacts migrated to Salesforce remain (no rollback to app database)\n* Rollback only affects Mobile App integration (not data migration)\n\n=== Architectural Scope Boundaries\n\n==== Capabilities Included\n\n===== Business Capabilities\n\n* **Customer Feedback Submission**: Mobile App users can submit structured feedback (Category, Store Name, Time of Visit, Phone, Free Text Message) via EngagementService\n* **Customer Contact Management**: Just-In-Time (JIT) Contact reconciliation with Salesforce via ProfileService, ensuring every Mobile App user has a Salesforce Contact record\n* **Case Management Integration**: EngagementService creates Salesforce Cases asynchronously for customer feedback, support agents manage Cases in Salesforce Service Cloud\n* **Customer Notifications**: Push notifications via Braze when Cases are created, updated, or resolved (bidirectional integration: Mobile App → Salesforce → Mobile App)\n* **Unified Customer View**: Support agents see OTR digital customer feedback alongside other Viva Energy channels (fuel wholesale, Shell Card, retail) in single Salesforce instance\n* **Contact Data Migration**: One-time migration of app-specific customer database Contacts to Salesforce with upsert logic (email/phone/VCI matching)\n\n===== Technical Capabilities\n\n* **ProfileService Bounded Context**: First DDD bounded context implementation - JIT Contact reconciliation, Salesforce API facade, foundation for Flybuys integration\n* **EngagementService Bounded Context**: First DDD bounded context implementation - Customer feedback submission BFF, Anti-Corruption Layer for Salesforce, Braze integration orchestration\n* **Event-Driven Architecture**: Domain event publishing via Event Bus (SNS+SQS/EventBridge/Kinesis) for `SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted` events\n* **Async Processing Pattern**: Non-blocking Case creation with retry logic, exponential backoff, dead letter queue for operational resilience\n* **Anti-Corruption Layer Pattern**: EngagementService protects digital channels from Salesforce API changes, translates between OTR domain language and Salesforce\n* **Conformist Pattern**: ProfileService and EngagementService conform to existing Salesforce configuration (shared Viva Energy instance, multi-tenant governance)\n* **Salesforce Integration**: REST API integration for Contact CRUD and Case creation, webhook receiver for Case update notifications\n* **Braze Integration**: Push notification campaign triggers for Case lifecycle events (created, updated, resolved)\n* **Observability & Monitoring**: Dashboards, metrics, alerting for feedback submission rate, queue depth, API errors, Case creation latency\n* **Feature Flag Management**: Kill switches for emergency rollback (enable_salesforce_feedback_submission, enable_async_case_creation, etc.)\n\n==== Capabilities Excluded\n\n===== Business Capabilities Explicitly Out of Scope\n\n* **Historical Case Migration**: D365 CE Cases not migrated to Salesforce (ADR-CS-005 - fresh start, no Case migration)\n* **Multi-Channel Feedback Submission**: Web app, POS, call centre, email feedback channels not included (Mobile App only in this phase)\n* **Case Resolution by Digital Channels**: Support agents resolve Cases in Salesforce, not via Mobile App self-service\n* **Knowledge Base Integration**: Salesforce Knowledge Base articles not surfaced in Mobile App (future enhancement)\n* **Live Chat/Messaging**: Real-time chat support not included (Salesforce omnichannel capabilities not activated)\n* **Sentiment Analysis**: Automated feedback sentiment analysis not included (future enhancement with AI/ML)\n* **Customer Satisfaction Surveys**: Post-resolution CSAT surveys not included (separate initiative)\n* **Case Attachments**: Mobile App feedback submission does not support file uploads (photos, receipts) - text only\n* **Agent Desktop Integration**: Custom Salesforce UI for support agents not included (use standard Salesforce Service Console)\n* **Social Media Feedback**: Facebook, Twitter, Instagram feedback channels not integrated\n\n===== Technical Capabilities Explicitly Out of Scope\n\n* **Event Sourcing**: Domain events are ephemeral (not persisted for event sourcing/replay) - Event Bus only, no Event Store\n* **CQRS (Command Query Responsibility Segregation)**: ProfileService and EngagementService use same data model for reads/writes (no separate read models)\n* **Local Aggregate Persistence**: ProfileService and EngagementService are stateless (Salesforce is System of Record, no local database for Contact/Case)\n* **Saga Orchestration**: No distributed transactions or saga patterns required (single-step Case creation, not multi-step workflow)\n* **API Gateway Advanced Features**: Rate limiting, API versioning, API key management deferred to detailed design (basic routing only)\n* **GraphQL API**: ProfileService and EngagementService expose REST APIs only (GraphQL not required)\n* **Real-Time Sync**: Salesforce Contact updates by support agents not synced back to ProfileService (eventual consistency acceptable via JIT reconciliation)\n* **Multi-Region Deployment**: Single AWS region deployment (no multi-region failover/disaster recovery in this phase)\n* **Blue-Green Deployment**: Big bang cutover (ADR-CS-006), not blue-green or canary deployment strategy\n* **A/B Testing Framework**: Feature flags for rollback only, not for A/B testing or experimentation\n* **Custom Authentication**: Microsoft Entra External ID used for Mobile App authentication (no custom authentication logic in ProfileService/EngagementService)\n* **Data Residency Compliance**: Salesforce data residency governed by Viva Energy Salesforce configuration (no OTR-specific data residency requirements)\n\n===== Future Bounded Contexts Not in Scope\n\n* **LoyaltyService**: Flybuys integration, reward preferences, transaction adjudication (separate initiative)\n* **LocationService**: Store finder, proximity features, geofencing (separate initiative)\n* **PaymentService**: Payment processing, subscription billing (separate initiative)\n* **RecommendationService**: Personalized recommendations, next-best offers (separate initiative)\n\n===== Integration Patterns Not in Scope\n\n* **Shared Kernel**: No shared domain model between ProfileService and EngagementService (separate bounded contexts with clear boundaries)\n* **Partnership**: No joint development or coordination with external teams (Conformist pattern - we conform to Salesforce)\n* **Customer-Supplier (we're upstream)**: No downstream systems depend on ProfileService/EngagementService APIs yet (future bounded contexts will consume domain events)\n\n==== Architectural Dependencies on Future Initiatives\n\n*This Architecture Enables Future Initiatives*:\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Future Initiative |Architectural Enablement\n\n|*Flybuys Integration*\n|**ProfileService Contact Reconciliation Reused**: ProfileService establishes pattern for JIT Contact reconciliation with Salesforce, which will be extended for Flybuys partner linking (link:../architecture_definitions/flybuys_integration.adoc[see Flybuys Integration architecture]) +\n**Event Bus Infrastructure**: Domain event publishing pattern (`CustomerEnrolledInLoyalty`, `PartnerLinked`, etc.) reuses Event Bus established for EngagementService\n\n|*LoyaltyService Bounded Context*\n|**Event Bus Subscription**: LoyaltyService will consume `CustomerProfileCreated` events published by ProfileService (future enhancement) +\n**Salesforce Contact Integration**: LoyaltyService may query Salesforce Contacts for customer reward preferences (via ProfileService facade or direct Salesforce API)\n\n|*Web App Feedback Submission*\n|**EngagementService API Reuse**: Web app will call same EngagementService REST API for feedback submission (multi-channel support) +\n**Conformist Pattern**: Web app conforms to EngagementService API contract (no translation required)\n\n|*Multi-Channel Customer Support*\n|**EngagementService Extension**: Add support for email, call centre, POS feedback channels (extend EngagementService to handle multiple origins) +\n**Salesforce Case Origin Field**: Cases already tagged with Origin=Mobile App, extend to Origin=Web, POS, Call Centre, Email\n\n|*Knowledge Base Integration*\n|**EngagementService API Extension**: Add endpoint to query Salesforce Knowledge Base articles, surface in Mobile App for self-service support +\n**Anti-Corruption Layer**: EngagementService translates Salesforce Knowledge API to OTR domain language\n\n|*Customer Satisfaction Surveys*\n|**Event-Driven Trigger**: Subscribe to `SupportCaseResolved` events published by EngagementService, trigger CSAT survey via Braze +\n**Braze Integration Pattern**: Reuse EngagementService → Braze integration pattern for survey campaigns\n\n|*Sentiment Analysis*\n|**Event Subscription**: Subscribe to `CustomerFeedbackSubmitted` events, analyse feedback sentiment (AI/ML service) +\n**EngagementService Extension**: Enrich Case with sentiment score before creating in Salesforce\n\n|*RecommendationService Bounded Context*\n|**Event Subscription**: RecommendationService subscribes to `SupportCaseCreated` events to understand customer pain points and personalize recommendations +\n**Domain Event Pattern**: Reuse Event Bus publishing pattern established by EngagementService\n\n|===\n\n*This Architecture Depends on Future Initiatives*:\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Future Initiative |Dependency Description\n\n|*Salesforce Data Isolation Strategy*\n|**BLOCKER**: Viva Energy Salesforce admin team must define data isolation strategy (Record Types, custom fields, queues) before production deployment +\n**Impact**: Multi-tenant data visibility and security governance\n\n|*Salesforce Case Field Mapping*\n|**BLOCKER**: Viva Energy Salesforce admin team must define field mapping for OTR feedback categories (App, Service, Order, Rewards, Refund, Delete Account) +\n**Impact**: Case creation logic in EngagementService depends on finalized Salesforce schema\n\n|*Salesforce Webhook Mechanism*\n|**BLOCKER**: Viva Energy Salesforce admin team must configure webhook mechanism (Outbound Messages vs Platform Events vs Process Builder) for Case update notifications +\n**Impact**: EngagementService webhook receiver implementation depends on chosen mechanism\n\n|*Event Bus Technology Selection*\n|**DECISION REQUIRED**: Choose Event Bus implementation (SNS+SQS vs EventBridge vs Kinesis) for domain event publishing +\n**Impact**: Infrastructure provisioning, event schema design, consumer implementation\n\n|*Microservice Hosting Platform*\n|**DECISION REQUIRED**: Choose hosting platform for ProfileService and EngagementService (AWS Lambda vs ECS vs EKS) +\n**Impact**: Deployment architecture, auto-scaling strategy, operational overhead\n\n|*Observability Platform*\n|**DECISION REQUIRED**: Choose observability platform (AWS CloudWatch vs Datadog vs New Relic) for monitoring and alerting +\n**Impact**: Dashboard configuration, metric collection, alerting setup\n\n|===\n\n*Future Work After This Initiative*:\n\n* **Event Schema Registry**: Implement event schema versioning and registry for domain events (currently ad-hoc schemas)\n* **API Versioning Strategy**: Define API versioning approach for ProfileService and EngagementService (currently v1 only)\n* **Multi-Region Deployment**: Extend to multi-region for disaster recovery and global availability\n* **Event Store**: Persist domain events for event sourcing and audit trail (currently ephemeral Event Bus only)\n* **CQRS Pattern**: Separate read models for high-volume queries (currently same model for reads/writes)\n* **GraphQL API**: Expose GraphQL API for flexible client queries (currently REST only)\n* **Real-Time Sync**: Bi-directional sync between Salesforce and ProfileService for Contact updates (currently JIT reconciliation only)\n\n=== Technical Risks and Mitigation\n\n[width=\"100%\",cols=\"5%,20%,25%,25%,25%\",options=\"header\",]\n|===\n|ID |Risk |Impact |Likelihood |Mitigation\n\n|RISK-CS-001\n|*Salesforce API rate limits exceeded*: High feedback volume exceeds Salesforce API limits, Cases not created\n|HIGH (customers don't receive Case confirmation, support tickets lost)\n|MEDIUM (volume unknown, rate limits TBD)\n|• Gather expected feedback volume data before cutover +\n• Implement Event Bus queue throttling/rate limiting +\n• Monitor queue depth and API usage +\n• Scale background workers based on queue depth +\n• Alert ops team when approaching rate limits\n\n|RISK-CS-002\n|*Salesforce downtime*: Salesforce Service Cloud outage prevents Case creation\n|MEDIUM (Cases delayed but queued, customers wait for confirmation)\n|LOW (Salesforce SLA 99.9% uptime)\n|• Async Case creation with retry logic +\n• Event Bus queues buffer work during outage +\n• Customers get immediate \"Feedback submitted\" (not blocked) +\n• Monitor Salesforce status page, alert ops team +\n• Automatic retry when Salesforce recovers\n\n|RISK-CS-003\n|*Contact migration data quality issues*: App database Contact data incomplete or invalid\n|HIGH (migration fails validation, cutover delayed)\n|MEDIUM (legacy data quality unknown)\n|• Pre-migration data quality assessment +\n• Flexible upsert logic (match by email/phone/VCI) +\n• Validation report identifies data issues before production migration +\n• Manual cleanup for invalid records +\n• Dry-run migration in sandbox environment\n\n|RISK-CS-004\n|*Duplicate Contacts created*: Email matching fails, ProfileService creates duplicate Contacts\n|MEDIUM (support agents see multiple profiles for same customer)\n|MEDIUM (email changes, data quality issues)\n|• Salesforce duplicate detection rules (if available) +\n• ProfileService logs Contact creation for audit trail +\n• Manual duplicate cleanup process (support team) +\n• Future enhancement: VCI as Salesforce External ID for stable matching\n\n|RISK-CS-005\n|*Dead letter queue accumulation*: Failed Case creations not processed, queue grows\n|HIGH (customers don't receive Case confirmation, feedback lost)\n|LOW (retry logic handles most failures)\n|• Dead letter queue monitoring and alerting +\n• Ops team dashboard showing DLQ depth +\n• Manual intervention process (investigate and reprocess) +\n• Automated alerts when DLQ depth exceeds threshold +\n• Root cause analysis for recurring failures\n\n|RISK-CS-006\n|*Salesforce webhook failures*: Salesforce can't deliver Case update notifications to EngagementService\n|MEDIUM (customers don't get push notifications for Case resolution)\n|LOW (webhook mechanism reliable)\n|• Webhook retry logic and exponential backoff +\n• EngagementService logs webhook deliveries +\n• Monitor webhook delivery success rate +\n• Fallback: Poll Salesforce API for Case updates (if webhook fails persistently) +\n• Alert ops team when webhook delivery rate drops\n\n|RISK-CS-007\n|*Multi-tenant data isolation breach*: OTR digital Cases visible to other Viva Energy support teams\n|HIGH (privacy violation, compliance risk)\n|LOW (Salesforce governance controls)\n|• Work with Viva Energy Salesforce admin team on data isolation strategy +\n• Test data visibility in Salesforce sandbox (UAT with different user roles) +\n• Validate Record Types, queues, field-level security before production +\n• Audit Salesforce user permissions and sharing rules\n\n|RISK-CS-008\n|*Mobile App release coordination*: App release delayed, cutover window missed\n|MEDIUM (cutover delayed, D365 CE retirement delayed)\n|MEDIUM (release schedule conflicts)\n|• Coordinate cutover timing with Mobile team early +\n• Buffer time in migration plan (2-week contingency) +\n• Decouple backend deployment from Mobile App release (backend deployed first, app follows) +\n• Feature flag for feedback submission (enable when ready)\n\n|RISK-CS-009\n|*Event Bus infrastructure issues*: SNS/SQS/EventBridge downtime or misconfiguration\n|HIGH (Case creation blocked, domain events not published)\n|LOW (AWS SLA 99.99% uptime)\n|• Leverage existing AWS infrastructure (proven, reliable) +\n• Infrastructure as Code (IaC) for Event Bus configuration +\n• Integration testing in non-production environment +\n• Monitor Event Bus metrics (queue depth, throughput, errors) +\n• Alert ops team on Event Bus failures\n\n|RISK-CS-010\n|*Team DDD knowledge gap*: Team unfamiliar with DDD patterns, bounded contexts, event-driven architecture\n|MEDIUM (implementation delays, architectural inconsistencies)\n|HIGH (first DDD implementation)\n|• DDD training for development team (workshops, documentation) +\n• Architecture review sessions (validate bounded context design) +\n• Pair programming with experienced DDD practitioners +\n• Incremental implementation (start small, iterate) +\n• Document architectural patterns in CLAUDE.md\n\n|===\n\n== Assumptions and Constraints\n\n=== Assumptions\n\n[width=\"100%\",cols=\"8%,92%\",options=\"header\",]\n|===\n|ID |Assumption\n\n|ASM-CS-001\n|Viva Energy Salesforce admin team will provide Salesforce production access, sandbox environment, and support for Case field mapping and data isolation configuration\n\n|ASM-CS-002\n|App database Contact data is sufficiently complete for migration (email/phone/VCI available for matching)\n\n|ASM-CS-003\n|Expected customer feedback volume (100-150 submissions/day from 20k DAU) is well within Salesforce API rate limits, with capacity planning for 3x-10x growth\n\n|ASM-CS-004\n|Existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis) is sufficient for Event Bus implementation (no additional infrastructure provisioning required)\n\n|ASM-CS-005\n|Braze integration already exists and can be extended for Case-related push notifications (no new Braze account or major configuration changes)\n\n|ASM-CS-006\n|Mobile App users have email addresses associated with their accounts (required for ProfileService Contact reconciliation)\n\n|ASM-CS-007\n|D365 Customer Engagement historical Cases have limited business value and do not require migration to Salesforce\n\n|ASM-CS-008\n|Support agents are trained on Salesforce Service Cloud and require minimal additional training for OTR digital customer Cases\n\n|ASM-CS-009\n|Salesforce Service Cloud shared instance has capacity for OTR digital customer Contacts and Cases (no additional licensing or storage costs)\n\n|ASM-CS-010\n|Mobile App release schedule can accommodate cutover timing (Week 10 in migration plan)\n\n|===\n\n=== Constraints\n\n[width=\"100%\",cols=\"8%,92%\",options=\"header\",]\n|===\n|ID |Constraint\n\n|CON-CS-001\n|Must use shared Viva Energy Salesforce Service Cloud instance (cannot deploy separate OTR-specific instance)\n\n|CON-CS-002\n|Must conform to existing Salesforce configuration and governance (Record Types, custom fields, queues, data isolation strategy defined by Viva Energy admin team)\n\n|CON-CS-003\n|Contact migration must complete before Mobile App cutover (no parallel run of D365 CE and Salesforce)\n\n|CON-CS-004\n|Big bang cutover only (no phased rollout with feature flags or pilot users)\n\n|CON-CS-005\n|Salesforce API rate limits and authentication method constrained by Viva Energy Salesforce configuration (TBD)\n\n|CON-CS-006\n|Event Bus implementation must use existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis - cannot introduce new infrastructure components)\n\n|CON-CS-007\n|Mobile App feedback form must include specific fields: Category, Store Name, Time of Visit, Contact Phone Number, Free Text Message (no attachments)\n\n|CON-CS-008\n|D365 Customer Engagement must be decommissioned within 90 days post-cutover (ADR-CS-006)\n\n|CON-CS-009\n|ProfileService and EngagementService must be stateless (no local aggregate persistence, Salesforce is System of Record)\n\n|CON-CS-010\n|First DDD bounded context implementation (team learning curve, architectural patterns must be documented for future bounded contexts)\n\n|===\n\n== Non-Functional Requirements\n\n=== Performance Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-PERF-001\n|Mobile App feedback submission API response time (ProfileService + EngagementService)\n|p95 < 1 second, p99 < 2 seconds\n\n|NFR-PERF-002\n|ProfileService Contact reconciliation API response time (JIT lookup)\n|p95 < 500ms, p99 < 1 second\n\n|NFR-PERF-003\n|EngagementService async Case creation latency (end-to-end: feedback submitted → Case created in Salesforce)\n|p95 < 5 minutes, p99 < 10 minutes\n\n|NFR-PERF-004\n|Salesforce API call latency (Contact query, Contact create, Case create)\n|p95 < 2 seconds, p99 < 5 seconds\n\n|NFR-PERF-005\n|Event Bus message processing throughput\n|> 100 messages/second (support peak feedback volume)\n\n|NFR-PERF-006\n|Braze push notification delivery latency (Case created → notification delivered)\n|p95 < 30 seconds, p99 < 60 seconds\n\n|===\n\n=== Availability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-AVAIL-001\n|ProfileService availability\n|99.9% uptime (8.76 hours downtime/year)\n\n|NFR-AVAIL-002\n|EngagementService availability\n|99.9% uptime (8.76 hours downtime/year)\n\n|NFR-AVAIL-003\n|Feedback submission success rate (including async Case creation)\n|> 99.5% (includes retry logic for transient failures)\n\n|NFR-AVAIL-004\n|Graceful degradation: Salesforce downtime handling\n|Feedback submission still succeeds, Cases queued for async creation when Salesforce recovers\n\n|NFR-AVAIL-005\n|Graceful degradation: Braze downtime handling\n|Case creation proceeds, push notifications disabled temporarily (feature flag)\n\n|NFR-AVAIL-006\n|Planned maintenance window\n|< 4 hours/month, scheduled during low-traffic periods (2-6am ACST)\n\n|===\n\n=== Scalability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-SCALE-001\n|Concurrent Mobile App users (peak)\n|Support 20,000 DAU (Daily Active Users), ~150 concurrent users submitting feedback during peak hours\n\n|NFR-SCALE-002\n|Feedback submissions per day\n|Expected: 100-150 submissions/day based on 20k DAU (~0.5-0.75% submission rate) +\nCapacity: Support 500 submissions/day (3x expected volume for growth), 2,000 submissions/day (peak/incident scenarios)\n\n|NFR-SCALE-003\n|Auto-scaling: ProfileService and EngagementService\n|Auto-scale based on CPU/memory/request rate, scale up within 2 minutes\n\n|NFR-SCALE-004\n|Event Bus queue capacity\n|Support 100,000 queued messages (buffer for Salesforce downtime)\n\n|NFR-SCALE-005\n|Salesforce API rate limit compliance\n|Stay within 80% of Salesforce API rate limits (buffer for spikes)\n\n|NFR-SCALE-006\n|Future growth capacity\n|Architecture supports 10x growth (1,000-1,500 submissions/day based on 200k DAU) without major redesign\n\n|===\n\n=== Security Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-SEC-001\n|Mobile App authentication\n|Microsoft Entra External ID OAuth 2.0 with JWT tokens (existing CIAM)\n\n|NFR-SEC-002\n|API authorisation: ProfileService and EngagementService\n|JWT token validation, authenticated users only, user context propagation\n\n|NFR-SEC-003\n|Salesforce API authentication\n|OAuth 2.0 with Connected App and JWT bearer flow (service account)\n\n|NFR-SEC-004\n|Data encryption in transit\n|TLS 1.2+ for all API calls (Mobile App ↔ ProfileService/EngagementService ↔ Salesforce ↔ Braze)\n\n|NFR-SEC-005\n|Data encryption at rest\n|Salesforce encryption at rest (managed by Salesforce), Event Bus message encryption (AWS KMS)\n\n|NFR-SEC-006\n|Secret management\n|AWS Secrets Manager for Salesforce credentials, Braze API keys, OAuth tokens (no hardcoded secrets)\n\n|NFR-SEC-007\n|PII data handling\n|Contact data (email, phone, name) treated as PII, GDPR-compliant retention policies (Salesforce governance)\n\n|NFR-SEC-008\n|API rate limiting and throttling\n|API Gateway rate limiting (100 requests/second per user), prevent abuse and DoS\n\n|NFR-SEC-009\n|Logging and auditing\n|Log all API calls, Salesforce Contact/Case creates/updates, Event Bus publishes (no PII in logs)\n\n|NFR-SEC-010\n|Salesforce data isolation\n|Multi-tenant data isolation via Salesforce Record Types, queues, sharing rules (defined by Viva Energy admin team)\n\n|===\n\n=== Reliability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-REL-001\n|Retry logic: EngagementService → Salesforce Case creation\n|Exponential backoff (1s, 2s, 4s, 8s, 16s), max 5 retries, then dead letter queue\n\n|NFR-REL-002\n|Dead letter queue monitoring\n|Alert ops team immediately when DLQ depth > 0 (failed Case creations require manual intervention)\n\n|NFR-REL-003\n|Event Bus message durability\n|Messages persisted in Event Bus (SNS+SQS/EventBridge/Kinesis), not lost on service restart\n\n|NFR-REL-004\n|Idempotency: Case creation\n|EngagementService ensures duplicate feedback submissions don't create duplicate Cases (idempotency key)\n\n|NFR-REL-005\n|Circuit breaker: Salesforce API calls\n|Open circuit after 5 consecutive failures, half-open retry after 30 seconds\n\n|NFR-REL-006\n|Health checks: ProfileService and EngagementService\n|Health endpoints for load balancer checks, readiness and liveness probes\n\n|NFR-REL-007\n|Disaster recovery: Event Bus\n|Event Bus messages replicated across AWS availability zones (SQS/EventBridge/Kinesis HA)\n\n|===\n\n=== Maintainability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-MAINT-001\n|Code quality: ProfileService and EngagementService\n|> 80% test coverage (unit + integration tests), automated CI/CD pipeline\n\n|NFR-MAINT-002\n|API documentation\n|OpenAPI/Swagger specs for ProfileService and EngagementService, auto-generated API docs\n\n|NFR-MAINT-003\n|Deployment automation\n|Infrastructure as Code (Terraform/CloudFormation/CDK), zero-downtime deployments\n\n|NFR-MAINT-004\n|Logging: structured logs\n|JSON-formatted logs with correlation IDs, log levels (DEBUG, INFO, WARN, ERROR), centralized log aggregation\n\n|NFR-MAINT-005\n|Monitoring dashboards\n|Real-time dashboards for ProfileService, EngagementService, Event Bus (see Monitoring and Observability section)\n\n|NFR-MAINT-006\n|Alerting and on-call\n|PagerDuty/Opsgenie integration for P1/P2 alerts, on-call rotation for ops team\n\n|NFR-MAINT-007\n|Configuration management\n|Externalized configuration (environment variables, AWS Parameter Store), no hardcoded config\n\n|NFR-MAINT-008\n|Versioning: API and events\n|Semantic versioning (v1, v2), backward compatibility for API changes, event schema evolution\n\n|===\n\n=== Usability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-USE-001\n|Feedback submission UX\n|Mobile App user receives immediate \"Feedback submitted\" confirmation (< 1 second), not blocked by async Case creation\n\n|NFR-USE-002\n|Push notification delivery\n|Customer receives \"Your feedback has been received\" notification within 30 seconds of Case creation in Salesforce\n\n|NFR-USE-003\n|Case resolution notification\n|Customer receives \"Your case has been resolved\" notification within 30 seconds of support agent resolving Case\n\n|NFR-USE-004\n|Error messaging\n|User-friendly error messages for failed feedback submission (not technical errors), retry prompts\n\n|NFR-USE-005\n|Accessibility\n|Mobile App feedback form meets WCAG 2.1 AA accessibility standards (existing Mobile App compliance)\n\n|===\n\n=== Compliance Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-COMP-001\n|GDPR compliance: PII data\n|Customer Contact data (email, phone, name) managed per GDPR retention policies (Salesforce governance)\n\n|NFR-COMP-002\n|GDPR compliance: Right to erasure\n|Support \"Delete Account\" feedback category, trigger Contact deletion in Salesforce per GDPR Article 17\n\n|NFR-COMP-003\n|Data residency\n|Salesforce data residency governed by Viva Energy Salesforce configuration (regional compliance)\n\n|NFR-COMP-004\n|Audit trail\n|All Contact creates/updates, Case creates/updates logged for compliance auditing (Salesforce audit logs)\n\n|NFR-COMP-005\n|API security standards\n|OWASP API Security Top 10 compliance (injection prevention, authentication, authorisation, data exposure)\n\n|===\n\n== Monitoring and Observability\n\n=== Key Metrics\n\n[width=\"100%\",cols=\"25%,40%,35%\",options=\"header\",]\n|===\n|Metric Category |Metric |Target/Threshold\n\n|*Feedback Submission*\n|Feedback submission success rate (Mobile App → EngagementService)\n|> 99.5%\n\n|*Async Case Creation*\n|Case creation success rate (EngagementService → Salesforce)\n|> 99%\n\n|*Async Case Creation*\n|Case creation latency (time from feedback submission to Case created in Salesforce)\n|p95 < 5 minutes\n\n|*Event Bus*\n|Event Bus queue depth (pending Case creations)\n|< 100 messages\n\n|*Event Bus*\n|Dead letter queue depth (failed Case creations)\n|= 0 (alert on any failures)\n\n|*Salesforce API*\n|Salesforce API error rate\n|< 1%\n\n|*Salesforce API*\n|Salesforce API latency (Case creation)\n|p95 < 2 seconds\n\n|*Salesforce API*\n|Salesforce API rate limit utilization\n|< 80% of limit\n\n|*ProfileService*\n|Contact reconciliation success rate (JIT lookups)\n|> 99.5%\n\n|*ProfileService*\n|Contact reconciliation latency\n|p95 < 500ms\n\n|*Braze Notifications*\n|Push notification delivery rate (Case created/updated)\n|> 95%\n\n|*Salesforce Webhook*\n|Webhook delivery success rate (Salesforce → EngagementService)\n|> 99%\n\n|*Customer Satisfaction*\n|Customer satisfaction score (CSAT)\n|> 4.0/5.0 (improve by 15% from D365 CE baseline)\n\n|*Support Operations*\n|Average case resolution time\n|Decrease by 20% from D365 CE baseline\n\n|===\n\n=== Alerting Thresholds\n\n[width=\"100%\",cols=\"25%,50%,25%\",options=\"header\",]\n|===\n|Alert |Condition |Severity\n\n|*Feedback submission failures*\n|Feedback submission success rate < 95% over 5-minute window\n|P1 - Critical\n\n|*Dead letter queue accumulation*\n|Dead letter queue depth > 0 (any failed Case creations)\n|P2 - High\n\n|*Event Bus queue backlog*\n|Event Bus queue depth > 100 messages for > 15 minutes\n|P2 - High\n\n|*Salesforce API errors*\n|Salesforce API error rate > 5% over 5-minute window\n|P1 - Critical\n\n|*Salesforce API rate limits*\n|Salesforce API rate limit utilization > 90%\n|P2 - High\n\n|*Contact reconciliation failures*\n|ProfileService Contact reconciliation failure rate > 5% over 5-minute window\n|P2 - High\n\n|*Braze notification failures*\n|Braze push notification delivery rate < 80% over 15-minute window\n|P3 - Medium\n\n|*Salesforce webhook failures*\n|Salesforce webhook delivery success rate < 90% over 15-minute window\n|P2 - High\n\n|*Case creation latency*\n|Case creation latency p95 > 10 minutes\n|P3 - Medium\n\n|===\n\n=== Dashboards\n\n*ProfileService Dashboard:*\n\n* Contact reconciliation success rate (JIT lookups)\n* Contact reconciliation latency (p50, p95, p99)\n* Contact creation vs update ratio (new Contacts created vs existing Contacts updated)\n* Salesforce API error rate (Contact queries and creates)\n* Request rate and throughput\n\n*EngagementService Dashboard:*\n\n* Feedback submission success rate\n* Case creation success rate (async workflow)\n* Case creation latency (p50, p95, p99)\n* Event Bus queue depth (pending Case creations)\n* Dead letter queue depth (failed Case creations)\n* Salesforce API error rate (Case creation)\n* Salesforce API latency\n* Salesforce API rate limit utilization\n* Braze push notification delivery rate\n* Salesforce webhook delivery success rate\n\n*Event Bus Dashboard:*\n\n* Queue depth (pending messages)\n* Throughput (messages published/consumed per minute)\n* Dead letter queue depth (failed messages)\n* Consumer lag (time between publish and consume)\n\n*Customer Support Dashboard (Business Metrics):*\n\n* Total feedback submissions per day/week/month\n* Feedback category breakdown (App, Service, Order, Rewards, Refund, Delete Account)\n* Customer satisfaction score (CSAT) trend\n* Average case resolution time trend\n* Case volume by support team/queue\n* Unified customer view adoption (support agent feedback)\n<<<\n== Solution Validation\n\nThis section defines the validation criteria and testing approach for the solution.\n\n=== Functional Validation\n\n==== ProfileService API Testing\n\n*Test Scenarios*:\n1. **Happy Path**: Authenticated user requests Contact ID, existing Contact found in Salesforce, Contact ID returned\n2. **JIT Creation**: Authenticated user requests Contact ID, no existing Contact, new Contact created in Salesforce, Contact ID returned\n3. **Salesforce API Failure**: Salesforce unavailable, ProfileService returns 500 error, user retries\n4. **Invalid JWT**: Unauthenticated request, ProfileService returns 401 error\n\n*Acceptance Criteria*:\n- Contact reconciliation success rate > 99.5%\n- JIT Contact creation completes within 500ms (p95)\n\n==== EngagementService API Testing\n\n*Test Scenarios*:\n1. **Happy Path**: Valid feedback submission, immediate 202 Accepted response, Case created in Salesforce within 5 minutes, Braze notification delivered\n2. **Invalid Category**: Invalid feedback category, 400 Bad Request response with validation error\n3. **Salesforce Downtime**: Salesforce unavailable during async Case creation, message queued, retry logic executes, Case created when Salesforce recovers\n4. **Dead Letter Queue**: Case creation fails after 5 retries, message moved to DLQ, ops team alerted\n5. **Webhook Notification**: Support agent resolves Case in Salesforce, webhook triggers EngagementService, Braze push notification sent to customer\n\n*Acceptance Criteria*:\n- Feedback submission success rate > 99.5% (including async Case creation)\n- Async Case creation completes within 5 minutes (p95)\n- Webhook delivery success rate > 99%\n\n=== Non-Functional Validation\n\n==== Performance Testing\n\n*Load Testing*:\n\n*Baseline*: Expected 100-150 submissions/day from 20k DAU (~0.5-0.75% submission rate)\n\n- **Normal Load**: 1 submission/minute sustained for 2 hours (simulate typical daily pattern)\n- **3x Load**: 3 submissions/minute sustained for 1 hour (simulate busy period, 450 submissions/day)\n- **Peak Load (10x)**: 10 submissions/minute for 15 minutes (simulate incident scenario, app outage causing backlog)\n- **Stress Test**: 50 submissions/minute for 5 minutes (find breaking point, 20x normal)\n\n*Validation*:\n- API response time p95 < 1 second under 10x load\n- Event Bus queue depth remains manageable (< 100 messages)\n- No Case creation failures, all submissions processed successfully\n- Auto-scaling triggers appropriately for sustained load > 3x baseline\n\n*Acceptance Criteria*:\n- NFR-PERF-001 through NFR-PERF-006 validated under realistic load (3x and 10x baseline)\n- Auto-scaling triggers within 2 minutes of load increase\n- System handles 10x peak gracefully, 20x stress test identifies limits\n\n==== Resilience Testing\n\n*Salesforce API Failure Scenarios*:\n1. **Complete Outage**: Salesforce unavailable for 2 hours, Event Bus queues buffer work, Cases created when Salesforce recovers\n2. **Rate Limit Exceeded**: Salesforce rate limit hit, queue throttling activates, Cases created within SLA\n\n*Acceptance Criteria*:\n- NFR-AVAIL-004 validated (graceful degradation during Salesforce downtime)\n- Circuit breaker activates after 5 consecutive failures\n\n==== Security Validation\n\n*Penetration Testing*:\n- API authentication bypass attempts\n- SQL injection attempts\n- Webhook signature validation bypass\n\n*Acceptance Criteria*:\n- NFR-SEC-001 through NFR-SEC-010 validated\n- OWASP API Security Top 10 compliance verified\n\n=== Integration Validation\n\n==== End-to-End Testing\n\n*Full User Journey*:\n1. User authenticates via Microsoft Entra External ID\n2. Mobile App requests Contact ID from ProfileService (JIT reconciliation)\n3. User submits feedback via EngagementService\n4. Background worker creates Case in Salesforce\n5. Braze notification delivered to user\n6. Support agent resolves Case in Salesforce\n7. Salesforce webhook triggers EngagementService\n8. Braze notification delivered to user\n\n*Acceptance Criteria*:\n- End-to-end flow completes successfully in UAT\n- User receives both \"feedback submitted\" and \"case resolved\" notifications\n","structuredPatch":[{"oldStart":1626,"oldLines":15,"newStart":1626,"newLines":15,"lines":[" "," *Prerequisites*:"," ","-* WP-CS-003 (Event Bus Infrastructure) completed","+* <<wp-cs-003,WP-CS-003>> (Event Bus Infrastructure) completed"," * Salesforce sandbox environment provisioned"," * Braze API credentials and campaign templates configured"," * Microsoft Entra External ID OAuth configuration"," "," *Dependent Work Packages*:"," ","-* WP-CS-003 must be completed first (Event Bus required for async processing)","-* WP-CS-007 (Salesforce Configuration) must be in progress (field mapping needed)","+* <<wp-cs-003,WP-CS-003>> must be completed first (Event Bus required for async processing)","+* <<wp-cs-007,WP-CS-007>> (Salesforce Configuration) must be in progress (field mapping needed)"," "," ==== Skills Required"," "]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"ae2ce45d-5427-4c51-8057-864251df9f11"}
{"parentUuid":"f58f12c3-48c5-40ea-bfd7-a847a55dbed2","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_015ZvbPRTNLhuXKaRtYqac3Y","type":"tool_result","content":"The file /mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n  1756→** Runbook for migration execution\n  1757→\n  1758→==== Dependencies\n  1759→\n  1760→*Prerequisites*:\n  1761→\n  1762→* <<wp-cs-001,WP-CS-001>> (ProfileService Development) completed (reuses Salesforce integration code)\n  1763→* Salesforce sandbox environment for migration testing\n  1764→* App-specific database access (read-only sufficient)\n  1765→* Salesforce production access granted\n  1766→\n  1767→*Dependent Work Packages*:\n  1768→\n  1769→* <<wp-cs-001,WP-CS-001>> provides Salesforce Contact upsert logic to reuse\n  1770→\n  1771→==== Skills Required\n  1772→\n  1773→* Database development (SQL, data extraction)"}]},"uuid":"012c2df5-d41c-4f00-a439-f9c5e737ccf9","timestamp":"2026-01-09T03:11:23.070Z","toolUseResult":{"filePath":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","oldString":"*Prerequisites*:\n\n* WP-CS-001 (ProfileService Development) completed (reuses Salesforce integration code)\n* Salesforce sandbox environment for migration testing\n* App-specific database access (read-only sufficient)\n* Salesforce production access granted\n\n*Dependent Work Packages*:\n\n* WP-CS-001 provides Salesforce Contact upsert logic to reuse","newString":"*Prerequisites*:\n\n* <<wp-cs-001,WP-CS-001>> (ProfileService Development) completed (reuses Salesforce integration code)\n* Salesforce sandbox environment for migration testing\n* App-specific database access (read-only sufficient)\n* Salesforce production access granted\n\n*Dependent Work Packages*:\n\n* <<wp-cs-001,WP-CS-001>> provides Salesforce Contact upsert logic to reuse","originalFile":"= Salesforce Customer Support - Solution Architecture\n:project-name: Salesforce Customer Support\n:togaf-adm-phase: Phase E: Opportunities & Solutions\n:last-updated: 2026-01-07\n:document-type: Solution Architecture Document\n:status: Discovery\n:version: 0.1\n:domain: Customer Support & Engagement\n:programme-lead:\n:domain-architect: O.Young@otr.com.au\n:architecture-definition: xref:architecture-definitions:salesforce_customer_support.adoc[Architecture Definitions/Salesforce Customer Support]\n:doctype: article\n:toc: left\n:toclevels: 4\n:sectanchors:\n:sectlinks:\n:sectnums:\n:icons: font\n:source-highlighter: highlightjs\n:experimental:\n:description:\n:keywords:\n\n<<<\n== Purpose and Scope\n\n=== Purpose\n\nThis Solution Architecture defines how the Salesforce Customer Support consolidation will be implemented - the specific technology products, configurations, interfaces, and deployment architecture that realise the xref:architecture-definitions:salesforce_customer_support.adoc[Salesforce Customer Support Architecture Definition].\n\nThis solution establishes the **first implementation of OTR's target Domain-Driven Design (DDD) architecture** by deploying two new bounded contexts (`ProfileService` and `EngagementService`) as microservices, consolidating customer support onto Salesforce Service Cloud, and implementing event-driven integration patterns that will serve as the foundation for future bounded contexts (including Flybuys integration).\n\n=== Vision\n\n> Unify customer support across all OTRG channels by consolidating OTR digital customer feedback onto Salesforce Service Cloud, establishing the foundational DDD architecture with ProfileService and EngagementService bounded contexts that protect digital channels from external system changes while enabling support agents to deliver exceptional customer experiences with complete interaction history.\n\n=== Architectural Approach\n\nThis architecture establishes OTR's **first bounded context implementation** using Domain-Driven Design strategic patterns:\n\n* *link:../bounded_context/profile.adoc[ProfileService]* (NEW bounded context): Just-In-Time Contact reconciliation with Salesforce, upsert by email, returns Salesforce Contact ID to digital channels - foundation for future Flybuys partner linking\n* *link:../bounded_context/engagement.adoc[EngagementService]* (NEW bounded context): Customer feedback submission facade, Anti-Corruption Layer for Salesforce Case creation, Braze integration for all outbound customer communications (push, email, SMS), async Case processing via Event Bus\n* *Event-driven integration* (NEW pattern): Domain event publishing using existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis) - first implementation establishing pattern for future bounded contexts\n* *Anti-Corruption Layer*: EngagementService isolates digital channels from Salesforce API changes, translates between OTR domain language and Salesforce Service Cloud API\n* *Conformist Pattern*: ProfileService and EngagementService conform to existing Salesforce configuration (shared Viva Energy instance, multi-tenant governance)\n* *Big bang cutover*: Single deployment after Contact migration, no phased rollout, D365 CE retirement post-cutover\n\n=== Scope\n\n==== In Scope\n\n* Solution Building Blocks (SBBs) - specific technology products and versions\n* Interface specifications (APIs, events, data formats)\n* Data architecture and schema specifications\n* Deployment architecture and infrastructure configuration\n* Transition architecture with migration phases\n* Technical validation criteria and testing approach\n* External system integration specifications\n* Physical data models and API schemas\n\n==== Out of Scope\n\n===== Covered in xref:architecture-definitions:salesforce_customer_support.adoc[Architecture Definition]\n\n* Business requirements and stakeholder analysis\n* Architecture decisions and rationale (ADRs)\n* Bounded context definitions and responsibilities\n* High-level integration patterns (ACL, Conformist, OHS+PL)\n* Business capability mapping and value streams\n* Architecture principles and governance\n\n===== Covered in Other Documents\n\n* Detailed design (class diagrams, sequence diagrams for all flows)\n* Implementation code and unit tests\n* Business case and return-on-investment analysis\n* Operational run books and support procedures\n\n<<<\n=== Architecture Overview\n\n[mermaid]\n----\n---\nconfig:\n  layout: elk\n---\nflowchart TB\n    Customer([\"Customer\"]) -- Uses --> MobileApp[\"Mobile App<br>iOS/Android\"]\n    Customer -- Shops at --> POS[\"OTR/OTR+ POS<br>D365 Commerce\"]\n    MobileApp -- Authenticate --> EntraID[\"Microsoft Entra\"]\n    MobileApp -- Identifies & Reconciles --> ProfileService[\"ProfileService\"]\n    ProfileService <-- Reconcile App User as Salesforce Contact --> Salesforce[\"Salesforce\"]\n    ProfileService -- On Create --> EventBus[\"EventBus\"]\n    EventBus -- Emits CreateUser Event --> LoyaltyService[\"LoyaltyService\"] & EngagementService[\"EngagementService\"]\n    LoyaltyService -- Reconcile Wallet --> EagleEye[\"EagleEye\"]\n    EngagementService -- Reconcile Braze Profile --> Braze[\"Braze\"]\n    EngagementService --> Salesforce\n    D365CE[\"D365CE\"] -- Data Migration --> Salesforce\n    MobileApp -- Submits Feedback --> EngagementService\n\n    Customer:::customer\n    MobileApp:::presentation\n    POS:::presentation\n    EntraID:::external\n    ProfileService:::newService\n    Salesforce:::external\n    EventBus:::infrastructure\n    LoyaltyService:::newService\n    EngagementService:::newService\n    EagleEye:::external\n    Braze:::external\n    D365CE:::external\n    classDef newService fill:#4CAF50,stroke:#2E7D32,stroke-width:3px,color:#fff\n    classDef external fill:#FF9800,stroke:#E65100,stroke-width:2px,color:#fff\n    classDef infrastructure fill:#2196F3,stroke:#0D47A1,stroke-width:2px,color:#fff\n    classDef presentation fill:#9C27B0,stroke:#4A148C,stroke-width:2px,color:#fff\n    classDef customer fill:#607D8B,stroke:#263238,stroke-width:2px,color:#fff\n----\n\n\n==== Key Architectural Patterns\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Pattern |Application |Rationale\n\n|*Anti-Corruption Layer (ACL)*\n|EngagementService → Salesforce Service Cloud\n|Protects digital channels (Mobile App, Web) from Salesforce API changes, translates between OTR domain language and Salesforce Case/Contact model, enables independent evolution of internal domain model\n\n|*Conformist*\n|ProfileService → Salesforce, EngagementService → Salesforce\n|Shared Viva Energy Salesforce instance - we conform to existing configuration, governance, and API contracts (external system we don't control)\n\n|*Backend-for-Frontend (BFF)*\n|EngagementService\n|Aggregates customer feedback submission, Contact lookup, async Case creation, and Braze notification orchestration for digital channel clients\n\n|*Event-Driven Architecture (OHS+PL)*\n|Event Bus (SNS+SQS/EventBridge/Kinesis)\n|Loose coupling between bounded contexts, async domain event publishing (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`), foundation for future bounded contexts\n\n|*Just-In-Time (JIT) Integration*\n|ProfileService → Salesforce Contact reconciliation\n|Reconcile app users as Salesforce Contacts on-demand (upsert by email), no pre-sync required, ensures Salesforce has current Contact data\n\n|*Async Processing*\n|EngagementService Case creation via Event Bus\n|Non-blocking user experience, resilience to Salesforce downtime, automatic retry with exponential backoff, dead letter queue for operations team intervention\n\n|*Strangler Fig*\n|Not applicable\n|Big bang cutover (no gradual migration) - D365 CE fully replaced, not incrementally strangled\n\n|===\n\n<<<\n== Solution Approach\n\n* Deploy xref:bounded-contexts:profile.adoc[ProfileService] and xref:bounded-contexts:engagement.adoc[EngagementService] as bounded context microservices\n* Implement Anti-Corruption Layers (ACLs) for Salesforce and Braze integration\n* Establish event-driven architecture as the foundational integration pattern\n* Big bang cutover (TS-1 → TS-4)\n\n=== Related Documentation\n\nThis solution architecture references detailed technical specifications:\n\n==== Architecture Definition\n\n* xref:architecture-definitions:salesforce_customer_support.adoc[Salesforce Customer Support - Architecture Definition] - Business requirements, architecture decisions (ADRs), bounded context definitions, high-level integration patterns\n\n==== Bounded Context Specifications\n\n* xref:bounded-contexts:profile.adoc[ProfileService Bounded Context] - JIT Contact reconciliation, aggregate definitions\n* xref:bounded-contexts:engagement.adoc[EngagementService Bounded Context] - Customer feedback facade, Anti-Corruption Layer\n\n==== Interface Specifications\n\nDetailed API specifications available in the specifications directory:\n\n* link:../../specifications/rest/profile-service-v1.yaml[ProfileService REST API v1] - OpenAPI 3.0 specification for `/profile/v1` endpoints (includes Salesforce Contact reconciliation `GET /contact-id`)\n* link:../../specifications/rest/engagement-service-v1.yaml[EngagementService REST API v1] - OpenAPI 3.0 specification for `/engagement/v1` endpoints (includes `POST /feedback`)\n* link:../../specifications/events/engagement-events.json[Engagement Domain Events] - CloudEvents 1.0 JSON Schema for `SupportCaseCreated`, `SupportCaseUpdated`, `SupportCaseResolved`, `CustomerFeedbackSubmitted`\n\n==== External System Documentation\n\n* https://developer.salesforce.com/docs/atlas.en-us.api_rest.meta/api_rest/[Salesforce REST API Documentation] - Contact and Case object APIs\n* https://www.braze.com/docs/api/endpoints/messaging/send_messages/post_send_triggered_campaigns/[Braze Campaign Trigger API] - Push notification campaigns\n\n<<<\n== Executive Summary\n\n=== Challenge\n\nOTR digital customers (Mobile App, Web) currently submit feedback and support requests to D365 Customer Engagement, while Viva Energy's broader business units (fuel wholesale, Shell Card customers, other retail channels) use Salesforce Service Cloud. This creates:\n\n* *Fragmented customer support platform*: Customer support data split across two systems, preventing support agents from having a unified view of customer interactions across all channels\n* *Operational inefficiency*: Maintaining two separate customer support platforms increases operational overhead and costs\n* *Poor support experience*: D365 CE is not working well for digital customer support, impacting customer satisfaction and case resolution times\n* *Post-merger consolidation opportunity*: Following Viva Energy's acquisition of OTR, strategic alignment on Salesforce as the enterprise customer support platform\n\n=== Solution\n\nThis architecture establishes the **foundational Domain-Driven Design (DDD) implementation** for OTR's target state architecture by introducing two new bounded contexts (link:../bounded_context/profile.adoc[ProfileService], link:../bounded_context/engagement.adoc[EngagementService]) and event-driven integration patterns:\n\n==== New Bounded Contexts\n\n* *link:../bounded_context/profile.adoc[ProfileService]* (NEW): Just-In-Time (JIT) Contact reconciliation with Salesforce, upsert by email, returns Salesforce Contact ID to Mobile App\n* *link:../bounded_context/engagement.adoc[EngagementService]* (NEW): Customer feedback submission, Anti-Corruption Layer (ACL) for Salesforce Case creation, Braze integration for all outbound customer communications (push, email, SMS), async Case processing via Event Bus\n* *Event Bus* (NEW pattern): Domain event publishing using existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis) - first implementation of event-driven architecture pattern\n\n==== Integration Architecture\n\n* *Salesforce = System of Record*: Salesforce Service Cloud (shared Viva Energy instance) owns Contact and Case data\n* *Conformist Pattern*: ProfileService and EngagementService conform to existing Salesforce configuration and API contracts\n* *Anti-Corruption Layer*: EngagementService protects digital channels from Salesforce API changes, translates between OTR domain language and Salesforce\n* *Async Case Creation*: Non-blocking user experience, resilience to Salesforce downtime, automatic retry with exponential backoff, dead letter queue for failed Cases\n* *Event-Driven Notifications*: Salesforce webhook → EngagementService → Braze for all customer communications (push, email, SMS) on Case status updates\n\n==== Migration Approach\n\n* *Contact Migration*: One-time migration from app-specific database → Salesforce (upsert with flexible matching by email/phone/VCI)\n* *No Case Migration*: Historical D365 CE Cases not migrated (fresh start in Salesforce)\n* *Big Bang Cutover*: Single deployment, no phased rollout or parallel run\n* *D365 CE Retirement*: Complete decommissioning of D365 Customer Engagement post-cutover\n\n=== Key Architectural Significance\n\nThis migration establishes the first implementation of OTR's target DDD architecture:\n\n* First bounded contexts implemented (ProfileService, EngagementService)\n* First event-driven domain event pattern (foundation for future bounded contexts)\n* Foundation for Flybuys integration (ProfileService Contact reconciliation reused)\n* Establishes integration patterns (Conformist, ACL, Event-Driven) for future services\n\n=== Success Criteria\n\n* All digital customer feedback routed to Salesforce Service Cloud within 30 days of launch\n* Support agents have unified customer view across all Viva Energy channels (digital, wholesale, Shell Card, other retail)\n* D365 Customer Engagement decommissioned within 90 days post-cutover\n* Customer satisfaction score improves by 15% within 6 months\n* Average case resolution time decreases by 20% within 6 months\n* Zero data loss during Contact migration (100% validation pass rate)\n* Mobile App feedback submission success rate > 99.5% (including async Case creation)\n\n=== Technical Constraints\n\n* Shared Salesforce instance (Viva Energy multi-tenant environment)\n* Conform to existing Salesforce configuration and governance (data isolation strategy TBD with Salesforce admin team)\n* Contact migration must complete before cutover (no parallel run)\n* Async Case creation mandatory (non-blocking user experience)\n* Expected volume: 100-150 feedback submissions/day from 20k DAU (~0.5-0.75% submission rate), architecture capacity planned for 3x-10x growth\n\n=== Open Technical Decisions (TBD)\n\n* Salesforce Case field mapping for digital feedback categories (App, Service, Order, Rewards, Refund, Delete Account)\n* Salesforce data isolation strategy (Record Types, custom fields, queues)\n* Salesforce REST API authentication method (OAuth 2.0, Connected App, JWT bearer flow)\n* Salesforce webhook mechanism for Case updates (Outbound Messages, Platform Events, Process Builder)\n* Retry policy configuration (attempts, backoff intervals)\n* Salesforce API rate limit strategy (expected volume: 100-150 submissions/day from 20k DAU, capacity planning for 3x-10x growth)\n\n== Technical Requirements\n\n[width=\"100%\",cols=\"8%,92%\",options=\"header\",]\n|===\n|ID |Description\n\n|TR-CS-001\n|Every Mobile App user must have a Salesforce Contact record in Salesforce Service Cloud (shared Viva Energy instance)\n\n|TR-CS-002\n|ProfileService must reconcile Mobile App users as Salesforce Contacts using Just-In-Time (JIT) upsert by email address\n\n|TR-CS-003\n|ProfileService must return Salesforce Contact ID to Mobile App for feedback submission\n\n|TR-CS-004\n|Mobile App must support customer feedback submission with fields: Category (App, Service, Order, Rewards, Refund, Delete Account), Store Name, Time of Visit, Contact Phone Number, Free Text Message\n\n|TR-CS-005\n|EngagementService must create Salesforce Cases asynchronously via Event Bus (non-blocking user experience)\n\n|TR-CS-006\n|EngagementService must acknowledge feedback submission immediately to Mobile App user (\"Feedback submitted\" confirmation)\n\n|TR-CS-007\n|EngagementService must send push notification to customer via Braze when Case is successfully created in Salesforce\n\n|TR-CS-008\n|EngagementService must retry failed Case creation with configurable exponential backoff and dead letter queue for operations team intervention\n\n|TR-CS-009\n|Salesforce must be the System of Record for Contact and Case data (no local persistence in ProfileService or EngagementService)\n\n|TR-CS-010\n|Contact migration from app-specific database to Salesforce must complete before Mobile App cutover (upsert with flexible matching by email/phone/VCI)\n\n|TR-CS-011\n|No Case migration from D365 Customer Engagement to Salesforce (fresh start, historical Cases not migrated)\n\n|TR-CS-012\n|EngagementService must publish domain events (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`) to Event Bus for consumption by other bounded contexts\n\n|TR-CS-013\n|EngagementService must receive Salesforce webhook notifications when Cases are updated/resolved by support agents\n\n|TR-CS-014\n|EngagementService must trigger Braze push notifications to customers when Cases are updated/resolved (via Salesforce webhook → EngagementService → Braze)\n\n|TR-CS-015\n|ProfileService and EngagementService must conform to existing Salesforce configuration and API contracts (Conformist pattern)\n\n|TR-CS-016\n|All changes must be communicated using event-driven architecture via Event Bus (using existing AWS infrastructure: SNS+SQS/EventBridge/Kinesis)\n\n|TR-CS-017\n|Mobile App feedback submission success rate must exceed 99.5% (including async Case creation completion)\n\n|TR-CS-018\n|Contact migration must achieve 100% validation pass rate (zero data loss)\n\n|TR-CS-019\n|D365 Customer Engagement must be fully decommissioned within 90 days post-cutover\n\n|===\n\n== Technical Architecture\n\n=== Technical Capability Requirements\n\n==== Requirements Traceability\n\n[width=\"100%\",cols=\"15%,50%,35%\",options=\"header\",]\n|===\n|Requirement ID |Requirement Summary |Architectural Building Blocks\n\n|TR-CS-001\n|Every Mobile App user must have Salesforce Contact record\n|ABB-CS-001 (ProfileService), ABB-CS-004 (Salesforce), ABB-CS-007 (Contact Migration Tool)\n\n|TR-CS-002\n|ProfileService JIT Contact reconciliation via upsert by email\n|ABB-CS-001 (ProfileService), ABB-CS-004 (Salesforce)\n\n|TR-CS-003\n|ProfileService returns Salesforce Contact ID to Mobile App\n|ABB-CS-001 (ProfileService), ABB-CS-006 (Mobile App)\n\n|TR-CS-004\n|Mobile App supports feedback submission with structured fields\n|ABB-CS-006 (Mobile App), ABB-CS-002 (EngagementService)\n\n|TR-CS-005\n|EngagementService creates Salesforce Cases asynchronously\n|ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus), ABB-CS-004 (Salesforce)\n\n|TR-CS-006\n|EngagementService immediate acknowledgment to Mobile App\n|ABB-CS-002 (EngagementService), ABB-CS-006 (Mobile App)\n\n|TR-CS-007\n|EngagementService sends push notification via Braze on Case creation\n|ABB-CS-002 (EngagementService), ABB-CS-005 (Braze)\n\n|TR-CS-008\n|EngagementService retry logic with exponential backoff and DLQ\n|ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus)\n\n|TR-CS-009\n|Salesforce is System of Record for Contact and Case data\n|ABB-CS-004 (Salesforce), ABB-CS-001 (ProfileService - stateless), ABB-CS-002 (EngagementService - stateless)\n\n|TR-CS-010\n|Contact migration before Mobile App cutover\n|ABB-CS-007 (Contact Migration Tool), ABB-CS-004 (Salesforce)\n\n|TR-CS-011\n|No Case migration from D365 CE (fresh start)\n|ABB-CS-004 (Salesforce) - no migration tooling required\n\n|TR-CS-012\n|EngagementService publishes domain events to Event Bus\n|ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus)\n\n|TR-CS-013\n|EngagementService receives Salesforce webhook notifications\n|ABB-CS-002 (EngagementService), ABB-CS-004 (Salesforce)\n\n|TR-CS-014\n|EngagementService triggers Braze notifications on Case updates\n|ABB-CS-002 (EngagementService), ABB-CS-004 (Salesforce), ABB-CS-005 (Braze)\n\n|TR-CS-015\n|ProfileService and EngagementService conform to Salesforce config\n|ABB-CS-001 (ProfileService), ABB-CS-002 (EngagementService), ABB-CS-004 (Salesforce)\n\n|TR-CS-016\n|Event-driven architecture via Event Bus\n|ABB-CS-003 (Event Bus), ABB-CS-002 (EngagementService)\n\n|TR-CS-017\n|Mobile App feedback submission success rate > 99.5%\n|ABB-CS-006 (Mobile App), ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus), ABB-CS-004 (Salesforce)\n\n|TR-CS-018\n|Contact migration 100% validation pass rate\n|ABB-CS-007 (Contact Migration Tool), ABB-CS-004 (Salesforce)\n\n|TR-CS-019\n|D365 CE decommissioned within 90 days post-cutover\n|All ABBs (replacement system operational)\n\n|===\n\n=== Service Catalogues\n\n==== Application Portfolio Catalogue\n\n[width=\"100%\",cols=\"20%,15%,15%,15%,35%\",options=\"header\",]\n|===\n|Application |Lifecycle State |Owner |Hosting Platform |Description\n\n|*ProfileService*\n|NEW\n|OTR Platform Team\n|AWS (TBD: Lambda/ECS/EKS)\n|JIT Contact reconciliation with Salesforce, returns Salesforce Contact ID, foundation for Flybuys integration\n\n|*EngagementService*\n|NEW\n|OTR Platform Team\n|AWS (TBD: Lambda/ECS/EKS)\n|Customer feedback submission facade, ACL for Salesforce Case creation, Braze integration for all outbound communications (push, email, SMS), webhook receiver\n\n|*Mobile App (iOS)*\n|ACTIVE (UPDATE)\n|OTR Mobile Team\n|Apple App Store\n|iOS native app with feedback form, integrate with ProfileService and EngagementService APIs\n\n|*Mobile App (Android)*\n|ACTIVE (UPDATE)\n|OTR Mobile Team\n|Google Play Store\n|Android native app with feedback form, integrate with ProfileService and EngagementService APIs\n\n|*Salesforce Service Cloud*\n|ACTIVE (EXPAND)\n|Viva Energy Salesforce Admin Team\n|Salesforce (SaaS)\n|Shared Viva Energy instance, System of Record for Contact and Case data, adding OTR digital customer support\n\n|*Braze*\n|ACTIVE (EXTEND)\n|OTR Marketing Team\n|Braze (SaaS)\n|Marketing automation platform, EngagementService triggers push notifications for Case updates\n\n|*D365 Customer Engagement*\n|RETIRE\n|OTR Support Team\n|Microsoft Azure (SaaS)\n|Legacy customer support platform, decommissioned within 90 days post-cutover\n\n|*App-Specific Customer Database*\n|RETIRE\n|OTR Platform Team\n|AWS (RDS/DynamoDB)\n|Legacy customer contact storage, one-time migration to Salesforce, then deprecated\n\n|*Event Bus*\n|NEW\n|OTR Platform Team\n|AWS (SNS+SQS/EventBridge/Kinesis)\n|Domain event publishing infrastructure for bounded context integration\n\n|*Contact Migration Tool*\n|TEMPORARY\n|OTR Platform Team\n|AWS (Script/Lambda)\n|One-time migration app database → Salesforce with upsert logic, retired after migration complete\n\n|===\n\n==== Technology Capability Requirements\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Technology Capability |Implementation Technology (TBD in detailed design) |Requirements\n\n|*Microservice Hosting*\n|AWS Lambda / ECS / EKS\n|Host ProfileService and EngagementService with auto-scaling, high availability, monitoring\n\n|*API Gateway*\n|AWS API Gateway / Application Load Balancer\n|REST API routing, authentication, rate limiting, request validation for ProfileService and EngagementService\n\n|*Event Bus*\n|AWS SNS+SQS / EventBridge / Kinesis\n|Domain event publishing, async message processing, retry logic, dead letter queue\n\n|*Salesforce Integration*\n|Salesforce REST API / SOAP API\n|Contact CRUD operations, Case creation, webhook notifications, OAuth 2.0 authentication\n\n|*Braze Integration*\n|Braze REST API / SDK\n|Push notification campaign triggers, customer profile reconciliation\n\n|*Authentication & Authorisation*\n|Microsoft Entra External ID / AWS Cognito\n|Mobile App user authentication, API authorisation, JWT token validation\n\n|*Observability & Monitoring*\n|AWS CloudWatch / Datadog / New Relic\n|Application metrics, logs, traces, dashboards, alerting (feedback submission rate, queue depth, API errors)\n\n|*Secret Management*\n|AWS Secrets Manager / Parameter Store\n|Salesforce credentials, Braze API keys, OAuth tokens, encryption keys\n\n|*Database (Migration Tool)*\n|AWS RDS / DynamoDB (read-only access)\n|Contact migration from app-specific database\n\n|*CI/CD Pipeline*\n|GitHub Actions / AWS CodePipeline\n|Automated build, test, deployment for ProfileService, EngagementService, Mobile App\n\n|*Infrastructure as Code*\n|Terraform / AWS CloudFormation / CDK\n|Declarative infrastructure provisioning for Event Bus, microservices, monitoring\n\n|*API Documentation*\n|OpenAPI / Swagger\n|ProfileService and EngagementService API specifications for Mobile App integration\n\n|===\n\n==== Feature Flag Register\n\n*Note*: Per ADR-CS-006 (big bang cutover, not phased rollout), feature flags are minimal and used primarily for emergency rollback/kill switches.\n\n[width=\"100%\",cols=\"20%,15%,35%,30%\",options=\"header\",]\n|===\n|Feature Flag |Default State |Purpose |Rollback Scenario\n\n|*enable_salesforce_feedback_submission*\n|OFF (pre-cutover), ON (post-cutover)\n|Enable/disable feedback submission to EngagementService → Salesforce (kill switch for emergency rollback to D365 CE)\n|Feedback submission success rate < 95%, Salesforce API failures, critical bugs - revert to D365 CE integration\n\n|*enable_async_case_creation*\n|ON\n|Enable/disable async Case creation via Event Bus (fallback to synchronous processing if Event Bus issues)\n|Event Bus infrastructure failures, queue backlog unmanageable - temporary synchronous processing\n\n|*enable_braze_notifications*\n|ON\n|Enable/disable Braze push notifications for Case updates (degrade gracefully if Braze integration fails)\n|Braze API failures, notification delivery rate < 80% - disable notifications temporarily\n\n|*enable_jit_contact_reconciliation*\n|ON\n|Enable/disable ProfileService JIT Contact reconciliation (fallback to cached Contact IDs if Salesforce unavailable)\n|Salesforce API downtime, Contact reconciliation failures > 5% - use cached Contact IDs temporarily\n\n|*enable_salesforce_webhook_processing*\n|ON\n|Enable/disable Salesforce webhook processing for Case updates (fallback to polling if webhook failures)\n|Webhook delivery failures, authentication issues - temporary polling fallback\n\n|===\n\n*Feature Flag Management*:\n\n* Feature flags managed via AWS AppConfig / LaunchDarkly / custom feature flag service (TBD in detailed design)\n* Mobile App feature flags controlled server-side (no app release required for flag changes)\n* Backend service feature flags configured via environment variables / configuration service\n* Feature flag changes logged and audited (who changed, when, reason)\n* Post-cutover monitoring: Gradual removal of feature flags once system stability confirmed (30-60 days)\n\n==== Data Entity Catalogue\n\n[width=\"100%\",cols=\"20%,15%,35%,30%\",options=\"header\",]\n|===\n|Data Entity |System of Record |Key Attributes |Lifecycle\n\n|*Contact*\n|Salesforce Service Cloud\n|• Contact ID (Salesforce 15/18-char ID) +\n• Email (primary matching key) +\n• First Name, Last Name +\n• Phone Number +\n• Viva Consumer ID (VCI) +\n• Account (Viva Energy customer account) +\n• Record Type (OTR Digital vs other channels)\n|Created: ProfileService JIT reconciliation or Contact Migration Tool +\nUpdated: ProfileService JIT upsert (email changes), Salesforce (manual updates by support agents) +\nDeleted: Salesforce retention policy (GDPR/compliance)\n\n|*Case*\n|Salesforce Service Cloud\n|• Case Number (Salesforce auto-generated) +\n• Contact ID (reference to Contact) +\n• Subject (derived from Category) +\n• Description (Free Text Message) +\n• Category (App, Service, Order, Rewards, Refund, Delete Account) +\n• Store Name (OTR location) +\n• Time of Visit +\n• Status (New, In Progress, Resolved, Closed) +\n• Priority, Origin (Mobile App) +\n• Owner (support agent/queue)\n|Created: EngagementService async Case creation +\nUpdated: Support agents (Salesforce UI), EngagementService (webhook processing) +\nDeleted: Salesforce retention policy (archive after X years)\n\n|*Feedback Submission (transient)*\n|None (not persisted)\n|• Salesforce Contact ID +\n• Category +\n• Store Name +\n• Time of Visit +\n• Contact Phone Number +\n• Free Text Message\n|Created: Mobile App user submission +\nProcessed: EngagementService publishes to Event Bus, Case created in Salesforce +\nNot persisted in ProfileService/EngagementService (stateless)\n\n|*Domain Events*\n|Event Bus (ephemeral)\n|**SupportCaseCreated**: +\n• Case Number, Contact ID, Category, Timestamp +\n**SupportCaseUpdated**: +\n• Case Number, Status, Updated By, Timestamp +\n**SupportCaseResolved**: +\n• Case Number, Resolution, Resolved By, Timestamp +\n**CustomerFeedbackSubmitted**: +\n• Contact ID, Category, Timestamp\n|Published: EngagementService +\nConsumed: Other bounded contexts (future), Braze notification triggers +\nRetention: Short-lived (minutes to hours), not persisted for event sourcing\n\n|*Braze Customer Profile*\n|Braze\n|• External User ID (VCI or Email) +\n• Push Notification Tokens (iOS/Android) +\n• Notification Preferences +\n• Campaign Engagement History\n|Created/Updated: EngagementService on Case creation/update +\nManaged: Braze (external SaaS)\n\n|===\n\n*Data Migration Entities*:\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Source Entity |Target Entity |Migration Strategy\n\n|*App Database Contact*\n|Salesforce Contact\n|One-time migration via Contact Migration Tool: +\n• Upsert by email (primary), phone (secondary), VCI (tertiary) +\n• Map: Email → Email, Name → First/Last Name, Phone → Phone, VCI → External ID +\n• Validation: 100% data integrity check, reconciliation report\n\n|*D365 CE Case*\n|Not migrated\n|ADR-CS-005: No Case migration (fresh start in Salesforce) +\nD365 CE Cases archived separately for compliance if needed\n\n|===\n\n==== Data Quality & Validation\n\n*Contact Migration Validation Rules*:\n\n* Email format validation (RFC 5322 compliance)\n* Phone number format validation (E.164 international format)\n* VCI format validation (alphanumeric, length constraints)\n* Duplicate detection: Flag potential duplicates for manual review (same email/phone combination)\n* Mandatory fields: Email (required), First Name, Last Name (required for Salesforce Contact)\n\n*Case Creation Validation Rules*:\n\n* Contact ID must exist in Salesforce (validated by EngagementService before Case creation)\n* Category must be one of: App, Service, Order, Rewards, Refund, Delete Account\n* Free Text Message maximum length: 32,000 characters (Salesforce Case Description limit)\n* Store Name validated against OTR location master data (optional - warn if not found)\n\n<<<\n== Solution Building Blocks\n\nThis section defines the specific technology products, configurations, and implementation details for each Solution Building Block (SBB).\n\n=== Technology Portfolio Catalogue\n\n[width=\"100%\",cols=\"10%,20%,25%,25%,20%\",options=\"header\",]\n|===\n|SBB ID |Component |Technology Product |Version/Configuration |Deployment Platform\n\n|SBB-CS-001\n|ProfileService Microservice\n|.NET 8 / Node.js 20 LTS\n|RESTful API, containerised\n|AWS ECS Fargate / Lambda\n\n|SBB-CS-002\n|EngagementService Microservice\n|.NET 8 / Node.js 20 LTS\n|RESTful API, containerised, async workers\n|AWS ECS Fargate / Lambda\n\n|SBB-CS-003\n|Event Bus\n|AWS SNS + SQS / EventBridge\n|Standard queues, FIFO for ordering\n|AWS (managed service)\n\n|SBB-CS-004\n|API Gateway\n|AWS API Gateway / ALB\n|REST API, JWT validation\n|AWS (managed service)\n\n|SBB-CS-005\n|Salesforce Integration Layer\n|Salesforce REST API Client\n|OAuth 2.0 JWT bearer flow\n|Embedded in SBB-CS-001/002\n\n|SBB-CS-006\n|Braze Integration Layer\n|Braze REST API SDK\n|API key authentication\n|Embedded in SBB-CS-002\n\n|SBB-CS-007\n|Contact Migration Tool\n|Python 3.11 / .NET 8\n|One-time batch script\n|AWS Lambda / EC2\n\n|SBB-CS-008\n|Application Monitoring\n|AWS CloudWatch / Datadog\n|Metrics, logs, traces, dashboards\n|AWS / SaaS\n\n|SBB-CS-009\n|Secret Management\n|AWS Secrets Manager\n|KMS encryption\n|AWS (managed service)\n\n|SBB-CS-010\n|Mobile App (iOS)\n|SwiftUI, Kotlin Multiplatform\n|iOS 15+\n|Apple App Store\n\n|SBB-CS-011\n|Mobile App (Android)\n|Jetpack Compose, Kotlin Multiplatform\n|Android 8+\n|Google Play Store\n\n|SBB-CS-012\n|Feature Flag Service\n|AWS AppConfig / LaunchDarkly\n|Server-side flags, real-time updates\n|AWS / SaaS\n\n|===\n\n<<<\n== Data Architecture\n\nThis section defines the physical data models, event schemas, and API request/response formats.\n\n=== Domain Event Schemas\n\nAll domain events follow the https://cloudevents.io/[CloudEvents 1.0] specification for consistency and interoperability.\n\n*Event Schema Specifications*: See // TODO: Add to Antora - specifications/events/engagement-events.json[Engagement Service Event Schemas] for complete JSON schemas and examples.\n\n==== Event Catalogue\n\n[width=\"100%\",cols=\"30%,20%,50%\",options=\"header\",]\n|===\n|Event Type |Publisher |Description\n\n|`SupportCaseCreated`\n|EngagementService\n|Published when EngagementService successfully creates a Case in Salesforce after async processing\n\n|`SupportCaseUpdated`\n|EngagementService (via Salesforce webhook)\n|Published when a support agent updates a Case in Salesforce (status, priority, comment changes)\n\n|`SupportCaseResolved`\n|EngagementService (via Salesforce webhook)\n|Published when a support agent resolves/closes a Case in Salesforce\n\n|`CustomerFeedbackSubmitted`\n|EngagementService\n|Published when customer submits feedback via Mobile App (before async Case creation)\n\n|===\n\n*Event Format*: All events use CloudEvents 1.0 envelope with event-specific payload in the `data` field.\n\n*Schema Location*: `specifications/events/engagement-events.json`\n\n=== API Request/Response Schemas\n\n==== ProfileService: GET /profile/contact-id\n\n*Response* (200 OK):\n[source,json]\n----\n{\n  \"contactId\": \"0034X00000ABCDEFG\",\n  \"email\": \"customer@example.com\",\n  \"firstName\": \"John\",\n  \"lastName\": \"Smith\"\n}\n----\n\n==== EngagementService: POST /feedback\n\n*Request*:\n[source,json]\n----\n{\n  \"contactId\": \"0034X00000ABCDEFG\",\n  \"category\": \"App\",\n  \"storeName\": \"OTR Adelaide\",\n  \"timeOfVisit\": \"2026-01-07T12:00:00Z\",\n  \"contactPhoneNumber\": \"+61412345678\",\n  \"message\": \"App crashed when submitting feedback\"\n}\n----\n\n*Response* (202 Accepted):\n[source,json]\n----\n{\n  \"feedbackId\": \"fb-2026-01-07-12345\",\n  \"status\": \"submitted\",\n  \"message\": \"Your feedback has been submitted!\"\n}\n----\n\n=== Salesforce Field Mappings\n\n==== Case Object Mapping\n\n[width=\"100%\",cols=\"25%,25%,25%,25%\",options=\"header\",]\n|===\n|OTR Field |Salesforce Field |Data Type |Notes\n\n|Category\n|Feedback_Category__c\n|Picklist\n|App, Service, Order, Rewards, Refund, Delete Account\n\n|Store Name\n|Store_Name__c\n|String (255)\n|OTR location name\n\n|Time of Visit\n|Time_of_Visit__c\n|DateTime\n|When customer visited store\n\n|Free Text Message\n|Description\n|Long Text (32,000)\n|Customer feedback message\n\n|===\n\n<<<\n=== Baseline Architecture\n\n==== Existing System Components\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Component |Current State |Status\n\n|*D365 Customer Engagement*\n|Customer support platform for OTR digital customers (Mobile App, Web), handles feedback submission and case management\n|**DEPRECATED** - Being replaced by Salesforce Service Cloud\n\n|*App-Specific Customer Database*\n|Stores customer contact data for Mobile App users, separate from Viva Energy systems\n|**MIGRATING** - One-time migration to Salesforce, then deprecated\n\n|*Mobile App*\n|iOS/Android native apps with feedback submission form including Category, Store Name, Time of Visit, Contact Phone Number, and Free Text Message fields\n|**REQUIRES UPDATE** - Integrate with ProfileService and EngagementService APIs (feedback form UI already complete)\n\n|*Salesforce Service Cloud*\n|Shared Viva Energy instance handling customer support for fuel wholesale, Shell Card customers, other retail channels\n|**EXPANDING** - Adding OTR digital customer support Cases and Contacts\n\n|*Existing AWS Infrastructure*\n|SNS+SQS / EventBridge / Kinesis available for event-driven architecture\n|**REUSING** - Event Bus implementation leverages existing infrastructure\n\n|===\n\n==== Integration Architecture\n\n*Current state:*\n\n* Mobile App → D365 Customer Engagement (direct integration)\n* App-specific customer database → standalone (no Salesforce integration)\n* No event-driven architecture (synchronous, tightly coupled)\n* No Anti-Corruption Layer protecting digital channels\n* Viva Energy support teams use Salesforce, OTR digital support uses D365 CE (fragmented)\n\n==== Technical Debt\n\n*No longer relevant* - D365 CE being deprecated, not documenting technical debt of system being retired.\n\n*New technical debt introduced by this migration:*\n\n* Salesforce field mapping TBD (requires coordination with Viva Energy Salesforce admin team)\n* Data isolation strategy TBD (Record Types, custom fields, queues - multi-tenant governance)\n* Salesforce webhook mechanism TBD (Outbound Messages vs Platform Events vs Process Builder)\n* Expected feedback volume unknown (gathering data for rate limit planning)\n\n=== Gap Analysis\n\n==== Missing Capabilities\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Missing Capability |Description\n\n|*ProfileService bounded context*\n|No existing service for Contact reconciliation with Salesforce - requires new microservice implementing JIT upsert by email, returning Salesforce Contact ID\n\n|*EngagementService bounded context*\n|No existing service for customer feedback facade - requires new microservice implementing Anti-Corruption Layer for Salesforce Case creation, Braze integration, async processing via Event Bus\n\n|*Event Bus domain event pattern*\n|No existing domain event publishing infrastructure - requires implementing event-driven architecture pattern using existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis)\n\n|*Async Case creation workflow*\n|Current D365 CE integration is synchronous - requires implementing async processing with retry logic, exponential backoff, dead letter queue\n\n|*Salesforce webhook integration*\n|No existing capability to receive Salesforce notifications - requires implementing webhook receiver in EngagementService for Case update notifications\n\n|*Braze push notification orchestration*\n|No existing integration for Case-related push notifications - requires implementing Braze campaign triggers from EngagementService\n\n|*Contact migration tooling*\n|No existing tooling for app database → Salesforce Contact migration with upsert logic (match by email/phone/VCI)\n\n|*Feedback form enhancements*\n|Mobile App feedback form lacks structured fields (Category, Store Name, Time of Visit, Contact Phone Number) - requires UI updates\n\n|===\n\n==== Missing Bounded Contexts\n\n[width=\"100%\",cols=\"30%,30%,40%\",options=\"header\",]\n|===\n|Bounded Context |Responsibilities |Implementation Status\n\n|*link:../bounded_context/profile.adoc[ProfileService]*\n|JIT Contact reconciliation with Salesforce (upsert by email), return Salesforce Contact ID to digital channels, foundation for future Flybuys partner linking\n|**NEW** - First bounded context implementation\n\n|*link:../bounded_context/engagement.adoc[EngagementService]*\n|Customer feedback submission facade, Anti-Corruption Layer for Salesforce Case creation, Braze integration for push notifications, async Case processing, webhook receiver for Case updates\n|**NEW** - First bounded context implementation\n\n|===\n\n==== Missing Integration Patterns\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Integration Pattern |Description\n\n|*Anti-Corruption Layer (ACL)*\n|EngagementService → Salesforce Service Cloud - protects digital channels from Salesforce API changes, translates between OTR domain language and Salesforce\n\n|*Conformist*\n|ProfileService/EngagementService → Salesforce - conform to existing Salesforce configuration and API contracts (shared Viva Energy instance)\n\n|*Event-Driven Architecture (OHS+PL)*\n|Event Bus publishing domain events (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`) for loose coupling between bounded contexts\n\n|*Just-In-Time (JIT) Integration*\n|ProfileService → Salesforce Contact reconciliation on-demand (no pre-sync)\n\n|*Async Processing*\n|EngagementService Case creation via Event Bus with retry, exponential backoff, dead letter queue\n\n|===\n\n=== Target State Architecture\n\n==== Architectural Building Blocks (ABB)\n\n[width=\"100%\",cols=\"20%,25%,30%,25%\",options=\"header\",]\n|===\n|ABB ID |Bounded Context |Responsibilities |Technology (TBD in Solution Architecture)\n\n|ABB-CS-001\n|*link:../bounded_context/profile.adoc[ProfileService]*\n|JIT Contact reconciliation with Salesforce (upsert by email), return Salesforce Contact ID, foundation for Flybuys partner linking\n|Microservice (.NET/Node.js), REST API, Salesforce REST API client\n\n|ABB-CS-002\n|*link:../bounded_context/engagement.adoc[EngagementService]*\n|Customer feedback submission facade, ACL for Salesforce Case creation, Braze integration, async processing, webhook receiver\n|Microservice (.NET/Node.js), REST API, Event Bus publisher/subscriber, Salesforce webhook receiver\n\n|ABB-CS-003\n|*Event Bus*\n|Domain event publishing infrastructure (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`)\n|AWS SNS+SQS / EventBridge / Kinesis\n\n|ABB-CS-004\n|*Salesforce Service Cloud*\n|System of Record for Contact and Case data (shared Viva Energy instance)\n|Salesforce Service Cloud (external SaaS)\n\n|ABB-CS-005\n|*Braze*\n|Marketing automation platform for push notifications\n|Braze (external SaaS) - existing integration\n\n|ABB-CS-006\n|*Mobile App*\n|iOS/Android native apps with enhanced feedback form (Category, Store Name, Time of Visit, Contact Phone Number, Free Text Message)\n|Kotlin Multiplatform, SwiftUI, Jetpack Compose\n\n|ABB-CS-007\n|*Contact Migration Tool*\n|One-time migration app database → Salesforce with upsert logic (match by email/phone/VCI)\n|Script/tool (.NET/Python/Node.js)\n\n|===\n\n==== Integration Architecture\n\n===== Integration Flows\n\n*Customer Feedback Submission (Async):*\n\n1. *Mobile App* → ProfileService: Authenticate user, get Salesforce Contact ID (JIT reconciliation)\n2. *Mobile App* → EngagementService: Submit feedback (POST /feedback with Contact ID, Category, Store Name, Time of Visit, Phone, Message)\n3. *EngagementService* → Mobile App: Immediate acknowledgment (\"Feedback submitted\")\n4. *EngagementService* → Event Bus: Publish work item for async Case creation\n5. *Background Worker* (EngagementService) → Salesforce: Create Case via REST API\n6. *Success*: EngagementService → Event Bus: Publish `SupportCaseCreated` event\n7. *EngagementService* → Braze: Trigger push notification campaign (\"Your feedback has been received, Case #12345\")\n8. *Failure*: Retry with exponential backoff → Dead Letter Queue → Ops team alert\n\n*Case Update Notification (Bidirectional):*\n\n1. *Support Agent* updates/resolves Case in Salesforce\n2. *Salesforce* → EngagementService: Webhook notification (Case updated)\n3. *EngagementService* → Event Bus: Publish `SupportCaseUpdated` or `SupportCaseResolved` event\n4. *EngagementService* → Braze: Trigger push notification campaign (\"Your case has been resolved\")\n\n*Contact Reconciliation (JIT):*\n\n1. *Mobile App user* authenticates\n2. *Mobile App* → ProfileService: GET /profile/contact-id\n3. *ProfileService* → Salesforce: Query Contact by email\n4. *Match found*: Return existing Salesforce Contact ID\n5. *No match*: Create new Contact in Salesforce, return new Contact ID\n6. *ProfileService* → Mobile App: Return Salesforce Contact ID (cached by Mobile App)\n\n===== System of Record Boundaries\n\n[width=\"100%\",cols=\"30%,35%,35%\",options=\"header\",]\n|===\n|Data Entity |System of Record |Rationale\n\n|*Contact*\n|Salesforce Service Cloud\n|Shared Viva Energy instance, unified customer profile across all channels (digital, wholesale, Shell Card, retail)\n\n|*Case*\n|Salesforce Service Cloud\n|Support agents manage Cases in Salesforce, digital channels submit via EngagementService ACL\n\n|*Feedback Submission (transient)*\n|None (no persistence)\n|EngagementService processes feedback and creates Case in Salesforce, no local storage\n\n|*Domain Events*\n|Event Bus (ephemeral)\n|Events published to Event Bus, consumed by subscribers, not persisted long-term (event sourcing not in scope)\n\n|===\n\n==== Data Architecture Principles\n\n===== Aggregate Persistence\n\n*ProfileService:*\n\n* **No local aggregate persistence** - ProfileService is stateless, queries Salesforce on-demand\n* Salesforce Contact is the aggregate root (owned by Salesforce)\n* ProfileService acts as facade/translator, not system of record\n\n*EngagementService:*\n\n* **No local aggregate persistence** - EngagementService is stateless, creates Cases in Salesforce via ACL\n* Salesforce Case is the aggregate root (owned by Salesforce)\n* EngagementService maintains no local Case state (Conformist pattern - trust Salesforce as source of truth)\n* Async processing state managed via Event Bus (work items in queue, not database)\n\n===== Event Store\n\n* **Event Bus** (SNS+SQS/EventBridge/Kinesis) handles domain event publishing\n* Events are **ephemeral** (consumed and discarded, not persisted for event sourcing)\n* No Event Store implementation in this architecture (future enhancement if needed)\n* Event schema versioning TBD in Solution Architecture\n\n\n=== Architecture Decisions\n\n==== ADR-CS-001: Consolidate onto Salesforce Service Cloud (not build custom solution)\n\n*Status*: Accepted\n\n*Context*:\n\n* D365 Customer Engagement not working well for digital customer support\n* Viva Energy already uses Salesforce Service Cloud for fuel wholesale, Shell Card, other retail channels\n* Post-merger opportunity to consolidate onto single platform\n* Alternative: Build custom support platform or use different SaaS\n\n*Decision*:\n\nConsolidate OTR digital customer support onto Salesforce Service Cloud (shared Viva Energy instance).\n\n*Rationale*:\n\n* **Unified customer view**: Support agents see all interactions across channels (digital, wholesale, Shell Card, retail)\n* **Platform consolidation**: Single support platform reduces operational overhead and costs\n* **Proven solution**: Salesforce Service Cloud is established, feature-rich, well-supported\n* **Post-merger alignment**: Strategic decision to standardize on Viva Energy platforms\n* **Avoid custom development**: Building custom support platform would be costly and high-risk\n\n*Consequences*:\n\n* Unified customer support across Viva Energy Group\n* Reduced operational complexity (single platform vs two)\n* Leverage Salesforce capabilities (case routing, knowledge base, AI, omnichannel)\n* ⚠️ Conformist pattern required (shared instance, conform to existing configuration)\n* ⚠️ Multi-tenant governance needed (data isolation, security, queues)\n* ❌ Less control over platform evolution (SaaS vendor, shared instance)\n\n==== ADR-CS-002: Implement ProfileService and EngagementService as first DDD bounded contexts\n\n*Status*: Accepted\n\n*Context*:\n\n* OTR target architecture uses Domain-Driven Design with bounded contexts\n* This migration is opportunity to establish first implementation\n* Alternative: Direct Mobile App → Salesforce integration (no bounded contexts)\n* Alternative: Single monolithic service for all customer-facing APIs\n\n*Decision*:\n\nImplement ProfileService and EngagementService as separate bounded contexts following DDD strategic patterns.\n\n*Rationale*:\n\n* **Foundation for target architecture**: First implementation of DDD pattern for future bounded contexts (Flybuys, LocationService, PaymentService)\n* **Separation of concerns**: ProfileService handles identity/Contact reconciliation, EngagementService handles support/feedback (different responsibilities, different change rates)\n* **Anti-Corruption Layer**: EngagementService protects digital channels from Salesforce API changes\n* **Reusability**: ProfileService Contact reconciliation reused for Flybuys integration\n* **Event-driven architecture**: Establishes pattern for loose coupling between bounded contexts\n\n*Consequences*:\n\n* Establishes DDD architecture foundation for OTR\n* Reusable ProfileService for Flybuys and future integrations\n* Digital channels protected from Salesforce API changes (ACL)\n* Clear bounded context boundaries and responsibilities\n* ⚠️ Increased initial complexity (two new microservices vs direct integration)\n* ⚠️ Requires Event Bus infrastructure implementation\n* ⚠️ Team must learn DDD patterns and bounded context design\n\n==== ADR-CS-003: Async Case creation via Event Bus (not synchronous)\n\n*Status*: Accepted\n\n*Context*:\n\n* Current D365 CE integration is synchronous (user waits for Case creation)\n* Alternative: Keep synchronous integration (Mobile App → EngagementService → Salesforce synchronously)\n* Salesforce API may experience downtime or latency\n\n*Decision*:\n\nImplement async Case creation via Event Bus with immediate user acknowledgment, retry logic, exponential backoff, and dead letter queue.\n\n*Rationale*:\n\n* **Non-blocking user experience**: User gets immediate \"Feedback submitted\" confirmation, not waiting for Salesforce API\n* **Resilience**: If Salesforce is down, feedback still accepted, Case created when Salesforce recovers\n* **Retry logic**: Automatic retry with exponential backoff handles transient failures\n* **Operational visibility**: Dead letter queue alerts ops team to persistent failures\n* **Scalability**: Queue buffering handles traffic spikes\n\n*Consequences*:\n\n* Better user experience (no waiting for Salesforce API)\n* Resilient to Salesforce downtime (queue buffers work)\n* Automatic retry reduces manual intervention\n* Queue depth monitoring provides operational visibility\n* ⚠️ Eventual consistency (user gets success notification after Case created, not immediately)\n* ⚠️ Increased complexity (Event Bus, background workers, retry logic, DLQ)\n* ⚠️ Requires monitoring and alerting for DLQ\n\n==== ADR-CS-004: ProfileService uses email as primary matching key (not VCI)\n\n*Status*: Accepted\n\n*Context*:\n\n* ProfileService needs to reconcile Mobile App users as Salesforce Contacts\n* Alternative matching keys: VCI (Viva Consumer ID), email, phone, Salesforce External ID\n* Email changes are rare but possible\n\n*Decision*:\n\nUse email address as primary matching key for Contact reconciliation (JIT upsert by email).\n\n*Rationale*:\n\n* **Availability**: Email always available for authenticated users\n* **Uniqueness**: Email is unique identifier in Salesforce and Mobile App\n* **Salesforce standard**: Salesforce Contact uses email as standard lookup field\n* **Simplicity**: Single matching key simplifies upsert logic\n* **Edge case acceptable**: Email changes are rare, manual cleanup acceptable\n\n*Consequences*:\n\n* Simple upsert logic (query by email, create if not found)\n* Leverages Salesforce standard email field\n* Email always available from authentication\n* ⚠️ Email changes create duplicate Contacts (rare edge case, manual cleanup)\n* ⚠️ Future enhancement: Add VCI as Salesforce External ID for stable matching\n\n==== ADR-CS-005: No Case migration from D365 CE (fresh start)\n\n*Status*: Accepted\n\n*Context*:\n\n* D365 CE contains historical customer support Cases\n* Alternative: Migrate historical Cases to Salesforce (preserve support history)\n* Alternative: Archive D365 CE Cases separately (read-only access)\n\n*Decision*:\n\nDo not migrate historical Cases from D365 CE to Salesforce. Start fresh in Salesforce.\n\n*Rationale*:\n\n* **Limited value**: Historical D365 CE Cases not critical for future support\n* **Data quality**: D365 CE Case data may be inconsistent or incomplete\n* **Complexity**: Case migration requires mapping D365 CE schema to Salesforce, data transformation, validation\n* **Cost-benefit**: Migration effort outweighs value of historical data\n* **Archive option**: D365 CE Cases can be archived separately if needed (read-only access for auditing)\n\n*Consequences*:\n\n* Simpler migration (Contacts only, no Case migration)\n* Faster time to value (no Case migration delay)\n* Clean start in Salesforce (no legacy data quality issues)\n* ⚠️ Historical Cases not visible in Salesforce (support agents can't see old Cases)\n* ⚠️ D365 CE must remain accessible temporarily for historical Case lookups (if needed)\n* ❌ Loss of historical Case insights (reporting, analytics on old Cases)\n\n==== ADR-CS-006: Big bang cutover (not phased rollout)\n\n*Status*: Accepted\n\n*Context*:\n\n* Alternative: Phased rollout with feature flags (pilot users first, gradual enablement)\n* Alternative: Parallel run (submit to both D365 CE and Salesforce temporarily)\n* Flybuys integration uses phased rollout (AS-1, AS-2, AS-3 architecture states)\n\n*Decision*:\n\nBig bang cutover - migrate Contacts, deploy ProfileService and EngagementService, switch Mobile App, retire D365 CE.\n\n*Rationale*:\n\n* **Simplicity**: No parallel run complexity, no feature flag management\n* **Faster D365 CE retirement**: No extended transition period maintaining two systems\n* **Limited risk**: Customer support not mission-critical (not payment processing), rollback possible\n* **User base manageable**: OTR digital customers smaller than Flybuys integration scope\n* **Different use case**: Flybuys phased rollout manages points accrual complexity, support feedback is simpler\n\n*Consequences*:\n\n* Simpler deployment (single cutover, no AS-1/AS-2/AS-3 states)\n* Faster D365 CE retirement (no extended parallel run)\n* No feature flag complexity or pilot user management\n* ⚠️ Higher cutover risk (all users switch at once)\n* ⚠️ Requires comprehensive testing before cutover\n* ⚠️ Rollback plan required (revert to D365 CE if critical issues)\n\n==== ADR-CS-007: EngagementService receives Salesforce webhooks for Case updates\n\n*Status*: Accepted\n\n*Context*:\n\n* Support agents update/resolve Cases in Salesforce\n* Need to notify customers of Case status changes via push notifications\n* Alternative: Poll Salesforce API for Case updates (inefficient)\n* Alternative: No customer notifications (agents contact customers directly)\n\n*Decision*:\n\nSalesforce sends webhook notifications to EngagementService when Cases are updated/resolved. EngagementService triggers Braze push notifications.\n\n*Rationale*:\n\n* **Real-time notifications**: Customer notified immediately when agent resolves Case\n* **Efficient**: Webhook push model (not polling)\n* **Event-driven**: Aligns with event-driven architecture pattern\n* **Better customer experience**: Proactive notification vs waiting for agent contact\n\n*Consequences*:\n\n* Real-time customer notifications for Case updates\n* Efficient push model (no polling overhead)\n* Bidirectional integration (Mobile App → Salesforce → Mobile App)\n* ⚠️ Salesforce webhook mechanism TBD (Outbound Messages vs Platform Events vs Process Builder)\n* ⚠️ Webhook authentication and security required\n* ⚠️ EngagementService must handle webhook retries and failures\n\n<<<\n== Interface Specifications\n\nThis section provides references to the complete API specifications and event catalogue for ProfileService and EngagementService.\n\n=== REST API Specifications\n\nComplete OpenAPI 3.0 specifications are maintained in the `specifications/rest/` directory:\n\n==== ProfileService API v1\n\n*Specification*: link:../../specifications/rest/profile-service-v1.yaml[profile-service-v1.yaml]\n\n*Base URL*: `https://api.otr.com.au/profile/v1`\n\n*Authentication*: Bearer token (Microsoft Entra External ID JWT)\n\n*Key Endpoints*:\n\n* `GET /contact-id` - Retrieve or create Salesforce Contact ID for authenticated user (Just-In-Time reconciliation)\n** Used by Mobile App before submitting feedback to EngagementService\n** Upserts Salesforce Contact record using email as external key\n** Returns 18-character Salesforce Contact ID with caching (15-minute TTL)\n** Performance SLA: p95 < 300ms (uncached), p95 < 50ms (cached)\n\n==== EngagementService API v1\n\n*Specification*: link:../../specifications/rest/engagement-service-v1.yaml[engagement-service-v1.yaml]\n\n*Base URL*: `https://api.otr.com.au/engagement/v1`\n\n*Authentication*: Bearer token (Microsoft Entra External ID JWT)\n\n*Key Endpoints*:\n\n* `POST /feedback` - Submit customer feedback for async Case creation in Salesforce\n** Accepts contactId, category, storeName, timeOfVisit, contactPhoneNumber, message\n** Returns 202 Accepted immediately (async Case creation in background)\n** Publishes `CustomerFeedbackSubmitted` event for analytics\n** Creates Salesforce Case via Anti-Corruption Layer with retry logic\n** Performance SLA: p95 < 200ms (feedback accepted, not Case creation)\n\n=== Domain Events (AsyncAPI)\n\nComplete CloudEvents 1.0 JSON Schema specifications are maintained in the `specifications/events/` directory:\n\n*Specification*: link:../../specifications/events/engagement-events.json[engagement-events.json]\n\n==== Event Catalogue\n\n[width=\"100%\",cols=\"30%,20%,50%\",options=\"header\",]\n|===\n|Event Type |Publisher |Consumers\n\n|`CustomerFeedbackSubmitted`\n|EngagementService\n|Future bounded contexts, analytics, sentiment analysis\n\n|`SupportCaseCreated`\n|EngagementService\n|Future bounded contexts, analytics\n\n|`SupportCaseUpdated`\n|EngagementService (via Salesforce webhook)\n|Future bounded contexts, analytics\n\n|`SupportCaseResolved`\n|EngagementService (via Salesforce webhook)\n|Future bounded contexts, analytics\n\n|===\n\n==== Event Delivery Guarantees\n\n* **At-least-once delivery**: Events may be delivered multiple times, consumers must handle idempotency\n* **Ordering**: FIFO queues guarantee ordering for events with same `contactId`\n* **Retention**: 4 days (96 hours) in Event Bus\n* **Dead Letter Queue**: Failed events after 5 retries moved to DLQ for manual intervention\n* **Format**: CloudEvents 1.0 specification with JSON payload\n\n=== API Versioning Policy\n\n==== Version Numbering\n\n* **Format**: `/v{major}` in URL path (e.g., `/profile/v1`, `/engagement/v1`)\n* **Semantic Versioning**: Major version incremented for breaking changes only\n* **Backwards Compatibility**: Minor changes (new optional fields, new endpoints) don't require version bump\n\n==== When to Version\n\n*Breaking changes requiring new major version*:\n\n- Removing or renaming fields in request/response\n- Changing field data types (e.g., string → number)\n- Changing authentication mechanism\n- Removing endpoints\n\n*Non-breaking changes not requiring version bump*:\n\n- Adding new optional fields to request/response\n- Adding new endpoints\n- Expanding enum values (e.g., adding new feedback category)\n- Improving error messages\n\n==== Parallel Version Support\n\n* Support N and N-1 versions concurrently for 6 months\n* Deprecation notice: 3 months before sunsetting old version\n* Mobile App must upgrade to new version within deprecation window\n\n<<<\n== Work Packages\n\nThis section consolidates gaps and activities into implementable work packages aligned with TOGAF Phase E requirements.\n\n=== Work Package Overview\n\n[width=\"100%\",cols=\"15%,35%,25%,25%\",options=\"header\",]\n|===\n|Work Package ID |Name |Transition State |Key Deliverables\n\n|WP-CS-001\n|ProfileService Development\n|TS-1 (Build & Test)\n|ProfileService microservice, Salesforce Contact integration, REST API\n\n|WP-CS-002\n|EngagementService Development\n|TS-1 (Build & Test)\n|EngagementService microservice, Anti-Corruption Layer, Braze integration\n\n|WP-CS-003\n|Event Bus Infrastructure\n|TS-1 (Build & Test)\n|Event Bus configuration, CloudEvents schemas, monitoring\n\n|WP-CS-004\n|Contact Migration Tooling\n|TS-1 (Build & Test)\n|Migration tool, validation scripts, reconciliation reporting\n\n|WP-CS-005\n|Mobile App Integration\n|TS-1 (Build & Test)\n|Mobile App API integration, feedback form enhancements, testing\n\n|WP-CS-006\n|Integration Testing\n|TS-1 (Build & Test)\n|Test environments, integration test suites, UAT execution\n\n|WP-CS-007\n|Salesforce Configuration\n|TS-1 (Build & Test)\n|Salesforce field mapping, data isolation, webhook configuration\n\n|WP-CS-008\n|Contact Data Migration\n|TS-2 (Contact Migration)\n|Contact migration execution, validation, reconciliation\n\n|WP-CS-009\n|Production Deployment\n|TS-3 (Cutover)\n|Production deployment, smoke testing, go-live execution\n\n|WP-CS-010\n|Post-Cutover Support\n|TS-4 (Target State)\n|Monitoring, issue resolution, D365 CE retirement\n\n|===\n\n[[wp-cs-001]]\n=== WP-CS-001: ProfileService Development\n\n==== Description\n\nBuild ProfileService bounded context microservice implementing Just-In-Time Contact reconciliation with Salesforce Service Cloud.\n\n==== Deliverables\n\n* ProfileService microservice application\n** REST API implementation (OpenAPI 3.0 specification)\n** `GET /contact-id` endpoint (Salesforce Contact reconciliation)\n** Authentication/authorization with Microsoft Entra External ID\n** Caching layer (15-minute TTL for Contact IDs)\n* Salesforce integration\n** Salesforce REST API client\n** Contact upsert by email (external key matching)\n** Error handling and retry logic\n* Unit tests (>80% code coverage)\n* Integration tests with Salesforce sandbox\n* API documentation\n* Deployment configuration (IaC - Infrastructure as Code)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* Salesforce sandbox environment provisioned\n* Microsoft Entra External ID OAuth configuration\n* Development environment setup (AWS dev account, CI/CD pipeline)\n\n*Dependent Work Packages*:\n\n* None (can start immediately after prerequisites met)\n\n==== Skills Required\n\n* Backend development (.NET Core or Node.js)\n* REST API design and implementation\n* Salesforce REST API integration\n* OAuth 2.0 / JWT authentication\n* Caching strategies (Redis/ElastiCache)\n* Unit/integration testing frameworks\n* Infrastructure as Code (Terraform/CloudFormation)\n\n==== Acceptance Criteria\n\n* All API endpoints return correct HTTP status codes per OpenAPI specification\n* Contact ID retrieval achieves p95 < 300ms (uncached), p95 < 50ms (cached)\n* Salesforce Contact upsert succeeds with 100% accuracy in sandbox testing\n* Unit test coverage > 80%\n* Integration tests pass in sandbox environment\n* API documentation generated from OpenAPI specification\n\n[[wp-cs-002]]\n=== WP-CS-002: EngagementService Development\n\n==== Description\n\nBuild EngagementService bounded context microservice implementing customer feedback submission, Anti-Corruption Layer for Salesforce Case creation, Braze integration, and webhook receiver for Case updates.\n\n==== Deliverables\n\n* EngagementService microservice application\n** REST API implementation (OpenAPI 3.0 specification)\n** `POST /feedback` endpoint (async feedback submission)\n** Authentication/authorization with Microsoft Entra External ID\n** Webhook receiver endpoint for Salesforce Case updates\n* Anti-Corruption Layer (ACL)\n** OTR domain model to Salesforce API translation\n** Category enum mapping (App/Service/Order/Rewards → Salesforce Case fields)\n** Salesforce REST API client for Case creation\n* Async processing infrastructure\n** Event Bus publisher integration\n** Background worker for Case creation\n** Retry logic with exponential backoff (5 attempts)\n** Dead Letter Queue integration\n* Braze integration\n** Braze campaign trigger API client\n** Push notification orchestration for Case updates\n* Domain event publishing\n** `CustomerFeedbackSubmitted` event publisher\n** `SupportCaseCreated` event publisher\n** `SupportCaseUpdated` event translator (Salesforce webhook → domain event)\n** `SupportCaseResolved` event translator (Salesforce webhook → domain event)\n* Unit tests (>80% code coverage)\n* Integration tests (EngagementService ↔ Salesforce, EngagementService ↔ Braze)\n* API documentation\n* Deployment configuration (IaC)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* <<wp-cs-003,WP-CS-003>> (Event Bus Infrastructure) completed\n* Salesforce sandbox environment provisioned\n* Braze API credentials and campaign templates configured\n* Microsoft Entra External ID OAuth configuration\n\n*Dependent Work Packages*:\n\n* <<wp-cs-003,WP-CS-003>> must be completed first (Event Bus required for async processing)\n* <<wp-cs-007,WP-CS-007>> (Salesforce Configuration) must be in progress (field mapping needed)\n\n==== Skills Required\n\n* Backend development (.NET Core or Node.js)\n* REST API design and implementation\n* Salesforce REST API integration\n* Event-driven architecture patterns\n* Async/background processing (queues, workers)\n* Braze API integration\n* Webhook design and security\n* OAuth 2.0 / JWT authentication\n* Domain-Driven Design (DDD) - Anti-Corruption Layer pattern\n* Unit/integration testing frameworks\n* Infrastructure as Code (Terraform/CloudFormation)\n\n==== Acceptance Criteria\n\n* Feedback submission endpoint returns 202 Accepted within p95 < 200ms\n* Async Case creation succeeds with >99.5% success rate (including retries)\n* Anti-Corruption Layer correctly maps all feedback categories to Salesforce Case fields\n* Webhook receiver processes Salesforce Case updates and publishes domain events\n* Braze push notifications sent successfully for Case updates\n* Failed Case creation moves to Dead Letter Queue after 5 retry attempts\n* Unit test coverage > 80%\n* Integration tests pass with Salesforce sandbox and Braze staging environment\n\n[[wp-cs-003]]\n=== WP-CS-003: Event Bus Infrastructure\n\n==== Description\n\nImplement Event Bus infrastructure for domain event publishing using existing AWS infrastructure (SNS+SQS, EventBridge, or Kinesis).\n\n==== Deliverables\n\n* Event Bus infrastructure configuration\n** Topic/stream provisioning (technology choice: SNS+SQS / EventBridge / Kinesis)\n** FIFO queue configuration (ordering by `contactId`)\n** Dead Letter Queue (DLQ) setup\n** Retention policy (4 days / 96 hours)\n** Access control policies (IAM roles, permissions)\n* CloudEvents 1.0 schema definitions\n** JSON Schema specifications for all domain events\n** Schema validation configuration\n** Schema registry (if using EventBridge/Kinesis)\n* Monitoring and alerting\n** CloudWatch dashboards for queue metrics\n** Alarms for DLQ depth, queue age, processing failures\n** Event Bus throughput monitoring\n* Documentation\n** Event Bus architecture diagram\n** Event publishing guidelines\n** Consumer integration guide\n* Infrastructure as Code (IaC)\n** Terraform/CloudFormation templates for all infrastructure\n\n==== Dependencies\n\n*Prerequisites*:\n\n* AWS account access (existing infrastructure)\n* Technology selection decision (SNS+SQS vs EventBridge vs Kinesis)\n* CloudEvents 1.0 schema design approval\n\n*Dependent Work Packages*:\n\n* None (foundational infrastructure, can start early)\n\n==== Skills Required\n\n* AWS messaging services (SNS, SQS, EventBridge, Kinesis)\n* Event-driven architecture patterns\n* CloudEvents specification\n* JSON Schema design\n* Infrastructure as Code (Terraform/CloudFormation)\n* AWS IAM security configuration\n* CloudWatch monitoring and alerting\n\n==== Acceptance Criteria\n\n* Event Bus infrastructure provisioned in all environments (dev, staging, production)\n* FIFO ordering validated for events with same `contactId`\n* Dead Letter Queue triggers alarms when messages arrive\n* Event retention policy enforced (4 days)\n* CloudEvents 1.0 schema validation enabled\n* Monitoring dashboards operational\n* Infrastructure fully codified (IaC)\n\n[[wp-cs-004]]\n=== WP-CS-004: Contact Migration Tooling\n\n==== Description\n\nDevelop Contact migration tool for one-time migration from app-specific database to Salesforce Service Cloud with upsert logic and validation.\n\n==== Deliverables\n\n* Contact migration tool\n** Extract Contacts from app-specific database\n** Transform to Salesforce Contact API format\n** Upsert to Salesforce using email as external key\n** Fallback matching by phone number or Viva Consumer ID\n** Batch processing with rate limiting (respect Salesforce API limits)\n** Idempotent operation (can be re-run safely)\n* Validation scripts\n** Pre-migration validation (data quality checks)\n** Post-migration validation (100% Contact reconciliation)\n** Email/phone/VCI matching accuracy report\n* Reconciliation reporting\n** Contacts created vs updated statistics\n** Failed upserts with error details\n** Matching accuracy metrics\n* Rollback capability\n** Export snapshot of Salesforce Contacts before migration\n** Rollback procedure documentation\n* Documentation\n** Migration tool user guide\n** Troubleshooting guide\n** Runbook for migration execution\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-001 (ProfileService Development) completed (reuses Salesforce integration code)\n* Salesforce sandbox environment for migration testing\n* App-specific database access (read-only sufficient)\n* Salesforce production access granted\n\n*Dependent Work Packages*:\n\n* WP-CS-001 provides Salesforce Contact upsert logic to reuse\n\n==== Skills Required\n\n* Database development (SQL, data extraction)\n* Salesforce REST API integration\n* Batch processing and ETL patterns\n* Data validation and reconciliation\n* Error handling and logging\n* Scripting (Python, PowerShell, or similar)\n\n==== Acceptance Criteria\n\n* Migration tool successfully migrates 100% of Contacts in sandbox with zero data loss\n* Email/phone/VCI matching accuracy > 95% in sandbox testing\n* Failed upserts captured with actionable error messages\n* Reconciliation report matches actual Salesforce Contact counts\n* Migration tool execution time acceptable for production (freezes app database for minimum time)\n* Rollback procedure validated in sandbox\n* Documentation complete and approved\n\n[[wp-cs-005]]\n=== WP-CS-005: Mobile App Integration\n\n==== Description\n\nUpdate Mobile App to integrate with ProfileService and EngagementService APIs, replacing D365 CE integration.\n\n==== Deliverables\n\n* Feedback form UI enhancements\n** Add Category dropdown (App, Service, Order, Rewards, Refund, Delete Account)\n** Add Store Name field (optional)\n** Add Time of Visit field (optional, datetime picker)\n** Add Contact Phone Number field (optional, E.164 validation)\n** Update Message field (1-2000 character limit with counter)\n* API integration (Kotlin Multiplatform shared code)\n** ProfileService client (`GET /contact-id`)\n** EngagementService client (`POST /feedback`)\n** JWT token management (Microsoft Entra External ID)\n** Error handling (network failures, API errors, validation errors)\n** Retry logic for transient failures\n* Platform-specific UI (SwiftUI for iOS, Jetpack Compose for Android)\n** Feedback form screens\n** Success/error confirmation screens\n** Loading states and progress indicators\n* Feature flag integration\n** `enable_salesforce_feedback_submission` flag\n** Fallback to D365 CE if flag disabled (during rollout)\n* Unit tests for shared business logic\n* UI tests for platform-specific screens\n* API integration tests (mocked APIs)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-001 (ProfileService Development) completed and deployed to dev/staging\n* WP-CS-002 (EngagementService Development) completed and deployed to dev/staging\n* ProfileService and EngagementService OpenAPI specifications finalized\n* Feature flag service configured\n\n*Dependent Work Packages*:\n\n* Must complete after WP-CS-001 and WP-CS-002 (requires API endpoints available for integration testing)\n\n==== Skills Required\n\n* Kotlin Multiplatform development\n* SwiftUI (iOS native UI)\n* Jetpack Compose (Android native UI)\n* REST API client development\n* OAuth 2.0 / JWT authentication\n* Form validation and UX design\n* Unit testing (Kotlin, Swift)\n* UI testing frameworks (XCTest, Espresso)\n\n==== Acceptance Criteria\n\n* Feedback form UI matches UX design specifications\n* All form fields validate correctly (client-side validation)\n* API integration successfully calls ProfileService and EngagementService in dev/staging\n* Error handling provides user-friendly error messages\n* Feature flag correctly toggles between Salesforce and D365 CE integration\n* Unit test coverage > 80% for shared business logic\n* UI tests pass for all feedback form workflows (happy path, error states)\n* App builds and deploys successfully to TestFlight (iOS) and Google Play Internal Testing (Android)\n\n[[wp-cs-006]]\n=== WP-CS-006: Integration Testing\n\n==== Description\n\nExecute comprehensive integration testing across all system components in non-production environments.\n\n==== Deliverables\n\n* Test environment setup\n** Salesforce sandbox configured with test data\n** ProfileService deployed to staging\n** EngagementService deployed to staging\n** Event Bus staging infrastructure\n** Braze staging environment configured\n** Mobile App TestFlight/Internal Testing builds\n* Integration test suites\n** ProfileService ↔ Salesforce (Contact upsert scenarios)\n** EngagementService ↔ Salesforce (Case creation scenarios)\n** EngagementService ↔ Braze (push notification scenarios)\n** Mobile App ↔ ProfileService ↔ EngagementService (end-to-end workflows)\n** Event Bus publishing and consumption\n** Webhook receiver (Salesforce → EngagementService)\n* Test scenarios\n** Happy path: Successful feedback submission and Case creation\n** Error scenarios: Salesforce API failures, Braze API failures, network timeouts\n** Retry scenarios: Async Case creation retries, DLQ validation\n** Performance testing: p95 latency validation for ProfileService and EngagementService\n** Load testing: Simulate 3x-10x expected volume\n* UAT execution\n** Business stakeholder UAT sessions\n** UAT test cases covering all feedback categories\n** UAT sign-off documentation\n* Test results documentation\n** Test execution reports\n** Defect tracking and resolution\n** Performance test results\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-001 (ProfileService Development) completed\n* WP-CS-002 (EngagementService Development) completed\n* WP-CS-003 (Event Bus Infrastructure) completed\n* WP-CS-005 (Mobile App Integration) completed\n* WP-CS-007 (Salesforce Configuration) sandbox configuration completed\n\n*Dependent Work Packages*:\n\n* Must complete after WP-CS-001, WP-CS-002, WP-CS-003, WP-CS-005 (requires all components available)\n\n==== Skills Required\n\n* Integration testing strategy and execution\n* Test automation frameworks (Postman, Newman, Selenium)\n* Performance testing tools (JMeter, k6, Gatling)\n* Salesforce sandbox administration\n* Test data management\n* Defect tracking and triage\n* UAT facilitation\n\n==== Acceptance Criteria\n\n* All integration test scenarios pass (happy path, error scenarios, retry scenarios)\n* Performance SLAs validated (ProfileService p95 < 300ms, EngagementService p95 < 200ms)\n* Load testing confirms system handles 3x expected volume without degradation\n* UAT sign-off obtained from business stakeholders\n* Zero critical defects (P1/P2) open before moving to Contact Migration\n* Test results documented and approved\n\n[[wp-cs-007]]\n=== WP-CS-007: Salesforce Configuration\n\n==== Description\n\nConfigure Salesforce Service Cloud for OTR digital customer support integration, including field mapping, data isolation, and webhook setup.\n\n==== Deliverables\n\n* Salesforce Contact configuration\n** Custom fields for OTR-specific data (if needed)\n** Email as external key configuration\n** Record Type for OTR digital customers (data isolation)\n** Validation rules\n* Salesforce Case configuration\n** Custom fields for feedback categories (App, Service, Order, Rewards, Refund, Delete Account)\n** Case Type and Reason picklist mapping\n** Queue assignment rules (OTR digital support queue)\n** Case escalation rules\n** Case routing rules\n* Salesforce webhook configuration\n** Platform Events / Outbound Messages for Case updates\n** Webhook authentication (API key, JWT, or OAuth)\n** Case status change triggers (New → In Progress, Resolved, Closed)\n** Webhook payload format (JSON)\n* Data isolation strategy\n** Record Types for OTR vs other Viva Energy business units\n** Queues for OTR-specific Cases\n** Reporting and dashboards scoped to OTR data\n* Salesforce API access\n** Connected App configuration\n** OAuth 2.0 JWT bearer flow setup\n** API user credentials\n** API rate limit monitoring\n* Documentation\n** Salesforce field mapping specification\n** Webhook configuration guide\n** Data isolation architecture diagram\n** API authentication setup guide\n\n==== Dependencies\n\n*Prerequisites*:\n\n* Viva Energy Salesforce admin team engagement\n* Salesforce governance approval (multi-tenant environment)\n* Technical decision on webhook mechanism (Platform Events vs Outbound Messages)\n* Technical decision on authentication method (OAuth 2.0 JWT bearer flow recommended)\n\n*Dependent Work Packages*:\n\n* None (can start in parallel with development work packages)\n* Required for WP-CS-002 (EngagementService needs field mapping)\n* Required for WP-CS-006 (Integration Testing needs sandbox configuration)\n\n==== Skills Required\n\n* Salesforce administration\n* Salesforce configuration (Record Types, Queues, Validation Rules)\n* Salesforce API integration (REST API, Platform Events, Outbound Messages)\n* Salesforce security and authentication (OAuth, Connected Apps)\n* Multi-tenant data isolation patterns\n\n==== Acceptance Criteria\n\n* Salesforce sandbox configured with all custom fields, Record Types, Queues\n* Field mapping documented and approved by OTR business stakeholders\n* Webhook configuration tested and delivering Case update notifications\n* Data isolation validated (OTR data separate from other Viva Energy business units)\n* API authentication working for ProfileService and EngagementService\n* Salesforce API rate limits monitored and acceptable for expected volume\n* Configuration replicated to Salesforce production environment\n\n[[wp-cs-008]]\n=== WP-CS-008: Contact Data Migration\n\n==== Description\n\nExecute one-time Contact migration from app-specific database to Salesforce Service Cloud production.\n\n==== Deliverables\n\n* Pre-migration activities\n** Final validation of migration tool in sandbox\n** Communication plan (notify users of maintenance window if needed)\n** Freeze app-specific database Contact updates\n** Backup app-specific database\n** Export snapshot of Salesforce Contacts (rollback preparation)\n* Migration execution\n** Execute migration tool against Salesforce production\n** Monitor migration progress\n** Handle failed upserts (manual intervention if needed)\n* Post-migration validation\n** 100% Contact reconciliation (app database vs Salesforce)\n** Email/phone/VCI matching accuracy report\n** Reconciliation report (Contacts created vs updated)\n** Data integrity checks (no duplicate Contacts, no missing Contacts)\n* ProfileService smoke testing\n** Verify Contact ID retrieval works in production\n** Test cache behavior\n** Validate Salesforce Contact upserts from ProfileService\n* Migration report\n** Total Contacts migrated\n** Contacts created vs updated\n** Failed upserts (if any) with resolution\n** Matching accuracy metrics\n** Migration execution time\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-004 (Contact Migration Tooling) completed\n* WP-CS-001 (ProfileService Development) deployed to production (not yet integrated with Mobile App)\n* WP-CS-007 (Salesforce Configuration) production configuration completed\n* Salesforce production access granted\n* Migration approved by business stakeholders\n\n*Dependent Work Packages*:\n\n* Must complete after WP-CS-001, WP-CS-004, WP-CS-007\n* Must complete before WP-CS-009 (Production Deployment)\n\n==== Skills Required\n\n* Data migration execution\n* Salesforce administration\n* Database operations\n* Data validation and reconciliation\n* Incident management (if issues arise)\n\n==== Acceptance Criteria\n\n* 100% of Contacts migrated with zero data loss\n* Email/phone/VCI matching accuracy > 95%\n* ProfileService smoke tests pass in production\n* Reconciliation report approved by business stakeholders\n* App-specific database Contact updates frozen (read-only mode)\n* Rollback procedure ready (but not executed if migration successful)\n\n[[wp-cs-009]]\n=== WP-CS-009: Production Deployment\n\n==== Description\n\nDeploy all solution components to production and execute cutover from D365 CE to Salesforce Service Cloud.\n\n==== Deliverables\n\n* Production deployment\n** EngagementService deployed to production\n** Event Bus production infrastructure validated\n** Salesforce webhook configured in production\n** Mobile App released to production (App Store, Google Play)\n* Go-live activities\n** Smoke testing (end-to-end feedback submission)\n** Feature flag enabled: `enable_salesforce_feedback_submission = ON`\n** D365 CE integration disabled in Mobile App\n** Monitor Event Bus queue depth, DLQ, Salesforce API rate limits\n** Monitor Mobile App feedback submission success rate\n* Go/No-Go decision\n** Validate success criteria before final cutover\n** Business stakeholder approval\n** Technical validation (smoke tests pass, monitoring healthy)\n* Cutover communication\n** Notify support agents of new Salesforce integration\n** Provide training materials for support agents\n** Customer communication (if visible change)\n* Rollback plan\n** Documented rollback procedure\n** Feature flag can disable Salesforce integration and re-enable D365 CE\n** Rollback decision criteria (P1/P2 incidents, feedback submission success rate < 99%)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-001 (ProfileService Development) completed\n* WP-CS-002 (EngagementService Development) completed\n* WP-CS-003 (Event Bus Infrastructure) completed\n* WP-CS-005 (Mobile App Integration) completed\n* WP-CS-006 (Integration Testing) completed with UAT sign-off\n* WP-CS-007 (Salesforce Configuration) production configuration completed\n* WP-CS-008 (Contact Data Migration) completed successfully\n* Mobile App release approval (App Store, Google Play)\n\n*Dependent Work Packages*:\n\n* Must complete after all prior work packages (final cutover)\n\n==== Skills Required\n\n* Production deployment and release management\n* Incident management and troubleshooting\n* Monitoring and observability\n* Change management and communication\n* Rollback execution (if needed)\n\n==== Acceptance Criteria\n\n* Mobile App feedback submission success rate > 99.5%\n* End-to-end flow validated (Mobile App → ProfileService → EngagementService → Salesforce Case created)\n* Braze push notifications delivered successfully\n* Event Bus queue depth normal, DLQ empty\n* No critical incidents (P1/P2) in first 24 hours\n* D365 CE integration disabled\n* Support agents successfully using Salesforce for OTR digital customer Cases\n\n[[wp-cs-010]]\n=== WP-CS-010: Post-Cutover Support\n\n==== Description\n\nMonitor production stability, resolve issues, validate success criteria, and execute D365 CE retirement.\n\n==== Deliverables\n\n* Monitoring and support\n** 24/7 on-call support for first week post-cutover\n** Daily monitoring reports (feedback submission success rate, Case creation success rate)\n** Incident response and resolution\n** Performance tuning (if needed)\n* Success criteria validation\n** Validate feedback submission success rate > 99.5%\n** Monitor customer satisfaction score (target: +15% improvement within 6 months)\n** Monitor average case resolution time (target: -20% improvement within 6 months)\n** Support agent feedback survey\n* D365 CE retirement\n** D365 CE set to read-only mode (historical Case lookups only)\n** Archive D365 CE data for compliance/auditing\n** Decommission D365 CE infrastructure (after 90-day stabilization period)\n** Remove D365 CE integration code from Mobile App\n* Documentation updates\n** Production runbook\n** Troubleshooting guide (based on incidents resolved)\n** Operational procedures for support team\n** Lessons learned document\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-009 (Production Deployment) completed\n* Cutover successful with no critical incidents\n\n*Dependent Work Packages*:\n\n* Final work package in sequence\n\n==== Skills Required\n\n* Production support and incident management\n* Performance monitoring and tuning\n* Data archival and compliance\n* Infrastructure decommissioning\n* Documentation\n\n==== Acceptance Criteria\n\n* Zero critical incidents (P1/P2) in first 30 days post-cutover\n* Feedback submission success rate sustained > 99.5%\n* Customer satisfaction improvement validated (baseline established, ongoing measurement)\n* Support agents reporting positive experience with Salesforce unified view\n* D365 CE successfully decommissioned\n* All production documentation complete and approved\n* Lessons learned document published\n\n=== Work Package Sequencing\n\n==== Parallel Track 1: Infrastructure & Configuration\n\nCan start immediately and run in parallel:\n\n* WP-CS-003 (Event Bus Infrastructure)\n* WP-CS-007 (Salesforce Configuration)\n\n==== Parallel Track 2: Development\n\nCan start after Track 1 infrastructure decisions made:\n\n* WP-CS-001 (ProfileService Development) - Independent\n* WP-CS-002 (EngagementService Development) - Requires WP-CS-003 completed\n* WP-CS-004 (Contact Migration Tooling) - Requires WP-CS-001 completed (reuses code)\n\n==== Sequential Track 3: Integration & Testing\n\nMust complete after development:\n\n* WP-CS-005 (Mobile App Integration) - Requires WP-CS-001, WP-CS-002\n* WP-CS-006 (Integration Testing) - Requires WP-CS-001, WP-CS-002, WP-CS-003, WP-CS-005, WP-CS-007\n\n==== Sequential Track 4: Migration & Cutover\n\nMust complete sequentially:\n\n* WP-CS-008 (Contact Data Migration) - Requires WP-CS-001, WP-CS-004, WP-CS-006 UAT sign-off\n* WP-CS-009 (Production Deployment) - Requires all prior work packages completed\n* WP-CS-010 (Post-Cutover Support) - Requires WP-CS-009\n\n==== Critical Path\n\nThe critical path for this project is:\n\n. WP-CS-003 (Event Bus Infrastructure)\n. WP-CS-002 (EngagementService Development) - blocks on WP-CS-003\n. WP-CS-005 (Mobile App Integration) - blocks on WP-CS-001, WP-CS-002\n. WP-CS-006 (Integration Testing) - blocks on WP-CS-001 through WP-CS-005, WP-CS-007\n. WP-CS-008 (Contact Data Migration) - blocks on WP-CS-006 UAT sign-off\n. WP-CS-009 (Production Deployment) - blocks on WP-CS-008\n. WP-CS-010 (Post-Cutover Support) - final deliverable\n\nAny delays in critical path work packages will delay the overall cutover date.\n\n<<<\n== Transition Architecture\n\nThis section defines the evolution from baseline (D365 CE) to target state (Salesforce Service Cloud + ProfileService + EngagementService).\n\n=== Transition Approach\n\n*Big Bang Cutover*: Per ADR-CS-006, this transition uses a single cutover approach rather than phased rollout. All users switch from D365 CE to Salesforce simultaneously after Contact migration completion.\n\n=== Transition States\n\n==== TS-0: Baseline State (Current)\n\n===== Characteristics\n\n* D365 Customer Engagement handles all digital customer feedback\n* App-specific database stores customer Contact data\n* No ProfileService or EngagementService\n* No event-driven architecture\n* Synchronous feedback submission\n\n===== Components Active\n\n- D365 Customer Engagement\n- App-specific customer database\n- Mobile App (current version with D365 CE integration)\n\n==== TS-1: Build & Test\n\n===== Activities\n\n* Build ProfileService microservice (JIT Contact reconciliation API)\n* Build EngagementService microservice (feedback submission API, ACL for Salesforce Case creation, Braze integration, webhook receiver)\n* Implement Event Bus infrastructure (SNS+SQS/EventBridge/Kinesis)\n* Develop Contact migration tool (app database → Salesforce upsert by email/phone/VCI)\n* Update Mobile App API integration (ProfileService + EngagementService endpoints - feedback form UI already complete)\n* Integration testing (ProfileService ↔ Salesforce, EngagementService ↔ Salesforce, EngagementService ↔ Braze)\n* UAT with test Salesforce sandbox environment\n\n===== Components Active\n\n- D365 Customer Engagement (still active, unchanged)\n- App-specific customer database (still active)\n- ProfileService (non-production, testing only)\n- EngagementService (non-production, testing only)\n- Event Bus (non-production)\n- Salesforce Sandbox (testing)\n\n===== Exit Criteria\n\n- All integration tests pass\n- UAT sign-off from business stakeholders\n- Contact migration tool validated in sandbox\n- Mobile App updates tested with non-production APIs\n\n==== TS-2: Contact Migration\n\n===== Activities\n* Execute Contact migration (app database → Salesforce production)\n* Validation: 100% data integrity check (email/phone/VCI matching)\n* Reconciliation report: New Contacts created vs existing Contacts updated\n* Freeze app database Contact updates during migration window\n* ProfileService smoke testing (verify Contact lookups work in Salesforce production)\n\n===== Components Active\n- D365 Customer Engagement (still active, users unaffected)\n- Salesforce Production (Contacts migrated, no Cases yet)\n- ProfileService (production deployed, not integrated with Mobile App yet)\n- App-specific customer database (frozen, read-only)\n\n===== Exit Criteria\n- 100% of Contacts migrated with zero data loss\n- Email/phone/VCI matching accuracy > 95%\n- ProfileService smoke tests pass (JIT lookups return correct Contact IDs)\n- Reconciliation report approved\n\n==== TS-3: Cutover (Go-Live)\n\n===== Go-Live Activities\n\n* Deploy EngagementService to production\n* Deploy Mobile App updates (ProfileService + EngagementService API integration)\n* Configure Salesforce webhook (Case update notifications → EngagementService)\n* Smoke testing: End-to-end feedback submission (Mobile App → EngagementService → Salesforce → Braze notification)\n* Monitor Event Bus queue depth, dead letter queue, Salesforce API rate limits\n* **Go/No-Go decision**: Validate success criteria before final cutover\n* Enable feature flag: `enable_salesforce_feedback_submission = ON`\n* Disable D365 CE integration in Mobile App\n\n===== Components Active\n\n- ProfileService (production, integrated with Mobile App)\n- EngagementService (production, integrated with Mobile App)\n- Event Bus (production, processing async Case creation)\n- Salesforce Production (receiving Cases from digital customers)\n- Braze (sending push notifications)\n- Mobile App (new version with Salesforce integration)\n- D365 Customer Engagement (disabled, read-only for historical lookups)\n\n===== Exit Criteria\n\n- Mobile App feedback submission success rate > 99.5%\n- End-to-end flow validated (Mobile App → Salesforce Case created)\n- Braze push notifications delivered successfully\n- Event Bus queue depth normal, DLQ empty\n- No critical incidents (P1/P2) in first 24 hours\n\n==== TS-4: Target State (Stable Production)\n\n===== Characteristics\n\n* ProfileService and EngagementService fully operational\n* All digital customer feedback routed to Salesforce\n* Event-driven architecture established\n* D365 CE decommissioned\n* First DDD bounded contexts implemented successfully\n\n===== Monitoring Period\n\n* Validate success criteria: feedback submission rate > 99.5%, no data loss\n* Monitor customer satisfaction score (target: +15% improvement)\n* Monitor average case resolution time (target: -20% improvement)\n* Support agents using unified Salesforce view across all channels\n\n===== D365 CE Retirement\n\n* D365 CE read-only access for historical Case lookups (if needed)\n* Decommission D365 CE infrastructure after 90 days\n* Archive D365 CE data for compliance/auditing\n\n===== Components Active\n\n- ProfileService (production)\n- EngagementService (production)\n- Event Bus (production)\n- Salesforce Production (system of record)\n- Braze (push notifications)\n- Mobile App (Salesforce integration)\n- App-specific database (deprecated, Contact data no longer updated)\n\n===== Success Criteria Achieved\n\n- All digital customer feedback routed to Salesforce\n- Support agents have unified customer view\n- D365 CE decommissioned\n- Customer satisfaction improved by 15%\n- Average case resolution time decreased by 20%\n- Zero data loss during transition\n\n=== Transition Dependencies\n\n[width=\"100%\",cols=\"40%,60%\",options=\"header\",]\n|===\n|Dependency |Owner/Status\n\n|*Salesforce production access*\n|Viva Energy Salesforce admin team - TBD\n\n|*Salesforce Case field mapping*\n|Viva Energy Salesforce admin team - TBD (map OTR feedback categories to Salesforce fields)\n\n|*Salesforce data isolation strategy*\n|Viva Energy Salesforce admin team - TBD (Record Types, queues, custom fields)\n\n|*Salesforce webhook configuration*\n|Viva Energy Salesforce admin team - TBD (Outbound Messages vs Platform Events)\n\n|*Event Bus infrastructure*\n|OTR Platform team - Existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis)\n\n|*Braze integration*\n|OTR Marketing team - Existing Braze account, EngagementService creates new campaigns\n\n|*Mobile App release window*\n|OTR Mobile team - Coordinate cutover timing with app release schedule\n\n|*App database access*\n|OTR Platform team - Read access for Contact migration\n\n|===\n\n=== Transition Validation Criteria\n\n==== Contact Migration Validation\n\n* 100% of app database Contacts migrated to Salesforce (zero data loss)\n* Email/phone/VCI matching accuracy > 95% (minimize duplicate Contacts)\n* ProfileService JIT lookups return correct Salesforce Contact IDs (smoke test sample)\n* Reconciliation report shows: X new Contacts created, Y existing Contacts updated\n\n==== Cutover Validation\n\n* Mobile App feedback submission success rate > 99.5% (including async Case creation)\n* End-to-end flow validated: Mobile App → ProfileService → EngagementService → Salesforce Case created\n* Braze push notifications delivered for Case creation and Case resolution\n* Event Bus queue depth within normal range (no backlog)\n* Dead letter queue empty (no failed Case creations)\n* Salesforce API rate limits not exceeded\n\n==== Production Monitoring (30 days)\n\n* Customer satisfaction score improves by 15% (compared to D365 CE baseline)\n* Average case resolution time decreases by 20% (Salesforce vs D365 CE)\n* Support agents confirm unified customer view across all channels\n* Zero critical incidents (P1 outages, data loss)\n\n=== Rollback Plan\n\n==== Rollback Triggers\n\n* Feedback submission success rate < 95% (below acceptable threshold)\n* Data loss or corruption detected in Salesforce\n* Salesforce API rate limits exceeded (Cases not created within SLA)\n* Critical bug blocking customer feedback submission\n\n==== Rollback Procedure\n\n1. **Revert Mobile App** to previous version (remove ProfileService/EngagementService integration, restore D365 CE integration)\n2. **Stop EngagementService** Case creation (prevent duplicate Cases in Salesforce)\n3. **Re-enable D365 CE** for customer feedback submission\n4. **Investigate root cause** (EngagementService logs, Salesforce API errors, Event Bus queue issues)\n5. **Fix and re-test** in sandbox environment\n6. **Retry cutover** when issues resolved\n\n==== Rollback Limitations\n\n* Cases created in Salesforce during cutover period remain in Salesforce (no reverse migration)\n* Contacts migrated to Salesforce remain (no rollback to app database)\n* Rollback only affects Mobile App integration (not data migration)\n\n=== Architectural Scope Boundaries\n\n==== Capabilities Included\n\n===== Business Capabilities\n\n* **Customer Feedback Submission**: Mobile App users can submit structured feedback (Category, Store Name, Time of Visit, Phone, Free Text Message) via EngagementService\n* **Customer Contact Management**: Just-In-Time (JIT) Contact reconciliation with Salesforce via ProfileService, ensuring every Mobile App user has a Salesforce Contact record\n* **Case Management Integration**: EngagementService creates Salesforce Cases asynchronously for customer feedback, support agents manage Cases in Salesforce Service Cloud\n* **Customer Notifications**: Push notifications via Braze when Cases are created, updated, or resolved (bidirectional integration: Mobile App → Salesforce → Mobile App)\n* **Unified Customer View**: Support agents see OTR digital customer feedback alongside other Viva Energy channels (fuel wholesale, Shell Card, retail) in single Salesforce instance\n* **Contact Data Migration**: One-time migration of app-specific customer database Contacts to Salesforce with upsert logic (email/phone/VCI matching)\n\n===== Technical Capabilities\n\n* **ProfileService Bounded Context**: First DDD bounded context implementation - JIT Contact reconciliation, Salesforce API facade, foundation for Flybuys integration\n* **EngagementService Bounded Context**: First DDD bounded context implementation - Customer feedback submission BFF, Anti-Corruption Layer for Salesforce, Braze integration orchestration\n* **Event-Driven Architecture**: Domain event publishing via Event Bus (SNS+SQS/EventBridge/Kinesis) for `SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted` events\n* **Async Processing Pattern**: Non-blocking Case creation with retry logic, exponential backoff, dead letter queue for operational resilience\n* **Anti-Corruption Layer Pattern**: EngagementService protects digital channels from Salesforce API changes, translates between OTR domain language and Salesforce\n* **Conformist Pattern**: ProfileService and EngagementService conform to existing Salesforce configuration (shared Viva Energy instance, multi-tenant governance)\n* **Salesforce Integration**: REST API integration for Contact CRUD and Case creation, webhook receiver for Case update notifications\n* **Braze Integration**: Push notification campaign triggers for Case lifecycle events (created, updated, resolved)\n* **Observability & Monitoring**: Dashboards, metrics, alerting for feedback submission rate, queue depth, API errors, Case creation latency\n* **Feature Flag Management**: Kill switches for emergency rollback (enable_salesforce_feedback_submission, enable_async_case_creation, etc.)\n\n==== Capabilities Excluded\n\n===== Business Capabilities Explicitly Out of Scope\n\n* **Historical Case Migration**: D365 CE Cases not migrated to Salesforce (ADR-CS-005 - fresh start, no Case migration)\n* **Multi-Channel Feedback Submission**: Web app, POS, call centre, email feedback channels not included (Mobile App only in this phase)\n* **Case Resolution by Digital Channels**: Support agents resolve Cases in Salesforce, not via Mobile App self-service\n* **Knowledge Base Integration**: Salesforce Knowledge Base articles not surfaced in Mobile App (future enhancement)\n* **Live Chat/Messaging**: Real-time chat support not included (Salesforce omnichannel capabilities not activated)\n* **Sentiment Analysis**: Automated feedback sentiment analysis not included (future enhancement with AI/ML)\n* **Customer Satisfaction Surveys**: Post-resolution CSAT surveys not included (separate initiative)\n* **Case Attachments**: Mobile App feedback submission does not support file uploads (photos, receipts) - text only\n* **Agent Desktop Integration**: Custom Salesforce UI for support agents not included (use standard Salesforce Service Console)\n* **Social Media Feedback**: Facebook, Twitter, Instagram feedback channels not integrated\n\n===== Technical Capabilities Explicitly Out of Scope\n\n* **Event Sourcing**: Domain events are ephemeral (not persisted for event sourcing/replay) - Event Bus only, no Event Store\n* **CQRS (Command Query Responsibility Segregation)**: ProfileService and EngagementService use same data model for reads/writes (no separate read models)\n* **Local Aggregate Persistence**: ProfileService and EngagementService are stateless (Salesforce is System of Record, no local database for Contact/Case)\n* **Saga Orchestration**: No distributed transactions or saga patterns required (single-step Case creation, not multi-step workflow)\n* **API Gateway Advanced Features**: Rate limiting, API versioning, API key management deferred to detailed design (basic routing only)\n* **GraphQL API**: ProfileService and EngagementService expose REST APIs only (GraphQL not required)\n* **Real-Time Sync**: Salesforce Contact updates by support agents not synced back to ProfileService (eventual consistency acceptable via JIT reconciliation)\n* **Multi-Region Deployment**: Single AWS region deployment (no multi-region failover/disaster recovery in this phase)\n* **Blue-Green Deployment**: Big bang cutover (ADR-CS-006), not blue-green or canary deployment strategy\n* **A/B Testing Framework**: Feature flags for rollback only, not for A/B testing or experimentation\n* **Custom Authentication**: Microsoft Entra External ID used for Mobile App authentication (no custom authentication logic in ProfileService/EngagementService)\n* **Data Residency Compliance**: Salesforce data residency governed by Viva Energy Salesforce configuration (no OTR-specific data residency requirements)\n\n===== Future Bounded Contexts Not in Scope\n\n* **LoyaltyService**: Flybuys integration, reward preferences, transaction adjudication (separate initiative)\n* **LocationService**: Store finder, proximity features, geofencing (separate initiative)\n* **PaymentService**: Payment processing, subscription billing (separate initiative)\n* **RecommendationService**: Personalized recommendations, next-best offers (separate initiative)\n\n===== Integration Patterns Not in Scope\n\n* **Shared Kernel**: No shared domain model between ProfileService and EngagementService (separate bounded contexts with clear boundaries)\n* **Partnership**: No joint development or coordination with external teams (Conformist pattern - we conform to Salesforce)\n* **Customer-Supplier (we're upstream)**: No downstream systems depend on ProfileService/EngagementService APIs yet (future bounded contexts will consume domain events)\n\n==== Architectural Dependencies on Future Initiatives\n\n*This Architecture Enables Future Initiatives*:\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Future Initiative |Architectural Enablement\n\n|*Flybuys Integration*\n|**ProfileService Contact Reconciliation Reused**: ProfileService establishes pattern for JIT Contact reconciliation with Salesforce, which will be extended for Flybuys partner linking (link:../architecture_definitions/flybuys_integration.adoc[see Flybuys Integration architecture]) +\n**Event Bus Infrastructure**: Domain event publishing pattern (`CustomerEnrolledInLoyalty`, `PartnerLinked`, etc.) reuses Event Bus established for EngagementService\n\n|*LoyaltyService Bounded Context*\n|**Event Bus Subscription**: LoyaltyService will consume `CustomerProfileCreated` events published by ProfileService (future enhancement) +\n**Salesforce Contact Integration**: LoyaltyService may query Salesforce Contacts for customer reward preferences (via ProfileService facade or direct Salesforce API)\n\n|*Web App Feedback Submission*\n|**EngagementService API Reuse**: Web app will call same EngagementService REST API for feedback submission (multi-channel support) +\n**Conformist Pattern**: Web app conforms to EngagementService API contract (no translation required)\n\n|*Multi-Channel Customer Support*\n|**EngagementService Extension**: Add support for email, call centre, POS feedback channels (extend EngagementService to handle multiple origins) +\n**Salesforce Case Origin Field**: Cases already tagged with Origin=Mobile App, extend to Origin=Web, POS, Call Centre, Email\n\n|*Knowledge Base Integration*\n|**EngagementService API Extension**: Add endpoint to query Salesforce Knowledge Base articles, surface in Mobile App for self-service support +\n**Anti-Corruption Layer**: EngagementService translates Salesforce Knowledge API to OTR domain language\n\n|*Customer Satisfaction Surveys*\n|**Event-Driven Trigger**: Subscribe to `SupportCaseResolved` events published by EngagementService, trigger CSAT survey via Braze +\n**Braze Integration Pattern**: Reuse EngagementService → Braze integration pattern for survey campaigns\n\n|*Sentiment Analysis*\n|**Event Subscription**: Subscribe to `CustomerFeedbackSubmitted` events, analyse feedback sentiment (AI/ML service) +\n**EngagementService Extension**: Enrich Case with sentiment score before creating in Salesforce\n\n|*RecommendationService Bounded Context*\n|**Event Subscription**: RecommendationService subscribes to `SupportCaseCreated` events to understand customer pain points and personalize recommendations +\n**Domain Event Pattern**: Reuse Event Bus publishing pattern established by EngagementService\n\n|===\n\n*This Architecture Depends on Future Initiatives*:\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Future Initiative |Dependency Description\n\n|*Salesforce Data Isolation Strategy*\n|**BLOCKER**: Viva Energy Salesforce admin team must define data isolation strategy (Record Types, custom fields, queues) before production deployment +\n**Impact**: Multi-tenant data visibility and security governance\n\n|*Salesforce Case Field Mapping*\n|**BLOCKER**: Viva Energy Salesforce admin team must define field mapping for OTR feedback categories (App, Service, Order, Rewards, Refund, Delete Account) +\n**Impact**: Case creation logic in EngagementService depends on finalized Salesforce schema\n\n|*Salesforce Webhook Mechanism*\n|**BLOCKER**: Viva Energy Salesforce admin team must configure webhook mechanism (Outbound Messages vs Platform Events vs Process Builder) for Case update notifications +\n**Impact**: EngagementService webhook receiver implementation depends on chosen mechanism\n\n|*Event Bus Technology Selection*\n|**DECISION REQUIRED**: Choose Event Bus implementation (SNS+SQS vs EventBridge vs Kinesis) for domain event publishing +\n**Impact**: Infrastructure provisioning, event schema design, consumer implementation\n\n|*Microservice Hosting Platform*\n|**DECISION REQUIRED**: Choose hosting platform for ProfileService and EngagementService (AWS Lambda vs ECS vs EKS) +\n**Impact**: Deployment architecture, auto-scaling strategy, operational overhead\n\n|*Observability Platform*\n|**DECISION REQUIRED**: Choose observability platform (AWS CloudWatch vs Datadog vs New Relic) for monitoring and alerting +\n**Impact**: Dashboard configuration, metric collection, alerting setup\n\n|===\n\n*Future Work After This Initiative*:\n\n* **Event Schema Registry**: Implement event schema versioning and registry for domain events (currently ad-hoc schemas)\n* **API Versioning Strategy**: Define API versioning approach for ProfileService and EngagementService (currently v1 only)\n* **Multi-Region Deployment**: Extend to multi-region for disaster recovery and global availability\n* **Event Store**: Persist domain events for event sourcing and audit trail (currently ephemeral Event Bus only)\n* **CQRS Pattern**: Separate read models for high-volume queries (currently same model for reads/writes)\n* **GraphQL API**: Expose GraphQL API for flexible client queries (currently REST only)\n* **Real-Time Sync**: Bi-directional sync between Salesforce and ProfileService for Contact updates (currently JIT reconciliation only)\n\n=== Technical Risks and Mitigation\n\n[width=\"100%\",cols=\"5%,20%,25%,25%,25%\",options=\"header\",]\n|===\n|ID |Risk |Impact |Likelihood |Mitigation\n\n|RISK-CS-001\n|*Salesforce API rate limits exceeded*: High feedback volume exceeds Salesforce API limits, Cases not created\n|HIGH (customers don't receive Case confirmation, support tickets lost)\n|MEDIUM (volume unknown, rate limits TBD)\n|• Gather expected feedback volume data before cutover +\n• Implement Event Bus queue throttling/rate limiting +\n• Monitor queue depth and API usage +\n• Scale background workers based on queue depth +\n• Alert ops team when approaching rate limits\n\n|RISK-CS-002\n|*Salesforce downtime*: Salesforce Service Cloud outage prevents Case creation\n|MEDIUM (Cases delayed but queued, customers wait for confirmation)\n|LOW (Salesforce SLA 99.9% uptime)\n|• Async Case creation with retry logic +\n• Event Bus queues buffer work during outage +\n• Customers get immediate \"Feedback submitted\" (not blocked) +\n• Monitor Salesforce status page, alert ops team +\n• Automatic retry when Salesforce recovers\n\n|RISK-CS-003\n|*Contact migration data quality issues*: App database Contact data incomplete or invalid\n|HIGH (migration fails validation, cutover delayed)\n|MEDIUM (legacy data quality unknown)\n|• Pre-migration data quality assessment +\n• Flexible upsert logic (match by email/phone/VCI) +\n• Validation report identifies data issues before production migration +\n• Manual cleanup for invalid records +\n• Dry-run migration in sandbox environment\n\n|RISK-CS-004\n|*Duplicate Contacts created*: Email matching fails, ProfileService creates duplicate Contacts\n|MEDIUM (support agents see multiple profiles for same customer)\n|MEDIUM (email changes, data quality issues)\n|• Salesforce duplicate detection rules (if available) +\n• ProfileService logs Contact creation for audit trail +\n• Manual duplicate cleanup process (support team) +\n• Future enhancement: VCI as Salesforce External ID for stable matching\n\n|RISK-CS-005\n|*Dead letter queue accumulation*: Failed Case creations not processed, queue grows\n|HIGH (customers don't receive Case confirmation, feedback lost)\n|LOW (retry logic handles most failures)\n|• Dead letter queue monitoring and alerting +\n• Ops team dashboard showing DLQ depth +\n• Manual intervention process (investigate and reprocess) +\n• Automated alerts when DLQ depth exceeds threshold +\n• Root cause analysis for recurring failures\n\n|RISK-CS-006\n|*Salesforce webhook failures*: Salesforce can't deliver Case update notifications to EngagementService\n|MEDIUM (customers don't get push notifications for Case resolution)\n|LOW (webhook mechanism reliable)\n|• Webhook retry logic and exponential backoff +\n• EngagementService logs webhook deliveries +\n• Monitor webhook delivery success rate +\n• Fallback: Poll Salesforce API for Case updates (if webhook fails persistently) +\n• Alert ops team when webhook delivery rate drops\n\n|RISK-CS-007\n|*Multi-tenant data isolation breach*: OTR digital Cases visible to other Viva Energy support teams\n|HIGH (privacy violation, compliance risk)\n|LOW (Salesforce governance controls)\n|• Work with Viva Energy Salesforce admin team on data isolation strategy +\n• Test data visibility in Salesforce sandbox (UAT with different user roles) +\n• Validate Record Types, queues, field-level security before production +\n• Audit Salesforce user permissions and sharing rules\n\n|RISK-CS-008\n|*Mobile App release coordination*: App release delayed, cutover window missed\n|MEDIUM (cutover delayed, D365 CE retirement delayed)\n|MEDIUM (release schedule conflicts)\n|• Coordinate cutover timing with Mobile team early +\n• Buffer time in migration plan (2-week contingency) +\n• Decouple backend deployment from Mobile App release (backend deployed first, app follows) +\n• Feature flag for feedback submission (enable when ready)\n\n|RISK-CS-009\n|*Event Bus infrastructure issues*: SNS/SQS/EventBridge downtime or misconfiguration\n|HIGH (Case creation blocked, domain events not published)\n|LOW (AWS SLA 99.99% uptime)\n|• Leverage existing AWS infrastructure (proven, reliable) +\n• Infrastructure as Code (IaC) for Event Bus configuration +\n• Integration testing in non-production environment +\n• Monitor Event Bus metrics (queue depth, throughput, errors) +\n• Alert ops team on Event Bus failures\n\n|RISK-CS-010\n|*Team DDD knowledge gap*: Team unfamiliar with DDD patterns, bounded contexts, event-driven architecture\n|MEDIUM (implementation delays, architectural inconsistencies)\n|HIGH (first DDD implementation)\n|• DDD training for development team (workshops, documentation) +\n• Architecture review sessions (validate bounded context design) +\n• Pair programming with experienced DDD practitioners +\n• Incremental implementation (start small, iterate) +\n• Document architectural patterns in CLAUDE.md\n\n|===\n\n== Assumptions and Constraints\n\n=== Assumptions\n\n[width=\"100%\",cols=\"8%,92%\",options=\"header\",]\n|===\n|ID |Assumption\n\n|ASM-CS-001\n|Viva Energy Salesforce admin team will provide Salesforce production access, sandbox environment, and support for Case field mapping and data isolation configuration\n\n|ASM-CS-002\n|App database Contact data is sufficiently complete for migration (email/phone/VCI available for matching)\n\n|ASM-CS-003\n|Expected customer feedback volume (100-150 submissions/day from 20k DAU) is well within Salesforce API rate limits, with capacity planning for 3x-10x growth\n\n|ASM-CS-004\n|Existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis) is sufficient for Event Bus implementation (no additional infrastructure provisioning required)\n\n|ASM-CS-005\n|Braze integration already exists and can be extended for Case-related push notifications (no new Braze account or major configuration changes)\n\n|ASM-CS-006\n|Mobile App users have email addresses associated with their accounts (required for ProfileService Contact reconciliation)\n\n|ASM-CS-007\n|D365 Customer Engagement historical Cases have limited business value and do not require migration to Salesforce\n\n|ASM-CS-008\n|Support agents are trained on Salesforce Service Cloud and require minimal additional training for OTR digital customer Cases\n\n|ASM-CS-009\n|Salesforce Service Cloud shared instance has capacity for OTR digital customer Contacts and Cases (no additional licensing or storage costs)\n\n|ASM-CS-010\n|Mobile App release schedule can accommodate cutover timing (Week 10 in migration plan)\n\n|===\n\n=== Constraints\n\n[width=\"100%\",cols=\"8%,92%\",options=\"header\",]\n|===\n|ID |Constraint\n\n|CON-CS-001\n|Must use shared Viva Energy Salesforce Service Cloud instance (cannot deploy separate OTR-specific instance)\n\n|CON-CS-002\n|Must conform to existing Salesforce configuration and governance (Record Types, custom fields, queues, data isolation strategy defined by Viva Energy admin team)\n\n|CON-CS-003\n|Contact migration must complete before Mobile App cutover (no parallel run of D365 CE and Salesforce)\n\n|CON-CS-004\n|Big bang cutover only (no phased rollout with feature flags or pilot users)\n\n|CON-CS-005\n|Salesforce API rate limits and authentication method constrained by Viva Energy Salesforce configuration (TBD)\n\n|CON-CS-006\n|Event Bus implementation must use existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis - cannot introduce new infrastructure components)\n\n|CON-CS-007\n|Mobile App feedback form must include specific fields: Category, Store Name, Time of Visit, Contact Phone Number, Free Text Message (no attachments)\n\n|CON-CS-008\n|D365 Customer Engagement must be decommissioned within 90 days post-cutover (ADR-CS-006)\n\n|CON-CS-009\n|ProfileService and EngagementService must be stateless (no local aggregate persistence, Salesforce is System of Record)\n\n|CON-CS-010\n|First DDD bounded context implementation (team learning curve, architectural patterns must be documented for future bounded contexts)\n\n|===\n\n== Non-Functional Requirements\n\n=== Performance Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-PERF-001\n|Mobile App feedback submission API response time (ProfileService + EngagementService)\n|p95 < 1 second, p99 < 2 seconds\n\n|NFR-PERF-002\n|ProfileService Contact reconciliation API response time (JIT lookup)\n|p95 < 500ms, p99 < 1 second\n\n|NFR-PERF-003\n|EngagementService async Case creation latency (end-to-end: feedback submitted → Case created in Salesforce)\n|p95 < 5 minutes, p99 < 10 minutes\n\n|NFR-PERF-004\n|Salesforce API call latency (Contact query, Contact create, Case create)\n|p95 < 2 seconds, p99 < 5 seconds\n\n|NFR-PERF-005\n|Event Bus message processing throughput\n|> 100 messages/second (support peak feedback volume)\n\n|NFR-PERF-006\n|Braze push notification delivery latency (Case created → notification delivered)\n|p95 < 30 seconds, p99 < 60 seconds\n\n|===\n\n=== Availability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-AVAIL-001\n|ProfileService availability\n|99.9% uptime (8.76 hours downtime/year)\n\n|NFR-AVAIL-002\n|EngagementService availability\n|99.9% uptime (8.76 hours downtime/year)\n\n|NFR-AVAIL-003\n|Feedback submission success rate (including async Case creation)\n|> 99.5% (includes retry logic for transient failures)\n\n|NFR-AVAIL-004\n|Graceful degradation: Salesforce downtime handling\n|Feedback submission still succeeds, Cases queued for async creation when Salesforce recovers\n\n|NFR-AVAIL-005\n|Graceful degradation: Braze downtime handling\n|Case creation proceeds, push notifications disabled temporarily (feature flag)\n\n|NFR-AVAIL-006\n|Planned maintenance window\n|< 4 hours/month, scheduled during low-traffic periods (2-6am ACST)\n\n|===\n\n=== Scalability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-SCALE-001\n|Concurrent Mobile App users (peak)\n|Support 20,000 DAU (Daily Active Users), ~150 concurrent users submitting feedback during peak hours\n\n|NFR-SCALE-002\n|Feedback submissions per day\n|Expected: 100-150 submissions/day based on 20k DAU (~0.5-0.75% submission rate) +\nCapacity: Support 500 submissions/day (3x expected volume for growth), 2,000 submissions/day (peak/incident scenarios)\n\n|NFR-SCALE-003\n|Auto-scaling: ProfileService and EngagementService\n|Auto-scale based on CPU/memory/request rate, scale up within 2 minutes\n\n|NFR-SCALE-004\n|Event Bus queue capacity\n|Support 100,000 queued messages (buffer for Salesforce downtime)\n\n|NFR-SCALE-005\n|Salesforce API rate limit compliance\n|Stay within 80% of Salesforce API rate limits (buffer for spikes)\n\n|NFR-SCALE-006\n|Future growth capacity\n|Architecture supports 10x growth (1,000-1,500 submissions/day based on 200k DAU) without major redesign\n\n|===\n\n=== Security Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-SEC-001\n|Mobile App authentication\n|Microsoft Entra External ID OAuth 2.0 with JWT tokens (existing CIAM)\n\n|NFR-SEC-002\n|API authorisation: ProfileService and EngagementService\n|JWT token validation, authenticated users only, user context propagation\n\n|NFR-SEC-003\n|Salesforce API authentication\n|OAuth 2.0 with Connected App and JWT bearer flow (service account)\n\n|NFR-SEC-004\n|Data encryption in transit\n|TLS 1.2+ for all API calls (Mobile App ↔ ProfileService/EngagementService ↔ Salesforce ↔ Braze)\n\n|NFR-SEC-005\n|Data encryption at rest\n|Salesforce encryption at rest (managed by Salesforce), Event Bus message encryption (AWS KMS)\n\n|NFR-SEC-006\n|Secret management\n|AWS Secrets Manager for Salesforce credentials, Braze API keys, OAuth tokens (no hardcoded secrets)\n\n|NFR-SEC-007\n|PII data handling\n|Contact data (email, phone, name) treated as PII, GDPR-compliant retention policies (Salesforce governance)\n\n|NFR-SEC-008\n|API rate limiting and throttling\n|API Gateway rate limiting (100 requests/second per user), prevent abuse and DoS\n\n|NFR-SEC-009\n|Logging and auditing\n|Log all API calls, Salesforce Contact/Case creates/updates, Event Bus publishes (no PII in logs)\n\n|NFR-SEC-010\n|Salesforce data isolation\n|Multi-tenant data isolation via Salesforce Record Types, queues, sharing rules (defined by Viva Energy admin team)\n\n|===\n\n=== Reliability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-REL-001\n|Retry logic: EngagementService → Salesforce Case creation\n|Exponential backoff (1s, 2s, 4s, 8s, 16s), max 5 retries, then dead letter queue\n\n|NFR-REL-002\n|Dead letter queue monitoring\n|Alert ops team immediately when DLQ depth > 0 (failed Case creations require manual intervention)\n\n|NFR-REL-003\n|Event Bus message durability\n|Messages persisted in Event Bus (SNS+SQS/EventBridge/Kinesis), not lost on service restart\n\n|NFR-REL-004\n|Idempotency: Case creation\n|EngagementService ensures duplicate feedback submissions don't create duplicate Cases (idempotency key)\n\n|NFR-REL-005\n|Circuit breaker: Salesforce API calls\n|Open circuit after 5 consecutive failures, half-open retry after 30 seconds\n\n|NFR-REL-006\n|Health checks: ProfileService and EngagementService\n|Health endpoints for load balancer checks, readiness and liveness probes\n\n|NFR-REL-007\n|Disaster recovery: Event Bus\n|Event Bus messages replicated across AWS availability zones (SQS/EventBridge/Kinesis HA)\n\n|===\n\n=== Maintainability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-MAINT-001\n|Code quality: ProfileService and EngagementService\n|> 80% test coverage (unit + integration tests), automated CI/CD pipeline\n\n|NFR-MAINT-002\n|API documentation\n|OpenAPI/Swagger specs for ProfileService and EngagementService, auto-generated API docs\n\n|NFR-MAINT-003\n|Deployment automation\n|Infrastructure as Code (Terraform/CloudFormation/CDK), zero-downtime deployments\n\n|NFR-MAINT-004\n|Logging: structured logs\n|JSON-formatted logs with correlation IDs, log levels (DEBUG, INFO, WARN, ERROR), centralized log aggregation\n\n|NFR-MAINT-005\n|Monitoring dashboards\n|Real-time dashboards for ProfileService, EngagementService, Event Bus (see Monitoring and Observability section)\n\n|NFR-MAINT-006\n|Alerting and on-call\n|PagerDuty/Opsgenie integration for P1/P2 alerts, on-call rotation for ops team\n\n|NFR-MAINT-007\n|Configuration management\n|Externalized configuration (environment variables, AWS Parameter Store), no hardcoded config\n\n|NFR-MAINT-008\n|Versioning: API and events\n|Semantic versioning (v1, v2), backward compatibility for API changes, event schema evolution\n\n|===\n\n=== Usability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-USE-001\n|Feedback submission UX\n|Mobile App user receives immediate \"Feedback submitted\" confirmation (< 1 second), not blocked by async Case creation\n\n|NFR-USE-002\n|Push notification delivery\n|Customer receives \"Your feedback has been received\" notification within 30 seconds of Case creation in Salesforce\n\n|NFR-USE-003\n|Case resolution notification\n|Customer receives \"Your case has been resolved\" notification within 30 seconds of support agent resolving Case\n\n|NFR-USE-004\n|Error messaging\n|User-friendly error messages for failed feedback submission (not technical errors), retry prompts\n\n|NFR-USE-005\n|Accessibility\n|Mobile App feedback form meets WCAG 2.1 AA accessibility standards (existing Mobile App compliance)\n\n|===\n\n=== Compliance Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-COMP-001\n|GDPR compliance: PII data\n|Customer Contact data (email, phone, name) managed per GDPR retention policies (Salesforce governance)\n\n|NFR-COMP-002\n|GDPR compliance: Right to erasure\n|Support \"Delete Account\" feedback category, trigger Contact deletion in Salesforce per GDPR Article 17\n\n|NFR-COMP-003\n|Data residency\n|Salesforce data residency governed by Viva Energy Salesforce configuration (regional compliance)\n\n|NFR-COMP-004\n|Audit trail\n|All Contact creates/updates, Case creates/updates logged for compliance auditing (Salesforce audit logs)\n\n|NFR-COMP-005\n|API security standards\n|OWASP API Security Top 10 compliance (injection prevention, authentication, authorisation, data exposure)\n\n|===\n\n== Monitoring and Observability\n\n=== Key Metrics\n\n[width=\"100%\",cols=\"25%,40%,35%\",options=\"header\",]\n|===\n|Metric Category |Metric |Target/Threshold\n\n|*Feedback Submission*\n|Feedback submission success rate (Mobile App → EngagementService)\n|> 99.5%\n\n|*Async Case Creation*\n|Case creation success rate (EngagementService → Salesforce)\n|> 99%\n\n|*Async Case Creation*\n|Case creation latency (time from feedback submission to Case created in Salesforce)\n|p95 < 5 minutes\n\n|*Event Bus*\n|Event Bus queue depth (pending Case creations)\n|< 100 messages\n\n|*Event Bus*\n|Dead letter queue depth (failed Case creations)\n|= 0 (alert on any failures)\n\n|*Salesforce API*\n|Salesforce API error rate\n|< 1%\n\n|*Salesforce API*\n|Salesforce API latency (Case creation)\n|p95 < 2 seconds\n\n|*Salesforce API*\n|Salesforce API rate limit utilization\n|< 80% of limit\n\n|*ProfileService*\n|Contact reconciliation success rate (JIT lookups)\n|> 99.5%\n\n|*ProfileService*\n|Contact reconciliation latency\n|p95 < 500ms\n\n|*Braze Notifications*\n|Push notification delivery rate (Case created/updated)\n|> 95%\n\n|*Salesforce Webhook*\n|Webhook delivery success rate (Salesforce → EngagementService)\n|> 99%\n\n|*Customer Satisfaction*\n|Customer satisfaction score (CSAT)\n|> 4.0/5.0 (improve by 15% from D365 CE baseline)\n\n|*Support Operations*\n|Average case resolution time\n|Decrease by 20% from D365 CE baseline\n\n|===\n\n=== Alerting Thresholds\n\n[width=\"100%\",cols=\"25%,50%,25%\",options=\"header\",]\n|===\n|Alert |Condition |Severity\n\n|*Feedback submission failures*\n|Feedback submission success rate < 95% over 5-minute window\n|P1 - Critical\n\n|*Dead letter queue accumulation*\n|Dead letter queue depth > 0 (any failed Case creations)\n|P2 - High\n\n|*Event Bus queue backlog*\n|Event Bus queue depth > 100 messages for > 15 minutes\n|P2 - High\n\n|*Salesforce API errors*\n|Salesforce API error rate > 5% over 5-minute window\n|P1 - Critical\n\n|*Salesforce API rate limits*\n|Salesforce API rate limit utilization > 90%\n|P2 - High\n\n|*Contact reconciliation failures*\n|ProfileService Contact reconciliation failure rate > 5% over 5-minute window\n|P2 - High\n\n|*Braze notification failures*\n|Braze push notification delivery rate < 80% over 15-minute window\n|P3 - Medium\n\n|*Salesforce webhook failures*\n|Salesforce webhook delivery success rate < 90% over 15-minute window\n|P2 - High\n\n|*Case creation latency*\n|Case creation latency p95 > 10 minutes\n|P3 - Medium\n\n|===\n\n=== Dashboards\n\n*ProfileService Dashboard:*\n\n* Contact reconciliation success rate (JIT lookups)\n* Contact reconciliation latency (p50, p95, p99)\n* Contact creation vs update ratio (new Contacts created vs existing Contacts updated)\n* Salesforce API error rate (Contact queries and creates)\n* Request rate and throughput\n\n*EngagementService Dashboard:*\n\n* Feedback submission success rate\n* Case creation success rate (async workflow)\n* Case creation latency (p50, p95, p99)\n* Event Bus queue depth (pending Case creations)\n* Dead letter queue depth (failed Case creations)\n* Salesforce API error rate (Case creation)\n* Salesforce API latency\n* Salesforce API rate limit utilization\n* Braze push notification delivery rate\n* Salesforce webhook delivery success rate\n\n*Event Bus Dashboard:*\n\n* Queue depth (pending messages)\n* Throughput (messages published/consumed per minute)\n* Dead letter queue depth (failed messages)\n* Consumer lag (time between publish and consume)\n\n*Customer Support Dashboard (Business Metrics):*\n\n* Total feedback submissions per day/week/month\n* Feedback category breakdown (App, Service, Order, Rewards, Refund, Delete Account)\n* Customer satisfaction score (CSAT) trend\n* Average case resolution time trend\n* Case volume by support team/queue\n* Unified customer view adoption (support agent feedback)\n<<<\n== Solution Validation\n\nThis section defines the validation criteria and testing approach for the solution.\n\n=== Functional Validation\n\n==== ProfileService API Testing\n\n*Test Scenarios*:\n1. **Happy Path**: Authenticated user requests Contact ID, existing Contact found in Salesforce, Contact ID returned\n2. **JIT Creation**: Authenticated user requests Contact ID, no existing Contact, new Contact created in Salesforce, Contact ID returned\n3. **Salesforce API Failure**: Salesforce unavailable, ProfileService returns 500 error, user retries\n4. **Invalid JWT**: Unauthenticated request, ProfileService returns 401 error\n\n*Acceptance Criteria*:\n- Contact reconciliation success rate > 99.5%\n- JIT Contact creation completes within 500ms (p95)\n\n==== EngagementService API Testing\n\n*Test Scenarios*:\n1. **Happy Path**: Valid feedback submission, immediate 202 Accepted response, Case created in Salesforce within 5 minutes, Braze notification delivered\n2. **Invalid Category**: Invalid feedback category, 400 Bad Request response with validation error\n3. **Salesforce Downtime**: Salesforce unavailable during async Case creation, message queued, retry logic executes, Case created when Salesforce recovers\n4. **Dead Letter Queue**: Case creation fails after 5 retries, message moved to DLQ, ops team alerted\n5. **Webhook Notification**: Support agent resolves Case in Salesforce, webhook triggers EngagementService, Braze push notification sent to customer\n\n*Acceptance Criteria*:\n- Feedback submission success rate > 99.5% (including async Case creation)\n- Async Case creation completes within 5 minutes (p95)\n- Webhook delivery success rate > 99%\n\n=== Non-Functional Validation\n\n==== Performance Testing\n\n*Load Testing*:\n\n*Baseline*: Expected 100-150 submissions/day from 20k DAU (~0.5-0.75% submission rate)\n\n- **Normal Load**: 1 submission/minute sustained for 2 hours (simulate typical daily pattern)\n- **3x Load**: 3 submissions/minute sustained for 1 hour (simulate busy period, 450 submissions/day)\n- **Peak Load (10x)**: 10 submissions/minute for 15 minutes (simulate incident scenario, app outage causing backlog)\n- **Stress Test**: 50 submissions/minute for 5 minutes (find breaking point, 20x normal)\n\n*Validation*:\n- API response time p95 < 1 second under 10x load\n- Event Bus queue depth remains manageable (< 100 messages)\n- No Case creation failures, all submissions processed successfully\n- Auto-scaling triggers appropriately for sustained load > 3x baseline\n\n*Acceptance Criteria*:\n- NFR-PERF-001 through NFR-PERF-006 validated under realistic load (3x and 10x baseline)\n- Auto-scaling triggers within 2 minutes of load increase\n- System handles 10x peak gracefully, 20x stress test identifies limits\n\n==== Resilience Testing\n\n*Salesforce API Failure Scenarios*:\n1. **Complete Outage**: Salesforce unavailable for 2 hours, Event Bus queues buffer work, Cases created when Salesforce recovers\n2. **Rate Limit Exceeded**: Salesforce rate limit hit, queue throttling activates, Cases created within SLA\n\n*Acceptance Criteria*:\n- NFR-AVAIL-004 validated (graceful degradation during Salesforce downtime)\n- Circuit breaker activates after 5 consecutive failures\n\n==== Security Validation\n\n*Penetration Testing*:\n- API authentication bypass attempts\n- SQL injection attempts\n- Webhook signature validation bypass\n\n*Acceptance Criteria*:\n- NFR-SEC-001 through NFR-SEC-010 validated\n- OWASP API Security Top 10 compliance verified\n\n=== Integration Validation\n\n==== End-to-End Testing\n\n*Full User Journey*:\n1. User authenticates via Microsoft Entra External ID\n2. Mobile App requests Contact ID from ProfileService (JIT reconciliation)\n3. User submits feedback via EngagementService\n4. Background worker creates Case in Salesforce\n5. Braze notification delivered to user\n6. Support agent resolves Case in Salesforce\n7. Salesforce webhook triggers EngagementService\n8. Braze notification delivered to user\n\n*Acceptance Criteria*:\n- End-to-end flow completes successfully in UAT\n- User receives both \"feedback submitted\" and \"case resolved\" notifications\n","structuredPatch":[{"oldStart":1759,"oldLines":14,"newStart":1759,"newLines":14,"lines":[" "," *Prerequisites*:"," ","-* WP-CS-001 (ProfileService Development) completed (reuses Salesforce integration code)","+* <<wp-cs-001,WP-CS-001>> (ProfileService Development) completed (reuses Salesforce integration code)"," * Salesforce sandbox environment for migration testing"," * App-specific database access (read-only sufficient)"," * Salesforce production access granted"," "," *Dependent Work Packages*:"," ","-* WP-CS-001 provides Salesforce Contact upsert logic to reuse","+* <<wp-cs-001,WP-CS-001>> provides Salesforce Contact upsert logic to reuse"," "," ==== Skills Required"," "]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"f58f12c3-48c5-40ea-bfd7-a847a55dbed2"}
{"parentUuid":"007591f8-8a23-42d8-b973-c6e663f8d425","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_0157ycPWBziMrhQAdmbLTxJH","type":"tool_result","content":"The file /mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n  1820→* API integration tests (mocked APIs)\n  1821→\n  1822→==== Dependencies\n  1823→\n  1824→*Prerequisites*:\n  1825→\n  1826→* <<wp-cs-001,WP-CS-001>> (ProfileService Development) completed and deployed to dev/staging\n  1827→* <<wp-cs-002,WP-CS-002>> (EngagementService Development) completed and deployed to dev/staging\n  1828→* ProfileService and EngagementService OpenAPI specifications finalized\n  1829→* Feature flag service configured\n  1830→\n  1831→*Dependent Work Packages*:\n  1832→\n  1833→* Must complete after <<wp-cs-001,WP-CS-001>> and <<wp-cs-002,WP-CS-002>> (requires API endpoints available for integration testing)\n  1834→\n  1835→==== Skills Required\n  1836→\n  1837→* Kotlin Multiplatform development"}]},"uuid":"d26147c8-5bbb-4074-a22f-bcdfee819ba2","timestamp":"2026-01-09T03:11:23.532Z","toolUseResult":{"filePath":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","oldString":"*Prerequisites*:\n\n* WP-CS-001 (ProfileService Development) completed and deployed to dev/staging\n* WP-CS-002 (EngagementService Development) completed and deployed to dev/staging\n* ProfileService and EngagementService OpenAPI specifications finalized\n* Feature flag service configured\n\n*Dependent Work Packages*:\n\n* Must complete after WP-CS-001 and WP-CS-002 (requires API endpoints available for integration testing)","newString":"*Prerequisites*:\n\n* <<wp-cs-001,WP-CS-001>> (ProfileService Development) completed and deployed to dev/staging\n* <<wp-cs-002,WP-CS-002>> (EngagementService Development) completed and deployed to dev/staging\n* ProfileService and EngagementService OpenAPI specifications finalized\n* Feature flag service configured\n\n*Dependent Work Packages*:\n\n* Must complete after <<wp-cs-001,WP-CS-001>> and <<wp-cs-002,WP-CS-002>> (requires API endpoints available for integration testing)","originalFile":"= Salesforce Customer Support - Solution Architecture\n:project-name: Salesforce Customer Support\n:togaf-adm-phase: Phase E: Opportunities & Solutions\n:last-updated: 2026-01-07\n:document-type: Solution Architecture Document\n:status: Discovery\n:version: 0.1\n:domain: Customer Support & Engagement\n:programme-lead:\n:domain-architect: O.Young@otr.com.au\n:architecture-definition: xref:architecture-definitions:salesforce_customer_support.adoc[Architecture Definitions/Salesforce Customer Support]\n:doctype: article\n:toc: left\n:toclevels: 4\n:sectanchors:\n:sectlinks:\n:sectnums:\n:icons: font\n:source-highlighter: highlightjs\n:experimental:\n:description:\n:keywords:\n\n<<<\n== Purpose and Scope\n\n=== Purpose\n\nThis Solution Architecture defines how the Salesforce Customer Support consolidation will be implemented - the specific technology products, configurations, interfaces, and deployment architecture that realise the xref:architecture-definitions:salesforce_customer_support.adoc[Salesforce Customer Support Architecture Definition].\n\nThis solution establishes the **first implementation of OTR's target Domain-Driven Design (DDD) architecture** by deploying two new bounded contexts (`ProfileService` and `EngagementService`) as microservices, consolidating customer support onto Salesforce Service Cloud, and implementing event-driven integration patterns that will serve as the foundation for future bounded contexts (including Flybuys integration).\n\n=== Vision\n\n> Unify customer support across all OTRG channels by consolidating OTR digital customer feedback onto Salesforce Service Cloud, establishing the foundational DDD architecture with ProfileService and EngagementService bounded contexts that protect digital channels from external system changes while enabling support agents to deliver exceptional customer experiences with complete interaction history.\n\n=== Architectural Approach\n\nThis architecture establishes OTR's **first bounded context implementation** using Domain-Driven Design strategic patterns:\n\n* *link:../bounded_context/profile.adoc[ProfileService]* (NEW bounded context): Just-In-Time Contact reconciliation with Salesforce, upsert by email, returns Salesforce Contact ID to digital channels - foundation for future Flybuys partner linking\n* *link:../bounded_context/engagement.adoc[EngagementService]* (NEW bounded context): Customer feedback submission facade, Anti-Corruption Layer for Salesforce Case creation, Braze integration for all outbound customer communications (push, email, SMS), async Case processing via Event Bus\n* *Event-driven integration* (NEW pattern): Domain event publishing using existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis) - first implementation establishing pattern for future bounded contexts\n* *Anti-Corruption Layer*: EngagementService isolates digital channels from Salesforce API changes, translates between OTR domain language and Salesforce Service Cloud API\n* *Conformist Pattern*: ProfileService and EngagementService conform to existing Salesforce configuration (shared Viva Energy instance, multi-tenant governance)\n* *Big bang cutover*: Single deployment after Contact migration, no phased rollout, D365 CE retirement post-cutover\n\n=== Scope\n\n==== In Scope\n\n* Solution Building Blocks (SBBs) - specific technology products and versions\n* Interface specifications (APIs, events, data formats)\n* Data architecture and schema specifications\n* Deployment architecture and infrastructure configuration\n* Transition architecture with migration phases\n* Technical validation criteria and testing approach\n* External system integration specifications\n* Physical data models and API schemas\n\n==== Out of Scope\n\n===== Covered in xref:architecture-definitions:salesforce_customer_support.adoc[Architecture Definition]\n\n* Business requirements and stakeholder analysis\n* Architecture decisions and rationale (ADRs)\n* Bounded context definitions and responsibilities\n* High-level integration patterns (ACL, Conformist, OHS+PL)\n* Business capability mapping and value streams\n* Architecture principles and governance\n\n===== Covered in Other Documents\n\n* Detailed design (class diagrams, sequence diagrams for all flows)\n* Implementation code and unit tests\n* Business case and return-on-investment analysis\n* Operational run books and support procedures\n\n<<<\n=== Architecture Overview\n\n[mermaid]\n----\n---\nconfig:\n  layout: elk\n---\nflowchart TB\n    Customer([\"Customer\"]) -- Uses --> MobileApp[\"Mobile App<br>iOS/Android\"]\n    Customer -- Shops at --> POS[\"OTR/OTR+ POS<br>D365 Commerce\"]\n    MobileApp -- Authenticate --> EntraID[\"Microsoft Entra\"]\n    MobileApp -- Identifies & Reconciles --> ProfileService[\"ProfileService\"]\n    ProfileService <-- Reconcile App User as Salesforce Contact --> Salesforce[\"Salesforce\"]\n    ProfileService -- On Create --> EventBus[\"EventBus\"]\n    EventBus -- Emits CreateUser Event --> LoyaltyService[\"LoyaltyService\"] & EngagementService[\"EngagementService\"]\n    LoyaltyService -- Reconcile Wallet --> EagleEye[\"EagleEye\"]\n    EngagementService -- Reconcile Braze Profile --> Braze[\"Braze\"]\n    EngagementService --> Salesforce\n    D365CE[\"D365CE\"] -- Data Migration --> Salesforce\n    MobileApp -- Submits Feedback --> EngagementService\n\n    Customer:::customer\n    MobileApp:::presentation\n    POS:::presentation\n    EntraID:::external\n    ProfileService:::newService\n    Salesforce:::external\n    EventBus:::infrastructure\n    LoyaltyService:::newService\n    EngagementService:::newService\n    EagleEye:::external\n    Braze:::external\n    D365CE:::external\n    classDef newService fill:#4CAF50,stroke:#2E7D32,stroke-width:3px,color:#fff\n    classDef external fill:#FF9800,stroke:#E65100,stroke-width:2px,color:#fff\n    classDef infrastructure fill:#2196F3,stroke:#0D47A1,stroke-width:2px,color:#fff\n    classDef presentation fill:#9C27B0,stroke:#4A148C,stroke-width:2px,color:#fff\n    classDef customer fill:#607D8B,stroke:#263238,stroke-width:2px,color:#fff\n----\n\n\n==== Key Architectural Patterns\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Pattern |Application |Rationale\n\n|*Anti-Corruption Layer (ACL)*\n|EngagementService → Salesforce Service Cloud\n|Protects digital channels (Mobile App, Web) from Salesforce API changes, translates between OTR domain language and Salesforce Case/Contact model, enables independent evolution of internal domain model\n\n|*Conformist*\n|ProfileService → Salesforce, EngagementService → Salesforce\n|Shared Viva Energy Salesforce instance - we conform to existing configuration, governance, and API contracts (external system we don't control)\n\n|*Backend-for-Frontend (BFF)*\n|EngagementService\n|Aggregates customer feedback submission, Contact lookup, async Case creation, and Braze notification orchestration for digital channel clients\n\n|*Event-Driven Architecture (OHS+PL)*\n|Event Bus (SNS+SQS/EventBridge/Kinesis)\n|Loose coupling between bounded contexts, async domain event publishing (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`), foundation for future bounded contexts\n\n|*Just-In-Time (JIT) Integration*\n|ProfileService → Salesforce Contact reconciliation\n|Reconcile app users as Salesforce Contacts on-demand (upsert by email), no pre-sync required, ensures Salesforce has current Contact data\n\n|*Async Processing*\n|EngagementService Case creation via Event Bus\n|Non-blocking user experience, resilience to Salesforce downtime, automatic retry with exponential backoff, dead letter queue for operations team intervention\n\n|*Strangler Fig*\n|Not applicable\n|Big bang cutover (no gradual migration) - D365 CE fully replaced, not incrementally strangled\n\n|===\n\n<<<\n== Solution Approach\n\n* Deploy xref:bounded-contexts:profile.adoc[ProfileService] and xref:bounded-contexts:engagement.adoc[EngagementService] as bounded context microservices\n* Implement Anti-Corruption Layers (ACLs) for Salesforce and Braze integration\n* Establish event-driven architecture as the foundational integration pattern\n* Big bang cutover (TS-1 → TS-4)\n\n=== Related Documentation\n\nThis solution architecture references detailed technical specifications:\n\n==== Architecture Definition\n\n* xref:architecture-definitions:salesforce_customer_support.adoc[Salesforce Customer Support - Architecture Definition] - Business requirements, architecture decisions (ADRs), bounded context definitions, high-level integration patterns\n\n==== Bounded Context Specifications\n\n* xref:bounded-contexts:profile.adoc[ProfileService Bounded Context] - JIT Contact reconciliation, aggregate definitions\n* xref:bounded-contexts:engagement.adoc[EngagementService Bounded Context] - Customer feedback facade, Anti-Corruption Layer\n\n==== Interface Specifications\n\nDetailed API specifications available in the specifications directory:\n\n* link:../../specifications/rest/profile-service-v1.yaml[ProfileService REST API v1] - OpenAPI 3.0 specification for `/profile/v1` endpoints (includes Salesforce Contact reconciliation `GET /contact-id`)\n* link:../../specifications/rest/engagement-service-v1.yaml[EngagementService REST API v1] - OpenAPI 3.0 specification for `/engagement/v1` endpoints (includes `POST /feedback`)\n* link:../../specifications/events/engagement-events.json[Engagement Domain Events] - CloudEvents 1.0 JSON Schema for `SupportCaseCreated`, `SupportCaseUpdated`, `SupportCaseResolved`, `CustomerFeedbackSubmitted`\n\n==== External System Documentation\n\n* https://developer.salesforce.com/docs/atlas.en-us.api_rest.meta/api_rest/[Salesforce REST API Documentation] - Contact and Case object APIs\n* https://www.braze.com/docs/api/endpoints/messaging/send_messages/post_send_triggered_campaigns/[Braze Campaign Trigger API] - Push notification campaigns\n\n<<<\n== Executive Summary\n\n=== Challenge\n\nOTR digital customers (Mobile App, Web) currently submit feedback and support requests to D365 Customer Engagement, while Viva Energy's broader business units (fuel wholesale, Shell Card customers, other retail channels) use Salesforce Service Cloud. This creates:\n\n* *Fragmented customer support platform*: Customer support data split across two systems, preventing support agents from having a unified view of customer interactions across all channels\n* *Operational inefficiency*: Maintaining two separate customer support platforms increases operational overhead and costs\n* *Poor support experience*: D365 CE is not working well for digital customer support, impacting customer satisfaction and case resolution times\n* *Post-merger consolidation opportunity*: Following Viva Energy's acquisition of OTR, strategic alignment on Salesforce as the enterprise customer support platform\n\n=== Solution\n\nThis architecture establishes the **foundational Domain-Driven Design (DDD) implementation** for OTR's target state architecture by introducing two new bounded contexts (link:../bounded_context/profile.adoc[ProfileService], link:../bounded_context/engagement.adoc[EngagementService]) and event-driven integration patterns:\n\n==== New Bounded Contexts\n\n* *link:../bounded_context/profile.adoc[ProfileService]* (NEW): Just-In-Time (JIT) Contact reconciliation with Salesforce, upsert by email, returns Salesforce Contact ID to Mobile App\n* *link:../bounded_context/engagement.adoc[EngagementService]* (NEW): Customer feedback submission, Anti-Corruption Layer (ACL) for Salesforce Case creation, Braze integration for all outbound customer communications (push, email, SMS), async Case processing via Event Bus\n* *Event Bus* (NEW pattern): Domain event publishing using existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis) - first implementation of event-driven architecture pattern\n\n==== Integration Architecture\n\n* *Salesforce = System of Record*: Salesforce Service Cloud (shared Viva Energy instance) owns Contact and Case data\n* *Conformist Pattern*: ProfileService and EngagementService conform to existing Salesforce configuration and API contracts\n* *Anti-Corruption Layer*: EngagementService protects digital channels from Salesforce API changes, translates between OTR domain language and Salesforce\n* *Async Case Creation*: Non-blocking user experience, resilience to Salesforce downtime, automatic retry with exponential backoff, dead letter queue for failed Cases\n* *Event-Driven Notifications*: Salesforce webhook → EngagementService → Braze for all customer communications (push, email, SMS) on Case status updates\n\n==== Migration Approach\n\n* *Contact Migration*: One-time migration from app-specific database → Salesforce (upsert with flexible matching by email/phone/VCI)\n* *No Case Migration*: Historical D365 CE Cases not migrated (fresh start in Salesforce)\n* *Big Bang Cutover*: Single deployment, no phased rollout or parallel run\n* *D365 CE Retirement*: Complete decommissioning of D365 Customer Engagement post-cutover\n\n=== Key Architectural Significance\n\nThis migration establishes the first implementation of OTR's target DDD architecture:\n\n* First bounded contexts implemented (ProfileService, EngagementService)\n* First event-driven domain event pattern (foundation for future bounded contexts)\n* Foundation for Flybuys integration (ProfileService Contact reconciliation reused)\n* Establishes integration patterns (Conformist, ACL, Event-Driven) for future services\n\n=== Success Criteria\n\n* All digital customer feedback routed to Salesforce Service Cloud within 30 days of launch\n* Support agents have unified customer view across all Viva Energy channels (digital, wholesale, Shell Card, other retail)\n* D365 Customer Engagement decommissioned within 90 days post-cutover\n* Customer satisfaction score improves by 15% within 6 months\n* Average case resolution time decreases by 20% within 6 months\n* Zero data loss during Contact migration (100% validation pass rate)\n* Mobile App feedback submission success rate > 99.5% (including async Case creation)\n\n=== Technical Constraints\n\n* Shared Salesforce instance (Viva Energy multi-tenant environment)\n* Conform to existing Salesforce configuration and governance (data isolation strategy TBD with Salesforce admin team)\n* Contact migration must complete before cutover (no parallel run)\n* Async Case creation mandatory (non-blocking user experience)\n* Expected volume: 100-150 feedback submissions/day from 20k DAU (~0.5-0.75% submission rate), architecture capacity planned for 3x-10x growth\n\n=== Open Technical Decisions (TBD)\n\n* Salesforce Case field mapping for digital feedback categories (App, Service, Order, Rewards, Refund, Delete Account)\n* Salesforce data isolation strategy (Record Types, custom fields, queues)\n* Salesforce REST API authentication method (OAuth 2.0, Connected App, JWT bearer flow)\n* Salesforce webhook mechanism for Case updates (Outbound Messages, Platform Events, Process Builder)\n* Retry policy configuration (attempts, backoff intervals)\n* Salesforce API rate limit strategy (expected volume: 100-150 submissions/day from 20k DAU, capacity planning for 3x-10x growth)\n\n== Technical Requirements\n\n[width=\"100%\",cols=\"8%,92%\",options=\"header\",]\n|===\n|ID |Description\n\n|TR-CS-001\n|Every Mobile App user must have a Salesforce Contact record in Salesforce Service Cloud (shared Viva Energy instance)\n\n|TR-CS-002\n|ProfileService must reconcile Mobile App users as Salesforce Contacts using Just-In-Time (JIT) upsert by email address\n\n|TR-CS-003\n|ProfileService must return Salesforce Contact ID to Mobile App for feedback submission\n\n|TR-CS-004\n|Mobile App must support customer feedback submission with fields: Category (App, Service, Order, Rewards, Refund, Delete Account), Store Name, Time of Visit, Contact Phone Number, Free Text Message\n\n|TR-CS-005\n|EngagementService must create Salesforce Cases asynchronously via Event Bus (non-blocking user experience)\n\n|TR-CS-006\n|EngagementService must acknowledge feedback submission immediately to Mobile App user (\"Feedback submitted\" confirmation)\n\n|TR-CS-007\n|EngagementService must send push notification to customer via Braze when Case is successfully created in Salesforce\n\n|TR-CS-008\n|EngagementService must retry failed Case creation with configurable exponential backoff and dead letter queue for operations team intervention\n\n|TR-CS-009\n|Salesforce must be the System of Record for Contact and Case data (no local persistence in ProfileService or EngagementService)\n\n|TR-CS-010\n|Contact migration from app-specific database to Salesforce must complete before Mobile App cutover (upsert with flexible matching by email/phone/VCI)\n\n|TR-CS-011\n|No Case migration from D365 Customer Engagement to Salesforce (fresh start, historical Cases not migrated)\n\n|TR-CS-012\n|EngagementService must publish domain events (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`) to Event Bus for consumption by other bounded contexts\n\n|TR-CS-013\n|EngagementService must receive Salesforce webhook notifications when Cases are updated/resolved by support agents\n\n|TR-CS-014\n|EngagementService must trigger Braze push notifications to customers when Cases are updated/resolved (via Salesforce webhook → EngagementService → Braze)\n\n|TR-CS-015\n|ProfileService and EngagementService must conform to existing Salesforce configuration and API contracts (Conformist pattern)\n\n|TR-CS-016\n|All changes must be communicated using event-driven architecture via Event Bus (using existing AWS infrastructure: SNS+SQS/EventBridge/Kinesis)\n\n|TR-CS-017\n|Mobile App feedback submission success rate must exceed 99.5% (including async Case creation completion)\n\n|TR-CS-018\n|Contact migration must achieve 100% validation pass rate (zero data loss)\n\n|TR-CS-019\n|D365 Customer Engagement must be fully decommissioned within 90 days post-cutover\n\n|===\n\n== Technical Architecture\n\n=== Technical Capability Requirements\n\n==== Requirements Traceability\n\n[width=\"100%\",cols=\"15%,50%,35%\",options=\"header\",]\n|===\n|Requirement ID |Requirement Summary |Architectural Building Blocks\n\n|TR-CS-001\n|Every Mobile App user must have Salesforce Contact record\n|ABB-CS-001 (ProfileService), ABB-CS-004 (Salesforce), ABB-CS-007 (Contact Migration Tool)\n\n|TR-CS-002\n|ProfileService JIT Contact reconciliation via upsert by email\n|ABB-CS-001 (ProfileService), ABB-CS-004 (Salesforce)\n\n|TR-CS-003\n|ProfileService returns Salesforce Contact ID to Mobile App\n|ABB-CS-001 (ProfileService), ABB-CS-006 (Mobile App)\n\n|TR-CS-004\n|Mobile App supports feedback submission with structured fields\n|ABB-CS-006 (Mobile App), ABB-CS-002 (EngagementService)\n\n|TR-CS-005\n|EngagementService creates Salesforce Cases asynchronously\n|ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus), ABB-CS-004 (Salesforce)\n\n|TR-CS-006\n|EngagementService immediate acknowledgment to Mobile App\n|ABB-CS-002 (EngagementService), ABB-CS-006 (Mobile App)\n\n|TR-CS-007\n|EngagementService sends push notification via Braze on Case creation\n|ABB-CS-002 (EngagementService), ABB-CS-005 (Braze)\n\n|TR-CS-008\n|EngagementService retry logic with exponential backoff and DLQ\n|ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus)\n\n|TR-CS-009\n|Salesforce is System of Record for Contact and Case data\n|ABB-CS-004 (Salesforce), ABB-CS-001 (ProfileService - stateless), ABB-CS-002 (EngagementService - stateless)\n\n|TR-CS-010\n|Contact migration before Mobile App cutover\n|ABB-CS-007 (Contact Migration Tool), ABB-CS-004 (Salesforce)\n\n|TR-CS-011\n|No Case migration from D365 CE (fresh start)\n|ABB-CS-004 (Salesforce) - no migration tooling required\n\n|TR-CS-012\n|EngagementService publishes domain events to Event Bus\n|ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus)\n\n|TR-CS-013\n|EngagementService receives Salesforce webhook notifications\n|ABB-CS-002 (EngagementService), ABB-CS-004 (Salesforce)\n\n|TR-CS-014\n|EngagementService triggers Braze notifications on Case updates\n|ABB-CS-002 (EngagementService), ABB-CS-004 (Salesforce), ABB-CS-005 (Braze)\n\n|TR-CS-015\n|ProfileService and EngagementService conform to Salesforce config\n|ABB-CS-001 (ProfileService), ABB-CS-002 (EngagementService), ABB-CS-004 (Salesforce)\n\n|TR-CS-016\n|Event-driven architecture via Event Bus\n|ABB-CS-003 (Event Bus), ABB-CS-002 (EngagementService)\n\n|TR-CS-017\n|Mobile App feedback submission success rate > 99.5%\n|ABB-CS-006 (Mobile App), ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus), ABB-CS-004 (Salesforce)\n\n|TR-CS-018\n|Contact migration 100% validation pass rate\n|ABB-CS-007 (Contact Migration Tool), ABB-CS-004 (Salesforce)\n\n|TR-CS-019\n|D365 CE decommissioned within 90 days post-cutover\n|All ABBs (replacement system operational)\n\n|===\n\n=== Service Catalogues\n\n==== Application Portfolio Catalogue\n\n[width=\"100%\",cols=\"20%,15%,15%,15%,35%\",options=\"header\",]\n|===\n|Application |Lifecycle State |Owner |Hosting Platform |Description\n\n|*ProfileService*\n|NEW\n|OTR Platform Team\n|AWS (TBD: Lambda/ECS/EKS)\n|JIT Contact reconciliation with Salesforce, returns Salesforce Contact ID, foundation for Flybuys integration\n\n|*EngagementService*\n|NEW\n|OTR Platform Team\n|AWS (TBD: Lambda/ECS/EKS)\n|Customer feedback submission facade, ACL for Salesforce Case creation, Braze integration for all outbound communications (push, email, SMS), webhook receiver\n\n|*Mobile App (iOS)*\n|ACTIVE (UPDATE)\n|OTR Mobile Team\n|Apple App Store\n|iOS native app with feedback form, integrate with ProfileService and EngagementService APIs\n\n|*Mobile App (Android)*\n|ACTIVE (UPDATE)\n|OTR Mobile Team\n|Google Play Store\n|Android native app with feedback form, integrate with ProfileService and EngagementService APIs\n\n|*Salesforce Service Cloud*\n|ACTIVE (EXPAND)\n|Viva Energy Salesforce Admin Team\n|Salesforce (SaaS)\n|Shared Viva Energy instance, System of Record for Contact and Case data, adding OTR digital customer support\n\n|*Braze*\n|ACTIVE (EXTEND)\n|OTR Marketing Team\n|Braze (SaaS)\n|Marketing automation platform, EngagementService triggers push notifications for Case updates\n\n|*D365 Customer Engagement*\n|RETIRE\n|OTR Support Team\n|Microsoft Azure (SaaS)\n|Legacy customer support platform, decommissioned within 90 days post-cutover\n\n|*App-Specific Customer Database*\n|RETIRE\n|OTR Platform Team\n|AWS (RDS/DynamoDB)\n|Legacy customer contact storage, one-time migration to Salesforce, then deprecated\n\n|*Event Bus*\n|NEW\n|OTR Platform Team\n|AWS (SNS+SQS/EventBridge/Kinesis)\n|Domain event publishing infrastructure for bounded context integration\n\n|*Contact Migration Tool*\n|TEMPORARY\n|OTR Platform Team\n|AWS (Script/Lambda)\n|One-time migration app database → Salesforce with upsert logic, retired after migration complete\n\n|===\n\n==== Technology Capability Requirements\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Technology Capability |Implementation Technology (TBD in detailed design) |Requirements\n\n|*Microservice Hosting*\n|AWS Lambda / ECS / EKS\n|Host ProfileService and EngagementService with auto-scaling, high availability, monitoring\n\n|*API Gateway*\n|AWS API Gateway / Application Load Balancer\n|REST API routing, authentication, rate limiting, request validation for ProfileService and EngagementService\n\n|*Event Bus*\n|AWS SNS+SQS / EventBridge / Kinesis\n|Domain event publishing, async message processing, retry logic, dead letter queue\n\n|*Salesforce Integration*\n|Salesforce REST API / SOAP API\n|Contact CRUD operations, Case creation, webhook notifications, OAuth 2.0 authentication\n\n|*Braze Integration*\n|Braze REST API / SDK\n|Push notification campaign triggers, customer profile reconciliation\n\n|*Authentication & Authorisation*\n|Microsoft Entra External ID / AWS Cognito\n|Mobile App user authentication, API authorisation, JWT token validation\n\n|*Observability & Monitoring*\n|AWS CloudWatch / Datadog / New Relic\n|Application metrics, logs, traces, dashboards, alerting (feedback submission rate, queue depth, API errors)\n\n|*Secret Management*\n|AWS Secrets Manager / Parameter Store\n|Salesforce credentials, Braze API keys, OAuth tokens, encryption keys\n\n|*Database (Migration Tool)*\n|AWS RDS / DynamoDB (read-only access)\n|Contact migration from app-specific database\n\n|*CI/CD Pipeline*\n|GitHub Actions / AWS CodePipeline\n|Automated build, test, deployment for ProfileService, EngagementService, Mobile App\n\n|*Infrastructure as Code*\n|Terraform / AWS CloudFormation / CDK\n|Declarative infrastructure provisioning for Event Bus, microservices, monitoring\n\n|*API Documentation*\n|OpenAPI / Swagger\n|ProfileService and EngagementService API specifications for Mobile App integration\n\n|===\n\n==== Feature Flag Register\n\n*Note*: Per ADR-CS-006 (big bang cutover, not phased rollout), feature flags are minimal and used primarily for emergency rollback/kill switches.\n\n[width=\"100%\",cols=\"20%,15%,35%,30%\",options=\"header\",]\n|===\n|Feature Flag |Default State |Purpose |Rollback Scenario\n\n|*enable_salesforce_feedback_submission*\n|OFF (pre-cutover), ON (post-cutover)\n|Enable/disable feedback submission to EngagementService → Salesforce (kill switch for emergency rollback to D365 CE)\n|Feedback submission success rate < 95%, Salesforce API failures, critical bugs - revert to D365 CE integration\n\n|*enable_async_case_creation*\n|ON\n|Enable/disable async Case creation via Event Bus (fallback to synchronous processing if Event Bus issues)\n|Event Bus infrastructure failures, queue backlog unmanageable - temporary synchronous processing\n\n|*enable_braze_notifications*\n|ON\n|Enable/disable Braze push notifications for Case updates (degrade gracefully if Braze integration fails)\n|Braze API failures, notification delivery rate < 80% - disable notifications temporarily\n\n|*enable_jit_contact_reconciliation*\n|ON\n|Enable/disable ProfileService JIT Contact reconciliation (fallback to cached Contact IDs if Salesforce unavailable)\n|Salesforce API downtime, Contact reconciliation failures > 5% - use cached Contact IDs temporarily\n\n|*enable_salesforce_webhook_processing*\n|ON\n|Enable/disable Salesforce webhook processing for Case updates (fallback to polling if webhook failures)\n|Webhook delivery failures, authentication issues - temporary polling fallback\n\n|===\n\n*Feature Flag Management*:\n\n* Feature flags managed via AWS AppConfig / LaunchDarkly / custom feature flag service (TBD in detailed design)\n* Mobile App feature flags controlled server-side (no app release required for flag changes)\n* Backend service feature flags configured via environment variables / configuration service\n* Feature flag changes logged and audited (who changed, when, reason)\n* Post-cutover monitoring: Gradual removal of feature flags once system stability confirmed (30-60 days)\n\n==== Data Entity Catalogue\n\n[width=\"100%\",cols=\"20%,15%,35%,30%\",options=\"header\",]\n|===\n|Data Entity |System of Record |Key Attributes |Lifecycle\n\n|*Contact*\n|Salesforce Service Cloud\n|• Contact ID (Salesforce 15/18-char ID) +\n• Email (primary matching key) +\n• First Name, Last Name +\n• Phone Number +\n• Viva Consumer ID (VCI) +\n• Account (Viva Energy customer account) +\n• Record Type (OTR Digital vs other channels)\n|Created: ProfileService JIT reconciliation or Contact Migration Tool +\nUpdated: ProfileService JIT upsert (email changes), Salesforce (manual updates by support agents) +\nDeleted: Salesforce retention policy (GDPR/compliance)\n\n|*Case*\n|Salesforce Service Cloud\n|• Case Number (Salesforce auto-generated) +\n• Contact ID (reference to Contact) +\n• Subject (derived from Category) +\n• Description (Free Text Message) +\n• Category (App, Service, Order, Rewards, Refund, Delete Account) +\n• Store Name (OTR location) +\n• Time of Visit +\n• Status (New, In Progress, Resolved, Closed) +\n• Priority, Origin (Mobile App) +\n• Owner (support agent/queue)\n|Created: EngagementService async Case creation +\nUpdated: Support agents (Salesforce UI), EngagementService (webhook processing) +\nDeleted: Salesforce retention policy (archive after X years)\n\n|*Feedback Submission (transient)*\n|None (not persisted)\n|• Salesforce Contact ID +\n• Category +\n• Store Name +\n• Time of Visit +\n• Contact Phone Number +\n• Free Text Message\n|Created: Mobile App user submission +\nProcessed: EngagementService publishes to Event Bus, Case created in Salesforce +\nNot persisted in ProfileService/EngagementService (stateless)\n\n|*Domain Events*\n|Event Bus (ephemeral)\n|**SupportCaseCreated**: +\n• Case Number, Contact ID, Category, Timestamp +\n**SupportCaseUpdated**: +\n• Case Number, Status, Updated By, Timestamp +\n**SupportCaseResolved**: +\n• Case Number, Resolution, Resolved By, Timestamp +\n**CustomerFeedbackSubmitted**: +\n• Contact ID, Category, Timestamp\n|Published: EngagementService +\nConsumed: Other bounded contexts (future), Braze notification triggers +\nRetention: Short-lived (minutes to hours), not persisted for event sourcing\n\n|*Braze Customer Profile*\n|Braze\n|• External User ID (VCI or Email) +\n• Push Notification Tokens (iOS/Android) +\n• Notification Preferences +\n• Campaign Engagement History\n|Created/Updated: EngagementService on Case creation/update +\nManaged: Braze (external SaaS)\n\n|===\n\n*Data Migration Entities*:\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Source Entity |Target Entity |Migration Strategy\n\n|*App Database Contact*\n|Salesforce Contact\n|One-time migration via Contact Migration Tool: +\n• Upsert by email (primary), phone (secondary), VCI (tertiary) +\n• Map: Email → Email, Name → First/Last Name, Phone → Phone, VCI → External ID +\n• Validation: 100% data integrity check, reconciliation report\n\n|*D365 CE Case*\n|Not migrated\n|ADR-CS-005: No Case migration (fresh start in Salesforce) +\nD365 CE Cases archived separately for compliance if needed\n\n|===\n\n==== Data Quality & Validation\n\n*Contact Migration Validation Rules*:\n\n* Email format validation (RFC 5322 compliance)\n* Phone number format validation (E.164 international format)\n* VCI format validation (alphanumeric, length constraints)\n* Duplicate detection: Flag potential duplicates for manual review (same email/phone combination)\n* Mandatory fields: Email (required), First Name, Last Name (required for Salesforce Contact)\n\n*Case Creation Validation Rules*:\n\n* Contact ID must exist in Salesforce (validated by EngagementService before Case creation)\n* Category must be one of: App, Service, Order, Rewards, Refund, Delete Account\n* Free Text Message maximum length: 32,000 characters (Salesforce Case Description limit)\n* Store Name validated against OTR location master data (optional - warn if not found)\n\n<<<\n== Solution Building Blocks\n\nThis section defines the specific technology products, configurations, and implementation details for each Solution Building Block (SBB).\n\n=== Technology Portfolio Catalogue\n\n[width=\"100%\",cols=\"10%,20%,25%,25%,20%\",options=\"header\",]\n|===\n|SBB ID |Component |Technology Product |Version/Configuration |Deployment Platform\n\n|SBB-CS-001\n|ProfileService Microservice\n|.NET 8 / Node.js 20 LTS\n|RESTful API, containerised\n|AWS ECS Fargate / Lambda\n\n|SBB-CS-002\n|EngagementService Microservice\n|.NET 8 / Node.js 20 LTS\n|RESTful API, containerised, async workers\n|AWS ECS Fargate / Lambda\n\n|SBB-CS-003\n|Event Bus\n|AWS SNS + SQS / EventBridge\n|Standard queues, FIFO for ordering\n|AWS (managed service)\n\n|SBB-CS-004\n|API Gateway\n|AWS API Gateway / ALB\n|REST API, JWT validation\n|AWS (managed service)\n\n|SBB-CS-005\n|Salesforce Integration Layer\n|Salesforce REST API Client\n|OAuth 2.0 JWT bearer flow\n|Embedded in SBB-CS-001/002\n\n|SBB-CS-006\n|Braze Integration Layer\n|Braze REST API SDK\n|API key authentication\n|Embedded in SBB-CS-002\n\n|SBB-CS-007\n|Contact Migration Tool\n|Python 3.11 / .NET 8\n|One-time batch script\n|AWS Lambda / EC2\n\n|SBB-CS-008\n|Application Monitoring\n|AWS CloudWatch / Datadog\n|Metrics, logs, traces, dashboards\n|AWS / SaaS\n\n|SBB-CS-009\n|Secret Management\n|AWS Secrets Manager\n|KMS encryption\n|AWS (managed service)\n\n|SBB-CS-010\n|Mobile App (iOS)\n|SwiftUI, Kotlin Multiplatform\n|iOS 15+\n|Apple App Store\n\n|SBB-CS-011\n|Mobile App (Android)\n|Jetpack Compose, Kotlin Multiplatform\n|Android 8+\n|Google Play Store\n\n|SBB-CS-012\n|Feature Flag Service\n|AWS AppConfig / LaunchDarkly\n|Server-side flags, real-time updates\n|AWS / SaaS\n\n|===\n\n<<<\n== Data Architecture\n\nThis section defines the physical data models, event schemas, and API request/response formats.\n\n=== Domain Event Schemas\n\nAll domain events follow the https://cloudevents.io/[CloudEvents 1.0] specification for consistency and interoperability.\n\n*Event Schema Specifications*: See // TODO: Add to Antora - specifications/events/engagement-events.json[Engagement Service Event Schemas] for complete JSON schemas and examples.\n\n==== Event Catalogue\n\n[width=\"100%\",cols=\"30%,20%,50%\",options=\"header\",]\n|===\n|Event Type |Publisher |Description\n\n|`SupportCaseCreated`\n|EngagementService\n|Published when EngagementService successfully creates a Case in Salesforce after async processing\n\n|`SupportCaseUpdated`\n|EngagementService (via Salesforce webhook)\n|Published when a support agent updates a Case in Salesforce (status, priority, comment changes)\n\n|`SupportCaseResolved`\n|EngagementService (via Salesforce webhook)\n|Published when a support agent resolves/closes a Case in Salesforce\n\n|`CustomerFeedbackSubmitted`\n|EngagementService\n|Published when customer submits feedback via Mobile App (before async Case creation)\n\n|===\n\n*Event Format*: All events use CloudEvents 1.0 envelope with event-specific payload in the `data` field.\n\n*Schema Location*: `specifications/events/engagement-events.json`\n\n=== API Request/Response Schemas\n\n==== ProfileService: GET /profile/contact-id\n\n*Response* (200 OK):\n[source,json]\n----\n{\n  \"contactId\": \"0034X00000ABCDEFG\",\n  \"email\": \"customer@example.com\",\n  \"firstName\": \"John\",\n  \"lastName\": \"Smith\"\n}\n----\n\n==== EngagementService: POST /feedback\n\n*Request*:\n[source,json]\n----\n{\n  \"contactId\": \"0034X00000ABCDEFG\",\n  \"category\": \"App\",\n  \"storeName\": \"OTR Adelaide\",\n  \"timeOfVisit\": \"2026-01-07T12:00:00Z\",\n  \"contactPhoneNumber\": \"+61412345678\",\n  \"message\": \"App crashed when submitting feedback\"\n}\n----\n\n*Response* (202 Accepted):\n[source,json]\n----\n{\n  \"feedbackId\": \"fb-2026-01-07-12345\",\n  \"status\": \"submitted\",\n  \"message\": \"Your feedback has been submitted!\"\n}\n----\n\n=== Salesforce Field Mappings\n\n==== Case Object Mapping\n\n[width=\"100%\",cols=\"25%,25%,25%,25%\",options=\"header\",]\n|===\n|OTR Field |Salesforce Field |Data Type |Notes\n\n|Category\n|Feedback_Category__c\n|Picklist\n|App, Service, Order, Rewards, Refund, Delete Account\n\n|Store Name\n|Store_Name__c\n|String (255)\n|OTR location name\n\n|Time of Visit\n|Time_of_Visit__c\n|DateTime\n|When customer visited store\n\n|Free Text Message\n|Description\n|Long Text (32,000)\n|Customer feedback message\n\n|===\n\n<<<\n=== Baseline Architecture\n\n==== Existing System Components\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Component |Current State |Status\n\n|*D365 Customer Engagement*\n|Customer support platform for OTR digital customers (Mobile App, Web), handles feedback submission and case management\n|**DEPRECATED** - Being replaced by Salesforce Service Cloud\n\n|*App-Specific Customer Database*\n|Stores customer contact data for Mobile App users, separate from Viva Energy systems\n|**MIGRATING** - One-time migration to Salesforce, then deprecated\n\n|*Mobile App*\n|iOS/Android native apps with feedback submission form including Category, Store Name, Time of Visit, Contact Phone Number, and Free Text Message fields\n|**REQUIRES UPDATE** - Integrate with ProfileService and EngagementService APIs (feedback form UI already complete)\n\n|*Salesforce Service Cloud*\n|Shared Viva Energy instance handling customer support for fuel wholesale, Shell Card customers, other retail channels\n|**EXPANDING** - Adding OTR digital customer support Cases and Contacts\n\n|*Existing AWS Infrastructure*\n|SNS+SQS / EventBridge / Kinesis available for event-driven architecture\n|**REUSING** - Event Bus implementation leverages existing infrastructure\n\n|===\n\n==== Integration Architecture\n\n*Current state:*\n\n* Mobile App → D365 Customer Engagement (direct integration)\n* App-specific customer database → standalone (no Salesforce integration)\n* No event-driven architecture (synchronous, tightly coupled)\n* No Anti-Corruption Layer protecting digital channels\n* Viva Energy support teams use Salesforce, OTR digital support uses D365 CE (fragmented)\n\n==== Technical Debt\n\n*No longer relevant* - D365 CE being deprecated, not documenting technical debt of system being retired.\n\n*New technical debt introduced by this migration:*\n\n* Salesforce field mapping TBD (requires coordination with Viva Energy Salesforce admin team)\n* Data isolation strategy TBD (Record Types, custom fields, queues - multi-tenant governance)\n* Salesforce webhook mechanism TBD (Outbound Messages vs Platform Events vs Process Builder)\n* Expected feedback volume unknown (gathering data for rate limit planning)\n\n=== Gap Analysis\n\n==== Missing Capabilities\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Missing Capability |Description\n\n|*ProfileService bounded context*\n|No existing service for Contact reconciliation with Salesforce - requires new microservice implementing JIT upsert by email, returning Salesforce Contact ID\n\n|*EngagementService bounded context*\n|No existing service for customer feedback facade - requires new microservice implementing Anti-Corruption Layer for Salesforce Case creation, Braze integration, async processing via Event Bus\n\n|*Event Bus domain event pattern*\n|No existing domain event publishing infrastructure - requires implementing event-driven architecture pattern using existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis)\n\n|*Async Case creation workflow*\n|Current D365 CE integration is synchronous - requires implementing async processing with retry logic, exponential backoff, dead letter queue\n\n|*Salesforce webhook integration*\n|No existing capability to receive Salesforce notifications - requires implementing webhook receiver in EngagementService for Case update notifications\n\n|*Braze push notification orchestration*\n|No existing integration for Case-related push notifications - requires implementing Braze campaign triggers from EngagementService\n\n|*Contact migration tooling*\n|No existing tooling for app database → Salesforce Contact migration with upsert logic (match by email/phone/VCI)\n\n|*Feedback form enhancements*\n|Mobile App feedback form lacks structured fields (Category, Store Name, Time of Visit, Contact Phone Number) - requires UI updates\n\n|===\n\n==== Missing Bounded Contexts\n\n[width=\"100%\",cols=\"30%,30%,40%\",options=\"header\",]\n|===\n|Bounded Context |Responsibilities |Implementation Status\n\n|*link:../bounded_context/profile.adoc[ProfileService]*\n|JIT Contact reconciliation with Salesforce (upsert by email), return Salesforce Contact ID to digital channels, foundation for future Flybuys partner linking\n|**NEW** - First bounded context implementation\n\n|*link:../bounded_context/engagement.adoc[EngagementService]*\n|Customer feedback submission facade, Anti-Corruption Layer for Salesforce Case creation, Braze integration for push notifications, async Case processing, webhook receiver for Case updates\n|**NEW** - First bounded context implementation\n\n|===\n\n==== Missing Integration Patterns\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Integration Pattern |Description\n\n|*Anti-Corruption Layer (ACL)*\n|EngagementService → Salesforce Service Cloud - protects digital channels from Salesforce API changes, translates between OTR domain language and Salesforce\n\n|*Conformist*\n|ProfileService/EngagementService → Salesforce - conform to existing Salesforce configuration and API contracts (shared Viva Energy instance)\n\n|*Event-Driven Architecture (OHS+PL)*\n|Event Bus publishing domain events (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`) for loose coupling between bounded contexts\n\n|*Just-In-Time (JIT) Integration*\n|ProfileService → Salesforce Contact reconciliation on-demand (no pre-sync)\n\n|*Async Processing*\n|EngagementService Case creation via Event Bus with retry, exponential backoff, dead letter queue\n\n|===\n\n=== Target State Architecture\n\n==== Architectural Building Blocks (ABB)\n\n[width=\"100%\",cols=\"20%,25%,30%,25%\",options=\"header\",]\n|===\n|ABB ID |Bounded Context |Responsibilities |Technology (TBD in Solution Architecture)\n\n|ABB-CS-001\n|*link:../bounded_context/profile.adoc[ProfileService]*\n|JIT Contact reconciliation with Salesforce (upsert by email), return Salesforce Contact ID, foundation for Flybuys partner linking\n|Microservice (.NET/Node.js), REST API, Salesforce REST API client\n\n|ABB-CS-002\n|*link:../bounded_context/engagement.adoc[EngagementService]*\n|Customer feedback submission facade, ACL for Salesforce Case creation, Braze integration, async processing, webhook receiver\n|Microservice (.NET/Node.js), REST API, Event Bus publisher/subscriber, Salesforce webhook receiver\n\n|ABB-CS-003\n|*Event Bus*\n|Domain event publishing infrastructure (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`)\n|AWS SNS+SQS / EventBridge / Kinesis\n\n|ABB-CS-004\n|*Salesforce Service Cloud*\n|System of Record for Contact and Case data (shared Viva Energy instance)\n|Salesforce Service Cloud (external SaaS)\n\n|ABB-CS-005\n|*Braze*\n|Marketing automation platform for push notifications\n|Braze (external SaaS) - existing integration\n\n|ABB-CS-006\n|*Mobile App*\n|iOS/Android native apps with enhanced feedback form (Category, Store Name, Time of Visit, Contact Phone Number, Free Text Message)\n|Kotlin Multiplatform, SwiftUI, Jetpack Compose\n\n|ABB-CS-007\n|*Contact Migration Tool*\n|One-time migration app database → Salesforce with upsert logic (match by email/phone/VCI)\n|Script/tool (.NET/Python/Node.js)\n\n|===\n\n==== Integration Architecture\n\n===== Integration Flows\n\n*Customer Feedback Submission (Async):*\n\n1. *Mobile App* → ProfileService: Authenticate user, get Salesforce Contact ID (JIT reconciliation)\n2. *Mobile App* → EngagementService: Submit feedback (POST /feedback with Contact ID, Category, Store Name, Time of Visit, Phone, Message)\n3. *EngagementService* → Mobile App: Immediate acknowledgment (\"Feedback submitted\")\n4. *EngagementService* → Event Bus: Publish work item for async Case creation\n5. *Background Worker* (EngagementService) → Salesforce: Create Case via REST API\n6. *Success*: EngagementService → Event Bus: Publish `SupportCaseCreated` event\n7. *EngagementService* → Braze: Trigger push notification campaign (\"Your feedback has been received, Case #12345\")\n8. *Failure*: Retry with exponential backoff → Dead Letter Queue → Ops team alert\n\n*Case Update Notification (Bidirectional):*\n\n1. *Support Agent* updates/resolves Case in Salesforce\n2. *Salesforce* → EngagementService: Webhook notification (Case updated)\n3. *EngagementService* → Event Bus: Publish `SupportCaseUpdated` or `SupportCaseResolved` event\n4. *EngagementService* → Braze: Trigger push notification campaign (\"Your case has been resolved\")\n\n*Contact Reconciliation (JIT):*\n\n1. *Mobile App user* authenticates\n2. *Mobile App* → ProfileService: GET /profile/contact-id\n3. *ProfileService* → Salesforce: Query Contact by email\n4. *Match found*: Return existing Salesforce Contact ID\n5. *No match*: Create new Contact in Salesforce, return new Contact ID\n6. *ProfileService* → Mobile App: Return Salesforce Contact ID (cached by Mobile App)\n\n===== System of Record Boundaries\n\n[width=\"100%\",cols=\"30%,35%,35%\",options=\"header\",]\n|===\n|Data Entity |System of Record |Rationale\n\n|*Contact*\n|Salesforce Service Cloud\n|Shared Viva Energy instance, unified customer profile across all channels (digital, wholesale, Shell Card, retail)\n\n|*Case*\n|Salesforce Service Cloud\n|Support agents manage Cases in Salesforce, digital channels submit via EngagementService ACL\n\n|*Feedback Submission (transient)*\n|None (no persistence)\n|EngagementService processes feedback and creates Case in Salesforce, no local storage\n\n|*Domain Events*\n|Event Bus (ephemeral)\n|Events published to Event Bus, consumed by subscribers, not persisted long-term (event sourcing not in scope)\n\n|===\n\n==== Data Architecture Principles\n\n===== Aggregate Persistence\n\n*ProfileService:*\n\n* **No local aggregate persistence** - ProfileService is stateless, queries Salesforce on-demand\n* Salesforce Contact is the aggregate root (owned by Salesforce)\n* ProfileService acts as facade/translator, not system of record\n\n*EngagementService:*\n\n* **No local aggregate persistence** - EngagementService is stateless, creates Cases in Salesforce via ACL\n* Salesforce Case is the aggregate root (owned by Salesforce)\n* EngagementService maintains no local Case state (Conformist pattern - trust Salesforce as source of truth)\n* Async processing state managed via Event Bus (work items in queue, not database)\n\n===== Event Store\n\n* **Event Bus** (SNS+SQS/EventBridge/Kinesis) handles domain event publishing\n* Events are **ephemeral** (consumed and discarded, not persisted for event sourcing)\n* No Event Store implementation in this architecture (future enhancement if needed)\n* Event schema versioning TBD in Solution Architecture\n\n\n=== Architecture Decisions\n\n==== ADR-CS-001: Consolidate onto Salesforce Service Cloud (not build custom solution)\n\n*Status*: Accepted\n\n*Context*:\n\n* D365 Customer Engagement not working well for digital customer support\n* Viva Energy already uses Salesforce Service Cloud for fuel wholesale, Shell Card, other retail channels\n* Post-merger opportunity to consolidate onto single platform\n* Alternative: Build custom support platform or use different SaaS\n\n*Decision*:\n\nConsolidate OTR digital customer support onto Salesforce Service Cloud (shared Viva Energy instance).\n\n*Rationale*:\n\n* **Unified customer view**: Support agents see all interactions across channels (digital, wholesale, Shell Card, retail)\n* **Platform consolidation**: Single support platform reduces operational overhead and costs\n* **Proven solution**: Salesforce Service Cloud is established, feature-rich, well-supported\n* **Post-merger alignment**: Strategic decision to standardize on Viva Energy platforms\n* **Avoid custom development**: Building custom support platform would be costly and high-risk\n\n*Consequences*:\n\n* Unified customer support across Viva Energy Group\n* Reduced operational complexity (single platform vs two)\n* Leverage Salesforce capabilities (case routing, knowledge base, AI, omnichannel)\n* ⚠️ Conformist pattern required (shared instance, conform to existing configuration)\n* ⚠️ Multi-tenant governance needed (data isolation, security, queues)\n* ❌ Less control over platform evolution (SaaS vendor, shared instance)\n\n==== ADR-CS-002: Implement ProfileService and EngagementService as first DDD bounded contexts\n\n*Status*: Accepted\n\n*Context*:\n\n* OTR target architecture uses Domain-Driven Design with bounded contexts\n* This migration is opportunity to establish first implementation\n* Alternative: Direct Mobile App → Salesforce integration (no bounded contexts)\n* Alternative: Single monolithic service for all customer-facing APIs\n\n*Decision*:\n\nImplement ProfileService and EngagementService as separate bounded contexts following DDD strategic patterns.\n\n*Rationale*:\n\n* **Foundation for target architecture**: First implementation of DDD pattern for future bounded contexts (Flybuys, LocationService, PaymentService)\n* **Separation of concerns**: ProfileService handles identity/Contact reconciliation, EngagementService handles support/feedback (different responsibilities, different change rates)\n* **Anti-Corruption Layer**: EngagementService protects digital channels from Salesforce API changes\n* **Reusability**: ProfileService Contact reconciliation reused for Flybuys integration\n* **Event-driven architecture**: Establishes pattern for loose coupling between bounded contexts\n\n*Consequences*:\n\n* Establishes DDD architecture foundation for OTR\n* Reusable ProfileService for Flybuys and future integrations\n* Digital channels protected from Salesforce API changes (ACL)\n* Clear bounded context boundaries and responsibilities\n* ⚠️ Increased initial complexity (two new microservices vs direct integration)\n* ⚠️ Requires Event Bus infrastructure implementation\n* ⚠️ Team must learn DDD patterns and bounded context design\n\n==== ADR-CS-003: Async Case creation via Event Bus (not synchronous)\n\n*Status*: Accepted\n\n*Context*:\n\n* Current D365 CE integration is synchronous (user waits for Case creation)\n* Alternative: Keep synchronous integration (Mobile App → EngagementService → Salesforce synchronously)\n* Salesforce API may experience downtime or latency\n\n*Decision*:\n\nImplement async Case creation via Event Bus with immediate user acknowledgment, retry logic, exponential backoff, and dead letter queue.\n\n*Rationale*:\n\n* **Non-blocking user experience**: User gets immediate \"Feedback submitted\" confirmation, not waiting for Salesforce API\n* **Resilience**: If Salesforce is down, feedback still accepted, Case created when Salesforce recovers\n* **Retry logic**: Automatic retry with exponential backoff handles transient failures\n* **Operational visibility**: Dead letter queue alerts ops team to persistent failures\n* **Scalability**: Queue buffering handles traffic spikes\n\n*Consequences*:\n\n* Better user experience (no waiting for Salesforce API)\n* Resilient to Salesforce downtime (queue buffers work)\n* Automatic retry reduces manual intervention\n* Queue depth monitoring provides operational visibility\n* ⚠️ Eventual consistency (user gets success notification after Case created, not immediately)\n* ⚠️ Increased complexity (Event Bus, background workers, retry logic, DLQ)\n* ⚠️ Requires monitoring and alerting for DLQ\n\n==== ADR-CS-004: ProfileService uses email as primary matching key (not VCI)\n\n*Status*: Accepted\n\n*Context*:\n\n* ProfileService needs to reconcile Mobile App users as Salesforce Contacts\n* Alternative matching keys: VCI (Viva Consumer ID), email, phone, Salesforce External ID\n* Email changes are rare but possible\n\n*Decision*:\n\nUse email address as primary matching key for Contact reconciliation (JIT upsert by email).\n\n*Rationale*:\n\n* **Availability**: Email always available for authenticated users\n* **Uniqueness**: Email is unique identifier in Salesforce and Mobile App\n* **Salesforce standard**: Salesforce Contact uses email as standard lookup field\n* **Simplicity**: Single matching key simplifies upsert logic\n* **Edge case acceptable**: Email changes are rare, manual cleanup acceptable\n\n*Consequences*:\n\n* Simple upsert logic (query by email, create if not found)\n* Leverages Salesforce standard email field\n* Email always available from authentication\n* ⚠️ Email changes create duplicate Contacts (rare edge case, manual cleanup)\n* ⚠️ Future enhancement: Add VCI as Salesforce External ID for stable matching\n\n==== ADR-CS-005: No Case migration from D365 CE (fresh start)\n\n*Status*: Accepted\n\n*Context*:\n\n* D365 CE contains historical customer support Cases\n* Alternative: Migrate historical Cases to Salesforce (preserve support history)\n* Alternative: Archive D365 CE Cases separately (read-only access)\n\n*Decision*:\n\nDo not migrate historical Cases from D365 CE to Salesforce. Start fresh in Salesforce.\n\n*Rationale*:\n\n* **Limited value**: Historical D365 CE Cases not critical for future support\n* **Data quality**: D365 CE Case data may be inconsistent or incomplete\n* **Complexity**: Case migration requires mapping D365 CE schema to Salesforce, data transformation, validation\n* **Cost-benefit**: Migration effort outweighs value of historical data\n* **Archive option**: D365 CE Cases can be archived separately if needed (read-only access for auditing)\n\n*Consequences*:\n\n* Simpler migration (Contacts only, no Case migration)\n* Faster time to value (no Case migration delay)\n* Clean start in Salesforce (no legacy data quality issues)\n* ⚠️ Historical Cases not visible in Salesforce (support agents can't see old Cases)\n* ⚠️ D365 CE must remain accessible temporarily for historical Case lookups (if needed)\n* ❌ Loss of historical Case insights (reporting, analytics on old Cases)\n\n==== ADR-CS-006: Big bang cutover (not phased rollout)\n\n*Status*: Accepted\n\n*Context*:\n\n* Alternative: Phased rollout with feature flags (pilot users first, gradual enablement)\n* Alternative: Parallel run (submit to both D365 CE and Salesforce temporarily)\n* Flybuys integration uses phased rollout (AS-1, AS-2, AS-3 architecture states)\n\n*Decision*:\n\nBig bang cutover - migrate Contacts, deploy ProfileService and EngagementService, switch Mobile App, retire D365 CE.\n\n*Rationale*:\n\n* **Simplicity**: No parallel run complexity, no feature flag management\n* **Faster D365 CE retirement**: No extended transition period maintaining two systems\n* **Limited risk**: Customer support not mission-critical (not payment processing), rollback possible\n* **User base manageable**: OTR digital customers smaller than Flybuys integration scope\n* **Different use case**: Flybuys phased rollout manages points accrual complexity, support feedback is simpler\n\n*Consequences*:\n\n* Simpler deployment (single cutover, no AS-1/AS-2/AS-3 states)\n* Faster D365 CE retirement (no extended parallel run)\n* No feature flag complexity or pilot user management\n* ⚠️ Higher cutover risk (all users switch at once)\n* ⚠️ Requires comprehensive testing before cutover\n* ⚠️ Rollback plan required (revert to D365 CE if critical issues)\n\n==== ADR-CS-007: EngagementService receives Salesforce webhooks for Case updates\n\n*Status*: Accepted\n\n*Context*:\n\n* Support agents update/resolve Cases in Salesforce\n* Need to notify customers of Case status changes via push notifications\n* Alternative: Poll Salesforce API for Case updates (inefficient)\n* Alternative: No customer notifications (agents contact customers directly)\n\n*Decision*:\n\nSalesforce sends webhook notifications to EngagementService when Cases are updated/resolved. EngagementService triggers Braze push notifications.\n\n*Rationale*:\n\n* **Real-time notifications**: Customer notified immediately when agent resolves Case\n* **Efficient**: Webhook push model (not polling)\n* **Event-driven**: Aligns with event-driven architecture pattern\n* **Better customer experience**: Proactive notification vs waiting for agent contact\n\n*Consequences*:\n\n* Real-time customer notifications for Case updates\n* Efficient push model (no polling overhead)\n* Bidirectional integration (Mobile App → Salesforce → Mobile App)\n* ⚠️ Salesforce webhook mechanism TBD (Outbound Messages vs Platform Events vs Process Builder)\n* ⚠️ Webhook authentication and security required\n* ⚠️ EngagementService must handle webhook retries and failures\n\n<<<\n== Interface Specifications\n\nThis section provides references to the complete API specifications and event catalogue for ProfileService and EngagementService.\n\n=== REST API Specifications\n\nComplete OpenAPI 3.0 specifications are maintained in the `specifications/rest/` directory:\n\n==== ProfileService API v1\n\n*Specification*: link:../../specifications/rest/profile-service-v1.yaml[profile-service-v1.yaml]\n\n*Base URL*: `https://api.otr.com.au/profile/v1`\n\n*Authentication*: Bearer token (Microsoft Entra External ID JWT)\n\n*Key Endpoints*:\n\n* `GET /contact-id` - Retrieve or create Salesforce Contact ID for authenticated user (Just-In-Time reconciliation)\n** Used by Mobile App before submitting feedback to EngagementService\n** Upserts Salesforce Contact record using email as external key\n** Returns 18-character Salesforce Contact ID with caching (15-minute TTL)\n** Performance SLA: p95 < 300ms (uncached), p95 < 50ms (cached)\n\n==== EngagementService API v1\n\n*Specification*: link:../../specifications/rest/engagement-service-v1.yaml[engagement-service-v1.yaml]\n\n*Base URL*: `https://api.otr.com.au/engagement/v1`\n\n*Authentication*: Bearer token (Microsoft Entra External ID JWT)\n\n*Key Endpoints*:\n\n* `POST /feedback` - Submit customer feedback for async Case creation in Salesforce\n** Accepts contactId, category, storeName, timeOfVisit, contactPhoneNumber, message\n** Returns 202 Accepted immediately (async Case creation in background)\n** Publishes `CustomerFeedbackSubmitted` event for analytics\n** Creates Salesforce Case via Anti-Corruption Layer with retry logic\n** Performance SLA: p95 < 200ms (feedback accepted, not Case creation)\n\n=== Domain Events (AsyncAPI)\n\nComplete CloudEvents 1.0 JSON Schema specifications are maintained in the `specifications/events/` directory:\n\n*Specification*: link:../../specifications/events/engagement-events.json[engagement-events.json]\n\n==== Event Catalogue\n\n[width=\"100%\",cols=\"30%,20%,50%\",options=\"header\",]\n|===\n|Event Type |Publisher |Consumers\n\n|`CustomerFeedbackSubmitted`\n|EngagementService\n|Future bounded contexts, analytics, sentiment analysis\n\n|`SupportCaseCreated`\n|EngagementService\n|Future bounded contexts, analytics\n\n|`SupportCaseUpdated`\n|EngagementService (via Salesforce webhook)\n|Future bounded contexts, analytics\n\n|`SupportCaseResolved`\n|EngagementService (via Salesforce webhook)\n|Future bounded contexts, analytics\n\n|===\n\n==== Event Delivery Guarantees\n\n* **At-least-once delivery**: Events may be delivered multiple times, consumers must handle idempotency\n* **Ordering**: FIFO queues guarantee ordering for events with same `contactId`\n* **Retention**: 4 days (96 hours) in Event Bus\n* **Dead Letter Queue**: Failed events after 5 retries moved to DLQ for manual intervention\n* **Format**: CloudEvents 1.0 specification with JSON payload\n\n=== API Versioning Policy\n\n==== Version Numbering\n\n* **Format**: `/v{major}` in URL path (e.g., `/profile/v1`, `/engagement/v1`)\n* **Semantic Versioning**: Major version incremented for breaking changes only\n* **Backwards Compatibility**: Minor changes (new optional fields, new endpoints) don't require version bump\n\n==== When to Version\n\n*Breaking changes requiring new major version*:\n\n- Removing or renaming fields in request/response\n- Changing field data types (e.g., string → number)\n- Changing authentication mechanism\n- Removing endpoints\n\n*Non-breaking changes not requiring version bump*:\n\n- Adding new optional fields to request/response\n- Adding new endpoints\n- Expanding enum values (e.g., adding new feedback category)\n- Improving error messages\n\n==== Parallel Version Support\n\n* Support N and N-1 versions concurrently for 6 months\n* Deprecation notice: 3 months before sunsetting old version\n* Mobile App must upgrade to new version within deprecation window\n\n<<<\n== Work Packages\n\nThis section consolidates gaps and activities into implementable work packages aligned with TOGAF Phase E requirements.\n\n=== Work Package Overview\n\n[width=\"100%\",cols=\"15%,35%,25%,25%\",options=\"header\",]\n|===\n|Work Package ID |Name |Transition State |Key Deliverables\n\n|WP-CS-001\n|ProfileService Development\n|TS-1 (Build & Test)\n|ProfileService microservice, Salesforce Contact integration, REST API\n\n|WP-CS-002\n|EngagementService Development\n|TS-1 (Build & Test)\n|EngagementService microservice, Anti-Corruption Layer, Braze integration\n\n|WP-CS-003\n|Event Bus Infrastructure\n|TS-1 (Build & Test)\n|Event Bus configuration, CloudEvents schemas, monitoring\n\n|WP-CS-004\n|Contact Migration Tooling\n|TS-1 (Build & Test)\n|Migration tool, validation scripts, reconciliation reporting\n\n|WP-CS-005\n|Mobile App Integration\n|TS-1 (Build & Test)\n|Mobile App API integration, feedback form enhancements, testing\n\n|WP-CS-006\n|Integration Testing\n|TS-1 (Build & Test)\n|Test environments, integration test suites, UAT execution\n\n|WP-CS-007\n|Salesforce Configuration\n|TS-1 (Build & Test)\n|Salesforce field mapping, data isolation, webhook configuration\n\n|WP-CS-008\n|Contact Data Migration\n|TS-2 (Contact Migration)\n|Contact migration execution, validation, reconciliation\n\n|WP-CS-009\n|Production Deployment\n|TS-3 (Cutover)\n|Production deployment, smoke testing, go-live execution\n\n|WP-CS-010\n|Post-Cutover Support\n|TS-4 (Target State)\n|Monitoring, issue resolution, D365 CE retirement\n\n|===\n\n[[wp-cs-001]]\n=== WP-CS-001: ProfileService Development\n\n==== Description\n\nBuild ProfileService bounded context microservice implementing Just-In-Time Contact reconciliation with Salesforce Service Cloud.\n\n==== Deliverables\n\n* ProfileService microservice application\n** REST API implementation (OpenAPI 3.0 specification)\n** `GET /contact-id` endpoint (Salesforce Contact reconciliation)\n** Authentication/authorization with Microsoft Entra External ID\n** Caching layer (15-minute TTL for Contact IDs)\n* Salesforce integration\n** Salesforce REST API client\n** Contact upsert by email (external key matching)\n** Error handling and retry logic\n* Unit tests (>80% code coverage)\n* Integration tests with Salesforce sandbox\n* API documentation\n* Deployment configuration (IaC - Infrastructure as Code)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* Salesforce sandbox environment provisioned\n* Microsoft Entra External ID OAuth configuration\n* Development environment setup (AWS dev account, CI/CD pipeline)\n\n*Dependent Work Packages*:\n\n* None (can start immediately after prerequisites met)\n\n==== Skills Required\n\n* Backend development (.NET Core or Node.js)\n* REST API design and implementation\n* Salesforce REST API integration\n* OAuth 2.0 / JWT authentication\n* Caching strategies (Redis/ElastiCache)\n* Unit/integration testing frameworks\n* Infrastructure as Code (Terraform/CloudFormation)\n\n==== Acceptance Criteria\n\n* All API endpoints return correct HTTP status codes per OpenAPI specification\n* Contact ID retrieval achieves p95 < 300ms (uncached), p95 < 50ms (cached)\n* Salesforce Contact upsert succeeds with 100% accuracy in sandbox testing\n* Unit test coverage > 80%\n* Integration tests pass in sandbox environment\n* API documentation generated from OpenAPI specification\n\n[[wp-cs-002]]\n=== WP-CS-002: EngagementService Development\n\n==== Description\n\nBuild EngagementService bounded context microservice implementing customer feedback submission, Anti-Corruption Layer for Salesforce Case creation, Braze integration, and webhook receiver for Case updates.\n\n==== Deliverables\n\n* EngagementService microservice application\n** REST API implementation (OpenAPI 3.0 specification)\n** `POST /feedback` endpoint (async feedback submission)\n** Authentication/authorization with Microsoft Entra External ID\n** Webhook receiver endpoint for Salesforce Case updates\n* Anti-Corruption Layer (ACL)\n** OTR domain model to Salesforce API translation\n** Category enum mapping (App/Service/Order/Rewards → Salesforce Case fields)\n** Salesforce REST API client for Case creation\n* Async processing infrastructure\n** Event Bus publisher integration\n** Background worker for Case creation\n** Retry logic with exponential backoff (5 attempts)\n** Dead Letter Queue integration\n* Braze integration\n** Braze campaign trigger API client\n** Push notification orchestration for Case updates\n* Domain event publishing\n** `CustomerFeedbackSubmitted` event publisher\n** `SupportCaseCreated` event publisher\n** `SupportCaseUpdated` event translator (Salesforce webhook → domain event)\n** `SupportCaseResolved` event translator (Salesforce webhook → domain event)\n* Unit tests (>80% code coverage)\n* Integration tests (EngagementService ↔ Salesforce, EngagementService ↔ Braze)\n* API documentation\n* Deployment configuration (IaC)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* <<wp-cs-003,WP-CS-003>> (Event Bus Infrastructure) completed\n* Salesforce sandbox environment provisioned\n* Braze API credentials and campaign templates configured\n* Microsoft Entra External ID OAuth configuration\n\n*Dependent Work Packages*:\n\n* <<wp-cs-003,WP-CS-003>> must be completed first (Event Bus required for async processing)\n* <<wp-cs-007,WP-CS-007>> (Salesforce Configuration) must be in progress (field mapping needed)\n\n==== Skills Required\n\n* Backend development (.NET Core or Node.js)\n* REST API design and implementation\n* Salesforce REST API integration\n* Event-driven architecture patterns\n* Async/background processing (queues, workers)\n* Braze API integration\n* Webhook design and security\n* OAuth 2.0 / JWT authentication\n* Domain-Driven Design (DDD) - Anti-Corruption Layer pattern\n* Unit/integration testing frameworks\n* Infrastructure as Code (Terraform/CloudFormation)\n\n==== Acceptance Criteria\n\n* Feedback submission endpoint returns 202 Accepted within p95 < 200ms\n* Async Case creation succeeds with >99.5% success rate (including retries)\n* Anti-Corruption Layer correctly maps all feedback categories to Salesforce Case fields\n* Webhook receiver processes Salesforce Case updates and publishes domain events\n* Braze push notifications sent successfully for Case updates\n* Failed Case creation moves to Dead Letter Queue after 5 retry attempts\n* Unit test coverage > 80%\n* Integration tests pass with Salesforce sandbox and Braze staging environment\n\n[[wp-cs-003]]\n=== WP-CS-003: Event Bus Infrastructure\n\n==== Description\n\nImplement Event Bus infrastructure for domain event publishing using existing AWS infrastructure (SNS+SQS, EventBridge, or Kinesis).\n\n==== Deliverables\n\n* Event Bus infrastructure configuration\n** Topic/stream provisioning (technology choice: SNS+SQS / EventBridge / Kinesis)\n** FIFO queue configuration (ordering by `contactId`)\n** Dead Letter Queue (DLQ) setup\n** Retention policy (4 days / 96 hours)\n** Access control policies (IAM roles, permissions)\n* CloudEvents 1.0 schema definitions\n** JSON Schema specifications for all domain events\n** Schema validation configuration\n** Schema registry (if using EventBridge/Kinesis)\n* Monitoring and alerting\n** CloudWatch dashboards for queue metrics\n** Alarms for DLQ depth, queue age, processing failures\n** Event Bus throughput monitoring\n* Documentation\n** Event Bus architecture diagram\n** Event publishing guidelines\n** Consumer integration guide\n* Infrastructure as Code (IaC)\n** Terraform/CloudFormation templates for all infrastructure\n\n==== Dependencies\n\n*Prerequisites*:\n\n* AWS account access (existing infrastructure)\n* Technology selection decision (SNS+SQS vs EventBridge vs Kinesis)\n* CloudEvents 1.0 schema design approval\n\n*Dependent Work Packages*:\n\n* None (foundational infrastructure, can start early)\n\n==== Skills Required\n\n* AWS messaging services (SNS, SQS, EventBridge, Kinesis)\n* Event-driven architecture patterns\n* CloudEvents specification\n* JSON Schema design\n* Infrastructure as Code (Terraform/CloudFormation)\n* AWS IAM security configuration\n* CloudWatch monitoring and alerting\n\n==== Acceptance Criteria\n\n* Event Bus infrastructure provisioned in all environments (dev, staging, production)\n* FIFO ordering validated for events with same `contactId`\n* Dead Letter Queue triggers alarms when messages arrive\n* Event retention policy enforced (4 days)\n* CloudEvents 1.0 schema validation enabled\n* Monitoring dashboards operational\n* Infrastructure fully codified (IaC)\n\n[[wp-cs-004]]\n=== WP-CS-004: Contact Migration Tooling\n\n==== Description\n\nDevelop Contact migration tool for one-time migration from app-specific database to Salesforce Service Cloud with upsert logic and validation.\n\n==== Deliverables\n\n* Contact migration tool\n** Extract Contacts from app-specific database\n** Transform to Salesforce Contact API format\n** Upsert to Salesforce using email as external key\n** Fallback matching by phone number or Viva Consumer ID\n** Batch processing with rate limiting (respect Salesforce API limits)\n** Idempotent operation (can be re-run safely)\n* Validation scripts\n** Pre-migration validation (data quality checks)\n** Post-migration validation (100% Contact reconciliation)\n** Email/phone/VCI matching accuracy report\n* Reconciliation reporting\n** Contacts created vs updated statistics\n** Failed upserts with error details\n** Matching accuracy metrics\n* Rollback capability\n** Export snapshot of Salesforce Contacts before migration\n** Rollback procedure documentation\n* Documentation\n** Migration tool user guide\n** Troubleshooting guide\n** Runbook for migration execution\n\n==== Dependencies\n\n*Prerequisites*:\n\n* <<wp-cs-001,WP-CS-001>> (ProfileService Development) completed (reuses Salesforce integration code)\n* Salesforce sandbox environment for migration testing\n* App-specific database access (read-only sufficient)\n* Salesforce production access granted\n\n*Dependent Work Packages*:\n\n* <<wp-cs-001,WP-CS-001>> provides Salesforce Contact upsert logic to reuse\n\n==== Skills Required\n\n* Database development (SQL, data extraction)\n* Salesforce REST API integration\n* Batch processing and ETL patterns\n* Data validation and reconciliation\n* Error handling and logging\n* Scripting (Python, PowerShell, or similar)\n\n==== Acceptance Criteria\n\n* Migration tool successfully migrates 100% of Contacts in sandbox with zero data loss\n* Email/phone/VCI matching accuracy > 95% in sandbox testing\n* Failed upserts captured with actionable error messages\n* Reconciliation report matches actual Salesforce Contact counts\n* Migration tool execution time acceptable for production (freezes app database for minimum time)\n* Rollback procedure validated in sandbox\n* Documentation complete and approved\n\n[[wp-cs-005]]\n=== WP-CS-005: Mobile App Integration\n\n==== Description\n\nUpdate Mobile App to integrate with ProfileService and EngagementService APIs, replacing D365 CE integration.\n\n==== Deliverables\n\n* Feedback form UI enhancements\n** Add Category dropdown (App, Service, Order, Rewards, Refund, Delete Account)\n** Add Store Name field (optional)\n** Add Time of Visit field (optional, datetime picker)\n** Add Contact Phone Number field (optional, E.164 validation)\n** Update Message field (1-2000 character limit with counter)\n* API integration (Kotlin Multiplatform shared code)\n** ProfileService client (`GET /contact-id`)\n** EngagementService client (`POST /feedback`)\n** JWT token management (Microsoft Entra External ID)\n** Error handling (network failures, API errors, validation errors)\n** Retry logic for transient failures\n* Platform-specific UI (SwiftUI for iOS, Jetpack Compose for Android)\n** Feedback form screens\n** Success/error confirmation screens\n** Loading states and progress indicators\n* Feature flag integration\n** `enable_salesforce_feedback_submission` flag\n** Fallback to D365 CE if flag disabled (during rollout)\n* Unit tests for shared business logic\n* UI tests for platform-specific screens\n* API integration tests (mocked APIs)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-001 (ProfileService Development) completed and deployed to dev/staging\n* WP-CS-002 (EngagementService Development) completed and deployed to dev/staging\n* ProfileService and EngagementService OpenAPI specifications finalized\n* Feature flag service configured\n\n*Dependent Work Packages*:\n\n* Must complete after WP-CS-001 and WP-CS-002 (requires API endpoints available for integration testing)\n\n==== Skills Required\n\n* Kotlin Multiplatform development\n* SwiftUI (iOS native UI)\n* Jetpack Compose (Android native UI)\n* REST API client development\n* OAuth 2.0 / JWT authentication\n* Form validation and UX design\n* Unit testing (Kotlin, Swift)\n* UI testing frameworks (XCTest, Espresso)\n\n==== Acceptance Criteria\n\n* Feedback form UI matches UX design specifications\n* All form fields validate correctly (client-side validation)\n* API integration successfully calls ProfileService and EngagementService in dev/staging\n* Error handling provides user-friendly error messages\n* Feature flag correctly toggles between Salesforce and D365 CE integration\n* Unit test coverage > 80% for shared business logic\n* UI tests pass for all feedback form workflows (happy path, error states)\n* App builds and deploys successfully to TestFlight (iOS) and Google Play Internal Testing (Android)\n\n[[wp-cs-006]]\n=== WP-CS-006: Integration Testing\n\n==== Description\n\nExecute comprehensive integration testing across all system components in non-production environments.\n\n==== Deliverables\n\n* Test environment setup\n** Salesforce sandbox configured with test data\n** ProfileService deployed to staging\n** EngagementService deployed to staging\n** Event Bus staging infrastructure\n** Braze staging environment configured\n** Mobile App TestFlight/Internal Testing builds\n* Integration test suites\n** ProfileService ↔ Salesforce (Contact upsert scenarios)\n** EngagementService ↔ Salesforce (Case creation scenarios)\n** EngagementService ↔ Braze (push notification scenarios)\n** Mobile App ↔ ProfileService ↔ EngagementService (end-to-end workflows)\n** Event Bus publishing and consumption\n** Webhook receiver (Salesforce → EngagementService)\n* Test scenarios\n** Happy path: Successful feedback submission and Case creation\n** Error scenarios: Salesforce API failures, Braze API failures, network timeouts\n** Retry scenarios: Async Case creation retries, DLQ validation\n** Performance testing: p95 latency validation for ProfileService and EngagementService\n** Load testing: Simulate 3x-10x expected volume\n* UAT execution\n** Business stakeholder UAT sessions\n** UAT test cases covering all feedback categories\n** UAT sign-off documentation\n* Test results documentation\n** Test execution reports\n** Defect tracking and resolution\n** Performance test results\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-001 (ProfileService Development) completed\n* WP-CS-002 (EngagementService Development) completed\n* WP-CS-003 (Event Bus Infrastructure) completed\n* WP-CS-005 (Mobile App Integration) completed\n* WP-CS-007 (Salesforce Configuration) sandbox configuration completed\n\n*Dependent Work Packages*:\n\n* Must complete after WP-CS-001, WP-CS-002, WP-CS-003, WP-CS-005 (requires all components available)\n\n==== Skills Required\n\n* Integration testing strategy and execution\n* Test automation frameworks (Postman, Newman, Selenium)\n* Performance testing tools (JMeter, k6, Gatling)\n* Salesforce sandbox administration\n* Test data management\n* Defect tracking and triage\n* UAT facilitation\n\n==== Acceptance Criteria\n\n* All integration test scenarios pass (happy path, error scenarios, retry scenarios)\n* Performance SLAs validated (ProfileService p95 < 300ms, EngagementService p95 < 200ms)\n* Load testing confirms system handles 3x expected volume without degradation\n* UAT sign-off obtained from business stakeholders\n* Zero critical defects (P1/P2) open before moving to Contact Migration\n* Test results documented and approved\n\n[[wp-cs-007]]\n=== WP-CS-007: Salesforce Configuration\n\n==== Description\n\nConfigure Salesforce Service Cloud for OTR digital customer support integration, including field mapping, data isolation, and webhook setup.\n\n==== Deliverables\n\n* Salesforce Contact configuration\n** Custom fields for OTR-specific data (if needed)\n** Email as external key configuration\n** Record Type for OTR digital customers (data isolation)\n** Validation rules\n* Salesforce Case configuration\n** Custom fields for feedback categories (App, Service, Order, Rewards, Refund, Delete Account)\n** Case Type and Reason picklist mapping\n** Queue assignment rules (OTR digital support queue)\n** Case escalation rules\n** Case routing rules\n* Salesforce webhook configuration\n** Platform Events / Outbound Messages for Case updates\n** Webhook authentication (API key, JWT, or OAuth)\n** Case status change triggers (New → In Progress, Resolved, Closed)\n** Webhook payload format (JSON)\n* Data isolation strategy\n** Record Types for OTR vs other Viva Energy business units\n** Queues for OTR-specific Cases\n** Reporting and dashboards scoped to OTR data\n* Salesforce API access\n** Connected App configuration\n** OAuth 2.0 JWT bearer flow setup\n** API user credentials\n** API rate limit monitoring\n* Documentation\n** Salesforce field mapping specification\n** Webhook configuration guide\n** Data isolation architecture diagram\n** API authentication setup guide\n\n==== Dependencies\n\n*Prerequisites*:\n\n* Viva Energy Salesforce admin team engagement\n* Salesforce governance approval (multi-tenant environment)\n* Technical decision on webhook mechanism (Platform Events vs Outbound Messages)\n* Technical decision on authentication method (OAuth 2.0 JWT bearer flow recommended)\n\n*Dependent Work Packages*:\n\n* None (can start in parallel with development work packages)\n* Required for WP-CS-002 (EngagementService needs field mapping)\n* Required for WP-CS-006 (Integration Testing needs sandbox configuration)\n\n==== Skills Required\n\n* Salesforce administration\n* Salesforce configuration (Record Types, Queues, Validation Rules)\n* Salesforce API integration (REST API, Platform Events, Outbound Messages)\n* Salesforce security and authentication (OAuth, Connected Apps)\n* Multi-tenant data isolation patterns\n\n==== Acceptance Criteria\n\n* Salesforce sandbox configured with all custom fields, Record Types, Queues\n* Field mapping documented and approved by OTR business stakeholders\n* Webhook configuration tested and delivering Case update notifications\n* Data isolation validated (OTR data separate from other Viva Energy business units)\n* API authentication working for ProfileService and EngagementService\n* Salesforce API rate limits monitored and acceptable for expected volume\n* Configuration replicated to Salesforce production environment\n\n[[wp-cs-008]]\n=== WP-CS-008: Contact Data Migration\n\n==== Description\n\nExecute one-time Contact migration from app-specific database to Salesforce Service Cloud production.\n\n==== Deliverables\n\n* Pre-migration activities\n** Final validation of migration tool in sandbox\n** Communication plan (notify users of maintenance window if needed)\n** Freeze app-specific database Contact updates\n** Backup app-specific database\n** Export snapshot of Salesforce Contacts (rollback preparation)\n* Migration execution\n** Execute migration tool against Salesforce production\n** Monitor migration progress\n** Handle failed upserts (manual intervention if needed)\n* Post-migration validation\n** 100% Contact reconciliation (app database vs Salesforce)\n** Email/phone/VCI matching accuracy report\n** Reconciliation report (Contacts created vs updated)\n** Data integrity checks (no duplicate Contacts, no missing Contacts)\n* ProfileService smoke testing\n** Verify Contact ID retrieval works in production\n** Test cache behavior\n** Validate Salesforce Contact upserts from ProfileService\n* Migration report\n** Total Contacts migrated\n** Contacts created vs updated\n** Failed upserts (if any) with resolution\n** Matching accuracy metrics\n** Migration execution time\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-004 (Contact Migration Tooling) completed\n* WP-CS-001 (ProfileService Development) deployed to production (not yet integrated with Mobile App)\n* WP-CS-007 (Salesforce Configuration) production configuration completed\n* Salesforce production access granted\n* Migration approved by business stakeholders\n\n*Dependent Work Packages*:\n\n* Must complete after WP-CS-001, WP-CS-004, WP-CS-007\n* Must complete before WP-CS-009 (Production Deployment)\n\n==== Skills Required\n\n* Data migration execution\n* Salesforce administration\n* Database operations\n* Data validation and reconciliation\n* Incident management (if issues arise)\n\n==== Acceptance Criteria\n\n* 100% of Contacts migrated with zero data loss\n* Email/phone/VCI matching accuracy > 95%\n* ProfileService smoke tests pass in production\n* Reconciliation report approved by business stakeholders\n* App-specific database Contact updates frozen (read-only mode)\n* Rollback procedure ready (but not executed if migration successful)\n\n[[wp-cs-009]]\n=== WP-CS-009: Production Deployment\n\n==== Description\n\nDeploy all solution components to production and execute cutover from D365 CE to Salesforce Service Cloud.\n\n==== Deliverables\n\n* Production deployment\n** EngagementService deployed to production\n** Event Bus production infrastructure validated\n** Salesforce webhook configured in production\n** Mobile App released to production (App Store, Google Play)\n* Go-live activities\n** Smoke testing (end-to-end feedback submission)\n** Feature flag enabled: `enable_salesforce_feedback_submission = ON`\n** D365 CE integration disabled in Mobile App\n** Monitor Event Bus queue depth, DLQ, Salesforce API rate limits\n** Monitor Mobile App feedback submission success rate\n* Go/No-Go decision\n** Validate success criteria before final cutover\n** Business stakeholder approval\n** Technical validation (smoke tests pass, monitoring healthy)\n* Cutover communication\n** Notify support agents of new Salesforce integration\n** Provide training materials for support agents\n** Customer communication (if visible change)\n* Rollback plan\n** Documented rollback procedure\n** Feature flag can disable Salesforce integration and re-enable D365 CE\n** Rollback decision criteria (P1/P2 incidents, feedback submission success rate < 99%)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-001 (ProfileService Development) completed\n* WP-CS-002 (EngagementService Development) completed\n* WP-CS-003 (Event Bus Infrastructure) completed\n* WP-CS-005 (Mobile App Integration) completed\n* WP-CS-006 (Integration Testing) completed with UAT sign-off\n* WP-CS-007 (Salesforce Configuration) production configuration completed\n* WP-CS-008 (Contact Data Migration) completed successfully\n* Mobile App release approval (App Store, Google Play)\n\n*Dependent Work Packages*:\n\n* Must complete after all prior work packages (final cutover)\n\n==== Skills Required\n\n* Production deployment and release management\n* Incident management and troubleshooting\n* Monitoring and observability\n* Change management and communication\n* Rollback execution (if needed)\n\n==== Acceptance Criteria\n\n* Mobile App feedback submission success rate > 99.5%\n* End-to-end flow validated (Mobile App → ProfileService → EngagementService → Salesforce Case created)\n* Braze push notifications delivered successfully\n* Event Bus queue depth normal, DLQ empty\n* No critical incidents (P1/P2) in first 24 hours\n* D365 CE integration disabled\n* Support agents successfully using Salesforce for OTR digital customer Cases\n\n[[wp-cs-010]]\n=== WP-CS-010: Post-Cutover Support\n\n==== Description\n\nMonitor production stability, resolve issues, validate success criteria, and execute D365 CE retirement.\n\n==== Deliverables\n\n* Monitoring and support\n** 24/7 on-call support for first week post-cutover\n** Daily monitoring reports (feedback submission success rate, Case creation success rate)\n** Incident response and resolution\n** Performance tuning (if needed)\n* Success criteria validation\n** Validate feedback submission success rate > 99.5%\n** Monitor customer satisfaction score (target: +15% improvement within 6 months)\n** Monitor average case resolution time (target: -20% improvement within 6 months)\n** Support agent feedback survey\n* D365 CE retirement\n** D365 CE set to read-only mode (historical Case lookups only)\n** Archive D365 CE data for compliance/auditing\n** Decommission D365 CE infrastructure (after 90-day stabilization period)\n** Remove D365 CE integration code from Mobile App\n* Documentation updates\n** Production runbook\n** Troubleshooting guide (based on incidents resolved)\n** Operational procedures for support team\n** Lessons learned document\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-009 (Production Deployment) completed\n* Cutover successful with no critical incidents\n\n*Dependent Work Packages*:\n\n* Final work package in sequence\n\n==== Skills Required\n\n* Production support and incident management\n* Performance monitoring and tuning\n* Data archival and compliance\n* Infrastructure decommissioning\n* Documentation\n\n==== Acceptance Criteria\n\n* Zero critical incidents (P1/P2) in first 30 days post-cutover\n* Feedback submission success rate sustained > 99.5%\n* Customer satisfaction improvement validated (baseline established, ongoing measurement)\n* Support agents reporting positive experience with Salesforce unified view\n* D365 CE successfully decommissioned\n* All production documentation complete and approved\n* Lessons learned document published\n\n=== Work Package Sequencing\n\n==== Parallel Track 1: Infrastructure & Configuration\n\nCan start immediately and run in parallel:\n\n* WP-CS-003 (Event Bus Infrastructure)\n* WP-CS-007 (Salesforce Configuration)\n\n==== Parallel Track 2: Development\n\nCan start after Track 1 infrastructure decisions made:\n\n* WP-CS-001 (ProfileService Development) - Independent\n* WP-CS-002 (EngagementService Development) - Requires WP-CS-003 completed\n* WP-CS-004 (Contact Migration Tooling) - Requires WP-CS-001 completed (reuses code)\n\n==== Sequential Track 3: Integration & Testing\n\nMust complete after development:\n\n* WP-CS-005 (Mobile App Integration) - Requires WP-CS-001, WP-CS-002\n* WP-CS-006 (Integration Testing) - Requires WP-CS-001, WP-CS-002, WP-CS-003, WP-CS-005, WP-CS-007\n\n==== Sequential Track 4: Migration & Cutover\n\nMust complete sequentially:\n\n* WP-CS-008 (Contact Data Migration) - Requires WP-CS-001, WP-CS-004, WP-CS-006 UAT sign-off\n* WP-CS-009 (Production Deployment) - Requires all prior work packages completed\n* WP-CS-010 (Post-Cutover Support) - Requires WP-CS-009\n\n==== Critical Path\n\nThe critical path for this project is:\n\n. WP-CS-003 (Event Bus Infrastructure)\n. WP-CS-002 (EngagementService Development) - blocks on WP-CS-003\n. WP-CS-005 (Mobile App Integration) - blocks on WP-CS-001, WP-CS-002\n. WP-CS-006 (Integration Testing) - blocks on WP-CS-001 through WP-CS-005, WP-CS-007\n. WP-CS-008 (Contact Data Migration) - blocks on WP-CS-006 UAT sign-off\n. WP-CS-009 (Production Deployment) - blocks on WP-CS-008\n. WP-CS-010 (Post-Cutover Support) - final deliverable\n\nAny delays in critical path work packages will delay the overall cutover date.\n\n<<<\n== Transition Architecture\n\nThis section defines the evolution from baseline (D365 CE) to target state (Salesforce Service Cloud + ProfileService + EngagementService).\n\n=== Transition Approach\n\n*Big Bang Cutover*: Per ADR-CS-006, this transition uses a single cutover approach rather than phased rollout. All users switch from D365 CE to Salesforce simultaneously after Contact migration completion.\n\n=== Transition States\n\n==== TS-0: Baseline State (Current)\n\n===== Characteristics\n\n* D365 Customer Engagement handles all digital customer feedback\n* App-specific database stores customer Contact data\n* No ProfileService or EngagementService\n* No event-driven architecture\n* Synchronous feedback submission\n\n===== Components Active\n\n- D365 Customer Engagement\n- App-specific customer database\n- Mobile App (current version with D365 CE integration)\n\n==== TS-1: Build & Test\n\n===== Activities\n\n* Build ProfileService microservice (JIT Contact reconciliation API)\n* Build EngagementService microservice (feedback submission API, ACL for Salesforce Case creation, Braze integration, webhook receiver)\n* Implement Event Bus infrastructure (SNS+SQS/EventBridge/Kinesis)\n* Develop Contact migration tool (app database → Salesforce upsert by email/phone/VCI)\n* Update Mobile App API integration (ProfileService + EngagementService endpoints - feedback form UI already complete)\n* Integration testing (ProfileService ↔ Salesforce, EngagementService ↔ Salesforce, EngagementService ↔ Braze)\n* UAT with test Salesforce sandbox environment\n\n===== Components Active\n\n- D365 Customer Engagement (still active, unchanged)\n- App-specific customer database (still active)\n- ProfileService (non-production, testing only)\n- EngagementService (non-production, testing only)\n- Event Bus (non-production)\n- Salesforce Sandbox (testing)\n\n===== Exit Criteria\n\n- All integration tests pass\n- UAT sign-off from business stakeholders\n- Contact migration tool validated in sandbox\n- Mobile App updates tested with non-production APIs\n\n==== TS-2: Contact Migration\n\n===== Activities\n* Execute Contact migration (app database → Salesforce production)\n* Validation: 100% data integrity check (email/phone/VCI matching)\n* Reconciliation report: New Contacts created vs existing Contacts updated\n* Freeze app database Contact updates during migration window\n* ProfileService smoke testing (verify Contact lookups work in Salesforce production)\n\n===== Components Active\n- D365 Customer Engagement (still active, users unaffected)\n- Salesforce Production (Contacts migrated, no Cases yet)\n- ProfileService (production deployed, not integrated with Mobile App yet)\n- App-specific customer database (frozen, read-only)\n\n===== Exit Criteria\n- 100% of Contacts migrated with zero data loss\n- Email/phone/VCI matching accuracy > 95%\n- ProfileService smoke tests pass (JIT lookups return correct Contact IDs)\n- Reconciliation report approved\n\n==== TS-3: Cutover (Go-Live)\n\n===== Go-Live Activities\n\n* Deploy EngagementService to production\n* Deploy Mobile App updates (ProfileService + EngagementService API integration)\n* Configure Salesforce webhook (Case update notifications → EngagementService)\n* Smoke testing: End-to-end feedback submission (Mobile App → EngagementService → Salesforce → Braze notification)\n* Monitor Event Bus queue depth, dead letter queue, Salesforce API rate limits\n* **Go/No-Go decision**: Validate success criteria before final cutover\n* Enable feature flag: `enable_salesforce_feedback_submission = ON`\n* Disable D365 CE integration in Mobile App\n\n===== Components Active\n\n- ProfileService (production, integrated with Mobile App)\n- EngagementService (production, integrated with Mobile App)\n- Event Bus (production, processing async Case creation)\n- Salesforce Production (receiving Cases from digital customers)\n- Braze (sending push notifications)\n- Mobile App (new version with Salesforce integration)\n- D365 Customer Engagement (disabled, read-only for historical lookups)\n\n===== Exit Criteria\n\n- Mobile App feedback submission success rate > 99.5%\n- End-to-end flow validated (Mobile App → Salesforce Case created)\n- Braze push notifications delivered successfully\n- Event Bus queue depth normal, DLQ empty\n- No critical incidents (P1/P2) in first 24 hours\n\n==== TS-4: Target State (Stable Production)\n\n===== Characteristics\n\n* ProfileService and EngagementService fully operational\n* All digital customer feedback routed to Salesforce\n* Event-driven architecture established\n* D365 CE decommissioned\n* First DDD bounded contexts implemented successfully\n\n===== Monitoring Period\n\n* Validate success criteria: feedback submission rate > 99.5%, no data loss\n* Monitor customer satisfaction score (target: +15% improvement)\n* Monitor average case resolution time (target: -20% improvement)\n* Support agents using unified Salesforce view across all channels\n\n===== D365 CE Retirement\n\n* D365 CE read-only access for historical Case lookups (if needed)\n* Decommission D365 CE infrastructure after 90 days\n* Archive D365 CE data for compliance/auditing\n\n===== Components Active\n\n- ProfileService (production)\n- EngagementService (production)\n- Event Bus (production)\n- Salesforce Production (system of record)\n- Braze (push notifications)\n- Mobile App (Salesforce integration)\n- App-specific database (deprecated, Contact data no longer updated)\n\n===== Success Criteria Achieved\n\n- All digital customer feedback routed to Salesforce\n- Support agents have unified customer view\n- D365 CE decommissioned\n- Customer satisfaction improved by 15%\n- Average case resolution time decreased by 20%\n- Zero data loss during transition\n\n=== Transition Dependencies\n\n[width=\"100%\",cols=\"40%,60%\",options=\"header\",]\n|===\n|Dependency |Owner/Status\n\n|*Salesforce production access*\n|Viva Energy Salesforce admin team - TBD\n\n|*Salesforce Case field mapping*\n|Viva Energy Salesforce admin team - TBD (map OTR feedback categories to Salesforce fields)\n\n|*Salesforce data isolation strategy*\n|Viva Energy Salesforce admin team - TBD (Record Types, queues, custom fields)\n\n|*Salesforce webhook configuration*\n|Viva Energy Salesforce admin team - TBD (Outbound Messages vs Platform Events)\n\n|*Event Bus infrastructure*\n|OTR Platform team - Existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis)\n\n|*Braze integration*\n|OTR Marketing team - Existing Braze account, EngagementService creates new campaigns\n\n|*Mobile App release window*\n|OTR Mobile team - Coordinate cutover timing with app release schedule\n\n|*App database access*\n|OTR Platform team - Read access for Contact migration\n\n|===\n\n=== Transition Validation Criteria\n\n==== Contact Migration Validation\n\n* 100% of app database Contacts migrated to Salesforce (zero data loss)\n* Email/phone/VCI matching accuracy > 95% (minimize duplicate Contacts)\n* ProfileService JIT lookups return correct Salesforce Contact IDs (smoke test sample)\n* Reconciliation report shows: X new Contacts created, Y existing Contacts updated\n\n==== Cutover Validation\n\n* Mobile App feedback submission success rate > 99.5% (including async Case creation)\n* End-to-end flow validated: Mobile App → ProfileService → EngagementService → Salesforce Case created\n* Braze push notifications delivered for Case creation and Case resolution\n* Event Bus queue depth within normal range (no backlog)\n* Dead letter queue empty (no failed Case creations)\n* Salesforce API rate limits not exceeded\n\n==== Production Monitoring (30 days)\n\n* Customer satisfaction score improves by 15% (compared to D365 CE baseline)\n* Average case resolution time decreases by 20% (Salesforce vs D365 CE)\n* Support agents confirm unified customer view across all channels\n* Zero critical incidents (P1 outages, data loss)\n\n=== Rollback Plan\n\n==== Rollback Triggers\n\n* Feedback submission success rate < 95% (below acceptable threshold)\n* Data loss or corruption detected in Salesforce\n* Salesforce API rate limits exceeded (Cases not created within SLA)\n* Critical bug blocking customer feedback submission\n\n==== Rollback Procedure\n\n1. **Revert Mobile App** to previous version (remove ProfileService/EngagementService integration, restore D365 CE integration)\n2. **Stop EngagementService** Case creation (prevent duplicate Cases in Salesforce)\n3. **Re-enable D365 CE** for customer feedback submission\n4. **Investigate root cause** (EngagementService logs, Salesforce API errors, Event Bus queue issues)\n5. **Fix and re-test** in sandbox environment\n6. **Retry cutover** when issues resolved\n\n==== Rollback Limitations\n\n* Cases created in Salesforce during cutover period remain in Salesforce (no reverse migration)\n* Contacts migrated to Salesforce remain (no rollback to app database)\n* Rollback only affects Mobile App integration (not data migration)\n\n=== Architectural Scope Boundaries\n\n==== Capabilities Included\n\n===== Business Capabilities\n\n* **Customer Feedback Submission**: Mobile App users can submit structured feedback (Category, Store Name, Time of Visit, Phone, Free Text Message) via EngagementService\n* **Customer Contact Management**: Just-In-Time (JIT) Contact reconciliation with Salesforce via ProfileService, ensuring every Mobile App user has a Salesforce Contact record\n* **Case Management Integration**: EngagementService creates Salesforce Cases asynchronously for customer feedback, support agents manage Cases in Salesforce Service Cloud\n* **Customer Notifications**: Push notifications via Braze when Cases are created, updated, or resolved (bidirectional integration: Mobile App → Salesforce → Mobile App)\n* **Unified Customer View**: Support agents see OTR digital customer feedback alongside other Viva Energy channels (fuel wholesale, Shell Card, retail) in single Salesforce instance\n* **Contact Data Migration**: One-time migration of app-specific customer database Contacts to Salesforce with upsert logic (email/phone/VCI matching)\n\n===== Technical Capabilities\n\n* **ProfileService Bounded Context**: First DDD bounded context implementation - JIT Contact reconciliation, Salesforce API facade, foundation for Flybuys integration\n* **EngagementService Bounded Context**: First DDD bounded context implementation - Customer feedback submission BFF, Anti-Corruption Layer for Salesforce, Braze integration orchestration\n* **Event-Driven Architecture**: Domain event publishing via Event Bus (SNS+SQS/EventBridge/Kinesis) for `SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted` events\n* **Async Processing Pattern**: Non-blocking Case creation with retry logic, exponential backoff, dead letter queue for operational resilience\n* **Anti-Corruption Layer Pattern**: EngagementService protects digital channels from Salesforce API changes, translates between OTR domain language and Salesforce\n* **Conformist Pattern**: ProfileService and EngagementService conform to existing Salesforce configuration (shared Viva Energy instance, multi-tenant governance)\n* **Salesforce Integration**: REST API integration for Contact CRUD and Case creation, webhook receiver for Case update notifications\n* **Braze Integration**: Push notification campaign triggers for Case lifecycle events (created, updated, resolved)\n* **Observability & Monitoring**: Dashboards, metrics, alerting for feedback submission rate, queue depth, API errors, Case creation latency\n* **Feature Flag Management**: Kill switches for emergency rollback (enable_salesforce_feedback_submission, enable_async_case_creation, etc.)\n\n==== Capabilities Excluded\n\n===== Business Capabilities Explicitly Out of Scope\n\n* **Historical Case Migration**: D365 CE Cases not migrated to Salesforce (ADR-CS-005 - fresh start, no Case migration)\n* **Multi-Channel Feedback Submission**: Web app, POS, call centre, email feedback channels not included (Mobile App only in this phase)\n* **Case Resolution by Digital Channels**: Support agents resolve Cases in Salesforce, not via Mobile App self-service\n* **Knowledge Base Integration**: Salesforce Knowledge Base articles not surfaced in Mobile App (future enhancement)\n* **Live Chat/Messaging**: Real-time chat support not included (Salesforce omnichannel capabilities not activated)\n* **Sentiment Analysis**: Automated feedback sentiment analysis not included (future enhancement with AI/ML)\n* **Customer Satisfaction Surveys**: Post-resolution CSAT surveys not included (separate initiative)\n* **Case Attachments**: Mobile App feedback submission does not support file uploads (photos, receipts) - text only\n* **Agent Desktop Integration**: Custom Salesforce UI for support agents not included (use standard Salesforce Service Console)\n* **Social Media Feedback**: Facebook, Twitter, Instagram feedback channels not integrated\n\n===== Technical Capabilities Explicitly Out of Scope\n\n* **Event Sourcing**: Domain events are ephemeral (not persisted for event sourcing/replay) - Event Bus only, no Event Store\n* **CQRS (Command Query Responsibility Segregation)**: ProfileService and EngagementService use same data model for reads/writes (no separate read models)\n* **Local Aggregate Persistence**: ProfileService and EngagementService are stateless (Salesforce is System of Record, no local database for Contact/Case)\n* **Saga Orchestration**: No distributed transactions or saga patterns required (single-step Case creation, not multi-step workflow)\n* **API Gateway Advanced Features**: Rate limiting, API versioning, API key management deferred to detailed design (basic routing only)\n* **GraphQL API**: ProfileService and EngagementService expose REST APIs only (GraphQL not required)\n* **Real-Time Sync**: Salesforce Contact updates by support agents not synced back to ProfileService (eventual consistency acceptable via JIT reconciliation)\n* **Multi-Region Deployment**: Single AWS region deployment (no multi-region failover/disaster recovery in this phase)\n* **Blue-Green Deployment**: Big bang cutover (ADR-CS-006), not blue-green or canary deployment strategy\n* **A/B Testing Framework**: Feature flags for rollback only, not for A/B testing or experimentation\n* **Custom Authentication**: Microsoft Entra External ID used for Mobile App authentication (no custom authentication logic in ProfileService/EngagementService)\n* **Data Residency Compliance**: Salesforce data residency governed by Viva Energy Salesforce configuration (no OTR-specific data residency requirements)\n\n===== Future Bounded Contexts Not in Scope\n\n* **LoyaltyService**: Flybuys integration, reward preferences, transaction adjudication (separate initiative)\n* **LocationService**: Store finder, proximity features, geofencing (separate initiative)\n* **PaymentService**: Payment processing, subscription billing (separate initiative)\n* **RecommendationService**: Personalized recommendations, next-best offers (separate initiative)\n\n===== Integration Patterns Not in Scope\n\n* **Shared Kernel**: No shared domain model between ProfileService and EngagementService (separate bounded contexts with clear boundaries)\n* **Partnership**: No joint development or coordination with external teams (Conformist pattern - we conform to Salesforce)\n* **Customer-Supplier (we're upstream)**: No downstream systems depend on ProfileService/EngagementService APIs yet (future bounded contexts will consume domain events)\n\n==== Architectural Dependencies on Future Initiatives\n\n*This Architecture Enables Future Initiatives*:\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Future Initiative |Architectural Enablement\n\n|*Flybuys Integration*\n|**ProfileService Contact Reconciliation Reused**: ProfileService establishes pattern for JIT Contact reconciliation with Salesforce, which will be extended for Flybuys partner linking (link:../architecture_definitions/flybuys_integration.adoc[see Flybuys Integration architecture]) +\n**Event Bus Infrastructure**: Domain event publishing pattern (`CustomerEnrolledInLoyalty`, `PartnerLinked`, etc.) reuses Event Bus established for EngagementService\n\n|*LoyaltyService Bounded Context*\n|**Event Bus Subscription**: LoyaltyService will consume `CustomerProfileCreated` events published by ProfileService (future enhancement) +\n**Salesforce Contact Integration**: LoyaltyService may query Salesforce Contacts for customer reward preferences (via ProfileService facade or direct Salesforce API)\n\n|*Web App Feedback Submission*\n|**EngagementService API Reuse**: Web app will call same EngagementService REST API for feedback submission (multi-channel support) +\n**Conformist Pattern**: Web app conforms to EngagementService API contract (no translation required)\n\n|*Multi-Channel Customer Support*\n|**EngagementService Extension**: Add support for email, call centre, POS feedback channels (extend EngagementService to handle multiple origins) +\n**Salesforce Case Origin Field**: Cases already tagged with Origin=Mobile App, extend to Origin=Web, POS, Call Centre, Email\n\n|*Knowledge Base Integration*\n|**EngagementService API Extension**: Add endpoint to query Salesforce Knowledge Base articles, surface in Mobile App for self-service support +\n**Anti-Corruption Layer**: EngagementService translates Salesforce Knowledge API to OTR domain language\n\n|*Customer Satisfaction Surveys*\n|**Event-Driven Trigger**: Subscribe to `SupportCaseResolved` events published by EngagementService, trigger CSAT survey via Braze +\n**Braze Integration Pattern**: Reuse EngagementService → Braze integration pattern for survey campaigns\n\n|*Sentiment Analysis*\n|**Event Subscription**: Subscribe to `CustomerFeedbackSubmitted` events, analyse feedback sentiment (AI/ML service) +\n**EngagementService Extension**: Enrich Case with sentiment score before creating in Salesforce\n\n|*RecommendationService Bounded Context*\n|**Event Subscription**: RecommendationService subscribes to `SupportCaseCreated` events to understand customer pain points and personalize recommendations +\n**Domain Event Pattern**: Reuse Event Bus publishing pattern established by EngagementService\n\n|===\n\n*This Architecture Depends on Future Initiatives*:\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Future Initiative |Dependency Description\n\n|*Salesforce Data Isolation Strategy*\n|**BLOCKER**: Viva Energy Salesforce admin team must define data isolation strategy (Record Types, custom fields, queues) before production deployment +\n**Impact**: Multi-tenant data visibility and security governance\n\n|*Salesforce Case Field Mapping*\n|**BLOCKER**: Viva Energy Salesforce admin team must define field mapping for OTR feedback categories (App, Service, Order, Rewards, Refund, Delete Account) +\n**Impact**: Case creation logic in EngagementService depends on finalized Salesforce schema\n\n|*Salesforce Webhook Mechanism*\n|**BLOCKER**: Viva Energy Salesforce admin team must configure webhook mechanism (Outbound Messages vs Platform Events vs Process Builder) for Case update notifications +\n**Impact**: EngagementService webhook receiver implementation depends on chosen mechanism\n\n|*Event Bus Technology Selection*\n|**DECISION REQUIRED**: Choose Event Bus implementation (SNS+SQS vs EventBridge vs Kinesis) for domain event publishing +\n**Impact**: Infrastructure provisioning, event schema design, consumer implementation\n\n|*Microservice Hosting Platform*\n|**DECISION REQUIRED**: Choose hosting platform for ProfileService and EngagementService (AWS Lambda vs ECS vs EKS) +\n**Impact**: Deployment architecture, auto-scaling strategy, operational overhead\n\n|*Observability Platform*\n|**DECISION REQUIRED**: Choose observability platform (AWS CloudWatch vs Datadog vs New Relic) for monitoring and alerting +\n**Impact**: Dashboard configuration, metric collection, alerting setup\n\n|===\n\n*Future Work After This Initiative*:\n\n* **Event Schema Registry**: Implement event schema versioning and registry for domain events (currently ad-hoc schemas)\n* **API Versioning Strategy**: Define API versioning approach for ProfileService and EngagementService (currently v1 only)\n* **Multi-Region Deployment**: Extend to multi-region for disaster recovery and global availability\n* **Event Store**: Persist domain events for event sourcing and audit trail (currently ephemeral Event Bus only)\n* **CQRS Pattern**: Separate read models for high-volume queries (currently same model for reads/writes)\n* **GraphQL API**: Expose GraphQL API for flexible client queries (currently REST only)\n* **Real-Time Sync**: Bi-directional sync between Salesforce and ProfileService for Contact updates (currently JIT reconciliation only)\n\n=== Technical Risks and Mitigation\n\n[width=\"100%\",cols=\"5%,20%,25%,25%,25%\",options=\"header\",]\n|===\n|ID |Risk |Impact |Likelihood |Mitigation\n\n|RISK-CS-001\n|*Salesforce API rate limits exceeded*: High feedback volume exceeds Salesforce API limits, Cases not created\n|HIGH (customers don't receive Case confirmation, support tickets lost)\n|MEDIUM (volume unknown, rate limits TBD)\n|• Gather expected feedback volume data before cutover +\n• Implement Event Bus queue throttling/rate limiting +\n• Monitor queue depth and API usage +\n• Scale background workers based on queue depth +\n• Alert ops team when approaching rate limits\n\n|RISK-CS-002\n|*Salesforce downtime*: Salesforce Service Cloud outage prevents Case creation\n|MEDIUM (Cases delayed but queued, customers wait for confirmation)\n|LOW (Salesforce SLA 99.9% uptime)\n|• Async Case creation with retry logic +\n• Event Bus queues buffer work during outage +\n• Customers get immediate \"Feedback submitted\" (not blocked) +\n• Monitor Salesforce status page, alert ops team +\n• Automatic retry when Salesforce recovers\n\n|RISK-CS-003\n|*Contact migration data quality issues*: App database Contact data incomplete or invalid\n|HIGH (migration fails validation, cutover delayed)\n|MEDIUM (legacy data quality unknown)\n|• Pre-migration data quality assessment +\n• Flexible upsert logic (match by email/phone/VCI) +\n• Validation report identifies data issues before production migration +\n• Manual cleanup for invalid records +\n• Dry-run migration in sandbox environment\n\n|RISK-CS-004\n|*Duplicate Contacts created*: Email matching fails, ProfileService creates duplicate Contacts\n|MEDIUM (support agents see multiple profiles for same customer)\n|MEDIUM (email changes, data quality issues)\n|• Salesforce duplicate detection rules (if available) +\n• ProfileService logs Contact creation for audit trail +\n• Manual duplicate cleanup process (support team) +\n• Future enhancement: VCI as Salesforce External ID for stable matching\n\n|RISK-CS-005\n|*Dead letter queue accumulation*: Failed Case creations not processed, queue grows\n|HIGH (customers don't receive Case confirmation, feedback lost)\n|LOW (retry logic handles most failures)\n|• Dead letter queue monitoring and alerting +\n• Ops team dashboard showing DLQ depth +\n• Manual intervention process (investigate and reprocess) +\n• Automated alerts when DLQ depth exceeds threshold +\n• Root cause analysis for recurring failures\n\n|RISK-CS-006\n|*Salesforce webhook failures*: Salesforce can't deliver Case update notifications to EngagementService\n|MEDIUM (customers don't get push notifications for Case resolution)\n|LOW (webhook mechanism reliable)\n|• Webhook retry logic and exponential backoff +\n• EngagementService logs webhook deliveries +\n• Monitor webhook delivery success rate +\n• Fallback: Poll Salesforce API for Case updates (if webhook fails persistently) +\n• Alert ops team when webhook delivery rate drops\n\n|RISK-CS-007\n|*Multi-tenant data isolation breach*: OTR digital Cases visible to other Viva Energy support teams\n|HIGH (privacy violation, compliance risk)\n|LOW (Salesforce governance controls)\n|• Work with Viva Energy Salesforce admin team on data isolation strategy +\n• Test data visibility in Salesforce sandbox (UAT with different user roles) +\n• Validate Record Types, queues, field-level security before production +\n• Audit Salesforce user permissions and sharing rules\n\n|RISK-CS-008\n|*Mobile App release coordination*: App release delayed, cutover window missed\n|MEDIUM (cutover delayed, D365 CE retirement delayed)\n|MEDIUM (release schedule conflicts)\n|• Coordinate cutover timing with Mobile team early +\n• Buffer time in migration plan (2-week contingency) +\n• Decouple backend deployment from Mobile App release (backend deployed first, app follows) +\n• Feature flag for feedback submission (enable when ready)\n\n|RISK-CS-009\n|*Event Bus infrastructure issues*: SNS/SQS/EventBridge downtime or misconfiguration\n|HIGH (Case creation blocked, domain events not published)\n|LOW (AWS SLA 99.99% uptime)\n|• Leverage existing AWS infrastructure (proven, reliable) +\n• Infrastructure as Code (IaC) for Event Bus configuration +\n• Integration testing in non-production environment +\n• Monitor Event Bus metrics (queue depth, throughput, errors) +\n• Alert ops team on Event Bus failures\n\n|RISK-CS-010\n|*Team DDD knowledge gap*: Team unfamiliar with DDD patterns, bounded contexts, event-driven architecture\n|MEDIUM (implementation delays, architectural inconsistencies)\n|HIGH (first DDD implementation)\n|• DDD training for development team (workshops, documentation) +\n• Architecture review sessions (validate bounded context design) +\n• Pair programming with experienced DDD practitioners +\n• Incremental implementation (start small, iterate) +\n• Document architectural patterns in CLAUDE.md\n\n|===\n\n== Assumptions and Constraints\n\n=== Assumptions\n\n[width=\"100%\",cols=\"8%,92%\",options=\"header\",]\n|===\n|ID |Assumption\n\n|ASM-CS-001\n|Viva Energy Salesforce admin team will provide Salesforce production access, sandbox environment, and support for Case field mapping and data isolation configuration\n\n|ASM-CS-002\n|App database Contact data is sufficiently complete for migration (email/phone/VCI available for matching)\n\n|ASM-CS-003\n|Expected customer feedback volume (100-150 submissions/day from 20k DAU) is well within Salesforce API rate limits, with capacity planning for 3x-10x growth\n\n|ASM-CS-004\n|Existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis) is sufficient for Event Bus implementation (no additional infrastructure provisioning required)\n\n|ASM-CS-005\n|Braze integration already exists and can be extended for Case-related push notifications (no new Braze account or major configuration changes)\n\n|ASM-CS-006\n|Mobile App users have email addresses associated with their accounts (required for ProfileService Contact reconciliation)\n\n|ASM-CS-007\n|D365 Customer Engagement historical Cases have limited business value and do not require migration to Salesforce\n\n|ASM-CS-008\n|Support agents are trained on Salesforce Service Cloud and require minimal additional training for OTR digital customer Cases\n\n|ASM-CS-009\n|Salesforce Service Cloud shared instance has capacity for OTR digital customer Contacts and Cases (no additional licensing or storage costs)\n\n|ASM-CS-010\n|Mobile App release schedule can accommodate cutover timing (Week 10 in migration plan)\n\n|===\n\n=== Constraints\n\n[width=\"100%\",cols=\"8%,92%\",options=\"header\",]\n|===\n|ID |Constraint\n\n|CON-CS-001\n|Must use shared Viva Energy Salesforce Service Cloud instance (cannot deploy separate OTR-specific instance)\n\n|CON-CS-002\n|Must conform to existing Salesforce configuration and governance (Record Types, custom fields, queues, data isolation strategy defined by Viva Energy admin team)\n\n|CON-CS-003\n|Contact migration must complete before Mobile App cutover (no parallel run of D365 CE and Salesforce)\n\n|CON-CS-004\n|Big bang cutover only (no phased rollout with feature flags or pilot users)\n\n|CON-CS-005\n|Salesforce API rate limits and authentication method constrained by Viva Energy Salesforce configuration (TBD)\n\n|CON-CS-006\n|Event Bus implementation must use existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis - cannot introduce new infrastructure components)\n\n|CON-CS-007\n|Mobile App feedback form must include specific fields: Category, Store Name, Time of Visit, Contact Phone Number, Free Text Message (no attachments)\n\n|CON-CS-008\n|D365 Customer Engagement must be decommissioned within 90 days post-cutover (ADR-CS-006)\n\n|CON-CS-009\n|ProfileService and EngagementService must be stateless (no local aggregate persistence, Salesforce is System of Record)\n\n|CON-CS-010\n|First DDD bounded context implementation (team learning curve, architectural patterns must be documented for future bounded contexts)\n\n|===\n\n== Non-Functional Requirements\n\n=== Performance Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-PERF-001\n|Mobile App feedback submission API response time (ProfileService + EngagementService)\n|p95 < 1 second, p99 < 2 seconds\n\n|NFR-PERF-002\n|ProfileService Contact reconciliation API response time (JIT lookup)\n|p95 < 500ms, p99 < 1 second\n\n|NFR-PERF-003\n|EngagementService async Case creation latency (end-to-end: feedback submitted → Case created in Salesforce)\n|p95 < 5 minutes, p99 < 10 minutes\n\n|NFR-PERF-004\n|Salesforce API call latency (Contact query, Contact create, Case create)\n|p95 < 2 seconds, p99 < 5 seconds\n\n|NFR-PERF-005\n|Event Bus message processing throughput\n|> 100 messages/second (support peak feedback volume)\n\n|NFR-PERF-006\n|Braze push notification delivery latency (Case created → notification delivered)\n|p95 < 30 seconds, p99 < 60 seconds\n\n|===\n\n=== Availability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-AVAIL-001\n|ProfileService availability\n|99.9% uptime (8.76 hours downtime/year)\n\n|NFR-AVAIL-002\n|EngagementService availability\n|99.9% uptime (8.76 hours downtime/year)\n\n|NFR-AVAIL-003\n|Feedback submission success rate (including async Case creation)\n|> 99.5% (includes retry logic for transient failures)\n\n|NFR-AVAIL-004\n|Graceful degradation: Salesforce downtime handling\n|Feedback submission still succeeds, Cases queued for async creation when Salesforce recovers\n\n|NFR-AVAIL-005\n|Graceful degradation: Braze downtime handling\n|Case creation proceeds, push notifications disabled temporarily (feature flag)\n\n|NFR-AVAIL-006\n|Planned maintenance window\n|< 4 hours/month, scheduled during low-traffic periods (2-6am ACST)\n\n|===\n\n=== Scalability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-SCALE-001\n|Concurrent Mobile App users (peak)\n|Support 20,000 DAU (Daily Active Users), ~150 concurrent users submitting feedback during peak hours\n\n|NFR-SCALE-002\n|Feedback submissions per day\n|Expected: 100-150 submissions/day based on 20k DAU (~0.5-0.75% submission rate) +\nCapacity: Support 500 submissions/day (3x expected volume for growth), 2,000 submissions/day (peak/incident scenarios)\n\n|NFR-SCALE-003\n|Auto-scaling: ProfileService and EngagementService\n|Auto-scale based on CPU/memory/request rate, scale up within 2 minutes\n\n|NFR-SCALE-004\n|Event Bus queue capacity\n|Support 100,000 queued messages (buffer for Salesforce downtime)\n\n|NFR-SCALE-005\n|Salesforce API rate limit compliance\n|Stay within 80% of Salesforce API rate limits (buffer for spikes)\n\n|NFR-SCALE-006\n|Future growth capacity\n|Architecture supports 10x growth (1,000-1,500 submissions/day based on 200k DAU) without major redesign\n\n|===\n\n=== Security Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-SEC-001\n|Mobile App authentication\n|Microsoft Entra External ID OAuth 2.0 with JWT tokens (existing CIAM)\n\n|NFR-SEC-002\n|API authorisation: ProfileService and EngagementService\n|JWT token validation, authenticated users only, user context propagation\n\n|NFR-SEC-003\n|Salesforce API authentication\n|OAuth 2.0 with Connected App and JWT bearer flow (service account)\n\n|NFR-SEC-004\n|Data encryption in transit\n|TLS 1.2+ for all API calls (Mobile App ↔ ProfileService/EngagementService ↔ Salesforce ↔ Braze)\n\n|NFR-SEC-005\n|Data encryption at rest\n|Salesforce encryption at rest (managed by Salesforce), Event Bus message encryption (AWS KMS)\n\n|NFR-SEC-006\n|Secret management\n|AWS Secrets Manager for Salesforce credentials, Braze API keys, OAuth tokens (no hardcoded secrets)\n\n|NFR-SEC-007\n|PII data handling\n|Contact data (email, phone, name) treated as PII, GDPR-compliant retention policies (Salesforce governance)\n\n|NFR-SEC-008\n|API rate limiting and throttling\n|API Gateway rate limiting (100 requests/second per user), prevent abuse and DoS\n\n|NFR-SEC-009\n|Logging and auditing\n|Log all API calls, Salesforce Contact/Case creates/updates, Event Bus publishes (no PII in logs)\n\n|NFR-SEC-010\n|Salesforce data isolation\n|Multi-tenant data isolation via Salesforce Record Types, queues, sharing rules (defined by Viva Energy admin team)\n\n|===\n\n=== Reliability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-REL-001\n|Retry logic: EngagementService → Salesforce Case creation\n|Exponential backoff (1s, 2s, 4s, 8s, 16s), max 5 retries, then dead letter queue\n\n|NFR-REL-002\n|Dead letter queue monitoring\n|Alert ops team immediately when DLQ depth > 0 (failed Case creations require manual intervention)\n\n|NFR-REL-003\n|Event Bus message durability\n|Messages persisted in Event Bus (SNS+SQS/EventBridge/Kinesis), not lost on service restart\n\n|NFR-REL-004\n|Idempotency: Case creation\n|EngagementService ensures duplicate feedback submissions don't create duplicate Cases (idempotency key)\n\n|NFR-REL-005\n|Circuit breaker: Salesforce API calls\n|Open circuit after 5 consecutive failures, half-open retry after 30 seconds\n\n|NFR-REL-006\n|Health checks: ProfileService and EngagementService\n|Health endpoints for load balancer checks, readiness and liveness probes\n\n|NFR-REL-007\n|Disaster recovery: Event Bus\n|Event Bus messages replicated across AWS availability zones (SQS/EventBridge/Kinesis HA)\n\n|===\n\n=== Maintainability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-MAINT-001\n|Code quality: ProfileService and EngagementService\n|> 80% test coverage (unit + integration tests), automated CI/CD pipeline\n\n|NFR-MAINT-002\n|API documentation\n|OpenAPI/Swagger specs for ProfileService and EngagementService, auto-generated API docs\n\n|NFR-MAINT-003\n|Deployment automation\n|Infrastructure as Code (Terraform/CloudFormation/CDK), zero-downtime deployments\n\n|NFR-MAINT-004\n|Logging: structured logs\n|JSON-formatted logs with correlation IDs, log levels (DEBUG, INFO, WARN, ERROR), centralized log aggregation\n\n|NFR-MAINT-005\n|Monitoring dashboards\n|Real-time dashboards for ProfileService, EngagementService, Event Bus (see Monitoring and Observability section)\n\n|NFR-MAINT-006\n|Alerting and on-call\n|PagerDuty/Opsgenie integration for P1/P2 alerts, on-call rotation for ops team\n\n|NFR-MAINT-007\n|Configuration management\n|Externalized configuration (environment variables, AWS Parameter Store), no hardcoded config\n\n|NFR-MAINT-008\n|Versioning: API and events\n|Semantic versioning (v1, v2), backward compatibility for API changes, event schema evolution\n\n|===\n\n=== Usability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-USE-001\n|Feedback submission UX\n|Mobile App user receives immediate \"Feedback submitted\" confirmation (< 1 second), not blocked by async Case creation\n\n|NFR-USE-002\n|Push notification delivery\n|Customer receives \"Your feedback has been received\" notification within 30 seconds of Case creation in Salesforce\n\n|NFR-USE-003\n|Case resolution notification\n|Customer receives \"Your case has been resolved\" notification within 30 seconds of support agent resolving Case\n\n|NFR-USE-004\n|Error messaging\n|User-friendly error messages for failed feedback submission (not technical errors), retry prompts\n\n|NFR-USE-005\n|Accessibility\n|Mobile App feedback form meets WCAG 2.1 AA accessibility standards (existing Mobile App compliance)\n\n|===\n\n=== Compliance Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-COMP-001\n|GDPR compliance: PII data\n|Customer Contact data (email, phone, name) managed per GDPR retention policies (Salesforce governance)\n\n|NFR-COMP-002\n|GDPR compliance: Right to erasure\n|Support \"Delete Account\" feedback category, trigger Contact deletion in Salesforce per GDPR Article 17\n\n|NFR-COMP-003\n|Data residency\n|Salesforce data residency governed by Viva Energy Salesforce configuration (regional compliance)\n\n|NFR-COMP-004\n|Audit trail\n|All Contact creates/updates, Case creates/updates logged for compliance auditing (Salesforce audit logs)\n\n|NFR-COMP-005\n|API security standards\n|OWASP API Security Top 10 compliance (injection prevention, authentication, authorisation, data exposure)\n\n|===\n\n== Monitoring and Observability\n\n=== Key Metrics\n\n[width=\"100%\",cols=\"25%,40%,35%\",options=\"header\",]\n|===\n|Metric Category |Metric |Target/Threshold\n\n|*Feedback Submission*\n|Feedback submission success rate (Mobile App → EngagementService)\n|> 99.5%\n\n|*Async Case Creation*\n|Case creation success rate (EngagementService → Salesforce)\n|> 99%\n\n|*Async Case Creation*\n|Case creation latency (time from feedback submission to Case created in Salesforce)\n|p95 < 5 minutes\n\n|*Event Bus*\n|Event Bus queue depth (pending Case creations)\n|< 100 messages\n\n|*Event Bus*\n|Dead letter queue depth (failed Case creations)\n|= 0 (alert on any failures)\n\n|*Salesforce API*\n|Salesforce API error rate\n|< 1%\n\n|*Salesforce API*\n|Salesforce API latency (Case creation)\n|p95 < 2 seconds\n\n|*Salesforce API*\n|Salesforce API rate limit utilization\n|< 80% of limit\n\n|*ProfileService*\n|Contact reconciliation success rate (JIT lookups)\n|> 99.5%\n\n|*ProfileService*\n|Contact reconciliation latency\n|p95 < 500ms\n\n|*Braze Notifications*\n|Push notification delivery rate (Case created/updated)\n|> 95%\n\n|*Salesforce Webhook*\n|Webhook delivery success rate (Salesforce → EngagementService)\n|> 99%\n\n|*Customer Satisfaction*\n|Customer satisfaction score (CSAT)\n|> 4.0/5.0 (improve by 15% from D365 CE baseline)\n\n|*Support Operations*\n|Average case resolution time\n|Decrease by 20% from D365 CE baseline\n\n|===\n\n=== Alerting Thresholds\n\n[width=\"100%\",cols=\"25%,50%,25%\",options=\"header\",]\n|===\n|Alert |Condition |Severity\n\n|*Feedback submission failures*\n|Feedback submission success rate < 95% over 5-minute window\n|P1 - Critical\n\n|*Dead letter queue accumulation*\n|Dead letter queue depth > 0 (any failed Case creations)\n|P2 - High\n\n|*Event Bus queue backlog*\n|Event Bus queue depth > 100 messages for > 15 minutes\n|P2 - High\n\n|*Salesforce API errors*\n|Salesforce API error rate > 5% over 5-minute window\n|P1 - Critical\n\n|*Salesforce API rate limits*\n|Salesforce API rate limit utilization > 90%\n|P2 - High\n\n|*Contact reconciliation failures*\n|ProfileService Contact reconciliation failure rate > 5% over 5-minute window\n|P2 - High\n\n|*Braze notification failures*\n|Braze push notification delivery rate < 80% over 15-minute window\n|P3 - Medium\n\n|*Salesforce webhook failures*\n|Salesforce webhook delivery success rate < 90% over 15-minute window\n|P2 - High\n\n|*Case creation latency*\n|Case creation latency p95 > 10 minutes\n|P3 - Medium\n\n|===\n\n=== Dashboards\n\n*ProfileService Dashboard:*\n\n* Contact reconciliation success rate (JIT lookups)\n* Contact reconciliation latency (p50, p95, p99)\n* Contact creation vs update ratio (new Contacts created vs existing Contacts updated)\n* Salesforce API error rate (Contact queries and creates)\n* Request rate and throughput\n\n*EngagementService Dashboard:*\n\n* Feedback submission success rate\n* Case creation success rate (async workflow)\n* Case creation latency (p50, p95, p99)\n* Event Bus queue depth (pending Case creations)\n* Dead letter queue depth (failed Case creations)\n* Salesforce API error rate (Case creation)\n* Salesforce API latency\n* Salesforce API rate limit utilization\n* Braze push notification delivery rate\n* Salesforce webhook delivery success rate\n\n*Event Bus Dashboard:*\n\n* Queue depth (pending messages)\n* Throughput (messages published/consumed per minute)\n* Dead letter queue depth (failed messages)\n* Consumer lag (time between publish and consume)\n\n*Customer Support Dashboard (Business Metrics):*\n\n* Total feedback submissions per day/week/month\n* Feedback category breakdown (App, Service, Order, Rewards, Refund, Delete Account)\n* Customer satisfaction score (CSAT) trend\n* Average case resolution time trend\n* Case volume by support team/queue\n* Unified customer view adoption (support agent feedback)\n<<<\n== Solution Validation\n\nThis section defines the validation criteria and testing approach for the solution.\n\n=== Functional Validation\n\n==== ProfileService API Testing\n\n*Test Scenarios*:\n1. **Happy Path**: Authenticated user requests Contact ID, existing Contact found in Salesforce, Contact ID returned\n2. **JIT Creation**: Authenticated user requests Contact ID, no existing Contact, new Contact created in Salesforce, Contact ID returned\n3. **Salesforce API Failure**: Salesforce unavailable, ProfileService returns 500 error, user retries\n4. **Invalid JWT**: Unauthenticated request, ProfileService returns 401 error\n\n*Acceptance Criteria*:\n- Contact reconciliation success rate > 99.5%\n- JIT Contact creation completes within 500ms (p95)\n\n==== EngagementService API Testing\n\n*Test Scenarios*:\n1. **Happy Path**: Valid feedback submission, immediate 202 Accepted response, Case created in Salesforce within 5 minutes, Braze notification delivered\n2. **Invalid Category**: Invalid feedback category, 400 Bad Request response with validation error\n3. **Salesforce Downtime**: Salesforce unavailable during async Case creation, message queued, retry logic executes, Case created when Salesforce recovers\n4. **Dead Letter Queue**: Case creation fails after 5 retries, message moved to DLQ, ops team alerted\n5. **Webhook Notification**: Support agent resolves Case in Salesforce, webhook triggers EngagementService, Braze push notification sent to customer\n\n*Acceptance Criteria*:\n- Feedback submission success rate > 99.5% (including async Case creation)\n- Async Case creation completes within 5 minutes (p95)\n- Webhook delivery success rate > 99%\n\n=== Non-Functional Validation\n\n==== Performance Testing\n\n*Load Testing*:\n\n*Baseline*: Expected 100-150 submissions/day from 20k DAU (~0.5-0.75% submission rate)\n\n- **Normal Load**: 1 submission/minute sustained for 2 hours (simulate typical daily pattern)\n- **3x Load**: 3 submissions/minute sustained for 1 hour (simulate busy period, 450 submissions/day)\n- **Peak Load (10x)**: 10 submissions/minute for 15 minutes (simulate incident scenario, app outage causing backlog)\n- **Stress Test**: 50 submissions/minute for 5 minutes (find breaking point, 20x normal)\n\n*Validation*:\n- API response time p95 < 1 second under 10x load\n- Event Bus queue depth remains manageable (< 100 messages)\n- No Case creation failures, all submissions processed successfully\n- Auto-scaling triggers appropriately for sustained load > 3x baseline\n\n*Acceptance Criteria*:\n- NFR-PERF-001 through NFR-PERF-006 validated under realistic load (3x and 10x baseline)\n- Auto-scaling triggers within 2 minutes of load increase\n- System handles 10x peak gracefully, 20x stress test identifies limits\n\n==== Resilience Testing\n\n*Salesforce API Failure Scenarios*:\n1. **Complete Outage**: Salesforce unavailable for 2 hours, Event Bus queues buffer work, Cases created when Salesforce recovers\n2. **Rate Limit Exceeded**: Salesforce rate limit hit, queue throttling activates, Cases created within SLA\n\n*Acceptance Criteria*:\n- NFR-AVAIL-004 validated (graceful degradation during Salesforce downtime)\n- Circuit breaker activates after 5 consecutive failures\n\n==== Security Validation\n\n*Penetration Testing*:\n- API authentication bypass attempts\n- SQL injection attempts\n- Webhook signature validation bypass\n\n*Acceptance Criteria*:\n- NFR-SEC-001 through NFR-SEC-010 validated\n- OWASP API Security Top 10 compliance verified\n\n=== Integration Validation\n\n==== End-to-End Testing\n\n*Full User Journey*:\n1. User authenticates via Microsoft Entra External ID\n2. Mobile App requests Contact ID from ProfileService (JIT reconciliation)\n3. User submits feedback via EngagementService\n4. Background worker creates Case in Salesforce\n5. Braze notification delivered to user\n6. Support agent resolves Case in Salesforce\n7. Salesforce webhook triggers EngagementService\n8. Braze notification delivered to user\n\n*Acceptance Criteria*:\n- End-to-end flow completes successfully in UAT\n- User receives both \"feedback submitted\" and \"case resolved\" notifications\n","structuredPatch":[{"oldStart":1823,"oldLines":14,"newStart":1823,"newLines":14,"lines":[" "," *Prerequisites*:"," ","-* WP-CS-001 (ProfileService Development) completed and deployed to dev/staging","-* WP-CS-002 (EngagementService Development) completed and deployed to dev/staging","+* <<wp-cs-001,WP-CS-001>> (ProfileService Development) completed and deployed to dev/staging","+* <<wp-cs-002,WP-CS-002>> (EngagementService Development) completed and deployed to dev/staging"," * ProfileService and EngagementService OpenAPI specifications finalized"," * Feature flag service configured"," "," *Dependent Work Packages*:"," ","-* Must complete after WP-CS-001 and WP-CS-002 (requires API endpoints available for integration testing)","+* Must complete after <<wp-cs-001,WP-CS-001>> and <<wp-cs-002,WP-CS-002>> (requires API endpoints available for integration testing)"," "," ==== Skills Required"," "]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"007591f8-8a23-42d8-b973-c6e663f8d425"}
{"parentUuid":"d26147c8-5bbb-4074-a22f-bcdfee819ba2","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01J7voefsC79TKXsC2FUVqA3","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Good! Now let me continue with the remaining work packages. Let me read the dependencies sections for WP-CS-006, WP-CS-007, WP-CS-008, WP-CS-009, and WP-CS-010.","signature":"EskCCkYICxgCKkC8dUP6Fe5IhOwqWJMPUIJY0tFuJvjRZ3Fhe0R7/eYcR8y3OPf0JPjcItFkCJ2mZAPsdxnU06Bte1KvtVsWVA3MEgwC4SfC49F5bauK8tkaDE6QC4Ok3h2VyrXjMyIwFERUVtYvDBJaL/Xqi5KLZkBtnrx4udr0TvdKRhyp2Y7V6CnjawduYZyouJ7LJYfgKrABNxvccBQ/8VsWIynTjuTjuvfiglwFWd2IJRdsPCE5NqtP+R5ml2G30P8FpXrEhNgItIJgbVrLeLVj21nQRjKZT1TC32BqXlcRhRFUM+LGXT+Iybb5S3cc4wJkqdHfrFuIVs9pVye4xv0bscudUmH3FUg3m+otxHiK/o4aDOpaE70ES5WKDGCOTpVxua1VPSa2G74zXq31N8k8x7qforyLJB6CXilz8J4PNWgDYtKapIEYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":2081,"cache_read_input_tokens":35908,"cache_creation":{"ephemeral_5m_input_tokens":2081,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CWw5811kRUyAerBAcLj5o","type":"assistant","uuid":"52aa6919-5512-42dd-a1fb-63c7a92affa7","timestamp":"2026-01-09T03:11:27.419Z"}
{"parentUuid":"52aa6919-5512-42dd-a1fb-63c7a92affa7","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01J7voefsC79TKXsC2FUVqA3","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01QhXc7KU2aGNuDCRiu5rT19","name":"Read","input":{"file_path":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","offset":1890,"limit":20}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":2081,"cache_read_input_tokens":35908,"cache_creation":{"ephemeral_5m_input_tokens":2081,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CWw5811kRUyAerBAcLj5o","type":"assistant","uuid":"98d5ea46-e363-48b7-9ba0-ca818bc061f4","timestamp":"2026-01-09T03:11:28.112Z"}
{"parentUuid":"98d5ea46-e363-48b7-9ba0-ca818bc061f4","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01J7voefsC79TKXsC2FUVqA3","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_018Pb1zYSHL7LyEmQkQymeto","name":"Read","input":{"file_path":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","offset":1970,"limit":20}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":2081,"cache_read_input_tokens":35908,"cache_creation":{"ephemeral_5m_input_tokens":2081,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CWw5811kRUyAerBAcLj5o","type":"assistant","uuid":"a62f22a5-cc67-481d-b1b6-0ba3a97fba1e","timestamp":"2026-01-09T03:11:28.873Z"}
{"parentUuid":"a62f22a5-cc67-481d-b1b6-0ba3a97fba1e","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01J7voefsC79TKXsC2FUVqA3","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01TyvfdpaL3ZuoUUci9TnRyt","name":"Read","input":{"file_path":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","offset":2030,"limit":20}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":2081,"cache_read_input_tokens":35908,"cache_creation":{"ephemeral_5m_input_tokens":2081,"ephemeral_1h_input_tokens":0},"output_tokens":380,"service_tier":"standard"}},"requestId":"req_011CWw5811kRUyAerBAcLj5o","type":"assistant","uuid":"78135dc2-7510-4066-8d10-83105a2282bb","timestamp":"2026-01-09T03:11:29.646Z"}
{"parentUuid":"98d5ea46-e363-48b7-9ba0-ca818bc061f4","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01QhXc7KU2aGNuDCRiu5rT19","type":"tool_result","content":"  1890→* Test results documentation\n  1891→** Test execution reports\n  1892→** Defect tracking and resolution\n  1893→** Performance test results\n  1894→\n  1895→==== Dependencies\n  1896→\n  1897→*Prerequisites*:\n  1898→\n  1899→* WP-CS-001 (ProfileService Development) completed\n  1900→* WP-CS-002 (EngagementService Development) completed\n  1901→* WP-CS-003 (Event Bus Infrastructure) completed\n  1902→* WP-CS-005 (Mobile App Integration) completed\n  1903→* WP-CS-007 (Salesforce Configuration) sandbox configuration completed\n  1904→\n  1905→*Dependent Work Packages*:\n  1906→\n  1907→* Must complete after WP-CS-001, WP-CS-002, WP-CS-003, WP-CS-005 (requires all components available)\n  1908→\n  1909→==== Skills Required\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"8118f077-0634-467e-a573-07a51835450b","timestamp":"2026-01-09T03:11:29.862Z","toolUseResult":{"type":"text","file":{"filePath":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","content":"* Test results documentation\n** Test execution reports\n** Defect tracking and resolution\n** Performance test results\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-001 (ProfileService Development) completed\n* WP-CS-002 (EngagementService Development) completed\n* WP-CS-003 (Event Bus Infrastructure) completed\n* WP-CS-005 (Mobile App Integration) completed\n* WP-CS-007 (Salesforce Configuration) sandbox configuration completed\n\n*Dependent Work Packages*:\n\n* Must complete after WP-CS-001, WP-CS-002, WP-CS-003, WP-CS-005 (requires all components available)\n\n==== Skills Required","numLines":20,"startLine":1890,"totalLines":3329}},"sourceToolAssistantUUID":"98d5ea46-e363-48b7-9ba0-ca818bc061f4"}
{"parentUuid":"a62f22a5-cc67-481d-b1b6-0ba3a97fba1e","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_018Pb1zYSHL7LyEmQkQymeto","type":"tool_result","content":"  1970→*Prerequisites*:\n  1971→\n  1972→* Viva Energy Salesforce admin team engagement\n  1973→* Salesforce governance approval (multi-tenant environment)\n  1974→* Technical decision on webhook mechanism (Platform Events vs Outbound Messages)\n  1975→* Technical decision on authentication method (OAuth 2.0 JWT bearer flow recommended)\n  1976→\n  1977→*Dependent Work Packages*:\n  1978→\n  1979→* None (can start in parallel with development work packages)\n  1980→* Required for WP-CS-002 (EngagementService needs field mapping)\n  1981→* Required for WP-CS-006 (Integration Testing needs sandbox configuration)\n  1982→\n  1983→==== Skills Required\n  1984→\n  1985→* Salesforce administration\n  1986→* Salesforce configuration (Record Types, Queues, Validation Rules)\n  1987→* Salesforce API integration (REST API, Platform Events, Outbound Messages)\n  1988→* Salesforce security and authentication (OAuth, Connected Apps)\n  1989→* Multi-tenant data isolation patterns\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"2d4eef58-0140-4623-ba12-686019f1c381","timestamp":"2026-01-09T03:11:29.862Z","toolUseResult":{"type":"text","file":{"filePath":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","content":"*Prerequisites*:\n\n* Viva Energy Salesforce admin team engagement\n* Salesforce governance approval (multi-tenant environment)\n* Technical decision on webhook mechanism (Platform Events vs Outbound Messages)\n* Technical decision on authentication method (OAuth 2.0 JWT bearer flow recommended)\n\n*Dependent Work Packages*:\n\n* None (can start in parallel with development work packages)\n* Required for WP-CS-002 (EngagementService needs field mapping)\n* Required for WP-CS-006 (Integration Testing needs sandbox configuration)\n\n==== Skills Required\n\n* Salesforce administration\n* Salesforce configuration (Record Types, Queues, Validation Rules)\n* Salesforce API integration (REST API, Platform Events, Outbound Messages)\n* Salesforce security and authentication (OAuth, Connected Apps)\n* Multi-tenant data isolation patterns","numLines":20,"startLine":1970,"totalLines":3329}},"sourceToolAssistantUUID":"a62f22a5-cc67-481d-b1b6-0ba3a97fba1e"}
{"parentUuid":"78135dc2-7510-4066-8d10-83105a2282bb","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01TyvfdpaL3ZuoUUci9TnRyt","type":"tool_result","content":"  2030→** Total Contacts migrated\n  2031→** Contacts created vs updated\n  2032→** Failed upserts (if any) with resolution\n  2033→** Matching accuracy metrics\n  2034→** Migration execution time\n  2035→\n  2036→==== Dependencies\n  2037→\n  2038→*Prerequisites*:\n  2039→\n  2040→* WP-CS-004 (Contact Migration Tooling) completed\n  2041→* WP-CS-001 (ProfileService Development) deployed to production (not yet integrated with Mobile App)\n  2042→* WP-CS-007 (Salesforce Configuration) production configuration completed\n  2043→* Salesforce production access granted\n  2044→* Migration approved by business stakeholders\n  2045→\n  2046→*Dependent Work Packages*:\n  2047→\n  2048→* Must complete after WP-CS-001, WP-CS-004, WP-CS-007\n  2049→* Must complete before WP-CS-009 (Production Deployment)\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"8fdccb1f-2c47-46e8-867b-17384c7c838a","timestamp":"2026-01-09T03:11:29.862Z","toolUseResult":{"type":"text","file":{"filePath":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","content":"** Total Contacts migrated\n** Contacts created vs updated\n** Failed upserts (if any) with resolution\n** Matching accuracy metrics\n** Migration execution time\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-004 (Contact Migration Tooling) completed\n* WP-CS-001 (ProfileService Development) deployed to production (not yet integrated with Mobile App)\n* WP-CS-007 (Salesforce Configuration) production configuration completed\n* Salesforce production access granted\n* Migration approved by business stakeholders\n\n*Dependent Work Packages*:\n\n* Must complete after WP-CS-001, WP-CS-004, WP-CS-007\n* Must complete before WP-CS-009 (Production Deployment)","numLines":20,"startLine":2030,"totalLines":3329}},"sourceToolAssistantUUID":"78135dc2-7510-4066-8d10-83105a2282bb"}
{"parentUuid":"8fdccb1f-2c47-46e8-867b-17384c7c838a","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01QFjhqmfewXogUPDos8HCMr","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now let me update these dependency sections with xrefs.","signature":"Et8BCkYICxgCKkBh9+Q0rWWuXxEwJHTONA9EJSJt4i1CBGkTxf72agcZ+Ee9GUYkjyuNyHLp/x3Roy8tOxIISStaaJ/rIpB8lXvPEgy0qdDGOe0EfSrPrrIaDNF8z86Px7FDN6AM6iIwnpFMtJncrX2vYB++h9ORt8IZ+fLgq+umK1kf/zle4O8vbkWH3169ZJqSzHTC7HrEKkefNu2s/7oP5e1oTUtfS2W8lyDd378atJ/z0x17MPJhLNuR6gQGzG3/mHyuSxwkUKhjrm/xV+nrOyalMp1klSsqq6GTjCY7fRgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":1648,"cache_read_input_tokens":37989,"cache_creation":{"ephemeral_5m_input_tokens":1648,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWw58Te98BTBDtaWYgTj2","type":"assistant","uuid":"f8a5d4d7-01c0-457b-969a-7460243888c0","timestamp":"2026-01-09T03:11:33.512Z"}
{"parentUuid":"f8a5d4d7-01c0-457b-969a-7460243888c0","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01QFjhqmfewXogUPDos8HCMr","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01WVhPgycJV4jjAZpG8PHnJQ","name":"Edit","input":{"replace_all":false,"file_path":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","old_string":"*Prerequisites*:\n\n* WP-CS-001 (ProfileService Development) completed\n* WP-CS-002 (EngagementService Development) completed\n* WP-CS-003 (Event Bus Infrastructure) completed\n* WP-CS-005 (Mobile App Integration) completed\n* WP-CS-007 (Salesforce Configuration) sandbox configuration completed\n\n*Dependent Work Packages*:\n\n* Must complete after WP-CS-001, WP-CS-002, WP-CS-003, WP-CS-005 (requires all components available)","new_string":"*Prerequisites*:\n\n* <<wp-cs-001,WP-CS-001>> (ProfileService Development) completed\n* <<wp-cs-002,WP-CS-002>> (EngagementService Development) completed\n* <<wp-cs-003,WP-CS-003>> (Event Bus Infrastructure) completed\n* <<wp-cs-005,WP-CS-005>> (Mobile App Integration) completed\n* <<wp-cs-007,WP-CS-007>> (Salesforce Configuration) sandbox configuration completed\n\n*Dependent Work Packages*:\n\n* Must complete after <<wp-cs-001,WP-CS-001>>, <<wp-cs-002,WP-CS-002>>, <<wp-cs-003,WP-CS-003>>, <<wp-cs-005,WP-CS-005>> (requires all components available)"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":1648,"cache_read_input_tokens":37989,"cache_creation":{"ephemeral_5m_input_tokens":1648,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWw58Te98BTBDtaWYgTj2","type":"assistant","uuid":"1e5f0096-da5f-40f5-a374-55314ced5a9c","timestamp":"2026-01-09T03:11:36.957Z"}
{"parentUuid":"1e5f0096-da5f-40f5-a374-55314ced5a9c","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01QFjhqmfewXogUPDos8HCMr","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Gtuej9iYhk7A6f3aPFaivt","name":"Edit","input":{"replace_all":false,"file_path":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","old_string":"* None (can start in parallel with development work packages)\n* Required for WP-CS-002 (EngagementService needs field mapping)\n* Required for WP-CS-006 (Integration Testing needs sandbox configuration)","new_string":"* None (can start in parallel with development work packages)\n* Required for <<wp-cs-002,WP-CS-002>> (EngagementService needs field mapping)\n* Required for <<wp-cs-006,WP-CS-006>> (Integration Testing needs sandbox configuration)"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":1648,"cache_read_input_tokens":37989,"cache_creation":{"ephemeral_5m_input_tokens":1648,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWw58Te98BTBDtaWYgTj2","type":"assistant","uuid":"fb740b3c-e0b1-49ca-8b00-b7ded5d86e2c","timestamp":"2026-01-09T03:11:38.718Z"}
{"parentUuid":"fb740b3c-e0b1-49ca-8b00-b7ded5d86e2c","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01QFjhqmfewXogUPDos8HCMr","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01TPFu29wg2xibjH9Wq5qbGz","name":"Edit","input":{"replace_all":false,"file_path":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","old_string":"*Prerequisites*:\n\n* WP-CS-004 (Contact Migration Tooling) completed\n* WP-CS-001 (ProfileService Development) deployed to production (not yet integrated with Mobile App)\n* WP-CS-007 (Salesforce Configuration) production configuration completed\n* Salesforce production access granted\n* Migration approved by business stakeholders\n\n*Dependent Work Packages*:\n\n* Must complete after WP-CS-001, WP-CS-004, WP-CS-007\n* Must complete before WP-CS-009 (Production Deployment)","new_string":"*Prerequisites*:\n\n* <<wp-cs-004,WP-CS-004>> (Contact Migration Tooling) completed\n* <<wp-cs-001,WP-CS-001>> (ProfileService Development) deployed to production (not yet integrated with Mobile App)\n* <<wp-cs-007,WP-CS-007>> (Salesforce Configuration) production configuration completed\n* Salesforce production access granted\n* Migration approved by business stakeholders\n\n*Dependent Work Packages*:\n\n* Must complete after <<wp-cs-001,WP-CS-001>>, <<wp-cs-004,WP-CS-004>>, <<wp-cs-007,WP-CS-007>>\n* Must complete before <<wp-cs-009,WP-CS-009>> (Production Deployment)"}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":1648,"cache_read_input_tokens":37989,"cache_creation":{"ephemeral_5m_input_tokens":1648,"ephemeral_1h_input_tokens":0},"output_tokens":1153,"service_tier":"standard"}},"requestId":"req_011CWw58Te98BTBDtaWYgTj2","type":"assistant","uuid":"95ef04e9-e6e0-4a11-968d-5eb893830301","timestamp":"2026-01-09T03:11:42.256Z"}
{"parentUuid":"1e5f0096-da5f-40f5-a374-55314ced5a9c","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01WVhPgycJV4jjAZpG8PHnJQ","type":"tool_result","content":"The file /mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n  1893→** Performance test results\n  1894→\n  1895→==== Dependencies\n  1896→\n  1897→*Prerequisites*:\n  1898→\n  1899→* <<wp-cs-001,WP-CS-001>> (ProfileService Development) completed\n  1900→* <<wp-cs-002,WP-CS-002>> (EngagementService Development) completed\n  1901→* <<wp-cs-003,WP-CS-003>> (Event Bus Infrastructure) completed\n  1902→* <<wp-cs-005,WP-CS-005>> (Mobile App Integration) completed\n  1903→* <<wp-cs-007,WP-CS-007>> (Salesforce Configuration) sandbox configuration completed\n  1904→\n  1905→*Dependent Work Packages*:\n  1906→\n  1907→* Must complete after <<wp-cs-001,WP-CS-001>>, <<wp-cs-002,WP-CS-002>>, <<wp-cs-003,WP-CS-003>>, <<wp-cs-005,WP-CS-005>> (requires all components available)\n  1908→\n  1909→==== Skills Required\n  1910→\n  1911→* Integration testing strategy and execution"}]},"uuid":"d38c99f3-15f1-4e3e-bcab-6f202fa32074","timestamp":"2026-01-09T03:11:42.430Z","toolUseResult":{"filePath":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","oldString":"*Prerequisites*:\n\n* WP-CS-001 (ProfileService Development) completed\n* WP-CS-002 (EngagementService Development) completed\n* WP-CS-003 (Event Bus Infrastructure) completed\n* WP-CS-005 (Mobile App Integration) completed\n* WP-CS-007 (Salesforce Configuration) sandbox configuration completed\n\n*Dependent Work Packages*:\n\n* Must complete after WP-CS-001, WP-CS-002, WP-CS-003, WP-CS-005 (requires all components available)","newString":"*Prerequisites*:\n\n* <<wp-cs-001,WP-CS-001>> (ProfileService Development) completed\n* <<wp-cs-002,WP-CS-002>> (EngagementService Development) completed\n* <<wp-cs-003,WP-CS-003>> (Event Bus Infrastructure) completed\n* <<wp-cs-005,WP-CS-005>> (Mobile App Integration) completed\n* <<wp-cs-007,WP-CS-007>> (Salesforce Configuration) sandbox configuration completed\n\n*Dependent Work Packages*:\n\n* Must complete after <<wp-cs-001,WP-CS-001>>, <<wp-cs-002,WP-CS-002>>, <<wp-cs-003,WP-CS-003>>, <<wp-cs-005,WP-CS-005>> (requires all components available)","originalFile":"= Salesforce Customer Support - Solution Architecture\n:project-name: Salesforce Customer Support\n:togaf-adm-phase: Phase E: Opportunities & Solutions\n:last-updated: 2026-01-07\n:document-type: Solution Architecture Document\n:status: Discovery\n:version: 0.1\n:domain: Customer Support & Engagement\n:programme-lead:\n:domain-architect: O.Young@otr.com.au\n:architecture-definition: xref:architecture-definitions:salesforce_customer_support.adoc[Architecture Definitions/Salesforce Customer Support]\n:doctype: article\n:toc: left\n:toclevels: 4\n:sectanchors:\n:sectlinks:\n:sectnums:\n:icons: font\n:source-highlighter: highlightjs\n:experimental:\n:description:\n:keywords:\n\n<<<\n== Purpose and Scope\n\n=== Purpose\n\nThis Solution Architecture defines how the Salesforce Customer Support consolidation will be implemented - the specific technology products, configurations, interfaces, and deployment architecture that realise the xref:architecture-definitions:salesforce_customer_support.adoc[Salesforce Customer Support Architecture Definition].\n\nThis solution establishes the **first implementation of OTR's target Domain-Driven Design (DDD) architecture** by deploying two new bounded contexts (`ProfileService` and `EngagementService`) as microservices, consolidating customer support onto Salesforce Service Cloud, and implementing event-driven integration patterns that will serve as the foundation for future bounded contexts (including Flybuys integration).\n\n=== Vision\n\n> Unify customer support across all OTRG channels by consolidating OTR digital customer feedback onto Salesforce Service Cloud, establishing the foundational DDD architecture with ProfileService and EngagementService bounded contexts that protect digital channels from external system changes while enabling support agents to deliver exceptional customer experiences with complete interaction history.\n\n=== Architectural Approach\n\nThis architecture establishes OTR's **first bounded context implementation** using Domain-Driven Design strategic patterns:\n\n* *link:../bounded_context/profile.adoc[ProfileService]* (NEW bounded context): Just-In-Time Contact reconciliation with Salesforce, upsert by email, returns Salesforce Contact ID to digital channels - foundation for future Flybuys partner linking\n* *link:../bounded_context/engagement.adoc[EngagementService]* (NEW bounded context): Customer feedback submission facade, Anti-Corruption Layer for Salesforce Case creation, Braze integration for all outbound customer communications (push, email, SMS), async Case processing via Event Bus\n* *Event-driven integration* (NEW pattern): Domain event publishing using existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis) - first implementation establishing pattern for future bounded contexts\n* *Anti-Corruption Layer*: EngagementService isolates digital channels from Salesforce API changes, translates between OTR domain language and Salesforce Service Cloud API\n* *Conformist Pattern*: ProfileService and EngagementService conform to existing Salesforce configuration (shared Viva Energy instance, multi-tenant governance)\n* *Big bang cutover*: Single deployment after Contact migration, no phased rollout, D365 CE retirement post-cutover\n\n=== Scope\n\n==== In Scope\n\n* Solution Building Blocks (SBBs) - specific technology products and versions\n* Interface specifications (APIs, events, data formats)\n* Data architecture and schema specifications\n* Deployment architecture and infrastructure configuration\n* Transition architecture with migration phases\n* Technical validation criteria and testing approach\n* External system integration specifications\n* Physical data models and API schemas\n\n==== Out of Scope\n\n===== Covered in xref:architecture-definitions:salesforce_customer_support.adoc[Architecture Definition]\n\n* Business requirements and stakeholder analysis\n* Architecture decisions and rationale (ADRs)\n* Bounded context definitions and responsibilities\n* High-level integration patterns (ACL, Conformist, OHS+PL)\n* Business capability mapping and value streams\n* Architecture principles and governance\n\n===== Covered in Other Documents\n\n* Detailed design (class diagrams, sequence diagrams for all flows)\n* Implementation code and unit tests\n* Business case and return-on-investment analysis\n* Operational run books and support procedures\n\n<<<\n=== Architecture Overview\n\n[mermaid]\n----\n---\nconfig:\n  layout: elk\n---\nflowchart TB\n    Customer([\"Customer\"]) -- Uses --> MobileApp[\"Mobile App<br>iOS/Android\"]\n    Customer -- Shops at --> POS[\"OTR/OTR+ POS<br>D365 Commerce\"]\n    MobileApp -- Authenticate --> EntraID[\"Microsoft Entra\"]\n    MobileApp -- Identifies & Reconciles --> ProfileService[\"ProfileService\"]\n    ProfileService <-- Reconcile App User as Salesforce Contact --> Salesforce[\"Salesforce\"]\n    ProfileService -- On Create --> EventBus[\"EventBus\"]\n    EventBus -- Emits CreateUser Event --> LoyaltyService[\"LoyaltyService\"] & EngagementService[\"EngagementService\"]\n    LoyaltyService -- Reconcile Wallet --> EagleEye[\"EagleEye\"]\n    EngagementService -- Reconcile Braze Profile --> Braze[\"Braze\"]\n    EngagementService --> Salesforce\n    D365CE[\"D365CE\"] -- Data Migration --> Salesforce\n    MobileApp -- Submits Feedback --> EngagementService\n\n    Customer:::customer\n    MobileApp:::presentation\n    POS:::presentation\n    EntraID:::external\n    ProfileService:::newService\n    Salesforce:::external\n    EventBus:::infrastructure\n    LoyaltyService:::newService\n    EngagementService:::newService\n    EagleEye:::external\n    Braze:::external\n    D365CE:::external\n    classDef newService fill:#4CAF50,stroke:#2E7D32,stroke-width:3px,color:#fff\n    classDef external fill:#FF9800,stroke:#E65100,stroke-width:2px,color:#fff\n    classDef infrastructure fill:#2196F3,stroke:#0D47A1,stroke-width:2px,color:#fff\n    classDef presentation fill:#9C27B0,stroke:#4A148C,stroke-width:2px,color:#fff\n    classDef customer fill:#607D8B,stroke:#263238,stroke-width:2px,color:#fff\n----\n\n\n==== Key Architectural Patterns\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Pattern |Application |Rationale\n\n|*Anti-Corruption Layer (ACL)*\n|EngagementService → Salesforce Service Cloud\n|Protects digital channels (Mobile App, Web) from Salesforce API changes, translates between OTR domain language and Salesforce Case/Contact model, enables independent evolution of internal domain model\n\n|*Conformist*\n|ProfileService → Salesforce, EngagementService → Salesforce\n|Shared Viva Energy Salesforce instance - we conform to existing configuration, governance, and API contracts (external system we don't control)\n\n|*Backend-for-Frontend (BFF)*\n|EngagementService\n|Aggregates customer feedback submission, Contact lookup, async Case creation, and Braze notification orchestration for digital channel clients\n\n|*Event-Driven Architecture (OHS+PL)*\n|Event Bus (SNS+SQS/EventBridge/Kinesis)\n|Loose coupling between bounded contexts, async domain event publishing (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`), foundation for future bounded contexts\n\n|*Just-In-Time (JIT) Integration*\n|ProfileService → Salesforce Contact reconciliation\n|Reconcile app users as Salesforce Contacts on-demand (upsert by email), no pre-sync required, ensures Salesforce has current Contact data\n\n|*Async Processing*\n|EngagementService Case creation via Event Bus\n|Non-blocking user experience, resilience to Salesforce downtime, automatic retry with exponential backoff, dead letter queue for operations team intervention\n\n|*Strangler Fig*\n|Not applicable\n|Big bang cutover (no gradual migration) - D365 CE fully replaced, not incrementally strangled\n\n|===\n\n<<<\n== Solution Approach\n\n* Deploy xref:bounded-contexts:profile.adoc[ProfileService] and xref:bounded-contexts:engagement.adoc[EngagementService] as bounded context microservices\n* Implement Anti-Corruption Layers (ACLs) for Salesforce and Braze integration\n* Establish event-driven architecture as the foundational integration pattern\n* Big bang cutover (TS-1 → TS-4)\n\n=== Related Documentation\n\nThis solution architecture references detailed technical specifications:\n\n==== Architecture Definition\n\n* xref:architecture-definitions:salesforce_customer_support.adoc[Salesforce Customer Support - Architecture Definition] - Business requirements, architecture decisions (ADRs), bounded context definitions, high-level integration patterns\n\n==== Bounded Context Specifications\n\n* xref:bounded-contexts:profile.adoc[ProfileService Bounded Context] - JIT Contact reconciliation, aggregate definitions\n* xref:bounded-contexts:engagement.adoc[EngagementService Bounded Context] - Customer feedback facade, Anti-Corruption Layer\n\n==== Interface Specifications\n\nDetailed API specifications available in the specifications directory:\n\n* link:../../specifications/rest/profile-service-v1.yaml[ProfileService REST API v1] - OpenAPI 3.0 specification for `/profile/v1` endpoints (includes Salesforce Contact reconciliation `GET /contact-id`)\n* link:../../specifications/rest/engagement-service-v1.yaml[EngagementService REST API v1] - OpenAPI 3.0 specification for `/engagement/v1` endpoints (includes `POST /feedback`)\n* link:../../specifications/events/engagement-events.json[Engagement Domain Events] - CloudEvents 1.0 JSON Schema for `SupportCaseCreated`, `SupportCaseUpdated`, `SupportCaseResolved`, `CustomerFeedbackSubmitted`\n\n==== External System Documentation\n\n* https://developer.salesforce.com/docs/atlas.en-us.api_rest.meta/api_rest/[Salesforce REST API Documentation] - Contact and Case object APIs\n* https://www.braze.com/docs/api/endpoints/messaging/send_messages/post_send_triggered_campaigns/[Braze Campaign Trigger API] - Push notification campaigns\n\n<<<\n== Executive Summary\n\n=== Challenge\n\nOTR digital customers (Mobile App, Web) currently submit feedback and support requests to D365 Customer Engagement, while Viva Energy's broader business units (fuel wholesale, Shell Card customers, other retail channels) use Salesforce Service Cloud. This creates:\n\n* *Fragmented customer support platform*: Customer support data split across two systems, preventing support agents from having a unified view of customer interactions across all channels\n* *Operational inefficiency*: Maintaining two separate customer support platforms increases operational overhead and costs\n* *Poor support experience*: D365 CE is not working well for digital customer support, impacting customer satisfaction and case resolution times\n* *Post-merger consolidation opportunity*: Following Viva Energy's acquisition of OTR, strategic alignment on Salesforce as the enterprise customer support platform\n\n=== Solution\n\nThis architecture establishes the **foundational Domain-Driven Design (DDD) implementation** for OTR's target state architecture by introducing two new bounded contexts (link:../bounded_context/profile.adoc[ProfileService], link:../bounded_context/engagement.adoc[EngagementService]) and event-driven integration patterns:\n\n==== New Bounded Contexts\n\n* *link:../bounded_context/profile.adoc[ProfileService]* (NEW): Just-In-Time (JIT) Contact reconciliation with Salesforce, upsert by email, returns Salesforce Contact ID to Mobile App\n* *link:../bounded_context/engagement.adoc[EngagementService]* (NEW): Customer feedback submission, Anti-Corruption Layer (ACL) for Salesforce Case creation, Braze integration for all outbound customer communications (push, email, SMS), async Case processing via Event Bus\n* *Event Bus* (NEW pattern): Domain event publishing using existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis) - first implementation of event-driven architecture pattern\n\n==== Integration Architecture\n\n* *Salesforce = System of Record*: Salesforce Service Cloud (shared Viva Energy instance) owns Contact and Case data\n* *Conformist Pattern*: ProfileService and EngagementService conform to existing Salesforce configuration and API contracts\n* *Anti-Corruption Layer*: EngagementService protects digital channels from Salesforce API changes, translates between OTR domain language and Salesforce\n* *Async Case Creation*: Non-blocking user experience, resilience to Salesforce downtime, automatic retry with exponential backoff, dead letter queue for failed Cases\n* *Event-Driven Notifications*: Salesforce webhook → EngagementService → Braze for all customer communications (push, email, SMS) on Case status updates\n\n==== Migration Approach\n\n* *Contact Migration*: One-time migration from app-specific database → Salesforce (upsert with flexible matching by email/phone/VCI)\n* *No Case Migration*: Historical D365 CE Cases not migrated (fresh start in Salesforce)\n* *Big Bang Cutover*: Single deployment, no phased rollout or parallel run\n* *D365 CE Retirement*: Complete decommissioning of D365 Customer Engagement post-cutover\n\n=== Key Architectural Significance\n\nThis migration establishes the first implementation of OTR's target DDD architecture:\n\n* First bounded contexts implemented (ProfileService, EngagementService)\n* First event-driven domain event pattern (foundation for future bounded contexts)\n* Foundation for Flybuys integration (ProfileService Contact reconciliation reused)\n* Establishes integration patterns (Conformist, ACL, Event-Driven) for future services\n\n=== Success Criteria\n\n* All digital customer feedback routed to Salesforce Service Cloud within 30 days of launch\n* Support agents have unified customer view across all Viva Energy channels (digital, wholesale, Shell Card, other retail)\n* D365 Customer Engagement decommissioned within 90 days post-cutover\n* Customer satisfaction score improves by 15% within 6 months\n* Average case resolution time decreases by 20% within 6 months\n* Zero data loss during Contact migration (100% validation pass rate)\n* Mobile App feedback submission success rate > 99.5% (including async Case creation)\n\n=== Technical Constraints\n\n* Shared Salesforce instance (Viva Energy multi-tenant environment)\n* Conform to existing Salesforce configuration and governance (data isolation strategy TBD with Salesforce admin team)\n* Contact migration must complete before cutover (no parallel run)\n* Async Case creation mandatory (non-blocking user experience)\n* Expected volume: 100-150 feedback submissions/day from 20k DAU (~0.5-0.75% submission rate), architecture capacity planned for 3x-10x growth\n\n=== Open Technical Decisions (TBD)\n\n* Salesforce Case field mapping for digital feedback categories (App, Service, Order, Rewards, Refund, Delete Account)\n* Salesforce data isolation strategy (Record Types, custom fields, queues)\n* Salesforce REST API authentication method (OAuth 2.0, Connected App, JWT bearer flow)\n* Salesforce webhook mechanism for Case updates (Outbound Messages, Platform Events, Process Builder)\n* Retry policy configuration (attempts, backoff intervals)\n* Salesforce API rate limit strategy (expected volume: 100-150 submissions/day from 20k DAU, capacity planning for 3x-10x growth)\n\n== Technical Requirements\n\n[width=\"100%\",cols=\"8%,92%\",options=\"header\",]\n|===\n|ID |Description\n\n|TR-CS-001\n|Every Mobile App user must have a Salesforce Contact record in Salesforce Service Cloud (shared Viva Energy instance)\n\n|TR-CS-002\n|ProfileService must reconcile Mobile App users as Salesforce Contacts using Just-In-Time (JIT) upsert by email address\n\n|TR-CS-003\n|ProfileService must return Salesforce Contact ID to Mobile App for feedback submission\n\n|TR-CS-004\n|Mobile App must support customer feedback submission with fields: Category (App, Service, Order, Rewards, Refund, Delete Account), Store Name, Time of Visit, Contact Phone Number, Free Text Message\n\n|TR-CS-005\n|EngagementService must create Salesforce Cases asynchronously via Event Bus (non-blocking user experience)\n\n|TR-CS-006\n|EngagementService must acknowledge feedback submission immediately to Mobile App user (\"Feedback submitted\" confirmation)\n\n|TR-CS-007\n|EngagementService must send push notification to customer via Braze when Case is successfully created in Salesforce\n\n|TR-CS-008\n|EngagementService must retry failed Case creation with configurable exponential backoff and dead letter queue for operations team intervention\n\n|TR-CS-009\n|Salesforce must be the System of Record for Contact and Case data (no local persistence in ProfileService or EngagementService)\n\n|TR-CS-010\n|Contact migration from app-specific database to Salesforce must complete before Mobile App cutover (upsert with flexible matching by email/phone/VCI)\n\n|TR-CS-011\n|No Case migration from D365 Customer Engagement to Salesforce (fresh start, historical Cases not migrated)\n\n|TR-CS-012\n|EngagementService must publish domain events (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`) to Event Bus for consumption by other bounded contexts\n\n|TR-CS-013\n|EngagementService must receive Salesforce webhook notifications when Cases are updated/resolved by support agents\n\n|TR-CS-014\n|EngagementService must trigger Braze push notifications to customers when Cases are updated/resolved (via Salesforce webhook → EngagementService → Braze)\n\n|TR-CS-015\n|ProfileService and EngagementService must conform to existing Salesforce configuration and API contracts (Conformist pattern)\n\n|TR-CS-016\n|All changes must be communicated using event-driven architecture via Event Bus (using existing AWS infrastructure: SNS+SQS/EventBridge/Kinesis)\n\n|TR-CS-017\n|Mobile App feedback submission success rate must exceed 99.5% (including async Case creation completion)\n\n|TR-CS-018\n|Contact migration must achieve 100% validation pass rate (zero data loss)\n\n|TR-CS-019\n|D365 Customer Engagement must be fully decommissioned within 90 days post-cutover\n\n|===\n\n== Technical Architecture\n\n=== Technical Capability Requirements\n\n==== Requirements Traceability\n\n[width=\"100%\",cols=\"15%,50%,35%\",options=\"header\",]\n|===\n|Requirement ID |Requirement Summary |Architectural Building Blocks\n\n|TR-CS-001\n|Every Mobile App user must have Salesforce Contact record\n|ABB-CS-001 (ProfileService), ABB-CS-004 (Salesforce), ABB-CS-007 (Contact Migration Tool)\n\n|TR-CS-002\n|ProfileService JIT Contact reconciliation via upsert by email\n|ABB-CS-001 (ProfileService), ABB-CS-004 (Salesforce)\n\n|TR-CS-003\n|ProfileService returns Salesforce Contact ID to Mobile App\n|ABB-CS-001 (ProfileService), ABB-CS-006 (Mobile App)\n\n|TR-CS-004\n|Mobile App supports feedback submission with structured fields\n|ABB-CS-006 (Mobile App), ABB-CS-002 (EngagementService)\n\n|TR-CS-005\n|EngagementService creates Salesforce Cases asynchronously\n|ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus), ABB-CS-004 (Salesforce)\n\n|TR-CS-006\n|EngagementService immediate acknowledgment to Mobile App\n|ABB-CS-002 (EngagementService), ABB-CS-006 (Mobile App)\n\n|TR-CS-007\n|EngagementService sends push notification via Braze on Case creation\n|ABB-CS-002 (EngagementService), ABB-CS-005 (Braze)\n\n|TR-CS-008\n|EngagementService retry logic with exponential backoff and DLQ\n|ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus)\n\n|TR-CS-009\n|Salesforce is System of Record for Contact and Case data\n|ABB-CS-004 (Salesforce), ABB-CS-001 (ProfileService - stateless), ABB-CS-002 (EngagementService - stateless)\n\n|TR-CS-010\n|Contact migration before Mobile App cutover\n|ABB-CS-007 (Contact Migration Tool), ABB-CS-004 (Salesforce)\n\n|TR-CS-011\n|No Case migration from D365 CE (fresh start)\n|ABB-CS-004 (Salesforce) - no migration tooling required\n\n|TR-CS-012\n|EngagementService publishes domain events to Event Bus\n|ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus)\n\n|TR-CS-013\n|EngagementService receives Salesforce webhook notifications\n|ABB-CS-002 (EngagementService), ABB-CS-004 (Salesforce)\n\n|TR-CS-014\n|EngagementService triggers Braze notifications on Case updates\n|ABB-CS-002 (EngagementService), ABB-CS-004 (Salesforce), ABB-CS-005 (Braze)\n\n|TR-CS-015\n|ProfileService and EngagementService conform to Salesforce config\n|ABB-CS-001 (ProfileService), ABB-CS-002 (EngagementService), ABB-CS-004 (Salesforce)\n\n|TR-CS-016\n|Event-driven architecture via Event Bus\n|ABB-CS-003 (Event Bus), ABB-CS-002 (EngagementService)\n\n|TR-CS-017\n|Mobile App feedback submission success rate > 99.5%\n|ABB-CS-006 (Mobile App), ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus), ABB-CS-004 (Salesforce)\n\n|TR-CS-018\n|Contact migration 100% validation pass rate\n|ABB-CS-007 (Contact Migration Tool), ABB-CS-004 (Salesforce)\n\n|TR-CS-019\n|D365 CE decommissioned within 90 days post-cutover\n|All ABBs (replacement system operational)\n\n|===\n\n=== Service Catalogues\n\n==== Application Portfolio Catalogue\n\n[width=\"100%\",cols=\"20%,15%,15%,15%,35%\",options=\"header\",]\n|===\n|Application |Lifecycle State |Owner |Hosting Platform |Description\n\n|*ProfileService*\n|NEW\n|OTR Platform Team\n|AWS (TBD: Lambda/ECS/EKS)\n|JIT Contact reconciliation with Salesforce, returns Salesforce Contact ID, foundation for Flybuys integration\n\n|*EngagementService*\n|NEW\n|OTR Platform Team\n|AWS (TBD: Lambda/ECS/EKS)\n|Customer feedback submission facade, ACL for Salesforce Case creation, Braze integration for all outbound communications (push, email, SMS), webhook receiver\n\n|*Mobile App (iOS)*\n|ACTIVE (UPDATE)\n|OTR Mobile Team\n|Apple App Store\n|iOS native app with feedback form, integrate with ProfileService and EngagementService APIs\n\n|*Mobile App (Android)*\n|ACTIVE (UPDATE)\n|OTR Mobile Team\n|Google Play Store\n|Android native app with feedback form, integrate with ProfileService and EngagementService APIs\n\n|*Salesforce Service Cloud*\n|ACTIVE (EXPAND)\n|Viva Energy Salesforce Admin Team\n|Salesforce (SaaS)\n|Shared Viva Energy instance, System of Record for Contact and Case data, adding OTR digital customer support\n\n|*Braze*\n|ACTIVE (EXTEND)\n|OTR Marketing Team\n|Braze (SaaS)\n|Marketing automation platform, EngagementService triggers push notifications for Case updates\n\n|*D365 Customer Engagement*\n|RETIRE\n|OTR Support Team\n|Microsoft Azure (SaaS)\n|Legacy customer support platform, decommissioned within 90 days post-cutover\n\n|*App-Specific Customer Database*\n|RETIRE\n|OTR Platform Team\n|AWS (RDS/DynamoDB)\n|Legacy customer contact storage, one-time migration to Salesforce, then deprecated\n\n|*Event Bus*\n|NEW\n|OTR Platform Team\n|AWS (SNS+SQS/EventBridge/Kinesis)\n|Domain event publishing infrastructure for bounded context integration\n\n|*Contact Migration Tool*\n|TEMPORARY\n|OTR Platform Team\n|AWS (Script/Lambda)\n|One-time migration app database → Salesforce with upsert logic, retired after migration complete\n\n|===\n\n==== Technology Capability Requirements\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Technology Capability |Implementation Technology (TBD in detailed design) |Requirements\n\n|*Microservice Hosting*\n|AWS Lambda / ECS / EKS\n|Host ProfileService and EngagementService with auto-scaling, high availability, monitoring\n\n|*API Gateway*\n|AWS API Gateway / Application Load Balancer\n|REST API routing, authentication, rate limiting, request validation for ProfileService and EngagementService\n\n|*Event Bus*\n|AWS SNS+SQS / EventBridge / Kinesis\n|Domain event publishing, async message processing, retry logic, dead letter queue\n\n|*Salesforce Integration*\n|Salesforce REST API / SOAP API\n|Contact CRUD operations, Case creation, webhook notifications, OAuth 2.0 authentication\n\n|*Braze Integration*\n|Braze REST API / SDK\n|Push notification campaign triggers, customer profile reconciliation\n\n|*Authentication & Authorisation*\n|Microsoft Entra External ID / AWS Cognito\n|Mobile App user authentication, API authorisation, JWT token validation\n\n|*Observability & Monitoring*\n|AWS CloudWatch / Datadog / New Relic\n|Application metrics, logs, traces, dashboards, alerting (feedback submission rate, queue depth, API errors)\n\n|*Secret Management*\n|AWS Secrets Manager / Parameter Store\n|Salesforce credentials, Braze API keys, OAuth tokens, encryption keys\n\n|*Database (Migration Tool)*\n|AWS RDS / DynamoDB (read-only access)\n|Contact migration from app-specific database\n\n|*CI/CD Pipeline*\n|GitHub Actions / AWS CodePipeline\n|Automated build, test, deployment for ProfileService, EngagementService, Mobile App\n\n|*Infrastructure as Code*\n|Terraform / AWS CloudFormation / CDK\n|Declarative infrastructure provisioning for Event Bus, microservices, monitoring\n\n|*API Documentation*\n|OpenAPI / Swagger\n|ProfileService and EngagementService API specifications for Mobile App integration\n\n|===\n\n==== Feature Flag Register\n\n*Note*: Per ADR-CS-006 (big bang cutover, not phased rollout), feature flags are minimal and used primarily for emergency rollback/kill switches.\n\n[width=\"100%\",cols=\"20%,15%,35%,30%\",options=\"header\",]\n|===\n|Feature Flag |Default State |Purpose |Rollback Scenario\n\n|*enable_salesforce_feedback_submission*\n|OFF (pre-cutover), ON (post-cutover)\n|Enable/disable feedback submission to EngagementService → Salesforce (kill switch for emergency rollback to D365 CE)\n|Feedback submission success rate < 95%, Salesforce API failures, critical bugs - revert to D365 CE integration\n\n|*enable_async_case_creation*\n|ON\n|Enable/disable async Case creation via Event Bus (fallback to synchronous processing if Event Bus issues)\n|Event Bus infrastructure failures, queue backlog unmanageable - temporary synchronous processing\n\n|*enable_braze_notifications*\n|ON\n|Enable/disable Braze push notifications for Case updates (degrade gracefully if Braze integration fails)\n|Braze API failures, notification delivery rate < 80% - disable notifications temporarily\n\n|*enable_jit_contact_reconciliation*\n|ON\n|Enable/disable ProfileService JIT Contact reconciliation (fallback to cached Contact IDs if Salesforce unavailable)\n|Salesforce API downtime, Contact reconciliation failures > 5% - use cached Contact IDs temporarily\n\n|*enable_salesforce_webhook_processing*\n|ON\n|Enable/disable Salesforce webhook processing for Case updates (fallback to polling if webhook failures)\n|Webhook delivery failures, authentication issues - temporary polling fallback\n\n|===\n\n*Feature Flag Management*:\n\n* Feature flags managed via AWS AppConfig / LaunchDarkly / custom feature flag service (TBD in detailed design)\n* Mobile App feature flags controlled server-side (no app release required for flag changes)\n* Backend service feature flags configured via environment variables / configuration service\n* Feature flag changes logged and audited (who changed, when, reason)\n* Post-cutover monitoring: Gradual removal of feature flags once system stability confirmed (30-60 days)\n\n==== Data Entity Catalogue\n\n[width=\"100%\",cols=\"20%,15%,35%,30%\",options=\"header\",]\n|===\n|Data Entity |System of Record |Key Attributes |Lifecycle\n\n|*Contact*\n|Salesforce Service Cloud\n|• Contact ID (Salesforce 15/18-char ID) +\n• Email (primary matching key) +\n• First Name, Last Name +\n• Phone Number +\n• Viva Consumer ID (VCI) +\n• Account (Viva Energy customer account) +\n• Record Type (OTR Digital vs other channels)\n|Created: ProfileService JIT reconciliation or Contact Migration Tool +\nUpdated: ProfileService JIT upsert (email changes), Salesforce (manual updates by support agents) +\nDeleted: Salesforce retention policy (GDPR/compliance)\n\n|*Case*\n|Salesforce Service Cloud\n|• Case Number (Salesforce auto-generated) +\n• Contact ID (reference to Contact) +\n• Subject (derived from Category) +\n• Description (Free Text Message) +\n• Category (App, Service, Order, Rewards, Refund, Delete Account) +\n• Store Name (OTR location) +\n• Time of Visit +\n• Status (New, In Progress, Resolved, Closed) +\n• Priority, Origin (Mobile App) +\n• Owner (support agent/queue)\n|Created: EngagementService async Case creation +\nUpdated: Support agents (Salesforce UI), EngagementService (webhook processing) +\nDeleted: Salesforce retention policy (archive after X years)\n\n|*Feedback Submission (transient)*\n|None (not persisted)\n|• Salesforce Contact ID +\n• Category +\n• Store Name +\n• Time of Visit +\n• Contact Phone Number +\n• Free Text Message\n|Created: Mobile App user submission +\nProcessed: EngagementService publishes to Event Bus, Case created in Salesforce +\nNot persisted in ProfileService/EngagementService (stateless)\n\n|*Domain Events*\n|Event Bus (ephemeral)\n|**SupportCaseCreated**: +\n• Case Number, Contact ID, Category, Timestamp +\n**SupportCaseUpdated**: +\n• Case Number, Status, Updated By, Timestamp +\n**SupportCaseResolved**: +\n• Case Number, Resolution, Resolved By, Timestamp +\n**CustomerFeedbackSubmitted**: +\n• Contact ID, Category, Timestamp\n|Published: EngagementService +\nConsumed: Other bounded contexts (future), Braze notification triggers +\nRetention: Short-lived (minutes to hours), not persisted for event sourcing\n\n|*Braze Customer Profile*\n|Braze\n|• External User ID (VCI or Email) +\n• Push Notification Tokens (iOS/Android) +\n• Notification Preferences +\n• Campaign Engagement History\n|Created/Updated: EngagementService on Case creation/update +\nManaged: Braze (external SaaS)\n\n|===\n\n*Data Migration Entities*:\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Source Entity |Target Entity |Migration Strategy\n\n|*App Database Contact*\n|Salesforce Contact\n|One-time migration via Contact Migration Tool: +\n• Upsert by email (primary), phone (secondary), VCI (tertiary) +\n• Map: Email → Email, Name → First/Last Name, Phone → Phone, VCI → External ID +\n• Validation: 100% data integrity check, reconciliation report\n\n|*D365 CE Case*\n|Not migrated\n|ADR-CS-005: No Case migration (fresh start in Salesforce) +\nD365 CE Cases archived separately for compliance if needed\n\n|===\n\n==== Data Quality & Validation\n\n*Contact Migration Validation Rules*:\n\n* Email format validation (RFC 5322 compliance)\n* Phone number format validation (E.164 international format)\n* VCI format validation (alphanumeric, length constraints)\n* Duplicate detection: Flag potential duplicates for manual review (same email/phone combination)\n* Mandatory fields: Email (required), First Name, Last Name (required for Salesforce Contact)\n\n*Case Creation Validation Rules*:\n\n* Contact ID must exist in Salesforce (validated by EngagementService before Case creation)\n* Category must be one of: App, Service, Order, Rewards, Refund, Delete Account\n* Free Text Message maximum length: 32,000 characters (Salesforce Case Description limit)\n* Store Name validated against OTR location master data (optional - warn if not found)\n\n<<<\n== Solution Building Blocks\n\nThis section defines the specific technology products, configurations, and implementation details for each Solution Building Block (SBB).\n\n=== Technology Portfolio Catalogue\n\n[width=\"100%\",cols=\"10%,20%,25%,25%,20%\",options=\"header\",]\n|===\n|SBB ID |Component |Technology Product |Version/Configuration |Deployment Platform\n\n|SBB-CS-001\n|ProfileService Microservice\n|.NET 8 / Node.js 20 LTS\n|RESTful API, containerised\n|AWS ECS Fargate / Lambda\n\n|SBB-CS-002\n|EngagementService Microservice\n|.NET 8 / Node.js 20 LTS\n|RESTful API, containerised, async workers\n|AWS ECS Fargate / Lambda\n\n|SBB-CS-003\n|Event Bus\n|AWS SNS + SQS / EventBridge\n|Standard queues, FIFO for ordering\n|AWS (managed service)\n\n|SBB-CS-004\n|API Gateway\n|AWS API Gateway / ALB\n|REST API, JWT validation\n|AWS (managed service)\n\n|SBB-CS-005\n|Salesforce Integration Layer\n|Salesforce REST API Client\n|OAuth 2.0 JWT bearer flow\n|Embedded in SBB-CS-001/002\n\n|SBB-CS-006\n|Braze Integration Layer\n|Braze REST API SDK\n|API key authentication\n|Embedded in SBB-CS-002\n\n|SBB-CS-007\n|Contact Migration Tool\n|Python 3.11 / .NET 8\n|One-time batch script\n|AWS Lambda / EC2\n\n|SBB-CS-008\n|Application Monitoring\n|AWS CloudWatch / Datadog\n|Metrics, logs, traces, dashboards\n|AWS / SaaS\n\n|SBB-CS-009\n|Secret Management\n|AWS Secrets Manager\n|KMS encryption\n|AWS (managed service)\n\n|SBB-CS-010\n|Mobile App (iOS)\n|SwiftUI, Kotlin Multiplatform\n|iOS 15+\n|Apple App Store\n\n|SBB-CS-011\n|Mobile App (Android)\n|Jetpack Compose, Kotlin Multiplatform\n|Android 8+\n|Google Play Store\n\n|SBB-CS-012\n|Feature Flag Service\n|AWS AppConfig / LaunchDarkly\n|Server-side flags, real-time updates\n|AWS / SaaS\n\n|===\n\n<<<\n== Data Architecture\n\nThis section defines the physical data models, event schemas, and API request/response formats.\n\n=== Domain Event Schemas\n\nAll domain events follow the https://cloudevents.io/[CloudEvents 1.0] specification for consistency and interoperability.\n\n*Event Schema Specifications*: See // TODO: Add to Antora - specifications/events/engagement-events.json[Engagement Service Event Schemas] for complete JSON schemas and examples.\n\n==== Event Catalogue\n\n[width=\"100%\",cols=\"30%,20%,50%\",options=\"header\",]\n|===\n|Event Type |Publisher |Description\n\n|`SupportCaseCreated`\n|EngagementService\n|Published when EngagementService successfully creates a Case in Salesforce after async processing\n\n|`SupportCaseUpdated`\n|EngagementService (via Salesforce webhook)\n|Published when a support agent updates a Case in Salesforce (status, priority, comment changes)\n\n|`SupportCaseResolved`\n|EngagementService (via Salesforce webhook)\n|Published when a support agent resolves/closes a Case in Salesforce\n\n|`CustomerFeedbackSubmitted`\n|EngagementService\n|Published when customer submits feedback via Mobile App (before async Case creation)\n\n|===\n\n*Event Format*: All events use CloudEvents 1.0 envelope with event-specific payload in the `data` field.\n\n*Schema Location*: `specifications/events/engagement-events.json`\n\n=== API Request/Response Schemas\n\n==== ProfileService: GET /profile/contact-id\n\n*Response* (200 OK):\n[source,json]\n----\n{\n  \"contactId\": \"0034X00000ABCDEFG\",\n  \"email\": \"customer@example.com\",\n  \"firstName\": \"John\",\n  \"lastName\": \"Smith\"\n}\n----\n\n==== EngagementService: POST /feedback\n\n*Request*:\n[source,json]\n----\n{\n  \"contactId\": \"0034X00000ABCDEFG\",\n  \"category\": \"App\",\n  \"storeName\": \"OTR Adelaide\",\n  \"timeOfVisit\": \"2026-01-07T12:00:00Z\",\n  \"contactPhoneNumber\": \"+61412345678\",\n  \"message\": \"App crashed when submitting feedback\"\n}\n----\n\n*Response* (202 Accepted):\n[source,json]\n----\n{\n  \"feedbackId\": \"fb-2026-01-07-12345\",\n  \"status\": \"submitted\",\n  \"message\": \"Your feedback has been submitted!\"\n}\n----\n\n=== Salesforce Field Mappings\n\n==== Case Object Mapping\n\n[width=\"100%\",cols=\"25%,25%,25%,25%\",options=\"header\",]\n|===\n|OTR Field |Salesforce Field |Data Type |Notes\n\n|Category\n|Feedback_Category__c\n|Picklist\n|App, Service, Order, Rewards, Refund, Delete Account\n\n|Store Name\n|Store_Name__c\n|String (255)\n|OTR location name\n\n|Time of Visit\n|Time_of_Visit__c\n|DateTime\n|When customer visited store\n\n|Free Text Message\n|Description\n|Long Text (32,000)\n|Customer feedback message\n\n|===\n\n<<<\n=== Baseline Architecture\n\n==== Existing System Components\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Component |Current State |Status\n\n|*D365 Customer Engagement*\n|Customer support platform for OTR digital customers (Mobile App, Web), handles feedback submission and case management\n|**DEPRECATED** - Being replaced by Salesforce Service Cloud\n\n|*App-Specific Customer Database*\n|Stores customer contact data for Mobile App users, separate from Viva Energy systems\n|**MIGRATING** - One-time migration to Salesforce, then deprecated\n\n|*Mobile App*\n|iOS/Android native apps with feedback submission form including Category, Store Name, Time of Visit, Contact Phone Number, and Free Text Message fields\n|**REQUIRES UPDATE** - Integrate with ProfileService and EngagementService APIs (feedback form UI already complete)\n\n|*Salesforce Service Cloud*\n|Shared Viva Energy instance handling customer support for fuel wholesale, Shell Card customers, other retail channels\n|**EXPANDING** - Adding OTR digital customer support Cases and Contacts\n\n|*Existing AWS Infrastructure*\n|SNS+SQS / EventBridge / Kinesis available for event-driven architecture\n|**REUSING** - Event Bus implementation leverages existing infrastructure\n\n|===\n\n==== Integration Architecture\n\n*Current state:*\n\n* Mobile App → D365 Customer Engagement (direct integration)\n* App-specific customer database → standalone (no Salesforce integration)\n* No event-driven architecture (synchronous, tightly coupled)\n* No Anti-Corruption Layer protecting digital channels\n* Viva Energy support teams use Salesforce, OTR digital support uses D365 CE (fragmented)\n\n==== Technical Debt\n\n*No longer relevant* - D365 CE being deprecated, not documenting technical debt of system being retired.\n\n*New technical debt introduced by this migration:*\n\n* Salesforce field mapping TBD (requires coordination with Viva Energy Salesforce admin team)\n* Data isolation strategy TBD (Record Types, custom fields, queues - multi-tenant governance)\n* Salesforce webhook mechanism TBD (Outbound Messages vs Platform Events vs Process Builder)\n* Expected feedback volume unknown (gathering data for rate limit planning)\n\n=== Gap Analysis\n\n==== Missing Capabilities\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Missing Capability |Description\n\n|*ProfileService bounded context*\n|No existing service for Contact reconciliation with Salesforce - requires new microservice implementing JIT upsert by email, returning Salesforce Contact ID\n\n|*EngagementService bounded context*\n|No existing service for customer feedback facade - requires new microservice implementing Anti-Corruption Layer for Salesforce Case creation, Braze integration, async processing via Event Bus\n\n|*Event Bus domain event pattern*\n|No existing domain event publishing infrastructure - requires implementing event-driven architecture pattern using existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis)\n\n|*Async Case creation workflow*\n|Current D365 CE integration is synchronous - requires implementing async processing with retry logic, exponential backoff, dead letter queue\n\n|*Salesforce webhook integration*\n|No existing capability to receive Salesforce notifications - requires implementing webhook receiver in EngagementService for Case update notifications\n\n|*Braze push notification orchestration*\n|No existing integration for Case-related push notifications - requires implementing Braze campaign triggers from EngagementService\n\n|*Contact migration tooling*\n|No existing tooling for app database → Salesforce Contact migration with upsert logic (match by email/phone/VCI)\n\n|*Feedback form enhancements*\n|Mobile App feedback form lacks structured fields (Category, Store Name, Time of Visit, Contact Phone Number) - requires UI updates\n\n|===\n\n==== Missing Bounded Contexts\n\n[width=\"100%\",cols=\"30%,30%,40%\",options=\"header\",]\n|===\n|Bounded Context |Responsibilities |Implementation Status\n\n|*link:../bounded_context/profile.adoc[ProfileService]*\n|JIT Contact reconciliation with Salesforce (upsert by email), return Salesforce Contact ID to digital channels, foundation for future Flybuys partner linking\n|**NEW** - First bounded context implementation\n\n|*link:../bounded_context/engagement.adoc[EngagementService]*\n|Customer feedback submission facade, Anti-Corruption Layer for Salesforce Case creation, Braze integration for push notifications, async Case processing, webhook receiver for Case updates\n|**NEW** - First bounded context implementation\n\n|===\n\n==== Missing Integration Patterns\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Integration Pattern |Description\n\n|*Anti-Corruption Layer (ACL)*\n|EngagementService → Salesforce Service Cloud - protects digital channels from Salesforce API changes, translates between OTR domain language and Salesforce\n\n|*Conformist*\n|ProfileService/EngagementService → Salesforce - conform to existing Salesforce configuration and API contracts (shared Viva Energy instance)\n\n|*Event-Driven Architecture (OHS+PL)*\n|Event Bus publishing domain events (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`) for loose coupling between bounded contexts\n\n|*Just-In-Time (JIT) Integration*\n|ProfileService → Salesforce Contact reconciliation on-demand (no pre-sync)\n\n|*Async Processing*\n|EngagementService Case creation via Event Bus with retry, exponential backoff, dead letter queue\n\n|===\n\n=== Target State Architecture\n\n==== Architectural Building Blocks (ABB)\n\n[width=\"100%\",cols=\"20%,25%,30%,25%\",options=\"header\",]\n|===\n|ABB ID |Bounded Context |Responsibilities |Technology (TBD in Solution Architecture)\n\n|ABB-CS-001\n|*link:../bounded_context/profile.adoc[ProfileService]*\n|JIT Contact reconciliation with Salesforce (upsert by email), return Salesforce Contact ID, foundation for Flybuys partner linking\n|Microservice (.NET/Node.js), REST API, Salesforce REST API client\n\n|ABB-CS-002\n|*link:../bounded_context/engagement.adoc[EngagementService]*\n|Customer feedback submission facade, ACL for Salesforce Case creation, Braze integration, async processing, webhook receiver\n|Microservice (.NET/Node.js), REST API, Event Bus publisher/subscriber, Salesforce webhook receiver\n\n|ABB-CS-003\n|*Event Bus*\n|Domain event publishing infrastructure (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`)\n|AWS SNS+SQS / EventBridge / Kinesis\n\n|ABB-CS-004\n|*Salesforce Service Cloud*\n|System of Record for Contact and Case data (shared Viva Energy instance)\n|Salesforce Service Cloud (external SaaS)\n\n|ABB-CS-005\n|*Braze*\n|Marketing automation platform for push notifications\n|Braze (external SaaS) - existing integration\n\n|ABB-CS-006\n|*Mobile App*\n|iOS/Android native apps with enhanced feedback form (Category, Store Name, Time of Visit, Contact Phone Number, Free Text Message)\n|Kotlin Multiplatform, SwiftUI, Jetpack Compose\n\n|ABB-CS-007\n|*Contact Migration Tool*\n|One-time migration app database → Salesforce with upsert logic (match by email/phone/VCI)\n|Script/tool (.NET/Python/Node.js)\n\n|===\n\n==== Integration Architecture\n\n===== Integration Flows\n\n*Customer Feedback Submission (Async):*\n\n1. *Mobile App* → ProfileService: Authenticate user, get Salesforce Contact ID (JIT reconciliation)\n2. *Mobile App* → EngagementService: Submit feedback (POST /feedback with Contact ID, Category, Store Name, Time of Visit, Phone, Message)\n3. *EngagementService* → Mobile App: Immediate acknowledgment (\"Feedback submitted\")\n4. *EngagementService* → Event Bus: Publish work item for async Case creation\n5. *Background Worker* (EngagementService) → Salesforce: Create Case via REST API\n6. *Success*: EngagementService → Event Bus: Publish `SupportCaseCreated` event\n7. *EngagementService* → Braze: Trigger push notification campaign (\"Your feedback has been received, Case #12345\")\n8. *Failure*: Retry with exponential backoff → Dead Letter Queue → Ops team alert\n\n*Case Update Notification (Bidirectional):*\n\n1. *Support Agent* updates/resolves Case in Salesforce\n2. *Salesforce* → EngagementService: Webhook notification (Case updated)\n3. *EngagementService* → Event Bus: Publish `SupportCaseUpdated` or `SupportCaseResolved` event\n4. *EngagementService* → Braze: Trigger push notification campaign (\"Your case has been resolved\")\n\n*Contact Reconciliation (JIT):*\n\n1. *Mobile App user* authenticates\n2. *Mobile App* → ProfileService: GET /profile/contact-id\n3. *ProfileService* → Salesforce: Query Contact by email\n4. *Match found*: Return existing Salesforce Contact ID\n5. *No match*: Create new Contact in Salesforce, return new Contact ID\n6. *ProfileService* → Mobile App: Return Salesforce Contact ID (cached by Mobile App)\n\n===== System of Record Boundaries\n\n[width=\"100%\",cols=\"30%,35%,35%\",options=\"header\",]\n|===\n|Data Entity |System of Record |Rationale\n\n|*Contact*\n|Salesforce Service Cloud\n|Shared Viva Energy instance, unified customer profile across all channels (digital, wholesale, Shell Card, retail)\n\n|*Case*\n|Salesforce Service Cloud\n|Support agents manage Cases in Salesforce, digital channels submit via EngagementService ACL\n\n|*Feedback Submission (transient)*\n|None (no persistence)\n|EngagementService processes feedback and creates Case in Salesforce, no local storage\n\n|*Domain Events*\n|Event Bus (ephemeral)\n|Events published to Event Bus, consumed by subscribers, not persisted long-term (event sourcing not in scope)\n\n|===\n\n==== Data Architecture Principles\n\n===== Aggregate Persistence\n\n*ProfileService:*\n\n* **No local aggregate persistence** - ProfileService is stateless, queries Salesforce on-demand\n* Salesforce Contact is the aggregate root (owned by Salesforce)\n* ProfileService acts as facade/translator, not system of record\n\n*EngagementService:*\n\n* **No local aggregate persistence** - EngagementService is stateless, creates Cases in Salesforce via ACL\n* Salesforce Case is the aggregate root (owned by Salesforce)\n* EngagementService maintains no local Case state (Conformist pattern - trust Salesforce as source of truth)\n* Async processing state managed via Event Bus (work items in queue, not database)\n\n===== Event Store\n\n* **Event Bus** (SNS+SQS/EventBridge/Kinesis) handles domain event publishing\n* Events are **ephemeral** (consumed and discarded, not persisted for event sourcing)\n* No Event Store implementation in this architecture (future enhancement if needed)\n* Event schema versioning TBD in Solution Architecture\n\n\n=== Architecture Decisions\n\n==== ADR-CS-001: Consolidate onto Salesforce Service Cloud (not build custom solution)\n\n*Status*: Accepted\n\n*Context*:\n\n* D365 Customer Engagement not working well for digital customer support\n* Viva Energy already uses Salesforce Service Cloud for fuel wholesale, Shell Card, other retail channels\n* Post-merger opportunity to consolidate onto single platform\n* Alternative: Build custom support platform or use different SaaS\n\n*Decision*:\n\nConsolidate OTR digital customer support onto Salesforce Service Cloud (shared Viva Energy instance).\n\n*Rationale*:\n\n* **Unified customer view**: Support agents see all interactions across channels (digital, wholesale, Shell Card, retail)\n* **Platform consolidation**: Single support platform reduces operational overhead and costs\n* **Proven solution**: Salesforce Service Cloud is established, feature-rich, well-supported\n* **Post-merger alignment**: Strategic decision to standardize on Viva Energy platforms\n* **Avoid custom development**: Building custom support platform would be costly and high-risk\n\n*Consequences*:\n\n* Unified customer support across Viva Energy Group\n* Reduced operational complexity (single platform vs two)\n* Leverage Salesforce capabilities (case routing, knowledge base, AI, omnichannel)\n* ⚠️ Conformist pattern required (shared instance, conform to existing configuration)\n* ⚠️ Multi-tenant governance needed (data isolation, security, queues)\n* ❌ Less control over platform evolution (SaaS vendor, shared instance)\n\n==== ADR-CS-002: Implement ProfileService and EngagementService as first DDD bounded contexts\n\n*Status*: Accepted\n\n*Context*:\n\n* OTR target architecture uses Domain-Driven Design with bounded contexts\n* This migration is opportunity to establish first implementation\n* Alternative: Direct Mobile App → Salesforce integration (no bounded contexts)\n* Alternative: Single monolithic service for all customer-facing APIs\n\n*Decision*:\n\nImplement ProfileService and EngagementService as separate bounded contexts following DDD strategic patterns.\n\n*Rationale*:\n\n* **Foundation for target architecture**: First implementation of DDD pattern for future bounded contexts (Flybuys, LocationService, PaymentService)\n* **Separation of concerns**: ProfileService handles identity/Contact reconciliation, EngagementService handles support/feedback (different responsibilities, different change rates)\n* **Anti-Corruption Layer**: EngagementService protects digital channels from Salesforce API changes\n* **Reusability**: ProfileService Contact reconciliation reused for Flybuys integration\n* **Event-driven architecture**: Establishes pattern for loose coupling between bounded contexts\n\n*Consequences*:\n\n* Establishes DDD architecture foundation for OTR\n* Reusable ProfileService for Flybuys and future integrations\n* Digital channels protected from Salesforce API changes (ACL)\n* Clear bounded context boundaries and responsibilities\n* ⚠️ Increased initial complexity (two new microservices vs direct integration)\n* ⚠️ Requires Event Bus infrastructure implementation\n* ⚠️ Team must learn DDD patterns and bounded context design\n\n==== ADR-CS-003: Async Case creation via Event Bus (not synchronous)\n\n*Status*: Accepted\n\n*Context*:\n\n* Current D365 CE integration is synchronous (user waits for Case creation)\n* Alternative: Keep synchronous integration (Mobile App → EngagementService → Salesforce synchronously)\n* Salesforce API may experience downtime or latency\n\n*Decision*:\n\nImplement async Case creation via Event Bus with immediate user acknowledgment, retry logic, exponential backoff, and dead letter queue.\n\n*Rationale*:\n\n* **Non-blocking user experience**: User gets immediate \"Feedback submitted\" confirmation, not waiting for Salesforce API\n* **Resilience**: If Salesforce is down, feedback still accepted, Case created when Salesforce recovers\n* **Retry logic**: Automatic retry with exponential backoff handles transient failures\n* **Operational visibility**: Dead letter queue alerts ops team to persistent failures\n* **Scalability**: Queue buffering handles traffic spikes\n\n*Consequences*:\n\n* Better user experience (no waiting for Salesforce API)\n* Resilient to Salesforce downtime (queue buffers work)\n* Automatic retry reduces manual intervention\n* Queue depth monitoring provides operational visibility\n* ⚠️ Eventual consistency (user gets success notification after Case created, not immediately)\n* ⚠️ Increased complexity (Event Bus, background workers, retry logic, DLQ)\n* ⚠️ Requires monitoring and alerting for DLQ\n\n==== ADR-CS-004: ProfileService uses email as primary matching key (not VCI)\n\n*Status*: Accepted\n\n*Context*:\n\n* ProfileService needs to reconcile Mobile App users as Salesforce Contacts\n* Alternative matching keys: VCI (Viva Consumer ID), email, phone, Salesforce External ID\n* Email changes are rare but possible\n\n*Decision*:\n\nUse email address as primary matching key for Contact reconciliation (JIT upsert by email).\n\n*Rationale*:\n\n* **Availability**: Email always available for authenticated users\n* **Uniqueness**: Email is unique identifier in Salesforce and Mobile App\n* **Salesforce standard**: Salesforce Contact uses email as standard lookup field\n* **Simplicity**: Single matching key simplifies upsert logic\n* **Edge case acceptable**: Email changes are rare, manual cleanup acceptable\n\n*Consequences*:\n\n* Simple upsert logic (query by email, create if not found)\n* Leverages Salesforce standard email field\n* Email always available from authentication\n* ⚠️ Email changes create duplicate Contacts (rare edge case, manual cleanup)\n* ⚠️ Future enhancement: Add VCI as Salesforce External ID for stable matching\n\n==== ADR-CS-005: No Case migration from D365 CE (fresh start)\n\n*Status*: Accepted\n\n*Context*:\n\n* D365 CE contains historical customer support Cases\n* Alternative: Migrate historical Cases to Salesforce (preserve support history)\n* Alternative: Archive D365 CE Cases separately (read-only access)\n\n*Decision*:\n\nDo not migrate historical Cases from D365 CE to Salesforce. Start fresh in Salesforce.\n\n*Rationale*:\n\n* **Limited value**: Historical D365 CE Cases not critical for future support\n* **Data quality**: D365 CE Case data may be inconsistent or incomplete\n* **Complexity**: Case migration requires mapping D365 CE schema to Salesforce, data transformation, validation\n* **Cost-benefit**: Migration effort outweighs value of historical data\n* **Archive option**: D365 CE Cases can be archived separately if needed (read-only access for auditing)\n\n*Consequences*:\n\n* Simpler migration (Contacts only, no Case migration)\n* Faster time to value (no Case migration delay)\n* Clean start in Salesforce (no legacy data quality issues)\n* ⚠️ Historical Cases not visible in Salesforce (support agents can't see old Cases)\n* ⚠️ D365 CE must remain accessible temporarily for historical Case lookups (if needed)\n* ❌ Loss of historical Case insights (reporting, analytics on old Cases)\n\n==== ADR-CS-006: Big bang cutover (not phased rollout)\n\n*Status*: Accepted\n\n*Context*:\n\n* Alternative: Phased rollout with feature flags (pilot users first, gradual enablement)\n* Alternative: Parallel run (submit to both D365 CE and Salesforce temporarily)\n* Flybuys integration uses phased rollout (AS-1, AS-2, AS-3 architecture states)\n\n*Decision*:\n\nBig bang cutover - migrate Contacts, deploy ProfileService and EngagementService, switch Mobile App, retire D365 CE.\n\n*Rationale*:\n\n* **Simplicity**: No parallel run complexity, no feature flag management\n* **Faster D365 CE retirement**: No extended transition period maintaining two systems\n* **Limited risk**: Customer support not mission-critical (not payment processing), rollback possible\n* **User base manageable**: OTR digital customers smaller than Flybuys integration scope\n* **Different use case**: Flybuys phased rollout manages points accrual complexity, support feedback is simpler\n\n*Consequences*:\n\n* Simpler deployment (single cutover, no AS-1/AS-2/AS-3 states)\n* Faster D365 CE retirement (no extended parallel run)\n* No feature flag complexity or pilot user management\n* ⚠️ Higher cutover risk (all users switch at once)\n* ⚠️ Requires comprehensive testing before cutover\n* ⚠️ Rollback plan required (revert to D365 CE if critical issues)\n\n==== ADR-CS-007: EngagementService receives Salesforce webhooks for Case updates\n\n*Status*: Accepted\n\n*Context*:\n\n* Support agents update/resolve Cases in Salesforce\n* Need to notify customers of Case status changes via push notifications\n* Alternative: Poll Salesforce API for Case updates (inefficient)\n* Alternative: No customer notifications (agents contact customers directly)\n\n*Decision*:\n\nSalesforce sends webhook notifications to EngagementService when Cases are updated/resolved. EngagementService triggers Braze push notifications.\n\n*Rationale*:\n\n* **Real-time notifications**: Customer notified immediately when agent resolves Case\n* **Efficient**: Webhook push model (not polling)\n* **Event-driven**: Aligns with event-driven architecture pattern\n* **Better customer experience**: Proactive notification vs waiting for agent contact\n\n*Consequences*:\n\n* Real-time customer notifications for Case updates\n* Efficient push model (no polling overhead)\n* Bidirectional integration (Mobile App → Salesforce → Mobile App)\n* ⚠️ Salesforce webhook mechanism TBD (Outbound Messages vs Platform Events vs Process Builder)\n* ⚠️ Webhook authentication and security required\n* ⚠️ EngagementService must handle webhook retries and failures\n\n<<<\n== Interface Specifications\n\nThis section provides references to the complete API specifications and event catalogue for ProfileService and EngagementService.\n\n=== REST API Specifications\n\nComplete OpenAPI 3.0 specifications are maintained in the `specifications/rest/` directory:\n\n==== ProfileService API v1\n\n*Specification*: link:../../specifications/rest/profile-service-v1.yaml[profile-service-v1.yaml]\n\n*Base URL*: `https://api.otr.com.au/profile/v1`\n\n*Authentication*: Bearer token (Microsoft Entra External ID JWT)\n\n*Key Endpoints*:\n\n* `GET /contact-id` - Retrieve or create Salesforce Contact ID for authenticated user (Just-In-Time reconciliation)\n** Used by Mobile App before submitting feedback to EngagementService\n** Upserts Salesforce Contact record using email as external key\n** Returns 18-character Salesforce Contact ID with caching (15-minute TTL)\n** Performance SLA: p95 < 300ms (uncached), p95 < 50ms (cached)\n\n==== EngagementService API v1\n\n*Specification*: link:../../specifications/rest/engagement-service-v1.yaml[engagement-service-v1.yaml]\n\n*Base URL*: `https://api.otr.com.au/engagement/v1`\n\n*Authentication*: Bearer token (Microsoft Entra External ID JWT)\n\n*Key Endpoints*:\n\n* `POST /feedback` - Submit customer feedback for async Case creation in Salesforce\n** Accepts contactId, category, storeName, timeOfVisit, contactPhoneNumber, message\n** Returns 202 Accepted immediately (async Case creation in background)\n** Publishes `CustomerFeedbackSubmitted` event for analytics\n** Creates Salesforce Case via Anti-Corruption Layer with retry logic\n** Performance SLA: p95 < 200ms (feedback accepted, not Case creation)\n\n=== Domain Events (AsyncAPI)\n\nComplete CloudEvents 1.0 JSON Schema specifications are maintained in the `specifications/events/` directory:\n\n*Specification*: link:../../specifications/events/engagement-events.json[engagement-events.json]\n\n==== Event Catalogue\n\n[width=\"100%\",cols=\"30%,20%,50%\",options=\"header\",]\n|===\n|Event Type |Publisher |Consumers\n\n|`CustomerFeedbackSubmitted`\n|EngagementService\n|Future bounded contexts, analytics, sentiment analysis\n\n|`SupportCaseCreated`\n|EngagementService\n|Future bounded contexts, analytics\n\n|`SupportCaseUpdated`\n|EngagementService (via Salesforce webhook)\n|Future bounded contexts, analytics\n\n|`SupportCaseResolved`\n|EngagementService (via Salesforce webhook)\n|Future bounded contexts, analytics\n\n|===\n\n==== Event Delivery Guarantees\n\n* **At-least-once delivery**: Events may be delivered multiple times, consumers must handle idempotency\n* **Ordering**: FIFO queues guarantee ordering for events with same `contactId`\n* **Retention**: 4 days (96 hours) in Event Bus\n* **Dead Letter Queue**: Failed events after 5 retries moved to DLQ for manual intervention\n* **Format**: CloudEvents 1.0 specification with JSON payload\n\n=== API Versioning Policy\n\n==== Version Numbering\n\n* **Format**: `/v{major}` in URL path (e.g., `/profile/v1`, `/engagement/v1`)\n* **Semantic Versioning**: Major version incremented for breaking changes only\n* **Backwards Compatibility**: Minor changes (new optional fields, new endpoints) don't require version bump\n\n==== When to Version\n\n*Breaking changes requiring new major version*:\n\n- Removing or renaming fields in request/response\n- Changing field data types (e.g., string → number)\n- Changing authentication mechanism\n- Removing endpoints\n\n*Non-breaking changes not requiring version bump*:\n\n- Adding new optional fields to request/response\n- Adding new endpoints\n- Expanding enum values (e.g., adding new feedback category)\n- Improving error messages\n\n==== Parallel Version Support\n\n* Support N and N-1 versions concurrently for 6 months\n* Deprecation notice: 3 months before sunsetting old version\n* Mobile App must upgrade to new version within deprecation window\n\n<<<\n== Work Packages\n\nThis section consolidates gaps and activities into implementable work packages aligned with TOGAF Phase E requirements.\n\n=== Work Package Overview\n\n[width=\"100%\",cols=\"15%,35%,25%,25%\",options=\"header\",]\n|===\n|Work Package ID |Name |Transition State |Key Deliverables\n\n|WP-CS-001\n|ProfileService Development\n|TS-1 (Build & Test)\n|ProfileService microservice, Salesforce Contact integration, REST API\n\n|WP-CS-002\n|EngagementService Development\n|TS-1 (Build & Test)\n|EngagementService microservice, Anti-Corruption Layer, Braze integration\n\n|WP-CS-003\n|Event Bus Infrastructure\n|TS-1 (Build & Test)\n|Event Bus configuration, CloudEvents schemas, monitoring\n\n|WP-CS-004\n|Contact Migration Tooling\n|TS-1 (Build & Test)\n|Migration tool, validation scripts, reconciliation reporting\n\n|WP-CS-005\n|Mobile App Integration\n|TS-1 (Build & Test)\n|Mobile App API integration, feedback form enhancements, testing\n\n|WP-CS-006\n|Integration Testing\n|TS-1 (Build & Test)\n|Test environments, integration test suites, UAT execution\n\n|WP-CS-007\n|Salesforce Configuration\n|TS-1 (Build & Test)\n|Salesforce field mapping, data isolation, webhook configuration\n\n|WP-CS-008\n|Contact Data Migration\n|TS-2 (Contact Migration)\n|Contact migration execution, validation, reconciliation\n\n|WP-CS-009\n|Production Deployment\n|TS-3 (Cutover)\n|Production deployment, smoke testing, go-live execution\n\n|WP-CS-010\n|Post-Cutover Support\n|TS-4 (Target State)\n|Monitoring, issue resolution, D365 CE retirement\n\n|===\n\n[[wp-cs-001]]\n=== WP-CS-001: ProfileService Development\n\n==== Description\n\nBuild ProfileService bounded context microservice implementing Just-In-Time Contact reconciliation with Salesforce Service Cloud.\n\n==== Deliverables\n\n* ProfileService microservice application\n** REST API implementation (OpenAPI 3.0 specification)\n** `GET /contact-id` endpoint (Salesforce Contact reconciliation)\n** Authentication/authorization with Microsoft Entra External ID\n** Caching layer (15-minute TTL for Contact IDs)\n* Salesforce integration\n** Salesforce REST API client\n** Contact upsert by email (external key matching)\n** Error handling and retry logic\n* Unit tests (>80% code coverage)\n* Integration tests with Salesforce sandbox\n* API documentation\n* Deployment configuration (IaC - Infrastructure as Code)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* Salesforce sandbox environment provisioned\n* Microsoft Entra External ID OAuth configuration\n* Development environment setup (AWS dev account, CI/CD pipeline)\n\n*Dependent Work Packages*:\n\n* None (can start immediately after prerequisites met)\n\n==== Skills Required\n\n* Backend development (.NET Core or Node.js)\n* REST API design and implementation\n* Salesforce REST API integration\n* OAuth 2.0 / JWT authentication\n* Caching strategies (Redis/ElastiCache)\n* Unit/integration testing frameworks\n* Infrastructure as Code (Terraform/CloudFormation)\n\n==== Acceptance Criteria\n\n* All API endpoints return correct HTTP status codes per OpenAPI specification\n* Contact ID retrieval achieves p95 < 300ms (uncached), p95 < 50ms (cached)\n* Salesforce Contact upsert succeeds with 100% accuracy in sandbox testing\n* Unit test coverage > 80%\n* Integration tests pass in sandbox environment\n* API documentation generated from OpenAPI specification\n\n[[wp-cs-002]]\n=== WP-CS-002: EngagementService Development\n\n==== Description\n\nBuild EngagementService bounded context microservice implementing customer feedback submission, Anti-Corruption Layer for Salesforce Case creation, Braze integration, and webhook receiver for Case updates.\n\n==== Deliverables\n\n* EngagementService microservice application\n** REST API implementation (OpenAPI 3.0 specification)\n** `POST /feedback` endpoint (async feedback submission)\n** Authentication/authorization with Microsoft Entra External ID\n** Webhook receiver endpoint for Salesforce Case updates\n* Anti-Corruption Layer (ACL)\n** OTR domain model to Salesforce API translation\n** Category enum mapping (App/Service/Order/Rewards → Salesforce Case fields)\n** Salesforce REST API client for Case creation\n* Async processing infrastructure\n** Event Bus publisher integration\n** Background worker for Case creation\n** Retry logic with exponential backoff (5 attempts)\n** Dead Letter Queue integration\n* Braze integration\n** Braze campaign trigger API client\n** Push notification orchestration for Case updates\n* Domain event publishing\n** `CustomerFeedbackSubmitted` event publisher\n** `SupportCaseCreated` event publisher\n** `SupportCaseUpdated` event translator (Salesforce webhook → domain event)\n** `SupportCaseResolved` event translator (Salesforce webhook → domain event)\n* Unit tests (>80% code coverage)\n* Integration tests (EngagementService ↔ Salesforce, EngagementService ↔ Braze)\n* API documentation\n* Deployment configuration (IaC)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* <<wp-cs-003,WP-CS-003>> (Event Bus Infrastructure) completed\n* Salesforce sandbox environment provisioned\n* Braze API credentials and campaign templates configured\n* Microsoft Entra External ID OAuth configuration\n\n*Dependent Work Packages*:\n\n* <<wp-cs-003,WP-CS-003>> must be completed first (Event Bus required for async processing)\n* <<wp-cs-007,WP-CS-007>> (Salesforce Configuration) must be in progress (field mapping needed)\n\n==== Skills Required\n\n* Backend development (.NET Core or Node.js)\n* REST API design and implementation\n* Salesforce REST API integration\n* Event-driven architecture patterns\n* Async/background processing (queues, workers)\n* Braze API integration\n* Webhook design and security\n* OAuth 2.0 / JWT authentication\n* Domain-Driven Design (DDD) - Anti-Corruption Layer pattern\n* Unit/integration testing frameworks\n* Infrastructure as Code (Terraform/CloudFormation)\n\n==== Acceptance Criteria\n\n* Feedback submission endpoint returns 202 Accepted within p95 < 200ms\n* Async Case creation succeeds with >99.5% success rate (including retries)\n* Anti-Corruption Layer correctly maps all feedback categories to Salesforce Case fields\n* Webhook receiver processes Salesforce Case updates and publishes domain events\n* Braze push notifications sent successfully for Case updates\n* Failed Case creation moves to Dead Letter Queue after 5 retry attempts\n* Unit test coverage > 80%\n* Integration tests pass with Salesforce sandbox and Braze staging environment\n\n[[wp-cs-003]]\n=== WP-CS-003: Event Bus Infrastructure\n\n==== Description\n\nImplement Event Bus infrastructure for domain event publishing using existing AWS infrastructure (SNS+SQS, EventBridge, or Kinesis).\n\n==== Deliverables\n\n* Event Bus infrastructure configuration\n** Topic/stream provisioning (technology choice: SNS+SQS / EventBridge / Kinesis)\n** FIFO queue configuration (ordering by `contactId`)\n** Dead Letter Queue (DLQ) setup\n** Retention policy (4 days / 96 hours)\n** Access control policies (IAM roles, permissions)\n* CloudEvents 1.0 schema definitions\n** JSON Schema specifications for all domain events\n** Schema validation configuration\n** Schema registry (if using EventBridge/Kinesis)\n* Monitoring and alerting\n** CloudWatch dashboards for queue metrics\n** Alarms for DLQ depth, queue age, processing failures\n** Event Bus throughput monitoring\n* Documentation\n** Event Bus architecture diagram\n** Event publishing guidelines\n** Consumer integration guide\n* Infrastructure as Code (IaC)\n** Terraform/CloudFormation templates for all infrastructure\n\n==== Dependencies\n\n*Prerequisites*:\n\n* AWS account access (existing infrastructure)\n* Technology selection decision (SNS+SQS vs EventBridge vs Kinesis)\n* CloudEvents 1.0 schema design approval\n\n*Dependent Work Packages*:\n\n* None (foundational infrastructure, can start early)\n\n==== Skills Required\n\n* AWS messaging services (SNS, SQS, EventBridge, Kinesis)\n* Event-driven architecture patterns\n* CloudEvents specification\n* JSON Schema design\n* Infrastructure as Code (Terraform/CloudFormation)\n* AWS IAM security configuration\n* CloudWatch monitoring and alerting\n\n==== Acceptance Criteria\n\n* Event Bus infrastructure provisioned in all environments (dev, staging, production)\n* FIFO ordering validated for events with same `contactId`\n* Dead Letter Queue triggers alarms when messages arrive\n* Event retention policy enforced (4 days)\n* CloudEvents 1.0 schema validation enabled\n* Monitoring dashboards operational\n* Infrastructure fully codified (IaC)\n\n[[wp-cs-004]]\n=== WP-CS-004: Contact Migration Tooling\n\n==== Description\n\nDevelop Contact migration tool for one-time migration from app-specific database to Salesforce Service Cloud with upsert logic and validation.\n\n==== Deliverables\n\n* Contact migration tool\n** Extract Contacts from app-specific database\n** Transform to Salesforce Contact API format\n** Upsert to Salesforce using email as external key\n** Fallback matching by phone number or Viva Consumer ID\n** Batch processing with rate limiting (respect Salesforce API limits)\n** Idempotent operation (can be re-run safely)\n* Validation scripts\n** Pre-migration validation (data quality checks)\n** Post-migration validation (100% Contact reconciliation)\n** Email/phone/VCI matching accuracy report\n* Reconciliation reporting\n** Contacts created vs updated statistics\n** Failed upserts with error details\n** Matching accuracy metrics\n* Rollback capability\n** Export snapshot of Salesforce Contacts before migration\n** Rollback procedure documentation\n* Documentation\n** Migration tool user guide\n** Troubleshooting guide\n** Runbook for migration execution\n\n==== Dependencies\n\n*Prerequisites*:\n\n* <<wp-cs-001,WP-CS-001>> (ProfileService Development) completed (reuses Salesforce integration code)\n* Salesforce sandbox environment for migration testing\n* App-specific database access (read-only sufficient)\n* Salesforce production access granted\n\n*Dependent Work Packages*:\n\n* <<wp-cs-001,WP-CS-001>> provides Salesforce Contact upsert logic to reuse\n\n==== Skills Required\n\n* Database development (SQL, data extraction)\n* Salesforce REST API integration\n* Batch processing and ETL patterns\n* Data validation and reconciliation\n* Error handling and logging\n* Scripting (Python, PowerShell, or similar)\n\n==== Acceptance Criteria\n\n* Migration tool successfully migrates 100% of Contacts in sandbox with zero data loss\n* Email/phone/VCI matching accuracy > 95% in sandbox testing\n* Failed upserts captured with actionable error messages\n* Reconciliation report matches actual Salesforce Contact counts\n* Migration tool execution time acceptable for production (freezes app database for minimum time)\n* Rollback procedure validated in sandbox\n* Documentation complete and approved\n\n[[wp-cs-005]]\n=== WP-CS-005: Mobile App Integration\n\n==== Description\n\nUpdate Mobile App to integrate with ProfileService and EngagementService APIs, replacing D365 CE integration.\n\n==== Deliverables\n\n* Feedback form UI enhancements\n** Add Category dropdown (App, Service, Order, Rewards, Refund, Delete Account)\n** Add Store Name field (optional)\n** Add Time of Visit field (optional, datetime picker)\n** Add Contact Phone Number field (optional, E.164 validation)\n** Update Message field (1-2000 character limit with counter)\n* API integration (Kotlin Multiplatform shared code)\n** ProfileService client (`GET /contact-id`)\n** EngagementService client (`POST /feedback`)\n** JWT token management (Microsoft Entra External ID)\n** Error handling (network failures, API errors, validation errors)\n** Retry logic for transient failures\n* Platform-specific UI (SwiftUI for iOS, Jetpack Compose for Android)\n** Feedback form screens\n** Success/error confirmation screens\n** Loading states and progress indicators\n* Feature flag integration\n** `enable_salesforce_feedback_submission` flag\n** Fallback to D365 CE if flag disabled (during rollout)\n* Unit tests for shared business logic\n* UI tests for platform-specific screens\n* API integration tests (mocked APIs)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* <<wp-cs-001,WP-CS-001>> (ProfileService Development) completed and deployed to dev/staging\n* <<wp-cs-002,WP-CS-002>> (EngagementService Development) completed and deployed to dev/staging\n* ProfileService and EngagementService OpenAPI specifications finalized\n* Feature flag service configured\n\n*Dependent Work Packages*:\n\n* Must complete after <<wp-cs-001,WP-CS-001>> and <<wp-cs-002,WP-CS-002>> (requires API endpoints available for integration testing)\n\n==== Skills Required\n\n* Kotlin Multiplatform development\n* SwiftUI (iOS native UI)\n* Jetpack Compose (Android native UI)\n* REST API client development\n* OAuth 2.0 / JWT authentication\n* Form validation and UX design\n* Unit testing (Kotlin, Swift)\n* UI testing frameworks (XCTest, Espresso)\n\n==== Acceptance Criteria\n\n* Feedback form UI matches UX design specifications\n* All form fields validate correctly (client-side validation)\n* API integration successfully calls ProfileService and EngagementService in dev/staging\n* Error handling provides user-friendly error messages\n* Feature flag correctly toggles between Salesforce and D365 CE integration\n* Unit test coverage > 80% for shared business logic\n* UI tests pass for all feedback form workflows (happy path, error states)\n* App builds and deploys successfully to TestFlight (iOS) and Google Play Internal Testing (Android)\n\n[[wp-cs-006]]\n=== WP-CS-006: Integration Testing\n\n==== Description\n\nExecute comprehensive integration testing across all system components in non-production environments.\n\n==== Deliverables\n\n* Test environment setup\n** Salesforce sandbox configured with test data\n** ProfileService deployed to staging\n** EngagementService deployed to staging\n** Event Bus staging infrastructure\n** Braze staging environment configured\n** Mobile App TestFlight/Internal Testing builds\n* Integration test suites\n** ProfileService ↔ Salesforce (Contact upsert scenarios)\n** EngagementService ↔ Salesforce (Case creation scenarios)\n** EngagementService ↔ Braze (push notification scenarios)\n** Mobile App ↔ ProfileService ↔ EngagementService (end-to-end workflows)\n** Event Bus publishing and consumption\n** Webhook receiver (Salesforce → EngagementService)\n* Test scenarios\n** Happy path: Successful feedback submission and Case creation\n** Error scenarios: Salesforce API failures, Braze API failures, network timeouts\n** Retry scenarios: Async Case creation retries, DLQ validation\n** Performance testing: p95 latency validation for ProfileService and EngagementService\n** Load testing: Simulate 3x-10x expected volume\n* UAT execution\n** Business stakeholder UAT sessions\n** UAT test cases covering all feedback categories\n** UAT sign-off documentation\n* Test results documentation\n** Test execution reports\n** Defect tracking and resolution\n** Performance test results\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-001 (ProfileService Development) completed\n* WP-CS-002 (EngagementService Development) completed\n* WP-CS-003 (Event Bus Infrastructure) completed\n* WP-CS-005 (Mobile App Integration) completed\n* WP-CS-007 (Salesforce Configuration) sandbox configuration completed\n\n*Dependent Work Packages*:\n\n* Must complete after WP-CS-001, WP-CS-002, WP-CS-003, WP-CS-005 (requires all components available)\n\n==== Skills Required\n\n* Integration testing strategy and execution\n* Test automation frameworks (Postman, Newman, Selenium)\n* Performance testing tools (JMeter, k6, Gatling)\n* Salesforce sandbox administration\n* Test data management\n* Defect tracking and triage\n* UAT facilitation\n\n==== Acceptance Criteria\n\n* All integration test scenarios pass (happy path, error scenarios, retry scenarios)\n* Performance SLAs validated (ProfileService p95 < 300ms, EngagementService p95 < 200ms)\n* Load testing confirms system handles 3x expected volume without degradation\n* UAT sign-off obtained from business stakeholders\n* Zero critical defects (P1/P2) open before moving to Contact Migration\n* Test results documented and approved\n\n[[wp-cs-007]]\n=== WP-CS-007: Salesforce Configuration\n\n==== Description\n\nConfigure Salesforce Service Cloud for OTR digital customer support integration, including field mapping, data isolation, and webhook setup.\n\n==== Deliverables\n\n* Salesforce Contact configuration\n** Custom fields for OTR-specific data (if needed)\n** Email as external key configuration\n** Record Type for OTR digital customers (data isolation)\n** Validation rules\n* Salesforce Case configuration\n** Custom fields for feedback categories (App, Service, Order, Rewards, Refund, Delete Account)\n** Case Type and Reason picklist mapping\n** Queue assignment rules (OTR digital support queue)\n** Case escalation rules\n** Case routing rules\n* Salesforce webhook configuration\n** Platform Events / Outbound Messages for Case updates\n** Webhook authentication (API key, JWT, or OAuth)\n** Case status change triggers (New → In Progress, Resolved, Closed)\n** Webhook payload format (JSON)\n* Data isolation strategy\n** Record Types for OTR vs other Viva Energy business units\n** Queues for OTR-specific Cases\n** Reporting and dashboards scoped to OTR data\n* Salesforce API access\n** Connected App configuration\n** OAuth 2.0 JWT bearer flow setup\n** API user credentials\n** API rate limit monitoring\n* Documentation\n** Salesforce field mapping specification\n** Webhook configuration guide\n** Data isolation architecture diagram\n** API authentication setup guide\n\n==== Dependencies\n\n*Prerequisites*:\n\n* Viva Energy Salesforce admin team engagement\n* Salesforce governance approval (multi-tenant environment)\n* Technical decision on webhook mechanism (Platform Events vs Outbound Messages)\n* Technical decision on authentication method (OAuth 2.0 JWT bearer flow recommended)\n\n*Dependent Work Packages*:\n\n* None (can start in parallel with development work packages)\n* Required for WP-CS-002 (EngagementService needs field mapping)\n* Required for WP-CS-006 (Integration Testing needs sandbox configuration)\n\n==== Skills Required\n\n* Salesforce administration\n* Salesforce configuration (Record Types, Queues, Validation Rules)\n* Salesforce API integration (REST API, Platform Events, Outbound Messages)\n* Salesforce security and authentication (OAuth, Connected Apps)\n* Multi-tenant data isolation patterns\n\n==== Acceptance Criteria\n\n* Salesforce sandbox configured with all custom fields, Record Types, Queues\n* Field mapping documented and approved by OTR business stakeholders\n* Webhook configuration tested and delivering Case update notifications\n* Data isolation validated (OTR data separate from other Viva Energy business units)\n* API authentication working for ProfileService and EngagementService\n* Salesforce API rate limits monitored and acceptable for expected volume\n* Configuration replicated to Salesforce production environment\n\n[[wp-cs-008]]\n=== WP-CS-008: Contact Data Migration\n\n==== Description\n\nExecute one-time Contact migration from app-specific database to Salesforce Service Cloud production.\n\n==== Deliverables\n\n* Pre-migration activities\n** Final validation of migration tool in sandbox\n** Communication plan (notify users of maintenance window if needed)\n** Freeze app-specific database Contact updates\n** Backup app-specific database\n** Export snapshot of Salesforce Contacts (rollback preparation)\n* Migration execution\n** Execute migration tool against Salesforce production\n** Monitor migration progress\n** Handle failed upserts (manual intervention if needed)\n* Post-migration validation\n** 100% Contact reconciliation (app database vs Salesforce)\n** Email/phone/VCI matching accuracy report\n** Reconciliation report (Contacts created vs updated)\n** Data integrity checks (no duplicate Contacts, no missing Contacts)\n* ProfileService smoke testing\n** Verify Contact ID retrieval works in production\n** Test cache behavior\n** Validate Salesforce Contact upserts from ProfileService\n* Migration report\n** Total Contacts migrated\n** Contacts created vs updated\n** Failed upserts (if any) with resolution\n** Matching accuracy metrics\n** Migration execution time\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-004 (Contact Migration Tooling) completed\n* WP-CS-001 (ProfileService Development) deployed to production (not yet integrated with Mobile App)\n* WP-CS-007 (Salesforce Configuration) production configuration completed\n* Salesforce production access granted\n* Migration approved by business stakeholders\n\n*Dependent Work Packages*:\n\n* Must complete after WP-CS-001, WP-CS-004, WP-CS-007\n* Must complete before WP-CS-009 (Production Deployment)\n\n==== Skills Required\n\n* Data migration execution\n* Salesforce administration\n* Database operations\n* Data validation and reconciliation\n* Incident management (if issues arise)\n\n==== Acceptance Criteria\n\n* 100% of Contacts migrated with zero data loss\n* Email/phone/VCI matching accuracy > 95%\n* ProfileService smoke tests pass in production\n* Reconciliation report approved by business stakeholders\n* App-specific database Contact updates frozen (read-only mode)\n* Rollback procedure ready (but not executed if migration successful)\n\n[[wp-cs-009]]\n=== WP-CS-009: Production Deployment\n\n==== Description\n\nDeploy all solution components to production and execute cutover from D365 CE to Salesforce Service Cloud.\n\n==== Deliverables\n\n* Production deployment\n** EngagementService deployed to production\n** Event Bus production infrastructure validated\n** Salesforce webhook configured in production\n** Mobile App released to production (App Store, Google Play)\n* Go-live activities\n** Smoke testing (end-to-end feedback submission)\n** Feature flag enabled: `enable_salesforce_feedback_submission = ON`\n** D365 CE integration disabled in Mobile App\n** Monitor Event Bus queue depth, DLQ, Salesforce API rate limits\n** Monitor Mobile App feedback submission success rate\n* Go/No-Go decision\n** Validate success criteria before final cutover\n** Business stakeholder approval\n** Technical validation (smoke tests pass, monitoring healthy)\n* Cutover communication\n** Notify support agents of new Salesforce integration\n** Provide training materials for support agents\n** Customer communication (if visible change)\n* Rollback plan\n** Documented rollback procedure\n** Feature flag can disable Salesforce integration and re-enable D365 CE\n** Rollback decision criteria (P1/P2 incidents, feedback submission success rate < 99%)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-001 (ProfileService Development) completed\n* WP-CS-002 (EngagementService Development) completed\n* WP-CS-003 (Event Bus Infrastructure) completed\n* WP-CS-005 (Mobile App Integration) completed\n* WP-CS-006 (Integration Testing) completed with UAT sign-off\n* WP-CS-007 (Salesforce Configuration) production configuration completed\n* WP-CS-008 (Contact Data Migration) completed successfully\n* Mobile App release approval (App Store, Google Play)\n\n*Dependent Work Packages*:\n\n* Must complete after all prior work packages (final cutover)\n\n==== Skills Required\n\n* Production deployment and release management\n* Incident management and troubleshooting\n* Monitoring and observability\n* Change management and communication\n* Rollback execution (if needed)\n\n==== Acceptance Criteria\n\n* Mobile App feedback submission success rate > 99.5%\n* End-to-end flow validated (Mobile App → ProfileService → EngagementService → Salesforce Case created)\n* Braze push notifications delivered successfully\n* Event Bus queue depth normal, DLQ empty\n* No critical incidents (P1/P2) in first 24 hours\n* D365 CE integration disabled\n* Support agents successfully using Salesforce for OTR digital customer Cases\n\n[[wp-cs-010]]\n=== WP-CS-010: Post-Cutover Support\n\n==== Description\n\nMonitor production stability, resolve issues, validate success criteria, and execute D365 CE retirement.\n\n==== Deliverables\n\n* Monitoring and support\n** 24/7 on-call support for first week post-cutover\n** Daily monitoring reports (feedback submission success rate, Case creation success rate)\n** Incident response and resolution\n** Performance tuning (if needed)\n* Success criteria validation\n** Validate feedback submission success rate > 99.5%\n** Monitor customer satisfaction score (target: +15% improvement within 6 months)\n** Monitor average case resolution time (target: -20% improvement within 6 months)\n** Support agent feedback survey\n* D365 CE retirement\n** D365 CE set to read-only mode (historical Case lookups only)\n** Archive D365 CE data for compliance/auditing\n** Decommission D365 CE infrastructure (after 90-day stabilization period)\n** Remove D365 CE integration code from Mobile App\n* Documentation updates\n** Production runbook\n** Troubleshooting guide (based on incidents resolved)\n** Operational procedures for support team\n** Lessons learned document\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-009 (Production Deployment) completed\n* Cutover successful with no critical incidents\n\n*Dependent Work Packages*:\n\n* Final work package in sequence\n\n==== Skills Required\n\n* Production support and incident management\n* Performance monitoring and tuning\n* Data archival and compliance\n* Infrastructure decommissioning\n* Documentation\n\n==== Acceptance Criteria\n\n* Zero critical incidents (P1/P2) in first 30 days post-cutover\n* Feedback submission success rate sustained > 99.5%\n* Customer satisfaction improvement validated (baseline established, ongoing measurement)\n* Support agents reporting positive experience with Salesforce unified view\n* D365 CE successfully decommissioned\n* All production documentation complete and approved\n* Lessons learned document published\n\n=== Work Package Sequencing\n\n==== Parallel Track 1: Infrastructure & Configuration\n\nCan start immediately and run in parallel:\n\n* WP-CS-003 (Event Bus Infrastructure)\n* WP-CS-007 (Salesforce Configuration)\n\n==== Parallel Track 2: Development\n\nCan start after Track 1 infrastructure decisions made:\n\n* WP-CS-001 (ProfileService Development) - Independent\n* WP-CS-002 (EngagementService Development) - Requires WP-CS-003 completed\n* WP-CS-004 (Contact Migration Tooling) - Requires WP-CS-001 completed (reuses code)\n\n==== Sequential Track 3: Integration & Testing\n\nMust complete after development:\n\n* WP-CS-005 (Mobile App Integration) - Requires WP-CS-001, WP-CS-002\n* WP-CS-006 (Integration Testing) - Requires WP-CS-001, WP-CS-002, WP-CS-003, WP-CS-005, WP-CS-007\n\n==== Sequential Track 4: Migration & Cutover\n\nMust complete sequentially:\n\n* WP-CS-008 (Contact Data Migration) - Requires WP-CS-001, WP-CS-004, WP-CS-006 UAT sign-off\n* WP-CS-009 (Production Deployment) - Requires all prior work packages completed\n* WP-CS-010 (Post-Cutover Support) - Requires WP-CS-009\n\n==== Critical Path\n\nThe critical path for this project is:\n\n. WP-CS-003 (Event Bus Infrastructure)\n. WP-CS-002 (EngagementService Development) - blocks on WP-CS-003\n. WP-CS-005 (Mobile App Integration) - blocks on WP-CS-001, WP-CS-002\n. WP-CS-006 (Integration Testing) - blocks on WP-CS-001 through WP-CS-005, WP-CS-007\n. WP-CS-008 (Contact Data Migration) - blocks on WP-CS-006 UAT sign-off\n. WP-CS-009 (Production Deployment) - blocks on WP-CS-008\n. WP-CS-010 (Post-Cutover Support) - final deliverable\n\nAny delays in critical path work packages will delay the overall cutover date.\n\n<<<\n== Transition Architecture\n\nThis section defines the evolution from baseline (D365 CE) to target state (Salesforce Service Cloud + ProfileService + EngagementService).\n\n=== Transition Approach\n\n*Big Bang Cutover*: Per ADR-CS-006, this transition uses a single cutover approach rather than phased rollout. All users switch from D365 CE to Salesforce simultaneously after Contact migration completion.\n\n=== Transition States\n\n==== TS-0: Baseline State (Current)\n\n===== Characteristics\n\n* D365 Customer Engagement handles all digital customer feedback\n* App-specific database stores customer Contact data\n* No ProfileService or EngagementService\n* No event-driven architecture\n* Synchronous feedback submission\n\n===== Components Active\n\n- D365 Customer Engagement\n- App-specific customer database\n- Mobile App (current version with D365 CE integration)\n\n==== TS-1: Build & Test\n\n===== Activities\n\n* Build ProfileService microservice (JIT Contact reconciliation API)\n* Build EngagementService microservice (feedback submission API, ACL for Salesforce Case creation, Braze integration, webhook receiver)\n* Implement Event Bus infrastructure (SNS+SQS/EventBridge/Kinesis)\n* Develop Contact migration tool (app database → Salesforce upsert by email/phone/VCI)\n* Update Mobile App API integration (ProfileService + EngagementService endpoints - feedback form UI already complete)\n* Integration testing (ProfileService ↔ Salesforce, EngagementService ↔ Salesforce, EngagementService ↔ Braze)\n* UAT with test Salesforce sandbox environment\n\n===== Components Active\n\n- D365 Customer Engagement (still active, unchanged)\n- App-specific customer database (still active)\n- ProfileService (non-production, testing only)\n- EngagementService (non-production, testing only)\n- Event Bus (non-production)\n- Salesforce Sandbox (testing)\n\n===== Exit Criteria\n\n- All integration tests pass\n- UAT sign-off from business stakeholders\n- Contact migration tool validated in sandbox\n- Mobile App updates tested with non-production APIs\n\n==== TS-2: Contact Migration\n\n===== Activities\n* Execute Contact migration (app database → Salesforce production)\n* Validation: 100% data integrity check (email/phone/VCI matching)\n* Reconciliation report: New Contacts created vs existing Contacts updated\n* Freeze app database Contact updates during migration window\n* ProfileService smoke testing (verify Contact lookups work in Salesforce production)\n\n===== Components Active\n- D365 Customer Engagement (still active, users unaffected)\n- Salesforce Production (Contacts migrated, no Cases yet)\n- ProfileService (production deployed, not integrated with Mobile App yet)\n- App-specific customer database (frozen, read-only)\n\n===== Exit Criteria\n- 100% of Contacts migrated with zero data loss\n- Email/phone/VCI matching accuracy > 95%\n- ProfileService smoke tests pass (JIT lookups return correct Contact IDs)\n- Reconciliation report approved\n\n==== TS-3: Cutover (Go-Live)\n\n===== Go-Live Activities\n\n* Deploy EngagementService to production\n* Deploy Mobile App updates (ProfileService + EngagementService API integration)\n* Configure Salesforce webhook (Case update notifications → EngagementService)\n* Smoke testing: End-to-end feedback submission (Mobile App → EngagementService → Salesforce → Braze notification)\n* Monitor Event Bus queue depth, dead letter queue, Salesforce API rate limits\n* **Go/No-Go decision**: Validate success criteria before final cutover\n* Enable feature flag: `enable_salesforce_feedback_submission = ON`\n* Disable D365 CE integration in Mobile App\n\n===== Components Active\n\n- ProfileService (production, integrated with Mobile App)\n- EngagementService (production, integrated with Mobile App)\n- Event Bus (production, processing async Case creation)\n- Salesforce Production (receiving Cases from digital customers)\n- Braze (sending push notifications)\n- Mobile App (new version with Salesforce integration)\n- D365 Customer Engagement (disabled, read-only for historical lookups)\n\n===== Exit Criteria\n\n- Mobile App feedback submission success rate > 99.5%\n- End-to-end flow validated (Mobile App → Salesforce Case created)\n- Braze push notifications delivered successfully\n- Event Bus queue depth normal, DLQ empty\n- No critical incidents (P1/P2) in first 24 hours\n\n==== TS-4: Target State (Stable Production)\n\n===== Characteristics\n\n* ProfileService and EngagementService fully operational\n* All digital customer feedback routed to Salesforce\n* Event-driven architecture established\n* D365 CE decommissioned\n* First DDD bounded contexts implemented successfully\n\n===== Monitoring Period\n\n* Validate success criteria: feedback submission rate > 99.5%, no data loss\n* Monitor customer satisfaction score (target: +15% improvement)\n* Monitor average case resolution time (target: -20% improvement)\n* Support agents using unified Salesforce view across all channels\n\n===== D365 CE Retirement\n\n* D365 CE read-only access for historical Case lookups (if needed)\n* Decommission D365 CE infrastructure after 90 days\n* Archive D365 CE data for compliance/auditing\n\n===== Components Active\n\n- ProfileService (production)\n- EngagementService (production)\n- Event Bus (production)\n- Salesforce Production (system of record)\n- Braze (push notifications)\n- Mobile App (Salesforce integration)\n- App-specific database (deprecated, Contact data no longer updated)\n\n===== Success Criteria Achieved\n\n- All digital customer feedback routed to Salesforce\n- Support agents have unified customer view\n- D365 CE decommissioned\n- Customer satisfaction improved by 15%\n- Average case resolution time decreased by 20%\n- Zero data loss during transition\n\n=== Transition Dependencies\n\n[width=\"100%\",cols=\"40%,60%\",options=\"header\",]\n|===\n|Dependency |Owner/Status\n\n|*Salesforce production access*\n|Viva Energy Salesforce admin team - TBD\n\n|*Salesforce Case field mapping*\n|Viva Energy Salesforce admin team - TBD (map OTR feedback categories to Salesforce fields)\n\n|*Salesforce data isolation strategy*\n|Viva Energy Salesforce admin team - TBD (Record Types, queues, custom fields)\n\n|*Salesforce webhook configuration*\n|Viva Energy Salesforce admin team - TBD (Outbound Messages vs Platform Events)\n\n|*Event Bus infrastructure*\n|OTR Platform team - Existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis)\n\n|*Braze integration*\n|OTR Marketing team - Existing Braze account, EngagementService creates new campaigns\n\n|*Mobile App release window*\n|OTR Mobile team - Coordinate cutover timing with app release schedule\n\n|*App database access*\n|OTR Platform team - Read access for Contact migration\n\n|===\n\n=== Transition Validation Criteria\n\n==== Contact Migration Validation\n\n* 100% of app database Contacts migrated to Salesforce (zero data loss)\n* Email/phone/VCI matching accuracy > 95% (minimize duplicate Contacts)\n* ProfileService JIT lookups return correct Salesforce Contact IDs (smoke test sample)\n* Reconciliation report shows: X new Contacts created, Y existing Contacts updated\n\n==== Cutover Validation\n\n* Mobile App feedback submission success rate > 99.5% (including async Case creation)\n* End-to-end flow validated: Mobile App → ProfileService → EngagementService → Salesforce Case created\n* Braze push notifications delivered for Case creation and Case resolution\n* Event Bus queue depth within normal range (no backlog)\n* Dead letter queue empty (no failed Case creations)\n* Salesforce API rate limits not exceeded\n\n==== Production Monitoring (30 days)\n\n* Customer satisfaction score improves by 15% (compared to D365 CE baseline)\n* Average case resolution time decreases by 20% (Salesforce vs D365 CE)\n* Support agents confirm unified customer view across all channels\n* Zero critical incidents (P1 outages, data loss)\n\n=== Rollback Plan\n\n==== Rollback Triggers\n\n* Feedback submission success rate < 95% (below acceptable threshold)\n* Data loss or corruption detected in Salesforce\n* Salesforce API rate limits exceeded (Cases not created within SLA)\n* Critical bug blocking customer feedback submission\n\n==== Rollback Procedure\n\n1. **Revert Mobile App** to previous version (remove ProfileService/EngagementService integration, restore D365 CE integration)\n2. **Stop EngagementService** Case creation (prevent duplicate Cases in Salesforce)\n3. **Re-enable D365 CE** for customer feedback submission\n4. **Investigate root cause** (EngagementService logs, Salesforce API errors, Event Bus queue issues)\n5. **Fix and re-test** in sandbox environment\n6. **Retry cutover** when issues resolved\n\n==== Rollback Limitations\n\n* Cases created in Salesforce during cutover period remain in Salesforce (no reverse migration)\n* Contacts migrated to Salesforce remain (no rollback to app database)\n* Rollback only affects Mobile App integration (not data migration)\n\n=== Architectural Scope Boundaries\n\n==== Capabilities Included\n\n===== Business Capabilities\n\n* **Customer Feedback Submission**: Mobile App users can submit structured feedback (Category, Store Name, Time of Visit, Phone, Free Text Message) via EngagementService\n* **Customer Contact Management**: Just-In-Time (JIT) Contact reconciliation with Salesforce via ProfileService, ensuring every Mobile App user has a Salesforce Contact record\n* **Case Management Integration**: EngagementService creates Salesforce Cases asynchronously for customer feedback, support agents manage Cases in Salesforce Service Cloud\n* **Customer Notifications**: Push notifications via Braze when Cases are created, updated, or resolved (bidirectional integration: Mobile App → Salesforce → Mobile App)\n* **Unified Customer View**: Support agents see OTR digital customer feedback alongside other Viva Energy channels (fuel wholesale, Shell Card, retail) in single Salesforce instance\n* **Contact Data Migration**: One-time migration of app-specific customer database Contacts to Salesforce with upsert logic (email/phone/VCI matching)\n\n===== Technical Capabilities\n\n* **ProfileService Bounded Context**: First DDD bounded context implementation - JIT Contact reconciliation, Salesforce API facade, foundation for Flybuys integration\n* **EngagementService Bounded Context**: First DDD bounded context implementation - Customer feedback submission BFF, Anti-Corruption Layer for Salesforce, Braze integration orchestration\n* **Event-Driven Architecture**: Domain event publishing via Event Bus (SNS+SQS/EventBridge/Kinesis) for `SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted` events\n* **Async Processing Pattern**: Non-blocking Case creation with retry logic, exponential backoff, dead letter queue for operational resilience\n* **Anti-Corruption Layer Pattern**: EngagementService protects digital channels from Salesforce API changes, translates between OTR domain language and Salesforce\n* **Conformist Pattern**: ProfileService and EngagementService conform to existing Salesforce configuration (shared Viva Energy instance, multi-tenant governance)\n* **Salesforce Integration**: REST API integration for Contact CRUD and Case creation, webhook receiver for Case update notifications\n* **Braze Integration**: Push notification campaign triggers for Case lifecycle events (created, updated, resolved)\n* **Observability & Monitoring**: Dashboards, metrics, alerting for feedback submission rate, queue depth, API errors, Case creation latency\n* **Feature Flag Management**: Kill switches for emergency rollback (enable_salesforce_feedback_submission, enable_async_case_creation, etc.)\n\n==== Capabilities Excluded\n\n===== Business Capabilities Explicitly Out of Scope\n\n* **Historical Case Migration**: D365 CE Cases not migrated to Salesforce (ADR-CS-005 - fresh start, no Case migration)\n* **Multi-Channel Feedback Submission**: Web app, POS, call centre, email feedback channels not included (Mobile App only in this phase)\n* **Case Resolution by Digital Channels**: Support agents resolve Cases in Salesforce, not via Mobile App self-service\n* **Knowledge Base Integration**: Salesforce Knowledge Base articles not surfaced in Mobile App (future enhancement)\n* **Live Chat/Messaging**: Real-time chat support not included (Salesforce omnichannel capabilities not activated)\n* **Sentiment Analysis**: Automated feedback sentiment analysis not included (future enhancement with AI/ML)\n* **Customer Satisfaction Surveys**: Post-resolution CSAT surveys not included (separate initiative)\n* **Case Attachments**: Mobile App feedback submission does not support file uploads (photos, receipts) - text only\n* **Agent Desktop Integration**: Custom Salesforce UI for support agents not included (use standard Salesforce Service Console)\n* **Social Media Feedback**: Facebook, Twitter, Instagram feedback channels not integrated\n\n===== Technical Capabilities Explicitly Out of Scope\n\n* **Event Sourcing**: Domain events are ephemeral (not persisted for event sourcing/replay) - Event Bus only, no Event Store\n* **CQRS (Command Query Responsibility Segregation)**: ProfileService and EngagementService use same data model for reads/writes (no separate read models)\n* **Local Aggregate Persistence**: ProfileService and EngagementService are stateless (Salesforce is System of Record, no local database for Contact/Case)\n* **Saga Orchestration**: No distributed transactions or saga patterns required (single-step Case creation, not multi-step workflow)\n* **API Gateway Advanced Features**: Rate limiting, API versioning, API key management deferred to detailed design (basic routing only)\n* **GraphQL API**: ProfileService and EngagementService expose REST APIs only (GraphQL not required)\n* **Real-Time Sync**: Salesforce Contact updates by support agents not synced back to ProfileService (eventual consistency acceptable via JIT reconciliation)\n* **Multi-Region Deployment**: Single AWS region deployment (no multi-region failover/disaster recovery in this phase)\n* **Blue-Green Deployment**: Big bang cutover (ADR-CS-006), not blue-green or canary deployment strategy\n* **A/B Testing Framework**: Feature flags for rollback only, not for A/B testing or experimentation\n* **Custom Authentication**: Microsoft Entra External ID used for Mobile App authentication (no custom authentication logic in ProfileService/EngagementService)\n* **Data Residency Compliance**: Salesforce data residency governed by Viva Energy Salesforce configuration (no OTR-specific data residency requirements)\n\n===== Future Bounded Contexts Not in Scope\n\n* **LoyaltyService**: Flybuys integration, reward preferences, transaction adjudication (separate initiative)\n* **LocationService**: Store finder, proximity features, geofencing (separate initiative)\n* **PaymentService**: Payment processing, subscription billing (separate initiative)\n* **RecommendationService**: Personalized recommendations, next-best offers (separate initiative)\n\n===== Integration Patterns Not in Scope\n\n* **Shared Kernel**: No shared domain model between ProfileService and EngagementService (separate bounded contexts with clear boundaries)\n* **Partnership**: No joint development or coordination with external teams (Conformist pattern - we conform to Salesforce)\n* **Customer-Supplier (we're upstream)**: No downstream systems depend on ProfileService/EngagementService APIs yet (future bounded contexts will consume domain events)\n\n==== Architectural Dependencies on Future Initiatives\n\n*This Architecture Enables Future Initiatives*:\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Future Initiative |Architectural Enablement\n\n|*Flybuys Integration*\n|**ProfileService Contact Reconciliation Reused**: ProfileService establishes pattern for JIT Contact reconciliation with Salesforce, which will be extended for Flybuys partner linking (link:../architecture_definitions/flybuys_integration.adoc[see Flybuys Integration architecture]) +\n**Event Bus Infrastructure**: Domain event publishing pattern (`CustomerEnrolledInLoyalty`, `PartnerLinked`, etc.) reuses Event Bus established for EngagementService\n\n|*LoyaltyService Bounded Context*\n|**Event Bus Subscription**: LoyaltyService will consume `CustomerProfileCreated` events published by ProfileService (future enhancement) +\n**Salesforce Contact Integration**: LoyaltyService may query Salesforce Contacts for customer reward preferences (via ProfileService facade or direct Salesforce API)\n\n|*Web App Feedback Submission*\n|**EngagementService API Reuse**: Web app will call same EngagementService REST API for feedback submission (multi-channel support) +\n**Conformist Pattern**: Web app conforms to EngagementService API contract (no translation required)\n\n|*Multi-Channel Customer Support*\n|**EngagementService Extension**: Add support for email, call centre, POS feedback channels (extend EngagementService to handle multiple origins) +\n**Salesforce Case Origin Field**: Cases already tagged with Origin=Mobile App, extend to Origin=Web, POS, Call Centre, Email\n\n|*Knowledge Base Integration*\n|**EngagementService API Extension**: Add endpoint to query Salesforce Knowledge Base articles, surface in Mobile App for self-service support +\n**Anti-Corruption Layer**: EngagementService translates Salesforce Knowledge API to OTR domain language\n\n|*Customer Satisfaction Surveys*\n|**Event-Driven Trigger**: Subscribe to `SupportCaseResolved` events published by EngagementService, trigger CSAT survey via Braze +\n**Braze Integration Pattern**: Reuse EngagementService → Braze integration pattern for survey campaigns\n\n|*Sentiment Analysis*\n|**Event Subscription**: Subscribe to `CustomerFeedbackSubmitted` events, analyse feedback sentiment (AI/ML service) +\n**EngagementService Extension**: Enrich Case with sentiment score before creating in Salesforce\n\n|*RecommendationService Bounded Context*\n|**Event Subscription**: RecommendationService subscribes to `SupportCaseCreated` events to understand customer pain points and personalize recommendations +\n**Domain Event Pattern**: Reuse Event Bus publishing pattern established by EngagementService\n\n|===\n\n*This Architecture Depends on Future Initiatives*:\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Future Initiative |Dependency Description\n\n|*Salesforce Data Isolation Strategy*\n|**BLOCKER**: Viva Energy Salesforce admin team must define data isolation strategy (Record Types, custom fields, queues) before production deployment +\n**Impact**: Multi-tenant data visibility and security governance\n\n|*Salesforce Case Field Mapping*\n|**BLOCKER**: Viva Energy Salesforce admin team must define field mapping for OTR feedback categories (App, Service, Order, Rewards, Refund, Delete Account) +\n**Impact**: Case creation logic in EngagementService depends on finalized Salesforce schema\n\n|*Salesforce Webhook Mechanism*\n|**BLOCKER**: Viva Energy Salesforce admin team must configure webhook mechanism (Outbound Messages vs Platform Events vs Process Builder) for Case update notifications +\n**Impact**: EngagementService webhook receiver implementation depends on chosen mechanism\n\n|*Event Bus Technology Selection*\n|**DECISION REQUIRED**: Choose Event Bus implementation (SNS+SQS vs EventBridge vs Kinesis) for domain event publishing +\n**Impact**: Infrastructure provisioning, event schema design, consumer implementation\n\n|*Microservice Hosting Platform*\n|**DECISION REQUIRED**: Choose hosting platform for ProfileService and EngagementService (AWS Lambda vs ECS vs EKS) +\n**Impact**: Deployment architecture, auto-scaling strategy, operational overhead\n\n|*Observability Platform*\n|**DECISION REQUIRED**: Choose observability platform (AWS CloudWatch vs Datadog vs New Relic) for monitoring and alerting +\n**Impact**: Dashboard configuration, metric collection, alerting setup\n\n|===\n\n*Future Work After This Initiative*:\n\n* **Event Schema Registry**: Implement event schema versioning and registry for domain events (currently ad-hoc schemas)\n* **API Versioning Strategy**: Define API versioning approach for ProfileService and EngagementService (currently v1 only)\n* **Multi-Region Deployment**: Extend to multi-region for disaster recovery and global availability\n* **Event Store**: Persist domain events for event sourcing and audit trail (currently ephemeral Event Bus only)\n* **CQRS Pattern**: Separate read models for high-volume queries (currently same model for reads/writes)\n* **GraphQL API**: Expose GraphQL API for flexible client queries (currently REST only)\n* **Real-Time Sync**: Bi-directional sync between Salesforce and ProfileService for Contact updates (currently JIT reconciliation only)\n\n=== Technical Risks and Mitigation\n\n[width=\"100%\",cols=\"5%,20%,25%,25%,25%\",options=\"header\",]\n|===\n|ID |Risk |Impact |Likelihood |Mitigation\n\n|RISK-CS-001\n|*Salesforce API rate limits exceeded*: High feedback volume exceeds Salesforce API limits, Cases not created\n|HIGH (customers don't receive Case confirmation, support tickets lost)\n|MEDIUM (volume unknown, rate limits TBD)\n|• Gather expected feedback volume data before cutover +\n• Implement Event Bus queue throttling/rate limiting +\n• Monitor queue depth and API usage +\n• Scale background workers based on queue depth +\n• Alert ops team when approaching rate limits\n\n|RISK-CS-002\n|*Salesforce downtime*: Salesforce Service Cloud outage prevents Case creation\n|MEDIUM (Cases delayed but queued, customers wait for confirmation)\n|LOW (Salesforce SLA 99.9% uptime)\n|• Async Case creation with retry logic +\n• Event Bus queues buffer work during outage +\n• Customers get immediate \"Feedback submitted\" (not blocked) +\n• Monitor Salesforce status page, alert ops team +\n• Automatic retry when Salesforce recovers\n\n|RISK-CS-003\n|*Contact migration data quality issues*: App database Contact data incomplete or invalid\n|HIGH (migration fails validation, cutover delayed)\n|MEDIUM (legacy data quality unknown)\n|• Pre-migration data quality assessment +\n• Flexible upsert logic (match by email/phone/VCI) +\n• Validation report identifies data issues before production migration +\n• Manual cleanup for invalid records +\n• Dry-run migration in sandbox environment\n\n|RISK-CS-004\n|*Duplicate Contacts created*: Email matching fails, ProfileService creates duplicate Contacts\n|MEDIUM (support agents see multiple profiles for same customer)\n|MEDIUM (email changes, data quality issues)\n|• Salesforce duplicate detection rules (if available) +\n• ProfileService logs Contact creation for audit trail +\n• Manual duplicate cleanup process (support team) +\n• Future enhancement: VCI as Salesforce External ID for stable matching\n\n|RISK-CS-005\n|*Dead letter queue accumulation*: Failed Case creations not processed, queue grows\n|HIGH (customers don't receive Case confirmation, feedback lost)\n|LOW (retry logic handles most failures)\n|• Dead letter queue monitoring and alerting +\n• Ops team dashboard showing DLQ depth +\n• Manual intervention process (investigate and reprocess) +\n• Automated alerts when DLQ depth exceeds threshold +\n• Root cause analysis for recurring failures\n\n|RISK-CS-006\n|*Salesforce webhook failures*: Salesforce can't deliver Case update notifications to EngagementService\n|MEDIUM (customers don't get push notifications for Case resolution)\n|LOW (webhook mechanism reliable)\n|• Webhook retry logic and exponential backoff +\n• EngagementService logs webhook deliveries +\n• Monitor webhook delivery success rate +\n• Fallback: Poll Salesforce API for Case updates (if webhook fails persistently) +\n• Alert ops team when webhook delivery rate drops\n\n|RISK-CS-007\n|*Multi-tenant data isolation breach*: OTR digital Cases visible to other Viva Energy support teams\n|HIGH (privacy violation, compliance risk)\n|LOW (Salesforce governance controls)\n|• Work with Viva Energy Salesforce admin team on data isolation strategy +\n• Test data visibility in Salesforce sandbox (UAT with different user roles) +\n• Validate Record Types, queues, field-level security before production +\n• Audit Salesforce user permissions and sharing rules\n\n|RISK-CS-008\n|*Mobile App release coordination*: App release delayed, cutover window missed\n|MEDIUM (cutover delayed, D365 CE retirement delayed)\n|MEDIUM (release schedule conflicts)\n|• Coordinate cutover timing with Mobile team early +\n• Buffer time in migration plan (2-week contingency) +\n• Decouple backend deployment from Mobile App release (backend deployed first, app follows) +\n• Feature flag for feedback submission (enable when ready)\n\n|RISK-CS-009\n|*Event Bus infrastructure issues*: SNS/SQS/EventBridge downtime or misconfiguration\n|HIGH (Case creation blocked, domain events not published)\n|LOW (AWS SLA 99.99% uptime)\n|• Leverage existing AWS infrastructure (proven, reliable) +\n• Infrastructure as Code (IaC) for Event Bus configuration +\n• Integration testing in non-production environment +\n• Monitor Event Bus metrics (queue depth, throughput, errors) +\n• Alert ops team on Event Bus failures\n\n|RISK-CS-010\n|*Team DDD knowledge gap*: Team unfamiliar with DDD patterns, bounded contexts, event-driven architecture\n|MEDIUM (implementation delays, architectural inconsistencies)\n|HIGH (first DDD implementation)\n|• DDD training for development team (workshops, documentation) +\n• Architecture review sessions (validate bounded context design) +\n• Pair programming with experienced DDD practitioners +\n• Incremental implementation (start small, iterate) +\n• Document architectural patterns in CLAUDE.md\n\n|===\n\n== Assumptions and Constraints\n\n=== Assumptions\n\n[width=\"100%\",cols=\"8%,92%\",options=\"header\",]\n|===\n|ID |Assumption\n\n|ASM-CS-001\n|Viva Energy Salesforce admin team will provide Salesforce production access, sandbox environment, and support for Case field mapping and data isolation configuration\n\n|ASM-CS-002\n|App database Contact data is sufficiently complete for migration (email/phone/VCI available for matching)\n\n|ASM-CS-003\n|Expected customer feedback volume (100-150 submissions/day from 20k DAU) is well within Salesforce API rate limits, with capacity planning for 3x-10x growth\n\n|ASM-CS-004\n|Existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis) is sufficient for Event Bus implementation (no additional infrastructure provisioning required)\n\n|ASM-CS-005\n|Braze integration already exists and can be extended for Case-related push notifications (no new Braze account or major configuration changes)\n\n|ASM-CS-006\n|Mobile App users have email addresses associated with their accounts (required for ProfileService Contact reconciliation)\n\n|ASM-CS-007\n|D365 Customer Engagement historical Cases have limited business value and do not require migration to Salesforce\n\n|ASM-CS-008\n|Support agents are trained on Salesforce Service Cloud and require minimal additional training for OTR digital customer Cases\n\n|ASM-CS-009\n|Salesforce Service Cloud shared instance has capacity for OTR digital customer Contacts and Cases (no additional licensing or storage costs)\n\n|ASM-CS-010\n|Mobile App release schedule can accommodate cutover timing (Week 10 in migration plan)\n\n|===\n\n=== Constraints\n\n[width=\"100%\",cols=\"8%,92%\",options=\"header\",]\n|===\n|ID |Constraint\n\n|CON-CS-001\n|Must use shared Viva Energy Salesforce Service Cloud instance (cannot deploy separate OTR-specific instance)\n\n|CON-CS-002\n|Must conform to existing Salesforce configuration and governance (Record Types, custom fields, queues, data isolation strategy defined by Viva Energy admin team)\n\n|CON-CS-003\n|Contact migration must complete before Mobile App cutover (no parallel run of D365 CE and Salesforce)\n\n|CON-CS-004\n|Big bang cutover only (no phased rollout with feature flags or pilot users)\n\n|CON-CS-005\n|Salesforce API rate limits and authentication method constrained by Viva Energy Salesforce configuration (TBD)\n\n|CON-CS-006\n|Event Bus implementation must use existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis - cannot introduce new infrastructure components)\n\n|CON-CS-007\n|Mobile App feedback form must include specific fields: Category, Store Name, Time of Visit, Contact Phone Number, Free Text Message (no attachments)\n\n|CON-CS-008\n|D365 Customer Engagement must be decommissioned within 90 days post-cutover (ADR-CS-006)\n\n|CON-CS-009\n|ProfileService and EngagementService must be stateless (no local aggregate persistence, Salesforce is System of Record)\n\n|CON-CS-010\n|First DDD bounded context implementation (team learning curve, architectural patterns must be documented for future bounded contexts)\n\n|===\n\n== Non-Functional Requirements\n\n=== Performance Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-PERF-001\n|Mobile App feedback submission API response time (ProfileService + EngagementService)\n|p95 < 1 second, p99 < 2 seconds\n\n|NFR-PERF-002\n|ProfileService Contact reconciliation API response time (JIT lookup)\n|p95 < 500ms, p99 < 1 second\n\n|NFR-PERF-003\n|EngagementService async Case creation latency (end-to-end: feedback submitted → Case created in Salesforce)\n|p95 < 5 minutes, p99 < 10 minutes\n\n|NFR-PERF-004\n|Salesforce API call latency (Contact query, Contact create, Case create)\n|p95 < 2 seconds, p99 < 5 seconds\n\n|NFR-PERF-005\n|Event Bus message processing throughput\n|> 100 messages/second (support peak feedback volume)\n\n|NFR-PERF-006\n|Braze push notification delivery latency (Case created → notification delivered)\n|p95 < 30 seconds, p99 < 60 seconds\n\n|===\n\n=== Availability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-AVAIL-001\n|ProfileService availability\n|99.9% uptime (8.76 hours downtime/year)\n\n|NFR-AVAIL-002\n|EngagementService availability\n|99.9% uptime (8.76 hours downtime/year)\n\n|NFR-AVAIL-003\n|Feedback submission success rate (including async Case creation)\n|> 99.5% (includes retry logic for transient failures)\n\n|NFR-AVAIL-004\n|Graceful degradation: Salesforce downtime handling\n|Feedback submission still succeeds, Cases queued for async creation when Salesforce recovers\n\n|NFR-AVAIL-005\n|Graceful degradation: Braze downtime handling\n|Case creation proceeds, push notifications disabled temporarily (feature flag)\n\n|NFR-AVAIL-006\n|Planned maintenance window\n|< 4 hours/month, scheduled during low-traffic periods (2-6am ACST)\n\n|===\n\n=== Scalability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-SCALE-001\n|Concurrent Mobile App users (peak)\n|Support 20,000 DAU (Daily Active Users), ~150 concurrent users submitting feedback during peak hours\n\n|NFR-SCALE-002\n|Feedback submissions per day\n|Expected: 100-150 submissions/day based on 20k DAU (~0.5-0.75% submission rate) +\nCapacity: Support 500 submissions/day (3x expected volume for growth), 2,000 submissions/day (peak/incident scenarios)\n\n|NFR-SCALE-003\n|Auto-scaling: ProfileService and EngagementService\n|Auto-scale based on CPU/memory/request rate, scale up within 2 minutes\n\n|NFR-SCALE-004\n|Event Bus queue capacity\n|Support 100,000 queued messages (buffer for Salesforce downtime)\n\n|NFR-SCALE-005\n|Salesforce API rate limit compliance\n|Stay within 80% of Salesforce API rate limits (buffer for spikes)\n\n|NFR-SCALE-006\n|Future growth capacity\n|Architecture supports 10x growth (1,000-1,500 submissions/day based on 200k DAU) without major redesign\n\n|===\n\n=== Security Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-SEC-001\n|Mobile App authentication\n|Microsoft Entra External ID OAuth 2.0 with JWT tokens (existing CIAM)\n\n|NFR-SEC-002\n|API authorisation: ProfileService and EngagementService\n|JWT token validation, authenticated users only, user context propagation\n\n|NFR-SEC-003\n|Salesforce API authentication\n|OAuth 2.0 with Connected App and JWT bearer flow (service account)\n\n|NFR-SEC-004\n|Data encryption in transit\n|TLS 1.2+ for all API calls (Mobile App ↔ ProfileService/EngagementService ↔ Salesforce ↔ Braze)\n\n|NFR-SEC-005\n|Data encryption at rest\n|Salesforce encryption at rest (managed by Salesforce), Event Bus message encryption (AWS KMS)\n\n|NFR-SEC-006\n|Secret management\n|AWS Secrets Manager for Salesforce credentials, Braze API keys, OAuth tokens (no hardcoded secrets)\n\n|NFR-SEC-007\n|PII data handling\n|Contact data (email, phone, name) treated as PII, GDPR-compliant retention policies (Salesforce governance)\n\n|NFR-SEC-008\n|API rate limiting and throttling\n|API Gateway rate limiting (100 requests/second per user), prevent abuse and DoS\n\n|NFR-SEC-009\n|Logging and auditing\n|Log all API calls, Salesforce Contact/Case creates/updates, Event Bus publishes (no PII in logs)\n\n|NFR-SEC-010\n|Salesforce data isolation\n|Multi-tenant data isolation via Salesforce Record Types, queues, sharing rules (defined by Viva Energy admin team)\n\n|===\n\n=== Reliability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-REL-001\n|Retry logic: EngagementService → Salesforce Case creation\n|Exponential backoff (1s, 2s, 4s, 8s, 16s), max 5 retries, then dead letter queue\n\n|NFR-REL-002\n|Dead letter queue monitoring\n|Alert ops team immediately when DLQ depth > 0 (failed Case creations require manual intervention)\n\n|NFR-REL-003\n|Event Bus message durability\n|Messages persisted in Event Bus (SNS+SQS/EventBridge/Kinesis), not lost on service restart\n\n|NFR-REL-004\n|Idempotency: Case creation\n|EngagementService ensures duplicate feedback submissions don't create duplicate Cases (idempotency key)\n\n|NFR-REL-005\n|Circuit breaker: Salesforce API calls\n|Open circuit after 5 consecutive failures, half-open retry after 30 seconds\n\n|NFR-REL-006\n|Health checks: ProfileService and EngagementService\n|Health endpoints for load balancer checks, readiness and liveness probes\n\n|NFR-REL-007\n|Disaster recovery: Event Bus\n|Event Bus messages replicated across AWS availability zones (SQS/EventBridge/Kinesis HA)\n\n|===\n\n=== Maintainability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-MAINT-001\n|Code quality: ProfileService and EngagementService\n|> 80% test coverage (unit + integration tests), automated CI/CD pipeline\n\n|NFR-MAINT-002\n|API documentation\n|OpenAPI/Swagger specs for ProfileService and EngagementService, auto-generated API docs\n\n|NFR-MAINT-003\n|Deployment automation\n|Infrastructure as Code (Terraform/CloudFormation/CDK), zero-downtime deployments\n\n|NFR-MAINT-004\n|Logging: structured logs\n|JSON-formatted logs with correlation IDs, log levels (DEBUG, INFO, WARN, ERROR), centralized log aggregation\n\n|NFR-MAINT-005\n|Monitoring dashboards\n|Real-time dashboards for ProfileService, EngagementService, Event Bus (see Monitoring and Observability section)\n\n|NFR-MAINT-006\n|Alerting and on-call\n|PagerDuty/Opsgenie integration for P1/P2 alerts, on-call rotation for ops team\n\n|NFR-MAINT-007\n|Configuration management\n|Externalized configuration (environment variables, AWS Parameter Store), no hardcoded config\n\n|NFR-MAINT-008\n|Versioning: API and events\n|Semantic versioning (v1, v2), backward compatibility for API changes, event schema evolution\n\n|===\n\n=== Usability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-USE-001\n|Feedback submission UX\n|Mobile App user receives immediate \"Feedback submitted\" confirmation (< 1 second), not blocked by async Case creation\n\n|NFR-USE-002\n|Push notification delivery\n|Customer receives \"Your feedback has been received\" notification within 30 seconds of Case creation in Salesforce\n\n|NFR-USE-003\n|Case resolution notification\n|Customer receives \"Your case has been resolved\" notification within 30 seconds of support agent resolving Case\n\n|NFR-USE-004\n|Error messaging\n|User-friendly error messages for failed feedback submission (not technical errors), retry prompts\n\n|NFR-USE-005\n|Accessibility\n|Mobile App feedback form meets WCAG 2.1 AA accessibility standards (existing Mobile App compliance)\n\n|===\n\n=== Compliance Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-COMP-001\n|GDPR compliance: PII data\n|Customer Contact data (email, phone, name) managed per GDPR retention policies (Salesforce governance)\n\n|NFR-COMP-002\n|GDPR compliance: Right to erasure\n|Support \"Delete Account\" feedback category, trigger Contact deletion in Salesforce per GDPR Article 17\n\n|NFR-COMP-003\n|Data residency\n|Salesforce data residency governed by Viva Energy Salesforce configuration (regional compliance)\n\n|NFR-COMP-004\n|Audit trail\n|All Contact creates/updates, Case creates/updates logged for compliance auditing (Salesforce audit logs)\n\n|NFR-COMP-005\n|API security standards\n|OWASP API Security Top 10 compliance (injection prevention, authentication, authorisation, data exposure)\n\n|===\n\n== Monitoring and Observability\n\n=== Key Metrics\n\n[width=\"100%\",cols=\"25%,40%,35%\",options=\"header\",]\n|===\n|Metric Category |Metric |Target/Threshold\n\n|*Feedback Submission*\n|Feedback submission success rate (Mobile App → EngagementService)\n|> 99.5%\n\n|*Async Case Creation*\n|Case creation success rate (EngagementService → Salesforce)\n|> 99%\n\n|*Async Case Creation*\n|Case creation latency (time from feedback submission to Case created in Salesforce)\n|p95 < 5 minutes\n\n|*Event Bus*\n|Event Bus queue depth (pending Case creations)\n|< 100 messages\n\n|*Event Bus*\n|Dead letter queue depth (failed Case creations)\n|= 0 (alert on any failures)\n\n|*Salesforce API*\n|Salesforce API error rate\n|< 1%\n\n|*Salesforce API*\n|Salesforce API latency (Case creation)\n|p95 < 2 seconds\n\n|*Salesforce API*\n|Salesforce API rate limit utilization\n|< 80% of limit\n\n|*ProfileService*\n|Contact reconciliation success rate (JIT lookups)\n|> 99.5%\n\n|*ProfileService*\n|Contact reconciliation latency\n|p95 < 500ms\n\n|*Braze Notifications*\n|Push notification delivery rate (Case created/updated)\n|> 95%\n\n|*Salesforce Webhook*\n|Webhook delivery success rate (Salesforce → EngagementService)\n|> 99%\n\n|*Customer Satisfaction*\n|Customer satisfaction score (CSAT)\n|> 4.0/5.0 (improve by 15% from D365 CE baseline)\n\n|*Support Operations*\n|Average case resolution time\n|Decrease by 20% from D365 CE baseline\n\n|===\n\n=== Alerting Thresholds\n\n[width=\"100%\",cols=\"25%,50%,25%\",options=\"header\",]\n|===\n|Alert |Condition |Severity\n\n|*Feedback submission failures*\n|Feedback submission success rate < 95% over 5-minute window\n|P1 - Critical\n\n|*Dead letter queue accumulation*\n|Dead letter queue depth > 0 (any failed Case creations)\n|P2 - High\n\n|*Event Bus queue backlog*\n|Event Bus queue depth > 100 messages for > 15 minutes\n|P2 - High\n\n|*Salesforce API errors*\n|Salesforce API error rate > 5% over 5-minute window\n|P1 - Critical\n\n|*Salesforce API rate limits*\n|Salesforce API rate limit utilization > 90%\n|P2 - High\n\n|*Contact reconciliation failures*\n|ProfileService Contact reconciliation failure rate > 5% over 5-minute window\n|P2 - High\n\n|*Braze notification failures*\n|Braze push notification delivery rate < 80% over 15-minute window\n|P3 - Medium\n\n|*Salesforce webhook failures*\n|Salesforce webhook delivery success rate < 90% over 15-minute window\n|P2 - High\n\n|*Case creation latency*\n|Case creation latency p95 > 10 minutes\n|P3 - Medium\n\n|===\n\n=== Dashboards\n\n*ProfileService Dashboard:*\n\n* Contact reconciliation success rate (JIT lookups)\n* Contact reconciliation latency (p50, p95, p99)\n* Contact creation vs update ratio (new Contacts created vs existing Contacts updated)\n* Salesforce API error rate (Contact queries and creates)\n* Request rate and throughput\n\n*EngagementService Dashboard:*\n\n* Feedback submission success rate\n* Case creation success rate (async workflow)\n* Case creation latency (p50, p95, p99)\n* Event Bus queue depth (pending Case creations)\n* Dead letter queue depth (failed Case creations)\n* Salesforce API error rate (Case creation)\n* Salesforce API latency\n* Salesforce API rate limit utilization\n* Braze push notification delivery rate\n* Salesforce webhook delivery success rate\n\n*Event Bus Dashboard:*\n\n* Queue depth (pending messages)\n* Throughput (messages published/consumed per minute)\n* Dead letter queue depth (failed messages)\n* Consumer lag (time between publish and consume)\n\n*Customer Support Dashboard (Business Metrics):*\n\n* Total feedback submissions per day/week/month\n* Feedback category breakdown (App, Service, Order, Rewards, Refund, Delete Account)\n* Customer satisfaction score (CSAT) trend\n* Average case resolution time trend\n* Case volume by support team/queue\n* Unified customer view adoption (support agent feedback)\n<<<\n== Solution Validation\n\nThis section defines the validation criteria and testing approach for the solution.\n\n=== Functional Validation\n\n==== ProfileService API Testing\n\n*Test Scenarios*:\n1. **Happy Path**: Authenticated user requests Contact ID, existing Contact found in Salesforce, Contact ID returned\n2. **JIT Creation**: Authenticated user requests Contact ID, no existing Contact, new Contact created in Salesforce, Contact ID returned\n3. **Salesforce API Failure**: Salesforce unavailable, ProfileService returns 500 error, user retries\n4. **Invalid JWT**: Unauthenticated request, ProfileService returns 401 error\n\n*Acceptance Criteria*:\n- Contact reconciliation success rate > 99.5%\n- JIT Contact creation completes within 500ms (p95)\n\n==== EngagementService API Testing\n\n*Test Scenarios*:\n1. **Happy Path**: Valid feedback submission, immediate 202 Accepted response, Case created in Salesforce within 5 minutes, Braze notification delivered\n2. **Invalid Category**: Invalid feedback category, 400 Bad Request response with validation error\n3. **Salesforce Downtime**: Salesforce unavailable during async Case creation, message queued, retry logic executes, Case created when Salesforce recovers\n4. **Dead Letter Queue**: Case creation fails after 5 retries, message moved to DLQ, ops team alerted\n5. **Webhook Notification**: Support agent resolves Case in Salesforce, webhook triggers EngagementService, Braze push notification sent to customer\n\n*Acceptance Criteria*:\n- Feedback submission success rate > 99.5% (including async Case creation)\n- Async Case creation completes within 5 minutes (p95)\n- Webhook delivery success rate > 99%\n\n=== Non-Functional Validation\n\n==== Performance Testing\n\n*Load Testing*:\n\n*Baseline*: Expected 100-150 submissions/day from 20k DAU (~0.5-0.75% submission rate)\n\n- **Normal Load**: 1 submission/minute sustained for 2 hours (simulate typical daily pattern)\n- **3x Load**: 3 submissions/minute sustained for 1 hour (simulate busy period, 450 submissions/day)\n- **Peak Load (10x)**: 10 submissions/minute for 15 minutes (simulate incident scenario, app outage causing backlog)\n- **Stress Test**: 50 submissions/minute for 5 minutes (find breaking point, 20x normal)\n\n*Validation*:\n- API response time p95 < 1 second under 10x load\n- Event Bus queue depth remains manageable (< 100 messages)\n- No Case creation failures, all submissions processed successfully\n- Auto-scaling triggers appropriately for sustained load > 3x baseline\n\n*Acceptance Criteria*:\n- NFR-PERF-001 through NFR-PERF-006 validated under realistic load (3x and 10x baseline)\n- Auto-scaling triggers within 2 minutes of load increase\n- System handles 10x peak gracefully, 20x stress test identifies limits\n\n==== Resilience Testing\n\n*Salesforce API Failure Scenarios*:\n1. **Complete Outage**: Salesforce unavailable for 2 hours, Event Bus queues buffer work, Cases created when Salesforce recovers\n2. **Rate Limit Exceeded**: Salesforce rate limit hit, queue throttling activates, Cases created within SLA\n\n*Acceptance Criteria*:\n- NFR-AVAIL-004 validated (graceful degradation during Salesforce downtime)\n- Circuit breaker activates after 5 consecutive failures\n\n==== Security Validation\n\n*Penetration Testing*:\n- API authentication bypass attempts\n- SQL injection attempts\n- Webhook signature validation bypass\n\n*Acceptance Criteria*:\n- NFR-SEC-001 through NFR-SEC-010 validated\n- OWASP API Security Top 10 compliance verified\n\n=== Integration Validation\n\n==== End-to-End Testing\n\n*Full User Journey*:\n1. User authenticates via Microsoft Entra External ID\n2. Mobile App requests Contact ID from ProfileService (JIT reconciliation)\n3. User submits feedback via EngagementService\n4. Background worker creates Case in Salesforce\n5. Braze notification delivered to user\n6. Support agent resolves Case in Salesforce\n7. Salesforce webhook triggers EngagementService\n8. Braze notification delivered to user\n\n*Acceptance Criteria*:\n- End-to-end flow completes successfully in UAT\n- User receives both \"feedback submitted\" and \"case resolved\" notifications\n","structuredPatch":[{"oldStart":1896,"oldLines":15,"newStart":1896,"newLines":15,"lines":[" "," *Prerequisites*:"," ","-* WP-CS-001 (ProfileService Development) completed","-* WP-CS-002 (EngagementService Development) completed","-* WP-CS-003 (Event Bus Infrastructure) completed","-* WP-CS-005 (Mobile App Integration) completed","-* WP-CS-007 (Salesforce Configuration) sandbox configuration completed","+* <<wp-cs-001,WP-CS-001>> (ProfileService Development) completed","+* <<wp-cs-002,WP-CS-002>> (EngagementService Development) completed","+* <<wp-cs-003,WP-CS-003>> (Event Bus Infrastructure) completed","+* <<wp-cs-005,WP-CS-005>> (Mobile App Integration) completed","+* <<wp-cs-007,WP-CS-007>> (Salesforce Configuration) sandbox configuration completed"," "," *Dependent Work Packages*:"," ","-* Must complete after WP-CS-001, WP-CS-002, WP-CS-003, WP-CS-005 (requires all components available)","+* Must complete after <<wp-cs-001,WP-CS-001>>, <<wp-cs-002,WP-CS-002>>, <<wp-cs-003,WP-CS-003>>, <<wp-cs-005,WP-CS-005>> (requires all components available)"," "," ==== Skills Required"," "]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"1e5f0096-da5f-40f5-a374-55314ced5a9c"}
{"parentUuid":"fb740b3c-e0b1-49ca-8b00-b7ded5d86e2c","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Gtuej9iYhk7A6f3aPFaivt","type":"tool_result","content":"The file /mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n  1975→* Technical decision on authentication method (OAuth 2.0 JWT bearer flow recommended)\n  1976→\n  1977→*Dependent Work Packages*:\n  1978→\n  1979→* None (can start in parallel with development work packages)\n  1980→* Required for <<wp-cs-002,WP-CS-002>> (EngagementService needs field mapping)\n  1981→* Required for <<wp-cs-006,WP-CS-006>> (Integration Testing needs sandbox configuration)\n  1982→\n  1983→==== Skills Required\n  1984→\n  1985→* Salesforce administration"}]},"uuid":"062a9e20-e366-483d-ac79-5c5fdb6eaf7d","timestamp":"2026-01-09T03:11:42.709Z","toolUseResult":{"filePath":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","oldString":"* None (can start in parallel with development work packages)\n* Required for WP-CS-002 (EngagementService needs field mapping)\n* Required for WP-CS-006 (Integration Testing needs sandbox configuration)","newString":"* None (can start in parallel with development work packages)\n* Required for <<wp-cs-002,WP-CS-002>> (EngagementService needs field mapping)\n* Required for <<wp-cs-006,WP-CS-006>> (Integration Testing needs sandbox configuration)","originalFile":"= Salesforce Customer Support - Solution Architecture\n:project-name: Salesforce Customer Support\n:togaf-adm-phase: Phase E: Opportunities & Solutions\n:last-updated: 2026-01-07\n:document-type: Solution Architecture Document\n:status: Discovery\n:version: 0.1\n:domain: Customer Support & Engagement\n:programme-lead:\n:domain-architect: O.Young@otr.com.au\n:architecture-definition: xref:architecture-definitions:salesforce_customer_support.adoc[Architecture Definitions/Salesforce Customer Support]\n:doctype: article\n:toc: left\n:toclevels: 4\n:sectanchors:\n:sectlinks:\n:sectnums:\n:icons: font\n:source-highlighter: highlightjs\n:experimental:\n:description:\n:keywords:\n\n<<<\n== Purpose and Scope\n\n=== Purpose\n\nThis Solution Architecture defines how the Salesforce Customer Support consolidation will be implemented - the specific technology products, configurations, interfaces, and deployment architecture that realise the xref:architecture-definitions:salesforce_customer_support.adoc[Salesforce Customer Support Architecture Definition].\n\nThis solution establishes the **first implementation of OTR's target Domain-Driven Design (DDD) architecture** by deploying two new bounded contexts (`ProfileService` and `EngagementService`) as microservices, consolidating customer support onto Salesforce Service Cloud, and implementing event-driven integration patterns that will serve as the foundation for future bounded contexts (including Flybuys integration).\n\n=== Vision\n\n> Unify customer support across all OTRG channels by consolidating OTR digital customer feedback onto Salesforce Service Cloud, establishing the foundational DDD architecture with ProfileService and EngagementService bounded contexts that protect digital channels from external system changes while enabling support agents to deliver exceptional customer experiences with complete interaction history.\n\n=== Architectural Approach\n\nThis architecture establishes OTR's **first bounded context implementation** using Domain-Driven Design strategic patterns:\n\n* *link:../bounded_context/profile.adoc[ProfileService]* (NEW bounded context): Just-In-Time Contact reconciliation with Salesforce, upsert by email, returns Salesforce Contact ID to digital channels - foundation for future Flybuys partner linking\n* *link:../bounded_context/engagement.adoc[EngagementService]* (NEW bounded context): Customer feedback submission facade, Anti-Corruption Layer for Salesforce Case creation, Braze integration for all outbound customer communications (push, email, SMS), async Case processing via Event Bus\n* *Event-driven integration* (NEW pattern): Domain event publishing using existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis) - first implementation establishing pattern for future bounded contexts\n* *Anti-Corruption Layer*: EngagementService isolates digital channels from Salesforce API changes, translates between OTR domain language and Salesforce Service Cloud API\n* *Conformist Pattern*: ProfileService and EngagementService conform to existing Salesforce configuration (shared Viva Energy instance, multi-tenant governance)\n* *Big bang cutover*: Single deployment after Contact migration, no phased rollout, D365 CE retirement post-cutover\n\n=== Scope\n\n==== In Scope\n\n* Solution Building Blocks (SBBs) - specific technology products and versions\n* Interface specifications (APIs, events, data formats)\n* Data architecture and schema specifications\n* Deployment architecture and infrastructure configuration\n* Transition architecture with migration phases\n* Technical validation criteria and testing approach\n* External system integration specifications\n* Physical data models and API schemas\n\n==== Out of Scope\n\n===== Covered in xref:architecture-definitions:salesforce_customer_support.adoc[Architecture Definition]\n\n* Business requirements and stakeholder analysis\n* Architecture decisions and rationale (ADRs)\n* Bounded context definitions and responsibilities\n* High-level integration patterns (ACL, Conformist, OHS+PL)\n* Business capability mapping and value streams\n* Architecture principles and governance\n\n===== Covered in Other Documents\n\n* Detailed design (class diagrams, sequence diagrams for all flows)\n* Implementation code and unit tests\n* Business case and return-on-investment analysis\n* Operational run books and support procedures\n\n<<<\n=== Architecture Overview\n\n[mermaid]\n----\n---\nconfig:\n  layout: elk\n---\nflowchart TB\n    Customer([\"Customer\"]) -- Uses --> MobileApp[\"Mobile App<br>iOS/Android\"]\n    Customer -- Shops at --> POS[\"OTR/OTR+ POS<br>D365 Commerce\"]\n    MobileApp -- Authenticate --> EntraID[\"Microsoft Entra\"]\n    MobileApp -- Identifies & Reconciles --> ProfileService[\"ProfileService\"]\n    ProfileService <-- Reconcile App User as Salesforce Contact --> Salesforce[\"Salesforce\"]\n    ProfileService -- On Create --> EventBus[\"EventBus\"]\n    EventBus -- Emits CreateUser Event --> LoyaltyService[\"LoyaltyService\"] & EngagementService[\"EngagementService\"]\n    LoyaltyService -- Reconcile Wallet --> EagleEye[\"EagleEye\"]\n    EngagementService -- Reconcile Braze Profile --> Braze[\"Braze\"]\n    EngagementService --> Salesforce\n    D365CE[\"D365CE\"] -- Data Migration --> Salesforce\n    MobileApp -- Submits Feedback --> EngagementService\n\n    Customer:::customer\n    MobileApp:::presentation\n    POS:::presentation\n    EntraID:::external\n    ProfileService:::newService\n    Salesforce:::external\n    EventBus:::infrastructure\n    LoyaltyService:::newService\n    EngagementService:::newService\n    EagleEye:::external\n    Braze:::external\n    D365CE:::external\n    classDef newService fill:#4CAF50,stroke:#2E7D32,stroke-width:3px,color:#fff\n    classDef external fill:#FF9800,stroke:#E65100,stroke-width:2px,color:#fff\n    classDef infrastructure fill:#2196F3,stroke:#0D47A1,stroke-width:2px,color:#fff\n    classDef presentation fill:#9C27B0,stroke:#4A148C,stroke-width:2px,color:#fff\n    classDef customer fill:#607D8B,stroke:#263238,stroke-width:2px,color:#fff\n----\n\n\n==== Key Architectural Patterns\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Pattern |Application |Rationale\n\n|*Anti-Corruption Layer (ACL)*\n|EngagementService → Salesforce Service Cloud\n|Protects digital channels (Mobile App, Web) from Salesforce API changes, translates between OTR domain language and Salesforce Case/Contact model, enables independent evolution of internal domain model\n\n|*Conformist*\n|ProfileService → Salesforce, EngagementService → Salesforce\n|Shared Viva Energy Salesforce instance - we conform to existing configuration, governance, and API contracts (external system we don't control)\n\n|*Backend-for-Frontend (BFF)*\n|EngagementService\n|Aggregates customer feedback submission, Contact lookup, async Case creation, and Braze notification orchestration for digital channel clients\n\n|*Event-Driven Architecture (OHS+PL)*\n|Event Bus (SNS+SQS/EventBridge/Kinesis)\n|Loose coupling between bounded contexts, async domain event publishing (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`), foundation for future bounded contexts\n\n|*Just-In-Time (JIT) Integration*\n|ProfileService → Salesforce Contact reconciliation\n|Reconcile app users as Salesforce Contacts on-demand (upsert by email), no pre-sync required, ensures Salesforce has current Contact data\n\n|*Async Processing*\n|EngagementService Case creation via Event Bus\n|Non-blocking user experience, resilience to Salesforce downtime, automatic retry with exponential backoff, dead letter queue for operations team intervention\n\n|*Strangler Fig*\n|Not applicable\n|Big bang cutover (no gradual migration) - D365 CE fully replaced, not incrementally strangled\n\n|===\n\n<<<\n== Solution Approach\n\n* Deploy xref:bounded-contexts:profile.adoc[ProfileService] and xref:bounded-contexts:engagement.adoc[EngagementService] as bounded context microservices\n* Implement Anti-Corruption Layers (ACLs) for Salesforce and Braze integration\n* Establish event-driven architecture as the foundational integration pattern\n* Big bang cutover (TS-1 → TS-4)\n\n=== Related Documentation\n\nThis solution architecture references detailed technical specifications:\n\n==== Architecture Definition\n\n* xref:architecture-definitions:salesforce_customer_support.adoc[Salesforce Customer Support - Architecture Definition] - Business requirements, architecture decisions (ADRs), bounded context definitions, high-level integration patterns\n\n==== Bounded Context Specifications\n\n* xref:bounded-contexts:profile.adoc[ProfileService Bounded Context] - JIT Contact reconciliation, aggregate definitions\n* xref:bounded-contexts:engagement.adoc[EngagementService Bounded Context] - Customer feedback facade, Anti-Corruption Layer\n\n==== Interface Specifications\n\nDetailed API specifications available in the specifications directory:\n\n* link:../../specifications/rest/profile-service-v1.yaml[ProfileService REST API v1] - OpenAPI 3.0 specification for `/profile/v1` endpoints (includes Salesforce Contact reconciliation `GET /contact-id`)\n* link:../../specifications/rest/engagement-service-v1.yaml[EngagementService REST API v1] - OpenAPI 3.0 specification for `/engagement/v1` endpoints (includes `POST /feedback`)\n* link:../../specifications/events/engagement-events.json[Engagement Domain Events] - CloudEvents 1.0 JSON Schema for `SupportCaseCreated`, `SupportCaseUpdated`, `SupportCaseResolved`, `CustomerFeedbackSubmitted`\n\n==== External System Documentation\n\n* https://developer.salesforce.com/docs/atlas.en-us.api_rest.meta/api_rest/[Salesforce REST API Documentation] - Contact and Case object APIs\n* https://www.braze.com/docs/api/endpoints/messaging/send_messages/post_send_triggered_campaigns/[Braze Campaign Trigger API] - Push notification campaigns\n\n<<<\n== Executive Summary\n\n=== Challenge\n\nOTR digital customers (Mobile App, Web) currently submit feedback and support requests to D365 Customer Engagement, while Viva Energy's broader business units (fuel wholesale, Shell Card customers, other retail channels) use Salesforce Service Cloud. This creates:\n\n* *Fragmented customer support platform*: Customer support data split across two systems, preventing support agents from having a unified view of customer interactions across all channels\n* *Operational inefficiency*: Maintaining two separate customer support platforms increases operational overhead and costs\n* *Poor support experience*: D365 CE is not working well for digital customer support, impacting customer satisfaction and case resolution times\n* *Post-merger consolidation opportunity*: Following Viva Energy's acquisition of OTR, strategic alignment on Salesforce as the enterprise customer support platform\n\n=== Solution\n\nThis architecture establishes the **foundational Domain-Driven Design (DDD) implementation** for OTR's target state architecture by introducing two new bounded contexts (link:../bounded_context/profile.adoc[ProfileService], link:../bounded_context/engagement.adoc[EngagementService]) and event-driven integration patterns:\n\n==== New Bounded Contexts\n\n* *link:../bounded_context/profile.adoc[ProfileService]* (NEW): Just-In-Time (JIT) Contact reconciliation with Salesforce, upsert by email, returns Salesforce Contact ID to Mobile App\n* *link:../bounded_context/engagement.adoc[EngagementService]* (NEW): Customer feedback submission, Anti-Corruption Layer (ACL) for Salesforce Case creation, Braze integration for all outbound customer communications (push, email, SMS), async Case processing via Event Bus\n* *Event Bus* (NEW pattern): Domain event publishing using existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis) - first implementation of event-driven architecture pattern\n\n==== Integration Architecture\n\n* *Salesforce = System of Record*: Salesforce Service Cloud (shared Viva Energy instance) owns Contact and Case data\n* *Conformist Pattern*: ProfileService and EngagementService conform to existing Salesforce configuration and API contracts\n* *Anti-Corruption Layer*: EngagementService protects digital channels from Salesforce API changes, translates between OTR domain language and Salesforce\n* *Async Case Creation*: Non-blocking user experience, resilience to Salesforce downtime, automatic retry with exponential backoff, dead letter queue for failed Cases\n* *Event-Driven Notifications*: Salesforce webhook → EngagementService → Braze for all customer communications (push, email, SMS) on Case status updates\n\n==== Migration Approach\n\n* *Contact Migration*: One-time migration from app-specific database → Salesforce (upsert with flexible matching by email/phone/VCI)\n* *No Case Migration*: Historical D365 CE Cases not migrated (fresh start in Salesforce)\n* *Big Bang Cutover*: Single deployment, no phased rollout or parallel run\n* *D365 CE Retirement*: Complete decommissioning of D365 Customer Engagement post-cutover\n\n=== Key Architectural Significance\n\nThis migration establishes the first implementation of OTR's target DDD architecture:\n\n* First bounded contexts implemented (ProfileService, EngagementService)\n* First event-driven domain event pattern (foundation for future bounded contexts)\n* Foundation for Flybuys integration (ProfileService Contact reconciliation reused)\n* Establishes integration patterns (Conformist, ACL, Event-Driven) for future services\n\n=== Success Criteria\n\n* All digital customer feedback routed to Salesforce Service Cloud within 30 days of launch\n* Support agents have unified customer view across all Viva Energy channels (digital, wholesale, Shell Card, other retail)\n* D365 Customer Engagement decommissioned within 90 days post-cutover\n* Customer satisfaction score improves by 15% within 6 months\n* Average case resolution time decreases by 20% within 6 months\n* Zero data loss during Contact migration (100% validation pass rate)\n* Mobile App feedback submission success rate > 99.5% (including async Case creation)\n\n=== Technical Constraints\n\n* Shared Salesforce instance (Viva Energy multi-tenant environment)\n* Conform to existing Salesforce configuration and governance (data isolation strategy TBD with Salesforce admin team)\n* Contact migration must complete before cutover (no parallel run)\n* Async Case creation mandatory (non-blocking user experience)\n* Expected volume: 100-150 feedback submissions/day from 20k DAU (~0.5-0.75% submission rate), architecture capacity planned for 3x-10x growth\n\n=== Open Technical Decisions (TBD)\n\n* Salesforce Case field mapping for digital feedback categories (App, Service, Order, Rewards, Refund, Delete Account)\n* Salesforce data isolation strategy (Record Types, custom fields, queues)\n* Salesforce REST API authentication method (OAuth 2.0, Connected App, JWT bearer flow)\n* Salesforce webhook mechanism for Case updates (Outbound Messages, Platform Events, Process Builder)\n* Retry policy configuration (attempts, backoff intervals)\n* Salesforce API rate limit strategy (expected volume: 100-150 submissions/day from 20k DAU, capacity planning for 3x-10x growth)\n\n== Technical Requirements\n\n[width=\"100%\",cols=\"8%,92%\",options=\"header\",]\n|===\n|ID |Description\n\n|TR-CS-001\n|Every Mobile App user must have a Salesforce Contact record in Salesforce Service Cloud (shared Viva Energy instance)\n\n|TR-CS-002\n|ProfileService must reconcile Mobile App users as Salesforce Contacts using Just-In-Time (JIT) upsert by email address\n\n|TR-CS-003\n|ProfileService must return Salesforce Contact ID to Mobile App for feedback submission\n\n|TR-CS-004\n|Mobile App must support customer feedback submission with fields: Category (App, Service, Order, Rewards, Refund, Delete Account), Store Name, Time of Visit, Contact Phone Number, Free Text Message\n\n|TR-CS-005\n|EngagementService must create Salesforce Cases asynchronously via Event Bus (non-blocking user experience)\n\n|TR-CS-006\n|EngagementService must acknowledge feedback submission immediately to Mobile App user (\"Feedback submitted\" confirmation)\n\n|TR-CS-007\n|EngagementService must send push notification to customer via Braze when Case is successfully created in Salesforce\n\n|TR-CS-008\n|EngagementService must retry failed Case creation with configurable exponential backoff and dead letter queue for operations team intervention\n\n|TR-CS-009\n|Salesforce must be the System of Record for Contact and Case data (no local persistence in ProfileService or EngagementService)\n\n|TR-CS-010\n|Contact migration from app-specific database to Salesforce must complete before Mobile App cutover (upsert with flexible matching by email/phone/VCI)\n\n|TR-CS-011\n|No Case migration from D365 Customer Engagement to Salesforce (fresh start, historical Cases not migrated)\n\n|TR-CS-012\n|EngagementService must publish domain events (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`) to Event Bus for consumption by other bounded contexts\n\n|TR-CS-013\n|EngagementService must receive Salesforce webhook notifications when Cases are updated/resolved by support agents\n\n|TR-CS-014\n|EngagementService must trigger Braze push notifications to customers when Cases are updated/resolved (via Salesforce webhook → EngagementService → Braze)\n\n|TR-CS-015\n|ProfileService and EngagementService must conform to existing Salesforce configuration and API contracts (Conformist pattern)\n\n|TR-CS-016\n|All changes must be communicated using event-driven architecture via Event Bus (using existing AWS infrastructure: SNS+SQS/EventBridge/Kinesis)\n\n|TR-CS-017\n|Mobile App feedback submission success rate must exceed 99.5% (including async Case creation completion)\n\n|TR-CS-018\n|Contact migration must achieve 100% validation pass rate (zero data loss)\n\n|TR-CS-019\n|D365 Customer Engagement must be fully decommissioned within 90 days post-cutover\n\n|===\n\n== Technical Architecture\n\n=== Technical Capability Requirements\n\n==== Requirements Traceability\n\n[width=\"100%\",cols=\"15%,50%,35%\",options=\"header\",]\n|===\n|Requirement ID |Requirement Summary |Architectural Building Blocks\n\n|TR-CS-001\n|Every Mobile App user must have Salesforce Contact record\n|ABB-CS-001 (ProfileService), ABB-CS-004 (Salesforce), ABB-CS-007 (Contact Migration Tool)\n\n|TR-CS-002\n|ProfileService JIT Contact reconciliation via upsert by email\n|ABB-CS-001 (ProfileService), ABB-CS-004 (Salesforce)\n\n|TR-CS-003\n|ProfileService returns Salesforce Contact ID to Mobile App\n|ABB-CS-001 (ProfileService), ABB-CS-006 (Mobile App)\n\n|TR-CS-004\n|Mobile App supports feedback submission with structured fields\n|ABB-CS-006 (Mobile App), ABB-CS-002 (EngagementService)\n\n|TR-CS-005\n|EngagementService creates Salesforce Cases asynchronously\n|ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus), ABB-CS-004 (Salesforce)\n\n|TR-CS-006\n|EngagementService immediate acknowledgment to Mobile App\n|ABB-CS-002 (EngagementService), ABB-CS-006 (Mobile App)\n\n|TR-CS-007\n|EngagementService sends push notification via Braze on Case creation\n|ABB-CS-002 (EngagementService), ABB-CS-005 (Braze)\n\n|TR-CS-008\n|EngagementService retry logic with exponential backoff and DLQ\n|ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus)\n\n|TR-CS-009\n|Salesforce is System of Record for Contact and Case data\n|ABB-CS-004 (Salesforce), ABB-CS-001 (ProfileService - stateless), ABB-CS-002 (EngagementService - stateless)\n\n|TR-CS-010\n|Contact migration before Mobile App cutover\n|ABB-CS-007 (Contact Migration Tool), ABB-CS-004 (Salesforce)\n\n|TR-CS-011\n|No Case migration from D365 CE (fresh start)\n|ABB-CS-004 (Salesforce) - no migration tooling required\n\n|TR-CS-012\n|EngagementService publishes domain events to Event Bus\n|ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus)\n\n|TR-CS-013\n|EngagementService receives Salesforce webhook notifications\n|ABB-CS-002 (EngagementService), ABB-CS-004 (Salesforce)\n\n|TR-CS-014\n|EngagementService triggers Braze notifications on Case updates\n|ABB-CS-002 (EngagementService), ABB-CS-004 (Salesforce), ABB-CS-005 (Braze)\n\n|TR-CS-015\n|ProfileService and EngagementService conform to Salesforce config\n|ABB-CS-001 (ProfileService), ABB-CS-002 (EngagementService), ABB-CS-004 (Salesforce)\n\n|TR-CS-016\n|Event-driven architecture via Event Bus\n|ABB-CS-003 (Event Bus), ABB-CS-002 (EngagementService)\n\n|TR-CS-017\n|Mobile App feedback submission success rate > 99.5%\n|ABB-CS-006 (Mobile App), ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus), ABB-CS-004 (Salesforce)\n\n|TR-CS-018\n|Contact migration 100% validation pass rate\n|ABB-CS-007 (Contact Migration Tool), ABB-CS-004 (Salesforce)\n\n|TR-CS-019\n|D365 CE decommissioned within 90 days post-cutover\n|All ABBs (replacement system operational)\n\n|===\n\n=== Service Catalogues\n\n==== Application Portfolio Catalogue\n\n[width=\"100%\",cols=\"20%,15%,15%,15%,35%\",options=\"header\",]\n|===\n|Application |Lifecycle State |Owner |Hosting Platform |Description\n\n|*ProfileService*\n|NEW\n|OTR Platform Team\n|AWS (TBD: Lambda/ECS/EKS)\n|JIT Contact reconciliation with Salesforce, returns Salesforce Contact ID, foundation for Flybuys integration\n\n|*EngagementService*\n|NEW\n|OTR Platform Team\n|AWS (TBD: Lambda/ECS/EKS)\n|Customer feedback submission facade, ACL for Salesforce Case creation, Braze integration for all outbound communications (push, email, SMS), webhook receiver\n\n|*Mobile App (iOS)*\n|ACTIVE (UPDATE)\n|OTR Mobile Team\n|Apple App Store\n|iOS native app with feedback form, integrate with ProfileService and EngagementService APIs\n\n|*Mobile App (Android)*\n|ACTIVE (UPDATE)\n|OTR Mobile Team\n|Google Play Store\n|Android native app with feedback form, integrate with ProfileService and EngagementService APIs\n\n|*Salesforce Service Cloud*\n|ACTIVE (EXPAND)\n|Viva Energy Salesforce Admin Team\n|Salesforce (SaaS)\n|Shared Viva Energy instance, System of Record for Contact and Case data, adding OTR digital customer support\n\n|*Braze*\n|ACTIVE (EXTEND)\n|OTR Marketing Team\n|Braze (SaaS)\n|Marketing automation platform, EngagementService triggers push notifications for Case updates\n\n|*D365 Customer Engagement*\n|RETIRE\n|OTR Support Team\n|Microsoft Azure (SaaS)\n|Legacy customer support platform, decommissioned within 90 days post-cutover\n\n|*App-Specific Customer Database*\n|RETIRE\n|OTR Platform Team\n|AWS (RDS/DynamoDB)\n|Legacy customer contact storage, one-time migration to Salesforce, then deprecated\n\n|*Event Bus*\n|NEW\n|OTR Platform Team\n|AWS (SNS+SQS/EventBridge/Kinesis)\n|Domain event publishing infrastructure for bounded context integration\n\n|*Contact Migration Tool*\n|TEMPORARY\n|OTR Platform Team\n|AWS (Script/Lambda)\n|One-time migration app database → Salesforce with upsert logic, retired after migration complete\n\n|===\n\n==== Technology Capability Requirements\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Technology Capability |Implementation Technology (TBD in detailed design) |Requirements\n\n|*Microservice Hosting*\n|AWS Lambda / ECS / EKS\n|Host ProfileService and EngagementService with auto-scaling, high availability, monitoring\n\n|*API Gateway*\n|AWS API Gateway / Application Load Balancer\n|REST API routing, authentication, rate limiting, request validation for ProfileService and EngagementService\n\n|*Event Bus*\n|AWS SNS+SQS / EventBridge / Kinesis\n|Domain event publishing, async message processing, retry logic, dead letter queue\n\n|*Salesforce Integration*\n|Salesforce REST API / SOAP API\n|Contact CRUD operations, Case creation, webhook notifications, OAuth 2.0 authentication\n\n|*Braze Integration*\n|Braze REST API / SDK\n|Push notification campaign triggers, customer profile reconciliation\n\n|*Authentication & Authorisation*\n|Microsoft Entra External ID / AWS Cognito\n|Mobile App user authentication, API authorisation, JWT token validation\n\n|*Observability & Monitoring*\n|AWS CloudWatch / Datadog / New Relic\n|Application metrics, logs, traces, dashboards, alerting (feedback submission rate, queue depth, API errors)\n\n|*Secret Management*\n|AWS Secrets Manager / Parameter Store\n|Salesforce credentials, Braze API keys, OAuth tokens, encryption keys\n\n|*Database (Migration Tool)*\n|AWS RDS / DynamoDB (read-only access)\n|Contact migration from app-specific database\n\n|*CI/CD Pipeline*\n|GitHub Actions / AWS CodePipeline\n|Automated build, test, deployment for ProfileService, EngagementService, Mobile App\n\n|*Infrastructure as Code*\n|Terraform / AWS CloudFormation / CDK\n|Declarative infrastructure provisioning for Event Bus, microservices, monitoring\n\n|*API Documentation*\n|OpenAPI / Swagger\n|ProfileService and EngagementService API specifications for Mobile App integration\n\n|===\n\n==== Feature Flag Register\n\n*Note*: Per ADR-CS-006 (big bang cutover, not phased rollout), feature flags are minimal and used primarily for emergency rollback/kill switches.\n\n[width=\"100%\",cols=\"20%,15%,35%,30%\",options=\"header\",]\n|===\n|Feature Flag |Default State |Purpose |Rollback Scenario\n\n|*enable_salesforce_feedback_submission*\n|OFF (pre-cutover), ON (post-cutover)\n|Enable/disable feedback submission to EngagementService → Salesforce (kill switch for emergency rollback to D365 CE)\n|Feedback submission success rate < 95%, Salesforce API failures, critical bugs - revert to D365 CE integration\n\n|*enable_async_case_creation*\n|ON\n|Enable/disable async Case creation via Event Bus (fallback to synchronous processing if Event Bus issues)\n|Event Bus infrastructure failures, queue backlog unmanageable - temporary synchronous processing\n\n|*enable_braze_notifications*\n|ON\n|Enable/disable Braze push notifications for Case updates (degrade gracefully if Braze integration fails)\n|Braze API failures, notification delivery rate < 80% - disable notifications temporarily\n\n|*enable_jit_contact_reconciliation*\n|ON\n|Enable/disable ProfileService JIT Contact reconciliation (fallback to cached Contact IDs if Salesforce unavailable)\n|Salesforce API downtime, Contact reconciliation failures > 5% - use cached Contact IDs temporarily\n\n|*enable_salesforce_webhook_processing*\n|ON\n|Enable/disable Salesforce webhook processing for Case updates (fallback to polling if webhook failures)\n|Webhook delivery failures, authentication issues - temporary polling fallback\n\n|===\n\n*Feature Flag Management*:\n\n* Feature flags managed via AWS AppConfig / LaunchDarkly / custom feature flag service (TBD in detailed design)\n* Mobile App feature flags controlled server-side (no app release required for flag changes)\n* Backend service feature flags configured via environment variables / configuration service\n* Feature flag changes logged and audited (who changed, when, reason)\n* Post-cutover monitoring: Gradual removal of feature flags once system stability confirmed (30-60 days)\n\n==== Data Entity Catalogue\n\n[width=\"100%\",cols=\"20%,15%,35%,30%\",options=\"header\",]\n|===\n|Data Entity |System of Record |Key Attributes |Lifecycle\n\n|*Contact*\n|Salesforce Service Cloud\n|• Contact ID (Salesforce 15/18-char ID) +\n• Email (primary matching key) +\n• First Name, Last Name +\n• Phone Number +\n• Viva Consumer ID (VCI) +\n• Account (Viva Energy customer account) +\n• Record Type (OTR Digital vs other channels)\n|Created: ProfileService JIT reconciliation or Contact Migration Tool +\nUpdated: ProfileService JIT upsert (email changes), Salesforce (manual updates by support agents) +\nDeleted: Salesforce retention policy (GDPR/compliance)\n\n|*Case*\n|Salesforce Service Cloud\n|• Case Number (Salesforce auto-generated) +\n• Contact ID (reference to Contact) +\n• Subject (derived from Category) +\n• Description (Free Text Message) +\n• Category (App, Service, Order, Rewards, Refund, Delete Account) +\n• Store Name (OTR location) +\n• Time of Visit +\n• Status (New, In Progress, Resolved, Closed) +\n• Priority, Origin (Mobile App) +\n• Owner (support agent/queue)\n|Created: EngagementService async Case creation +\nUpdated: Support agents (Salesforce UI), EngagementService (webhook processing) +\nDeleted: Salesforce retention policy (archive after X years)\n\n|*Feedback Submission (transient)*\n|None (not persisted)\n|• Salesforce Contact ID +\n• Category +\n• Store Name +\n• Time of Visit +\n• Contact Phone Number +\n• Free Text Message\n|Created: Mobile App user submission +\nProcessed: EngagementService publishes to Event Bus, Case created in Salesforce +\nNot persisted in ProfileService/EngagementService (stateless)\n\n|*Domain Events*\n|Event Bus (ephemeral)\n|**SupportCaseCreated**: +\n• Case Number, Contact ID, Category, Timestamp +\n**SupportCaseUpdated**: +\n• Case Number, Status, Updated By, Timestamp +\n**SupportCaseResolved**: +\n• Case Number, Resolution, Resolved By, Timestamp +\n**CustomerFeedbackSubmitted**: +\n• Contact ID, Category, Timestamp\n|Published: EngagementService +\nConsumed: Other bounded contexts (future), Braze notification triggers +\nRetention: Short-lived (minutes to hours), not persisted for event sourcing\n\n|*Braze Customer Profile*\n|Braze\n|• External User ID (VCI or Email) +\n• Push Notification Tokens (iOS/Android) +\n• Notification Preferences +\n• Campaign Engagement History\n|Created/Updated: EngagementService on Case creation/update +\nManaged: Braze (external SaaS)\n\n|===\n\n*Data Migration Entities*:\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Source Entity |Target Entity |Migration Strategy\n\n|*App Database Contact*\n|Salesforce Contact\n|One-time migration via Contact Migration Tool: +\n• Upsert by email (primary), phone (secondary), VCI (tertiary) +\n• Map: Email → Email, Name → First/Last Name, Phone → Phone, VCI → External ID +\n• Validation: 100% data integrity check, reconciliation report\n\n|*D365 CE Case*\n|Not migrated\n|ADR-CS-005: No Case migration (fresh start in Salesforce) +\nD365 CE Cases archived separately for compliance if needed\n\n|===\n\n==== Data Quality & Validation\n\n*Contact Migration Validation Rules*:\n\n* Email format validation (RFC 5322 compliance)\n* Phone number format validation (E.164 international format)\n* VCI format validation (alphanumeric, length constraints)\n* Duplicate detection: Flag potential duplicates for manual review (same email/phone combination)\n* Mandatory fields: Email (required), First Name, Last Name (required for Salesforce Contact)\n\n*Case Creation Validation Rules*:\n\n* Contact ID must exist in Salesforce (validated by EngagementService before Case creation)\n* Category must be one of: App, Service, Order, Rewards, Refund, Delete Account\n* Free Text Message maximum length: 32,000 characters (Salesforce Case Description limit)\n* Store Name validated against OTR location master data (optional - warn if not found)\n\n<<<\n== Solution Building Blocks\n\nThis section defines the specific technology products, configurations, and implementation details for each Solution Building Block (SBB).\n\n=== Technology Portfolio Catalogue\n\n[width=\"100%\",cols=\"10%,20%,25%,25%,20%\",options=\"header\",]\n|===\n|SBB ID |Component |Technology Product |Version/Configuration |Deployment Platform\n\n|SBB-CS-001\n|ProfileService Microservice\n|.NET 8 / Node.js 20 LTS\n|RESTful API, containerised\n|AWS ECS Fargate / Lambda\n\n|SBB-CS-002\n|EngagementService Microservice\n|.NET 8 / Node.js 20 LTS\n|RESTful API, containerised, async workers\n|AWS ECS Fargate / Lambda\n\n|SBB-CS-003\n|Event Bus\n|AWS SNS + SQS / EventBridge\n|Standard queues, FIFO for ordering\n|AWS (managed service)\n\n|SBB-CS-004\n|API Gateway\n|AWS API Gateway / ALB\n|REST API, JWT validation\n|AWS (managed service)\n\n|SBB-CS-005\n|Salesforce Integration Layer\n|Salesforce REST API Client\n|OAuth 2.0 JWT bearer flow\n|Embedded in SBB-CS-001/002\n\n|SBB-CS-006\n|Braze Integration Layer\n|Braze REST API SDK\n|API key authentication\n|Embedded in SBB-CS-002\n\n|SBB-CS-007\n|Contact Migration Tool\n|Python 3.11 / .NET 8\n|One-time batch script\n|AWS Lambda / EC2\n\n|SBB-CS-008\n|Application Monitoring\n|AWS CloudWatch / Datadog\n|Metrics, logs, traces, dashboards\n|AWS / SaaS\n\n|SBB-CS-009\n|Secret Management\n|AWS Secrets Manager\n|KMS encryption\n|AWS (managed service)\n\n|SBB-CS-010\n|Mobile App (iOS)\n|SwiftUI, Kotlin Multiplatform\n|iOS 15+\n|Apple App Store\n\n|SBB-CS-011\n|Mobile App (Android)\n|Jetpack Compose, Kotlin Multiplatform\n|Android 8+\n|Google Play Store\n\n|SBB-CS-012\n|Feature Flag Service\n|AWS AppConfig / LaunchDarkly\n|Server-side flags, real-time updates\n|AWS / SaaS\n\n|===\n\n<<<\n== Data Architecture\n\nThis section defines the physical data models, event schemas, and API request/response formats.\n\n=== Domain Event Schemas\n\nAll domain events follow the https://cloudevents.io/[CloudEvents 1.0] specification for consistency and interoperability.\n\n*Event Schema Specifications*: See // TODO: Add to Antora - specifications/events/engagement-events.json[Engagement Service Event Schemas] for complete JSON schemas and examples.\n\n==== Event Catalogue\n\n[width=\"100%\",cols=\"30%,20%,50%\",options=\"header\",]\n|===\n|Event Type |Publisher |Description\n\n|`SupportCaseCreated`\n|EngagementService\n|Published when EngagementService successfully creates a Case in Salesforce after async processing\n\n|`SupportCaseUpdated`\n|EngagementService (via Salesforce webhook)\n|Published when a support agent updates a Case in Salesforce (status, priority, comment changes)\n\n|`SupportCaseResolved`\n|EngagementService (via Salesforce webhook)\n|Published when a support agent resolves/closes a Case in Salesforce\n\n|`CustomerFeedbackSubmitted`\n|EngagementService\n|Published when customer submits feedback via Mobile App (before async Case creation)\n\n|===\n\n*Event Format*: All events use CloudEvents 1.0 envelope with event-specific payload in the `data` field.\n\n*Schema Location*: `specifications/events/engagement-events.json`\n\n=== API Request/Response Schemas\n\n==== ProfileService: GET /profile/contact-id\n\n*Response* (200 OK):\n[source,json]\n----\n{\n  \"contactId\": \"0034X00000ABCDEFG\",\n  \"email\": \"customer@example.com\",\n  \"firstName\": \"John\",\n  \"lastName\": \"Smith\"\n}\n----\n\n==== EngagementService: POST /feedback\n\n*Request*:\n[source,json]\n----\n{\n  \"contactId\": \"0034X00000ABCDEFG\",\n  \"category\": \"App\",\n  \"storeName\": \"OTR Adelaide\",\n  \"timeOfVisit\": \"2026-01-07T12:00:00Z\",\n  \"contactPhoneNumber\": \"+61412345678\",\n  \"message\": \"App crashed when submitting feedback\"\n}\n----\n\n*Response* (202 Accepted):\n[source,json]\n----\n{\n  \"feedbackId\": \"fb-2026-01-07-12345\",\n  \"status\": \"submitted\",\n  \"message\": \"Your feedback has been submitted!\"\n}\n----\n\n=== Salesforce Field Mappings\n\n==== Case Object Mapping\n\n[width=\"100%\",cols=\"25%,25%,25%,25%\",options=\"header\",]\n|===\n|OTR Field |Salesforce Field |Data Type |Notes\n\n|Category\n|Feedback_Category__c\n|Picklist\n|App, Service, Order, Rewards, Refund, Delete Account\n\n|Store Name\n|Store_Name__c\n|String (255)\n|OTR location name\n\n|Time of Visit\n|Time_of_Visit__c\n|DateTime\n|When customer visited store\n\n|Free Text Message\n|Description\n|Long Text (32,000)\n|Customer feedback message\n\n|===\n\n<<<\n=== Baseline Architecture\n\n==== Existing System Components\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Component |Current State |Status\n\n|*D365 Customer Engagement*\n|Customer support platform for OTR digital customers (Mobile App, Web), handles feedback submission and case management\n|**DEPRECATED** - Being replaced by Salesforce Service Cloud\n\n|*App-Specific Customer Database*\n|Stores customer contact data for Mobile App users, separate from Viva Energy systems\n|**MIGRATING** - One-time migration to Salesforce, then deprecated\n\n|*Mobile App*\n|iOS/Android native apps with feedback submission form including Category, Store Name, Time of Visit, Contact Phone Number, and Free Text Message fields\n|**REQUIRES UPDATE** - Integrate with ProfileService and EngagementService APIs (feedback form UI already complete)\n\n|*Salesforce Service Cloud*\n|Shared Viva Energy instance handling customer support for fuel wholesale, Shell Card customers, other retail channels\n|**EXPANDING** - Adding OTR digital customer support Cases and Contacts\n\n|*Existing AWS Infrastructure*\n|SNS+SQS / EventBridge / Kinesis available for event-driven architecture\n|**REUSING** - Event Bus implementation leverages existing infrastructure\n\n|===\n\n==== Integration Architecture\n\n*Current state:*\n\n* Mobile App → D365 Customer Engagement (direct integration)\n* App-specific customer database → standalone (no Salesforce integration)\n* No event-driven architecture (synchronous, tightly coupled)\n* No Anti-Corruption Layer protecting digital channels\n* Viva Energy support teams use Salesforce, OTR digital support uses D365 CE (fragmented)\n\n==== Technical Debt\n\n*No longer relevant* - D365 CE being deprecated, not documenting technical debt of system being retired.\n\n*New technical debt introduced by this migration:*\n\n* Salesforce field mapping TBD (requires coordination with Viva Energy Salesforce admin team)\n* Data isolation strategy TBD (Record Types, custom fields, queues - multi-tenant governance)\n* Salesforce webhook mechanism TBD (Outbound Messages vs Platform Events vs Process Builder)\n* Expected feedback volume unknown (gathering data for rate limit planning)\n\n=== Gap Analysis\n\n==== Missing Capabilities\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Missing Capability |Description\n\n|*ProfileService bounded context*\n|No existing service for Contact reconciliation with Salesforce - requires new microservice implementing JIT upsert by email, returning Salesforce Contact ID\n\n|*EngagementService bounded context*\n|No existing service for customer feedback facade - requires new microservice implementing Anti-Corruption Layer for Salesforce Case creation, Braze integration, async processing via Event Bus\n\n|*Event Bus domain event pattern*\n|No existing domain event publishing infrastructure - requires implementing event-driven architecture pattern using existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis)\n\n|*Async Case creation workflow*\n|Current D365 CE integration is synchronous - requires implementing async processing with retry logic, exponential backoff, dead letter queue\n\n|*Salesforce webhook integration*\n|No existing capability to receive Salesforce notifications - requires implementing webhook receiver in EngagementService for Case update notifications\n\n|*Braze push notification orchestration*\n|No existing integration for Case-related push notifications - requires implementing Braze campaign triggers from EngagementService\n\n|*Contact migration tooling*\n|No existing tooling for app database → Salesforce Contact migration with upsert logic (match by email/phone/VCI)\n\n|*Feedback form enhancements*\n|Mobile App feedback form lacks structured fields (Category, Store Name, Time of Visit, Contact Phone Number) - requires UI updates\n\n|===\n\n==== Missing Bounded Contexts\n\n[width=\"100%\",cols=\"30%,30%,40%\",options=\"header\",]\n|===\n|Bounded Context |Responsibilities |Implementation Status\n\n|*link:../bounded_context/profile.adoc[ProfileService]*\n|JIT Contact reconciliation with Salesforce (upsert by email), return Salesforce Contact ID to digital channels, foundation for future Flybuys partner linking\n|**NEW** - First bounded context implementation\n\n|*link:../bounded_context/engagement.adoc[EngagementService]*\n|Customer feedback submission facade, Anti-Corruption Layer for Salesforce Case creation, Braze integration for push notifications, async Case processing, webhook receiver for Case updates\n|**NEW** - First bounded context implementation\n\n|===\n\n==== Missing Integration Patterns\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Integration Pattern |Description\n\n|*Anti-Corruption Layer (ACL)*\n|EngagementService → Salesforce Service Cloud - protects digital channels from Salesforce API changes, translates between OTR domain language and Salesforce\n\n|*Conformist*\n|ProfileService/EngagementService → Salesforce - conform to existing Salesforce configuration and API contracts (shared Viva Energy instance)\n\n|*Event-Driven Architecture (OHS+PL)*\n|Event Bus publishing domain events (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`) for loose coupling between bounded contexts\n\n|*Just-In-Time (JIT) Integration*\n|ProfileService → Salesforce Contact reconciliation on-demand (no pre-sync)\n\n|*Async Processing*\n|EngagementService Case creation via Event Bus with retry, exponential backoff, dead letter queue\n\n|===\n\n=== Target State Architecture\n\n==== Architectural Building Blocks (ABB)\n\n[width=\"100%\",cols=\"20%,25%,30%,25%\",options=\"header\",]\n|===\n|ABB ID |Bounded Context |Responsibilities |Technology (TBD in Solution Architecture)\n\n|ABB-CS-001\n|*link:../bounded_context/profile.adoc[ProfileService]*\n|JIT Contact reconciliation with Salesforce (upsert by email), return Salesforce Contact ID, foundation for Flybuys partner linking\n|Microservice (.NET/Node.js), REST API, Salesforce REST API client\n\n|ABB-CS-002\n|*link:../bounded_context/engagement.adoc[EngagementService]*\n|Customer feedback submission facade, ACL for Salesforce Case creation, Braze integration, async processing, webhook receiver\n|Microservice (.NET/Node.js), REST API, Event Bus publisher/subscriber, Salesforce webhook receiver\n\n|ABB-CS-003\n|*Event Bus*\n|Domain event publishing infrastructure (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`)\n|AWS SNS+SQS / EventBridge / Kinesis\n\n|ABB-CS-004\n|*Salesforce Service Cloud*\n|System of Record for Contact and Case data (shared Viva Energy instance)\n|Salesforce Service Cloud (external SaaS)\n\n|ABB-CS-005\n|*Braze*\n|Marketing automation platform for push notifications\n|Braze (external SaaS) - existing integration\n\n|ABB-CS-006\n|*Mobile App*\n|iOS/Android native apps with enhanced feedback form (Category, Store Name, Time of Visit, Contact Phone Number, Free Text Message)\n|Kotlin Multiplatform, SwiftUI, Jetpack Compose\n\n|ABB-CS-007\n|*Contact Migration Tool*\n|One-time migration app database → Salesforce with upsert logic (match by email/phone/VCI)\n|Script/tool (.NET/Python/Node.js)\n\n|===\n\n==== Integration Architecture\n\n===== Integration Flows\n\n*Customer Feedback Submission (Async):*\n\n1. *Mobile App* → ProfileService: Authenticate user, get Salesforce Contact ID (JIT reconciliation)\n2. *Mobile App* → EngagementService: Submit feedback (POST /feedback with Contact ID, Category, Store Name, Time of Visit, Phone, Message)\n3. *EngagementService* → Mobile App: Immediate acknowledgment (\"Feedback submitted\")\n4. *EngagementService* → Event Bus: Publish work item for async Case creation\n5. *Background Worker* (EngagementService) → Salesforce: Create Case via REST API\n6. *Success*: EngagementService → Event Bus: Publish `SupportCaseCreated` event\n7. *EngagementService* → Braze: Trigger push notification campaign (\"Your feedback has been received, Case #12345\")\n8. *Failure*: Retry with exponential backoff → Dead Letter Queue → Ops team alert\n\n*Case Update Notification (Bidirectional):*\n\n1. *Support Agent* updates/resolves Case in Salesforce\n2. *Salesforce* → EngagementService: Webhook notification (Case updated)\n3. *EngagementService* → Event Bus: Publish `SupportCaseUpdated` or `SupportCaseResolved` event\n4. *EngagementService* → Braze: Trigger push notification campaign (\"Your case has been resolved\")\n\n*Contact Reconciliation (JIT):*\n\n1. *Mobile App user* authenticates\n2. *Mobile App* → ProfileService: GET /profile/contact-id\n3. *ProfileService* → Salesforce: Query Contact by email\n4. *Match found*: Return existing Salesforce Contact ID\n5. *No match*: Create new Contact in Salesforce, return new Contact ID\n6. *ProfileService* → Mobile App: Return Salesforce Contact ID (cached by Mobile App)\n\n===== System of Record Boundaries\n\n[width=\"100%\",cols=\"30%,35%,35%\",options=\"header\",]\n|===\n|Data Entity |System of Record |Rationale\n\n|*Contact*\n|Salesforce Service Cloud\n|Shared Viva Energy instance, unified customer profile across all channels (digital, wholesale, Shell Card, retail)\n\n|*Case*\n|Salesforce Service Cloud\n|Support agents manage Cases in Salesforce, digital channels submit via EngagementService ACL\n\n|*Feedback Submission (transient)*\n|None (no persistence)\n|EngagementService processes feedback and creates Case in Salesforce, no local storage\n\n|*Domain Events*\n|Event Bus (ephemeral)\n|Events published to Event Bus, consumed by subscribers, not persisted long-term (event sourcing not in scope)\n\n|===\n\n==== Data Architecture Principles\n\n===== Aggregate Persistence\n\n*ProfileService:*\n\n* **No local aggregate persistence** - ProfileService is stateless, queries Salesforce on-demand\n* Salesforce Contact is the aggregate root (owned by Salesforce)\n* ProfileService acts as facade/translator, not system of record\n\n*EngagementService:*\n\n* **No local aggregate persistence** - EngagementService is stateless, creates Cases in Salesforce via ACL\n* Salesforce Case is the aggregate root (owned by Salesforce)\n* EngagementService maintains no local Case state (Conformist pattern - trust Salesforce as source of truth)\n* Async processing state managed via Event Bus (work items in queue, not database)\n\n===== Event Store\n\n* **Event Bus** (SNS+SQS/EventBridge/Kinesis) handles domain event publishing\n* Events are **ephemeral** (consumed and discarded, not persisted for event sourcing)\n* No Event Store implementation in this architecture (future enhancement if needed)\n* Event schema versioning TBD in Solution Architecture\n\n\n=== Architecture Decisions\n\n==== ADR-CS-001: Consolidate onto Salesforce Service Cloud (not build custom solution)\n\n*Status*: Accepted\n\n*Context*:\n\n* D365 Customer Engagement not working well for digital customer support\n* Viva Energy already uses Salesforce Service Cloud for fuel wholesale, Shell Card, other retail channels\n* Post-merger opportunity to consolidate onto single platform\n* Alternative: Build custom support platform or use different SaaS\n\n*Decision*:\n\nConsolidate OTR digital customer support onto Salesforce Service Cloud (shared Viva Energy instance).\n\n*Rationale*:\n\n* **Unified customer view**: Support agents see all interactions across channels (digital, wholesale, Shell Card, retail)\n* **Platform consolidation**: Single support platform reduces operational overhead and costs\n* **Proven solution**: Salesforce Service Cloud is established, feature-rich, well-supported\n* **Post-merger alignment**: Strategic decision to standardize on Viva Energy platforms\n* **Avoid custom development**: Building custom support platform would be costly and high-risk\n\n*Consequences*:\n\n* Unified customer support across Viva Energy Group\n* Reduced operational complexity (single platform vs two)\n* Leverage Salesforce capabilities (case routing, knowledge base, AI, omnichannel)\n* ⚠️ Conformist pattern required (shared instance, conform to existing configuration)\n* ⚠️ Multi-tenant governance needed (data isolation, security, queues)\n* ❌ Less control over platform evolution (SaaS vendor, shared instance)\n\n==== ADR-CS-002: Implement ProfileService and EngagementService as first DDD bounded contexts\n\n*Status*: Accepted\n\n*Context*:\n\n* OTR target architecture uses Domain-Driven Design with bounded contexts\n* This migration is opportunity to establish first implementation\n* Alternative: Direct Mobile App → Salesforce integration (no bounded contexts)\n* Alternative: Single monolithic service for all customer-facing APIs\n\n*Decision*:\n\nImplement ProfileService and EngagementService as separate bounded contexts following DDD strategic patterns.\n\n*Rationale*:\n\n* **Foundation for target architecture**: First implementation of DDD pattern for future bounded contexts (Flybuys, LocationService, PaymentService)\n* **Separation of concerns**: ProfileService handles identity/Contact reconciliation, EngagementService handles support/feedback (different responsibilities, different change rates)\n* **Anti-Corruption Layer**: EngagementService protects digital channels from Salesforce API changes\n* **Reusability**: ProfileService Contact reconciliation reused for Flybuys integration\n* **Event-driven architecture**: Establishes pattern for loose coupling between bounded contexts\n\n*Consequences*:\n\n* Establishes DDD architecture foundation for OTR\n* Reusable ProfileService for Flybuys and future integrations\n* Digital channels protected from Salesforce API changes (ACL)\n* Clear bounded context boundaries and responsibilities\n* ⚠️ Increased initial complexity (two new microservices vs direct integration)\n* ⚠️ Requires Event Bus infrastructure implementation\n* ⚠️ Team must learn DDD patterns and bounded context design\n\n==== ADR-CS-003: Async Case creation via Event Bus (not synchronous)\n\n*Status*: Accepted\n\n*Context*:\n\n* Current D365 CE integration is synchronous (user waits for Case creation)\n* Alternative: Keep synchronous integration (Mobile App → EngagementService → Salesforce synchronously)\n* Salesforce API may experience downtime or latency\n\n*Decision*:\n\nImplement async Case creation via Event Bus with immediate user acknowledgment, retry logic, exponential backoff, and dead letter queue.\n\n*Rationale*:\n\n* **Non-blocking user experience**: User gets immediate \"Feedback submitted\" confirmation, not waiting for Salesforce API\n* **Resilience**: If Salesforce is down, feedback still accepted, Case created when Salesforce recovers\n* **Retry logic**: Automatic retry with exponential backoff handles transient failures\n* **Operational visibility**: Dead letter queue alerts ops team to persistent failures\n* **Scalability**: Queue buffering handles traffic spikes\n\n*Consequences*:\n\n* Better user experience (no waiting for Salesforce API)\n* Resilient to Salesforce downtime (queue buffers work)\n* Automatic retry reduces manual intervention\n* Queue depth monitoring provides operational visibility\n* ⚠️ Eventual consistency (user gets success notification after Case created, not immediately)\n* ⚠️ Increased complexity (Event Bus, background workers, retry logic, DLQ)\n* ⚠️ Requires monitoring and alerting for DLQ\n\n==== ADR-CS-004: ProfileService uses email as primary matching key (not VCI)\n\n*Status*: Accepted\n\n*Context*:\n\n* ProfileService needs to reconcile Mobile App users as Salesforce Contacts\n* Alternative matching keys: VCI (Viva Consumer ID), email, phone, Salesforce External ID\n* Email changes are rare but possible\n\n*Decision*:\n\nUse email address as primary matching key for Contact reconciliation (JIT upsert by email).\n\n*Rationale*:\n\n* **Availability**: Email always available for authenticated users\n* **Uniqueness**: Email is unique identifier in Salesforce and Mobile App\n* **Salesforce standard**: Salesforce Contact uses email as standard lookup field\n* **Simplicity**: Single matching key simplifies upsert logic\n* **Edge case acceptable**: Email changes are rare, manual cleanup acceptable\n\n*Consequences*:\n\n* Simple upsert logic (query by email, create if not found)\n* Leverages Salesforce standard email field\n* Email always available from authentication\n* ⚠️ Email changes create duplicate Contacts (rare edge case, manual cleanup)\n* ⚠️ Future enhancement: Add VCI as Salesforce External ID for stable matching\n\n==== ADR-CS-005: No Case migration from D365 CE (fresh start)\n\n*Status*: Accepted\n\n*Context*:\n\n* D365 CE contains historical customer support Cases\n* Alternative: Migrate historical Cases to Salesforce (preserve support history)\n* Alternative: Archive D365 CE Cases separately (read-only access)\n\n*Decision*:\n\nDo not migrate historical Cases from D365 CE to Salesforce. Start fresh in Salesforce.\n\n*Rationale*:\n\n* **Limited value**: Historical D365 CE Cases not critical for future support\n* **Data quality**: D365 CE Case data may be inconsistent or incomplete\n* **Complexity**: Case migration requires mapping D365 CE schema to Salesforce, data transformation, validation\n* **Cost-benefit**: Migration effort outweighs value of historical data\n* **Archive option**: D365 CE Cases can be archived separately if needed (read-only access for auditing)\n\n*Consequences*:\n\n* Simpler migration (Contacts only, no Case migration)\n* Faster time to value (no Case migration delay)\n* Clean start in Salesforce (no legacy data quality issues)\n* ⚠️ Historical Cases not visible in Salesforce (support agents can't see old Cases)\n* ⚠️ D365 CE must remain accessible temporarily for historical Case lookups (if needed)\n* ❌ Loss of historical Case insights (reporting, analytics on old Cases)\n\n==== ADR-CS-006: Big bang cutover (not phased rollout)\n\n*Status*: Accepted\n\n*Context*:\n\n* Alternative: Phased rollout with feature flags (pilot users first, gradual enablement)\n* Alternative: Parallel run (submit to both D365 CE and Salesforce temporarily)\n* Flybuys integration uses phased rollout (AS-1, AS-2, AS-3 architecture states)\n\n*Decision*:\n\nBig bang cutover - migrate Contacts, deploy ProfileService and EngagementService, switch Mobile App, retire D365 CE.\n\n*Rationale*:\n\n* **Simplicity**: No parallel run complexity, no feature flag management\n* **Faster D365 CE retirement**: No extended transition period maintaining two systems\n* **Limited risk**: Customer support not mission-critical (not payment processing), rollback possible\n* **User base manageable**: OTR digital customers smaller than Flybuys integration scope\n* **Different use case**: Flybuys phased rollout manages points accrual complexity, support feedback is simpler\n\n*Consequences*:\n\n* Simpler deployment (single cutover, no AS-1/AS-2/AS-3 states)\n* Faster D365 CE retirement (no extended parallel run)\n* No feature flag complexity or pilot user management\n* ⚠️ Higher cutover risk (all users switch at once)\n* ⚠️ Requires comprehensive testing before cutover\n* ⚠️ Rollback plan required (revert to D365 CE if critical issues)\n\n==== ADR-CS-007: EngagementService receives Salesforce webhooks for Case updates\n\n*Status*: Accepted\n\n*Context*:\n\n* Support agents update/resolve Cases in Salesforce\n* Need to notify customers of Case status changes via push notifications\n* Alternative: Poll Salesforce API for Case updates (inefficient)\n* Alternative: No customer notifications (agents contact customers directly)\n\n*Decision*:\n\nSalesforce sends webhook notifications to EngagementService when Cases are updated/resolved. EngagementService triggers Braze push notifications.\n\n*Rationale*:\n\n* **Real-time notifications**: Customer notified immediately when agent resolves Case\n* **Efficient**: Webhook push model (not polling)\n* **Event-driven**: Aligns with event-driven architecture pattern\n* **Better customer experience**: Proactive notification vs waiting for agent contact\n\n*Consequences*:\n\n* Real-time customer notifications for Case updates\n* Efficient push model (no polling overhead)\n* Bidirectional integration (Mobile App → Salesforce → Mobile App)\n* ⚠️ Salesforce webhook mechanism TBD (Outbound Messages vs Platform Events vs Process Builder)\n* ⚠️ Webhook authentication and security required\n* ⚠️ EngagementService must handle webhook retries and failures\n\n<<<\n== Interface Specifications\n\nThis section provides references to the complete API specifications and event catalogue for ProfileService and EngagementService.\n\n=== REST API Specifications\n\nComplete OpenAPI 3.0 specifications are maintained in the `specifications/rest/` directory:\n\n==== ProfileService API v1\n\n*Specification*: link:../../specifications/rest/profile-service-v1.yaml[profile-service-v1.yaml]\n\n*Base URL*: `https://api.otr.com.au/profile/v1`\n\n*Authentication*: Bearer token (Microsoft Entra External ID JWT)\n\n*Key Endpoints*:\n\n* `GET /contact-id` - Retrieve or create Salesforce Contact ID for authenticated user (Just-In-Time reconciliation)\n** Used by Mobile App before submitting feedback to EngagementService\n** Upserts Salesforce Contact record using email as external key\n** Returns 18-character Salesforce Contact ID with caching (15-minute TTL)\n** Performance SLA: p95 < 300ms (uncached), p95 < 50ms (cached)\n\n==== EngagementService API v1\n\n*Specification*: link:../../specifications/rest/engagement-service-v1.yaml[engagement-service-v1.yaml]\n\n*Base URL*: `https://api.otr.com.au/engagement/v1`\n\n*Authentication*: Bearer token (Microsoft Entra External ID JWT)\n\n*Key Endpoints*:\n\n* `POST /feedback` - Submit customer feedback for async Case creation in Salesforce\n** Accepts contactId, category, storeName, timeOfVisit, contactPhoneNumber, message\n** Returns 202 Accepted immediately (async Case creation in background)\n** Publishes `CustomerFeedbackSubmitted` event for analytics\n** Creates Salesforce Case via Anti-Corruption Layer with retry logic\n** Performance SLA: p95 < 200ms (feedback accepted, not Case creation)\n\n=== Domain Events (AsyncAPI)\n\nComplete CloudEvents 1.0 JSON Schema specifications are maintained in the `specifications/events/` directory:\n\n*Specification*: link:../../specifications/events/engagement-events.json[engagement-events.json]\n\n==== Event Catalogue\n\n[width=\"100%\",cols=\"30%,20%,50%\",options=\"header\",]\n|===\n|Event Type |Publisher |Consumers\n\n|`CustomerFeedbackSubmitted`\n|EngagementService\n|Future bounded contexts, analytics, sentiment analysis\n\n|`SupportCaseCreated`\n|EngagementService\n|Future bounded contexts, analytics\n\n|`SupportCaseUpdated`\n|EngagementService (via Salesforce webhook)\n|Future bounded contexts, analytics\n\n|`SupportCaseResolved`\n|EngagementService (via Salesforce webhook)\n|Future bounded contexts, analytics\n\n|===\n\n==== Event Delivery Guarantees\n\n* **At-least-once delivery**: Events may be delivered multiple times, consumers must handle idempotency\n* **Ordering**: FIFO queues guarantee ordering for events with same `contactId`\n* **Retention**: 4 days (96 hours) in Event Bus\n* **Dead Letter Queue**: Failed events after 5 retries moved to DLQ for manual intervention\n* **Format**: CloudEvents 1.0 specification with JSON payload\n\n=== API Versioning Policy\n\n==== Version Numbering\n\n* **Format**: `/v{major}` in URL path (e.g., `/profile/v1`, `/engagement/v1`)\n* **Semantic Versioning**: Major version incremented for breaking changes only\n* **Backwards Compatibility**: Minor changes (new optional fields, new endpoints) don't require version bump\n\n==== When to Version\n\n*Breaking changes requiring new major version*:\n\n- Removing or renaming fields in request/response\n- Changing field data types (e.g., string → number)\n- Changing authentication mechanism\n- Removing endpoints\n\n*Non-breaking changes not requiring version bump*:\n\n- Adding new optional fields to request/response\n- Adding new endpoints\n- Expanding enum values (e.g., adding new feedback category)\n- Improving error messages\n\n==== Parallel Version Support\n\n* Support N and N-1 versions concurrently for 6 months\n* Deprecation notice: 3 months before sunsetting old version\n* Mobile App must upgrade to new version within deprecation window\n\n<<<\n== Work Packages\n\nThis section consolidates gaps and activities into implementable work packages aligned with TOGAF Phase E requirements.\n\n=== Work Package Overview\n\n[width=\"100%\",cols=\"15%,35%,25%,25%\",options=\"header\",]\n|===\n|Work Package ID |Name |Transition State |Key Deliverables\n\n|WP-CS-001\n|ProfileService Development\n|TS-1 (Build & Test)\n|ProfileService microservice, Salesforce Contact integration, REST API\n\n|WP-CS-002\n|EngagementService Development\n|TS-1 (Build & Test)\n|EngagementService microservice, Anti-Corruption Layer, Braze integration\n\n|WP-CS-003\n|Event Bus Infrastructure\n|TS-1 (Build & Test)\n|Event Bus configuration, CloudEvents schemas, monitoring\n\n|WP-CS-004\n|Contact Migration Tooling\n|TS-1 (Build & Test)\n|Migration tool, validation scripts, reconciliation reporting\n\n|WP-CS-005\n|Mobile App Integration\n|TS-1 (Build & Test)\n|Mobile App API integration, feedback form enhancements, testing\n\n|WP-CS-006\n|Integration Testing\n|TS-1 (Build & Test)\n|Test environments, integration test suites, UAT execution\n\n|WP-CS-007\n|Salesforce Configuration\n|TS-1 (Build & Test)\n|Salesforce field mapping, data isolation, webhook configuration\n\n|WP-CS-008\n|Contact Data Migration\n|TS-2 (Contact Migration)\n|Contact migration execution, validation, reconciliation\n\n|WP-CS-009\n|Production Deployment\n|TS-3 (Cutover)\n|Production deployment, smoke testing, go-live execution\n\n|WP-CS-010\n|Post-Cutover Support\n|TS-4 (Target State)\n|Monitoring, issue resolution, D365 CE retirement\n\n|===\n\n[[wp-cs-001]]\n=== WP-CS-001: ProfileService Development\n\n==== Description\n\nBuild ProfileService bounded context microservice implementing Just-In-Time Contact reconciliation with Salesforce Service Cloud.\n\n==== Deliverables\n\n* ProfileService microservice application\n** REST API implementation (OpenAPI 3.0 specification)\n** `GET /contact-id` endpoint (Salesforce Contact reconciliation)\n** Authentication/authorization with Microsoft Entra External ID\n** Caching layer (15-minute TTL for Contact IDs)\n* Salesforce integration\n** Salesforce REST API client\n** Contact upsert by email (external key matching)\n** Error handling and retry logic\n* Unit tests (>80% code coverage)\n* Integration tests with Salesforce sandbox\n* API documentation\n* Deployment configuration (IaC - Infrastructure as Code)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* Salesforce sandbox environment provisioned\n* Microsoft Entra External ID OAuth configuration\n* Development environment setup (AWS dev account, CI/CD pipeline)\n\n*Dependent Work Packages*:\n\n* None (can start immediately after prerequisites met)\n\n==== Skills Required\n\n* Backend development (.NET Core or Node.js)\n* REST API design and implementation\n* Salesforce REST API integration\n* OAuth 2.0 / JWT authentication\n* Caching strategies (Redis/ElastiCache)\n* Unit/integration testing frameworks\n* Infrastructure as Code (Terraform/CloudFormation)\n\n==== Acceptance Criteria\n\n* All API endpoints return correct HTTP status codes per OpenAPI specification\n* Contact ID retrieval achieves p95 < 300ms (uncached), p95 < 50ms (cached)\n* Salesforce Contact upsert succeeds with 100% accuracy in sandbox testing\n* Unit test coverage > 80%\n* Integration tests pass in sandbox environment\n* API documentation generated from OpenAPI specification\n\n[[wp-cs-002]]\n=== WP-CS-002: EngagementService Development\n\n==== Description\n\nBuild EngagementService bounded context microservice implementing customer feedback submission, Anti-Corruption Layer for Salesforce Case creation, Braze integration, and webhook receiver for Case updates.\n\n==== Deliverables\n\n* EngagementService microservice application\n** REST API implementation (OpenAPI 3.0 specification)\n** `POST /feedback` endpoint (async feedback submission)\n** Authentication/authorization with Microsoft Entra External ID\n** Webhook receiver endpoint for Salesforce Case updates\n* Anti-Corruption Layer (ACL)\n** OTR domain model to Salesforce API translation\n** Category enum mapping (App/Service/Order/Rewards → Salesforce Case fields)\n** Salesforce REST API client for Case creation\n* Async processing infrastructure\n** Event Bus publisher integration\n** Background worker for Case creation\n** Retry logic with exponential backoff (5 attempts)\n** Dead Letter Queue integration\n* Braze integration\n** Braze campaign trigger API client\n** Push notification orchestration for Case updates\n* Domain event publishing\n** `CustomerFeedbackSubmitted` event publisher\n** `SupportCaseCreated` event publisher\n** `SupportCaseUpdated` event translator (Salesforce webhook → domain event)\n** `SupportCaseResolved` event translator (Salesforce webhook → domain event)\n* Unit tests (>80% code coverage)\n* Integration tests (EngagementService ↔ Salesforce, EngagementService ↔ Braze)\n* API documentation\n* Deployment configuration (IaC)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* <<wp-cs-003,WP-CS-003>> (Event Bus Infrastructure) completed\n* Salesforce sandbox environment provisioned\n* Braze API credentials and campaign templates configured\n* Microsoft Entra External ID OAuth configuration\n\n*Dependent Work Packages*:\n\n* <<wp-cs-003,WP-CS-003>> must be completed first (Event Bus required for async processing)\n* <<wp-cs-007,WP-CS-007>> (Salesforce Configuration) must be in progress (field mapping needed)\n\n==== Skills Required\n\n* Backend development (.NET Core or Node.js)\n* REST API design and implementation\n* Salesforce REST API integration\n* Event-driven architecture patterns\n* Async/background processing (queues, workers)\n* Braze API integration\n* Webhook design and security\n* OAuth 2.0 / JWT authentication\n* Domain-Driven Design (DDD) - Anti-Corruption Layer pattern\n* Unit/integration testing frameworks\n* Infrastructure as Code (Terraform/CloudFormation)\n\n==== Acceptance Criteria\n\n* Feedback submission endpoint returns 202 Accepted within p95 < 200ms\n* Async Case creation succeeds with >99.5% success rate (including retries)\n* Anti-Corruption Layer correctly maps all feedback categories to Salesforce Case fields\n* Webhook receiver processes Salesforce Case updates and publishes domain events\n* Braze push notifications sent successfully for Case updates\n* Failed Case creation moves to Dead Letter Queue after 5 retry attempts\n* Unit test coverage > 80%\n* Integration tests pass with Salesforce sandbox and Braze staging environment\n\n[[wp-cs-003]]\n=== WP-CS-003: Event Bus Infrastructure\n\n==== Description\n\nImplement Event Bus infrastructure for domain event publishing using existing AWS infrastructure (SNS+SQS, EventBridge, or Kinesis).\n\n==== Deliverables\n\n* Event Bus infrastructure configuration\n** Topic/stream provisioning (technology choice: SNS+SQS / EventBridge / Kinesis)\n** FIFO queue configuration (ordering by `contactId`)\n** Dead Letter Queue (DLQ) setup\n** Retention policy (4 days / 96 hours)\n** Access control policies (IAM roles, permissions)\n* CloudEvents 1.0 schema definitions\n** JSON Schema specifications for all domain events\n** Schema validation configuration\n** Schema registry (if using EventBridge/Kinesis)\n* Monitoring and alerting\n** CloudWatch dashboards for queue metrics\n** Alarms for DLQ depth, queue age, processing failures\n** Event Bus throughput monitoring\n* Documentation\n** Event Bus architecture diagram\n** Event publishing guidelines\n** Consumer integration guide\n* Infrastructure as Code (IaC)\n** Terraform/CloudFormation templates for all infrastructure\n\n==== Dependencies\n\n*Prerequisites*:\n\n* AWS account access (existing infrastructure)\n* Technology selection decision (SNS+SQS vs EventBridge vs Kinesis)\n* CloudEvents 1.0 schema design approval\n\n*Dependent Work Packages*:\n\n* None (foundational infrastructure, can start early)\n\n==== Skills Required\n\n* AWS messaging services (SNS, SQS, EventBridge, Kinesis)\n* Event-driven architecture patterns\n* CloudEvents specification\n* JSON Schema design\n* Infrastructure as Code (Terraform/CloudFormation)\n* AWS IAM security configuration\n* CloudWatch monitoring and alerting\n\n==== Acceptance Criteria\n\n* Event Bus infrastructure provisioned in all environments (dev, staging, production)\n* FIFO ordering validated for events with same `contactId`\n* Dead Letter Queue triggers alarms when messages arrive\n* Event retention policy enforced (4 days)\n* CloudEvents 1.0 schema validation enabled\n* Monitoring dashboards operational\n* Infrastructure fully codified (IaC)\n\n[[wp-cs-004]]\n=== WP-CS-004: Contact Migration Tooling\n\n==== Description\n\nDevelop Contact migration tool for one-time migration from app-specific database to Salesforce Service Cloud with upsert logic and validation.\n\n==== Deliverables\n\n* Contact migration tool\n** Extract Contacts from app-specific database\n** Transform to Salesforce Contact API format\n** Upsert to Salesforce using email as external key\n** Fallback matching by phone number or Viva Consumer ID\n** Batch processing with rate limiting (respect Salesforce API limits)\n** Idempotent operation (can be re-run safely)\n* Validation scripts\n** Pre-migration validation (data quality checks)\n** Post-migration validation (100% Contact reconciliation)\n** Email/phone/VCI matching accuracy report\n* Reconciliation reporting\n** Contacts created vs updated statistics\n** Failed upserts with error details\n** Matching accuracy metrics\n* Rollback capability\n** Export snapshot of Salesforce Contacts before migration\n** Rollback procedure documentation\n* Documentation\n** Migration tool user guide\n** Troubleshooting guide\n** Runbook for migration execution\n\n==== Dependencies\n\n*Prerequisites*:\n\n* <<wp-cs-001,WP-CS-001>> (ProfileService Development) completed (reuses Salesforce integration code)\n* Salesforce sandbox environment for migration testing\n* App-specific database access (read-only sufficient)\n* Salesforce production access granted\n\n*Dependent Work Packages*:\n\n* <<wp-cs-001,WP-CS-001>> provides Salesforce Contact upsert logic to reuse\n\n==== Skills Required\n\n* Database development (SQL, data extraction)\n* Salesforce REST API integration\n* Batch processing and ETL patterns\n* Data validation and reconciliation\n* Error handling and logging\n* Scripting (Python, PowerShell, or similar)\n\n==== Acceptance Criteria\n\n* Migration tool successfully migrates 100% of Contacts in sandbox with zero data loss\n* Email/phone/VCI matching accuracy > 95% in sandbox testing\n* Failed upserts captured with actionable error messages\n* Reconciliation report matches actual Salesforce Contact counts\n* Migration tool execution time acceptable for production (freezes app database for minimum time)\n* Rollback procedure validated in sandbox\n* Documentation complete and approved\n\n[[wp-cs-005]]\n=== WP-CS-005: Mobile App Integration\n\n==== Description\n\nUpdate Mobile App to integrate with ProfileService and EngagementService APIs, replacing D365 CE integration.\n\n==== Deliverables\n\n* Feedback form UI enhancements\n** Add Category dropdown (App, Service, Order, Rewards, Refund, Delete Account)\n** Add Store Name field (optional)\n** Add Time of Visit field (optional, datetime picker)\n** Add Contact Phone Number field (optional, E.164 validation)\n** Update Message field (1-2000 character limit with counter)\n* API integration (Kotlin Multiplatform shared code)\n** ProfileService client (`GET /contact-id`)\n** EngagementService client (`POST /feedback`)\n** JWT token management (Microsoft Entra External ID)\n** Error handling (network failures, API errors, validation errors)\n** Retry logic for transient failures\n* Platform-specific UI (SwiftUI for iOS, Jetpack Compose for Android)\n** Feedback form screens\n** Success/error confirmation screens\n** Loading states and progress indicators\n* Feature flag integration\n** `enable_salesforce_feedback_submission` flag\n** Fallback to D365 CE if flag disabled (during rollout)\n* Unit tests for shared business logic\n* UI tests for platform-specific screens\n* API integration tests (mocked APIs)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* <<wp-cs-001,WP-CS-001>> (ProfileService Development) completed and deployed to dev/staging\n* <<wp-cs-002,WP-CS-002>> (EngagementService Development) completed and deployed to dev/staging\n* ProfileService and EngagementService OpenAPI specifications finalized\n* Feature flag service configured\n\n*Dependent Work Packages*:\n\n* Must complete after <<wp-cs-001,WP-CS-001>> and <<wp-cs-002,WP-CS-002>> (requires API endpoints available for integration testing)\n\n==== Skills Required\n\n* Kotlin Multiplatform development\n* SwiftUI (iOS native UI)\n* Jetpack Compose (Android native UI)\n* REST API client development\n* OAuth 2.0 / JWT authentication\n* Form validation and UX design\n* Unit testing (Kotlin, Swift)\n* UI testing frameworks (XCTest, Espresso)\n\n==== Acceptance Criteria\n\n* Feedback form UI matches UX design specifications\n* All form fields validate correctly (client-side validation)\n* API integration successfully calls ProfileService and EngagementService in dev/staging\n* Error handling provides user-friendly error messages\n* Feature flag correctly toggles between Salesforce and D365 CE integration\n* Unit test coverage > 80% for shared business logic\n* UI tests pass for all feedback form workflows (happy path, error states)\n* App builds and deploys successfully to TestFlight (iOS) and Google Play Internal Testing (Android)\n\n[[wp-cs-006]]\n=== WP-CS-006: Integration Testing\n\n==== Description\n\nExecute comprehensive integration testing across all system components in non-production environments.\n\n==== Deliverables\n\n* Test environment setup\n** Salesforce sandbox configured with test data\n** ProfileService deployed to staging\n** EngagementService deployed to staging\n** Event Bus staging infrastructure\n** Braze staging environment configured\n** Mobile App TestFlight/Internal Testing builds\n* Integration test suites\n** ProfileService ↔ Salesforce (Contact upsert scenarios)\n** EngagementService ↔ Salesforce (Case creation scenarios)\n** EngagementService ↔ Braze (push notification scenarios)\n** Mobile App ↔ ProfileService ↔ EngagementService (end-to-end workflows)\n** Event Bus publishing and consumption\n** Webhook receiver (Salesforce → EngagementService)\n* Test scenarios\n** Happy path: Successful feedback submission and Case creation\n** Error scenarios: Salesforce API failures, Braze API failures, network timeouts\n** Retry scenarios: Async Case creation retries, DLQ validation\n** Performance testing: p95 latency validation for ProfileService and EngagementService\n** Load testing: Simulate 3x-10x expected volume\n* UAT execution\n** Business stakeholder UAT sessions\n** UAT test cases covering all feedback categories\n** UAT sign-off documentation\n* Test results documentation\n** Test execution reports\n** Defect tracking and resolution\n** Performance test results\n\n==== Dependencies\n\n*Prerequisites*:\n\n* <<wp-cs-001,WP-CS-001>> (ProfileService Development) completed\n* <<wp-cs-002,WP-CS-002>> (EngagementService Development) completed\n* <<wp-cs-003,WP-CS-003>> (Event Bus Infrastructure) completed\n* <<wp-cs-005,WP-CS-005>> (Mobile App Integration) completed\n* <<wp-cs-007,WP-CS-007>> (Salesforce Configuration) sandbox configuration completed\n\n*Dependent Work Packages*:\n\n* Must complete after <<wp-cs-001,WP-CS-001>>, <<wp-cs-002,WP-CS-002>>, <<wp-cs-003,WP-CS-003>>, <<wp-cs-005,WP-CS-005>> (requires all components available)\n\n==== Skills Required\n\n* Integration testing strategy and execution\n* Test automation frameworks (Postman, Newman, Selenium)\n* Performance testing tools (JMeter, k6, Gatling)\n* Salesforce sandbox administration\n* Test data management\n* Defect tracking and triage\n* UAT facilitation\n\n==== Acceptance Criteria\n\n* All integration test scenarios pass (happy path, error scenarios, retry scenarios)\n* Performance SLAs validated (ProfileService p95 < 300ms, EngagementService p95 < 200ms)\n* Load testing confirms system handles 3x expected volume without degradation\n* UAT sign-off obtained from business stakeholders\n* Zero critical defects (P1/P2) open before moving to Contact Migration\n* Test results documented and approved\n\n[[wp-cs-007]]\n=== WP-CS-007: Salesforce Configuration\n\n==== Description\n\nConfigure Salesforce Service Cloud for OTR digital customer support integration, including field mapping, data isolation, and webhook setup.\n\n==== Deliverables\n\n* Salesforce Contact configuration\n** Custom fields for OTR-specific data (if needed)\n** Email as external key configuration\n** Record Type for OTR digital customers (data isolation)\n** Validation rules\n* Salesforce Case configuration\n** Custom fields for feedback categories (App, Service, Order, Rewards, Refund, Delete Account)\n** Case Type and Reason picklist mapping\n** Queue assignment rules (OTR digital support queue)\n** Case escalation rules\n** Case routing rules\n* Salesforce webhook configuration\n** Platform Events / Outbound Messages for Case updates\n** Webhook authentication (API key, JWT, or OAuth)\n** Case status change triggers (New → In Progress, Resolved, Closed)\n** Webhook payload format (JSON)\n* Data isolation strategy\n** Record Types for OTR vs other Viva Energy business units\n** Queues for OTR-specific Cases\n** Reporting and dashboards scoped to OTR data\n* Salesforce API access\n** Connected App configuration\n** OAuth 2.0 JWT bearer flow setup\n** API user credentials\n** API rate limit monitoring\n* Documentation\n** Salesforce field mapping specification\n** Webhook configuration guide\n** Data isolation architecture diagram\n** API authentication setup guide\n\n==== Dependencies\n\n*Prerequisites*:\n\n* Viva Energy Salesforce admin team engagement\n* Salesforce governance approval (multi-tenant environment)\n* Technical decision on webhook mechanism (Platform Events vs Outbound Messages)\n* Technical decision on authentication method (OAuth 2.0 JWT bearer flow recommended)\n\n*Dependent Work Packages*:\n\n* None (can start in parallel with development work packages)\n* Required for WP-CS-002 (EngagementService needs field mapping)\n* Required for WP-CS-006 (Integration Testing needs sandbox configuration)\n\n==== Skills Required\n\n* Salesforce administration\n* Salesforce configuration (Record Types, Queues, Validation Rules)\n* Salesforce API integration (REST API, Platform Events, Outbound Messages)\n* Salesforce security and authentication (OAuth, Connected Apps)\n* Multi-tenant data isolation patterns\n\n==== Acceptance Criteria\n\n* Salesforce sandbox configured with all custom fields, Record Types, Queues\n* Field mapping documented and approved by OTR business stakeholders\n* Webhook configuration tested and delivering Case update notifications\n* Data isolation validated (OTR data separate from other Viva Energy business units)\n* API authentication working for ProfileService and EngagementService\n* Salesforce API rate limits monitored and acceptable for expected volume\n* Configuration replicated to Salesforce production environment\n\n[[wp-cs-008]]\n=== WP-CS-008: Contact Data Migration\n\n==== Description\n\nExecute one-time Contact migration from app-specific database to Salesforce Service Cloud production.\n\n==== Deliverables\n\n* Pre-migration activities\n** Final validation of migration tool in sandbox\n** Communication plan (notify users of maintenance window if needed)\n** Freeze app-specific database Contact updates\n** Backup app-specific database\n** Export snapshot of Salesforce Contacts (rollback preparation)\n* Migration execution\n** Execute migration tool against Salesforce production\n** Monitor migration progress\n** Handle failed upserts (manual intervention if needed)\n* Post-migration validation\n** 100% Contact reconciliation (app database vs Salesforce)\n** Email/phone/VCI matching accuracy report\n** Reconciliation report (Contacts created vs updated)\n** Data integrity checks (no duplicate Contacts, no missing Contacts)\n* ProfileService smoke testing\n** Verify Contact ID retrieval works in production\n** Test cache behavior\n** Validate Salesforce Contact upserts from ProfileService\n* Migration report\n** Total Contacts migrated\n** Contacts created vs updated\n** Failed upserts (if any) with resolution\n** Matching accuracy metrics\n** Migration execution time\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-004 (Contact Migration Tooling) completed\n* WP-CS-001 (ProfileService Development) deployed to production (not yet integrated with Mobile App)\n* WP-CS-007 (Salesforce Configuration) production configuration completed\n* Salesforce production access granted\n* Migration approved by business stakeholders\n\n*Dependent Work Packages*:\n\n* Must complete after WP-CS-001, WP-CS-004, WP-CS-007\n* Must complete before WP-CS-009 (Production Deployment)\n\n==== Skills Required\n\n* Data migration execution\n* Salesforce administration\n* Database operations\n* Data validation and reconciliation\n* Incident management (if issues arise)\n\n==== Acceptance Criteria\n\n* 100% of Contacts migrated with zero data loss\n* Email/phone/VCI matching accuracy > 95%\n* ProfileService smoke tests pass in production\n* Reconciliation report approved by business stakeholders\n* App-specific database Contact updates frozen (read-only mode)\n* Rollback procedure ready (but not executed if migration successful)\n\n[[wp-cs-009]]\n=== WP-CS-009: Production Deployment\n\n==== Description\n\nDeploy all solution components to production and execute cutover from D365 CE to Salesforce Service Cloud.\n\n==== Deliverables\n\n* Production deployment\n** EngagementService deployed to production\n** Event Bus production infrastructure validated\n** Salesforce webhook configured in production\n** Mobile App released to production (App Store, Google Play)\n* Go-live activities\n** Smoke testing (end-to-end feedback submission)\n** Feature flag enabled: `enable_salesforce_feedback_submission = ON`\n** D365 CE integration disabled in Mobile App\n** Monitor Event Bus queue depth, DLQ, Salesforce API rate limits\n** Monitor Mobile App feedback submission success rate\n* Go/No-Go decision\n** Validate success criteria before final cutover\n** Business stakeholder approval\n** Technical validation (smoke tests pass, monitoring healthy)\n* Cutover communication\n** Notify support agents of new Salesforce integration\n** Provide training materials for support agents\n** Customer communication (if visible change)\n* Rollback plan\n** Documented rollback procedure\n** Feature flag can disable Salesforce integration and re-enable D365 CE\n** Rollback decision criteria (P1/P2 incidents, feedback submission success rate < 99%)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-001 (ProfileService Development) completed\n* WP-CS-002 (EngagementService Development) completed\n* WP-CS-003 (Event Bus Infrastructure) completed\n* WP-CS-005 (Mobile App Integration) completed\n* WP-CS-006 (Integration Testing) completed with UAT sign-off\n* WP-CS-007 (Salesforce Configuration) production configuration completed\n* WP-CS-008 (Contact Data Migration) completed successfully\n* Mobile App release approval (App Store, Google Play)\n\n*Dependent Work Packages*:\n\n* Must complete after all prior work packages (final cutover)\n\n==== Skills Required\n\n* Production deployment and release management\n* Incident management and troubleshooting\n* Monitoring and observability\n* Change management and communication\n* Rollback execution (if needed)\n\n==== Acceptance Criteria\n\n* Mobile App feedback submission success rate > 99.5%\n* End-to-end flow validated (Mobile App → ProfileService → EngagementService → Salesforce Case created)\n* Braze push notifications delivered successfully\n* Event Bus queue depth normal, DLQ empty\n* No critical incidents (P1/P2) in first 24 hours\n* D365 CE integration disabled\n* Support agents successfully using Salesforce for OTR digital customer Cases\n\n[[wp-cs-010]]\n=== WP-CS-010: Post-Cutover Support\n\n==== Description\n\nMonitor production stability, resolve issues, validate success criteria, and execute D365 CE retirement.\n\n==== Deliverables\n\n* Monitoring and support\n** 24/7 on-call support for first week post-cutover\n** Daily monitoring reports (feedback submission success rate, Case creation success rate)\n** Incident response and resolution\n** Performance tuning (if needed)\n* Success criteria validation\n** Validate feedback submission success rate > 99.5%\n** Monitor customer satisfaction score (target: +15% improvement within 6 months)\n** Monitor average case resolution time (target: -20% improvement within 6 months)\n** Support agent feedback survey\n* D365 CE retirement\n** D365 CE set to read-only mode (historical Case lookups only)\n** Archive D365 CE data for compliance/auditing\n** Decommission D365 CE infrastructure (after 90-day stabilization period)\n** Remove D365 CE integration code from Mobile App\n* Documentation updates\n** Production runbook\n** Troubleshooting guide (based on incidents resolved)\n** Operational procedures for support team\n** Lessons learned document\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-009 (Production Deployment) completed\n* Cutover successful with no critical incidents\n\n*Dependent Work Packages*:\n\n* Final work package in sequence\n\n==== Skills Required\n\n* Production support and incident management\n* Performance monitoring and tuning\n* Data archival and compliance\n* Infrastructure decommissioning\n* Documentation\n\n==== Acceptance Criteria\n\n* Zero critical incidents (P1/P2) in first 30 days post-cutover\n* Feedback submission success rate sustained > 99.5%\n* Customer satisfaction improvement validated (baseline established, ongoing measurement)\n* Support agents reporting positive experience with Salesforce unified view\n* D365 CE successfully decommissioned\n* All production documentation complete and approved\n* Lessons learned document published\n\n=== Work Package Sequencing\n\n==== Parallel Track 1: Infrastructure & Configuration\n\nCan start immediately and run in parallel:\n\n* WP-CS-003 (Event Bus Infrastructure)\n* WP-CS-007 (Salesforce Configuration)\n\n==== Parallel Track 2: Development\n\nCan start after Track 1 infrastructure decisions made:\n\n* WP-CS-001 (ProfileService Development) - Independent\n* WP-CS-002 (EngagementService Development) - Requires WP-CS-003 completed\n* WP-CS-004 (Contact Migration Tooling) - Requires WP-CS-001 completed (reuses code)\n\n==== Sequential Track 3: Integration & Testing\n\nMust complete after development:\n\n* WP-CS-005 (Mobile App Integration) - Requires WP-CS-001, WP-CS-002\n* WP-CS-006 (Integration Testing) - Requires WP-CS-001, WP-CS-002, WP-CS-003, WP-CS-005, WP-CS-007\n\n==== Sequential Track 4: Migration & Cutover\n\nMust complete sequentially:\n\n* WP-CS-008 (Contact Data Migration) - Requires WP-CS-001, WP-CS-004, WP-CS-006 UAT sign-off\n* WP-CS-009 (Production Deployment) - Requires all prior work packages completed\n* WP-CS-010 (Post-Cutover Support) - Requires WP-CS-009\n\n==== Critical Path\n\nThe critical path for this project is:\n\n. WP-CS-003 (Event Bus Infrastructure)\n. WP-CS-002 (EngagementService Development) - blocks on WP-CS-003\n. WP-CS-005 (Mobile App Integration) - blocks on WP-CS-001, WP-CS-002\n. WP-CS-006 (Integration Testing) - blocks on WP-CS-001 through WP-CS-005, WP-CS-007\n. WP-CS-008 (Contact Data Migration) - blocks on WP-CS-006 UAT sign-off\n. WP-CS-009 (Production Deployment) - blocks on WP-CS-008\n. WP-CS-010 (Post-Cutover Support) - final deliverable\n\nAny delays in critical path work packages will delay the overall cutover date.\n\n<<<\n== Transition Architecture\n\nThis section defines the evolution from baseline (D365 CE) to target state (Salesforce Service Cloud + ProfileService + EngagementService).\n\n=== Transition Approach\n\n*Big Bang Cutover*: Per ADR-CS-006, this transition uses a single cutover approach rather than phased rollout. All users switch from D365 CE to Salesforce simultaneously after Contact migration completion.\n\n=== Transition States\n\n==== TS-0: Baseline State (Current)\n\n===== Characteristics\n\n* D365 Customer Engagement handles all digital customer feedback\n* App-specific database stores customer Contact data\n* No ProfileService or EngagementService\n* No event-driven architecture\n* Synchronous feedback submission\n\n===== Components Active\n\n- D365 Customer Engagement\n- App-specific customer database\n- Mobile App (current version with D365 CE integration)\n\n==== TS-1: Build & Test\n\n===== Activities\n\n* Build ProfileService microservice (JIT Contact reconciliation API)\n* Build EngagementService microservice (feedback submission API, ACL for Salesforce Case creation, Braze integration, webhook receiver)\n* Implement Event Bus infrastructure (SNS+SQS/EventBridge/Kinesis)\n* Develop Contact migration tool (app database → Salesforce upsert by email/phone/VCI)\n* Update Mobile App API integration (ProfileService + EngagementService endpoints - feedback form UI already complete)\n* Integration testing (ProfileService ↔ Salesforce, EngagementService ↔ Salesforce, EngagementService ↔ Braze)\n* UAT with test Salesforce sandbox environment\n\n===== Components Active\n\n- D365 Customer Engagement (still active, unchanged)\n- App-specific customer database (still active)\n- ProfileService (non-production, testing only)\n- EngagementService (non-production, testing only)\n- Event Bus (non-production)\n- Salesforce Sandbox (testing)\n\n===== Exit Criteria\n\n- All integration tests pass\n- UAT sign-off from business stakeholders\n- Contact migration tool validated in sandbox\n- Mobile App updates tested with non-production APIs\n\n==== TS-2: Contact Migration\n\n===== Activities\n* Execute Contact migration (app database → Salesforce production)\n* Validation: 100% data integrity check (email/phone/VCI matching)\n* Reconciliation report: New Contacts created vs existing Contacts updated\n* Freeze app database Contact updates during migration window\n* ProfileService smoke testing (verify Contact lookups work in Salesforce production)\n\n===== Components Active\n- D365 Customer Engagement (still active, users unaffected)\n- Salesforce Production (Contacts migrated, no Cases yet)\n- ProfileService (production deployed, not integrated with Mobile App yet)\n- App-specific customer database (frozen, read-only)\n\n===== Exit Criteria\n- 100% of Contacts migrated with zero data loss\n- Email/phone/VCI matching accuracy > 95%\n- ProfileService smoke tests pass (JIT lookups return correct Contact IDs)\n- Reconciliation report approved\n\n==== TS-3: Cutover (Go-Live)\n\n===== Go-Live Activities\n\n* Deploy EngagementService to production\n* Deploy Mobile App updates (ProfileService + EngagementService API integration)\n* Configure Salesforce webhook (Case update notifications → EngagementService)\n* Smoke testing: End-to-end feedback submission (Mobile App → EngagementService → Salesforce → Braze notification)\n* Monitor Event Bus queue depth, dead letter queue, Salesforce API rate limits\n* **Go/No-Go decision**: Validate success criteria before final cutover\n* Enable feature flag: `enable_salesforce_feedback_submission = ON`\n* Disable D365 CE integration in Mobile App\n\n===== Components Active\n\n- ProfileService (production, integrated with Mobile App)\n- EngagementService (production, integrated with Mobile App)\n- Event Bus (production, processing async Case creation)\n- Salesforce Production (receiving Cases from digital customers)\n- Braze (sending push notifications)\n- Mobile App (new version with Salesforce integration)\n- D365 Customer Engagement (disabled, read-only for historical lookups)\n\n===== Exit Criteria\n\n- Mobile App feedback submission success rate > 99.5%\n- End-to-end flow validated (Mobile App → Salesforce Case created)\n- Braze push notifications delivered successfully\n- Event Bus queue depth normal, DLQ empty\n- No critical incidents (P1/P2) in first 24 hours\n\n==== TS-4: Target State (Stable Production)\n\n===== Characteristics\n\n* ProfileService and EngagementService fully operational\n* All digital customer feedback routed to Salesforce\n* Event-driven architecture established\n* D365 CE decommissioned\n* First DDD bounded contexts implemented successfully\n\n===== Monitoring Period\n\n* Validate success criteria: feedback submission rate > 99.5%, no data loss\n* Monitor customer satisfaction score (target: +15% improvement)\n* Monitor average case resolution time (target: -20% improvement)\n* Support agents using unified Salesforce view across all channels\n\n===== D365 CE Retirement\n\n* D365 CE read-only access for historical Case lookups (if needed)\n* Decommission D365 CE infrastructure after 90 days\n* Archive D365 CE data for compliance/auditing\n\n===== Components Active\n\n- ProfileService (production)\n- EngagementService (production)\n- Event Bus (production)\n- Salesforce Production (system of record)\n- Braze (push notifications)\n- Mobile App (Salesforce integration)\n- App-specific database (deprecated, Contact data no longer updated)\n\n===== Success Criteria Achieved\n\n- All digital customer feedback routed to Salesforce\n- Support agents have unified customer view\n- D365 CE decommissioned\n- Customer satisfaction improved by 15%\n- Average case resolution time decreased by 20%\n- Zero data loss during transition\n\n=== Transition Dependencies\n\n[width=\"100%\",cols=\"40%,60%\",options=\"header\",]\n|===\n|Dependency |Owner/Status\n\n|*Salesforce production access*\n|Viva Energy Salesforce admin team - TBD\n\n|*Salesforce Case field mapping*\n|Viva Energy Salesforce admin team - TBD (map OTR feedback categories to Salesforce fields)\n\n|*Salesforce data isolation strategy*\n|Viva Energy Salesforce admin team - TBD (Record Types, queues, custom fields)\n\n|*Salesforce webhook configuration*\n|Viva Energy Salesforce admin team - TBD (Outbound Messages vs Platform Events)\n\n|*Event Bus infrastructure*\n|OTR Platform team - Existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis)\n\n|*Braze integration*\n|OTR Marketing team - Existing Braze account, EngagementService creates new campaigns\n\n|*Mobile App release window*\n|OTR Mobile team - Coordinate cutover timing with app release schedule\n\n|*App database access*\n|OTR Platform team - Read access for Contact migration\n\n|===\n\n=== Transition Validation Criteria\n\n==== Contact Migration Validation\n\n* 100% of app database Contacts migrated to Salesforce (zero data loss)\n* Email/phone/VCI matching accuracy > 95% (minimize duplicate Contacts)\n* ProfileService JIT lookups return correct Salesforce Contact IDs (smoke test sample)\n* Reconciliation report shows: X new Contacts created, Y existing Contacts updated\n\n==== Cutover Validation\n\n* Mobile App feedback submission success rate > 99.5% (including async Case creation)\n* End-to-end flow validated: Mobile App → ProfileService → EngagementService → Salesforce Case created\n* Braze push notifications delivered for Case creation and Case resolution\n* Event Bus queue depth within normal range (no backlog)\n* Dead letter queue empty (no failed Case creations)\n* Salesforce API rate limits not exceeded\n\n==== Production Monitoring (30 days)\n\n* Customer satisfaction score improves by 15% (compared to D365 CE baseline)\n* Average case resolution time decreases by 20% (Salesforce vs D365 CE)\n* Support agents confirm unified customer view across all channels\n* Zero critical incidents (P1 outages, data loss)\n\n=== Rollback Plan\n\n==== Rollback Triggers\n\n* Feedback submission success rate < 95% (below acceptable threshold)\n* Data loss or corruption detected in Salesforce\n* Salesforce API rate limits exceeded (Cases not created within SLA)\n* Critical bug blocking customer feedback submission\n\n==== Rollback Procedure\n\n1. **Revert Mobile App** to previous version (remove ProfileService/EngagementService integration, restore D365 CE integration)\n2. **Stop EngagementService** Case creation (prevent duplicate Cases in Salesforce)\n3. **Re-enable D365 CE** for customer feedback submission\n4. **Investigate root cause** (EngagementService logs, Salesforce API errors, Event Bus queue issues)\n5. **Fix and re-test** in sandbox environment\n6. **Retry cutover** when issues resolved\n\n==== Rollback Limitations\n\n* Cases created in Salesforce during cutover period remain in Salesforce (no reverse migration)\n* Contacts migrated to Salesforce remain (no rollback to app database)\n* Rollback only affects Mobile App integration (not data migration)\n\n=== Architectural Scope Boundaries\n\n==== Capabilities Included\n\n===== Business Capabilities\n\n* **Customer Feedback Submission**: Mobile App users can submit structured feedback (Category, Store Name, Time of Visit, Phone, Free Text Message) via EngagementService\n* **Customer Contact Management**: Just-In-Time (JIT) Contact reconciliation with Salesforce via ProfileService, ensuring every Mobile App user has a Salesforce Contact record\n* **Case Management Integration**: EngagementService creates Salesforce Cases asynchronously for customer feedback, support agents manage Cases in Salesforce Service Cloud\n* **Customer Notifications**: Push notifications via Braze when Cases are created, updated, or resolved (bidirectional integration: Mobile App → Salesforce → Mobile App)\n* **Unified Customer View**: Support agents see OTR digital customer feedback alongside other Viva Energy channels (fuel wholesale, Shell Card, retail) in single Salesforce instance\n* **Contact Data Migration**: One-time migration of app-specific customer database Contacts to Salesforce with upsert logic (email/phone/VCI matching)\n\n===== Technical Capabilities\n\n* **ProfileService Bounded Context**: First DDD bounded context implementation - JIT Contact reconciliation, Salesforce API facade, foundation for Flybuys integration\n* **EngagementService Bounded Context**: First DDD bounded context implementation - Customer feedback submission BFF, Anti-Corruption Layer for Salesforce, Braze integration orchestration\n* **Event-Driven Architecture**: Domain event publishing via Event Bus (SNS+SQS/EventBridge/Kinesis) for `SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted` events\n* **Async Processing Pattern**: Non-blocking Case creation with retry logic, exponential backoff, dead letter queue for operational resilience\n* **Anti-Corruption Layer Pattern**: EngagementService protects digital channels from Salesforce API changes, translates between OTR domain language and Salesforce\n* **Conformist Pattern**: ProfileService and EngagementService conform to existing Salesforce configuration (shared Viva Energy instance, multi-tenant governance)\n* **Salesforce Integration**: REST API integration for Contact CRUD and Case creation, webhook receiver for Case update notifications\n* **Braze Integration**: Push notification campaign triggers for Case lifecycle events (created, updated, resolved)\n* **Observability & Monitoring**: Dashboards, metrics, alerting for feedback submission rate, queue depth, API errors, Case creation latency\n* **Feature Flag Management**: Kill switches for emergency rollback (enable_salesforce_feedback_submission, enable_async_case_creation, etc.)\n\n==== Capabilities Excluded\n\n===== Business Capabilities Explicitly Out of Scope\n\n* **Historical Case Migration**: D365 CE Cases not migrated to Salesforce (ADR-CS-005 - fresh start, no Case migration)\n* **Multi-Channel Feedback Submission**: Web app, POS, call centre, email feedback channels not included (Mobile App only in this phase)\n* **Case Resolution by Digital Channels**: Support agents resolve Cases in Salesforce, not via Mobile App self-service\n* **Knowledge Base Integration**: Salesforce Knowledge Base articles not surfaced in Mobile App (future enhancement)\n* **Live Chat/Messaging**: Real-time chat support not included (Salesforce omnichannel capabilities not activated)\n* **Sentiment Analysis**: Automated feedback sentiment analysis not included (future enhancement with AI/ML)\n* **Customer Satisfaction Surveys**: Post-resolution CSAT surveys not included (separate initiative)\n* **Case Attachments**: Mobile App feedback submission does not support file uploads (photos, receipts) - text only\n* **Agent Desktop Integration**: Custom Salesforce UI for support agents not included (use standard Salesforce Service Console)\n* **Social Media Feedback**: Facebook, Twitter, Instagram feedback channels not integrated\n\n===== Technical Capabilities Explicitly Out of Scope\n\n* **Event Sourcing**: Domain events are ephemeral (not persisted for event sourcing/replay) - Event Bus only, no Event Store\n* **CQRS (Command Query Responsibility Segregation)**: ProfileService and EngagementService use same data model for reads/writes (no separate read models)\n* **Local Aggregate Persistence**: ProfileService and EngagementService are stateless (Salesforce is System of Record, no local database for Contact/Case)\n* **Saga Orchestration**: No distributed transactions or saga patterns required (single-step Case creation, not multi-step workflow)\n* **API Gateway Advanced Features**: Rate limiting, API versioning, API key management deferred to detailed design (basic routing only)\n* **GraphQL API**: ProfileService and EngagementService expose REST APIs only (GraphQL not required)\n* **Real-Time Sync**: Salesforce Contact updates by support agents not synced back to ProfileService (eventual consistency acceptable via JIT reconciliation)\n* **Multi-Region Deployment**: Single AWS region deployment (no multi-region failover/disaster recovery in this phase)\n* **Blue-Green Deployment**: Big bang cutover (ADR-CS-006), not blue-green or canary deployment strategy\n* **A/B Testing Framework**: Feature flags for rollback only, not for A/B testing or experimentation\n* **Custom Authentication**: Microsoft Entra External ID used for Mobile App authentication (no custom authentication logic in ProfileService/EngagementService)\n* **Data Residency Compliance**: Salesforce data residency governed by Viva Energy Salesforce configuration (no OTR-specific data residency requirements)\n\n===== Future Bounded Contexts Not in Scope\n\n* **LoyaltyService**: Flybuys integration, reward preferences, transaction adjudication (separate initiative)\n* **LocationService**: Store finder, proximity features, geofencing (separate initiative)\n* **PaymentService**: Payment processing, subscription billing (separate initiative)\n* **RecommendationService**: Personalized recommendations, next-best offers (separate initiative)\n\n===== Integration Patterns Not in Scope\n\n* **Shared Kernel**: No shared domain model between ProfileService and EngagementService (separate bounded contexts with clear boundaries)\n* **Partnership**: No joint development or coordination with external teams (Conformist pattern - we conform to Salesforce)\n* **Customer-Supplier (we're upstream)**: No downstream systems depend on ProfileService/EngagementService APIs yet (future bounded contexts will consume domain events)\n\n==== Architectural Dependencies on Future Initiatives\n\n*This Architecture Enables Future Initiatives*:\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Future Initiative |Architectural Enablement\n\n|*Flybuys Integration*\n|**ProfileService Contact Reconciliation Reused**: ProfileService establishes pattern for JIT Contact reconciliation with Salesforce, which will be extended for Flybuys partner linking (link:../architecture_definitions/flybuys_integration.adoc[see Flybuys Integration architecture]) +\n**Event Bus Infrastructure**: Domain event publishing pattern (`CustomerEnrolledInLoyalty`, `PartnerLinked`, etc.) reuses Event Bus established for EngagementService\n\n|*LoyaltyService Bounded Context*\n|**Event Bus Subscription**: LoyaltyService will consume `CustomerProfileCreated` events published by ProfileService (future enhancement) +\n**Salesforce Contact Integration**: LoyaltyService may query Salesforce Contacts for customer reward preferences (via ProfileService facade or direct Salesforce API)\n\n|*Web App Feedback Submission*\n|**EngagementService API Reuse**: Web app will call same EngagementService REST API for feedback submission (multi-channel support) +\n**Conformist Pattern**: Web app conforms to EngagementService API contract (no translation required)\n\n|*Multi-Channel Customer Support*\n|**EngagementService Extension**: Add support for email, call centre, POS feedback channels (extend EngagementService to handle multiple origins) +\n**Salesforce Case Origin Field**: Cases already tagged with Origin=Mobile App, extend to Origin=Web, POS, Call Centre, Email\n\n|*Knowledge Base Integration*\n|**EngagementService API Extension**: Add endpoint to query Salesforce Knowledge Base articles, surface in Mobile App for self-service support +\n**Anti-Corruption Layer**: EngagementService translates Salesforce Knowledge API to OTR domain language\n\n|*Customer Satisfaction Surveys*\n|**Event-Driven Trigger**: Subscribe to `SupportCaseResolved` events published by EngagementService, trigger CSAT survey via Braze +\n**Braze Integration Pattern**: Reuse EngagementService → Braze integration pattern for survey campaigns\n\n|*Sentiment Analysis*\n|**Event Subscription**: Subscribe to `CustomerFeedbackSubmitted` events, analyse feedback sentiment (AI/ML service) +\n**EngagementService Extension**: Enrich Case with sentiment score before creating in Salesforce\n\n|*RecommendationService Bounded Context*\n|**Event Subscription**: RecommendationService subscribes to `SupportCaseCreated` events to understand customer pain points and personalize recommendations +\n**Domain Event Pattern**: Reuse Event Bus publishing pattern established by EngagementService\n\n|===\n\n*This Architecture Depends on Future Initiatives*:\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Future Initiative |Dependency Description\n\n|*Salesforce Data Isolation Strategy*\n|**BLOCKER**: Viva Energy Salesforce admin team must define data isolation strategy (Record Types, custom fields, queues) before production deployment +\n**Impact**: Multi-tenant data visibility and security governance\n\n|*Salesforce Case Field Mapping*\n|**BLOCKER**: Viva Energy Salesforce admin team must define field mapping for OTR feedback categories (App, Service, Order, Rewards, Refund, Delete Account) +\n**Impact**: Case creation logic in EngagementService depends on finalized Salesforce schema\n\n|*Salesforce Webhook Mechanism*\n|**BLOCKER**: Viva Energy Salesforce admin team must configure webhook mechanism (Outbound Messages vs Platform Events vs Process Builder) for Case update notifications +\n**Impact**: EngagementService webhook receiver implementation depends on chosen mechanism\n\n|*Event Bus Technology Selection*\n|**DECISION REQUIRED**: Choose Event Bus implementation (SNS+SQS vs EventBridge vs Kinesis) for domain event publishing +\n**Impact**: Infrastructure provisioning, event schema design, consumer implementation\n\n|*Microservice Hosting Platform*\n|**DECISION REQUIRED**: Choose hosting platform for ProfileService and EngagementService (AWS Lambda vs ECS vs EKS) +\n**Impact**: Deployment architecture, auto-scaling strategy, operational overhead\n\n|*Observability Platform*\n|**DECISION REQUIRED**: Choose observability platform (AWS CloudWatch vs Datadog vs New Relic) for monitoring and alerting +\n**Impact**: Dashboard configuration, metric collection, alerting setup\n\n|===\n\n*Future Work After This Initiative*:\n\n* **Event Schema Registry**: Implement event schema versioning and registry for domain events (currently ad-hoc schemas)\n* **API Versioning Strategy**: Define API versioning approach for ProfileService and EngagementService (currently v1 only)\n* **Multi-Region Deployment**: Extend to multi-region for disaster recovery and global availability\n* **Event Store**: Persist domain events for event sourcing and audit trail (currently ephemeral Event Bus only)\n* **CQRS Pattern**: Separate read models for high-volume queries (currently same model for reads/writes)\n* **GraphQL API**: Expose GraphQL API for flexible client queries (currently REST only)\n* **Real-Time Sync**: Bi-directional sync between Salesforce and ProfileService for Contact updates (currently JIT reconciliation only)\n\n=== Technical Risks and Mitigation\n\n[width=\"100%\",cols=\"5%,20%,25%,25%,25%\",options=\"header\",]\n|===\n|ID |Risk |Impact |Likelihood |Mitigation\n\n|RISK-CS-001\n|*Salesforce API rate limits exceeded*: High feedback volume exceeds Salesforce API limits, Cases not created\n|HIGH (customers don't receive Case confirmation, support tickets lost)\n|MEDIUM (volume unknown, rate limits TBD)\n|• Gather expected feedback volume data before cutover +\n• Implement Event Bus queue throttling/rate limiting +\n• Monitor queue depth and API usage +\n• Scale background workers based on queue depth +\n• Alert ops team when approaching rate limits\n\n|RISK-CS-002\n|*Salesforce downtime*: Salesforce Service Cloud outage prevents Case creation\n|MEDIUM (Cases delayed but queued, customers wait for confirmation)\n|LOW (Salesforce SLA 99.9% uptime)\n|• Async Case creation with retry logic +\n• Event Bus queues buffer work during outage +\n• Customers get immediate \"Feedback submitted\" (not blocked) +\n• Monitor Salesforce status page, alert ops team +\n• Automatic retry when Salesforce recovers\n\n|RISK-CS-003\n|*Contact migration data quality issues*: App database Contact data incomplete or invalid\n|HIGH (migration fails validation, cutover delayed)\n|MEDIUM (legacy data quality unknown)\n|• Pre-migration data quality assessment +\n• Flexible upsert logic (match by email/phone/VCI) +\n• Validation report identifies data issues before production migration +\n• Manual cleanup for invalid records +\n• Dry-run migration in sandbox environment\n\n|RISK-CS-004\n|*Duplicate Contacts created*: Email matching fails, ProfileService creates duplicate Contacts\n|MEDIUM (support agents see multiple profiles for same customer)\n|MEDIUM (email changes, data quality issues)\n|• Salesforce duplicate detection rules (if available) +\n• ProfileService logs Contact creation for audit trail +\n• Manual duplicate cleanup process (support team) +\n• Future enhancement: VCI as Salesforce External ID for stable matching\n\n|RISK-CS-005\n|*Dead letter queue accumulation*: Failed Case creations not processed, queue grows\n|HIGH (customers don't receive Case confirmation, feedback lost)\n|LOW (retry logic handles most failures)\n|• Dead letter queue monitoring and alerting +\n• Ops team dashboard showing DLQ depth +\n• Manual intervention process (investigate and reprocess) +\n• Automated alerts when DLQ depth exceeds threshold +\n• Root cause analysis for recurring failures\n\n|RISK-CS-006\n|*Salesforce webhook failures*: Salesforce can't deliver Case update notifications to EngagementService\n|MEDIUM (customers don't get push notifications for Case resolution)\n|LOW (webhook mechanism reliable)\n|• Webhook retry logic and exponential backoff +\n• EngagementService logs webhook deliveries +\n• Monitor webhook delivery success rate +\n• Fallback: Poll Salesforce API for Case updates (if webhook fails persistently) +\n• Alert ops team when webhook delivery rate drops\n\n|RISK-CS-007\n|*Multi-tenant data isolation breach*: OTR digital Cases visible to other Viva Energy support teams\n|HIGH (privacy violation, compliance risk)\n|LOW (Salesforce governance controls)\n|• Work with Viva Energy Salesforce admin team on data isolation strategy +\n• Test data visibility in Salesforce sandbox (UAT with different user roles) +\n• Validate Record Types, queues, field-level security before production +\n• Audit Salesforce user permissions and sharing rules\n\n|RISK-CS-008\n|*Mobile App release coordination*: App release delayed, cutover window missed\n|MEDIUM (cutover delayed, D365 CE retirement delayed)\n|MEDIUM (release schedule conflicts)\n|• Coordinate cutover timing with Mobile team early +\n• Buffer time in migration plan (2-week contingency) +\n• Decouple backend deployment from Mobile App release (backend deployed first, app follows) +\n• Feature flag for feedback submission (enable when ready)\n\n|RISK-CS-009\n|*Event Bus infrastructure issues*: SNS/SQS/EventBridge downtime or misconfiguration\n|HIGH (Case creation blocked, domain events not published)\n|LOW (AWS SLA 99.99% uptime)\n|• Leverage existing AWS infrastructure (proven, reliable) +\n• Infrastructure as Code (IaC) for Event Bus configuration +\n• Integration testing in non-production environment +\n• Monitor Event Bus metrics (queue depth, throughput, errors) +\n• Alert ops team on Event Bus failures\n\n|RISK-CS-010\n|*Team DDD knowledge gap*: Team unfamiliar with DDD patterns, bounded contexts, event-driven architecture\n|MEDIUM (implementation delays, architectural inconsistencies)\n|HIGH (first DDD implementation)\n|• DDD training for development team (workshops, documentation) +\n• Architecture review sessions (validate bounded context design) +\n• Pair programming with experienced DDD practitioners +\n• Incremental implementation (start small, iterate) +\n• Document architectural patterns in CLAUDE.md\n\n|===\n\n== Assumptions and Constraints\n\n=== Assumptions\n\n[width=\"100%\",cols=\"8%,92%\",options=\"header\",]\n|===\n|ID |Assumption\n\n|ASM-CS-001\n|Viva Energy Salesforce admin team will provide Salesforce production access, sandbox environment, and support for Case field mapping and data isolation configuration\n\n|ASM-CS-002\n|App database Contact data is sufficiently complete for migration (email/phone/VCI available for matching)\n\n|ASM-CS-003\n|Expected customer feedback volume (100-150 submissions/day from 20k DAU) is well within Salesforce API rate limits, with capacity planning for 3x-10x growth\n\n|ASM-CS-004\n|Existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis) is sufficient for Event Bus implementation (no additional infrastructure provisioning required)\n\n|ASM-CS-005\n|Braze integration already exists and can be extended for Case-related push notifications (no new Braze account or major configuration changes)\n\n|ASM-CS-006\n|Mobile App users have email addresses associated with their accounts (required for ProfileService Contact reconciliation)\n\n|ASM-CS-007\n|D365 Customer Engagement historical Cases have limited business value and do not require migration to Salesforce\n\n|ASM-CS-008\n|Support agents are trained on Salesforce Service Cloud and require minimal additional training for OTR digital customer Cases\n\n|ASM-CS-009\n|Salesforce Service Cloud shared instance has capacity for OTR digital customer Contacts and Cases (no additional licensing or storage costs)\n\n|ASM-CS-010\n|Mobile App release schedule can accommodate cutover timing (Week 10 in migration plan)\n\n|===\n\n=== Constraints\n\n[width=\"100%\",cols=\"8%,92%\",options=\"header\",]\n|===\n|ID |Constraint\n\n|CON-CS-001\n|Must use shared Viva Energy Salesforce Service Cloud instance (cannot deploy separate OTR-specific instance)\n\n|CON-CS-002\n|Must conform to existing Salesforce configuration and governance (Record Types, custom fields, queues, data isolation strategy defined by Viva Energy admin team)\n\n|CON-CS-003\n|Contact migration must complete before Mobile App cutover (no parallel run of D365 CE and Salesforce)\n\n|CON-CS-004\n|Big bang cutover only (no phased rollout with feature flags or pilot users)\n\n|CON-CS-005\n|Salesforce API rate limits and authentication method constrained by Viva Energy Salesforce configuration (TBD)\n\n|CON-CS-006\n|Event Bus implementation must use existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis - cannot introduce new infrastructure components)\n\n|CON-CS-007\n|Mobile App feedback form must include specific fields: Category, Store Name, Time of Visit, Contact Phone Number, Free Text Message (no attachments)\n\n|CON-CS-008\n|D365 Customer Engagement must be decommissioned within 90 days post-cutover (ADR-CS-006)\n\n|CON-CS-009\n|ProfileService and EngagementService must be stateless (no local aggregate persistence, Salesforce is System of Record)\n\n|CON-CS-010\n|First DDD bounded context implementation (team learning curve, architectural patterns must be documented for future bounded contexts)\n\n|===\n\n== Non-Functional Requirements\n\n=== Performance Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-PERF-001\n|Mobile App feedback submission API response time (ProfileService + EngagementService)\n|p95 < 1 second, p99 < 2 seconds\n\n|NFR-PERF-002\n|ProfileService Contact reconciliation API response time (JIT lookup)\n|p95 < 500ms, p99 < 1 second\n\n|NFR-PERF-003\n|EngagementService async Case creation latency (end-to-end: feedback submitted → Case created in Salesforce)\n|p95 < 5 minutes, p99 < 10 minutes\n\n|NFR-PERF-004\n|Salesforce API call latency (Contact query, Contact create, Case create)\n|p95 < 2 seconds, p99 < 5 seconds\n\n|NFR-PERF-005\n|Event Bus message processing throughput\n|> 100 messages/second (support peak feedback volume)\n\n|NFR-PERF-006\n|Braze push notification delivery latency (Case created → notification delivered)\n|p95 < 30 seconds, p99 < 60 seconds\n\n|===\n\n=== Availability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-AVAIL-001\n|ProfileService availability\n|99.9% uptime (8.76 hours downtime/year)\n\n|NFR-AVAIL-002\n|EngagementService availability\n|99.9% uptime (8.76 hours downtime/year)\n\n|NFR-AVAIL-003\n|Feedback submission success rate (including async Case creation)\n|> 99.5% (includes retry logic for transient failures)\n\n|NFR-AVAIL-004\n|Graceful degradation: Salesforce downtime handling\n|Feedback submission still succeeds, Cases queued for async creation when Salesforce recovers\n\n|NFR-AVAIL-005\n|Graceful degradation: Braze downtime handling\n|Case creation proceeds, push notifications disabled temporarily (feature flag)\n\n|NFR-AVAIL-006\n|Planned maintenance window\n|< 4 hours/month, scheduled during low-traffic periods (2-6am ACST)\n\n|===\n\n=== Scalability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-SCALE-001\n|Concurrent Mobile App users (peak)\n|Support 20,000 DAU (Daily Active Users), ~150 concurrent users submitting feedback during peak hours\n\n|NFR-SCALE-002\n|Feedback submissions per day\n|Expected: 100-150 submissions/day based on 20k DAU (~0.5-0.75% submission rate) +\nCapacity: Support 500 submissions/day (3x expected volume for growth), 2,000 submissions/day (peak/incident scenarios)\n\n|NFR-SCALE-003\n|Auto-scaling: ProfileService and EngagementService\n|Auto-scale based on CPU/memory/request rate, scale up within 2 minutes\n\n|NFR-SCALE-004\n|Event Bus queue capacity\n|Support 100,000 queued messages (buffer for Salesforce downtime)\n\n|NFR-SCALE-005\n|Salesforce API rate limit compliance\n|Stay within 80% of Salesforce API rate limits (buffer for spikes)\n\n|NFR-SCALE-006\n|Future growth capacity\n|Architecture supports 10x growth (1,000-1,500 submissions/day based on 200k DAU) without major redesign\n\n|===\n\n=== Security Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-SEC-001\n|Mobile App authentication\n|Microsoft Entra External ID OAuth 2.0 with JWT tokens (existing CIAM)\n\n|NFR-SEC-002\n|API authorisation: ProfileService and EngagementService\n|JWT token validation, authenticated users only, user context propagation\n\n|NFR-SEC-003\n|Salesforce API authentication\n|OAuth 2.0 with Connected App and JWT bearer flow (service account)\n\n|NFR-SEC-004\n|Data encryption in transit\n|TLS 1.2+ for all API calls (Mobile App ↔ ProfileService/EngagementService ↔ Salesforce ↔ Braze)\n\n|NFR-SEC-005\n|Data encryption at rest\n|Salesforce encryption at rest (managed by Salesforce), Event Bus message encryption (AWS KMS)\n\n|NFR-SEC-006\n|Secret management\n|AWS Secrets Manager for Salesforce credentials, Braze API keys, OAuth tokens (no hardcoded secrets)\n\n|NFR-SEC-007\n|PII data handling\n|Contact data (email, phone, name) treated as PII, GDPR-compliant retention policies (Salesforce governance)\n\n|NFR-SEC-008\n|API rate limiting and throttling\n|API Gateway rate limiting (100 requests/second per user), prevent abuse and DoS\n\n|NFR-SEC-009\n|Logging and auditing\n|Log all API calls, Salesforce Contact/Case creates/updates, Event Bus publishes (no PII in logs)\n\n|NFR-SEC-010\n|Salesforce data isolation\n|Multi-tenant data isolation via Salesforce Record Types, queues, sharing rules (defined by Viva Energy admin team)\n\n|===\n\n=== Reliability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-REL-001\n|Retry logic: EngagementService → Salesforce Case creation\n|Exponential backoff (1s, 2s, 4s, 8s, 16s), max 5 retries, then dead letter queue\n\n|NFR-REL-002\n|Dead letter queue monitoring\n|Alert ops team immediately when DLQ depth > 0 (failed Case creations require manual intervention)\n\n|NFR-REL-003\n|Event Bus message durability\n|Messages persisted in Event Bus (SNS+SQS/EventBridge/Kinesis), not lost on service restart\n\n|NFR-REL-004\n|Idempotency: Case creation\n|EngagementService ensures duplicate feedback submissions don't create duplicate Cases (idempotency key)\n\n|NFR-REL-005\n|Circuit breaker: Salesforce API calls\n|Open circuit after 5 consecutive failures, half-open retry after 30 seconds\n\n|NFR-REL-006\n|Health checks: ProfileService and EngagementService\n|Health endpoints for load balancer checks, readiness and liveness probes\n\n|NFR-REL-007\n|Disaster recovery: Event Bus\n|Event Bus messages replicated across AWS availability zones (SQS/EventBridge/Kinesis HA)\n\n|===\n\n=== Maintainability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-MAINT-001\n|Code quality: ProfileService and EngagementService\n|> 80% test coverage (unit + integration tests), automated CI/CD pipeline\n\n|NFR-MAINT-002\n|API documentation\n|OpenAPI/Swagger specs for ProfileService and EngagementService, auto-generated API docs\n\n|NFR-MAINT-003\n|Deployment automation\n|Infrastructure as Code (Terraform/CloudFormation/CDK), zero-downtime deployments\n\n|NFR-MAINT-004\n|Logging: structured logs\n|JSON-formatted logs with correlation IDs, log levels (DEBUG, INFO, WARN, ERROR), centralized log aggregation\n\n|NFR-MAINT-005\n|Monitoring dashboards\n|Real-time dashboards for ProfileService, EngagementService, Event Bus (see Monitoring and Observability section)\n\n|NFR-MAINT-006\n|Alerting and on-call\n|PagerDuty/Opsgenie integration for P1/P2 alerts, on-call rotation for ops team\n\n|NFR-MAINT-007\n|Configuration management\n|Externalized configuration (environment variables, AWS Parameter Store), no hardcoded config\n\n|NFR-MAINT-008\n|Versioning: API and events\n|Semantic versioning (v1, v2), backward compatibility for API changes, event schema evolution\n\n|===\n\n=== Usability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-USE-001\n|Feedback submission UX\n|Mobile App user receives immediate \"Feedback submitted\" confirmation (< 1 second), not blocked by async Case creation\n\n|NFR-USE-002\n|Push notification delivery\n|Customer receives \"Your feedback has been received\" notification within 30 seconds of Case creation in Salesforce\n\n|NFR-USE-003\n|Case resolution notification\n|Customer receives \"Your case has been resolved\" notification within 30 seconds of support agent resolving Case\n\n|NFR-USE-004\n|Error messaging\n|User-friendly error messages for failed feedback submission (not technical errors), retry prompts\n\n|NFR-USE-005\n|Accessibility\n|Mobile App feedback form meets WCAG 2.1 AA accessibility standards (existing Mobile App compliance)\n\n|===\n\n=== Compliance Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-COMP-001\n|GDPR compliance: PII data\n|Customer Contact data (email, phone, name) managed per GDPR retention policies (Salesforce governance)\n\n|NFR-COMP-002\n|GDPR compliance: Right to erasure\n|Support \"Delete Account\" feedback category, trigger Contact deletion in Salesforce per GDPR Article 17\n\n|NFR-COMP-003\n|Data residency\n|Salesforce data residency governed by Viva Energy Salesforce configuration (regional compliance)\n\n|NFR-COMP-004\n|Audit trail\n|All Contact creates/updates, Case creates/updates logged for compliance auditing (Salesforce audit logs)\n\n|NFR-COMP-005\n|API security standards\n|OWASP API Security Top 10 compliance (injection prevention, authentication, authorisation, data exposure)\n\n|===\n\n== Monitoring and Observability\n\n=== Key Metrics\n\n[width=\"100%\",cols=\"25%,40%,35%\",options=\"header\",]\n|===\n|Metric Category |Metric |Target/Threshold\n\n|*Feedback Submission*\n|Feedback submission success rate (Mobile App → EngagementService)\n|> 99.5%\n\n|*Async Case Creation*\n|Case creation success rate (EngagementService → Salesforce)\n|> 99%\n\n|*Async Case Creation*\n|Case creation latency (time from feedback submission to Case created in Salesforce)\n|p95 < 5 minutes\n\n|*Event Bus*\n|Event Bus queue depth (pending Case creations)\n|< 100 messages\n\n|*Event Bus*\n|Dead letter queue depth (failed Case creations)\n|= 0 (alert on any failures)\n\n|*Salesforce API*\n|Salesforce API error rate\n|< 1%\n\n|*Salesforce API*\n|Salesforce API latency (Case creation)\n|p95 < 2 seconds\n\n|*Salesforce API*\n|Salesforce API rate limit utilization\n|< 80% of limit\n\n|*ProfileService*\n|Contact reconciliation success rate (JIT lookups)\n|> 99.5%\n\n|*ProfileService*\n|Contact reconciliation latency\n|p95 < 500ms\n\n|*Braze Notifications*\n|Push notification delivery rate (Case created/updated)\n|> 95%\n\n|*Salesforce Webhook*\n|Webhook delivery success rate (Salesforce → EngagementService)\n|> 99%\n\n|*Customer Satisfaction*\n|Customer satisfaction score (CSAT)\n|> 4.0/5.0 (improve by 15% from D365 CE baseline)\n\n|*Support Operations*\n|Average case resolution time\n|Decrease by 20% from D365 CE baseline\n\n|===\n\n=== Alerting Thresholds\n\n[width=\"100%\",cols=\"25%,50%,25%\",options=\"header\",]\n|===\n|Alert |Condition |Severity\n\n|*Feedback submission failures*\n|Feedback submission success rate < 95% over 5-minute window\n|P1 - Critical\n\n|*Dead letter queue accumulation*\n|Dead letter queue depth > 0 (any failed Case creations)\n|P2 - High\n\n|*Event Bus queue backlog*\n|Event Bus queue depth > 100 messages for > 15 minutes\n|P2 - High\n\n|*Salesforce API errors*\n|Salesforce API error rate > 5% over 5-minute window\n|P1 - Critical\n\n|*Salesforce API rate limits*\n|Salesforce API rate limit utilization > 90%\n|P2 - High\n\n|*Contact reconciliation failures*\n|ProfileService Contact reconciliation failure rate > 5% over 5-minute window\n|P2 - High\n\n|*Braze notification failures*\n|Braze push notification delivery rate < 80% over 15-minute window\n|P3 - Medium\n\n|*Salesforce webhook failures*\n|Salesforce webhook delivery success rate < 90% over 15-minute window\n|P2 - High\n\n|*Case creation latency*\n|Case creation latency p95 > 10 minutes\n|P3 - Medium\n\n|===\n\n=== Dashboards\n\n*ProfileService Dashboard:*\n\n* Contact reconciliation success rate (JIT lookups)\n* Contact reconciliation latency (p50, p95, p99)\n* Contact creation vs update ratio (new Contacts created vs existing Contacts updated)\n* Salesforce API error rate (Contact queries and creates)\n* Request rate and throughput\n\n*EngagementService Dashboard:*\n\n* Feedback submission success rate\n* Case creation success rate (async workflow)\n* Case creation latency (p50, p95, p99)\n* Event Bus queue depth (pending Case creations)\n* Dead letter queue depth (failed Case creations)\n* Salesforce API error rate (Case creation)\n* Salesforce API latency\n* Salesforce API rate limit utilization\n* Braze push notification delivery rate\n* Salesforce webhook delivery success rate\n\n*Event Bus Dashboard:*\n\n* Queue depth (pending messages)\n* Throughput (messages published/consumed per minute)\n* Dead letter queue depth (failed messages)\n* Consumer lag (time between publish and consume)\n\n*Customer Support Dashboard (Business Metrics):*\n\n* Total feedback submissions per day/week/month\n* Feedback category breakdown (App, Service, Order, Rewards, Refund, Delete Account)\n* Customer satisfaction score (CSAT) trend\n* Average case resolution time trend\n* Case volume by support team/queue\n* Unified customer view adoption (support agent feedback)\n<<<\n== Solution Validation\n\nThis section defines the validation criteria and testing approach for the solution.\n\n=== Functional Validation\n\n==== ProfileService API Testing\n\n*Test Scenarios*:\n1. **Happy Path**: Authenticated user requests Contact ID, existing Contact found in Salesforce, Contact ID returned\n2. **JIT Creation**: Authenticated user requests Contact ID, no existing Contact, new Contact created in Salesforce, Contact ID returned\n3. **Salesforce API Failure**: Salesforce unavailable, ProfileService returns 500 error, user retries\n4. **Invalid JWT**: Unauthenticated request, ProfileService returns 401 error\n\n*Acceptance Criteria*:\n- Contact reconciliation success rate > 99.5%\n- JIT Contact creation completes within 500ms (p95)\n\n==== EngagementService API Testing\n\n*Test Scenarios*:\n1. **Happy Path**: Valid feedback submission, immediate 202 Accepted response, Case created in Salesforce within 5 minutes, Braze notification delivered\n2. **Invalid Category**: Invalid feedback category, 400 Bad Request response with validation error\n3. **Salesforce Downtime**: Salesforce unavailable during async Case creation, message queued, retry logic executes, Case created when Salesforce recovers\n4. **Dead Letter Queue**: Case creation fails after 5 retries, message moved to DLQ, ops team alerted\n5. **Webhook Notification**: Support agent resolves Case in Salesforce, webhook triggers EngagementService, Braze push notification sent to customer\n\n*Acceptance Criteria*:\n- Feedback submission success rate > 99.5% (including async Case creation)\n- Async Case creation completes within 5 minutes (p95)\n- Webhook delivery success rate > 99%\n\n=== Non-Functional Validation\n\n==== Performance Testing\n\n*Load Testing*:\n\n*Baseline*: Expected 100-150 submissions/day from 20k DAU (~0.5-0.75% submission rate)\n\n- **Normal Load**: 1 submission/minute sustained for 2 hours (simulate typical daily pattern)\n- **3x Load**: 3 submissions/minute sustained for 1 hour (simulate busy period, 450 submissions/day)\n- **Peak Load (10x)**: 10 submissions/minute for 15 minutes (simulate incident scenario, app outage causing backlog)\n- **Stress Test**: 50 submissions/minute for 5 minutes (find breaking point, 20x normal)\n\n*Validation*:\n- API response time p95 < 1 second under 10x load\n- Event Bus queue depth remains manageable (< 100 messages)\n- No Case creation failures, all submissions processed successfully\n- Auto-scaling triggers appropriately for sustained load > 3x baseline\n\n*Acceptance Criteria*:\n- NFR-PERF-001 through NFR-PERF-006 validated under realistic load (3x and 10x baseline)\n- Auto-scaling triggers within 2 minutes of load increase\n- System handles 10x peak gracefully, 20x stress test identifies limits\n\n==== Resilience Testing\n\n*Salesforce API Failure Scenarios*:\n1. **Complete Outage**: Salesforce unavailable for 2 hours, Event Bus queues buffer work, Cases created when Salesforce recovers\n2. **Rate Limit Exceeded**: Salesforce rate limit hit, queue throttling activates, Cases created within SLA\n\n*Acceptance Criteria*:\n- NFR-AVAIL-004 validated (graceful degradation during Salesforce downtime)\n- Circuit breaker activates after 5 consecutive failures\n\n==== Security Validation\n\n*Penetration Testing*:\n- API authentication bypass attempts\n- SQL injection attempts\n- Webhook signature validation bypass\n\n*Acceptance Criteria*:\n- NFR-SEC-001 through NFR-SEC-010 validated\n- OWASP API Security Top 10 compliance verified\n\n=== Integration Validation\n\n==== End-to-End Testing\n\n*Full User Journey*:\n1. User authenticates via Microsoft Entra External ID\n2. Mobile App requests Contact ID from ProfileService (JIT reconciliation)\n3. User submits feedback via EngagementService\n4. Background worker creates Case in Salesforce\n5. Braze notification delivered to user\n6. Support agent resolves Case in Salesforce\n7. Salesforce webhook triggers EngagementService\n8. Braze notification delivered to user\n\n*Acceptance Criteria*:\n- End-to-end flow completes successfully in UAT\n- User receives both \"feedback submitted\" and \"case resolved\" notifications\n","structuredPatch":[{"oldStart":1977,"oldLines":8,"newStart":1977,"newLines":8,"lines":[" *Dependent Work Packages*:"," "," * None (can start in parallel with development work packages)","-* Required for WP-CS-002 (EngagementService needs field mapping)","-* Required for WP-CS-006 (Integration Testing needs sandbox configuration)","+* Required for <<wp-cs-002,WP-CS-002>> (EngagementService needs field mapping)","+* Required for <<wp-cs-006,WP-CS-006>> (Integration Testing needs sandbox configuration)"," "," ==== Skills Required"," "]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"fb740b3c-e0b1-49ca-8b00-b7ded5d86e2c"}
{"parentUuid":"95ef04e9-e6e0-4a11-968d-5eb893830301","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01TPFu29wg2xibjH9Wq5qbGz","type":"tool_result","content":"The file /mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n  2034→** Migration execution time\n  2035→\n  2036→==== Dependencies\n  2037→\n  2038→*Prerequisites*:\n  2039→\n  2040→* <<wp-cs-004,WP-CS-004>> (Contact Migration Tooling) completed\n  2041→* <<wp-cs-001,WP-CS-001>> (ProfileService Development) deployed to production (not yet integrated with Mobile App)\n  2042→* <<wp-cs-007,WP-CS-007>> (Salesforce Configuration) production configuration completed\n  2043→* Salesforce production access granted\n  2044→* Migration approved by business stakeholders\n  2045→\n  2046→*Dependent Work Packages*:\n  2047→\n  2048→* Must complete after <<wp-cs-001,WP-CS-001>>, <<wp-cs-004,WP-CS-004>>, <<wp-cs-007,WP-CS-007>>\n  2049→* Must complete before <<wp-cs-009,WP-CS-009>> (Production Deployment)\n  2050→\n  2051→==== Skills Required\n  2052→\n  2053→* Data migration execution"}]},"uuid":"7ab8c21b-4832-4994-8a0a-6dc666d5479f","timestamp":"2026-01-09T03:11:43.135Z","toolUseResult":{"filePath":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","oldString":"*Prerequisites*:\n\n* WP-CS-004 (Contact Migration Tooling) completed\n* WP-CS-001 (ProfileService Development) deployed to production (not yet integrated with Mobile App)\n* WP-CS-007 (Salesforce Configuration) production configuration completed\n* Salesforce production access granted\n* Migration approved by business stakeholders\n\n*Dependent Work Packages*:\n\n* Must complete after WP-CS-001, WP-CS-004, WP-CS-007\n* Must complete before WP-CS-009 (Production Deployment)","newString":"*Prerequisites*:\n\n* <<wp-cs-004,WP-CS-004>> (Contact Migration Tooling) completed\n* <<wp-cs-001,WP-CS-001>> (ProfileService Development) deployed to production (not yet integrated with Mobile App)\n* <<wp-cs-007,WP-CS-007>> (Salesforce Configuration) production configuration completed\n* Salesforce production access granted\n* Migration approved by business stakeholders\n\n*Dependent Work Packages*:\n\n* Must complete after <<wp-cs-001,WP-CS-001>>, <<wp-cs-004,WP-CS-004>>, <<wp-cs-007,WP-CS-007>>\n* Must complete before <<wp-cs-009,WP-CS-009>> (Production Deployment)","originalFile":"= Salesforce Customer Support - Solution Architecture\n:project-name: Salesforce Customer Support\n:togaf-adm-phase: Phase E: Opportunities & Solutions\n:last-updated: 2026-01-07\n:document-type: Solution Architecture Document\n:status: Discovery\n:version: 0.1\n:domain: Customer Support & Engagement\n:programme-lead:\n:domain-architect: O.Young@otr.com.au\n:architecture-definition: xref:architecture-definitions:salesforce_customer_support.adoc[Architecture Definitions/Salesforce Customer Support]\n:doctype: article\n:toc: left\n:toclevels: 4\n:sectanchors:\n:sectlinks:\n:sectnums:\n:icons: font\n:source-highlighter: highlightjs\n:experimental:\n:description:\n:keywords:\n\n<<<\n== Purpose and Scope\n\n=== Purpose\n\nThis Solution Architecture defines how the Salesforce Customer Support consolidation will be implemented - the specific technology products, configurations, interfaces, and deployment architecture that realise the xref:architecture-definitions:salesforce_customer_support.adoc[Salesforce Customer Support Architecture Definition].\n\nThis solution establishes the **first implementation of OTR's target Domain-Driven Design (DDD) architecture** by deploying two new bounded contexts (`ProfileService` and `EngagementService`) as microservices, consolidating customer support onto Salesforce Service Cloud, and implementing event-driven integration patterns that will serve as the foundation for future bounded contexts (including Flybuys integration).\n\n=== Vision\n\n> Unify customer support across all OTRG channels by consolidating OTR digital customer feedback onto Salesforce Service Cloud, establishing the foundational DDD architecture with ProfileService and EngagementService bounded contexts that protect digital channels from external system changes while enabling support agents to deliver exceptional customer experiences with complete interaction history.\n\n=== Architectural Approach\n\nThis architecture establishes OTR's **first bounded context implementation** using Domain-Driven Design strategic patterns:\n\n* *link:../bounded_context/profile.adoc[ProfileService]* (NEW bounded context): Just-In-Time Contact reconciliation with Salesforce, upsert by email, returns Salesforce Contact ID to digital channels - foundation for future Flybuys partner linking\n* *link:../bounded_context/engagement.adoc[EngagementService]* (NEW bounded context): Customer feedback submission facade, Anti-Corruption Layer for Salesforce Case creation, Braze integration for all outbound customer communications (push, email, SMS), async Case processing via Event Bus\n* *Event-driven integration* (NEW pattern): Domain event publishing using existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis) - first implementation establishing pattern for future bounded contexts\n* *Anti-Corruption Layer*: EngagementService isolates digital channels from Salesforce API changes, translates between OTR domain language and Salesforce Service Cloud API\n* *Conformist Pattern*: ProfileService and EngagementService conform to existing Salesforce configuration (shared Viva Energy instance, multi-tenant governance)\n* *Big bang cutover*: Single deployment after Contact migration, no phased rollout, D365 CE retirement post-cutover\n\n=== Scope\n\n==== In Scope\n\n* Solution Building Blocks (SBBs) - specific technology products and versions\n* Interface specifications (APIs, events, data formats)\n* Data architecture and schema specifications\n* Deployment architecture and infrastructure configuration\n* Transition architecture with migration phases\n* Technical validation criteria and testing approach\n* External system integration specifications\n* Physical data models and API schemas\n\n==== Out of Scope\n\n===== Covered in xref:architecture-definitions:salesforce_customer_support.adoc[Architecture Definition]\n\n* Business requirements and stakeholder analysis\n* Architecture decisions and rationale (ADRs)\n* Bounded context definitions and responsibilities\n* High-level integration patterns (ACL, Conformist, OHS+PL)\n* Business capability mapping and value streams\n* Architecture principles and governance\n\n===== Covered in Other Documents\n\n* Detailed design (class diagrams, sequence diagrams for all flows)\n* Implementation code and unit tests\n* Business case and return-on-investment analysis\n* Operational run books and support procedures\n\n<<<\n=== Architecture Overview\n\n[mermaid]\n----\n---\nconfig:\n  layout: elk\n---\nflowchart TB\n    Customer([\"Customer\"]) -- Uses --> MobileApp[\"Mobile App<br>iOS/Android\"]\n    Customer -- Shops at --> POS[\"OTR/OTR+ POS<br>D365 Commerce\"]\n    MobileApp -- Authenticate --> EntraID[\"Microsoft Entra\"]\n    MobileApp -- Identifies & Reconciles --> ProfileService[\"ProfileService\"]\n    ProfileService <-- Reconcile App User as Salesforce Contact --> Salesforce[\"Salesforce\"]\n    ProfileService -- On Create --> EventBus[\"EventBus\"]\n    EventBus -- Emits CreateUser Event --> LoyaltyService[\"LoyaltyService\"] & EngagementService[\"EngagementService\"]\n    LoyaltyService -- Reconcile Wallet --> EagleEye[\"EagleEye\"]\n    EngagementService -- Reconcile Braze Profile --> Braze[\"Braze\"]\n    EngagementService --> Salesforce\n    D365CE[\"D365CE\"] -- Data Migration --> Salesforce\n    MobileApp -- Submits Feedback --> EngagementService\n\n    Customer:::customer\n    MobileApp:::presentation\n    POS:::presentation\n    EntraID:::external\n    ProfileService:::newService\n    Salesforce:::external\n    EventBus:::infrastructure\n    LoyaltyService:::newService\n    EngagementService:::newService\n    EagleEye:::external\n    Braze:::external\n    D365CE:::external\n    classDef newService fill:#4CAF50,stroke:#2E7D32,stroke-width:3px,color:#fff\n    classDef external fill:#FF9800,stroke:#E65100,stroke-width:2px,color:#fff\n    classDef infrastructure fill:#2196F3,stroke:#0D47A1,stroke-width:2px,color:#fff\n    classDef presentation fill:#9C27B0,stroke:#4A148C,stroke-width:2px,color:#fff\n    classDef customer fill:#607D8B,stroke:#263238,stroke-width:2px,color:#fff\n----\n\n\n==== Key Architectural Patterns\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Pattern |Application |Rationale\n\n|*Anti-Corruption Layer (ACL)*\n|EngagementService → Salesforce Service Cloud\n|Protects digital channels (Mobile App, Web) from Salesforce API changes, translates between OTR domain language and Salesforce Case/Contact model, enables independent evolution of internal domain model\n\n|*Conformist*\n|ProfileService → Salesforce, EngagementService → Salesforce\n|Shared Viva Energy Salesforce instance - we conform to existing configuration, governance, and API contracts (external system we don't control)\n\n|*Backend-for-Frontend (BFF)*\n|EngagementService\n|Aggregates customer feedback submission, Contact lookup, async Case creation, and Braze notification orchestration for digital channel clients\n\n|*Event-Driven Architecture (OHS+PL)*\n|Event Bus (SNS+SQS/EventBridge/Kinesis)\n|Loose coupling between bounded contexts, async domain event publishing (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`), foundation for future bounded contexts\n\n|*Just-In-Time (JIT) Integration*\n|ProfileService → Salesforce Contact reconciliation\n|Reconcile app users as Salesforce Contacts on-demand (upsert by email), no pre-sync required, ensures Salesforce has current Contact data\n\n|*Async Processing*\n|EngagementService Case creation via Event Bus\n|Non-blocking user experience, resilience to Salesforce downtime, automatic retry with exponential backoff, dead letter queue for operations team intervention\n\n|*Strangler Fig*\n|Not applicable\n|Big bang cutover (no gradual migration) - D365 CE fully replaced, not incrementally strangled\n\n|===\n\n<<<\n== Solution Approach\n\n* Deploy xref:bounded-contexts:profile.adoc[ProfileService] and xref:bounded-contexts:engagement.adoc[EngagementService] as bounded context microservices\n* Implement Anti-Corruption Layers (ACLs) for Salesforce and Braze integration\n* Establish event-driven architecture as the foundational integration pattern\n* Big bang cutover (TS-1 → TS-4)\n\n=== Related Documentation\n\nThis solution architecture references detailed technical specifications:\n\n==== Architecture Definition\n\n* xref:architecture-definitions:salesforce_customer_support.adoc[Salesforce Customer Support - Architecture Definition] - Business requirements, architecture decisions (ADRs), bounded context definitions, high-level integration patterns\n\n==== Bounded Context Specifications\n\n* xref:bounded-contexts:profile.adoc[ProfileService Bounded Context] - JIT Contact reconciliation, aggregate definitions\n* xref:bounded-contexts:engagement.adoc[EngagementService Bounded Context] - Customer feedback facade, Anti-Corruption Layer\n\n==== Interface Specifications\n\nDetailed API specifications available in the specifications directory:\n\n* link:../../specifications/rest/profile-service-v1.yaml[ProfileService REST API v1] - OpenAPI 3.0 specification for `/profile/v1` endpoints (includes Salesforce Contact reconciliation `GET /contact-id`)\n* link:../../specifications/rest/engagement-service-v1.yaml[EngagementService REST API v1] - OpenAPI 3.0 specification for `/engagement/v1` endpoints (includes `POST /feedback`)\n* link:../../specifications/events/engagement-events.json[Engagement Domain Events] - CloudEvents 1.0 JSON Schema for `SupportCaseCreated`, `SupportCaseUpdated`, `SupportCaseResolved`, `CustomerFeedbackSubmitted`\n\n==== External System Documentation\n\n* https://developer.salesforce.com/docs/atlas.en-us.api_rest.meta/api_rest/[Salesforce REST API Documentation] - Contact and Case object APIs\n* https://www.braze.com/docs/api/endpoints/messaging/send_messages/post_send_triggered_campaigns/[Braze Campaign Trigger API] - Push notification campaigns\n\n<<<\n== Executive Summary\n\n=== Challenge\n\nOTR digital customers (Mobile App, Web) currently submit feedback and support requests to D365 Customer Engagement, while Viva Energy's broader business units (fuel wholesale, Shell Card customers, other retail channels) use Salesforce Service Cloud. This creates:\n\n* *Fragmented customer support platform*: Customer support data split across two systems, preventing support agents from having a unified view of customer interactions across all channels\n* *Operational inefficiency*: Maintaining two separate customer support platforms increases operational overhead and costs\n* *Poor support experience*: D365 CE is not working well for digital customer support, impacting customer satisfaction and case resolution times\n* *Post-merger consolidation opportunity*: Following Viva Energy's acquisition of OTR, strategic alignment on Salesforce as the enterprise customer support platform\n\n=== Solution\n\nThis architecture establishes the **foundational Domain-Driven Design (DDD) implementation** for OTR's target state architecture by introducing two new bounded contexts (link:../bounded_context/profile.adoc[ProfileService], link:../bounded_context/engagement.adoc[EngagementService]) and event-driven integration patterns:\n\n==== New Bounded Contexts\n\n* *link:../bounded_context/profile.adoc[ProfileService]* (NEW): Just-In-Time (JIT) Contact reconciliation with Salesforce, upsert by email, returns Salesforce Contact ID to Mobile App\n* *link:../bounded_context/engagement.adoc[EngagementService]* (NEW): Customer feedback submission, Anti-Corruption Layer (ACL) for Salesforce Case creation, Braze integration for all outbound customer communications (push, email, SMS), async Case processing via Event Bus\n* *Event Bus* (NEW pattern): Domain event publishing using existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis) - first implementation of event-driven architecture pattern\n\n==== Integration Architecture\n\n* *Salesforce = System of Record*: Salesforce Service Cloud (shared Viva Energy instance) owns Contact and Case data\n* *Conformist Pattern*: ProfileService and EngagementService conform to existing Salesforce configuration and API contracts\n* *Anti-Corruption Layer*: EngagementService protects digital channels from Salesforce API changes, translates between OTR domain language and Salesforce\n* *Async Case Creation*: Non-blocking user experience, resilience to Salesforce downtime, automatic retry with exponential backoff, dead letter queue for failed Cases\n* *Event-Driven Notifications*: Salesforce webhook → EngagementService → Braze for all customer communications (push, email, SMS) on Case status updates\n\n==== Migration Approach\n\n* *Contact Migration*: One-time migration from app-specific database → Salesforce (upsert with flexible matching by email/phone/VCI)\n* *No Case Migration*: Historical D365 CE Cases not migrated (fresh start in Salesforce)\n* *Big Bang Cutover*: Single deployment, no phased rollout or parallel run\n* *D365 CE Retirement*: Complete decommissioning of D365 Customer Engagement post-cutover\n\n=== Key Architectural Significance\n\nThis migration establishes the first implementation of OTR's target DDD architecture:\n\n* First bounded contexts implemented (ProfileService, EngagementService)\n* First event-driven domain event pattern (foundation for future bounded contexts)\n* Foundation for Flybuys integration (ProfileService Contact reconciliation reused)\n* Establishes integration patterns (Conformist, ACL, Event-Driven) for future services\n\n=== Success Criteria\n\n* All digital customer feedback routed to Salesforce Service Cloud within 30 days of launch\n* Support agents have unified customer view across all Viva Energy channels (digital, wholesale, Shell Card, other retail)\n* D365 Customer Engagement decommissioned within 90 days post-cutover\n* Customer satisfaction score improves by 15% within 6 months\n* Average case resolution time decreases by 20% within 6 months\n* Zero data loss during Contact migration (100% validation pass rate)\n* Mobile App feedback submission success rate > 99.5% (including async Case creation)\n\n=== Technical Constraints\n\n* Shared Salesforce instance (Viva Energy multi-tenant environment)\n* Conform to existing Salesforce configuration and governance (data isolation strategy TBD with Salesforce admin team)\n* Contact migration must complete before cutover (no parallel run)\n* Async Case creation mandatory (non-blocking user experience)\n* Expected volume: 100-150 feedback submissions/day from 20k DAU (~0.5-0.75% submission rate), architecture capacity planned for 3x-10x growth\n\n=== Open Technical Decisions (TBD)\n\n* Salesforce Case field mapping for digital feedback categories (App, Service, Order, Rewards, Refund, Delete Account)\n* Salesforce data isolation strategy (Record Types, custom fields, queues)\n* Salesforce REST API authentication method (OAuth 2.0, Connected App, JWT bearer flow)\n* Salesforce webhook mechanism for Case updates (Outbound Messages, Platform Events, Process Builder)\n* Retry policy configuration (attempts, backoff intervals)\n* Salesforce API rate limit strategy (expected volume: 100-150 submissions/day from 20k DAU, capacity planning for 3x-10x growth)\n\n== Technical Requirements\n\n[width=\"100%\",cols=\"8%,92%\",options=\"header\",]\n|===\n|ID |Description\n\n|TR-CS-001\n|Every Mobile App user must have a Salesforce Contact record in Salesforce Service Cloud (shared Viva Energy instance)\n\n|TR-CS-002\n|ProfileService must reconcile Mobile App users as Salesforce Contacts using Just-In-Time (JIT) upsert by email address\n\n|TR-CS-003\n|ProfileService must return Salesforce Contact ID to Mobile App for feedback submission\n\n|TR-CS-004\n|Mobile App must support customer feedback submission with fields: Category (App, Service, Order, Rewards, Refund, Delete Account), Store Name, Time of Visit, Contact Phone Number, Free Text Message\n\n|TR-CS-005\n|EngagementService must create Salesforce Cases asynchronously via Event Bus (non-blocking user experience)\n\n|TR-CS-006\n|EngagementService must acknowledge feedback submission immediately to Mobile App user (\"Feedback submitted\" confirmation)\n\n|TR-CS-007\n|EngagementService must send push notification to customer via Braze when Case is successfully created in Salesforce\n\n|TR-CS-008\n|EngagementService must retry failed Case creation with configurable exponential backoff and dead letter queue for operations team intervention\n\n|TR-CS-009\n|Salesforce must be the System of Record for Contact and Case data (no local persistence in ProfileService or EngagementService)\n\n|TR-CS-010\n|Contact migration from app-specific database to Salesforce must complete before Mobile App cutover (upsert with flexible matching by email/phone/VCI)\n\n|TR-CS-011\n|No Case migration from D365 Customer Engagement to Salesforce (fresh start, historical Cases not migrated)\n\n|TR-CS-012\n|EngagementService must publish domain events (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`) to Event Bus for consumption by other bounded contexts\n\n|TR-CS-013\n|EngagementService must receive Salesforce webhook notifications when Cases are updated/resolved by support agents\n\n|TR-CS-014\n|EngagementService must trigger Braze push notifications to customers when Cases are updated/resolved (via Salesforce webhook → EngagementService → Braze)\n\n|TR-CS-015\n|ProfileService and EngagementService must conform to existing Salesforce configuration and API contracts (Conformist pattern)\n\n|TR-CS-016\n|All changes must be communicated using event-driven architecture via Event Bus (using existing AWS infrastructure: SNS+SQS/EventBridge/Kinesis)\n\n|TR-CS-017\n|Mobile App feedback submission success rate must exceed 99.5% (including async Case creation completion)\n\n|TR-CS-018\n|Contact migration must achieve 100% validation pass rate (zero data loss)\n\n|TR-CS-019\n|D365 Customer Engagement must be fully decommissioned within 90 days post-cutover\n\n|===\n\n== Technical Architecture\n\n=== Technical Capability Requirements\n\n==== Requirements Traceability\n\n[width=\"100%\",cols=\"15%,50%,35%\",options=\"header\",]\n|===\n|Requirement ID |Requirement Summary |Architectural Building Blocks\n\n|TR-CS-001\n|Every Mobile App user must have Salesforce Contact record\n|ABB-CS-001 (ProfileService), ABB-CS-004 (Salesforce), ABB-CS-007 (Contact Migration Tool)\n\n|TR-CS-002\n|ProfileService JIT Contact reconciliation via upsert by email\n|ABB-CS-001 (ProfileService), ABB-CS-004 (Salesforce)\n\n|TR-CS-003\n|ProfileService returns Salesforce Contact ID to Mobile App\n|ABB-CS-001 (ProfileService), ABB-CS-006 (Mobile App)\n\n|TR-CS-004\n|Mobile App supports feedback submission with structured fields\n|ABB-CS-006 (Mobile App), ABB-CS-002 (EngagementService)\n\n|TR-CS-005\n|EngagementService creates Salesforce Cases asynchronously\n|ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus), ABB-CS-004 (Salesforce)\n\n|TR-CS-006\n|EngagementService immediate acknowledgment to Mobile App\n|ABB-CS-002 (EngagementService), ABB-CS-006 (Mobile App)\n\n|TR-CS-007\n|EngagementService sends push notification via Braze on Case creation\n|ABB-CS-002 (EngagementService), ABB-CS-005 (Braze)\n\n|TR-CS-008\n|EngagementService retry logic with exponential backoff and DLQ\n|ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus)\n\n|TR-CS-009\n|Salesforce is System of Record for Contact and Case data\n|ABB-CS-004 (Salesforce), ABB-CS-001 (ProfileService - stateless), ABB-CS-002 (EngagementService - stateless)\n\n|TR-CS-010\n|Contact migration before Mobile App cutover\n|ABB-CS-007 (Contact Migration Tool), ABB-CS-004 (Salesforce)\n\n|TR-CS-011\n|No Case migration from D365 CE (fresh start)\n|ABB-CS-004 (Salesforce) - no migration tooling required\n\n|TR-CS-012\n|EngagementService publishes domain events to Event Bus\n|ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus)\n\n|TR-CS-013\n|EngagementService receives Salesforce webhook notifications\n|ABB-CS-002 (EngagementService), ABB-CS-004 (Salesforce)\n\n|TR-CS-014\n|EngagementService triggers Braze notifications on Case updates\n|ABB-CS-002 (EngagementService), ABB-CS-004 (Salesforce), ABB-CS-005 (Braze)\n\n|TR-CS-015\n|ProfileService and EngagementService conform to Salesforce config\n|ABB-CS-001 (ProfileService), ABB-CS-002 (EngagementService), ABB-CS-004 (Salesforce)\n\n|TR-CS-016\n|Event-driven architecture via Event Bus\n|ABB-CS-003 (Event Bus), ABB-CS-002 (EngagementService)\n\n|TR-CS-017\n|Mobile App feedback submission success rate > 99.5%\n|ABB-CS-006 (Mobile App), ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus), ABB-CS-004 (Salesforce)\n\n|TR-CS-018\n|Contact migration 100% validation pass rate\n|ABB-CS-007 (Contact Migration Tool), ABB-CS-004 (Salesforce)\n\n|TR-CS-019\n|D365 CE decommissioned within 90 days post-cutover\n|All ABBs (replacement system operational)\n\n|===\n\n=== Service Catalogues\n\n==== Application Portfolio Catalogue\n\n[width=\"100%\",cols=\"20%,15%,15%,15%,35%\",options=\"header\",]\n|===\n|Application |Lifecycle State |Owner |Hosting Platform |Description\n\n|*ProfileService*\n|NEW\n|OTR Platform Team\n|AWS (TBD: Lambda/ECS/EKS)\n|JIT Contact reconciliation with Salesforce, returns Salesforce Contact ID, foundation for Flybuys integration\n\n|*EngagementService*\n|NEW\n|OTR Platform Team\n|AWS (TBD: Lambda/ECS/EKS)\n|Customer feedback submission facade, ACL for Salesforce Case creation, Braze integration for all outbound communications (push, email, SMS), webhook receiver\n\n|*Mobile App (iOS)*\n|ACTIVE (UPDATE)\n|OTR Mobile Team\n|Apple App Store\n|iOS native app with feedback form, integrate with ProfileService and EngagementService APIs\n\n|*Mobile App (Android)*\n|ACTIVE (UPDATE)\n|OTR Mobile Team\n|Google Play Store\n|Android native app with feedback form, integrate with ProfileService and EngagementService APIs\n\n|*Salesforce Service Cloud*\n|ACTIVE (EXPAND)\n|Viva Energy Salesforce Admin Team\n|Salesforce (SaaS)\n|Shared Viva Energy instance, System of Record for Contact and Case data, adding OTR digital customer support\n\n|*Braze*\n|ACTIVE (EXTEND)\n|OTR Marketing Team\n|Braze (SaaS)\n|Marketing automation platform, EngagementService triggers push notifications for Case updates\n\n|*D365 Customer Engagement*\n|RETIRE\n|OTR Support Team\n|Microsoft Azure (SaaS)\n|Legacy customer support platform, decommissioned within 90 days post-cutover\n\n|*App-Specific Customer Database*\n|RETIRE\n|OTR Platform Team\n|AWS (RDS/DynamoDB)\n|Legacy customer contact storage, one-time migration to Salesforce, then deprecated\n\n|*Event Bus*\n|NEW\n|OTR Platform Team\n|AWS (SNS+SQS/EventBridge/Kinesis)\n|Domain event publishing infrastructure for bounded context integration\n\n|*Contact Migration Tool*\n|TEMPORARY\n|OTR Platform Team\n|AWS (Script/Lambda)\n|One-time migration app database → Salesforce with upsert logic, retired after migration complete\n\n|===\n\n==== Technology Capability Requirements\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Technology Capability |Implementation Technology (TBD in detailed design) |Requirements\n\n|*Microservice Hosting*\n|AWS Lambda / ECS / EKS\n|Host ProfileService and EngagementService with auto-scaling, high availability, monitoring\n\n|*API Gateway*\n|AWS API Gateway / Application Load Balancer\n|REST API routing, authentication, rate limiting, request validation for ProfileService and EngagementService\n\n|*Event Bus*\n|AWS SNS+SQS / EventBridge / Kinesis\n|Domain event publishing, async message processing, retry logic, dead letter queue\n\n|*Salesforce Integration*\n|Salesforce REST API / SOAP API\n|Contact CRUD operations, Case creation, webhook notifications, OAuth 2.0 authentication\n\n|*Braze Integration*\n|Braze REST API / SDK\n|Push notification campaign triggers, customer profile reconciliation\n\n|*Authentication & Authorisation*\n|Microsoft Entra External ID / AWS Cognito\n|Mobile App user authentication, API authorisation, JWT token validation\n\n|*Observability & Monitoring*\n|AWS CloudWatch / Datadog / New Relic\n|Application metrics, logs, traces, dashboards, alerting (feedback submission rate, queue depth, API errors)\n\n|*Secret Management*\n|AWS Secrets Manager / Parameter Store\n|Salesforce credentials, Braze API keys, OAuth tokens, encryption keys\n\n|*Database (Migration Tool)*\n|AWS RDS / DynamoDB (read-only access)\n|Contact migration from app-specific database\n\n|*CI/CD Pipeline*\n|GitHub Actions / AWS CodePipeline\n|Automated build, test, deployment for ProfileService, EngagementService, Mobile App\n\n|*Infrastructure as Code*\n|Terraform / AWS CloudFormation / CDK\n|Declarative infrastructure provisioning for Event Bus, microservices, monitoring\n\n|*API Documentation*\n|OpenAPI / Swagger\n|ProfileService and EngagementService API specifications for Mobile App integration\n\n|===\n\n==== Feature Flag Register\n\n*Note*: Per ADR-CS-006 (big bang cutover, not phased rollout), feature flags are minimal and used primarily for emergency rollback/kill switches.\n\n[width=\"100%\",cols=\"20%,15%,35%,30%\",options=\"header\",]\n|===\n|Feature Flag |Default State |Purpose |Rollback Scenario\n\n|*enable_salesforce_feedback_submission*\n|OFF (pre-cutover), ON (post-cutover)\n|Enable/disable feedback submission to EngagementService → Salesforce (kill switch for emergency rollback to D365 CE)\n|Feedback submission success rate < 95%, Salesforce API failures, critical bugs - revert to D365 CE integration\n\n|*enable_async_case_creation*\n|ON\n|Enable/disable async Case creation via Event Bus (fallback to synchronous processing if Event Bus issues)\n|Event Bus infrastructure failures, queue backlog unmanageable - temporary synchronous processing\n\n|*enable_braze_notifications*\n|ON\n|Enable/disable Braze push notifications for Case updates (degrade gracefully if Braze integration fails)\n|Braze API failures, notification delivery rate < 80% - disable notifications temporarily\n\n|*enable_jit_contact_reconciliation*\n|ON\n|Enable/disable ProfileService JIT Contact reconciliation (fallback to cached Contact IDs if Salesforce unavailable)\n|Salesforce API downtime, Contact reconciliation failures > 5% - use cached Contact IDs temporarily\n\n|*enable_salesforce_webhook_processing*\n|ON\n|Enable/disable Salesforce webhook processing for Case updates (fallback to polling if webhook failures)\n|Webhook delivery failures, authentication issues - temporary polling fallback\n\n|===\n\n*Feature Flag Management*:\n\n* Feature flags managed via AWS AppConfig / LaunchDarkly / custom feature flag service (TBD in detailed design)\n* Mobile App feature flags controlled server-side (no app release required for flag changes)\n* Backend service feature flags configured via environment variables / configuration service\n* Feature flag changes logged and audited (who changed, when, reason)\n* Post-cutover monitoring: Gradual removal of feature flags once system stability confirmed (30-60 days)\n\n==== Data Entity Catalogue\n\n[width=\"100%\",cols=\"20%,15%,35%,30%\",options=\"header\",]\n|===\n|Data Entity |System of Record |Key Attributes |Lifecycle\n\n|*Contact*\n|Salesforce Service Cloud\n|• Contact ID (Salesforce 15/18-char ID) +\n• Email (primary matching key) +\n• First Name, Last Name +\n• Phone Number +\n• Viva Consumer ID (VCI) +\n• Account (Viva Energy customer account) +\n• Record Type (OTR Digital vs other channels)\n|Created: ProfileService JIT reconciliation or Contact Migration Tool +\nUpdated: ProfileService JIT upsert (email changes), Salesforce (manual updates by support agents) +\nDeleted: Salesforce retention policy (GDPR/compliance)\n\n|*Case*\n|Salesforce Service Cloud\n|• Case Number (Salesforce auto-generated) +\n• Contact ID (reference to Contact) +\n• Subject (derived from Category) +\n• Description (Free Text Message) +\n• Category (App, Service, Order, Rewards, Refund, Delete Account) +\n• Store Name (OTR location) +\n• Time of Visit +\n• Status (New, In Progress, Resolved, Closed) +\n• Priority, Origin (Mobile App) +\n• Owner (support agent/queue)\n|Created: EngagementService async Case creation +\nUpdated: Support agents (Salesforce UI), EngagementService (webhook processing) +\nDeleted: Salesforce retention policy (archive after X years)\n\n|*Feedback Submission (transient)*\n|None (not persisted)\n|• Salesforce Contact ID +\n• Category +\n• Store Name +\n• Time of Visit +\n• Contact Phone Number +\n• Free Text Message\n|Created: Mobile App user submission +\nProcessed: EngagementService publishes to Event Bus, Case created in Salesforce +\nNot persisted in ProfileService/EngagementService (stateless)\n\n|*Domain Events*\n|Event Bus (ephemeral)\n|**SupportCaseCreated**: +\n• Case Number, Contact ID, Category, Timestamp +\n**SupportCaseUpdated**: +\n• Case Number, Status, Updated By, Timestamp +\n**SupportCaseResolved**: +\n• Case Number, Resolution, Resolved By, Timestamp +\n**CustomerFeedbackSubmitted**: +\n• Contact ID, Category, Timestamp\n|Published: EngagementService +\nConsumed: Other bounded contexts (future), Braze notification triggers +\nRetention: Short-lived (minutes to hours), not persisted for event sourcing\n\n|*Braze Customer Profile*\n|Braze\n|• External User ID (VCI or Email) +\n• Push Notification Tokens (iOS/Android) +\n• Notification Preferences +\n• Campaign Engagement History\n|Created/Updated: EngagementService on Case creation/update +\nManaged: Braze (external SaaS)\n\n|===\n\n*Data Migration Entities*:\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Source Entity |Target Entity |Migration Strategy\n\n|*App Database Contact*\n|Salesforce Contact\n|One-time migration via Contact Migration Tool: +\n• Upsert by email (primary), phone (secondary), VCI (tertiary) +\n• Map: Email → Email, Name → First/Last Name, Phone → Phone, VCI → External ID +\n• Validation: 100% data integrity check, reconciliation report\n\n|*D365 CE Case*\n|Not migrated\n|ADR-CS-005: No Case migration (fresh start in Salesforce) +\nD365 CE Cases archived separately for compliance if needed\n\n|===\n\n==== Data Quality & Validation\n\n*Contact Migration Validation Rules*:\n\n* Email format validation (RFC 5322 compliance)\n* Phone number format validation (E.164 international format)\n* VCI format validation (alphanumeric, length constraints)\n* Duplicate detection: Flag potential duplicates for manual review (same email/phone combination)\n* Mandatory fields: Email (required), First Name, Last Name (required for Salesforce Contact)\n\n*Case Creation Validation Rules*:\n\n* Contact ID must exist in Salesforce (validated by EngagementService before Case creation)\n* Category must be one of: App, Service, Order, Rewards, Refund, Delete Account\n* Free Text Message maximum length: 32,000 characters (Salesforce Case Description limit)\n* Store Name validated against OTR location master data (optional - warn if not found)\n\n<<<\n== Solution Building Blocks\n\nThis section defines the specific technology products, configurations, and implementation details for each Solution Building Block (SBB).\n\n=== Technology Portfolio Catalogue\n\n[width=\"100%\",cols=\"10%,20%,25%,25%,20%\",options=\"header\",]\n|===\n|SBB ID |Component |Technology Product |Version/Configuration |Deployment Platform\n\n|SBB-CS-001\n|ProfileService Microservice\n|.NET 8 / Node.js 20 LTS\n|RESTful API, containerised\n|AWS ECS Fargate / Lambda\n\n|SBB-CS-002\n|EngagementService Microservice\n|.NET 8 / Node.js 20 LTS\n|RESTful API, containerised, async workers\n|AWS ECS Fargate / Lambda\n\n|SBB-CS-003\n|Event Bus\n|AWS SNS + SQS / EventBridge\n|Standard queues, FIFO for ordering\n|AWS (managed service)\n\n|SBB-CS-004\n|API Gateway\n|AWS API Gateway / ALB\n|REST API, JWT validation\n|AWS (managed service)\n\n|SBB-CS-005\n|Salesforce Integration Layer\n|Salesforce REST API Client\n|OAuth 2.0 JWT bearer flow\n|Embedded in SBB-CS-001/002\n\n|SBB-CS-006\n|Braze Integration Layer\n|Braze REST API SDK\n|API key authentication\n|Embedded in SBB-CS-002\n\n|SBB-CS-007\n|Contact Migration Tool\n|Python 3.11 / .NET 8\n|One-time batch script\n|AWS Lambda / EC2\n\n|SBB-CS-008\n|Application Monitoring\n|AWS CloudWatch / Datadog\n|Metrics, logs, traces, dashboards\n|AWS / SaaS\n\n|SBB-CS-009\n|Secret Management\n|AWS Secrets Manager\n|KMS encryption\n|AWS (managed service)\n\n|SBB-CS-010\n|Mobile App (iOS)\n|SwiftUI, Kotlin Multiplatform\n|iOS 15+\n|Apple App Store\n\n|SBB-CS-011\n|Mobile App (Android)\n|Jetpack Compose, Kotlin Multiplatform\n|Android 8+\n|Google Play Store\n\n|SBB-CS-012\n|Feature Flag Service\n|AWS AppConfig / LaunchDarkly\n|Server-side flags, real-time updates\n|AWS / SaaS\n\n|===\n\n<<<\n== Data Architecture\n\nThis section defines the physical data models, event schemas, and API request/response formats.\n\n=== Domain Event Schemas\n\nAll domain events follow the https://cloudevents.io/[CloudEvents 1.0] specification for consistency and interoperability.\n\n*Event Schema Specifications*: See // TODO: Add to Antora - specifications/events/engagement-events.json[Engagement Service Event Schemas] for complete JSON schemas and examples.\n\n==== Event Catalogue\n\n[width=\"100%\",cols=\"30%,20%,50%\",options=\"header\",]\n|===\n|Event Type |Publisher |Description\n\n|`SupportCaseCreated`\n|EngagementService\n|Published when EngagementService successfully creates a Case in Salesforce after async processing\n\n|`SupportCaseUpdated`\n|EngagementService (via Salesforce webhook)\n|Published when a support agent updates a Case in Salesforce (status, priority, comment changes)\n\n|`SupportCaseResolved`\n|EngagementService (via Salesforce webhook)\n|Published when a support agent resolves/closes a Case in Salesforce\n\n|`CustomerFeedbackSubmitted`\n|EngagementService\n|Published when customer submits feedback via Mobile App (before async Case creation)\n\n|===\n\n*Event Format*: All events use CloudEvents 1.0 envelope with event-specific payload in the `data` field.\n\n*Schema Location*: `specifications/events/engagement-events.json`\n\n=== API Request/Response Schemas\n\n==== ProfileService: GET /profile/contact-id\n\n*Response* (200 OK):\n[source,json]\n----\n{\n  \"contactId\": \"0034X00000ABCDEFG\",\n  \"email\": \"customer@example.com\",\n  \"firstName\": \"John\",\n  \"lastName\": \"Smith\"\n}\n----\n\n==== EngagementService: POST /feedback\n\n*Request*:\n[source,json]\n----\n{\n  \"contactId\": \"0034X00000ABCDEFG\",\n  \"category\": \"App\",\n  \"storeName\": \"OTR Adelaide\",\n  \"timeOfVisit\": \"2026-01-07T12:00:00Z\",\n  \"contactPhoneNumber\": \"+61412345678\",\n  \"message\": \"App crashed when submitting feedback\"\n}\n----\n\n*Response* (202 Accepted):\n[source,json]\n----\n{\n  \"feedbackId\": \"fb-2026-01-07-12345\",\n  \"status\": \"submitted\",\n  \"message\": \"Your feedback has been submitted!\"\n}\n----\n\n=== Salesforce Field Mappings\n\n==== Case Object Mapping\n\n[width=\"100%\",cols=\"25%,25%,25%,25%\",options=\"header\",]\n|===\n|OTR Field |Salesforce Field |Data Type |Notes\n\n|Category\n|Feedback_Category__c\n|Picklist\n|App, Service, Order, Rewards, Refund, Delete Account\n\n|Store Name\n|Store_Name__c\n|String (255)\n|OTR location name\n\n|Time of Visit\n|Time_of_Visit__c\n|DateTime\n|When customer visited store\n\n|Free Text Message\n|Description\n|Long Text (32,000)\n|Customer feedback message\n\n|===\n\n<<<\n=== Baseline Architecture\n\n==== Existing System Components\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Component |Current State |Status\n\n|*D365 Customer Engagement*\n|Customer support platform for OTR digital customers (Mobile App, Web), handles feedback submission and case management\n|**DEPRECATED** - Being replaced by Salesforce Service Cloud\n\n|*App-Specific Customer Database*\n|Stores customer contact data for Mobile App users, separate from Viva Energy systems\n|**MIGRATING** - One-time migration to Salesforce, then deprecated\n\n|*Mobile App*\n|iOS/Android native apps with feedback submission form including Category, Store Name, Time of Visit, Contact Phone Number, and Free Text Message fields\n|**REQUIRES UPDATE** - Integrate with ProfileService and EngagementService APIs (feedback form UI already complete)\n\n|*Salesforce Service Cloud*\n|Shared Viva Energy instance handling customer support for fuel wholesale, Shell Card customers, other retail channels\n|**EXPANDING** - Adding OTR digital customer support Cases and Contacts\n\n|*Existing AWS Infrastructure*\n|SNS+SQS / EventBridge / Kinesis available for event-driven architecture\n|**REUSING** - Event Bus implementation leverages existing infrastructure\n\n|===\n\n==== Integration Architecture\n\n*Current state:*\n\n* Mobile App → D365 Customer Engagement (direct integration)\n* App-specific customer database → standalone (no Salesforce integration)\n* No event-driven architecture (synchronous, tightly coupled)\n* No Anti-Corruption Layer protecting digital channels\n* Viva Energy support teams use Salesforce, OTR digital support uses D365 CE (fragmented)\n\n==== Technical Debt\n\n*No longer relevant* - D365 CE being deprecated, not documenting technical debt of system being retired.\n\n*New technical debt introduced by this migration:*\n\n* Salesforce field mapping TBD (requires coordination with Viva Energy Salesforce admin team)\n* Data isolation strategy TBD (Record Types, custom fields, queues - multi-tenant governance)\n* Salesforce webhook mechanism TBD (Outbound Messages vs Platform Events vs Process Builder)\n* Expected feedback volume unknown (gathering data for rate limit planning)\n\n=== Gap Analysis\n\n==== Missing Capabilities\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Missing Capability |Description\n\n|*ProfileService bounded context*\n|No existing service for Contact reconciliation with Salesforce - requires new microservice implementing JIT upsert by email, returning Salesforce Contact ID\n\n|*EngagementService bounded context*\n|No existing service for customer feedback facade - requires new microservice implementing Anti-Corruption Layer for Salesforce Case creation, Braze integration, async processing via Event Bus\n\n|*Event Bus domain event pattern*\n|No existing domain event publishing infrastructure - requires implementing event-driven architecture pattern using existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis)\n\n|*Async Case creation workflow*\n|Current D365 CE integration is synchronous - requires implementing async processing with retry logic, exponential backoff, dead letter queue\n\n|*Salesforce webhook integration*\n|No existing capability to receive Salesforce notifications - requires implementing webhook receiver in EngagementService for Case update notifications\n\n|*Braze push notification orchestration*\n|No existing integration for Case-related push notifications - requires implementing Braze campaign triggers from EngagementService\n\n|*Contact migration tooling*\n|No existing tooling for app database → Salesforce Contact migration with upsert logic (match by email/phone/VCI)\n\n|*Feedback form enhancements*\n|Mobile App feedback form lacks structured fields (Category, Store Name, Time of Visit, Contact Phone Number) - requires UI updates\n\n|===\n\n==== Missing Bounded Contexts\n\n[width=\"100%\",cols=\"30%,30%,40%\",options=\"header\",]\n|===\n|Bounded Context |Responsibilities |Implementation Status\n\n|*link:../bounded_context/profile.adoc[ProfileService]*\n|JIT Contact reconciliation with Salesforce (upsert by email), return Salesforce Contact ID to digital channels, foundation for future Flybuys partner linking\n|**NEW** - First bounded context implementation\n\n|*link:../bounded_context/engagement.adoc[EngagementService]*\n|Customer feedback submission facade, Anti-Corruption Layer for Salesforce Case creation, Braze integration for push notifications, async Case processing, webhook receiver for Case updates\n|**NEW** - First bounded context implementation\n\n|===\n\n==== Missing Integration Patterns\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Integration Pattern |Description\n\n|*Anti-Corruption Layer (ACL)*\n|EngagementService → Salesforce Service Cloud - protects digital channels from Salesforce API changes, translates between OTR domain language and Salesforce\n\n|*Conformist*\n|ProfileService/EngagementService → Salesforce - conform to existing Salesforce configuration and API contracts (shared Viva Energy instance)\n\n|*Event-Driven Architecture (OHS+PL)*\n|Event Bus publishing domain events (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`) for loose coupling between bounded contexts\n\n|*Just-In-Time (JIT) Integration*\n|ProfileService → Salesforce Contact reconciliation on-demand (no pre-sync)\n\n|*Async Processing*\n|EngagementService Case creation via Event Bus with retry, exponential backoff, dead letter queue\n\n|===\n\n=== Target State Architecture\n\n==== Architectural Building Blocks (ABB)\n\n[width=\"100%\",cols=\"20%,25%,30%,25%\",options=\"header\",]\n|===\n|ABB ID |Bounded Context |Responsibilities |Technology (TBD in Solution Architecture)\n\n|ABB-CS-001\n|*link:../bounded_context/profile.adoc[ProfileService]*\n|JIT Contact reconciliation with Salesforce (upsert by email), return Salesforce Contact ID, foundation for Flybuys partner linking\n|Microservice (.NET/Node.js), REST API, Salesforce REST API client\n\n|ABB-CS-002\n|*link:../bounded_context/engagement.adoc[EngagementService]*\n|Customer feedback submission facade, ACL for Salesforce Case creation, Braze integration, async processing, webhook receiver\n|Microservice (.NET/Node.js), REST API, Event Bus publisher/subscriber, Salesforce webhook receiver\n\n|ABB-CS-003\n|*Event Bus*\n|Domain event publishing infrastructure (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`)\n|AWS SNS+SQS / EventBridge / Kinesis\n\n|ABB-CS-004\n|*Salesforce Service Cloud*\n|System of Record for Contact and Case data (shared Viva Energy instance)\n|Salesforce Service Cloud (external SaaS)\n\n|ABB-CS-005\n|*Braze*\n|Marketing automation platform for push notifications\n|Braze (external SaaS) - existing integration\n\n|ABB-CS-006\n|*Mobile App*\n|iOS/Android native apps with enhanced feedback form (Category, Store Name, Time of Visit, Contact Phone Number, Free Text Message)\n|Kotlin Multiplatform, SwiftUI, Jetpack Compose\n\n|ABB-CS-007\n|*Contact Migration Tool*\n|One-time migration app database → Salesforce with upsert logic (match by email/phone/VCI)\n|Script/tool (.NET/Python/Node.js)\n\n|===\n\n==== Integration Architecture\n\n===== Integration Flows\n\n*Customer Feedback Submission (Async):*\n\n1. *Mobile App* → ProfileService: Authenticate user, get Salesforce Contact ID (JIT reconciliation)\n2. *Mobile App* → EngagementService: Submit feedback (POST /feedback with Contact ID, Category, Store Name, Time of Visit, Phone, Message)\n3. *EngagementService* → Mobile App: Immediate acknowledgment (\"Feedback submitted\")\n4. *EngagementService* → Event Bus: Publish work item for async Case creation\n5. *Background Worker* (EngagementService) → Salesforce: Create Case via REST API\n6. *Success*: EngagementService → Event Bus: Publish `SupportCaseCreated` event\n7. *EngagementService* → Braze: Trigger push notification campaign (\"Your feedback has been received, Case #12345\")\n8. *Failure*: Retry with exponential backoff → Dead Letter Queue → Ops team alert\n\n*Case Update Notification (Bidirectional):*\n\n1. *Support Agent* updates/resolves Case in Salesforce\n2. *Salesforce* → EngagementService: Webhook notification (Case updated)\n3. *EngagementService* → Event Bus: Publish `SupportCaseUpdated` or `SupportCaseResolved` event\n4. *EngagementService* → Braze: Trigger push notification campaign (\"Your case has been resolved\")\n\n*Contact Reconciliation (JIT):*\n\n1. *Mobile App user* authenticates\n2. *Mobile App* → ProfileService: GET /profile/contact-id\n3. *ProfileService* → Salesforce: Query Contact by email\n4. *Match found*: Return existing Salesforce Contact ID\n5. *No match*: Create new Contact in Salesforce, return new Contact ID\n6. *ProfileService* → Mobile App: Return Salesforce Contact ID (cached by Mobile App)\n\n===== System of Record Boundaries\n\n[width=\"100%\",cols=\"30%,35%,35%\",options=\"header\",]\n|===\n|Data Entity |System of Record |Rationale\n\n|*Contact*\n|Salesforce Service Cloud\n|Shared Viva Energy instance, unified customer profile across all channels (digital, wholesale, Shell Card, retail)\n\n|*Case*\n|Salesforce Service Cloud\n|Support agents manage Cases in Salesforce, digital channels submit via EngagementService ACL\n\n|*Feedback Submission (transient)*\n|None (no persistence)\n|EngagementService processes feedback and creates Case in Salesforce, no local storage\n\n|*Domain Events*\n|Event Bus (ephemeral)\n|Events published to Event Bus, consumed by subscribers, not persisted long-term (event sourcing not in scope)\n\n|===\n\n==== Data Architecture Principles\n\n===== Aggregate Persistence\n\n*ProfileService:*\n\n* **No local aggregate persistence** - ProfileService is stateless, queries Salesforce on-demand\n* Salesforce Contact is the aggregate root (owned by Salesforce)\n* ProfileService acts as facade/translator, not system of record\n\n*EngagementService:*\n\n* **No local aggregate persistence** - EngagementService is stateless, creates Cases in Salesforce via ACL\n* Salesforce Case is the aggregate root (owned by Salesforce)\n* EngagementService maintains no local Case state (Conformist pattern - trust Salesforce as source of truth)\n* Async processing state managed via Event Bus (work items in queue, not database)\n\n===== Event Store\n\n* **Event Bus** (SNS+SQS/EventBridge/Kinesis) handles domain event publishing\n* Events are **ephemeral** (consumed and discarded, not persisted for event sourcing)\n* No Event Store implementation in this architecture (future enhancement if needed)\n* Event schema versioning TBD in Solution Architecture\n\n\n=== Architecture Decisions\n\n==== ADR-CS-001: Consolidate onto Salesforce Service Cloud (not build custom solution)\n\n*Status*: Accepted\n\n*Context*:\n\n* D365 Customer Engagement not working well for digital customer support\n* Viva Energy already uses Salesforce Service Cloud for fuel wholesale, Shell Card, other retail channels\n* Post-merger opportunity to consolidate onto single platform\n* Alternative: Build custom support platform or use different SaaS\n\n*Decision*:\n\nConsolidate OTR digital customer support onto Salesforce Service Cloud (shared Viva Energy instance).\n\n*Rationale*:\n\n* **Unified customer view**: Support agents see all interactions across channels (digital, wholesale, Shell Card, retail)\n* **Platform consolidation**: Single support platform reduces operational overhead and costs\n* **Proven solution**: Salesforce Service Cloud is established, feature-rich, well-supported\n* **Post-merger alignment**: Strategic decision to standardize on Viva Energy platforms\n* **Avoid custom development**: Building custom support platform would be costly and high-risk\n\n*Consequences*:\n\n* Unified customer support across Viva Energy Group\n* Reduced operational complexity (single platform vs two)\n* Leverage Salesforce capabilities (case routing, knowledge base, AI, omnichannel)\n* ⚠️ Conformist pattern required (shared instance, conform to existing configuration)\n* ⚠️ Multi-tenant governance needed (data isolation, security, queues)\n* ❌ Less control over platform evolution (SaaS vendor, shared instance)\n\n==== ADR-CS-002: Implement ProfileService and EngagementService as first DDD bounded contexts\n\n*Status*: Accepted\n\n*Context*:\n\n* OTR target architecture uses Domain-Driven Design with bounded contexts\n* This migration is opportunity to establish first implementation\n* Alternative: Direct Mobile App → Salesforce integration (no bounded contexts)\n* Alternative: Single monolithic service for all customer-facing APIs\n\n*Decision*:\n\nImplement ProfileService and EngagementService as separate bounded contexts following DDD strategic patterns.\n\n*Rationale*:\n\n* **Foundation for target architecture**: First implementation of DDD pattern for future bounded contexts (Flybuys, LocationService, PaymentService)\n* **Separation of concerns**: ProfileService handles identity/Contact reconciliation, EngagementService handles support/feedback (different responsibilities, different change rates)\n* **Anti-Corruption Layer**: EngagementService protects digital channels from Salesforce API changes\n* **Reusability**: ProfileService Contact reconciliation reused for Flybuys integration\n* **Event-driven architecture**: Establishes pattern for loose coupling between bounded contexts\n\n*Consequences*:\n\n* Establishes DDD architecture foundation for OTR\n* Reusable ProfileService for Flybuys and future integrations\n* Digital channels protected from Salesforce API changes (ACL)\n* Clear bounded context boundaries and responsibilities\n* ⚠️ Increased initial complexity (two new microservices vs direct integration)\n* ⚠️ Requires Event Bus infrastructure implementation\n* ⚠️ Team must learn DDD patterns and bounded context design\n\n==== ADR-CS-003: Async Case creation via Event Bus (not synchronous)\n\n*Status*: Accepted\n\n*Context*:\n\n* Current D365 CE integration is synchronous (user waits for Case creation)\n* Alternative: Keep synchronous integration (Mobile App → EngagementService → Salesforce synchronously)\n* Salesforce API may experience downtime or latency\n\n*Decision*:\n\nImplement async Case creation via Event Bus with immediate user acknowledgment, retry logic, exponential backoff, and dead letter queue.\n\n*Rationale*:\n\n* **Non-blocking user experience**: User gets immediate \"Feedback submitted\" confirmation, not waiting for Salesforce API\n* **Resilience**: If Salesforce is down, feedback still accepted, Case created when Salesforce recovers\n* **Retry logic**: Automatic retry with exponential backoff handles transient failures\n* **Operational visibility**: Dead letter queue alerts ops team to persistent failures\n* **Scalability**: Queue buffering handles traffic spikes\n\n*Consequences*:\n\n* Better user experience (no waiting for Salesforce API)\n* Resilient to Salesforce downtime (queue buffers work)\n* Automatic retry reduces manual intervention\n* Queue depth monitoring provides operational visibility\n* ⚠️ Eventual consistency (user gets success notification after Case created, not immediately)\n* ⚠️ Increased complexity (Event Bus, background workers, retry logic, DLQ)\n* ⚠️ Requires monitoring and alerting for DLQ\n\n==== ADR-CS-004: ProfileService uses email as primary matching key (not VCI)\n\n*Status*: Accepted\n\n*Context*:\n\n* ProfileService needs to reconcile Mobile App users as Salesforce Contacts\n* Alternative matching keys: VCI (Viva Consumer ID), email, phone, Salesforce External ID\n* Email changes are rare but possible\n\n*Decision*:\n\nUse email address as primary matching key for Contact reconciliation (JIT upsert by email).\n\n*Rationale*:\n\n* **Availability**: Email always available for authenticated users\n* **Uniqueness**: Email is unique identifier in Salesforce and Mobile App\n* **Salesforce standard**: Salesforce Contact uses email as standard lookup field\n* **Simplicity**: Single matching key simplifies upsert logic\n* **Edge case acceptable**: Email changes are rare, manual cleanup acceptable\n\n*Consequences*:\n\n* Simple upsert logic (query by email, create if not found)\n* Leverages Salesforce standard email field\n* Email always available from authentication\n* ⚠️ Email changes create duplicate Contacts (rare edge case, manual cleanup)\n* ⚠️ Future enhancement: Add VCI as Salesforce External ID for stable matching\n\n==== ADR-CS-005: No Case migration from D365 CE (fresh start)\n\n*Status*: Accepted\n\n*Context*:\n\n* D365 CE contains historical customer support Cases\n* Alternative: Migrate historical Cases to Salesforce (preserve support history)\n* Alternative: Archive D365 CE Cases separately (read-only access)\n\n*Decision*:\n\nDo not migrate historical Cases from D365 CE to Salesforce. Start fresh in Salesforce.\n\n*Rationale*:\n\n* **Limited value**: Historical D365 CE Cases not critical for future support\n* **Data quality**: D365 CE Case data may be inconsistent or incomplete\n* **Complexity**: Case migration requires mapping D365 CE schema to Salesforce, data transformation, validation\n* **Cost-benefit**: Migration effort outweighs value of historical data\n* **Archive option**: D365 CE Cases can be archived separately if needed (read-only access for auditing)\n\n*Consequences*:\n\n* Simpler migration (Contacts only, no Case migration)\n* Faster time to value (no Case migration delay)\n* Clean start in Salesforce (no legacy data quality issues)\n* ⚠️ Historical Cases not visible in Salesforce (support agents can't see old Cases)\n* ⚠️ D365 CE must remain accessible temporarily for historical Case lookups (if needed)\n* ❌ Loss of historical Case insights (reporting, analytics on old Cases)\n\n==== ADR-CS-006: Big bang cutover (not phased rollout)\n\n*Status*: Accepted\n\n*Context*:\n\n* Alternative: Phased rollout with feature flags (pilot users first, gradual enablement)\n* Alternative: Parallel run (submit to both D365 CE and Salesforce temporarily)\n* Flybuys integration uses phased rollout (AS-1, AS-2, AS-3 architecture states)\n\n*Decision*:\n\nBig bang cutover - migrate Contacts, deploy ProfileService and EngagementService, switch Mobile App, retire D365 CE.\n\n*Rationale*:\n\n* **Simplicity**: No parallel run complexity, no feature flag management\n* **Faster D365 CE retirement**: No extended transition period maintaining two systems\n* **Limited risk**: Customer support not mission-critical (not payment processing), rollback possible\n* **User base manageable**: OTR digital customers smaller than Flybuys integration scope\n* **Different use case**: Flybuys phased rollout manages points accrual complexity, support feedback is simpler\n\n*Consequences*:\n\n* Simpler deployment (single cutover, no AS-1/AS-2/AS-3 states)\n* Faster D365 CE retirement (no extended parallel run)\n* No feature flag complexity or pilot user management\n* ⚠️ Higher cutover risk (all users switch at once)\n* ⚠️ Requires comprehensive testing before cutover\n* ⚠️ Rollback plan required (revert to D365 CE if critical issues)\n\n==== ADR-CS-007: EngagementService receives Salesforce webhooks for Case updates\n\n*Status*: Accepted\n\n*Context*:\n\n* Support agents update/resolve Cases in Salesforce\n* Need to notify customers of Case status changes via push notifications\n* Alternative: Poll Salesforce API for Case updates (inefficient)\n* Alternative: No customer notifications (agents contact customers directly)\n\n*Decision*:\n\nSalesforce sends webhook notifications to EngagementService when Cases are updated/resolved. EngagementService triggers Braze push notifications.\n\n*Rationale*:\n\n* **Real-time notifications**: Customer notified immediately when agent resolves Case\n* **Efficient**: Webhook push model (not polling)\n* **Event-driven**: Aligns with event-driven architecture pattern\n* **Better customer experience**: Proactive notification vs waiting for agent contact\n\n*Consequences*:\n\n* Real-time customer notifications for Case updates\n* Efficient push model (no polling overhead)\n* Bidirectional integration (Mobile App → Salesforce → Mobile App)\n* ⚠️ Salesforce webhook mechanism TBD (Outbound Messages vs Platform Events vs Process Builder)\n* ⚠️ Webhook authentication and security required\n* ⚠️ EngagementService must handle webhook retries and failures\n\n<<<\n== Interface Specifications\n\nThis section provides references to the complete API specifications and event catalogue for ProfileService and EngagementService.\n\n=== REST API Specifications\n\nComplete OpenAPI 3.0 specifications are maintained in the `specifications/rest/` directory:\n\n==== ProfileService API v1\n\n*Specification*: link:../../specifications/rest/profile-service-v1.yaml[profile-service-v1.yaml]\n\n*Base URL*: `https://api.otr.com.au/profile/v1`\n\n*Authentication*: Bearer token (Microsoft Entra External ID JWT)\n\n*Key Endpoints*:\n\n* `GET /contact-id` - Retrieve or create Salesforce Contact ID for authenticated user (Just-In-Time reconciliation)\n** Used by Mobile App before submitting feedback to EngagementService\n** Upserts Salesforce Contact record using email as external key\n** Returns 18-character Salesforce Contact ID with caching (15-minute TTL)\n** Performance SLA: p95 < 300ms (uncached), p95 < 50ms (cached)\n\n==== EngagementService API v1\n\n*Specification*: link:../../specifications/rest/engagement-service-v1.yaml[engagement-service-v1.yaml]\n\n*Base URL*: `https://api.otr.com.au/engagement/v1`\n\n*Authentication*: Bearer token (Microsoft Entra External ID JWT)\n\n*Key Endpoints*:\n\n* `POST /feedback` - Submit customer feedback for async Case creation in Salesforce\n** Accepts contactId, category, storeName, timeOfVisit, contactPhoneNumber, message\n** Returns 202 Accepted immediately (async Case creation in background)\n** Publishes `CustomerFeedbackSubmitted` event for analytics\n** Creates Salesforce Case via Anti-Corruption Layer with retry logic\n** Performance SLA: p95 < 200ms (feedback accepted, not Case creation)\n\n=== Domain Events (AsyncAPI)\n\nComplete CloudEvents 1.0 JSON Schema specifications are maintained in the `specifications/events/` directory:\n\n*Specification*: link:../../specifications/events/engagement-events.json[engagement-events.json]\n\n==== Event Catalogue\n\n[width=\"100%\",cols=\"30%,20%,50%\",options=\"header\",]\n|===\n|Event Type |Publisher |Consumers\n\n|`CustomerFeedbackSubmitted`\n|EngagementService\n|Future bounded contexts, analytics, sentiment analysis\n\n|`SupportCaseCreated`\n|EngagementService\n|Future bounded contexts, analytics\n\n|`SupportCaseUpdated`\n|EngagementService (via Salesforce webhook)\n|Future bounded contexts, analytics\n\n|`SupportCaseResolved`\n|EngagementService (via Salesforce webhook)\n|Future bounded contexts, analytics\n\n|===\n\n==== Event Delivery Guarantees\n\n* **At-least-once delivery**: Events may be delivered multiple times, consumers must handle idempotency\n* **Ordering**: FIFO queues guarantee ordering for events with same `contactId`\n* **Retention**: 4 days (96 hours) in Event Bus\n* **Dead Letter Queue**: Failed events after 5 retries moved to DLQ for manual intervention\n* **Format**: CloudEvents 1.0 specification with JSON payload\n\n=== API Versioning Policy\n\n==== Version Numbering\n\n* **Format**: `/v{major}` in URL path (e.g., `/profile/v1`, `/engagement/v1`)\n* **Semantic Versioning**: Major version incremented for breaking changes only\n* **Backwards Compatibility**: Minor changes (new optional fields, new endpoints) don't require version bump\n\n==== When to Version\n\n*Breaking changes requiring new major version*:\n\n- Removing or renaming fields in request/response\n- Changing field data types (e.g., string → number)\n- Changing authentication mechanism\n- Removing endpoints\n\n*Non-breaking changes not requiring version bump*:\n\n- Adding new optional fields to request/response\n- Adding new endpoints\n- Expanding enum values (e.g., adding new feedback category)\n- Improving error messages\n\n==== Parallel Version Support\n\n* Support N and N-1 versions concurrently for 6 months\n* Deprecation notice: 3 months before sunsetting old version\n* Mobile App must upgrade to new version within deprecation window\n\n<<<\n== Work Packages\n\nThis section consolidates gaps and activities into implementable work packages aligned with TOGAF Phase E requirements.\n\n=== Work Package Overview\n\n[width=\"100%\",cols=\"15%,35%,25%,25%\",options=\"header\",]\n|===\n|Work Package ID |Name |Transition State |Key Deliverables\n\n|WP-CS-001\n|ProfileService Development\n|TS-1 (Build & Test)\n|ProfileService microservice, Salesforce Contact integration, REST API\n\n|WP-CS-002\n|EngagementService Development\n|TS-1 (Build & Test)\n|EngagementService microservice, Anti-Corruption Layer, Braze integration\n\n|WP-CS-003\n|Event Bus Infrastructure\n|TS-1 (Build & Test)\n|Event Bus configuration, CloudEvents schemas, monitoring\n\n|WP-CS-004\n|Contact Migration Tooling\n|TS-1 (Build & Test)\n|Migration tool, validation scripts, reconciliation reporting\n\n|WP-CS-005\n|Mobile App Integration\n|TS-1 (Build & Test)\n|Mobile App API integration, feedback form enhancements, testing\n\n|WP-CS-006\n|Integration Testing\n|TS-1 (Build & Test)\n|Test environments, integration test suites, UAT execution\n\n|WP-CS-007\n|Salesforce Configuration\n|TS-1 (Build & Test)\n|Salesforce field mapping, data isolation, webhook configuration\n\n|WP-CS-008\n|Contact Data Migration\n|TS-2 (Contact Migration)\n|Contact migration execution, validation, reconciliation\n\n|WP-CS-009\n|Production Deployment\n|TS-3 (Cutover)\n|Production deployment, smoke testing, go-live execution\n\n|WP-CS-010\n|Post-Cutover Support\n|TS-4 (Target State)\n|Monitoring, issue resolution, D365 CE retirement\n\n|===\n\n[[wp-cs-001]]\n=== WP-CS-001: ProfileService Development\n\n==== Description\n\nBuild ProfileService bounded context microservice implementing Just-In-Time Contact reconciliation with Salesforce Service Cloud.\n\n==== Deliverables\n\n* ProfileService microservice application\n** REST API implementation (OpenAPI 3.0 specification)\n** `GET /contact-id` endpoint (Salesforce Contact reconciliation)\n** Authentication/authorization with Microsoft Entra External ID\n** Caching layer (15-minute TTL for Contact IDs)\n* Salesforce integration\n** Salesforce REST API client\n** Contact upsert by email (external key matching)\n** Error handling and retry logic\n* Unit tests (>80% code coverage)\n* Integration tests with Salesforce sandbox\n* API documentation\n* Deployment configuration (IaC - Infrastructure as Code)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* Salesforce sandbox environment provisioned\n* Microsoft Entra External ID OAuth configuration\n* Development environment setup (AWS dev account, CI/CD pipeline)\n\n*Dependent Work Packages*:\n\n* None (can start immediately after prerequisites met)\n\n==== Skills Required\n\n* Backend development (.NET Core or Node.js)\n* REST API design and implementation\n* Salesforce REST API integration\n* OAuth 2.0 / JWT authentication\n* Caching strategies (Redis/ElastiCache)\n* Unit/integration testing frameworks\n* Infrastructure as Code (Terraform/CloudFormation)\n\n==== Acceptance Criteria\n\n* All API endpoints return correct HTTP status codes per OpenAPI specification\n* Contact ID retrieval achieves p95 < 300ms (uncached), p95 < 50ms (cached)\n* Salesforce Contact upsert succeeds with 100% accuracy in sandbox testing\n* Unit test coverage > 80%\n* Integration tests pass in sandbox environment\n* API documentation generated from OpenAPI specification\n\n[[wp-cs-002]]\n=== WP-CS-002: EngagementService Development\n\n==== Description\n\nBuild EngagementService bounded context microservice implementing customer feedback submission, Anti-Corruption Layer for Salesforce Case creation, Braze integration, and webhook receiver for Case updates.\n\n==== Deliverables\n\n* EngagementService microservice application\n** REST API implementation (OpenAPI 3.0 specification)\n** `POST /feedback` endpoint (async feedback submission)\n** Authentication/authorization with Microsoft Entra External ID\n** Webhook receiver endpoint for Salesforce Case updates\n* Anti-Corruption Layer (ACL)\n** OTR domain model to Salesforce API translation\n** Category enum mapping (App/Service/Order/Rewards → Salesforce Case fields)\n** Salesforce REST API client for Case creation\n* Async processing infrastructure\n** Event Bus publisher integration\n** Background worker for Case creation\n** Retry logic with exponential backoff (5 attempts)\n** Dead Letter Queue integration\n* Braze integration\n** Braze campaign trigger API client\n** Push notification orchestration for Case updates\n* Domain event publishing\n** `CustomerFeedbackSubmitted` event publisher\n** `SupportCaseCreated` event publisher\n** `SupportCaseUpdated` event translator (Salesforce webhook → domain event)\n** `SupportCaseResolved` event translator (Salesforce webhook → domain event)\n* Unit tests (>80% code coverage)\n* Integration tests (EngagementService ↔ Salesforce, EngagementService ↔ Braze)\n* API documentation\n* Deployment configuration (IaC)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* <<wp-cs-003,WP-CS-003>> (Event Bus Infrastructure) completed\n* Salesforce sandbox environment provisioned\n* Braze API credentials and campaign templates configured\n* Microsoft Entra External ID OAuth configuration\n\n*Dependent Work Packages*:\n\n* <<wp-cs-003,WP-CS-003>> must be completed first (Event Bus required for async processing)\n* <<wp-cs-007,WP-CS-007>> (Salesforce Configuration) must be in progress (field mapping needed)\n\n==== Skills Required\n\n* Backend development (.NET Core or Node.js)\n* REST API design and implementation\n* Salesforce REST API integration\n* Event-driven architecture patterns\n* Async/background processing (queues, workers)\n* Braze API integration\n* Webhook design and security\n* OAuth 2.0 / JWT authentication\n* Domain-Driven Design (DDD) - Anti-Corruption Layer pattern\n* Unit/integration testing frameworks\n* Infrastructure as Code (Terraform/CloudFormation)\n\n==== Acceptance Criteria\n\n* Feedback submission endpoint returns 202 Accepted within p95 < 200ms\n* Async Case creation succeeds with >99.5% success rate (including retries)\n* Anti-Corruption Layer correctly maps all feedback categories to Salesforce Case fields\n* Webhook receiver processes Salesforce Case updates and publishes domain events\n* Braze push notifications sent successfully for Case updates\n* Failed Case creation moves to Dead Letter Queue after 5 retry attempts\n* Unit test coverage > 80%\n* Integration tests pass with Salesforce sandbox and Braze staging environment\n\n[[wp-cs-003]]\n=== WP-CS-003: Event Bus Infrastructure\n\n==== Description\n\nImplement Event Bus infrastructure for domain event publishing using existing AWS infrastructure (SNS+SQS, EventBridge, or Kinesis).\n\n==== Deliverables\n\n* Event Bus infrastructure configuration\n** Topic/stream provisioning (technology choice: SNS+SQS / EventBridge / Kinesis)\n** FIFO queue configuration (ordering by `contactId`)\n** Dead Letter Queue (DLQ) setup\n** Retention policy (4 days / 96 hours)\n** Access control policies (IAM roles, permissions)\n* CloudEvents 1.0 schema definitions\n** JSON Schema specifications for all domain events\n** Schema validation configuration\n** Schema registry (if using EventBridge/Kinesis)\n* Monitoring and alerting\n** CloudWatch dashboards for queue metrics\n** Alarms for DLQ depth, queue age, processing failures\n** Event Bus throughput monitoring\n* Documentation\n** Event Bus architecture diagram\n** Event publishing guidelines\n** Consumer integration guide\n* Infrastructure as Code (IaC)\n** Terraform/CloudFormation templates for all infrastructure\n\n==== Dependencies\n\n*Prerequisites*:\n\n* AWS account access (existing infrastructure)\n* Technology selection decision (SNS+SQS vs EventBridge vs Kinesis)\n* CloudEvents 1.0 schema design approval\n\n*Dependent Work Packages*:\n\n* None (foundational infrastructure, can start early)\n\n==== Skills Required\n\n* AWS messaging services (SNS, SQS, EventBridge, Kinesis)\n* Event-driven architecture patterns\n* CloudEvents specification\n* JSON Schema design\n* Infrastructure as Code (Terraform/CloudFormation)\n* AWS IAM security configuration\n* CloudWatch monitoring and alerting\n\n==== Acceptance Criteria\n\n* Event Bus infrastructure provisioned in all environments (dev, staging, production)\n* FIFO ordering validated for events with same `contactId`\n* Dead Letter Queue triggers alarms when messages arrive\n* Event retention policy enforced (4 days)\n* CloudEvents 1.0 schema validation enabled\n* Monitoring dashboards operational\n* Infrastructure fully codified (IaC)\n\n[[wp-cs-004]]\n=== WP-CS-004: Contact Migration Tooling\n\n==== Description\n\nDevelop Contact migration tool for one-time migration from app-specific database to Salesforce Service Cloud with upsert logic and validation.\n\n==== Deliverables\n\n* Contact migration tool\n** Extract Contacts from app-specific database\n** Transform to Salesforce Contact API format\n** Upsert to Salesforce using email as external key\n** Fallback matching by phone number or Viva Consumer ID\n** Batch processing with rate limiting (respect Salesforce API limits)\n** Idempotent operation (can be re-run safely)\n* Validation scripts\n** Pre-migration validation (data quality checks)\n** Post-migration validation (100% Contact reconciliation)\n** Email/phone/VCI matching accuracy report\n* Reconciliation reporting\n** Contacts created vs updated statistics\n** Failed upserts with error details\n** Matching accuracy metrics\n* Rollback capability\n** Export snapshot of Salesforce Contacts before migration\n** Rollback procedure documentation\n* Documentation\n** Migration tool user guide\n** Troubleshooting guide\n** Runbook for migration execution\n\n==== Dependencies\n\n*Prerequisites*:\n\n* <<wp-cs-001,WP-CS-001>> (ProfileService Development) completed (reuses Salesforce integration code)\n* Salesforce sandbox environment for migration testing\n* App-specific database access (read-only sufficient)\n* Salesforce production access granted\n\n*Dependent Work Packages*:\n\n* <<wp-cs-001,WP-CS-001>> provides Salesforce Contact upsert logic to reuse\n\n==== Skills Required\n\n* Database development (SQL, data extraction)\n* Salesforce REST API integration\n* Batch processing and ETL patterns\n* Data validation and reconciliation\n* Error handling and logging\n* Scripting (Python, PowerShell, or similar)\n\n==== Acceptance Criteria\n\n* Migration tool successfully migrates 100% of Contacts in sandbox with zero data loss\n* Email/phone/VCI matching accuracy > 95% in sandbox testing\n* Failed upserts captured with actionable error messages\n* Reconciliation report matches actual Salesforce Contact counts\n* Migration tool execution time acceptable for production (freezes app database for minimum time)\n* Rollback procedure validated in sandbox\n* Documentation complete and approved\n\n[[wp-cs-005]]\n=== WP-CS-005: Mobile App Integration\n\n==== Description\n\nUpdate Mobile App to integrate with ProfileService and EngagementService APIs, replacing D365 CE integration.\n\n==== Deliverables\n\n* Feedback form UI enhancements\n** Add Category dropdown (App, Service, Order, Rewards, Refund, Delete Account)\n** Add Store Name field (optional)\n** Add Time of Visit field (optional, datetime picker)\n** Add Contact Phone Number field (optional, E.164 validation)\n** Update Message field (1-2000 character limit with counter)\n* API integration (Kotlin Multiplatform shared code)\n** ProfileService client (`GET /contact-id`)\n** EngagementService client (`POST /feedback`)\n** JWT token management (Microsoft Entra External ID)\n** Error handling (network failures, API errors, validation errors)\n** Retry logic for transient failures\n* Platform-specific UI (SwiftUI for iOS, Jetpack Compose for Android)\n** Feedback form screens\n** Success/error confirmation screens\n** Loading states and progress indicators\n* Feature flag integration\n** `enable_salesforce_feedback_submission` flag\n** Fallback to D365 CE if flag disabled (during rollout)\n* Unit tests for shared business logic\n* UI tests for platform-specific screens\n* API integration tests (mocked APIs)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* <<wp-cs-001,WP-CS-001>> (ProfileService Development) completed and deployed to dev/staging\n* <<wp-cs-002,WP-CS-002>> (EngagementService Development) completed and deployed to dev/staging\n* ProfileService and EngagementService OpenAPI specifications finalized\n* Feature flag service configured\n\n*Dependent Work Packages*:\n\n* Must complete after <<wp-cs-001,WP-CS-001>> and <<wp-cs-002,WP-CS-002>> (requires API endpoints available for integration testing)\n\n==== Skills Required\n\n* Kotlin Multiplatform development\n* SwiftUI (iOS native UI)\n* Jetpack Compose (Android native UI)\n* REST API client development\n* OAuth 2.0 / JWT authentication\n* Form validation and UX design\n* Unit testing (Kotlin, Swift)\n* UI testing frameworks (XCTest, Espresso)\n\n==== Acceptance Criteria\n\n* Feedback form UI matches UX design specifications\n* All form fields validate correctly (client-side validation)\n* API integration successfully calls ProfileService and EngagementService in dev/staging\n* Error handling provides user-friendly error messages\n* Feature flag correctly toggles between Salesforce and D365 CE integration\n* Unit test coverage > 80% for shared business logic\n* UI tests pass for all feedback form workflows (happy path, error states)\n* App builds and deploys successfully to TestFlight (iOS) and Google Play Internal Testing (Android)\n\n[[wp-cs-006]]\n=== WP-CS-006: Integration Testing\n\n==== Description\n\nExecute comprehensive integration testing across all system components in non-production environments.\n\n==== Deliverables\n\n* Test environment setup\n** Salesforce sandbox configured with test data\n** ProfileService deployed to staging\n** EngagementService deployed to staging\n** Event Bus staging infrastructure\n** Braze staging environment configured\n** Mobile App TestFlight/Internal Testing builds\n* Integration test suites\n** ProfileService ↔ Salesforce (Contact upsert scenarios)\n** EngagementService ↔ Salesforce (Case creation scenarios)\n** EngagementService ↔ Braze (push notification scenarios)\n** Mobile App ↔ ProfileService ↔ EngagementService (end-to-end workflows)\n** Event Bus publishing and consumption\n** Webhook receiver (Salesforce → EngagementService)\n* Test scenarios\n** Happy path: Successful feedback submission and Case creation\n** Error scenarios: Salesforce API failures, Braze API failures, network timeouts\n** Retry scenarios: Async Case creation retries, DLQ validation\n** Performance testing: p95 latency validation for ProfileService and EngagementService\n** Load testing: Simulate 3x-10x expected volume\n* UAT execution\n** Business stakeholder UAT sessions\n** UAT test cases covering all feedback categories\n** UAT sign-off documentation\n* Test results documentation\n** Test execution reports\n** Defect tracking and resolution\n** Performance test results\n\n==== Dependencies\n\n*Prerequisites*:\n\n* <<wp-cs-001,WP-CS-001>> (ProfileService Development) completed\n* <<wp-cs-002,WP-CS-002>> (EngagementService Development) completed\n* <<wp-cs-003,WP-CS-003>> (Event Bus Infrastructure) completed\n* <<wp-cs-005,WP-CS-005>> (Mobile App Integration) completed\n* <<wp-cs-007,WP-CS-007>> (Salesforce Configuration) sandbox configuration completed\n\n*Dependent Work Packages*:\n\n* Must complete after <<wp-cs-001,WP-CS-001>>, <<wp-cs-002,WP-CS-002>>, <<wp-cs-003,WP-CS-003>>, <<wp-cs-005,WP-CS-005>> (requires all components available)\n\n==== Skills Required\n\n* Integration testing strategy and execution\n* Test automation frameworks (Postman, Newman, Selenium)\n* Performance testing tools (JMeter, k6, Gatling)\n* Salesforce sandbox administration\n* Test data management\n* Defect tracking and triage\n* UAT facilitation\n\n==== Acceptance Criteria\n\n* All integration test scenarios pass (happy path, error scenarios, retry scenarios)\n* Performance SLAs validated (ProfileService p95 < 300ms, EngagementService p95 < 200ms)\n* Load testing confirms system handles 3x expected volume without degradation\n* UAT sign-off obtained from business stakeholders\n* Zero critical defects (P1/P2) open before moving to Contact Migration\n* Test results documented and approved\n\n[[wp-cs-007]]\n=== WP-CS-007: Salesforce Configuration\n\n==== Description\n\nConfigure Salesforce Service Cloud for OTR digital customer support integration, including field mapping, data isolation, and webhook setup.\n\n==== Deliverables\n\n* Salesforce Contact configuration\n** Custom fields for OTR-specific data (if needed)\n** Email as external key configuration\n** Record Type for OTR digital customers (data isolation)\n** Validation rules\n* Salesforce Case configuration\n** Custom fields for feedback categories (App, Service, Order, Rewards, Refund, Delete Account)\n** Case Type and Reason picklist mapping\n** Queue assignment rules (OTR digital support queue)\n** Case escalation rules\n** Case routing rules\n* Salesforce webhook configuration\n** Platform Events / Outbound Messages for Case updates\n** Webhook authentication (API key, JWT, or OAuth)\n** Case status change triggers (New → In Progress, Resolved, Closed)\n** Webhook payload format (JSON)\n* Data isolation strategy\n** Record Types for OTR vs other Viva Energy business units\n** Queues for OTR-specific Cases\n** Reporting and dashboards scoped to OTR data\n* Salesforce API access\n** Connected App configuration\n** OAuth 2.0 JWT bearer flow setup\n** API user credentials\n** API rate limit monitoring\n* Documentation\n** Salesforce field mapping specification\n** Webhook configuration guide\n** Data isolation architecture diagram\n** API authentication setup guide\n\n==== Dependencies\n\n*Prerequisites*:\n\n* Viva Energy Salesforce admin team engagement\n* Salesforce governance approval (multi-tenant environment)\n* Technical decision on webhook mechanism (Platform Events vs Outbound Messages)\n* Technical decision on authentication method (OAuth 2.0 JWT bearer flow recommended)\n\n*Dependent Work Packages*:\n\n* None (can start in parallel with development work packages)\n* Required for <<wp-cs-002,WP-CS-002>> (EngagementService needs field mapping)\n* Required for <<wp-cs-006,WP-CS-006>> (Integration Testing needs sandbox configuration)\n\n==== Skills Required\n\n* Salesforce administration\n* Salesforce configuration (Record Types, Queues, Validation Rules)\n* Salesforce API integration (REST API, Platform Events, Outbound Messages)\n* Salesforce security and authentication (OAuth, Connected Apps)\n* Multi-tenant data isolation patterns\n\n==== Acceptance Criteria\n\n* Salesforce sandbox configured with all custom fields, Record Types, Queues\n* Field mapping documented and approved by OTR business stakeholders\n* Webhook configuration tested and delivering Case update notifications\n* Data isolation validated (OTR data separate from other Viva Energy business units)\n* API authentication working for ProfileService and EngagementService\n* Salesforce API rate limits monitored and acceptable for expected volume\n* Configuration replicated to Salesforce production environment\n\n[[wp-cs-008]]\n=== WP-CS-008: Contact Data Migration\n\n==== Description\n\nExecute one-time Contact migration from app-specific database to Salesforce Service Cloud production.\n\n==== Deliverables\n\n* Pre-migration activities\n** Final validation of migration tool in sandbox\n** Communication plan (notify users of maintenance window if needed)\n** Freeze app-specific database Contact updates\n** Backup app-specific database\n** Export snapshot of Salesforce Contacts (rollback preparation)\n* Migration execution\n** Execute migration tool against Salesforce production\n** Monitor migration progress\n** Handle failed upserts (manual intervention if needed)\n* Post-migration validation\n** 100% Contact reconciliation (app database vs Salesforce)\n** Email/phone/VCI matching accuracy report\n** Reconciliation report (Contacts created vs updated)\n** Data integrity checks (no duplicate Contacts, no missing Contacts)\n* ProfileService smoke testing\n** Verify Contact ID retrieval works in production\n** Test cache behavior\n** Validate Salesforce Contact upserts from ProfileService\n* Migration report\n** Total Contacts migrated\n** Contacts created vs updated\n** Failed upserts (if any) with resolution\n** Matching accuracy metrics\n** Migration execution time\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-004 (Contact Migration Tooling) completed\n* WP-CS-001 (ProfileService Development) deployed to production (not yet integrated with Mobile App)\n* WP-CS-007 (Salesforce Configuration) production configuration completed\n* Salesforce production access granted\n* Migration approved by business stakeholders\n\n*Dependent Work Packages*:\n\n* Must complete after WP-CS-001, WP-CS-004, WP-CS-007\n* Must complete before WP-CS-009 (Production Deployment)\n\n==== Skills Required\n\n* Data migration execution\n* Salesforce administration\n* Database operations\n* Data validation and reconciliation\n* Incident management (if issues arise)\n\n==== Acceptance Criteria\n\n* 100% of Contacts migrated with zero data loss\n* Email/phone/VCI matching accuracy > 95%\n* ProfileService smoke tests pass in production\n* Reconciliation report approved by business stakeholders\n* App-specific database Contact updates frozen (read-only mode)\n* Rollback procedure ready (but not executed if migration successful)\n\n[[wp-cs-009]]\n=== WP-CS-009: Production Deployment\n\n==== Description\n\nDeploy all solution components to production and execute cutover from D365 CE to Salesforce Service Cloud.\n\n==== Deliverables\n\n* Production deployment\n** EngagementService deployed to production\n** Event Bus production infrastructure validated\n** Salesforce webhook configured in production\n** Mobile App released to production (App Store, Google Play)\n* Go-live activities\n** Smoke testing (end-to-end feedback submission)\n** Feature flag enabled: `enable_salesforce_feedback_submission = ON`\n** D365 CE integration disabled in Mobile App\n** Monitor Event Bus queue depth, DLQ, Salesforce API rate limits\n** Monitor Mobile App feedback submission success rate\n* Go/No-Go decision\n** Validate success criteria before final cutover\n** Business stakeholder approval\n** Technical validation (smoke tests pass, monitoring healthy)\n* Cutover communication\n** Notify support agents of new Salesforce integration\n** Provide training materials for support agents\n** Customer communication (if visible change)\n* Rollback plan\n** Documented rollback procedure\n** Feature flag can disable Salesforce integration and re-enable D365 CE\n** Rollback decision criteria (P1/P2 incidents, feedback submission success rate < 99%)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-001 (ProfileService Development) completed\n* WP-CS-002 (EngagementService Development) completed\n* WP-CS-003 (Event Bus Infrastructure) completed\n* WP-CS-005 (Mobile App Integration) completed\n* WP-CS-006 (Integration Testing) completed with UAT sign-off\n* WP-CS-007 (Salesforce Configuration) production configuration completed\n* WP-CS-008 (Contact Data Migration) completed successfully\n* Mobile App release approval (App Store, Google Play)\n\n*Dependent Work Packages*:\n\n* Must complete after all prior work packages (final cutover)\n\n==== Skills Required\n\n* Production deployment and release management\n* Incident management and troubleshooting\n* Monitoring and observability\n* Change management and communication\n* Rollback execution (if needed)\n\n==== Acceptance Criteria\n\n* Mobile App feedback submission success rate > 99.5%\n* End-to-end flow validated (Mobile App → ProfileService → EngagementService → Salesforce Case created)\n* Braze push notifications delivered successfully\n* Event Bus queue depth normal, DLQ empty\n* No critical incidents (P1/P2) in first 24 hours\n* D365 CE integration disabled\n* Support agents successfully using Salesforce for OTR digital customer Cases\n\n[[wp-cs-010]]\n=== WP-CS-010: Post-Cutover Support\n\n==== Description\n\nMonitor production stability, resolve issues, validate success criteria, and execute D365 CE retirement.\n\n==== Deliverables\n\n* Monitoring and support\n** 24/7 on-call support for first week post-cutover\n** Daily monitoring reports (feedback submission success rate, Case creation success rate)\n** Incident response and resolution\n** Performance tuning (if needed)\n* Success criteria validation\n** Validate feedback submission success rate > 99.5%\n** Monitor customer satisfaction score (target: +15% improvement within 6 months)\n** Monitor average case resolution time (target: -20% improvement within 6 months)\n** Support agent feedback survey\n* D365 CE retirement\n** D365 CE set to read-only mode (historical Case lookups only)\n** Archive D365 CE data for compliance/auditing\n** Decommission D365 CE infrastructure (after 90-day stabilization period)\n** Remove D365 CE integration code from Mobile App\n* Documentation updates\n** Production runbook\n** Troubleshooting guide (based on incidents resolved)\n** Operational procedures for support team\n** Lessons learned document\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-009 (Production Deployment) completed\n* Cutover successful with no critical incidents\n\n*Dependent Work Packages*:\n\n* Final work package in sequence\n\n==== Skills Required\n\n* Production support and incident management\n* Performance monitoring and tuning\n* Data archival and compliance\n* Infrastructure decommissioning\n* Documentation\n\n==== Acceptance Criteria\n\n* Zero critical incidents (P1/P2) in first 30 days post-cutover\n* Feedback submission success rate sustained > 99.5%\n* Customer satisfaction improvement validated (baseline established, ongoing measurement)\n* Support agents reporting positive experience with Salesforce unified view\n* D365 CE successfully decommissioned\n* All production documentation complete and approved\n* Lessons learned document published\n\n=== Work Package Sequencing\n\n==== Parallel Track 1: Infrastructure & Configuration\n\nCan start immediately and run in parallel:\n\n* WP-CS-003 (Event Bus Infrastructure)\n* WP-CS-007 (Salesforce Configuration)\n\n==== Parallel Track 2: Development\n\nCan start after Track 1 infrastructure decisions made:\n\n* WP-CS-001 (ProfileService Development) - Independent\n* WP-CS-002 (EngagementService Development) - Requires WP-CS-003 completed\n* WP-CS-004 (Contact Migration Tooling) - Requires WP-CS-001 completed (reuses code)\n\n==== Sequential Track 3: Integration & Testing\n\nMust complete after development:\n\n* WP-CS-005 (Mobile App Integration) - Requires WP-CS-001, WP-CS-002\n* WP-CS-006 (Integration Testing) - Requires WP-CS-001, WP-CS-002, WP-CS-003, WP-CS-005, WP-CS-007\n\n==== Sequential Track 4: Migration & Cutover\n\nMust complete sequentially:\n\n* WP-CS-008 (Contact Data Migration) - Requires WP-CS-001, WP-CS-004, WP-CS-006 UAT sign-off\n* WP-CS-009 (Production Deployment) - Requires all prior work packages completed\n* WP-CS-010 (Post-Cutover Support) - Requires WP-CS-009\n\n==== Critical Path\n\nThe critical path for this project is:\n\n. WP-CS-003 (Event Bus Infrastructure)\n. WP-CS-002 (EngagementService Development) - blocks on WP-CS-003\n. WP-CS-005 (Mobile App Integration) - blocks on WP-CS-001, WP-CS-002\n. WP-CS-006 (Integration Testing) - blocks on WP-CS-001 through WP-CS-005, WP-CS-007\n. WP-CS-008 (Contact Data Migration) - blocks on WP-CS-006 UAT sign-off\n. WP-CS-009 (Production Deployment) - blocks on WP-CS-008\n. WP-CS-010 (Post-Cutover Support) - final deliverable\n\nAny delays in critical path work packages will delay the overall cutover date.\n\n<<<\n== Transition Architecture\n\nThis section defines the evolution from baseline (D365 CE) to target state (Salesforce Service Cloud + ProfileService + EngagementService).\n\n=== Transition Approach\n\n*Big Bang Cutover*: Per ADR-CS-006, this transition uses a single cutover approach rather than phased rollout. All users switch from D365 CE to Salesforce simultaneously after Contact migration completion.\n\n=== Transition States\n\n==== TS-0: Baseline State (Current)\n\n===== Characteristics\n\n* D365 Customer Engagement handles all digital customer feedback\n* App-specific database stores customer Contact data\n* No ProfileService or EngagementService\n* No event-driven architecture\n* Synchronous feedback submission\n\n===== Components Active\n\n- D365 Customer Engagement\n- App-specific customer database\n- Mobile App (current version with D365 CE integration)\n\n==== TS-1: Build & Test\n\n===== Activities\n\n* Build ProfileService microservice (JIT Contact reconciliation API)\n* Build EngagementService microservice (feedback submission API, ACL for Salesforce Case creation, Braze integration, webhook receiver)\n* Implement Event Bus infrastructure (SNS+SQS/EventBridge/Kinesis)\n* Develop Contact migration tool (app database → Salesforce upsert by email/phone/VCI)\n* Update Mobile App API integration (ProfileService + EngagementService endpoints - feedback form UI already complete)\n* Integration testing (ProfileService ↔ Salesforce, EngagementService ↔ Salesforce, EngagementService ↔ Braze)\n* UAT with test Salesforce sandbox environment\n\n===== Components Active\n\n- D365 Customer Engagement (still active, unchanged)\n- App-specific customer database (still active)\n- ProfileService (non-production, testing only)\n- EngagementService (non-production, testing only)\n- Event Bus (non-production)\n- Salesforce Sandbox (testing)\n\n===== Exit Criteria\n\n- All integration tests pass\n- UAT sign-off from business stakeholders\n- Contact migration tool validated in sandbox\n- Mobile App updates tested with non-production APIs\n\n==== TS-2: Contact Migration\n\n===== Activities\n* Execute Contact migration (app database → Salesforce production)\n* Validation: 100% data integrity check (email/phone/VCI matching)\n* Reconciliation report: New Contacts created vs existing Contacts updated\n* Freeze app database Contact updates during migration window\n* ProfileService smoke testing (verify Contact lookups work in Salesforce production)\n\n===== Components Active\n- D365 Customer Engagement (still active, users unaffected)\n- Salesforce Production (Contacts migrated, no Cases yet)\n- ProfileService (production deployed, not integrated with Mobile App yet)\n- App-specific customer database (frozen, read-only)\n\n===== Exit Criteria\n- 100% of Contacts migrated with zero data loss\n- Email/phone/VCI matching accuracy > 95%\n- ProfileService smoke tests pass (JIT lookups return correct Contact IDs)\n- Reconciliation report approved\n\n==== TS-3: Cutover (Go-Live)\n\n===== Go-Live Activities\n\n* Deploy EngagementService to production\n* Deploy Mobile App updates (ProfileService + EngagementService API integration)\n* Configure Salesforce webhook (Case update notifications → EngagementService)\n* Smoke testing: End-to-end feedback submission (Mobile App → EngagementService → Salesforce → Braze notification)\n* Monitor Event Bus queue depth, dead letter queue, Salesforce API rate limits\n* **Go/No-Go decision**: Validate success criteria before final cutover\n* Enable feature flag: `enable_salesforce_feedback_submission = ON`\n* Disable D365 CE integration in Mobile App\n\n===== Components Active\n\n- ProfileService (production, integrated with Mobile App)\n- EngagementService (production, integrated with Mobile App)\n- Event Bus (production, processing async Case creation)\n- Salesforce Production (receiving Cases from digital customers)\n- Braze (sending push notifications)\n- Mobile App (new version with Salesforce integration)\n- D365 Customer Engagement (disabled, read-only for historical lookups)\n\n===== Exit Criteria\n\n- Mobile App feedback submission success rate > 99.5%\n- End-to-end flow validated (Mobile App → Salesforce Case created)\n- Braze push notifications delivered successfully\n- Event Bus queue depth normal, DLQ empty\n- No critical incidents (P1/P2) in first 24 hours\n\n==== TS-4: Target State (Stable Production)\n\n===== Characteristics\n\n* ProfileService and EngagementService fully operational\n* All digital customer feedback routed to Salesforce\n* Event-driven architecture established\n* D365 CE decommissioned\n* First DDD bounded contexts implemented successfully\n\n===== Monitoring Period\n\n* Validate success criteria: feedback submission rate > 99.5%, no data loss\n* Monitor customer satisfaction score (target: +15% improvement)\n* Monitor average case resolution time (target: -20% improvement)\n* Support agents using unified Salesforce view across all channels\n\n===== D365 CE Retirement\n\n* D365 CE read-only access for historical Case lookups (if needed)\n* Decommission D365 CE infrastructure after 90 days\n* Archive D365 CE data for compliance/auditing\n\n===== Components Active\n\n- ProfileService (production)\n- EngagementService (production)\n- Event Bus (production)\n- Salesforce Production (system of record)\n- Braze (push notifications)\n- Mobile App (Salesforce integration)\n- App-specific database (deprecated, Contact data no longer updated)\n\n===== Success Criteria Achieved\n\n- All digital customer feedback routed to Salesforce\n- Support agents have unified customer view\n- D365 CE decommissioned\n- Customer satisfaction improved by 15%\n- Average case resolution time decreased by 20%\n- Zero data loss during transition\n\n=== Transition Dependencies\n\n[width=\"100%\",cols=\"40%,60%\",options=\"header\",]\n|===\n|Dependency |Owner/Status\n\n|*Salesforce production access*\n|Viva Energy Salesforce admin team - TBD\n\n|*Salesforce Case field mapping*\n|Viva Energy Salesforce admin team - TBD (map OTR feedback categories to Salesforce fields)\n\n|*Salesforce data isolation strategy*\n|Viva Energy Salesforce admin team - TBD (Record Types, queues, custom fields)\n\n|*Salesforce webhook configuration*\n|Viva Energy Salesforce admin team - TBD (Outbound Messages vs Platform Events)\n\n|*Event Bus infrastructure*\n|OTR Platform team - Existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis)\n\n|*Braze integration*\n|OTR Marketing team - Existing Braze account, EngagementService creates new campaigns\n\n|*Mobile App release window*\n|OTR Mobile team - Coordinate cutover timing with app release schedule\n\n|*App database access*\n|OTR Platform team - Read access for Contact migration\n\n|===\n\n=== Transition Validation Criteria\n\n==== Contact Migration Validation\n\n* 100% of app database Contacts migrated to Salesforce (zero data loss)\n* Email/phone/VCI matching accuracy > 95% (minimize duplicate Contacts)\n* ProfileService JIT lookups return correct Salesforce Contact IDs (smoke test sample)\n* Reconciliation report shows: X new Contacts created, Y existing Contacts updated\n\n==== Cutover Validation\n\n* Mobile App feedback submission success rate > 99.5% (including async Case creation)\n* End-to-end flow validated: Mobile App → ProfileService → EngagementService → Salesforce Case created\n* Braze push notifications delivered for Case creation and Case resolution\n* Event Bus queue depth within normal range (no backlog)\n* Dead letter queue empty (no failed Case creations)\n* Salesforce API rate limits not exceeded\n\n==== Production Monitoring (30 days)\n\n* Customer satisfaction score improves by 15% (compared to D365 CE baseline)\n* Average case resolution time decreases by 20% (Salesforce vs D365 CE)\n* Support agents confirm unified customer view across all channels\n* Zero critical incidents (P1 outages, data loss)\n\n=== Rollback Plan\n\n==== Rollback Triggers\n\n* Feedback submission success rate < 95% (below acceptable threshold)\n* Data loss or corruption detected in Salesforce\n* Salesforce API rate limits exceeded (Cases not created within SLA)\n* Critical bug blocking customer feedback submission\n\n==== Rollback Procedure\n\n1. **Revert Mobile App** to previous version (remove ProfileService/EngagementService integration, restore D365 CE integration)\n2. **Stop EngagementService** Case creation (prevent duplicate Cases in Salesforce)\n3. **Re-enable D365 CE** for customer feedback submission\n4. **Investigate root cause** (EngagementService logs, Salesforce API errors, Event Bus queue issues)\n5. **Fix and re-test** in sandbox environment\n6. **Retry cutover** when issues resolved\n\n==== Rollback Limitations\n\n* Cases created in Salesforce during cutover period remain in Salesforce (no reverse migration)\n* Contacts migrated to Salesforce remain (no rollback to app database)\n* Rollback only affects Mobile App integration (not data migration)\n\n=== Architectural Scope Boundaries\n\n==== Capabilities Included\n\n===== Business Capabilities\n\n* **Customer Feedback Submission**: Mobile App users can submit structured feedback (Category, Store Name, Time of Visit, Phone, Free Text Message) via EngagementService\n* **Customer Contact Management**: Just-In-Time (JIT) Contact reconciliation with Salesforce via ProfileService, ensuring every Mobile App user has a Salesforce Contact record\n* **Case Management Integration**: EngagementService creates Salesforce Cases asynchronously for customer feedback, support agents manage Cases in Salesforce Service Cloud\n* **Customer Notifications**: Push notifications via Braze when Cases are created, updated, or resolved (bidirectional integration: Mobile App → Salesforce → Mobile App)\n* **Unified Customer View**: Support agents see OTR digital customer feedback alongside other Viva Energy channels (fuel wholesale, Shell Card, retail) in single Salesforce instance\n* **Contact Data Migration**: One-time migration of app-specific customer database Contacts to Salesforce with upsert logic (email/phone/VCI matching)\n\n===== Technical Capabilities\n\n* **ProfileService Bounded Context**: First DDD bounded context implementation - JIT Contact reconciliation, Salesforce API facade, foundation for Flybuys integration\n* **EngagementService Bounded Context**: First DDD bounded context implementation - Customer feedback submission BFF, Anti-Corruption Layer for Salesforce, Braze integration orchestration\n* **Event-Driven Architecture**: Domain event publishing via Event Bus (SNS+SQS/EventBridge/Kinesis) for `SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted` events\n* **Async Processing Pattern**: Non-blocking Case creation with retry logic, exponential backoff, dead letter queue for operational resilience\n* **Anti-Corruption Layer Pattern**: EngagementService protects digital channels from Salesforce API changes, translates between OTR domain language and Salesforce\n* **Conformist Pattern**: ProfileService and EngagementService conform to existing Salesforce configuration (shared Viva Energy instance, multi-tenant governance)\n* **Salesforce Integration**: REST API integration for Contact CRUD and Case creation, webhook receiver for Case update notifications\n* **Braze Integration**: Push notification campaign triggers for Case lifecycle events (created, updated, resolved)\n* **Observability & Monitoring**: Dashboards, metrics, alerting for feedback submission rate, queue depth, API errors, Case creation latency\n* **Feature Flag Management**: Kill switches for emergency rollback (enable_salesforce_feedback_submission, enable_async_case_creation, etc.)\n\n==== Capabilities Excluded\n\n===== Business Capabilities Explicitly Out of Scope\n\n* **Historical Case Migration**: D365 CE Cases not migrated to Salesforce (ADR-CS-005 - fresh start, no Case migration)\n* **Multi-Channel Feedback Submission**: Web app, POS, call centre, email feedback channels not included (Mobile App only in this phase)\n* **Case Resolution by Digital Channels**: Support agents resolve Cases in Salesforce, not via Mobile App self-service\n* **Knowledge Base Integration**: Salesforce Knowledge Base articles not surfaced in Mobile App (future enhancement)\n* **Live Chat/Messaging**: Real-time chat support not included (Salesforce omnichannel capabilities not activated)\n* **Sentiment Analysis**: Automated feedback sentiment analysis not included (future enhancement with AI/ML)\n* **Customer Satisfaction Surveys**: Post-resolution CSAT surveys not included (separate initiative)\n* **Case Attachments**: Mobile App feedback submission does not support file uploads (photos, receipts) - text only\n* **Agent Desktop Integration**: Custom Salesforce UI for support agents not included (use standard Salesforce Service Console)\n* **Social Media Feedback**: Facebook, Twitter, Instagram feedback channels not integrated\n\n===== Technical Capabilities Explicitly Out of Scope\n\n* **Event Sourcing**: Domain events are ephemeral (not persisted for event sourcing/replay) - Event Bus only, no Event Store\n* **CQRS (Command Query Responsibility Segregation)**: ProfileService and EngagementService use same data model for reads/writes (no separate read models)\n* **Local Aggregate Persistence**: ProfileService and EngagementService are stateless (Salesforce is System of Record, no local database for Contact/Case)\n* **Saga Orchestration**: No distributed transactions or saga patterns required (single-step Case creation, not multi-step workflow)\n* **API Gateway Advanced Features**: Rate limiting, API versioning, API key management deferred to detailed design (basic routing only)\n* **GraphQL API**: ProfileService and EngagementService expose REST APIs only (GraphQL not required)\n* **Real-Time Sync**: Salesforce Contact updates by support agents not synced back to ProfileService (eventual consistency acceptable via JIT reconciliation)\n* **Multi-Region Deployment**: Single AWS region deployment (no multi-region failover/disaster recovery in this phase)\n* **Blue-Green Deployment**: Big bang cutover (ADR-CS-006), not blue-green or canary deployment strategy\n* **A/B Testing Framework**: Feature flags for rollback only, not for A/B testing or experimentation\n* **Custom Authentication**: Microsoft Entra External ID used for Mobile App authentication (no custom authentication logic in ProfileService/EngagementService)\n* **Data Residency Compliance**: Salesforce data residency governed by Viva Energy Salesforce configuration (no OTR-specific data residency requirements)\n\n===== Future Bounded Contexts Not in Scope\n\n* **LoyaltyService**: Flybuys integration, reward preferences, transaction adjudication (separate initiative)\n* **LocationService**: Store finder, proximity features, geofencing (separate initiative)\n* **PaymentService**: Payment processing, subscription billing (separate initiative)\n* **RecommendationService**: Personalized recommendations, next-best offers (separate initiative)\n\n===== Integration Patterns Not in Scope\n\n* **Shared Kernel**: No shared domain model between ProfileService and EngagementService (separate bounded contexts with clear boundaries)\n* **Partnership**: No joint development or coordination with external teams (Conformist pattern - we conform to Salesforce)\n* **Customer-Supplier (we're upstream)**: No downstream systems depend on ProfileService/EngagementService APIs yet (future bounded contexts will consume domain events)\n\n==== Architectural Dependencies on Future Initiatives\n\n*This Architecture Enables Future Initiatives*:\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Future Initiative |Architectural Enablement\n\n|*Flybuys Integration*\n|**ProfileService Contact Reconciliation Reused**: ProfileService establishes pattern for JIT Contact reconciliation with Salesforce, which will be extended for Flybuys partner linking (link:../architecture_definitions/flybuys_integration.adoc[see Flybuys Integration architecture]) +\n**Event Bus Infrastructure**: Domain event publishing pattern (`CustomerEnrolledInLoyalty`, `PartnerLinked`, etc.) reuses Event Bus established for EngagementService\n\n|*LoyaltyService Bounded Context*\n|**Event Bus Subscription**: LoyaltyService will consume `CustomerProfileCreated` events published by ProfileService (future enhancement) +\n**Salesforce Contact Integration**: LoyaltyService may query Salesforce Contacts for customer reward preferences (via ProfileService facade or direct Salesforce API)\n\n|*Web App Feedback Submission*\n|**EngagementService API Reuse**: Web app will call same EngagementService REST API for feedback submission (multi-channel support) +\n**Conformist Pattern**: Web app conforms to EngagementService API contract (no translation required)\n\n|*Multi-Channel Customer Support*\n|**EngagementService Extension**: Add support for email, call centre, POS feedback channels (extend EngagementService to handle multiple origins) +\n**Salesforce Case Origin Field**: Cases already tagged with Origin=Mobile App, extend to Origin=Web, POS, Call Centre, Email\n\n|*Knowledge Base Integration*\n|**EngagementService API Extension**: Add endpoint to query Salesforce Knowledge Base articles, surface in Mobile App for self-service support +\n**Anti-Corruption Layer**: EngagementService translates Salesforce Knowledge API to OTR domain language\n\n|*Customer Satisfaction Surveys*\n|**Event-Driven Trigger**: Subscribe to `SupportCaseResolved` events published by EngagementService, trigger CSAT survey via Braze +\n**Braze Integration Pattern**: Reuse EngagementService → Braze integration pattern for survey campaigns\n\n|*Sentiment Analysis*\n|**Event Subscription**: Subscribe to `CustomerFeedbackSubmitted` events, analyse feedback sentiment (AI/ML service) +\n**EngagementService Extension**: Enrich Case with sentiment score before creating in Salesforce\n\n|*RecommendationService Bounded Context*\n|**Event Subscription**: RecommendationService subscribes to `SupportCaseCreated` events to understand customer pain points and personalize recommendations +\n**Domain Event Pattern**: Reuse Event Bus publishing pattern established by EngagementService\n\n|===\n\n*This Architecture Depends on Future Initiatives*:\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Future Initiative |Dependency Description\n\n|*Salesforce Data Isolation Strategy*\n|**BLOCKER**: Viva Energy Salesforce admin team must define data isolation strategy (Record Types, custom fields, queues) before production deployment +\n**Impact**: Multi-tenant data visibility and security governance\n\n|*Salesforce Case Field Mapping*\n|**BLOCKER**: Viva Energy Salesforce admin team must define field mapping for OTR feedback categories (App, Service, Order, Rewards, Refund, Delete Account) +\n**Impact**: Case creation logic in EngagementService depends on finalized Salesforce schema\n\n|*Salesforce Webhook Mechanism*\n|**BLOCKER**: Viva Energy Salesforce admin team must configure webhook mechanism (Outbound Messages vs Platform Events vs Process Builder) for Case update notifications +\n**Impact**: EngagementService webhook receiver implementation depends on chosen mechanism\n\n|*Event Bus Technology Selection*\n|**DECISION REQUIRED**: Choose Event Bus implementation (SNS+SQS vs EventBridge vs Kinesis) for domain event publishing +\n**Impact**: Infrastructure provisioning, event schema design, consumer implementation\n\n|*Microservice Hosting Platform*\n|**DECISION REQUIRED**: Choose hosting platform for ProfileService and EngagementService (AWS Lambda vs ECS vs EKS) +\n**Impact**: Deployment architecture, auto-scaling strategy, operational overhead\n\n|*Observability Platform*\n|**DECISION REQUIRED**: Choose observability platform (AWS CloudWatch vs Datadog vs New Relic) for monitoring and alerting +\n**Impact**: Dashboard configuration, metric collection, alerting setup\n\n|===\n\n*Future Work After This Initiative*:\n\n* **Event Schema Registry**: Implement event schema versioning and registry for domain events (currently ad-hoc schemas)\n* **API Versioning Strategy**: Define API versioning approach for ProfileService and EngagementService (currently v1 only)\n* **Multi-Region Deployment**: Extend to multi-region for disaster recovery and global availability\n* **Event Store**: Persist domain events for event sourcing and audit trail (currently ephemeral Event Bus only)\n* **CQRS Pattern**: Separate read models for high-volume queries (currently same model for reads/writes)\n* **GraphQL API**: Expose GraphQL API for flexible client queries (currently REST only)\n* **Real-Time Sync**: Bi-directional sync between Salesforce and ProfileService for Contact updates (currently JIT reconciliation only)\n\n=== Technical Risks and Mitigation\n\n[width=\"100%\",cols=\"5%,20%,25%,25%,25%\",options=\"header\",]\n|===\n|ID |Risk |Impact |Likelihood |Mitigation\n\n|RISK-CS-001\n|*Salesforce API rate limits exceeded*: High feedback volume exceeds Salesforce API limits, Cases not created\n|HIGH (customers don't receive Case confirmation, support tickets lost)\n|MEDIUM (volume unknown, rate limits TBD)\n|• Gather expected feedback volume data before cutover +\n• Implement Event Bus queue throttling/rate limiting +\n• Monitor queue depth and API usage +\n• Scale background workers based on queue depth +\n• Alert ops team when approaching rate limits\n\n|RISK-CS-002\n|*Salesforce downtime*: Salesforce Service Cloud outage prevents Case creation\n|MEDIUM (Cases delayed but queued, customers wait for confirmation)\n|LOW (Salesforce SLA 99.9% uptime)\n|• Async Case creation with retry logic +\n• Event Bus queues buffer work during outage +\n• Customers get immediate \"Feedback submitted\" (not blocked) +\n• Monitor Salesforce status page, alert ops team +\n• Automatic retry when Salesforce recovers\n\n|RISK-CS-003\n|*Contact migration data quality issues*: App database Contact data incomplete or invalid\n|HIGH (migration fails validation, cutover delayed)\n|MEDIUM (legacy data quality unknown)\n|• Pre-migration data quality assessment +\n• Flexible upsert logic (match by email/phone/VCI) +\n• Validation report identifies data issues before production migration +\n• Manual cleanup for invalid records +\n• Dry-run migration in sandbox environment\n\n|RISK-CS-004\n|*Duplicate Contacts created*: Email matching fails, ProfileService creates duplicate Contacts\n|MEDIUM (support agents see multiple profiles for same customer)\n|MEDIUM (email changes, data quality issues)\n|• Salesforce duplicate detection rules (if available) +\n• ProfileService logs Contact creation for audit trail +\n• Manual duplicate cleanup process (support team) +\n• Future enhancement: VCI as Salesforce External ID for stable matching\n\n|RISK-CS-005\n|*Dead letter queue accumulation*: Failed Case creations not processed, queue grows\n|HIGH (customers don't receive Case confirmation, feedback lost)\n|LOW (retry logic handles most failures)\n|• Dead letter queue monitoring and alerting +\n• Ops team dashboard showing DLQ depth +\n• Manual intervention process (investigate and reprocess) +\n• Automated alerts when DLQ depth exceeds threshold +\n• Root cause analysis for recurring failures\n\n|RISK-CS-006\n|*Salesforce webhook failures*: Salesforce can't deliver Case update notifications to EngagementService\n|MEDIUM (customers don't get push notifications for Case resolution)\n|LOW (webhook mechanism reliable)\n|• Webhook retry logic and exponential backoff +\n• EngagementService logs webhook deliveries +\n• Monitor webhook delivery success rate +\n• Fallback: Poll Salesforce API for Case updates (if webhook fails persistently) +\n• Alert ops team when webhook delivery rate drops\n\n|RISK-CS-007\n|*Multi-tenant data isolation breach*: OTR digital Cases visible to other Viva Energy support teams\n|HIGH (privacy violation, compliance risk)\n|LOW (Salesforce governance controls)\n|• Work with Viva Energy Salesforce admin team on data isolation strategy +\n• Test data visibility in Salesforce sandbox (UAT with different user roles) +\n• Validate Record Types, queues, field-level security before production +\n• Audit Salesforce user permissions and sharing rules\n\n|RISK-CS-008\n|*Mobile App release coordination*: App release delayed, cutover window missed\n|MEDIUM (cutover delayed, D365 CE retirement delayed)\n|MEDIUM (release schedule conflicts)\n|• Coordinate cutover timing with Mobile team early +\n• Buffer time in migration plan (2-week contingency) +\n• Decouple backend deployment from Mobile App release (backend deployed first, app follows) +\n• Feature flag for feedback submission (enable when ready)\n\n|RISK-CS-009\n|*Event Bus infrastructure issues*: SNS/SQS/EventBridge downtime or misconfiguration\n|HIGH (Case creation blocked, domain events not published)\n|LOW (AWS SLA 99.99% uptime)\n|• Leverage existing AWS infrastructure (proven, reliable) +\n• Infrastructure as Code (IaC) for Event Bus configuration +\n• Integration testing in non-production environment +\n• Monitor Event Bus metrics (queue depth, throughput, errors) +\n• Alert ops team on Event Bus failures\n\n|RISK-CS-010\n|*Team DDD knowledge gap*: Team unfamiliar with DDD patterns, bounded contexts, event-driven architecture\n|MEDIUM (implementation delays, architectural inconsistencies)\n|HIGH (first DDD implementation)\n|• DDD training for development team (workshops, documentation) +\n• Architecture review sessions (validate bounded context design) +\n• Pair programming with experienced DDD practitioners +\n• Incremental implementation (start small, iterate) +\n• Document architectural patterns in CLAUDE.md\n\n|===\n\n== Assumptions and Constraints\n\n=== Assumptions\n\n[width=\"100%\",cols=\"8%,92%\",options=\"header\",]\n|===\n|ID |Assumption\n\n|ASM-CS-001\n|Viva Energy Salesforce admin team will provide Salesforce production access, sandbox environment, and support for Case field mapping and data isolation configuration\n\n|ASM-CS-002\n|App database Contact data is sufficiently complete for migration (email/phone/VCI available for matching)\n\n|ASM-CS-003\n|Expected customer feedback volume (100-150 submissions/day from 20k DAU) is well within Salesforce API rate limits, with capacity planning for 3x-10x growth\n\n|ASM-CS-004\n|Existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis) is sufficient for Event Bus implementation (no additional infrastructure provisioning required)\n\n|ASM-CS-005\n|Braze integration already exists and can be extended for Case-related push notifications (no new Braze account or major configuration changes)\n\n|ASM-CS-006\n|Mobile App users have email addresses associated with their accounts (required for ProfileService Contact reconciliation)\n\n|ASM-CS-007\n|D365 Customer Engagement historical Cases have limited business value and do not require migration to Salesforce\n\n|ASM-CS-008\n|Support agents are trained on Salesforce Service Cloud and require minimal additional training for OTR digital customer Cases\n\n|ASM-CS-009\n|Salesforce Service Cloud shared instance has capacity for OTR digital customer Contacts and Cases (no additional licensing or storage costs)\n\n|ASM-CS-010\n|Mobile App release schedule can accommodate cutover timing (Week 10 in migration plan)\n\n|===\n\n=== Constraints\n\n[width=\"100%\",cols=\"8%,92%\",options=\"header\",]\n|===\n|ID |Constraint\n\n|CON-CS-001\n|Must use shared Viva Energy Salesforce Service Cloud instance (cannot deploy separate OTR-specific instance)\n\n|CON-CS-002\n|Must conform to existing Salesforce configuration and governance (Record Types, custom fields, queues, data isolation strategy defined by Viva Energy admin team)\n\n|CON-CS-003\n|Contact migration must complete before Mobile App cutover (no parallel run of D365 CE and Salesforce)\n\n|CON-CS-004\n|Big bang cutover only (no phased rollout with feature flags or pilot users)\n\n|CON-CS-005\n|Salesforce API rate limits and authentication method constrained by Viva Energy Salesforce configuration (TBD)\n\n|CON-CS-006\n|Event Bus implementation must use existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis - cannot introduce new infrastructure components)\n\n|CON-CS-007\n|Mobile App feedback form must include specific fields: Category, Store Name, Time of Visit, Contact Phone Number, Free Text Message (no attachments)\n\n|CON-CS-008\n|D365 Customer Engagement must be decommissioned within 90 days post-cutover (ADR-CS-006)\n\n|CON-CS-009\n|ProfileService and EngagementService must be stateless (no local aggregate persistence, Salesforce is System of Record)\n\n|CON-CS-010\n|First DDD bounded context implementation (team learning curve, architectural patterns must be documented for future bounded contexts)\n\n|===\n\n== Non-Functional Requirements\n\n=== Performance Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-PERF-001\n|Mobile App feedback submission API response time (ProfileService + EngagementService)\n|p95 < 1 second, p99 < 2 seconds\n\n|NFR-PERF-002\n|ProfileService Contact reconciliation API response time (JIT lookup)\n|p95 < 500ms, p99 < 1 second\n\n|NFR-PERF-003\n|EngagementService async Case creation latency (end-to-end: feedback submitted → Case created in Salesforce)\n|p95 < 5 minutes, p99 < 10 minutes\n\n|NFR-PERF-004\n|Salesforce API call latency (Contact query, Contact create, Case create)\n|p95 < 2 seconds, p99 < 5 seconds\n\n|NFR-PERF-005\n|Event Bus message processing throughput\n|> 100 messages/second (support peak feedback volume)\n\n|NFR-PERF-006\n|Braze push notification delivery latency (Case created → notification delivered)\n|p95 < 30 seconds, p99 < 60 seconds\n\n|===\n\n=== Availability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-AVAIL-001\n|ProfileService availability\n|99.9% uptime (8.76 hours downtime/year)\n\n|NFR-AVAIL-002\n|EngagementService availability\n|99.9% uptime (8.76 hours downtime/year)\n\n|NFR-AVAIL-003\n|Feedback submission success rate (including async Case creation)\n|> 99.5% (includes retry logic for transient failures)\n\n|NFR-AVAIL-004\n|Graceful degradation: Salesforce downtime handling\n|Feedback submission still succeeds, Cases queued for async creation when Salesforce recovers\n\n|NFR-AVAIL-005\n|Graceful degradation: Braze downtime handling\n|Case creation proceeds, push notifications disabled temporarily (feature flag)\n\n|NFR-AVAIL-006\n|Planned maintenance window\n|< 4 hours/month, scheduled during low-traffic periods (2-6am ACST)\n\n|===\n\n=== Scalability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-SCALE-001\n|Concurrent Mobile App users (peak)\n|Support 20,000 DAU (Daily Active Users), ~150 concurrent users submitting feedback during peak hours\n\n|NFR-SCALE-002\n|Feedback submissions per day\n|Expected: 100-150 submissions/day based on 20k DAU (~0.5-0.75% submission rate) +\nCapacity: Support 500 submissions/day (3x expected volume for growth), 2,000 submissions/day (peak/incident scenarios)\n\n|NFR-SCALE-003\n|Auto-scaling: ProfileService and EngagementService\n|Auto-scale based on CPU/memory/request rate, scale up within 2 minutes\n\n|NFR-SCALE-004\n|Event Bus queue capacity\n|Support 100,000 queued messages (buffer for Salesforce downtime)\n\n|NFR-SCALE-005\n|Salesforce API rate limit compliance\n|Stay within 80% of Salesforce API rate limits (buffer for spikes)\n\n|NFR-SCALE-006\n|Future growth capacity\n|Architecture supports 10x growth (1,000-1,500 submissions/day based on 200k DAU) without major redesign\n\n|===\n\n=== Security Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-SEC-001\n|Mobile App authentication\n|Microsoft Entra External ID OAuth 2.0 with JWT tokens (existing CIAM)\n\n|NFR-SEC-002\n|API authorisation: ProfileService and EngagementService\n|JWT token validation, authenticated users only, user context propagation\n\n|NFR-SEC-003\n|Salesforce API authentication\n|OAuth 2.0 with Connected App and JWT bearer flow (service account)\n\n|NFR-SEC-004\n|Data encryption in transit\n|TLS 1.2+ for all API calls (Mobile App ↔ ProfileService/EngagementService ↔ Salesforce ↔ Braze)\n\n|NFR-SEC-005\n|Data encryption at rest\n|Salesforce encryption at rest (managed by Salesforce), Event Bus message encryption (AWS KMS)\n\n|NFR-SEC-006\n|Secret management\n|AWS Secrets Manager for Salesforce credentials, Braze API keys, OAuth tokens (no hardcoded secrets)\n\n|NFR-SEC-007\n|PII data handling\n|Contact data (email, phone, name) treated as PII, GDPR-compliant retention policies (Salesforce governance)\n\n|NFR-SEC-008\n|API rate limiting and throttling\n|API Gateway rate limiting (100 requests/second per user), prevent abuse and DoS\n\n|NFR-SEC-009\n|Logging and auditing\n|Log all API calls, Salesforce Contact/Case creates/updates, Event Bus publishes (no PII in logs)\n\n|NFR-SEC-010\n|Salesforce data isolation\n|Multi-tenant data isolation via Salesforce Record Types, queues, sharing rules (defined by Viva Energy admin team)\n\n|===\n\n=== Reliability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-REL-001\n|Retry logic: EngagementService → Salesforce Case creation\n|Exponential backoff (1s, 2s, 4s, 8s, 16s), max 5 retries, then dead letter queue\n\n|NFR-REL-002\n|Dead letter queue monitoring\n|Alert ops team immediately when DLQ depth > 0 (failed Case creations require manual intervention)\n\n|NFR-REL-003\n|Event Bus message durability\n|Messages persisted in Event Bus (SNS+SQS/EventBridge/Kinesis), not lost on service restart\n\n|NFR-REL-004\n|Idempotency: Case creation\n|EngagementService ensures duplicate feedback submissions don't create duplicate Cases (idempotency key)\n\n|NFR-REL-005\n|Circuit breaker: Salesforce API calls\n|Open circuit after 5 consecutive failures, half-open retry after 30 seconds\n\n|NFR-REL-006\n|Health checks: ProfileService and EngagementService\n|Health endpoints for load balancer checks, readiness and liveness probes\n\n|NFR-REL-007\n|Disaster recovery: Event Bus\n|Event Bus messages replicated across AWS availability zones (SQS/EventBridge/Kinesis HA)\n\n|===\n\n=== Maintainability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-MAINT-001\n|Code quality: ProfileService and EngagementService\n|> 80% test coverage (unit + integration tests), automated CI/CD pipeline\n\n|NFR-MAINT-002\n|API documentation\n|OpenAPI/Swagger specs for ProfileService and EngagementService, auto-generated API docs\n\n|NFR-MAINT-003\n|Deployment automation\n|Infrastructure as Code (Terraform/CloudFormation/CDK), zero-downtime deployments\n\n|NFR-MAINT-004\n|Logging: structured logs\n|JSON-formatted logs with correlation IDs, log levels (DEBUG, INFO, WARN, ERROR), centralized log aggregation\n\n|NFR-MAINT-005\n|Monitoring dashboards\n|Real-time dashboards for ProfileService, EngagementService, Event Bus (see Monitoring and Observability section)\n\n|NFR-MAINT-006\n|Alerting and on-call\n|PagerDuty/Opsgenie integration for P1/P2 alerts, on-call rotation for ops team\n\n|NFR-MAINT-007\n|Configuration management\n|Externalized configuration (environment variables, AWS Parameter Store), no hardcoded config\n\n|NFR-MAINT-008\n|Versioning: API and events\n|Semantic versioning (v1, v2), backward compatibility for API changes, event schema evolution\n\n|===\n\n=== Usability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-USE-001\n|Feedback submission UX\n|Mobile App user receives immediate \"Feedback submitted\" confirmation (< 1 second), not blocked by async Case creation\n\n|NFR-USE-002\n|Push notification delivery\n|Customer receives \"Your feedback has been received\" notification within 30 seconds of Case creation in Salesforce\n\n|NFR-USE-003\n|Case resolution notification\n|Customer receives \"Your case has been resolved\" notification within 30 seconds of support agent resolving Case\n\n|NFR-USE-004\n|Error messaging\n|User-friendly error messages for failed feedback submission (not technical errors), retry prompts\n\n|NFR-USE-005\n|Accessibility\n|Mobile App feedback form meets WCAG 2.1 AA accessibility standards (existing Mobile App compliance)\n\n|===\n\n=== Compliance Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-COMP-001\n|GDPR compliance: PII data\n|Customer Contact data (email, phone, name) managed per GDPR retention policies (Salesforce governance)\n\n|NFR-COMP-002\n|GDPR compliance: Right to erasure\n|Support \"Delete Account\" feedback category, trigger Contact deletion in Salesforce per GDPR Article 17\n\n|NFR-COMP-003\n|Data residency\n|Salesforce data residency governed by Viva Energy Salesforce configuration (regional compliance)\n\n|NFR-COMP-004\n|Audit trail\n|All Contact creates/updates, Case creates/updates logged for compliance auditing (Salesforce audit logs)\n\n|NFR-COMP-005\n|API security standards\n|OWASP API Security Top 10 compliance (injection prevention, authentication, authorisation, data exposure)\n\n|===\n\n== Monitoring and Observability\n\n=== Key Metrics\n\n[width=\"100%\",cols=\"25%,40%,35%\",options=\"header\",]\n|===\n|Metric Category |Metric |Target/Threshold\n\n|*Feedback Submission*\n|Feedback submission success rate (Mobile App → EngagementService)\n|> 99.5%\n\n|*Async Case Creation*\n|Case creation success rate (EngagementService → Salesforce)\n|> 99%\n\n|*Async Case Creation*\n|Case creation latency (time from feedback submission to Case created in Salesforce)\n|p95 < 5 minutes\n\n|*Event Bus*\n|Event Bus queue depth (pending Case creations)\n|< 100 messages\n\n|*Event Bus*\n|Dead letter queue depth (failed Case creations)\n|= 0 (alert on any failures)\n\n|*Salesforce API*\n|Salesforce API error rate\n|< 1%\n\n|*Salesforce API*\n|Salesforce API latency (Case creation)\n|p95 < 2 seconds\n\n|*Salesforce API*\n|Salesforce API rate limit utilization\n|< 80% of limit\n\n|*ProfileService*\n|Contact reconciliation success rate (JIT lookups)\n|> 99.5%\n\n|*ProfileService*\n|Contact reconciliation latency\n|p95 < 500ms\n\n|*Braze Notifications*\n|Push notification delivery rate (Case created/updated)\n|> 95%\n\n|*Salesforce Webhook*\n|Webhook delivery success rate (Salesforce → EngagementService)\n|> 99%\n\n|*Customer Satisfaction*\n|Customer satisfaction score (CSAT)\n|> 4.0/5.0 (improve by 15% from D365 CE baseline)\n\n|*Support Operations*\n|Average case resolution time\n|Decrease by 20% from D365 CE baseline\n\n|===\n\n=== Alerting Thresholds\n\n[width=\"100%\",cols=\"25%,50%,25%\",options=\"header\",]\n|===\n|Alert |Condition |Severity\n\n|*Feedback submission failures*\n|Feedback submission success rate < 95% over 5-minute window\n|P1 - Critical\n\n|*Dead letter queue accumulation*\n|Dead letter queue depth > 0 (any failed Case creations)\n|P2 - High\n\n|*Event Bus queue backlog*\n|Event Bus queue depth > 100 messages for > 15 minutes\n|P2 - High\n\n|*Salesforce API errors*\n|Salesforce API error rate > 5% over 5-minute window\n|P1 - Critical\n\n|*Salesforce API rate limits*\n|Salesforce API rate limit utilization > 90%\n|P2 - High\n\n|*Contact reconciliation failures*\n|ProfileService Contact reconciliation failure rate > 5% over 5-minute window\n|P2 - High\n\n|*Braze notification failures*\n|Braze push notification delivery rate < 80% over 15-minute window\n|P3 - Medium\n\n|*Salesforce webhook failures*\n|Salesforce webhook delivery success rate < 90% over 15-minute window\n|P2 - High\n\n|*Case creation latency*\n|Case creation latency p95 > 10 minutes\n|P3 - Medium\n\n|===\n\n=== Dashboards\n\n*ProfileService Dashboard:*\n\n* Contact reconciliation success rate (JIT lookups)\n* Contact reconciliation latency (p50, p95, p99)\n* Contact creation vs update ratio (new Contacts created vs existing Contacts updated)\n* Salesforce API error rate (Contact queries and creates)\n* Request rate and throughput\n\n*EngagementService Dashboard:*\n\n* Feedback submission success rate\n* Case creation success rate (async workflow)\n* Case creation latency (p50, p95, p99)\n* Event Bus queue depth (pending Case creations)\n* Dead letter queue depth (failed Case creations)\n* Salesforce API error rate (Case creation)\n* Salesforce API latency\n* Salesforce API rate limit utilization\n* Braze push notification delivery rate\n* Salesforce webhook delivery success rate\n\n*Event Bus Dashboard:*\n\n* Queue depth (pending messages)\n* Throughput (messages published/consumed per minute)\n* Dead letter queue depth (failed messages)\n* Consumer lag (time between publish and consume)\n\n*Customer Support Dashboard (Business Metrics):*\n\n* Total feedback submissions per day/week/month\n* Feedback category breakdown (App, Service, Order, Rewards, Refund, Delete Account)\n* Customer satisfaction score (CSAT) trend\n* Average case resolution time trend\n* Case volume by support team/queue\n* Unified customer view adoption (support agent feedback)\n<<<\n== Solution Validation\n\nThis section defines the validation criteria and testing approach for the solution.\n\n=== Functional Validation\n\n==== ProfileService API Testing\n\n*Test Scenarios*:\n1. **Happy Path**: Authenticated user requests Contact ID, existing Contact found in Salesforce, Contact ID returned\n2. **JIT Creation**: Authenticated user requests Contact ID, no existing Contact, new Contact created in Salesforce, Contact ID returned\n3. **Salesforce API Failure**: Salesforce unavailable, ProfileService returns 500 error, user retries\n4. **Invalid JWT**: Unauthenticated request, ProfileService returns 401 error\n\n*Acceptance Criteria*:\n- Contact reconciliation success rate > 99.5%\n- JIT Contact creation completes within 500ms (p95)\n\n==== EngagementService API Testing\n\n*Test Scenarios*:\n1. **Happy Path**: Valid feedback submission, immediate 202 Accepted response, Case created in Salesforce within 5 minutes, Braze notification delivered\n2. **Invalid Category**: Invalid feedback category, 400 Bad Request response with validation error\n3. **Salesforce Downtime**: Salesforce unavailable during async Case creation, message queued, retry logic executes, Case created when Salesforce recovers\n4. **Dead Letter Queue**: Case creation fails after 5 retries, message moved to DLQ, ops team alerted\n5. **Webhook Notification**: Support agent resolves Case in Salesforce, webhook triggers EngagementService, Braze push notification sent to customer\n\n*Acceptance Criteria*:\n- Feedback submission success rate > 99.5% (including async Case creation)\n- Async Case creation completes within 5 minutes (p95)\n- Webhook delivery success rate > 99%\n\n=== Non-Functional Validation\n\n==== Performance Testing\n\n*Load Testing*:\n\n*Baseline*: Expected 100-150 submissions/day from 20k DAU (~0.5-0.75% submission rate)\n\n- **Normal Load**: 1 submission/minute sustained for 2 hours (simulate typical daily pattern)\n- **3x Load**: 3 submissions/minute sustained for 1 hour (simulate busy period, 450 submissions/day)\n- **Peak Load (10x)**: 10 submissions/minute for 15 minutes (simulate incident scenario, app outage causing backlog)\n- **Stress Test**: 50 submissions/minute for 5 minutes (find breaking point, 20x normal)\n\n*Validation*:\n- API response time p95 < 1 second under 10x load\n- Event Bus queue depth remains manageable (< 100 messages)\n- No Case creation failures, all submissions processed successfully\n- Auto-scaling triggers appropriately for sustained load > 3x baseline\n\n*Acceptance Criteria*:\n- NFR-PERF-001 through NFR-PERF-006 validated under realistic load (3x and 10x baseline)\n- Auto-scaling triggers within 2 minutes of load increase\n- System handles 10x peak gracefully, 20x stress test identifies limits\n\n==== Resilience Testing\n\n*Salesforce API Failure Scenarios*:\n1. **Complete Outage**: Salesforce unavailable for 2 hours, Event Bus queues buffer work, Cases created when Salesforce recovers\n2. **Rate Limit Exceeded**: Salesforce rate limit hit, queue throttling activates, Cases created within SLA\n\n*Acceptance Criteria*:\n- NFR-AVAIL-004 validated (graceful degradation during Salesforce downtime)\n- Circuit breaker activates after 5 consecutive failures\n\n==== Security Validation\n\n*Penetration Testing*:\n- API authentication bypass attempts\n- SQL injection attempts\n- Webhook signature validation bypass\n\n*Acceptance Criteria*:\n- NFR-SEC-001 through NFR-SEC-010 validated\n- OWASP API Security Top 10 compliance verified\n\n=== Integration Validation\n\n==== End-to-End Testing\n\n*Full User Journey*:\n1. User authenticates via Microsoft Entra External ID\n2. Mobile App requests Contact ID from ProfileService (JIT reconciliation)\n3. User submits feedback via EngagementService\n4. Background worker creates Case in Salesforce\n5. Braze notification delivered to user\n6. Support agent resolves Case in Salesforce\n7. Salesforce webhook triggers EngagementService\n8. Braze notification delivered to user\n\n*Acceptance Criteria*:\n- End-to-end flow completes successfully in UAT\n- User receives both \"feedback submitted\" and \"case resolved\" notifications\n","structuredPatch":[{"oldStart":2037,"oldLines":16,"newStart":2037,"newLines":16,"lines":[" "," *Prerequisites*:"," ","-* WP-CS-004 (Contact Migration Tooling) completed","-* WP-CS-001 (ProfileService Development) deployed to production (not yet integrated with Mobile App)","-* WP-CS-007 (Salesforce Configuration) production configuration completed","+* <<wp-cs-004,WP-CS-004>> (Contact Migration Tooling) completed","+* <<wp-cs-001,WP-CS-001>> (ProfileService Development) deployed to production (not yet integrated with Mobile App)","+* <<wp-cs-007,WP-CS-007>> (Salesforce Configuration) production configuration completed"," * Salesforce production access granted"," * Migration approved by business stakeholders"," "," *Dependent Work Packages*:"," ","-* Must complete after WP-CS-001, WP-CS-004, WP-CS-007","-* Must complete before WP-CS-009 (Production Deployment)","+* Must complete after <<wp-cs-001,WP-CS-001>>, <<wp-cs-004,WP-CS-004>>, <<wp-cs-007,WP-CS-007>>","+* Must complete before <<wp-cs-009,WP-CS-009>> (Production Deployment)"," "," ==== Skills Required"," "]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"95ef04e9-e6e0-4a11-968d-5eb893830301"}
{"parentUuid":"7ab8c21b-4832-4994-8a0a-6dc666d5479f","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01QE9soGN6hyj6oBf8bDjmEP","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Good! Now let me read the remaining dependencies for WP-CS-009 and WP-CS-010.","signature":"EvUBCkYICxgCKkDx47zxK9mwIQc7ejqyCkbWliAUiTOBwkT0zbVBEq8vy09mGANW92uqZ2TdiA/Frk0SPwTA2uT6IyYMuoWDiu4dEgyjIgoN62IkG2Dx3GwaDLmrVKUt1ocCYDx+7yIwRUsMmyoK7r20KB8l+snd0WYUxvbx4+grAEdqaHlFVJ/woZwsnxqNQUVwb8o/rZdKKl2fywwd7EIhqmcbTJaZ9AdJHj2LTtxKEufhtDB6eAOfwgriKyI55o3w3wXvNSWNOOig+xWALK0s3LW0tH9luHTlxYYParJWXnB9j39LKU7R8ToucaRcFxp0coNIJsoYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":2154,"cache_read_input_tokens":39637,"cache_creation":{"ephemeral_5m_input_tokens":2154,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWw59SyjL6BB5gPKsGYEh","type":"assistant","uuid":"be033c80-fc0b-481d-abdb-6e90c089639d","timestamp":"2026-01-09T03:11:46.830Z"}
{"parentUuid":"be033c80-fc0b-481d-abdb-6e90c089639d","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01QE9soGN6hyj6oBf8bDjmEP","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01F5PwavYK6joFrPy8afy5HX","name":"Read","input":{"file_path":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","offset":2095,"limit":20}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":2154,"cache_read_input_tokens":39637,"cache_creation":{"ephemeral_5m_input_tokens":2154,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWw59SyjL6BB5gPKsGYEh","type":"assistant","uuid":"78505a73-cdb0-44a0-9cf1-21839f3af031","timestamp":"2026-01-09T03:11:47.496Z"}
{"parentUuid":"78505a73-cdb0-44a0-9cf1-21839f3af031","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01QE9soGN6hyj6oBf8bDjmEP","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_012565F8jeFtQwSWg2QiHRmY","name":"Read","input":{"file_path":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","offset":2160,"limit":20}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":2154,"cache_read_input_tokens":39637,"cache_creation":{"ephemeral_5m_input_tokens":2154,"ephemeral_1h_input_tokens":0},"output_tokens":250,"service_tier":"standard"}},"requestId":"req_011CWw59SyjL6BB5gPKsGYEh","type":"assistant","uuid":"279c98d1-9cda-4ce8-ba26-055aab300dda","timestamp":"2026-01-09T03:11:48.259Z"}
{"parentUuid":"78505a73-cdb0-44a0-9cf1-21839f3af031","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01F5PwavYK6joFrPy8afy5HX","type":"tool_result","content":"  2095→** Customer communication (if visible change)\n  2096→* Rollback plan\n  2097→** Documented rollback procedure\n  2098→** Feature flag can disable Salesforce integration and re-enable D365 CE\n  2099→** Rollback decision criteria (P1/P2 incidents, feedback submission success rate < 99%)\n  2100→\n  2101→==== Dependencies\n  2102→\n  2103→*Prerequisites*:\n  2104→\n  2105→* WP-CS-001 (ProfileService Development) completed\n  2106→* WP-CS-002 (EngagementService Development) completed\n  2107→* WP-CS-003 (Event Bus Infrastructure) completed\n  2108→* WP-CS-005 (Mobile App Integration) completed\n  2109→* WP-CS-006 (Integration Testing) completed with UAT sign-off\n  2110→* WP-CS-007 (Salesforce Configuration) production configuration completed\n  2111→* WP-CS-008 (Contact Data Migration) completed successfully\n  2112→* Mobile App release approval (App Store, Google Play)\n  2113→\n  2114→*Dependent Work Packages*:\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"8da9d961-eb4d-4713-8646-02ef7ee722c3","timestamp":"2026-01-09T03:11:48.542Z","toolUseResult":{"type":"text","file":{"filePath":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","content":"** Customer communication (if visible change)\n* Rollback plan\n** Documented rollback procedure\n** Feature flag can disable Salesforce integration and re-enable D365 CE\n** Rollback decision criteria (P1/P2 incidents, feedback submission success rate < 99%)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-001 (ProfileService Development) completed\n* WP-CS-002 (EngagementService Development) completed\n* WP-CS-003 (Event Bus Infrastructure) completed\n* WP-CS-005 (Mobile App Integration) completed\n* WP-CS-006 (Integration Testing) completed with UAT sign-off\n* WP-CS-007 (Salesforce Configuration) production configuration completed\n* WP-CS-008 (Contact Data Migration) completed successfully\n* Mobile App release approval (App Store, Google Play)\n\n*Dependent Work Packages*:","numLines":20,"startLine":2095,"totalLines":3329}},"sourceToolAssistantUUID":"78505a73-cdb0-44a0-9cf1-21839f3af031"}
{"parentUuid":"279c98d1-9cda-4ce8-ba26-055aab300dda","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_012565F8jeFtQwSWg2QiHRmY","type":"tool_result","content":"  2160→* Documentation updates\n  2161→** Production runbook\n  2162→** Troubleshooting guide (based on incidents resolved)\n  2163→** Operational procedures for support team\n  2164→** Lessons learned document\n  2165→\n  2166→==== Dependencies\n  2167→\n  2168→*Prerequisites*:\n  2169→\n  2170→* WP-CS-009 (Production Deployment) completed\n  2171→* Cutover successful with no critical incidents\n  2172→\n  2173→*Dependent Work Packages*:\n  2174→\n  2175→* Final work package in sequence\n  2176→\n  2177→==== Skills Required\n  2178→\n  2179→* Production support and incident management\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"e6518daf-74b9-467f-a8b5-34730a8e1b91","timestamp":"2026-01-09T03:11:48.542Z","toolUseResult":{"type":"text","file":{"filePath":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","content":"* Documentation updates\n** Production runbook\n** Troubleshooting guide (based on incidents resolved)\n** Operational procedures for support team\n** Lessons learned document\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-009 (Production Deployment) completed\n* Cutover successful with no critical incidents\n\n*Dependent Work Packages*:\n\n* Final work package in sequence\n\n==== Skills Required\n\n* Production support and incident management","numLines":20,"startLine":2160,"totalLines":3329}},"sourceToolAssistantUUID":"279c98d1-9cda-4ce8-ba26-055aab300dda"}
{"parentUuid":"e6518daf-74b9-467f-a8b5-34730a8e1b91","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01BciikPTja3arGFt7F7JMXt","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Let me also read a bit more of WP-CS-009 to see if there are more references.","signature":"EvUBCkYICxgCKkChQ3mhK8OkljV7hPxYJ8rPEheOwP10EdcTSB1BczWXP6CBbstAxR6Wde+RUViNbUoqewE5bgDpzdv4GRbzTo2bEgxMOUzUnp2MuXhm6cEaDGdR/oh737//uMj+FCIwHgBERLn9ey0rOCxeskIetHrY27+WZs5m041fnzwLIwhilmUmDgnWw8F92Sa/d476Kl29vWoHC3Hut2chVQ8cHMia5iHMykEa4LIlPDfiz75GEuno4WtATwxxIyAeWYd/5Hfa3tphGU0qfCNRZ2hH3eU+6wfUViBt27CbFqauNHbvkLgt5IX9OQb7goBR2vUYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":956,"cache_read_input_tokens":41791,"cache_creation":{"ephemeral_5m_input_tokens":956,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CWw59qpugsPy3no4L4i9Q","type":"assistant","uuid":"fd739e4d-b2e4-4b6d-b3a6-52097ad71c7a","timestamp":"2026-01-09T03:11:51.707Z"}
{"parentUuid":"fd739e4d-b2e4-4b6d-b3a6-52097ad71c7a","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01BciikPTja3arGFt7F7JMXt","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_018THmLdN1am6J6PmziJFTza","name":"Read","input":{"file_path":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","offset":2114,"limit":10}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":956,"cache_read_input_tokens":41791,"cache_creation":{"ephemeral_5m_input_tokens":956,"ephemeral_1h_input_tokens":0},"output_tokens":148,"service_tier":"standard"}},"requestId":"req_011CWw59qpugsPy3no4L4i9Q","type":"assistant","uuid":"54d41653-134e-4772-9694-636abe5bddf7","timestamp":"2026-01-09T03:11:52.435Z"}
{"parentUuid":"54d41653-134e-4772-9694-636abe5bddf7","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_018THmLdN1am6J6PmziJFTza","type":"tool_result","content":"  2114→*Dependent Work Packages*:\n  2115→\n  2116→* Must complete after all prior work packages (final cutover)\n  2117→\n  2118→==== Skills Required\n  2119→\n  2120→* Production deployment and release management\n  2121→* Incident management and troubleshooting\n  2122→* Monitoring and observability\n  2123→* Change management and communication\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"b83ae8aa-218a-4abe-9b6e-d22c6541d0e2","timestamp":"2026-01-09T03:11:52.646Z","toolUseResult":{"type":"text","file":{"filePath":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","content":"*Dependent Work Packages*:\n\n* Must complete after all prior work packages (final cutover)\n\n==== Skills Required\n\n* Production deployment and release management\n* Incident management and troubleshooting\n* Monitoring and observability\n* Change management and communication","numLines":10,"startLine":2114,"totalLines":3329}},"sourceToolAssistantUUID":"54d41653-134e-4772-9694-636abe5bddf7"}
{"parentUuid":"b83ae8aa-218a-4abe-9b6e-d22c6541d0e2","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01KEU6YqegFDghTqyfGyAUMy","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now let me update the dependencies for WP-CS-009 and WP-CS-010.","signature":"EucBCkYICxgCKkBbXrDv5Obw+s66p5H7NIw+B6eNMGFebtfwolnR76aDBxjprTMXJW8XkyDrtw4o8dv5UgKeqftXIqEGbuSEt97hEgwJhrJWtPjalWRw4SAaDIG88SS6wjakHwZBTiIwsYo3xxKk3iTzpNFIWZ3L52rGSNv2s2WIuhXkAft2WG2u4YwqUXzMenrkHtmwNdYTKk+UdkNq77eNY6W9dYr7R4CU1zYS0Z5C/letb0QTtAm9l0mU/peTKLJ8mCzALxh5KZptHa1VuQs8EVH4jcx6qsYeWYeM4peVgyp9AybSJBIiGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":348,"cache_read_input_tokens":42747,"cache_creation":{"ephemeral_5m_input_tokens":348,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CWw5A97DuaMVk8jUXtmCV","type":"assistant","uuid":"f8da06b9-5167-4496-9174-518396e780c7","timestamp":"2026-01-09T03:11:56.102Z"}
{"parentUuid":"f8da06b9-5167-4496-9174-518396e780c7","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01KEU6YqegFDghTqyfGyAUMy","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01LGA4bSSkNZNx3ZaK6T8GTr","name":"Edit","input":{"replace_all":false,"file_path":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","old_string":"*Prerequisites*:\n\n* WP-CS-001 (ProfileService Development) completed\n* WP-CS-002 (EngagementService Development) completed\n* WP-CS-003 (Event Bus Infrastructure) completed\n* WP-CS-005 (Mobile App Integration) completed\n* WP-CS-006 (Integration Testing) completed with UAT sign-off\n* WP-CS-007 (Salesforce Configuration) production configuration completed\n* WP-CS-008 (Contact Data Migration) completed successfully\n* Mobile App release approval (App Store, Google Play)","new_string":"*Prerequisites*:\n\n* <<wp-cs-001,WP-CS-001>> (ProfileService Development) completed\n* <<wp-cs-002,WP-CS-002>> (EngagementService Development) completed\n* <<wp-cs-003,WP-CS-003>> (Event Bus Infrastructure) completed\n* <<wp-cs-005,WP-CS-005>> (Mobile App Integration) completed\n* <<wp-cs-006,WP-CS-006>> (Integration Testing) completed with UAT sign-off\n* <<wp-cs-007,WP-CS-007>> (Salesforce Configuration) production configuration completed\n* <<wp-cs-008,WP-CS-008>> (Contact Data Migration) completed successfully\n* Mobile App release approval (App Store, Google Play)"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":348,"cache_read_input_tokens":42747,"cache_creation":{"ephemeral_5m_input_tokens":348,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CWw5A97DuaMVk8jUXtmCV","type":"assistant","uuid":"e79d73c2-d32d-4fb6-9c90-b628f8894d7f","timestamp":"2026-01-09T03:11:59.532Z"}
{"parentUuid":"e79d73c2-d32d-4fb6-9c90-b628f8894d7f","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01KEU6YqegFDghTqyfGyAUMy","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01C8nfY8TnFh8xaRHWJX58HJ","name":"Edit","input":{"replace_all":false,"file_path":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","old_string":"*Prerequisites*:\n\n* WP-CS-009 (Production Deployment) completed\n* Cutover successful with no critical incidents","new_string":"*Prerequisites*:\n\n* <<wp-cs-009,WP-CS-009>> (Production Deployment) completed\n* Cutover successful with no critical incidents"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":348,"cache_read_input_tokens":42747,"cache_creation":{"ephemeral_5m_input_tokens":348,"ephemeral_1h_input_tokens":0},"output_tokens":667,"service_tier":"standard"}},"requestId":"req_011CWw5A97DuaMVk8jUXtmCV","type":"assistant","uuid":"8bea5b82-6ce0-47a3-836d-5db1ec23531c","timestamp":"2026-01-09T03:12:01.047Z"}
{"parentUuid":"e79d73c2-d32d-4fb6-9c90-b628f8894d7f","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01LGA4bSSkNZNx3ZaK6T8GTr","type":"tool_result","content":"The file /mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n  2099→** Rollback decision criteria (P1/P2 incidents, feedback submission success rate < 99%)\n  2100→\n  2101→==== Dependencies\n  2102→\n  2103→*Prerequisites*:\n  2104→\n  2105→* <<wp-cs-001,WP-CS-001>> (ProfileService Development) completed\n  2106→* <<wp-cs-002,WP-CS-002>> (EngagementService Development) completed\n  2107→* <<wp-cs-003,WP-CS-003>> (Event Bus Infrastructure) completed\n  2108→* <<wp-cs-005,WP-CS-005>> (Mobile App Integration) completed\n  2109→* <<wp-cs-006,WP-CS-006>> (Integration Testing) completed with UAT sign-off\n  2110→* <<wp-cs-007,WP-CS-007>> (Salesforce Configuration) production configuration completed\n  2111→* <<wp-cs-008,WP-CS-008>> (Contact Data Migration) completed successfully\n  2112→* Mobile App release approval (App Store, Google Play)\n  2113→\n  2114→*Dependent Work Packages*:\n  2115→\n  2116→* Must complete after all prior work packages (final cutover)"}]},"uuid":"22961170-c715-4224-ad76-4e3903c5e25e","timestamp":"2026-01-09T03:12:01.276Z","toolUseResult":{"filePath":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","oldString":"*Prerequisites*:\n\n* WP-CS-001 (ProfileService Development) completed\n* WP-CS-002 (EngagementService Development) completed\n* WP-CS-003 (Event Bus Infrastructure) completed\n* WP-CS-005 (Mobile App Integration) completed\n* WP-CS-006 (Integration Testing) completed with UAT sign-off\n* WP-CS-007 (Salesforce Configuration) production configuration completed\n* WP-CS-008 (Contact Data Migration) completed successfully\n* Mobile App release approval (App Store, Google Play)","newString":"*Prerequisites*:\n\n* <<wp-cs-001,WP-CS-001>> (ProfileService Development) completed\n* <<wp-cs-002,WP-CS-002>> (EngagementService Development) completed\n* <<wp-cs-003,WP-CS-003>> (Event Bus Infrastructure) completed\n* <<wp-cs-005,WP-CS-005>> (Mobile App Integration) completed\n* <<wp-cs-006,WP-CS-006>> (Integration Testing) completed with UAT sign-off\n* <<wp-cs-007,WP-CS-007>> (Salesforce Configuration) production configuration completed\n* <<wp-cs-008,WP-CS-008>> (Contact Data Migration) completed successfully\n* Mobile App release approval (App Store, Google Play)","originalFile":"= Salesforce Customer Support - Solution Architecture\n:project-name: Salesforce Customer Support\n:togaf-adm-phase: Phase E: Opportunities & Solutions\n:last-updated: 2026-01-07\n:document-type: Solution Architecture Document\n:status: Discovery\n:version: 0.1\n:domain: Customer Support & Engagement\n:programme-lead:\n:domain-architect: O.Young@otr.com.au\n:architecture-definition: xref:architecture-definitions:salesforce_customer_support.adoc[Architecture Definitions/Salesforce Customer Support]\n:doctype: article\n:toc: left\n:toclevels: 4\n:sectanchors:\n:sectlinks:\n:sectnums:\n:icons: font\n:source-highlighter: highlightjs\n:experimental:\n:description:\n:keywords:\n\n<<<\n== Purpose and Scope\n\n=== Purpose\n\nThis Solution Architecture defines how the Salesforce Customer Support consolidation will be implemented - the specific technology products, configurations, interfaces, and deployment architecture that realise the xref:architecture-definitions:salesforce_customer_support.adoc[Salesforce Customer Support Architecture Definition].\n\nThis solution establishes the **first implementation of OTR's target Domain-Driven Design (DDD) architecture** by deploying two new bounded contexts (`ProfileService` and `EngagementService`) as microservices, consolidating customer support onto Salesforce Service Cloud, and implementing event-driven integration patterns that will serve as the foundation for future bounded contexts (including Flybuys integration).\n\n=== Vision\n\n> Unify customer support across all OTRG channels by consolidating OTR digital customer feedback onto Salesforce Service Cloud, establishing the foundational DDD architecture with ProfileService and EngagementService bounded contexts that protect digital channels from external system changes while enabling support agents to deliver exceptional customer experiences with complete interaction history.\n\n=== Architectural Approach\n\nThis architecture establishes OTR's **first bounded context implementation** using Domain-Driven Design strategic patterns:\n\n* *link:../bounded_context/profile.adoc[ProfileService]* (NEW bounded context): Just-In-Time Contact reconciliation with Salesforce, upsert by email, returns Salesforce Contact ID to digital channels - foundation for future Flybuys partner linking\n* *link:../bounded_context/engagement.adoc[EngagementService]* (NEW bounded context): Customer feedback submission facade, Anti-Corruption Layer for Salesforce Case creation, Braze integration for all outbound customer communications (push, email, SMS), async Case processing via Event Bus\n* *Event-driven integration* (NEW pattern): Domain event publishing using existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis) - first implementation establishing pattern for future bounded contexts\n* *Anti-Corruption Layer*: EngagementService isolates digital channels from Salesforce API changes, translates between OTR domain language and Salesforce Service Cloud API\n* *Conformist Pattern*: ProfileService and EngagementService conform to existing Salesforce configuration (shared Viva Energy instance, multi-tenant governance)\n* *Big bang cutover*: Single deployment after Contact migration, no phased rollout, D365 CE retirement post-cutover\n\n=== Scope\n\n==== In Scope\n\n* Solution Building Blocks (SBBs) - specific technology products and versions\n* Interface specifications (APIs, events, data formats)\n* Data architecture and schema specifications\n* Deployment architecture and infrastructure configuration\n* Transition architecture with migration phases\n* Technical validation criteria and testing approach\n* External system integration specifications\n* Physical data models and API schemas\n\n==== Out of Scope\n\n===== Covered in xref:architecture-definitions:salesforce_customer_support.adoc[Architecture Definition]\n\n* Business requirements and stakeholder analysis\n* Architecture decisions and rationale (ADRs)\n* Bounded context definitions and responsibilities\n* High-level integration patterns (ACL, Conformist, OHS+PL)\n* Business capability mapping and value streams\n* Architecture principles and governance\n\n===== Covered in Other Documents\n\n* Detailed design (class diagrams, sequence diagrams for all flows)\n* Implementation code and unit tests\n* Business case and return-on-investment analysis\n* Operational run books and support procedures\n\n<<<\n=== Architecture Overview\n\n[mermaid]\n----\n---\nconfig:\n  layout: elk\n---\nflowchart TB\n    Customer([\"Customer\"]) -- Uses --> MobileApp[\"Mobile App<br>iOS/Android\"]\n    Customer -- Shops at --> POS[\"OTR/OTR+ POS<br>D365 Commerce\"]\n    MobileApp -- Authenticate --> EntraID[\"Microsoft Entra\"]\n    MobileApp -- Identifies & Reconciles --> ProfileService[\"ProfileService\"]\n    ProfileService <-- Reconcile App User as Salesforce Contact --> Salesforce[\"Salesforce\"]\n    ProfileService -- On Create --> EventBus[\"EventBus\"]\n    EventBus -- Emits CreateUser Event --> LoyaltyService[\"LoyaltyService\"] & EngagementService[\"EngagementService\"]\n    LoyaltyService -- Reconcile Wallet --> EagleEye[\"EagleEye\"]\n    EngagementService -- Reconcile Braze Profile --> Braze[\"Braze\"]\n    EngagementService --> Salesforce\n    D365CE[\"D365CE\"] -- Data Migration --> Salesforce\n    MobileApp -- Submits Feedback --> EngagementService\n\n    Customer:::customer\n    MobileApp:::presentation\n    POS:::presentation\n    EntraID:::external\n    ProfileService:::newService\n    Salesforce:::external\n    EventBus:::infrastructure\n    LoyaltyService:::newService\n    EngagementService:::newService\n    EagleEye:::external\n    Braze:::external\n    D365CE:::external\n    classDef newService fill:#4CAF50,stroke:#2E7D32,stroke-width:3px,color:#fff\n    classDef external fill:#FF9800,stroke:#E65100,stroke-width:2px,color:#fff\n    classDef infrastructure fill:#2196F3,stroke:#0D47A1,stroke-width:2px,color:#fff\n    classDef presentation fill:#9C27B0,stroke:#4A148C,stroke-width:2px,color:#fff\n    classDef customer fill:#607D8B,stroke:#263238,stroke-width:2px,color:#fff\n----\n\n\n==== Key Architectural Patterns\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Pattern |Application |Rationale\n\n|*Anti-Corruption Layer (ACL)*\n|EngagementService → Salesforce Service Cloud\n|Protects digital channels (Mobile App, Web) from Salesforce API changes, translates between OTR domain language and Salesforce Case/Contact model, enables independent evolution of internal domain model\n\n|*Conformist*\n|ProfileService → Salesforce, EngagementService → Salesforce\n|Shared Viva Energy Salesforce instance - we conform to existing configuration, governance, and API contracts (external system we don't control)\n\n|*Backend-for-Frontend (BFF)*\n|EngagementService\n|Aggregates customer feedback submission, Contact lookup, async Case creation, and Braze notification orchestration for digital channel clients\n\n|*Event-Driven Architecture (OHS+PL)*\n|Event Bus (SNS+SQS/EventBridge/Kinesis)\n|Loose coupling between bounded contexts, async domain event publishing (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`), foundation for future bounded contexts\n\n|*Just-In-Time (JIT) Integration*\n|ProfileService → Salesforce Contact reconciliation\n|Reconcile app users as Salesforce Contacts on-demand (upsert by email), no pre-sync required, ensures Salesforce has current Contact data\n\n|*Async Processing*\n|EngagementService Case creation via Event Bus\n|Non-blocking user experience, resilience to Salesforce downtime, automatic retry with exponential backoff, dead letter queue for operations team intervention\n\n|*Strangler Fig*\n|Not applicable\n|Big bang cutover (no gradual migration) - D365 CE fully replaced, not incrementally strangled\n\n|===\n\n<<<\n== Solution Approach\n\n* Deploy xref:bounded-contexts:profile.adoc[ProfileService] and xref:bounded-contexts:engagement.adoc[EngagementService] as bounded context microservices\n* Implement Anti-Corruption Layers (ACLs) for Salesforce and Braze integration\n* Establish event-driven architecture as the foundational integration pattern\n* Big bang cutover (TS-1 → TS-4)\n\n=== Related Documentation\n\nThis solution architecture references detailed technical specifications:\n\n==== Architecture Definition\n\n* xref:architecture-definitions:salesforce_customer_support.adoc[Salesforce Customer Support - Architecture Definition] - Business requirements, architecture decisions (ADRs), bounded context definitions, high-level integration patterns\n\n==== Bounded Context Specifications\n\n* xref:bounded-contexts:profile.adoc[ProfileService Bounded Context] - JIT Contact reconciliation, aggregate definitions\n* xref:bounded-contexts:engagement.adoc[EngagementService Bounded Context] - Customer feedback facade, Anti-Corruption Layer\n\n==== Interface Specifications\n\nDetailed API specifications available in the specifications directory:\n\n* link:../../specifications/rest/profile-service-v1.yaml[ProfileService REST API v1] - OpenAPI 3.0 specification for `/profile/v1` endpoints (includes Salesforce Contact reconciliation `GET /contact-id`)\n* link:../../specifications/rest/engagement-service-v1.yaml[EngagementService REST API v1] - OpenAPI 3.0 specification for `/engagement/v1` endpoints (includes `POST /feedback`)\n* link:../../specifications/events/engagement-events.json[Engagement Domain Events] - CloudEvents 1.0 JSON Schema for `SupportCaseCreated`, `SupportCaseUpdated`, `SupportCaseResolved`, `CustomerFeedbackSubmitted`\n\n==== External System Documentation\n\n* https://developer.salesforce.com/docs/atlas.en-us.api_rest.meta/api_rest/[Salesforce REST API Documentation] - Contact and Case object APIs\n* https://www.braze.com/docs/api/endpoints/messaging/send_messages/post_send_triggered_campaigns/[Braze Campaign Trigger API] - Push notification campaigns\n\n<<<\n== Executive Summary\n\n=== Challenge\n\nOTR digital customers (Mobile App, Web) currently submit feedback and support requests to D365 Customer Engagement, while Viva Energy's broader business units (fuel wholesale, Shell Card customers, other retail channels) use Salesforce Service Cloud. This creates:\n\n* *Fragmented customer support platform*: Customer support data split across two systems, preventing support agents from having a unified view of customer interactions across all channels\n* *Operational inefficiency*: Maintaining two separate customer support platforms increases operational overhead and costs\n* *Poor support experience*: D365 CE is not working well for digital customer support, impacting customer satisfaction and case resolution times\n* *Post-merger consolidation opportunity*: Following Viva Energy's acquisition of OTR, strategic alignment on Salesforce as the enterprise customer support platform\n\n=== Solution\n\nThis architecture establishes the **foundational Domain-Driven Design (DDD) implementation** for OTR's target state architecture by introducing two new bounded contexts (link:../bounded_context/profile.adoc[ProfileService], link:../bounded_context/engagement.adoc[EngagementService]) and event-driven integration patterns:\n\n==== New Bounded Contexts\n\n* *link:../bounded_context/profile.adoc[ProfileService]* (NEW): Just-In-Time (JIT) Contact reconciliation with Salesforce, upsert by email, returns Salesforce Contact ID to Mobile App\n* *link:../bounded_context/engagement.adoc[EngagementService]* (NEW): Customer feedback submission, Anti-Corruption Layer (ACL) for Salesforce Case creation, Braze integration for all outbound customer communications (push, email, SMS), async Case processing via Event Bus\n* *Event Bus* (NEW pattern): Domain event publishing using existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis) - first implementation of event-driven architecture pattern\n\n==== Integration Architecture\n\n* *Salesforce = System of Record*: Salesforce Service Cloud (shared Viva Energy instance) owns Contact and Case data\n* *Conformist Pattern*: ProfileService and EngagementService conform to existing Salesforce configuration and API contracts\n* *Anti-Corruption Layer*: EngagementService protects digital channels from Salesforce API changes, translates between OTR domain language and Salesforce\n* *Async Case Creation*: Non-blocking user experience, resilience to Salesforce downtime, automatic retry with exponential backoff, dead letter queue for failed Cases\n* *Event-Driven Notifications*: Salesforce webhook → EngagementService → Braze for all customer communications (push, email, SMS) on Case status updates\n\n==== Migration Approach\n\n* *Contact Migration*: One-time migration from app-specific database → Salesforce (upsert with flexible matching by email/phone/VCI)\n* *No Case Migration*: Historical D365 CE Cases not migrated (fresh start in Salesforce)\n* *Big Bang Cutover*: Single deployment, no phased rollout or parallel run\n* *D365 CE Retirement*: Complete decommissioning of D365 Customer Engagement post-cutover\n\n=== Key Architectural Significance\n\nThis migration establishes the first implementation of OTR's target DDD architecture:\n\n* First bounded contexts implemented (ProfileService, EngagementService)\n* First event-driven domain event pattern (foundation for future bounded contexts)\n* Foundation for Flybuys integration (ProfileService Contact reconciliation reused)\n* Establishes integration patterns (Conformist, ACL, Event-Driven) for future services\n\n=== Success Criteria\n\n* All digital customer feedback routed to Salesforce Service Cloud within 30 days of launch\n* Support agents have unified customer view across all Viva Energy channels (digital, wholesale, Shell Card, other retail)\n* D365 Customer Engagement decommissioned within 90 days post-cutover\n* Customer satisfaction score improves by 15% within 6 months\n* Average case resolution time decreases by 20% within 6 months\n* Zero data loss during Contact migration (100% validation pass rate)\n* Mobile App feedback submission success rate > 99.5% (including async Case creation)\n\n=== Technical Constraints\n\n* Shared Salesforce instance (Viva Energy multi-tenant environment)\n* Conform to existing Salesforce configuration and governance (data isolation strategy TBD with Salesforce admin team)\n* Contact migration must complete before cutover (no parallel run)\n* Async Case creation mandatory (non-blocking user experience)\n* Expected volume: 100-150 feedback submissions/day from 20k DAU (~0.5-0.75% submission rate), architecture capacity planned for 3x-10x growth\n\n=== Open Technical Decisions (TBD)\n\n* Salesforce Case field mapping for digital feedback categories (App, Service, Order, Rewards, Refund, Delete Account)\n* Salesforce data isolation strategy (Record Types, custom fields, queues)\n* Salesforce REST API authentication method (OAuth 2.0, Connected App, JWT bearer flow)\n* Salesforce webhook mechanism for Case updates (Outbound Messages, Platform Events, Process Builder)\n* Retry policy configuration (attempts, backoff intervals)\n* Salesforce API rate limit strategy (expected volume: 100-150 submissions/day from 20k DAU, capacity planning for 3x-10x growth)\n\n== Technical Requirements\n\n[width=\"100%\",cols=\"8%,92%\",options=\"header\",]\n|===\n|ID |Description\n\n|TR-CS-001\n|Every Mobile App user must have a Salesforce Contact record in Salesforce Service Cloud (shared Viva Energy instance)\n\n|TR-CS-002\n|ProfileService must reconcile Mobile App users as Salesforce Contacts using Just-In-Time (JIT) upsert by email address\n\n|TR-CS-003\n|ProfileService must return Salesforce Contact ID to Mobile App for feedback submission\n\n|TR-CS-004\n|Mobile App must support customer feedback submission with fields: Category (App, Service, Order, Rewards, Refund, Delete Account), Store Name, Time of Visit, Contact Phone Number, Free Text Message\n\n|TR-CS-005\n|EngagementService must create Salesforce Cases asynchronously via Event Bus (non-blocking user experience)\n\n|TR-CS-006\n|EngagementService must acknowledge feedback submission immediately to Mobile App user (\"Feedback submitted\" confirmation)\n\n|TR-CS-007\n|EngagementService must send push notification to customer via Braze when Case is successfully created in Salesforce\n\n|TR-CS-008\n|EngagementService must retry failed Case creation with configurable exponential backoff and dead letter queue for operations team intervention\n\n|TR-CS-009\n|Salesforce must be the System of Record for Contact and Case data (no local persistence in ProfileService or EngagementService)\n\n|TR-CS-010\n|Contact migration from app-specific database to Salesforce must complete before Mobile App cutover (upsert with flexible matching by email/phone/VCI)\n\n|TR-CS-011\n|No Case migration from D365 Customer Engagement to Salesforce (fresh start, historical Cases not migrated)\n\n|TR-CS-012\n|EngagementService must publish domain events (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`) to Event Bus for consumption by other bounded contexts\n\n|TR-CS-013\n|EngagementService must receive Salesforce webhook notifications when Cases are updated/resolved by support agents\n\n|TR-CS-014\n|EngagementService must trigger Braze push notifications to customers when Cases are updated/resolved (via Salesforce webhook → EngagementService → Braze)\n\n|TR-CS-015\n|ProfileService and EngagementService must conform to existing Salesforce configuration and API contracts (Conformist pattern)\n\n|TR-CS-016\n|All changes must be communicated using event-driven architecture via Event Bus (using existing AWS infrastructure: SNS+SQS/EventBridge/Kinesis)\n\n|TR-CS-017\n|Mobile App feedback submission success rate must exceed 99.5% (including async Case creation completion)\n\n|TR-CS-018\n|Contact migration must achieve 100% validation pass rate (zero data loss)\n\n|TR-CS-019\n|D365 Customer Engagement must be fully decommissioned within 90 days post-cutover\n\n|===\n\n== Technical Architecture\n\n=== Technical Capability Requirements\n\n==== Requirements Traceability\n\n[width=\"100%\",cols=\"15%,50%,35%\",options=\"header\",]\n|===\n|Requirement ID |Requirement Summary |Architectural Building Blocks\n\n|TR-CS-001\n|Every Mobile App user must have Salesforce Contact record\n|ABB-CS-001 (ProfileService), ABB-CS-004 (Salesforce), ABB-CS-007 (Contact Migration Tool)\n\n|TR-CS-002\n|ProfileService JIT Contact reconciliation via upsert by email\n|ABB-CS-001 (ProfileService), ABB-CS-004 (Salesforce)\n\n|TR-CS-003\n|ProfileService returns Salesforce Contact ID to Mobile App\n|ABB-CS-001 (ProfileService), ABB-CS-006 (Mobile App)\n\n|TR-CS-004\n|Mobile App supports feedback submission with structured fields\n|ABB-CS-006 (Mobile App), ABB-CS-002 (EngagementService)\n\n|TR-CS-005\n|EngagementService creates Salesforce Cases asynchronously\n|ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus), ABB-CS-004 (Salesforce)\n\n|TR-CS-006\n|EngagementService immediate acknowledgment to Mobile App\n|ABB-CS-002 (EngagementService), ABB-CS-006 (Mobile App)\n\n|TR-CS-007\n|EngagementService sends push notification via Braze on Case creation\n|ABB-CS-002 (EngagementService), ABB-CS-005 (Braze)\n\n|TR-CS-008\n|EngagementService retry logic with exponential backoff and DLQ\n|ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus)\n\n|TR-CS-009\n|Salesforce is System of Record for Contact and Case data\n|ABB-CS-004 (Salesforce), ABB-CS-001 (ProfileService - stateless), ABB-CS-002 (EngagementService - stateless)\n\n|TR-CS-010\n|Contact migration before Mobile App cutover\n|ABB-CS-007 (Contact Migration Tool), ABB-CS-004 (Salesforce)\n\n|TR-CS-011\n|No Case migration from D365 CE (fresh start)\n|ABB-CS-004 (Salesforce) - no migration tooling required\n\n|TR-CS-012\n|EngagementService publishes domain events to Event Bus\n|ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus)\n\n|TR-CS-013\n|EngagementService receives Salesforce webhook notifications\n|ABB-CS-002 (EngagementService), ABB-CS-004 (Salesforce)\n\n|TR-CS-014\n|EngagementService triggers Braze notifications on Case updates\n|ABB-CS-002 (EngagementService), ABB-CS-004 (Salesforce), ABB-CS-005 (Braze)\n\n|TR-CS-015\n|ProfileService and EngagementService conform to Salesforce config\n|ABB-CS-001 (ProfileService), ABB-CS-002 (EngagementService), ABB-CS-004 (Salesforce)\n\n|TR-CS-016\n|Event-driven architecture via Event Bus\n|ABB-CS-003 (Event Bus), ABB-CS-002 (EngagementService)\n\n|TR-CS-017\n|Mobile App feedback submission success rate > 99.5%\n|ABB-CS-006 (Mobile App), ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus), ABB-CS-004 (Salesforce)\n\n|TR-CS-018\n|Contact migration 100% validation pass rate\n|ABB-CS-007 (Contact Migration Tool), ABB-CS-004 (Salesforce)\n\n|TR-CS-019\n|D365 CE decommissioned within 90 days post-cutover\n|All ABBs (replacement system operational)\n\n|===\n\n=== Service Catalogues\n\n==== Application Portfolio Catalogue\n\n[width=\"100%\",cols=\"20%,15%,15%,15%,35%\",options=\"header\",]\n|===\n|Application |Lifecycle State |Owner |Hosting Platform |Description\n\n|*ProfileService*\n|NEW\n|OTR Platform Team\n|AWS (TBD: Lambda/ECS/EKS)\n|JIT Contact reconciliation with Salesforce, returns Salesforce Contact ID, foundation for Flybuys integration\n\n|*EngagementService*\n|NEW\n|OTR Platform Team\n|AWS (TBD: Lambda/ECS/EKS)\n|Customer feedback submission facade, ACL for Salesforce Case creation, Braze integration for all outbound communications (push, email, SMS), webhook receiver\n\n|*Mobile App (iOS)*\n|ACTIVE (UPDATE)\n|OTR Mobile Team\n|Apple App Store\n|iOS native app with feedback form, integrate with ProfileService and EngagementService APIs\n\n|*Mobile App (Android)*\n|ACTIVE (UPDATE)\n|OTR Mobile Team\n|Google Play Store\n|Android native app with feedback form, integrate with ProfileService and EngagementService APIs\n\n|*Salesforce Service Cloud*\n|ACTIVE (EXPAND)\n|Viva Energy Salesforce Admin Team\n|Salesforce (SaaS)\n|Shared Viva Energy instance, System of Record for Contact and Case data, adding OTR digital customer support\n\n|*Braze*\n|ACTIVE (EXTEND)\n|OTR Marketing Team\n|Braze (SaaS)\n|Marketing automation platform, EngagementService triggers push notifications for Case updates\n\n|*D365 Customer Engagement*\n|RETIRE\n|OTR Support Team\n|Microsoft Azure (SaaS)\n|Legacy customer support platform, decommissioned within 90 days post-cutover\n\n|*App-Specific Customer Database*\n|RETIRE\n|OTR Platform Team\n|AWS (RDS/DynamoDB)\n|Legacy customer contact storage, one-time migration to Salesforce, then deprecated\n\n|*Event Bus*\n|NEW\n|OTR Platform Team\n|AWS (SNS+SQS/EventBridge/Kinesis)\n|Domain event publishing infrastructure for bounded context integration\n\n|*Contact Migration Tool*\n|TEMPORARY\n|OTR Platform Team\n|AWS (Script/Lambda)\n|One-time migration app database → Salesforce with upsert logic, retired after migration complete\n\n|===\n\n==== Technology Capability Requirements\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Technology Capability |Implementation Technology (TBD in detailed design) |Requirements\n\n|*Microservice Hosting*\n|AWS Lambda / ECS / EKS\n|Host ProfileService and EngagementService with auto-scaling, high availability, monitoring\n\n|*API Gateway*\n|AWS API Gateway / Application Load Balancer\n|REST API routing, authentication, rate limiting, request validation for ProfileService and EngagementService\n\n|*Event Bus*\n|AWS SNS+SQS / EventBridge / Kinesis\n|Domain event publishing, async message processing, retry logic, dead letter queue\n\n|*Salesforce Integration*\n|Salesforce REST API / SOAP API\n|Contact CRUD operations, Case creation, webhook notifications, OAuth 2.0 authentication\n\n|*Braze Integration*\n|Braze REST API / SDK\n|Push notification campaign triggers, customer profile reconciliation\n\n|*Authentication & Authorisation*\n|Microsoft Entra External ID / AWS Cognito\n|Mobile App user authentication, API authorisation, JWT token validation\n\n|*Observability & Monitoring*\n|AWS CloudWatch / Datadog / New Relic\n|Application metrics, logs, traces, dashboards, alerting (feedback submission rate, queue depth, API errors)\n\n|*Secret Management*\n|AWS Secrets Manager / Parameter Store\n|Salesforce credentials, Braze API keys, OAuth tokens, encryption keys\n\n|*Database (Migration Tool)*\n|AWS RDS / DynamoDB (read-only access)\n|Contact migration from app-specific database\n\n|*CI/CD Pipeline*\n|GitHub Actions / AWS CodePipeline\n|Automated build, test, deployment for ProfileService, EngagementService, Mobile App\n\n|*Infrastructure as Code*\n|Terraform / AWS CloudFormation / CDK\n|Declarative infrastructure provisioning for Event Bus, microservices, monitoring\n\n|*API Documentation*\n|OpenAPI / Swagger\n|ProfileService and EngagementService API specifications for Mobile App integration\n\n|===\n\n==== Feature Flag Register\n\n*Note*: Per ADR-CS-006 (big bang cutover, not phased rollout), feature flags are minimal and used primarily for emergency rollback/kill switches.\n\n[width=\"100%\",cols=\"20%,15%,35%,30%\",options=\"header\",]\n|===\n|Feature Flag |Default State |Purpose |Rollback Scenario\n\n|*enable_salesforce_feedback_submission*\n|OFF (pre-cutover), ON (post-cutover)\n|Enable/disable feedback submission to EngagementService → Salesforce (kill switch for emergency rollback to D365 CE)\n|Feedback submission success rate < 95%, Salesforce API failures, critical bugs - revert to D365 CE integration\n\n|*enable_async_case_creation*\n|ON\n|Enable/disable async Case creation via Event Bus (fallback to synchronous processing if Event Bus issues)\n|Event Bus infrastructure failures, queue backlog unmanageable - temporary synchronous processing\n\n|*enable_braze_notifications*\n|ON\n|Enable/disable Braze push notifications for Case updates (degrade gracefully if Braze integration fails)\n|Braze API failures, notification delivery rate < 80% - disable notifications temporarily\n\n|*enable_jit_contact_reconciliation*\n|ON\n|Enable/disable ProfileService JIT Contact reconciliation (fallback to cached Contact IDs if Salesforce unavailable)\n|Salesforce API downtime, Contact reconciliation failures > 5% - use cached Contact IDs temporarily\n\n|*enable_salesforce_webhook_processing*\n|ON\n|Enable/disable Salesforce webhook processing for Case updates (fallback to polling if webhook failures)\n|Webhook delivery failures, authentication issues - temporary polling fallback\n\n|===\n\n*Feature Flag Management*:\n\n* Feature flags managed via AWS AppConfig / LaunchDarkly / custom feature flag service (TBD in detailed design)\n* Mobile App feature flags controlled server-side (no app release required for flag changes)\n* Backend service feature flags configured via environment variables / configuration service\n* Feature flag changes logged and audited (who changed, when, reason)\n* Post-cutover monitoring: Gradual removal of feature flags once system stability confirmed (30-60 days)\n\n==== Data Entity Catalogue\n\n[width=\"100%\",cols=\"20%,15%,35%,30%\",options=\"header\",]\n|===\n|Data Entity |System of Record |Key Attributes |Lifecycle\n\n|*Contact*\n|Salesforce Service Cloud\n|• Contact ID (Salesforce 15/18-char ID) +\n• Email (primary matching key) +\n• First Name, Last Name +\n• Phone Number +\n• Viva Consumer ID (VCI) +\n• Account (Viva Energy customer account) +\n• Record Type (OTR Digital vs other channels)\n|Created: ProfileService JIT reconciliation or Contact Migration Tool +\nUpdated: ProfileService JIT upsert (email changes), Salesforce (manual updates by support agents) +\nDeleted: Salesforce retention policy (GDPR/compliance)\n\n|*Case*\n|Salesforce Service Cloud\n|• Case Number (Salesforce auto-generated) +\n• Contact ID (reference to Contact) +\n• Subject (derived from Category) +\n• Description (Free Text Message) +\n• Category (App, Service, Order, Rewards, Refund, Delete Account) +\n• Store Name (OTR location) +\n• Time of Visit +\n• Status (New, In Progress, Resolved, Closed) +\n• Priority, Origin (Mobile App) +\n• Owner (support agent/queue)\n|Created: EngagementService async Case creation +\nUpdated: Support agents (Salesforce UI), EngagementService (webhook processing) +\nDeleted: Salesforce retention policy (archive after X years)\n\n|*Feedback Submission (transient)*\n|None (not persisted)\n|• Salesforce Contact ID +\n• Category +\n• Store Name +\n• Time of Visit +\n• Contact Phone Number +\n• Free Text Message\n|Created: Mobile App user submission +\nProcessed: EngagementService publishes to Event Bus, Case created in Salesforce +\nNot persisted in ProfileService/EngagementService (stateless)\n\n|*Domain Events*\n|Event Bus (ephemeral)\n|**SupportCaseCreated**: +\n• Case Number, Contact ID, Category, Timestamp +\n**SupportCaseUpdated**: +\n• Case Number, Status, Updated By, Timestamp +\n**SupportCaseResolved**: +\n• Case Number, Resolution, Resolved By, Timestamp +\n**CustomerFeedbackSubmitted**: +\n• Contact ID, Category, Timestamp\n|Published: EngagementService +\nConsumed: Other bounded contexts (future), Braze notification triggers +\nRetention: Short-lived (minutes to hours), not persisted for event sourcing\n\n|*Braze Customer Profile*\n|Braze\n|• External User ID (VCI or Email) +\n• Push Notification Tokens (iOS/Android) +\n• Notification Preferences +\n• Campaign Engagement History\n|Created/Updated: EngagementService on Case creation/update +\nManaged: Braze (external SaaS)\n\n|===\n\n*Data Migration Entities*:\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Source Entity |Target Entity |Migration Strategy\n\n|*App Database Contact*\n|Salesforce Contact\n|One-time migration via Contact Migration Tool: +\n• Upsert by email (primary), phone (secondary), VCI (tertiary) +\n• Map: Email → Email, Name → First/Last Name, Phone → Phone, VCI → External ID +\n• Validation: 100% data integrity check, reconciliation report\n\n|*D365 CE Case*\n|Not migrated\n|ADR-CS-005: No Case migration (fresh start in Salesforce) +\nD365 CE Cases archived separately for compliance if needed\n\n|===\n\n==== Data Quality & Validation\n\n*Contact Migration Validation Rules*:\n\n* Email format validation (RFC 5322 compliance)\n* Phone number format validation (E.164 international format)\n* VCI format validation (alphanumeric, length constraints)\n* Duplicate detection: Flag potential duplicates for manual review (same email/phone combination)\n* Mandatory fields: Email (required), First Name, Last Name (required for Salesforce Contact)\n\n*Case Creation Validation Rules*:\n\n* Contact ID must exist in Salesforce (validated by EngagementService before Case creation)\n* Category must be one of: App, Service, Order, Rewards, Refund, Delete Account\n* Free Text Message maximum length: 32,000 characters (Salesforce Case Description limit)\n* Store Name validated against OTR location master data (optional - warn if not found)\n\n<<<\n== Solution Building Blocks\n\nThis section defines the specific technology products, configurations, and implementation details for each Solution Building Block (SBB).\n\n=== Technology Portfolio Catalogue\n\n[width=\"100%\",cols=\"10%,20%,25%,25%,20%\",options=\"header\",]\n|===\n|SBB ID |Component |Technology Product |Version/Configuration |Deployment Platform\n\n|SBB-CS-001\n|ProfileService Microservice\n|.NET 8 / Node.js 20 LTS\n|RESTful API, containerised\n|AWS ECS Fargate / Lambda\n\n|SBB-CS-002\n|EngagementService Microservice\n|.NET 8 / Node.js 20 LTS\n|RESTful API, containerised, async workers\n|AWS ECS Fargate / Lambda\n\n|SBB-CS-003\n|Event Bus\n|AWS SNS + SQS / EventBridge\n|Standard queues, FIFO for ordering\n|AWS (managed service)\n\n|SBB-CS-004\n|API Gateway\n|AWS API Gateway / ALB\n|REST API, JWT validation\n|AWS (managed service)\n\n|SBB-CS-005\n|Salesforce Integration Layer\n|Salesforce REST API Client\n|OAuth 2.0 JWT bearer flow\n|Embedded in SBB-CS-001/002\n\n|SBB-CS-006\n|Braze Integration Layer\n|Braze REST API SDK\n|API key authentication\n|Embedded in SBB-CS-002\n\n|SBB-CS-007\n|Contact Migration Tool\n|Python 3.11 / .NET 8\n|One-time batch script\n|AWS Lambda / EC2\n\n|SBB-CS-008\n|Application Monitoring\n|AWS CloudWatch / Datadog\n|Metrics, logs, traces, dashboards\n|AWS / SaaS\n\n|SBB-CS-009\n|Secret Management\n|AWS Secrets Manager\n|KMS encryption\n|AWS (managed service)\n\n|SBB-CS-010\n|Mobile App (iOS)\n|SwiftUI, Kotlin Multiplatform\n|iOS 15+\n|Apple App Store\n\n|SBB-CS-011\n|Mobile App (Android)\n|Jetpack Compose, Kotlin Multiplatform\n|Android 8+\n|Google Play Store\n\n|SBB-CS-012\n|Feature Flag Service\n|AWS AppConfig / LaunchDarkly\n|Server-side flags, real-time updates\n|AWS / SaaS\n\n|===\n\n<<<\n== Data Architecture\n\nThis section defines the physical data models, event schemas, and API request/response formats.\n\n=== Domain Event Schemas\n\nAll domain events follow the https://cloudevents.io/[CloudEvents 1.0] specification for consistency and interoperability.\n\n*Event Schema Specifications*: See // TODO: Add to Antora - specifications/events/engagement-events.json[Engagement Service Event Schemas] for complete JSON schemas and examples.\n\n==== Event Catalogue\n\n[width=\"100%\",cols=\"30%,20%,50%\",options=\"header\",]\n|===\n|Event Type |Publisher |Description\n\n|`SupportCaseCreated`\n|EngagementService\n|Published when EngagementService successfully creates a Case in Salesforce after async processing\n\n|`SupportCaseUpdated`\n|EngagementService (via Salesforce webhook)\n|Published when a support agent updates a Case in Salesforce (status, priority, comment changes)\n\n|`SupportCaseResolved`\n|EngagementService (via Salesforce webhook)\n|Published when a support agent resolves/closes a Case in Salesforce\n\n|`CustomerFeedbackSubmitted`\n|EngagementService\n|Published when customer submits feedback via Mobile App (before async Case creation)\n\n|===\n\n*Event Format*: All events use CloudEvents 1.0 envelope with event-specific payload in the `data` field.\n\n*Schema Location*: `specifications/events/engagement-events.json`\n\n=== API Request/Response Schemas\n\n==== ProfileService: GET /profile/contact-id\n\n*Response* (200 OK):\n[source,json]\n----\n{\n  \"contactId\": \"0034X00000ABCDEFG\",\n  \"email\": \"customer@example.com\",\n  \"firstName\": \"John\",\n  \"lastName\": \"Smith\"\n}\n----\n\n==== EngagementService: POST /feedback\n\n*Request*:\n[source,json]\n----\n{\n  \"contactId\": \"0034X00000ABCDEFG\",\n  \"category\": \"App\",\n  \"storeName\": \"OTR Adelaide\",\n  \"timeOfVisit\": \"2026-01-07T12:00:00Z\",\n  \"contactPhoneNumber\": \"+61412345678\",\n  \"message\": \"App crashed when submitting feedback\"\n}\n----\n\n*Response* (202 Accepted):\n[source,json]\n----\n{\n  \"feedbackId\": \"fb-2026-01-07-12345\",\n  \"status\": \"submitted\",\n  \"message\": \"Your feedback has been submitted!\"\n}\n----\n\n=== Salesforce Field Mappings\n\n==== Case Object Mapping\n\n[width=\"100%\",cols=\"25%,25%,25%,25%\",options=\"header\",]\n|===\n|OTR Field |Salesforce Field |Data Type |Notes\n\n|Category\n|Feedback_Category__c\n|Picklist\n|App, Service, Order, Rewards, Refund, Delete Account\n\n|Store Name\n|Store_Name__c\n|String (255)\n|OTR location name\n\n|Time of Visit\n|Time_of_Visit__c\n|DateTime\n|When customer visited store\n\n|Free Text Message\n|Description\n|Long Text (32,000)\n|Customer feedback message\n\n|===\n\n<<<\n=== Baseline Architecture\n\n==== Existing System Components\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Component |Current State |Status\n\n|*D365 Customer Engagement*\n|Customer support platform for OTR digital customers (Mobile App, Web), handles feedback submission and case management\n|**DEPRECATED** - Being replaced by Salesforce Service Cloud\n\n|*App-Specific Customer Database*\n|Stores customer contact data for Mobile App users, separate from Viva Energy systems\n|**MIGRATING** - One-time migration to Salesforce, then deprecated\n\n|*Mobile App*\n|iOS/Android native apps with feedback submission form including Category, Store Name, Time of Visit, Contact Phone Number, and Free Text Message fields\n|**REQUIRES UPDATE** - Integrate with ProfileService and EngagementService APIs (feedback form UI already complete)\n\n|*Salesforce Service Cloud*\n|Shared Viva Energy instance handling customer support for fuel wholesale, Shell Card customers, other retail channels\n|**EXPANDING** - Adding OTR digital customer support Cases and Contacts\n\n|*Existing AWS Infrastructure*\n|SNS+SQS / EventBridge / Kinesis available for event-driven architecture\n|**REUSING** - Event Bus implementation leverages existing infrastructure\n\n|===\n\n==== Integration Architecture\n\n*Current state:*\n\n* Mobile App → D365 Customer Engagement (direct integration)\n* App-specific customer database → standalone (no Salesforce integration)\n* No event-driven architecture (synchronous, tightly coupled)\n* No Anti-Corruption Layer protecting digital channels\n* Viva Energy support teams use Salesforce, OTR digital support uses D365 CE (fragmented)\n\n==== Technical Debt\n\n*No longer relevant* - D365 CE being deprecated, not documenting technical debt of system being retired.\n\n*New technical debt introduced by this migration:*\n\n* Salesforce field mapping TBD (requires coordination with Viva Energy Salesforce admin team)\n* Data isolation strategy TBD (Record Types, custom fields, queues - multi-tenant governance)\n* Salesforce webhook mechanism TBD (Outbound Messages vs Platform Events vs Process Builder)\n* Expected feedback volume unknown (gathering data for rate limit planning)\n\n=== Gap Analysis\n\n==== Missing Capabilities\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Missing Capability |Description\n\n|*ProfileService bounded context*\n|No existing service for Contact reconciliation with Salesforce - requires new microservice implementing JIT upsert by email, returning Salesforce Contact ID\n\n|*EngagementService bounded context*\n|No existing service for customer feedback facade - requires new microservice implementing Anti-Corruption Layer for Salesforce Case creation, Braze integration, async processing via Event Bus\n\n|*Event Bus domain event pattern*\n|No existing domain event publishing infrastructure - requires implementing event-driven architecture pattern using existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis)\n\n|*Async Case creation workflow*\n|Current D365 CE integration is synchronous - requires implementing async processing with retry logic, exponential backoff, dead letter queue\n\n|*Salesforce webhook integration*\n|No existing capability to receive Salesforce notifications - requires implementing webhook receiver in EngagementService for Case update notifications\n\n|*Braze push notification orchestration*\n|No existing integration for Case-related push notifications - requires implementing Braze campaign triggers from EngagementService\n\n|*Contact migration tooling*\n|No existing tooling for app database → Salesforce Contact migration with upsert logic (match by email/phone/VCI)\n\n|*Feedback form enhancements*\n|Mobile App feedback form lacks structured fields (Category, Store Name, Time of Visit, Contact Phone Number) - requires UI updates\n\n|===\n\n==== Missing Bounded Contexts\n\n[width=\"100%\",cols=\"30%,30%,40%\",options=\"header\",]\n|===\n|Bounded Context |Responsibilities |Implementation Status\n\n|*link:../bounded_context/profile.adoc[ProfileService]*\n|JIT Contact reconciliation with Salesforce (upsert by email), return Salesforce Contact ID to digital channels, foundation for future Flybuys partner linking\n|**NEW** - First bounded context implementation\n\n|*link:../bounded_context/engagement.adoc[EngagementService]*\n|Customer feedback submission facade, Anti-Corruption Layer for Salesforce Case creation, Braze integration for push notifications, async Case processing, webhook receiver for Case updates\n|**NEW** - First bounded context implementation\n\n|===\n\n==== Missing Integration Patterns\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Integration Pattern |Description\n\n|*Anti-Corruption Layer (ACL)*\n|EngagementService → Salesforce Service Cloud - protects digital channels from Salesforce API changes, translates between OTR domain language and Salesforce\n\n|*Conformist*\n|ProfileService/EngagementService → Salesforce - conform to existing Salesforce configuration and API contracts (shared Viva Energy instance)\n\n|*Event-Driven Architecture (OHS+PL)*\n|Event Bus publishing domain events (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`) for loose coupling between bounded contexts\n\n|*Just-In-Time (JIT) Integration*\n|ProfileService → Salesforce Contact reconciliation on-demand (no pre-sync)\n\n|*Async Processing*\n|EngagementService Case creation via Event Bus with retry, exponential backoff, dead letter queue\n\n|===\n\n=== Target State Architecture\n\n==== Architectural Building Blocks (ABB)\n\n[width=\"100%\",cols=\"20%,25%,30%,25%\",options=\"header\",]\n|===\n|ABB ID |Bounded Context |Responsibilities |Technology (TBD in Solution Architecture)\n\n|ABB-CS-001\n|*link:../bounded_context/profile.adoc[ProfileService]*\n|JIT Contact reconciliation with Salesforce (upsert by email), return Salesforce Contact ID, foundation for Flybuys partner linking\n|Microservice (.NET/Node.js), REST API, Salesforce REST API client\n\n|ABB-CS-002\n|*link:../bounded_context/engagement.adoc[EngagementService]*\n|Customer feedback submission facade, ACL for Salesforce Case creation, Braze integration, async processing, webhook receiver\n|Microservice (.NET/Node.js), REST API, Event Bus publisher/subscriber, Salesforce webhook receiver\n\n|ABB-CS-003\n|*Event Bus*\n|Domain event publishing infrastructure (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`)\n|AWS SNS+SQS / EventBridge / Kinesis\n\n|ABB-CS-004\n|*Salesforce Service Cloud*\n|System of Record for Contact and Case data (shared Viva Energy instance)\n|Salesforce Service Cloud (external SaaS)\n\n|ABB-CS-005\n|*Braze*\n|Marketing automation platform for push notifications\n|Braze (external SaaS) - existing integration\n\n|ABB-CS-006\n|*Mobile App*\n|iOS/Android native apps with enhanced feedback form (Category, Store Name, Time of Visit, Contact Phone Number, Free Text Message)\n|Kotlin Multiplatform, SwiftUI, Jetpack Compose\n\n|ABB-CS-007\n|*Contact Migration Tool*\n|One-time migration app database → Salesforce with upsert logic (match by email/phone/VCI)\n|Script/tool (.NET/Python/Node.js)\n\n|===\n\n==== Integration Architecture\n\n===== Integration Flows\n\n*Customer Feedback Submission (Async):*\n\n1. *Mobile App* → ProfileService: Authenticate user, get Salesforce Contact ID (JIT reconciliation)\n2. *Mobile App* → EngagementService: Submit feedback (POST /feedback with Contact ID, Category, Store Name, Time of Visit, Phone, Message)\n3. *EngagementService* → Mobile App: Immediate acknowledgment (\"Feedback submitted\")\n4. *EngagementService* → Event Bus: Publish work item for async Case creation\n5. *Background Worker* (EngagementService) → Salesforce: Create Case via REST API\n6. *Success*: EngagementService → Event Bus: Publish `SupportCaseCreated` event\n7. *EngagementService* → Braze: Trigger push notification campaign (\"Your feedback has been received, Case #12345\")\n8. *Failure*: Retry with exponential backoff → Dead Letter Queue → Ops team alert\n\n*Case Update Notification (Bidirectional):*\n\n1. *Support Agent* updates/resolves Case in Salesforce\n2. *Salesforce* → EngagementService: Webhook notification (Case updated)\n3. *EngagementService* → Event Bus: Publish `SupportCaseUpdated` or `SupportCaseResolved` event\n4. *EngagementService* → Braze: Trigger push notification campaign (\"Your case has been resolved\")\n\n*Contact Reconciliation (JIT):*\n\n1. *Mobile App user* authenticates\n2. *Mobile App* → ProfileService: GET /profile/contact-id\n3. *ProfileService* → Salesforce: Query Contact by email\n4. *Match found*: Return existing Salesforce Contact ID\n5. *No match*: Create new Contact in Salesforce, return new Contact ID\n6. *ProfileService* → Mobile App: Return Salesforce Contact ID (cached by Mobile App)\n\n===== System of Record Boundaries\n\n[width=\"100%\",cols=\"30%,35%,35%\",options=\"header\",]\n|===\n|Data Entity |System of Record |Rationale\n\n|*Contact*\n|Salesforce Service Cloud\n|Shared Viva Energy instance, unified customer profile across all channels (digital, wholesale, Shell Card, retail)\n\n|*Case*\n|Salesforce Service Cloud\n|Support agents manage Cases in Salesforce, digital channels submit via EngagementService ACL\n\n|*Feedback Submission (transient)*\n|None (no persistence)\n|EngagementService processes feedback and creates Case in Salesforce, no local storage\n\n|*Domain Events*\n|Event Bus (ephemeral)\n|Events published to Event Bus, consumed by subscribers, not persisted long-term (event sourcing not in scope)\n\n|===\n\n==== Data Architecture Principles\n\n===== Aggregate Persistence\n\n*ProfileService:*\n\n* **No local aggregate persistence** - ProfileService is stateless, queries Salesforce on-demand\n* Salesforce Contact is the aggregate root (owned by Salesforce)\n* ProfileService acts as facade/translator, not system of record\n\n*EngagementService:*\n\n* **No local aggregate persistence** - EngagementService is stateless, creates Cases in Salesforce via ACL\n* Salesforce Case is the aggregate root (owned by Salesforce)\n* EngagementService maintains no local Case state (Conformist pattern - trust Salesforce as source of truth)\n* Async processing state managed via Event Bus (work items in queue, not database)\n\n===== Event Store\n\n* **Event Bus** (SNS+SQS/EventBridge/Kinesis) handles domain event publishing\n* Events are **ephemeral** (consumed and discarded, not persisted for event sourcing)\n* No Event Store implementation in this architecture (future enhancement if needed)\n* Event schema versioning TBD in Solution Architecture\n\n\n=== Architecture Decisions\n\n==== ADR-CS-001: Consolidate onto Salesforce Service Cloud (not build custom solution)\n\n*Status*: Accepted\n\n*Context*:\n\n* D365 Customer Engagement not working well for digital customer support\n* Viva Energy already uses Salesforce Service Cloud for fuel wholesale, Shell Card, other retail channels\n* Post-merger opportunity to consolidate onto single platform\n* Alternative: Build custom support platform or use different SaaS\n\n*Decision*:\n\nConsolidate OTR digital customer support onto Salesforce Service Cloud (shared Viva Energy instance).\n\n*Rationale*:\n\n* **Unified customer view**: Support agents see all interactions across channels (digital, wholesale, Shell Card, retail)\n* **Platform consolidation**: Single support platform reduces operational overhead and costs\n* **Proven solution**: Salesforce Service Cloud is established, feature-rich, well-supported\n* **Post-merger alignment**: Strategic decision to standardize on Viva Energy platforms\n* **Avoid custom development**: Building custom support platform would be costly and high-risk\n\n*Consequences*:\n\n* Unified customer support across Viva Energy Group\n* Reduced operational complexity (single platform vs two)\n* Leverage Salesforce capabilities (case routing, knowledge base, AI, omnichannel)\n* ⚠️ Conformist pattern required (shared instance, conform to existing configuration)\n* ⚠️ Multi-tenant governance needed (data isolation, security, queues)\n* ❌ Less control over platform evolution (SaaS vendor, shared instance)\n\n==== ADR-CS-002: Implement ProfileService and EngagementService as first DDD bounded contexts\n\n*Status*: Accepted\n\n*Context*:\n\n* OTR target architecture uses Domain-Driven Design with bounded contexts\n* This migration is opportunity to establish first implementation\n* Alternative: Direct Mobile App → Salesforce integration (no bounded contexts)\n* Alternative: Single monolithic service for all customer-facing APIs\n\n*Decision*:\n\nImplement ProfileService and EngagementService as separate bounded contexts following DDD strategic patterns.\n\n*Rationale*:\n\n* **Foundation for target architecture**: First implementation of DDD pattern for future bounded contexts (Flybuys, LocationService, PaymentService)\n* **Separation of concerns**: ProfileService handles identity/Contact reconciliation, EngagementService handles support/feedback (different responsibilities, different change rates)\n* **Anti-Corruption Layer**: EngagementService protects digital channels from Salesforce API changes\n* **Reusability**: ProfileService Contact reconciliation reused for Flybuys integration\n* **Event-driven architecture**: Establishes pattern for loose coupling between bounded contexts\n\n*Consequences*:\n\n* Establishes DDD architecture foundation for OTR\n* Reusable ProfileService for Flybuys and future integrations\n* Digital channels protected from Salesforce API changes (ACL)\n* Clear bounded context boundaries and responsibilities\n* ⚠️ Increased initial complexity (two new microservices vs direct integration)\n* ⚠️ Requires Event Bus infrastructure implementation\n* ⚠️ Team must learn DDD patterns and bounded context design\n\n==== ADR-CS-003: Async Case creation via Event Bus (not synchronous)\n\n*Status*: Accepted\n\n*Context*:\n\n* Current D365 CE integration is synchronous (user waits for Case creation)\n* Alternative: Keep synchronous integration (Mobile App → EngagementService → Salesforce synchronously)\n* Salesforce API may experience downtime or latency\n\n*Decision*:\n\nImplement async Case creation via Event Bus with immediate user acknowledgment, retry logic, exponential backoff, and dead letter queue.\n\n*Rationale*:\n\n* **Non-blocking user experience**: User gets immediate \"Feedback submitted\" confirmation, not waiting for Salesforce API\n* **Resilience**: If Salesforce is down, feedback still accepted, Case created when Salesforce recovers\n* **Retry logic**: Automatic retry with exponential backoff handles transient failures\n* **Operational visibility**: Dead letter queue alerts ops team to persistent failures\n* **Scalability**: Queue buffering handles traffic spikes\n\n*Consequences*:\n\n* Better user experience (no waiting for Salesforce API)\n* Resilient to Salesforce downtime (queue buffers work)\n* Automatic retry reduces manual intervention\n* Queue depth monitoring provides operational visibility\n* ⚠️ Eventual consistency (user gets success notification after Case created, not immediately)\n* ⚠️ Increased complexity (Event Bus, background workers, retry logic, DLQ)\n* ⚠️ Requires monitoring and alerting for DLQ\n\n==== ADR-CS-004: ProfileService uses email as primary matching key (not VCI)\n\n*Status*: Accepted\n\n*Context*:\n\n* ProfileService needs to reconcile Mobile App users as Salesforce Contacts\n* Alternative matching keys: VCI (Viva Consumer ID), email, phone, Salesforce External ID\n* Email changes are rare but possible\n\n*Decision*:\n\nUse email address as primary matching key for Contact reconciliation (JIT upsert by email).\n\n*Rationale*:\n\n* **Availability**: Email always available for authenticated users\n* **Uniqueness**: Email is unique identifier in Salesforce and Mobile App\n* **Salesforce standard**: Salesforce Contact uses email as standard lookup field\n* **Simplicity**: Single matching key simplifies upsert logic\n* **Edge case acceptable**: Email changes are rare, manual cleanup acceptable\n\n*Consequences*:\n\n* Simple upsert logic (query by email, create if not found)\n* Leverages Salesforce standard email field\n* Email always available from authentication\n* ⚠️ Email changes create duplicate Contacts (rare edge case, manual cleanup)\n* ⚠️ Future enhancement: Add VCI as Salesforce External ID for stable matching\n\n==== ADR-CS-005: No Case migration from D365 CE (fresh start)\n\n*Status*: Accepted\n\n*Context*:\n\n* D365 CE contains historical customer support Cases\n* Alternative: Migrate historical Cases to Salesforce (preserve support history)\n* Alternative: Archive D365 CE Cases separately (read-only access)\n\n*Decision*:\n\nDo not migrate historical Cases from D365 CE to Salesforce. Start fresh in Salesforce.\n\n*Rationale*:\n\n* **Limited value**: Historical D365 CE Cases not critical for future support\n* **Data quality**: D365 CE Case data may be inconsistent or incomplete\n* **Complexity**: Case migration requires mapping D365 CE schema to Salesforce, data transformation, validation\n* **Cost-benefit**: Migration effort outweighs value of historical data\n* **Archive option**: D365 CE Cases can be archived separately if needed (read-only access for auditing)\n\n*Consequences*:\n\n* Simpler migration (Contacts only, no Case migration)\n* Faster time to value (no Case migration delay)\n* Clean start in Salesforce (no legacy data quality issues)\n* ⚠️ Historical Cases not visible in Salesforce (support agents can't see old Cases)\n* ⚠️ D365 CE must remain accessible temporarily for historical Case lookups (if needed)\n* ❌ Loss of historical Case insights (reporting, analytics on old Cases)\n\n==== ADR-CS-006: Big bang cutover (not phased rollout)\n\n*Status*: Accepted\n\n*Context*:\n\n* Alternative: Phased rollout with feature flags (pilot users first, gradual enablement)\n* Alternative: Parallel run (submit to both D365 CE and Salesforce temporarily)\n* Flybuys integration uses phased rollout (AS-1, AS-2, AS-3 architecture states)\n\n*Decision*:\n\nBig bang cutover - migrate Contacts, deploy ProfileService and EngagementService, switch Mobile App, retire D365 CE.\n\n*Rationale*:\n\n* **Simplicity**: No parallel run complexity, no feature flag management\n* **Faster D365 CE retirement**: No extended transition period maintaining two systems\n* **Limited risk**: Customer support not mission-critical (not payment processing), rollback possible\n* **User base manageable**: OTR digital customers smaller than Flybuys integration scope\n* **Different use case**: Flybuys phased rollout manages points accrual complexity, support feedback is simpler\n\n*Consequences*:\n\n* Simpler deployment (single cutover, no AS-1/AS-2/AS-3 states)\n* Faster D365 CE retirement (no extended parallel run)\n* No feature flag complexity or pilot user management\n* ⚠️ Higher cutover risk (all users switch at once)\n* ⚠️ Requires comprehensive testing before cutover\n* ⚠️ Rollback plan required (revert to D365 CE if critical issues)\n\n==== ADR-CS-007: EngagementService receives Salesforce webhooks for Case updates\n\n*Status*: Accepted\n\n*Context*:\n\n* Support agents update/resolve Cases in Salesforce\n* Need to notify customers of Case status changes via push notifications\n* Alternative: Poll Salesforce API for Case updates (inefficient)\n* Alternative: No customer notifications (agents contact customers directly)\n\n*Decision*:\n\nSalesforce sends webhook notifications to EngagementService when Cases are updated/resolved. EngagementService triggers Braze push notifications.\n\n*Rationale*:\n\n* **Real-time notifications**: Customer notified immediately when agent resolves Case\n* **Efficient**: Webhook push model (not polling)\n* **Event-driven**: Aligns with event-driven architecture pattern\n* **Better customer experience**: Proactive notification vs waiting for agent contact\n\n*Consequences*:\n\n* Real-time customer notifications for Case updates\n* Efficient push model (no polling overhead)\n* Bidirectional integration (Mobile App → Salesforce → Mobile App)\n* ⚠️ Salesforce webhook mechanism TBD (Outbound Messages vs Platform Events vs Process Builder)\n* ⚠️ Webhook authentication and security required\n* ⚠️ EngagementService must handle webhook retries and failures\n\n<<<\n== Interface Specifications\n\nThis section provides references to the complete API specifications and event catalogue for ProfileService and EngagementService.\n\n=== REST API Specifications\n\nComplete OpenAPI 3.0 specifications are maintained in the `specifications/rest/` directory:\n\n==== ProfileService API v1\n\n*Specification*: link:../../specifications/rest/profile-service-v1.yaml[profile-service-v1.yaml]\n\n*Base URL*: `https://api.otr.com.au/profile/v1`\n\n*Authentication*: Bearer token (Microsoft Entra External ID JWT)\n\n*Key Endpoints*:\n\n* `GET /contact-id` - Retrieve or create Salesforce Contact ID for authenticated user (Just-In-Time reconciliation)\n** Used by Mobile App before submitting feedback to EngagementService\n** Upserts Salesforce Contact record using email as external key\n** Returns 18-character Salesforce Contact ID with caching (15-minute TTL)\n** Performance SLA: p95 < 300ms (uncached), p95 < 50ms (cached)\n\n==== EngagementService API v1\n\n*Specification*: link:../../specifications/rest/engagement-service-v1.yaml[engagement-service-v1.yaml]\n\n*Base URL*: `https://api.otr.com.au/engagement/v1`\n\n*Authentication*: Bearer token (Microsoft Entra External ID JWT)\n\n*Key Endpoints*:\n\n* `POST /feedback` - Submit customer feedback for async Case creation in Salesforce\n** Accepts contactId, category, storeName, timeOfVisit, contactPhoneNumber, message\n** Returns 202 Accepted immediately (async Case creation in background)\n** Publishes `CustomerFeedbackSubmitted` event for analytics\n** Creates Salesforce Case via Anti-Corruption Layer with retry logic\n** Performance SLA: p95 < 200ms (feedback accepted, not Case creation)\n\n=== Domain Events (AsyncAPI)\n\nComplete CloudEvents 1.0 JSON Schema specifications are maintained in the `specifications/events/` directory:\n\n*Specification*: link:../../specifications/events/engagement-events.json[engagement-events.json]\n\n==== Event Catalogue\n\n[width=\"100%\",cols=\"30%,20%,50%\",options=\"header\",]\n|===\n|Event Type |Publisher |Consumers\n\n|`CustomerFeedbackSubmitted`\n|EngagementService\n|Future bounded contexts, analytics, sentiment analysis\n\n|`SupportCaseCreated`\n|EngagementService\n|Future bounded contexts, analytics\n\n|`SupportCaseUpdated`\n|EngagementService (via Salesforce webhook)\n|Future bounded contexts, analytics\n\n|`SupportCaseResolved`\n|EngagementService (via Salesforce webhook)\n|Future bounded contexts, analytics\n\n|===\n\n==== Event Delivery Guarantees\n\n* **At-least-once delivery**: Events may be delivered multiple times, consumers must handle idempotency\n* **Ordering**: FIFO queues guarantee ordering for events with same `contactId`\n* **Retention**: 4 days (96 hours) in Event Bus\n* **Dead Letter Queue**: Failed events after 5 retries moved to DLQ for manual intervention\n* **Format**: CloudEvents 1.0 specification with JSON payload\n\n=== API Versioning Policy\n\n==== Version Numbering\n\n* **Format**: `/v{major}` in URL path (e.g., `/profile/v1`, `/engagement/v1`)\n* **Semantic Versioning**: Major version incremented for breaking changes only\n* **Backwards Compatibility**: Minor changes (new optional fields, new endpoints) don't require version bump\n\n==== When to Version\n\n*Breaking changes requiring new major version*:\n\n- Removing or renaming fields in request/response\n- Changing field data types (e.g., string → number)\n- Changing authentication mechanism\n- Removing endpoints\n\n*Non-breaking changes not requiring version bump*:\n\n- Adding new optional fields to request/response\n- Adding new endpoints\n- Expanding enum values (e.g., adding new feedback category)\n- Improving error messages\n\n==== Parallel Version Support\n\n* Support N and N-1 versions concurrently for 6 months\n* Deprecation notice: 3 months before sunsetting old version\n* Mobile App must upgrade to new version within deprecation window\n\n<<<\n== Work Packages\n\nThis section consolidates gaps and activities into implementable work packages aligned with TOGAF Phase E requirements.\n\n=== Work Package Overview\n\n[width=\"100%\",cols=\"15%,35%,25%,25%\",options=\"header\",]\n|===\n|Work Package ID |Name |Transition State |Key Deliverables\n\n|WP-CS-001\n|ProfileService Development\n|TS-1 (Build & Test)\n|ProfileService microservice, Salesforce Contact integration, REST API\n\n|WP-CS-002\n|EngagementService Development\n|TS-1 (Build & Test)\n|EngagementService microservice, Anti-Corruption Layer, Braze integration\n\n|WP-CS-003\n|Event Bus Infrastructure\n|TS-1 (Build & Test)\n|Event Bus configuration, CloudEvents schemas, monitoring\n\n|WP-CS-004\n|Contact Migration Tooling\n|TS-1 (Build & Test)\n|Migration tool, validation scripts, reconciliation reporting\n\n|WP-CS-005\n|Mobile App Integration\n|TS-1 (Build & Test)\n|Mobile App API integration, feedback form enhancements, testing\n\n|WP-CS-006\n|Integration Testing\n|TS-1 (Build & Test)\n|Test environments, integration test suites, UAT execution\n\n|WP-CS-007\n|Salesforce Configuration\n|TS-1 (Build & Test)\n|Salesforce field mapping, data isolation, webhook configuration\n\n|WP-CS-008\n|Contact Data Migration\n|TS-2 (Contact Migration)\n|Contact migration execution, validation, reconciliation\n\n|WP-CS-009\n|Production Deployment\n|TS-3 (Cutover)\n|Production deployment, smoke testing, go-live execution\n\n|WP-CS-010\n|Post-Cutover Support\n|TS-4 (Target State)\n|Monitoring, issue resolution, D365 CE retirement\n\n|===\n\n[[wp-cs-001]]\n=== WP-CS-001: ProfileService Development\n\n==== Description\n\nBuild ProfileService bounded context microservice implementing Just-In-Time Contact reconciliation with Salesforce Service Cloud.\n\n==== Deliverables\n\n* ProfileService microservice application\n** REST API implementation (OpenAPI 3.0 specification)\n** `GET /contact-id` endpoint (Salesforce Contact reconciliation)\n** Authentication/authorization with Microsoft Entra External ID\n** Caching layer (15-minute TTL for Contact IDs)\n* Salesforce integration\n** Salesforce REST API client\n** Contact upsert by email (external key matching)\n** Error handling and retry logic\n* Unit tests (>80% code coverage)\n* Integration tests with Salesforce sandbox\n* API documentation\n* Deployment configuration (IaC - Infrastructure as Code)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* Salesforce sandbox environment provisioned\n* Microsoft Entra External ID OAuth configuration\n* Development environment setup (AWS dev account, CI/CD pipeline)\n\n*Dependent Work Packages*:\n\n* None (can start immediately after prerequisites met)\n\n==== Skills Required\n\n* Backend development (.NET Core or Node.js)\n* REST API design and implementation\n* Salesforce REST API integration\n* OAuth 2.0 / JWT authentication\n* Caching strategies (Redis/ElastiCache)\n* Unit/integration testing frameworks\n* Infrastructure as Code (Terraform/CloudFormation)\n\n==== Acceptance Criteria\n\n* All API endpoints return correct HTTP status codes per OpenAPI specification\n* Contact ID retrieval achieves p95 < 300ms (uncached), p95 < 50ms (cached)\n* Salesforce Contact upsert succeeds with 100% accuracy in sandbox testing\n* Unit test coverage > 80%\n* Integration tests pass in sandbox environment\n* API documentation generated from OpenAPI specification\n\n[[wp-cs-002]]\n=== WP-CS-002: EngagementService Development\n\n==== Description\n\nBuild EngagementService bounded context microservice implementing customer feedback submission, Anti-Corruption Layer for Salesforce Case creation, Braze integration, and webhook receiver for Case updates.\n\n==== Deliverables\n\n* EngagementService microservice application\n** REST API implementation (OpenAPI 3.0 specification)\n** `POST /feedback` endpoint (async feedback submission)\n** Authentication/authorization with Microsoft Entra External ID\n** Webhook receiver endpoint for Salesforce Case updates\n* Anti-Corruption Layer (ACL)\n** OTR domain model to Salesforce API translation\n** Category enum mapping (App/Service/Order/Rewards → Salesforce Case fields)\n** Salesforce REST API client for Case creation\n* Async processing infrastructure\n** Event Bus publisher integration\n** Background worker for Case creation\n** Retry logic with exponential backoff (5 attempts)\n** Dead Letter Queue integration\n* Braze integration\n** Braze campaign trigger API client\n** Push notification orchestration for Case updates\n* Domain event publishing\n** `CustomerFeedbackSubmitted` event publisher\n** `SupportCaseCreated` event publisher\n** `SupportCaseUpdated` event translator (Salesforce webhook → domain event)\n** `SupportCaseResolved` event translator (Salesforce webhook → domain event)\n* Unit tests (>80% code coverage)\n* Integration tests (EngagementService ↔ Salesforce, EngagementService ↔ Braze)\n* API documentation\n* Deployment configuration (IaC)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* <<wp-cs-003,WP-CS-003>> (Event Bus Infrastructure) completed\n* Salesforce sandbox environment provisioned\n* Braze API credentials and campaign templates configured\n* Microsoft Entra External ID OAuth configuration\n\n*Dependent Work Packages*:\n\n* <<wp-cs-003,WP-CS-003>> must be completed first (Event Bus required for async processing)\n* <<wp-cs-007,WP-CS-007>> (Salesforce Configuration) must be in progress (field mapping needed)\n\n==== Skills Required\n\n* Backend development (.NET Core or Node.js)\n* REST API design and implementation\n* Salesforce REST API integration\n* Event-driven architecture patterns\n* Async/background processing (queues, workers)\n* Braze API integration\n* Webhook design and security\n* OAuth 2.0 / JWT authentication\n* Domain-Driven Design (DDD) - Anti-Corruption Layer pattern\n* Unit/integration testing frameworks\n* Infrastructure as Code (Terraform/CloudFormation)\n\n==== Acceptance Criteria\n\n* Feedback submission endpoint returns 202 Accepted within p95 < 200ms\n* Async Case creation succeeds with >99.5% success rate (including retries)\n* Anti-Corruption Layer correctly maps all feedback categories to Salesforce Case fields\n* Webhook receiver processes Salesforce Case updates and publishes domain events\n* Braze push notifications sent successfully for Case updates\n* Failed Case creation moves to Dead Letter Queue after 5 retry attempts\n* Unit test coverage > 80%\n* Integration tests pass with Salesforce sandbox and Braze staging environment\n\n[[wp-cs-003]]\n=== WP-CS-003: Event Bus Infrastructure\n\n==== Description\n\nImplement Event Bus infrastructure for domain event publishing using existing AWS infrastructure (SNS+SQS, EventBridge, or Kinesis).\n\n==== Deliverables\n\n* Event Bus infrastructure configuration\n** Topic/stream provisioning (technology choice: SNS+SQS / EventBridge / Kinesis)\n** FIFO queue configuration (ordering by `contactId`)\n** Dead Letter Queue (DLQ) setup\n** Retention policy (4 days / 96 hours)\n** Access control policies (IAM roles, permissions)\n* CloudEvents 1.0 schema definitions\n** JSON Schema specifications for all domain events\n** Schema validation configuration\n** Schema registry (if using EventBridge/Kinesis)\n* Monitoring and alerting\n** CloudWatch dashboards for queue metrics\n** Alarms for DLQ depth, queue age, processing failures\n** Event Bus throughput monitoring\n* Documentation\n** Event Bus architecture diagram\n** Event publishing guidelines\n** Consumer integration guide\n* Infrastructure as Code (IaC)\n** Terraform/CloudFormation templates for all infrastructure\n\n==== Dependencies\n\n*Prerequisites*:\n\n* AWS account access (existing infrastructure)\n* Technology selection decision (SNS+SQS vs EventBridge vs Kinesis)\n* CloudEvents 1.0 schema design approval\n\n*Dependent Work Packages*:\n\n* None (foundational infrastructure, can start early)\n\n==== Skills Required\n\n* AWS messaging services (SNS, SQS, EventBridge, Kinesis)\n* Event-driven architecture patterns\n* CloudEvents specification\n* JSON Schema design\n* Infrastructure as Code (Terraform/CloudFormation)\n* AWS IAM security configuration\n* CloudWatch monitoring and alerting\n\n==== Acceptance Criteria\n\n* Event Bus infrastructure provisioned in all environments (dev, staging, production)\n* FIFO ordering validated for events with same `contactId`\n* Dead Letter Queue triggers alarms when messages arrive\n* Event retention policy enforced (4 days)\n* CloudEvents 1.0 schema validation enabled\n* Monitoring dashboards operational\n* Infrastructure fully codified (IaC)\n\n[[wp-cs-004]]\n=== WP-CS-004: Contact Migration Tooling\n\n==== Description\n\nDevelop Contact migration tool for one-time migration from app-specific database to Salesforce Service Cloud with upsert logic and validation.\n\n==== Deliverables\n\n* Contact migration tool\n** Extract Contacts from app-specific database\n** Transform to Salesforce Contact API format\n** Upsert to Salesforce using email as external key\n** Fallback matching by phone number or Viva Consumer ID\n** Batch processing with rate limiting (respect Salesforce API limits)\n** Idempotent operation (can be re-run safely)\n* Validation scripts\n** Pre-migration validation (data quality checks)\n** Post-migration validation (100% Contact reconciliation)\n** Email/phone/VCI matching accuracy report\n* Reconciliation reporting\n** Contacts created vs updated statistics\n** Failed upserts with error details\n** Matching accuracy metrics\n* Rollback capability\n** Export snapshot of Salesforce Contacts before migration\n** Rollback procedure documentation\n* Documentation\n** Migration tool user guide\n** Troubleshooting guide\n** Runbook for migration execution\n\n==== Dependencies\n\n*Prerequisites*:\n\n* <<wp-cs-001,WP-CS-001>> (ProfileService Development) completed (reuses Salesforce integration code)\n* Salesforce sandbox environment for migration testing\n* App-specific database access (read-only sufficient)\n* Salesforce production access granted\n\n*Dependent Work Packages*:\n\n* <<wp-cs-001,WP-CS-001>> provides Salesforce Contact upsert logic to reuse\n\n==== Skills Required\n\n* Database development (SQL, data extraction)\n* Salesforce REST API integration\n* Batch processing and ETL patterns\n* Data validation and reconciliation\n* Error handling and logging\n* Scripting (Python, PowerShell, or similar)\n\n==== Acceptance Criteria\n\n* Migration tool successfully migrates 100% of Contacts in sandbox with zero data loss\n* Email/phone/VCI matching accuracy > 95% in sandbox testing\n* Failed upserts captured with actionable error messages\n* Reconciliation report matches actual Salesforce Contact counts\n* Migration tool execution time acceptable for production (freezes app database for minimum time)\n* Rollback procedure validated in sandbox\n* Documentation complete and approved\n\n[[wp-cs-005]]\n=== WP-CS-005: Mobile App Integration\n\n==== Description\n\nUpdate Mobile App to integrate with ProfileService and EngagementService APIs, replacing D365 CE integration.\n\n==== Deliverables\n\n* Feedback form UI enhancements\n** Add Category dropdown (App, Service, Order, Rewards, Refund, Delete Account)\n** Add Store Name field (optional)\n** Add Time of Visit field (optional, datetime picker)\n** Add Contact Phone Number field (optional, E.164 validation)\n** Update Message field (1-2000 character limit with counter)\n* API integration (Kotlin Multiplatform shared code)\n** ProfileService client (`GET /contact-id`)\n** EngagementService client (`POST /feedback`)\n** JWT token management (Microsoft Entra External ID)\n** Error handling (network failures, API errors, validation errors)\n** Retry logic for transient failures\n* Platform-specific UI (SwiftUI for iOS, Jetpack Compose for Android)\n** Feedback form screens\n** Success/error confirmation screens\n** Loading states and progress indicators\n* Feature flag integration\n** `enable_salesforce_feedback_submission` flag\n** Fallback to D365 CE if flag disabled (during rollout)\n* Unit tests for shared business logic\n* UI tests for platform-specific screens\n* API integration tests (mocked APIs)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* <<wp-cs-001,WP-CS-001>> (ProfileService Development) completed and deployed to dev/staging\n* <<wp-cs-002,WP-CS-002>> (EngagementService Development) completed and deployed to dev/staging\n* ProfileService and EngagementService OpenAPI specifications finalized\n* Feature flag service configured\n\n*Dependent Work Packages*:\n\n* Must complete after <<wp-cs-001,WP-CS-001>> and <<wp-cs-002,WP-CS-002>> (requires API endpoints available for integration testing)\n\n==== Skills Required\n\n* Kotlin Multiplatform development\n* SwiftUI (iOS native UI)\n* Jetpack Compose (Android native UI)\n* REST API client development\n* OAuth 2.0 / JWT authentication\n* Form validation and UX design\n* Unit testing (Kotlin, Swift)\n* UI testing frameworks (XCTest, Espresso)\n\n==== Acceptance Criteria\n\n* Feedback form UI matches UX design specifications\n* All form fields validate correctly (client-side validation)\n* API integration successfully calls ProfileService and EngagementService in dev/staging\n* Error handling provides user-friendly error messages\n* Feature flag correctly toggles between Salesforce and D365 CE integration\n* Unit test coverage > 80% for shared business logic\n* UI tests pass for all feedback form workflows (happy path, error states)\n* App builds and deploys successfully to TestFlight (iOS) and Google Play Internal Testing (Android)\n\n[[wp-cs-006]]\n=== WP-CS-006: Integration Testing\n\n==== Description\n\nExecute comprehensive integration testing across all system components in non-production environments.\n\n==== Deliverables\n\n* Test environment setup\n** Salesforce sandbox configured with test data\n** ProfileService deployed to staging\n** EngagementService deployed to staging\n** Event Bus staging infrastructure\n** Braze staging environment configured\n** Mobile App TestFlight/Internal Testing builds\n* Integration test suites\n** ProfileService ↔ Salesforce (Contact upsert scenarios)\n** EngagementService ↔ Salesforce (Case creation scenarios)\n** EngagementService ↔ Braze (push notification scenarios)\n** Mobile App ↔ ProfileService ↔ EngagementService (end-to-end workflows)\n** Event Bus publishing and consumption\n** Webhook receiver (Salesforce → EngagementService)\n* Test scenarios\n** Happy path: Successful feedback submission and Case creation\n** Error scenarios: Salesforce API failures, Braze API failures, network timeouts\n** Retry scenarios: Async Case creation retries, DLQ validation\n** Performance testing: p95 latency validation for ProfileService and EngagementService\n** Load testing: Simulate 3x-10x expected volume\n* UAT execution\n** Business stakeholder UAT sessions\n** UAT test cases covering all feedback categories\n** UAT sign-off documentation\n* Test results documentation\n** Test execution reports\n** Defect tracking and resolution\n** Performance test results\n\n==== Dependencies\n\n*Prerequisites*:\n\n* <<wp-cs-001,WP-CS-001>> (ProfileService Development) completed\n* <<wp-cs-002,WP-CS-002>> (EngagementService Development) completed\n* <<wp-cs-003,WP-CS-003>> (Event Bus Infrastructure) completed\n* <<wp-cs-005,WP-CS-005>> (Mobile App Integration) completed\n* <<wp-cs-007,WP-CS-007>> (Salesforce Configuration) sandbox configuration completed\n\n*Dependent Work Packages*:\n\n* Must complete after <<wp-cs-001,WP-CS-001>>, <<wp-cs-002,WP-CS-002>>, <<wp-cs-003,WP-CS-003>>, <<wp-cs-005,WP-CS-005>> (requires all components available)\n\n==== Skills Required\n\n* Integration testing strategy and execution\n* Test automation frameworks (Postman, Newman, Selenium)\n* Performance testing tools (JMeter, k6, Gatling)\n* Salesforce sandbox administration\n* Test data management\n* Defect tracking and triage\n* UAT facilitation\n\n==== Acceptance Criteria\n\n* All integration test scenarios pass (happy path, error scenarios, retry scenarios)\n* Performance SLAs validated (ProfileService p95 < 300ms, EngagementService p95 < 200ms)\n* Load testing confirms system handles 3x expected volume without degradation\n* UAT sign-off obtained from business stakeholders\n* Zero critical defects (P1/P2) open before moving to Contact Migration\n* Test results documented and approved\n\n[[wp-cs-007]]\n=== WP-CS-007: Salesforce Configuration\n\n==== Description\n\nConfigure Salesforce Service Cloud for OTR digital customer support integration, including field mapping, data isolation, and webhook setup.\n\n==== Deliverables\n\n* Salesforce Contact configuration\n** Custom fields for OTR-specific data (if needed)\n** Email as external key configuration\n** Record Type for OTR digital customers (data isolation)\n** Validation rules\n* Salesforce Case configuration\n** Custom fields for feedback categories (App, Service, Order, Rewards, Refund, Delete Account)\n** Case Type and Reason picklist mapping\n** Queue assignment rules (OTR digital support queue)\n** Case escalation rules\n** Case routing rules\n* Salesforce webhook configuration\n** Platform Events / Outbound Messages for Case updates\n** Webhook authentication (API key, JWT, or OAuth)\n** Case status change triggers (New → In Progress, Resolved, Closed)\n** Webhook payload format (JSON)\n* Data isolation strategy\n** Record Types for OTR vs other Viva Energy business units\n** Queues for OTR-specific Cases\n** Reporting and dashboards scoped to OTR data\n* Salesforce API access\n** Connected App configuration\n** OAuth 2.0 JWT bearer flow setup\n** API user credentials\n** API rate limit monitoring\n* Documentation\n** Salesforce field mapping specification\n** Webhook configuration guide\n** Data isolation architecture diagram\n** API authentication setup guide\n\n==== Dependencies\n\n*Prerequisites*:\n\n* Viva Energy Salesforce admin team engagement\n* Salesforce governance approval (multi-tenant environment)\n* Technical decision on webhook mechanism (Platform Events vs Outbound Messages)\n* Technical decision on authentication method (OAuth 2.0 JWT bearer flow recommended)\n\n*Dependent Work Packages*:\n\n* None (can start in parallel with development work packages)\n* Required for <<wp-cs-002,WP-CS-002>> (EngagementService needs field mapping)\n* Required for <<wp-cs-006,WP-CS-006>> (Integration Testing needs sandbox configuration)\n\n==== Skills Required\n\n* Salesforce administration\n* Salesforce configuration (Record Types, Queues, Validation Rules)\n* Salesforce API integration (REST API, Platform Events, Outbound Messages)\n* Salesforce security and authentication (OAuth, Connected Apps)\n* Multi-tenant data isolation patterns\n\n==== Acceptance Criteria\n\n* Salesforce sandbox configured with all custom fields, Record Types, Queues\n* Field mapping documented and approved by OTR business stakeholders\n* Webhook configuration tested and delivering Case update notifications\n* Data isolation validated (OTR data separate from other Viva Energy business units)\n* API authentication working for ProfileService and EngagementService\n* Salesforce API rate limits monitored and acceptable for expected volume\n* Configuration replicated to Salesforce production environment\n\n[[wp-cs-008]]\n=== WP-CS-008: Contact Data Migration\n\n==== Description\n\nExecute one-time Contact migration from app-specific database to Salesforce Service Cloud production.\n\n==== Deliverables\n\n* Pre-migration activities\n** Final validation of migration tool in sandbox\n** Communication plan (notify users of maintenance window if needed)\n** Freeze app-specific database Contact updates\n** Backup app-specific database\n** Export snapshot of Salesforce Contacts (rollback preparation)\n* Migration execution\n** Execute migration tool against Salesforce production\n** Monitor migration progress\n** Handle failed upserts (manual intervention if needed)\n* Post-migration validation\n** 100% Contact reconciliation (app database vs Salesforce)\n** Email/phone/VCI matching accuracy report\n** Reconciliation report (Contacts created vs updated)\n** Data integrity checks (no duplicate Contacts, no missing Contacts)\n* ProfileService smoke testing\n** Verify Contact ID retrieval works in production\n** Test cache behavior\n** Validate Salesforce Contact upserts from ProfileService\n* Migration report\n** Total Contacts migrated\n** Contacts created vs updated\n** Failed upserts (if any) with resolution\n** Matching accuracy metrics\n** Migration execution time\n\n==== Dependencies\n\n*Prerequisites*:\n\n* <<wp-cs-004,WP-CS-004>> (Contact Migration Tooling) completed\n* <<wp-cs-001,WP-CS-001>> (ProfileService Development) deployed to production (not yet integrated with Mobile App)\n* <<wp-cs-007,WP-CS-007>> (Salesforce Configuration) production configuration completed\n* Salesforce production access granted\n* Migration approved by business stakeholders\n\n*Dependent Work Packages*:\n\n* Must complete after <<wp-cs-001,WP-CS-001>>, <<wp-cs-004,WP-CS-004>>, <<wp-cs-007,WP-CS-007>>\n* Must complete before <<wp-cs-009,WP-CS-009>> (Production Deployment)\n\n==== Skills Required\n\n* Data migration execution\n* Salesforce administration\n* Database operations\n* Data validation and reconciliation\n* Incident management (if issues arise)\n\n==== Acceptance Criteria\n\n* 100% of Contacts migrated with zero data loss\n* Email/phone/VCI matching accuracy > 95%\n* ProfileService smoke tests pass in production\n* Reconciliation report approved by business stakeholders\n* App-specific database Contact updates frozen (read-only mode)\n* Rollback procedure ready (but not executed if migration successful)\n\n[[wp-cs-009]]\n=== WP-CS-009: Production Deployment\n\n==== Description\n\nDeploy all solution components to production and execute cutover from D365 CE to Salesforce Service Cloud.\n\n==== Deliverables\n\n* Production deployment\n** EngagementService deployed to production\n** Event Bus production infrastructure validated\n** Salesforce webhook configured in production\n** Mobile App released to production (App Store, Google Play)\n* Go-live activities\n** Smoke testing (end-to-end feedback submission)\n** Feature flag enabled: `enable_salesforce_feedback_submission = ON`\n** D365 CE integration disabled in Mobile App\n** Monitor Event Bus queue depth, DLQ, Salesforce API rate limits\n** Monitor Mobile App feedback submission success rate\n* Go/No-Go decision\n** Validate success criteria before final cutover\n** Business stakeholder approval\n** Technical validation (smoke tests pass, monitoring healthy)\n* Cutover communication\n** Notify support agents of new Salesforce integration\n** Provide training materials for support agents\n** Customer communication (if visible change)\n* Rollback plan\n** Documented rollback procedure\n** Feature flag can disable Salesforce integration and re-enable D365 CE\n** Rollback decision criteria (P1/P2 incidents, feedback submission success rate < 99%)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-001 (ProfileService Development) completed\n* WP-CS-002 (EngagementService Development) completed\n* WP-CS-003 (Event Bus Infrastructure) completed\n* WP-CS-005 (Mobile App Integration) completed\n* WP-CS-006 (Integration Testing) completed with UAT sign-off\n* WP-CS-007 (Salesforce Configuration) production configuration completed\n* WP-CS-008 (Contact Data Migration) completed successfully\n* Mobile App release approval (App Store, Google Play)\n\n*Dependent Work Packages*:\n\n* Must complete after all prior work packages (final cutover)\n\n==== Skills Required\n\n* Production deployment and release management\n* Incident management and troubleshooting\n* Monitoring and observability\n* Change management and communication\n* Rollback execution (if needed)\n\n==== Acceptance Criteria\n\n* Mobile App feedback submission success rate > 99.5%\n* End-to-end flow validated (Mobile App → ProfileService → EngagementService → Salesforce Case created)\n* Braze push notifications delivered successfully\n* Event Bus queue depth normal, DLQ empty\n* No critical incidents (P1/P2) in first 24 hours\n* D365 CE integration disabled\n* Support agents successfully using Salesforce for OTR digital customer Cases\n\n[[wp-cs-010]]\n=== WP-CS-010: Post-Cutover Support\n\n==== Description\n\nMonitor production stability, resolve issues, validate success criteria, and execute D365 CE retirement.\n\n==== Deliverables\n\n* Monitoring and support\n** 24/7 on-call support for first week post-cutover\n** Daily monitoring reports (feedback submission success rate, Case creation success rate)\n** Incident response and resolution\n** Performance tuning (if needed)\n* Success criteria validation\n** Validate feedback submission success rate > 99.5%\n** Monitor customer satisfaction score (target: +15% improvement within 6 months)\n** Monitor average case resolution time (target: -20% improvement within 6 months)\n** Support agent feedback survey\n* D365 CE retirement\n** D365 CE set to read-only mode (historical Case lookups only)\n** Archive D365 CE data for compliance/auditing\n** Decommission D365 CE infrastructure (after 90-day stabilization period)\n** Remove D365 CE integration code from Mobile App\n* Documentation updates\n** Production runbook\n** Troubleshooting guide (based on incidents resolved)\n** Operational procedures for support team\n** Lessons learned document\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-009 (Production Deployment) completed\n* Cutover successful with no critical incidents\n\n*Dependent Work Packages*:\n\n* Final work package in sequence\n\n==== Skills Required\n\n* Production support and incident management\n* Performance monitoring and tuning\n* Data archival and compliance\n* Infrastructure decommissioning\n* Documentation\n\n==== Acceptance Criteria\n\n* Zero critical incidents (P1/P2) in first 30 days post-cutover\n* Feedback submission success rate sustained > 99.5%\n* Customer satisfaction improvement validated (baseline established, ongoing measurement)\n* Support agents reporting positive experience with Salesforce unified view\n* D365 CE successfully decommissioned\n* All production documentation complete and approved\n* Lessons learned document published\n\n=== Work Package Sequencing\n\n==== Parallel Track 1: Infrastructure & Configuration\n\nCan start immediately and run in parallel:\n\n* WP-CS-003 (Event Bus Infrastructure)\n* WP-CS-007 (Salesforce Configuration)\n\n==== Parallel Track 2: Development\n\nCan start after Track 1 infrastructure decisions made:\n\n* WP-CS-001 (ProfileService Development) - Independent\n* WP-CS-002 (EngagementService Development) - Requires WP-CS-003 completed\n* WP-CS-004 (Contact Migration Tooling) - Requires WP-CS-001 completed (reuses code)\n\n==== Sequential Track 3: Integration & Testing\n\nMust complete after development:\n\n* WP-CS-005 (Mobile App Integration) - Requires WP-CS-001, WP-CS-002\n* WP-CS-006 (Integration Testing) - Requires WP-CS-001, WP-CS-002, WP-CS-003, WP-CS-005, WP-CS-007\n\n==== Sequential Track 4: Migration & Cutover\n\nMust complete sequentially:\n\n* WP-CS-008 (Contact Data Migration) - Requires WP-CS-001, WP-CS-004, WP-CS-006 UAT sign-off\n* WP-CS-009 (Production Deployment) - Requires all prior work packages completed\n* WP-CS-010 (Post-Cutover Support) - Requires WP-CS-009\n\n==== Critical Path\n\nThe critical path for this project is:\n\n. WP-CS-003 (Event Bus Infrastructure)\n. WP-CS-002 (EngagementService Development) - blocks on WP-CS-003\n. WP-CS-005 (Mobile App Integration) - blocks on WP-CS-001, WP-CS-002\n. WP-CS-006 (Integration Testing) - blocks on WP-CS-001 through WP-CS-005, WP-CS-007\n. WP-CS-008 (Contact Data Migration) - blocks on WP-CS-006 UAT sign-off\n. WP-CS-009 (Production Deployment) - blocks on WP-CS-008\n. WP-CS-010 (Post-Cutover Support) - final deliverable\n\nAny delays in critical path work packages will delay the overall cutover date.\n\n<<<\n== Transition Architecture\n\nThis section defines the evolution from baseline (D365 CE) to target state (Salesforce Service Cloud + ProfileService + EngagementService).\n\n=== Transition Approach\n\n*Big Bang Cutover*: Per ADR-CS-006, this transition uses a single cutover approach rather than phased rollout. All users switch from D365 CE to Salesforce simultaneously after Contact migration completion.\n\n=== Transition States\n\n==== TS-0: Baseline State (Current)\n\n===== Characteristics\n\n* D365 Customer Engagement handles all digital customer feedback\n* App-specific database stores customer Contact data\n* No ProfileService or EngagementService\n* No event-driven architecture\n* Synchronous feedback submission\n\n===== Components Active\n\n- D365 Customer Engagement\n- App-specific customer database\n- Mobile App (current version with D365 CE integration)\n\n==== TS-1: Build & Test\n\n===== Activities\n\n* Build ProfileService microservice (JIT Contact reconciliation API)\n* Build EngagementService microservice (feedback submission API, ACL for Salesforce Case creation, Braze integration, webhook receiver)\n* Implement Event Bus infrastructure (SNS+SQS/EventBridge/Kinesis)\n* Develop Contact migration tool (app database → Salesforce upsert by email/phone/VCI)\n* Update Mobile App API integration (ProfileService + EngagementService endpoints - feedback form UI already complete)\n* Integration testing (ProfileService ↔ Salesforce, EngagementService ↔ Salesforce, EngagementService ↔ Braze)\n* UAT with test Salesforce sandbox environment\n\n===== Components Active\n\n- D365 Customer Engagement (still active, unchanged)\n- App-specific customer database (still active)\n- ProfileService (non-production, testing only)\n- EngagementService (non-production, testing only)\n- Event Bus (non-production)\n- Salesforce Sandbox (testing)\n\n===== Exit Criteria\n\n- All integration tests pass\n- UAT sign-off from business stakeholders\n- Contact migration tool validated in sandbox\n- Mobile App updates tested with non-production APIs\n\n==== TS-2: Contact Migration\n\n===== Activities\n* Execute Contact migration (app database → Salesforce production)\n* Validation: 100% data integrity check (email/phone/VCI matching)\n* Reconciliation report: New Contacts created vs existing Contacts updated\n* Freeze app database Contact updates during migration window\n* ProfileService smoke testing (verify Contact lookups work in Salesforce production)\n\n===== Components Active\n- D365 Customer Engagement (still active, users unaffected)\n- Salesforce Production (Contacts migrated, no Cases yet)\n- ProfileService (production deployed, not integrated with Mobile App yet)\n- App-specific customer database (frozen, read-only)\n\n===== Exit Criteria\n- 100% of Contacts migrated with zero data loss\n- Email/phone/VCI matching accuracy > 95%\n- ProfileService smoke tests pass (JIT lookups return correct Contact IDs)\n- Reconciliation report approved\n\n==== TS-3: Cutover (Go-Live)\n\n===== Go-Live Activities\n\n* Deploy EngagementService to production\n* Deploy Mobile App updates (ProfileService + EngagementService API integration)\n* Configure Salesforce webhook (Case update notifications → EngagementService)\n* Smoke testing: End-to-end feedback submission (Mobile App → EngagementService → Salesforce → Braze notification)\n* Monitor Event Bus queue depth, dead letter queue, Salesforce API rate limits\n* **Go/No-Go decision**: Validate success criteria before final cutover\n* Enable feature flag: `enable_salesforce_feedback_submission = ON`\n* Disable D365 CE integration in Mobile App\n\n===== Components Active\n\n- ProfileService (production, integrated with Mobile App)\n- EngagementService (production, integrated with Mobile App)\n- Event Bus (production, processing async Case creation)\n- Salesforce Production (receiving Cases from digital customers)\n- Braze (sending push notifications)\n- Mobile App (new version with Salesforce integration)\n- D365 Customer Engagement (disabled, read-only for historical lookups)\n\n===== Exit Criteria\n\n- Mobile App feedback submission success rate > 99.5%\n- End-to-end flow validated (Mobile App → Salesforce Case created)\n- Braze push notifications delivered successfully\n- Event Bus queue depth normal, DLQ empty\n- No critical incidents (P1/P2) in first 24 hours\n\n==== TS-4: Target State (Stable Production)\n\n===== Characteristics\n\n* ProfileService and EngagementService fully operational\n* All digital customer feedback routed to Salesforce\n* Event-driven architecture established\n* D365 CE decommissioned\n* First DDD bounded contexts implemented successfully\n\n===== Monitoring Period\n\n* Validate success criteria: feedback submission rate > 99.5%, no data loss\n* Monitor customer satisfaction score (target: +15% improvement)\n* Monitor average case resolution time (target: -20% improvement)\n* Support agents using unified Salesforce view across all channels\n\n===== D365 CE Retirement\n\n* D365 CE read-only access for historical Case lookups (if needed)\n* Decommission D365 CE infrastructure after 90 days\n* Archive D365 CE data for compliance/auditing\n\n===== Components Active\n\n- ProfileService (production)\n- EngagementService (production)\n- Event Bus (production)\n- Salesforce Production (system of record)\n- Braze (push notifications)\n- Mobile App (Salesforce integration)\n- App-specific database (deprecated, Contact data no longer updated)\n\n===== Success Criteria Achieved\n\n- All digital customer feedback routed to Salesforce\n- Support agents have unified customer view\n- D365 CE decommissioned\n- Customer satisfaction improved by 15%\n- Average case resolution time decreased by 20%\n- Zero data loss during transition\n\n=== Transition Dependencies\n\n[width=\"100%\",cols=\"40%,60%\",options=\"header\",]\n|===\n|Dependency |Owner/Status\n\n|*Salesforce production access*\n|Viva Energy Salesforce admin team - TBD\n\n|*Salesforce Case field mapping*\n|Viva Energy Salesforce admin team - TBD (map OTR feedback categories to Salesforce fields)\n\n|*Salesforce data isolation strategy*\n|Viva Energy Salesforce admin team - TBD (Record Types, queues, custom fields)\n\n|*Salesforce webhook configuration*\n|Viva Energy Salesforce admin team - TBD (Outbound Messages vs Platform Events)\n\n|*Event Bus infrastructure*\n|OTR Platform team - Existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis)\n\n|*Braze integration*\n|OTR Marketing team - Existing Braze account, EngagementService creates new campaigns\n\n|*Mobile App release window*\n|OTR Mobile team - Coordinate cutover timing with app release schedule\n\n|*App database access*\n|OTR Platform team - Read access for Contact migration\n\n|===\n\n=== Transition Validation Criteria\n\n==== Contact Migration Validation\n\n* 100% of app database Contacts migrated to Salesforce (zero data loss)\n* Email/phone/VCI matching accuracy > 95% (minimize duplicate Contacts)\n* ProfileService JIT lookups return correct Salesforce Contact IDs (smoke test sample)\n* Reconciliation report shows: X new Contacts created, Y existing Contacts updated\n\n==== Cutover Validation\n\n* Mobile App feedback submission success rate > 99.5% (including async Case creation)\n* End-to-end flow validated: Mobile App → ProfileService → EngagementService → Salesforce Case created\n* Braze push notifications delivered for Case creation and Case resolution\n* Event Bus queue depth within normal range (no backlog)\n* Dead letter queue empty (no failed Case creations)\n* Salesforce API rate limits not exceeded\n\n==== Production Monitoring (30 days)\n\n* Customer satisfaction score improves by 15% (compared to D365 CE baseline)\n* Average case resolution time decreases by 20% (Salesforce vs D365 CE)\n* Support agents confirm unified customer view across all channels\n* Zero critical incidents (P1 outages, data loss)\n\n=== Rollback Plan\n\n==== Rollback Triggers\n\n* Feedback submission success rate < 95% (below acceptable threshold)\n* Data loss or corruption detected in Salesforce\n* Salesforce API rate limits exceeded (Cases not created within SLA)\n* Critical bug blocking customer feedback submission\n\n==== Rollback Procedure\n\n1. **Revert Mobile App** to previous version (remove ProfileService/EngagementService integration, restore D365 CE integration)\n2. **Stop EngagementService** Case creation (prevent duplicate Cases in Salesforce)\n3. **Re-enable D365 CE** for customer feedback submission\n4. **Investigate root cause** (EngagementService logs, Salesforce API errors, Event Bus queue issues)\n5. **Fix and re-test** in sandbox environment\n6. **Retry cutover** when issues resolved\n\n==== Rollback Limitations\n\n* Cases created in Salesforce during cutover period remain in Salesforce (no reverse migration)\n* Contacts migrated to Salesforce remain (no rollback to app database)\n* Rollback only affects Mobile App integration (not data migration)\n\n=== Architectural Scope Boundaries\n\n==== Capabilities Included\n\n===== Business Capabilities\n\n* **Customer Feedback Submission**: Mobile App users can submit structured feedback (Category, Store Name, Time of Visit, Phone, Free Text Message) via EngagementService\n* **Customer Contact Management**: Just-In-Time (JIT) Contact reconciliation with Salesforce via ProfileService, ensuring every Mobile App user has a Salesforce Contact record\n* **Case Management Integration**: EngagementService creates Salesforce Cases asynchronously for customer feedback, support agents manage Cases in Salesforce Service Cloud\n* **Customer Notifications**: Push notifications via Braze when Cases are created, updated, or resolved (bidirectional integration: Mobile App → Salesforce → Mobile App)\n* **Unified Customer View**: Support agents see OTR digital customer feedback alongside other Viva Energy channels (fuel wholesale, Shell Card, retail) in single Salesforce instance\n* **Contact Data Migration**: One-time migration of app-specific customer database Contacts to Salesforce with upsert logic (email/phone/VCI matching)\n\n===== Technical Capabilities\n\n* **ProfileService Bounded Context**: First DDD bounded context implementation - JIT Contact reconciliation, Salesforce API facade, foundation for Flybuys integration\n* **EngagementService Bounded Context**: First DDD bounded context implementation - Customer feedback submission BFF, Anti-Corruption Layer for Salesforce, Braze integration orchestration\n* **Event-Driven Architecture**: Domain event publishing via Event Bus (SNS+SQS/EventBridge/Kinesis) for `SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted` events\n* **Async Processing Pattern**: Non-blocking Case creation with retry logic, exponential backoff, dead letter queue for operational resilience\n* **Anti-Corruption Layer Pattern**: EngagementService protects digital channels from Salesforce API changes, translates between OTR domain language and Salesforce\n* **Conformist Pattern**: ProfileService and EngagementService conform to existing Salesforce configuration (shared Viva Energy instance, multi-tenant governance)\n* **Salesforce Integration**: REST API integration for Contact CRUD and Case creation, webhook receiver for Case update notifications\n* **Braze Integration**: Push notification campaign triggers for Case lifecycle events (created, updated, resolved)\n* **Observability & Monitoring**: Dashboards, metrics, alerting for feedback submission rate, queue depth, API errors, Case creation latency\n* **Feature Flag Management**: Kill switches for emergency rollback (enable_salesforce_feedback_submission, enable_async_case_creation, etc.)\n\n==== Capabilities Excluded\n\n===== Business Capabilities Explicitly Out of Scope\n\n* **Historical Case Migration**: D365 CE Cases not migrated to Salesforce (ADR-CS-005 - fresh start, no Case migration)\n* **Multi-Channel Feedback Submission**: Web app, POS, call centre, email feedback channels not included (Mobile App only in this phase)\n* **Case Resolution by Digital Channels**: Support agents resolve Cases in Salesforce, not via Mobile App self-service\n* **Knowledge Base Integration**: Salesforce Knowledge Base articles not surfaced in Mobile App (future enhancement)\n* **Live Chat/Messaging**: Real-time chat support not included (Salesforce omnichannel capabilities not activated)\n* **Sentiment Analysis**: Automated feedback sentiment analysis not included (future enhancement with AI/ML)\n* **Customer Satisfaction Surveys**: Post-resolution CSAT surveys not included (separate initiative)\n* **Case Attachments**: Mobile App feedback submission does not support file uploads (photos, receipts) - text only\n* **Agent Desktop Integration**: Custom Salesforce UI for support agents not included (use standard Salesforce Service Console)\n* **Social Media Feedback**: Facebook, Twitter, Instagram feedback channels not integrated\n\n===== Technical Capabilities Explicitly Out of Scope\n\n* **Event Sourcing**: Domain events are ephemeral (not persisted for event sourcing/replay) - Event Bus only, no Event Store\n* **CQRS (Command Query Responsibility Segregation)**: ProfileService and EngagementService use same data model for reads/writes (no separate read models)\n* **Local Aggregate Persistence**: ProfileService and EngagementService are stateless (Salesforce is System of Record, no local database for Contact/Case)\n* **Saga Orchestration**: No distributed transactions or saga patterns required (single-step Case creation, not multi-step workflow)\n* **API Gateway Advanced Features**: Rate limiting, API versioning, API key management deferred to detailed design (basic routing only)\n* **GraphQL API**: ProfileService and EngagementService expose REST APIs only (GraphQL not required)\n* **Real-Time Sync**: Salesforce Contact updates by support agents not synced back to ProfileService (eventual consistency acceptable via JIT reconciliation)\n* **Multi-Region Deployment**: Single AWS region deployment (no multi-region failover/disaster recovery in this phase)\n* **Blue-Green Deployment**: Big bang cutover (ADR-CS-006), not blue-green or canary deployment strategy\n* **A/B Testing Framework**: Feature flags for rollback only, not for A/B testing or experimentation\n* **Custom Authentication**: Microsoft Entra External ID used for Mobile App authentication (no custom authentication logic in ProfileService/EngagementService)\n* **Data Residency Compliance**: Salesforce data residency governed by Viva Energy Salesforce configuration (no OTR-specific data residency requirements)\n\n===== Future Bounded Contexts Not in Scope\n\n* **LoyaltyService**: Flybuys integration, reward preferences, transaction adjudication (separate initiative)\n* **LocationService**: Store finder, proximity features, geofencing (separate initiative)\n* **PaymentService**: Payment processing, subscription billing (separate initiative)\n* **RecommendationService**: Personalized recommendations, next-best offers (separate initiative)\n\n===== Integration Patterns Not in Scope\n\n* **Shared Kernel**: No shared domain model between ProfileService and EngagementService (separate bounded contexts with clear boundaries)\n* **Partnership**: No joint development or coordination with external teams (Conformist pattern - we conform to Salesforce)\n* **Customer-Supplier (we're upstream)**: No downstream systems depend on ProfileService/EngagementService APIs yet (future bounded contexts will consume domain events)\n\n==== Architectural Dependencies on Future Initiatives\n\n*This Architecture Enables Future Initiatives*:\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Future Initiative |Architectural Enablement\n\n|*Flybuys Integration*\n|**ProfileService Contact Reconciliation Reused**: ProfileService establishes pattern for JIT Contact reconciliation with Salesforce, which will be extended for Flybuys partner linking (link:../architecture_definitions/flybuys_integration.adoc[see Flybuys Integration architecture]) +\n**Event Bus Infrastructure**: Domain event publishing pattern (`CustomerEnrolledInLoyalty`, `PartnerLinked`, etc.) reuses Event Bus established for EngagementService\n\n|*LoyaltyService Bounded Context*\n|**Event Bus Subscription**: LoyaltyService will consume `CustomerProfileCreated` events published by ProfileService (future enhancement) +\n**Salesforce Contact Integration**: LoyaltyService may query Salesforce Contacts for customer reward preferences (via ProfileService facade or direct Salesforce API)\n\n|*Web App Feedback Submission*\n|**EngagementService API Reuse**: Web app will call same EngagementService REST API for feedback submission (multi-channel support) +\n**Conformist Pattern**: Web app conforms to EngagementService API contract (no translation required)\n\n|*Multi-Channel Customer Support*\n|**EngagementService Extension**: Add support for email, call centre, POS feedback channels (extend EngagementService to handle multiple origins) +\n**Salesforce Case Origin Field**: Cases already tagged with Origin=Mobile App, extend to Origin=Web, POS, Call Centre, Email\n\n|*Knowledge Base Integration*\n|**EngagementService API Extension**: Add endpoint to query Salesforce Knowledge Base articles, surface in Mobile App for self-service support +\n**Anti-Corruption Layer**: EngagementService translates Salesforce Knowledge API to OTR domain language\n\n|*Customer Satisfaction Surveys*\n|**Event-Driven Trigger**: Subscribe to `SupportCaseResolved` events published by EngagementService, trigger CSAT survey via Braze +\n**Braze Integration Pattern**: Reuse EngagementService → Braze integration pattern for survey campaigns\n\n|*Sentiment Analysis*\n|**Event Subscription**: Subscribe to `CustomerFeedbackSubmitted` events, analyse feedback sentiment (AI/ML service) +\n**EngagementService Extension**: Enrich Case with sentiment score before creating in Salesforce\n\n|*RecommendationService Bounded Context*\n|**Event Subscription**: RecommendationService subscribes to `SupportCaseCreated` events to understand customer pain points and personalize recommendations +\n**Domain Event Pattern**: Reuse Event Bus publishing pattern established by EngagementService\n\n|===\n\n*This Architecture Depends on Future Initiatives*:\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Future Initiative |Dependency Description\n\n|*Salesforce Data Isolation Strategy*\n|**BLOCKER**: Viva Energy Salesforce admin team must define data isolation strategy (Record Types, custom fields, queues) before production deployment +\n**Impact**: Multi-tenant data visibility and security governance\n\n|*Salesforce Case Field Mapping*\n|**BLOCKER**: Viva Energy Salesforce admin team must define field mapping for OTR feedback categories (App, Service, Order, Rewards, Refund, Delete Account) +\n**Impact**: Case creation logic in EngagementService depends on finalized Salesforce schema\n\n|*Salesforce Webhook Mechanism*\n|**BLOCKER**: Viva Energy Salesforce admin team must configure webhook mechanism (Outbound Messages vs Platform Events vs Process Builder) for Case update notifications +\n**Impact**: EngagementService webhook receiver implementation depends on chosen mechanism\n\n|*Event Bus Technology Selection*\n|**DECISION REQUIRED**: Choose Event Bus implementation (SNS+SQS vs EventBridge vs Kinesis) for domain event publishing +\n**Impact**: Infrastructure provisioning, event schema design, consumer implementation\n\n|*Microservice Hosting Platform*\n|**DECISION REQUIRED**: Choose hosting platform for ProfileService and EngagementService (AWS Lambda vs ECS vs EKS) +\n**Impact**: Deployment architecture, auto-scaling strategy, operational overhead\n\n|*Observability Platform*\n|**DECISION REQUIRED**: Choose observability platform (AWS CloudWatch vs Datadog vs New Relic) for monitoring and alerting +\n**Impact**: Dashboard configuration, metric collection, alerting setup\n\n|===\n\n*Future Work After This Initiative*:\n\n* **Event Schema Registry**: Implement event schema versioning and registry for domain events (currently ad-hoc schemas)\n* **API Versioning Strategy**: Define API versioning approach for ProfileService and EngagementService (currently v1 only)\n* **Multi-Region Deployment**: Extend to multi-region for disaster recovery and global availability\n* **Event Store**: Persist domain events for event sourcing and audit trail (currently ephemeral Event Bus only)\n* **CQRS Pattern**: Separate read models for high-volume queries (currently same model for reads/writes)\n* **GraphQL API**: Expose GraphQL API for flexible client queries (currently REST only)\n* **Real-Time Sync**: Bi-directional sync between Salesforce and ProfileService for Contact updates (currently JIT reconciliation only)\n\n=== Technical Risks and Mitigation\n\n[width=\"100%\",cols=\"5%,20%,25%,25%,25%\",options=\"header\",]\n|===\n|ID |Risk |Impact |Likelihood |Mitigation\n\n|RISK-CS-001\n|*Salesforce API rate limits exceeded*: High feedback volume exceeds Salesforce API limits, Cases not created\n|HIGH (customers don't receive Case confirmation, support tickets lost)\n|MEDIUM (volume unknown, rate limits TBD)\n|• Gather expected feedback volume data before cutover +\n• Implement Event Bus queue throttling/rate limiting +\n• Monitor queue depth and API usage +\n• Scale background workers based on queue depth +\n• Alert ops team when approaching rate limits\n\n|RISK-CS-002\n|*Salesforce downtime*: Salesforce Service Cloud outage prevents Case creation\n|MEDIUM (Cases delayed but queued, customers wait for confirmation)\n|LOW (Salesforce SLA 99.9% uptime)\n|• Async Case creation with retry logic +\n• Event Bus queues buffer work during outage +\n• Customers get immediate \"Feedback submitted\" (not blocked) +\n• Monitor Salesforce status page, alert ops team +\n• Automatic retry when Salesforce recovers\n\n|RISK-CS-003\n|*Contact migration data quality issues*: App database Contact data incomplete or invalid\n|HIGH (migration fails validation, cutover delayed)\n|MEDIUM (legacy data quality unknown)\n|• Pre-migration data quality assessment +\n• Flexible upsert logic (match by email/phone/VCI) +\n• Validation report identifies data issues before production migration +\n• Manual cleanup for invalid records +\n• Dry-run migration in sandbox environment\n\n|RISK-CS-004\n|*Duplicate Contacts created*: Email matching fails, ProfileService creates duplicate Contacts\n|MEDIUM (support agents see multiple profiles for same customer)\n|MEDIUM (email changes, data quality issues)\n|• Salesforce duplicate detection rules (if available) +\n• ProfileService logs Contact creation for audit trail +\n• Manual duplicate cleanup process (support team) +\n• Future enhancement: VCI as Salesforce External ID for stable matching\n\n|RISK-CS-005\n|*Dead letter queue accumulation*: Failed Case creations not processed, queue grows\n|HIGH (customers don't receive Case confirmation, feedback lost)\n|LOW (retry logic handles most failures)\n|• Dead letter queue monitoring and alerting +\n• Ops team dashboard showing DLQ depth +\n• Manual intervention process (investigate and reprocess) +\n• Automated alerts when DLQ depth exceeds threshold +\n• Root cause analysis for recurring failures\n\n|RISK-CS-006\n|*Salesforce webhook failures*: Salesforce can't deliver Case update notifications to EngagementService\n|MEDIUM (customers don't get push notifications for Case resolution)\n|LOW (webhook mechanism reliable)\n|• Webhook retry logic and exponential backoff +\n• EngagementService logs webhook deliveries +\n• Monitor webhook delivery success rate +\n• Fallback: Poll Salesforce API for Case updates (if webhook fails persistently) +\n• Alert ops team when webhook delivery rate drops\n\n|RISK-CS-007\n|*Multi-tenant data isolation breach*: OTR digital Cases visible to other Viva Energy support teams\n|HIGH (privacy violation, compliance risk)\n|LOW (Salesforce governance controls)\n|• Work with Viva Energy Salesforce admin team on data isolation strategy +\n• Test data visibility in Salesforce sandbox (UAT with different user roles) +\n• Validate Record Types, queues, field-level security before production +\n• Audit Salesforce user permissions and sharing rules\n\n|RISK-CS-008\n|*Mobile App release coordination*: App release delayed, cutover window missed\n|MEDIUM (cutover delayed, D365 CE retirement delayed)\n|MEDIUM (release schedule conflicts)\n|• Coordinate cutover timing with Mobile team early +\n• Buffer time in migration plan (2-week contingency) +\n• Decouple backend deployment from Mobile App release (backend deployed first, app follows) +\n• Feature flag for feedback submission (enable when ready)\n\n|RISK-CS-009\n|*Event Bus infrastructure issues*: SNS/SQS/EventBridge downtime or misconfiguration\n|HIGH (Case creation blocked, domain events not published)\n|LOW (AWS SLA 99.99% uptime)\n|• Leverage existing AWS infrastructure (proven, reliable) +\n• Infrastructure as Code (IaC) for Event Bus configuration +\n• Integration testing in non-production environment +\n• Monitor Event Bus metrics (queue depth, throughput, errors) +\n• Alert ops team on Event Bus failures\n\n|RISK-CS-010\n|*Team DDD knowledge gap*: Team unfamiliar with DDD patterns, bounded contexts, event-driven architecture\n|MEDIUM (implementation delays, architectural inconsistencies)\n|HIGH (first DDD implementation)\n|• DDD training for development team (workshops, documentation) +\n• Architecture review sessions (validate bounded context design) +\n• Pair programming with experienced DDD practitioners +\n• Incremental implementation (start small, iterate) +\n• Document architectural patterns in CLAUDE.md\n\n|===\n\n== Assumptions and Constraints\n\n=== Assumptions\n\n[width=\"100%\",cols=\"8%,92%\",options=\"header\",]\n|===\n|ID |Assumption\n\n|ASM-CS-001\n|Viva Energy Salesforce admin team will provide Salesforce production access, sandbox environment, and support for Case field mapping and data isolation configuration\n\n|ASM-CS-002\n|App database Contact data is sufficiently complete for migration (email/phone/VCI available for matching)\n\n|ASM-CS-003\n|Expected customer feedback volume (100-150 submissions/day from 20k DAU) is well within Salesforce API rate limits, with capacity planning for 3x-10x growth\n\n|ASM-CS-004\n|Existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis) is sufficient for Event Bus implementation (no additional infrastructure provisioning required)\n\n|ASM-CS-005\n|Braze integration already exists and can be extended for Case-related push notifications (no new Braze account or major configuration changes)\n\n|ASM-CS-006\n|Mobile App users have email addresses associated with their accounts (required for ProfileService Contact reconciliation)\n\n|ASM-CS-007\n|D365 Customer Engagement historical Cases have limited business value and do not require migration to Salesforce\n\n|ASM-CS-008\n|Support agents are trained on Salesforce Service Cloud and require minimal additional training for OTR digital customer Cases\n\n|ASM-CS-009\n|Salesforce Service Cloud shared instance has capacity for OTR digital customer Contacts and Cases (no additional licensing or storage costs)\n\n|ASM-CS-010\n|Mobile App release schedule can accommodate cutover timing (Week 10 in migration plan)\n\n|===\n\n=== Constraints\n\n[width=\"100%\",cols=\"8%,92%\",options=\"header\",]\n|===\n|ID |Constraint\n\n|CON-CS-001\n|Must use shared Viva Energy Salesforce Service Cloud instance (cannot deploy separate OTR-specific instance)\n\n|CON-CS-002\n|Must conform to existing Salesforce configuration and governance (Record Types, custom fields, queues, data isolation strategy defined by Viva Energy admin team)\n\n|CON-CS-003\n|Contact migration must complete before Mobile App cutover (no parallel run of D365 CE and Salesforce)\n\n|CON-CS-004\n|Big bang cutover only (no phased rollout with feature flags or pilot users)\n\n|CON-CS-005\n|Salesforce API rate limits and authentication method constrained by Viva Energy Salesforce configuration (TBD)\n\n|CON-CS-006\n|Event Bus implementation must use existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis - cannot introduce new infrastructure components)\n\n|CON-CS-007\n|Mobile App feedback form must include specific fields: Category, Store Name, Time of Visit, Contact Phone Number, Free Text Message (no attachments)\n\n|CON-CS-008\n|D365 Customer Engagement must be decommissioned within 90 days post-cutover (ADR-CS-006)\n\n|CON-CS-009\n|ProfileService and EngagementService must be stateless (no local aggregate persistence, Salesforce is System of Record)\n\n|CON-CS-010\n|First DDD bounded context implementation (team learning curve, architectural patterns must be documented for future bounded contexts)\n\n|===\n\n== Non-Functional Requirements\n\n=== Performance Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-PERF-001\n|Mobile App feedback submission API response time (ProfileService + EngagementService)\n|p95 < 1 second, p99 < 2 seconds\n\n|NFR-PERF-002\n|ProfileService Contact reconciliation API response time (JIT lookup)\n|p95 < 500ms, p99 < 1 second\n\n|NFR-PERF-003\n|EngagementService async Case creation latency (end-to-end: feedback submitted → Case created in Salesforce)\n|p95 < 5 minutes, p99 < 10 minutes\n\n|NFR-PERF-004\n|Salesforce API call latency (Contact query, Contact create, Case create)\n|p95 < 2 seconds, p99 < 5 seconds\n\n|NFR-PERF-005\n|Event Bus message processing throughput\n|> 100 messages/second (support peak feedback volume)\n\n|NFR-PERF-006\n|Braze push notification delivery latency (Case created → notification delivered)\n|p95 < 30 seconds, p99 < 60 seconds\n\n|===\n\n=== Availability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-AVAIL-001\n|ProfileService availability\n|99.9% uptime (8.76 hours downtime/year)\n\n|NFR-AVAIL-002\n|EngagementService availability\n|99.9% uptime (8.76 hours downtime/year)\n\n|NFR-AVAIL-003\n|Feedback submission success rate (including async Case creation)\n|> 99.5% (includes retry logic for transient failures)\n\n|NFR-AVAIL-004\n|Graceful degradation: Salesforce downtime handling\n|Feedback submission still succeeds, Cases queued for async creation when Salesforce recovers\n\n|NFR-AVAIL-005\n|Graceful degradation: Braze downtime handling\n|Case creation proceeds, push notifications disabled temporarily (feature flag)\n\n|NFR-AVAIL-006\n|Planned maintenance window\n|< 4 hours/month, scheduled during low-traffic periods (2-6am ACST)\n\n|===\n\n=== Scalability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-SCALE-001\n|Concurrent Mobile App users (peak)\n|Support 20,000 DAU (Daily Active Users), ~150 concurrent users submitting feedback during peak hours\n\n|NFR-SCALE-002\n|Feedback submissions per day\n|Expected: 100-150 submissions/day based on 20k DAU (~0.5-0.75% submission rate) +\nCapacity: Support 500 submissions/day (3x expected volume for growth), 2,000 submissions/day (peak/incident scenarios)\n\n|NFR-SCALE-003\n|Auto-scaling: ProfileService and EngagementService\n|Auto-scale based on CPU/memory/request rate, scale up within 2 minutes\n\n|NFR-SCALE-004\n|Event Bus queue capacity\n|Support 100,000 queued messages (buffer for Salesforce downtime)\n\n|NFR-SCALE-005\n|Salesforce API rate limit compliance\n|Stay within 80% of Salesforce API rate limits (buffer for spikes)\n\n|NFR-SCALE-006\n|Future growth capacity\n|Architecture supports 10x growth (1,000-1,500 submissions/day based on 200k DAU) without major redesign\n\n|===\n\n=== Security Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-SEC-001\n|Mobile App authentication\n|Microsoft Entra External ID OAuth 2.0 with JWT tokens (existing CIAM)\n\n|NFR-SEC-002\n|API authorisation: ProfileService and EngagementService\n|JWT token validation, authenticated users only, user context propagation\n\n|NFR-SEC-003\n|Salesforce API authentication\n|OAuth 2.0 with Connected App and JWT bearer flow (service account)\n\n|NFR-SEC-004\n|Data encryption in transit\n|TLS 1.2+ for all API calls (Mobile App ↔ ProfileService/EngagementService ↔ Salesforce ↔ Braze)\n\n|NFR-SEC-005\n|Data encryption at rest\n|Salesforce encryption at rest (managed by Salesforce), Event Bus message encryption (AWS KMS)\n\n|NFR-SEC-006\n|Secret management\n|AWS Secrets Manager for Salesforce credentials, Braze API keys, OAuth tokens (no hardcoded secrets)\n\n|NFR-SEC-007\n|PII data handling\n|Contact data (email, phone, name) treated as PII, GDPR-compliant retention policies (Salesforce governance)\n\n|NFR-SEC-008\n|API rate limiting and throttling\n|API Gateway rate limiting (100 requests/second per user), prevent abuse and DoS\n\n|NFR-SEC-009\n|Logging and auditing\n|Log all API calls, Salesforce Contact/Case creates/updates, Event Bus publishes (no PII in logs)\n\n|NFR-SEC-010\n|Salesforce data isolation\n|Multi-tenant data isolation via Salesforce Record Types, queues, sharing rules (defined by Viva Energy admin team)\n\n|===\n\n=== Reliability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-REL-001\n|Retry logic: EngagementService → Salesforce Case creation\n|Exponential backoff (1s, 2s, 4s, 8s, 16s), max 5 retries, then dead letter queue\n\n|NFR-REL-002\n|Dead letter queue monitoring\n|Alert ops team immediately when DLQ depth > 0 (failed Case creations require manual intervention)\n\n|NFR-REL-003\n|Event Bus message durability\n|Messages persisted in Event Bus (SNS+SQS/EventBridge/Kinesis), not lost on service restart\n\n|NFR-REL-004\n|Idempotency: Case creation\n|EngagementService ensures duplicate feedback submissions don't create duplicate Cases (idempotency key)\n\n|NFR-REL-005\n|Circuit breaker: Salesforce API calls\n|Open circuit after 5 consecutive failures, half-open retry after 30 seconds\n\n|NFR-REL-006\n|Health checks: ProfileService and EngagementService\n|Health endpoints for load balancer checks, readiness and liveness probes\n\n|NFR-REL-007\n|Disaster recovery: Event Bus\n|Event Bus messages replicated across AWS availability zones (SQS/EventBridge/Kinesis HA)\n\n|===\n\n=== Maintainability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-MAINT-001\n|Code quality: ProfileService and EngagementService\n|> 80% test coverage (unit + integration tests), automated CI/CD pipeline\n\n|NFR-MAINT-002\n|API documentation\n|OpenAPI/Swagger specs for ProfileService and EngagementService, auto-generated API docs\n\n|NFR-MAINT-003\n|Deployment automation\n|Infrastructure as Code (Terraform/CloudFormation/CDK), zero-downtime deployments\n\n|NFR-MAINT-004\n|Logging: structured logs\n|JSON-formatted logs with correlation IDs, log levels (DEBUG, INFO, WARN, ERROR), centralized log aggregation\n\n|NFR-MAINT-005\n|Monitoring dashboards\n|Real-time dashboards for ProfileService, EngagementService, Event Bus (see Monitoring and Observability section)\n\n|NFR-MAINT-006\n|Alerting and on-call\n|PagerDuty/Opsgenie integration for P1/P2 alerts, on-call rotation for ops team\n\n|NFR-MAINT-007\n|Configuration management\n|Externalized configuration (environment variables, AWS Parameter Store), no hardcoded config\n\n|NFR-MAINT-008\n|Versioning: API and events\n|Semantic versioning (v1, v2), backward compatibility for API changes, event schema evolution\n\n|===\n\n=== Usability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-USE-001\n|Feedback submission UX\n|Mobile App user receives immediate \"Feedback submitted\" confirmation (< 1 second), not blocked by async Case creation\n\n|NFR-USE-002\n|Push notification delivery\n|Customer receives \"Your feedback has been received\" notification within 30 seconds of Case creation in Salesforce\n\n|NFR-USE-003\n|Case resolution notification\n|Customer receives \"Your case has been resolved\" notification within 30 seconds of support agent resolving Case\n\n|NFR-USE-004\n|Error messaging\n|User-friendly error messages for failed feedback submission (not technical errors), retry prompts\n\n|NFR-USE-005\n|Accessibility\n|Mobile App feedback form meets WCAG 2.1 AA accessibility standards (existing Mobile App compliance)\n\n|===\n\n=== Compliance Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-COMP-001\n|GDPR compliance: PII data\n|Customer Contact data (email, phone, name) managed per GDPR retention policies (Salesforce governance)\n\n|NFR-COMP-002\n|GDPR compliance: Right to erasure\n|Support \"Delete Account\" feedback category, trigger Contact deletion in Salesforce per GDPR Article 17\n\n|NFR-COMP-003\n|Data residency\n|Salesforce data residency governed by Viva Energy Salesforce configuration (regional compliance)\n\n|NFR-COMP-004\n|Audit trail\n|All Contact creates/updates, Case creates/updates logged for compliance auditing (Salesforce audit logs)\n\n|NFR-COMP-005\n|API security standards\n|OWASP API Security Top 10 compliance (injection prevention, authentication, authorisation, data exposure)\n\n|===\n\n== Monitoring and Observability\n\n=== Key Metrics\n\n[width=\"100%\",cols=\"25%,40%,35%\",options=\"header\",]\n|===\n|Metric Category |Metric |Target/Threshold\n\n|*Feedback Submission*\n|Feedback submission success rate (Mobile App → EngagementService)\n|> 99.5%\n\n|*Async Case Creation*\n|Case creation success rate (EngagementService → Salesforce)\n|> 99%\n\n|*Async Case Creation*\n|Case creation latency (time from feedback submission to Case created in Salesforce)\n|p95 < 5 minutes\n\n|*Event Bus*\n|Event Bus queue depth (pending Case creations)\n|< 100 messages\n\n|*Event Bus*\n|Dead letter queue depth (failed Case creations)\n|= 0 (alert on any failures)\n\n|*Salesforce API*\n|Salesforce API error rate\n|< 1%\n\n|*Salesforce API*\n|Salesforce API latency (Case creation)\n|p95 < 2 seconds\n\n|*Salesforce API*\n|Salesforce API rate limit utilization\n|< 80% of limit\n\n|*ProfileService*\n|Contact reconciliation success rate (JIT lookups)\n|> 99.5%\n\n|*ProfileService*\n|Contact reconciliation latency\n|p95 < 500ms\n\n|*Braze Notifications*\n|Push notification delivery rate (Case created/updated)\n|> 95%\n\n|*Salesforce Webhook*\n|Webhook delivery success rate (Salesforce → EngagementService)\n|> 99%\n\n|*Customer Satisfaction*\n|Customer satisfaction score (CSAT)\n|> 4.0/5.0 (improve by 15% from D365 CE baseline)\n\n|*Support Operations*\n|Average case resolution time\n|Decrease by 20% from D365 CE baseline\n\n|===\n\n=== Alerting Thresholds\n\n[width=\"100%\",cols=\"25%,50%,25%\",options=\"header\",]\n|===\n|Alert |Condition |Severity\n\n|*Feedback submission failures*\n|Feedback submission success rate < 95% over 5-minute window\n|P1 - Critical\n\n|*Dead letter queue accumulation*\n|Dead letter queue depth > 0 (any failed Case creations)\n|P2 - High\n\n|*Event Bus queue backlog*\n|Event Bus queue depth > 100 messages for > 15 minutes\n|P2 - High\n\n|*Salesforce API errors*\n|Salesforce API error rate > 5% over 5-minute window\n|P1 - Critical\n\n|*Salesforce API rate limits*\n|Salesforce API rate limit utilization > 90%\n|P2 - High\n\n|*Contact reconciliation failures*\n|ProfileService Contact reconciliation failure rate > 5% over 5-minute window\n|P2 - High\n\n|*Braze notification failures*\n|Braze push notification delivery rate < 80% over 15-minute window\n|P3 - Medium\n\n|*Salesforce webhook failures*\n|Salesforce webhook delivery success rate < 90% over 15-minute window\n|P2 - High\n\n|*Case creation latency*\n|Case creation latency p95 > 10 minutes\n|P3 - Medium\n\n|===\n\n=== Dashboards\n\n*ProfileService Dashboard:*\n\n* Contact reconciliation success rate (JIT lookups)\n* Contact reconciliation latency (p50, p95, p99)\n* Contact creation vs update ratio (new Contacts created vs existing Contacts updated)\n* Salesforce API error rate (Contact queries and creates)\n* Request rate and throughput\n\n*EngagementService Dashboard:*\n\n* Feedback submission success rate\n* Case creation success rate (async workflow)\n* Case creation latency (p50, p95, p99)\n* Event Bus queue depth (pending Case creations)\n* Dead letter queue depth (failed Case creations)\n* Salesforce API error rate (Case creation)\n* Salesforce API latency\n* Salesforce API rate limit utilization\n* Braze push notification delivery rate\n* Salesforce webhook delivery success rate\n\n*Event Bus Dashboard:*\n\n* Queue depth (pending messages)\n* Throughput (messages published/consumed per minute)\n* Dead letter queue depth (failed messages)\n* Consumer lag (time between publish and consume)\n\n*Customer Support Dashboard (Business Metrics):*\n\n* Total feedback submissions per day/week/month\n* Feedback category breakdown (App, Service, Order, Rewards, Refund, Delete Account)\n* Customer satisfaction score (CSAT) trend\n* Average case resolution time trend\n* Case volume by support team/queue\n* Unified customer view adoption (support agent feedback)\n<<<\n== Solution Validation\n\nThis section defines the validation criteria and testing approach for the solution.\n\n=== Functional Validation\n\n==== ProfileService API Testing\n\n*Test Scenarios*:\n1. **Happy Path**: Authenticated user requests Contact ID, existing Contact found in Salesforce, Contact ID returned\n2. **JIT Creation**: Authenticated user requests Contact ID, no existing Contact, new Contact created in Salesforce, Contact ID returned\n3. **Salesforce API Failure**: Salesforce unavailable, ProfileService returns 500 error, user retries\n4. **Invalid JWT**: Unauthenticated request, ProfileService returns 401 error\n\n*Acceptance Criteria*:\n- Contact reconciliation success rate > 99.5%\n- JIT Contact creation completes within 500ms (p95)\n\n==== EngagementService API Testing\n\n*Test Scenarios*:\n1. **Happy Path**: Valid feedback submission, immediate 202 Accepted response, Case created in Salesforce within 5 minutes, Braze notification delivered\n2. **Invalid Category**: Invalid feedback category, 400 Bad Request response with validation error\n3. **Salesforce Downtime**: Salesforce unavailable during async Case creation, message queued, retry logic executes, Case created when Salesforce recovers\n4. **Dead Letter Queue**: Case creation fails after 5 retries, message moved to DLQ, ops team alerted\n5. **Webhook Notification**: Support agent resolves Case in Salesforce, webhook triggers EngagementService, Braze push notification sent to customer\n\n*Acceptance Criteria*:\n- Feedback submission success rate > 99.5% (including async Case creation)\n- Async Case creation completes within 5 minutes (p95)\n- Webhook delivery success rate > 99%\n\n=== Non-Functional Validation\n\n==== Performance Testing\n\n*Load Testing*:\n\n*Baseline*: Expected 100-150 submissions/day from 20k DAU (~0.5-0.75% submission rate)\n\n- **Normal Load**: 1 submission/minute sustained for 2 hours (simulate typical daily pattern)\n- **3x Load**: 3 submissions/minute sustained for 1 hour (simulate busy period, 450 submissions/day)\n- **Peak Load (10x)**: 10 submissions/minute for 15 minutes (simulate incident scenario, app outage causing backlog)\n- **Stress Test**: 50 submissions/minute for 5 minutes (find breaking point, 20x normal)\n\n*Validation*:\n- API response time p95 < 1 second under 10x load\n- Event Bus queue depth remains manageable (< 100 messages)\n- No Case creation failures, all submissions processed successfully\n- Auto-scaling triggers appropriately for sustained load > 3x baseline\n\n*Acceptance Criteria*:\n- NFR-PERF-001 through NFR-PERF-006 validated under realistic load (3x and 10x baseline)\n- Auto-scaling triggers within 2 minutes of load increase\n- System handles 10x peak gracefully, 20x stress test identifies limits\n\n==== Resilience Testing\n\n*Salesforce API Failure Scenarios*:\n1. **Complete Outage**: Salesforce unavailable for 2 hours, Event Bus queues buffer work, Cases created when Salesforce recovers\n2. **Rate Limit Exceeded**: Salesforce rate limit hit, queue throttling activates, Cases created within SLA\n\n*Acceptance Criteria*:\n- NFR-AVAIL-004 validated (graceful degradation during Salesforce downtime)\n- Circuit breaker activates after 5 consecutive failures\n\n==== Security Validation\n\n*Penetration Testing*:\n- API authentication bypass attempts\n- SQL injection attempts\n- Webhook signature validation bypass\n\n*Acceptance Criteria*:\n- NFR-SEC-001 through NFR-SEC-010 validated\n- OWASP API Security Top 10 compliance verified\n\n=== Integration Validation\n\n==== End-to-End Testing\n\n*Full User Journey*:\n1. User authenticates via Microsoft Entra External ID\n2. Mobile App requests Contact ID from ProfileService (JIT reconciliation)\n3. User submits feedback via EngagementService\n4. Background worker creates Case in Salesforce\n5. Braze notification delivered to user\n6. Support agent resolves Case in Salesforce\n7. Salesforce webhook triggers EngagementService\n8. Braze notification delivered to user\n\n*Acceptance Criteria*:\n- End-to-end flow completes successfully in UAT\n- User receives both \"feedback submitted\" and \"case resolved\" notifications\n","structuredPatch":[{"oldStart":2102,"oldLines":13,"newStart":2102,"newLines":13,"lines":[" "," *Prerequisites*:"," ","-* WP-CS-001 (ProfileService Development) completed","-* WP-CS-002 (EngagementService Development) completed","-* WP-CS-003 (Event Bus Infrastructure) completed","-* WP-CS-005 (Mobile App Integration) completed","-* WP-CS-006 (Integration Testing) completed with UAT sign-off","-* WP-CS-007 (Salesforce Configuration) production configuration completed","-* WP-CS-008 (Contact Data Migration) completed successfully","+* <<wp-cs-001,WP-CS-001>> (ProfileService Development) completed","+* <<wp-cs-002,WP-CS-002>> (EngagementService Development) completed","+* <<wp-cs-003,WP-CS-003>> (Event Bus Infrastructure) completed","+* <<wp-cs-005,WP-CS-005>> (Mobile App Integration) completed","+* <<wp-cs-006,WP-CS-006>> (Integration Testing) completed with UAT sign-off","+* <<wp-cs-007,WP-CS-007>> (Salesforce Configuration) production configuration completed","+* <<wp-cs-008,WP-CS-008>> (Contact Data Migration) completed successfully"," * Mobile App release approval (App Store, Google Play)"," "," *Dependent Work Packages*:"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"e79d73c2-d32d-4fb6-9c90-b628f8894d7f"}
{"parentUuid":"8bea5b82-6ce0-47a3-836d-5db1ec23531c","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01C8nfY8TnFh8xaRHWJX58HJ","type":"tool_result","content":"The file /mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n  2164→** Lessons learned document\n  2165→\n  2166→==== Dependencies\n  2167→\n  2168→*Prerequisites*:\n  2169→\n  2170→* <<wp-cs-009,WP-CS-009>> (Production Deployment) completed\n  2171→* Cutover successful with no critical incidents\n  2172→\n  2173→*Dependent Work Packages*:\n  2174→\n  2175→* Final work package in sequence"}]},"uuid":"c59b3b08-e04a-475a-8a89-5711dda91229","timestamp":"2026-01-09T03:12:01.595Z","toolUseResult":{"filePath":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","oldString":"*Prerequisites*:\n\n* WP-CS-009 (Production Deployment) completed\n* Cutover successful with no critical incidents","newString":"*Prerequisites*:\n\n* <<wp-cs-009,WP-CS-009>> (Production Deployment) completed\n* Cutover successful with no critical incidents","originalFile":"= Salesforce Customer Support - Solution Architecture\n:project-name: Salesforce Customer Support\n:togaf-adm-phase: Phase E: Opportunities & Solutions\n:last-updated: 2026-01-07\n:document-type: Solution Architecture Document\n:status: Discovery\n:version: 0.1\n:domain: Customer Support & Engagement\n:programme-lead:\n:domain-architect: O.Young@otr.com.au\n:architecture-definition: xref:architecture-definitions:salesforce_customer_support.adoc[Architecture Definitions/Salesforce Customer Support]\n:doctype: article\n:toc: left\n:toclevels: 4\n:sectanchors:\n:sectlinks:\n:sectnums:\n:icons: font\n:source-highlighter: highlightjs\n:experimental:\n:description:\n:keywords:\n\n<<<\n== Purpose and Scope\n\n=== Purpose\n\nThis Solution Architecture defines how the Salesforce Customer Support consolidation will be implemented - the specific technology products, configurations, interfaces, and deployment architecture that realise the xref:architecture-definitions:salesforce_customer_support.adoc[Salesforce Customer Support Architecture Definition].\n\nThis solution establishes the **first implementation of OTR's target Domain-Driven Design (DDD) architecture** by deploying two new bounded contexts (`ProfileService` and `EngagementService`) as microservices, consolidating customer support onto Salesforce Service Cloud, and implementing event-driven integration patterns that will serve as the foundation for future bounded contexts (including Flybuys integration).\n\n=== Vision\n\n> Unify customer support across all OTRG channels by consolidating OTR digital customer feedback onto Salesforce Service Cloud, establishing the foundational DDD architecture with ProfileService and EngagementService bounded contexts that protect digital channels from external system changes while enabling support agents to deliver exceptional customer experiences with complete interaction history.\n\n=== Architectural Approach\n\nThis architecture establishes OTR's **first bounded context implementation** using Domain-Driven Design strategic patterns:\n\n* *link:../bounded_context/profile.adoc[ProfileService]* (NEW bounded context): Just-In-Time Contact reconciliation with Salesforce, upsert by email, returns Salesforce Contact ID to digital channels - foundation for future Flybuys partner linking\n* *link:../bounded_context/engagement.adoc[EngagementService]* (NEW bounded context): Customer feedback submission facade, Anti-Corruption Layer for Salesforce Case creation, Braze integration for all outbound customer communications (push, email, SMS), async Case processing via Event Bus\n* *Event-driven integration* (NEW pattern): Domain event publishing using existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis) - first implementation establishing pattern for future bounded contexts\n* *Anti-Corruption Layer*: EngagementService isolates digital channels from Salesforce API changes, translates between OTR domain language and Salesforce Service Cloud API\n* *Conformist Pattern*: ProfileService and EngagementService conform to existing Salesforce configuration (shared Viva Energy instance, multi-tenant governance)\n* *Big bang cutover*: Single deployment after Contact migration, no phased rollout, D365 CE retirement post-cutover\n\n=== Scope\n\n==== In Scope\n\n* Solution Building Blocks (SBBs) - specific technology products and versions\n* Interface specifications (APIs, events, data formats)\n* Data architecture and schema specifications\n* Deployment architecture and infrastructure configuration\n* Transition architecture with migration phases\n* Technical validation criteria and testing approach\n* External system integration specifications\n* Physical data models and API schemas\n\n==== Out of Scope\n\n===== Covered in xref:architecture-definitions:salesforce_customer_support.adoc[Architecture Definition]\n\n* Business requirements and stakeholder analysis\n* Architecture decisions and rationale (ADRs)\n* Bounded context definitions and responsibilities\n* High-level integration patterns (ACL, Conformist, OHS+PL)\n* Business capability mapping and value streams\n* Architecture principles and governance\n\n===== Covered in Other Documents\n\n* Detailed design (class diagrams, sequence diagrams for all flows)\n* Implementation code and unit tests\n* Business case and return-on-investment analysis\n* Operational run books and support procedures\n\n<<<\n=== Architecture Overview\n\n[mermaid]\n----\n---\nconfig:\n  layout: elk\n---\nflowchart TB\n    Customer([\"Customer\"]) -- Uses --> MobileApp[\"Mobile App<br>iOS/Android\"]\n    Customer -- Shops at --> POS[\"OTR/OTR+ POS<br>D365 Commerce\"]\n    MobileApp -- Authenticate --> EntraID[\"Microsoft Entra\"]\n    MobileApp -- Identifies & Reconciles --> ProfileService[\"ProfileService\"]\n    ProfileService <-- Reconcile App User as Salesforce Contact --> Salesforce[\"Salesforce\"]\n    ProfileService -- On Create --> EventBus[\"EventBus\"]\n    EventBus -- Emits CreateUser Event --> LoyaltyService[\"LoyaltyService\"] & EngagementService[\"EngagementService\"]\n    LoyaltyService -- Reconcile Wallet --> EagleEye[\"EagleEye\"]\n    EngagementService -- Reconcile Braze Profile --> Braze[\"Braze\"]\n    EngagementService --> Salesforce\n    D365CE[\"D365CE\"] -- Data Migration --> Salesforce\n    MobileApp -- Submits Feedback --> EngagementService\n\n    Customer:::customer\n    MobileApp:::presentation\n    POS:::presentation\n    EntraID:::external\n    ProfileService:::newService\n    Salesforce:::external\n    EventBus:::infrastructure\n    LoyaltyService:::newService\n    EngagementService:::newService\n    EagleEye:::external\n    Braze:::external\n    D365CE:::external\n    classDef newService fill:#4CAF50,stroke:#2E7D32,stroke-width:3px,color:#fff\n    classDef external fill:#FF9800,stroke:#E65100,stroke-width:2px,color:#fff\n    classDef infrastructure fill:#2196F3,stroke:#0D47A1,stroke-width:2px,color:#fff\n    classDef presentation fill:#9C27B0,stroke:#4A148C,stroke-width:2px,color:#fff\n    classDef customer fill:#607D8B,stroke:#263238,stroke-width:2px,color:#fff\n----\n\n\n==== Key Architectural Patterns\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Pattern |Application |Rationale\n\n|*Anti-Corruption Layer (ACL)*\n|EngagementService → Salesforce Service Cloud\n|Protects digital channels (Mobile App, Web) from Salesforce API changes, translates between OTR domain language and Salesforce Case/Contact model, enables independent evolution of internal domain model\n\n|*Conformist*\n|ProfileService → Salesforce, EngagementService → Salesforce\n|Shared Viva Energy Salesforce instance - we conform to existing configuration, governance, and API contracts (external system we don't control)\n\n|*Backend-for-Frontend (BFF)*\n|EngagementService\n|Aggregates customer feedback submission, Contact lookup, async Case creation, and Braze notification orchestration for digital channel clients\n\n|*Event-Driven Architecture (OHS+PL)*\n|Event Bus (SNS+SQS/EventBridge/Kinesis)\n|Loose coupling between bounded contexts, async domain event publishing (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`), foundation for future bounded contexts\n\n|*Just-In-Time (JIT) Integration*\n|ProfileService → Salesforce Contact reconciliation\n|Reconcile app users as Salesforce Contacts on-demand (upsert by email), no pre-sync required, ensures Salesforce has current Contact data\n\n|*Async Processing*\n|EngagementService Case creation via Event Bus\n|Non-blocking user experience, resilience to Salesforce downtime, automatic retry with exponential backoff, dead letter queue for operations team intervention\n\n|*Strangler Fig*\n|Not applicable\n|Big bang cutover (no gradual migration) - D365 CE fully replaced, not incrementally strangled\n\n|===\n\n<<<\n== Solution Approach\n\n* Deploy xref:bounded-contexts:profile.adoc[ProfileService] and xref:bounded-contexts:engagement.adoc[EngagementService] as bounded context microservices\n* Implement Anti-Corruption Layers (ACLs) for Salesforce and Braze integration\n* Establish event-driven architecture as the foundational integration pattern\n* Big bang cutover (TS-1 → TS-4)\n\n=== Related Documentation\n\nThis solution architecture references detailed technical specifications:\n\n==== Architecture Definition\n\n* xref:architecture-definitions:salesforce_customer_support.adoc[Salesforce Customer Support - Architecture Definition] - Business requirements, architecture decisions (ADRs), bounded context definitions, high-level integration patterns\n\n==== Bounded Context Specifications\n\n* xref:bounded-contexts:profile.adoc[ProfileService Bounded Context] - JIT Contact reconciliation, aggregate definitions\n* xref:bounded-contexts:engagement.adoc[EngagementService Bounded Context] - Customer feedback facade, Anti-Corruption Layer\n\n==== Interface Specifications\n\nDetailed API specifications available in the specifications directory:\n\n* link:../../specifications/rest/profile-service-v1.yaml[ProfileService REST API v1] - OpenAPI 3.0 specification for `/profile/v1` endpoints (includes Salesforce Contact reconciliation `GET /contact-id`)\n* link:../../specifications/rest/engagement-service-v1.yaml[EngagementService REST API v1] - OpenAPI 3.0 specification for `/engagement/v1` endpoints (includes `POST /feedback`)\n* link:../../specifications/events/engagement-events.json[Engagement Domain Events] - CloudEvents 1.0 JSON Schema for `SupportCaseCreated`, `SupportCaseUpdated`, `SupportCaseResolved`, `CustomerFeedbackSubmitted`\n\n==== External System Documentation\n\n* https://developer.salesforce.com/docs/atlas.en-us.api_rest.meta/api_rest/[Salesforce REST API Documentation] - Contact and Case object APIs\n* https://www.braze.com/docs/api/endpoints/messaging/send_messages/post_send_triggered_campaigns/[Braze Campaign Trigger API] - Push notification campaigns\n\n<<<\n== Executive Summary\n\n=== Challenge\n\nOTR digital customers (Mobile App, Web) currently submit feedback and support requests to D365 Customer Engagement, while Viva Energy's broader business units (fuel wholesale, Shell Card customers, other retail channels) use Salesforce Service Cloud. This creates:\n\n* *Fragmented customer support platform*: Customer support data split across two systems, preventing support agents from having a unified view of customer interactions across all channels\n* *Operational inefficiency*: Maintaining two separate customer support platforms increases operational overhead and costs\n* *Poor support experience*: D365 CE is not working well for digital customer support, impacting customer satisfaction and case resolution times\n* *Post-merger consolidation opportunity*: Following Viva Energy's acquisition of OTR, strategic alignment on Salesforce as the enterprise customer support platform\n\n=== Solution\n\nThis architecture establishes the **foundational Domain-Driven Design (DDD) implementation** for OTR's target state architecture by introducing two new bounded contexts (link:../bounded_context/profile.adoc[ProfileService], link:../bounded_context/engagement.adoc[EngagementService]) and event-driven integration patterns:\n\n==== New Bounded Contexts\n\n* *link:../bounded_context/profile.adoc[ProfileService]* (NEW): Just-In-Time (JIT) Contact reconciliation with Salesforce, upsert by email, returns Salesforce Contact ID to Mobile App\n* *link:../bounded_context/engagement.adoc[EngagementService]* (NEW): Customer feedback submission, Anti-Corruption Layer (ACL) for Salesforce Case creation, Braze integration for all outbound customer communications (push, email, SMS), async Case processing via Event Bus\n* *Event Bus* (NEW pattern): Domain event publishing using existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis) - first implementation of event-driven architecture pattern\n\n==== Integration Architecture\n\n* *Salesforce = System of Record*: Salesforce Service Cloud (shared Viva Energy instance) owns Contact and Case data\n* *Conformist Pattern*: ProfileService and EngagementService conform to existing Salesforce configuration and API contracts\n* *Anti-Corruption Layer*: EngagementService protects digital channels from Salesforce API changes, translates between OTR domain language and Salesforce\n* *Async Case Creation*: Non-blocking user experience, resilience to Salesforce downtime, automatic retry with exponential backoff, dead letter queue for failed Cases\n* *Event-Driven Notifications*: Salesforce webhook → EngagementService → Braze for all customer communications (push, email, SMS) on Case status updates\n\n==== Migration Approach\n\n* *Contact Migration*: One-time migration from app-specific database → Salesforce (upsert with flexible matching by email/phone/VCI)\n* *No Case Migration*: Historical D365 CE Cases not migrated (fresh start in Salesforce)\n* *Big Bang Cutover*: Single deployment, no phased rollout or parallel run\n* *D365 CE Retirement*: Complete decommissioning of D365 Customer Engagement post-cutover\n\n=== Key Architectural Significance\n\nThis migration establishes the first implementation of OTR's target DDD architecture:\n\n* First bounded contexts implemented (ProfileService, EngagementService)\n* First event-driven domain event pattern (foundation for future bounded contexts)\n* Foundation for Flybuys integration (ProfileService Contact reconciliation reused)\n* Establishes integration patterns (Conformist, ACL, Event-Driven) for future services\n\n=== Success Criteria\n\n* All digital customer feedback routed to Salesforce Service Cloud within 30 days of launch\n* Support agents have unified customer view across all Viva Energy channels (digital, wholesale, Shell Card, other retail)\n* D365 Customer Engagement decommissioned within 90 days post-cutover\n* Customer satisfaction score improves by 15% within 6 months\n* Average case resolution time decreases by 20% within 6 months\n* Zero data loss during Contact migration (100% validation pass rate)\n* Mobile App feedback submission success rate > 99.5% (including async Case creation)\n\n=== Technical Constraints\n\n* Shared Salesforce instance (Viva Energy multi-tenant environment)\n* Conform to existing Salesforce configuration and governance (data isolation strategy TBD with Salesforce admin team)\n* Contact migration must complete before cutover (no parallel run)\n* Async Case creation mandatory (non-blocking user experience)\n* Expected volume: 100-150 feedback submissions/day from 20k DAU (~0.5-0.75% submission rate), architecture capacity planned for 3x-10x growth\n\n=== Open Technical Decisions (TBD)\n\n* Salesforce Case field mapping for digital feedback categories (App, Service, Order, Rewards, Refund, Delete Account)\n* Salesforce data isolation strategy (Record Types, custom fields, queues)\n* Salesforce REST API authentication method (OAuth 2.0, Connected App, JWT bearer flow)\n* Salesforce webhook mechanism for Case updates (Outbound Messages, Platform Events, Process Builder)\n* Retry policy configuration (attempts, backoff intervals)\n* Salesforce API rate limit strategy (expected volume: 100-150 submissions/day from 20k DAU, capacity planning for 3x-10x growth)\n\n== Technical Requirements\n\n[width=\"100%\",cols=\"8%,92%\",options=\"header\",]\n|===\n|ID |Description\n\n|TR-CS-001\n|Every Mobile App user must have a Salesforce Contact record in Salesforce Service Cloud (shared Viva Energy instance)\n\n|TR-CS-002\n|ProfileService must reconcile Mobile App users as Salesforce Contacts using Just-In-Time (JIT) upsert by email address\n\n|TR-CS-003\n|ProfileService must return Salesforce Contact ID to Mobile App for feedback submission\n\n|TR-CS-004\n|Mobile App must support customer feedback submission with fields: Category (App, Service, Order, Rewards, Refund, Delete Account), Store Name, Time of Visit, Contact Phone Number, Free Text Message\n\n|TR-CS-005\n|EngagementService must create Salesforce Cases asynchronously via Event Bus (non-blocking user experience)\n\n|TR-CS-006\n|EngagementService must acknowledge feedback submission immediately to Mobile App user (\"Feedback submitted\" confirmation)\n\n|TR-CS-007\n|EngagementService must send push notification to customer via Braze when Case is successfully created in Salesforce\n\n|TR-CS-008\n|EngagementService must retry failed Case creation with configurable exponential backoff and dead letter queue for operations team intervention\n\n|TR-CS-009\n|Salesforce must be the System of Record for Contact and Case data (no local persistence in ProfileService or EngagementService)\n\n|TR-CS-010\n|Contact migration from app-specific database to Salesforce must complete before Mobile App cutover (upsert with flexible matching by email/phone/VCI)\n\n|TR-CS-011\n|No Case migration from D365 Customer Engagement to Salesforce (fresh start, historical Cases not migrated)\n\n|TR-CS-012\n|EngagementService must publish domain events (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`) to Event Bus for consumption by other bounded contexts\n\n|TR-CS-013\n|EngagementService must receive Salesforce webhook notifications when Cases are updated/resolved by support agents\n\n|TR-CS-014\n|EngagementService must trigger Braze push notifications to customers when Cases are updated/resolved (via Salesforce webhook → EngagementService → Braze)\n\n|TR-CS-015\n|ProfileService and EngagementService must conform to existing Salesforce configuration and API contracts (Conformist pattern)\n\n|TR-CS-016\n|All changes must be communicated using event-driven architecture via Event Bus (using existing AWS infrastructure: SNS+SQS/EventBridge/Kinesis)\n\n|TR-CS-017\n|Mobile App feedback submission success rate must exceed 99.5% (including async Case creation completion)\n\n|TR-CS-018\n|Contact migration must achieve 100% validation pass rate (zero data loss)\n\n|TR-CS-019\n|D365 Customer Engagement must be fully decommissioned within 90 days post-cutover\n\n|===\n\n== Technical Architecture\n\n=== Technical Capability Requirements\n\n==== Requirements Traceability\n\n[width=\"100%\",cols=\"15%,50%,35%\",options=\"header\",]\n|===\n|Requirement ID |Requirement Summary |Architectural Building Blocks\n\n|TR-CS-001\n|Every Mobile App user must have Salesforce Contact record\n|ABB-CS-001 (ProfileService), ABB-CS-004 (Salesforce), ABB-CS-007 (Contact Migration Tool)\n\n|TR-CS-002\n|ProfileService JIT Contact reconciliation via upsert by email\n|ABB-CS-001 (ProfileService), ABB-CS-004 (Salesforce)\n\n|TR-CS-003\n|ProfileService returns Salesforce Contact ID to Mobile App\n|ABB-CS-001 (ProfileService), ABB-CS-006 (Mobile App)\n\n|TR-CS-004\n|Mobile App supports feedback submission with structured fields\n|ABB-CS-006 (Mobile App), ABB-CS-002 (EngagementService)\n\n|TR-CS-005\n|EngagementService creates Salesforce Cases asynchronously\n|ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus), ABB-CS-004 (Salesforce)\n\n|TR-CS-006\n|EngagementService immediate acknowledgment to Mobile App\n|ABB-CS-002 (EngagementService), ABB-CS-006 (Mobile App)\n\n|TR-CS-007\n|EngagementService sends push notification via Braze on Case creation\n|ABB-CS-002 (EngagementService), ABB-CS-005 (Braze)\n\n|TR-CS-008\n|EngagementService retry logic with exponential backoff and DLQ\n|ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus)\n\n|TR-CS-009\n|Salesforce is System of Record for Contact and Case data\n|ABB-CS-004 (Salesforce), ABB-CS-001 (ProfileService - stateless), ABB-CS-002 (EngagementService - stateless)\n\n|TR-CS-010\n|Contact migration before Mobile App cutover\n|ABB-CS-007 (Contact Migration Tool), ABB-CS-004 (Salesforce)\n\n|TR-CS-011\n|No Case migration from D365 CE (fresh start)\n|ABB-CS-004 (Salesforce) - no migration tooling required\n\n|TR-CS-012\n|EngagementService publishes domain events to Event Bus\n|ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus)\n\n|TR-CS-013\n|EngagementService receives Salesforce webhook notifications\n|ABB-CS-002 (EngagementService), ABB-CS-004 (Salesforce)\n\n|TR-CS-014\n|EngagementService triggers Braze notifications on Case updates\n|ABB-CS-002 (EngagementService), ABB-CS-004 (Salesforce), ABB-CS-005 (Braze)\n\n|TR-CS-015\n|ProfileService and EngagementService conform to Salesforce config\n|ABB-CS-001 (ProfileService), ABB-CS-002 (EngagementService), ABB-CS-004 (Salesforce)\n\n|TR-CS-016\n|Event-driven architecture via Event Bus\n|ABB-CS-003 (Event Bus), ABB-CS-002 (EngagementService)\n\n|TR-CS-017\n|Mobile App feedback submission success rate > 99.5%\n|ABB-CS-006 (Mobile App), ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus), ABB-CS-004 (Salesforce)\n\n|TR-CS-018\n|Contact migration 100% validation pass rate\n|ABB-CS-007 (Contact Migration Tool), ABB-CS-004 (Salesforce)\n\n|TR-CS-019\n|D365 CE decommissioned within 90 days post-cutover\n|All ABBs (replacement system operational)\n\n|===\n\n=== Service Catalogues\n\n==== Application Portfolio Catalogue\n\n[width=\"100%\",cols=\"20%,15%,15%,15%,35%\",options=\"header\",]\n|===\n|Application |Lifecycle State |Owner |Hosting Platform |Description\n\n|*ProfileService*\n|NEW\n|OTR Platform Team\n|AWS (TBD: Lambda/ECS/EKS)\n|JIT Contact reconciliation with Salesforce, returns Salesforce Contact ID, foundation for Flybuys integration\n\n|*EngagementService*\n|NEW\n|OTR Platform Team\n|AWS (TBD: Lambda/ECS/EKS)\n|Customer feedback submission facade, ACL for Salesforce Case creation, Braze integration for all outbound communications (push, email, SMS), webhook receiver\n\n|*Mobile App (iOS)*\n|ACTIVE (UPDATE)\n|OTR Mobile Team\n|Apple App Store\n|iOS native app with feedback form, integrate with ProfileService and EngagementService APIs\n\n|*Mobile App (Android)*\n|ACTIVE (UPDATE)\n|OTR Mobile Team\n|Google Play Store\n|Android native app with feedback form, integrate with ProfileService and EngagementService APIs\n\n|*Salesforce Service Cloud*\n|ACTIVE (EXPAND)\n|Viva Energy Salesforce Admin Team\n|Salesforce (SaaS)\n|Shared Viva Energy instance, System of Record for Contact and Case data, adding OTR digital customer support\n\n|*Braze*\n|ACTIVE (EXTEND)\n|OTR Marketing Team\n|Braze (SaaS)\n|Marketing automation platform, EngagementService triggers push notifications for Case updates\n\n|*D365 Customer Engagement*\n|RETIRE\n|OTR Support Team\n|Microsoft Azure (SaaS)\n|Legacy customer support platform, decommissioned within 90 days post-cutover\n\n|*App-Specific Customer Database*\n|RETIRE\n|OTR Platform Team\n|AWS (RDS/DynamoDB)\n|Legacy customer contact storage, one-time migration to Salesforce, then deprecated\n\n|*Event Bus*\n|NEW\n|OTR Platform Team\n|AWS (SNS+SQS/EventBridge/Kinesis)\n|Domain event publishing infrastructure for bounded context integration\n\n|*Contact Migration Tool*\n|TEMPORARY\n|OTR Platform Team\n|AWS (Script/Lambda)\n|One-time migration app database → Salesforce with upsert logic, retired after migration complete\n\n|===\n\n==== Technology Capability Requirements\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Technology Capability |Implementation Technology (TBD in detailed design) |Requirements\n\n|*Microservice Hosting*\n|AWS Lambda / ECS / EKS\n|Host ProfileService and EngagementService with auto-scaling, high availability, monitoring\n\n|*API Gateway*\n|AWS API Gateway / Application Load Balancer\n|REST API routing, authentication, rate limiting, request validation for ProfileService and EngagementService\n\n|*Event Bus*\n|AWS SNS+SQS / EventBridge / Kinesis\n|Domain event publishing, async message processing, retry logic, dead letter queue\n\n|*Salesforce Integration*\n|Salesforce REST API / SOAP API\n|Contact CRUD operations, Case creation, webhook notifications, OAuth 2.0 authentication\n\n|*Braze Integration*\n|Braze REST API / SDK\n|Push notification campaign triggers, customer profile reconciliation\n\n|*Authentication & Authorisation*\n|Microsoft Entra External ID / AWS Cognito\n|Mobile App user authentication, API authorisation, JWT token validation\n\n|*Observability & Monitoring*\n|AWS CloudWatch / Datadog / New Relic\n|Application metrics, logs, traces, dashboards, alerting (feedback submission rate, queue depth, API errors)\n\n|*Secret Management*\n|AWS Secrets Manager / Parameter Store\n|Salesforce credentials, Braze API keys, OAuth tokens, encryption keys\n\n|*Database (Migration Tool)*\n|AWS RDS / DynamoDB (read-only access)\n|Contact migration from app-specific database\n\n|*CI/CD Pipeline*\n|GitHub Actions / AWS CodePipeline\n|Automated build, test, deployment for ProfileService, EngagementService, Mobile App\n\n|*Infrastructure as Code*\n|Terraform / AWS CloudFormation / CDK\n|Declarative infrastructure provisioning for Event Bus, microservices, monitoring\n\n|*API Documentation*\n|OpenAPI / Swagger\n|ProfileService and EngagementService API specifications for Mobile App integration\n\n|===\n\n==== Feature Flag Register\n\n*Note*: Per ADR-CS-006 (big bang cutover, not phased rollout), feature flags are minimal and used primarily for emergency rollback/kill switches.\n\n[width=\"100%\",cols=\"20%,15%,35%,30%\",options=\"header\",]\n|===\n|Feature Flag |Default State |Purpose |Rollback Scenario\n\n|*enable_salesforce_feedback_submission*\n|OFF (pre-cutover), ON (post-cutover)\n|Enable/disable feedback submission to EngagementService → Salesforce (kill switch for emergency rollback to D365 CE)\n|Feedback submission success rate < 95%, Salesforce API failures, critical bugs - revert to D365 CE integration\n\n|*enable_async_case_creation*\n|ON\n|Enable/disable async Case creation via Event Bus (fallback to synchronous processing if Event Bus issues)\n|Event Bus infrastructure failures, queue backlog unmanageable - temporary synchronous processing\n\n|*enable_braze_notifications*\n|ON\n|Enable/disable Braze push notifications for Case updates (degrade gracefully if Braze integration fails)\n|Braze API failures, notification delivery rate < 80% - disable notifications temporarily\n\n|*enable_jit_contact_reconciliation*\n|ON\n|Enable/disable ProfileService JIT Contact reconciliation (fallback to cached Contact IDs if Salesforce unavailable)\n|Salesforce API downtime, Contact reconciliation failures > 5% - use cached Contact IDs temporarily\n\n|*enable_salesforce_webhook_processing*\n|ON\n|Enable/disable Salesforce webhook processing for Case updates (fallback to polling if webhook failures)\n|Webhook delivery failures, authentication issues - temporary polling fallback\n\n|===\n\n*Feature Flag Management*:\n\n* Feature flags managed via AWS AppConfig / LaunchDarkly / custom feature flag service (TBD in detailed design)\n* Mobile App feature flags controlled server-side (no app release required for flag changes)\n* Backend service feature flags configured via environment variables / configuration service\n* Feature flag changes logged and audited (who changed, when, reason)\n* Post-cutover monitoring: Gradual removal of feature flags once system stability confirmed (30-60 days)\n\n==== Data Entity Catalogue\n\n[width=\"100%\",cols=\"20%,15%,35%,30%\",options=\"header\",]\n|===\n|Data Entity |System of Record |Key Attributes |Lifecycle\n\n|*Contact*\n|Salesforce Service Cloud\n|• Contact ID (Salesforce 15/18-char ID) +\n• Email (primary matching key) +\n• First Name, Last Name +\n• Phone Number +\n• Viva Consumer ID (VCI) +\n• Account (Viva Energy customer account) +\n• Record Type (OTR Digital vs other channels)\n|Created: ProfileService JIT reconciliation or Contact Migration Tool +\nUpdated: ProfileService JIT upsert (email changes), Salesforce (manual updates by support agents) +\nDeleted: Salesforce retention policy (GDPR/compliance)\n\n|*Case*\n|Salesforce Service Cloud\n|• Case Number (Salesforce auto-generated) +\n• Contact ID (reference to Contact) +\n• Subject (derived from Category) +\n• Description (Free Text Message) +\n• Category (App, Service, Order, Rewards, Refund, Delete Account) +\n• Store Name (OTR location) +\n• Time of Visit +\n• Status (New, In Progress, Resolved, Closed) +\n• Priority, Origin (Mobile App) +\n• Owner (support agent/queue)\n|Created: EngagementService async Case creation +\nUpdated: Support agents (Salesforce UI), EngagementService (webhook processing) +\nDeleted: Salesforce retention policy (archive after X years)\n\n|*Feedback Submission (transient)*\n|None (not persisted)\n|• Salesforce Contact ID +\n• Category +\n• Store Name +\n• Time of Visit +\n• Contact Phone Number +\n• Free Text Message\n|Created: Mobile App user submission +\nProcessed: EngagementService publishes to Event Bus, Case created in Salesforce +\nNot persisted in ProfileService/EngagementService (stateless)\n\n|*Domain Events*\n|Event Bus (ephemeral)\n|**SupportCaseCreated**: +\n• Case Number, Contact ID, Category, Timestamp +\n**SupportCaseUpdated**: +\n• Case Number, Status, Updated By, Timestamp +\n**SupportCaseResolved**: +\n• Case Number, Resolution, Resolved By, Timestamp +\n**CustomerFeedbackSubmitted**: +\n• Contact ID, Category, Timestamp\n|Published: EngagementService +\nConsumed: Other bounded contexts (future), Braze notification triggers +\nRetention: Short-lived (minutes to hours), not persisted for event sourcing\n\n|*Braze Customer Profile*\n|Braze\n|• External User ID (VCI or Email) +\n• Push Notification Tokens (iOS/Android) +\n• Notification Preferences +\n• Campaign Engagement History\n|Created/Updated: EngagementService on Case creation/update +\nManaged: Braze (external SaaS)\n\n|===\n\n*Data Migration Entities*:\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Source Entity |Target Entity |Migration Strategy\n\n|*App Database Contact*\n|Salesforce Contact\n|One-time migration via Contact Migration Tool: +\n• Upsert by email (primary), phone (secondary), VCI (tertiary) +\n• Map: Email → Email, Name → First/Last Name, Phone → Phone, VCI → External ID +\n• Validation: 100% data integrity check, reconciliation report\n\n|*D365 CE Case*\n|Not migrated\n|ADR-CS-005: No Case migration (fresh start in Salesforce) +\nD365 CE Cases archived separately for compliance if needed\n\n|===\n\n==== Data Quality & Validation\n\n*Contact Migration Validation Rules*:\n\n* Email format validation (RFC 5322 compliance)\n* Phone number format validation (E.164 international format)\n* VCI format validation (alphanumeric, length constraints)\n* Duplicate detection: Flag potential duplicates for manual review (same email/phone combination)\n* Mandatory fields: Email (required), First Name, Last Name (required for Salesforce Contact)\n\n*Case Creation Validation Rules*:\n\n* Contact ID must exist in Salesforce (validated by EngagementService before Case creation)\n* Category must be one of: App, Service, Order, Rewards, Refund, Delete Account\n* Free Text Message maximum length: 32,000 characters (Salesforce Case Description limit)\n* Store Name validated against OTR location master data (optional - warn if not found)\n\n<<<\n== Solution Building Blocks\n\nThis section defines the specific technology products, configurations, and implementation details for each Solution Building Block (SBB).\n\n=== Technology Portfolio Catalogue\n\n[width=\"100%\",cols=\"10%,20%,25%,25%,20%\",options=\"header\",]\n|===\n|SBB ID |Component |Technology Product |Version/Configuration |Deployment Platform\n\n|SBB-CS-001\n|ProfileService Microservice\n|.NET 8 / Node.js 20 LTS\n|RESTful API, containerised\n|AWS ECS Fargate / Lambda\n\n|SBB-CS-002\n|EngagementService Microservice\n|.NET 8 / Node.js 20 LTS\n|RESTful API, containerised, async workers\n|AWS ECS Fargate / Lambda\n\n|SBB-CS-003\n|Event Bus\n|AWS SNS + SQS / EventBridge\n|Standard queues, FIFO for ordering\n|AWS (managed service)\n\n|SBB-CS-004\n|API Gateway\n|AWS API Gateway / ALB\n|REST API, JWT validation\n|AWS (managed service)\n\n|SBB-CS-005\n|Salesforce Integration Layer\n|Salesforce REST API Client\n|OAuth 2.0 JWT bearer flow\n|Embedded in SBB-CS-001/002\n\n|SBB-CS-006\n|Braze Integration Layer\n|Braze REST API SDK\n|API key authentication\n|Embedded in SBB-CS-002\n\n|SBB-CS-007\n|Contact Migration Tool\n|Python 3.11 / .NET 8\n|One-time batch script\n|AWS Lambda / EC2\n\n|SBB-CS-008\n|Application Monitoring\n|AWS CloudWatch / Datadog\n|Metrics, logs, traces, dashboards\n|AWS / SaaS\n\n|SBB-CS-009\n|Secret Management\n|AWS Secrets Manager\n|KMS encryption\n|AWS (managed service)\n\n|SBB-CS-010\n|Mobile App (iOS)\n|SwiftUI, Kotlin Multiplatform\n|iOS 15+\n|Apple App Store\n\n|SBB-CS-011\n|Mobile App (Android)\n|Jetpack Compose, Kotlin Multiplatform\n|Android 8+\n|Google Play Store\n\n|SBB-CS-012\n|Feature Flag Service\n|AWS AppConfig / LaunchDarkly\n|Server-side flags, real-time updates\n|AWS / SaaS\n\n|===\n\n<<<\n== Data Architecture\n\nThis section defines the physical data models, event schemas, and API request/response formats.\n\n=== Domain Event Schemas\n\nAll domain events follow the https://cloudevents.io/[CloudEvents 1.0] specification for consistency and interoperability.\n\n*Event Schema Specifications*: See // TODO: Add to Antora - specifications/events/engagement-events.json[Engagement Service Event Schemas] for complete JSON schemas and examples.\n\n==== Event Catalogue\n\n[width=\"100%\",cols=\"30%,20%,50%\",options=\"header\",]\n|===\n|Event Type |Publisher |Description\n\n|`SupportCaseCreated`\n|EngagementService\n|Published when EngagementService successfully creates a Case in Salesforce after async processing\n\n|`SupportCaseUpdated`\n|EngagementService (via Salesforce webhook)\n|Published when a support agent updates a Case in Salesforce (status, priority, comment changes)\n\n|`SupportCaseResolved`\n|EngagementService (via Salesforce webhook)\n|Published when a support agent resolves/closes a Case in Salesforce\n\n|`CustomerFeedbackSubmitted`\n|EngagementService\n|Published when customer submits feedback via Mobile App (before async Case creation)\n\n|===\n\n*Event Format*: All events use CloudEvents 1.0 envelope with event-specific payload in the `data` field.\n\n*Schema Location*: `specifications/events/engagement-events.json`\n\n=== API Request/Response Schemas\n\n==== ProfileService: GET /profile/contact-id\n\n*Response* (200 OK):\n[source,json]\n----\n{\n  \"contactId\": \"0034X00000ABCDEFG\",\n  \"email\": \"customer@example.com\",\n  \"firstName\": \"John\",\n  \"lastName\": \"Smith\"\n}\n----\n\n==== EngagementService: POST /feedback\n\n*Request*:\n[source,json]\n----\n{\n  \"contactId\": \"0034X00000ABCDEFG\",\n  \"category\": \"App\",\n  \"storeName\": \"OTR Adelaide\",\n  \"timeOfVisit\": \"2026-01-07T12:00:00Z\",\n  \"contactPhoneNumber\": \"+61412345678\",\n  \"message\": \"App crashed when submitting feedback\"\n}\n----\n\n*Response* (202 Accepted):\n[source,json]\n----\n{\n  \"feedbackId\": \"fb-2026-01-07-12345\",\n  \"status\": \"submitted\",\n  \"message\": \"Your feedback has been submitted!\"\n}\n----\n\n=== Salesforce Field Mappings\n\n==== Case Object Mapping\n\n[width=\"100%\",cols=\"25%,25%,25%,25%\",options=\"header\",]\n|===\n|OTR Field |Salesforce Field |Data Type |Notes\n\n|Category\n|Feedback_Category__c\n|Picklist\n|App, Service, Order, Rewards, Refund, Delete Account\n\n|Store Name\n|Store_Name__c\n|String (255)\n|OTR location name\n\n|Time of Visit\n|Time_of_Visit__c\n|DateTime\n|When customer visited store\n\n|Free Text Message\n|Description\n|Long Text (32,000)\n|Customer feedback message\n\n|===\n\n<<<\n=== Baseline Architecture\n\n==== Existing System Components\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Component |Current State |Status\n\n|*D365 Customer Engagement*\n|Customer support platform for OTR digital customers (Mobile App, Web), handles feedback submission and case management\n|**DEPRECATED** - Being replaced by Salesforce Service Cloud\n\n|*App-Specific Customer Database*\n|Stores customer contact data for Mobile App users, separate from Viva Energy systems\n|**MIGRATING** - One-time migration to Salesforce, then deprecated\n\n|*Mobile App*\n|iOS/Android native apps with feedback submission form including Category, Store Name, Time of Visit, Contact Phone Number, and Free Text Message fields\n|**REQUIRES UPDATE** - Integrate with ProfileService and EngagementService APIs (feedback form UI already complete)\n\n|*Salesforce Service Cloud*\n|Shared Viva Energy instance handling customer support for fuel wholesale, Shell Card customers, other retail channels\n|**EXPANDING** - Adding OTR digital customer support Cases and Contacts\n\n|*Existing AWS Infrastructure*\n|SNS+SQS / EventBridge / Kinesis available for event-driven architecture\n|**REUSING** - Event Bus implementation leverages existing infrastructure\n\n|===\n\n==== Integration Architecture\n\n*Current state:*\n\n* Mobile App → D365 Customer Engagement (direct integration)\n* App-specific customer database → standalone (no Salesforce integration)\n* No event-driven architecture (synchronous, tightly coupled)\n* No Anti-Corruption Layer protecting digital channels\n* Viva Energy support teams use Salesforce, OTR digital support uses D365 CE (fragmented)\n\n==== Technical Debt\n\n*No longer relevant* - D365 CE being deprecated, not documenting technical debt of system being retired.\n\n*New technical debt introduced by this migration:*\n\n* Salesforce field mapping TBD (requires coordination with Viva Energy Salesforce admin team)\n* Data isolation strategy TBD (Record Types, custom fields, queues - multi-tenant governance)\n* Salesforce webhook mechanism TBD (Outbound Messages vs Platform Events vs Process Builder)\n* Expected feedback volume unknown (gathering data for rate limit planning)\n\n=== Gap Analysis\n\n==== Missing Capabilities\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Missing Capability |Description\n\n|*ProfileService bounded context*\n|No existing service for Contact reconciliation with Salesforce - requires new microservice implementing JIT upsert by email, returning Salesforce Contact ID\n\n|*EngagementService bounded context*\n|No existing service for customer feedback facade - requires new microservice implementing Anti-Corruption Layer for Salesforce Case creation, Braze integration, async processing via Event Bus\n\n|*Event Bus domain event pattern*\n|No existing domain event publishing infrastructure - requires implementing event-driven architecture pattern using existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis)\n\n|*Async Case creation workflow*\n|Current D365 CE integration is synchronous - requires implementing async processing with retry logic, exponential backoff, dead letter queue\n\n|*Salesforce webhook integration*\n|No existing capability to receive Salesforce notifications - requires implementing webhook receiver in EngagementService for Case update notifications\n\n|*Braze push notification orchestration*\n|No existing integration for Case-related push notifications - requires implementing Braze campaign triggers from EngagementService\n\n|*Contact migration tooling*\n|No existing tooling for app database → Salesforce Contact migration with upsert logic (match by email/phone/VCI)\n\n|*Feedback form enhancements*\n|Mobile App feedback form lacks structured fields (Category, Store Name, Time of Visit, Contact Phone Number) - requires UI updates\n\n|===\n\n==== Missing Bounded Contexts\n\n[width=\"100%\",cols=\"30%,30%,40%\",options=\"header\",]\n|===\n|Bounded Context |Responsibilities |Implementation Status\n\n|*link:../bounded_context/profile.adoc[ProfileService]*\n|JIT Contact reconciliation with Salesforce (upsert by email), return Salesforce Contact ID to digital channels, foundation for future Flybuys partner linking\n|**NEW** - First bounded context implementation\n\n|*link:../bounded_context/engagement.adoc[EngagementService]*\n|Customer feedback submission facade, Anti-Corruption Layer for Salesforce Case creation, Braze integration for push notifications, async Case processing, webhook receiver for Case updates\n|**NEW** - First bounded context implementation\n\n|===\n\n==== Missing Integration Patterns\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Integration Pattern |Description\n\n|*Anti-Corruption Layer (ACL)*\n|EngagementService → Salesforce Service Cloud - protects digital channels from Salesforce API changes, translates between OTR domain language and Salesforce\n\n|*Conformist*\n|ProfileService/EngagementService → Salesforce - conform to existing Salesforce configuration and API contracts (shared Viva Energy instance)\n\n|*Event-Driven Architecture (OHS+PL)*\n|Event Bus publishing domain events (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`) for loose coupling between bounded contexts\n\n|*Just-In-Time (JIT) Integration*\n|ProfileService → Salesforce Contact reconciliation on-demand (no pre-sync)\n\n|*Async Processing*\n|EngagementService Case creation via Event Bus with retry, exponential backoff, dead letter queue\n\n|===\n\n=== Target State Architecture\n\n==== Architectural Building Blocks (ABB)\n\n[width=\"100%\",cols=\"20%,25%,30%,25%\",options=\"header\",]\n|===\n|ABB ID |Bounded Context |Responsibilities |Technology (TBD in Solution Architecture)\n\n|ABB-CS-001\n|*link:../bounded_context/profile.adoc[ProfileService]*\n|JIT Contact reconciliation with Salesforce (upsert by email), return Salesforce Contact ID, foundation for Flybuys partner linking\n|Microservice (.NET/Node.js), REST API, Salesforce REST API client\n\n|ABB-CS-002\n|*link:../bounded_context/engagement.adoc[EngagementService]*\n|Customer feedback submission facade, ACL for Salesforce Case creation, Braze integration, async processing, webhook receiver\n|Microservice (.NET/Node.js), REST API, Event Bus publisher/subscriber, Salesforce webhook receiver\n\n|ABB-CS-003\n|*Event Bus*\n|Domain event publishing infrastructure (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`)\n|AWS SNS+SQS / EventBridge / Kinesis\n\n|ABB-CS-004\n|*Salesforce Service Cloud*\n|System of Record for Contact and Case data (shared Viva Energy instance)\n|Salesforce Service Cloud (external SaaS)\n\n|ABB-CS-005\n|*Braze*\n|Marketing automation platform for push notifications\n|Braze (external SaaS) - existing integration\n\n|ABB-CS-006\n|*Mobile App*\n|iOS/Android native apps with enhanced feedback form (Category, Store Name, Time of Visit, Contact Phone Number, Free Text Message)\n|Kotlin Multiplatform, SwiftUI, Jetpack Compose\n\n|ABB-CS-007\n|*Contact Migration Tool*\n|One-time migration app database → Salesforce with upsert logic (match by email/phone/VCI)\n|Script/tool (.NET/Python/Node.js)\n\n|===\n\n==== Integration Architecture\n\n===== Integration Flows\n\n*Customer Feedback Submission (Async):*\n\n1. *Mobile App* → ProfileService: Authenticate user, get Salesforce Contact ID (JIT reconciliation)\n2. *Mobile App* → EngagementService: Submit feedback (POST /feedback with Contact ID, Category, Store Name, Time of Visit, Phone, Message)\n3. *EngagementService* → Mobile App: Immediate acknowledgment (\"Feedback submitted\")\n4. *EngagementService* → Event Bus: Publish work item for async Case creation\n5. *Background Worker* (EngagementService) → Salesforce: Create Case via REST API\n6. *Success*: EngagementService → Event Bus: Publish `SupportCaseCreated` event\n7. *EngagementService* → Braze: Trigger push notification campaign (\"Your feedback has been received, Case #12345\")\n8. *Failure*: Retry with exponential backoff → Dead Letter Queue → Ops team alert\n\n*Case Update Notification (Bidirectional):*\n\n1. *Support Agent* updates/resolves Case in Salesforce\n2. *Salesforce* → EngagementService: Webhook notification (Case updated)\n3. *EngagementService* → Event Bus: Publish `SupportCaseUpdated` or `SupportCaseResolved` event\n4. *EngagementService* → Braze: Trigger push notification campaign (\"Your case has been resolved\")\n\n*Contact Reconciliation (JIT):*\n\n1. *Mobile App user* authenticates\n2. *Mobile App* → ProfileService: GET /profile/contact-id\n3. *ProfileService* → Salesforce: Query Contact by email\n4. *Match found*: Return existing Salesforce Contact ID\n5. *No match*: Create new Contact in Salesforce, return new Contact ID\n6. *ProfileService* → Mobile App: Return Salesforce Contact ID (cached by Mobile App)\n\n===== System of Record Boundaries\n\n[width=\"100%\",cols=\"30%,35%,35%\",options=\"header\",]\n|===\n|Data Entity |System of Record |Rationale\n\n|*Contact*\n|Salesforce Service Cloud\n|Shared Viva Energy instance, unified customer profile across all channels (digital, wholesale, Shell Card, retail)\n\n|*Case*\n|Salesforce Service Cloud\n|Support agents manage Cases in Salesforce, digital channels submit via EngagementService ACL\n\n|*Feedback Submission (transient)*\n|None (no persistence)\n|EngagementService processes feedback and creates Case in Salesforce, no local storage\n\n|*Domain Events*\n|Event Bus (ephemeral)\n|Events published to Event Bus, consumed by subscribers, not persisted long-term (event sourcing not in scope)\n\n|===\n\n==== Data Architecture Principles\n\n===== Aggregate Persistence\n\n*ProfileService:*\n\n* **No local aggregate persistence** - ProfileService is stateless, queries Salesforce on-demand\n* Salesforce Contact is the aggregate root (owned by Salesforce)\n* ProfileService acts as facade/translator, not system of record\n\n*EngagementService:*\n\n* **No local aggregate persistence** - EngagementService is stateless, creates Cases in Salesforce via ACL\n* Salesforce Case is the aggregate root (owned by Salesforce)\n* EngagementService maintains no local Case state (Conformist pattern - trust Salesforce as source of truth)\n* Async processing state managed via Event Bus (work items in queue, not database)\n\n===== Event Store\n\n* **Event Bus** (SNS+SQS/EventBridge/Kinesis) handles domain event publishing\n* Events are **ephemeral** (consumed and discarded, not persisted for event sourcing)\n* No Event Store implementation in this architecture (future enhancement if needed)\n* Event schema versioning TBD in Solution Architecture\n\n\n=== Architecture Decisions\n\n==== ADR-CS-001: Consolidate onto Salesforce Service Cloud (not build custom solution)\n\n*Status*: Accepted\n\n*Context*:\n\n* D365 Customer Engagement not working well for digital customer support\n* Viva Energy already uses Salesforce Service Cloud for fuel wholesale, Shell Card, other retail channels\n* Post-merger opportunity to consolidate onto single platform\n* Alternative: Build custom support platform or use different SaaS\n\n*Decision*:\n\nConsolidate OTR digital customer support onto Salesforce Service Cloud (shared Viva Energy instance).\n\n*Rationale*:\n\n* **Unified customer view**: Support agents see all interactions across channels (digital, wholesale, Shell Card, retail)\n* **Platform consolidation**: Single support platform reduces operational overhead and costs\n* **Proven solution**: Salesforce Service Cloud is established, feature-rich, well-supported\n* **Post-merger alignment**: Strategic decision to standardize on Viva Energy platforms\n* **Avoid custom development**: Building custom support platform would be costly and high-risk\n\n*Consequences*:\n\n* Unified customer support across Viva Energy Group\n* Reduced operational complexity (single platform vs two)\n* Leverage Salesforce capabilities (case routing, knowledge base, AI, omnichannel)\n* ⚠️ Conformist pattern required (shared instance, conform to existing configuration)\n* ⚠️ Multi-tenant governance needed (data isolation, security, queues)\n* ❌ Less control over platform evolution (SaaS vendor, shared instance)\n\n==== ADR-CS-002: Implement ProfileService and EngagementService as first DDD bounded contexts\n\n*Status*: Accepted\n\n*Context*:\n\n* OTR target architecture uses Domain-Driven Design with bounded contexts\n* This migration is opportunity to establish first implementation\n* Alternative: Direct Mobile App → Salesforce integration (no bounded contexts)\n* Alternative: Single monolithic service for all customer-facing APIs\n\n*Decision*:\n\nImplement ProfileService and EngagementService as separate bounded contexts following DDD strategic patterns.\n\n*Rationale*:\n\n* **Foundation for target architecture**: First implementation of DDD pattern for future bounded contexts (Flybuys, LocationService, PaymentService)\n* **Separation of concerns**: ProfileService handles identity/Contact reconciliation, EngagementService handles support/feedback (different responsibilities, different change rates)\n* **Anti-Corruption Layer**: EngagementService protects digital channels from Salesforce API changes\n* **Reusability**: ProfileService Contact reconciliation reused for Flybuys integration\n* **Event-driven architecture**: Establishes pattern for loose coupling between bounded contexts\n\n*Consequences*:\n\n* Establishes DDD architecture foundation for OTR\n* Reusable ProfileService for Flybuys and future integrations\n* Digital channels protected from Salesforce API changes (ACL)\n* Clear bounded context boundaries and responsibilities\n* ⚠️ Increased initial complexity (two new microservices vs direct integration)\n* ⚠️ Requires Event Bus infrastructure implementation\n* ⚠️ Team must learn DDD patterns and bounded context design\n\n==== ADR-CS-003: Async Case creation via Event Bus (not synchronous)\n\n*Status*: Accepted\n\n*Context*:\n\n* Current D365 CE integration is synchronous (user waits for Case creation)\n* Alternative: Keep synchronous integration (Mobile App → EngagementService → Salesforce synchronously)\n* Salesforce API may experience downtime or latency\n\n*Decision*:\n\nImplement async Case creation via Event Bus with immediate user acknowledgment, retry logic, exponential backoff, and dead letter queue.\n\n*Rationale*:\n\n* **Non-blocking user experience**: User gets immediate \"Feedback submitted\" confirmation, not waiting for Salesforce API\n* **Resilience**: If Salesforce is down, feedback still accepted, Case created when Salesforce recovers\n* **Retry logic**: Automatic retry with exponential backoff handles transient failures\n* **Operational visibility**: Dead letter queue alerts ops team to persistent failures\n* **Scalability**: Queue buffering handles traffic spikes\n\n*Consequences*:\n\n* Better user experience (no waiting for Salesforce API)\n* Resilient to Salesforce downtime (queue buffers work)\n* Automatic retry reduces manual intervention\n* Queue depth monitoring provides operational visibility\n* ⚠️ Eventual consistency (user gets success notification after Case created, not immediately)\n* ⚠️ Increased complexity (Event Bus, background workers, retry logic, DLQ)\n* ⚠️ Requires monitoring and alerting for DLQ\n\n==== ADR-CS-004: ProfileService uses email as primary matching key (not VCI)\n\n*Status*: Accepted\n\n*Context*:\n\n* ProfileService needs to reconcile Mobile App users as Salesforce Contacts\n* Alternative matching keys: VCI (Viva Consumer ID), email, phone, Salesforce External ID\n* Email changes are rare but possible\n\n*Decision*:\n\nUse email address as primary matching key for Contact reconciliation (JIT upsert by email).\n\n*Rationale*:\n\n* **Availability**: Email always available for authenticated users\n* **Uniqueness**: Email is unique identifier in Salesforce and Mobile App\n* **Salesforce standard**: Salesforce Contact uses email as standard lookup field\n* **Simplicity**: Single matching key simplifies upsert logic\n* **Edge case acceptable**: Email changes are rare, manual cleanup acceptable\n\n*Consequences*:\n\n* Simple upsert logic (query by email, create if not found)\n* Leverages Salesforce standard email field\n* Email always available from authentication\n* ⚠️ Email changes create duplicate Contacts (rare edge case, manual cleanup)\n* ⚠️ Future enhancement: Add VCI as Salesforce External ID for stable matching\n\n==== ADR-CS-005: No Case migration from D365 CE (fresh start)\n\n*Status*: Accepted\n\n*Context*:\n\n* D365 CE contains historical customer support Cases\n* Alternative: Migrate historical Cases to Salesforce (preserve support history)\n* Alternative: Archive D365 CE Cases separately (read-only access)\n\n*Decision*:\n\nDo not migrate historical Cases from D365 CE to Salesforce. Start fresh in Salesforce.\n\n*Rationale*:\n\n* **Limited value**: Historical D365 CE Cases not critical for future support\n* **Data quality**: D365 CE Case data may be inconsistent or incomplete\n* **Complexity**: Case migration requires mapping D365 CE schema to Salesforce, data transformation, validation\n* **Cost-benefit**: Migration effort outweighs value of historical data\n* **Archive option**: D365 CE Cases can be archived separately if needed (read-only access for auditing)\n\n*Consequences*:\n\n* Simpler migration (Contacts only, no Case migration)\n* Faster time to value (no Case migration delay)\n* Clean start in Salesforce (no legacy data quality issues)\n* ⚠️ Historical Cases not visible in Salesforce (support agents can't see old Cases)\n* ⚠️ D365 CE must remain accessible temporarily for historical Case lookups (if needed)\n* ❌ Loss of historical Case insights (reporting, analytics on old Cases)\n\n==== ADR-CS-006: Big bang cutover (not phased rollout)\n\n*Status*: Accepted\n\n*Context*:\n\n* Alternative: Phased rollout with feature flags (pilot users first, gradual enablement)\n* Alternative: Parallel run (submit to both D365 CE and Salesforce temporarily)\n* Flybuys integration uses phased rollout (AS-1, AS-2, AS-3 architecture states)\n\n*Decision*:\n\nBig bang cutover - migrate Contacts, deploy ProfileService and EngagementService, switch Mobile App, retire D365 CE.\n\n*Rationale*:\n\n* **Simplicity**: No parallel run complexity, no feature flag management\n* **Faster D365 CE retirement**: No extended transition period maintaining two systems\n* **Limited risk**: Customer support not mission-critical (not payment processing), rollback possible\n* **User base manageable**: OTR digital customers smaller than Flybuys integration scope\n* **Different use case**: Flybuys phased rollout manages points accrual complexity, support feedback is simpler\n\n*Consequences*:\n\n* Simpler deployment (single cutover, no AS-1/AS-2/AS-3 states)\n* Faster D365 CE retirement (no extended parallel run)\n* No feature flag complexity or pilot user management\n* ⚠️ Higher cutover risk (all users switch at once)\n* ⚠️ Requires comprehensive testing before cutover\n* ⚠️ Rollback plan required (revert to D365 CE if critical issues)\n\n==== ADR-CS-007: EngagementService receives Salesforce webhooks for Case updates\n\n*Status*: Accepted\n\n*Context*:\n\n* Support agents update/resolve Cases in Salesforce\n* Need to notify customers of Case status changes via push notifications\n* Alternative: Poll Salesforce API for Case updates (inefficient)\n* Alternative: No customer notifications (agents contact customers directly)\n\n*Decision*:\n\nSalesforce sends webhook notifications to EngagementService when Cases are updated/resolved. EngagementService triggers Braze push notifications.\n\n*Rationale*:\n\n* **Real-time notifications**: Customer notified immediately when agent resolves Case\n* **Efficient**: Webhook push model (not polling)\n* **Event-driven**: Aligns with event-driven architecture pattern\n* **Better customer experience**: Proactive notification vs waiting for agent contact\n\n*Consequences*:\n\n* Real-time customer notifications for Case updates\n* Efficient push model (no polling overhead)\n* Bidirectional integration (Mobile App → Salesforce → Mobile App)\n* ⚠️ Salesforce webhook mechanism TBD (Outbound Messages vs Platform Events vs Process Builder)\n* ⚠️ Webhook authentication and security required\n* ⚠️ EngagementService must handle webhook retries and failures\n\n<<<\n== Interface Specifications\n\nThis section provides references to the complete API specifications and event catalogue for ProfileService and EngagementService.\n\n=== REST API Specifications\n\nComplete OpenAPI 3.0 specifications are maintained in the `specifications/rest/` directory:\n\n==== ProfileService API v1\n\n*Specification*: link:../../specifications/rest/profile-service-v1.yaml[profile-service-v1.yaml]\n\n*Base URL*: `https://api.otr.com.au/profile/v1`\n\n*Authentication*: Bearer token (Microsoft Entra External ID JWT)\n\n*Key Endpoints*:\n\n* `GET /contact-id` - Retrieve or create Salesforce Contact ID for authenticated user (Just-In-Time reconciliation)\n** Used by Mobile App before submitting feedback to EngagementService\n** Upserts Salesforce Contact record using email as external key\n** Returns 18-character Salesforce Contact ID with caching (15-minute TTL)\n** Performance SLA: p95 < 300ms (uncached), p95 < 50ms (cached)\n\n==== EngagementService API v1\n\n*Specification*: link:../../specifications/rest/engagement-service-v1.yaml[engagement-service-v1.yaml]\n\n*Base URL*: `https://api.otr.com.au/engagement/v1`\n\n*Authentication*: Bearer token (Microsoft Entra External ID JWT)\n\n*Key Endpoints*:\n\n* `POST /feedback` - Submit customer feedback for async Case creation in Salesforce\n** Accepts contactId, category, storeName, timeOfVisit, contactPhoneNumber, message\n** Returns 202 Accepted immediately (async Case creation in background)\n** Publishes `CustomerFeedbackSubmitted` event for analytics\n** Creates Salesforce Case via Anti-Corruption Layer with retry logic\n** Performance SLA: p95 < 200ms (feedback accepted, not Case creation)\n\n=== Domain Events (AsyncAPI)\n\nComplete CloudEvents 1.0 JSON Schema specifications are maintained in the `specifications/events/` directory:\n\n*Specification*: link:../../specifications/events/engagement-events.json[engagement-events.json]\n\n==== Event Catalogue\n\n[width=\"100%\",cols=\"30%,20%,50%\",options=\"header\",]\n|===\n|Event Type |Publisher |Consumers\n\n|`CustomerFeedbackSubmitted`\n|EngagementService\n|Future bounded contexts, analytics, sentiment analysis\n\n|`SupportCaseCreated`\n|EngagementService\n|Future bounded contexts, analytics\n\n|`SupportCaseUpdated`\n|EngagementService (via Salesforce webhook)\n|Future bounded contexts, analytics\n\n|`SupportCaseResolved`\n|EngagementService (via Salesforce webhook)\n|Future bounded contexts, analytics\n\n|===\n\n==== Event Delivery Guarantees\n\n* **At-least-once delivery**: Events may be delivered multiple times, consumers must handle idempotency\n* **Ordering**: FIFO queues guarantee ordering for events with same `contactId`\n* **Retention**: 4 days (96 hours) in Event Bus\n* **Dead Letter Queue**: Failed events after 5 retries moved to DLQ for manual intervention\n* **Format**: CloudEvents 1.0 specification with JSON payload\n\n=== API Versioning Policy\n\n==== Version Numbering\n\n* **Format**: `/v{major}` in URL path (e.g., `/profile/v1`, `/engagement/v1`)\n* **Semantic Versioning**: Major version incremented for breaking changes only\n* **Backwards Compatibility**: Minor changes (new optional fields, new endpoints) don't require version bump\n\n==== When to Version\n\n*Breaking changes requiring new major version*:\n\n- Removing or renaming fields in request/response\n- Changing field data types (e.g., string → number)\n- Changing authentication mechanism\n- Removing endpoints\n\n*Non-breaking changes not requiring version bump*:\n\n- Adding new optional fields to request/response\n- Adding new endpoints\n- Expanding enum values (e.g., adding new feedback category)\n- Improving error messages\n\n==== Parallel Version Support\n\n* Support N and N-1 versions concurrently for 6 months\n* Deprecation notice: 3 months before sunsetting old version\n* Mobile App must upgrade to new version within deprecation window\n\n<<<\n== Work Packages\n\nThis section consolidates gaps and activities into implementable work packages aligned with TOGAF Phase E requirements.\n\n=== Work Package Overview\n\n[width=\"100%\",cols=\"15%,35%,25%,25%\",options=\"header\",]\n|===\n|Work Package ID |Name |Transition State |Key Deliverables\n\n|WP-CS-001\n|ProfileService Development\n|TS-1 (Build & Test)\n|ProfileService microservice, Salesforce Contact integration, REST API\n\n|WP-CS-002\n|EngagementService Development\n|TS-1 (Build & Test)\n|EngagementService microservice, Anti-Corruption Layer, Braze integration\n\n|WP-CS-003\n|Event Bus Infrastructure\n|TS-1 (Build & Test)\n|Event Bus configuration, CloudEvents schemas, monitoring\n\n|WP-CS-004\n|Contact Migration Tooling\n|TS-1 (Build & Test)\n|Migration tool, validation scripts, reconciliation reporting\n\n|WP-CS-005\n|Mobile App Integration\n|TS-1 (Build & Test)\n|Mobile App API integration, feedback form enhancements, testing\n\n|WP-CS-006\n|Integration Testing\n|TS-1 (Build & Test)\n|Test environments, integration test suites, UAT execution\n\n|WP-CS-007\n|Salesforce Configuration\n|TS-1 (Build & Test)\n|Salesforce field mapping, data isolation, webhook configuration\n\n|WP-CS-008\n|Contact Data Migration\n|TS-2 (Contact Migration)\n|Contact migration execution, validation, reconciliation\n\n|WP-CS-009\n|Production Deployment\n|TS-3 (Cutover)\n|Production deployment, smoke testing, go-live execution\n\n|WP-CS-010\n|Post-Cutover Support\n|TS-4 (Target State)\n|Monitoring, issue resolution, D365 CE retirement\n\n|===\n\n[[wp-cs-001]]\n=== WP-CS-001: ProfileService Development\n\n==== Description\n\nBuild ProfileService bounded context microservice implementing Just-In-Time Contact reconciliation with Salesforce Service Cloud.\n\n==== Deliverables\n\n* ProfileService microservice application\n** REST API implementation (OpenAPI 3.0 specification)\n** `GET /contact-id` endpoint (Salesforce Contact reconciliation)\n** Authentication/authorization with Microsoft Entra External ID\n** Caching layer (15-minute TTL for Contact IDs)\n* Salesforce integration\n** Salesforce REST API client\n** Contact upsert by email (external key matching)\n** Error handling and retry logic\n* Unit tests (>80% code coverage)\n* Integration tests with Salesforce sandbox\n* API documentation\n* Deployment configuration (IaC - Infrastructure as Code)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* Salesforce sandbox environment provisioned\n* Microsoft Entra External ID OAuth configuration\n* Development environment setup (AWS dev account, CI/CD pipeline)\n\n*Dependent Work Packages*:\n\n* None (can start immediately after prerequisites met)\n\n==== Skills Required\n\n* Backend development (.NET Core or Node.js)\n* REST API design and implementation\n* Salesforce REST API integration\n* OAuth 2.0 / JWT authentication\n* Caching strategies (Redis/ElastiCache)\n* Unit/integration testing frameworks\n* Infrastructure as Code (Terraform/CloudFormation)\n\n==== Acceptance Criteria\n\n* All API endpoints return correct HTTP status codes per OpenAPI specification\n* Contact ID retrieval achieves p95 < 300ms (uncached), p95 < 50ms (cached)\n* Salesforce Contact upsert succeeds with 100% accuracy in sandbox testing\n* Unit test coverage > 80%\n* Integration tests pass in sandbox environment\n* API documentation generated from OpenAPI specification\n\n[[wp-cs-002]]\n=== WP-CS-002: EngagementService Development\n\n==== Description\n\nBuild EngagementService bounded context microservice implementing customer feedback submission, Anti-Corruption Layer for Salesforce Case creation, Braze integration, and webhook receiver for Case updates.\n\n==== Deliverables\n\n* EngagementService microservice application\n** REST API implementation (OpenAPI 3.0 specification)\n** `POST /feedback` endpoint (async feedback submission)\n** Authentication/authorization with Microsoft Entra External ID\n** Webhook receiver endpoint for Salesforce Case updates\n* Anti-Corruption Layer (ACL)\n** OTR domain model to Salesforce API translation\n** Category enum mapping (App/Service/Order/Rewards → Salesforce Case fields)\n** Salesforce REST API client for Case creation\n* Async processing infrastructure\n** Event Bus publisher integration\n** Background worker for Case creation\n** Retry logic with exponential backoff (5 attempts)\n** Dead Letter Queue integration\n* Braze integration\n** Braze campaign trigger API client\n** Push notification orchestration for Case updates\n* Domain event publishing\n** `CustomerFeedbackSubmitted` event publisher\n** `SupportCaseCreated` event publisher\n** `SupportCaseUpdated` event translator (Salesforce webhook → domain event)\n** `SupportCaseResolved` event translator (Salesforce webhook → domain event)\n* Unit tests (>80% code coverage)\n* Integration tests (EngagementService ↔ Salesforce, EngagementService ↔ Braze)\n* API documentation\n* Deployment configuration (IaC)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* <<wp-cs-003,WP-CS-003>> (Event Bus Infrastructure) completed\n* Salesforce sandbox environment provisioned\n* Braze API credentials and campaign templates configured\n* Microsoft Entra External ID OAuth configuration\n\n*Dependent Work Packages*:\n\n* <<wp-cs-003,WP-CS-003>> must be completed first (Event Bus required for async processing)\n* <<wp-cs-007,WP-CS-007>> (Salesforce Configuration) must be in progress (field mapping needed)\n\n==== Skills Required\n\n* Backend development (.NET Core or Node.js)\n* REST API design and implementation\n* Salesforce REST API integration\n* Event-driven architecture patterns\n* Async/background processing (queues, workers)\n* Braze API integration\n* Webhook design and security\n* OAuth 2.0 / JWT authentication\n* Domain-Driven Design (DDD) - Anti-Corruption Layer pattern\n* Unit/integration testing frameworks\n* Infrastructure as Code (Terraform/CloudFormation)\n\n==== Acceptance Criteria\n\n* Feedback submission endpoint returns 202 Accepted within p95 < 200ms\n* Async Case creation succeeds with >99.5% success rate (including retries)\n* Anti-Corruption Layer correctly maps all feedback categories to Salesforce Case fields\n* Webhook receiver processes Salesforce Case updates and publishes domain events\n* Braze push notifications sent successfully for Case updates\n* Failed Case creation moves to Dead Letter Queue after 5 retry attempts\n* Unit test coverage > 80%\n* Integration tests pass with Salesforce sandbox and Braze staging environment\n\n[[wp-cs-003]]\n=== WP-CS-003: Event Bus Infrastructure\n\n==== Description\n\nImplement Event Bus infrastructure for domain event publishing using existing AWS infrastructure (SNS+SQS, EventBridge, or Kinesis).\n\n==== Deliverables\n\n* Event Bus infrastructure configuration\n** Topic/stream provisioning (technology choice: SNS+SQS / EventBridge / Kinesis)\n** FIFO queue configuration (ordering by `contactId`)\n** Dead Letter Queue (DLQ) setup\n** Retention policy (4 days / 96 hours)\n** Access control policies (IAM roles, permissions)\n* CloudEvents 1.0 schema definitions\n** JSON Schema specifications for all domain events\n** Schema validation configuration\n** Schema registry (if using EventBridge/Kinesis)\n* Monitoring and alerting\n** CloudWatch dashboards for queue metrics\n** Alarms for DLQ depth, queue age, processing failures\n** Event Bus throughput monitoring\n* Documentation\n** Event Bus architecture diagram\n** Event publishing guidelines\n** Consumer integration guide\n* Infrastructure as Code (IaC)\n** Terraform/CloudFormation templates for all infrastructure\n\n==== Dependencies\n\n*Prerequisites*:\n\n* AWS account access (existing infrastructure)\n* Technology selection decision (SNS+SQS vs EventBridge vs Kinesis)\n* CloudEvents 1.0 schema design approval\n\n*Dependent Work Packages*:\n\n* None (foundational infrastructure, can start early)\n\n==== Skills Required\n\n* AWS messaging services (SNS, SQS, EventBridge, Kinesis)\n* Event-driven architecture patterns\n* CloudEvents specification\n* JSON Schema design\n* Infrastructure as Code (Terraform/CloudFormation)\n* AWS IAM security configuration\n* CloudWatch monitoring and alerting\n\n==== Acceptance Criteria\n\n* Event Bus infrastructure provisioned in all environments (dev, staging, production)\n* FIFO ordering validated for events with same `contactId`\n* Dead Letter Queue triggers alarms when messages arrive\n* Event retention policy enforced (4 days)\n* CloudEvents 1.0 schema validation enabled\n* Monitoring dashboards operational\n* Infrastructure fully codified (IaC)\n\n[[wp-cs-004]]\n=== WP-CS-004: Contact Migration Tooling\n\n==== Description\n\nDevelop Contact migration tool for one-time migration from app-specific database to Salesforce Service Cloud with upsert logic and validation.\n\n==== Deliverables\n\n* Contact migration tool\n** Extract Contacts from app-specific database\n** Transform to Salesforce Contact API format\n** Upsert to Salesforce using email as external key\n** Fallback matching by phone number or Viva Consumer ID\n** Batch processing with rate limiting (respect Salesforce API limits)\n** Idempotent operation (can be re-run safely)\n* Validation scripts\n** Pre-migration validation (data quality checks)\n** Post-migration validation (100% Contact reconciliation)\n** Email/phone/VCI matching accuracy report\n* Reconciliation reporting\n** Contacts created vs updated statistics\n** Failed upserts with error details\n** Matching accuracy metrics\n* Rollback capability\n** Export snapshot of Salesforce Contacts before migration\n** Rollback procedure documentation\n* Documentation\n** Migration tool user guide\n** Troubleshooting guide\n** Runbook for migration execution\n\n==== Dependencies\n\n*Prerequisites*:\n\n* <<wp-cs-001,WP-CS-001>> (ProfileService Development) completed (reuses Salesforce integration code)\n* Salesforce sandbox environment for migration testing\n* App-specific database access (read-only sufficient)\n* Salesforce production access granted\n\n*Dependent Work Packages*:\n\n* <<wp-cs-001,WP-CS-001>> provides Salesforce Contact upsert logic to reuse\n\n==== Skills Required\n\n* Database development (SQL, data extraction)\n* Salesforce REST API integration\n* Batch processing and ETL patterns\n* Data validation and reconciliation\n* Error handling and logging\n* Scripting (Python, PowerShell, or similar)\n\n==== Acceptance Criteria\n\n* Migration tool successfully migrates 100% of Contacts in sandbox with zero data loss\n* Email/phone/VCI matching accuracy > 95% in sandbox testing\n* Failed upserts captured with actionable error messages\n* Reconciliation report matches actual Salesforce Contact counts\n* Migration tool execution time acceptable for production (freezes app database for minimum time)\n* Rollback procedure validated in sandbox\n* Documentation complete and approved\n\n[[wp-cs-005]]\n=== WP-CS-005: Mobile App Integration\n\n==== Description\n\nUpdate Mobile App to integrate with ProfileService and EngagementService APIs, replacing D365 CE integration.\n\n==== Deliverables\n\n* Feedback form UI enhancements\n** Add Category dropdown (App, Service, Order, Rewards, Refund, Delete Account)\n** Add Store Name field (optional)\n** Add Time of Visit field (optional, datetime picker)\n** Add Contact Phone Number field (optional, E.164 validation)\n** Update Message field (1-2000 character limit with counter)\n* API integration (Kotlin Multiplatform shared code)\n** ProfileService client (`GET /contact-id`)\n** EngagementService client (`POST /feedback`)\n** JWT token management (Microsoft Entra External ID)\n** Error handling (network failures, API errors, validation errors)\n** Retry logic for transient failures\n* Platform-specific UI (SwiftUI for iOS, Jetpack Compose for Android)\n** Feedback form screens\n** Success/error confirmation screens\n** Loading states and progress indicators\n* Feature flag integration\n** `enable_salesforce_feedback_submission` flag\n** Fallback to D365 CE if flag disabled (during rollout)\n* Unit tests for shared business logic\n* UI tests for platform-specific screens\n* API integration tests (mocked APIs)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* <<wp-cs-001,WP-CS-001>> (ProfileService Development) completed and deployed to dev/staging\n* <<wp-cs-002,WP-CS-002>> (EngagementService Development) completed and deployed to dev/staging\n* ProfileService and EngagementService OpenAPI specifications finalized\n* Feature flag service configured\n\n*Dependent Work Packages*:\n\n* Must complete after <<wp-cs-001,WP-CS-001>> and <<wp-cs-002,WP-CS-002>> (requires API endpoints available for integration testing)\n\n==== Skills Required\n\n* Kotlin Multiplatform development\n* SwiftUI (iOS native UI)\n* Jetpack Compose (Android native UI)\n* REST API client development\n* OAuth 2.0 / JWT authentication\n* Form validation and UX design\n* Unit testing (Kotlin, Swift)\n* UI testing frameworks (XCTest, Espresso)\n\n==== Acceptance Criteria\n\n* Feedback form UI matches UX design specifications\n* All form fields validate correctly (client-side validation)\n* API integration successfully calls ProfileService and EngagementService in dev/staging\n* Error handling provides user-friendly error messages\n* Feature flag correctly toggles between Salesforce and D365 CE integration\n* Unit test coverage > 80% for shared business logic\n* UI tests pass for all feedback form workflows (happy path, error states)\n* App builds and deploys successfully to TestFlight (iOS) and Google Play Internal Testing (Android)\n\n[[wp-cs-006]]\n=== WP-CS-006: Integration Testing\n\n==== Description\n\nExecute comprehensive integration testing across all system components in non-production environments.\n\n==== Deliverables\n\n* Test environment setup\n** Salesforce sandbox configured with test data\n** ProfileService deployed to staging\n** EngagementService deployed to staging\n** Event Bus staging infrastructure\n** Braze staging environment configured\n** Mobile App TestFlight/Internal Testing builds\n* Integration test suites\n** ProfileService ↔ Salesforce (Contact upsert scenarios)\n** EngagementService ↔ Salesforce (Case creation scenarios)\n** EngagementService ↔ Braze (push notification scenarios)\n** Mobile App ↔ ProfileService ↔ EngagementService (end-to-end workflows)\n** Event Bus publishing and consumption\n** Webhook receiver (Salesforce → EngagementService)\n* Test scenarios\n** Happy path: Successful feedback submission and Case creation\n** Error scenarios: Salesforce API failures, Braze API failures, network timeouts\n** Retry scenarios: Async Case creation retries, DLQ validation\n** Performance testing: p95 latency validation for ProfileService and EngagementService\n** Load testing: Simulate 3x-10x expected volume\n* UAT execution\n** Business stakeholder UAT sessions\n** UAT test cases covering all feedback categories\n** UAT sign-off documentation\n* Test results documentation\n** Test execution reports\n** Defect tracking and resolution\n** Performance test results\n\n==== Dependencies\n\n*Prerequisites*:\n\n* <<wp-cs-001,WP-CS-001>> (ProfileService Development) completed\n* <<wp-cs-002,WP-CS-002>> (EngagementService Development) completed\n* <<wp-cs-003,WP-CS-003>> (Event Bus Infrastructure) completed\n* <<wp-cs-005,WP-CS-005>> (Mobile App Integration) completed\n* <<wp-cs-007,WP-CS-007>> (Salesforce Configuration) sandbox configuration completed\n\n*Dependent Work Packages*:\n\n* Must complete after <<wp-cs-001,WP-CS-001>>, <<wp-cs-002,WP-CS-002>>, <<wp-cs-003,WP-CS-003>>, <<wp-cs-005,WP-CS-005>> (requires all components available)\n\n==== Skills Required\n\n* Integration testing strategy and execution\n* Test automation frameworks (Postman, Newman, Selenium)\n* Performance testing tools (JMeter, k6, Gatling)\n* Salesforce sandbox administration\n* Test data management\n* Defect tracking and triage\n* UAT facilitation\n\n==== Acceptance Criteria\n\n* All integration test scenarios pass (happy path, error scenarios, retry scenarios)\n* Performance SLAs validated (ProfileService p95 < 300ms, EngagementService p95 < 200ms)\n* Load testing confirms system handles 3x expected volume without degradation\n* UAT sign-off obtained from business stakeholders\n* Zero critical defects (P1/P2) open before moving to Contact Migration\n* Test results documented and approved\n\n[[wp-cs-007]]\n=== WP-CS-007: Salesforce Configuration\n\n==== Description\n\nConfigure Salesforce Service Cloud for OTR digital customer support integration, including field mapping, data isolation, and webhook setup.\n\n==== Deliverables\n\n* Salesforce Contact configuration\n** Custom fields for OTR-specific data (if needed)\n** Email as external key configuration\n** Record Type for OTR digital customers (data isolation)\n** Validation rules\n* Salesforce Case configuration\n** Custom fields for feedback categories (App, Service, Order, Rewards, Refund, Delete Account)\n** Case Type and Reason picklist mapping\n** Queue assignment rules (OTR digital support queue)\n** Case escalation rules\n** Case routing rules\n* Salesforce webhook configuration\n** Platform Events / Outbound Messages for Case updates\n** Webhook authentication (API key, JWT, or OAuth)\n** Case status change triggers (New → In Progress, Resolved, Closed)\n** Webhook payload format (JSON)\n* Data isolation strategy\n** Record Types for OTR vs other Viva Energy business units\n** Queues for OTR-specific Cases\n** Reporting and dashboards scoped to OTR data\n* Salesforce API access\n** Connected App configuration\n** OAuth 2.0 JWT bearer flow setup\n** API user credentials\n** API rate limit monitoring\n* Documentation\n** Salesforce field mapping specification\n** Webhook configuration guide\n** Data isolation architecture diagram\n** API authentication setup guide\n\n==== Dependencies\n\n*Prerequisites*:\n\n* Viva Energy Salesforce admin team engagement\n* Salesforce governance approval (multi-tenant environment)\n* Technical decision on webhook mechanism (Platform Events vs Outbound Messages)\n* Technical decision on authentication method (OAuth 2.0 JWT bearer flow recommended)\n\n*Dependent Work Packages*:\n\n* None (can start in parallel with development work packages)\n* Required for <<wp-cs-002,WP-CS-002>> (EngagementService needs field mapping)\n* Required for <<wp-cs-006,WP-CS-006>> (Integration Testing needs sandbox configuration)\n\n==== Skills Required\n\n* Salesforce administration\n* Salesforce configuration (Record Types, Queues, Validation Rules)\n* Salesforce API integration (REST API, Platform Events, Outbound Messages)\n* Salesforce security and authentication (OAuth, Connected Apps)\n* Multi-tenant data isolation patterns\n\n==== Acceptance Criteria\n\n* Salesforce sandbox configured with all custom fields, Record Types, Queues\n* Field mapping documented and approved by OTR business stakeholders\n* Webhook configuration tested and delivering Case update notifications\n* Data isolation validated (OTR data separate from other Viva Energy business units)\n* API authentication working for ProfileService and EngagementService\n* Salesforce API rate limits monitored and acceptable for expected volume\n* Configuration replicated to Salesforce production environment\n\n[[wp-cs-008]]\n=== WP-CS-008: Contact Data Migration\n\n==== Description\n\nExecute one-time Contact migration from app-specific database to Salesforce Service Cloud production.\n\n==== Deliverables\n\n* Pre-migration activities\n** Final validation of migration tool in sandbox\n** Communication plan (notify users of maintenance window if needed)\n** Freeze app-specific database Contact updates\n** Backup app-specific database\n** Export snapshot of Salesforce Contacts (rollback preparation)\n* Migration execution\n** Execute migration tool against Salesforce production\n** Monitor migration progress\n** Handle failed upserts (manual intervention if needed)\n* Post-migration validation\n** 100% Contact reconciliation (app database vs Salesforce)\n** Email/phone/VCI matching accuracy report\n** Reconciliation report (Contacts created vs updated)\n** Data integrity checks (no duplicate Contacts, no missing Contacts)\n* ProfileService smoke testing\n** Verify Contact ID retrieval works in production\n** Test cache behavior\n** Validate Salesforce Contact upserts from ProfileService\n* Migration report\n** Total Contacts migrated\n** Contacts created vs updated\n** Failed upserts (if any) with resolution\n** Matching accuracy metrics\n** Migration execution time\n\n==== Dependencies\n\n*Prerequisites*:\n\n* <<wp-cs-004,WP-CS-004>> (Contact Migration Tooling) completed\n* <<wp-cs-001,WP-CS-001>> (ProfileService Development) deployed to production (not yet integrated with Mobile App)\n* <<wp-cs-007,WP-CS-007>> (Salesforce Configuration) production configuration completed\n* Salesforce production access granted\n* Migration approved by business stakeholders\n\n*Dependent Work Packages*:\n\n* Must complete after <<wp-cs-001,WP-CS-001>>, <<wp-cs-004,WP-CS-004>>, <<wp-cs-007,WP-CS-007>>\n* Must complete before <<wp-cs-009,WP-CS-009>> (Production Deployment)\n\n==== Skills Required\n\n* Data migration execution\n* Salesforce administration\n* Database operations\n* Data validation and reconciliation\n* Incident management (if issues arise)\n\n==== Acceptance Criteria\n\n* 100% of Contacts migrated with zero data loss\n* Email/phone/VCI matching accuracy > 95%\n* ProfileService smoke tests pass in production\n* Reconciliation report approved by business stakeholders\n* App-specific database Contact updates frozen (read-only mode)\n* Rollback procedure ready (but not executed if migration successful)\n\n[[wp-cs-009]]\n=== WP-CS-009: Production Deployment\n\n==== Description\n\nDeploy all solution components to production and execute cutover from D365 CE to Salesforce Service Cloud.\n\n==== Deliverables\n\n* Production deployment\n** EngagementService deployed to production\n** Event Bus production infrastructure validated\n** Salesforce webhook configured in production\n** Mobile App released to production (App Store, Google Play)\n* Go-live activities\n** Smoke testing (end-to-end feedback submission)\n** Feature flag enabled: `enable_salesforce_feedback_submission = ON`\n** D365 CE integration disabled in Mobile App\n** Monitor Event Bus queue depth, DLQ, Salesforce API rate limits\n** Monitor Mobile App feedback submission success rate\n* Go/No-Go decision\n** Validate success criteria before final cutover\n** Business stakeholder approval\n** Technical validation (smoke tests pass, monitoring healthy)\n* Cutover communication\n** Notify support agents of new Salesforce integration\n** Provide training materials for support agents\n** Customer communication (if visible change)\n* Rollback plan\n** Documented rollback procedure\n** Feature flag can disable Salesforce integration and re-enable D365 CE\n** Rollback decision criteria (P1/P2 incidents, feedback submission success rate < 99%)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* <<wp-cs-001,WP-CS-001>> (ProfileService Development) completed\n* <<wp-cs-002,WP-CS-002>> (EngagementService Development) completed\n* <<wp-cs-003,WP-CS-003>> (Event Bus Infrastructure) completed\n* <<wp-cs-005,WP-CS-005>> (Mobile App Integration) completed\n* <<wp-cs-006,WP-CS-006>> (Integration Testing) completed with UAT sign-off\n* <<wp-cs-007,WP-CS-007>> (Salesforce Configuration) production configuration completed\n* <<wp-cs-008,WP-CS-008>> (Contact Data Migration) completed successfully\n* Mobile App release approval (App Store, Google Play)\n\n*Dependent Work Packages*:\n\n* Must complete after all prior work packages (final cutover)\n\n==== Skills Required\n\n* Production deployment and release management\n* Incident management and troubleshooting\n* Monitoring and observability\n* Change management and communication\n* Rollback execution (if needed)\n\n==== Acceptance Criteria\n\n* Mobile App feedback submission success rate > 99.5%\n* End-to-end flow validated (Mobile App → ProfileService → EngagementService → Salesforce Case created)\n* Braze push notifications delivered successfully\n* Event Bus queue depth normal, DLQ empty\n* No critical incidents (P1/P2) in first 24 hours\n* D365 CE integration disabled\n* Support agents successfully using Salesforce for OTR digital customer Cases\n\n[[wp-cs-010]]\n=== WP-CS-010: Post-Cutover Support\n\n==== Description\n\nMonitor production stability, resolve issues, validate success criteria, and execute D365 CE retirement.\n\n==== Deliverables\n\n* Monitoring and support\n** 24/7 on-call support for first week post-cutover\n** Daily monitoring reports (feedback submission success rate, Case creation success rate)\n** Incident response and resolution\n** Performance tuning (if needed)\n* Success criteria validation\n** Validate feedback submission success rate > 99.5%\n** Monitor customer satisfaction score (target: +15% improvement within 6 months)\n** Monitor average case resolution time (target: -20% improvement within 6 months)\n** Support agent feedback survey\n* D365 CE retirement\n** D365 CE set to read-only mode (historical Case lookups only)\n** Archive D365 CE data for compliance/auditing\n** Decommission D365 CE infrastructure (after 90-day stabilization period)\n** Remove D365 CE integration code from Mobile App\n* Documentation updates\n** Production runbook\n** Troubleshooting guide (based on incidents resolved)\n** Operational procedures for support team\n** Lessons learned document\n\n==== Dependencies\n\n*Prerequisites*:\n\n* WP-CS-009 (Production Deployment) completed\n* Cutover successful with no critical incidents\n\n*Dependent Work Packages*:\n\n* Final work package in sequence\n\n==== Skills Required\n\n* Production support and incident management\n* Performance monitoring and tuning\n* Data archival and compliance\n* Infrastructure decommissioning\n* Documentation\n\n==== Acceptance Criteria\n\n* Zero critical incidents (P1/P2) in first 30 days post-cutover\n* Feedback submission success rate sustained > 99.5%\n* Customer satisfaction improvement validated (baseline established, ongoing measurement)\n* Support agents reporting positive experience with Salesforce unified view\n* D365 CE successfully decommissioned\n* All production documentation complete and approved\n* Lessons learned document published\n\n=== Work Package Sequencing\n\n==== Parallel Track 1: Infrastructure & Configuration\n\nCan start immediately and run in parallel:\n\n* WP-CS-003 (Event Bus Infrastructure)\n* WP-CS-007 (Salesforce Configuration)\n\n==== Parallel Track 2: Development\n\nCan start after Track 1 infrastructure decisions made:\n\n* WP-CS-001 (ProfileService Development) - Independent\n* WP-CS-002 (EngagementService Development) - Requires WP-CS-003 completed\n* WP-CS-004 (Contact Migration Tooling) - Requires WP-CS-001 completed (reuses code)\n\n==== Sequential Track 3: Integration & Testing\n\nMust complete after development:\n\n* WP-CS-005 (Mobile App Integration) - Requires WP-CS-001, WP-CS-002\n* WP-CS-006 (Integration Testing) - Requires WP-CS-001, WP-CS-002, WP-CS-003, WP-CS-005, WP-CS-007\n\n==== Sequential Track 4: Migration & Cutover\n\nMust complete sequentially:\n\n* WP-CS-008 (Contact Data Migration) - Requires WP-CS-001, WP-CS-004, WP-CS-006 UAT sign-off\n* WP-CS-009 (Production Deployment) - Requires all prior work packages completed\n* WP-CS-010 (Post-Cutover Support) - Requires WP-CS-009\n\n==== Critical Path\n\nThe critical path for this project is:\n\n. WP-CS-003 (Event Bus Infrastructure)\n. WP-CS-002 (EngagementService Development) - blocks on WP-CS-003\n. WP-CS-005 (Mobile App Integration) - blocks on WP-CS-001, WP-CS-002\n. WP-CS-006 (Integration Testing) - blocks on WP-CS-001 through WP-CS-005, WP-CS-007\n. WP-CS-008 (Contact Data Migration) - blocks on WP-CS-006 UAT sign-off\n. WP-CS-009 (Production Deployment) - blocks on WP-CS-008\n. WP-CS-010 (Post-Cutover Support) - final deliverable\n\nAny delays in critical path work packages will delay the overall cutover date.\n\n<<<\n== Transition Architecture\n\nThis section defines the evolution from baseline (D365 CE) to target state (Salesforce Service Cloud + ProfileService + EngagementService).\n\n=== Transition Approach\n\n*Big Bang Cutover*: Per ADR-CS-006, this transition uses a single cutover approach rather than phased rollout. All users switch from D365 CE to Salesforce simultaneously after Contact migration completion.\n\n=== Transition States\n\n==== TS-0: Baseline State (Current)\n\n===== Characteristics\n\n* D365 Customer Engagement handles all digital customer feedback\n* App-specific database stores customer Contact data\n* No ProfileService or EngagementService\n* No event-driven architecture\n* Synchronous feedback submission\n\n===== Components Active\n\n- D365 Customer Engagement\n- App-specific customer database\n- Mobile App (current version with D365 CE integration)\n\n==== TS-1: Build & Test\n\n===== Activities\n\n* Build ProfileService microservice (JIT Contact reconciliation API)\n* Build EngagementService microservice (feedback submission API, ACL for Salesforce Case creation, Braze integration, webhook receiver)\n* Implement Event Bus infrastructure (SNS+SQS/EventBridge/Kinesis)\n* Develop Contact migration tool (app database → Salesforce upsert by email/phone/VCI)\n* Update Mobile App API integration (ProfileService + EngagementService endpoints - feedback form UI already complete)\n* Integration testing (ProfileService ↔ Salesforce, EngagementService ↔ Salesforce, EngagementService ↔ Braze)\n* UAT with test Salesforce sandbox environment\n\n===== Components Active\n\n- D365 Customer Engagement (still active, unchanged)\n- App-specific customer database (still active)\n- ProfileService (non-production, testing only)\n- EngagementService (non-production, testing only)\n- Event Bus (non-production)\n- Salesforce Sandbox (testing)\n\n===== Exit Criteria\n\n- All integration tests pass\n- UAT sign-off from business stakeholders\n- Contact migration tool validated in sandbox\n- Mobile App updates tested with non-production APIs\n\n==== TS-2: Contact Migration\n\n===== Activities\n* Execute Contact migration (app database → Salesforce production)\n* Validation: 100% data integrity check (email/phone/VCI matching)\n* Reconciliation report: New Contacts created vs existing Contacts updated\n* Freeze app database Contact updates during migration window\n* ProfileService smoke testing (verify Contact lookups work in Salesforce production)\n\n===== Components Active\n- D365 Customer Engagement (still active, users unaffected)\n- Salesforce Production (Contacts migrated, no Cases yet)\n- ProfileService (production deployed, not integrated with Mobile App yet)\n- App-specific customer database (frozen, read-only)\n\n===== Exit Criteria\n- 100% of Contacts migrated with zero data loss\n- Email/phone/VCI matching accuracy > 95%\n- ProfileService smoke tests pass (JIT lookups return correct Contact IDs)\n- Reconciliation report approved\n\n==== TS-3: Cutover (Go-Live)\n\n===== Go-Live Activities\n\n* Deploy EngagementService to production\n* Deploy Mobile App updates (ProfileService + EngagementService API integration)\n* Configure Salesforce webhook (Case update notifications → EngagementService)\n* Smoke testing: End-to-end feedback submission (Mobile App → EngagementService → Salesforce → Braze notification)\n* Monitor Event Bus queue depth, dead letter queue, Salesforce API rate limits\n* **Go/No-Go decision**: Validate success criteria before final cutover\n* Enable feature flag: `enable_salesforce_feedback_submission = ON`\n* Disable D365 CE integration in Mobile App\n\n===== Components Active\n\n- ProfileService (production, integrated with Mobile App)\n- EngagementService (production, integrated with Mobile App)\n- Event Bus (production, processing async Case creation)\n- Salesforce Production (receiving Cases from digital customers)\n- Braze (sending push notifications)\n- Mobile App (new version with Salesforce integration)\n- D365 Customer Engagement (disabled, read-only for historical lookups)\n\n===== Exit Criteria\n\n- Mobile App feedback submission success rate > 99.5%\n- End-to-end flow validated (Mobile App → Salesforce Case created)\n- Braze push notifications delivered successfully\n- Event Bus queue depth normal, DLQ empty\n- No critical incidents (P1/P2) in first 24 hours\n\n==== TS-4: Target State (Stable Production)\n\n===== Characteristics\n\n* ProfileService and EngagementService fully operational\n* All digital customer feedback routed to Salesforce\n* Event-driven architecture established\n* D365 CE decommissioned\n* First DDD bounded contexts implemented successfully\n\n===== Monitoring Period\n\n* Validate success criteria: feedback submission rate > 99.5%, no data loss\n* Monitor customer satisfaction score (target: +15% improvement)\n* Monitor average case resolution time (target: -20% improvement)\n* Support agents using unified Salesforce view across all channels\n\n===== D365 CE Retirement\n\n* D365 CE read-only access for historical Case lookups (if needed)\n* Decommission D365 CE infrastructure after 90 days\n* Archive D365 CE data for compliance/auditing\n\n===== Components Active\n\n- ProfileService (production)\n- EngagementService (production)\n- Event Bus (production)\n- Salesforce Production (system of record)\n- Braze (push notifications)\n- Mobile App (Salesforce integration)\n- App-specific database (deprecated, Contact data no longer updated)\n\n===== Success Criteria Achieved\n\n- All digital customer feedback routed to Salesforce\n- Support agents have unified customer view\n- D365 CE decommissioned\n- Customer satisfaction improved by 15%\n- Average case resolution time decreased by 20%\n- Zero data loss during transition\n\n=== Transition Dependencies\n\n[width=\"100%\",cols=\"40%,60%\",options=\"header\",]\n|===\n|Dependency |Owner/Status\n\n|*Salesforce production access*\n|Viva Energy Salesforce admin team - TBD\n\n|*Salesforce Case field mapping*\n|Viva Energy Salesforce admin team - TBD (map OTR feedback categories to Salesforce fields)\n\n|*Salesforce data isolation strategy*\n|Viva Energy Salesforce admin team - TBD (Record Types, queues, custom fields)\n\n|*Salesforce webhook configuration*\n|Viva Energy Salesforce admin team - TBD (Outbound Messages vs Platform Events)\n\n|*Event Bus infrastructure*\n|OTR Platform team - Existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis)\n\n|*Braze integration*\n|OTR Marketing team - Existing Braze account, EngagementService creates new campaigns\n\n|*Mobile App release window*\n|OTR Mobile team - Coordinate cutover timing with app release schedule\n\n|*App database access*\n|OTR Platform team - Read access for Contact migration\n\n|===\n\n=== Transition Validation Criteria\n\n==== Contact Migration Validation\n\n* 100% of app database Contacts migrated to Salesforce (zero data loss)\n* Email/phone/VCI matching accuracy > 95% (minimize duplicate Contacts)\n* ProfileService JIT lookups return correct Salesforce Contact IDs (smoke test sample)\n* Reconciliation report shows: X new Contacts created, Y existing Contacts updated\n\n==== Cutover Validation\n\n* Mobile App feedback submission success rate > 99.5% (including async Case creation)\n* End-to-end flow validated: Mobile App → ProfileService → EngagementService → Salesforce Case created\n* Braze push notifications delivered for Case creation and Case resolution\n* Event Bus queue depth within normal range (no backlog)\n* Dead letter queue empty (no failed Case creations)\n* Salesforce API rate limits not exceeded\n\n==== Production Monitoring (30 days)\n\n* Customer satisfaction score improves by 15% (compared to D365 CE baseline)\n* Average case resolution time decreases by 20% (Salesforce vs D365 CE)\n* Support agents confirm unified customer view across all channels\n* Zero critical incidents (P1 outages, data loss)\n\n=== Rollback Plan\n\n==== Rollback Triggers\n\n* Feedback submission success rate < 95% (below acceptable threshold)\n* Data loss or corruption detected in Salesforce\n* Salesforce API rate limits exceeded (Cases not created within SLA)\n* Critical bug blocking customer feedback submission\n\n==== Rollback Procedure\n\n1. **Revert Mobile App** to previous version (remove ProfileService/EngagementService integration, restore D365 CE integration)\n2. **Stop EngagementService** Case creation (prevent duplicate Cases in Salesforce)\n3. **Re-enable D365 CE** for customer feedback submission\n4. **Investigate root cause** (EngagementService logs, Salesforce API errors, Event Bus queue issues)\n5. **Fix and re-test** in sandbox environment\n6. **Retry cutover** when issues resolved\n\n==== Rollback Limitations\n\n* Cases created in Salesforce during cutover period remain in Salesforce (no reverse migration)\n* Contacts migrated to Salesforce remain (no rollback to app database)\n* Rollback only affects Mobile App integration (not data migration)\n\n=== Architectural Scope Boundaries\n\n==== Capabilities Included\n\n===== Business Capabilities\n\n* **Customer Feedback Submission**: Mobile App users can submit structured feedback (Category, Store Name, Time of Visit, Phone, Free Text Message) via EngagementService\n* **Customer Contact Management**: Just-In-Time (JIT) Contact reconciliation with Salesforce via ProfileService, ensuring every Mobile App user has a Salesforce Contact record\n* **Case Management Integration**: EngagementService creates Salesforce Cases asynchronously for customer feedback, support agents manage Cases in Salesforce Service Cloud\n* **Customer Notifications**: Push notifications via Braze when Cases are created, updated, or resolved (bidirectional integration: Mobile App → Salesforce → Mobile App)\n* **Unified Customer View**: Support agents see OTR digital customer feedback alongside other Viva Energy channels (fuel wholesale, Shell Card, retail) in single Salesforce instance\n* **Contact Data Migration**: One-time migration of app-specific customer database Contacts to Salesforce with upsert logic (email/phone/VCI matching)\n\n===== Technical Capabilities\n\n* **ProfileService Bounded Context**: First DDD bounded context implementation - JIT Contact reconciliation, Salesforce API facade, foundation for Flybuys integration\n* **EngagementService Bounded Context**: First DDD bounded context implementation - Customer feedback submission BFF, Anti-Corruption Layer for Salesforce, Braze integration orchestration\n* **Event-Driven Architecture**: Domain event publishing via Event Bus (SNS+SQS/EventBridge/Kinesis) for `SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted` events\n* **Async Processing Pattern**: Non-blocking Case creation with retry logic, exponential backoff, dead letter queue for operational resilience\n* **Anti-Corruption Layer Pattern**: EngagementService protects digital channels from Salesforce API changes, translates between OTR domain language and Salesforce\n* **Conformist Pattern**: ProfileService and EngagementService conform to existing Salesforce configuration (shared Viva Energy instance, multi-tenant governance)\n* **Salesforce Integration**: REST API integration for Contact CRUD and Case creation, webhook receiver for Case update notifications\n* **Braze Integration**: Push notification campaign triggers for Case lifecycle events (created, updated, resolved)\n* **Observability & Monitoring**: Dashboards, metrics, alerting for feedback submission rate, queue depth, API errors, Case creation latency\n* **Feature Flag Management**: Kill switches for emergency rollback (enable_salesforce_feedback_submission, enable_async_case_creation, etc.)\n\n==== Capabilities Excluded\n\n===== Business Capabilities Explicitly Out of Scope\n\n* **Historical Case Migration**: D365 CE Cases not migrated to Salesforce (ADR-CS-005 - fresh start, no Case migration)\n* **Multi-Channel Feedback Submission**: Web app, POS, call centre, email feedback channels not included (Mobile App only in this phase)\n* **Case Resolution by Digital Channels**: Support agents resolve Cases in Salesforce, not via Mobile App self-service\n* **Knowledge Base Integration**: Salesforce Knowledge Base articles not surfaced in Mobile App (future enhancement)\n* **Live Chat/Messaging**: Real-time chat support not included (Salesforce omnichannel capabilities not activated)\n* **Sentiment Analysis**: Automated feedback sentiment analysis not included (future enhancement with AI/ML)\n* **Customer Satisfaction Surveys**: Post-resolution CSAT surveys not included (separate initiative)\n* **Case Attachments**: Mobile App feedback submission does not support file uploads (photos, receipts) - text only\n* **Agent Desktop Integration**: Custom Salesforce UI for support agents not included (use standard Salesforce Service Console)\n* **Social Media Feedback**: Facebook, Twitter, Instagram feedback channels not integrated\n\n===== Technical Capabilities Explicitly Out of Scope\n\n* **Event Sourcing**: Domain events are ephemeral (not persisted for event sourcing/replay) - Event Bus only, no Event Store\n* **CQRS (Command Query Responsibility Segregation)**: ProfileService and EngagementService use same data model for reads/writes (no separate read models)\n* **Local Aggregate Persistence**: ProfileService and EngagementService are stateless (Salesforce is System of Record, no local database for Contact/Case)\n* **Saga Orchestration**: No distributed transactions or saga patterns required (single-step Case creation, not multi-step workflow)\n* **API Gateway Advanced Features**: Rate limiting, API versioning, API key management deferred to detailed design (basic routing only)\n* **GraphQL API**: ProfileService and EngagementService expose REST APIs only (GraphQL not required)\n* **Real-Time Sync**: Salesforce Contact updates by support agents not synced back to ProfileService (eventual consistency acceptable via JIT reconciliation)\n* **Multi-Region Deployment**: Single AWS region deployment (no multi-region failover/disaster recovery in this phase)\n* **Blue-Green Deployment**: Big bang cutover (ADR-CS-006), not blue-green or canary deployment strategy\n* **A/B Testing Framework**: Feature flags for rollback only, not for A/B testing or experimentation\n* **Custom Authentication**: Microsoft Entra External ID used for Mobile App authentication (no custom authentication logic in ProfileService/EngagementService)\n* **Data Residency Compliance**: Salesforce data residency governed by Viva Energy Salesforce configuration (no OTR-specific data residency requirements)\n\n===== Future Bounded Contexts Not in Scope\n\n* **LoyaltyService**: Flybuys integration, reward preferences, transaction adjudication (separate initiative)\n* **LocationService**: Store finder, proximity features, geofencing (separate initiative)\n* **PaymentService**: Payment processing, subscription billing (separate initiative)\n* **RecommendationService**: Personalized recommendations, next-best offers (separate initiative)\n\n===== Integration Patterns Not in Scope\n\n* **Shared Kernel**: No shared domain model between ProfileService and EngagementService (separate bounded contexts with clear boundaries)\n* **Partnership**: No joint development or coordination with external teams (Conformist pattern - we conform to Salesforce)\n* **Customer-Supplier (we're upstream)**: No downstream systems depend on ProfileService/EngagementService APIs yet (future bounded contexts will consume domain events)\n\n==== Architectural Dependencies on Future Initiatives\n\n*This Architecture Enables Future Initiatives*:\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Future Initiative |Architectural Enablement\n\n|*Flybuys Integration*\n|**ProfileService Contact Reconciliation Reused**: ProfileService establishes pattern for JIT Contact reconciliation with Salesforce, which will be extended for Flybuys partner linking (link:../architecture_definitions/flybuys_integration.adoc[see Flybuys Integration architecture]) +\n**Event Bus Infrastructure**: Domain event publishing pattern (`CustomerEnrolledInLoyalty`, `PartnerLinked`, etc.) reuses Event Bus established for EngagementService\n\n|*LoyaltyService Bounded Context*\n|**Event Bus Subscription**: LoyaltyService will consume `CustomerProfileCreated` events published by ProfileService (future enhancement) +\n**Salesforce Contact Integration**: LoyaltyService may query Salesforce Contacts for customer reward preferences (via ProfileService facade or direct Salesforce API)\n\n|*Web App Feedback Submission*\n|**EngagementService API Reuse**: Web app will call same EngagementService REST API for feedback submission (multi-channel support) +\n**Conformist Pattern**: Web app conforms to EngagementService API contract (no translation required)\n\n|*Multi-Channel Customer Support*\n|**EngagementService Extension**: Add support for email, call centre, POS feedback channels (extend EngagementService to handle multiple origins) +\n**Salesforce Case Origin Field**: Cases already tagged with Origin=Mobile App, extend to Origin=Web, POS, Call Centre, Email\n\n|*Knowledge Base Integration*\n|**EngagementService API Extension**: Add endpoint to query Salesforce Knowledge Base articles, surface in Mobile App for self-service support +\n**Anti-Corruption Layer**: EngagementService translates Salesforce Knowledge API to OTR domain language\n\n|*Customer Satisfaction Surveys*\n|**Event-Driven Trigger**: Subscribe to `SupportCaseResolved` events published by EngagementService, trigger CSAT survey via Braze +\n**Braze Integration Pattern**: Reuse EngagementService → Braze integration pattern for survey campaigns\n\n|*Sentiment Analysis*\n|**Event Subscription**: Subscribe to `CustomerFeedbackSubmitted` events, analyse feedback sentiment (AI/ML service) +\n**EngagementService Extension**: Enrich Case with sentiment score before creating in Salesforce\n\n|*RecommendationService Bounded Context*\n|**Event Subscription**: RecommendationService subscribes to `SupportCaseCreated` events to understand customer pain points and personalize recommendations +\n**Domain Event Pattern**: Reuse Event Bus publishing pattern established by EngagementService\n\n|===\n\n*This Architecture Depends on Future Initiatives*:\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Future Initiative |Dependency Description\n\n|*Salesforce Data Isolation Strategy*\n|**BLOCKER**: Viva Energy Salesforce admin team must define data isolation strategy (Record Types, custom fields, queues) before production deployment +\n**Impact**: Multi-tenant data visibility and security governance\n\n|*Salesforce Case Field Mapping*\n|**BLOCKER**: Viva Energy Salesforce admin team must define field mapping for OTR feedback categories (App, Service, Order, Rewards, Refund, Delete Account) +\n**Impact**: Case creation logic in EngagementService depends on finalized Salesforce schema\n\n|*Salesforce Webhook Mechanism*\n|**BLOCKER**: Viva Energy Salesforce admin team must configure webhook mechanism (Outbound Messages vs Platform Events vs Process Builder) for Case update notifications +\n**Impact**: EngagementService webhook receiver implementation depends on chosen mechanism\n\n|*Event Bus Technology Selection*\n|**DECISION REQUIRED**: Choose Event Bus implementation (SNS+SQS vs EventBridge vs Kinesis) for domain event publishing +\n**Impact**: Infrastructure provisioning, event schema design, consumer implementation\n\n|*Microservice Hosting Platform*\n|**DECISION REQUIRED**: Choose hosting platform for ProfileService and EngagementService (AWS Lambda vs ECS vs EKS) +\n**Impact**: Deployment architecture, auto-scaling strategy, operational overhead\n\n|*Observability Platform*\n|**DECISION REQUIRED**: Choose observability platform (AWS CloudWatch vs Datadog vs New Relic) for monitoring and alerting +\n**Impact**: Dashboard configuration, metric collection, alerting setup\n\n|===\n\n*Future Work After This Initiative*:\n\n* **Event Schema Registry**: Implement event schema versioning and registry for domain events (currently ad-hoc schemas)\n* **API Versioning Strategy**: Define API versioning approach for ProfileService and EngagementService (currently v1 only)\n* **Multi-Region Deployment**: Extend to multi-region for disaster recovery and global availability\n* **Event Store**: Persist domain events for event sourcing and audit trail (currently ephemeral Event Bus only)\n* **CQRS Pattern**: Separate read models for high-volume queries (currently same model for reads/writes)\n* **GraphQL API**: Expose GraphQL API for flexible client queries (currently REST only)\n* **Real-Time Sync**: Bi-directional sync between Salesforce and ProfileService for Contact updates (currently JIT reconciliation only)\n\n=== Technical Risks and Mitigation\n\n[width=\"100%\",cols=\"5%,20%,25%,25%,25%\",options=\"header\",]\n|===\n|ID |Risk |Impact |Likelihood |Mitigation\n\n|RISK-CS-001\n|*Salesforce API rate limits exceeded*: High feedback volume exceeds Salesforce API limits, Cases not created\n|HIGH (customers don't receive Case confirmation, support tickets lost)\n|MEDIUM (volume unknown, rate limits TBD)\n|• Gather expected feedback volume data before cutover +\n• Implement Event Bus queue throttling/rate limiting +\n• Monitor queue depth and API usage +\n• Scale background workers based on queue depth +\n• Alert ops team when approaching rate limits\n\n|RISK-CS-002\n|*Salesforce downtime*: Salesforce Service Cloud outage prevents Case creation\n|MEDIUM (Cases delayed but queued, customers wait for confirmation)\n|LOW (Salesforce SLA 99.9% uptime)\n|• Async Case creation with retry logic +\n• Event Bus queues buffer work during outage +\n• Customers get immediate \"Feedback submitted\" (not blocked) +\n• Monitor Salesforce status page, alert ops team +\n• Automatic retry when Salesforce recovers\n\n|RISK-CS-003\n|*Contact migration data quality issues*: App database Contact data incomplete or invalid\n|HIGH (migration fails validation, cutover delayed)\n|MEDIUM (legacy data quality unknown)\n|• Pre-migration data quality assessment +\n• Flexible upsert logic (match by email/phone/VCI) +\n• Validation report identifies data issues before production migration +\n• Manual cleanup for invalid records +\n• Dry-run migration in sandbox environment\n\n|RISK-CS-004\n|*Duplicate Contacts created*: Email matching fails, ProfileService creates duplicate Contacts\n|MEDIUM (support agents see multiple profiles for same customer)\n|MEDIUM (email changes, data quality issues)\n|• Salesforce duplicate detection rules (if available) +\n• ProfileService logs Contact creation for audit trail +\n• Manual duplicate cleanup process (support team) +\n• Future enhancement: VCI as Salesforce External ID for stable matching\n\n|RISK-CS-005\n|*Dead letter queue accumulation*: Failed Case creations not processed, queue grows\n|HIGH (customers don't receive Case confirmation, feedback lost)\n|LOW (retry logic handles most failures)\n|• Dead letter queue monitoring and alerting +\n• Ops team dashboard showing DLQ depth +\n• Manual intervention process (investigate and reprocess) +\n• Automated alerts when DLQ depth exceeds threshold +\n• Root cause analysis for recurring failures\n\n|RISK-CS-006\n|*Salesforce webhook failures*: Salesforce can't deliver Case update notifications to EngagementService\n|MEDIUM (customers don't get push notifications for Case resolution)\n|LOW (webhook mechanism reliable)\n|• Webhook retry logic and exponential backoff +\n• EngagementService logs webhook deliveries +\n• Monitor webhook delivery success rate +\n• Fallback: Poll Salesforce API for Case updates (if webhook fails persistently) +\n• Alert ops team when webhook delivery rate drops\n\n|RISK-CS-007\n|*Multi-tenant data isolation breach*: OTR digital Cases visible to other Viva Energy support teams\n|HIGH (privacy violation, compliance risk)\n|LOW (Salesforce governance controls)\n|• Work with Viva Energy Salesforce admin team on data isolation strategy +\n• Test data visibility in Salesforce sandbox (UAT with different user roles) +\n• Validate Record Types, queues, field-level security before production +\n• Audit Salesforce user permissions and sharing rules\n\n|RISK-CS-008\n|*Mobile App release coordination*: App release delayed, cutover window missed\n|MEDIUM (cutover delayed, D365 CE retirement delayed)\n|MEDIUM (release schedule conflicts)\n|• Coordinate cutover timing with Mobile team early +\n• Buffer time in migration plan (2-week contingency) +\n• Decouple backend deployment from Mobile App release (backend deployed first, app follows) +\n• Feature flag for feedback submission (enable when ready)\n\n|RISK-CS-009\n|*Event Bus infrastructure issues*: SNS/SQS/EventBridge downtime or misconfiguration\n|HIGH (Case creation blocked, domain events not published)\n|LOW (AWS SLA 99.99% uptime)\n|• Leverage existing AWS infrastructure (proven, reliable) +\n• Infrastructure as Code (IaC) for Event Bus configuration +\n• Integration testing in non-production environment +\n• Monitor Event Bus metrics (queue depth, throughput, errors) +\n• Alert ops team on Event Bus failures\n\n|RISK-CS-010\n|*Team DDD knowledge gap*: Team unfamiliar with DDD patterns, bounded contexts, event-driven architecture\n|MEDIUM (implementation delays, architectural inconsistencies)\n|HIGH (first DDD implementation)\n|• DDD training for development team (workshops, documentation) +\n• Architecture review sessions (validate bounded context design) +\n• Pair programming with experienced DDD practitioners +\n• Incremental implementation (start small, iterate) +\n• Document architectural patterns in CLAUDE.md\n\n|===\n\n== Assumptions and Constraints\n\n=== Assumptions\n\n[width=\"100%\",cols=\"8%,92%\",options=\"header\",]\n|===\n|ID |Assumption\n\n|ASM-CS-001\n|Viva Energy Salesforce admin team will provide Salesforce production access, sandbox environment, and support for Case field mapping and data isolation configuration\n\n|ASM-CS-002\n|App database Contact data is sufficiently complete for migration (email/phone/VCI available for matching)\n\n|ASM-CS-003\n|Expected customer feedback volume (100-150 submissions/day from 20k DAU) is well within Salesforce API rate limits, with capacity planning for 3x-10x growth\n\n|ASM-CS-004\n|Existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis) is sufficient for Event Bus implementation (no additional infrastructure provisioning required)\n\n|ASM-CS-005\n|Braze integration already exists and can be extended for Case-related push notifications (no new Braze account or major configuration changes)\n\n|ASM-CS-006\n|Mobile App users have email addresses associated with their accounts (required for ProfileService Contact reconciliation)\n\n|ASM-CS-007\n|D365 Customer Engagement historical Cases have limited business value and do not require migration to Salesforce\n\n|ASM-CS-008\n|Support agents are trained on Salesforce Service Cloud and require minimal additional training for OTR digital customer Cases\n\n|ASM-CS-009\n|Salesforce Service Cloud shared instance has capacity for OTR digital customer Contacts and Cases (no additional licensing or storage costs)\n\n|ASM-CS-010\n|Mobile App release schedule can accommodate cutover timing (Week 10 in migration plan)\n\n|===\n\n=== Constraints\n\n[width=\"100%\",cols=\"8%,92%\",options=\"header\",]\n|===\n|ID |Constraint\n\n|CON-CS-001\n|Must use shared Viva Energy Salesforce Service Cloud instance (cannot deploy separate OTR-specific instance)\n\n|CON-CS-002\n|Must conform to existing Salesforce configuration and governance (Record Types, custom fields, queues, data isolation strategy defined by Viva Energy admin team)\n\n|CON-CS-003\n|Contact migration must complete before Mobile App cutover (no parallel run of D365 CE and Salesforce)\n\n|CON-CS-004\n|Big bang cutover only (no phased rollout with feature flags or pilot users)\n\n|CON-CS-005\n|Salesforce API rate limits and authentication method constrained by Viva Energy Salesforce configuration (TBD)\n\n|CON-CS-006\n|Event Bus implementation must use existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis - cannot introduce new infrastructure components)\n\n|CON-CS-007\n|Mobile App feedback form must include specific fields: Category, Store Name, Time of Visit, Contact Phone Number, Free Text Message (no attachments)\n\n|CON-CS-008\n|D365 Customer Engagement must be decommissioned within 90 days post-cutover (ADR-CS-006)\n\n|CON-CS-009\n|ProfileService and EngagementService must be stateless (no local aggregate persistence, Salesforce is System of Record)\n\n|CON-CS-010\n|First DDD bounded context implementation (team learning curve, architectural patterns must be documented for future bounded contexts)\n\n|===\n\n== Non-Functional Requirements\n\n=== Performance Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-PERF-001\n|Mobile App feedback submission API response time (ProfileService + EngagementService)\n|p95 < 1 second, p99 < 2 seconds\n\n|NFR-PERF-002\n|ProfileService Contact reconciliation API response time (JIT lookup)\n|p95 < 500ms, p99 < 1 second\n\n|NFR-PERF-003\n|EngagementService async Case creation latency (end-to-end: feedback submitted → Case created in Salesforce)\n|p95 < 5 minutes, p99 < 10 minutes\n\n|NFR-PERF-004\n|Salesforce API call latency (Contact query, Contact create, Case create)\n|p95 < 2 seconds, p99 < 5 seconds\n\n|NFR-PERF-005\n|Event Bus message processing throughput\n|> 100 messages/second (support peak feedback volume)\n\n|NFR-PERF-006\n|Braze push notification delivery latency (Case created → notification delivered)\n|p95 < 30 seconds, p99 < 60 seconds\n\n|===\n\n=== Availability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-AVAIL-001\n|ProfileService availability\n|99.9% uptime (8.76 hours downtime/year)\n\n|NFR-AVAIL-002\n|EngagementService availability\n|99.9% uptime (8.76 hours downtime/year)\n\n|NFR-AVAIL-003\n|Feedback submission success rate (including async Case creation)\n|> 99.5% (includes retry logic for transient failures)\n\n|NFR-AVAIL-004\n|Graceful degradation: Salesforce downtime handling\n|Feedback submission still succeeds, Cases queued for async creation when Salesforce recovers\n\n|NFR-AVAIL-005\n|Graceful degradation: Braze downtime handling\n|Case creation proceeds, push notifications disabled temporarily (feature flag)\n\n|NFR-AVAIL-006\n|Planned maintenance window\n|< 4 hours/month, scheduled during low-traffic periods (2-6am ACST)\n\n|===\n\n=== Scalability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-SCALE-001\n|Concurrent Mobile App users (peak)\n|Support 20,000 DAU (Daily Active Users), ~150 concurrent users submitting feedback during peak hours\n\n|NFR-SCALE-002\n|Feedback submissions per day\n|Expected: 100-150 submissions/day based on 20k DAU (~0.5-0.75% submission rate) +\nCapacity: Support 500 submissions/day (3x expected volume for growth), 2,000 submissions/day (peak/incident scenarios)\n\n|NFR-SCALE-003\n|Auto-scaling: ProfileService and EngagementService\n|Auto-scale based on CPU/memory/request rate, scale up within 2 minutes\n\n|NFR-SCALE-004\n|Event Bus queue capacity\n|Support 100,000 queued messages (buffer for Salesforce downtime)\n\n|NFR-SCALE-005\n|Salesforce API rate limit compliance\n|Stay within 80% of Salesforce API rate limits (buffer for spikes)\n\n|NFR-SCALE-006\n|Future growth capacity\n|Architecture supports 10x growth (1,000-1,500 submissions/day based on 200k DAU) without major redesign\n\n|===\n\n=== Security Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-SEC-001\n|Mobile App authentication\n|Microsoft Entra External ID OAuth 2.0 with JWT tokens (existing CIAM)\n\n|NFR-SEC-002\n|API authorisation: ProfileService and EngagementService\n|JWT token validation, authenticated users only, user context propagation\n\n|NFR-SEC-003\n|Salesforce API authentication\n|OAuth 2.0 with Connected App and JWT bearer flow (service account)\n\n|NFR-SEC-004\n|Data encryption in transit\n|TLS 1.2+ for all API calls (Mobile App ↔ ProfileService/EngagementService ↔ Salesforce ↔ Braze)\n\n|NFR-SEC-005\n|Data encryption at rest\n|Salesforce encryption at rest (managed by Salesforce), Event Bus message encryption (AWS KMS)\n\n|NFR-SEC-006\n|Secret management\n|AWS Secrets Manager for Salesforce credentials, Braze API keys, OAuth tokens (no hardcoded secrets)\n\n|NFR-SEC-007\n|PII data handling\n|Contact data (email, phone, name) treated as PII, GDPR-compliant retention policies (Salesforce governance)\n\n|NFR-SEC-008\n|API rate limiting and throttling\n|API Gateway rate limiting (100 requests/second per user), prevent abuse and DoS\n\n|NFR-SEC-009\n|Logging and auditing\n|Log all API calls, Salesforce Contact/Case creates/updates, Event Bus publishes (no PII in logs)\n\n|NFR-SEC-010\n|Salesforce data isolation\n|Multi-tenant data isolation via Salesforce Record Types, queues, sharing rules (defined by Viva Energy admin team)\n\n|===\n\n=== Reliability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-REL-001\n|Retry logic: EngagementService → Salesforce Case creation\n|Exponential backoff (1s, 2s, 4s, 8s, 16s), max 5 retries, then dead letter queue\n\n|NFR-REL-002\n|Dead letter queue monitoring\n|Alert ops team immediately when DLQ depth > 0 (failed Case creations require manual intervention)\n\n|NFR-REL-003\n|Event Bus message durability\n|Messages persisted in Event Bus (SNS+SQS/EventBridge/Kinesis), not lost on service restart\n\n|NFR-REL-004\n|Idempotency: Case creation\n|EngagementService ensures duplicate feedback submissions don't create duplicate Cases (idempotency key)\n\n|NFR-REL-005\n|Circuit breaker: Salesforce API calls\n|Open circuit after 5 consecutive failures, half-open retry after 30 seconds\n\n|NFR-REL-006\n|Health checks: ProfileService and EngagementService\n|Health endpoints for load balancer checks, readiness and liveness probes\n\n|NFR-REL-007\n|Disaster recovery: Event Bus\n|Event Bus messages replicated across AWS availability zones (SQS/EventBridge/Kinesis HA)\n\n|===\n\n=== Maintainability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-MAINT-001\n|Code quality: ProfileService and EngagementService\n|> 80% test coverage (unit + integration tests), automated CI/CD pipeline\n\n|NFR-MAINT-002\n|API documentation\n|OpenAPI/Swagger specs for ProfileService and EngagementService, auto-generated API docs\n\n|NFR-MAINT-003\n|Deployment automation\n|Infrastructure as Code (Terraform/CloudFormation/CDK), zero-downtime deployments\n\n|NFR-MAINT-004\n|Logging: structured logs\n|JSON-formatted logs with correlation IDs, log levels (DEBUG, INFO, WARN, ERROR), centralized log aggregation\n\n|NFR-MAINT-005\n|Monitoring dashboards\n|Real-time dashboards for ProfileService, EngagementService, Event Bus (see Monitoring and Observability section)\n\n|NFR-MAINT-006\n|Alerting and on-call\n|PagerDuty/Opsgenie integration for P1/P2 alerts, on-call rotation for ops team\n\n|NFR-MAINT-007\n|Configuration management\n|Externalized configuration (environment variables, AWS Parameter Store), no hardcoded config\n\n|NFR-MAINT-008\n|Versioning: API and events\n|Semantic versioning (v1, v2), backward compatibility for API changes, event schema evolution\n\n|===\n\n=== Usability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-USE-001\n|Feedback submission UX\n|Mobile App user receives immediate \"Feedback submitted\" confirmation (< 1 second), not blocked by async Case creation\n\n|NFR-USE-002\n|Push notification delivery\n|Customer receives \"Your feedback has been received\" notification within 30 seconds of Case creation in Salesforce\n\n|NFR-USE-003\n|Case resolution notification\n|Customer receives \"Your case has been resolved\" notification within 30 seconds of support agent resolving Case\n\n|NFR-USE-004\n|Error messaging\n|User-friendly error messages for failed feedback submission (not technical errors), retry prompts\n\n|NFR-USE-005\n|Accessibility\n|Mobile App feedback form meets WCAG 2.1 AA accessibility standards (existing Mobile App compliance)\n\n|===\n\n=== Compliance Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-COMP-001\n|GDPR compliance: PII data\n|Customer Contact data (email, phone, name) managed per GDPR retention policies (Salesforce governance)\n\n|NFR-COMP-002\n|GDPR compliance: Right to erasure\n|Support \"Delete Account\" feedback category, trigger Contact deletion in Salesforce per GDPR Article 17\n\n|NFR-COMP-003\n|Data residency\n|Salesforce data residency governed by Viva Energy Salesforce configuration (regional compliance)\n\n|NFR-COMP-004\n|Audit trail\n|All Contact creates/updates, Case creates/updates logged for compliance auditing (Salesforce audit logs)\n\n|NFR-COMP-005\n|API security standards\n|OWASP API Security Top 10 compliance (injection prevention, authentication, authorisation, data exposure)\n\n|===\n\n== Monitoring and Observability\n\n=== Key Metrics\n\n[width=\"100%\",cols=\"25%,40%,35%\",options=\"header\",]\n|===\n|Metric Category |Metric |Target/Threshold\n\n|*Feedback Submission*\n|Feedback submission success rate (Mobile App → EngagementService)\n|> 99.5%\n\n|*Async Case Creation*\n|Case creation success rate (EngagementService → Salesforce)\n|> 99%\n\n|*Async Case Creation*\n|Case creation latency (time from feedback submission to Case created in Salesforce)\n|p95 < 5 minutes\n\n|*Event Bus*\n|Event Bus queue depth (pending Case creations)\n|< 100 messages\n\n|*Event Bus*\n|Dead letter queue depth (failed Case creations)\n|= 0 (alert on any failures)\n\n|*Salesforce API*\n|Salesforce API error rate\n|< 1%\n\n|*Salesforce API*\n|Salesforce API latency (Case creation)\n|p95 < 2 seconds\n\n|*Salesforce API*\n|Salesforce API rate limit utilization\n|< 80% of limit\n\n|*ProfileService*\n|Contact reconciliation success rate (JIT lookups)\n|> 99.5%\n\n|*ProfileService*\n|Contact reconciliation latency\n|p95 < 500ms\n\n|*Braze Notifications*\n|Push notification delivery rate (Case created/updated)\n|> 95%\n\n|*Salesforce Webhook*\n|Webhook delivery success rate (Salesforce → EngagementService)\n|> 99%\n\n|*Customer Satisfaction*\n|Customer satisfaction score (CSAT)\n|> 4.0/5.0 (improve by 15% from D365 CE baseline)\n\n|*Support Operations*\n|Average case resolution time\n|Decrease by 20% from D365 CE baseline\n\n|===\n\n=== Alerting Thresholds\n\n[width=\"100%\",cols=\"25%,50%,25%\",options=\"header\",]\n|===\n|Alert |Condition |Severity\n\n|*Feedback submission failures*\n|Feedback submission success rate < 95% over 5-minute window\n|P1 - Critical\n\n|*Dead letter queue accumulation*\n|Dead letter queue depth > 0 (any failed Case creations)\n|P2 - High\n\n|*Event Bus queue backlog*\n|Event Bus queue depth > 100 messages for > 15 minutes\n|P2 - High\n\n|*Salesforce API errors*\n|Salesforce API error rate > 5% over 5-minute window\n|P1 - Critical\n\n|*Salesforce API rate limits*\n|Salesforce API rate limit utilization > 90%\n|P2 - High\n\n|*Contact reconciliation failures*\n|ProfileService Contact reconciliation failure rate > 5% over 5-minute window\n|P2 - High\n\n|*Braze notification failures*\n|Braze push notification delivery rate < 80% over 15-minute window\n|P3 - Medium\n\n|*Salesforce webhook failures*\n|Salesforce webhook delivery success rate < 90% over 15-minute window\n|P2 - High\n\n|*Case creation latency*\n|Case creation latency p95 > 10 minutes\n|P3 - Medium\n\n|===\n\n=== Dashboards\n\n*ProfileService Dashboard:*\n\n* Contact reconciliation success rate (JIT lookups)\n* Contact reconciliation latency (p50, p95, p99)\n* Contact creation vs update ratio (new Contacts created vs existing Contacts updated)\n* Salesforce API error rate (Contact queries and creates)\n* Request rate and throughput\n\n*EngagementService Dashboard:*\n\n* Feedback submission success rate\n* Case creation success rate (async workflow)\n* Case creation latency (p50, p95, p99)\n* Event Bus queue depth (pending Case creations)\n* Dead letter queue depth (failed Case creations)\n* Salesforce API error rate (Case creation)\n* Salesforce API latency\n* Salesforce API rate limit utilization\n* Braze push notification delivery rate\n* Salesforce webhook delivery success rate\n\n*Event Bus Dashboard:*\n\n* Queue depth (pending messages)\n* Throughput (messages published/consumed per minute)\n* Dead letter queue depth (failed messages)\n* Consumer lag (time between publish and consume)\n\n*Customer Support Dashboard (Business Metrics):*\n\n* Total feedback submissions per day/week/month\n* Feedback category breakdown (App, Service, Order, Rewards, Refund, Delete Account)\n* Customer satisfaction score (CSAT) trend\n* Average case resolution time trend\n* Case volume by support team/queue\n* Unified customer view adoption (support agent feedback)\n<<<\n== Solution Validation\n\nThis section defines the validation criteria and testing approach for the solution.\n\n=== Functional Validation\n\n==== ProfileService API Testing\n\n*Test Scenarios*:\n1. **Happy Path**: Authenticated user requests Contact ID, existing Contact found in Salesforce, Contact ID returned\n2. **JIT Creation**: Authenticated user requests Contact ID, no existing Contact, new Contact created in Salesforce, Contact ID returned\n3. **Salesforce API Failure**: Salesforce unavailable, ProfileService returns 500 error, user retries\n4. **Invalid JWT**: Unauthenticated request, ProfileService returns 401 error\n\n*Acceptance Criteria*:\n- Contact reconciliation success rate > 99.5%\n- JIT Contact creation completes within 500ms (p95)\n\n==== EngagementService API Testing\n\n*Test Scenarios*:\n1. **Happy Path**: Valid feedback submission, immediate 202 Accepted response, Case created in Salesforce within 5 minutes, Braze notification delivered\n2. **Invalid Category**: Invalid feedback category, 400 Bad Request response with validation error\n3. **Salesforce Downtime**: Salesforce unavailable during async Case creation, message queued, retry logic executes, Case created when Salesforce recovers\n4. **Dead Letter Queue**: Case creation fails after 5 retries, message moved to DLQ, ops team alerted\n5. **Webhook Notification**: Support agent resolves Case in Salesforce, webhook triggers EngagementService, Braze push notification sent to customer\n\n*Acceptance Criteria*:\n- Feedback submission success rate > 99.5% (including async Case creation)\n- Async Case creation completes within 5 minutes (p95)\n- Webhook delivery success rate > 99%\n\n=== Non-Functional Validation\n\n==== Performance Testing\n\n*Load Testing*:\n\n*Baseline*: Expected 100-150 submissions/day from 20k DAU (~0.5-0.75% submission rate)\n\n- **Normal Load**: 1 submission/minute sustained for 2 hours (simulate typical daily pattern)\n- **3x Load**: 3 submissions/minute sustained for 1 hour (simulate busy period, 450 submissions/day)\n- **Peak Load (10x)**: 10 submissions/minute for 15 minutes (simulate incident scenario, app outage causing backlog)\n- **Stress Test**: 50 submissions/minute for 5 minutes (find breaking point, 20x normal)\n\n*Validation*:\n- API response time p95 < 1 second under 10x load\n- Event Bus queue depth remains manageable (< 100 messages)\n- No Case creation failures, all submissions processed successfully\n- Auto-scaling triggers appropriately for sustained load > 3x baseline\n\n*Acceptance Criteria*:\n- NFR-PERF-001 through NFR-PERF-006 validated under realistic load (3x and 10x baseline)\n- Auto-scaling triggers within 2 minutes of load increase\n- System handles 10x peak gracefully, 20x stress test identifies limits\n\n==== Resilience Testing\n\n*Salesforce API Failure Scenarios*:\n1. **Complete Outage**: Salesforce unavailable for 2 hours, Event Bus queues buffer work, Cases created when Salesforce recovers\n2. **Rate Limit Exceeded**: Salesforce rate limit hit, queue throttling activates, Cases created within SLA\n\n*Acceptance Criteria*:\n- NFR-AVAIL-004 validated (graceful degradation during Salesforce downtime)\n- Circuit breaker activates after 5 consecutive failures\n\n==== Security Validation\n\n*Penetration Testing*:\n- API authentication bypass attempts\n- SQL injection attempts\n- Webhook signature validation bypass\n\n*Acceptance Criteria*:\n- NFR-SEC-001 through NFR-SEC-010 validated\n- OWASP API Security Top 10 compliance verified\n\n=== Integration Validation\n\n==== End-to-End Testing\n\n*Full User Journey*:\n1. User authenticates via Microsoft Entra External ID\n2. Mobile App requests Contact ID from ProfileService (JIT reconciliation)\n3. User submits feedback via EngagementService\n4. Background worker creates Case in Salesforce\n5. Braze notification delivered to user\n6. Support agent resolves Case in Salesforce\n7. Salesforce webhook triggers EngagementService\n8. Braze notification delivered to user\n\n*Acceptance Criteria*:\n- End-to-end flow completes successfully in UAT\n- User receives both \"feedback submitted\" and \"case resolved\" notifications\n","structuredPatch":[{"oldStart":2167,"oldLines":7,"newStart":2167,"newLines":7,"lines":[" "," *Prerequisites*:"," ","-* WP-CS-009 (Production Deployment) completed","+* <<wp-cs-009,WP-CS-009>> (Production Deployment) completed"," * Cutover successful with no critical incidents"," "," *Dependent Work Packages*:"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"8bea5b82-6ce0-47a3-836d-5db1ec23531c"}
{"parentUuid":"c59b3b08-e04a-475a-8a89-5711dda91229","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01Bm2WTkDeQiutGCyR54vpwG","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Good! Now let me check if there are any other references in the Work Package Sequencing section or elsewhere. Let me read that section.","signature":"ErACCkYICxgCKkB6OpIuC8PnEg9PoWTXwJ/n/6hqPTv4mcgU5t59dFib2lqwqokadOv+fZHbvw4oJhuLxkD43MFtIUApArCVWAgQEgy0WzFxSVdZ9SQLdVYaDBigaOF6vseOtowKXSIwoROYfJFl+MsUJl6FlGVAQ3ExbyJgAY7ukD/zLHbMp9q1NOMojJjztKRf0l1Uqx9/KpcBbzOAx7XOoXZ7X5cLueQLdAbYn9qGmN805NJChi1hdsB7VuFkTH2Guc2Gc65IUank64YDpcRJyMiCBQj8ix6hY+tXpiNRpP8zng+oIX6EVpxnJoBBhq+VS78RVePz5HzketvaoPtlR6WCSpbzkNwjWLInryovdYkwMFmYT0kn/FfhwEzbhEYHywfPlhwF3kjoE9cmjioQgRgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":1269,"cache_read_input_tokens":43095,"cache_creation":{"ephemeral_5m_input_tokens":1269,"ephemeral_1h_input_tokens":0},"output_tokens":6,"service_tier":"standard"}},"requestId":"req_011CWw5AoZkhBY79fTgqMr78","type":"assistant","uuid":"5d3a98a1-1edc-4224-815d-7d154f4540e6","timestamp":"2026-01-09T03:12:05.566Z"}
{"parentUuid":"5d3a98a1-1edc-4224-815d-7d154f4540e6","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01Bm2WTkDeQiutGCyR54vpwG","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01MyRg17YCnVzHFNetMfix3L","name":"Read","input":{"file_path":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","offset":2185,"limit":50}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":1269,"cache_read_input_tokens":43095,"cache_creation":{"ephemeral_5m_input_tokens":1269,"ephemeral_1h_input_tokens":0},"output_tokens":154,"service_tier":"standard"}},"requestId":"req_011CWw5AoZkhBY79fTgqMr78","type":"assistant","uuid":"185c5219-3baf-4b8a-ba16-529a061a2927","timestamp":"2026-01-09T03:12:06.113Z"}
{"parentUuid":"185c5219-3baf-4b8a-ba16-529a061a2927","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01MyRg17YCnVzHFNetMfix3L","type":"tool_result","content":"  2185→==== Acceptance Criteria\n  2186→\n  2187→* Zero critical incidents (P1/P2) in first 30 days post-cutover\n  2188→* Feedback submission success rate sustained > 99.5%\n  2189→* Customer satisfaction improvement validated (baseline established, ongoing measurement)\n  2190→* Support agents reporting positive experience with Salesforce unified view\n  2191→* D365 CE successfully decommissioned\n  2192→* All production documentation complete and approved\n  2193→* Lessons learned document published\n  2194→\n  2195→=== Work Package Sequencing\n  2196→\n  2197→==== Parallel Track 1: Infrastructure & Configuration\n  2198→\n  2199→Can start immediately and run in parallel:\n  2200→\n  2201→* WP-CS-003 (Event Bus Infrastructure)\n  2202→* WP-CS-007 (Salesforce Configuration)\n  2203→\n  2204→==== Parallel Track 2: Development\n  2205→\n  2206→Can start after Track 1 infrastructure decisions made:\n  2207→\n  2208→* WP-CS-001 (ProfileService Development) - Independent\n  2209→* WP-CS-002 (EngagementService Development) - Requires WP-CS-003 completed\n  2210→* WP-CS-004 (Contact Migration Tooling) - Requires WP-CS-001 completed (reuses code)\n  2211→\n  2212→==== Sequential Track 3: Integration & Testing\n  2213→\n  2214→Must complete after development:\n  2215→\n  2216→* WP-CS-005 (Mobile App Integration) - Requires WP-CS-001, WP-CS-002\n  2217→* WP-CS-006 (Integration Testing) - Requires WP-CS-001, WP-CS-002, WP-CS-003, WP-CS-005, WP-CS-007\n  2218→\n  2219→==== Sequential Track 4: Migration & Cutover\n  2220→\n  2221→Must complete sequentially:\n  2222→\n  2223→* WP-CS-008 (Contact Data Migration) - Requires WP-CS-001, WP-CS-004, WP-CS-006 UAT sign-off\n  2224→* WP-CS-009 (Production Deployment) - Requires all prior work packages completed\n  2225→* WP-CS-010 (Post-Cutover Support) - Requires WP-CS-009\n  2226→\n  2227→==== Critical Path\n  2228→\n  2229→The critical path for this project is:\n  2230→\n  2231→. WP-CS-003 (Event Bus Infrastructure)\n  2232→. WP-CS-002 (EngagementService Development) - blocks on WP-CS-003\n  2233→. WP-CS-005 (Mobile App Integration) - blocks on WP-CS-001, WP-CS-002\n  2234→. WP-CS-006 (Integration Testing) - blocks on WP-CS-001 through WP-CS-005, WP-CS-007\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"4021c621-da8c-4078-9dc0-8b036588e04b","timestamp":"2026-01-09T03:12:06.338Z","toolUseResult":{"type":"text","file":{"filePath":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","content":"==== Acceptance Criteria\n\n* Zero critical incidents (P1/P2) in first 30 days post-cutover\n* Feedback submission success rate sustained > 99.5%\n* Customer satisfaction improvement validated (baseline established, ongoing measurement)\n* Support agents reporting positive experience with Salesforce unified view\n* D365 CE successfully decommissioned\n* All production documentation complete and approved\n* Lessons learned document published\n\n=== Work Package Sequencing\n\n==== Parallel Track 1: Infrastructure & Configuration\n\nCan start immediately and run in parallel:\n\n* WP-CS-003 (Event Bus Infrastructure)\n* WP-CS-007 (Salesforce Configuration)\n\n==== Parallel Track 2: Development\n\nCan start after Track 1 infrastructure decisions made:\n\n* WP-CS-001 (ProfileService Development) - Independent\n* WP-CS-002 (EngagementService Development) - Requires WP-CS-003 completed\n* WP-CS-004 (Contact Migration Tooling) - Requires WP-CS-001 completed (reuses code)\n\n==== Sequential Track 3: Integration & Testing\n\nMust complete after development:\n\n* WP-CS-005 (Mobile App Integration) - Requires WP-CS-001, WP-CS-002\n* WP-CS-006 (Integration Testing) - Requires WP-CS-001, WP-CS-002, WP-CS-003, WP-CS-005, WP-CS-007\n\n==== Sequential Track 4: Migration & Cutover\n\nMust complete sequentially:\n\n* WP-CS-008 (Contact Data Migration) - Requires WP-CS-001, WP-CS-004, WP-CS-006 UAT sign-off\n* WP-CS-009 (Production Deployment) - Requires all prior work packages completed\n* WP-CS-010 (Post-Cutover Support) - Requires WP-CS-009\n\n==== Critical Path\n\nThe critical path for this project is:\n\n. WP-CS-003 (Event Bus Infrastructure)\n. WP-CS-002 (EngagementService Development) - blocks on WP-CS-003\n. WP-CS-005 (Mobile App Integration) - blocks on WP-CS-001, WP-CS-002\n. WP-CS-006 (Integration Testing) - blocks on WP-CS-001 through WP-CS-005, WP-CS-007","numLines":50,"startLine":2185,"totalLines":3329}},"sourceToolAssistantUUID":"185c5219-3baf-4b8a-ba16-529a061a2927"}
{"parentUuid":"4021c621-da8c-4078-9dc0-8b036588e04b","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01RRAbKUA4cddXtpgKg5c1SD","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Perfect! I need to update the Work Package Sequencing section as well. Let me update all the references there.","signature":"EpYCCkYICxgCKkAJ8QA+qI7ARqA5YDCcH0PP6GBbLSfV0CCyb4LABX2k10xREAs5t+RgZdBUOCqwx7Pij9mNfZUk0BwhzKYLpPm5Egx/ffZq+5GpARLLeQ0aDOLUVFX9WVkuVPGyRiIwddPXUaWUCXXPYuI+xMZi1W+ucr1VpCkyLInHqq7DznFdvaIntQ2HG9xw9b0VfKEnKn4g5hjPiUxelx4KgNeXf4mzTm56wWXopA/XgDU1gYx187d/f4ULl/NGTSeoET+5msZ+MNy2mIz36OO9G2iLkBdEUGe3XaA33nyvTtLMoI3yyIC04fcbOFhMOatJt7HbkTiP+g+/lsLDUEKu5q1ExUm+AuvLfX+O2da4HW3hHWkYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":1049,"cache_read_input_tokens":44364,"cache_creation":{"ephemeral_5m_input_tokens":1049,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWw5B9pAazJea3P8PrvAo","type":"assistant","uuid":"4608b5ea-7530-4a9b-b192-3d2aa958b61a","timestamp":"2026-01-09T03:12:09.893Z"}
{"parentUuid":"4608b5ea-7530-4a9b-b192-3d2aa958b61a","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01RRAbKUA4cddXtpgKg5c1SD","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Q5xEDTwVv5AcjQdWRbwu25","name":"Edit","input":{"replace_all":false,"file_path":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","old_string":"==== Parallel Track 1: Infrastructure & Configuration\n\nCan start immediately and run in parallel:\n\n* WP-CS-003 (Event Bus Infrastructure)\n* WP-CS-007 (Salesforce Configuration)","new_string":"==== Parallel Track 1: Infrastructure & Configuration\n\nCan start immediately and run in parallel:\n\n* <<wp-cs-003,WP-CS-003>> (Event Bus Infrastructure)\n* <<wp-cs-007,WP-CS-007>> (Salesforce Configuration)"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":1049,"cache_read_input_tokens":44364,"cache_creation":{"ephemeral_5m_input_tokens":1049,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWw5B9pAazJea3P8PrvAo","type":"assistant","uuid":"91b42589-450d-4893-bbbb-eff3cd9b64f2","timestamp":"2026-01-09T03:12:11.799Z"}
{"parentUuid":"91b42589-450d-4893-bbbb-eff3cd9b64f2","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01RRAbKUA4cddXtpgKg5c1SD","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_011cj8xwDKTVPJuQC1p12R5z","name":"Edit","input":{"replace_all":false,"file_path":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","old_string":"==== Parallel Track 2: Development\n\nCan start after Track 1 infrastructure decisions made:\n\n* WP-CS-001 (ProfileService Development) - Independent\n* WP-CS-002 (EngagementService Development) - Requires WP-CS-003 completed\n* WP-CS-004 (Contact Migration Tooling) - Requires WP-CS-001 completed (reuses code)","new_string":"==== Parallel Track 2: Development\n\nCan start after Track 1 infrastructure decisions made:\n\n* <<wp-cs-001,WP-CS-001>> (ProfileService Development) - Independent\n* <<wp-cs-002,WP-CS-002>> (EngagementService Development) - Requires <<wp-cs-003,WP-CS-003>> completed\n* <<wp-cs-004,WP-CS-004>> (Contact Migration Tooling) - Requires <<wp-cs-001,WP-CS-001>> completed (reuses code)"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":1049,"cache_read_input_tokens":44364,"cache_creation":{"ephemeral_5m_input_tokens":1049,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWw5B9pAazJea3P8PrvAo","type":"assistant","uuid":"222ef4ca-b08b-4f7e-983d-18afb00a37ac","timestamp":"2026-01-09T03:12:14.485Z"}
{"parentUuid":"222ef4ca-b08b-4f7e-983d-18afb00a37ac","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01RRAbKUA4cddXtpgKg5c1SD","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01MvcqFPRxA2QzcuCckK4U15","name":"Edit","input":{"replace_all":false,"file_path":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","old_string":"==== Sequential Track 3: Integration & Testing\n\nMust complete after development:\n\n* WP-CS-005 (Mobile App Integration) - Requires WP-CS-001, WP-CS-002\n* WP-CS-006 (Integration Testing) - Requires WP-CS-001, WP-CS-002, WP-CS-003, WP-CS-005, WP-CS-007","new_string":"==== Sequential Track 3: Integration & Testing\n\nMust complete after development:\n\n* <<wp-cs-005,WP-CS-005>> (Mobile App Integration) - Requires <<wp-cs-001,WP-CS-001>>, <<wp-cs-002,WP-CS-002>>\n* <<wp-cs-006,WP-CS-006>> (Integration Testing) - Requires <<wp-cs-001,WP-CS-001>>, <<wp-cs-002,WP-CS-002>>, <<wp-cs-003,WP-CS-003>>, <<wp-cs-005,WP-CS-005>>, <<wp-cs-007,WP-CS-007>>"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":1049,"cache_read_input_tokens":44364,"cache_creation":{"ephemeral_5m_input_tokens":1049,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWw5B9pAazJea3P8PrvAo","type":"assistant","uuid":"c6e5a8a7-1404-4c9c-8e93-dfb56a463a5c","timestamp":"2026-01-09T03:12:17.213Z"}
{"parentUuid":"c6e5a8a7-1404-4c9c-8e93-dfb56a463a5c","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01RRAbKUA4cddXtpgKg5c1SD","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01YPJTxXAx61TQ54TeQARNcj","name":"Edit","input":{"replace_all":false,"file_path":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","old_string":"==== Sequential Track 4: Migration & Cutover\n\nMust complete sequentially:\n\n* WP-CS-008 (Contact Data Migration) - Requires WP-CS-001, WP-CS-004, WP-CS-006 UAT sign-off\n* WP-CS-009 (Production Deployment) - Requires all prior work packages completed\n* WP-CS-010 (Post-Cutover Support) - Requires WP-CS-009","new_string":"==== Sequential Track 4: Migration & Cutover\n\nMust complete sequentially:\n\n* <<wp-cs-008,WP-CS-008>> (Contact Data Migration) - Requires <<wp-cs-001,WP-CS-001>>, <<wp-cs-004,WP-CS-004>>, <<wp-cs-006,WP-CS-006>> UAT sign-off\n* <<wp-cs-009,WP-CS-009>> (Production Deployment) - Requires all prior work packages completed\n* <<wp-cs-010,WP-CS-010>> (Post-Cutover Support) - Requires <<wp-cs-009,WP-CS-009>>"}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":1049,"cache_read_input_tokens":44364,"cache_creation":{"ephemeral_5m_input_tokens":1049,"ephemeral_1h_input_tokens":0},"output_tokens":1398,"service_tier":"standard"}},"requestId":"req_011CWw5B9pAazJea3P8PrvAo","type":"assistant","uuid":"41fd2be5-eef1-4292-8aa4-b47711f9b321","timestamp":"2026-01-09T03:12:20.129Z"}
{"parentUuid":"91b42589-450d-4893-bbbb-eff3cd9b64f2","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Q5xEDTwVv5AcjQdWRbwu25","type":"tool_result","content":"The file /mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n  2193→* Lessons learned document published\n  2194→\n  2195→=== Work Package Sequencing\n  2196→\n  2197→==== Parallel Track 1: Infrastructure & Configuration\n  2198→\n  2199→Can start immediately and run in parallel:\n  2200→\n  2201→* <<wp-cs-003,WP-CS-003>> (Event Bus Infrastructure)\n  2202→* <<wp-cs-007,WP-CS-007>> (Salesforce Configuration)\n  2203→\n  2204→==== Parallel Track 2: Development\n  2205→\n  2206→Can start after Track 1 infrastructure decisions made:"}]},"uuid":"fdc88b45-a33f-444e-a71e-bb38d4bc1156","timestamp":"2026-01-09T03:12:20.363Z","toolUseResult":{"filePath":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","oldString":"==== Parallel Track 1: Infrastructure & Configuration\n\nCan start immediately and run in parallel:\n\n* WP-CS-003 (Event Bus Infrastructure)\n* WP-CS-007 (Salesforce Configuration)","newString":"==== Parallel Track 1: Infrastructure & Configuration\n\nCan start immediately and run in parallel:\n\n* <<wp-cs-003,WP-CS-003>> (Event Bus Infrastructure)\n* <<wp-cs-007,WP-CS-007>> (Salesforce Configuration)","originalFile":"= Salesforce Customer Support - Solution Architecture\n:project-name: Salesforce Customer Support\n:togaf-adm-phase: Phase E: Opportunities & Solutions\n:last-updated: 2026-01-07\n:document-type: Solution Architecture Document\n:status: Discovery\n:version: 0.1\n:domain: Customer Support & Engagement\n:programme-lead:\n:domain-architect: O.Young@otr.com.au\n:architecture-definition: xref:architecture-definitions:salesforce_customer_support.adoc[Architecture Definitions/Salesforce Customer Support]\n:doctype: article\n:toc: left\n:toclevels: 4\n:sectanchors:\n:sectlinks:\n:sectnums:\n:icons: font\n:source-highlighter: highlightjs\n:experimental:\n:description:\n:keywords:\n\n<<<\n== Purpose and Scope\n\n=== Purpose\n\nThis Solution Architecture defines how the Salesforce Customer Support consolidation will be implemented - the specific technology products, configurations, interfaces, and deployment architecture that realise the xref:architecture-definitions:salesforce_customer_support.adoc[Salesforce Customer Support Architecture Definition].\n\nThis solution establishes the **first implementation of OTR's target Domain-Driven Design (DDD) architecture** by deploying two new bounded contexts (`ProfileService` and `EngagementService`) as microservices, consolidating customer support onto Salesforce Service Cloud, and implementing event-driven integration patterns that will serve as the foundation for future bounded contexts (including Flybuys integration).\n\n=== Vision\n\n> Unify customer support across all OTRG channels by consolidating OTR digital customer feedback onto Salesforce Service Cloud, establishing the foundational DDD architecture with ProfileService and EngagementService bounded contexts that protect digital channels from external system changes while enabling support agents to deliver exceptional customer experiences with complete interaction history.\n\n=== Architectural Approach\n\nThis architecture establishes OTR's **first bounded context implementation** using Domain-Driven Design strategic patterns:\n\n* *link:../bounded_context/profile.adoc[ProfileService]* (NEW bounded context): Just-In-Time Contact reconciliation with Salesforce, upsert by email, returns Salesforce Contact ID to digital channels - foundation for future Flybuys partner linking\n* *link:../bounded_context/engagement.adoc[EngagementService]* (NEW bounded context): Customer feedback submission facade, Anti-Corruption Layer for Salesforce Case creation, Braze integration for all outbound customer communications (push, email, SMS), async Case processing via Event Bus\n* *Event-driven integration* (NEW pattern): Domain event publishing using existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis) - first implementation establishing pattern for future bounded contexts\n* *Anti-Corruption Layer*: EngagementService isolates digital channels from Salesforce API changes, translates between OTR domain language and Salesforce Service Cloud API\n* *Conformist Pattern*: ProfileService and EngagementService conform to existing Salesforce configuration (shared Viva Energy instance, multi-tenant governance)\n* *Big bang cutover*: Single deployment after Contact migration, no phased rollout, D365 CE retirement post-cutover\n\n=== Scope\n\n==== In Scope\n\n* Solution Building Blocks (SBBs) - specific technology products and versions\n* Interface specifications (APIs, events, data formats)\n* Data architecture and schema specifications\n* Deployment architecture and infrastructure configuration\n* Transition architecture with migration phases\n* Technical validation criteria and testing approach\n* External system integration specifications\n* Physical data models and API schemas\n\n==== Out of Scope\n\n===== Covered in xref:architecture-definitions:salesforce_customer_support.adoc[Architecture Definition]\n\n* Business requirements and stakeholder analysis\n* Architecture decisions and rationale (ADRs)\n* Bounded context definitions and responsibilities\n* High-level integration patterns (ACL, Conformist, OHS+PL)\n* Business capability mapping and value streams\n* Architecture principles and governance\n\n===== Covered in Other Documents\n\n* Detailed design (class diagrams, sequence diagrams for all flows)\n* Implementation code and unit tests\n* Business case and return-on-investment analysis\n* Operational run books and support procedures\n\n<<<\n=== Architecture Overview\n\n[mermaid]\n----\n---\nconfig:\n  layout: elk\n---\nflowchart TB\n    Customer([\"Customer\"]) -- Uses --> MobileApp[\"Mobile App<br>iOS/Android\"]\n    Customer -- Shops at --> POS[\"OTR/OTR+ POS<br>D365 Commerce\"]\n    MobileApp -- Authenticate --> EntraID[\"Microsoft Entra\"]\n    MobileApp -- Identifies & Reconciles --> ProfileService[\"ProfileService\"]\n    ProfileService <-- Reconcile App User as Salesforce Contact --> Salesforce[\"Salesforce\"]\n    ProfileService -- On Create --> EventBus[\"EventBus\"]\n    EventBus -- Emits CreateUser Event --> LoyaltyService[\"LoyaltyService\"] & EngagementService[\"EngagementService\"]\n    LoyaltyService -- Reconcile Wallet --> EagleEye[\"EagleEye\"]\n    EngagementService -- Reconcile Braze Profile --> Braze[\"Braze\"]\n    EngagementService --> Salesforce\n    D365CE[\"D365CE\"] -- Data Migration --> Salesforce\n    MobileApp -- Submits Feedback --> EngagementService\n\n    Customer:::customer\n    MobileApp:::presentation\n    POS:::presentation\n    EntraID:::external\n    ProfileService:::newService\n    Salesforce:::external\n    EventBus:::infrastructure\n    LoyaltyService:::newService\n    EngagementService:::newService\n    EagleEye:::external\n    Braze:::external\n    D365CE:::external\n    classDef newService fill:#4CAF50,stroke:#2E7D32,stroke-width:3px,color:#fff\n    classDef external fill:#FF9800,stroke:#E65100,stroke-width:2px,color:#fff\n    classDef infrastructure fill:#2196F3,stroke:#0D47A1,stroke-width:2px,color:#fff\n    classDef presentation fill:#9C27B0,stroke:#4A148C,stroke-width:2px,color:#fff\n    classDef customer fill:#607D8B,stroke:#263238,stroke-width:2px,color:#fff\n----\n\n\n==== Key Architectural Patterns\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Pattern |Application |Rationale\n\n|*Anti-Corruption Layer (ACL)*\n|EngagementService → Salesforce Service Cloud\n|Protects digital channels (Mobile App, Web) from Salesforce API changes, translates between OTR domain language and Salesforce Case/Contact model, enables independent evolution of internal domain model\n\n|*Conformist*\n|ProfileService → Salesforce, EngagementService → Salesforce\n|Shared Viva Energy Salesforce instance - we conform to existing configuration, governance, and API contracts (external system we don't control)\n\n|*Backend-for-Frontend (BFF)*\n|EngagementService\n|Aggregates customer feedback submission, Contact lookup, async Case creation, and Braze notification orchestration for digital channel clients\n\n|*Event-Driven Architecture (OHS+PL)*\n|Event Bus (SNS+SQS/EventBridge/Kinesis)\n|Loose coupling between bounded contexts, async domain event publishing (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`), foundation for future bounded contexts\n\n|*Just-In-Time (JIT) Integration*\n|ProfileService → Salesforce Contact reconciliation\n|Reconcile app users as Salesforce Contacts on-demand (upsert by email), no pre-sync required, ensures Salesforce has current Contact data\n\n|*Async Processing*\n|EngagementService Case creation via Event Bus\n|Non-blocking user experience, resilience to Salesforce downtime, automatic retry with exponential backoff, dead letter queue for operations team intervention\n\n|*Strangler Fig*\n|Not applicable\n|Big bang cutover (no gradual migration) - D365 CE fully replaced, not incrementally strangled\n\n|===\n\n<<<\n== Solution Approach\n\n* Deploy xref:bounded-contexts:profile.adoc[ProfileService] and xref:bounded-contexts:engagement.adoc[EngagementService] as bounded context microservices\n* Implement Anti-Corruption Layers (ACLs) for Salesforce and Braze integration\n* Establish event-driven architecture as the foundational integration pattern\n* Big bang cutover (TS-1 → TS-4)\n\n=== Related Documentation\n\nThis solution architecture references detailed technical specifications:\n\n==== Architecture Definition\n\n* xref:architecture-definitions:salesforce_customer_support.adoc[Salesforce Customer Support - Architecture Definition] - Business requirements, architecture decisions (ADRs), bounded context definitions, high-level integration patterns\n\n==== Bounded Context Specifications\n\n* xref:bounded-contexts:profile.adoc[ProfileService Bounded Context] - JIT Contact reconciliation, aggregate definitions\n* xref:bounded-contexts:engagement.adoc[EngagementService Bounded Context] - Customer feedback facade, Anti-Corruption Layer\n\n==== Interface Specifications\n\nDetailed API specifications available in the specifications directory:\n\n* link:../../specifications/rest/profile-service-v1.yaml[ProfileService REST API v1] - OpenAPI 3.0 specification for `/profile/v1` endpoints (includes Salesforce Contact reconciliation `GET /contact-id`)\n* link:../../specifications/rest/engagement-service-v1.yaml[EngagementService REST API v1] - OpenAPI 3.0 specification for `/engagement/v1` endpoints (includes `POST /feedback`)\n* link:../../specifications/events/engagement-events.json[Engagement Domain Events] - CloudEvents 1.0 JSON Schema for `SupportCaseCreated`, `SupportCaseUpdated`, `SupportCaseResolved`, `CustomerFeedbackSubmitted`\n\n==== External System Documentation\n\n* https://developer.salesforce.com/docs/atlas.en-us.api_rest.meta/api_rest/[Salesforce REST API Documentation] - Contact and Case object APIs\n* https://www.braze.com/docs/api/endpoints/messaging/send_messages/post_send_triggered_campaigns/[Braze Campaign Trigger API] - Push notification campaigns\n\n<<<\n== Executive Summary\n\n=== Challenge\n\nOTR digital customers (Mobile App, Web) currently submit feedback and support requests to D365 Customer Engagement, while Viva Energy's broader business units (fuel wholesale, Shell Card customers, other retail channels) use Salesforce Service Cloud. This creates:\n\n* *Fragmented customer support platform*: Customer support data split across two systems, preventing support agents from having a unified view of customer interactions across all channels\n* *Operational inefficiency*: Maintaining two separate customer support platforms increases operational overhead and costs\n* *Poor support experience*: D365 CE is not working well for digital customer support, impacting customer satisfaction and case resolution times\n* *Post-merger consolidation opportunity*: Following Viva Energy's acquisition of OTR, strategic alignment on Salesforce as the enterprise customer support platform\n\n=== Solution\n\nThis architecture establishes the **foundational Domain-Driven Design (DDD) implementation** for OTR's target state architecture by introducing two new bounded contexts (link:../bounded_context/profile.adoc[ProfileService], link:../bounded_context/engagement.adoc[EngagementService]) and event-driven integration patterns:\n\n==== New Bounded Contexts\n\n* *link:../bounded_context/profile.adoc[ProfileService]* (NEW): Just-In-Time (JIT) Contact reconciliation with Salesforce, upsert by email, returns Salesforce Contact ID to Mobile App\n* *link:../bounded_context/engagement.adoc[EngagementService]* (NEW): Customer feedback submission, Anti-Corruption Layer (ACL) for Salesforce Case creation, Braze integration for all outbound customer communications (push, email, SMS), async Case processing via Event Bus\n* *Event Bus* (NEW pattern): Domain event publishing using existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis) - first implementation of event-driven architecture pattern\n\n==== Integration Architecture\n\n* *Salesforce = System of Record*: Salesforce Service Cloud (shared Viva Energy instance) owns Contact and Case data\n* *Conformist Pattern*: ProfileService and EngagementService conform to existing Salesforce configuration and API contracts\n* *Anti-Corruption Layer*: EngagementService protects digital channels from Salesforce API changes, translates between OTR domain language and Salesforce\n* *Async Case Creation*: Non-blocking user experience, resilience to Salesforce downtime, automatic retry with exponential backoff, dead letter queue for failed Cases\n* *Event-Driven Notifications*: Salesforce webhook → EngagementService → Braze for all customer communications (push, email, SMS) on Case status updates\n\n==== Migration Approach\n\n* *Contact Migration*: One-time migration from app-specific database → Salesforce (upsert with flexible matching by email/phone/VCI)\n* *No Case Migration*: Historical D365 CE Cases not migrated (fresh start in Salesforce)\n* *Big Bang Cutover*: Single deployment, no phased rollout or parallel run\n* *D365 CE Retirement*: Complete decommissioning of D365 Customer Engagement post-cutover\n\n=== Key Architectural Significance\n\nThis migration establishes the first implementation of OTR's target DDD architecture:\n\n* First bounded contexts implemented (ProfileService, EngagementService)\n* First event-driven domain event pattern (foundation for future bounded contexts)\n* Foundation for Flybuys integration (ProfileService Contact reconciliation reused)\n* Establishes integration patterns (Conformist, ACL, Event-Driven) for future services\n\n=== Success Criteria\n\n* All digital customer feedback routed to Salesforce Service Cloud within 30 days of launch\n* Support agents have unified customer view across all Viva Energy channels (digital, wholesale, Shell Card, other retail)\n* D365 Customer Engagement decommissioned within 90 days post-cutover\n* Customer satisfaction score improves by 15% within 6 months\n* Average case resolution time decreases by 20% within 6 months\n* Zero data loss during Contact migration (100% validation pass rate)\n* Mobile App feedback submission success rate > 99.5% (including async Case creation)\n\n=== Technical Constraints\n\n* Shared Salesforce instance (Viva Energy multi-tenant environment)\n* Conform to existing Salesforce configuration and governance (data isolation strategy TBD with Salesforce admin team)\n* Contact migration must complete before cutover (no parallel run)\n* Async Case creation mandatory (non-blocking user experience)\n* Expected volume: 100-150 feedback submissions/day from 20k DAU (~0.5-0.75% submission rate), architecture capacity planned for 3x-10x growth\n\n=== Open Technical Decisions (TBD)\n\n* Salesforce Case field mapping for digital feedback categories (App, Service, Order, Rewards, Refund, Delete Account)\n* Salesforce data isolation strategy (Record Types, custom fields, queues)\n* Salesforce REST API authentication method (OAuth 2.0, Connected App, JWT bearer flow)\n* Salesforce webhook mechanism for Case updates (Outbound Messages, Platform Events, Process Builder)\n* Retry policy configuration (attempts, backoff intervals)\n* Salesforce API rate limit strategy (expected volume: 100-150 submissions/day from 20k DAU, capacity planning for 3x-10x growth)\n\n== Technical Requirements\n\n[width=\"100%\",cols=\"8%,92%\",options=\"header\",]\n|===\n|ID |Description\n\n|TR-CS-001\n|Every Mobile App user must have a Salesforce Contact record in Salesforce Service Cloud (shared Viva Energy instance)\n\n|TR-CS-002\n|ProfileService must reconcile Mobile App users as Salesforce Contacts using Just-In-Time (JIT) upsert by email address\n\n|TR-CS-003\n|ProfileService must return Salesforce Contact ID to Mobile App for feedback submission\n\n|TR-CS-004\n|Mobile App must support customer feedback submission with fields: Category (App, Service, Order, Rewards, Refund, Delete Account), Store Name, Time of Visit, Contact Phone Number, Free Text Message\n\n|TR-CS-005\n|EngagementService must create Salesforce Cases asynchronously via Event Bus (non-blocking user experience)\n\n|TR-CS-006\n|EngagementService must acknowledge feedback submission immediately to Mobile App user (\"Feedback submitted\" confirmation)\n\n|TR-CS-007\n|EngagementService must send push notification to customer via Braze when Case is successfully created in Salesforce\n\n|TR-CS-008\n|EngagementService must retry failed Case creation with configurable exponential backoff and dead letter queue for operations team intervention\n\n|TR-CS-009\n|Salesforce must be the System of Record for Contact and Case data (no local persistence in ProfileService or EngagementService)\n\n|TR-CS-010\n|Contact migration from app-specific database to Salesforce must complete before Mobile App cutover (upsert with flexible matching by email/phone/VCI)\n\n|TR-CS-011\n|No Case migration from D365 Customer Engagement to Salesforce (fresh start, historical Cases not migrated)\n\n|TR-CS-012\n|EngagementService must publish domain events (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`) to Event Bus for consumption by other bounded contexts\n\n|TR-CS-013\n|EngagementService must receive Salesforce webhook notifications when Cases are updated/resolved by support agents\n\n|TR-CS-014\n|EngagementService must trigger Braze push notifications to customers when Cases are updated/resolved (via Salesforce webhook → EngagementService → Braze)\n\n|TR-CS-015\n|ProfileService and EngagementService must conform to existing Salesforce configuration and API contracts (Conformist pattern)\n\n|TR-CS-016\n|All changes must be communicated using event-driven architecture via Event Bus (using existing AWS infrastructure: SNS+SQS/EventBridge/Kinesis)\n\n|TR-CS-017\n|Mobile App feedback submission success rate must exceed 99.5% (including async Case creation completion)\n\n|TR-CS-018\n|Contact migration must achieve 100% validation pass rate (zero data loss)\n\n|TR-CS-019\n|D365 Customer Engagement must be fully decommissioned within 90 days post-cutover\n\n|===\n\n== Technical Architecture\n\n=== Technical Capability Requirements\n\n==== Requirements Traceability\n\n[width=\"100%\",cols=\"15%,50%,35%\",options=\"header\",]\n|===\n|Requirement ID |Requirement Summary |Architectural Building Blocks\n\n|TR-CS-001\n|Every Mobile App user must have Salesforce Contact record\n|ABB-CS-001 (ProfileService), ABB-CS-004 (Salesforce), ABB-CS-007 (Contact Migration Tool)\n\n|TR-CS-002\n|ProfileService JIT Contact reconciliation via upsert by email\n|ABB-CS-001 (ProfileService), ABB-CS-004 (Salesforce)\n\n|TR-CS-003\n|ProfileService returns Salesforce Contact ID to Mobile App\n|ABB-CS-001 (ProfileService), ABB-CS-006 (Mobile App)\n\n|TR-CS-004\n|Mobile App supports feedback submission with structured fields\n|ABB-CS-006 (Mobile App), ABB-CS-002 (EngagementService)\n\n|TR-CS-005\n|EngagementService creates Salesforce Cases asynchronously\n|ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus), ABB-CS-004 (Salesforce)\n\n|TR-CS-006\n|EngagementService immediate acknowledgment to Mobile App\n|ABB-CS-002 (EngagementService), ABB-CS-006 (Mobile App)\n\n|TR-CS-007\n|EngagementService sends push notification via Braze on Case creation\n|ABB-CS-002 (EngagementService), ABB-CS-005 (Braze)\n\n|TR-CS-008\n|EngagementService retry logic with exponential backoff and DLQ\n|ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus)\n\n|TR-CS-009\n|Salesforce is System of Record for Contact and Case data\n|ABB-CS-004 (Salesforce), ABB-CS-001 (ProfileService - stateless), ABB-CS-002 (EngagementService - stateless)\n\n|TR-CS-010\n|Contact migration before Mobile App cutover\n|ABB-CS-007 (Contact Migration Tool), ABB-CS-004 (Salesforce)\n\n|TR-CS-011\n|No Case migration from D365 CE (fresh start)\n|ABB-CS-004 (Salesforce) - no migration tooling required\n\n|TR-CS-012\n|EngagementService publishes domain events to Event Bus\n|ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus)\n\n|TR-CS-013\n|EngagementService receives Salesforce webhook notifications\n|ABB-CS-002 (EngagementService), ABB-CS-004 (Salesforce)\n\n|TR-CS-014\n|EngagementService triggers Braze notifications on Case updates\n|ABB-CS-002 (EngagementService), ABB-CS-004 (Salesforce), ABB-CS-005 (Braze)\n\n|TR-CS-015\n|ProfileService and EngagementService conform to Salesforce config\n|ABB-CS-001 (ProfileService), ABB-CS-002 (EngagementService), ABB-CS-004 (Salesforce)\n\n|TR-CS-016\n|Event-driven architecture via Event Bus\n|ABB-CS-003 (Event Bus), ABB-CS-002 (EngagementService)\n\n|TR-CS-017\n|Mobile App feedback submission success rate > 99.5%\n|ABB-CS-006 (Mobile App), ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus), ABB-CS-004 (Salesforce)\n\n|TR-CS-018\n|Contact migration 100% validation pass rate\n|ABB-CS-007 (Contact Migration Tool), ABB-CS-004 (Salesforce)\n\n|TR-CS-019\n|D365 CE decommissioned within 90 days post-cutover\n|All ABBs (replacement system operational)\n\n|===\n\n=== Service Catalogues\n\n==== Application Portfolio Catalogue\n\n[width=\"100%\",cols=\"20%,15%,15%,15%,35%\",options=\"header\",]\n|===\n|Application |Lifecycle State |Owner |Hosting Platform |Description\n\n|*ProfileService*\n|NEW\n|OTR Platform Team\n|AWS (TBD: Lambda/ECS/EKS)\n|JIT Contact reconciliation with Salesforce, returns Salesforce Contact ID, foundation for Flybuys integration\n\n|*EngagementService*\n|NEW\n|OTR Platform Team\n|AWS (TBD: Lambda/ECS/EKS)\n|Customer feedback submission facade, ACL for Salesforce Case creation, Braze integration for all outbound communications (push, email, SMS), webhook receiver\n\n|*Mobile App (iOS)*\n|ACTIVE (UPDATE)\n|OTR Mobile Team\n|Apple App Store\n|iOS native app with feedback form, integrate with ProfileService and EngagementService APIs\n\n|*Mobile App (Android)*\n|ACTIVE (UPDATE)\n|OTR Mobile Team\n|Google Play Store\n|Android native app with feedback form, integrate with ProfileService and EngagementService APIs\n\n|*Salesforce Service Cloud*\n|ACTIVE (EXPAND)\n|Viva Energy Salesforce Admin Team\n|Salesforce (SaaS)\n|Shared Viva Energy instance, System of Record for Contact and Case data, adding OTR digital customer support\n\n|*Braze*\n|ACTIVE (EXTEND)\n|OTR Marketing Team\n|Braze (SaaS)\n|Marketing automation platform, EngagementService triggers push notifications for Case updates\n\n|*D365 Customer Engagement*\n|RETIRE\n|OTR Support Team\n|Microsoft Azure (SaaS)\n|Legacy customer support platform, decommissioned within 90 days post-cutover\n\n|*App-Specific Customer Database*\n|RETIRE\n|OTR Platform Team\n|AWS (RDS/DynamoDB)\n|Legacy customer contact storage, one-time migration to Salesforce, then deprecated\n\n|*Event Bus*\n|NEW\n|OTR Platform Team\n|AWS (SNS+SQS/EventBridge/Kinesis)\n|Domain event publishing infrastructure for bounded context integration\n\n|*Contact Migration Tool*\n|TEMPORARY\n|OTR Platform Team\n|AWS (Script/Lambda)\n|One-time migration app database → Salesforce with upsert logic, retired after migration complete\n\n|===\n\n==== Technology Capability Requirements\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Technology Capability |Implementation Technology (TBD in detailed design) |Requirements\n\n|*Microservice Hosting*\n|AWS Lambda / ECS / EKS\n|Host ProfileService and EngagementService with auto-scaling, high availability, monitoring\n\n|*API Gateway*\n|AWS API Gateway / Application Load Balancer\n|REST API routing, authentication, rate limiting, request validation for ProfileService and EngagementService\n\n|*Event Bus*\n|AWS SNS+SQS / EventBridge / Kinesis\n|Domain event publishing, async message processing, retry logic, dead letter queue\n\n|*Salesforce Integration*\n|Salesforce REST API / SOAP API\n|Contact CRUD operations, Case creation, webhook notifications, OAuth 2.0 authentication\n\n|*Braze Integration*\n|Braze REST API / SDK\n|Push notification campaign triggers, customer profile reconciliation\n\n|*Authentication & Authorisation*\n|Microsoft Entra External ID / AWS Cognito\n|Mobile App user authentication, API authorisation, JWT token validation\n\n|*Observability & Monitoring*\n|AWS CloudWatch / Datadog / New Relic\n|Application metrics, logs, traces, dashboards, alerting (feedback submission rate, queue depth, API errors)\n\n|*Secret Management*\n|AWS Secrets Manager / Parameter Store\n|Salesforce credentials, Braze API keys, OAuth tokens, encryption keys\n\n|*Database (Migration Tool)*\n|AWS RDS / DynamoDB (read-only access)\n|Contact migration from app-specific database\n\n|*CI/CD Pipeline*\n|GitHub Actions / AWS CodePipeline\n|Automated build, test, deployment for ProfileService, EngagementService, Mobile App\n\n|*Infrastructure as Code*\n|Terraform / AWS CloudFormation / CDK\n|Declarative infrastructure provisioning for Event Bus, microservices, monitoring\n\n|*API Documentation*\n|OpenAPI / Swagger\n|ProfileService and EngagementService API specifications for Mobile App integration\n\n|===\n\n==== Feature Flag Register\n\n*Note*: Per ADR-CS-006 (big bang cutover, not phased rollout), feature flags are minimal and used primarily for emergency rollback/kill switches.\n\n[width=\"100%\",cols=\"20%,15%,35%,30%\",options=\"header\",]\n|===\n|Feature Flag |Default State |Purpose |Rollback Scenario\n\n|*enable_salesforce_feedback_submission*\n|OFF (pre-cutover), ON (post-cutover)\n|Enable/disable feedback submission to EngagementService → Salesforce (kill switch for emergency rollback to D365 CE)\n|Feedback submission success rate < 95%, Salesforce API failures, critical bugs - revert to D365 CE integration\n\n|*enable_async_case_creation*\n|ON\n|Enable/disable async Case creation via Event Bus (fallback to synchronous processing if Event Bus issues)\n|Event Bus infrastructure failures, queue backlog unmanageable - temporary synchronous processing\n\n|*enable_braze_notifications*\n|ON\n|Enable/disable Braze push notifications for Case updates (degrade gracefully if Braze integration fails)\n|Braze API failures, notification delivery rate < 80% - disable notifications temporarily\n\n|*enable_jit_contact_reconciliation*\n|ON\n|Enable/disable ProfileService JIT Contact reconciliation (fallback to cached Contact IDs if Salesforce unavailable)\n|Salesforce API downtime, Contact reconciliation failures > 5% - use cached Contact IDs temporarily\n\n|*enable_salesforce_webhook_processing*\n|ON\n|Enable/disable Salesforce webhook processing for Case updates (fallback to polling if webhook failures)\n|Webhook delivery failures, authentication issues - temporary polling fallback\n\n|===\n\n*Feature Flag Management*:\n\n* Feature flags managed via AWS AppConfig / LaunchDarkly / custom feature flag service (TBD in detailed design)\n* Mobile App feature flags controlled server-side (no app release required for flag changes)\n* Backend service feature flags configured via environment variables / configuration service\n* Feature flag changes logged and audited (who changed, when, reason)\n* Post-cutover monitoring: Gradual removal of feature flags once system stability confirmed (30-60 days)\n\n==== Data Entity Catalogue\n\n[width=\"100%\",cols=\"20%,15%,35%,30%\",options=\"header\",]\n|===\n|Data Entity |System of Record |Key Attributes |Lifecycle\n\n|*Contact*\n|Salesforce Service Cloud\n|• Contact ID (Salesforce 15/18-char ID) +\n• Email (primary matching key) +\n• First Name, Last Name +\n• Phone Number +\n• Viva Consumer ID (VCI) +\n• Account (Viva Energy customer account) +\n• Record Type (OTR Digital vs other channels)\n|Created: ProfileService JIT reconciliation or Contact Migration Tool +\nUpdated: ProfileService JIT upsert (email changes), Salesforce (manual updates by support agents) +\nDeleted: Salesforce retention policy (GDPR/compliance)\n\n|*Case*\n|Salesforce Service Cloud\n|• Case Number (Salesforce auto-generated) +\n• Contact ID (reference to Contact) +\n• Subject (derived from Category) +\n• Description (Free Text Message) +\n• Category (App, Service, Order, Rewards, Refund, Delete Account) +\n• Store Name (OTR location) +\n• Time of Visit +\n• Status (New, In Progress, Resolved, Closed) +\n• Priority, Origin (Mobile App) +\n• Owner (support agent/queue)\n|Created: EngagementService async Case creation +\nUpdated: Support agents (Salesforce UI), EngagementService (webhook processing) +\nDeleted: Salesforce retention policy (archive after X years)\n\n|*Feedback Submission (transient)*\n|None (not persisted)\n|• Salesforce Contact ID +\n• Category +\n• Store Name +\n• Time of Visit +\n• Contact Phone Number +\n• Free Text Message\n|Created: Mobile App user submission +\nProcessed: EngagementService publishes to Event Bus, Case created in Salesforce +\nNot persisted in ProfileService/EngagementService (stateless)\n\n|*Domain Events*\n|Event Bus (ephemeral)\n|**SupportCaseCreated**: +\n• Case Number, Contact ID, Category, Timestamp +\n**SupportCaseUpdated**: +\n• Case Number, Status, Updated By, Timestamp +\n**SupportCaseResolved**: +\n• Case Number, Resolution, Resolved By, Timestamp +\n**CustomerFeedbackSubmitted**: +\n• Contact ID, Category, Timestamp\n|Published: EngagementService +\nConsumed: Other bounded contexts (future), Braze notification triggers +\nRetention: Short-lived (minutes to hours), not persisted for event sourcing\n\n|*Braze Customer Profile*\n|Braze\n|• External User ID (VCI or Email) +\n• Push Notification Tokens (iOS/Android) +\n• Notification Preferences +\n• Campaign Engagement History\n|Created/Updated: EngagementService on Case creation/update +\nManaged: Braze (external SaaS)\n\n|===\n\n*Data Migration Entities*:\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Source Entity |Target Entity |Migration Strategy\n\n|*App Database Contact*\n|Salesforce Contact\n|One-time migration via Contact Migration Tool: +\n• Upsert by email (primary), phone (secondary), VCI (tertiary) +\n• Map: Email → Email, Name → First/Last Name, Phone → Phone, VCI → External ID +\n• Validation: 100% data integrity check, reconciliation report\n\n|*D365 CE Case*\n|Not migrated\n|ADR-CS-005: No Case migration (fresh start in Salesforce) +\nD365 CE Cases archived separately for compliance if needed\n\n|===\n\n==== Data Quality & Validation\n\n*Contact Migration Validation Rules*:\n\n* Email format validation (RFC 5322 compliance)\n* Phone number format validation (E.164 international format)\n* VCI format validation (alphanumeric, length constraints)\n* Duplicate detection: Flag potential duplicates for manual review (same email/phone combination)\n* Mandatory fields: Email (required), First Name, Last Name (required for Salesforce Contact)\n\n*Case Creation Validation Rules*:\n\n* Contact ID must exist in Salesforce (validated by EngagementService before Case creation)\n* Category must be one of: App, Service, Order, Rewards, Refund, Delete Account\n* Free Text Message maximum length: 32,000 characters (Salesforce Case Description limit)\n* Store Name validated against OTR location master data (optional - warn if not found)\n\n<<<\n== Solution Building Blocks\n\nThis section defines the specific technology products, configurations, and implementation details for each Solution Building Block (SBB).\n\n=== Technology Portfolio Catalogue\n\n[width=\"100%\",cols=\"10%,20%,25%,25%,20%\",options=\"header\",]\n|===\n|SBB ID |Component |Technology Product |Version/Configuration |Deployment Platform\n\n|SBB-CS-001\n|ProfileService Microservice\n|.NET 8 / Node.js 20 LTS\n|RESTful API, containerised\n|AWS ECS Fargate / Lambda\n\n|SBB-CS-002\n|EngagementService Microservice\n|.NET 8 / Node.js 20 LTS\n|RESTful API, containerised, async workers\n|AWS ECS Fargate / Lambda\n\n|SBB-CS-003\n|Event Bus\n|AWS SNS + SQS / EventBridge\n|Standard queues, FIFO for ordering\n|AWS (managed service)\n\n|SBB-CS-004\n|API Gateway\n|AWS API Gateway / ALB\n|REST API, JWT validation\n|AWS (managed service)\n\n|SBB-CS-005\n|Salesforce Integration Layer\n|Salesforce REST API Client\n|OAuth 2.0 JWT bearer flow\n|Embedded in SBB-CS-001/002\n\n|SBB-CS-006\n|Braze Integration Layer\n|Braze REST API SDK\n|API key authentication\n|Embedded in SBB-CS-002\n\n|SBB-CS-007\n|Contact Migration Tool\n|Python 3.11 / .NET 8\n|One-time batch script\n|AWS Lambda / EC2\n\n|SBB-CS-008\n|Application Monitoring\n|AWS CloudWatch / Datadog\n|Metrics, logs, traces, dashboards\n|AWS / SaaS\n\n|SBB-CS-009\n|Secret Management\n|AWS Secrets Manager\n|KMS encryption\n|AWS (managed service)\n\n|SBB-CS-010\n|Mobile App (iOS)\n|SwiftUI, Kotlin Multiplatform\n|iOS 15+\n|Apple App Store\n\n|SBB-CS-011\n|Mobile App (Android)\n|Jetpack Compose, Kotlin Multiplatform\n|Android 8+\n|Google Play Store\n\n|SBB-CS-012\n|Feature Flag Service\n|AWS AppConfig / LaunchDarkly\n|Server-side flags, real-time updates\n|AWS / SaaS\n\n|===\n\n<<<\n== Data Architecture\n\nThis section defines the physical data models, event schemas, and API request/response formats.\n\n=== Domain Event Schemas\n\nAll domain events follow the https://cloudevents.io/[CloudEvents 1.0] specification for consistency and interoperability.\n\n*Event Schema Specifications*: See // TODO: Add to Antora - specifications/events/engagement-events.json[Engagement Service Event Schemas] for complete JSON schemas and examples.\n\n==== Event Catalogue\n\n[width=\"100%\",cols=\"30%,20%,50%\",options=\"header\",]\n|===\n|Event Type |Publisher |Description\n\n|`SupportCaseCreated`\n|EngagementService\n|Published when EngagementService successfully creates a Case in Salesforce after async processing\n\n|`SupportCaseUpdated`\n|EngagementService (via Salesforce webhook)\n|Published when a support agent updates a Case in Salesforce (status, priority, comment changes)\n\n|`SupportCaseResolved`\n|EngagementService (via Salesforce webhook)\n|Published when a support agent resolves/closes a Case in Salesforce\n\n|`CustomerFeedbackSubmitted`\n|EngagementService\n|Published when customer submits feedback via Mobile App (before async Case creation)\n\n|===\n\n*Event Format*: All events use CloudEvents 1.0 envelope with event-specific payload in the `data` field.\n\n*Schema Location*: `specifications/events/engagement-events.json`\n\n=== API Request/Response Schemas\n\n==== ProfileService: GET /profile/contact-id\n\n*Response* (200 OK):\n[source,json]\n----\n{\n  \"contactId\": \"0034X00000ABCDEFG\",\n  \"email\": \"customer@example.com\",\n  \"firstName\": \"John\",\n  \"lastName\": \"Smith\"\n}\n----\n\n==== EngagementService: POST /feedback\n\n*Request*:\n[source,json]\n----\n{\n  \"contactId\": \"0034X00000ABCDEFG\",\n  \"category\": \"App\",\n  \"storeName\": \"OTR Adelaide\",\n  \"timeOfVisit\": \"2026-01-07T12:00:00Z\",\n  \"contactPhoneNumber\": \"+61412345678\",\n  \"message\": \"App crashed when submitting feedback\"\n}\n----\n\n*Response* (202 Accepted):\n[source,json]\n----\n{\n  \"feedbackId\": \"fb-2026-01-07-12345\",\n  \"status\": \"submitted\",\n  \"message\": \"Your feedback has been submitted!\"\n}\n----\n\n=== Salesforce Field Mappings\n\n==== Case Object Mapping\n\n[width=\"100%\",cols=\"25%,25%,25%,25%\",options=\"header\",]\n|===\n|OTR Field |Salesforce Field |Data Type |Notes\n\n|Category\n|Feedback_Category__c\n|Picklist\n|App, Service, Order, Rewards, Refund, Delete Account\n\n|Store Name\n|Store_Name__c\n|String (255)\n|OTR location name\n\n|Time of Visit\n|Time_of_Visit__c\n|DateTime\n|When customer visited store\n\n|Free Text Message\n|Description\n|Long Text (32,000)\n|Customer feedback message\n\n|===\n\n<<<\n=== Baseline Architecture\n\n==== Existing System Components\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Component |Current State |Status\n\n|*D365 Customer Engagement*\n|Customer support platform for OTR digital customers (Mobile App, Web), handles feedback submission and case management\n|**DEPRECATED** - Being replaced by Salesforce Service Cloud\n\n|*App-Specific Customer Database*\n|Stores customer contact data for Mobile App users, separate from Viva Energy systems\n|**MIGRATING** - One-time migration to Salesforce, then deprecated\n\n|*Mobile App*\n|iOS/Android native apps with feedback submission form including Category, Store Name, Time of Visit, Contact Phone Number, and Free Text Message fields\n|**REQUIRES UPDATE** - Integrate with ProfileService and EngagementService APIs (feedback form UI already complete)\n\n|*Salesforce Service Cloud*\n|Shared Viva Energy instance handling customer support for fuel wholesale, Shell Card customers, other retail channels\n|**EXPANDING** - Adding OTR digital customer support Cases and Contacts\n\n|*Existing AWS Infrastructure*\n|SNS+SQS / EventBridge / Kinesis available for event-driven architecture\n|**REUSING** - Event Bus implementation leverages existing infrastructure\n\n|===\n\n==== Integration Architecture\n\n*Current state:*\n\n* Mobile App → D365 Customer Engagement (direct integration)\n* App-specific customer database → standalone (no Salesforce integration)\n* No event-driven architecture (synchronous, tightly coupled)\n* No Anti-Corruption Layer protecting digital channels\n* Viva Energy support teams use Salesforce, OTR digital support uses D365 CE (fragmented)\n\n==== Technical Debt\n\n*No longer relevant* - D365 CE being deprecated, not documenting technical debt of system being retired.\n\n*New technical debt introduced by this migration:*\n\n* Salesforce field mapping TBD (requires coordination with Viva Energy Salesforce admin team)\n* Data isolation strategy TBD (Record Types, custom fields, queues - multi-tenant governance)\n* Salesforce webhook mechanism TBD (Outbound Messages vs Platform Events vs Process Builder)\n* Expected feedback volume unknown (gathering data for rate limit planning)\n\n=== Gap Analysis\n\n==== Missing Capabilities\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Missing Capability |Description\n\n|*ProfileService bounded context*\n|No existing service for Contact reconciliation with Salesforce - requires new microservice implementing JIT upsert by email, returning Salesforce Contact ID\n\n|*EngagementService bounded context*\n|No existing service for customer feedback facade - requires new microservice implementing Anti-Corruption Layer for Salesforce Case creation, Braze integration, async processing via Event Bus\n\n|*Event Bus domain event pattern*\n|No existing domain event publishing infrastructure - requires implementing event-driven architecture pattern using existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis)\n\n|*Async Case creation workflow*\n|Current D365 CE integration is synchronous - requires implementing async processing with retry logic, exponential backoff, dead letter queue\n\n|*Salesforce webhook integration*\n|No existing capability to receive Salesforce notifications - requires implementing webhook receiver in EngagementService for Case update notifications\n\n|*Braze push notification orchestration*\n|No existing integration for Case-related push notifications - requires implementing Braze campaign triggers from EngagementService\n\n|*Contact migration tooling*\n|No existing tooling for app database → Salesforce Contact migration with upsert logic (match by email/phone/VCI)\n\n|*Feedback form enhancements*\n|Mobile App feedback form lacks structured fields (Category, Store Name, Time of Visit, Contact Phone Number) - requires UI updates\n\n|===\n\n==== Missing Bounded Contexts\n\n[width=\"100%\",cols=\"30%,30%,40%\",options=\"header\",]\n|===\n|Bounded Context |Responsibilities |Implementation Status\n\n|*link:../bounded_context/profile.adoc[ProfileService]*\n|JIT Contact reconciliation with Salesforce (upsert by email), return Salesforce Contact ID to digital channels, foundation for future Flybuys partner linking\n|**NEW** - First bounded context implementation\n\n|*link:../bounded_context/engagement.adoc[EngagementService]*\n|Customer feedback submission facade, Anti-Corruption Layer for Salesforce Case creation, Braze integration for push notifications, async Case processing, webhook receiver for Case updates\n|**NEW** - First bounded context implementation\n\n|===\n\n==== Missing Integration Patterns\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Integration Pattern |Description\n\n|*Anti-Corruption Layer (ACL)*\n|EngagementService → Salesforce Service Cloud - protects digital channels from Salesforce API changes, translates between OTR domain language and Salesforce\n\n|*Conformist*\n|ProfileService/EngagementService → Salesforce - conform to existing Salesforce configuration and API contracts (shared Viva Energy instance)\n\n|*Event-Driven Architecture (OHS+PL)*\n|Event Bus publishing domain events (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`) for loose coupling between bounded contexts\n\n|*Just-In-Time (JIT) Integration*\n|ProfileService → Salesforce Contact reconciliation on-demand (no pre-sync)\n\n|*Async Processing*\n|EngagementService Case creation via Event Bus with retry, exponential backoff, dead letter queue\n\n|===\n\n=== Target State Architecture\n\n==== Architectural Building Blocks (ABB)\n\n[width=\"100%\",cols=\"20%,25%,30%,25%\",options=\"header\",]\n|===\n|ABB ID |Bounded Context |Responsibilities |Technology (TBD in Solution Architecture)\n\n|ABB-CS-001\n|*link:../bounded_context/profile.adoc[ProfileService]*\n|JIT Contact reconciliation with Salesforce (upsert by email), return Salesforce Contact ID, foundation for Flybuys partner linking\n|Microservice (.NET/Node.js), REST API, Salesforce REST API client\n\n|ABB-CS-002\n|*link:../bounded_context/engagement.adoc[EngagementService]*\n|Customer feedback submission facade, ACL for Salesforce Case creation, Braze integration, async processing, webhook receiver\n|Microservice (.NET/Node.js), REST API, Event Bus publisher/subscriber, Salesforce webhook receiver\n\n|ABB-CS-003\n|*Event Bus*\n|Domain event publishing infrastructure (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`)\n|AWS SNS+SQS / EventBridge / Kinesis\n\n|ABB-CS-004\n|*Salesforce Service Cloud*\n|System of Record for Contact and Case data (shared Viva Energy instance)\n|Salesforce Service Cloud (external SaaS)\n\n|ABB-CS-005\n|*Braze*\n|Marketing automation platform for push notifications\n|Braze (external SaaS) - existing integration\n\n|ABB-CS-006\n|*Mobile App*\n|iOS/Android native apps with enhanced feedback form (Category, Store Name, Time of Visit, Contact Phone Number, Free Text Message)\n|Kotlin Multiplatform, SwiftUI, Jetpack Compose\n\n|ABB-CS-007\n|*Contact Migration Tool*\n|One-time migration app database → Salesforce with upsert logic (match by email/phone/VCI)\n|Script/tool (.NET/Python/Node.js)\n\n|===\n\n==== Integration Architecture\n\n===== Integration Flows\n\n*Customer Feedback Submission (Async):*\n\n1. *Mobile App* → ProfileService: Authenticate user, get Salesforce Contact ID (JIT reconciliation)\n2. *Mobile App* → EngagementService: Submit feedback (POST /feedback with Contact ID, Category, Store Name, Time of Visit, Phone, Message)\n3. *EngagementService* → Mobile App: Immediate acknowledgment (\"Feedback submitted\")\n4. *EngagementService* → Event Bus: Publish work item for async Case creation\n5. *Background Worker* (EngagementService) → Salesforce: Create Case via REST API\n6. *Success*: EngagementService → Event Bus: Publish `SupportCaseCreated` event\n7. *EngagementService* → Braze: Trigger push notification campaign (\"Your feedback has been received, Case #12345\")\n8. *Failure*: Retry with exponential backoff → Dead Letter Queue → Ops team alert\n\n*Case Update Notification (Bidirectional):*\n\n1. *Support Agent* updates/resolves Case in Salesforce\n2. *Salesforce* → EngagementService: Webhook notification (Case updated)\n3. *EngagementService* → Event Bus: Publish `SupportCaseUpdated` or `SupportCaseResolved` event\n4. *EngagementService* → Braze: Trigger push notification campaign (\"Your case has been resolved\")\n\n*Contact Reconciliation (JIT):*\n\n1. *Mobile App user* authenticates\n2. *Mobile App* → ProfileService: GET /profile/contact-id\n3. *ProfileService* → Salesforce: Query Contact by email\n4. *Match found*: Return existing Salesforce Contact ID\n5. *No match*: Create new Contact in Salesforce, return new Contact ID\n6. *ProfileService* → Mobile App: Return Salesforce Contact ID (cached by Mobile App)\n\n===== System of Record Boundaries\n\n[width=\"100%\",cols=\"30%,35%,35%\",options=\"header\",]\n|===\n|Data Entity |System of Record |Rationale\n\n|*Contact*\n|Salesforce Service Cloud\n|Shared Viva Energy instance, unified customer profile across all channels (digital, wholesale, Shell Card, retail)\n\n|*Case*\n|Salesforce Service Cloud\n|Support agents manage Cases in Salesforce, digital channels submit via EngagementService ACL\n\n|*Feedback Submission (transient)*\n|None (no persistence)\n|EngagementService processes feedback and creates Case in Salesforce, no local storage\n\n|*Domain Events*\n|Event Bus (ephemeral)\n|Events published to Event Bus, consumed by subscribers, not persisted long-term (event sourcing not in scope)\n\n|===\n\n==== Data Architecture Principles\n\n===== Aggregate Persistence\n\n*ProfileService:*\n\n* **No local aggregate persistence** - ProfileService is stateless, queries Salesforce on-demand\n* Salesforce Contact is the aggregate root (owned by Salesforce)\n* ProfileService acts as facade/translator, not system of record\n\n*EngagementService:*\n\n* **No local aggregate persistence** - EngagementService is stateless, creates Cases in Salesforce via ACL\n* Salesforce Case is the aggregate root (owned by Salesforce)\n* EngagementService maintains no local Case state (Conformist pattern - trust Salesforce as source of truth)\n* Async processing state managed via Event Bus (work items in queue, not database)\n\n===== Event Store\n\n* **Event Bus** (SNS+SQS/EventBridge/Kinesis) handles domain event publishing\n* Events are **ephemeral** (consumed and discarded, not persisted for event sourcing)\n* No Event Store implementation in this architecture (future enhancement if needed)\n* Event schema versioning TBD in Solution Architecture\n\n\n=== Architecture Decisions\n\n==== ADR-CS-001: Consolidate onto Salesforce Service Cloud (not build custom solution)\n\n*Status*: Accepted\n\n*Context*:\n\n* D365 Customer Engagement not working well for digital customer support\n* Viva Energy already uses Salesforce Service Cloud for fuel wholesale, Shell Card, other retail channels\n* Post-merger opportunity to consolidate onto single platform\n* Alternative: Build custom support platform or use different SaaS\n\n*Decision*:\n\nConsolidate OTR digital customer support onto Salesforce Service Cloud (shared Viva Energy instance).\n\n*Rationale*:\n\n* **Unified customer view**: Support agents see all interactions across channels (digital, wholesale, Shell Card, retail)\n* **Platform consolidation**: Single support platform reduces operational overhead and costs\n* **Proven solution**: Salesforce Service Cloud is established, feature-rich, well-supported\n* **Post-merger alignment**: Strategic decision to standardize on Viva Energy platforms\n* **Avoid custom development**: Building custom support platform would be costly and high-risk\n\n*Consequences*:\n\n* Unified customer support across Viva Energy Group\n* Reduced operational complexity (single platform vs two)\n* Leverage Salesforce capabilities (case routing, knowledge base, AI, omnichannel)\n* ⚠️ Conformist pattern required (shared instance, conform to existing configuration)\n* ⚠️ Multi-tenant governance needed (data isolation, security, queues)\n* ❌ Less control over platform evolution (SaaS vendor, shared instance)\n\n==== ADR-CS-002: Implement ProfileService and EngagementService as first DDD bounded contexts\n\n*Status*: Accepted\n\n*Context*:\n\n* OTR target architecture uses Domain-Driven Design with bounded contexts\n* This migration is opportunity to establish first implementation\n* Alternative: Direct Mobile App → Salesforce integration (no bounded contexts)\n* Alternative: Single monolithic service for all customer-facing APIs\n\n*Decision*:\n\nImplement ProfileService and EngagementService as separate bounded contexts following DDD strategic patterns.\n\n*Rationale*:\n\n* **Foundation for target architecture**: First implementation of DDD pattern for future bounded contexts (Flybuys, LocationService, PaymentService)\n* **Separation of concerns**: ProfileService handles identity/Contact reconciliation, EngagementService handles support/feedback (different responsibilities, different change rates)\n* **Anti-Corruption Layer**: EngagementService protects digital channels from Salesforce API changes\n* **Reusability**: ProfileService Contact reconciliation reused for Flybuys integration\n* **Event-driven architecture**: Establishes pattern for loose coupling between bounded contexts\n\n*Consequences*:\n\n* Establishes DDD architecture foundation for OTR\n* Reusable ProfileService for Flybuys and future integrations\n* Digital channels protected from Salesforce API changes (ACL)\n* Clear bounded context boundaries and responsibilities\n* ⚠️ Increased initial complexity (two new microservices vs direct integration)\n* ⚠️ Requires Event Bus infrastructure implementation\n* ⚠️ Team must learn DDD patterns and bounded context design\n\n==== ADR-CS-003: Async Case creation via Event Bus (not synchronous)\n\n*Status*: Accepted\n\n*Context*:\n\n* Current D365 CE integration is synchronous (user waits for Case creation)\n* Alternative: Keep synchronous integration (Mobile App → EngagementService → Salesforce synchronously)\n* Salesforce API may experience downtime or latency\n\n*Decision*:\n\nImplement async Case creation via Event Bus with immediate user acknowledgment, retry logic, exponential backoff, and dead letter queue.\n\n*Rationale*:\n\n* **Non-blocking user experience**: User gets immediate \"Feedback submitted\" confirmation, not waiting for Salesforce API\n* **Resilience**: If Salesforce is down, feedback still accepted, Case created when Salesforce recovers\n* **Retry logic**: Automatic retry with exponential backoff handles transient failures\n* **Operational visibility**: Dead letter queue alerts ops team to persistent failures\n* **Scalability**: Queue buffering handles traffic spikes\n\n*Consequences*:\n\n* Better user experience (no waiting for Salesforce API)\n* Resilient to Salesforce downtime (queue buffers work)\n* Automatic retry reduces manual intervention\n* Queue depth monitoring provides operational visibility\n* ⚠️ Eventual consistency (user gets success notification after Case created, not immediately)\n* ⚠️ Increased complexity (Event Bus, background workers, retry logic, DLQ)\n* ⚠️ Requires monitoring and alerting for DLQ\n\n==== ADR-CS-004: ProfileService uses email as primary matching key (not VCI)\n\n*Status*: Accepted\n\n*Context*:\n\n* ProfileService needs to reconcile Mobile App users as Salesforce Contacts\n* Alternative matching keys: VCI (Viva Consumer ID), email, phone, Salesforce External ID\n* Email changes are rare but possible\n\n*Decision*:\n\nUse email address as primary matching key for Contact reconciliation (JIT upsert by email).\n\n*Rationale*:\n\n* **Availability**: Email always available for authenticated users\n* **Uniqueness**: Email is unique identifier in Salesforce and Mobile App\n* **Salesforce standard**: Salesforce Contact uses email as standard lookup field\n* **Simplicity**: Single matching key simplifies upsert logic\n* **Edge case acceptable**: Email changes are rare, manual cleanup acceptable\n\n*Consequences*:\n\n* Simple upsert logic (query by email, create if not found)\n* Leverages Salesforce standard email field\n* Email always available from authentication\n* ⚠️ Email changes create duplicate Contacts (rare edge case, manual cleanup)\n* ⚠️ Future enhancement: Add VCI as Salesforce External ID for stable matching\n\n==== ADR-CS-005: No Case migration from D365 CE (fresh start)\n\n*Status*: Accepted\n\n*Context*:\n\n* D365 CE contains historical customer support Cases\n* Alternative: Migrate historical Cases to Salesforce (preserve support history)\n* Alternative: Archive D365 CE Cases separately (read-only access)\n\n*Decision*:\n\nDo not migrate historical Cases from D365 CE to Salesforce. Start fresh in Salesforce.\n\n*Rationale*:\n\n* **Limited value**: Historical D365 CE Cases not critical for future support\n* **Data quality**: D365 CE Case data may be inconsistent or incomplete\n* **Complexity**: Case migration requires mapping D365 CE schema to Salesforce, data transformation, validation\n* **Cost-benefit**: Migration effort outweighs value of historical data\n* **Archive option**: D365 CE Cases can be archived separately if needed (read-only access for auditing)\n\n*Consequences*:\n\n* Simpler migration (Contacts only, no Case migration)\n* Faster time to value (no Case migration delay)\n* Clean start in Salesforce (no legacy data quality issues)\n* ⚠️ Historical Cases not visible in Salesforce (support agents can't see old Cases)\n* ⚠️ D365 CE must remain accessible temporarily for historical Case lookups (if needed)\n* ❌ Loss of historical Case insights (reporting, analytics on old Cases)\n\n==== ADR-CS-006: Big bang cutover (not phased rollout)\n\n*Status*: Accepted\n\n*Context*:\n\n* Alternative: Phased rollout with feature flags (pilot users first, gradual enablement)\n* Alternative: Parallel run (submit to both D365 CE and Salesforce temporarily)\n* Flybuys integration uses phased rollout (AS-1, AS-2, AS-3 architecture states)\n\n*Decision*:\n\nBig bang cutover - migrate Contacts, deploy ProfileService and EngagementService, switch Mobile App, retire D365 CE.\n\n*Rationale*:\n\n* **Simplicity**: No parallel run complexity, no feature flag management\n* **Faster D365 CE retirement**: No extended transition period maintaining two systems\n* **Limited risk**: Customer support not mission-critical (not payment processing), rollback possible\n* **User base manageable**: OTR digital customers smaller than Flybuys integration scope\n* **Different use case**: Flybuys phased rollout manages points accrual complexity, support feedback is simpler\n\n*Consequences*:\n\n* Simpler deployment (single cutover, no AS-1/AS-2/AS-3 states)\n* Faster D365 CE retirement (no extended parallel run)\n* No feature flag complexity or pilot user management\n* ⚠️ Higher cutover risk (all users switch at once)\n* ⚠️ Requires comprehensive testing before cutover\n* ⚠️ Rollback plan required (revert to D365 CE if critical issues)\n\n==== ADR-CS-007: EngagementService receives Salesforce webhooks for Case updates\n\n*Status*: Accepted\n\n*Context*:\n\n* Support agents update/resolve Cases in Salesforce\n* Need to notify customers of Case status changes via push notifications\n* Alternative: Poll Salesforce API for Case updates (inefficient)\n* Alternative: No customer notifications (agents contact customers directly)\n\n*Decision*:\n\nSalesforce sends webhook notifications to EngagementService when Cases are updated/resolved. EngagementService triggers Braze push notifications.\n\n*Rationale*:\n\n* **Real-time notifications**: Customer notified immediately when agent resolves Case\n* **Efficient**: Webhook push model (not polling)\n* **Event-driven**: Aligns with event-driven architecture pattern\n* **Better customer experience**: Proactive notification vs waiting for agent contact\n\n*Consequences*:\n\n* Real-time customer notifications for Case updates\n* Efficient push model (no polling overhead)\n* Bidirectional integration (Mobile App → Salesforce → Mobile App)\n* ⚠️ Salesforce webhook mechanism TBD (Outbound Messages vs Platform Events vs Process Builder)\n* ⚠️ Webhook authentication and security required\n* ⚠️ EngagementService must handle webhook retries and failures\n\n<<<\n== Interface Specifications\n\nThis section provides references to the complete API specifications and event catalogue for ProfileService and EngagementService.\n\n=== REST API Specifications\n\nComplete OpenAPI 3.0 specifications are maintained in the `specifications/rest/` directory:\n\n==== ProfileService API v1\n\n*Specification*: link:../../specifications/rest/profile-service-v1.yaml[profile-service-v1.yaml]\n\n*Base URL*: `https://api.otr.com.au/profile/v1`\n\n*Authentication*: Bearer token (Microsoft Entra External ID JWT)\n\n*Key Endpoints*:\n\n* `GET /contact-id` - Retrieve or create Salesforce Contact ID for authenticated user (Just-In-Time reconciliation)\n** Used by Mobile App before submitting feedback to EngagementService\n** Upserts Salesforce Contact record using email as external key\n** Returns 18-character Salesforce Contact ID with caching (15-minute TTL)\n** Performance SLA: p95 < 300ms (uncached), p95 < 50ms (cached)\n\n==== EngagementService API v1\n\n*Specification*: link:../../specifications/rest/engagement-service-v1.yaml[engagement-service-v1.yaml]\n\n*Base URL*: `https://api.otr.com.au/engagement/v1`\n\n*Authentication*: Bearer token (Microsoft Entra External ID JWT)\n\n*Key Endpoints*:\n\n* `POST /feedback` - Submit customer feedback for async Case creation in Salesforce\n** Accepts contactId, category, storeName, timeOfVisit, contactPhoneNumber, message\n** Returns 202 Accepted immediately (async Case creation in background)\n** Publishes `CustomerFeedbackSubmitted` event for analytics\n** Creates Salesforce Case via Anti-Corruption Layer with retry logic\n** Performance SLA: p95 < 200ms (feedback accepted, not Case creation)\n\n=== Domain Events (AsyncAPI)\n\nComplete CloudEvents 1.0 JSON Schema specifications are maintained in the `specifications/events/` directory:\n\n*Specification*: link:../../specifications/events/engagement-events.json[engagement-events.json]\n\n==== Event Catalogue\n\n[width=\"100%\",cols=\"30%,20%,50%\",options=\"header\",]\n|===\n|Event Type |Publisher |Consumers\n\n|`CustomerFeedbackSubmitted`\n|EngagementService\n|Future bounded contexts, analytics, sentiment analysis\n\n|`SupportCaseCreated`\n|EngagementService\n|Future bounded contexts, analytics\n\n|`SupportCaseUpdated`\n|EngagementService (via Salesforce webhook)\n|Future bounded contexts, analytics\n\n|`SupportCaseResolved`\n|EngagementService (via Salesforce webhook)\n|Future bounded contexts, analytics\n\n|===\n\n==== Event Delivery Guarantees\n\n* **At-least-once delivery**: Events may be delivered multiple times, consumers must handle idempotency\n* **Ordering**: FIFO queues guarantee ordering for events with same `contactId`\n* **Retention**: 4 days (96 hours) in Event Bus\n* **Dead Letter Queue**: Failed events after 5 retries moved to DLQ for manual intervention\n* **Format**: CloudEvents 1.0 specification with JSON payload\n\n=== API Versioning Policy\n\n==== Version Numbering\n\n* **Format**: `/v{major}` in URL path (e.g., `/profile/v1`, `/engagement/v1`)\n* **Semantic Versioning**: Major version incremented for breaking changes only\n* **Backwards Compatibility**: Minor changes (new optional fields, new endpoints) don't require version bump\n\n==== When to Version\n\n*Breaking changes requiring new major version*:\n\n- Removing or renaming fields in request/response\n- Changing field data types (e.g., string → number)\n- Changing authentication mechanism\n- Removing endpoints\n\n*Non-breaking changes not requiring version bump*:\n\n- Adding new optional fields to request/response\n- Adding new endpoints\n- Expanding enum values (e.g., adding new feedback category)\n- Improving error messages\n\n==== Parallel Version Support\n\n* Support N and N-1 versions concurrently for 6 months\n* Deprecation notice: 3 months before sunsetting old version\n* Mobile App must upgrade to new version within deprecation window\n\n<<<\n== Work Packages\n\nThis section consolidates gaps and activities into implementable work packages aligned with TOGAF Phase E requirements.\n\n=== Work Package Overview\n\n[width=\"100%\",cols=\"15%,35%,25%,25%\",options=\"header\",]\n|===\n|Work Package ID |Name |Transition State |Key Deliverables\n\n|WP-CS-001\n|ProfileService Development\n|TS-1 (Build & Test)\n|ProfileService microservice, Salesforce Contact integration, REST API\n\n|WP-CS-002\n|EngagementService Development\n|TS-1 (Build & Test)\n|EngagementService microservice, Anti-Corruption Layer, Braze integration\n\n|WP-CS-003\n|Event Bus Infrastructure\n|TS-1 (Build & Test)\n|Event Bus configuration, CloudEvents schemas, monitoring\n\n|WP-CS-004\n|Contact Migration Tooling\n|TS-1 (Build & Test)\n|Migration tool, validation scripts, reconciliation reporting\n\n|WP-CS-005\n|Mobile App Integration\n|TS-1 (Build & Test)\n|Mobile App API integration, feedback form enhancements, testing\n\n|WP-CS-006\n|Integration Testing\n|TS-1 (Build & Test)\n|Test environments, integration test suites, UAT execution\n\n|WP-CS-007\n|Salesforce Configuration\n|TS-1 (Build & Test)\n|Salesforce field mapping, data isolation, webhook configuration\n\n|WP-CS-008\n|Contact Data Migration\n|TS-2 (Contact Migration)\n|Contact migration execution, validation, reconciliation\n\n|WP-CS-009\n|Production Deployment\n|TS-3 (Cutover)\n|Production deployment, smoke testing, go-live execution\n\n|WP-CS-010\n|Post-Cutover Support\n|TS-4 (Target State)\n|Monitoring, issue resolution, D365 CE retirement\n\n|===\n\n[[wp-cs-001]]\n=== WP-CS-001: ProfileService Development\n\n==== Description\n\nBuild ProfileService bounded context microservice implementing Just-In-Time Contact reconciliation with Salesforce Service Cloud.\n\n==== Deliverables\n\n* ProfileService microservice application\n** REST API implementation (OpenAPI 3.0 specification)\n** `GET /contact-id` endpoint (Salesforce Contact reconciliation)\n** Authentication/authorization with Microsoft Entra External ID\n** Caching layer (15-minute TTL for Contact IDs)\n* Salesforce integration\n** Salesforce REST API client\n** Contact upsert by email (external key matching)\n** Error handling and retry logic\n* Unit tests (>80% code coverage)\n* Integration tests with Salesforce sandbox\n* API documentation\n* Deployment configuration (IaC - Infrastructure as Code)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* Salesforce sandbox environment provisioned\n* Microsoft Entra External ID OAuth configuration\n* Development environment setup (AWS dev account, CI/CD pipeline)\n\n*Dependent Work Packages*:\n\n* None (can start immediately after prerequisites met)\n\n==== Skills Required\n\n* Backend development (.NET Core or Node.js)\n* REST API design and implementation\n* Salesforce REST API integration\n* OAuth 2.0 / JWT authentication\n* Caching strategies (Redis/ElastiCache)\n* Unit/integration testing frameworks\n* Infrastructure as Code (Terraform/CloudFormation)\n\n==== Acceptance Criteria\n\n* All API endpoints return correct HTTP status codes per OpenAPI specification\n* Contact ID retrieval achieves p95 < 300ms (uncached), p95 < 50ms (cached)\n* Salesforce Contact upsert succeeds with 100% accuracy in sandbox testing\n* Unit test coverage > 80%\n* Integration tests pass in sandbox environment\n* API documentation generated from OpenAPI specification\n\n[[wp-cs-002]]\n=== WP-CS-002: EngagementService Development\n\n==== Description\n\nBuild EngagementService bounded context microservice implementing customer feedback submission, Anti-Corruption Layer for Salesforce Case creation, Braze integration, and webhook receiver for Case updates.\n\n==== Deliverables\n\n* EngagementService microservice application\n** REST API implementation (OpenAPI 3.0 specification)\n** `POST /feedback` endpoint (async feedback submission)\n** Authentication/authorization with Microsoft Entra External ID\n** Webhook receiver endpoint for Salesforce Case updates\n* Anti-Corruption Layer (ACL)\n** OTR domain model to Salesforce API translation\n** Category enum mapping (App/Service/Order/Rewards → Salesforce Case fields)\n** Salesforce REST API client for Case creation\n* Async processing infrastructure\n** Event Bus publisher integration\n** Background worker for Case creation\n** Retry logic with exponential backoff (5 attempts)\n** Dead Letter Queue integration\n* Braze integration\n** Braze campaign trigger API client\n** Push notification orchestration for Case updates\n* Domain event publishing\n** `CustomerFeedbackSubmitted` event publisher\n** `SupportCaseCreated` event publisher\n** `SupportCaseUpdated` event translator (Salesforce webhook → domain event)\n** `SupportCaseResolved` event translator (Salesforce webhook → domain event)\n* Unit tests (>80% code coverage)\n* Integration tests (EngagementService ↔ Salesforce, EngagementService ↔ Braze)\n* API documentation\n* Deployment configuration (IaC)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* <<wp-cs-003,WP-CS-003>> (Event Bus Infrastructure) completed\n* Salesforce sandbox environment provisioned\n* Braze API credentials and campaign templates configured\n* Microsoft Entra External ID OAuth configuration\n\n*Dependent Work Packages*:\n\n* <<wp-cs-003,WP-CS-003>> must be completed first (Event Bus required for async processing)\n* <<wp-cs-007,WP-CS-007>> (Salesforce Configuration) must be in progress (field mapping needed)\n\n==== Skills Required\n\n* Backend development (.NET Core or Node.js)\n* REST API design and implementation\n* Salesforce REST API integration\n* Event-driven architecture patterns\n* Async/background processing (queues, workers)\n* Braze API integration\n* Webhook design and security\n* OAuth 2.0 / JWT authentication\n* Domain-Driven Design (DDD) - Anti-Corruption Layer pattern\n* Unit/integration testing frameworks\n* Infrastructure as Code (Terraform/CloudFormation)\n\n==== Acceptance Criteria\n\n* Feedback submission endpoint returns 202 Accepted within p95 < 200ms\n* Async Case creation succeeds with >99.5% success rate (including retries)\n* Anti-Corruption Layer correctly maps all feedback categories to Salesforce Case fields\n* Webhook receiver processes Salesforce Case updates and publishes domain events\n* Braze push notifications sent successfully for Case updates\n* Failed Case creation moves to Dead Letter Queue after 5 retry attempts\n* Unit test coverage > 80%\n* Integration tests pass with Salesforce sandbox and Braze staging environment\n\n[[wp-cs-003]]\n=== WP-CS-003: Event Bus Infrastructure\n\n==== Description\n\nImplement Event Bus infrastructure for domain event publishing using existing AWS infrastructure (SNS+SQS, EventBridge, or Kinesis).\n\n==== Deliverables\n\n* Event Bus infrastructure configuration\n** Topic/stream provisioning (technology choice: SNS+SQS / EventBridge / Kinesis)\n** FIFO queue configuration (ordering by `contactId`)\n** Dead Letter Queue (DLQ) setup\n** Retention policy (4 days / 96 hours)\n** Access control policies (IAM roles, permissions)\n* CloudEvents 1.0 schema definitions\n** JSON Schema specifications for all domain events\n** Schema validation configuration\n** Schema registry (if using EventBridge/Kinesis)\n* Monitoring and alerting\n** CloudWatch dashboards for queue metrics\n** Alarms for DLQ depth, queue age, processing failures\n** Event Bus throughput monitoring\n* Documentation\n** Event Bus architecture diagram\n** Event publishing guidelines\n** Consumer integration guide\n* Infrastructure as Code (IaC)\n** Terraform/CloudFormation templates for all infrastructure\n\n==== Dependencies\n\n*Prerequisites*:\n\n* AWS account access (existing infrastructure)\n* Technology selection decision (SNS+SQS vs EventBridge vs Kinesis)\n* CloudEvents 1.0 schema design approval\n\n*Dependent Work Packages*:\n\n* None (foundational infrastructure, can start early)\n\n==== Skills Required\n\n* AWS messaging services (SNS, SQS, EventBridge, Kinesis)\n* Event-driven architecture patterns\n* CloudEvents specification\n* JSON Schema design\n* Infrastructure as Code (Terraform/CloudFormation)\n* AWS IAM security configuration\n* CloudWatch monitoring and alerting\n\n==== Acceptance Criteria\n\n* Event Bus infrastructure provisioned in all environments (dev, staging, production)\n* FIFO ordering validated for events with same `contactId`\n* Dead Letter Queue triggers alarms when messages arrive\n* Event retention policy enforced (4 days)\n* CloudEvents 1.0 schema validation enabled\n* Monitoring dashboards operational\n* Infrastructure fully codified (IaC)\n\n[[wp-cs-004]]\n=== WP-CS-004: Contact Migration Tooling\n\n==== Description\n\nDevelop Contact migration tool for one-time migration from app-specific database to Salesforce Service Cloud with upsert logic and validation.\n\n==== Deliverables\n\n* Contact migration tool\n** Extract Contacts from app-specific database\n** Transform to Salesforce Contact API format\n** Upsert to Salesforce using email as external key\n** Fallback matching by phone number or Viva Consumer ID\n** Batch processing with rate limiting (respect Salesforce API limits)\n** Idempotent operation (can be re-run safely)\n* Validation scripts\n** Pre-migration validation (data quality checks)\n** Post-migration validation (100% Contact reconciliation)\n** Email/phone/VCI matching accuracy report\n* Reconciliation reporting\n** Contacts created vs updated statistics\n** Failed upserts with error details\n** Matching accuracy metrics\n* Rollback capability\n** Export snapshot of Salesforce Contacts before migration\n** Rollback procedure documentation\n* Documentation\n** Migration tool user guide\n** Troubleshooting guide\n** Runbook for migration execution\n\n==== Dependencies\n\n*Prerequisites*:\n\n* <<wp-cs-001,WP-CS-001>> (ProfileService Development) completed (reuses Salesforce integration code)\n* Salesforce sandbox environment for migration testing\n* App-specific database access (read-only sufficient)\n* Salesforce production access granted\n\n*Dependent Work Packages*:\n\n* <<wp-cs-001,WP-CS-001>> provides Salesforce Contact upsert logic to reuse\n\n==== Skills Required\n\n* Database development (SQL, data extraction)\n* Salesforce REST API integration\n* Batch processing and ETL patterns\n* Data validation and reconciliation\n* Error handling and logging\n* Scripting (Python, PowerShell, or similar)\n\n==== Acceptance Criteria\n\n* Migration tool successfully migrates 100% of Contacts in sandbox with zero data loss\n* Email/phone/VCI matching accuracy > 95% in sandbox testing\n* Failed upserts captured with actionable error messages\n* Reconciliation report matches actual Salesforce Contact counts\n* Migration tool execution time acceptable for production (freezes app database for minimum time)\n* Rollback procedure validated in sandbox\n* Documentation complete and approved\n\n[[wp-cs-005]]\n=== WP-CS-005: Mobile App Integration\n\n==== Description\n\nUpdate Mobile App to integrate with ProfileService and EngagementService APIs, replacing D365 CE integration.\n\n==== Deliverables\n\n* Feedback form UI enhancements\n** Add Category dropdown (App, Service, Order, Rewards, Refund, Delete Account)\n** Add Store Name field (optional)\n** Add Time of Visit field (optional, datetime picker)\n** Add Contact Phone Number field (optional, E.164 validation)\n** Update Message field (1-2000 character limit with counter)\n* API integration (Kotlin Multiplatform shared code)\n** ProfileService client (`GET /contact-id`)\n** EngagementService client (`POST /feedback`)\n** JWT token management (Microsoft Entra External ID)\n** Error handling (network failures, API errors, validation errors)\n** Retry logic for transient failures\n* Platform-specific UI (SwiftUI for iOS, Jetpack Compose for Android)\n** Feedback form screens\n** Success/error confirmation screens\n** Loading states and progress indicators\n* Feature flag integration\n** `enable_salesforce_feedback_submission` flag\n** Fallback to D365 CE if flag disabled (during rollout)\n* Unit tests for shared business logic\n* UI tests for platform-specific screens\n* API integration tests (mocked APIs)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* <<wp-cs-001,WP-CS-001>> (ProfileService Development) completed and deployed to dev/staging\n* <<wp-cs-002,WP-CS-002>> (EngagementService Development) completed and deployed to dev/staging\n* ProfileService and EngagementService OpenAPI specifications finalized\n* Feature flag service configured\n\n*Dependent Work Packages*:\n\n* Must complete after <<wp-cs-001,WP-CS-001>> and <<wp-cs-002,WP-CS-002>> (requires API endpoints available for integration testing)\n\n==== Skills Required\n\n* Kotlin Multiplatform development\n* SwiftUI (iOS native UI)\n* Jetpack Compose (Android native UI)\n* REST API client development\n* OAuth 2.0 / JWT authentication\n* Form validation and UX design\n* Unit testing (Kotlin, Swift)\n* UI testing frameworks (XCTest, Espresso)\n\n==== Acceptance Criteria\n\n* Feedback form UI matches UX design specifications\n* All form fields validate correctly (client-side validation)\n* API integration successfully calls ProfileService and EngagementService in dev/staging\n* Error handling provides user-friendly error messages\n* Feature flag correctly toggles between Salesforce and D365 CE integration\n* Unit test coverage > 80% for shared business logic\n* UI tests pass for all feedback form workflows (happy path, error states)\n* App builds and deploys successfully to TestFlight (iOS) and Google Play Internal Testing (Android)\n\n[[wp-cs-006]]\n=== WP-CS-006: Integration Testing\n\n==== Description\n\nExecute comprehensive integration testing across all system components in non-production environments.\n\n==== Deliverables\n\n* Test environment setup\n** Salesforce sandbox configured with test data\n** ProfileService deployed to staging\n** EngagementService deployed to staging\n** Event Bus staging infrastructure\n** Braze staging environment configured\n** Mobile App TestFlight/Internal Testing builds\n* Integration test suites\n** ProfileService ↔ Salesforce (Contact upsert scenarios)\n** EngagementService ↔ Salesforce (Case creation scenarios)\n** EngagementService ↔ Braze (push notification scenarios)\n** Mobile App ↔ ProfileService ↔ EngagementService (end-to-end workflows)\n** Event Bus publishing and consumption\n** Webhook receiver (Salesforce → EngagementService)\n* Test scenarios\n** Happy path: Successful feedback submission and Case creation\n** Error scenarios: Salesforce API failures, Braze API failures, network timeouts\n** Retry scenarios: Async Case creation retries, DLQ validation\n** Performance testing: p95 latency validation for ProfileService and EngagementService\n** Load testing: Simulate 3x-10x expected volume\n* UAT execution\n** Business stakeholder UAT sessions\n** UAT test cases covering all feedback categories\n** UAT sign-off documentation\n* Test results documentation\n** Test execution reports\n** Defect tracking and resolution\n** Performance test results\n\n==== Dependencies\n\n*Prerequisites*:\n\n* <<wp-cs-001,WP-CS-001>> (ProfileService Development) completed\n* <<wp-cs-002,WP-CS-002>> (EngagementService Development) completed\n* <<wp-cs-003,WP-CS-003>> (Event Bus Infrastructure) completed\n* <<wp-cs-005,WP-CS-005>> (Mobile App Integration) completed\n* <<wp-cs-007,WP-CS-007>> (Salesforce Configuration) sandbox configuration completed\n\n*Dependent Work Packages*:\n\n* Must complete after <<wp-cs-001,WP-CS-001>>, <<wp-cs-002,WP-CS-002>>, <<wp-cs-003,WP-CS-003>>, <<wp-cs-005,WP-CS-005>> (requires all components available)\n\n==== Skills Required\n\n* Integration testing strategy and execution\n* Test automation frameworks (Postman, Newman, Selenium)\n* Performance testing tools (JMeter, k6, Gatling)\n* Salesforce sandbox administration\n* Test data management\n* Defect tracking and triage\n* UAT facilitation\n\n==== Acceptance Criteria\n\n* All integration test scenarios pass (happy path, error scenarios, retry scenarios)\n* Performance SLAs validated (ProfileService p95 < 300ms, EngagementService p95 < 200ms)\n* Load testing confirms system handles 3x expected volume without degradation\n* UAT sign-off obtained from business stakeholders\n* Zero critical defects (P1/P2) open before moving to Contact Migration\n* Test results documented and approved\n\n[[wp-cs-007]]\n=== WP-CS-007: Salesforce Configuration\n\n==== Description\n\nConfigure Salesforce Service Cloud for OTR digital customer support integration, including field mapping, data isolation, and webhook setup.\n\n==== Deliverables\n\n* Salesforce Contact configuration\n** Custom fields for OTR-specific data (if needed)\n** Email as external key configuration\n** Record Type for OTR digital customers (data isolation)\n** Validation rules\n* Salesforce Case configuration\n** Custom fields for feedback categories (App, Service, Order, Rewards, Refund, Delete Account)\n** Case Type and Reason picklist mapping\n** Queue assignment rules (OTR digital support queue)\n** Case escalation rules\n** Case routing rules\n* Salesforce webhook configuration\n** Platform Events / Outbound Messages for Case updates\n** Webhook authentication (API key, JWT, or OAuth)\n** Case status change triggers (New → In Progress, Resolved, Closed)\n** Webhook payload format (JSON)\n* Data isolation strategy\n** Record Types for OTR vs other Viva Energy business units\n** Queues for OTR-specific Cases\n** Reporting and dashboards scoped to OTR data\n* Salesforce API access\n** Connected App configuration\n** OAuth 2.0 JWT bearer flow setup\n** API user credentials\n** API rate limit monitoring\n* Documentation\n** Salesforce field mapping specification\n** Webhook configuration guide\n** Data isolation architecture diagram\n** API authentication setup guide\n\n==== Dependencies\n\n*Prerequisites*:\n\n* Viva Energy Salesforce admin team engagement\n* Salesforce governance approval (multi-tenant environment)\n* Technical decision on webhook mechanism (Platform Events vs Outbound Messages)\n* Technical decision on authentication method (OAuth 2.0 JWT bearer flow recommended)\n\n*Dependent Work Packages*:\n\n* None (can start in parallel with development work packages)\n* Required for <<wp-cs-002,WP-CS-002>> (EngagementService needs field mapping)\n* Required for <<wp-cs-006,WP-CS-006>> (Integration Testing needs sandbox configuration)\n\n==== Skills Required\n\n* Salesforce administration\n* Salesforce configuration (Record Types, Queues, Validation Rules)\n* Salesforce API integration (REST API, Platform Events, Outbound Messages)\n* Salesforce security and authentication (OAuth, Connected Apps)\n* Multi-tenant data isolation patterns\n\n==== Acceptance Criteria\n\n* Salesforce sandbox configured with all custom fields, Record Types, Queues\n* Field mapping documented and approved by OTR business stakeholders\n* Webhook configuration tested and delivering Case update notifications\n* Data isolation validated (OTR data separate from other Viva Energy business units)\n* API authentication working for ProfileService and EngagementService\n* Salesforce API rate limits monitored and acceptable for expected volume\n* Configuration replicated to Salesforce production environment\n\n[[wp-cs-008]]\n=== WP-CS-008: Contact Data Migration\n\n==== Description\n\nExecute one-time Contact migration from app-specific database to Salesforce Service Cloud production.\n\n==== Deliverables\n\n* Pre-migration activities\n** Final validation of migration tool in sandbox\n** Communication plan (notify users of maintenance window if needed)\n** Freeze app-specific database Contact updates\n** Backup app-specific database\n** Export snapshot of Salesforce Contacts (rollback preparation)\n* Migration execution\n** Execute migration tool against Salesforce production\n** Monitor migration progress\n** Handle failed upserts (manual intervention if needed)\n* Post-migration validation\n** 100% Contact reconciliation (app database vs Salesforce)\n** Email/phone/VCI matching accuracy report\n** Reconciliation report (Contacts created vs updated)\n** Data integrity checks (no duplicate Contacts, no missing Contacts)\n* ProfileService smoke testing\n** Verify Contact ID retrieval works in production\n** Test cache behavior\n** Validate Salesforce Contact upserts from ProfileService\n* Migration report\n** Total Contacts migrated\n** Contacts created vs updated\n** Failed upserts (if any) with resolution\n** Matching accuracy metrics\n** Migration execution time\n\n==== Dependencies\n\n*Prerequisites*:\n\n* <<wp-cs-004,WP-CS-004>> (Contact Migration Tooling) completed\n* <<wp-cs-001,WP-CS-001>> (ProfileService Development) deployed to production (not yet integrated with Mobile App)\n* <<wp-cs-007,WP-CS-007>> (Salesforce Configuration) production configuration completed\n* Salesforce production access granted\n* Migration approved by business stakeholders\n\n*Dependent Work Packages*:\n\n* Must complete after <<wp-cs-001,WP-CS-001>>, <<wp-cs-004,WP-CS-004>>, <<wp-cs-007,WP-CS-007>>\n* Must complete before <<wp-cs-009,WP-CS-009>> (Production Deployment)\n\n==== Skills Required\n\n* Data migration execution\n* Salesforce administration\n* Database operations\n* Data validation and reconciliation\n* Incident management (if issues arise)\n\n==== Acceptance Criteria\n\n* 100% of Contacts migrated with zero data loss\n* Email/phone/VCI matching accuracy > 95%\n* ProfileService smoke tests pass in production\n* Reconciliation report approved by business stakeholders\n* App-specific database Contact updates frozen (read-only mode)\n* Rollback procedure ready (but not executed if migration successful)\n\n[[wp-cs-009]]\n=== WP-CS-009: Production Deployment\n\n==== Description\n\nDeploy all solution components to production and execute cutover from D365 CE to Salesforce Service Cloud.\n\n==== Deliverables\n\n* Production deployment\n** EngagementService deployed to production\n** Event Bus production infrastructure validated\n** Salesforce webhook configured in production\n** Mobile App released to production (App Store, Google Play)\n* Go-live activities\n** Smoke testing (end-to-end feedback submission)\n** Feature flag enabled: `enable_salesforce_feedback_submission = ON`\n** D365 CE integration disabled in Mobile App\n** Monitor Event Bus queue depth, DLQ, Salesforce API rate limits\n** Monitor Mobile App feedback submission success rate\n* Go/No-Go decision\n** Validate success criteria before final cutover\n** Business stakeholder approval\n** Technical validation (smoke tests pass, monitoring healthy)\n* Cutover communication\n** Notify support agents of new Salesforce integration\n** Provide training materials for support agents\n** Customer communication (if visible change)\n* Rollback plan\n** Documented rollback procedure\n** Feature flag can disable Salesforce integration and re-enable D365 CE\n** Rollback decision criteria (P1/P2 incidents, feedback submission success rate < 99%)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* <<wp-cs-001,WP-CS-001>> (ProfileService Development) completed\n* <<wp-cs-002,WP-CS-002>> (EngagementService Development) completed\n* <<wp-cs-003,WP-CS-003>> (Event Bus Infrastructure) completed\n* <<wp-cs-005,WP-CS-005>> (Mobile App Integration) completed\n* <<wp-cs-006,WP-CS-006>> (Integration Testing) completed with UAT sign-off\n* <<wp-cs-007,WP-CS-007>> (Salesforce Configuration) production configuration completed\n* <<wp-cs-008,WP-CS-008>> (Contact Data Migration) completed successfully\n* Mobile App release approval (App Store, Google Play)\n\n*Dependent Work Packages*:\n\n* Must complete after all prior work packages (final cutover)\n\n==== Skills Required\n\n* Production deployment and release management\n* Incident management and troubleshooting\n* Monitoring and observability\n* Change management and communication\n* Rollback execution (if needed)\n\n==== Acceptance Criteria\n\n* Mobile App feedback submission success rate > 99.5%\n* End-to-end flow validated (Mobile App → ProfileService → EngagementService → Salesforce Case created)\n* Braze push notifications delivered successfully\n* Event Bus queue depth normal, DLQ empty\n* No critical incidents (P1/P2) in first 24 hours\n* D365 CE integration disabled\n* Support agents successfully using Salesforce for OTR digital customer Cases\n\n[[wp-cs-010]]\n=== WP-CS-010: Post-Cutover Support\n\n==== Description\n\nMonitor production stability, resolve issues, validate success criteria, and execute D365 CE retirement.\n\n==== Deliverables\n\n* Monitoring and support\n** 24/7 on-call support for first week post-cutover\n** Daily monitoring reports (feedback submission success rate, Case creation success rate)\n** Incident response and resolution\n** Performance tuning (if needed)\n* Success criteria validation\n** Validate feedback submission success rate > 99.5%\n** Monitor customer satisfaction score (target: +15% improvement within 6 months)\n** Monitor average case resolution time (target: -20% improvement within 6 months)\n** Support agent feedback survey\n* D365 CE retirement\n** D365 CE set to read-only mode (historical Case lookups only)\n** Archive D365 CE data for compliance/auditing\n** Decommission D365 CE infrastructure (after 90-day stabilization period)\n** Remove D365 CE integration code from Mobile App\n* Documentation updates\n** Production runbook\n** Troubleshooting guide (based on incidents resolved)\n** Operational procedures for support team\n** Lessons learned document\n\n==== Dependencies\n\n*Prerequisites*:\n\n* <<wp-cs-009,WP-CS-009>> (Production Deployment) completed\n* Cutover successful with no critical incidents\n\n*Dependent Work Packages*:\n\n* Final work package in sequence\n\n==== Skills Required\n\n* Production support and incident management\n* Performance monitoring and tuning\n* Data archival and compliance\n* Infrastructure decommissioning\n* Documentation\n\n==== Acceptance Criteria\n\n* Zero critical incidents (P1/P2) in first 30 days post-cutover\n* Feedback submission success rate sustained > 99.5%\n* Customer satisfaction improvement validated (baseline established, ongoing measurement)\n* Support agents reporting positive experience with Salesforce unified view\n* D365 CE successfully decommissioned\n* All production documentation complete and approved\n* Lessons learned document published\n\n=== Work Package Sequencing\n\n==== Parallel Track 1: Infrastructure & Configuration\n\nCan start immediately and run in parallel:\n\n* WP-CS-003 (Event Bus Infrastructure)\n* WP-CS-007 (Salesforce Configuration)\n\n==== Parallel Track 2: Development\n\nCan start after Track 1 infrastructure decisions made:\n\n* WP-CS-001 (ProfileService Development) - Independent\n* WP-CS-002 (EngagementService Development) - Requires WP-CS-003 completed\n* WP-CS-004 (Contact Migration Tooling) - Requires WP-CS-001 completed (reuses code)\n\n==== Sequential Track 3: Integration & Testing\n\nMust complete after development:\n\n* WP-CS-005 (Mobile App Integration) - Requires WP-CS-001, WP-CS-002\n* WP-CS-006 (Integration Testing) - Requires WP-CS-001, WP-CS-002, WP-CS-003, WP-CS-005, WP-CS-007\n\n==== Sequential Track 4: Migration & Cutover\n\nMust complete sequentially:\n\n* WP-CS-008 (Contact Data Migration) - Requires WP-CS-001, WP-CS-004, WP-CS-006 UAT sign-off\n* WP-CS-009 (Production Deployment) - Requires all prior work packages completed\n* WP-CS-010 (Post-Cutover Support) - Requires WP-CS-009\n\n==== Critical Path\n\nThe critical path for this project is:\n\n. WP-CS-003 (Event Bus Infrastructure)\n. WP-CS-002 (EngagementService Development) - blocks on WP-CS-003\n. WP-CS-005 (Mobile App Integration) - blocks on WP-CS-001, WP-CS-002\n. WP-CS-006 (Integration Testing) - blocks on WP-CS-001 through WP-CS-005, WP-CS-007\n. WP-CS-008 (Contact Data Migration) - blocks on WP-CS-006 UAT sign-off\n. WP-CS-009 (Production Deployment) - blocks on WP-CS-008\n. WP-CS-010 (Post-Cutover Support) - final deliverable\n\nAny delays in critical path work packages will delay the overall cutover date.\n\n<<<\n== Transition Architecture\n\nThis section defines the evolution from baseline (D365 CE) to target state (Salesforce Service Cloud + ProfileService + EngagementService).\n\n=== Transition Approach\n\n*Big Bang Cutover*: Per ADR-CS-006, this transition uses a single cutover approach rather than phased rollout. All users switch from D365 CE to Salesforce simultaneously after Contact migration completion.\n\n=== Transition States\n\n==== TS-0: Baseline State (Current)\n\n===== Characteristics\n\n* D365 Customer Engagement handles all digital customer feedback\n* App-specific database stores customer Contact data\n* No ProfileService or EngagementService\n* No event-driven architecture\n* Synchronous feedback submission\n\n===== Components Active\n\n- D365 Customer Engagement\n- App-specific customer database\n- Mobile App (current version with D365 CE integration)\n\n==== TS-1: Build & Test\n\n===== Activities\n\n* Build ProfileService microservice (JIT Contact reconciliation API)\n* Build EngagementService microservice (feedback submission API, ACL for Salesforce Case creation, Braze integration, webhook receiver)\n* Implement Event Bus infrastructure (SNS+SQS/EventBridge/Kinesis)\n* Develop Contact migration tool (app database → Salesforce upsert by email/phone/VCI)\n* Update Mobile App API integration (ProfileService + EngagementService endpoints - feedback form UI already complete)\n* Integration testing (ProfileService ↔ Salesforce, EngagementService ↔ Salesforce, EngagementService ↔ Braze)\n* UAT with test Salesforce sandbox environment\n\n===== Components Active\n\n- D365 Customer Engagement (still active, unchanged)\n- App-specific customer database (still active)\n- ProfileService (non-production, testing only)\n- EngagementService (non-production, testing only)\n- Event Bus (non-production)\n- Salesforce Sandbox (testing)\n\n===== Exit Criteria\n\n- All integration tests pass\n- UAT sign-off from business stakeholders\n- Contact migration tool validated in sandbox\n- Mobile App updates tested with non-production APIs\n\n==== TS-2: Contact Migration\n\n===== Activities\n* Execute Contact migration (app database → Salesforce production)\n* Validation: 100% data integrity check (email/phone/VCI matching)\n* Reconciliation report: New Contacts created vs existing Contacts updated\n* Freeze app database Contact updates during migration window\n* ProfileService smoke testing (verify Contact lookups work in Salesforce production)\n\n===== Components Active\n- D365 Customer Engagement (still active, users unaffected)\n- Salesforce Production (Contacts migrated, no Cases yet)\n- ProfileService (production deployed, not integrated with Mobile App yet)\n- App-specific customer database (frozen, read-only)\n\n===== Exit Criteria\n- 100% of Contacts migrated with zero data loss\n- Email/phone/VCI matching accuracy > 95%\n- ProfileService smoke tests pass (JIT lookups return correct Contact IDs)\n- Reconciliation report approved\n\n==== TS-3: Cutover (Go-Live)\n\n===== Go-Live Activities\n\n* Deploy EngagementService to production\n* Deploy Mobile App updates (ProfileService + EngagementService API integration)\n* Configure Salesforce webhook (Case update notifications → EngagementService)\n* Smoke testing: End-to-end feedback submission (Mobile App → EngagementService → Salesforce → Braze notification)\n* Monitor Event Bus queue depth, dead letter queue, Salesforce API rate limits\n* **Go/No-Go decision**: Validate success criteria before final cutover\n* Enable feature flag: `enable_salesforce_feedback_submission = ON`\n* Disable D365 CE integration in Mobile App\n\n===== Components Active\n\n- ProfileService (production, integrated with Mobile App)\n- EngagementService (production, integrated with Mobile App)\n- Event Bus (production, processing async Case creation)\n- Salesforce Production (receiving Cases from digital customers)\n- Braze (sending push notifications)\n- Mobile App (new version with Salesforce integration)\n- D365 Customer Engagement (disabled, read-only for historical lookups)\n\n===== Exit Criteria\n\n- Mobile App feedback submission success rate > 99.5%\n- End-to-end flow validated (Mobile App → Salesforce Case created)\n- Braze push notifications delivered successfully\n- Event Bus queue depth normal, DLQ empty\n- No critical incidents (P1/P2) in first 24 hours\n\n==== TS-4: Target State (Stable Production)\n\n===== Characteristics\n\n* ProfileService and EngagementService fully operational\n* All digital customer feedback routed to Salesforce\n* Event-driven architecture established\n* D365 CE decommissioned\n* First DDD bounded contexts implemented successfully\n\n===== Monitoring Period\n\n* Validate success criteria: feedback submission rate > 99.5%, no data loss\n* Monitor customer satisfaction score (target: +15% improvement)\n* Monitor average case resolution time (target: -20% improvement)\n* Support agents using unified Salesforce view across all channels\n\n===== D365 CE Retirement\n\n* D365 CE read-only access for historical Case lookups (if needed)\n* Decommission D365 CE infrastructure after 90 days\n* Archive D365 CE data for compliance/auditing\n\n===== Components Active\n\n- ProfileService (production)\n- EngagementService (production)\n- Event Bus (production)\n- Salesforce Production (system of record)\n- Braze (push notifications)\n- Mobile App (Salesforce integration)\n- App-specific database (deprecated, Contact data no longer updated)\n\n===== Success Criteria Achieved\n\n- All digital customer feedback routed to Salesforce\n- Support agents have unified customer view\n- D365 CE decommissioned\n- Customer satisfaction improved by 15%\n- Average case resolution time decreased by 20%\n- Zero data loss during transition\n\n=== Transition Dependencies\n\n[width=\"100%\",cols=\"40%,60%\",options=\"header\",]\n|===\n|Dependency |Owner/Status\n\n|*Salesforce production access*\n|Viva Energy Salesforce admin team - TBD\n\n|*Salesforce Case field mapping*\n|Viva Energy Salesforce admin team - TBD (map OTR feedback categories to Salesforce fields)\n\n|*Salesforce data isolation strategy*\n|Viva Energy Salesforce admin team - TBD (Record Types, queues, custom fields)\n\n|*Salesforce webhook configuration*\n|Viva Energy Salesforce admin team - TBD (Outbound Messages vs Platform Events)\n\n|*Event Bus infrastructure*\n|OTR Platform team - Existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis)\n\n|*Braze integration*\n|OTR Marketing team - Existing Braze account, EngagementService creates new campaigns\n\n|*Mobile App release window*\n|OTR Mobile team - Coordinate cutover timing with app release schedule\n\n|*App database access*\n|OTR Platform team - Read access for Contact migration\n\n|===\n\n=== Transition Validation Criteria\n\n==== Contact Migration Validation\n\n* 100% of app database Contacts migrated to Salesforce (zero data loss)\n* Email/phone/VCI matching accuracy > 95% (minimize duplicate Contacts)\n* ProfileService JIT lookups return correct Salesforce Contact IDs (smoke test sample)\n* Reconciliation report shows: X new Contacts created, Y existing Contacts updated\n\n==== Cutover Validation\n\n* Mobile App feedback submission success rate > 99.5% (including async Case creation)\n* End-to-end flow validated: Mobile App → ProfileService → EngagementService → Salesforce Case created\n* Braze push notifications delivered for Case creation and Case resolution\n* Event Bus queue depth within normal range (no backlog)\n* Dead letter queue empty (no failed Case creations)\n* Salesforce API rate limits not exceeded\n\n==== Production Monitoring (30 days)\n\n* Customer satisfaction score improves by 15% (compared to D365 CE baseline)\n* Average case resolution time decreases by 20% (Salesforce vs D365 CE)\n* Support agents confirm unified customer view across all channels\n* Zero critical incidents (P1 outages, data loss)\n\n=== Rollback Plan\n\n==== Rollback Triggers\n\n* Feedback submission success rate < 95% (below acceptable threshold)\n* Data loss or corruption detected in Salesforce\n* Salesforce API rate limits exceeded (Cases not created within SLA)\n* Critical bug blocking customer feedback submission\n\n==== Rollback Procedure\n\n1. **Revert Mobile App** to previous version (remove ProfileService/EngagementService integration, restore D365 CE integration)\n2. **Stop EngagementService** Case creation (prevent duplicate Cases in Salesforce)\n3. **Re-enable D365 CE** for customer feedback submission\n4. **Investigate root cause** (EngagementService logs, Salesforce API errors, Event Bus queue issues)\n5. **Fix and re-test** in sandbox environment\n6. **Retry cutover** when issues resolved\n\n==== Rollback Limitations\n\n* Cases created in Salesforce during cutover period remain in Salesforce (no reverse migration)\n* Contacts migrated to Salesforce remain (no rollback to app database)\n* Rollback only affects Mobile App integration (not data migration)\n\n=== Architectural Scope Boundaries\n\n==== Capabilities Included\n\n===== Business Capabilities\n\n* **Customer Feedback Submission**: Mobile App users can submit structured feedback (Category, Store Name, Time of Visit, Phone, Free Text Message) via EngagementService\n* **Customer Contact Management**: Just-In-Time (JIT) Contact reconciliation with Salesforce via ProfileService, ensuring every Mobile App user has a Salesforce Contact record\n* **Case Management Integration**: EngagementService creates Salesforce Cases asynchronously for customer feedback, support agents manage Cases in Salesforce Service Cloud\n* **Customer Notifications**: Push notifications via Braze when Cases are created, updated, or resolved (bidirectional integration: Mobile App → Salesforce → Mobile App)\n* **Unified Customer View**: Support agents see OTR digital customer feedback alongside other Viva Energy channels (fuel wholesale, Shell Card, retail) in single Salesforce instance\n* **Contact Data Migration**: One-time migration of app-specific customer database Contacts to Salesforce with upsert logic (email/phone/VCI matching)\n\n===== Technical Capabilities\n\n* **ProfileService Bounded Context**: First DDD bounded context implementation - JIT Contact reconciliation, Salesforce API facade, foundation for Flybuys integration\n* **EngagementService Bounded Context**: First DDD bounded context implementation - Customer feedback submission BFF, Anti-Corruption Layer for Salesforce, Braze integration orchestration\n* **Event-Driven Architecture**: Domain event publishing via Event Bus (SNS+SQS/EventBridge/Kinesis) for `SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted` events\n* **Async Processing Pattern**: Non-blocking Case creation with retry logic, exponential backoff, dead letter queue for operational resilience\n* **Anti-Corruption Layer Pattern**: EngagementService protects digital channels from Salesforce API changes, translates between OTR domain language and Salesforce\n* **Conformist Pattern**: ProfileService and EngagementService conform to existing Salesforce configuration (shared Viva Energy instance, multi-tenant governance)\n* **Salesforce Integration**: REST API integration for Contact CRUD and Case creation, webhook receiver for Case update notifications\n* **Braze Integration**: Push notification campaign triggers for Case lifecycle events (created, updated, resolved)\n* **Observability & Monitoring**: Dashboards, metrics, alerting for feedback submission rate, queue depth, API errors, Case creation latency\n* **Feature Flag Management**: Kill switches for emergency rollback (enable_salesforce_feedback_submission, enable_async_case_creation, etc.)\n\n==== Capabilities Excluded\n\n===== Business Capabilities Explicitly Out of Scope\n\n* **Historical Case Migration**: D365 CE Cases not migrated to Salesforce (ADR-CS-005 - fresh start, no Case migration)\n* **Multi-Channel Feedback Submission**: Web app, POS, call centre, email feedback channels not included (Mobile App only in this phase)\n* **Case Resolution by Digital Channels**: Support agents resolve Cases in Salesforce, not via Mobile App self-service\n* **Knowledge Base Integration**: Salesforce Knowledge Base articles not surfaced in Mobile App (future enhancement)\n* **Live Chat/Messaging**: Real-time chat support not included (Salesforce omnichannel capabilities not activated)\n* **Sentiment Analysis**: Automated feedback sentiment analysis not included (future enhancement with AI/ML)\n* **Customer Satisfaction Surveys**: Post-resolution CSAT surveys not included (separate initiative)\n* **Case Attachments**: Mobile App feedback submission does not support file uploads (photos, receipts) - text only\n* **Agent Desktop Integration**: Custom Salesforce UI for support agents not included (use standard Salesforce Service Console)\n* **Social Media Feedback**: Facebook, Twitter, Instagram feedback channels not integrated\n\n===== Technical Capabilities Explicitly Out of Scope\n\n* **Event Sourcing**: Domain events are ephemeral (not persisted for event sourcing/replay) - Event Bus only, no Event Store\n* **CQRS (Command Query Responsibility Segregation)**: ProfileService and EngagementService use same data model for reads/writes (no separate read models)\n* **Local Aggregate Persistence**: ProfileService and EngagementService are stateless (Salesforce is System of Record, no local database for Contact/Case)\n* **Saga Orchestration**: No distributed transactions or saga patterns required (single-step Case creation, not multi-step workflow)\n* **API Gateway Advanced Features**: Rate limiting, API versioning, API key management deferred to detailed design (basic routing only)\n* **GraphQL API**: ProfileService and EngagementService expose REST APIs only (GraphQL not required)\n* **Real-Time Sync**: Salesforce Contact updates by support agents not synced back to ProfileService (eventual consistency acceptable via JIT reconciliation)\n* **Multi-Region Deployment**: Single AWS region deployment (no multi-region failover/disaster recovery in this phase)\n* **Blue-Green Deployment**: Big bang cutover (ADR-CS-006), not blue-green or canary deployment strategy\n* **A/B Testing Framework**: Feature flags for rollback only, not for A/B testing or experimentation\n* **Custom Authentication**: Microsoft Entra External ID used for Mobile App authentication (no custom authentication logic in ProfileService/EngagementService)\n* **Data Residency Compliance**: Salesforce data residency governed by Viva Energy Salesforce configuration (no OTR-specific data residency requirements)\n\n===== Future Bounded Contexts Not in Scope\n\n* **LoyaltyService**: Flybuys integration, reward preferences, transaction adjudication (separate initiative)\n* **LocationService**: Store finder, proximity features, geofencing (separate initiative)\n* **PaymentService**: Payment processing, subscription billing (separate initiative)\n* **RecommendationService**: Personalized recommendations, next-best offers (separate initiative)\n\n===== Integration Patterns Not in Scope\n\n* **Shared Kernel**: No shared domain model between ProfileService and EngagementService (separate bounded contexts with clear boundaries)\n* **Partnership**: No joint development or coordination with external teams (Conformist pattern - we conform to Salesforce)\n* **Customer-Supplier (we're upstream)**: No downstream systems depend on ProfileService/EngagementService APIs yet (future bounded contexts will consume domain events)\n\n==== Architectural Dependencies on Future Initiatives\n\n*This Architecture Enables Future Initiatives*:\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Future Initiative |Architectural Enablement\n\n|*Flybuys Integration*\n|**ProfileService Contact Reconciliation Reused**: ProfileService establishes pattern for JIT Contact reconciliation with Salesforce, which will be extended for Flybuys partner linking (link:../architecture_definitions/flybuys_integration.adoc[see Flybuys Integration architecture]) +\n**Event Bus Infrastructure**: Domain event publishing pattern (`CustomerEnrolledInLoyalty`, `PartnerLinked`, etc.) reuses Event Bus established for EngagementService\n\n|*LoyaltyService Bounded Context*\n|**Event Bus Subscription**: LoyaltyService will consume `CustomerProfileCreated` events published by ProfileService (future enhancement) +\n**Salesforce Contact Integration**: LoyaltyService may query Salesforce Contacts for customer reward preferences (via ProfileService facade or direct Salesforce API)\n\n|*Web App Feedback Submission*\n|**EngagementService API Reuse**: Web app will call same EngagementService REST API for feedback submission (multi-channel support) +\n**Conformist Pattern**: Web app conforms to EngagementService API contract (no translation required)\n\n|*Multi-Channel Customer Support*\n|**EngagementService Extension**: Add support for email, call centre, POS feedback channels (extend EngagementService to handle multiple origins) +\n**Salesforce Case Origin Field**: Cases already tagged with Origin=Mobile App, extend to Origin=Web, POS, Call Centre, Email\n\n|*Knowledge Base Integration*\n|**EngagementService API Extension**: Add endpoint to query Salesforce Knowledge Base articles, surface in Mobile App for self-service support +\n**Anti-Corruption Layer**: EngagementService translates Salesforce Knowledge API to OTR domain language\n\n|*Customer Satisfaction Surveys*\n|**Event-Driven Trigger**: Subscribe to `SupportCaseResolved` events published by EngagementService, trigger CSAT survey via Braze +\n**Braze Integration Pattern**: Reuse EngagementService → Braze integration pattern for survey campaigns\n\n|*Sentiment Analysis*\n|**Event Subscription**: Subscribe to `CustomerFeedbackSubmitted` events, analyse feedback sentiment (AI/ML service) +\n**EngagementService Extension**: Enrich Case with sentiment score before creating in Salesforce\n\n|*RecommendationService Bounded Context*\n|**Event Subscription**: RecommendationService subscribes to `SupportCaseCreated` events to understand customer pain points and personalize recommendations +\n**Domain Event Pattern**: Reuse Event Bus publishing pattern established by EngagementService\n\n|===\n\n*This Architecture Depends on Future Initiatives*:\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Future Initiative |Dependency Description\n\n|*Salesforce Data Isolation Strategy*\n|**BLOCKER**: Viva Energy Salesforce admin team must define data isolation strategy (Record Types, custom fields, queues) before production deployment +\n**Impact**: Multi-tenant data visibility and security governance\n\n|*Salesforce Case Field Mapping*\n|**BLOCKER**: Viva Energy Salesforce admin team must define field mapping for OTR feedback categories (App, Service, Order, Rewards, Refund, Delete Account) +\n**Impact**: Case creation logic in EngagementService depends on finalized Salesforce schema\n\n|*Salesforce Webhook Mechanism*\n|**BLOCKER**: Viva Energy Salesforce admin team must configure webhook mechanism (Outbound Messages vs Platform Events vs Process Builder) for Case update notifications +\n**Impact**: EngagementService webhook receiver implementation depends on chosen mechanism\n\n|*Event Bus Technology Selection*\n|**DECISION REQUIRED**: Choose Event Bus implementation (SNS+SQS vs EventBridge vs Kinesis) for domain event publishing +\n**Impact**: Infrastructure provisioning, event schema design, consumer implementation\n\n|*Microservice Hosting Platform*\n|**DECISION REQUIRED**: Choose hosting platform for ProfileService and EngagementService (AWS Lambda vs ECS vs EKS) +\n**Impact**: Deployment architecture, auto-scaling strategy, operational overhead\n\n|*Observability Platform*\n|**DECISION REQUIRED**: Choose observability platform (AWS CloudWatch vs Datadog vs New Relic) for monitoring and alerting +\n**Impact**: Dashboard configuration, metric collection, alerting setup\n\n|===\n\n*Future Work After This Initiative*:\n\n* **Event Schema Registry**: Implement event schema versioning and registry for domain events (currently ad-hoc schemas)\n* **API Versioning Strategy**: Define API versioning approach for ProfileService and EngagementService (currently v1 only)\n* **Multi-Region Deployment**: Extend to multi-region for disaster recovery and global availability\n* **Event Store**: Persist domain events for event sourcing and audit trail (currently ephemeral Event Bus only)\n* **CQRS Pattern**: Separate read models for high-volume queries (currently same model for reads/writes)\n* **GraphQL API**: Expose GraphQL API for flexible client queries (currently REST only)\n* **Real-Time Sync**: Bi-directional sync between Salesforce and ProfileService for Contact updates (currently JIT reconciliation only)\n\n=== Technical Risks and Mitigation\n\n[width=\"100%\",cols=\"5%,20%,25%,25%,25%\",options=\"header\",]\n|===\n|ID |Risk |Impact |Likelihood |Mitigation\n\n|RISK-CS-001\n|*Salesforce API rate limits exceeded*: High feedback volume exceeds Salesforce API limits, Cases not created\n|HIGH (customers don't receive Case confirmation, support tickets lost)\n|MEDIUM (volume unknown, rate limits TBD)\n|• Gather expected feedback volume data before cutover +\n• Implement Event Bus queue throttling/rate limiting +\n• Monitor queue depth and API usage +\n• Scale background workers based on queue depth +\n• Alert ops team when approaching rate limits\n\n|RISK-CS-002\n|*Salesforce downtime*: Salesforce Service Cloud outage prevents Case creation\n|MEDIUM (Cases delayed but queued, customers wait for confirmation)\n|LOW (Salesforce SLA 99.9% uptime)\n|• Async Case creation with retry logic +\n• Event Bus queues buffer work during outage +\n• Customers get immediate \"Feedback submitted\" (not blocked) +\n• Monitor Salesforce status page, alert ops team +\n• Automatic retry when Salesforce recovers\n\n|RISK-CS-003\n|*Contact migration data quality issues*: App database Contact data incomplete or invalid\n|HIGH (migration fails validation, cutover delayed)\n|MEDIUM (legacy data quality unknown)\n|• Pre-migration data quality assessment +\n• Flexible upsert logic (match by email/phone/VCI) +\n• Validation report identifies data issues before production migration +\n• Manual cleanup for invalid records +\n• Dry-run migration in sandbox environment\n\n|RISK-CS-004\n|*Duplicate Contacts created*: Email matching fails, ProfileService creates duplicate Contacts\n|MEDIUM (support agents see multiple profiles for same customer)\n|MEDIUM (email changes, data quality issues)\n|• Salesforce duplicate detection rules (if available) +\n• ProfileService logs Contact creation for audit trail +\n• Manual duplicate cleanup process (support team) +\n• Future enhancement: VCI as Salesforce External ID for stable matching\n\n|RISK-CS-005\n|*Dead letter queue accumulation*: Failed Case creations not processed, queue grows\n|HIGH (customers don't receive Case confirmation, feedback lost)\n|LOW (retry logic handles most failures)\n|• Dead letter queue monitoring and alerting +\n• Ops team dashboard showing DLQ depth +\n• Manual intervention process (investigate and reprocess) +\n• Automated alerts when DLQ depth exceeds threshold +\n• Root cause analysis for recurring failures\n\n|RISK-CS-006\n|*Salesforce webhook failures*: Salesforce can't deliver Case update notifications to EngagementService\n|MEDIUM (customers don't get push notifications for Case resolution)\n|LOW (webhook mechanism reliable)\n|• Webhook retry logic and exponential backoff +\n• EngagementService logs webhook deliveries +\n• Monitor webhook delivery success rate +\n• Fallback: Poll Salesforce API for Case updates (if webhook fails persistently) +\n• Alert ops team when webhook delivery rate drops\n\n|RISK-CS-007\n|*Multi-tenant data isolation breach*: OTR digital Cases visible to other Viva Energy support teams\n|HIGH (privacy violation, compliance risk)\n|LOW (Salesforce governance controls)\n|• Work with Viva Energy Salesforce admin team on data isolation strategy +\n• Test data visibility in Salesforce sandbox (UAT with different user roles) +\n• Validate Record Types, queues, field-level security before production +\n• Audit Salesforce user permissions and sharing rules\n\n|RISK-CS-008\n|*Mobile App release coordination*: App release delayed, cutover window missed\n|MEDIUM (cutover delayed, D365 CE retirement delayed)\n|MEDIUM (release schedule conflicts)\n|• Coordinate cutover timing with Mobile team early +\n• Buffer time in migration plan (2-week contingency) +\n• Decouple backend deployment from Mobile App release (backend deployed first, app follows) +\n• Feature flag for feedback submission (enable when ready)\n\n|RISK-CS-009\n|*Event Bus infrastructure issues*: SNS/SQS/EventBridge downtime or misconfiguration\n|HIGH (Case creation blocked, domain events not published)\n|LOW (AWS SLA 99.99% uptime)\n|• Leverage existing AWS infrastructure (proven, reliable) +\n• Infrastructure as Code (IaC) for Event Bus configuration +\n• Integration testing in non-production environment +\n• Monitor Event Bus metrics (queue depth, throughput, errors) +\n• Alert ops team on Event Bus failures\n\n|RISK-CS-010\n|*Team DDD knowledge gap*: Team unfamiliar with DDD patterns, bounded contexts, event-driven architecture\n|MEDIUM (implementation delays, architectural inconsistencies)\n|HIGH (first DDD implementation)\n|• DDD training for development team (workshops, documentation) +\n• Architecture review sessions (validate bounded context design) +\n• Pair programming with experienced DDD practitioners +\n• Incremental implementation (start small, iterate) +\n• Document architectural patterns in CLAUDE.md\n\n|===\n\n== Assumptions and Constraints\n\n=== Assumptions\n\n[width=\"100%\",cols=\"8%,92%\",options=\"header\",]\n|===\n|ID |Assumption\n\n|ASM-CS-001\n|Viva Energy Salesforce admin team will provide Salesforce production access, sandbox environment, and support for Case field mapping and data isolation configuration\n\n|ASM-CS-002\n|App database Contact data is sufficiently complete for migration (email/phone/VCI available for matching)\n\n|ASM-CS-003\n|Expected customer feedback volume (100-150 submissions/day from 20k DAU) is well within Salesforce API rate limits, with capacity planning for 3x-10x growth\n\n|ASM-CS-004\n|Existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis) is sufficient for Event Bus implementation (no additional infrastructure provisioning required)\n\n|ASM-CS-005\n|Braze integration already exists and can be extended for Case-related push notifications (no new Braze account or major configuration changes)\n\n|ASM-CS-006\n|Mobile App users have email addresses associated with their accounts (required for ProfileService Contact reconciliation)\n\n|ASM-CS-007\n|D365 Customer Engagement historical Cases have limited business value and do not require migration to Salesforce\n\n|ASM-CS-008\n|Support agents are trained on Salesforce Service Cloud and require minimal additional training for OTR digital customer Cases\n\n|ASM-CS-009\n|Salesforce Service Cloud shared instance has capacity for OTR digital customer Contacts and Cases (no additional licensing or storage costs)\n\n|ASM-CS-010\n|Mobile App release schedule can accommodate cutover timing (Week 10 in migration plan)\n\n|===\n\n=== Constraints\n\n[width=\"100%\",cols=\"8%,92%\",options=\"header\",]\n|===\n|ID |Constraint\n\n|CON-CS-001\n|Must use shared Viva Energy Salesforce Service Cloud instance (cannot deploy separate OTR-specific instance)\n\n|CON-CS-002\n|Must conform to existing Salesforce configuration and governance (Record Types, custom fields, queues, data isolation strategy defined by Viva Energy admin team)\n\n|CON-CS-003\n|Contact migration must complete before Mobile App cutover (no parallel run of D365 CE and Salesforce)\n\n|CON-CS-004\n|Big bang cutover only (no phased rollout with feature flags or pilot users)\n\n|CON-CS-005\n|Salesforce API rate limits and authentication method constrained by Viva Energy Salesforce configuration (TBD)\n\n|CON-CS-006\n|Event Bus implementation must use existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis - cannot introduce new infrastructure components)\n\n|CON-CS-007\n|Mobile App feedback form must include specific fields: Category, Store Name, Time of Visit, Contact Phone Number, Free Text Message (no attachments)\n\n|CON-CS-008\n|D365 Customer Engagement must be decommissioned within 90 days post-cutover (ADR-CS-006)\n\n|CON-CS-009\n|ProfileService and EngagementService must be stateless (no local aggregate persistence, Salesforce is System of Record)\n\n|CON-CS-010\n|First DDD bounded context implementation (team learning curve, architectural patterns must be documented for future bounded contexts)\n\n|===\n\n== Non-Functional Requirements\n\n=== Performance Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-PERF-001\n|Mobile App feedback submission API response time (ProfileService + EngagementService)\n|p95 < 1 second, p99 < 2 seconds\n\n|NFR-PERF-002\n|ProfileService Contact reconciliation API response time (JIT lookup)\n|p95 < 500ms, p99 < 1 second\n\n|NFR-PERF-003\n|EngagementService async Case creation latency (end-to-end: feedback submitted → Case created in Salesforce)\n|p95 < 5 minutes, p99 < 10 minutes\n\n|NFR-PERF-004\n|Salesforce API call latency (Contact query, Contact create, Case create)\n|p95 < 2 seconds, p99 < 5 seconds\n\n|NFR-PERF-005\n|Event Bus message processing throughput\n|> 100 messages/second (support peak feedback volume)\n\n|NFR-PERF-006\n|Braze push notification delivery latency (Case created → notification delivered)\n|p95 < 30 seconds, p99 < 60 seconds\n\n|===\n\n=== Availability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-AVAIL-001\n|ProfileService availability\n|99.9% uptime (8.76 hours downtime/year)\n\n|NFR-AVAIL-002\n|EngagementService availability\n|99.9% uptime (8.76 hours downtime/year)\n\n|NFR-AVAIL-003\n|Feedback submission success rate (including async Case creation)\n|> 99.5% (includes retry logic for transient failures)\n\n|NFR-AVAIL-004\n|Graceful degradation: Salesforce downtime handling\n|Feedback submission still succeeds, Cases queued for async creation when Salesforce recovers\n\n|NFR-AVAIL-005\n|Graceful degradation: Braze downtime handling\n|Case creation proceeds, push notifications disabled temporarily (feature flag)\n\n|NFR-AVAIL-006\n|Planned maintenance window\n|< 4 hours/month, scheduled during low-traffic periods (2-6am ACST)\n\n|===\n\n=== Scalability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-SCALE-001\n|Concurrent Mobile App users (peak)\n|Support 20,000 DAU (Daily Active Users), ~150 concurrent users submitting feedback during peak hours\n\n|NFR-SCALE-002\n|Feedback submissions per day\n|Expected: 100-150 submissions/day based on 20k DAU (~0.5-0.75% submission rate) +\nCapacity: Support 500 submissions/day (3x expected volume for growth), 2,000 submissions/day (peak/incident scenarios)\n\n|NFR-SCALE-003\n|Auto-scaling: ProfileService and EngagementService\n|Auto-scale based on CPU/memory/request rate, scale up within 2 minutes\n\n|NFR-SCALE-004\n|Event Bus queue capacity\n|Support 100,000 queued messages (buffer for Salesforce downtime)\n\n|NFR-SCALE-005\n|Salesforce API rate limit compliance\n|Stay within 80% of Salesforce API rate limits (buffer for spikes)\n\n|NFR-SCALE-006\n|Future growth capacity\n|Architecture supports 10x growth (1,000-1,500 submissions/day based on 200k DAU) without major redesign\n\n|===\n\n=== Security Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-SEC-001\n|Mobile App authentication\n|Microsoft Entra External ID OAuth 2.0 with JWT tokens (existing CIAM)\n\n|NFR-SEC-002\n|API authorisation: ProfileService and EngagementService\n|JWT token validation, authenticated users only, user context propagation\n\n|NFR-SEC-003\n|Salesforce API authentication\n|OAuth 2.0 with Connected App and JWT bearer flow (service account)\n\n|NFR-SEC-004\n|Data encryption in transit\n|TLS 1.2+ for all API calls (Mobile App ↔ ProfileService/EngagementService ↔ Salesforce ↔ Braze)\n\n|NFR-SEC-005\n|Data encryption at rest\n|Salesforce encryption at rest (managed by Salesforce), Event Bus message encryption (AWS KMS)\n\n|NFR-SEC-006\n|Secret management\n|AWS Secrets Manager for Salesforce credentials, Braze API keys, OAuth tokens (no hardcoded secrets)\n\n|NFR-SEC-007\n|PII data handling\n|Contact data (email, phone, name) treated as PII, GDPR-compliant retention policies (Salesforce governance)\n\n|NFR-SEC-008\n|API rate limiting and throttling\n|API Gateway rate limiting (100 requests/second per user), prevent abuse and DoS\n\n|NFR-SEC-009\n|Logging and auditing\n|Log all API calls, Salesforce Contact/Case creates/updates, Event Bus publishes (no PII in logs)\n\n|NFR-SEC-010\n|Salesforce data isolation\n|Multi-tenant data isolation via Salesforce Record Types, queues, sharing rules (defined by Viva Energy admin team)\n\n|===\n\n=== Reliability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-REL-001\n|Retry logic: EngagementService → Salesforce Case creation\n|Exponential backoff (1s, 2s, 4s, 8s, 16s), max 5 retries, then dead letter queue\n\n|NFR-REL-002\n|Dead letter queue monitoring\n|Alert ops team immediately when DLQ depth > 0 (failed Case creations require manual intervention)\n\n|NFR-REL-003\n|Event Bus message durability\n|Messages persisted in Event Bus (SNS+SQS/EventBridge/Kinesis), not lost on service restart\n\n|NFR-REL-004\n|Idempotency: Case creation\n|EngagementService ensures duplicate feedback submissions don't create duplicate Cases (idempotency key)\n\n|NFR-REL-005\n|Circuit breaker: Salesforce API calls\n|Open circuit after 5 consecutive failures, half-open retry after 30 seconds\n\n|NFR-REL-006\n|Health checks: ProfileService and EngagementService\n|Health endpoints for load balancer checks, readiness and liveness probes\n\n|NFR-REL-007\n|Disaster recovery: Event Bus\n|Event Bus messages replicated across AWS availability zones (SQS/EventBridge/Kinesis HA)\n\n|===\n\n=== Maintainability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-MAINT-001\n|Code quality: ProfileService and EngagementService\n|> 80% test coverage (unit + integration tests), automated CI/CD pipeline\n\n|NFR-MAINT-002\n|API documentation\n|OpenAPI/Swagger specs for ProfileService and EngagementService, auto-generated API docs\n\n|NFR-MAINT-003\n|Deployment automation\n|Infrastructure as Code (Terraform/CloudFormation/CDK), zero-downtime deployments\n\n|NFR-MAINT-004\n|Logging: structured logs\n|JSON-formatted logs with correlation IDs, log levels (DEBUG, INFO, WARN, ERROR), centralized log aggregation\n\n|NFR-MAINT-005\n|Monitoring dashboards\n|Real-time dashboards for ProfileService, EngagementService, Event Bus (see Monitoring and Observability section)\n\n|NFR-MAINT-006\n|Alerting and on-call\n|PagerDuty/Opsgenie integration for P1/P2 alerts, on-call rotation for ops team\n\n|NFR-MAINT-007\n|Configuration management\n|Externalized configuration (environment variables, AWS Parameter Store), no hardcoded config\n\n|NFR-MAINT-008\n|Versioning: API and events\n|Semantic versioning (v1, v2), backward compatibility for API changes, event schema evolution\n\n|===\n\n=== Usability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-USE-001\n|Feedback submission UX\n|Mobile App user receives immediate \"Feedback submitted\" confirmation (< 1 second), not blocked by async Case creation\n\n|NFR-USE-002\n|Push notification delivery\n|Customer receives \"Your feedback has been received\" notification within 30 seconds of Case creation in Salesforce\n\n|NFR-USE-003\n|Case resolution notification\n|Customer receives \"Your case has been resolved\" notification within 30 seconds of support agent resolving Case\n\n|NFR-USE-004\n|Error messaging\n|User-friendly error messages for failed feedback submission (not technical errors), retry prompts\n\n|NFR-USE-005\n|Accessibility\n|Mobile App feedback form meets WCAG 2.1 AA accessibility standards (existing Mobile App compliance)\n\n|===\n\n=== Compliance Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-COMP-001\n|GDPR compliance: PII data\n|Customer Contact data (email, phone, name) managed per GDPR retention policies (Salesforce governance)\n\n|NFR-COMP-002\n|GDPR compliance: Right to erasure\n|Support \"Delete Account\" feedback category, trigger Contact deletion in Salesforce per GDPR Article 17\n\n|NFR-COMP-003\n|Data residency\n|Salesforce data residency governed by Viva Energy Salesforce configuration (regional compliance)\n\n|NFR-COMP-004\n|Audit trail\n|All Contact creates/updates, Case creates/updates logged for compliance auditing (Salesforce audit logs)\n\n|NFR-COMP-005\n|API security standards\n|OWASP API Security Top 10 compliance (injection prevention, authentication, authorisation, data exposure)\n\n|===\n\n== Monitoring and Observability\n\n=== Key Metrics\n\n[width=\"100%\",cols=\"25%,40%,35%\",options=\"header\",]\n|===\n|Metric Category |Metric |Target/Threshold\n\n|*Feedback Submission*\n|Feedback submission success rate (Mobile App → EngagementService)\n|> 99.5%\n\n|*Async Case Creation*\n|Case creation success rate (EngagementService → Salesforce)\n|> 99%\n\n|*Async Case Creation*\n|Case creation latency (time from feedback submission to Case created in Salesforce)\n|p95 < 5 minutes\n\n|*Event Bus*\n|Event Bus queue depth (pending Case creations)\n|< 100 messages\n\n|*Event Bus*\n|Dead letter queue depth (failed Case creations)\n|= 0 (alert on any failures)\n\n|*Salesforce API*\n|Salesforce API error rate\n|< 1%\n\n|*Salesforce API*\n|Salesforce API latency (Case creation)\n|p95 < 2 seconds\n\n|*Salesforce API*\n|Salesforce API rate limit utilization\n|< 80% of limit\n\n|*ProfileService*\n|Contact reconciliation success rate (JIT lookups)\n|> 99.5%\n\n|*ProfileService*\n|Contact reconciliation latency\n|p95 < 500ms\n\n|*Braze Notifications*\n|Push notification delivery rate (Case created/updated)\n|> 95%\n\n|*Salesforce Webhook*\n|Webhook delivery success rate (Salesforce → EngagementService)\n|> 99%\n\n|*Customer Satisfaction*\n|Customer satisfaction score (CSAT)\n|> 4.0/5.0 (improve by 15% from D365 CE baseline)\n\n|*Support Operations*\n|Average case resolution time\n|Decrease by 20% from D365 CE baseline\n\n|===\n\n=== Alerting Thresholds\n\n[width=\"100%\",cols=\"25%,50%,25%\",options=\"header\",]\n|===\n|Alert |Condition |Severity\n\n|*Feedback submission failures*\n|Feedback submission success rate < 95% over 5-minute window\n|P1 - Critical\n\n|*Dead letter queue accumulation*\n|Dead letter queue depth > 0 (any failed Case creations)\n|P2 - High\n\n|*Event Bus queue backlog*\n|Event Bus queue depth > 100 messages for > 15 minutes\n|P2 - High\n\n|*Salesforce API errors*\n|Salesforce API error rate > 5% over 5-minute window\n|P1 - Critical\n\n|*Salesforce API rate limits*\n|Salesforce API rate limit utilization > 90%\n|P2 - High\n\n|*Contact reconciliation failures*\n|ProfileService Contact reconciliation failure rate > 5% over 5-minute window\n|P2 - High\n\n|*Braze notification failures*\n|Braze push notification delivery rate < 80% over 15-minute window\n|P3 - Medium\n\n|*Salesforce webhook failures*\n|Salesforce webhook delivery success rate < 90% over 15-minute window\n|P2 - High\n\n|*Case creation latency*\n|Case creation latency p95 > 10 minutes\n|P3 - Medium\n\n|===\n\n=== Dashboards\n\n*ProfileService Dashboard:*\n\n* Contact reconciliation success rate (JIT lookups)\n* Contact reconciliation latency (p50, p95, p99)\n* Contact creation vs update ratio (new Contacts created vs existing Contacts updated)\n* Salesforce API error rate (Contact queries and creates)\n* Request rate and throughput\n\n*EngagementService Dashboard:*\n\n* Feedback submission success rate\n* Case creation success rate (async workflow)\n* Case creation latency (p50, p95, p99)\n* Event Bus queue depth (pending Case creations)\n* Dead letter queue depth (failed Case creations)\n* Salesforce API error rate (Case creation)\n* Salesforce API latency\n* Salesforce API rate limit utilization\n* Braze push notification delivery rate\n* Salesforce webhook delivery success rate\n\n*Event Bus Dashboard:*\n\n* Queue depth (pending messages)\n* Throughput (messages published/consumed per minute)\n* Dead letter queue depth (failed messages)\n* Consumer lag (time between publish and consume)\n\n*Customer Support Dashboard (Business Metrics):*\n\n* Total feedback submissions per day/week/month\n* Feedback category breakdown (App, Service, Order, Rewards, Refund, Delete Account)\n* Customer satisfaction score (CSAT) trend\n* Average case resolution time trend\n* Case volume by support team/queue\n* Unified customer view adoption (support agent feedback)\n<<<\n== Solution Validation\n\nThis section defines the validation criteria and testing approach for the solution.\n\n=== Functional Validation\n\n==== ProfileService API Testing\n\n*Test Scenarios*:\n1. **Happy Path**: Authenticated user requests Contact ID, existing Contact found in Salesforce, Contact ID returned\n2. **JIT Creation**: Authenticated user requests Contact ID, no existing Contact, new Contact created in Salesforce, Contact ID returned\n3. **Salesforce API Failure**: Salesforce unavailable, ProfileService returns 500 error, user retries\n4. **Invalid JWT**: Unauthenticated request, ProfileService returns 401 error\n\n*Acceptance Criteria*:\n- Contact reconciliation success rate > 99.5%\n- JIT Contact creation completes within 500ms (p95)\n\n==== EngagementService API Testing\n\n*Test Scenarios*:\n1. **Happy Path**: Valid feedback submission, immediate 202 Accepted response, Case created in Salesforce within 5 minutes, Braze notification delivered\n2. **Invalid Category**: Invalid feedback category, 400 Bad Request response with validation error\n3. **Salesforce Downtime**: Salesforce unavailable during async Case creation, message queued, retry logic executes, Case created when Salesforce recovers\n4. **Dead Letter Queue**: Case creation fails after 5 retries, message moved to DLQ, ops team alerted\n5. **Webhook Notification**: Support agent resolves Case in Salesforce, webhook triggers EngagementService, Braze push notification sent to customer\n\n*Acceptance Criteria*:\n- Feedback submission success rate > 99.5% (including async Case creation)\n- Async Case creation completes within 5 minutes (p95)\n- Webhook delivery success rate > 99%\n\n=== Non-Functional Validation\n\n==== Performance Testing\n\n*Load Testing*:\n\n*Baseline*: Expected 100-150 submissions/day from 20k DAU (~0.5-0.75% submission rate)\n\n- **Normal Load**: 1 submission/minute sustained for 2 hours (simulate typical daily pattern)\n- **3x Load**: 3 submissions/minute sustained for 1 hour (simulate busy period, 450 submissions/day)\n- **Peak Load (10x)**: 10 submissions/minute for 15 minutes (simulate incident scenario, app outage causing backlog)\n- **Stress Test**: 50 submissions/minute for 5 minutes (find breaking point, 20x normal)\n\n*Validation*:\n- API response time p95 < 1 second under 10x load\n- Event Bus queue depth remains manageable (< 100 messages)\n- No Case creation failures, all submissions processed successfully\n- Auto-scaling triggers appropriately for sustained load > 3x baseline\n\n*Acceptance Criteria*:\n- NFR-PERF-001 through NFR-PERF-006 validated under realistic load (3x and 10x baseline)\n- Auto-scaling triggers within 2 minutes of load increase\n- System handles 10x peak gracefully, 20x stress test identifies limits\n\n==== Resilience Testing\n\n*Salesforce API Failure Scenarios*:\n1. **Complete Outage**: Salesforce unavailable for 2 hours, Event Bus queues buffer work, Cases created when Salesforce recovers\n2. **Rate Limit Exceeded**: Salesforce rate limit hit, queue throttling activates, Cases created within SLA\n\n*Acceptance Criteria*:\n- NFR-AVAIL-004 validated (graceful degradation during Salesforce downtime)\n- Circuit breaker activates after 5 consecutive failures\n\n==== Security Validation\n\n*Penetration Testing*:\n- API authentication bypass attempts\n- SQL injection attempts\n- Webhook signature validation bypass\n\n*Acceptance Criteria*:\n- NFR-SEC-001 through NFR-SEC-010 validated\n- OWASP API Security Top 10 compliance verified\n\n=== Integration Validation\n\n==== End-to-End Testing\n\n*Full User Journey*:\n1. User authenticates via Microsoft Entra External ID\n2. Mobile App requests Contact ID from ProfileService (JIT reconciliation)\n3. User submits feedback via EngagementService\n4. Background worker creates Case in Salesforce\n5. Braze notification delivered to user\n6. Support agent resolves Case in Salesforce\n7. Salesforce webhook triggers EngagementService\n8. Braze notification delivered to user\n\n*Acceptance Criteria*:\n- End-to-end flow completes successfully in UAT\n- User receives both \"feedback submitted\" and \"case resolved\" notifications\n","structuredPatch":[{"oldStart":2198,"oldLines":8,"newStart":2198,"newLines":8,"lines":[" "," Can start immediately and run in parallel:"," ","-* WP-CS-003 (Event Bus Infrastructure)","-* WP-CS-007 (Salesforce Configuration)","+* <<wp-cs-003,WP-CS-003>> (Event Bus Infrastructure)","+* <<wp-cs-007,WP-CS-007>> (Salesforce Configuration)"," "," ==== Parallel Track 2: Development"," "]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"91b42589-450d-4893-bbbb-eff3cd9b64f2"}
{"parentUuid":"222ef4ca-b08b-4f7e-983d-18afb00a37ac","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_011cj8xwDKTVPJuQC1p12R5z","type":"tool_result","content":"The file /mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n  2200→\n  2201→* <<wp-cs-003,WP-CS-003>> (Event Bus Infrastructure)\n  2202→* <<wp-cs-007,WP-CS-007>> (Salesforce Configuration)\n  2203→\n  2204→==== Parallel Track 2: Development\n  2205→\n  2206→Can start after Track 1 infrastructure decisions made:\n  2207→\n  2208→* <<wp-cs-001,WP-CS-001>> (ProfileService Development) - Independent\n  2209→* <<wp-cs-002,WP-CS-002>> (EngagementService Development) - Requires <<wp-cs-003,WP-CS-003>> completed\n  2210→* <<wp-cs-004,WP-CS-004>> (Contact Migration Tooling) - Requires <<wp-cs-001,WP-CS-001>> completed (reuses code)\n  2211→\n  2212→==== Sequential Track 3: Integration & Testing\n  2213→\n  2214→Must complete after development:"}]},"uuid":"dca535bf-439e-44f3-9078-2577d7f8a450","timestamp":"2026-01-09T03:12:20.764Z","toolUseResult":{"filePath":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","oldString":"==== Parallel Track 2: Development\n\nCan start after Track 1 infrastructure decisions made:\n\n* WP-CS-001 (ProfileService Development) - Independent\n* WP-CS-002 (EngagementService Development) - Requires WP-CS-003 completed\n* WP-CS-004 (Contact Migration Tooling) - Requires WP-CS-001 completed (reuses code)","newString":"==== Parallel Track 2: Development\n\nCan start after Track 1 infrastructure decisions made:\n\n* <<wp-cs-001,WP-CS-001>> (ProfileService Development) - Independent\n* <<wp-cs-002,WP-CS-002>> (EngagementService Development) - Requires <<wp-cs-003,WP-CS-003>> completed\n* <<wp-cs-004,WP-CS-004>> (Contact Migration Tooling) - Requires <<wp-cs-001,WP-CS-001>> completed (reuses code)","originalFile":"= Salesforce Customer Support - Solution Architecture\n:project-name: Salesforce Customer Support\n:togaf-adm-phase: Phase E: Opportunities & Solutions\n:last-updated: 2026-01-07\n:document-type: Solution Architecture Document\n:status: Discovery\n:version: 0.1\n:domain: Customer Support & Engagement\n:programme-lead:\n:domain-architect: O.Young@otr.com.au\n:architecture-definition: xref:architecture-definitions:salesforce_customer_support.adoc[Architecture Definitions/Salesforce Customer Support]\n:doctype: article\n:toc: left\n:toclevels: 4\n:sectanchors:\n:sectlinks:\n:sectnums:\n:icons: font\n:source-highlighter: highlightjs\n:experimental:\n:description:\n:keywords:\n\n<<<\n== Purpose and Scope\n\n=== Purpose\n\nThis Solution Architecture defines how the Salesforce Customer Support consolidation will be implemented - the specific technology products, configurations, interfaces, and deployment architecture that realise the xref:architecture-definitions:salesforce_customer_support.adoc[Salesforce Customer Support Architecture Definition].\n\nThis solution establishes the **first implementation of OTR's target Domain-Driven Design (DDD) architecture** by deploying two new bounded contexts (`ProfileService` and `EngagementService`) as microservices, consolidating customer support onto Salesforce Service Cloud, and implementing event-driven integration patterns that will serve as the foundation for future bounded contexts (including Flybuys integration).\n\n=== Vision\n\n> Unify customer support across all OTRG channels by consolidating OTR digital customer feedback onto Salesforce Service Cloud, establishing the foundational DDD architecture with ProfileService and EngagementService bounded contexts that protect digital channels from external system changes while enabling support agents to deliver exceptional customer experiences with complete interaction history.\n\n=== Architectural Approach\n\nThis architecture establishes OTR's **first bounded context implementation** using Domain-Driven Design strategic patterns:\n\n* *link:../bounded_context/profile.adoc[ProfileService]* (NEW bounded context): Just-In-Time Contact reconciliation with Salesforce, upsert by email, returns Salesforce Contact ID to digital channels - foundation for future Flybuys partner linking\n* *link:../bounded_context/engagement.adoc[EngagementService]* (NEW bounded context): Customer feedback submission facade, Anti-Corruption Layer for Salesforce Case creation, Braze integration for all outbound customer communications (push, email, SMS), async Case processing via Event Bus\n* *Event-driven integration* (NEW pattern): Domain event publishing using existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis) - first implementation establishing pattern for future bounded contexts\n* *Anti-Corruption Layer*: EngagementService isolates digital channels from Salesforce API changes, translates between OTR domain language and Salesforce Service Cloud API\n* *Conformist Pattern*: ProfileService and EngagementService conform to existing Salesforce configuration (shared Viva Energy instance, multi-tenant governance)\n* *Big bang cutover*: Single deployment after Contact migration, no phased rollout, D365 CE retirement post-cutover\n\n=== Scope\n\n==== In Scope\n\n* Solution Building Blocks (SBBs) - specific technology products and versions\n* Interface specifications (APIs, events, data formats)\n* Data architecture and schema specifications\n* Deployment architecture and infrastructure configuration\n* Transition architecture with migration phases\n* Technical validation criteria and testing approach\n* External system integration specifications\n* Physical data models and API schemas\n\n==== Out of Scope\n\n===== Covered in xref:architecture-definitions:salesforce_customer_support.adoc[Architecture Definition]\n\n* Business requirements and stakeholder analysis\n* Architecture decisions and rationale (ADRs)\n* Bounded context definitions and responsibilities\n* High-level integration patterns (ACL, Conformist, OHS+PL)\n* Business capability mapping and value streams\n* Architecture principles and governance\n\n===== Covered in Other Documents\n\n* Detailed design (class diagrams, sequence diagrams for all flows)\n* Implementation code and unit tests\n* Business case and return-on-investment analysis\n* Operational run books and support procedures\n\n<<<\n=== Architecture Overview\n\n[mermaid]\n----\n---\nconfig:\n  layout: elk\n---\nflowchart TB\n    Customer([\"Customer\"]) -- Uses --> MobileApp[\"Mobile App<br>iOS/Android\"]\n    Customer -- Shops at --> POS[\"OTR/OTR+ POS<br>D365 Commerce\"]\n    MobileApp -- Authenticate --> EntraID[\"Microsoft Entra\"]\n    MobileApp -- Identifies & Reconciles --> ProfileService[\"ProfileService\"]\n    ProfileService <-- Reconcile App User as Salesforce Contact --> Salesforce[\"Salesforce\"]\n    ProfileService -- On Create --> EventBus[\"EventBus\"]\n    EventBus -- Emits CreateUser Event --> LoyaltyService[\"LoyaltyService\"] & EngagementService[\"EngagementService\"]\n    LoyaltyService -- Reconcile Wallet --> EagleEye[\"EagleEye\"]\n    EngagementService -- Reconcile Braze Profile --> Braze[\"Braze\"]\n    EngagementService --> Salesforce\n    D365CE[\"D365CE\"] -- Data Migration --> Salesforce\n    MobileApp -- Submits Feedback --> EngagementService\n\n    Customer:::customer\n    MobileApp:::presentation\n    POS:::presentation\n    EntraID:::external\n    ProfileService:::newService\n    Salesforce:::external\n    EventBus:::infrastructure\n    LoyaltyService:::newService\n    EngagementService:::newService\n    EagleEye:::external\n    Braze:::external\n    D365CE:::external\n    classDef newService fill:#4CAF50,stroke:#2E7D32,stroke-width:3px,color:#fff\n    classDef external fill:#FF9800,stroke:#E65100,stroke-width:2px,color:#fff\n    classDef infrastructure fill:#2196F3,stroke:#0D47A1,stroke-width:2px,color:#fff\n    classDef presentation fill:#9C27B0,stroke:#4A148C,stroke-width:2px,color:#fff\n    classDef customer fill:#607D8B,stroke:#263238,stroke-width:2px,color:#fff\n----\n\n\n==== Key Architectural Patterns\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Pattern |Application |Rationale\n\n|*Anti-Corruption Layer (ACL)*\n|EngagementService → Salesforce Service Cloud\n|Protects digital channels (Mobile App, Web) from Salesforce API changes, translates between OTR domain language and Salesforce Case/Contact model, enables independent evolution of internal domain model\n\n|*Conformist*\n|ProfileService → Salesforce, EngagementService → Salesforce\n|Shared Viva Energy Salesforce instance - we conform to existing configuration, governance, and API contracts (external system we don't control)\n\n|*Backend-for-Frontend (BFF)*\n|EngagementService\n|Aggregates customer feedback submission, Contact lookup, async Case creation, and Braze notification orchestration for digital channel clients\n\n|*Event-Driven Architecture (OHS+PL)*\n|Event Bus (SNS+SQS/EventBridge/Kinesis)\n|Loose coupling between bounded contexts, async domain event publishing (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`), foundation for future bounded contexts\n\n|*Just-In-Time (JIT) Integration*\n|ProfileService → Salesforce Contact reconciliation\n|Reconcile app users as Salesforce Contacts on-demand (upsert by email), no pre-sync required, ensures Salesforce has current Contact data\n\n|*Async Processing*\n|EngagementService Case creation via Event Bus\n|Non-blocking user experience, resilience to Salesforce downtime, automatic retry with exponential backoff, dead letter queue for operations team intervention\n\n|*Strangler Fig*\n|Not applicable\n|Big bang cutover (no gradual migration) - D365 CE fully replaced, not incrementally strangled\n\n|===\n\n<<<\n== Solution Approach\n\n* Deploy xref:bounded-contexts:profile.adoc[ProfileService] and xref:bounded-contexts:engagement.adoc[EngagementService] as bounded context microservices\n* Implement Anti-Corruption Layers (ACLs) for Salesforce and Braze integration\n* Establish event-driven architecture as the foundational integration pattern\n* Big bang cutover (TS-1 → TS-4)\n\n=== Related Documentation\n\nThis solution architecture references detailed technical specifications:\n\n==== Architecture Definition\n\n* xref:architecture-definitions:salesforce_customer_support.adoc[Salesforce Customer Support - Architecture Definition] - Business requirements, architecture decisions (ADRs), bounded context definitions, high-level integration patterns\n\n==== Bounded Context Specifications\n\n* xref:bounded-contexts:profile.adoc[ProfileService Bounded Context] - JIT Contact reconciliation, aggregate definitions\n* xref:bounded-contexts:engagement.adoc[EngagementService Bounded Context] - Customer feedback facade, Anti-Corruption Layer\n\n==== Interface Specifications\n\nDetailed API specifications available in the specifications directory:\n\n* link:../../specifications/rest/profile-service-v1.yaml[ProfileService REST API v1] - OpenAPI 3.0 specification for `/profile/v1` endpoints (includes Salesforce Contact reconciliation `GET /contact-id`)\n* link:../../specifications/rest/engagement-service-v1.yaml[EngagementService REST API v1] - OpenAPI 3.0 specification for `/engagement/v1` endpoints (includes `POST /feedback`)\n* link:../../specifications/events/engagement-events.json[Engagement Domain Events] - CloudEvents 1.0 JSON Schema for `SupportCaseCreated`, `SupportCaseUpdated`, `SupportCaseResolved`, `CustomerFeedbackSubmitted`\n\n==== External System Documentation\n\n* https://developer.salesforce.com/docs/atlas.en-us.api_rest.meta/api_rest/[Salesforce REST API Documentation] - Contact and Case object APIs\n* https://www.braze.com/docs/api/endpoints/messaging/send_messages/post_send_triggered_campaigns/[Braze Campaign Trigger API] - Push notification campaigns\n\n<<<\n== Executive Summary\n\n=== Challenge\n\nOTR digital customers (Mobile App, Web) currently submit feedback and support requests to D365 Customer Engagement, while Viva Energy's broader business units (fuel wholesale, Shell Card customers, other retail channels) use Salesforce Service Cloud. This creates:\n\n* *Fragmented customer support platform*: Customer support data split across two systems, preventing support agents from having a unified view of customer interactions across all channels\n* *Operational inefficiency*: Maintaining two separate customer support platforms increases operational overhead and costs\n* *Poor support experience*: D365 CE is not working well for digital customer support, impacting customer satisfaction and case resolution times\n* *Post-merger consolidation opportunity*: Following Viva Energy's acquisition of OTR, strategic alignment on Salesforce as the enterprise customer support platform\n\n=== Solution\n\nThis architecture establishes the **foundational Domain-Driven Design (DDD) implementation** for OTR's target state architecture by introducing two new bounded contexts (link:../bounded_context/profile.adoc[ProfileService], link:../bounded_context/engagement.adoc[EngagementService]) and event-driven integration patterns:\n\n==== New Bounded Contexts\n\n* *link:../bounded_context/profile.adoc[ProfileService]* (NEW): Just-In-Time (JIT) Contact reconciliation with Salesforce, upsert by email, returns Salesforce Contact ID to Mobile App\n* *link:../bounded_context/engagement.adoc[EngagementService]* (NEW): Customer feedback submission, Anti-Corruption Layer (ACL) for Salesforce Case creation, Braze integration for all outbound customer communications (push, email, SMS), async Case processing via Event Bus\n* *Event Bus* (NEW pattern): Domain event publishing using existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis) - first implementation of event-driven architecture pattern\n\n==== Integration Architecture\n\n* *Salesforce = System of Record*: Salesforce Service Cloud (shared Viva Energy instance) owns Contact and Case data\n* *Conformist Pattern*: ProfileService and EngagementService conform to existing Salesforce configuration and API contracts\n* *Anti-Corruption Layer*: EngagementService protects digital channels from Salesforce API changes, translates between OTR domain language and Salesforce\n* *Async Case Creation*: Non-blocking user experience, resilience to Salesforce downtime, automatic retry with exponential backoff, dead letter queue for failed Cases\n* *Event-Driven Notifications*: Salesforce webhook → EngagementService → Braze for all customer communications (push, email, SMS) on Case status updates\n\n==== Migration Approach\n\n* *Contact Migration*: One-time migration from app-specific database → Salesforce (upsert with flexible matching by email/phone/VCI)\n* *No Case Migration*: Historical D365 CE Cases not migrated (fresh start in Salesforce)\n* *Big Bang Cutover*: Single deployment, no phased rollout or parallel run\n* *D365 CE Retirement*: Complete decommissioning of D365 Customer Engagement post-cutover\n\n=== Key Architectural Significance\n\nThis migration establishes the first implementation of OTR's target DDD architecture:\n\n* First bounded contexts implemented (ProfileService, EngagementService)\n* First event-driven domain event pattern (foundation for future bounded contexts)\n* Foundation for Flybuys integration (ProfileService Contact reconciliation reused)\n* Establishes integration patterns (Conformist, ACL, Event-Driven) for future services\n\n=== Success Criteria\n\n* All digital customer feedback routed to Salesforce Service Cloud within 30 days of launch\n* Support agents have unified customer view across all Viva Energy channels (digital, wholesale, Shell Card, other retail)\n* D365 Customer Engagement decommissioned within 90 days post-cutover\n* Customer satisfaction score improves by 15% within 6 months\n* Average case resolution time decreases by 20% within 6 months\n* Zero data loss during Contact migration (100% validation pass rate)\n* Mobile App feedback submission success rate > 99.5% (including async Case creation)\n\n=== Technical Constraints\n\n* Shared Salesforce instance (Viva Energy multi-tenant environment)\n* Conform to existing Salesforce configuration and governance (data isolation strategy TBD with Salesforce admin team)\n* Contact migration must complete before cutover (no parallel run)\n* Async Case creation mandatory (non-blocking user experience)\n* Expected volume: 100-150 feedback submissions/day from 20k DAU (~0.5-0.75% submission rate), architecture capacity planned for 3x-10x growth\n\n=== Open Technical Decisions (TBD)\n\n* Salesforce Case field mapping for digital feedback categories (App, Service, Order, Rewards, Refund, Delete Account)\n* Salesforce data isolation strategy (Record Types, custom fields, queues)\n* Salesforce REST API authentication method (OAuth 2.0, Connected App, JWT bearer flow)\n* Salesforce webhook mechanism for Case updates (Outbound Messages, Platform Events, Process Builder)\n* Retry policy configuration (attempts, backoff intervals)\n* Salesforce API rate limit strategy (expected volume: 100-150 submissions/day from 20k DAU, capacity planning for 3x-10x growth)\n\n== Technical Requirements\n\n[width=\"100%\",cols=\"8%,92%\",options=\"header\",]\n|===\n|ID |Description\n\n|TR-CS-001\n|Every Mobile App user must have a Salesforce Contact record in Salesforce Service Cloud (shared Viva Energy instance)\n\n|TR-CS-002\n|ProfileService must reconcile Mobile App users as Salesforce Contacts using Just-In-Time (JIT) upsert by email address\n\n|TR-CS-003\n|ProfileService must return Salesforce Contact ID to Mobile App for feedback submission\n\n|TR-CS-004\n|Mobile App must support customer feedback submission with fields: Category (App, Service, Order, Rewards, Refund, Delete Account), Store Name, Time of Visit, Contact Phone Number, Free Text Message\n\n|TR-CS-005\n|EngagementService must create Salesforce Cases asynchronously via Event Bus (non-blocking user experience)\n\n|TR-CS-006\n|EngagementService must acknowledge feedback submission immediately to Mobile App user (\"Feedback submitted\" confirmation)\n\n|TR-CS-007\n|EngagementService must send push notification to customer via Braze when Case is successfully created in Salesforce\n\n|TR-CS-008\n|EngagementService must retry failed Case creation with configurable exponential backoff and dead letter queue for operations team intervention\n\n|TR-CS-009\n|Salesforce must be the System of Record for Contact and Case data (no local persistence in ProfileService or EngagementService)\n\n|TR-CS-010\n|Contact migration from app-specific database to Salesforce must complete before Mobile App cutover (upsert with flexible matching by email/phone/VCI)\n\n|TR-CS-011\n|No Case migration from D365 Customer Engagement to Salesforce (fresh start, historical Cases not migrated)\n\n|TR-CS-012\n|EngagementService must publish domain events (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`) to Event Bus for consumption by other bounded contexts\n\n|TR-CS-013\n|EngagementService must receive Salesforce webhook notifications when Cases are updated/resolved by support agents\n\n|TR-CS-014\n|EngagementService must trigger Braze push notifications to customers when Cases are updated/resolved (via Salesforce webhook → EngagementService → Braze)\n\n|TR-CS-015\n|ProfileService and EngagementService must conform to existing Salesforce configuration and API contracts (Conformist pattern)\n\n|TR-CS-016\n|All changes must be communicated using event-driven architecture via Event Bus (using existing AWS infrastructure: SNS+SQS/EventBridge/Kinesis)\n\n|TR-CS-017\n|Mobile App feedback submission success rate must exceed 99.5% (including async Case creation completion)\n\n|TR-CS-018\n|Contact migration must achieve 100% validation pass rate (zero data loss)\n\n|TR-CS-019\n|D365 Customer Engagement must be fully decommissioned within 90 days post-cutover\n\n|===\n\n== Technical Architecture\n\n=== Technical Capability Requirements\n\n==== Requirements Traceability\n\n[width=\"100%\",cols=\"15%,50%,35%\",options=\"header\",]\n|===\n|Requirement ID |Requirement Summary |Architectural Building Blocks\n\n|TR-CS-001\n|Every Mobile App user must have Salesforce Contact record\n|ABB-CS-001 (ProfileService), ABB-CS-004 (Salesforce), ABB-CS-007 (Contact Migration Tool)\n\n|TR-CS-002\n|ProfileService JIT Contact reconciliation via upsert by email\n|ABB-CS-001 (ProfileService), ABB-CS-004 (Salesforce)\n\n|TR-CS-003\n|ProfileService returns Salesforce Contact ID to Mobile App\n|ABB-CS-001 (ProfileService), ABB-CS-006 (Mobile App)\n\n|TR-CS-004\n|Mobile App supports feedback submission with structured fields\n|ABB-CS-006 (Mobile App), ABB-CS-002 (EngagementService)\n\n|TR-CS-005\n|EngagementService creates Salesforce Cases asynchronously\n|ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus), ABB-CS-004 (Salesforce)\n\n|TR-CS-006\n|EngagementService immediate acknowledgment to Mobile App\n|ABB-CS-002 (EngagementService), ABB-CS-006 (Mobile App)\n\n|TR-CS-007\n|EngagementService sends push notification via Braze on Case creation\n|ABB-CS-002 (EngagementService), ABB-CS-005 (Braze)\n\n|TR-CS-008\n|EngagementService retry logic with exponential backoff and DLQ\n|ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus)\n\n|TR-CS-009\n|Salesforce is System of Record for Contact and Case data\n|ABB-CS-004 (Salesforce), ABB-CS-001 (ProfileService - stateless), ABB-CS-002 (EngagementService - stateless)\n\n|TR-CS-010\n|Contact migration before Mobile App cutover\n|ABB-CS-007 (Contact Migration Tool), ABB-CS-004 (Salesforce)\n\n|TR-CS-011\n|No Case migration from D365 CE (fresh start)\n|ABB-CS-004 (Salesforce) - no migration tooling required\n\n|TR-CS-012\n|EngagementService publishes domain events to Event Bus\n|ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus)\n\n|TR-CS-013\n|EngagementService receives Salesforce webhook notifications\n|ABB-CS-002 (EngagementService), ABB-CS-004 (Salesforce)\n\n|TR-CS-014\n|EngagementService triggers Braze notifications on Case updates\n|ABB-CS-002 (EngagementService), ABB-CS-004 (Salesforce), ABB-CS-005 (Braze)\n\n|TR-CS-015\n|ProfileService and EngagementService conform to Salesforce config\n|ABB-CS-001 (ProfileService), ABB-CS-002 (EngagementService), ABB-CS-004 (Salesforce)\n\n|TR-CS-016\n|Event-driven architecture via Event Bus\n|ABB-CS-003 (Event Bus), ABB-CS-002 (EngagementService)\n\n|TR-CS-017\n|Mobile App feedback submission success rate > 99.5%\n|ABB-CS-006 (Mobile App), ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus), ABB-CS-004 (Salesforce)\n\n|TR-CS-018\n|Contact migration 100% validation pass rate\n|ABB-CS-007 (Contact Migration Tool), ABB-CS-004 (Salesforce)\n\n|TR-CS-019\n|D365 CE decommissioned within 90 days post-cutover\n|All ABBs (replacement system operational)\n\n|===\n\n=== Service Catalogues\n\n==== Application Portfolio Catalogue\n\n[width=\"100%\",cols=\"20%,15%,15%,15%,35%\",options=\"header\",]\n|===\n|Application |Lifecycle State |Owner |Hosting Platform |Description\n\n|*ProfileService*\n|NEW\n|OTR Platform Team\n|AWS (TBD: Lambda/ECS/EKS)\n|JIT Contact reconciliation with Salesforce, returns Salesforce Contact ID, foundation for Flybuys integration\n\n|*EngagementService*\n|NEW\n|OTR Platform Team\n|AWS (TBD: Lambda/ECS/EKS)\n|Customer feedback submission facade, ACL for Salesforce Case creation, Braze integration for all outbound communications (push, email, SMS), webhook receiver\n\n|*Mobile App (iOS)*\n|ACTIVE (UPDATE)\n|OTR Mobile Team\n|Apple App Store\n|iOS native app with feedback form, integrate with ProfileService and EngagementService APIs\n\n|*Mobile App (Android)*\n|ACTIVE (UPDATE)\n|OTR Mobile Team\n|Google Play Store\n|Android native app with feedback form, integrate with ProfileService and EngagementService APIs\n\n|*Salesforce Service Cloud*\n|ACTIVE (EXPAND)\n|Viva Energy Salesforce Admin Team\n|Salesforce (SaaS)\n|Shared Viva Energy instance, System of Record for Contact and Case data, adding OTR digital customer support\n\n|*Braze*\n|ACTIVE (EXTEND)\n|OTR Marketing Team\n|Braze (SaaS)\n|Marketing automation platform, EngagementService triggers push notifications for Case updates\n\n|*D365 Customer Engagement*\n|RETIRE\n|OTR Support Team\n|Microsoft Azure (SaaS)\n|Legacy customer support platform, decommissioned within 90 days post-cutover\n\n|*App-Specific Customer Database*\n|RETIRE\n|OTR Platform Team\n|AWS (RDS/DynamoDB)\n|Legacy customer contact storage, one-time migration to Salesforce, then deprecated\n\n|*Event Bus*\n|NEW\n|OTR Platform Team\n|AWS (SNS+SQS/EventBridge/Kinesis)\n|Domain event publishing infrastructure for bounded context integration\n\n|*Contact Migration Tool*\n|TEMPORARY\n|OTR Platform Team\n|AWS (Script/Lambda)\n|One-time migration app database → Salesforce with upsert logic, retired after migration complete\n\n|===\n\n==== Technology Capability Requirements\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Technology Capability |Implementation Technology (TBD in detailed design) |Requirements\n\n|*Microservice Hosting*\n|AWS Lambda / ECS / EKS\n|Host ProfileService and EngagementService with auto-scaling, high availability, monitoring\n\n|*API Gateway*\n|AWS API Gateway / Application Load Balancer\n|REST API routing, authentication, rate limiting, request validation for ProfileService and EngagementService\n\n|*Event Bus*\n|AWS SNS+SQS / EventBridge / Kinesis\n|Domain event publishing, async message processing, retry logic, dead letter queue\n\n|*Salesforce Integration*\n|Salesforce REST API / SOAP API\n|Contact CRUD operations, Case creation, webhook notifications, OAuth 2.0 authentication\n\n|*Braze Integration*\n|Braze REST API / SDK\n|Push notification campaign triggers, customer profile reconciliation\n\n|*Authentication & Authorisation*\n|Microsoft Entra External ID / AWS Cognito\n|Mobile App user authentication, API authorisation, JWT token validation\n\n|*Observability & Monitoring*\n|AWS CloudWatch / Datadog / New Relic\n|Application metrics, logs, traces, dashboards, alerting (feedback submission rate, queue depth, API errors)\n\n|*Secret Management*\n|AWS Secrets Manager / Parameter Store\n|Salesforce credentials, Braze API keys, OAuth tokens, encryption keys\n\n|*Database (Migration Tool)*\n|AWS RDS / DynamoDB (read-only access)\n|Contact migration from app-specific database\n\n|*CI/CD Pipeline*\n|GitHub Actions / AWS CodePipeline\n|Automated build, test, deployment for ProfileService, EngagementService, Mobile App\n\n|*Infrastructure as Code*\n|Terraform / AWS CloudFormation / CDK\n|Declarative infrastructure provisioning for Event Bus, microservices, monitoring\n\n|*API Documentation*\n|OpenAPI / Swagger\n|ProfileService and EngagementService API specifications for Mobile App integration\n\n|===\n\n==== Feature Flag Register\n\n*Note*: Per ADR-CS-006 (big bang cutover, not phased rollout), feature flags are minimal and used primarily for emergency rollback/kill switches.\n\n[width=\"100%\",cols=\"20%,15%,35%,30%\",options=\"header\",]\n|===\n|Feature Flag |Default State |Purpose |Rollback Scenario\n\n|*enable_salesforce_feedback_submission*\n|OFF (pre-cutover), ON (post-cutover)\n|Enable/disable feedback submission to EngagementService → Salesforce (kill switch for emergency rollback to D365 CE)\n|Feedback submission success rate < 95%, Salesforce API failures, critical bugs - revert to D365 CE integration\n\n|*enable_async_case_creation*\n|ON\n|Enable/disable async Case creation via Event Bus (fallback to synchronous processing if Event Bus issues)\n|Event Bus infrastructure failures, queue backlog unmanageable - temporary synchronous processing\n\n|*enable_braze_notifications*\n|ON\n|Enable/disable Braze push notifications for Case updates (degrade gracefully if Braze integration fails)\n|Braze API failures, notification delivery rate < 80% - disable notifications temporarily\n\n|*enable_jit_contact_reconciliation*\n|ON\n|Enable/disable ProfileService JIT Contact reconciliation (fallback to cached Contact IDs if Salesforce unavailable)\n|Salesforce API downtime, Contact reconciliation failures > 5% - use cached Contact IDs temporarily\n\n|*enable_salesforce_webhook_processing*\n|ON\n|Enable/disable Salesforce webhook processing for Case updates (fallback to polling if webhook failures)\n|Webhook delivery failures, authentication issues - temporary polling fallback\n\n|===\n\n*Feature Flag Management*:\n\n* Feature flags managed via AWS AppConfig / LaunchDarkly / custom feature flag service (TBD in detailed design)\n* Mobile App feature flags controlled server-side (no app release required for flag changes)\n* Backend service feature flags configured via environment variables / configuration service\n* Feature flag changes logged and audited (who changed, when, reason)\n* Post-cutover monitoring: Gradual removal of feature flags once system stability confirmed (30-60 days)\n\n==== Data Entity Catalogue\n\n[width=\"100%\",cols=\"20%,15%,35%,30%\",options=\"header\",]\n|===\n|Data Entity |System of Record |Key Attributes |Lifecycle\n\n|*Contact*\n|Salesforce Service Cloud\n|• Contact ID (Salesforce 15/18-char ID) +\n• Email (primary matching key) +\n• First Name, Last Name +\n• Phone Number +\n• Viva Consumer ID (VCI) +\n• Account (Viva Energy customer account) +\n• Record Type (OTR Digital vs other channels)\n|Created: ProfileService JIT reconciliation or Contact Migration Tool +\nUpdated: ProfileService JIT upsert (email changes), Salesforce (manual updates by support agents) +\nDeleted: Salesforce retention policy (GDPR/compliance)\n\n|*Case*\n|Salesforce Service Cloud\n|• Case Number (Salesforce auto-generated) +\n• Contact ID (reference to Contact) +\n• Subject (derived from Category) +\n• Description (Free Text Message) +\n• Category (App, Service, Order, Rewards, Refund, Delete Account) +\n• Store Name (OTR location) +\n• Time of Visit +\n• Status (New, In Progress, Resolved, Closed) +\n• Priority, Origin (Mobile App) +\n• Owner (support agent/queue)\n|Created: EngagementService async Case creation +\nUpdated: Support agents (Salesforce UI), EngagementService (webhook processing) +\nDeleted: Salesforce retention policy (archive after X years)\n\n|*Feedback Submission (transient)*\n|None (not persisted)\n|• Salesforce Contact ID +\n• Category +\n• Store Name +\n• Time of Visit +\n• Contact Phone Number +\n• Free Text Message\n|Created: Mobile App user submission +\nProcessed: EngagementService publishes to Event Bus, Case created in Salesforce +\nNot persisted in ProfileService/EngagementService (stateless)\n\n|*Domain Events*\n|Event Bus (ephemeral)\n|**SupportCaseCreated**: +\n• Case Number, Contact ID, Category, Timestamp +\n**SupportCaseUpdated**: +\n• Case Number, Status, Updated By, Timestamp +\n**SupportCaseResolved**: +\n• Case Number, Resolution, Resolved By, Timestamp +\n**CustomerFeedbackSubmitted**: +\n• Contact ID, Category, Timestamp\n|Published: EngagementService +\nConsumed: Other bounded contexts (future), Braze notification triggers +\nRetention: Short-lived (minutes to hours), not persisted for event sourcing\n\n|*Braze Customer Profile*\n|Braze\n|• External User ID (VCI or Email) +\n• Push Notification Tokens (iOS/Android) +\n• Notification Preferences +\n• Campaign Engagement History\n|Created/Updated: EngagementService on Case creation/update +\nManaged: Braze (external SaaS)\n\n|===\n\n*Data Migration Entities*:\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Source Entity |Target Entity |Migration Strategy\n\n|*App Database Contact*\n|Salesforce Contact\n|One-time migration via Contact Migration Tool: +\n• Upsert by email (primary), phone (secondary), VCI (tertiary) +\n• Map: Email → Email, Name → First/Last Name, Phone → Phone, VCI → External ID +\n• Validation: 100% data integrity check, reconciliation report\n\n|*D365 CE Case*\n|Not migrated\n|ADR-CS-005: No Case migration (fresh start in Salesforce) +\nD365 CE Cases archived separately for compliance if needed\n\n|===\n\n==== Data Quality & Validation\n\n*Contact Migration Validation Rules*:\n\n* Email format validation (RFC 5322 compliance)\n* Phone number format validation (E.164 international format)\n* VCI format validation (alphanumeric, length constraints)\n* Duplicate detection: Flag potential duplicates for manual review (same email/phone combination)\n* Mandatory fields: Email (required), First Name, Last Name (required for Salesforce Contact)\n\n*Case Creation Validation Rules*:\n\n* Contact ID must exist in Salesforce (validated by EngagementService before Case creation)\n* Category must be one of: App, Service, Order, Rewards, Refund, Delete Account\n* Free Text Message maximum length: 32,000 characters (Salesforce Case Description limit)\n* Store Name validated against OTR location master data (optional - warn if not found)\n\n<<<\n== Solution Building Blocks\n\nThis section defines the specific technology products, configurations, and implementation details for each Solution Building Block (SBB).\n\n=== Technology Portfolio Catalogue\n\n[width=\"100%\",cols=\"10%,20%,25%,25%,20%\",options=\"header\",]\n|===\n|SBB ID |Component |Technology Product |Version/Configuration |Deployment Platform\n\n|SBB-CS-001\n|ProfileService Microservice\n|.NET 8 / Node.js 20 LTS\n|RESTful API, containerised\n|AWS ECS Fargate / Lambda\n\n|SBB-CS-002\n|EngagementService Microservice\n|.NET 8 / Node.js 20 LTS\n|RESTful API, containerised, async workers\n|AWS ECS Fargate / Lambda\n\n|SBB-CS-003\n|Event Bus\n|AWS SNS + SQS / EventBridge\n|Standard queues, FIFO for ordering\n|AWS (managed service)\n\n|SBB-CS-004\n|API Gateway\n|AWS API Gateway / ALB\n|REST API, JWT validation\n|AWS (managed service)\n\n|SBB-CS-005\n|Salesforce Integration Layer\n|Salesforce REST API Client\n|OAuth 2.0 JWT bearer flow\n|Embedded in SBB-CS-001/002\n\n|SBB-CS-006\n|Braze Integration Layer\n|Braze REST API SDK\n|API key authentication\n|Embedded in SBB-CS-002\n\n|SBB-CS-007\n|Contact Migration Tool\n|Python 3.11 / .NET 8\n|One-time batch script\n|AWS Lambda / EC2\n\n|SBB-CS-008\n|Application Monitoring\n|AWS CloudWatch / Datadog\n|Metrics, logs, traces, dashboards\n|AWS / SaaS\n\n|SBB-CS-009\n|Secret Management\n|AWS Secrets Manager\n|KMS encryption\n|AWS (managed service)\n\n|SBB-CS-010\n|Mobile App (iOS)\n|SwiftUI, Kotlin Multiplatform\n|iOS 15+\n|Apple App Store\n\n|SBB-CS-011\n|Mobile App (Android)\n|Jetpack Compose, Kotlin Multiplatform\n|Android 8+\n|Google Play Store\n\n|SBB-CS-012\n|Feature Flag Service\n|AWS AppConfig / LaunchDarkly\n|Server-side flags, real-time updates\n|AWS / SaaS\n\n|===\n\n<<<\n== Data Architecture\n\nThis section defines the physical data models, event schemas, and API request/response formats.\n\n=== Domain Event Schemas\n\nAll domain events follow the https://cloudevents.io/[CloudEvents 1.0] specification for consistency and interoperability.\n\n*Event Schema Specifications*: See // TODO: Add to Antora - specifications/events/engagement-events.json[Engagement Service Event Schemas] for complete JSON schemas and examples.\n\n==== Event Catalogue\n\n[width=\"100%\",cols=\"30%,20%,50%\",options=\"header\",]\n|===\n|Event Type |Publisher |Description\n\n|`SupportCaseCreated`\n|EngagementService\n|Published when EngagementService successfully creates a Case in Salesforce after async processing\n\n|`SupportCaseUpdated`\n|EngagementService (via Salesforce webhook)\n|Published when a support agent updates a Case in Salesforce (status, priority, comment changes)\n\n|`SupportCaseResolved`\n|EngagementService (via Salesforce webhook)\n|Published when a support agent resolves/closes a Case in Salesforce\n\n|`CustomerFeedbackSubmitted`\n|EngagementService\n|Published when customer submits feedback via Mobile App (before async Case creation)\n\n|===\n\n*Event Format*: All events use CloudEvents 1.0 envelope with event-specific payload in the `data` field.\n\n*Schema Location*: `specifications/events/engagement-events.json`\n\n=== API Request/Response Schemas\n\n==== ProfileService: GET /profile/contact-id\n\n*Response* (200 OK):\n[source,json]\n----\n{\n  \"contactId\": \"0034X00000ABCDEFG\",\n  \"email\": \"customer@example.com\",\n  \"firstName\": \"John\",\n  \"lastName\": \"Smith\"\n}\n----\n\n==== EngagementService: POST /feedback\n\n*Request*:\n[source,json]\n----\n{\n  \"contactId\": \"0034X00000ABCDEFG\",\n  \"category\": \"App\",\n  \"storeName\": \"OTR Adelaide\",\n  \"timeOfVisit\": \"2026-01-07T12:00:00Z\",\n  \"contactPhoneNumber\": \"+61412345678\",\n  \"message\": \"App crashed when submitting feedback\"\n}\n----\n\n*Response* (202 Accepted):\n[source,json]\n----\n{\n  \"feedbackId\": \"fb-2026-01-07-12345\",\n  \"status\": \"submitted\",\n  \"message\": \"Your feedback has been submitted!\"\n}\n----\n\n=== Salesforce Field Mappings\n\n==== Case Object Mapping\n\n[width=\"100%\",cols=\"25%,25%,25%,25%\",options=\"header\",]\n|===\n|OTR Field |Salesforce Field |Data Type |Notes\n\n|Category\n|Feedback_Category__c\n|Picklist\n|App, Service, Order, Rewards, Refund, Delete Account\n\n|Store Name\n|Store_Name__c\n|String (255)\n|OTR location name\n\n|Time of Visit\n|Time_of_Visit__c\n|DateTime\n|When customer visited store\n\n|Free Text Message\n|Description\n|Long Text (32,000)\n|Customer feedback message\n\n|===\n\n<<<\n=== Baseline Architecture\n\n==== Existing System Components\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Component |Current State |Status\n\n|*D365 Customer Engagement*\n|Customer support platform for OTR digital customers (Mobile App, Web), handles feedback submission and case management\n|**DEPRECATED** - Being replaced by Salesforce Service Cloud\n\n|*App-Specific Customer Database*\n|Stores customer contact data for Mobile App users, separate from Viva Energy systems\n|**MIGRATING** - One-time migration to Salesforce, then deprecated\n\n|*Mobile App*\n|iOS/Android native apps with feedback submission form including Category, Store Name, Time of Visit, Contact Phone Number, and Free Text Message fields\n|**REQUIRES UPDATE** - Integrate with ProfileService and EngagementService APIs (feedback form UI already complete)\n\n|*Salesforce Service Cloud*\n|Shared Viva Energy instance handling customer support for fuel wholesale, Shell Card customers, other retail channels\n|**EXPANDING** - Adding OTR digital customer support Cases and Contacts\n\n|*Existing AWS Infrastructure*\n|SNS+SQS / EventBridge / Kinesis available for event-driven architecture\n|**REUSING** - Event Bus implementation leverages existing infrastructure\n\n|===\n\n==== Integration Architecture\n\n*Current state:*\n\n* Mobile App → D365 Customer Engagement (direct integration)\n* App-specific customer database → standalone (no Salesforce integration)\n* No event-driven architecture (synchronous, tightly coupled)\n* No Anti-Corruption Layer protecting digital channels\n* Viva Energy support teams use Salesforce, OTR digital support uses D365 CE (fragmented)\n\n==== Technical Debt\n\n*No longer relevant* - D365 CE being deprecated, not documenting technical debt of system being retired.\n\n*New technical debt introduced by this migration:*\n\n* Salesforce field mapping TBD (requires coordination with Viva Energy Salesforce admin team)\n* Data isolation strategy TBD (Record Types, custom fields, queues - multi-tenant governance)\n* Salesforce webhook mechanism TBD (Outbound Messages vs Platform Events vs Process Builder)\n* Expected feedback volume unknown (gathering data for rate limit planning)\n\n=== Gap Analysis\n\n==== Missing Capabilities\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Missing Capability |Description\n\n|*ProfileService bounded context*\n|No existing service for Contact reconciliation with Salesforce - requires new microservice implementing JIT upsert by email, returning Salesforce Contact ID\n\n|*EngagementService bounded context*\n|No existing service for customer feedback facade - requires new microservice implementing Anti-Corruption Layer for Salesforce Case creation, Braze integration, async processing via Event Bus\n\n|*Event Bus domain event pattern*\n|No existing domain event publishing infrastructure - requires implementing event-driven architecture pattern using existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis)\n\n|*Async Case creation workflow*\n|Current D365 CE integration is synchronous - requires implementing async processing with retry logic, exponential backoff, dead letter queue\n\n|*Salesforce webhook integration*\n|No existing capability to receive Salesforce notifications - requires implementing webhook receiver in EngagementService for Case update notifications\n\n|*Braze push notification orchestration*\n|No existing integration for Case-related push notifications - requires implementing Braze campaign triggers from EngagementService\n\n|*Contact migration tooling*\n|No existing tooling for app database → Salesforce Contact migration with upsert logic (match by email/phone/VCI)\n\n|*Feedback form enhancements*\n|Mobile App feedback form lacks structured fields (Category, Store Name, Time of Visit, Contact Phone Number) - requires UI updates\n\n|===\n\n==== Missing Bounded Contexts\n\n[width=\"100%\",cols=\"30%,30%,40%\",options=\"header\",]\n|===\n|Bounded Context |Responsibilities |Implementation Status\n\n|*link:../bounded_context/profile.adoc[ProfileService]*\n|JIT Contact reconciliation with Salesforce (upsert by email), return Salesforce Contact ID to digital channels, foundation for future Flybuys partner linking\n|**NEW** - First bounded context implementation\n\n|*link:../bounded_context/engagement.adoc[EngagementService]*\n|Customer feedback submission facade, Anti-Corruption Layer for Salesforce Case creation, Braze integration for push notifications, async Case processing, webhook receiver for Case updates\n|**NEW** - First bounded context implementation\n\n|===\n\n==== Missing Integration Patterns\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Integration Pattern |Description\n\n|*Anti-Corruption Layer (ACL)*\n|EngagementService → Salesforce Service Cloud - protects digital channels from Salesforce API changes, translates between OTR domain language and Salesforce\n\n|*Conformist*\n|ProfileService/EngagementService → Salesforce - conform to existing Salesforce configuration and API contracts (shared Viva Energy instance)\n\n|*Event-Driven Architecture (OHS+PL)*\n|Event Bus publishing domain events (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`) for loose coupling between bounded contexts\n\n|*Just-In-Time (JIT) Integration*\n|ProfileService → Salesforce Contact reconciliation on-demand (no pre-sync)\n\n|*Async Processing*\n|EngagementService Case creation via Event Bus with retry, exponential backoff, dead letter queue\n\n|===\n\n=== Target State Architecture\n\n==== Architectural Building Blocks (ABB)\n\n[width=\"100%\",cols=\"20%,25%,30%,25%\",options=\"header\",]\n|===\n|ABB ID |Bounded Context |Responsibilities |Technology (TBD in Solution Architecture)\n\n|ABB-CS-001\n|*link:../bounded_context/profile.adoc[ProfileService]*\n|JIT Contact reconciliation with Salesforce (upsert by email), return Salesforce Contact ID, foundation for Flybuys partner linking\n|Microservice (.NET/Node.js), REST API, Salesforce REST API client\n\n|ABB-CS-002\n|*link:../bounded_context/engagement.adoc[EngagementService]*\n|Customer feedback submission facade, ACL for Salesforce Case creation, Braze integration, async processing, webhook receiver\n|Microservice (.NET/Node.js), REST API, Event Bus publisher/subscriber, Salesforce webhook receiver\n\n|ABB-CS-003\n|*Event Bus*\n|Domain event publishing infrastructure (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`)\n|AWS SNS+SQS / EventBridge / Kinesis\n\n|ABB-CS-004\n|*Salesforce Service Cloud*\n|System of Record for Contact and Case data (shared Viva Energy instance)\n|Salesforce Service Cloud (external SaaS)\n\n|ABB-CS-005\n|*Braze*\n|Marketing automation platform for push notifications\n|Braze (external SaaS) - existing integration\n\n|ABB-CS-006\n|*Mobile App*\n|iOS/Android native apps with enhanced feedback form (Category, Store Name, Time of Visit, Contact Phone Number, Free Text Message)\n|Kotlin Multiplatform, SwiftUI, Jetpack Compose\n\n|ABB-CS-007\n|*Contact Migration Tool*\n|One-time migration app database → Salesforce with upsert logic (match by email/phone/VCI)\n|Script/tool (.NET/Python/Node.js)\n\n|===\n\n==== Integration Architecture\n\n===== Integration Flows\n\n*Customer Feedback Submission (Async):*\n\n1. *Mobile App* → ProfileService: Authenticate user, get Salesforce Contact ID (JIT reconciliation)\n2. *Mobile App* → EngagementService: Submit feedback (POST /feedback with Contact ID, Category, Store Name, Time of Visit, Phone, Message)\n3. *EngagementService* → Mobile App: Immediate acknowledgment (\"Feedback submitted\")\n4. *EngagementService* → Event Bus: Publish work item for async Case creation\n5. *Background Worker* (EngagementService) → Salesforce: Create Case via REST API\n6. *Success*: EngagementService → Event Bus: Publish `SupportCaseCreated` event\n7. *EngagementService* → Braze: Trigger push notification campaign (\"Your feedback has been received, Case #12345\")\n8. *Failure*: Retry with exponential backoff → Dead Letter Queue → Ops team alert\n\n*Case Update Notification (Bidirectional):*\n\n1. *Support Agent* updates/resolves Case in Salesforce\n2. *Salesforce* → EngagementService: Webhook notification (Case updated)\n3. *EngagementService* → Event Bus: Publish `SupportCaseUpdated` or `SupportCaseResolved` event\n4. *EngagementService* → Braze: Trigger push notification campaign (\"Your case has been resolved\")\n\n*Contact Reconciliation (JIT):*\n\n1. *Mobile App user* authenticates\n2. *Mobile App* → ProfileService: GET /profile/contact-id\n3. *ProfileService* → Salesforce: Query Contact by email\n4. *Match found*: Return existing Salesforce Contact ID\n5. *No match*: Create new Contact in Salesforce, return new Contact ID\n6. *ProfileService* → Mobile App: Return Salesforce Contact ID (cached by Mobile App)\n\n===== System of Record Boundaries\n\n[width=\"100%\",cols=\"30%,35%,35%\",options=\"header\",]\n|===\n|Data Entity |System of Record |Rationale\n\n|*Contact*\n|Salesforce Service Cloud\n|Shared Viva Energy instance, unified customer profile across all channels (digital, wholesale, Shell Card, retail)\n\n|*Case*\n|Salesforce Service Cloud\n|Support agents manage Cases in Salesforce, digital channels submit via EngagementService ACL\n\n|*Feedback Submission (transient)*\n|None (no persistence)\n|EngagementService processes feedback and creates Case in Salesforce, no local storage\n\n|*Domain Events*\n|Event Bus (ephemeral)\n|Events published to Event Bus, consumed by subscribers, not persisted long-term (event sourcing not in scope)\n\n|===\n\n==== Data Architecture Principles\n\n===== Aggregate Persistence\n\n*ProfileService:*\n\n* **No local aggregate persistence** - ProfileService is stateless, queries Salesforce on-demand\n* Salesforce Contact is the aggregate root (owned by Salesforce)\n* ProfileService acts as facade/translator, not system of record\n\n*EngagementService:*\n\n* **No local aggregate persistence** - EngagementService is stateless, creates Cases in Salesforce via ACL\n* Salesforce Case is the aggregate root (owned by Salesforce)\n* EngagementService maintains no local Case state (Conformist pattern - trust Salesforce as source of truth)\n* Async processing state managed via Event Bus (work items in queue, not database)\n\n===== Event Store\n\n* **Event Bus** (SNS+SQS/EventBridge/Kinesis) handles domain event publishing\n* Events are **ephemeral** (consumed and discarded, not persisted for event sourcing)\n* No Event Store implementation in this architecture (future enhancement if needed)\n* Event schema versioning TBD in Solution Architecture\n\n\n=== Architecture Decisions\n\n==== ADR-CS-001: Consolidate onto Salesforce Service Cloud (not build custom solution)\n\n*Status*: Accepted\n\n*Context*:\n\n* D365 Customer Engagement not working well for digital customer support\n* Viva Energy already uses Salesforce Service Cloud for fuel wholesale, Shell Card, other retail channels\n* Post-merger opportunity to consolidate onto single platform\n* Alternative: Build custom support platform or use different SaaS\n\n*Decision*:\n\nConsolidate OTR digital customer support onto Salesforce Service Cloud (shared Viva Energy instance).\n\n*Rationale*:\n\n* **Unified customer view**: Support agents see all interactions across channels (digital, wholesale, Shell Card, retail)\n* **Platform consolidation**: Single support platform reduces operational overhead and costs\n* **Proven solution**: Salesforce Service Cloud is established, feature-rich, well-supported\n* **Post-merger alignment**: Strategic decision to standardize on Viva Energy platforms\n* **Avoid custom development**: Building custom support platform would be costly and high-risk\n\n*Consequences*:\n\n* Unified customer support across Viva Energy Group\n* Reduced operational complexity (single platform vs two)\n* Leverage Salesforce capabilities (case routing, knowledge base, AI, omnichannel)\n* ⚠️ Conformist pattern required (shared instance, conform to existing configuration)\n* ⚠️ Multi-tenant governance needed (data isolation, security, queues)\n* ❌ Less control over platform evolution (SaaS vendor, shared instance)\n\n==== ADR-CS-002: Implement ProfileService and EngagementService as first DDD bounded contexts\n\n*Status*: Accepted\n\n*Context*:\n\n* OTR target architecture uses Domain-Driven Design with bounded contexts\n* This migration is opportunity to establish first implementation\n* Alternative: Direct Mobile App → Salesforce integration (no bounded contexts)\n* Alternative: Single monolithic service for all customer-facing APIs\n\n*Decision*:\n\nImplement ProfileService and EngagementService as separate bounded contexts following DDD strategic patterns.\n\n*Rationale*:\n\n* **Foundation for target architecture**: First implementation of DDD pattern for future bounded contexts (Flybuys, LocationService, PaymentService)\n* **Separation of concerns**: ProfileService handles identity/Contact reconciliation, EngagementService handles support/feedback (different responsibilities, different change rates)\n* **Anti-Corruption Layer**: EngagementService protects digital channels from Salesforce API changes\n* **Reusability**: ProfileService Contact reconciliation reused for Flybuys integration\n* **Event-driven architecture**: Establishes pattern for loose coupling between bounded contexts\n\n*Consequences*:\n\n* Establishes DDD architecture foundation for OTR\n* Reusable ProfileService for Flybuys and future integrations\n* Digital channels protected from Salesforce API changes (ACL)\n* Clear bounded context boundaries and responsibilities\n* ⚠️ Increased initial complexity (two new microservices vs direct integration)\n* ⚠️ Requires Event Bus infrastructure implementation\n* ⚠️ Team must learn DDD patterns and bounded context design\n\n==== ADR-CS-003: Async Case creation via Event Bus (not synchronous)\n\n*Status*: Accepted\n\n*Context*:\n\n* Current D365 CE integration is synchronous (user waits for Case creation)\n* Alternative: Keep synchronous integration (Mobile App → EngagementService → Salesforce synchronously)\n* Salesforce API may experience downtime or latency\n\n*Decision*:\n\nImplement async Case creation via Event Bus with immediate user acknowledgment, retry logic, exponential backoff, and dead letter queue.\n\n*Rationale*:\n\n* **Non-blocking user experience**: User gets immediate \"Feedback submitted\" confirmation, not waiting for Salesforce API\n* **Resilience**: If Salesforce is down, feedback still accepted, Case created when Salesforce recovers\n* **Retry logic**: Automatic retry with exponential backoff handles transient failures\n* **Operational visibility**: Dead letter queue alerts ops team to persistent failures\n* **Scalability**: Queue buffering handles traffic spikes\n\n*Consequences*:\n\n* Better user experience (no waiting for Salesforce API)\n* Resilient to Salesforce downtime (queue buffers work)\n* Automatic retry reduces manual intervention\n* Queue depth monitoring provides operational visibility\n* ⚠️ Eventual consistency (user gets success notification after Case created, not immediately)\n* ⚠️ Increased complexity (Event Bus, background workers, retry logic, DLQ)\n* ⚠️ Requires monitoring and alerting for DLQ\n\n==== ADR-CS-004: ProfileService uses email as primary matching key (not VCI)\n\n*Status*: Accepted\n\n*Context*:\n\n* ProfileService needs to reconcile Mobile App users as Salesforce Contacts\n* Alternative matching keys: VCI (Viva Consumer ID), email, phone, Salesforce External ID\n* Email changes are rare but possible\n\n*Decision*:\n\nUse email address as primary matching key for Contact reconciliation (JIT upsert by email).\n\n*Rationale*:\n\n* **Availability**: Email always available for authenticated users\n* **Uniqueness**: Email is unique identifier in Salesforce and Mobile App\n* **Salesforce standard**: Salesforce Contact uses email as standard lookup field\n* **Simplicity**: Single matching key simplifies upsert logic\n* **Edge case acceptable**: Email changes are rare, manual cleanup acceptable\n\n*Consequences*:\n\n* Simple upsert logic (query by email, create if not found)\n* Leverages Salesforce standard email field\n* Email always available from authentication\n* ⚠️ Email changes create duplicate Contacts (rare edge case, manual cleanup)\n* ⚠️ Future enhancement: Add VCI as Salesforce External ID for stable matching\n\n==== ADR-CS-005: No Case migration from D365 CE (fresh start)\n\n*Status*: Accepted\n\n*Context*:\n\n* D365 CE contains historical customer support Cases\n* Alternative: Migrate historical Cases to Salesforce (preserve support history)\n* Alternative: Archive D365 CE Cases separately (read-only access)\n\n*Decision*:\n\nDo not migrate historical Cases from D365 CE to Salesforce. Start fresh in Salesforce.\n\n*Rationale*:\n\n* **Limited value**: Historical D365 CE Cases not critical for future support\n* **Data quality**: D365 CE Case data may be inconsistent or incomplete\n* **Complexity**: Case migration requires mapping D365 CE schema to Salesforce, data transformation, validation\n* **Cost-benefit**: Migration effort outweighs value of historical data\n* **Archive option**: D365 CE Cases can be archived separately if needed (read-only access for auditing)\n\n*Consequences*:\n\n* Simpler migration (Contacts only, no Case migration)\n* Faster time to value (no Case migration delay)\n* Clean start in Salesforce (no legacy data quality issues)\n* ⚠️ Historical Cases not visible in Salesforce (support agents can't see old Cases)\n* ⚠️ D365 CE must remain accessible temporarily for historical Case lookups (if needed)\n* ❌ Loss of historical Case insights (reporting, analytics on old Cases)\n\n==== ADR-CS-006: Big bang cutover (not phased rollout)\n\n*Status*: Accepted\n\n*Context*:\n\n* Alternative: Phased rollout with feature flags (pilot users first, gradual enablement)\n* Alternative: Parallel run (submit to both D365 CE and Salesforce temporarily)\n* Flybuys integration uses phased rollout (AS-1, AS-2, AS-3 architecture states)\n\n*Decision*:\n\nBig bang cutover - migrate Contacts, deploy ProfileService and EngagementService, switch Mobile App, retire D365 CE.\n\n*Rationale*:\n\n* **Simplicity**: No parallel run complexity, no feature flag management\n* **Faster D365 CE retirement**: No extended transition period maintaining two systems\n* **Limited risk**: Customer support not mission-critical (not payment processing), rollback possible\n* **User base manageable**: OTR digital customers smaller than Flybuys integration scope\n* **Different use case**: Flybuys phased rollout manages points accrual complexity, support feedback is simpler\n\n*Consequences*:\n\n* Simpler deployment (single cutover, no AS-1/AS-2/AS-3 states)\n* Faster D365 CE retirement (no extended parallel run)\n* No feature flag complexity or pilot user management\n* ⚠️ Higher cutover risk (all users switch at once)\n* ⚠️ Requires comprehensive testing before cutover\n* ⚠️ Rollback plan required (revert to D365 CE if critical issues)\n\n==== ADR-CS-007: EngagementService receives Salesforce webhooks for Case updates\n\n*Status*: Accepted\n\n*Context*:\n\n* Support agents update/resolve Cases in Salesforce\n* Need to notify customers of Case status changes via push notifications\n* Alternative: Poll Salesforce API for Case updates (inefficient)\n* Alternative: No customer notifications (agents contact customers directly)\n\n*Decision*:\n\nSalesforce sends webhook notifications to EngagementService when Cases are updated/resolved. EngagementService triggers Braze push notifications.\n\n*Rationale*:\n\n* **Real-time notifications**: Customer notified immediately when agent resolves Case\n* **Efficient**: Webhook push model (not polling)\n* **Event-driven**: Aligns with event-driven architecture pattern\n* **Better customer experience**: Proactive notification vs waiting for agent contact\n\n*Consequences*:\n\n* Real-time customer notifications for Case updates\n* Efficient push model (no polling overhead)\n* Bidirectional integration (Mobile App → Salesforce → Mobile App)\n* ⚠️ Salesforce webhook mechanism TBD (Outbound Messages vs Platform Events vs Process Builder)\n* ⚠️ Webhook authentication and security required\n* ⚠️ EngagementService must handle webhook retries and failures\n\n<<<\n== Interface Specifications\n\nThis section provides references to the complete API specifications and event catalogue for ProfileService and EngagementService.\n\n=== REST API Specifications\n\nComplete OpenAPI 3.0 specifications are maintained in the `specifications/rest/` directory:\n\n==== ProfileService API v1\n\n*Specification*: link:../../specifications/rest/profile-service-v1.yaml[profile-service-v1.yaml]\n\n*Base URL*: `https://api.otr.com.au/profile/v1`\n\n*Authentication*: Bearer token (Microsoft Entra External ID JWT)\n\n*Key Endpoints*:\n\n* `GET /contact-id` - Retrieve or create Salesforce Contact ID for authenticated user (Just-In-Time reconciliation)\n** Used by Mobile App before submitting feedback to EngagementService\n** Upserts Salesforce Contact record using email as external key\n** Returns 18-character Salesforce Contact ID with caching (15-minute TTL)\n** Performance SLA: p95 < 300ms (uncached), p95 < 50ms (cached)\n\n==== EngagementService API v1\n\n*Specification*: link:../../specifications/rest/engagement-service-v1.yaml[engagement-service-v1.yaml]\n\n*Base URL*: `https://api.otr.com.au/engagement/v1`\n\n*Authentication*: Bearer token (Microsoft Entra External ID JWT)\n\n*Key Endpoints*:\n\n* `POST /feedback` - Submit customer feedback for async Case creation in Salesforce\n** Accepts contactId, category, storeName, timeOfVisit, contactPhoneNumber, message\n** Returns 202 Accepted immediately (async Case creation in background)\n** Publishes `CustomerFeedbackSubmitted` event for analytics\n** Creates Salesforce Case via Anti-Corruption Layer with retry logic\n** Performance SLA: p95 < 200ms (feedback accepted, not Case creation)\n\n=== Domain Events (AsyncAPI)\n\nComplete CloudEvents 1.0 JSON Schema specifications are maintained in the `specifications/events/` directory:\n\n*Specification*: link:../../specifications/events/engagement-events.json[engagement-events.json]\n\n==== Event Catalogue\n\n[width=\"100%\",cols=\"30%,20%,50%\",options=\"header\",]\n|===\n|Event Type |Publisher |Consumers\n\n|`CustomerFeedbackSubmitted`\n|EngagementService\n|Future bounded contexts, analytics, sentiment analysis\n\n|`SupportCaseCreated`\n|EngagementService\n|Future bounded contexts, analytics\n\n|`SupportCaseUpdated`\n|EngagementService (via Salesforce webhook)\n|Future bounded contexts, analytics\n\n|`SupportCaseResolved`\n|EngagementService (via Salesforce webhook)\n|Future bounded contexts, analytics\n\n|===\n\n==== Event Delivery Guarantees\n\n* **At-least-once delivery**: Events may be delivered multiple times, consumers must handle idempotency\n* **Ordering**: FIFO queues guarantee ordering for events with same `contactId`\n* **Retention**: 4 days (96 hours) in Event Bus\n* **Dead Letter Queue**: Failed events after 5 retries moved to DLQ for manual intervention\n* **Format**: CloudEvents 1.0 specification with JSON payload\n\n=== API Versioning Policy\n\n==== Version Numbering\n\n* **Format**: `/v{major}` in URL path (e.g., `/profile/v1`, `/engagement/v1`)\n* **Semantic Versioning**: Major version incremented for breaking changes only\n* **Backwards Compatibility**: Minor changes (new optional fields, new endpoints) don't require version bump\n\n==== When to Version\n\n*Breaking changes requiring new major version*:\n\n- Removing or renaming fields in request/response\n- Changing field data types (e.g., string → number)\n- Changing authentication mechanism\n- Removing endpoints\n\n*Non-breaking changes not requiring version bump*:\n\n- Adding new optional fields to request/response\n- Adding new endpoints\n- Expanding enum values (e.g., adding new feedback category)\n- Improving error messages\n\n==== Parallel Version Support\n\n* Support N and N-1 versions concurrently for 6 months\n* Deprecation notice: 3 months before sunsetting old version\n* Mobile App must upgrade to new version within deprecation window\n\n<<<\n== Work Packages\n\nThis section consolidates gaps and activities into implementable work packages aligned with TOGAF Phase E requirements.\n\n=== Work Package Overview\n\n[width=\"100%\",cols=\"15%,35%,25%,25%\",options=\"header\",]\n|===\n|Work Package ID |Name |Transition State |Key Deliverables\n\n|WP-CS-001\n|ProfileService Development\n|TS-1 (Build & Test)\n|ProfileService microservice, Salesforce Contact integration, REST API\n\n|WP-CS-002\n|EngagementService Development\n|TS-1 (Build & Test)\n|EngagementService microservice, Anti-Corruption Layer, Braze integration\n\n|WP-CS-003\n|Event Bus Infrastructure\n|TS-1 (Build & Test)\n|Event Bus configuration, CloudEvents schemas, monitoring\n\n|WP-CS-004\n|Contact Migration Tooling\n|TS-1 (Build & Test)\n|Migration tool, validation scripts, reconciliation reporting\n\n|WP-CS-005\n|Mobile App Integration\n|TS-1 (Build & Test)\n|Mobile App API integration, feedback form enhancements, testing\n\n|WP-CS-006\n|Integration Testing\n|TS-1 (Build & Test)\n|Test environments, integration test suites, UAT execution\n\n|WP-CS-007\n|Salesforce Configuration\n|TS-1 (Build & Test)\n|Salesforce field mapping, data isolation, webhook configuration\n\n|WP-CS-008\n|Contact Data Migration\n|TS-2 (Contact Migration)\n|Contact migration execution, validation, reconciliation\n\n|WP-CS-009\n|Production Deployment\n|TS-3 (Cutover)\n|Production deployment, smoke testing, go-live execution\n\n|WP-CS-010\n|Post-Cutover Support\n|TS-4 (Target State)\n|Monitoring, issue resolution, D365 CE retirement\n\n|===\n\n[[wp-cs-001]]\n=== WP-CS-001: ProfileService Development\n\n==== Description\n\nBuild ProfileService bounded context microservice implementing Just-In-Time Contact reconciliation with Salesforce Service Cloud.\n\n==== Deliverables\n\n* ProfileService microservice application\n** REST API implementation (OpenAPI 3.0 specification)\n** `GET /contact-id` endpoint (Salesforce Contact reconciliation)\n** Authentication/authorization with Microsoft Entra External ID\n** Caching layer (15-minute TTL for Contact IDs)\n* Salesforce integration\n** Salesforce REST API client\n** Contact upsert by email (external key matching)\n** Error handling and retry logic\n* Unit tests (>80% code coverage)\n* Integration tests with Salesforce sandbox\n* API documentation\n* Deployment configuration (IaC - Infrastructure as Code)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* Salesforce sandbox environment provisioned\n* Microsoft Entra External ID OAuth configuration\n* Development environment setup (AWS dev account, CI/CD pipeline)\n\n*Dependent Work Packages*:\n\n* None (can start immediately after prerequisites met)\n\n==== Skills Required\n\n* Backend development (.NET Core or Node.js)\n* REST API design and implementation\n* Salesforce REST API integration\n* OAuth 2.0 / JWT authentication\n* Caching strategies (Redis/ElastiCache)\n* Unit/integration testing frameworks\n* Infrastructure as Code (Terraform/CloudFormation)\n\n==== Acceptance Criteria\n\n* All API endpoints return correct HTTP status codes per OpenAPI specification\n* Contact ID retrieval achieves p95 < 300ms (uncached), p95 < 50ms (cached)\n* Salesforce Contact upsert succeeds with 100% accuracy in sandbox testing\n* Unit test coverage > 80%\n* Integration tests pass in sandbox environment\n* API documentation generated from OpenAPI specification\n\n[[wp-cs-002]]\n=== WP-CS-002: EngagementService Development\n\n==== Description\n\nBuild EngagementService bounded context microservice implementing customer feedback submission, Anti-Corruption Layer for Salesforce Case creation, Braze integration, and webhook receiver for Case updates.\n\n==== Deliverables\n\n* EngagementService microservice application\n** REST API implementation (OpenAPI 3.0 specification)\n** `POST /feedback` endpoint (async feedback submission)\n** Authentication/authorization with Microsoft Entra External ID\n** Webhook receiver endpoint for Salesforce Case updates\n* Anti-Corruption Layer (ACL)\n** OTR domain model to Salesforce API translation\n** Category enum mapping (App/Service/Order/Rewards → Salesforce Case fields)\n** Salesforce REST API client for Case creation\n* Async processing infrastructure\n** Event Bus publisher integration\n** Background worker for Case creation\n** Retry logic with exponential backoff (5 attempts)\n** Dead Letter Queue integration\n* Braze integration\n** Braze campaign trigger API client\n** Push notification orchestration for Case updates\n* Domain event publishing\n** `CustomerFeedbackSubmitted` event publisher\n** `SupportCaseCreated` event publisher\n** `SupportCaseUpdated` event translator (Salesforce webhook → domain event)\n** `SupportCaseResolved` event translator (Salesforce webhook → domain event)\n* Unit tests (>80% code coverage)\n* Integration tests (EngagementService ↔ Salesforce, EngagementService ↔ Braze)\n* API documentation\n* Deployment configuration (IaC)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* <<wp-cs-003,WP-CS-003>> (Event Bus Infrastructure) completed\n* Salesforce sandbox environment provisioned\n* Braze API credentials and campaign templates configured\n* Microsoft Entra External ID OAuth configuration\n\n*Dependent Work Packages*:\n\n* <<wp-cs-003,WP-CS-003>> must be completed first (Event Bus required for async processing)\n* <<wp-cs-007,WP-CS-007>> (Salesforce Configuration) must be in progress (field mapping needed)\n\n==== Skills Required\n\n* Backend development (.NET Core or Node.js)\n* REST API design and implementation\n* Salesforce REST API integration\n* Event-driven architecture patterns\n* Async/background processing (queues, workers)\n* Braze API integration\n* Webhook design and security\n* OAuth 2.0 / JWT authentication\n* Domain-Driven Design (DDD) - Anti-Corruption Layer pattern\n* Unit/integration testing frameworks\n* Infrastructure as Code (Terraform/CloudFormation)\n\n==== Acceptance Criteria\n\n* Feedback submission endpoint returns 202 Accepted within p95 < 200ms\n* Async Case creation succeeds with >99.5% success rate (including retries)\n* Anti-Corruption Layer correctly maps all feedback categories to Salesforce Case fields\n* Webhook receiver processes Salesforce Case updates and publishes domain events\n* Braze push notifications sent successfully for Case updates\n* Failed Case creation moves to Dead Letter Queue after 5 retry attempts\n* Unit test coverage > 80%\n* Integration tests pass with Salesforce sandbox and Braze staging environment\n\n[[wp-cs-003]]\n=== WP-CS-003: Event Bus Infrastructure\n\n==== Description\n\nImplement Event Bus infrastructure for domain event publishing using existing AWS infrastructure (SNS+SQS, EventBridge, or Kinesis).\n\n==== Deliverables\n\n* Event Bus infrastructure configuration\n** Topic/stream provisioning (technology choice: SNS+SQS / EventBridge / Kinesis)\n** FIFO queue configuration (ordering by `contactId`)\n** Dead Letter Queue (DLQ) setup\n** Retention policy (4 days / 96 hours)\n** Access control policies (IAM roles, permissions)\n* CloudEvents 1.0 schema definitions\n** JSON Schema specifications for all domain events\n** Schema validation configuration\n** Schema registry (if using EventBridge/Kinesis)\n* Monitoring and alerting\n** CloudWatch dashboards for queue metrics\n** Alarms for DLQ depth, queue age, processing failures\n** Event Bus throughput monitoring\n* Documentation\n** Event Bus architecture diagram\n** Event publishing guidelines\n** Consumer integration guide\n* Infrastructure as Code (IaC)\n** Terraform/CloudFormation templates for all infrastructure\n\n==== Dependencies\n\n*Prerequisites*:\n\n* AWS account access (existing infrastructure)\n* Technology selection decision (SNS+SQS vs EventBridge vs Kinesis)\n* CloudEvents 1.0 schema design approval\n\n*Dependent Work Packages*:\n\n* None (foundational infrastructure, can start early)\n\n==== Skills Required\n\n* AWS messaging services (SNS, SQS, EventBridge, Kinesis)\n* Event-driven architecture patterns\n* CloudEvents specification\n* JSON Schema design\n* Infrastructure as Code (Terraform/CloudFormation)\n* AWS IAM security configuration\n* CloudWatch monitoring and alerting\n\n==== Acceptance Criteria\n\n* Event Bus infrastructure provisioned in all environments (dev, staging, production)\n* FIFO ordering validated for events with same `contactId`\n* Dead Letter Queue triggers alarms when messages arrive\n* Event retention policy enforced (4 days)\n* CloudEvents 1.0 schema validation enabled\n* Monitoring dashboards operational\n* Infrastructure fully codified (IaC)\n\n[[wp-cs-004]]\n=== WP-CS-004: Contact Migration Tooling\n\n==== Description\n\nDevelop Contact migration tool for one-time migration from app-specific database to Salesforce Service Cloud with upsert logic and validation.\n\n==== Deliverables\n\n* Contact migration tool\n** Extract Contacts from app-specific database\n** Transform to Salesforce Contact API format\n** Upsert to Salesforce using email as external key\n** Fallback matching by phone number or Viva Consumer ID\n** Batch processing with rate limiting (respect Salesforce API limits)\n** Idempotent operation (can be re-run safely)\n* Validation scripts\n** Pre-migration validation (data quality checks)\n** Post-migration validation (100% Contact reconciliation)\n** Email/phone/VCI matching accuracy report\n* Reconciliation reporting\n** Contacts created vs updated statistics\n** Failed upserts with error details\n** Matching accuracy metrics\n* Rollback capability\n** Export snapshot of Salesforce Contacts before migration\n** Rollback procedure documentation\n* Documentation\n** Migration tool user guide\n** Troubleshooting guide\n** Runbook for migration execution\n\n==== Dependencies\n\n*Prerequisites*:\n\n* <<wp-cs-001,WP-CS-001>> (ProfileService Development) completed (reuses Salesforce integration code)\n* Salesforce sandbox environment for migration testing\n* App-specific database access (read-only sufficient)\n* Salesforce production access granted\n\n*Dependent Work Packages*:\n\n* <<wp-cs-001,WP-CS-001>> provides Salesforce Contact upsert logic to reuse\n\n==== Skills Required\n\n* Database development (SQL, data extraction)\n* Salesforce REST API integration\n* Batch processing and ETL patterns\n* Data validation and reconciliation\n* Error handling and logging\n* Scripting (Python, PowerShell, or similar)\n\n==== Acceptance Criteria\n\n* Migration tool successfully migrates 100% of Contacts in sandbox with zero data loss\n* Email/phone/VCI matching accuracy > 95% in sandbox testing\n* Failed upserts captured with actionable error messages\n* Reconciliation report matches actual Salesforce Contact counts\n* Migration tool execution time acceptable for production (freezes app database for minimum time)\n* Rollback procedure validated in sandbox\n* Documentation complete and approved\n\n[[wp-cs-005]]\n=== WP-CS-005: Mobile App Integration\n\n==== Description\n\nUpdate Mobile App to integrate with ProfileService and EngagementService APIs, replacing D365 CE integration.\n\n==== Deliverables\n\n* Feedback form UI enhancements\n** Add Category dropdown (App, Service, Order, Rewards, Refund, Delete Account)\n** Add Store Name field (optional)\n** Add Time of Visit field (optional, datetime picker)\n** Add Contact Phone Number field (optional, E.164 validation)\n** Update Message field (1-2000 character limit with counter)\n* API integration (Kotlin Multiplatform shared code)\n** ProfileService client (`GET /contact-id`)\n** EngagementService client (`POST /feedback`)\n** JWT token management (Microsoft Entra External ID)\n** Error handling (network failures, API errors, validation errors)\n** Retry logic for transient failures\n* Platform-specific UI (SwiftUI for iOS, Jetpack Compose for Android)\n** Feedback form screens\n** Success/error confirmation screens\n** Loading states and progress indicators\n* Feature flag integration\n** `enable_salesforce_feedback_submission` flag\n** Fallback to D365 CE if flag disabled (during rollout)\n* Unit tests for shared business logic\n* UI tests for platform-specific screens\n* API integration tests (mocked APIs)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* <<wp-cs-001,WP-CS-001>> (ProfileService Development) completed and deployed to dev/staging\n* <<wp-cs-002,WP-CS-002>> (EngagementService Development) completed and deployed to dev/staging\n* ProfileService and EngagementService OpenAPI specifications finalized\n* Feature flag service configured\n\n*Dependent Work Packages*:\n\n* Must complete after <<wp-cs-001,WP-CS-001>> and <<wp-cs-002,WP-CS-002>> (requires API endpoints available for integration testing)\n\n==== Skills Required\n\n* Kotlin Multiplatform development\n* SwiftUI (iOS native UI)\n* Jetpack Compose (Android native UI)\n* REST API client development\n* OAuth 2.0 / JWT authentication\n* Form validation and UX design\n* Unit testing (Kotlin, Swift)\n* UI testing frameworks (XCTest, Espresso)\n\n==== Acceptance Criteria\n\n* Feedback form UI matches UX design specifications\n* All form fields validate correctly (client-side validation)\n* API integration successfully calls ProfileService and EngagementService in dev/staging\n* Error handling provides user-friendly error messages\n* Feature flag correctly toggles between Salesforce and D365 CE integration\n* Unit test coverage > 80% for shared business logic\n* UI tests pass for all feedback form workflows (happy path, error states)\n* App builds and deploys successfully to TestFlight (iOS) and Google Play Internal Testing (Android)\n\n[[wp-cs-006]]\n=== WP-CS-006: Integration Testing\n\n==== Description\n\nExecute comprehensive integration testing across all system components in non-production environments.\n\n==== Deliverables\n\n* Test environment setup\n** Salesforce sandbox configured with test data\n** ProfileService deployed to staging\n** EngagementService deployed to staging\n** Event Bus staging infrastructure\n** Braze staging environment configured\n** Mobile App TestFlight/Internal Testing builds\n* Integration test suites\n** ProfileService ↔ Salesforce (Contact upsert scenarios)\n** EngagementService ↔ Salesforce (Case creation scenarios)\n** EngagementService ↔ Braze (push notification scenarios)\n** Mobile App ↔ ProfileService ↔ EngagementService (end-to-end workflows)\n** Event Bus publishing and consumption\n** Webhook receiver (Salesforce → EngagementService)\n* Test scenarios\n** Happy path: Successful feedback submission and Case creation\n** Error scenarios: Salesforce API failures, Braze API failures, network timeouts\n** Retry scenarios: Async Case creation retries, DLQ validation\n** Performance testing: p95 latency validation for ProfileService and EngagementService\n** Load testing: Simulate 3x-10x expected volume\n* UAT execution\n** Business stakeholder UAT sessions\n** UAT test cases covering all feedback categories\n** UAT sign-off documentation\n* Test results documentation\n** Test execution reports\n** Defect tracking and resolution\n** Performance test results\n\n==== Dependencies\n\n*Prerequisites*:\n\n* <<wp-cs-001,WP-CS-001>> (ProfileService Development) completed\n* <<wp-cs-002,WP-CS-002>> (EngagementService Development) completed\n* <<wp-cs-003,WP-CS-003>> (Event Bus Infrastructure) completed\n* <<wp-cs-005,WP-CS-005>> (Mobile App Integration) completed\n* <<wp-cs-007,WP-CS-007>> (Salesforce Configuration) sandbox configuration completed\n\n*Dependent Work Packages*:\n\n* Must complete after <<wp-cs-001,WP-CS-001>>, <<wp-cs-002,WP-CS-002>>, <<wp-cs-003,WP-CS-003>>, <<wp-cs-005,WP-CS-005>> (requires all components available)\n\n==== Skills Required\n\n* Integration testing strategy and execution\n* Test automation frameworks (Postman, Newman, Selenium)\n* Performance testing tools (JMeter, k6, Gatling)\n* Salesforce sandbox administration\n* Test data management\n* Defect tracking and triage\n* UAT facilitation\n\n==== Acceptance Criteria\n\n* All integration test scenarios pass (happy path, error scenarios, retry scenarios)\n* Performance SLAs validated (ProfileService p95 < 300ms, EngagementService p95 < 200ms)\n* Load testing confirms system handles 3x expected volume without degradation\n* UAT sign-off obtained from business stakeholders\n* Zero critical defects (P1/P2) open before moving to Contact Migration\n* Test results documented and approved\n\n[[wp-cs-007]]\n=== WP-CS-007: Salesforce Configuration\n\n==== Description\n\nConfigure Salesforce Service Cloud for OTR digital customer support integration, including field mapping, data isolation, and webhook setup.\n\n==== Deliverables\n\n* Salesforce Contact configuration\n** Custom fields for OTR-specific data (if needed)\n** Email as external key configuration\n** Record Type for OTR digital customers (data isolation)\n** Validation rules\n* Salesforce Case configuration\n** Custom fields for feedback categories (App, Service, Order, Rewards, Refund, Delete Account)\n** Case Type and Reason picklist mapping\n** Queue assignment rules (OTR digital support queue)\n** Case escalation rules\n** Case routing rules\n* Salesforce webhook configuration\n** Platform Events / Outbound Messages for Case updates\n** Webhook authentication (API key, JWT, or OAuth)\n** Case status change triggers (New → In Progress, Resolved, Closed)\n** Webhook payload format (JSON)\n* Data isolation strategy\n** Record Types for OTR vs other Viva Energy business units\n** Queues for OTR-specific Cases\n** Reporting and dashboards scoped to OTR data\n* Salesforce API access\n** Connected App configuration\n** OAuth 2.0 JWT bearer flow setup\n** API user credentials\n** API rate limit monitoring\n* Documentation\n** Salesforce field mapping specification\n** Webhook configuration guide\n** Data isolation architecture diagram\n** API authentication setup guide\n\n==== Dependencies\n\n*Prerequisites*:\n\n* Viva Energy Salesforce admin team engagement\n* Salesforce governance approval (multi-tenant environment)\n* Technical decision on webhook mechanism (Platform Events vs Outbound Messages)\n* Technical decision on authentication method (OAuth 2.0 JWT bearer flow recommended)\n\n*Dependent Work Packages*:\n\n* None (can start in parallel with development work packages)\n* Required for <<wp-cs-002,WP-CS-002>> (EngagementService needs field mapping)\n* Required for <<wp-cs-006,WP-CS-006>> (Integration Testing needs sandbox configuration)\n\n==== Skills Required\n\n* Salesforce administration\n* Salesforce configuration (Record Types, Queues, Validation Rules)\n* Salesforce API integration (REST API, Platform Events, Outbound Messages)\n* Salesforce security and authentication (OAuth, Connected Apps)\n* Multi-tenant data isolation patterns\n\n==== Acceptance Criteria\n\n* Salesforce sandbox configured with all custom fields, Record Types, Queues\n* Field mapping documented and approved by OTR business stakeholders\n* Webhook configuration tested and delivering Case update notifications\n* Data isolation validated (OTR data separate from other Viva Energy business units)\n* API authentication working for ProfileService and EngagementService\n* Salesforce API rate limits monitored and acceptable for expected volume\n* Configuration replicated to Salesforce production environment\n\n[[wp-cs-008]]\n=== WP-CS-008: Contact Data Migration\n\n==== Description\n\nExecute one-time Contact migration from app-specific database to Salesforce Service Cloud production.\n\n==== Deliverables\n\n* Pre-migration activities\n** Final validation of migration tool in sandbox\n** Communication plan (notify users of maintenance window if needed)\n** Freeze app-specific database Contact updates\n** Backup app-specific database\n** Export snapshot of Salesforce Contacts (rollback preparation)\n* Migration execution\n** Execute migration tool against Salesforce production\n** Monitor migration progress\n** Handle failed upserts (manual intervention if needed)\n* Post-migration validation\n** 100% Contact reconciliation (app database vs Salesforce)\n** Email/phone/VCI matching accuracy report\n** Reconciliation report (Contacts created vs updated)\n** Data integrity checks (no duplicate Contacts, no missing Contacts)\n* ProfileService smoke testing\n** Verify Contact ID retrieval works in production\n** Test cache behavior\n** Validate Salesforce Contact upserts from ProfileService\n* Migration report\n** Total Contacts migrated\n** Contacts created vs updated\n** Failed upserts (if any) with resolution\n** Matching accuracy metrics\n** Migration execution time\n\n==== Dependencies\n\n*Prerequisites*:\n\n* <<wp-cs-004,WP-CS-004>> (Contact Migration Tooling) completed\n* <<wp-cs-001,WP-CS-001>> (ProfileService Development) deployed to production (not yet integrated with Mobile App)\n* <<wp-cs-007,WP-CS-007>> (Salesforce Configuration) production configuration completed\n* Salesforce production access granted\n* Migration approved by business stakeholders\n\n*Dependent Work Packages*:\n\n* Must complete after <<wp-cs-001,WP-CS-001>>, <<wp-cs-004,WP-CS-004>>, <<wp-cs-007,WP-CS-007>>\n* Must complete before <<wp-cs-009,WP-CS-009>> (Production Deployment)\n\n==== Skills Required\n\n* Data migration execution\n* Salesforce administration\n* Database operations\n* Data validation and reconciliation\n* Incident management (if issues arise)\n\n==== Acceptance Criteria\n\n* 100% of Contacts migrated with zero data loss\n* Email/phone/VCI matching accuracy > 95%\n* ProfileService smoke tests pass in production\n* Reconciliation report approved by business stakeholders\n* App-specific database Contact updates frozen (read-only mode)\n* Rollback procedure ready (but not executed if migration successful)\n\n[[wp-cs-009]]\n=== WP-CS-009: Production Deployment\n\n==== Description\n\nDeploy all solution components to production and execute cutover from D365 CE to Salesforce Service Cloud.\n\n==== Deliverables\n\n* Production deployment\n** EngagementService deployed to production\n** Event Bus production infrastructure validated\n** Salesforce webhook configured in production\n** Mobile App released to production (App Store, Google Play)\n* Go-live activities\n** Smoke testing (end-to-end feedback submission)\n** Feature flag enabled: `enable_salesforce_feedback_submission = ON`\n** D365 CE integration disabled in Mobile App\n** Monitor Event Bus queue depth, DLQ, Salesforce API rate limits\n** Monitor Mobile App feedback submission success rate\n* Go/No-Go decision\n** Validate success criteria before final cutover\n** Business stakeholder approval\n** Technical validation (smoke tests pass, monitoring healthy)\n* Cutover communication\n** Notify support agents of new Salesforce integration\n** Provide training materials for support agents\n** Customer communication (if visible change)\n* Rollback plan\n** Documented rollback procedure\n** Feature flag can disable Salesforce integration and re-enable D365 CE\n** Rollback decision criteria (P1/P2 incidents, feedback submission success rate < 99%)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* <<wp-cs-001,WP-CS-001>> (ProfileService Development) completed\n* <<wp-cs-002,WP-CS-002>> (EngagementService Development) completed\n* <<wp-cs-003,WP-CS-003>> (Event Bus Infrastructure) completed\n* <<wp-cs-005,WP-CS-005>> (Mobile App Integration) completed\n* <<wp-cs-006,WP-CS-006>> (Integration Testing) completed with UAT sign-off\n* <<wp-cs-007,WP-CS-007>> (Salesforce Configuration) production configuration completed\n* <<wp-cs-008,WP-CS-008>> (Contact Data Migration) completed successfully\n* Mobile App release approval (App Store, Google Play)\n\n*Dependent Work Packages*:\n\n* Must complete after all prior work packages (final cutover)\n\n==== Skills Required\n\n* Production deployment and release management\n* Incident management and troubleshooting\n* Monitoring and observability\n* Change management and communication\n* Rollback execution (if needed)\n\n==== Acceptance Criteria\n\n* Mobile App feedback submission success rate > 99.5%\n* End-to-end flow validated (Mobile App → ProfileService → EngagementService → Salesforce Case created)\n* Braze push notifications delivered successfully\n* Event Bus queue depth normal, DLQ empty\n* No critical incidents (P1/P2) in first 24 hours\n* D365 CE integration disabled\n* Support agents successfully using Salesforce for OTR digital customer Cases\n\n[[wp-cs-010]]\n=== WP-CS-010: Post-Cutover Support\n\n==== Description\n\nMonitor production stability, resolve issues, validate success criteria, and execute D365 CE retirement.\n\n==== Deliverables\n\n* Monitoring and support\n** 24/7 on-call support for first week post-cutover\n** Daily monitoring reports (feedback submission success rate, Case creation success rate)\n** Incident response and resolution\n** Performance tuning (if needed)\n* Success criteria validation\n** Validate feedback submission success rate > 99.5%\n** Monitor customer satisfaction score (target: +15% improvement within 6 months)\n** Monitor average case resolution time (target: -20% improvement within 6 months)\n** Support agent feedback survey\n* D365 CE retirement\n** D365 CE set to read-only mode (historical Case lookups only)\n** Archive D365 CE data for compliance/auditing\n** Decommission D365 CE infrastructure (after 90-day stabilization period)\n** Remove D365 CE integration code from Mobile App\n* Documentation updates\n** Production runbook\n** Troubleshooting guide (based on incidents resolved)\n** Operational procedures for support team\n** Lessons learned document\n\n==== Dependencies\n\n*Prerequisites*:\n\n* <<wp-cs-009,WP-CS-009>> (Production Deployment) completed\n* Cutover successful with no critical incidents\n\n*Dependent Work Packages*:\n\n* Final work package in sequence\n\n==== Skills Required\n\n* Production support and incident management\n* Performance monitoring and tuning\n* Data archival and compliance\n* Infrastructure decommissioning\n* Documentation\n\n==== Acceptance Criteria\n\n* Zero critical incidents (P1/P2) in first 30 days post-cutover\n* Feedback submission success rate sustained > 99.5%\n* Customer satisfaction improvement validated (baseline established, ongoing measurement)\n* Support agents reporting positive experience with Salesforce unified view\n* D365 CE successfully decommissioned\n* All production documentation complete and approved\n* Lessons learned document published\n\n=== Work Package Sequencing\n\n==== Parallel Track 1: Infrastructure & Configuration\n\nCan start immediately and run in parallel:\n\n* <<wp-cs-003,WP-CS-003>> (Event Bus Infrastructure)\n* <<wp-cs-007,WP-CS-007>> (Salesforce Configuration)\n\n==== Parallel Track 2: Development\n\nCan start after Track 1 infrastructure decisions made:\n\n* WP-CS-001 (ProfileService Development) - Independent\n* WP-CS-002 (EngagementService Development) - Requires WP-CS-003 completed\n* WP-CS-004 (Contact Migration Tooling) - Requires WP-CS-001 completed (reuses code)\n\n==== Sequential Track 3: Integration & Testing\n\nMust complete after development:\n\n* WP-CS-005 (Mobile App Integration) - Requires WP-CS-001, WP-CS-002\n* WP-CS-006 (Integration Testing) - Requires WP-CS-001, WP-CS-002, WP-CS-003, WP-CS-005, WP-CS-007\n\n==== Sequential Track 4: Migration & Cutover\n\nMust complete sequentially:\n\n* WP-CS-008 (Contact Data Migration) - Requires WP-CS-001, WP-CS-004, WP-CS-006 UAT sign-off\n* WP-CS-009 (Production Deployment) - Requires all prior work packages completed\n* WP-CS-010 (Post-Cutover Support) - Requires WP-CS-009\n\n==== Critical Path\n\nThe critical path for this project is:\n\n. WP-CS-003 (Event Bus Infrastructure)\n. WP-CS-002 (EngagementService Development) - blocks on WP-CS-003\n. WP-CS-005 (Mobile App Integration) - blocks on WP-CS-001, WP-CS-002\n. WP-CS-006 (Integration Testing) - blocks on WP-CS-001 through WP-CS-005, WP-CS-007\n. WP-CS-008 (Contact Data Migration) - blocks on WP-CS-006 UAT sign-off\n. WP-CS-009 (Production Deployment) - blocks on WP-CS-008\n. WP-CS-010 (Post-Cutover Support) - final deliverable\n\nAny delays in critical path work packages will delay the overall cutover date.\n\n<<<\n== Transition Architecture\n\nThis section defines the evolution from baseline (D365 CE) to target state (Salesforce Service Cloud + ProfileService + EngagementService).\n\n=== Transition Approach\n\n*Big Bang Cutover*: Per ADR-CS-006, this transition uses a single cutover approach rather than phased rollout. All users switch from D365 CE to Salesforce simultaneously after Contact migration completion.\n\n=== Transition States\n\n==== TS-0: Baseline State (Current)\n\n===== Characteristics\n\n* D365 Customer Engagement handles all digital customer feedback\n* App-specific database stores customer Contact data\n* No ProfileService or EngagementService\n* No event-driven architecture\n* Synchronous feedback submission\n\n===== Components Active\n\n- D365 Customer Engagement\n- App-specific customer database\n- Mobile App (current version with D365 CE integration)\n\n==== TS-1: Build & Test\n\n===== Activities\n\n* Build ProfileService microservice (JIT Contact reconciliation API)\n* Build EngagementService microservice (feedback submission API, ACL for Salesforce Case creation, Braze integration, webhook receiver)\n* Implement Event Bus infrastructure (SNS+SQS/EventBridge/Kinesis)\n* Develop Contact migration tool (app database → Salesforce upsert by email/phone/VCI)\n* Update Mobile App API integration (ProfileService + EngagementService endpoints - feedback form UI already complete)\n* Integration testing (ProfileService ↔ Salesforce, EngagementService ↔ Salesforce, EngagementService ↔ Braze)\n* UAT with test Salesforce sandbox environment\n\n===== Components Active\n\n- D365 Customer Engagement (still active, unchanged)\n- App-specific customer database (still active)\n- ProfileService (non-production, testing only)\n- EngagementService (non-production, testing only)\n- Event Bus (non-production)\n- Salesforce Sandbox (testing)\n\n===== Exit Criteria\n\n- All integration tests pass\n- UAT sign-off from business stakeholders\n- Contact migration tool validated in sandbox\n- Mobile App updates tested with non-production APIs\n\n==== TS-2: Contact Migration\n\n===== Activities\n* Execute Contact migration (app database → Salesforce production)\n* Validation: 100% data integrity check (email/phone/VCI matching)\n* Reconciliation report: New Contacts created vs existing Contacts updated\n* Freeze app database Contact updates during migration window\n* ProfileService smoke testing (verify Contact lookups work in Salesforce production)\n\n===== Components Active\n- D365 Customer Engagement (still active, users unaffected)\n- Salesforce Production (Contacts migrated, no Cases yet)\n- ProfileService (production deployed, not integrated with Mobile App yet)\n- App-specific customer database (frozen, read-only)\n\n===== Exit Criteria\n- 100% of Contacts migrated with zero data loss\n- Email/phone/VCI matching accuracy > 95%\n- ProfileService smoke tests pass (JIT lookups return correct Contact IDs)\n- Reconciliation report approved\n\n==== TS-3: Cutover (Go-Live)\n\n===== Go-Live Activities\n\n* Deploy EngagementService to production\n* Deploy Mobile App updates (ProfileService + EngagementService API integration)\n* Configure Salesforce webhook (Case update notifications → EngagementService)\n* Smoke testing: End-to-end feedback submission (Mobile App → EngagementService → Salesforce → Braze notification)\n* Monitor Event Bus queue depth, dead letter queue, Salesforce API rate limits\n* **Go/No-Go decision**: Validate success criteria before final cutover\n* Enable feature flag: `enable_salesforce_feedback_submission = ON`\n* Disable D365 CE integration in Mobile App\n\n===== Components Active\n\n- ProfileService (production, integrated with Mobile App)\n- EngagementService (production, integrated with Mobile App)\n- Event Bus (production, processing async Case creation)\n- Salesforce Production (receiving Cases from digital customers)\n- Braze (sending push notifications)\n- Mobile App (new version with Salesforce integration)\n- D365 Customer Engagement (disabled, read-only for historical lookups)\n\n===== Exit Criteria\n\n- Mobile App feedback submission success rate > 99.5%\n- End-to-end flow validated (Mobile App → Salesforce Case created)\n- Braze push notifications delivered successfully\n- Event Bus queue depth normal, DLQ empty\n- No critical incidents (P1/P2) in first 24 hours\n\n==== TS-4: Target State (Stable Production)\n\n===== Characteristics\n\n* ProfileService and EngagementService fully operational\n* All digital customer feedback routed to Salesforce\n* Event-driven architecture established\n* D365 CE decommissioned\n* First DDD bounded contexts implemented successfully\n\n===== Monitoring Period\n\n* Validate success criteria: feedback submission rate > 99.5%, no data loss\n* Monitor customer satisfaction score (target: +15% improvement)\n* Monitor average case resolution time (target: -20% improvement)\n* Support agents using unified Salesforce view across all channels\n\n===== D365 CE Retirement\n\n* D365 CE read-only access for historical Case lookups (if needed)\n* Decommission D365 CE infrastructure after 90 days\n* Archive D365 CE data for compliance/auditing\n\n===== Components Active\n\n- ProfileService (production)\n- EngagementService (production)\n- Event Bus (production)\n- Salesforce Production (system of record)\n- Braze (push notifications)\n- Mobile App (Salesforce integration)\n- App-specific database (deprecated, Contact data no longer updated)\n\n===== Success Criteria Achieved\n\n- All digital customer feedback routed to Salesforce\n- Support agents have unified customer view\n- D365 CE decommissioned\n- Customer satisfaction improved by 15%\n- Average case resolution time decreased by 20%\n- Zero data loss during transition\n\n=== Transition Dependencies\n\n[width=\"100%\",cols=\"40%,60%\",options=\"header\",]\n|===\n|Dependency |Owner/Status\n\n|*Salesforce production access*\n|Viva Energy Salesforce admin team - TBD\n\n|*Salesforce Case field mapping*\n|Viva Energy Salesforce admin team - TBD (map OTR feedback categories to Salesforce fields)\n\n|*Salesforce data isolation strategy*\n|Viva Energy Salesforce admin team - TBD (Record Types, queues, custom fields)\n\n|*Salesforce webhook configuration*\n|Viva Energy Salesforce admin team - TBD (Outbound Messages vs Platform Events)\n\n|*Event Bus infrastructure*\n|OTR Platform team - Existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis)\n\n|*Braze integration*\n|OTR Marketing team - Existing Braze account, EngagementService creates new campaigns\n\n|*Mobile App release window*\n|OTR Mobile team - Coordinate cutover timing with app release schedule\n\n|*App database access*\n|OTR Platform team - Read access for Contact migration\n\n|===\n\n=== Transition Validation Criteria\n\n==== Contact Migration Validation\n\n* 100% of app database Contacts migrated to Salesforce (zero data loss)\n* Email/phone/VCI matching accuracy > 95% (minimize duplicate Contacts)\n* ProfileService JIT lookups return correct Salesforce Contact IDs (smoke test sample)\n* Reconciliation report shows: X new Contacts created, Y existing Contacts updated\n\n==== Cutover Validation\n\n* Mobile App feedback submission success rate > 99.5% (including async Case creation)\n* End-to-end flow validated: Mobile App → ProfileService → EngagementService → Salesforce Case created\n* Braze push notifications delivered for Case creation and Case resolution\n* Event Bus queue depth within normal range (no backlog)\n* Dead letter queue empty (no failed Case creations)\n* Salesforce API rate limits not exceeded\n\n==== Production Monitoring (30 days)\n\n* Customer satisfaction score improves by 15% (compared to D365 CE baseline)\n* Average case resolution time decreases by 20% (Salesforce vs D365 CE)\n* Support agents confirm unified customer view across all channels\n* Zero critical incidents (P1 outages, data loss)\n\n=== Rollback Plan\n\n==== Rollback Triggers\n\n* Feedback submission success rate < 95% (below acceptable threshold)\n* Data loss or corruption detected in Salesforce\n* Salesforce API rate limits exceeded (Cases not created within SLA)\n* Critical bug blocking customer feedback submission\n\n==== Rollback Procedure\n\n1. **Revert Mobile App** to previous version (remove ProfileService/EngagementService integration, restore D365 CE integration)\n2. **Stop EngagementService** Case creation (prevent duplicate Cases in Salesforce)\n3. **Re-enable D365 CE** for customer feedback submission\n4. **Investigate root cause** (EngagementService logs, Salesforce API errors, Event Bus queue issues)\n5. **Fix and re-test** in sandbox environment\n6. **Retry cutover** when issues resolved\n\n==== Rollback Limitations\n\n* Cases created in Salesforce during cutover period remain in Salesforce (no reverse migration)\n* Contacts migrated to Salesforce remain (no rollback to app database)\n* Rollback only affects Mobile App integration (not data migration)\n\n=== Architectural Scope Boundaries\n\n==== Capabilities Included\n\n===== Business Capabilities\n\n* **Customer Feedback Submission**: Mobile App users can submit structured feedback (Category, Store Name, Time of Visit, Phone, Free Text Message) via EngagementService\n* **Customer Contact Management**: Just-In-Time (JIT) Contact reconciliation with Salesforce via ProfileService, ensuring every Mobile App user has a Salesforce Contact record\n* **Case Management Integration**: EngagementService creates Salesforce Cases asynchronously for customer feedback, support agents manage Cases in Salesforce Service Cloud\n* **Customer Notifications**: Push notifications via Braze when Cases are created, updated, or resolved (bidirectional integration: Mobile App → Salesforce → Mobile App)\n* **Unified Customer View**: Support agents see OTR digital customer feedback alongside other Viva Energy channels (fuel wholesale, Shell Card, retail) in single Salesforce instance\n* **Contact Data Migration**: One-time migration of app-specific customer database Contacts to Salesforce with upsert logic (email/phone/VCI matching)\n\n===== Technical Capabilities\n\n* **ProfileService Bounded Context**: First DDD bounded context implementation - JIT Contact reconciliation, Salesforce API facade, foundation for Flybuys integration\n* **EngagementService Bounded Context**: First DDD bounded context implementation - Customer feedback submission BFF, Anti-Corruption Layer for Salesforce, Braze integration orchestration\n* **Event-Driven Architecture**: Domain event publishing via Event Bus (SNS+SQS/EventBridge/Kinesis) for `SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted` events\n* **Async Processing Pattern**: Non-blocking Case creation with retry logic, exponential backoff, dead letter queue for operational resilience\n* **Anti-Corruption Layer Pattern**: EngagementService protects digital channels from Salesforce API changes, translates between OTR domain language and Salesforce\n* **Conformist Pattern**: ProfileService and EngagementService conform to existing Salesforce configuration (shared Viva Energy instance, multi-tenant governance)\n* **Salesforce Integration**: REST API integration for Contact CRUD and Case creation, webhook receiver for Case update notifications\n* **Braze Integration**: Push notification campaign triggers for Case lifecycle events (created, updated, resolved)\n* **Observability & Monitoring**: Dashboards, metrics, alerting for feedback submission rate, queue depth, API errors, Case creation latency\n* **Feature Flag Management**: Kill switches for emergency rollback (enable_salesforce_feedback_submission, enable_async_case_creation, etc.)\n\n==== Capabilities Excluded\n\n===== Business Capabilities Explicitly Out of Scope\n\n* **Historical Case Migration**: D365 CE Cases not migrated to Salesforce (ADR-CS-005 - fresh start, no Case migration)\n* **Multi-Channel Feedback Submission**: Web app, POS, call centre, email feedback channels not included (Mobile App only in this phase)\n* **Case Resolution by Digital Channels**: Support agents resolve Cases in Salesforce, not via Mobile App self-service\n* **Knowledge Base Integration**: Salesforce Knowledge Base articles not surfaced in Mobile App (future enhancement)\n* **Live Chat/Messaging**: Real-time chat support not included (Salesforce omnichannel capabilities not activated)\n* **Sentiment Analysis**: Automated feedback sentiment analysis not included (future enhancement with AI/ML)\n* **Customer Satisfaction Surveys**: Post-resolution CSAT surveys not included (separate initiative)\n* **Case Attachments**: Mobile App feedback submission does not support file uploads (photos, receipts) - text only\n* **Agent Desktop Integration**: Custom Salesforce UI for support agents not included (use standard Salesforce Service Console)\n* **Social Media Feedback**: Facebook, Twitter, Instagram feedback channels not integrated\n\n===== Technical Capabilities Explicitly Out of Scope\n\n* **Event Sourcing**: Domain events are ephemeral (not persisted for event sourcing/replay) - Event Bus only, no Event Store\n* **CQRS (Command Query Responsibility Segregation)**: ProfileService and EngagementService use same data model for reads/writes (no separate read models)\n* **Local Aggregate Persistence**: ProfileService and EngagementService are stateless (Salesforce is System of Record, no local database for Contact/Case)\n* **Saga Orchestration**: No distributed transactions or saga patterns required (single-step Case creation, not multi-step workflow)\n* **API Gateway Advanced Features**: Rate limiting, API versioning, API key management deferred to detailed design (basic routing only)\n* **GraphQL API**: ProfileService and EngagementService expose REST APIs only (GraphQL not required)\n* **Real-Time Sync**: Salesforce Contact updates by support agents not synced back to ProfileService (eventual consistency acceptable via JIT reconciliation)\n* **Multi-Region Deployment**: Single AWS region deployment (no multi-region failover/disaster recovery in this phase)\n* **Blue-Green Deployment**: Big bang cutover (ADR-CS-006), not blue-green or canary deployment strategy\n* **A/B Testing Framework**: Feature flags for rollback only, not for A/B testing or experimentation\n* **Custom Authentication**: Microsoft Entra External ID used for Mobile App authentication (no custom authentication logic in ProfileService/EngagementService)\n* **Data Residency Compliance**: Salesforce data residency governed by Viva Energy Salesforce configuration (no OTR-specific data residency requirements)\n\n===== Future Bounded Contexts Not in Scope\n\n* **LoyaltyService**: Flybuys integration, reward preferences, transaction adjudication (separate initiative)\n* **LocationService**: Store finder, proximity features, geofencing (separate initiative)\n* **PaymentService**: Payment processing, subscription billing (separate initiative)\n* **RecommendationService**: Personalized recommendations, next-best offers (separate initiative)\n\n===== Integration Patterns Not in Scope\n\n* **Shared Kernel**: No shared domain model between ProfileService and EngagementService (separate bounded contexts with clear boundaries)\n* **Partnership**: No joint development or coordination with external teams (Conformist pattern - we conform to Salesforce)\n* **Customer-Supplier (we're upstream)**: No downstream systems depend on ProfileService/EngagementService APIs yet (future bounded contexts will consume domain events)\n\n==== Architectural Dependencies on Future Initiatives\n\n*This Architecture Enables Future Initiatives*:\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Future Initiative |Architectural Enablement\n\n|*Flybuys Integration*\n|**ProfileService Contact Reconciliation Reused**: ProfileService establishes pattern for JIT Contact reconciliation with Salesforce, which will be extended for Flybuys partner linking (link:../architecture_definitions/flybuys_integration.adoc[see Flybuys Integration architecture]) +\n**Event Bus Infrastructure**: Domain event publishing pattern (`CustomerEnrolledInLoyalty`, `PartnerLinked`, etc.) reuses Event Bus established for EngagementService\n\n|*LoyaltyService Bounded Context*\n|**Event Bus Subscription**: LoyaltyService will consume `CustomerProfileCreated` events published by ProfileService (future enhancement) +\n**Salesforce Contact Integration**: LoyaltyService may query Salesforce Contacts for customer reward preferences (via ProfileService facade or direct Salesforce API)\n\n|*Web App Feedback Submission*\n|**EngagementService API Reuse**: Web app will call same EngagementService REST API for feedback submission (multi-channel support) +\n**Conformist Pattern**: Web app conforms to EngagementService API contract (no translation required)\n\n|*Multi-Channel Customer Support*\n|**EngagementService Extension**: Add support for email, call centre, POS feedback channels (extend EngagementService to handle multiple origins) +\n**Salesforce Case Origin Field**: Cases already tagged with Origin=Mobile App, extend to Origin=Web, POS, Call Centre, Email\n\n|*Knowledge Base Integration*\n|**EngagementService API Extension**: Add endpoint to query Salesforce Knowledge Base articles, surface in Mobile App for self-service support +\n**Anti-Corruption Layer**: EngagementService translates Salesforce Knowledge API to OTR domain language\n\n|*Customer Satisfaction Surveys*\n|**Event-Driven Trigger**: Subscribe to `SupportCaseResolved` events published by EngagementService, trigger CSAT survey via Braze +\n**Braze Integration Pattern**: Reuse EngagementService → Braze integration pattern for survey campaigns\n\n|*Sentiment Analysis*\n|**Event Subscription**: Subscribe to `CustomerFeedbackSubmitted` events, analyse feedback sentiment (AI/ML service) +\n**EngagementService Extension**: Enrich Case with sentiment score before creating in Salesforce\n\n|*RecommendationService Bounded Context*\n|**Event Subscription**: RecommendationService subscribes to `SupportCaseCreated` events to understand customer pain points and personalize recommendations +\n**Domain Event Pattern**: Reuse Event Bus publishing pattern established by EngagementService\n\n|===\n\n*This Architecture Depends on Future Initiatives*:\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Future Initiative |Dependency Description\n\n|*Salesforce Data Isolation Strategy*\n|**BLOCKER**: Viva Energy Salesforce admin team must define data isolation strategy (Record Types, custom fields, queues) before production deployment +\n**Impact**: Multi-tenant data visibility and security governance\n\n|*Salesforce Case Field Mapping*\n|**BLOCKER**: Viva Energy Salesforce admin team must define field mapping for OTR feedback categories (App, Service, Order, Rewards, Refund, Delete Account) +\n**Impact**: Case creation logic in EngagementService depends on finalized Salesforce schema\n\n|*Salesforce Webhook Mechanism*\n|**BLOCKER**: Viva Energy Salesforce admin team must configure webhook mechanism (Outbound Messages vs Platform Events vs Process Builder) for Case update notifications +\n**Impact**: EngagementService webhook receiver implementation depends on chosen mechanism\n\n|*Event Bus Technology Selection*\n|**DECISION REQUIRED**: Choose Event Bus implementation (SNS+SQS vs EventBridge vs Kinesis) for domain event publishing +\n**Impact**: Infrastructure provisioning, event schema design, consumer implementation\n\n|*Microservice Hosting Platform*\n|**DECISION REQUIRED**: Choose hosting platform for ProfileService and EngagementService (AWS Lambda vs ECS vs EKS) +\n**Impact**: Deployment architecture, auto-scaling strategy, operational overhead\n\n|*Observability Platform*\n|**DECISION REQUIRED**: Choose observability platform (AWS CloudWatch vs Datadog vs New Relic) for monitoring and alerting +\n**Impact**: Dashboard configuration, metric collection, alerting setup\n\n|===\n\n*Future Work After This Initiative*:\n\n* **Event Schema Registry**: Implement event schema versioning and registry for domain events (currently ad-hoc schemas)\n* **API Versioning Strategy**: Define API versioning approach for ProfileService and EngagementService (currently v1 only)\n* **Multi-Region Deployment**: Extend to multi-region for disaster recovery and global availability\n* **Event Store**: Persist domain events for event sourcing and audit trail (currently ephemeral Event Bus only)\n* **CQRS Pattern**: Separate read models for high-volume queries (currently same model for reads/writes)\n* **GraphQL API**: Expose GraphQL API for flexible client queries (currently REST only)\n* **Real-Time Sync**: Bi-directional sync between Salesforce and ProfileService for Contact updates (currently JIT reconciliation only)\n\n=== Technical Risks and Mitigation\n\n[width=\"100%\",cols=\"5%,20%,25%,25%,25%\",options=\"header\",]\n|===\n|ID |Risk |Impact |Likelihood |Mitigation\n\n|RISK-CS-001\n|*Salesforce API rate limits exceeded*: High feedback volume exceeds Salesforce API limits, Cases not created\n|HIGH (customers don't receive Case confirmation, support tickets lost)\n|MEDIUM (volume unknown, rate limits TBD)\n|• Gather expected feedback volume data before cutover +\n• Implement Event Bus queue throttling/rate limiting +\n• Monitor queue depth and API usage +\n• Scale background workers based on queue depth +\n• Alert ops team when approaching rate limits\n\n|RISK-CS-002\n|*Salesforce downtime*: Salesforce Service Cloud outage prevents Case creation\n|MEDIUM (Cases delayed but queued, customers wait for confirmation)\n|LOW (Salesforce SLA 99.9% uptime)\n|• Async Case creation with retry logic +\n• Event Bus queues buffer work during outage +\n• Customers get immediate \"Feedback submitted\" (not blocked) +\n• Monitor Salesforce status page, alert ops team +\n• Automatic retry when Salesforce recovers\n\n|RISK-CS-003\n|*Contact migration data quality issues*: App database Contact data incomplete or invalid\n|HIGH (migration fails validation, cutover delayed)\n|MEDIUM (legacy data quality unknown)\n|• Pre-migration data quality assessment +\n• Flexible upsert logic (match by email/phone/VCI) +\n• Validation report identifies data issues before production migration +\n• Manual cleanup for invalid records +\n• Dry-run migration in sandbox environment\n\n|RISK-CS-004\n|*Duplicate Contacts created*: Email matching fails, ProfileService creates duplicate Contacts\n|MEDIUM (support agents see multiple profiles for same customer)\n|MEDIUM (email changes, data quality issues)\n|• Salesforce duplicate detection rules (if available) +\n• ProfileService logs Contact creation for audit trail +\n• Manual duplicate cleanup process (support team) +\n• Future enhancement: VCI as Salesforce External ID for stable matching\n\n|RISK-CS-005\n|*Dead letter queue accumulation*: Failed Case creations not processed, queue grows\n|HIGH (customers don't receive Case confirmation, feedback lost)\n|LOW (retry logic handles most failures)\n|• Dead letter queue monitoring and alerting +\n• Ops team dashboard showing DLQ depth +\n• Manual intervention process (investigate and reprocess) +\n• Automated alerts when DLQ depth exceeds threshold +\n• Root cause analysis for recurring failures\n\n|RISK-CS-006\n|*Salesforce webhook failures*: Salesforce can't deliver Case update notifications to EngagementService\n|MEDIUM (customers don't get push notifications for Case resolution)\n|LOW (webhook mechanism reliable)\n|• Webhook retry logic and exponential backoff +\n• EngagementService logs webhook deliveries +\n• Monitor webhook delivery success rate +\n• Fallback: Poll Salesforce API for Case updates (if webhook fails persistently) +\n• Alert ops team when webhook delivery rate drops\n\n|RISK-CS-007\n|*Multi-tenant data isolation breach*: OTR digital Cases visible to other Viva Energy support teams\n|HIGH (privacy violation, compliance risk)\n|LOW (Salesforce governance controls)\n|• Work with Viva Energy Salesforce admin team on data isolation strategy +\n• Test data visibility in Salesforce sandbox (UAT with different user roles) +\n• Validate Record Types, queues, field-level security before production +\n• Audit Salesforce user permissions and sharing rules\n\n|RISK-CS-008\n|*Mobile App release coordination*: App release delayed, cutover window missed\n|MEDIUM (cutover delayed, D365 CE retirement delayed)\n|MEDIUM (release schedule conflicts)\n|• Coordinate cutover timing with Mobile team early +\n• Buffer time in migration plan (2-week contingency) +\n• Decouple backend deployment from Mobile App release (backend deployed first, app follows) +\n• Feature flag for feedback submission (enable when ready)\n\n|RISK-CS-009\n|*Event Bus infrastructure issues*: SNS/SQS/EventBridge downtime or misconfiguration\n|HIGH (Case creation blocked, domain events not published)\n|LOW (AWS SLA 99.99% uptime)\n|• Leverage existing AWS infrastructure (proven, reliable) +\n• Infrastructure as Code (IaC) for Event Bus configuration +\n• Integration testing in non-production environment +\n• Monitor Event Bus metrics (queue depth, throughput, errors) +\n• Alert ops team on Event Bus failures\n\n|RISK-CS-010\n|*Team DDD knowledge gap*: Team unfamiliar with DDD patterns, bounded contexts, event-driven architecture\n|MEDIUM (implementation delays, architectural inconsistencies)\n|HIGH (first DDD implementation)\n|• DDD training for development team (workshops, documentation) +\n• Architecture review sessions (validate bounded context design) +\n• Pair programming with experienced DDD practitioners +\n• Incremental implementation (start small, iterate) +\n• Document architectural patterns in CLAUDE.md\n\n|===\n\n== Assumptions and Constraints\n\n=== Assumptions\n\n[width=\"100%\",cols=\"8%,92%\",options=\"header\",]\n|===\n|ID |Assumption\n\n|ASM-CS-001\n|Viva Energy Salesforce admin team will provide Salesforce production access, sandbox environment, and support for Case field mapping and data isolation configuration\n\n|ASM-CS-002\n|App database Contact data is sufficiently complete for migration (email/phone/VCI available for matching)\n\n|ASM-CS-003\n|Expected customer feedback volume (100-150 submissions/day from 20k DAU) is well within Salesforce API rate limits, with capacity planning for 3x-10x growth\n\n|ASM-CS-004\n|Existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis) is sufficient for Event Bus implementation (no additional infrastructure provisioning required)\n\n|ASM-CS-005\n|Braze integration already exists and can be extended for Case-related push notifications (no new Braze account or major configuration changes)\n\n|ASM-CS-006\n|Mobile App users have email addresses associated with their accounts (required for ProfileService Contact reconciliation)\n\n|ASM-CS-007\n|D365 Customer Engagement historical Cases have limited business value and do not require migration to Salesforce\n\n|ASM-CS-008\n|Support agents are trained on Salesforce Service Cloud and require minimal additional training for OTR digital customer Cases\n\n|ASM-CS-009\n|Salesforce Service Cloud shared instance has capacity for OTR digital customer Contacts and Cases (no additional licensing or storage costs)\n\n|ASM-CS-010\n|Mobile App release schedule can accommodate cutover timing (Week 10 in migration plan)\n\n|===\n\n=== Constraints\n\n[width=\"100%\",cols=\"8%,92%\",options=\"header\",]\n|===\n|ID |Constraint\n\n|CON-CS-001\n|Must use shared Viva Energy Salesforce Service Cloud instance (cannot deploy separate OTR-specific instance)\n\n|CON-CS-002\n|Must conform to existing Salesforce configuration and governance (Record Types, custom fields, queues, data isolation strategy defined by Viva Energy admin team)\n\n|CON-CS-003\n|Contact migration must complete before Mobile App cutover (no parallel run of D365 CE and Salesforce)\n\n|CON-CS-004\n|Big bang cutover only (no phased rollout with feature flags or pilot users)\n\n|CON-CS-005\n|Salesforce API rate limits and authentication method constrained by Viva Energy Salesforce configuration (TBD)\n\n|CON-CS-006\n|Event Bus implementation must use existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis - cannot introduce new infrastructure components)\n\n|CON-CS-007\n|Mobile App feedback form must include specific fields: Category, Store Name, Time of Visit, Contact Phone Number, Free Text Message (no attachments)\n\n|CON-CS-008\n|D365 Customer Engagement must be decommissioned within 90 days post-cutover (ADR-CS-006)\n\n|CON-CS-009\n|ProfileService and EngagementService must be stateless (no local aggregate persistence, Salesforce is System of Record)\n\n|CON-CS-010\n|First DDD bounded context implementation (team learning curve, architectural patterns must be documented for future bounded contexts)\n\n|===\n\n== Non-Functional Requirements\n\n=== Performance Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-PERF-001\n|Mobile App feedback submission API response time (ProfileService + EngagementService)\n|p95 < 1 second, p99 < 2 seconds\n\n|NFR-PERF-002\n|ProfileService Contact reconciliation API response time (JIT lookup)\n|p95 < 500ms, p99 < 1 second\n\n|NFR-PERF-003\n|EngagementService async Case creation latency (end-to-end: feedback submitted → Case created in Salesforce)\n|p95 < 5 minutes, p99 < 10 minutes\n\n|NFR-PERF-004\n|Salesforce API call latency (Contact query, Contact create, Case create)\n|p95 < 2 seconds, p99 < 5 seconds\n\n|NFR-PERF-005\n|Event Bus message processing throughput\n|> 100 messages/second (support peak feedback volume)\n\n|NFR-PERF-006\n|Braze push notification delivery latency (Case created → notification delivered)\n|p95 < 30 seconds, p99 < 60 seconds\n\n|===\n\n=== Availability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-AVAIL-001\n|ProfileService availability\n|99.9% uptime (8.76 hours downtime/year)\n\n|NFR-AVAIL-002\n|EngagementService availability\n|99.9% uptime (8.76 hours downtime/year)\n\n|NFR-AVAIL-003\n|Feedback submission success rate (including async Case creation)\n|> 99.5% (includes retry logic for transient failures)\n\n|NFR-AVAIL-004\n|Graceful degradation: Salesforce downtime handling\n|Feedback submission still succeeds, Cases queued for async creation when Salesforce recovers\n\n|NFR-AVAIL-005\n|Graceful degradation: Braze downtime handling\n|Case creation proceeds, push notifications disabled temporarily (feature flag)\n\n|NFR-AVAIL-006\n|Planned maintenance window\n|< 4 hours/month, scheduled during low-traffic periods (2-6am ACST)\n\n|===\n\n=== Scalability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-SCALE-001\n|Concurrent Mobile App users (peak)\n|Support 20,000 DAU (Daily Active Users), ~150 concurrent users submitting feedback during peak hours\n\n|NFR-SCALE-002\n|Feedback submissions per day\n|Expected: 100-150 submissions/day based on 20k DAU (~0.5-0.75% submission rate) +\nCapacity: Support 500 submissions/day (3x expected volume for growth), 2,000 submissions/day (peak/incident scenarios)\n\n|NFR-SCALE-003\n|Auto-scaling: ProfileService and EngagementService\n|Auto-scale based on CPU/memory/request rate, scale up within 2 minutes\n\n|NFR-SCALE-004\n|Event Bus queue capacity\n|Support 100,000 queued messages (buffer for Salesforce downtime)\n\n|NFR-SCALE-005\n|Salesforce API rate limit compliance\n|Stay within 80% of Salesforce API rate limits (buffer for spikes)\n\n|NFR-SCALE-006\n|Future growth capacity\n|Architecture supports 10x growth (1,000-1,500 submissions/day based on 200k DAU) without major redesign\n\n|===\n\n=== Security Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-SEC-001\n|Mobile App authentication\n|Microsoft Entra External ID OAuth 2.0 with JWT tokens (existing CIAM)\n\n|NFR-SEC-002\n|API authorisation: ProfileService and EngagementService\n|JWT token validation, authenticated users only, user context propagation\n\n|NFR-SEC-003\n|Salesforce API authentication\n|OAuth 2.0 with Connected App and JWT bearer flow (service account)\n\n|NFR-SEC-004\n|Data encryption in transit\n|TLS 1.2+ for all API calls (Mobile App ↔ ProfileService/EngagementService ↔ Salesforce ↔ Braze)\n\n|NFR-SEC-005\n|Data encryption at rest\n|Salesforce encryption at rest (managed by Salesforce), Event Bus message encryption (AWS KMS)\n\n|NFR-SEC-006\n|Secret management\n|AWS Secrets Manager for Salesforce credentials, Braze API keys, OAuth tokens (no hardcoded secrets)\n\n|NFR-SEC-007\n|PII data handling\n|Contact data (email, phone, name) treated as PII, GDPR-compliant retention policies (Salesforce governance)\n\n|NFR-SEC-008\n|API rate limiting and throttling\n|API Gateway rate limiting (100 requests/second per user), prevent abuse and DoS\n\n|NFR-SEC-009\n|Logging and auditing\n|Log all API calls, Salesforce Contact/Case creates/updates, Event Bus publishes (no PII in logs)\n\n|NFR-SEC-010\n|Salesforce data isolation\n|Multi-tenant data isolation via Salesforce Record Types, queues, sharing rules (defined by Viva Energy admin team)\n\n|===\n\n=== Reliability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-REL-001\n|Retry logic: EngagementService → Salesforce Case creation\n|Exponential backoff (1s, 2s, 4s, 8s, 16s), max 5 retries, then dead letter queue\n\n|NFR-REL-002\n|Dead letter queue monitoring\n|Alert ops team immediately when DLQ depth > 0 (failed Case creations require manual intervention)\n\n|NFR-REL-003\n|Event Bus message durability\n|Messages persisted in Event Bus (SNS+SQS/EventBridge/Kinesis), not lost on service restart\n\n|NFR-REL-004\n|Idempotency: Case creation\n|EngagementService ensures duplicate feedback submissions don't create duplicate Cases (idempotency key)\n\n|NFR-REL-005\n|Circuit breaker: Salesforce API calls\n|Open circuit after 5 consecutive failures, half-open retry after 30 seconds\n\n|NFR-REL-006\n|Health checks: ProfileService and EngagementService\n|Health endpoints for load balancer checks, readiness and liveness probes\n\n|NFR-REL-007\n|Disaster recovery: Event Bus\n|Event Bus messages replicated across AWS availability zones (SQS/EventBridge/Kinesis HA)\n\n|===\n\n=== Maintainability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-MAINT-001\n|Code quality: ProfileService and EngagementService\n|> 80% test coverage (unit + integration tests), automated CI/CD pipeline\n\n|NFR-MAINT-002\n|API documentation\n|OpenAPI/Swagger specs for ProfileService and EngagementService, auto-generated API docs\n\n|NFR-MAINT-003\n|Deployment automation\n|Infrastructure as Code (Terraform/CloudFormation/CDK), zero-downtime deployments\n\n|NFR-MAINT-004\n|Logging: structured logs\n|JSON-formatted logs with correlation IDs, log levels (DEBUG, INFO, WARN, ERROR), centralized log aggregation\n\n|NFR-MAINT-005\n|Monitoring dashboards\n|Real-time dashboards for ProfileService, EngagementService, Event Bus (see Monitoring and Observability section)\n\n|NFR-MAINT-006\n|Alerting and on-call\n|PagerDuty/Opsgenie integration for P1/P2 alerts, on-call rotation for ops team\n\n|NFR-MAINT-007\n|Configuration management\n|Externalized configuration (environment variables, AWS Parameter Store), no hardcoded config\n\n|NFR-MAINT-008\n|Versioning: API and events\n|Semantic versioning (v1, v2), backward compatibility for API changes, event schema evolution\n\n|===\n\n=== Usability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-USE-001\n|Feedback submission UX\n|Mobile App user receives immediate \"Feedback submitted\" confirmation (< 1 second), not blocked by async Case creation\n\n|NFR-USE-002\n|Push notification delivery\n|Customer receives \"Your feedback has been received\" notification within 30 seconds of Case creation in Salesforce\n\n|NFR-USE-003\n|Case resolution notification\n|Customer receives \"Your case has been resolved\" notification within 30 seconds of support agent resolving Case\n\n|NFR-USE-004\n|Error messaging\n|User-friendly error messages for failed feedback submission (not technical errors), retry prompts\n\n|NFR-USE-005\n|Accessibility\n|Mobile App feedback form meets WCAG 2.1 AA accessibility standards (existing Mobile App compliance)\n\n|===\n\n=== Compliance Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-COMP-001\n|GDPR compliance: PII data\n|Customer Contact data (email, phone, name) managed per GDPR retention policies (Salesforce governance)\n\n|NFR-COMP-002\n|GDPR compliance: Right to erasure\n|Support \"Delete Account\" feedback category, trigger Contact deletion in Salesforce per GDPR Article 17\n\n|NFR-COMP-003\n|Data residency\n|Salesforce data residency governed by Viva Energy Salesforce configuration (regional compliance)\n\n|NFR-COMP-004\n|Audit trail\n|All Contact creates/updates, Case creates/updates logged for compliance auditing (Salesforce audit logs)\n\n|NFR-COMP-005\n|API security standards\n|OWASP API Security Top 10 compliance (injection prevention, authentication, authorisation, data exposure)\n\n|===\n\n== Monitoring and Observability\n\n=== Key Metrics\n\n[width=\"100%\",cols=\"25%,40%,35%\",options=\"header\",]\n|===\n|Metric Category |Metric |Target/Threshold\n\n|*Feedback Submission*\n|Feedback submission success rate (Mobile App → EngagementService)\n|> 99.5%\n\n|*Async Case Creation*\n|Case creation success rate (EngagementService → Salesforce)\n|> 99%\n\n|*Async Case Creation*\n|Case creation latency (time from feedback submission to Case created in Salesforce)\n|p95 < 5 minutes\n\n|*Event Bus*\n|Event Bus queue depth (pending Case creations)\n|< 100 messages\n\n|*Event Bus*\n|Dead letter queue depth (failed Case creations)\n|= 0 (alert on any failures)\n\n|*Salesforce API*\n|Salesforce API error rate\n|< 1%\n\n|*Salesforce API*\n|Salesforce API latency (Case creation)\n|p95 < 2 seconds\n\n|*Salesforce API*\n|Salesforce API rate limit utilization\n|< 80% of limit\n\n|*ProfileService*\n|Contact reconciliation success rate (JIT lookups)\n|> 99.5%\n\n|*ProfileService*\n|Contact reconciliation latency\n|p95 < 500ms\n\n|*Braze Notifications*\n|Push notification delivery rate (Case created/updated)\n|> 95%\n\n|*Salesforce Webhook*\n|Webhook delivery success rate (Salesforce → EngagementService)\n|> 99%\n\n|*Customer Satisfaction*\n|Customer satisfaction score (CSAT)\n|> 4.0/5.0 (improve by 15% from D365 CE baseline)\n\n|*Support Operations*\n|Average case resolution time\n|Decrease by 20% from D365 CE baseline\n\n|===\n\n=== Alerting Thresholds\n\n[width=\"100%\",cols=\"25%,50%,25%\",options=\"header\",]\n|===\n|Alert |Condition |Severity\n\n|*Feedback submission failures*\n|Feedback submission success rate < 95% over 5-minute window\n|P1 - Critical\n\n|*Dead letter queue accumulation*\n|Dead letter queue depth > 0 (any failed Case creations)\n|P2 - High\n\n|*Event Bus queue backlog*\n|Event Bus queue depth > 100 messages for > 15 minutes\n|P2 - High\n\n|*Salesforce API errors*\n|Salesforce API error rate > 5% over 5-minute window\n|P1 - Critical\n\n|*Salesforce API rate limits*\n|Salesforce API rate limit utilization > 90%\n|P2 - High\n\n|*Contact reconciliation failures*\n|ProfileService Contact reconciliation failure rate > 5% over 5-minute window\n|P2 - High\n\n|*Braze notification failures*\n|Braze push notification delivery rate < 80% over 15-minute window\n|P3 - Medium\n\n|*Salesforce webhook failures*\n|Salesforce webhook delivery success rate < 90% over 15-minute window\n|P2 - High\n\n|*Case creation latency*\n|Case creation latency p95 > 10 minutes\n|P3 - Medium\n\n|===\n\n=== Dashboards\n\n*ProfileService Dashboard:*\n\n* Contact reconciliation success rate (JIT lookups)\n* Contact reconciliation latency (p50, p95, p99)\n* Contact creation vs update ratio (new Contacts created vs existing Contacts updated)\n* Salesforce API error rate (Contact queries and creates)\n* Request rate and throughput\n\n*EngagementService Dashboard:*\n\n* Feedback submission success rate\n* Case creation success rate (async workflow)\n* Case creation latency (p50, p95, p99)\n* Event Bus queue depth (pending Case creations)\n* Dead letter queue depth (failed Case creations)\n* Salesforce API error rate (Case creation)\n* Salesforce API latency\n* Salesforce API rate limit utilization\n* Braze push notification delivery rate\n* Salesforce webhook delivery success rate\n\n*Event Bus Dashboard:*\n\n* Queue depth (pending messages)\n* Throughput (messages published/consumed per minute)\n* Dead letter queue depth (failed messages)\n* Consumer lag (time between publish and consume)\n\n*Customer Support Dashboard (Business Metrics):*\n\n* Total feedback submissions per day/week/month\n* Feedback category breakdown (App, Service, Order, Rewards, Refund, Delete Account)\n* Customer satisfaction score (CSAT) trend\n* Average case resolution time trend\n* Case volume by support team/queue\n* Unified customer view adoption (support agent feedback)\n<<<\n== Solution Validation\n\nThis section defines the validation criteria and testing approach for the solution.\n\n=== Functional Validation\n\n==== ProfileService API Testing\n\n*Test Scenarios*:\n1. **Happy Path**: Authenticated user requests Contact ID, existing Contact found in Salesforce, Contact ID returned\n2. **JIT Creation**: Authenticated user requests Contact ID, no existing Contact, new Contact created in Salesforce, Contact ID returned\n3. **Salesforce API Failure**: Salesforce unavailable, ProfileService returns 500 error, user retries\n4. **Invalid JWT**: Unauthenticated request, ProfileService returns 401 error\n\n*Acceptance Criteria*:\n- Contact reconciliation success rate > 99.5%\n- JIT Contact creation completes within 500ms (p95)\n\n==== EngagementService API Testing\n\n*Test Scenarios*:\n1. **Happy Path**: Valid feedback submission, immediate 202 Accepted response, Case created in Salesforce within 5 minutes, Braze notification delivered\n2. **Invalid Category**: Invalid feedback category, 400 Bad Request response with validation error\n3. **Salesforce Downtime**: Salesforce unavailable during async Case creation, message queued, retry logic executes, Case created when Salesforce recovers\n4. **Dead Letter Queue**: Case creation fails after 5 retries, message moved to DLQ, ops team alerted\n5. **Webhook Notification**: Support agent resolves Case in Salesforce, webhook triggers EngagementService, Braze push notification sent to customer\n\n*Acceptance Criteria*:\n- Feedback submission success rate > 99.5% (including async Case creation)\n- Async Case creation completes within 5 minutes (p95)\n- Webhook delivery success rate > 99%\n\n=== Non-Functional Validation\n\n==== Performance Testing\n\n*Load Testing*:\n\n*Baseline*: Expected 100-150 submissions/day from 20k DAU (~0.5-0.75% submission rate)\n\n- **Normal Load**: 1 submission/minute sustained for 2 hours (simulate typical daily pattern)\n- **3x Load**: 3 submissions/minute sustained for 1 hour (simulate busy period, 450 submissions/day)\n- **Peak Load (10x)**: 10 submissions/minute for 15 minutes (simulate incident scenario, app outage causing backlog)\n- **Stress Test**: 50 submissions/minute for 5 minutes (find breaking point, 20x normal)\n\n*Validation*:\n- API response time p95 < 1 second under 10x load\n- Event Bus queue depth remains manageable (< 100 messages)\n- No Case creation failures, all submissions processed successfully\n- Auto-scaling triggers appropriately for sustained load > 3x baseline\n\n*Acceptance Criteria*:\n- NFR-PERF-001 through NFR-PERF-006 validated under realistic load (3x and 10x baseline)\n- Auto-scaling triggers within 2 minutes of load increase\n- System handles 10x peak gracefully, 20x stress test identifies limits\n\n==== Resilience Testing\n\n*Salesforce API Failure Scenarios*:\n1. **Complete Outage**: Salesforce unavailable for 2 hours, Event Bus queues buffer work, Cases created when Salesforce recovers\n2. **Rate Limit Exceeded**: Salesforce rate limit hit, queue throttling activates, Cases created within SLA\n\n*Acceptance Criteria*:\n- NFR-AVAIL-004 validated (graceful degradation during Salesforce downtime)\n- Circuit breaker activates after 5 consecutive failures\n\n==== Security Validation\n\n*Penetration Testing*:\n- API authentication bypass attempts\n- SQL injection attempts\n- Webhook signature validation bypass\n\n*Acceptance Criteria*:\n- NFR-SEC-001 through NFR-SEC-010 validated\n- OWASP API Security Top 10 compliance verified\n\n=== Integration Validation\n\n==== End-to-End Testing\n\n*Full User Journey*:\n1. User authenticates via Microsoft Entra External ID\n2. Mobile App requests Contact ID from ProfileService (JIT reconciliation)\n3. User submits feedback via EngagementService\n4. Background worker creates Case in Salesforce\n5. Braze notification delivered to user\n6. Support agent resolves Case in Salesforce\n7. Salesforce webhook triggers EngagementService\n8. Braze notification delivered to user\n\n*Acceptance Criteria*:\n- End-to-end flow completes successfully in UAT\n- User receives both \"feedback submitted\" and \"case resolved\" notifications\n","structuredPatch":[{"oldStart":2205,"oldLines":9,"newStart":2205,"newLines":9,"lines":[" "," Can start after Track 1 infrastructure decisions made:"," ","-* WP-CS-001 (ProfileService Development) - Independent","-* WP-CS-002 (EngagementService Development) - Requires WP-CS-003 completed","-* WP-CS-004 (Contact Migration Tooling) - Requires WP-CS-001 completed (reuses code)","+* <<wp-cs-001,WP-CS-001>> (ProfileService Development) - Independent","+* <<wp-cs-002,WP-CS-002>> (EngagementService Development) - Requires <<wp-cs-003,WP-CS-003>> completed","+* <<wp-cs-004,WP-CS-004>> (Contact Migration Tooling) - Requires <<wp-cs-001,WP-CS-001>> completed (reuses code)"," "," ==== Sequential Track 3: Integration & Testing"," "]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"222ef4ca-b08b-4f7e-983d-18afb00a37ac"}
{"parentUuid":"c6e5a8a7-1404-4c9c-8e93-dfb56a463a5c","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01MvcqFPRxA2QzcuCckK4U15","type":"tool_result","content":"The file /mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n  2208→* <<wp-cs-001,WP-CS-001>> (ProfileService Development) - Independent\n  2209→* <<wp-cs-002,WP-CS-002>> (EngagementService Development) - Requires <<wp-cs-003,WP-CS-003>> completed\n  2210→* <<wp-cs-004,WP-CS-004>> (Contact Migration Tooling) - Requires <<wp-cs-001,WP-CS-001>> completed (reuses code)\n  2211→\n  2212→==== Sequential Track 3: Integration & Testing\n  2213→\n  2214→Must complete after development:\n  2215→\n  2216→* <<wp-cs-005,WP-CS-005>> (Mobile App Integration) - Requires <<wp-cs-001,WP-CS-001>>, <<wp-cs-002,WP-CS-002>>\n  2217→* <<wp-cs-006,WP-CS-006>> (Integration Testing) - Requires <<wp-cs-001,WP-CS-001>>, <<wp-cs-002,WP-CS-002>>, <<wp-cs-003,WP-CS-003>>, <<wp-cs-005,WP-CS-005>>, <<wp-cs-007,WP-CS-007>>\n  2218→\n  2219→==== Sequential Track 4: Migration & Cutover\n  2220→\n  2221→Must complete sequentially:"}]},"uuid":"99aefae8-7e04-4a38-9faf-d26b0c7b7375","timestamp":"2026-01-09T03:12:21.213Z","toolUseResult":{"filePath":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","oldString":"==== Sequential Track 3: Integration & Testing\n\nMust complete after development:\n\n* WP-CS-005 (Mobile App Integration) - Requires WP-CS-001, WP-CS-002\n* WP-CS-006 (Integration Testing) - Requires WP-CS-001, WP-CS-002, WP-CS-003, WP-CS-005, WP-CS-007","newString":"==== Sequential Track 3: Integration & Testing\n\nMust complete after development:\n\n* <<wp-cs-005,WP-CS-005>> (Mobile App Integration) - Requires <<wp-cs-001,WP-CS-001>>, <<wp-cs-002,WP-CS-002>>\n* <<wp-cs-006,WP-CS-006>> (Integration Testing) - Requires <<wp-cs-001,WP-CS-001>>, <<wp-cs-002,WP-CS-002>>, <<wp-cs-003,WP-CS-003>>, <<wp-cs-005,WP-CS-005>>, <<wp-cs-007,WP-CS-007>>","originalFile":"= Salesforce Customer Support - Solution Architecture\n:project-name: Salesforce Customer Support\n:togaf-adm-phase: Phase E: Opportunities & Solutions\n:last-updated: 2026-01-07\n:document-type: Solution Architecture Document\n:status: Discovery\n:version: 0.1\n:domain: Customer Support & Engagement\n:programme-lead:\n:domain-architect: O.Young@otr.com.au\n:architecture-definition: xref:architecture-definitions:salesforce_customer_support.adoc[Architecture Definitions/Salesforce Customer Support]\n:doctype: article\n:toc: left\n:toclevels: 4\n:sectanchors:\n:sectlinks:\n:sectnums:\n:icons: font\n:source-highlighter: highlightjs\n:experimental:\n:description:\n:keywords:\n\n<<<\n== Purpose and Scope\n\n=== Purpose\n\nThis Solution Architecture defines how the Salesforce Customer Support consolidation will be implemented - the specific technology products, configurations, interfaces, and deployment architecture that realise the xref:architecture-definitions:salesforce_customer_support.adoc[Salesforce Customer Support Architecture Definition].\n\nThis solution establishes the **first implementation of OTR's target Domain-Driven Design (DDD) architecture** by deploying two new bounded contexts (`ProfileService` and `EngagementService`) as microservices, consolidating customer support onto Salesforce Service Cloud, and implementing event-driven integration patterns that will serve as the foundation for future bounded contexts (including Flybuys integration).\n\n=== Vision\n\n> Unify customer support across all OTRG channels by consolidating OTR digital customer feedback onto Salesforce Service Cloud, establishing the foundational DDD architecture with ProfileService and EngagementService bounded contexts that protect digital channels from external system changes while enabling support agents to deliver exceptional customer experiences with complete interaction history.\n\n=== Architectural Approach\n\nThis architecture establishes OTR's **first bounded context implementation** using Domain-Driven Design strategic patterns:\n\n* *link:../bounded_context/profile.adoc[ProfileService]* (NEW bounded context): Just-In-Time Contact reconciliation with Salesforce, upsert by email, returns Salesforce Contact ID to digital channels - foundation for future Flybuys partner linking\n* *link:../bounded_context/engagement.adoc[EngagementService]* (NEW bounded context): Customer feedback submission facade, Anti-Corruption Layer for Salesforce Case creation, Braze integration for all outbound customer communications (push, email, SMS), async Case processing via Event Bus\n* *Event-driven integration* (NEW pattern): Domain event publishing using existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis) - first implementation establishing pattern for future bounded contexts\n* *Anti-Corruption Layer*: EngagementService isolates digital channels from Salesforce API changes, translates between OTR domain language and Salesforce Service Cloud API\n* *Conformist Pattern*: ProfileService and EngagementService conform to existing Salesforce configuration (shared Viva Energy instance, multi-tenant governance)\n* *Big bang cutover*: Single deployment after Contact migration, no phased rollout, D365 CE retirement post-cutover\n\n=== Scope\n\n==== In Scope\n\n* Solution Building Blocks (SBBs) - specific technology products and versions\n* Interface specifications (APIs, events, data formats)\n* Data architecture and schema specifications\n* Deployment architecture and infrastructure configuration\n* Transition architecture with migration phases\n* Technical validation criteria and testing approach\n* External system integration specifications\n* Physical data models and API schemas\n\n==== Out of Scope\n\n===== Covered in xref:architecture-definitions:salesforce_customer_support.adoc[Architecture Definition]\n\n* Business requirements and stakeholder analysis\n* Architecture decisions and rationale (ADRs)\n* Bounded context definitions and responsibilities\n* High-level integration patterns (ACL, Conformist, OHS+PL)\n* Business capability mapping and value streams\n* Architecture principles and governance\n\n===== Covered in Other Documents\n\n* Detailed design (class diagrams, sequence diagrams for all flows)\n* Implementation code and unit tests\n* Business case and return-on-investment analysis\n* Operational run books and support procedures\n\n<<<\n=== Architecture Overview\n\n[mermaid]\n----\n---\nconfig:\n  layout: elk\n---\nflowchart TB\n    Customer([\"Customer\"]) -- Uses --> MobileApp[\"Mobile App<br>iOS/Android\"]\n    Customer -- Shops at --> POS[\"OTR/OTR+ POS<br>D365 Commerce\"]\n    MobileApp -- Authenticate --> EntraID[\"Microsoft Entra\"]\n    MobileApp -- Identifies & Reconciles --> ProfileService[\"ProfileService\"]\n    ProfileService <-- Reconcile App User as Salesforce Contact --> Salesforce[\"Salesforce\"]\n    ProfileService -- On Create --> EventBus[\"EventBus\"]\n    EventBus -- Emits CreateUser Event --> LoyaltyService[\"LoyaltyService\"] & EngagementService[\"EngagementService\"]\n    LoyaltyService -- Reconcile Wallet --> EagleEye[\"EagleEye\"]\n    EngagementService -- Reconcile Braze Profile --> Braze[\"Braze\"]\n    EngagementService --> Salesforce\n    D365CE[\"D365CE\"] -- Data Migration --> Salesforce\n    MobileApp -- Submits Feedback --> EngagementService\n\n    Customer:::customer\n    MobileApp:::presentation\n    POS:::presentation\n    EntraID:::external\n    ProfileService:::newService\n    Salesforce:::external\n    EventBus:::infrastructure\n    LoyaltyService:::newService\n    EngagementService:::newService\n    EagleEye:::external\n    Braze:::external\n    D365CE:::external\n    classDef newService fill:#4CAF50,stroke:#2E7D32,stroke-width:3px,color:#fff\n    classDef external fill:#FF9800,stroke:#E65100,stroke-width:2px,color:#fff\n    classDef infrastructure fill:#2196F3,stroke:#0D47A1,stroke-width:2px,color:#fff\n    classDef presentation fill:#9C27B0,stroke:#4A148C,stroke-width:2px,color:#fff\n    classDef customer fill:#607D8B,stroke:#263238,stroke-width:2px,color:#fff\n----\n\n\n==== Key Architectural Patterns\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Pattern |Application |Rationale\n\n|*Anti-Corruption Layer (ACL)*\n|EngagementService → Salesforce Service Cloud\n|Protects digital channels (Mobile App, Web) from Salesforce API changes, translates between OTR domain language and Salesforce Case/Contact model, enables independent evolution of internal domain model\n\n|*Conformist*\n|ProfileService → Salesforce, EngagementService → Salesforce\n|Shared Viva Energy Salesforce instance - we conform to existing configuration, governance, and API contracts (external system we don't control)\n\n|*Backend-for-Frontend (BFF)*\n|EngagementService\n|Aggregates customer feedback submission, Contact lookup, async Case creation, and Braze notification orchestration for digital channel clients\n\n|*Event-Driven Architecture (OHS+PL)*\n|Event Bus (SNS+SQS/EventBridge/Kinesis)\n|Loose coupling between bounded contexts, async domain event publishing (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`), foundation for future bounded contexts\n\n|*Just-In-Time (JIT) Integration*\n|ProfileService → Salesforce Contact reconciliation\n|Reconcile app users as Salesforce Contacts on-demand (upsert by email), no pre-sync required, ensures Salesforce has current Contact data\n\n|*Async Processing*\n|EngagementService Case creation via Event Bus\n|Non-blocking user experience, resilience to Salesforce downtime, automatic retry with exponential backoff, dead letter queue for operations team intervention\n\n|*Strangler Fig*\n|Not applicable\n|Big bang cutover (no gradual migration) - D365 CE fully replaced, not incrementally strangled\n\n|===\n\n<<<\n== Solution Approach\n\n* Deploy xref:bounded-contexts:profile.adoc[ProfileService] and xref:bounded-contexts:engagement.adoc[EngagementService] as bounded context microservices\n* Implement Anti-Corruption Layers (ACLs) for Salesforce and Braze integration\n* Establish event-driven architecture as the foundational integration pattern\n* Big bang cutover (TS-1 → TS-4)\n\n=== Related Documentation\n\nThis solution architecture references detailed technical specifications:\n\n==== Architecture Definition\n\n* xref:architecture-definitions:salesforce_customer_support.adoc[Salesforce Customer Support - Architecture Definition] - Business requirements, architecture decisions (ADRs), bounded context definitions, high-level integration patterns\n\n==== Bounded Context Specifications\n\n* xref:bounded-contexts:profile.adoc[ProfileService Bounded Context] - JIT Contact reconciliation, aggregate definitions\n* xref:bounded-contexts:engagement.adoc[EngagementService Bounded Context] - Customer feedback facade, Anti-Corruption Layer\n\n==== Interface Specifications\n\nDetailed API specifications available in the specifications directory:\n\n* link:../../specifications/rest/profile-service-v1.yaml[ProfileService REST API v1] - OpenAPI 3.0 specification for `/profile/v1` endpoints (includes Salesforce Contact reconciliation `GET /contact-id`)\n* link:../../specifications/rest/engagement-service-v1.yaml[EngagementService REST API v1] - OpenAPI 3.0 specification for `/engagement/v1` endpoints (includes `POST /feedback`)\n* link:../../specifications/events/engagement-events.json[Engagement Domain Events] - CloudEvents 1.0 JSON Schema for `SupportCaseCreated`, `SupportCaseUpdated`, `SupportCaseResolved`, `CustomerFeedbackSubmitted`\n\n==== External System Documentation\n\n* https://developer.salesforce.com/docs/atlas.en-us.api_rest.meta/api_rest/[Salesforce REST API Documentation] - Contact and Case object APIs\n* https://www.braze.com/docs/api/endpoints/messaging/send_messages/post_send_triggered_campaigns/[Braze Campaign Trigger API] - Push notification campaigns\n\n<<<\n== Executive Summary\n\n=== Challenge\n\nOTR digital customers (Mobile App, Web) currently submit feedback and support requests to D365 Customer Engagement, while Viva Energy's broader business units (fuel wholesale, Shell Card customers, other retail channels) use Salesforce Service Cloud. This creates:\n\n* *Fragmented customer support platform*: Customer support data split across two systems, preventing support agents from having a unified view of customer interactions across all channels\n* *Operational inefficiency*: Maintaining two separate customer support platforms increases operational overhead and costs\n* *Poor support experience*: D365 CE is not working well for digital customer support, impacting customer satisfaction and case resolution times\n* *Post-merger consolidation opportunity*: Following Viva Energy's acquisition of OTR, strategic alignment on Salesforce as the enterprise customer support platform\n\n=== Solution\n\nThis architecture establishes the **foundational Domain-Driven Design (DDD) implementation** for OTR's target state architecture by introducing two new bounded contexts (link:../bounded_context/profile.adoc[ProfileService], link:../bounded_context/engagement.adoc[EngagementService]) and event-driven integration patterns:\n\n==== New Bounded Contexts\n\n* *link:../bounded_context/profile.adoc[ProfileService]* (NEW): Just-In-Time (JIT) Contact reconciliation with Salesforce, upsert by email, returns Salesforce Contact ID to Mobile App\n* *link:../bounded_context/engagement.adoc[EngagementService]* (NEW): Customer feedback submission, Anti-Corruption Layer (ACL) for Salesforce Case creation, Braze integration for all outbound customer communications (push, email, SMS), async Case processing via Event Bus\n* *Event Bus* (NEW pattern): Domain event publishing using existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis) - first implementation of event-driven architecture pattern\n\n==== Integration Architecture\n\n* *Salesforce = System of Record*: Salesforce Service Cloud (shared Viva Energy instance) owns Contact and Case data\n* *Conformist Pattern*: ProfileService and EngagementService conform to existing Salesforce configuration and API contracts\n* *Anti-Corruption Layer*: EngagementService protects digital channels from Salesforce API changes, translates between OTR domain language and Salesforce\n* *Async Case Creation*: Non-blocking user experience, resilience to Salesforce downtime, automatic retry with exponential backoff, dead letter queue for failed Cases\n* *Event-Driven Notifications*: Salesforce webhook → EngagementService → Braze for all customer communications (push, email, SMS) on Case status updates\n\n==== Migration Approach\n\n* *Contact Migration*: One-time migration from app-specific database → Salesforce (upsert with flexible matching by email/phone/VCI)\n* *No Case Migration*: Historical D365 CE Cases not migrated (fresh start in Salesforce)\n* *Big Bang Cutover*: Single deployment, no phased rollout or parallel run\n* *D365 CE Retirement*: Complete decommissioning of D365 Customer Engagement post-cutover\n\n=== Key Architectural Significance\n\nThis migration establishes the first implementation of OTR's target DDD architecture:\n\n* First bounded contexts implemented (ProfileService, EngagementService)\n* First event-driven domain event pattern (foundation for future bounded contexts)\n* Foundation for Flybuys integration (ProfileService Contact reconciliation reused)\n* Establishes integration patterns (Conformist, ACL, Event-Driven) for future services\n\n=== Success Criteria\n\n* All digital customer feedback routed to Salesforce Service Cloud within 30 days of launch\n* Support agents have unified customer view across all Viva Energy channels (digital, wholesale, Shell Card, other retail)\n* D365 Customer Engagement decommissioned within 90 days post-cutover\n* Customer satisfaction score improves by 15% within 6 months\n* Average case resolution time decreases by 20% within 6 months\n* Zero data loss during Contact migration (100% validation pass rate)\n* Mobile App feedback submission success rate > 99.5% (including async Case creation)\n\n=== Technical Constraints\n\n* Shared Salesforce instance (Viva Energy multi-tenant environment)\n* Conform to existing Salesforce configuration and governance (data isolation strategy TBD with Salesforce admin team)\n* Contact migration must complete before cutover (no parallel run)\n* Async Case creation mandatory (non-blocking user experience)\n* Expected volume: 100-150 feedback submissions/day from 20k DAU (~0.5-0.75% submission rate), architecture capacity planned for 3x-10x growth\n\n=== Open Technical Decisions (TBD)\n\n* Salesforce Case field mapping for digital feedback categories (App, Service, Order, Rewards, Refund, Delete Account)\n* Salesforce data isolation strategy (Record Types, custom fields, queues)\n* Salesforce REST API authentication method (OAuth 2.0, Connected App, JWT bearer flow)\n* Salesforce webhook mechanism for Case updates (Outbound Messages, Platform Events, Process Builder)\n* Retry policy configuration (attempts, backoff intervals)\n* Salesforce API rate limit strategy (expected volume: 100-150 submissions/day from 20k DAU, capacity planning for 3x-10x growth)\n\n== Technical Requirements\n\n[width=\"100%\",cols=\"8%,92%\",options=\"header\",]\n|===\n|ID |Description\n\n|TR-CS-001\n|Every Mobile App user must have a Salesforce Contact record in Salesforce Service Cloud (shared Viva Energy instance)\n\n|TR-CS-002\n|ProfileService must reconcile Mobile App users as Salesforce Contacts using Just-In-Time (JIT) upsert by email address\n\n|TR-CS-003\n|ProfileService must return Salesforce Contact ID to Mobile App for feedback submission\n\n|TR-CS-004\n|Mobile App must support customer feedback submission with fields: Category (App, Service, Order, Rewards, Refund, Delete Account), Store Name, Time of Visit, Contact Phone Number, Free Text Message\n\n|TR-CS-005\n|EngagementService must create Salesforce Cases asynchronously via Event Bus (non-blocking user experience)\n\n|TR-CS-006\n|EngagementService must acknowledge feedback submission immediately to Mobile App user (\"Feedback submitted\" confirmation)\n\n|TR-CS-007\n|EngagementService must send push notification to customer via Braze when Case is successfully created in Salesforce\n\n|TR-CS-008\n|EngagementService must retry failed Case creation with configurable exponential backoff and dead letter queue for operations team intervention\n\n|TR-CS-009\n|Salesforce must be the System of Record for Contact and Case data (no local persistence in ProfileService or EngagementService)\n\n|TR-CS-010\n|Contact migration from app-specific database to Salesforce must complete before Mobile App cutover (upsert with flexible matching by email/phone/VCI)\n\n|TR-CS-011\n|No Case migration from D365 Customer Engagement to Salesforce (fresh start, historical Cases not migrated)\n\n|TR-CS-012\n|EngagementService must publish domain events (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`) to Event Bus for consumption by other bounded contexts\n\n|TR-CS-013\n|EngagementService must receive Salesforce webhook notifications when Cases are updated/resolved by support agents\n\n|TR-CS-014\n|EngagementService must trigger Braze push notifications to customers when Cases are updated/resolved (via Salesforce webhook → EngagementService → Braze)\n\n|TR-CS-015\n|ProfileService and EngagementService must conform to existing Salesforce configuration and API contracts (Conformist pattern)\n\n|TR-CS-016\n|All changes must be communicated using event-driven architecture via Event Bus (using existing AWS infrastructure: SNS+SQS/EventBridge/Kinesis)\n\n|TR-CS-017\n|Mobile App feedback submission success rate must exceed 99.5% (including async Case creation completion)\n\n|TR-CS-018\n|Contact migration must achieve 100% validation pass rate (zero data loss)\n\n|TR-CS-019\n|D365 Customer Engagement must be fully decommissioned within 90 days post-cutover\n\n|===\n\n== Technical Architecture\n\n=== Technical Capability Requirements\n\n==== Requirements Traceability\n\n[width=\"100%\",cols=\"15%,50%,35%\",options=\"header\",]\n|===\n|Requirement ID |Requirement Summary |Architectural Building Blocks\n\n|TR-CS-001\n|Every Mobile App user must have Salesforce Contact record\n|ABB-CS-001 (ProfileService), ABB-CS-004 (Salesforce), ABB-CS-007 (Contact Migration Tool)\n\n|TR-CS-002\n|ProfileService JIT Contact reconciliation via upsert by email\n|ABB-CS-001 (ProfileService), ABB-CS-004 (Salesforce)\n\n|TR-CS-003\n|ProfileService returns Salesforce Contact ID to Mobile App\n|ABB-CS-001 (ProfileService), ABB-CS-006 (Mobile App)\n\n|TR-CS-004\n|Mobile App supports feedback submission with structured fields\n|ABB-CS-006 (Mobile App), ABB-CS-002 (EngagementService)\n\n|TR-CS-005\n|EngagementService creates Salesforce Cases asynchronously\n|ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus), ABB-CS-004 (Salesforce)\n\n|TR-CS-006\n|EngagementService immediate acknowledgment to Mobile App\n|ABB-CS-002 (EngagementService), ABB-CS-006 (Mobile App)\n\n|TR-CS-007\n|EngagementService sends push notification via Braze on Case creation\n|ABB-CS-002 (EngagementService), ABB-CS-005 (Braze)\n\n|TR-CS-008\n|EngagementService retry logic with exponential backoff and DLQ\n|ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus)\n\n|TR-CS-009\n|Salesforce is System of Record for Contact and Case data\n|ABB-CS-004 (Salesforce), ABB-CS-001 (ProfileService - stateless), ABB-CS-002 (EngagementService - stateless)\n\n|TR-CS-010\n|Contact migration before Mobile App cutover\n|ABB-CS-007 (Contact Migration Tool), ABB-CS-004 (Salesforce)\n\n|TR-CS-011\n|No Case migration from D365 CE (fresh start)\n|ABB-CS-004 (Salesforce) - no migration tooling required\n\n|TR-CS-012\n|EngagementService publishes domain events to Event Bus\n|ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus)\n\n|TR-CS-013\n|EngagementService receives Salesforce webhook notifications\n|ABB-CS-002 (EngagementService), ABB-CS-004 (Salesforce)\n\n|TR-CS-014\n|EngagementService triggers Braze notifications on Case updates\n|ABB-CS-002 (EngagementService), ABB-CS-004 (Salesforce), ABB-CS-005 (Braze)\n\n|TR-CS-015\n|ProfileService and EngagementService conform to Salesforce config\n|ABB-CS-001 (ProfileService), ABB-CS-002 (EngagementService), ABB-CS-004 (Salesforce)\n\n|TR-CS-016\n|Event-driven architecture via Event Bus\n|ABB-CS-003 (Event Bus), ABB-CS-002 (EngagementService)\n\n|TR-CS-017\n|Mobile App feedback submission success rate > 99.5%\n|ABB-CS-006 (Mobile App), ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus), ABB-CS-004 (Salesforce)\n\n|TR-CS-018\n|Contact migration 100% validation pass rate\n|ABB-CS-007 (Contact Migration Tool), ABB-CS-004 (Salesforce)\n\n|TR-CS-019\n|D365 CE decommissioned within 90 days post-cutover\n|All ABBs (replacement system operational)\n\n|===\n\n=== Service Catalogues\n\n==== Application Portfolio Catalogue\n\n[width=\"100%\",cols=\"20%,15%,15%,15%,35%\",options=\"header\",]\n|===\n|Application |Lifecycle State |Owner |Hosting Platform |Description\n\n|*ProfileService*\n|NEW\n|OTR Platform Team\n|AWS (TBD: Lambda/ECS/EKS)\n|JIT Contact reconciliation with Salesforce, returns Salesforce Contact ID, foundation for Flybuys integration\n\n|*EngagementService*\n|NEW\n|OTR Platform Team\n|AWS (TBD: Lambda/ECS/EKS)\n|Customer feedback submission facade, ACL for Salesforce Case creation, Braze integration for all outbound communications (push, email, SMS), webhook receiver\n\n|*Mobile App (iOS)*\n|ACTIVE (UPDATE)\n|OTR Mobile Team\n|Apple App Store\n|iOS native app with feedback form, integrate with ProfileService and EngagementService APIs\n\n|*Mobile App (Android)*\n|ACTIVE (UPDATE)\n|OTR Mobile Team\n|Google Play Store\n|Android native app with feedback form, integrate with ProfileService and EngagementService APIs\n\n|*Salesforce Service Cloud*\n|ACTIVE (EXPAND)\n|Viva Energy Salesforce Admin Team\n|Salesforce (SaaS)\n|Shared Viva Energy instance, System of Record for Contact and Case data, adding OTR digital customer support\n\n|*Braze*\n|ACTIVE (EXTEND)\n|OTR Marketing Team\n|Braze (SaaS)\n|Marketing automation platform, EngagementService triggers push notifications for Case updates\n\n|*D365 Customer Engagement*\n|RETIRE\n|OTR Support Team\n|Microsoft Azure (SaaS)\n|Legacy customer support platform, decommissioned within 90 days post-cutover\n\n|*App-Specific Customer Database*\n|RETIRE\n|OTR Platform Team\n|AWS (RDS/DynamoDB)\n|Legacy customer contact storage, one-time migration to Salesforce, then deprecated\n\n|*Event Bus*\n|NEW\n|OTR Platform Team\n|AWS (SNS+SQS/EventBridge/Kinesis)\n|Domain event publishing infrastructure for bounded context integration\n\n|*Contact Migration Tool*\n|TEMPORARY\n|OTR Platform Team\n|AWS (Script/Lambda)\n|One-time migration app database → Salesforce with upsert logic, retired after migration complete\n\n|===\n\n==== Technology Capability Requirements\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Technology Capability |Implementation Technology (TBD in detailed design) |Requirements\n\n|*Microservice Hosting*\n|AWS Lambda / ECS / EKS\n|Host ProfileService and EngagementService with auto-scaling, high availability, monitoring\n\n|*API Gateway*\n|AWS API Gateway / Application Load Balancer\n|REST API routing, authentication, rate limiting, request validation for ProfileService and EngagementService\n\n|*Event Bus*\n|AWS SNS+SQS / EventBridge / Kinesis\n|Domain event publishing, async message processing, retry logic, dead letter queue\n\n|*Salesforce Integration*\n|Salesforce REST API / SOAP API\n|Contact CRUD operations, Case creation, webhook notifications, OAuth 2.0 authentication\n\n|*Braze Integration*\n|Braze REST API / SDK\n|Push notification campaign triggers, customer profile reconciliation\n\n|*Authentication & Authorisation*\n|Microsoft Entra External ID / AWS Cognito\n|Mobile App user authentication, API authorisation, JWT token validation\n\n|*Observability & Monitoring*\n|AWS CloudWatch / Datadog / New Relic\n|Application metrics, logs, traces, dashboards, alerting (feedback submission rate, queue depth, API errors)\n\n|*Secret Management*\n|AWS Secrets Manager / Parameter Store\n|Salesforce credentials, Braze API keys, OAuth tokens, encryption keys\n\n|*Database (Migration Tool)*\n|AWS RDS / DynamoDB (read-only access)\n|Contact migration from app-specific database\n\n|*CI/CD Pipeline*\n|GitHub Actions / AWS CodePipeline\n|Automated build, test, deployment for ProfileService, EngagementService, Mobile App\n\n|*Infrastructure as Code*\n|Terraform / AWS CloudFormation / CDK\n|Declarative infrastructure provisioning for Event Bus, microservices, monitoring\n\n|*API Documentation*\n|OpenAPI / Swagger\n|ProfileService and EngagementService API specifications for Mobile App integration\n\n|===\n\n==== Feature Flag Register\n\n*Note*: Per ADR-CS-006 (big bang cutover, not phased rollout), feature flags are minimal and used primarily for emergency rollback/kill switches.\n\n[width=\"100%\",cols=\"20%,15%,35%,30%\",options=\"header\",]\n|===\n|Feature Flag |Default State |Purpose |Rollback Scenario\n\n|*enable_salesforce_feedback_submission*\n|OFF (pre-cutover), ON (post-cutover)\n|Enable/disable feedback submission to EngagementService → Salesforce (kill switch for emergency rollback to D365 CE)\n|Feedback submission success rate < 95%, Salesforce API failures, critical bugs - revert to D365 CE integration\n\n|*enable_async_case_creation*\n|ON\n|Enable/disable async Case creation via Event Bus (fallback to synchronous processing if Event Bus issues)\n|Event Bus infrastructure failures, queue backlog unmanageable - temporary synchronous processing\n\n|*enable_braze_notifications*\n|ON\n|Enable/disable Braze push notifications for Case updates (degrade gracefully if Braze integration fails)\n|Braze API failures, notification delivery rate < 80% - disable notifications temporarily\n\n|*enable_jit_contact_reconciliation*\n|ON\n|Enable/disable ProfileService JIT Contact reconciliation (fallback to cached Contact IDs if Salesforce unavailable)\n|Salesforce API downtime, Contact reconciliation failures > 5% - use cached Contact IDs temporarily\n\n|*enable_salesforce_webhook_processing*\n|ON\n|Enable/disable Salesforce webhook processing for Case updates (fallback to polling if webhook failures)\n|Webhook delivery failures, authentication issues - temporary polling fallback\n\n|===\n\n*Feature Flag Management*:\n\n* Feature flags managed via AWS AppConfig / LaunchDarkly / custom feature flag service (TBD in detailed design)\n* Mobile App feature flags controlled server-side (no app release required for flag changes)\n* Backend service feature flags configured via environment variables / configuration service\n* Feature flag changes logged and audited (who changed, when, reason)\n* Post-cutover monitoring: Gradual removal of feature flags once system stability confirmed (30-60 days)\n\n==== Data Entity Catalogue\n\n[width=\"100%\",cols=\"20%,15%,35%,30%\",options=\"header\",]\n|===\n|Data Entity |System of Record |Key Attributes |Lifecycle\n\n|*Contact*\n|Salesforce Service Cloud\n|• Contact ID (Salesforce 15/18-char ID) +\n• Email (primary matching key) +\n• First Name, Last Name +\n• Phone Number +\n• Viva Consumer ID (VCI) +\n• Account (Viva Energy customer account) +\n• Record Type (OTR Digital vs other channels)\n|Created: ProfileService JIT reconciliation or Contact Migration Tool +\nUpdated: ProfileService JIT upsert (email changes), Salesforce (manual updates by support agents) +\nDeleted: Salesforce retention policy (GDPR/compliance)\n\n|*Case*\n|Salesforce Service Cloud\n|• Case Number (Salesforce auto-generated) +\n• Contact ID (reference to Contact) +\n• Subject (derived from Category) +\n• Description (Free Text Message) +\n• Category (App, Service, Order, Rewards, Refund, Delete Account) +\n• Store Name (OTR location) +\n• Time of Visit +\n• Status (New, In Progress, Resolved, Closed) +\n• Priority, Origin (Mobile App) +\n• Owner (support agent/queue)\n|Created: EngagementService async Case creation +\nUpdated: Support agents (Salesforce UI), EngagementService (webhook processing) +\nDeleted: Salesforce retention policy (archive after X years)\n\n|*Feedback Submission (transient)*\n|None (not persisted)\n|• Salesforce Contact ID +\n• Category +\n• Store Name +\n• Time of Visit +\n• Contact Phone Number +\n• Free Text Message\n|Created: Mobile App user submission +\nProcessed: EngagementService publishes to Event Bus, Case created in Salesforce +\nNot persisted in ProfileService/EngagementService (stateless)\n\n|*Domain Events*\n|Event Bus (ephemeral)\n|**SupportCaseCreated**: +\n• Case Number, Contact ID, Category, Timestamp +\n**SupportCaseUpdated**: +\n• Case Number, Status, Updated By, Timestamp +\n**SupportCaseResolved**: +\n• Case Number, Resolution, Resolved By, Timestamp +\n**CustomerFeedbackSubmitted**: +\n• Contact ID, Category, Timestamp\n|Published: EngagementService +\nConsumed: Other bounded contexts (future), Braze notification triggers +\nRetention: Short-lived (minutes to hours), not persisted for event sourcing\n\n|*Braze Customer Profile*\n|Braze\n|• External User ID (VCI or Email) +\n• Push Notification Tokens (iOS/Android) +\n• Notification Preferences +\n• Campaign Engagement History\n|Created/Updated: EngagementService on Case creation/update +\nManaged: Braze (external SaaS)\n\n|===\n\n*Data Migration Entities*:\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Source Entity |Target Entity |Migration Strategy\n\n|*App Database Contact*\n|Salesforce Contact\n|One-time migration via Contact Migration Tool: +\n• Upsert by email (primary), phone (secondary), VCI (tertiary) +\n• Map: Email → Email, Name → First/Last Name, Phone → Phone, VCI → External ID +\n• Validation: 100% data integrity check, reconciliation report\n\n|*D365 CE Case*\n|Not migrated\n|ADR-CS-005: No Case migration (fresh start in Salesforce) +\nD365 CE Cases archived separately for compliance if needed\n\n|===\n\n==== Data Quality & Validation\n\n*Contact Migration Validation Rules*:\n\n* Email format validation (RFC 5322 compliance)\n* Phone number format validation (E.164 international format)\n* VCI format validation (alphanumeric, length constraints)\n* Duplicate detection: Flag potential duplicates for manual review (same email/phone combination)\n* Mandatory fields: Email (required), First Name, Last Name (required for Salesforce Contact)\n\n*Case Creation Validation Rules*:\n\n* Contact ID must exist in Salesforce (validated by EngagementService before Case creation)\n* Category must be one of: App, Service, Order, Rewards, Refund, Delete Account\n* Free Text Message maximum length: 32,000 characters (Salesforce Case Description limit)\n* Store Name validated against OTR location master data (optional - warn if not found)\n\n<<<\n== Solution Building Blocks\n\nThis section defines the specific technology products, configurations, and implementation details for each Solution Building Block (SBB).\n\n=== Technology Portfolio Catalogue\n\n[width=\"100%\",cols=\"10%,20%,25%,25%,20%\",options=\"header\",]\n|===\n|SBB ID |Component |Technology Product |Version/Configuration |Deployment Platform\n\n|SBB-CS-001\n|ProfileService Microservice\n|.NET 8 / Node.js 20 LTS\n|RESTful API, containerised\n|AWS ECS Fargate / Lambda\n\n|SBB-CS-002\n|EngagementService Microservice\n|.NET 8 / Node.js 20 LTS\n|RESTful API, containerised, async workers\n|AWS ECS Fargate / Lambda\n\n|SBB-CS-003\n|Event Bus\n|AWS SNS + SQS / EventBridge\n|Standard queues, FIFO for ordering\n|AWS (managed service)\n\n|SBB-CS-004\n|API Gateway\n|AWS API Gateway / ALB\n|REST API, JWT validation\n|AWS (managed service)\n\n|SBB-CS-005\n|Salesforce Integration Layer\n|Salesforce REST API Client\n|OAuth 2.0 JWT bearer flow\n|Embedded in SBB-CS-001/002\n\n|SBB-CS-006\n|Braze Integration Layer\n|Braze REST API SDK\n|API key authentication\n|Embedded in SBB-CS-002\n\n|SBB-CS-007\n|Contact Migration Tool\n|Python 3.11 / .NET 8\n|One-time batch script\n|AWS Lambda / EC2\n\n|SBB-CS-008\n|Application Monitoring\n|AWS CloudWatch / Datadog\n|Metrics, logs, traces, dashboards\n|AWS / SaaS\n\n|SBB-CS-009\n|Secret Management\n|AWS Secrets Manager\n|KMS encryption\n|AWS (managed service)\n\n|SBB-CS-010\n|Mobile App (iOS)\n|SwiftUI, Kotlin Multiplatform\n|iOS 15+\n|Apple App Store\n\n|SBB-CS-011\n|Mobile App (Android)\n|Jetpack Compose, Kotlin Multiplatform\n|Android 8+\n|Google Play Store\n\n|SBB-CS-012\n|Feature Flag Service\n|AWS AppConfig / LaunchDarkly\n|Server-side flags, real-time updates\n|AWS / SaaS\n\n|===\n\n<<<\n== Data Architecture\n\nThis section defines the physical data models, event schemas, and API request/response formats.\n\n=== Domain Event Schemas\n\nAll domain events follow the https://cloudevents.io/[CloudEvents 1.0] specification for consistency and interoperability.\n\n*Event Schema Specifications*: See // TODO: Add to Antora - specifications/events/engagement-events.json[Engagement Service Event Schemas] for complete JSON schemas and examples.\n\n==== Event Catalogue\n\n[width=\"100%\",cols=\"30%,20%,50%\",options=\"header\",]\n|===\n|Event Type |Publisher |Description\n\n|`SupportCaseCreated`\n|EngagementService\n|Published when EngagementService successfully creates a Case in Salesforce after async processing\n\n|`SupportCaseUpdated`\n|EngagementService (via Salesforce webhook)\n|Published when a support agent updates a Case in Salesforce (status, priority, comment changes)\n\n|`SupportCaseResolved`\n|EngagementService (via Salesforce webhook)\n|Published when a support agent resolves/closes a Case in Salesforce\n\n|`CustomerFeedbackSubmitted`\n|EngagementService\n|Published when customer submits feedback via Mobile App (before async Case creation)\n\n|===\n\n*Event Format*: All events use CloudEvents 1.0 envelope with event-specific payload in the `data` field.\n\n*Schema Location*: `specifications/events/engagement-events.json`\n\n=== API Request/Response Schemas\n\n==== ProfileService: GET /profile/contact-id\n\n*Response* (200 OK):\n[source,json]\n----\n{\n  \"contactId\": \"0034X00000ABCDEFG\",\n  \"email\": \"customer@example.com\",\n  \"firstName\": \"John\",\n  \"lastName\": \"Smith\"\n}\n----\n\n==== EngagementService: POST /feedback\n\n*Request*:\n[source,json]\n----\n{\n  \"contactId\": \"0034X00000ABCDEFG\",\n  \"category\": \"App\",\n  \"storeName\": \"OTR Adelaide\",\n  \"timeOfVisit\": \"2026-01-07T12:00:00Z\",\n  \"contactPhoneNumber\": \"+61412345678\",\n  \"message\": \"App crashed when submitting feedback\"\n}\n----\n\n*Response* (202 Accepted):\n[source,json]\n----\n{\n  \"feedbackId\": \"fb-2026-01-07-12345\",\n  \"status\": \"submitted\",\n  \"message\": \"Your feedback has been submitted!\"\n}\n----\n\n=== Salesforce Field Mappings\n\n==== Case Object Mapping\n\n[width=\"100%\",cols=\"25%,25%,25%,25%\",options=\"header\",]\n|===\n|OTR Field |Salesforce Field |Data Type |Notes\n\n|Category\n|Feedback_Category__c\n|Picklist\n|App, Service, Order, Rewards, Refund, Delete Account\n\n|Store Name\n|Store_Name__c\n|String (255)\n|OTR location name\n\n|Time of Visit\n|Time_of_Visit__c\n|DateTime\n|When customer visited store\n\n|Free Text Message\n|Description\n|Long Text (32,000)\n|Customer feedback message\n\n|===\n\n<<<\n=== Baseline Architecture\n\n==== Existing System Components\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Component |Current State |Status\n\n|*D365 Customer Engagement*\n|Customer support platform for OTR digital customers (Mobile App, Web), handles feedback submission and case management\n|**DEPRECATED** - Being replaced by Salesforce Service Cloud\n\n|*App-Specific Customer Database*\n|Stores customer contact data for Mobile App users, separate from Viva Energy systems\n|**MIGRATING** - One-time migration to Salesforce, then deprecated\n\n|*Mobile App*\n|iOS/Android native apps with feedback submission form including Category, Store Name, Time of Visit, Contact Phone Number, and Free Text Message fields\n|**REQUIRES UPDATE** - Integrate with ProfileService and EngagementService APIs (feedback form UI already complete)\n\n|*Salesforce Service Cloud*\n|Shared Viva Energy instance handling customer support for fuel wholesale, Shell Card customers, other retail channels\n|**EXPANDING** - Adding OTR digital customer support Cases and Contacts\n\n|*Existing AWS Infrastructure*\n|SNS+SQS / EventBridge / Kinesis available for event-driven architecture\n|**REUSING** - Event Bus implementation leverages existing infrastructure\n\n|===\n\n==== Integration Architecture\n\n*Current state:*\n\n* Mobile App → D365 Customer Engagement (direct integration)\n* App-specific customer database → standalone (no Salesforce integration)\n* No event-driven architecture (synchronous, tightly coupled)\n* No Anti-Corruption Layer protecting digital channels\n* Viva Energy support teams use Salesforce, OTR digital support uses D365 CE (fragmented)\n\n==== Technical Debt\n\n*No longer relevant* - D365 CE being deprecated, not documenting technical debt of system being retired.\n\n*New technical debt introduced by this migration:*\n\n* Salesforce field mapping TBD (requires coordination with Viva Energy Salesforce admin team)\n* Data isolation strategy TBD (Record Types, custom fields, queues - multi-tenant governance)\n* Salesforce webhook mechanism TBD (Outbound Messages vs Platform Events vs Process Builder)\n* Expected feedback volume unknown (gathering data for rate limit planning)\n\n=== Gap Analysis\n\n==== Missing Capabilities\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Missing Capability |Description\n\n|*ProfileService bounded context*\n|No existing service for Contact reconciliation with Salesforce - requires new microservice implementing JIT upsert by email, returning Salesforce Contact ID\n\n|*EngagementService bounded context*\n|No existing service for customer feedback facade - requires new microservice implementing Anti-Corruption Layer for Salesforce Case creation, Braze integration, async processing via Event Bus\n\n|*Event Bus domain event pattern*\n|No existing domain event publishing infrastructure - requires implementing event-driven architecture pattern using existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis)\n\n|*Async Case creation workflow*\n|Current D365 CE integration is synchronous - requires implementing async processing with retry logic, exponential backoff, dead letter queue\n\n|*Salesforce webhook integration*\n|No existing capability to receive Salesforce notifications - requires implementing webhook receiver in EngagementService for Case update notifications\n\n|*Braze push notification orchestration*\n|No existing integration for Case-related push notifications - requires implementing Braze campaign triggers from EngagementService\n\n|*Contact migration tooling*\n|No existing tooling for app database → Salesforce Contact migration with upsert logic (match by email/phone/VCI)\n\n|*Feedback form enhancements*\n|Mobile App feedback form lacks structured fields (Category, Store Name, Time of Visit, Contact Phone Number) - requires UI updates\n\n|===\n\n==== Missing Bounded Contexts\n\n[width=\"100%\",cols=\"30%,30%,40%\",options=\"header\",]\n|===\n|Bounded Context |Responsibilities |Implementation Status\n\n|*link:../bounded_context/profile.adoc[ProfileService]*\n|JIT Contact reconciliation with Salesforce (upsert by email), return Salesforce Contact ID to digital channels, foundation for future Flybuys partner linking\n|**NEW** - First bounded context implementation\n\n|*link:../bounded_context/engagement.adoc[EngagementService]*\n|Customer feedback submission facade, Anti-Corruption Layer for Salesforce Case creation, Braze integration for push notifications, async Case processing, webhook receiver for Case updates\n|**NEW** - First bounded context implementation\n\n|===\n\n==== Missing Integration Patterns\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Integration Pattern |Description\n\n|*Anti-Corruption Layer (ACL)*\n|EngagementService → Salesforce Service Cloud - protects digital channels from Salesforce API changes, translates between OTR domain language and Salesforce\n\n|*Conformist*\n|ProfileService/EngagementService → Salesforce - conform to existing Salesforce configuration and API contracts (shared Viva Energy instance)\n\n|*Event-Driven Architecture (OHS+PL)*\n|Event Bus publishing domain events (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`) for loose coupling between bounded contexts\n\n|*Just-In-Time (JIT) Integration*\n|ProfileService → Salesforce Contact reconciliation on-demand (no pre-sync)\n\n|*Async Processing*\n|EngagementService Case creation via Event Bus with retry, exponential backoff, dead letter queue\n\n|===\n\n=== Target State Architecture\n\n==== Architectural Building Blocks (ABB)\n\n[width=\"100%\",cols=\"20%,25%,30%,25%\",options=\"header\",]\n|===\n|ABB ID |Bounded Context |Responsibilities |Technology (TBD in Solution Architecture)\n\n|ABB-CS-001\n|*link:../bounded_context/profile.adoc[ProfileService]*\n|JIT Contact reconciliation with Salesforce (upsert by email), return Salesforce Contact ID, foundation for Flybuys partner linking\n|Microservice (.NET/Node.js), REST API, Salesforce REST API client\n\n|ABB-CS-002\n|*link:../bounded_context/engagement.adoc[EngagementService]*\n|Customer feedback submission facade, ACL for Salesforce Case creation, Braze integration, async processing, webhook receiver\n|Microservice (.NET/Node.js), REST API, Event Bus publisher/subscriber, Salesforce webhook receiver\n\n|ABB-CS-003\n|*Event Bus*\n|Domain event publishing infrastructure (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`)\n|AWS SNS+SQS / EventBridge / Kinesis\n\n|ABB-CS-004\n|*Salesforce Service Cloud*\n|System of Record for Contact and Case data (shared Viva Energy instance)\n|Salesforce Service Cloud (external SaaS)\n\n|ABB-CS-005\n|*Braze*\n|Marketing automation platform for push notifications\n|Braze (external SaaS) - existing integration\n\n|ABB-CS-006\n|*Mobile App*\n|iOS/Android native apps with enhanced feedback form (Category, Store Name, Time of Visit, Contact Phone Number, Free Text Message)\n|Kotlin Multiplatform, SwiftUI, Jetpack Compose\n\n|ABB-CS-007\n|*Contact Migration Tool*\n|One-time migration app database → Salesforce with upsert logic (match by email/phone/VCI)\n|Script/tool (.NET/Python/Node.js)\n\n|===\n\n==== Integration Architecture\n\n===== Integration Flows\n\n*Customer Feedback Submission (Async):*\n\n1. *Mobile App* → ProfileService: Authenticate user, get Salesforce Contact ID (JIT reconciliation)\n2. *Mobile App* → EngagementService: Submit feedback (POST /feedback with Contact ID, Category, Store Name, Time of Visit, Phone, Message)\n3. *EngagementService* → Mobile App: Immediate acknowledgment (\"Feedback submitted\")\n4. *EngagementService* → Event Bus: Publish work item for async Case creation\n5. *Background Worker* (EngagementService) → Salesforce: Create Case via REST API\n6. *Success*: EngagementService → Event Bus: Publish `SupportCaseCreated` event\n7. *EngagementService* → Braze: Trigger push notification campaign (\"Your feedback has been received, Case #12345\")\n8. *Failure*: Retry with exponential backoff → Dead Letter Queue → Ops team alert\n\n*Case Update Notification (Bidirectional):*\n\n1. *Support Agent* updates/resolves Case in Salesforce\n2. *Salesforce* → EngagementService: Webhook notification (Case updated)\n3. *EngagementService* → Event Bus: Publish `SupportCaseUpdated` or `SupportCaseResolved` event\n4. *EngagementService* → Braze: Trigger push notification campaign (\"Your case has been resolved\")\n\n*Contact Reconciliation (JIT):*\n\n1. *Mobile App user* authenticates\n2. *Mobile App* → ProfileService: GET /profile/contact-id\n3. *ProfileService* → Salesforce: Query Contact by email\n4. *Match found*: Return existing Salesforce Contact ID\n5. *No match*: Create new Contact in Salesforce, return new Contact ID\n6. *ProfileService* → Mobile App: Return Salesforce Contact ID (cached by Mobile App)\n\n===== System of Record Boundaries\n\n[width=\"100%\",cols=\"30%,35%,35%\",options=\"header\",]\n|===\n|Data Entity |System of Record |Rationale\n\n|*Contact*\n|Salesforce Service Cloud\n|Shared Viva Energy instance, unified customer profile across all channels (digital, wholesale, Shell Card, retail)\n\n|*Case*\n|Salesforce Service Cloud\n|Support agents manage Cases in Salesforce, digital channels submit via EngagementService ACL\n\n|*Feedback Submission (transient)*\n|None (no persistence)\n|EngagementService processes feedback and creates Case in Salesforce, no local storage\n\n|*Domain Events*\n|Event Bus (ephemeral)\n|Events published to Event Bus, consumed by subscribers, not persisted long-term (event sourcing not in scope)\n\n|===\n\n==== Data Architecture Principles\n\n===== Aggregate Persistence\n\n*ProfileService:*\n\n* **No local aggregate persistence** - ProfileService is stateless, queries Salesforce on-demand\n* Salesforce Contact is the aggregate root (owned by Salesforce)\n* ProfileService acts as facade/translator, not system of record\n\n*EngagementService:*\n\n* **No local aggregate persistence** - EngagementService is stateless, creates Cases in Salesforce via ACL\n* Salesforce Case is the aggregate root (owned by Salesforce)\n* EngagementService maintains no local Case state (Conformist pattern - trust Salesforce as source of truth)\n* Async processing state managed via Event Bus (work items in queue, not database)\n\n===== Event Store\n\n* **Event Bus** (SNS+SQS/EventBridge/Kinesis) handles domain event publishing\n* Events are **ephemeral** (consumed and discarded, not persisted for event sourcing)\n* No Event Store implementation in this architecture (future enhancement if needed)\n* Event schema versioning TBD in Solution Architecture\n\n\n=== Architecture Decisions\n\n==== ADR-CS-001: Consolidate onto Salesforce Service Cloud (not build custom solution)\n\n*Status*: Accepted\n\n*Context*:\n\n* D365 Customer Engagement not working well for digital customer support\n* Viva Energy already uses Salesforce Service Cloud for fuel wholesale, Shell Card, other retail channels\n* Post-merger opportunity to consolidate onto single platform\n* Alternative: Build custom support platform or use different SaaS\n\n*Decision*:\n\nConsolidate OTR digital customer support onto Salesforce Service Cloud (shared Viva Energy instance).\n\n*Rationale*:\n\n* **Unified customer view**: Support agents see all interactions across channels (digital, wholesale, Shell Card, retail)\n* **Platform consolidation**: Single support platform reduces operational overhead and costs\n* **Proven solution**: Salesforce Service Cloud is established, feature-rich, well-supported\n* **Post-merger alignment**: Strategic decision to standardize on Viva Energy platforms\n* **Avoid custom development**: Building custom support platform would be costly and high-risk\n\n*Consequences*:\n\n* Unified customer support across Viva Energy Group\n* Reduced operational complexity (single platform vs two)\n* Leverage Salesforce capabilities (case routing, knowledge base, AI, omnichannel)\n* ⚠️ Conformist pattern required (shared instance, conform to existing configuration)\n* ⚠️ Multi-tenant governance needed (data isolation, security, queues)\n* ❌ Less control over platform evolution (SaaS vendor, shared instance)\n\n==== ADR-CS-002: Implement ProfileService and EngagementService as first DDD bounded contexts\n\n*Status*: Accepted\n\n*Context*:\n\n* OTR target architecture uses Domain-Driven Design with bounded contexts\n* This migration is opportunity to establish first implementation\n* Alternative: Direct Mobile App → Salesforce integration (no bounded contexts)\n* Alternative: Single monolithic service for all customer-facing APIs\n\n*Decision*:\n\nImplement ProfileService and EngagementService as separate bounded contexts following DDD strategic patterns.\n\n*Rationale*:\n\n* **Foundation for target architecture**: First implementation of DDD pattern for future bounded contexts (Flybuys, LocationService, PaymentService)\n* **Separation of concerns**: ProfileService handles identity/Contact reconciliation, EngagementService handles support/feedback (different responsibilities, different change rates)\n* **Anti-Corruption Layer**: EngagementService protects digital channels from Salesforce API changes\n* **Reusability**: ProfileService Contact reconciliation reused for Flybuys integration\n* **Event-driven architecture**: Establishes pattern for loose coupling between bounded contexts\n\n*Consequences*:\n\n* Establishes DDD architecture foundation for OTR\n* Reusable ProfileService for Flybuys and future integrations\n* Digital channels protected from Salesforce API changes (ACL)\n* Clear bounded context boundaries and responsibilities\n* ⚠️ Increased initial complexity (two new microservices vs direct integration)\n* ⚠️ Requires Event Bus infrastructure implementation\n* ⚠️ Team must learn DDD patterns and bounded context design\n\n==== ADR-CS-003: Async Case creation via Event Bus (not synchronous)\n\n*Status*: Accepted\n\n*Context*:\n\n* Current D365 CE integration is synchronous (user waits for Case creation)\n* Alternative: Keep synchronous integration (Mobile App → EngagementService → Salesforce synchronously)\n* Salesforce API may experience downtime or latency\n\n*Decision*:\n\nImplement async Case creation via Event Bus with immediate user acknowledgment, retry logic, exponential backoff, and dead letter queue.\n\n*Rationale*:\n\n* **Non-blocking user experience**: User gets immediate \"Feedback submitted\" confirmation, not waiting for Salesforce API\n* **Resilience**: If Salesforce is down, feedback still accepted, Case created when Salesforce recovers\n* **Retry logic**: Automatic retry with exponential backoff handles transient failures\n* **Operational visibility**: Dead letter queue alerts ops team to persistent failures\n* **Scalability**: Queue buffering handles traffic spikes\n\n*Consequences*:\n\n* Better user experience (no waiting for Salesforce API)\n* Resilient to Salesforce downtime (queue buffers work)\n* Automatic retry reduces manual intervention\n* Queue depth monitoring provides operational visibility\n* ⚠️ Eventual consistency (user gets success notification after Case created, not immediately)\n* ⚠️ Increased complexity (Event Bus, background workers, retry logic, DLQ)\n* ⚠️ Requires monitoring and alerting for DLQ\n\n==== ADR-CS-004: ProfileService uses email as primary matching key (not VCI)\n\n*Status*: Accepted\n\n*Context*:\n\n* ProfileService needs to reconcile Mobile App users as Salesforce Contacts\n* Alternative matching keys: VCI (Viva Consumer ID), email, phone, Salesforce External ID\n* Email changes are rare but possible\n\n*Decision*:\n\nUse email address as primary matching key for Contact reconciliation (JIT upsert by email).\n\n*Rationale*:\n\n* **Availability**: Email always available for authenticated users\n* **Uniqueness**: Email is unique identifier in Salesforce and Mobile App\n* **Salesforce standard**: Salesforce Contact uses email as standard lookup field\n* **Simplicity**: Single matching key simplifies upsert logic\n* **Edge case acceptable**: Email changes are rare, manual cleanup acceptable\n\n*Consequences*:\n\n* Simple upsert logic (query by email, create if not found)\n* Leverages Salesforce standard email field\n* Email always available from authentication\n* ⚠️ Email changes create duplicate Contacts (rare edge case, manual cleanup)\n* ⚠️ Future enhancement: Add VCI as Salesforce External ID for stable matching\n\n==== ADR-CS-005: No Case migration from D365 CE (fresh start)\n\n*Status*: Accepted\n\n*Context*:\n\n* D365 CE contains historical customer support Cases\n* Alternative: Migrate historical Cases to Salesforce (preserve support history)\n* Alternative: Archive D365 CE Cases separately (read-only access)\n\n*Decision*:\n\nDo not migrate historical Cases from D365 CE to Salesforce. Start fresh in Salesforce.\n\n*Rationale*:\n\n* **Limited value**: Historical D365 CE Cases not critical for future support\n* **Data quality**: D365 CE Case data may be inconsistent or incomplete\n* **Complexity**: Case migration requires mapping D365 CE schema to Salesforce, data transformation, validation\n* **Cost-benefit**: Migration effort outweighs value of historical data\n* **Archive option**: D365 CE Cases can be archived separately if needed (read-only access for auditing)\n\n*Consequences*:\n\n* Simpler migration (Contacts only, no Case migration)\n* Faster time to value (no Case migration delay)\n* Clean start in Salesforce (no legacy data quality issues)\n* ⚠️ Historical Cases not visible in Salesforce (support agents can't see old Cases)\n* ⚠️ D365 CE must remain accessible temporarily for historical Case lookups (if needed)\n* ❌ Loss of historical Case insights (reporting, analytics on old Cases)\n\n==== ADR-CS-006: Big bang cutover (not phased rollout)\n\n*Status*: Accepted\n\n*Context*:\n\n* Alternative: Phased rollout with feature flags (pilot users first, gradual enablement)\n* Alternative: Parallel run (submit to both D365 CE and Salesforce temporarily)\n* Flybuys integration uses phased rollout (AS-1, AS-2, AS-3 architecture states)\n\n*Decision*:\n\nBig bang cutover - migrate Contacts, deploy ProfileService and EngagementService, switch Mobile App, retire D365 CE.\n\n*Rationale*:\n\n* **Simplicity**: No parallel run complexity, no feature flag management\n* **Faster D365 CE retirement**: No extended transition period maintaining two systems\n* **Limited risk**: Customer support not mission-critical (not payment processing), rollback possible\n* **User base manageable**: OTR digital customers smaller than Flybuys integration scope\n* **Different use case**: Flybuys phased rollout manages points accrual complexity, support feedback is simpler\n\n*Consequences*:\n\n* Simpler deployment (single cutover, no AS-1/AS-2/AS-3 states)\n* Faster D365 CE retirement (no extended parallel run)\n* No feature flag complexity or pilot user management\n* ⚠️ Higher cutover risk (all users switch at once)\n* ⚠️ Requires comprehensive testing before cutover\n* ⚠️ Rollback plan required (revert to D365 CE if critical issues)\n\n==== ADR-CS-007: EngagementService receives Salesforce webhooks for Case updates\n\n*Status*: Accepted\n\n*Context*:\n\n* Support agents update/resolve Cases in Salesforce\n* Need to notify customers of Case status changes via push notifications\n* Alternative: Poll Salesforce API for Case updates (inefficient)\n* Alternative: No customer notifications (agents contact customers directly)\n\n*Decision*:\n\nSalesforce sends webhook notifications to EngagementService when Cases are updated/resolved. EngagementService triggers Braze push notifications.\n\n*Rationale*:\n\n* **Real-time notifications**: Customer notified immediately when agent resolves Case\n* **Efficient**: Webhook push model (not polling)\n* **Event-driven**: Aligns with event-driven architecture pattern\n* **Better customer experience**: Proactive notification vs waiting for agent contact\n\n*Consequences*:\n\n* Real-time customer notifications for Case updates\n* Efficient push model (no polling overhead)\n* Bidirectional integration (Mobile App → Salesforce → Mobile App)\n* ⚠️ Salesforce webhook mechanism TBD (Outbound Messages vs Platform Events vs Process Builder)\n* ⚠️ Webhook authentication and security required\n* ⚠️ EngagementService must handle webhook retries and failures\n\n<<<\n== Interface Specifications\n\nThis section provides references to the complete API specifications and event catalogue for ProfileService and EngagementService.\n\n=== REST API Specifications\n\nComplete OpenAPI 3.0 specifications are maintained in the `specifications/rest/` directory:\n\n==== ProfileService API v1\n\n*Specification*: link:../../specifications/rest/profile-service-v1.yaml[profile-service-v1.yaml]\n\n*Base URL*: `https://api.otr.com.au/profile/v1`\n\n*Authentication*: Bearer token (Microsoft Entra External ID JWT)\n\n*Key Endpoints*:\n\n* `GET /contact-id` - Retrieve or create Salesforce Contact ID for authenticated user (Just-In-Time reconciliation)\n** Used by Mobile App before submitting feedback to EngagementService\n** Upserts Salesforce Contact record using email as external key\n** Returns 18-character Salesforce Contact ID with caching (15-minute TTL)\n** Performance SLA: p95 < 300ms (uncached), p95 < 50ms (cached)\n\n==== EngagementService API v1\n\n*Specification*: link:../../specifications/rest/engagement-service-v1.yaml[engagement-service-v1.yaml]\n\n*Base URL*: `https://api.otr.com.au/engagement/v1`\n\n*Authentication*: Bearer token (Microsoft Entra External ID JWT)\n\n*Key Endpoints*:\n\n* `POST /feedback` - Submit customer feedback for async Case creation in Salesforce\n** Accepts contactId, category, storeName, timeOfVisit, contactPhoneNumber, message\n** Returns 202 Accepted immediately (async Case creation in background)\n** Publishes `CustomerFeedbackSubmitted` event for analytics\n** Creates Salesforce Case via Anti-Corruption Layer with retry logic\n** Performance SLA: p95 < 200ms (feedback accepted, not Case creation)\n\n=== Domain Events (AsyncAPI)\n\nComplete CloudEvents 1.0 JSON Schema specifications are maintained in the `specifications/events/` directory:\n\n*Specification*: link:../../specifications/events/engagement-events.json[engagement-events.json]\n\n==== Event Catalogue\n\n[width=\"100%\",cols=\"30%,20%,50%\",options=\"header\",]\n|===\n|Event Type |Publisher |Consumers\n\n|`CustomerFeedbackSubmitted`\n|EngagementService\n|Future bounded contexts, analytics, sentiment analysis\n\n|`SupportCaseCreated`\n|EngagementService\n|Future bounded contexts, analytics\n\n|`SupportCaseUpdated`\n|EngagementService (via Salesforce webhook)\n|Future bounded contexts, analytics\n\n|`SupportCaseResolved`\n|EngagementService (via Salesforce webhook)\n|Future bounded contexts, analytics\n\n|===\n\n==== Event Delivery Guarantees\n\n* **At-least-once delivery**: Events may be delivered multiple times, consumers must handle idempotency\n* **Ordering**: FIFO queues guarantee ordering for events with same `contactId`\n* **Retention**: 4 days (96 hours) in Event Bus\n* **Dead Letter Queue**: Failed events after 5 retries moved to DLQ for manual intervention\n* **Format**: CloudEvents 1.0 specification with JSON payload\n\n=== API Versioning Policy\n\n==== Version Numbering\n\n* **Format**: `/v{major}` in URL path (e.g., `/profile/v1`, `/engagement/v1`)\n* **Semantic Versioning**: Major version incremented for breaking changes only\n* **Backwards Compatibility**: Minor changes (new optional fields, new endpoints) don't require version bump\n\n==== When to Version\n\n*Breaking changes requiring new major version*:\n\n- Removing or renaming fields in request/response\n- Changing field data types (e.g., string → number)\n- Changing authentication mechanism\n- Removing endpoints\n\n*Non-breaking changes not requiring version bump*:\n\n- Adding new optional fields to request/response\n- Adding new endpoints\n- Expanding enum values (e.g., adding new feedback category)\n- Improving error messages\n\n==== Parallel Version Support\n\n* Support N and N-1 versions concurrently for 6 months\n* Deprecation notice: 3 months before sunsetting old version\n* Mobile App must upgrade to new version within deprecation window\n\n<<<\n== Work Packages\n\nThis section consolidates gaps and activities into implementable work packages aligned with TOGAF Phase E requirements.\n\n=== Work Package Overview\n\n[width=\"100%\",cols=\"15%,35%,25%,25%\",options=\"header\",]\n|===\n|Work Package ID |Name |Transition State |Key Deliverables\n\n|WP-CS-001\n|ProfileService Development\n|TS-1 (Build & Test)\n|ProfileService microservice, Salesforce Contact integration, REST API\n\n|WP-CS-002\n|EngagementService Development\n|TS-1 (Build & Test)\n|EngagementService microservice, Anti-Corruption Layer, Braze integration\n\n|WP-CS-003\n|Event Bus Infrastructure\n|TS-1 (Build & Test)\n|Event Bus configuration, CloudEvents schemas, monitoring\n\n|WP-CS-004\n|Contact Migration Tooling\n|TS-1 (Build & Test)\n|Migration tool, validation scripts, reconciliation reporting\n\n|WP-CS-005\n|Mobile App Integration\n|TS-1 (Build & Test)\n|Mobile App API integration, feedback form enhancements, testing\n\n|WP-CS-006\n|Integration Testing\n|TS-1 (Build & Test)\n|Test environments, integration test suites, UAT execution\n\n|WP-CS-007\n|Salesforce Configuration\n|TS-1 (Build & Test)\n|Salesforce field mapping, data isolation, webhook configuration\n\n|WP-CS-008\n|Contact Data Migration\n|TS-2 (Contact Migration)\n|Contact migration execution, validation, reconciliation\n\n|WP-CS-009\n|Production Deployment\n|TS-3 (Cutover)\n|Production deployment, smoke testing, go-live execution\n\n|WP-CS-010\n|Post-Cutover Support\n|TS-4 (Target State)\n|Monitoring, issue resolution, D365 CE retirement\n\n|===\n\n[[wp-cs-001]]\n=== WP-CS-001: ProfileService Development\n\n==== Description\n\nBuild ProfileService bounded context microservice implementing Just-In-Time Contact reconciliation with Salesforce Service Cloud.\n\n==== Deliverables\n\n* ProfileService microservice application\n** REST API implementation (OpenAPI 3.0 specification)\n** `GET /contact-id` endpoint (Salesforce Contact reconciliation)\n** Authentication/authorization with Microsoft Entra External ID\n** Caching layer (15-minute TTL for Contact IDs)\n* Salesforce integration\n** Salesforce REST API client\n** Contact upsert by email (external key matching)\n** Error handling and retry logic\n* Unit tests (>80% code coverage)\n* Integration tests with Salesforce sandbox\n* API documentation\n* Deployment configuration (IaC - Infrastructure as Code)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* Salesforce sandbox environment provisioned\n* Microsoft Entra External ID OAuth configuration\n* Development environment setup (AWS dev account, CI/CD pipeline)\n\n*Dependent Work Packages*:\n\n* None (can start immediately after prerequisites met)\n\n==== Skills Required\n\n* Backend development (.NET Core or Node.js)\n* REST API design and implementation\n* Salesforce REST API integration\n* OAuth 2.0 / JWT authentication\n* Caching strategies (Redis/ElastiCache)\n* Unit/integration testing frameworks\n* Infrastructure as Code (Terraform/CloudFormation)\n\n==== Acceptance Criteria\n\n* All API endpoints return correct HTTP status codes per OpenAPI specification\n* Contact ID retrieval achieves p95 < 300ms (uncached), p95 < 50ms (cached)\n* Salesforce Contact upsert succeeds with 100% accuracy in sandbox testing\n* Unit test coverage > 80%\n* Integration tests pass in sandbox environment\n* API documentation generated from OpenAPI specification\n\n[[wp-cs-002]]\n=== WP-CS-002: EngagementService Development\n\n==== Description\n\nBuild EngagementService bounded context microservice implementing customer feedback submission, Anti-Corruption Layer for Salesforce Case creation, Braze integration, and webhook receiver for Case updates.\n\n==== Deliverables\n\n* EngagementService microservice application\n** REST API implementation (OpenAPI 3.0 specification)\n** `POST /feedback` endpoint (async feedback submission)\n** Authentication/authorization with Microsoft Entra External ID\n** Webhook receiver endpoint for Salesforce Case updates\n* Anti-Corruption Layer (ACL)\n** OTR domain model to Salesforce API translation\n** Category enum mapping (App/Service/Order/Rewards → Salesforce Case fields)\n** Salesforce REST API client for Case creation\n* Async processing infrastructure\n** Event Bus publisher integration\n** Background worker for Case creation\n** Retry logic with exponential backoff (5 attempts)\n** Dead Letter Queue integration\n* Braze integration\n** Braze campaign trigger API client\n** Push notification orchestration for Case updates\n* Domain event publishing\n** `CustomerFeedbackSubmitted` event publisher\n** `SupportCaseCreated` event publisher\n** `SupportCaseUpdated` event translator (Salesforce webhook → domain event)\n** `SupportCaseResolved` event translator (Salesforce webhook → domain event)\n* Unit tests (>80% code coverage)\n* Integration tests (EngagementService ↔ Salesforce, EngagementService ↔ Braze)\n* API documentation\n* Deployment configuration (IaC)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* <<wp-cs-003,WP-CS-003>> (Event Bus Infrastructure) completed\n* Salesforce sandbox environment provisioned\n* Braze API credentials and campaign templates configured\n* Microsoft Entra External ID OAuth configuration\n\n*Dependent Work Packages*:\n\n* <<wp-cs-003,WP-CS-003>> must be completed first (Event Bus required for async processing)\n* <<wp-cs-007,WP-CS-007>> (Salesforce Configuration) must be in progress (field mapping needed)\n\n==== Skills Required\n\n* Backend development (.NET Core or Node.js)\n* REST API design and implementation\n* Salesforce REST API integration\n* Event-driven architecture patterns\n* Async/background processing (queues, workers)\n* Braze API integration\n* Webhook design and security\n* OAuth 2.0 / JWT authentication\n* Domain-Driven Design (DDD) - Anti-Corruption Layer pattern\n* Unit/integration testing frameworks\n* Infrastructure as Code (Terraform/CloudFormation)\n\n==== Acceptance Criteria\n\n* Feedback submission endpoint returns 202 Accepted within p95 < 200ms\n* Async Case creation succeeds with >99.5% success rate (including retries)\n* Anti-Corruption Layer correctly maps all feedback categories to Salesforce Case fields\n* Webhook receiver processes Salesforce Case updates and publishes domain events\n* Braze push notifications sent successfully for Case updates\n* Failed Case creation moves to Dead Letter Queue after 5 retry attempts\n* Unit test coverage > 80%\n* Integration tests pass with Salesforce sandbox and Braze staging environment\n\n[[wp-cs-003]]\n=== WP-CS-003: Event Bus Infrastructure\n\n==== Description\n\nImplement Event Bus infrastructure for domain event publishing using existing AWS infrastructure (SNS+SQS, EventBridge, or Kinesis).\n\n==== Deliverables\n\n* Event Bus infrastructure configuration\n** Topic/stream provisioning (technology choice: SNS+SQS / EventBridge / Kinesis)\n** FIFO queue configuration (ordering by `contactId`)\n** Dead Letter Queue (DLQ) setup\n** Retention policy (4 days / 96 hours)\n** Access control policies (IAM roles, permissions)\n* CloudEvents 1.0 schema definitions\n** JSON Schema specifications for all domain events\n** Schema validation configuration\n** Schema registry (if using EventBridge/Kinesis)\n* Monitoring and alerting\n** CloudWatch dashboards for queue metrics\n** Alarms for DLQ depth, queue age, processing failures\n** Event Bus throughput monitoring\n* Documentation\n** Event Bus architecture diagram\n** Event publishing guidelines\n** Consumer integration guide\n* Infrastructure as Code (IaC)\n** Terraform/CloudFormation templates for all infrastructure\n\n==== Dependencies\n\n*Prerequisites*:\n\n* AWS account access (existing infrastructure)\n* Technology selection decision (SNS+SQS vs EventBridge vs Kinesis)\n* CloudEvents 1.0 schema design approval\n\n*Dependent Work Packages*:\n\n* None (foundational infrastructure, can start early)\n\n==== Skills Required\n\n* AWS messaging services (SNS, SQS, EventBridge, Kinesis)\n* Event-driven architecture patterns\n* CloudEvents specification\n* JSON Schema design\n* Infrastructure as Code (Terraform/CloudFormation)\n* AWS IAM security configuration\n* CloudWatch monitoring and alerting\n\n==== Acceptance Criteria\n\n* Event Bus infrastructure provisioned in all environments (dev, staging, production)\n* FIFO ordering validated for events with same `contactId`\n* Dead Letter Queue triggers alarms when messages arrive\n* Event retention policy enforced (4 days)\n* CloudEvents 1.0 schema validation enabled\n* Monitoring dashboards operational\n* Infrastructure fully codified (IaC)\n\n[[wp-cs-004]]\n=== WP-CS-004: Contact Migration Tooling\n\n==== Description\n\nDevelop Contact migration tool for one-time migration from app-specific database to Salesforce Service Cloud with upsert logic and validation.\n\n==== Deliverables\n\n* Contact migration tool\n** Extract Contacts from app-specific database\n** Transform to Salesforce Contact API format\n** Upsert to Salesforce using email as external key\n** Fallback matching by phone number or Viva Consumer ID\n** Batch processing with rate limiting (respect Salesforce API limits)\n** Idempotent operation (can be re-run safely)\n* Validation scripts\n** Pre-migration validation (data quality checks)\n** Post-migration validation (100% Contact reconciliation)\n** Email/phone/VCI matching accuracy report\n* Reconciliation reporting\n** Contacts created vs updated statistics\n** Failed upserts with error details\n** Matching accuracy metrics\n* Rollback capability\n** Export snapshot of Salesforce Contacts before migration\n** Rollback procedure documentation\n* Documentation\n** Migration tool user guide\n** Troubleshooting guide\n** Runbook for migration execution\n\n==== Dependencies\n\n*Prerequisites*:\n\n* <<wp-cs-001,WP-CS-001>> (ProfileService Development) completed (reuses Salesforce integration code)\n* Salesforce sandbox environment for migration testing\n* App-specific database access (read-only sufficient)\n* Salesforce production access granted\n\n*Dependent Work Packages*:\n\n* <<wp-cs-001,WP-CS-001>> provides Salesforce Contact upsert logic to reuse\n\n==== Skills Required\n\n* Database development (SQL, data extraction)\n* Salesforce REST API integration\n* Batch processing and ETL patterns\n* Data validation and reconciliation\n* Error handling and logging\n* Scripting (Python, PowerShell, or similar)\n\n==== Acceptance Criteria\n\n* Migration tool successfully migrates 100% of Contacts in sandbox with zero data loss\n* Email/phone/VCI matching accuracy > 95% in sandbox testing\n* Failed upserts captured with actionable error messages\n* Reconciliation report matches actual Salesforce Contact counts\n* Migration tool execution time acceptable for production (freezes app database for minimum time)\n* Rollback procedure validated in sandbox\n* Documentation complete and approved\n\n[[wp-cs-005]]\n=== WP-CS-005: Mobile App Integration\n\n==== Description\n\nUpdate Mobile App to integrate with ProfileService and EngagementService APIs, replacing D365 CE integration.\n\n==== Deliverables\n\n* Feedback form UI enhancements\n** Add Category dropdown (App, Service, Order, Rewards, Refund, Delete Account)\n** Add Store Name field (optional)\n** Add Time of Visit field (optional, datetime picker)\n** Add Contact Phone Number field (optional, E.164 validation)\n** Update Message field (1-2000 character limit with counter)\n* API integration (Kotlin Multiplatform shared code)\n** ProfileService client (`GET /contact-id`)\n** EngagementService client (`POST /feedback`)\n** JWT token management (Microsoft Entra External ID)\n** Error handling (network failures, API errors, validation errors)\n** Retry logic for transient failures\n* Platform-specific UI (SwiftUI for iOS, Jetpack Compose for Android)\n** Feedback form screens\n** Success/error confirmation screens\n** Loading states and progress indicators\n* Feature flag integration\n** `enable_salesforce_feedback_submission` flag\n** Fallback to D365 CE if flag disabled (during rollout)\n* Unit tests for shared business logic\n* UI tests for platform-specific screens\n* API integration tests (mocked APIs)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* <<wp-cs-001,WP-CS-001>> (ProfileService Development) completed and deployed to dev/staging\n* <<wp-cs-002,WP-CS-002>> (EngagementService Development) completed and deployed to dev/staging\n* ProfileService and EngagementService OpenAPI specifications finalized\n* Feature flag service configured\n\n*Dependent Work Packages*:\n\n* Must complete after <<wp-cs-001,WP-CS-001>> and <<wp-cs-002,WP-CS-002>> (requires API endpoints available for integration testing)\n\n==== Skills Required\n\n* Kotlin Multiplatform development\n* SwiftUI (iOS native UI)\n* Jetpack Compose (Android native UI)\n* REST API client development\n* OAuth 2.0 / JWT authentication\n* Form validation and UX design\n* Unit testing (Kotlin, Swift)\n* UI testing frameworks (XCTest, Espresso)\n\n==== Acceptance Criteria\n\n* Feedback form UI matches UX design specifications\n* All form fields validate correctly (client-side validation)\n* API integration successfully calls ProfileService and EngagementService in dev/staging\n* Error handling provides user-friendly error messages\n* Feature flag correctly toggles between Salesforce and D365 CE integration\n* Unit test coverage > 80% for shared business logic\n* UI tests pass for all feedback form workflows (happy path, error states)\n* App builds and deploys successfully to TestFlight (iOS) and Google Play Internal Testing (Android)\n\n[[wp-cs-006]]\n=== WP-CS-006: Integration Testing\n\n==== Description\n\nExecute comprehensive integration testing across all system components in non-production environments.\n\n==== Deliverables\n\n* Test environment setup\n** Salesforce sandbox configured with test data\n** ProfileService deployed to staging\n** EngagementService deployed to staging\n** Event Bus staging infrastructure\n** Braze staging environment configured\n** Mobile App TestFlight/Internal Testing builds\n* Integration test suites\n** ProfileService ↔ Salesforce (Contact upsert scenarios)\n** EngagementService ↔ Salesforce (Case creation scenarios)\n** EngagementService ↔ Braze (push notification scenarios)\n** Mobile App ↔ ProfileService ↔ EngagementService (end-to-end workflows)\n** Event Bus publishing and consumption\n** Webhook receiver (Salesforce → EngagementService)\n* Test scenarios\n** Happy path: Successful feedback submission and Case creation\n** Error scenarios: Salesforce API failures, Braze API failures, network timeouts\n** Retry scenarios: Async Case creation retries, DLQ validation\n** Performance testing: p95 latency validation for ProfileService and EngagementService\n** Load testing: Simulate 3x-10x expected volume\n* UAT execution\n** Business stakeholder UAT sessions\n** UAT test cases covering all feedback categories\n** UAT sign-off documentation\n* Test results documentation\n** Test execution reports\n** Defect tracking and resolution\n** Performance test results\n\n==== Dependencies\n\n*Prerequisites*:\n\n* <<wp-cs-001,WP-CS-001>> (ProfileService Development) completed\n* <<wp-cs-002,WP-CS-002>> (EngagementService Development) completed\n* <<wp-cs-003,WP-CS-003>> (Event Bus Infrastructure) completed\n* <<wp-cs-005,WP-CS-005>> (Mobile App Integration) completed\n* <<wp-cs-007,WP-CS-007>> (Salesforce Configuration) sandbox configuration completed\n\n*Dependent Work Packages*:\n\n* Must complete after <<wp-cs-001,WP-CS-001>>, <<wp-cs-002,WP-CS-002>>, <<wp-cs-003,WP-CS-003>>, <<wp-cs-005,WP-CS-005>> (requires all components available)\n\n==== Skills Required\n\n* Integration testing strategy and execution\n* Test automation frameworks (Postman, Newman, Selenium)\n* Performance testing tools (JMeter, k6, Gatling)\n* Salesforce sandbox administration\n* Test data management\n* Defect tracking and triage\n* UAT facilitation\n\n==== Acceptance Criteria\n\n* All integration test scenarios pass (happy path, error scenarios, retry scenarios)\n* Performance SLAs validated (ProfileService p95 < 300ms, EngagementService p95 < 200ms)\n* Load testing confirms system handles 3x expected volume without degradation\n* UAT sign-off obtained from business stakeholders\n* Zero critical defects (P1/P2) open before moving to Contact Migration\n* Test results documented and approved\n\n[[wp-cs-007]]\n=== WP-CS-007: Salesforce Configuration\n\n==== Description\n\nConfigure Salesforce Service Cloud for OTR digital customer support integration, including field mapping, data isolation, and webhook setup.\n\n==== Deliverables\n\n* Salesforce Contact configuration\n** Custom fields for OTR-specific data (if needed)\n** Email as external key configuration\n** Record Type for OTR digital customers (data isolation)\n** Validation rules\n* Salesforce Case configuration\n** Custom fields for feedback categories (App, Service, Order, Rewards, Refund, Delete Account)\n** Case Type and Reason picklist mapping\n** Queue assignment rules (OTR digital support queue)\n** Case escalation rules\n** Case routing rules\n* Salesforce webhook configuration\n** Platform Events / Outbound Messages for Case updates\n** Webhook authentication (API key, JWT, or OAuth)\n** Case status change triggers (New → In Progress, Resolved, Closed)\n** Webhook payload format (JSON)\n* Data isolation strategy\n** Record Types for OTR vs other Viva Energy business units\n** Queues for OTR-specific Cases\n** Reporting and dashboards scoped to OTR data\n* Salesforce API access\n** Connected App configuration\n** OAuth 2.0 JWT bearer flow setup\n** API user credentials\n** API rate limit monitoring\n* Documentation\n** Salesforce field mapping specification\n** Webhook configuration guide\n** Data isolation architecture diagram\n** API authentication setup guide\n\n==== Dependencies\n\n*Prerequisites*:\n\n* Viva Energy Salesforce admin team engagement\n* Salesforce governance approval (multi-tenant environment)\n* Technical decision on webhook mechanism (Platform Events vs Outbound Messages)\n* Technical decision on authentication method (OAuth 2.0 JWT bearer flow recommended)\n\n*Dependent Work Packages*:\n\n* None (can start in parallel with development work packages)\n* Required for <<wp-cs-002,WP-CS-002>> (EngagementService needs field mapping)\n* Required for <<wp-cs-006,WP-CS-006>> (Integration Testing needs sandbox configuration)\n\n==== Skills Required\n\n* Salesforce administration\n* Salesforce configuration (Record Types, Queues, Validation Rules)\n* Salesforce API integration (REST API, Platform Events, Outbound Messages)\n* Salesforce security and authentication (OAuth, Connected Apps)\n* Multi-tenant data isolation patterns\n\n==== Acceptance Criteria\n\n* Salesforce sandbox configured with all custom fields, Record Types, Queues\n* Field mapping documented and approved by OTR business stakeholders\n* Webhook configuration tested and delivering Case update notifications\n* Data isolation validated (OTR data separate from other Viva Energy business units)\n* API authentication working for ProfileService and EngagementService\n* Salesforce API rate limits monitored and acceptable for expected volume\n* Configuration replicated to Salesforce production environment\n\n[[wp-cs-008]]\n=== WP-CS-008: Contact Data Migration\n\n==== Description\n\nExecute one-time Contact migration from app-specific database to Salesforce Service Cloud production.\n\n==== Deliverables\n\n* Pre-migration activities\n** Final validation of migration tool in sandbox\n** Communication plan (notify users of maintenance window if needed)\n** Freeze app-specific database Contact updates\n** Backup app-specific database\n** Export snapshot of Salesforce Contacts (rollback preparation)\n* Migration execution\n** Execute migration tool against Salesforce production\n** Monitor migration progress\n** Handle failed upserts (manual intervention if needed)\n* Post-migration validation\n** 100% Contact reconciliation (app database vs Salesforce)\n** Email/phone/VCI matching accuracy report\n** Reconciliation report (Contacts created vs updated)\n** Data integrity checks (no duplicate Contacts, no missing Contacts)\n* ProfileService smoke testing\n** Verify Contact ID retrieval works in production\n** Test cache behavior\n** Validate Salesforce Contact upserts from ProfileService\n* Migration report\n** Total Contacts migrated\n** Contacts created vs updated\n** Failed upserts (if any) with resolution\n** Matching accuracy metrics\n** Migration execution time\n\n==== Dependencies\n\n*Prerequisites*:\n\n* <<wp-cs-004,WP-CS-004>> (Contact Migration Tooling) completed\n* <<wp-cs-001,WP-CS-001>> (ProfileService Development) deployed to production (not yet integrated with Mobile App)\n* <<wp-cs-007,WP-CS-007>> (Salesforce Configuration) production configuration completed\n* Salesforce production access granted\n* Migration approved by business stakeholders\n\n*Dependent Work Packages*:\n\n* Must complete after <<wp-cs-001,WP-CS-001>>, <<wp-cs-004,WP-CS-004>>, <<wp-cs-007,WP-CS-007>>\n* Must complete before <<wp-cs-009,WP-CS-009>> (Production Deployment)\n\n==== Skills Required\n\n* Data migration execution\n* Salesforce administration\n* Database operations\n* Data validation and reconciliation\n* Incident management (if issues arise)\n\n==== Acceptance Criteria\n\n* 100% of Contacts migrated with zero data loss\n* Email/phone/VCI matching accuracy > 95%\n* ProfileService smoke tests pass in production\n* Reconciliation report approved by business stakeholders\n* App-specific database Contact updates frozen (read-only mode)\n* Rollback procedure ready (but not executed if migration successful)\n\n[[wp-cs-009]]\n=== WP-CS-009: Production Deployment\n\n==== Description\n\nDeploy all solution components to production and execute cutover from D365 CE to Salesforce Service Cloud.\n\n==== Deliverables\n\n* Production deployment\n** EngagementService deployed to production\n** Event Bus production infrastructure validated\n** Salesforce webhook configured in production\n** Mobile App released to production (App Store, Google Play)\n* Go-live activities\n** Smoke testing (end-to-end feedback submission)\n** Feature flag enabled: `enable_salesforce_feedback_submission = ON`\n** D365 CE integration disabled in Mobile App\n** Monitor Event Bus queue depth, DLQ, Salesforce API rate limits\n** Monitor Mobile App feedback submission success rate\n* Go/No-Go decision\n** Validate success criteria before final cutover\n** Business stakeholder approval\n** Technical validation (smoke tests pass, monitoring healthy)\n* Cutover communication\n** Notify support agents of new Salesforce integration\n** Provide training materials for support agents\n** Customer communication (if visible change)\n* Rollback plan\n** Documented rollback procedure\n** Feature flag can disable Salesforce integration and re-enable D365 CE\n** Rollback decision criteria (P1/P2 incidents, feedback submission success rate < 99%)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* <<wp-cs-001,WP-CS-001>> (ProfileService Development) completed\n* <<wp-cs-002,WP-CS-002>> (EngagementService Development) completed\n* <<wp-cs-003,WP-CS-003>> (Event Bus Infrastructure) completed\n* <<wp-cs-005,WP-CS-005>> (Mobile App Integration) completed\n* <<wp-cs-006,WP-CS-006>> (Integration Testing) completed with UAT sign-off\n* <<wp-cs-007,WP-CS-007>> (Salesforce Configuration) production configuration completed\n* <<wp-cs-008,WP-CS-008>> (Contact Data Migration) completed successfully\n* Mobile App release approval (App Store, Google Play)\n\n*Dependent Work Packages*:\n\n* Must complete after all prior work packages (final cutover)\n\n==== Skills Required\n\n* Production deployment and release management\n* Incident management and troubleshooting\n* Monitoring and observability\n* Change management and communication\n* Rollback execution (if needed)\n\n==== Acceptance Criteria\n\n* Mobile App feedback submission success rate > 99.5%\n* End-to-end flow validated (Mobile App → ProfileService → EngagementService → Salesforce Case created)\n* Braze push notifications delivered successfully\n* Event Bus queue depth normal, DLQ empty\n* No critical incidents (P1/P2) in first 24 hours\n* D365 CE integration disabled\n* Support agents successfully using Salesforce for OTR digital customer Cases\n\n[[wp-cs-010]]\n=== WP-CS-010: Post-Cutover Support\n\n==== Description\n\nMonitor production stability, resolve issues, validate success criteria, and execute D365 CE retirement.\n\n==== Deliverables\n\n* Monitoring and support\n** 24/7 on-call support for first week post-cutover\n** Daily monitoring reports (feedback submission success rate, Case creation success rate)\n** Incident response and resolution\n** Performance tuning (if needed)\n* Success criteria validation\n** Validate feedback submission success rate > 99.5%\n** Monitor customer satisfaction score (target: +15% improvement within 6 months)\n** Monitor average case resolution time (target: -20% improvement within 6 months)\n** Support agent feedback survey\n* D365 CE retirement\n** D365 CE set to read-only mode (historical Case lookups only)\n** Archive D365 CE data for compliance/auditing\n** Decommission D365 CE infrastructure (after 90-day stabilization period)\n** Remove D365 CE integration code from Mobile App\n* Documentation updates\n** Production runbook\n** Troubleshooting guide (based on incidents resolved)\n** Operational procedures for support team\n** Lessons learned document\n\n==== Dependencies\n\n*Prerequisites*:\n\n* <<wp-cs-009,WP-CS-009>> (Production Deployment) completed\n* Cutover successful with no critical incidents\n\n*Dependent Work Packages*:\n\n* Final work package in sequence\n\n==== Skills Required\n\n* Production support and incident management\n* Performance monitoring and tuning\n* Data archival and compliance\n* Infrastructure decommissioning\n* Documentation\n\n==== Acceptance Criteria\n\n* Zero critical incidents (P1/P2) in first 30 days post-cutover\n* Feedback submission success rate sustained > 99.5%\n* Customer satisfaction improvement validated (baseline established, ongoing measurement)\n* Support agents reporting positive experience with Salesforce unified view\n* D365 CE successfully decommissioned\n* All production documentation complete and approved\n* Lessons learned document published\n\n=== Work Package Sequencing\n\n==== Parallel Track 1: Infrastructure & Configuration\n\nCan start immediately and run in parallel:\n\n* <<wp-cs-003,WP-CS-003>> (Event Bus Infrastructure)\n* <<wp-cs-007,WP-CS-007>> (Salesforce Configuration)\n\n==== Parallel Track 2: Development\n\nCan start after Track 1 infrastructure decisions made:\n\n* <<wp-cs-001,WP-CS-001>> (ProfileService Development) - Independent\n* <<wp-cs-002,WP-CS-002>> (EngagementService Development) - Requires <<wp-cs-003,WP-CS-003>> completed\n* <<wp-cs-004,WP-CS-004>> (Contact Migration Tooling) - Requires <<wp-cs-001,WP-CS-001>> completed (reuses code)\n\n==== Sequential Track 3: Integration & Testing\n\nMust complete after development:\n\n* WP-CS-005 (Mobile App Integration) - Requires WP-CS-001, WP-CS-002\n* WP-CS-006 (Integration Testing) - Requires WP-CS-001, WP-CS-002, WP-CS-003, WP-CS-005, WP-CS-007\n\n==== Sequential Track 4: Migration & Cutover\n\nMust complete sequentially:\n\n* WP-CS-008 (Contact Data Migration) - Requires WP-CS-001, WP-CS-004, WP-CS-006 UAT sign-off\n* WP-CS-009 (Production Deployment) - Requires all prior work packages completed\n* WP-CS-010 (Post-Cutover Support) - Requires WP-CS-009\n\n==== Critical Path\n\nThe critical path for this project is:\n\n. WP-CS-003 (Event Bus Infrastructure)\n. WP-CS-002 (EngagementService Development) - blocks on WP-CS-003\n. WP-CS-005 (Mobile App Integration) - blocks on WP-CS-001, WP-CS-002\n. WP-CS-006 (Integration Testing) - blocks on WP-CS-001 through WP-CS-005, WP-CS-007\n. WP-CS-008 (Contact Data Migration) - blocks on WP-CS-006 UAT sign-off\n. WP-CS-009 (Production Deployment) - blocks on WP-CS-008\n. WP-CS-010 (Post-Cutover Support) - final deliverable\n\nAny delays in critical path work packages will delay the overall cutover date.\n\n<<<\n== Transition Architecture\n\nThis section defines the evolution from baseline (D365 CE) to target state (Salesforce Service Cloud + ProfileService + EngagementService).\n\n=== Transition Approach\n\n*Big Bang Cutover*: Per ADR-CS-006, this transition uses a single cutover approach rather than phased rollout. All users switch from D365 CE to Salesforce simultaneously after Contact migration completion.\n\n=== Transition States\n\n==== TS-0: Baseline State (Current)\n\n===== Characteristics\n\n* D365 Customer Engagement handles all digital customer feedback\n* App-specific database stores customer Contact data\n* No ProfileService or EngagementService\n* No event-driven architecture\n* Synchronous feedback submission\n\n===== Components Active\n\n- D365 Customer Engagement\n- App-specific customer database\n- Mobile App (current version with D365 CE integration)\n\n==== TS-1: Build & Test\n\n===== Activities\n\n* Build ProfileService microservice (JIT Contact reconciliation API)\n* Build EngagementService microservice (feedback submission API, ACL for Salesforce Case creation, Braze integration, webhook receiver)\n* Implement Event Bus infrastructure (SNS+SQS/EventBridge/Kinesis)\n* Develop Contact migration tool (app database → Salesforce upsert by email/phone/VCI)\n* Update Mobile App API integration (ProfileService + EngagementService endpoints - feedback form UI already complete)\n* Integration testing (ProfileService ↔ Salesforce, EngagementService ↔ Salesforce, EngagementService ↔ Braze)\n* UAT with test Salesforce sandbox environment\n\n===== Components Active\n\n- D365 Customer Engagement (still active, unchanged)\n- App-specific customer database (still active)\n- ProfileService (non-production, testing only)\n- EngagementService (non-production, testing only)\n- Event Bus (non-production)\n- Salesforce Sandbox (testing)\n\n===== Exit Criteria\n\n- All integration tests pass\n- UAT sign-off from business stakeholders\n- Contact migration tool validated in sandbox\n- Mobile App updates tested with non-production APIs\n\n==== TS-2: Contact Migration\n\n===== Activities\n* Execute Contact migration (app database → Salesforce production)\n* Validation: 100% data integrity check (email/phone/VCI matching)\n* Reconciliation report: New Contacts created vs existing Contacts updated\n* Freeze app database Contact updates during migration window\n* ProfileService smoke testing (verify Contact lookups work in Salesforce production)\n\n===== Components Active\n- D365 Customer Engagement (still active, users unaffected)\n- Salesforce Production (Contacts migrated, no Cases yet)\n- ProfileService (production deployed, not integrated with Mobile App yet)\n- App-specific customer database (frozen, read-only)\n\n===== Exit Criteria\n- 100% of Contacts migrated with zero data loss\n- Email/phone/VCI matching accuracy > 95%\n- ProfileService smoke tests pass (JIT lookups return correct Contact IDs)\n- Reconciliation report approved\n\n==== TS-3: Cutover (Go-Live)\n\n===== Go-Live Activities\n\n* Deploy EngagementService to production\n* Deploy Mobile App updates (ProfileService + EngagementService API integration)\n* Configure Salesforce webhook (Case update notifications → EngagementService)\n* Smoke testing: End-to-end feedback submission (Mobile App → EngagementService → Salesforce → Braze notification)\n* Monitor Event Bus queue depth, dead letter queue, Salesforce API rate limits\n* **Go/No-Go decision**: Validate success criteria before final cutover\n* Enable feature flag: `enable_salesforce_feedback_submission = ON`\n* Disable D365 CE integration in Mobile App\n\n===== Components Active\n\n- ProfileService (production, integrated with Mobile App)\n- EngagementService (production, integrated with Mobile App)\n- Event Bus (production, processing async Case creation)\n- Salesforce Production (receiving Cases from digital customers)\n- Braze (sending push notifications)\n- Mobile App (new version with Salesforce integration)\n- D365 Customer Engagement (disabled, read-only for historical lookups)\n\n===== Exit Criteria\n\n- Mobile App feedback submission success rate > 99.5%\n- End-to-end flow validated (Mobile App → Salesforce Case created)\n- Braze push notifications delivered successfully\n- Event Bus queue depth normal, DLQ empty\n- No critical incidents (P1/P2) in first 24 hours\n\n==== TS-4: Target State (Stable Production)\n\n===== Characteristics\n\n* ProfileService and EngagementService fully operational\n* All digital customer feedback routed to Salesforce\n* Event-driven architecture established\n* D365 CE decommissioned\n* First DDD bounded contexts implemented successfully\n\n===== Monitoring Period\n\n* Validate success criteria: feedback submission rate > 99.5%, no data loss\n* Monitor customer satisfaction score (target: +15% improvement)\n* Monitor average case resolution time (target: -20% improvement)\n* Support agents using unified Salesforce view across all channels\n\n===== D365 CE Retirement\n\n* D365 CE read-only access for historical Case lookups (if needed)\n* Decommission D365 CE infrastructure after 90 days\n* Archive D365 CE data for compliance/auditing\n\n===== Components Active\n\n- ProfileService (production)\n- EngagementService (production)\n- Event Bus (production)\n- Salesforce Production (system of record)\n- Braze (push notifications)\n- Mobile App (Salesforce integration)\n- App-specific database (deprecated, Contact data no longer updated)\n\n===== Success Criteria Achieved\n\n- All digital customer feedback routed to Salesforce\n- Support agents have unified customer view\n- D365 CE decommissioned\n- Customer satisfaction improved by 15%\n- Average case resolution time decreased by 20%\n- Zero data loss during transition\n\n=== Transition Dependencies\n\n[width=\"100%\",cols=\"40%,60%\",options=\"header\",]\n|===\n|Dependency |Owner/Status\n\n|*Salesforce production access*\n|Viva Energy Salesforce admin team - TBD\n\n|*Salesforce Case field mapping*\n|Viva Energy Salesforce admin team - TBD (map OTR feedback categories to Salesforce fields)\n\n|*Salesforce data isolation strategy*\n|Viva Energy Salesforce admin team - TBD (Record Types, queues, custom fields)\n\n|*Salesforce webhook configuration*\n|Viva Energy Salesforce admin team - TBD (Outbound Messages vs Platform Events)\n\n|*Event Bus infrastructure*\n|OTR Platform team - Existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis)\n\n|*Braze integration*\n|OTR Marketing team - Existing Braze account, EngagementService creates new campaigns\n\n|*Mobile App release window*\n|OTR Mobile team - Coordinate cutover timing with app release schedule\n\n|*App database access*\n|OTR Platform team - Read access for Contact migration\n\n|===\n\n=== Transition Validation Criteria\n\n==== Contact Migration Validation\n\n* 100% of app database Contacts migrated to Salesforce (zero data loss)\n* Email/phone/VCI matching accuracy > 95% (minimize duplicate Contacts)\n* ProfileService JIT lookups return correct Salesforce Contact IDs (smoke test sample)\n* Reconciliation report shows: X new Contacts created, Y existing Contacts updated\n\n==== Cutover Validation\n\n* Mobile App feedback submission success rate > 99.5% (including async Case creation)\n* End-to-end flow validated: Mobile App → ProfileService → EngagementService → Salesforce Case created\n* Braze push notifications delivered for Case creation and Case resolution\n* Event Bus queue depth within normal range (no backlog)\n* Dead letter queue empty (no failed Case creations)\n* Salesforce API rate limits not exceeded\n\n==== Production Monitoring (30 days)\n\n* Customer satisfaction score improves by 15% (compared to D365 CE baseline)\n* Average case resolution time decreases by 20% (Salesforce vs D365 CE)\n* Support agents confirm unified customer view across all channels\n* Zero critical incidents (P1 outages, data loss)\n\n=== Rollback Plan\n\n==== Rollback Triggers\n\n* Feedback submission success rate < 95% (below acceptable threshold)\n* Data loss or corruption detected in Salesforce\n* Salesforce API rate limits exceeded (Cases not created within SLA)\n* Critical bug blocking customer feedback submission\n\n==== Rollback Procedure\n\n1. **Revert Mobile App** to previous version (remove ProfileService/EngagementService integration, restore D365 CE integration)\n2. **Stop EngagementService** Case creation (prevent duplicate Cases in Salesforce)\n3. **Re-enable D365 CE** for customer feedback submission\n4. **Investigate root cause** (EngagementService logs, Salesforce API errors, Event Bus queue issues)\n5. **Fix and re-test** in sandbox environment\n6. **Retry cutover** when issues resolved\n\n==== Rollback Limitations\n\n* Cases created in Salesforce during cutover period remain in Salesforce (no reverse migration)\n* Contacts migrated to Salesforce remain (no rollback to app database)\n* Rollback only affects Mobile App integration (not data migration)\n\n=== Architectural Scope Boundaries\n\n==== Capabilities Included\n\n===== Business Capabilities\n\n* **Customer Feedback Submission**: Mobile App users can submit structured feedback (Category, Store Name, Time of Visit, Phone, Free Text Message) via EngagementService\n* **Customer Contact Management**: Just-In-Time (JIT) Contact reconciliation with Salesforce via ProfileService, ensuring every Mobile App user has a Salesforce Contact record\n* **Case Management Integration**: EngagementService creates Salesforce Cases asynchronously for customer feedback, support agents manage Cases in Salesforce Service Cloud\n* **Customer Notifications**: Push notifications via Braze when Cases are created, updated, or resolved (bidirectional integration: Mobile App → Salesforce → Mobile App)\n* **Unified Customer View**: Support agents see OTR digital customer feedback alongside other Viva Energy channels (fuel wholesale, Shell Card, retail) in single Salesforce instance\n* **Contact Data Migration**: One-time migration of app-specific customer database Contacts to Salesforce with upsert logic (email/phone/VCI matching)\n\n===== Technical Capabilities\n\n* **ProfileService Bounded Context**: First DDD bounded context implementation - JIT Contact reconciliation, Salesforce API facade, foundation for Flybuys integration\n* **EngagementService Bounded Context**: First DDD bounded context implementation - Customer feedback submission BFF, Anti-Corruption Layer for Salesforce, Braze integration orchestration\n* **Event-Driven Architecture**: Domain event publishing via Event Bus (SNS+SQS/EventBridge/Kinesis) for `SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted` events\n* **Async Processing Pattern**: Non-blocking Case creation with retry logic, exponential backoff, dead letter queue for operational resilience\n* **Anti-Corruption Layer Pattern**: EngagementService protects digital channels from Salesforce API changes, translates between OTR domain language and Salesforce\n* **Conformist Pattern**: ProfileService and EngagementService conform to existing Salesforce configuration (shared Viva Energy instance, multi-tenant governance)\n* **Salesforce Integration**: REST API integration for Contact CRUD and Case creation, webhook receiver for Case update notifications\n* **Braze Integration**: Push notification campaign triggers for Case lifecycle events (created, updated, resolved)\n* **Observability & Monitoring**: Dashboards, metrics, alerting for feedback submission rate, queue depth, API errors, Case creation latency\n* **Feature Flag Management**: Kill switches for emergency rollback (enable_salesforce_feedback_submission, enable_async_case_creation, etc.)\n\n==== Capabilities Excluded\n\n===== Business Capabilities Explicitly Out of Scope\n\n* **Historical Case Migration**: D365 CE Cases not migrated to Salesforce (ADR-CS-005 - fresh start, no Case migration)\n* **Multi-Channel Feedback Submission**: Web app, POS, call centre, email feedback channels not included (Mobile App only in this phase)\n* **Case Resolution by Digital Channels**: Support agents resolve Cases in Salesforce, not via Mobile App self-service\n* **Knowledge Base Integration**: Salesforce Knowledge Base articles not surfaced in Mobile App (future enhancement)\n* **Live Chat/Messaging**: Real-time chat support not included (Salesforce omnichannel capabilities not activated)\n* **Sentiment Analysis**: Automated feedback sentiment analysis not included (future enhancement with AI/ML)\n* **Customer Satisfaction Surveys**: Post-resolution CSAT surveys not included (separate initiative)\n* **Case Attachments**: Mobile App feedback submission does not support file uploads (photos, receipts) - text only\n* **Agent Desktop Integration**: Custom Salesforce UI for support agents not included (use standard Salesforce Service Console)\n* **Social Media Feedback**: Facebook, Twitter, Instagram feedback channels not integrated\n\n===== Technical Capabilities Explicitly Out of Scope\n\n* **Event Sourcing**: Domain events are ephemeral (not persisted for event sourcing/replay) - Event Bus only, no Event Store\n* **CQRS (Command Query Responsibility Segregation)**: ProfileService and EngagementService use same data model for reads/writes (no separate read models)\n* **Local Aggregate Persistence**: ProfileService and EngagementService are stateless (Salesforce is System of Record, no local database for Contact/Case)\n* **Saga Orchestration**: No distributed transactions or saga patterns required (single-step Case creation, not multi-step workflow)\n* **API Gateway Advanced Features**: Rate limiting, API versioning, API key management deferred to detailed design (basic routing only)\n* **GraphQL API**: ProfileService and EngagementService expose REST APIs only (GraphQL not required)\n* **Real-Time Sync**: Salesforce Contact updates by support agents not synced back to ProfileService (eventual consistency acceptable via JIT reconciliation)\n* **Multi-Region Deployment**: Single AWS region deployment (no multi-region failover/disaster recovery in this phase)\n* **Blue-Green Deployment**: Big bang cutover (ADR-CS-006), not blue-green or canary deployment strategy\n* **A/B Testing Framework**: Feature flags for rollback only, not for A/B testing or experimentation\n* **Custom Authentication**: Microsoft Entra External ID used for Mobile App authentication (no custom authentication logic in ProfileService/EngagementService)\n* **Data Residency Compliance**: Salesforce data residency governed by Viva Energy Salesforce configuration (no OTR-specific data residency requirements)\n\n===== Future Bounded Contexts Not in Scope\n\n* **LoyaltyService**: Flybuys integration, reward preferences, transaction adjudication (separate initiative)\n* **LocationService**: Store finder, proximity features, geofencing (separate initiative)\n* **PaymentService**: Payment processing, subscription billing (separate initiative)\n* **RecommendationService**: Personalized recommendations, next-best offers (separate initiative)\n\n===== Integration Patterns Not in Scope\n\n* **Shared Kernel**: No shared domain model between ProfileService and EngagementService (separate bounded contexts with clear boundaries)\n* **Partnership**: No joint development or coordination with external teams (Conformist pattern - we conform to Salesforce)\n* **Customer-Supplier (we're upstream)**: No downstream systems depend on ProfileService/EngagementService APIs yet (future bounded contexts will consume domain events)\n\n==== Architectural Dependencies on Future Initiatives\n\n*This Architecture Enables Future Initiatives*:\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Future Initiative |Architectural Enablement\n\n|*Flybuys Integration*\n|**ProfileService Contact Reconciliation Reused**: ProfileService establishes pattern for JIT Contact reconciliation with Salesforce, which will be extended for Flybuys partner linking (link:../architecture_definitions/flybuys_integration.adoc[see Flybuys Integration architecture]) +\n**Event Bus Infrastructure**: Domain event publishing pattern (`CustomerEnrolledInLoyalty`, `PartnerLinked`, etc.) reuses Event Bus established for EngagementService\n\n|*LoyaltyService Bounded Context*\n|**Event Bus Subscription**: LoyaltyService will consume `CustomerProfileCreated` events published by ProfileService (future enhancement) +\n**Salesforce Contact Integration**: LoyaltyService may query Salesforce Contacts for customer reward preferences (via ProfileService facade or direct Salesforce API)\n\n|*Web App Feedback Submission*\n|**EngagementService API Reuse**: Web app will call same EngagementService REST API for feedback submission (multi-channel support) +\n**Conformist Pattern**: Web app conforms to EngagementService API contract (no translation required)\n\n|*Multi-Channel Customer Support*\n|**EngagementService Extension**: Add support for email, call centre, POS feedback channels (extend EngagementService to handle multiple origins) +\n**Salesforce Case Origin Field**: Cases already tagged with Origin=Mobile App, extend to Origin=Web, POS, Call Centre, Email\n\n|*Knowledge Base Integration*\n|**EngagementService API Extension**: Add endpoint to query Salesforce Knowledge Base articles, surface in Mobile App for self-service support +\n**Anti-Corruption Layer**: EngagementService translates Salesforce Knowledge API to OTR domain language\n\n|*Customer Satisfaction Surveys*\n|**Event-Driven Trigger**: Subscribe to `SupportCaseResolved` events published by EngagementService, trigger CSAT survey via Braze +\n**Braze Integration Pattern**: Reuse EngagementService → Braze integration pattern for survey campaigns\n\n|*Sentiment Analysis*\n|**Event Subscription**: Subscribe to `CustomerFeedbackSubmitted` events, analyse feedback sentiment (AI/ML service) +\n**EngagementService Extension**: Enrich Case with sentiment score before creating in Salesforce\n\n|*RecommendationService Bounded Context*\n|**Event Subscription**: RecommendationService subscribes to `SupportCaseCreated` events to understand customer pain points and personalize recommendations +\n**Domain Event Pattern**: Reuse Event Bus publishing pattern established by EngagementService\n\n|===\n\n*This Architecture Depends on Future Initiatives*:\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Future Initiative |Dependency Description\n\n|*Salesforce Data Isolation Strategy*\n|**BLOCKER**: Viva Energy Salesforce admin team must define data isolation strategy (Record Types, custom fields, queues) before production deployment +\n**Impact**: Multi-tenant data visibility and security governance\n\n|*Salesforce Case Field Mapping*\n|**BLOCKER**: Viva Energy Salesforce admin team must define field mapping for OTR feedback categories (App, Service, Order, Rewards, Refund, Delete Account) +\n**Impact**: Case creation logic in EngagementService depends on finalized Salesforce schema\n\n|*Salesforce Webhook Mechanism*\n|**BLOCKER**: Viva Energy Salesforce admin team must configure webhook mechanism (Outbound Messages vs Platform Events vs Process Builder) for Case update notifications +\n**Impact**: EngagementService webhook receiver implementation depends on chosen mechanism\n\n|*Event Bus Technology Selection*\n|**DECISION REQUIRED**: Choose Event Bus implementation (SNS+SQS vs EventBridge vs Kinesis) for domain event publishing +\n**Impact**: Infrastructure provisioning, event schema design, consumer implementation\n\n|*Microservice Hosting Platform*\n|**DECISION REQUIRED**: Choose hosting platform for ProfileService and EngagementService (AWS Lambda vs ECS vs EKS) +\n**Impact**: Deployment architecture, auto-scaling strategy, operational overhead\n\n|*Observability Platform*\n|**DECISION REQUIRED**: Choose observability platform (AWS CloudWatch vs Datadog vs New Relic) for monitoring and alerting +\n**Impact**: Dashboard configuration, metric collection, alerting setup\n\n|===\n\n*Future Work After This Initiative*:\n\n* **Event Schema Registry**: Implement event schema versioning and registry for domain events (currently ad-hoc schemas)\n* **API Versioning Strategy**: Define API versioning approach for ProfileService and EngagementService (currently v1 only)\n* **Multi-Region Deployment**: Extend to multi-region for disaster recovery and global availability\n* **Event Store**: Persist domain events for event sourcing and audit trail (currently ephemeral Event Bus only)\n* **CQRS Pattern**: Separate read models for high-volume queries (currently same model for reads/writes)\n* **GraphQL API**: Expose GraphQL API for flexible client queries (currently REST only)\n* **Real-Time Sync**: Bi-directional sync between Salesforce and ProfileService for Contact updates (currently JIT reconciliation only)\n\n=== Technical Risks and Mitigation\n\n[width=\"100%\",cols=\"5%,20%,25%,25%,25%\",options=\"header\",]\n|===\n|ID |Risk |Impact |Likelihood |Mitigation\n\n|RISK-CS-001\n|*Salesforce API rate limits exceeded*: High feedback volume exceeds Salesforce API limits, Cases not created\n|HIGH (customers don't receive Case confirmation, support tickets lost)\n|MEDIUM (volume unknown, rate limits TBD)\n|• Gather expected feedback volume data before cutover +\n• Implement Event Bus queue throttling/rate limiting +\n• Monitor queue depth and API usage +\n• Scale background workers based on queue depth +\n• Alert ops team when approaching rate limits\n\n|RISK-CS-002\n|*Salesforce downtime*: Salesforce Service Cloud outage prevents Case creation\n|MEDIUM (Cases delayed but queued, customers wait for confirmation)\n|LOW (Salesforce SLA 99.9% uptime)\n|• Async Case creation with retry logic +\n• Event Bus queues buffer work during outage +\n• Customers get immediate \"Feedback submitted\" (not blocked) +\n• Monitor Salesforce status page, alert ops team +\n• Automatic retry when Salesforce recovers\n\n|RISK-CS-003\n|*Contact migration data quality issues*: App database Contact data incomplete or invalid\n|HIGH (migration fails validation, cutover delayed)\n|MEDIUM (legacy data quality unknown)\n|• Pre-migration data quality assessment +\n• Flexible upsert logic (match by email/phone/VCI) +\n• Validation report identifies data issues before production migration +\n• Manual cleanup for invalid records +\n• Dry-run migration in sandbox environment\n\n|RISK-CS-004\n|*Duplicate Contacts created*: Email matching fails, ProfileService creates duplicate Contacts\n|MEDIUM (support agents see multiple profiles for same customer)\n|MEDIUM (email changes, data quality issues)\n|• Salesforce duplicate detection rules (if available) +\n• ProfileService logs Contact creation for audit trail +\n• Manual duplicate cleanup process (support team) +\n• Future enhancement: VCI as Salesforce External ID for stable matching\n\n|RISK-CS-005\n|*Dead letter queue accumulation*: Failed Case creations not processed, queue grows\n|HIGH (customers don't receive Case confirmation, feedback lost)\n|LOW (retry logic handles most failures)\n|• Dead letter queue monitoring and alerting +\n• Ops team dashboard showing DLQ depth +\n• Manual intervention process (investigate and reprocess) +\n• Automated alerts when DLQ depth exceeds threshold +\n• Root cause analysis for recurring failures\n\n|RISK-CS-006\n|*Salesforce webhook failures*: Salesforce can't deliver Case update notifications to EngagementService\n|MEDIUM (customers don't get push notifications for Case resolution)\n|LOW (webhook mechanism reliable)\n|• Webhook retry logic and exponential backoff +\n• EngagementService logs webhook deliveries +\n• Monitor webhook delivery success rate +\n• Fallback: Poll Salesforce API for Case updates (if webhook fails persistently) +\n• Alert ops team when webhook delivery rate drops\n\n|RISK-CS-007\n|*Multi-tenant data isolation breach*: OTR digital Cases visible to other Viva Energy support teams\n|HIGH (privacy violation, compliance risk)\n|LOW (Salesforce governance controls)\n|• Work with Viva Energy Salesforce admin team on data isolation strategy +\n• Test data visibility in Salesforce sandbox (UAT with different user roles) +\n• Validate Record Types, queues, field-level security before production +\n• Audit Salesforce user permissions and sharing rules\n\n|RISK-CS-008\n|*Mobile App release coordination*: App release delayed, cutover window missed\n|MEDIUM (cutover delayed, D365 CE retirement delayed)\n|MEDIUM (release schedule conflicts)\n|• Coordinate cutover timing with Mobile team early +\n• Buffer time in migration plan (2-week contingency) +\n• Decouple backend deployment from Mobile App release (backend deployed first, app follows) +\n• Feature flag for feedback submission (enable when ready)\n\n|RISK-CS-009\n|*Event Bus infrastructure issues*: SNS/SQS/EventBridge downtime or misconfiguration\n|HIGH (Case creation blocked, domain events not published)\n|LOW (AWS SLA 99.99% uptime)\n|• Leverage existing AWS infrastructure (proven, reliable) +\n• Infrastructure as Code (IaC) for Event Bus configuration +\n• Integration testing in non-production environment +\n• Monitor Event Bus metrics (queue depth, throughput, errors) +\n• Alert ops team on Event Bus failures\n\n|RISK-CS-010\n|*Team DDD knowledge gap*: Team unfamiliar with DDD patterns, bounded contexts, event-driven architecture\n|MEDIUM (implementation delays, architectural inconsistencies)\n|HIGH (first DDD implementation)\n|• DDD training for development team (workshops, documentation) +\n• Architecture review sessions (validate bounded context design) +\n• Pair programming with experienced DDD practitioners +\n• Incremental implementation (start small, iterate) +\n• Document architectural patterns in CLAUDE.md\n\n|===\n\n== Assumptions and Constraints\n\n=== Assumptions\n\n[width=\"100%\",cols=\"8%,92%\",options=\"header\",]\n|===\n|ID |Assumption\n\n|ASM-CS-001\n|Viva Energy Salesforce admin team will provide Salesforce production access, sandbox environment, and support for Case field mapping and data isolation configuration\n\n|ASM-CS-002\n|App database Contact data is sufficiently complete for migration (email/phone/VCI available for matching)\n\n|ASM-CS-003\n|Expected customer feedback volume (100-150 submissions/day from 20k DAU) is well within Salesforce API rate limits, with capacity planning for 3x-10x growth\n\n|ASM-CS-004\n|Existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis) is sufficient for Event Bus implementation (no additional infrastructure provisioning required)\n\n|ASM-CS-005\n|Braze integration already exists and can be extended for Case-related push notifications (no new Braze account or major configuration changes)\n\n|ASM-CS-006\n|Mobile App users have email addresses associated with their accounts (required for ProfileService Contact reconciliation)\n\n|ASM-CS-007\n|D365 Customer Engagement historical Cases have limited business value and do not require migration to Salesforce\n\n|ASM-CS-008\n|Support agents are trained on Salesforce Service Cloud and require minimal additional training for OTR digital customer Cases\n\n|ASM-CS-009\n|Salesforce Service Cloud shared instance has capacity for OTR digital customer Contacts and Cases (no additional licensing or storage costs)\n\n|ASM-CS-010\n|Mobile App release schedule can accommodate cutover timing (Week 10 in migration plan)\n\n|===\n\n=== Constraints\n\n[width=\"100%\",cols=\"8%,92%\",options=\"header\",]\n|===\n|ID |Constraint\n\n|CON-CS-001\n|Must use shared Viva Energy Salesforce Service Cloud instance (cannot deploy separate OTR-specific instance)\n\n|CON-CS-002\n|Must conform to existing Salesforce configuration and governance (Record Types, custom fields, queues, data isolation strategy defined by Viva Energy admin team)\n\n|CON-CS-003\n|Contact migration must complete before Mobile App cutover (no parallel run of D365 CE and Salesforce)\n\n|CON-CS-004\n|Big bang cutover only (no phased rollout with feature flags or pilot users)\n\n|CON-CS-005\n|Salesforce API rate limits and authentication method constrained by Viva Energy Salesforce configuration (TBD)\n\n|CON-CS-006\n|Event Bus implementation must use existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis - cannot introduce new infrastructure components)\n\n|CON-CS-007\n|Mobile App feedback form must include specific fields: Category, Store Name, Time of Visit, Contact Phone Number, Free Text Message (no attachments)\n\n|CON-CS-008\n|D365 Customer Engagement must be decommissioned within 90 days post-cutover (ADR-CS-006)\n\n|CON-CS-009\n|ProfileService and EngagementService must be stateless (no local aggregate persistence, Salesforce is System of Record)\n\n|CON-CS-010\n|First DDD bounded context implementation (team learning curve, architectural patterns must be documented for future bounded contexts)\n\n|===\n\n== Non-Functional Requirements\n\n=== Performance Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-PERF-001\n|Mobile App feedback submission API response time (ProfileService + EngagementService)\n|p95 < 1 second, p99 < 2 seconds\n\n|NFR-PERF-002\n|ProfileService Contact reconciliation API response time (JIT lookup)\n|p95 < 500ms, p99 < 1 second\n\n|NFR-PERF-003\n|EngagementService async Case creation latency (end-to-end: feedback submitted → Case created in Salesforce)\n|p95 < 5 minutes, p99 < 10 minutes\n\n|NFR-PERF-004\n|Salesforce API call latency (Contact query, Contact create, Case create)\n|p95 < 2 seconds, p99 < 5 seconds\n\n|NFR-PERF-005\n|Event Bus message processing throughput\n|> 100 messages/second (support peak feedback volume)\n\n|NFR-PERF-006\n|Braze push notification delivery latency (Case created → notification delivered)\n|p95 < 30 seconds, p99 < 60 seconds\n\n|===\n\n=== Availability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-AVAIL-001\n|ProfileService availability\n|99.9% uptime (8.76 hours downtime/year)\n\n|NFR-AVAIL-002\n|EngagementService availability\n|99.9% uptime (8.76 hours downtime/year)\n\n|NFR-AVAIL-003\n|Feedback submission success rate (including async Case creation)\n|> 99.5% (includes retry logic for transient failures)\n\n|NFR-AVAIL-004\n|Graceful degradation: Salesforce downtime handling\n|Feedback submission still succeeds, Cases queued for async creation when Salesforce recovers\n\n|NFR-AVAIL-005\n|Graceful degradation: Braze downtime handling\n|Case creation proceeds, push notifications disabled temporarily (feature flag)\n\n|NFR-AVAIL-006\n|Planned maintenance window\n|< 4 hours/month, scheduled during low-traffic periods (2-6am ACST)\n\n|===\n\n=== Scalability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-SCALE-001\n|Concurrent Mobile App users (peak)\n|Support 20,000 DAU (Daily Active Users), ~150 concurrent users submitting feedback during peak hours\n\n|NFR-SCALE-002\n|Feedback submissions per day\n|Expected: 100-150 submissions/day based on 20k DAU (~0.5-0.75% submission rate) +\nCapacity: Support 500 submissions/day (3x expected volume for growth), 2,000 submissions/day (peak/incident scenarios)\n\n|NFR-SCALE-003\n|Auto-scaling: ProfileService and EngagementService\n|Auto-scale based on CPU/memory/request rate, scale up within 2 minutes\n\n|NFR-SCALE-004\n|Event Bus queue capacity\n|Support 100,000 queued messages (buffer for Salesforce downtime)\n\n|NFR-SCALE-005\n|Salesforce API rate limit compliance\n|Stay within 80% of Salesforce API rate limits (buffer for spikes)\n\n|NFR-SCALE-006\n|Future growth capacity\n|Architecture supports 10x growth (1,000-1,500 submissions/day based on 200k DAU) without major redesign\n\n|===\n\n=== Security Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-SEC-001\n|Mobile App authentication\n|Microsoft Entra External ID OAuth 2.0 with JWT tokens (existing CIAM)\n\n|NFR-SEC-002\n|API authorisation: ProfileService and EngagementService\n|JWT token validation, authenticated users only, user context propagation\n\n|NFR-SEC-003\n|Salesforce API authentication\n|OAuth 2.0 with Connected App and JWT bearer flow (service account)\n\n|NFR-SEC-004\n|Data encryption in transit\n|TLS 1.2+ for all API calls (Mobile App ↔ ProfileService/EngagementService ↔ Salesforce ↔ Braze)\n\n|NFR-SEC-005\n|Data encryption at rest\n|Salesforce encryption at rest (managed by Salesforce), Event Bus message encryption (AWS KMS)\n\n|NFR-SEC-006\n|Secret management\n|AWS Secrets Manager for Salesforce credentials, Braze API keys, OAuth tokens (no hardcoded secrets)\n\n|NFR-SEC-007\n|PII data handling\n|Contact data (email, phone, name) treated as PII, GDPR-compliant retention policies (Salesforce governance)\n\n|NFR-SEC-008\n|API rate limiting and throttling\n|API Gateway rate limiting (100 requests/second per user), prevent abuse and DoS\n\n|NFR-SEC-009\n|Logging and auditing\n|Log all API calls, Salesforce Contact/Case creates/updates, Event Bus publishes (no PII in logs)\n\n|NFR-SEC-010\n|Salesforce data isolation\n|Multi-tenant data isolation via Salesforce Record Types, queues, sharing rules (defined by Viva Energy admin team)\n\n|===\n\n=== Reliability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-REL-001\n|Retry logic: EngagementService → Salesforce Case creation\n|Exponential backoff (1s, 2s, 4s, 8s, 16s), max 5 retries, then dead letter queue\n\n|NFR-REL-002\n|Dead letter queue monitoring\n|Alert ops team immediately when DLQ depth > 0 (failed Case creations require manual intervention)\n\n|NFR-REL-003\n|Event Bus message durability\n|Messages persisted in Event Bus (SNS+SQS/EventBridge/Kinesis), not lost on service restart\n\n|NFR-REL-004\n|Idempotency: Case creation\n|EngagementService ensures duplicate feedback submissions don't create duplicate Cases (idempotency key)\n\n|NFR-REL-005\n|Circuit breaker: Salesforce API calls\n|Open circuit after 5 consecutive failures, half-open retry after 30 seconds\n\n|NFR-REL-006\n|Health checks: ProfileService and EngagementService\n|Health endpoints for load balancer checks, readiness and liveness probes\n\n|NFR-REL-007\n|Disaster recovery: Event Bus\n|Event Bus messages replicated across AWS availability zones (SQS/EventBridge/Kinesis HA)\n\n|===\n\n=== Maintainability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-MAINT-001\n|Code quality: ProfileService and EngagementService\n|> 80% test coverage (unit + integration tests), automated CI/CD pipeline\n\n|NFR-MAINT-002\n|API documentation\n|OpenAPI/Swagger specs for ProfileService and EngagementService, auto-generated API docs\n\n|NFR-MAINT-003\n|Deployment automation\n|Infrastructure as Code (Terraform/CloudFormation/CDK), zero-downtime deployments\n\n|NFR-MAINT-004\n|Logging: structured logs\n|JSON-formatted logs with correlation IDs, log levels (DEBUG, INFO, WARN, ERROR), centralized log aggregation\n\n|NFR-MAINT-005\n|Monitoring dashboards\n|Real-time dashboards for ProfileService, EngagementService, Event Bus (see Monitoring and Observability section)\n\n|NFR-MAINT-006\n|Alerting and on-call\n|PagerDuty/Opsgenie integration for P1/P2 alerts, on-call rotation for ops team\n\n|NFR-MAINT-007\n|Configuration management\n|Externalized configuration (environment variables, AWS Parameter Store), no hardcoded config\n\n|NFR-MAINT-008\n|Versioning: API and events\n|Semantic versioning (v1, v2), backward compatibility for API changes, event schema evolution\n\n|===\n\n=== Usability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-USE-001\n|Feedback submission UX\n|Mobile App user receives immediate \"Feedback submitted\" confirmation (< 1 second), not blocked by async Case creation\n\n|NFR-USE-002\n|Push notification delivery\n|Customer receives \"Your feedback has been received\" notification within 30 seconds of Case creation in Salesforce\n\n|NFR-USE-003\n|Case resolution notification\n|Customer receives \"Your case has been resolved\" notification within 30 seconds of support agent resolving Case\n\n|NFR-USE-004\n|Error messaging\n|User-friendly error messages for failed feedback submission (not technical errors), retry prompts\n\n|NFR-USE-005\n|Accessibility\n|Mobile App feedback form meets WCAG 2.1 AA accessibility standards (existing Mobile App compliance)\n\n|===\n\n=== Compliance Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-COMP-001\n|GDPR compliance: PII data\n|Customer Contact data (email, phone, name) managed per GDPR retention policies (Salesforce governance)\n\n|NFR-COMP-002\n|GDPR compliance: Right to erasure\n|Support \"Delete Account\" feedback category, trigger Contact deletion in Salesforce per GDPR Article 17\n\n|NFR-COMP-003\n|Data residency\n|Salesforce data residency governed by Viva Energy Salesforce configuration (regional compliance)\n\n|NFR-COMP-004\n|Audit trail\n|All Contact creates/updates, Case creates/updates logged for compliance auditing (Salesforce audit logs)\n\n|NFR-COMP-005\n|API security standards\n|OWASP API Security Top 10 compliance (injection prevention, authentication, authorisation, data exposure)\n\n|===\n\n== Monitoring and Observability\n\n=== Key Metrics\n\n[width=\"100%\",cols=\"25%,40%,35%\",options=\"header\",]\n|===\n|Metric Category |Metric |Target/Threshold\n\n|*Feedback Submission*\n|Feedback submission success rate (Mobile App → EngagementService)\n|> 99.5%\n\n|*Async Case Creation*\n|Case creation success rate (EngagementService → Salesforce)\n|> 99%\n\n|*Async Case Creation*\n|Case creation latency (time from feedback submission to Case created in Salesforce)\n|p95 < 5 minutes\n\n|*Event Bus*\n|Event Bus queue depth (pending Case creations)\n|< 100 messages\n\n|*Event Bus*\n|Dead letter queue depth (failed Case creations)\n|= 0 (alert on any failures)\n\n|*Salesforce API*\n|Salesforce API error rate\n|< 1%\n\n|*Salesforce API*\n|Salesforce API latency (Case creation)\n|p95 < 2 seconds\n\n|*Salesforce API*\n|Salesforce API rate limit utilization\n|< 80% of limit\n\n|*ProfileService*\n|Contact reconciliation success rate (JIT lookups)\n|> 99.5%\n\n|*ProfileService*\n|Contact reconciliation latency\n|p95 < 500ms\n\n|*Braze Notifications*\n|Push notification delivery rate (Case created/updated)\n|> 95%\n\n|*Salesforce Webhook*\n|Webhook delivery success rate (Salesforce → EngagementService)\n|> 99%\n\n|*Customer Satisfaction*\n|Customer satisfaction score (CSAT)\n|> 4.0/5.0 (improve by 15% from D365 CE baseline)\n\n|*Support Operations*\n|Average case resolution time\n|Decrease by 20% from D365 CE baseline\n\n|===\n\n=== Alerting Thresholds\n\n[width=\"100%\",cols=\"25%,50%,25%\",options=\"header\",]\n|===\n|Alert |Condition |Severity\n\n|*Feedback submission failures*\n|Feedback submission success rate < 95% over 5-minute window\n|P1 - Critical\n\n|*Dead letter queue accumulation*\n|Dead letter queue depth > 0 (any failed Case creations)\n|P2 - High\n\n|*Event Bus queue backlog*\n|Event Bus queue depth > 100 messages for > 15 minutes\n|P2 - High\n\n|*Salesforce API errors*\n|Salesforce API error rate > 5% over 5-minute window\n|P1 - Critical\n\n|*Salesforce API rate limits*\n|Salesforce API rate limit utilization > 90%\n|P2 - High\n\n|*Contact reconciliation failures*\n|ProfileService Contact reconciliation failure rate > 5% over 5-minute window\n|P2 - High\n\n|*Braze notification failures*\n|Braze push notification delivery rate < 80% over 15-minute window\n|P3 - Medium\n\n|*Salesforce webhook failures*\n|Salesforce webhook delivery success rate < 90% over 15-minute window\n|P2 - High\n\n|*Case creation latency*\n|Case creation latency p95 > 10 minutes\n|P3 - Medium\n\n|===\n\n=== Dashboards\n\n*ProfileService Dashboard:*\n\n* Contact reconciliation success rate (JIT lookups)\n* Contact reconciliation latency (p50, p95, p99)\n* Contact creation vs update ratio (new Contacts created vs existing Contacts updated)\n* Salesforce API error rate (Contact queries and creates)\n* Request rate and throughput\n\n*EngagementService Dashboard:*\n\n* Feedback submission success rate\n* Case creation success rate (async workflow)\n* Case creation latency (p50, p95, p99)\n* Event Bus queue depth (pending Case creations)\n* Dead letter queue depth (failed Case creations)\n* Salesforce API error rate (Case creation)\n* Salesforce API latency\n* Salesforce API rate limit utilization\n* Braze push notification delivery rate\n* Salesforce webhook delivery success rate\n\n*Event Bus Dashboard:*\n\n* Queue depth (pending messages)\n* Throughput (messages published/consumed per minute)\n* Dead letter queue depth (failed messages)\n* Consumer lag (time between publish and consume)\n\n*Customer Support Dashboard (Business Metrics):*\n\n* Total feedback submissions per day/week/month\n* Feedback category breakdown (App, Service, Order, Rewards, Refund, Delete Account)\n* Customer satisfaction score (CSAT) trend\n* Average case resolution time trend\n* Case volume by support team/queue\n* Unified customer view adoption (support agent feedback)\n<<<\n== Solution Validation\n\nThis section defines the validation criteria and testing approach for the solution.\n\n=== Functional Validation\n\n==== ProfileService API Testing\n\n*Test Scenarios*:\n1. **Happy Path**: Authenticated user requests Contact ID, existing Contact found in Salesforce, Contact ID returned\n2. **JIT Creation**: Authenticated user requests Contact ID, no existing Contact, new Contact created in Salesforce, Contact ID returned\n3. **Salesforce API Failure**: Salesforce unavailable, ProfileService returns 500 error, user retries\n4. **Invalid JWT**: Unauthenticated request, ProfileService returns 401 error\n\n*Acceptance Criteria*:\n- Contact reconciliation success rate > 99.5%\n- JIT Contact creation completes within 500ms (p95)\n\n==== EngagementService API Testing\n\n*Test Scenarios*:\n1. **Happy Path**: Valid feedback submission, immediate 202 Accepted response, Case created in Salesforce within 5 minutes, Braze notification delivered\n2. **Invalid Category**: Invalid feedback category, 400 Bad Request response with validation error\n3. **Salesforce Downtime**: Salesforce unavailable during async Case creation, message queued, retry logic executes, Case created when Salesforce recovers\n4. **Dead Letter Queue**: Case creation fails after 5 retries, message moved to DLQ, ops team alerted\n5. **Webhook Notification**: Support agent resolves Case in Salesforce, webhook triggers EngagementService, Braze push notification sent to customer\n\n*Acceptance Criteria*:\n- Feedback submission success rate > 99.5% (including async Case creation)\n- Async Case creation completes within 5 minutes (p95)\n- Webhook delivery success rate > 99%\n\n=== Non-Functional Validation\n\n==== Performance Testing\n\n*Load Testing*:\n\n*Baseline*: Expected 100-150 submissions/day from 20k DAU (~0.5-0.75% submission rate)\n\n- **Normal Load**: 1 submission/minute sustained for 2 hours (simulate typical daily pattern)\n- **3x Load**: 3 submissions/minute sustained for 1 hour (simulate busy period, 450 submissions/day)\n- **Peak Load (10x)**: 10 submissions/minute for 15 minutes (simulate incident scenario, app outage causing backlog)\n- **Stress Test**: 50 submissions/minute for 5 minutes (find breaking point, 20x normal)\n\n*Validation*:\n- API response time p95 < 1 second under 10x load\n- Event Bus queue depth remains manageable (< 100 messages)\n- No Case creation failures, all submissions processed successfully\n- Auto-scaling triggers appropriately for sustained load > 3x baseline\n\n*Acceptance Criteria*:\n- NFR-PERF-001 through NFR-PERF-006 validated under realistic load (3x and 10x baseline)\n- Auto-scaling triggers within 2 minutes of load increase\n- System handles 10x peak gracefully, 20x stress test identifies limits\n\n==== Resilience Testing\n\n*Salesforce API Failure Scenarios*:\n1. **Complete Outage**: Salesforce unavailable for 2 hours, Event Bus queues buffer work, Cases created when Salesforce recovers\n2. **Rate Limit Exceeded**: Salesforce rate limit hit, queue throttling activates, Cases created within SLA\n\n*Acceptance Criteria*:\n- NFR-AVAIL-004 validated (graceful degradation during Salesforce downtime)\n- Circuit breaker activates after 5 consecutive failures\n\n==== Security Validation\n\n*Penetration Testing*:\n- API authentication bypass attempts\n- SQL injection attempts\n- Webhook signature validation bypass\n\n*Acceptance Criteria*:\n- NFR-SEC-001 through NFR-SEC-010 validated\n- OWASP API Security Top 10 compliance verified\n\n=== Integration Validation\n\n==== End-to-End Testing\n\n*Full User Journey*:\n1. User authenticates via Microsoft Entra External ID\n2. Mobile App requests Contact ID from ProfileService (JIT reconciliation)\n3. User submits feedback via EngagementService\n4. Background worker creates Case in Salesforce\n5. Braze notification delivered to user\n6. Support agent resolves Case in Salesforce\n7. Salesforce webhook triggers EngagementService\n8. Braze notification delivered to user\n\n*Acceptance Criteria*:\n- End-to-end flow completes successfully in UAT\n- User receives both \"feedback submitted\" and \"case resolved\" notifications\n","structuredPatch":[{"oldStart":2213,"oldLines":8,"newStart":2213,"newLines":8,"lines":[" "," Must complete after development:"," ","-* WP-CS-005 (Mobile App Integration) - Requires WP-CS-001, WP-CS-002","-* WP-CS-006 (Integration Testing) - Requires WP-CS-001, WP-CS-002, WP-CS-003, WP-CS-005, WP-CS-007","+* <<wp-cs-005,WP-CS-005>> (Mobile App Integration) - Requires <<wp-cs-001,WP-CS-001>>, <<wp-cs-002,WP-CS-002>>","+* <<wp-cs-006,WP-CS-006>> (Integration Testing) - Requires <<wp-cs-001,WP-CS-001>>, <<wp-cs-002,WP-CS-002>>, <<wp-cs-003,WP-CS-003>>, <<wp-cs-005,WP-CS-005>>, <<wp-cs-007,WP-CS-007>>"," "," ==== Sequential Track 4: Migration & Cutover"," "]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"c6e5a8a7-1404-4c9c-8e93-dfb56a463a5c"}
{"parentUuid":"41fd2be5-eef1-4292-8aa4-b47711f9b321","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01YPJTxXAx61TQ54TeQARNcj","type":"tool_result","content":"The file /mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n  2215→\n  2216→* <<wp-cs-005,WP-CS-005>> (Mobile App Integration) - Requires <<wp-cs-001,WP-CS-001>>, <<wp-cs-002,WP-CS-002>>\n  2217→* <<wp-cs-006,WP-CS-006>> (Integration Testing) - Requires <<wp-cs-001,WP-CS-001>>, <<wp-cs-002,WP-CS-002>>, <<wp-cs-003,WP-CS-003>>, <<wp-cs-005,WP-CS-005>>, <<wp-cs-007,WP-CS-007>>\n  2218→\n  2219→==== Sequential Track 4: Migration & Cutover\n  2220→\n  2221→Must complete sequentially:\n  2222→\n  2223→* <<wp-cs-008,WP-CS-008>> (Contact Data Migration) - Requires <<wp-cs-001,WP-CS-001>>, <<wp-cs-004,WP-CS-004>>, <<wp-cs-006,WP-CS-006>> UAT sign-off\n  2224→* <<wp-cs-009,WP-CS-009>> (Production Deployment) - Requires all prior work packages completed\n  2225→* <<wp-cs-010,WP-CS-010>> (Post-Cutover Support) - Requires <<wp-cs-009,WP-CS-009>>\n  2226→\n  2227→==== Critical Path\n  2228→\n  2229→The critical path for this project is:"}]},"uuid":"5440ee7f-0176-4d15-acc2-6888bb48f43b","timestamp":"2026-01-09T03:12:21.932Z","toolUseResult":{"filePath":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","oldString":"==== Sequential Track 4: Migration & Cutover\n\nMust complete sequentially:\n\n* WP-CS-008 (Contact Data Migration) - Requires WP-CS-001, WP-CS-004, WP-CS-006 UAT sign-off\n* WP-CS-009 (Production Deployment) - Requires all prior work packages completed\n* WP-CS-010 (Post-Cutover Support) - Requires WP-CS-009","newString":"==== Sequential Track 4: Migration & Cutover\n\nMust complete sequentially:\n\n* <<wp-cs-008,WP-CS-008>> (Contact Data Migration) - Requires <<wp-cs-001,WP-CS-001>>, <<wp-cs-004,WP-CS-004>>, <<wp-cs-006,WP-CS-006>> UAT sign-off\n* <<wp-cs-009,WP-CS-009>> (Production Deployment) - Requires all prior work packages completed\n* <<wp-cs-010,WP-CS-010>> (Post-Cutover Support) - Requires <<wp-cs-009,WP-CS-009>>","originalFile":"= Salesforce Customer Support - Solution Architecture\n:project-name: Salesforce Customer Support\n:togaf-adm-phase: Phase E: Opportunities & Solutions\n:last-updated: 2026-01-07\n:document-type: Solution Architecture Document\n:status: Discovery\n:version: 0.1\n:domain: Customer Support & Engagement\n:programme-lead:\n:domain-architect: O.Young@otr.com.au\n:architecture-definition: xref:architecture-definitions:salesforce_customer_support.adoc[Architecture Definitions/Salesforce Customer Support]\n:doctype: article\n:toc: left\n:toclevels: 4\n:sectanchors:\n:sectlinks:\n:sectnums:\n:icons: font\n:source-highlighter: highlightjs\n:experimental:\n:description:\n:keywords:\n\n<<<\n== Purpose and Scope\n\n=== Purpose\n\nThis Solution Architecture defines how the Salesforce Customer Support consolidation will be implemented - the specific technology products, configurations, interfaces, and deployment architecture that realise the xref:architecture-definitions:salesforce_customer_support.adoc[Salesforce Customer Support Architecture Definition].\n\nThis solution establishes the **first implementation of OTR's target Domain-Driven Design (DDD) architecture** by deploying two new bounded contexts (`ProfileService` and `EngagementService`) as microservices, consolidating customer support onto Salesforce Service Cloud, and implementing event-driven integration patterns that will serve as the foundation for future bounded contexts (including Flybuys integration).\n\n=== Vision\n\n> Unify customer support across all OTRG channels by consolidating OTR digital customer feedback onto Salesforce Service Cloud, establishing the foundational DDD architecture with ProfileService and EngagementService bounded contexts that protect digital channels from external system changes while enabling support agents to deliver exceptional customer experiences with complete interaction history.\n\n=== Architectural Approach\n\nThis architecture establishes OTR's **first bounded context implementation** using Domain-Driven Design strategic patterns:\n\n* *link:../bounded_context/profile.adoc[ProfileService]* (NEW bounded context): Just-In-Time Contact reconciliation with Salesforce, upsert by email, returns Salesforce Contact ID to digital channels - foundation for future Flybuys partner linking\n* *link:../bounded_context/engagement.adoc[EngagementService]* (NEW bounded context): Customer feedback submission facade, Anti-Corruption Layer for Salesforce Case creation, Braze integration for all outbound customer communications (push, email, SMS), async Case processing via Event Bus\n* *Event-driven integration* (NEW pattern): Domain event publishing using existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis) - first implementation establishing pattern for future bounded contexts\n* *Anti-Corruption Layer*: EngagementService isolates digital channels from Salesforce API changes, translates between OTR domain language and Salesforce Service Cloud API\n* *Conformist Pattern*: ProfileService and EngagementService conform to existing Salesforce configuration (shared Viva Energy instance, multi-tenant governance)\n* *Big bang cutover*: Single deployment after Contact migration, no phased rollout, D365 CE retirement post-cutover\n\n=== Scope\n\n==== In Scope\n\n* Solution Building Blocks (SBBs) - specific technology products and versions\n* Interface specifications (APIs, events, data formats)\n* Data architecture and schema specifications\n* Deployment architecture and infrastructure configuration\n* Transition architecture with migration phases\n* Technical validation criteria and testing approach\n* External system integration specifications\n* Physical data models and API schemas\n\n==== Out of Scope\n\n===== Covered in xref:architecture-definitions:salesforce_customer_support.adoc[Architecture Definition]\n\n* Business requirements and stakeholder analysis\n* Architecture decisions and rationale (ADRs)\n* Bounded context definitions and responsibilities\n* High-level integration patterns (ACL, Conformist, OHS+PL)\n* Business capability mapping and value streams\n* Architecture principles and governance\n\n===== Covered in Other Documents\n\n* Detailed design (class diagrams, sequence diagrams for all flows)\n* Implementation code and unit tests\n* Business case and return-on-investment analysis\n* Operational run books and support procedures\n\n<<<\n=== Architecture Overview\n\n[mermaid]\n----\n---\nconfig:\n  layout: elk\n---\nflowchart TB\n    Customer([\"Customer\"]) -- Uses --> MobileApp[\"Mobile App<br>iOS/Android\"]\n    Customer -- Shops at --> POS[\"OTR/OTR+ POS<br>D365 Commerce\"]\n    MobileApp -- Authenticate --> EntraID[\"Microsoft Entra\"]\n    MobileApp -- Identifies & Reconciles --> ProfileService[\"ProfileService\"]\n    ProfileService <-- Reconcile App User as Salesforce Contact --> Salesforce[\"Salesforce\"]\n    ProfileService -- On Create --> EventBus[\"EventBus\"]\n    EventBus -- Emits CreateUser Event --> LoyaltyService[\"LoyaltyService\"] & EngagementService[\"EngagementService\"]\n    LoyaltyService -- Reconcile Wallet --> EagleEye[\"EagleEye\"]\n    EngagementService -- Reconcile Braze Profile --> Braze[\"Braze\"]\n    EngagementService --> Salesforce\n    D365CE[\"D365CE\"] -- Data Migration --> Salesforce\n    MobileApp -- Submits Feedback --> EngagementService\n\n    Customer:::customer\n    MobileApp:::presentation\n    POS:::presentation\n    EntraID:::external\n    ProfileService:::newService\n    Salesforce:::external\n    EventBus:::infrastructure\n    LoyaltyService:::newService\n    EngagementService:::newService\n    EagleEye:::external\n    Braze:::external\n    D365CE:::external\n    classDef newService fill:#4CAF50,stroke:#2E7D32,stroke-width:3px,color:#fff\n    classDef external fill:#FF9800,stroke:#E65100,stroke-width:2px,color:#fff\n    classDef infrastructure fill:#2196F3,stroke:#0D47A1,stroke-width:2px,color:#fff\n    classDef presentation fill:#9C27B0,stroke:#4A148C,stroke-width:2px,color:#fff\n    classDef customer fill:#607D8B,stroke:#263238,stroke-width:2px,color:#fff\n----\n\n\n==== Key Architectural Patterns\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Pattern |Application |Rationale\n\n|*Anti-Corruption Layer (ACL)*\n|EngagementService → Salesforce Service Cloud\n|Protects digital channels (Mobile App, Web) from Salesforce API changes, translates between OTR domain language and Salesforce Case/Contact model, enables independent evolution of internal domain model\n\n|*Conformist*\n|ProfileService → Salesforce, EngagementService → Salesforce\n|Shared Viva Energy Salesforce instance - we conform to existing configuration, governance, and API contracts (external system we don't control)\n\n|*Backend-for-Frontend (BFF)*\n|EngagementService\n|Aggregates customer feedback submission, Contact lookup, async Case creation, and Braze notification orchestration for digital channel clients\n\n|*Event-Driven Architecture (OHS+PL)*\n|Event Bus (SNS+SQS/EventBridge/Kinesis)\n|Loose coupling between bounded contexts, async domain event publishing (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`), foundation for future bounded contexts\n\n|*Just-In-Time (JIT) Integration*\n|ProfileService → Salesforce Contact reconciliation\n|Reconcile app users as Salesforce Contacts on-demand (upsert by email), no pre-sync required, ensures Salesforce has current Contact data\n\n|*Async Processing*\n|EngagementService Case creation via Event Bus\n|Non-blocking user experience, resilience to Salesforce downtime, automatic retry with exponential backoff, dead letter queue for operations team intervention\n\n|*Strangler Fig*\n|Not applicable\n|Big bang cutover (no gradual migration) - D365 CE fully replaced, not incrementally strangled\n\n|===\n\n<<<\n== Solution Approach\n\n* Deploy xref:bounded-contexts:profile.adoc[ProfileService] and xref:bounded-contexts:engagement.adoc[EngagementService] as bounded context microservices\n* Implement Anti-Corruption Layers (ACLs) for Salesforce and Braze integration\n* Establish event-driven architecture as the foundational integration pattern\n* Big bang cutover (TS-1 → TS-4)\n\n=== Related Documentation\n\nThis solution architecture references detailed technical specifications:\n\n==== Architecture Definition\n\n* xref:architecture-definitions:salesforce_customer_support.adoc[Salesforce Customer Support - Architecture Definition] - Business requirements, architecture decisions (ADRs), bounded context definitions, high-level integration patterns\n\n==== Bounded Context Specifications\n\n* xref:bounded-contexts:profile.adoc[ProfileService Bounded Context] - JIT Contact reconciliation, aggregate definitions\n* xref:bounded-contexts:engagement.adoc[EngagementService Bounded Context] - Customer feedback facade, Anti-Corruption Layer\n\n==== Interface Specifications\n\nDetailed API specifications available in the specifications directory:\n\n* link:../../specifications/rest/profile-service-v1.yaml[ProfileService REST API v1] - OpenAPI 3.0 specification for `/profile/v1` endpoints (includes Salesforce Contact reconciliation `GET /contact-id`)\n* link:../../specifications/rest/engagement-service-v1.yaml[EngagementService REST API v1] - OpenAPI 3.0 specification for `/engagement/v1` endpoints (includes `POST /feedback`)\n* link:../../specifications/events/engagement-events.json[Engagement Domain Events] - CloudEvents 1.0 JSON Schema for `SupportCaseCreated`, `SupportCaseUpdated`, `SupportCaseResolved`, `CustomerFeedbackSubmitted`\n\n==== External System Documentation\n\n* https://developer.salesforce.com/docs/atlas.en-us.api_rest.meta/api_rest/[Salesforce REST API Documentation] - Contact and Case object APIs\n* https://www.braze.com/docs/api/endpoints/messaging/send_messages/post_send_triggered_campaigns/[Braze Campaign Trigger API] - Push notification campaigns\n\n<<<\n== Executive Summary\n\n=== Challenge\n\nOTR digital customers (Mobile App, Web) currently submit feedback and support requests to D365 Customer Engagement, while Viva Energy's broader business units (fuel wholesale, Shell Card customers, other retail channels) use Salesforce Service Cloud. This creates:\n\n* *Fragmented customer support platform*: Customer support data split across two systems, preventing support agents from having a unified view of customer interactions across all channels\n* *Operational inefficiency*: Maintaining two separate customer support platforms increases operational overhead and costs\n* *Poor support experience*: D365 CE is not working well for digital customer support, impacting customer satisfaction and case resolution times\n* *Post-merger consolidation opportunity*: Following Viva Energy's acquisition of OTR, strategic alignment on Salesforce as the enterprise customer support platform\n\n=== Solution\n\nThis architecture establishes the **foundational Domain-Driven Design (DDD) implementation** for OTR's target state architecture by introducing two new bounded contexts (link:../bounded_context/profile.adoc[ProfileService], link:../bounded_context/engagement.adoc[EngagementService]) and event-driven integration patterns:\n\n==== New Bounded Contexts\n\n* *link:../bounded_context/profile.adoc[ProfileService]* (NEW): Just-In-Time (JIT) Contact reconciliation with Salesforce, upsert by email, returns Salesforce Contact ID to Mobile App\n* *link:../bounded_context/engagement.adoc[EngagementService]* (NEW): Customer feedback submission, Anti-Corruption Layer (ACL) for Salesforce Case creation, Braze integration for all outbound customer communications (push, email, SMS), async Case processing via Event Bus\n* *Event Bus* (NEW pattern): Domain event publishing using existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis) - first implementation of event-driven architecture pattern\n\n==== Integration Architecture\n\n* *Salesforce = System of Record*: Salesforce Service Cloud (shared Viva Energy instance) owns Contact and Case data\n* *Conformist Pattern*: ProfileService and EngagementService conform to existing Salesforce configuration and API contracts\n* *Anti-Corruption Layer*: EngagementService protects digital channels from Salesforce API changes, translates between OTR domain language and Salesforce\n* *Async Case Creation*: Non-blocking user experience, resilience to Salesforce downtime, automatic retry with exponential backoff, dead letter queue for failed Cases\n* *Event-Driven Notifications*: Salesforce webhook → EngagementService → Braze for all customer communications (push, email, SMS) on Case status updates\n\n==== Migration Approach\n\n* *Contact Migration*: One-time migration from app-specific database → Salesforce (upsert with flexible matching by email/phone/VCI)\n* *No Case Migration*: Historical D365 CE Cases not migrated (fresh start in Salesforce)\n* *Big Bang Cutover*: Single deployment, no phased rollout or parallel run\n* *D365 CE Retirement*: Complete decommissioning of D365 Customer Engagement post-cutover\n\n=== Key Architectural Significance\n\nThis migration establishes the first implementation of OTR's target DDD architecture:\n\n* First bounded contexts implemented (ProfileService, EngagementService)\n* First event-driven domain event pattern (foundation for future bounded contexts)\n* Foundation for Flybuys integration (ProfileService Contact reconciliation reused)\n* Establishes integration patterns (Conformist, ACL, Event-Driven) for future services\n\n=== Success Criteria\n\n* All digital customer feedback routed to Salesforce Service Cloud within 30 days of launch\n* Support agents have unified customer view across all Viva Energy channels (digital, wholesale, Shell Card, other retail)\n* D365 Customer Engagement decommissioned within 90 days post-cutover\n* Customer satisfaction score improves by 15% within 6 months\n* Average case resolution time decreases by 20% within 6 months\n* Zero data loss during Contact migration (100% validation pass rate)\n* Mobile App feedback submission success rate > 99.5% (including async Case creation)\n\n=== Technical Constraints\n\n* Shared Salesforce instance (Viva Energy multi-tenant environment)\n* Conform to existing Salesforce configuration and governance (data isolation strategy TBD with Salesforce admin team)\n* Contact migration must complete before cutover (no parallel run)\n* Async Case creation mandatory (non-blocking user experience)\n* Expected volume: 100-150 feedback submissions/day from 20k DAU (~0.5-0.75% submission rate), architecture capacity planned for 3x-10x growth\n\n=== Open Technical Decisions (TBD)\n\n* Salesforce Case field mapping for digital feedback categories (App, Service, Order, Rewards, Refund, Delete Account)\n* Salesforce data isolation strategy (Record Types, custom fields, queues)\n* Salesforce REST API authentication method (OAuth 2.0, Connected App, JWT bearer flow)\n* Salesforce webhook mechanism for Case updates (Outbound Messages, Platform Events, Process Builder)\n* Retry policy configuration (attempts, backoff intervals)\n* Salesforce API rate limit strategy (expected volume: 100-150 submissions/day from 20k DAU, capacity planning for 3x-10x growth)\n\n== Technical Requirements\n\n[width=\"100%\",cols=\"8%,92%\",options=\"header\",]\n|===\n|ID |Description\n\n|TR-CS-001\n|Every Mobile App user must have a Salesforce Contact record in Salesforce Service Cloud (shared Viva Energy instance)\n\n|TR-CS-002\n|ProfileService must reconcile Mobile App users as Salesforce Contacts using Just-In-Time (JIT) upsert by email address\n\n|TR-CS-003\n|ProfileService must return Salesforce Contact ID to Mobile App for feedback submission\n\n|TR-CS-004\n|Mobile App must support customer feedback submission with fields: Category (App, Service, Order, Rewards, Refund, Delete Account), Store Name, Time of Visit, Contact Phone Number, Free Text Message\n\n|TR-CS-005\n|EngagementService must create Salesforce Cases asynchronously via Event Bus (non-blocking user experience)\n\n|TR-CS-006\n|EngagementService must acknowledge feedback submission immediately to Mobile App user (\"Feedback submitted\" confirmation)\n\n|TR-CS-007\n|EngagementService must send push notification to customer via Braze when Case is successfully created in Salesforce\n\n|TR-CS-008\n|EngagementService must retry failed Case creation with configurable exponential backoff and dead letter queue for operations team intervention\n\n|TR-CS-009\n|Salesforce must be the System of Record for Contact and Case data (no local persistence in ProfileService or EngagementService)\n\n|TR-CS-010\n|Contact migration from app-specific database to Salesforce must complete before Mobile App cutover (upsert with flexible matching by email/phone/VCI)\n\n|TR-CS-011\n|No Case migration from D365 Customer Engagement to Salesforce (fresh start, historical Cases not migrated)\n\n|TR-CS-012\n|EngagementService must publish domain events (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`) to Event Bus for consumption by other bounded contexts\n\n|TR-CS-013\n|EngagementService must receive Salesforce webhook notifications when Cases are updated/resolved by support agents\n\n|TR-CS-014\n|EngagementService must trigger Braze push notifications to customers when Cases are updated/resolved (via Salesforce webhook → EngagementService → Braze)\n\n|TR-CS-015\n|ProfileService and EngagementService must conform to existing Salesforce configuration and API contracts (Conformist pattern)\n\n|TR-CS-016\n|All changes must be communicated using event-driven architecture via Event Bus (using existing AWS infrastructure: SNS+SQS/EventBridge/Kinesis)\n\n|TR-CS-017\n|Mobile App feedback submission success rate must exceed 99.5% (including async Case creation completion)\n\n|TR-CS-018\n|Contact migration must achieve 100% validation pass rate (zero data loss)\n\n|TR-CS-019\n|D365 Customer Engagement must be fully decommissioned within 90 days post-cutover\n\n|===\n\n== Technical Architecture\n\n=== Technical Capability Requirements\n\n==== Requirements Traceability\n\n[width=\"100%\",cols=\"15%,50%,35%\",options=\"header\",]\n|===\n|Requirement ID |Requirement Summary |Architectural Building Blocks\n\n|TR-CS-001\n|Every Mobile App user must have Salesforce Contact record\n|ABB-CS-001 (ProfileService), ABB-CS-004 (Salesforce), ABB-CS-007 (Contact Migration Tool)\n\n|TR-CS-002\n|ProfileService JIT Contact reconciliation via upsert by email\n|ABB-CS-001 (ProfileService), ABB-CS-004 (Salesforce)\n\n|TR-CS-003\n|ProfileService returns Salesforce Contact ID to Mobile App\n|ABB-CS-001 (ProfileService), ABB-CS-006 (Mobile App)\n\n|TR-CS-004\n|Mobile App supports feedback submission with structured fields\n|ABB-CS-006 (Mobile App), ABB-CS-002 (EngagementService)\n\n|TR-CS-005\n|EngagementService creates Salesforce Cases asynchronously\n|ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus), ABB-CS-004 (Salesforce)\n\n|TR-CS-006\n|EngagementService immediate acknowledgment to Mobile App\n|ABB-CS-002 (EngagementService), ABB-CS-006 (Mobile App)\n\n|TR-CS-007\n|EngagementService sends push notification via Braze on Case creation\n|ABB-CS-002 (EngagementService), ABB-CS-005 (Braze)\n\n|TR-CS-008\n|EngagementService retry logic with exponential backoff and DLQ\n|ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus)\n\n|TR-CS-009\n|Salesforce is System of Record for Contact and Case data\n|ABB-CS-004 (Salesforce), ABB-CS-001 (ProfileService - stateless), ABB-CS-002 (EngagementService - stateless)\n\n|TR-CS-010\n|Contact migration before Mobile App cutover\n|ABB-CS-007 (Contact Migration Tool), ABB-CS-004 (Salesforce)\n\n|TR-CS-011\n|No Case migration from D365 CE (fresh start)\n|ABB-CS-004 (Salesforce) - no migration tooling required\n\n|TR-CS-012\n|EngagementService publishes domain events to Event Bus\n|ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus)\n\n|TR-CS-013\n|EngagementService receives Salesforce webhook notifications\n|ABB-CS-002 (EngagementService), ABB-CS-004 (Salesforce)\n\n|TR-CS-014\n|EngagementService triggers Braze notifications on Case updates\n|ABB-CS-002 (EngagementService), ABB-CS-004 (Salesforce), ABB-CS-005 (Braze)\n\n|TR-CS-015\n|ProfileService and EngagementService conform to Salesforce config\n|ABB-CS-001 (ProfileService), ABB-CS-002 (EngagementService), ABB-CS-004 (Salesforce)\n\n|TR-CS-016\n|Event-driven architecture via Event Bus\n|ABB-CS-003 (Event Bus), ABB-CS-002 (EngagementService)\n\n|TR-CS-017\n|Mobile App feedback submission success rate > 99.5%\n|ABB-CS-006 (Mobile App), ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus), ABB-CS-004 (Salesforce)\n\n|TR-CS-018\n|Contact migration 100% validation pass rate\n|ABB-CS-007 (Contact Migration Tool), ABB-CS-004 (Salesforce)\n\n|TR-CS-019\n|D365 CE decommissioned within 90 days post-cutover\n|All ABBs (replacement system operational)\n\n|===\n\n=== Service Catalogues\n\n==== Application Portfolio Catalogue\n\n[width=\"100%\",cols=\"20%,15%,15%,15%,35%\",options=\"header\",]\n|===\n|Application |Lifecycle State |Owner |Hosting Platform |Description\n\n|*ProfileService*\n|NEW\n|OTR Platform Team\n|AWS (TBD: Lambda/ECS/EKS)\n|JIT Contact reconciliation with Salesforce, returns Salesforce Contact ID, foundation for Flybuys integration\n\n|*EngagementService*\n|NEW\n|OTR Platform Team\n|AWS (TBD: Lambda/ECS/EKS)\n|Customer feedback submission facade, ACL for Salesforce Case creation, Braze integration for all outbound communications (push, email, SMS), webhook receiver\n\n|*Mobile App (iOS)*\n|ACTIVE (UPDATE)\n|OTR Mobile Team\n|Apple App Store\n|iOS native app with feedback form, integrate with ProfileService and EngagementService APIs\n\n|*Mobile App (Android)*\n|ACTIVE (UPDATE)\n|OTR Mobile Team\n|Google Play Store\n|Android native app with feedback form, integrate with ProfileService and EngagementService APIs\n\n|*Salesforce Service Cloud*\n|ACTIVE (EXPAND)\n|Viva Energy Salesforce Admin Team\n|Salesforce (SaaS)\n|Shared Viva Energy instance, System of Record for Contact and Case data, adding OTR digital customer support\n\n|*Braze*\n|ACTIVE (EXTEND)\n|OTR Marketing Team\n|Braze (SaaS)\n|Marketing automation platform, EngagementService triggers push notifications for Case updates\n\n|*D365 Customer Engagement*\n|RETIRE\n|OTR Support Team\n|Microsoft Azure (SaaS)\n|Legacy customer support platform, decommissioned within 90 days post-cutover\n\n|*App-Specific Customer Database*\n|RETIRE\n|OTR Platform Team\n|AWS (RDS/DynamoDB)\n|Legacy customer contact storage, one-time migration to Salesforce, then deprecated\n\n|*Event Bus*\n|NEW\n|OTR Platform Team\n|AWS (SNS+SQS/EventBridge/Kinesis)\n|Domain event publishing infrastructure for bounded context integration\n\n|*Contact Migration Tool*\n|TEMPORARY\n|OTR Platform Team\n|AWS (Script/Lambda)\n|One-time migration app database → Salesforce with upsert logic, retired after migration complete\n\n|===\n\n==== Technology Capability Requirements\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Technology Capability |Implementation Technology (TBD in detailed design) |Requirements\n\n|*Microservice Hosting*\n|AWS Lambda / ECS / EKS\n|Host ProfileService and EngagementService with auto-scaling, high availability, monitoring\n\n|*API Gateway*\n|AWS API Gateway / Application Load Balancer\n|REST API routing, authentication, rate limiting, request validation for ProfileService and EngagementService\n\n|*Event Bus*\n|AWS SNS+SQS / EventBridge / Kinesis\n|Domain event publishing, async message processing, retry logic, dead letter queue\n\n|*Salesforce Integration*\n|Salesforce REST API / SOAP API\n|Contact CRUD operations, Case creation, webhook notifications, OAuth 2.0 authentication\n\n|*Braze Integration*\n|Braze REST API / SDK\n|Push notification campaign triggers, customer profile reconciliation\n\n|*Authentication & Authorisation*\n|Microsoft Entra External ID / AWS Cognito\n|Mobile App user authentication, API authorisation, JWT token validation\n\n|*Observability & Monitoring*\n|AWS CloudWatch / Datadog / New Relic\n|Application metrics, logs, traces, dashboards, alerting (feedback submission rate, queue depth, API errors)\n\n|*Secret Management*\n|AWS Secrets Manager / Parameter Store\n|Salesforce credentials, Braze API keys, OAuth tokens, encryption keys\n\n|*Database (Migration Tool)*\n|AWS RDS / DynamoDB (read-only access)\n|Contact migration from app-specific database\n\n|*CI/CD Pipeline*\n|GitHub Actions / AWS CodePipeline\n|Automated build, test, deployment for ProfileService, EngagementService, Mobile App\n\n|*Infrastructure as Code*\n|Terraform / AWS CloudFormation / CDK\n|Declarative infrastructure provisioning for Event Bus, microservices, monitoring\n\n|*API Documentation*\n|OpenAPI / Swagger\n|ProfileService and EngagementService API specifications for Mobile App integration\n\n|===\n\n==== Feature Flag Register\n\n*Note*: Per ADR-CS-006 (big bang cutover, not phased rollout), feature flags are minimal and used primarily for emergency rollback/kill switches.\n\n[width=\"100%\",cols=\"20%,15%,35%,30%\",options=\"header\",]\n|===\n|Feature Flag |Default State |Purpose |Rollback Scenario\n\n|*enable_salesforce_feedback_submission*\n|OFF (pre-cutover), ON (post-cutover)\n|Enable/disable feedback submission to EngagementService → Salesforce (kill switch for emergency rollback to D365 CE)\n|Feedback submission success rate < 95%, Salesforce API failures, critical bugs - revert to D365 CE integration\n\n|*enable_async_case_creation*\n|ON\n|Enable/disable async Case creation via Event Bus (fallback to synchronous processing if Event Bus issues)\n|Event Bus infrastructure failures, queue backlog unmanageable - temporary synchronous processing\n\n|*enable_braze_notifications*\n|ON\n|Enable/disable Braze push notifications for Case updates (degrade gracefully if Braze integration fails)\n|Braze API failures, notification delivery rate < 80% - disable notifications temporarily\n\n|*enable_jit_contact_reconciliation*\n|ON\n|Enable/disable ProfileService JIT Contact reconciliation (fallback to cached Contact IDs if Salesforce unavailable)\n|Salesforce API downtime, Contact reconciliation failures > 5% - use cached Contact IDs temporarily\n\n|*enable_salesforce_webhook_processing*\n|ON\n|Enable/disable Salesforce webhook processing for Case updates (fallback to polling if webhook failures)\n|Webhook delivery failures, authentication issues - temporary polling fallback\n\n|===\n\n*Feature Flag Management*:\n\n* Feature flags managed via AWS AppConfig / LaunchDarkly / custom feature flag service (TBD in detailed design)\n* Mobile App feature flags controlled server-side (no app release required for flag changes)\n* Backend service feature flags configured via environment variables / configuration service\n* Feature flag changes logged and audited (who changed, when, reason)\n* Post-cutover monitoring: Gradual removal of feature flags once system stability confirmed (30-60 days)\n\n==== Data Entity Catalogue\n\n[width=\"100%\",cols=\"20%,15%,35%,30%\",options=\"header\",]\n|===\n|Data Entity |System of Record |Key Attributes |Lifecycle\n\n|*Contact*\n|Salesforce Service Cloud\n|• Contact ID (Salesforce 15/18-char ID) +\n• Email (primary matching key) +\n• First Name, Last Name +\n• Phone Number +\n• Viva Consumer ID (VCI) +\n• Account (Viva Energy customer account) +\n• Record Type (OTR Digital vs other channels)\n|Created: ProfileService JIT reconciliation or Contact Migration Tool +\nUpdated: ProfileService JIT upsert (email changes), Salesforce (manual updates by support agents) +\nDeleted: Salesforce retention policy (GDPR/compliance)\n\n|*Case*\n|Salesforce Service Cloud\n|• Case Number (Salesforce auto-generated) +\n• Contact ID (reference to Contact) +\n• Subject (derived from Category) +\n• Description (Free Text Message) +\n• Category (App, Service, Order, Rewards, Refund, Delete Account) +\n• Store Name (OTR location) +\n• Time of Visit +\n• Status (New, In Progress, Resolved, Closed) +\n• Priority, Origin (Mobile App) +\n• Owner (support agent/queue)\n|Created: EngagementService async Case creation +\nUpdated: Support agents (Salesforce UI), EngagementService (webhook processing) +\nDeleted: Salesforce retention policy (archive after X years)\n\n|*Feedback Submission (transient)*\n|None (not persisted)\n|• Salesforce Contact ID +\n• Category +\n• Store Name +\n• Time of Visit +\n• Contact Phone Number +\n• Free Text Message\n|Created: Mobile App user submission +\nProcessed: EngagementService publishes to Event Bus, Case created in Salesforce +\nNot persisted in ProfileService/EngagementService (stateless)\n\n|*Domain Events*\n|Event Bus (ephemeral)\n|**SupportCaseCreated**: +\n• Case Number, Contact ID, Category, Timestamp +\n**SupportCaseUpdated**: +\n• Case Number, Status, Updated By, Timestamp +\n**SupportCaseResolved**: +\n• Case Number, Resolution, Resolved By, Timestamp +\n**CustomerFeedbackSubmitted**: +\n• Contact ID, Category, Timestamp\n|Published: EngagementService +\nConsumed: Other bounded contexts (future), Braze notification triggers +\nRetention: Short-lived (minutes to hours), not persisted for event sourcing\n\n|*Braze Customer Profile*\n|Braze\n|• External User ID (VCI or Email) +\n• Push Notification Tokens (iOS/Android) +\n• Notification Preferences +\n• Campaign Engagement History\n|Created/Updated: EngagementService on Case creation/update +\nManaged: Braze (external SaaS)\n\n|===\n\n*Data Migration Entities*:\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Source Entity |Target Entity |Migration Strategy\n\n|*App Database Contact*\n|Salesforce Contact\n|One-time migration via Contact Migration Tool: +\n• Upsert by email (primary), phone (secondary), VCI (tertiary) +\n• Map: Email → Email, Name → First/Last Name, Phone → Phone, VCI → External ID +\n• Validation: 100% data integrity check, reconciliation report\n\n|*D365 CE Case*\n|Not migrated\n|ADR-CS-005: No Case migration (fresh start in Salesforce) +\nD365 CE Cases archived separately for compliance if needed\n\n|===\n\n==== Data Quality & Validation\n\n*Contact Migration Validation Rules*:\n\n* Email format validation (RFC 5322 compliance)\n* Phone number format validation (E.164 international format)\n* VCI format validation (alphanumeric, length constraints)\n* Duplicate detection: Flag potential duplicates for manual review (same email/phone combination)\n* Mandatory fields: Email (required), First Name, Last Name (required for Salesforce Contact)\n\n*Case Creation Validation Rules*:\n\n* Contact ID must exist in Salesforce (validated by EngagementService before Case creation)\n* Category must be one of: App, Service, Order, Rewards, Refund, Delete Account\n* Free Text Message maximum length: 32,000 characters (Salesforce Case Description limit)\n* Store Name validated against OTR location master data (optional - warn if not found)\n\n<<<\n== Solution Building Blocks\n\nThis section defines the specific technology products, configurations, and implementation details for each Solution Building Block (SBB).\n\n=== Technology Portfolio Catalogue\n\n[width=\"100%\",cols=\"10%,20%,25%,25%,20%\",options=\"header\",]\n|===\n|SBB ID |Component |Technology Product |Version/Configuration |Deployment Platform\n\n|SBB-CS-001\n|ProfileService Microservice\n|.NET 8 / Node.js 20 LTS\n|RESTful API, containerised\n|AWS ECS Fargate / Lambda\n\n|SBB-CS-002\n|EngagementService Microservice\n|.NET 8 / Node.js 20 LTS\n|RESTful API, containerised, async workers\n|AWS ECS Fargate / Lambda\n\n|SBB-CS-003\n|Event Bus\n|AWS SNS + SQS / EventBridge\n|Standard queues, FIFO for ordering\n|AWS (managed service)\n\n|SBB-CS-004\n|API Gateway\n|AWS API Gateway / ALB\n|REST API, JWT validation\n|AWS (managed service)\n\n|SBB-CS-005\n|Salesforce Integration Layer\n|Salesforce REST API Client\n|OAuth 2.0 JWT bearer flow\n|Embedded in SBB-CS-001/002\n\n|SBB-CS-006\n|Braze Integration Layer\n|Braze REST API SDK\n|API key authentication\n|Embedded in SBB-CS-002\n\n|SBB-CS-007\n|Contact Migration Tool\n|Python 3.11 / .NET 8\n|One-time batch script\n|AWS Lambda / EC2\n\n|SBB-CS-008\n|Application Monitoring\n|AWS CloudWatch / Datadog\n|Metrics, logs, traces, dashboards\n|AWS / SaaS\n\n|SBB-CS-009\n|Secret Management\n|AWS Secrets Manager\n|KMS encryption\n|AWS (managed service)\n\n|SBB-CS-010\n|Mobile App (iOS)\n|SwiftUI, Kotlin Multiplatform\n|iOS 15+\n|Apple App Store\n\n|SBB-CS-011\n|Mobile App (Android)\n|Jetpack Compose, Kotlin Multiplatform\n|Android 8+\n|Google Play Store\n\n|SBB-CS-012\n|Feature Flag Service\n|AWS AppConfig / LaunchDarkly\n|Server-side flags, real-time updates\n|AWS / SaaS\n\n|===\n\n<<<\n== Data Architecture\n\nThis section defines the physical data models, event schemas, and API request/response formats.\n\n=== Domain Event Schemas\n\nAll domain events follow the https://cloudevents.io/[CloudEvents 1.0] specification for consistency and interoperability.\n\n*Event Schema Specifications*: See // TODO: Add to Antora - specifications/events/engagement-events.json[Engagement Service Event Schemas] for complete JSON schemas and examples.\n\n==== Event Catalogue\n\n[width=\"100%\",cols=\"30%,20%,50%\",options=\"header\",]\n|===\n|Event Type |Publisher |Description\n\n|`SupportCaseCreated`\n|EngagementService\n|Published when EngagementService successfully creates a Case in Salesforce after async processing\n\n|`SupportCaseUpdated`\n|EngagementService (via Salesforce webhook)\n|Published when a support agent updates a Case in Salesforce (status, priority, comment changes)\n\n|`SupportCaseResolved`\n|EngagementService (via Salesforce webhook)\n|Published when a support agent resolves/closes a Case in Salesforce\n\n|`CustomerFeedbackSubmitted`\n|EngagementService\n|Published when customer submits feedback via Mobile App (before async Case creation)\n\n|===\n\n*Event Format*: All events use CloudEvents 1.0 envelope with event-specific payload in the `data` field.\n\n*Schema Location*: `specifications/events/engagement-events.json`\n\n=== API Request/Response Schemas\n\n==== ProfileService: GET /profile/contact-id\n\n*Response* (200 OK):\n[source,json]\n----\n{\n  \"contactId\": \"0034X00000ABCDEFG\",\n  \"email\": \"customer@example.com\",\n  \"firstName\": \"John\",\n  \"lastName\": \"Smith\"\n}\n----\n\n==== EngagementService: POST /feedback\n\n*Request*:\n[source,json]\n----\n{\n  \"contactId\": \"0034X00000ABCDEFG\",\n  \"category\": \"App\",\n  \"storeName\": \"OTR Adelaide\",\n  \"timeOfVisit\": \"2026-01-07T12:00:00Z\",\n  \"contactPhoneNumber\": \"+61412345678\",\n  \"message\": \"App crashed when submitting feedback\"\n}\n----\n\n*Response* (202 Accepted):\n[source,json]\n----\n{\n  \"feedbackId\": \"fb-2026-01-07-12345\",\n  \"status\": \"submitted\",\n  \"message\": \"Your feedback has been submitted!\"\n}\n----\n\n=== Salesforce Field Mappings\n\n==== Case Object Mapping\n\n[width=\"100%\",cols=\"25%,25%,25%,25%\",options=\"header\",]\n|===\n|OTR Field |Salesforce Field |Data Type |Notes\n\n|Category\n|Feedback_Category__c\n|Picklist\n|App, Service, Order, Rewards, Refund, Delete Account\n\n|Store Name\n|Store_Name__c\n|String (255)\n|OTR location name\n\n|Time of Visit\n|Time_of_Visit__c\n|DateTime\n|When customer visited store\n\n|Free Text Message\n|Description\n|Long Text (32,000)\n|Customer feedback message\n\n|===\n\n<<<\n=== Baseline Architecture\n\n==== Existing System Components\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Component |Current State |Status\n\n|*D365 Customer Engagement*\n|Customer support platform for OTR digital customers (Mobile App, Web), handles feedback submission and case management\n|**DEPRECATED** - Being replaced by Salesforce Service Cloud\n\n|*App-Specific Customer Database*\n|Stores customer contact data for Mobile App users, separate from Viva Energy systems\n|**MIGRATING** - One-time migration to Salesforce, then deprecated\n\n|*Mobile App*\n|iOS/Android native apps with feedback submission form including Category, Store Name, Time of Visit, Contact Phone Number, and Free Text Message fields\n|**REQUIRES UPDATE** - Integrate with ProfileService and EngagementService APIs (feedback form UI already complete)\n\n|*Salesforce Service Cloud*\n|Shared Viva Energy instance handling customer support for fuel wholesale, Shell Card customers, other retail channels\n|**EXPANDING** - Adding OTR digital customer support Cases and Contacts\n\n|*Existing AWS Infrastructure*\n|SNS+SQS / EventBridge / Kinesis available for event-driven architecture\n|**REUSING** - Event Bus implementation leverages existing infrastructure\n\n|===\n\n==== Integration Architecture\n\n*Current state:*\n\n* Mobile App → D365 Customer Engagement (direct integration)\n* App-specific customer database → standalone (no Salesforce integration)\n* No event-driven architecture (synchronous, tightly coupled)\n* No Anti-Corruption Layer protecting digital channels\n* Viva Energy support teams use Salesforce, OTR digital support uses D365 CE (fragmented)\n\n==== Technical Debt\n\n*No longer relevant* - D365 CE being deprecated, not documenting technical debt of system being retired.\n\n*New technical debt introduced by this migration:*\n\n* Salesforce field mapping TBD (requires coordination with Viva Energy Salesforce admin team)\n* Data isolation strategy TBD (Record Types, custom fields, queues - multi-tenant governance)\n* Salesforce webhook mechanism TBD (Outbound Messages vs Platform Events vs Process Builder)\n* Expected feedback volume unknown (gathering data for rate limit planning)\n\n=== Gap Analysis\n\n==== Missing Capabilities\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Missing Capability |Description\n\n|*ProfileService bounded context*\n|No existing service for Contact reconciliation with Salesforce - requires new microservice implementing JIT upsert by email, returning Salesforce Contact ID\n\n|*EngagementService bounded context*\n|No existing service for customer feedback facade - requires new microservice implementing Anti-Corruption Layer for Salesforce Case creation, Braze integration, async processing via Event Bus\n\n|*Event Bus domain event pattern*\n|No existing domain event publishing infrastructure - requires implementing event-driven architecture pattern using existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis)\n\n|*Async Case creation workflow*\n|Current D365 CE integration is synchronous - requires implementing async processing with retry logic, exponential backoff, dead letter queue\n\n|*Salesforce webhook integration*\n|No existing capability to receive Salesforce notifications - requires implementing webhook receiver in EngagementService for Case update notifications\n\n|*Braze push notification orchestration*\n|No existing integration for Case-related push notifications - requires implementing Braze campaign triggers from EngagementService\n\n|*Contact migration tooling*\n|No existing tooling for app database → Salesforce Contact migration with upsert logic (match by email/phone/VCI)\n\n|*Feedback form enhancements*\n|Mobile App feedback form lacks structured fields (Category, Store Name, Time of Visit, Contact Phone Number) - requires UI updates\n\n|===\n\n==== Missing Bounded Contexts\n\n[width=\"100%\",cols=\"30%,30%,40%\",options=\"header\",]\n|===\n|Bounded Context |Responsibilities |Implementation Status\n\n|*link:../bounded_context/profile.adoc[ProfileService]*\n|JIT Contact reconciliation with Salesforce (upsert by email), return Salesforce Contact ID to digital channels, foundation for future Flybuys partner linking\n|**NEW** - First bounded context implementation\n\n|*link:../bounded_context/engagement.adoc[EngagementService]*\n|Customer feedback submission facade, Anti-Corruption Layer for Salesforce Case creation, Braze integration for push notifications, async Case processing, webhook receiver for Case updates\n|**NEW** - First bounded context implementation\n\n|===\n\n==== Missing Integration Patterns\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Integration Pattern |Description\n\n|*Anti-Corruption Layer (ACL)*\n|EngagementService → Salesforce Service Cloud - protects digital channels from Salesforce API changes, translates between OTR domain language and Salesforce\n\n|*Conformist*\n|ProfileService/EngagementService → Salesforce - conform to existing Salesforce configuration and API contracts (shared Viva Energy instance)\n\n|*Event-Driven Architecture (OHS+PL)*\n|Event Bus publishing domain events (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`) for loose coupling between bounded contexts\n\n|*Just-In-Time (JIT) Integration*\n|ProfileService → Salesforce Contact reconciliation on-demand (no pre-sync)\n\n|*Async Processing*\n|EngagementService Case creation via Event Bus with retry, exponential backoff, dead letter queue\n\n|===\n\n=== Target State Architecture\n\n==== Architectural Building Blocks (ABB)\n\n[width=\"100%\",cols=\"20%,25%,30%,25%\",options=\"header\",]\n|===\n|ABB ID |Bounded Context |Responsibilities |Technology (TBD in Solution Architecture)\n\n|ABB-CS-001\n|*link:../bounded_context/profile.adoc[ProfileService]*\n|JIT Contact reconciliation with Salesforce (upsert by email), return Salesforce Contact ID, foundation for Flybuys partner linking\n|Microservice (.NET/Node.js), REST API, Salesforce REST API client\n\n|ABB-CS-002\n|*link:../bounded_context/engagement.adoc[EngagementService]*\n|Customer feedback submission facade, ACL for Salesforce Case creation, Braze integration, async processing, webhook receiver\n|Microservice (.NET/Node.js), REST API, Event Bus publisher/subscriber, Salesforce webhook receiver\n\n|ABB-CS-003\n|*Event Bus*\n|Domain event publishing infrastructure (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`)\n|AWS SNS+SQS / EventBridge / Kinesis\n\n|ABB-CS-004\n|*Salesforce Service Cloud*\n|System of Record for Contact and Case data (shared Viva Energy instance)\n|Salesforce Service Cloud (external SaaS)\n\n|ABB-CS-005\n|*Braze*\n|Marketing automation platform for push notifications\n|Braze (external SaaS) - existing integration\n\n|ABB-CS-006\n|*Mobile App*\n|iOS/Android native apps with enhanced feedback form (Category, Store Name, Time of Visit, Contact Phone Number, Free Text Message)\n|Kotlin Multiplatform, SwiftUI, Jetpack Compose\n\n|ABB-CS-007\n|*Contact Migration Tool*\n|One-time migration app database → Salesforce with upsert logic (match by email/phone/VCI)\n|Script/tool (.NET/Python/Node.js)\n\n|===\n\n==== Integration Architecture\n\n===== Integration Flows\n\n*Customer Feedback Submission (Async):*\n\n1. *Mobile App* → ProfileService: Authenticate user, get Salesforce Contact ID (JIT reconciliation)\n2. *Mobile App* → EngagementService: Submit feedback (POST /feedback with Contact ID, Category, Store Name, Time of Visit, Phone, Message)\n3. *EngagementService* → Mobile App: Immediate acknowledgment (\"Feedback submitted\")\n4. *EngagementService* → Event Bus: Publish work item for async Case creation\n5. *Background Worker* (EngagementService) → Salesforce: Create Case via REST API\n6. *Success*: EngagementService → Event Bus: Publish `SupportCaseCreated` event\n7. *EngagementService* → Braze: Trigger push notification campaign (\"Your feedback has been received, Case #12345\")\n8. *Failure*: Retry with exponential backoff → Dead Letter Queue → Ops team alert\n\n*Case Update Notification (Bidirectional):*\n\n1. *Support Agent* updates/resolves Case in Salesforce\n2. *Salesforce* → EngagementService: Webhook notification (Case updated)\n3. *EngagementService* → Event Bus: Publish `SupportCaseUpdated` or `SupportCaseResolved` event\n4. *EngagementService* → Braze: Trigger push notification campaign (\"Your case has been resolved\")\n\n*Contact Reconciliation (JIT):*\n\n1. *Mobile App user* authenticates\n2. *Mobile App* → ProfileService: GET /profile/contact-id\n3. *ProfileService* → Salesforce: Query Contact by email\n4. *Match found*: Return existing Salesforce Contact ID\n5. *No match*: Create new Contact in Salesforce, return new Contact ID\n6. *ProfileService* → Mobile App: Return Salesforce Contact ID (cached by Mobile App)\n\n===== System of Record Boundaries\n\n[width=\"100%\",cols=\"30%,35%,35%\",options=\"header\",]\n|===\n|Data Entity |System of Record |Rationale\n\n|*Contact*\n|Salesforce Service Cloud\n|Shared Viva Energy instance, unified customer profile across all channels (digital, wholesale, Shell Card, retail)\n\n|*Case*\n|Salesforce Service Cloud\n|Support agents manage Cases in Salesforce, digital channels submit via EngagementService ACL\n\n|*Feedback Submission (transient)*\n|None (no persistence)\n|EngagementService processes feedback and creates Case in Salesforce, no local storage\n\n|*Domain Events*\n|Event Bus (ephemeral)\n|Events published to Event Bus, consumed by subscribers, not persisted long-term (event sourcing not in scope)\n\n|===\n\n==== Data Architecture Principles\n\n===== Aggregate Persistence\n\n*ProfileService:*\n\n* **No local aggregate persistence** - ProfileService is stateless, queries Salesforce on-demand\n* Salesforce Contact is the aggregate root (owned by Salesforce)\n* ProfileService acts as facade/translator, not system of record\n\n*EngagementService:*\n\n* **No local aggregate persistence** - EngagementService is stateless, creates Cases in Salesforce via ACL\n* Salesforce Case is the aggregate root (owned by Salesforce)\n* EngagementService maintains no local Case state (Conformist pattern - trust Salesforce as source of truth)\n* Async processing state managed via Event Bus (work items in queue, not database)\n\n===== Event Store\n\n* **Event Bus** (SNS+SQS/EventBridge/Kinesis) handles domain event publishing\n* Events are **ephemeral** (consumed and discarded, not persisted for event sourcing)\n* No Event Store implementation in this architecture (future enhancement if needed)\n* Event schema versioning TBD in Solution Architecture\n\n\n=== Architecture Decisions\n\n==== ADR-CS-001: Consolidate onto Salesforce Service Cloud (not build custom solution)\n\n*Status*: Accepted\n\n*Context*:\n\n* D365 Customer Engagement not working well for digital customer support\n* Viva Energy already uses Salesforce Service Cloud for fuel wholesale, Shell Card, other retail channels\n* Post-merger opportunity to consolidate onto single platform\n* Alternative: Build custom support platform or use different SaaS\n\n*Decision*:\n\nConsolidate OTR digital customer support onto Salesforce Service Cloud (shared Viva Energy instance).\n\n*Rationale*:\n\n* **Unified customer view**: Support agents see all interactions across channels (digital, wholesale, Shell Card, retail)\n* **Platform consolidation**: Single support platform reduces operational overhead and costs\n* **Proven solution**: Salesforce Service Cloud is established, feature-rich, well-supported\n* **Post-merger alignment**: Strategic decision to standardize on Viva Energy platforms\n* **Avoid custom development**: Building custom support platform would be costly and high-risk\n\n*Consequences*:\n\n* Unified customer support across Viva Energy Group\n* Reduced operational complexity (single platform vs two)\n* Leverage Salesforce capabilities (case routing, knowledge base, AI, omnichannel)\n* ⚠️ Conformist pattern required (shared instance, conform to existing configuration)\n* ⚠️ Multi-tenant governance needed (data isolation, security, queues)\n* ❌ Less control over platform evolution (SaaS vendor, shared instance)\n\n==== ADR-CS-002: Implement ProfileService and EngagementService as first DDD bounded contexts\n\n*Status*: Accepted\n\n*Context*:\n\n* OTR target architecture uses Domain-Driven Design with bounded contexts\n* This migration is opportunity to establish first implementation\n* Alternative: Direct Mobile App → Salesforce integration (no bounded contexts)\n* Alternative: Single monolithic service for all customer-facing APIs\n\n*Decision*:\n\nImplement ProfileService and EngagementService as separate bounded contexts following DDD strategic patterns.\n\n*Rationale*:\n\n* **Foundation for target architecture**: First implementation of DDD pattern for future bounded contexts (Flybuys, LocationService, PaymentService)\n* **Separation of concerns**: ProfileService handles identity/Contact reconciliation, EngagementService handles support/feedback (different responsibilities, different change rates)\n* **Anti-Corruption Layer**: EngagementService protects digital channels from Salesforce API changes\n* **Reusability**: ProfileService Contact reconciliation reused for Flybuys integration\n* **Event-driven architecture**: Establishes pattern for loose coupling between bounded contexts\n\n*Consequences*:\n\n* Establishes DDD architecture foundation for OTR\n* Reusable ProfileService for Flybuys and future integrations\n* Digital channels protected from Salesforce API changes (ACL)\n* Clear bounded context boundaries and responsibilities\n* ⚠️ Increased initial complexity (two new microservices vs direct integration)\n* ⚠️ Requires Event Bus infrastructure implementation\n* ⚠️ Team must learn DDD patterns and bounded context design\n\n==== ADR-CS-003: Async Case creation via Event Bus (not synchronous)\n\n*Status*: Accepted\n\n*Context*:\n\n* Current D365 CE integration is synchronous (user waits for Case creation)\n* Alternative: Keep synchronous integration (Mobile App → EngagementService → Salesforce synchronously)\n* Salesforce API may experience downtime or latency\n\n*Decision*:\n\nImplement async Case creation via Event Bus with immediate user acknowledgment, retry logic, exponential backoff, and dead letter queue.\n\n*Rationale*:\n\n* **Non-blocking user experience**: User gets immediate \"Feedback submitted\" confirmation, not waiting for Salesforce API\n* **Resilience**: If Salesforce is down, feedback still accepted, Case created when Salesforce recovers\n* **Retry logic**: Automatic retry with exponential backoff handles transient failures\n* **Operational visibility**: Dead letter queue alerts ops team to persistent failures\n* **Scalability**: Queue buffering handles traffic spikes\n\n*Consequences*:\n\n* Better user experience (no waiting for Salesforce API)\n* Resilient to Salesforce downtime (queue buffers work)\n* Automatic retry reduces manual intervention\n* Queue depth monitoring provides operational visibility\n* ⚠️ Eventual consistency (user gets success notification after Case created, not immediately)\n* ⚠️ Increased complexity (Event Bus, background workers, retry logic, DLQ)\n* ⚠️ Requires monitoring and alerting for DLQ\n\n==== ADR-CS-004: ProfileService uses email as primary matching key (not VCI)\n\n*Status*: Accepted\n\n*Context*:\n\n* ProfileService needs to reconcile Mobile App users as Salesforce Contacts\n* Alternative matching keys: VCI (Viva Consumer ID), email, phone, Salesforce External ID\n* Email changes are rare but possible\n\n*Decision*:\n\nUse email address as primary matching key for Contact reconciliation (JIT upsert by email).\n\n*Rationale*:\n\n* **Availability**: Email always available for authenticated users\n* **Uniqueness**: Email is unique identifier in Salesforce and Mobile App\n* **Salesforce standard**: Salesforce Contact uses email as standard lookup field\n* **Simplicity**: Single matching key simplifies upsert logic\n* **Edge case acceptable**: Email changes are rare, manual cleanup acceptable\n\n*Consequences*:\n\n* Simple upsert logic (query by email, create if not found)\n* Leverages Salesforce standard email field\n* Email always available from authentication\n* ⚠️ Email changes create duplicate Contacts (rare edge case, manual cleanup)\n* ⚠️ Future enhancement: Add VCI as Salesforce External ID for stable matching\n\n==== ADR-CS-005: No Case migration from D365 CE (fresh start)\n\n*Status*: Accepted\n\n*Context*:\n\n* D365 CE contains historical customer support Cases\n* Alternative: Migrate historical Cases to Salesforce (preserve support history)\n* Alternative: Archive D365 CE Cases separately (read-only access)\n\n*Decision*:\n\nDo not migrate historical Cases from D365 CE to Salesforce. Start fresh in Salesforce.\n\n*Rationale*:\n\n* **Limited value**: Historical D365 CE Cases not critical for future support\n* **Data quality**: D365 CE Case data may be inconsistent or incomplete\n* **Complexity**: Case migration requires mapping D365 CE schema to Salesforce, data transformation, validation\n* **Cost-benefit**: Migration effort outweighs value of historical data\n* **Archive option**: D365 CE Cases can be archived separately if needed (read-only access for auditing)\n\n*Consequences*:\n\n* Simpler migration (Contacts only, no Case migration)\n* Faster time to value (no Case migration delay)\n* Clean start in Salesforce (no legacy data quality issues)\n* ⚠️ Historical Cases not visible in Salesforce (support agents can't see old Cases)\n* ⚠️ D365 CE must remain accessible temporarily for historical Case lookups (if needed)\n* ❌ Loss of historical Case insights (reporting, analytics on old Cases)\n\n==== ADR-CS-006: Big bang cutover (not phased rollout)\n\n*Status*: Accepted\n\n*Context*:\n\n* Alternative: Phased rollout with feature flags (pilot users first, gradual enablement)\n* Alternative: Parallel run (submit to both D365 CE and Salesforce temporarily)\n* Flybuys integration uses phased rollout (AS-1, AS-2, AS-3 architecture states)\n\n*Decision*:\n\nBig bang cutover - migrate Contacts, deploy ProfileService and EngagementService, switch Mobile App, retire D365 CE.\n\n*Rationale*:\n\n* **Simplicity**: No parallel run complexity, no feature flag management\n* **Faster D365 CE retirement**: No extended transition period maintaining two systems\n* **Limited risk**: Customer support not mission-critical (not payment processing), rollback possible\n* **User base manageable**: OTR digital customers smaller than Flybuys integration scope\n* **Different use case**: Flybuys phased rollout manages points accrual complexity, support feedback is simpler\n\n*Consequences*:\n\n* Simpler deployment (single cutover, no AS-1/AS-2/AS-3 states)\n* Faster D365 CE retirement (no extended parallel run)\n* No feature flag complexity or pilot user management\n* ⚠️ Higher cutover risk (all users switch at once)\n* ⚠️ Requires comprehensive testing before cutover\n* ⚠️ Rollback plan required (revert to D365 CE if critical issues)\n\n==== ADR-CS-007: EngagementService receives Salesforce webhooks for Case updates\n\n*Status*: Accepted\n\n*Context*:\n\n* Support agents update/resolve Cases in Salesforce\n* Need to notify customers of Case status changes via push notifications\n* Alternative: Poll Salesforce API for Case updates (inefficient)\n* Alternative: No customer notifications (agents contact customers directly)\n\n*Decision*:\n\nSalesforce sends webhook notifications to EngagementService when Cases are updated/resolved. EngagementService triggers Braze push notifications.\n\n*Rationale*:\n\n* **Real-time notifications**: Customer notified immediately when agent resolves Case\n* **Efficient**: Webhook push model (not polling)\n* **Event-driven**: Aligns with event-driven architecture pattern\n* **Better customer experience**: Proactive notification vs waiting for agent contact\n\n*Consequences*:\n\n* Real-time customer notifications for Case updates\n* Efficient push model (no polling overhead)\n* Bidirectional integration (Mobile App → Salesforce → Mobile App)\n* ⚠️ Salesforce webhook mechanism TBD (Outbound Messages vs Platform Events vs Process Builder)\n* ⚠️ Webhook authentication and security required\n* ⚠️ EngagementService must handle webhook retries and failures\n\n<<<\n== Interface Specifications\n\nThis section provides references to the complete API specifications and event catalogue for ProfileService and EngagementService.\n\n=== REST API Specifications\n\nComplete OpenAPI 3.0 specifications are maintained in the `specifications/rest/` directory:\n\n==== ProfileService API v1\n\n*Specification*: link:../../specifications/rest/profile-service-v1.yaml[profile-service-v1.yaml]\n\n*Base URL*: `https://api.otr.com.au/profile/v1`\n\n*Authentication*: Bearer token (Microsoft Entra External ID JWT)\n\n*Key Endpoints*:\n\n* `GET /contact-id` - Retrieve or create Salesforce Contact ID for authenticated user (Just-In-Time reconciliation)\n** Used by Mobile App before submitting feedback to EngagementService\n** Upserts Salesforce Contact record using email as external key\n** Returns 18-character Salesforce Contact ID with caching (15-minute TTL)\n** Performance SLA: p95 < 300ms (uncached), p95 < 50ms (cached)\n\n==== EngagementService API v1\n\n*Specification*: link:../../specifications/rest/engagement-service-v1.yaml[engagement-service-v1.yaml]\n\n*Base URL*: `https://api.otr.com.au/engagement/v1`\n\n*Authentication*: Bearer token (Microsoft Entra External ID JWT)\n\n*Key Endpoints*:\n\n* `POST /feedback` - Submit customer feedback for async Case creation in Salesforce\n** Accepts contactId, category, storeName, timeOfVisit, contactPhoneNumber, message\n** Returns 202 Accepted immediately (async Case creation in background)\n** Publishes `CustomerFeedbackSubmitted` event for analytics\n** Creates Salesforce Case via Anti-Corruption Layer with retry logic\n** Performance SLA: p95 < 200ms (feedback accepted, not Case creation)\n\n=== Domain Events (AsyncAPI)\n\nComplete CloudEvents 1.0 JSON Schema specifications are maintained in the `specifications/events/` directory:\n\n*Specification*: link:../../specifications/events/engagement-events.json[engagement-events.json]\n\n==== Event Catalogue\n\n[width=\"100%\",cols=\"30%,20%,50%\",options=\"header\",]\n|===\n|Event Type |Publisher |Consumers\n\n|`CustomerFeedbackSubmitted`\n|EngagementService\n|Future bounded contexts, analytics, sentiment analysis\n\n|`SupportCaseCreated`\n|EngagementService\n|Future bounded contexts, analytics\n\n|`SupportCaseUpdated`\n|EngagementService (via Salesforce webhook)\n|Future bounded contexts, analytics\n\n|`SupportCaseResolved`\n|EngagementService (via Salesforce webhook)\n|Future bounded contexts, analytics\n\n|===\n\n==== Event Delivery Guarantees\n\n* **At-least-once delivery**: Events may be delivered multiple times, consumers must handle idempotency\n* **Ordering**: FIFO queues guarantee ordering for events with same `contactId`\n* **Retention**: 4 days (96 hours) in Event Bus\n* **Dead Letter Queue**: Failed events after 5 retries moved to DLQ for manual intervention\n* **Format**: CloudEvents 1.0 specification with JSON payload\n\n=== API Versioning Policy\n\n==== Version Numbering\n\n* **Format**: `/v{major}` in URL path (e.g., `/profile/v1`, `/engagement/v1`)\n* **Semantic Versioning**: Major version incremented for breaking changes only\n* **Backwards Compatibility**: Minor changes (new optional fields, new endpoints) don't require version bump\n\n==== When to Version\n\n*Breaking changes requiring new major version*:\n\n- Removing or renaming fields in request/response\n- Changing field data types (e.g., string → number)\n- Changing authentication mechanism\n- Removing endpoints\n\n*Non-breaking changes not requiring version bump*:\n\n- Adding new optional fields to request/response\n- Adding new endpoints\n- Expanding enum values (e.g., adding new feedback category)\n- Improving error messages\n\n==== Parallel Version Support\n\n* Support N and N-1 versions concurrently for 6 months\n* Deprecation notice: 3 months before sunsetting old version\n* Mobile App must upgrade to new version within deprecation window\n\n<<<\n== Work Packages\n\nThis section consolidates gaps and activities into implementable work packages aligned with TOGAF Phase E requirements.\n\n=== Work Package Overview\n\n[width=\"100%\",cols=\"15%,35%,25%,25%\",options=\"header\",]\n|===\n|Work Package ID |Name |Transition State |Key Deliverables\n\n|WP-CS-001\n|ProfileService Development\n|TS-1 (Build & Test)\n|ProfileService microservice, Salesforce Contact integration, REST API\n\n|WP-CS-002\n|EngagementService Development\n|TS-1 (Build & Test)\n|EngagementService microservice, Anti-Corruption Layer, Braze integration\n\n|WP-CS-003\n|Event Bus Infrastructure\n|TS-1 (Build & Test)\n|Event Bus configuration, CloudEvents schemas, monitoring\n\n|WP-CS-004\n|Contact Migration Tooling\n|TS-1 (Build & Test)\n|Migration tool, validation scripts, reconciliation reporting\n\n|WP-CS-005\n|Mobile App Integration\n|TS-1 (Build & Test)\n|Mobile App API integration, feedback form enhancements, testing\n\n|WP-CS-006\n|Integration Testing\n|TS-1 (Build & Test)\n|Test environments, integration test suites, UAT execution\n\n|WP-CS-007\n|Salesforce Configuration\n|TS-1 (Build & Test)\n|Salesforce field mapping, data isolation, webhook configuration\n\n|WP-CS-008\n|Contact Data Migration\n|TS-2 (Contact Migration)\n|Contact migration execution, validation, reconciliation\n\n|WP-CS-009\n|Production Deployment\n|TS-3 (Cutover)\n|Production deployment, smoke testing, go-live execution\n\n|WP-CS-010\n|Post-Cutover Support\n|TS-4 (Target State)\n|Monitoring, issue resolution, D365 CE retirement\n\n|===\n\n[[wp-cs-001]]\n=== WP-CS-001: ProfileService Development\n\n==== Description\n\nBuild ProfileService bounded context microservice implementing Just-In-Time Contact reconciliation with Salesforce Service Cloud.\n\n==== Deliverables\n\n* ProfileService microservice application\n** REST API implementation (OpenAPI 3.0 specification)\n** `GET /contact-id` endpoint (Salesforce Contact reconciliation)\n** Authentication/authorization with Microsoft Entra External ID\n** Caching layer (15-minute TTL for Contact IDs)\n* Salesforce integration\n** Salesforce REST API client\n** Contact upsert by email (external key matching)\n** Error handling and retry logic\n* Unit tests (>80% code coverage)\n* Integration tests with Salesforce sandbox\n* API documentation\n* Deployment configuration (IaC - Infrastructure as Code)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* Salesforce sandbox environment provisioned\n* Microsoft Entra External ID OAuth configuration\n* Development environment setup (AWS dev account, CI/CD pipeline)\n\n*Dependent Work Packages*:\n\n* None (can start immediately after prerequisites met)\n\n==== Skills Required\n\n* Backend development (.NET Core or Node.js)\n* REST API design and implementation\n* Salesforce REST API integration\n* OAuth 2.0 / JWT authentication\n* Caching strategies (Redis/ElastiCache)\n* Unit/integration testing frameworks\n* Infrastructure as Code (Terraform/CloudFormation)\n\n==== Acceptance Criteria\n\n* All API endpoints return correct HTTP status codes per OpenAPI specification\n* Contact ID retrieval achieves p95 < 300ms (uncached), p95 < 50ms (cached)\n* Salesforce Contact upsert succeeds with 100% accuracy in sandbox testing\n* Unit test coverage > 80%\n* Integration tests pass in sandbox environment\n* API documentation generated from OpenAPI specification\n\n[[wp-cs-002]]\n=== WP-CS-002: EngagementService Development\n\n==== Description\n\nBuild EngagementService bounded context microservice implementing customer feedback submission, Anti-Corruption Layer for Salesforce Case creation, Braze integration, and webhook receiver for Case updates.\n\n==== Deliverables\n\n* EngagementService microservice application\n** REST API implementation (OpenAPI 3.0 specification)\n** `POST /feedback` endpoint (async feedback submission)\n** Authentication/authorization with Microsoft Entra External ID\n** Webhook receiver endpoint for Salesforce Case updates\n* Anti-Corruption Layer (ACL)\n** OTR domain model to Salesforce API translation\n** Category enum mapping (App/Service/Order/Rewards → Salesforce Case fields)\n** Salesforce REST API client for Case creation\n* Async processing infrastructure\n** Event Bus publisher integration\n** Background worker for Case creation\n** Retry logic with exponential backoff (5 attempts)\n** Dead Letter Queue integration\n* Braze integration\n** Braze campaign trigger API client\n** Push notification orchestration for Case updates\n* Domain event publishing\n** `CustomerFeedbackSubmitted` event publisher\n** `SupportCaseCreated` event publisher\n** `SupportCaseUpdated` event translator (Salesforce webhook → domain event)\n** `SupportCaseResolved` event translator (Salesforce webhook → domain event)\n* Unit tests (>80% code coverage)\n* Integration tests (EngagementService ↔ Salesforce, EngagementService ↔ Braze)\n* API documentation\n* Deployment configuration (IaC)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* <<wp-cs-003,WP-CS-003>> (Event Bus Infrastructure) completed\n* Salesforce sandbox environment provisioned\n* Braze API credentials and campaign templates configured\n* Microsoft Entra External ID OAuth configuration\n\n*Dependent Work Packages*:\n\n* <<wp-cs-003,WP-CS-003>> must be completed first (Event Bus required for async processing)\n* <<wp-cs-007,WP-CS-007>> (Salesforce Configuration) must be in progress (field mapping needed)\n\n==== Skills Required\n\n* Backend development (.NET Core or Node.js)\n* REST API design and implementation\n* Salesforce REST API integration\n* Event-driven architecture patterns\n* Async/background processing (queues, workers)\n* Braze API integration\n* Webhook design and security\n* OAuth 2.0 / JWT authentication\n* Domain-Driven Design (DDD) - Anti-Corruption Layer pattern\n* Unit/integration testing frameworks\n* Infrastructure as Code (Terraform/CloudFormation)\n\n==== Acceptance Criteria\n\n* Feedback submission endpoint returns 202 Accepted within p95 < 200ms\n* Async Case creation succeeds with >99.5% success rate (including retries)\n* Anti-Corruption Layer correctly maps all feedback categories to Salesforce Case fields\n* Webhook receiver processes Salesforce Case updates and publishes domain events\n* Braze push notifications sent successfully for Case updates\n* Failed Case creation moves to Dead Letter Queue after 5 retry attempts\n* Unit test coverage > 80%\n* Integration tests pass with Salesforce sandbox and Braze staging environment\n\n[[wp-cs-003]]\n=== WP-CS-003: Event Bus Infrastructure\n\n==== Description\n\nImplement Event Bus infrastructure for domain event publishing using existing AWS infrastructure (SNS+SQS, EventBridge, or Kinesis).\n\n==== Deliverables\n\n* Event Bus infrastructure configuration\n** Topic/stream provisioning (technology choice: SNS+SQS / EventBridge / Kinesis)\n** FIFO queue configuration (ordering by `contactId`)\n** Dead Letter Queue (DLQ) setup\n** Retention policy (4 days / 96 hours)\n** Access control policies (IAM roles, permissions)\n* CloudEvents 1.0 schema definitions\n** JSON Schema specifications for all domain events\n** Schema validation configuration\n** Schema registry (if using EventBridge/Kinesis)\n* Monitoring and alerting\n** CloudWatch dashboards for queue metrics\n** Alarms for DLQ depth, queue age, processing failures\n** Event Bus throughput monitoring\n* Documentation\n** Event Bus architecture diagram\n** Event publishing guidelines\n** Consumer integration guide\n* Infrastructure as Code (IaC)\n** Terraform/CloudFormation templates for all infrastructure\n\n==== Dependencies\n\n*Prerequisites*:\n\n* AWS account access (existing infrastructure)\n* Technology selection decision (SNS+SQS vs EventBridge vs Kinesis)\n* CloudEvents 1.0 schema design approval\n\n*Dependent Work Packages*:\n\n* None (foundational infrastructure, can start early)\n\n==== Skills Required\n\n* AWS messaging services (SNS, SQS, EventBridge, Kinesis)\n* Event-driven architecture patterns\n* CloudEvents specification\n* JSON Schema design\n* Infrastructure as Code (Terraform/CloudFormation)\n* AWS IAM security configuration\n* CloudWatch monitoring and alerting\n\n==== Acceptance Criteria\n\n* Event Bus infrastructure provisioned in all environments (dev, staging, production)\n* FIFO ordering validated for events with same `contactId`\n* Dead Letter Queue triggers alarms when messages arrive\n* Event retention policy enforced (4 days)\n* CloudEvents 1.0 schema validation enabled\n* Monitoring dashboards operational\n* Infrastructure fully codified (IaC)\n\n[[wp-cs-004]]\n=== WP-CS-004: Contact Migration Tooling\n\n==== Description\n\nDevelop Contact migration tool for one-time migration from app-specific database to Salesforce Service Cloud with upsert logic and validation.\n\n==== Deliverables\n\n* Contact migration tool\n** Extract Contacts from app-specific database\n** Transform to Salesforce Contact API format\n** Upsert to Salesforce using email as external key\n** Fallback matching by phone number or Viva Consumer ID\n** Batch processing with rate limiting (respect Salesforce API limits)\n** Idempotent operation (can be re-run safely)\n* Validation scripts\n** Pre-migration validation (data quality checks)\n** Post-migration validation (100% Contact reconciliation)\n** Email/phone/VCI matching accuracy report\n* Reconciliation reporting\n** Contacts created vs updated statistics\n** Failed upserts with error details\n** Matching accuracy metrics\n* Rollback capability\n** Export snapshot of Salesforce Contacts before migration\n** Rollback procedure documentation\n* Documentation\n** Migration tool user guide\n** Troubleshooting guide\n** Runbook for migration execution\n\n==== Dependencies\n\n*Prerequisites*:\n\n* <<wp-cs-001,WP-CS-001>> (ProfileService Development) completed (reuses Salesforce integration code)\n* Salesforce sandbox environment for migration testing\n* App-specific database access (read-only sufficient)\n* Salesforce production access granted\n\n*Dependent Work Packages*:\n\n* <<wp-cs-001,WP-CS-001>> provides Salesforce Contact upsert logic to reuse\n\n==== Skills Required\n\n* Database development (SQL, data extraction)\n* Salesforce REST API integration\n* Batch processing and ETL patterns\n* Data validation and reconciliation\n* Error handling and logging\n* Scripting (Python, PowerShell, or similar)\n\n==== Acceptance Criteria\n\n* Migration tool successfully migrates 100% of Contacts in sandbox with zero data loss\n* Email/phone/VCI matching accuracy > 95% in sandbox testing\n* Failed upserts captured with actionable error messages\n* Reconciliation report matches actual Salesforce Contact counts\n* Migration tool execution time acceptable for production (freezes app database for minimum time)\n* Rollback procedure validated in sandbox\n* Documentation complete and approved\n\n[[wp-cs-005]]\n=== WP-CS-005: Mobile App Integration\n\n==== Description\n\nUpdate Mobile App to integrate with ProfileService and EngagementService APIs, replacing D365 CE integration.\n\n==== Deliverables\n\n* Feedback form UI enhancements\n** Add Category dropdown (App, Service, Order, Rewards, Refund, Delete Account)\n** Add Store Name field (optional)\n** Add Time of Visit field (optional, datetime picker)\n** Add Contact Phone Number field (optional, E.164 validation)\n** Update Message field (1-2000 character limit with counter)\n* API integration (Kotlin Multiplatform shared code)\n** ProfileService client (`GET /contact-id`)\n** EngagementService client (`POST /feedback`)\n** JWT token management (Microsoft Entra External ID)\n** Error handling (network failures, API errors, validation errors)\n** Retry logic for transient failures\n* Platform-specific UI (SwiftUI for iOS, Jetpack Compose for Android)\n** Feedback form screens\n** Success/error confirmation screens\n** Loading states and progress indicators\n* Feature flag integration\n** `enable_salesforce_feedback_submission` flag\n** Fallback to D365 CE if flag disabled (during rollout)\n* Unit tests for shared business logic\n* UI tests for platform-specific screens\n* API integration tests (mocked APIs)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* <<wp-cs-001,WP-CS-001>> (ProfileService Development) completed and deployed to dev/staging\n* <<wp-cs-002,WP-CS-002>> (EngagementService Development) completed and deployed to dev/staging\n* ProfileService and EngagementService OpenAPI specifications finalized\n* Feature flag service configured\n\n*Dependent Work Packages*:\n\n* Must complete after <<wp-cs-001,WP-CS-001>> and <<wp-cs-002,WP-CS-002>> (requires API endpoints available for integration testing)\n\n==== Skills Required\n\n* Kotlin Multiplatform development\n* SwiftUI (iOS native UI)\n* Jetpack Compose (Android native UI)\n* REST API client development\n* OAuth 2.0 / JWT authentication\n* Form validation and UX design\n* Unit testing (Kotlin, Swift)\n* UI testing frameworks (XCTest, Espresso)\n\n==== Acceptance Criteria\n\n* Feedback form UI matches UX design specifications\n* All form fields validate correctly (client-side validation)\n* API integration successfully calls ProfileService and EngagementService in dev/staging\n* Error handling provides user-friendly error messages\n* Feature flag correctly toggles between Salesforce and D365 CE integration\n* Unit test coverage > 80% for shared business logic\n* UI tests pass for all feedback form workflows (happy path, error states)\n* App builds and deploys successfully to TestFlight (iOS) and Google Play Internal Testing (Android)\n\n[[wp-cs-006]]\n=== WP-CS-006: Integration Testing\n\n==== Description\n\nExecute comprehensive integration testing across all system components in non-production environments.\n\n==== Deliverables\n\n* Test environment setup\n** Salesforce sandbox configured with test data\n** ProfileService deployed to staging\n** EngagementService deployed to staging\n** Event Bus staging infrastructure\n** Braze staging environment configured\n** Mobile App TestFlight/Internal Testing builds\n* Integration test suites\n** ProfileService ↔ Salesforce (Contact upsert scenarios)\n** EngagementService ↔ Salesforce (Case creation scenarios)\n** EngagementService ↔ Braze (push notification scenarios)\n** Mobile App ↔ ProfileService ↔ EngagementService (end-to-end workflows)\n** Event Bus publishing and consumption\n** Webhook receiver (Salesforce → EngagementService)\n* Test scenarios\n** Happy path: Successful feedback submission and Case creation\n** Error scenarios: Salesforce API failures, Braze API failures, network timeouts\n** Retry scenarios: Async Case creation retries, DLQ validation\n** Performance testing: p95 latency validation for ProfileService and EngagementService\n** Load testing: Simulate 3x-10x expected volume\n* UAT execution\n** Business stakeholder UAT sessions\n** UAT test cases covering all feedback categories\n** UAT sign-off documentation\n* Test results documentation\n** Test execution reports\n** Defect tracking and resolution\n** Performance test results\n\n==== Dependencies\n\n*Prerequisites*:\n\n* <<wp-cs-001,WP-CS-001>> (ProfileService Development) completed\n* <<wp-cs-002,WP-CS-002>> (EngagementService Development) completed\n* <<wp-cs-003,WP-CS-003>> (Event Bus Infrastructure) completed\n* <<wp-cs-005,WP-CS-005>> (Mobile App Integration) completed\n* <<wp-cs-007,WP-CS-007>> (Salesforce Configuration) sandbox configuration completed\n\n*Dependent Work Packages*:\n\n* Must complete after <<wp-cs-001,WP-CS-001>>, <<wp-cs-002,WP-CS-002>>, <<wp-cs-003,WP-CS-003>>, <<wp-cs-005,WP-CS-005>> (requires all components available)\n\n==== Skills Required\n\n* Integration testing strategy and execution\n* Test automation frameworks (Postman, Newman, Selenium)\n* Performance testing tools (JMeter, k6, Gatling)\n* Salesforce sandbox administration\n* Test data management\n* Defect tracking and triage\n* UAT facilitation\n\n==== Acceptance Criteria\n\n* All integration test scenarios pass (happy path, error scenarios, retry scenarios)\n* Performance SLAs validated (ProfileService p95 < 300ms, EngagementService p95 < 200ms)\n* Load testing confirms system handles 3x expected volume without degradation\n* UAT sign-off obtained from business stakeholders\n* Zero critical defects (P1/P2) open before moving to Contact Migration\n* Test results documented and approved\n\n[[wp-cs-007]]\n=== WP-CS-007: Salesforce Configuration\n\n==== Description\n\nConfigure Salesforce Service Cloud for OTR digital customer support integration, including field mapping, data isolation, and webhook setup.\n\n==== Deliverables\n\n* Salesforce Contact configuration\n** Custom fields for OTR-specific data (if needed)\n** Email as external key configuration\n** Record Type for OTR digital customers (data isolation)\n** Validation rules\n* Salesforce Case configuration\n** Custom fields for feedback categories (App, Service, Order, Rewards, Refund, Delete Account)\n** Case Type and Reason picklist mapping\n** Queue assignment rules (OTR digital support queue)\n** Case escalation rules\n** Case routing rules\n* Salesforce webhook configuration\n** Platform Events / Outbound Messages for Case updates\n** Webhook authentication (API key, JWT, or OAuth)\n** Case status change triggers (New → In Progress, Resolved, Closed)\n** Webhook payload format (JSON)\n* Data isolation strategy\n** Record Types for OTR vs other Viva Energy business units\n** Queues for OTR-specific Cases\n** Reporting and dashboards scoped to OTR data\n* Salesforce API access\n** Connected App configuration\n** OAuth 2.0 JWT bearer flow setup\n** API user credentials\n** API rate limit monitoring\n* Documentation\n** Salesforce field mapping specification\n** Webhook configuration guide\n** Data isolation architecture diagram\n** API authentication setup guide\n\n==== Dependencies\n\n*Prerequisites*:\n\n* Viva Energy Salesforce admin team engagement\n* Salesforce governance approval (multi-tenant environment)\n* Technical decision on webhook mechanism (Platform Events vs Outbound Messages)\n* Technical decision on authentication method (OAuth 2.0 JWT bearer flow recommended)\n\n*Dependent Work Packages*:\n\n* None (can start in parallel with development work packages)\n* Required for <<wp-cs-002,WP-CS-002>> (EngagementService needs field mapping)\n* Required for <<wp-cs-006,WP-CS-006>> (Integration Testing needs sandbox configuration)\n\n==== Skills Required\n\n* Salesforce administration\n* Salesforce configuration (Record Types, Queues, Validation Rules)\n* Salesforce API integration (REST API, Platform Events, Outbound Messages)\n* Salesforce security and authentication (OAuth, Connected Apps)\n* Multi-tenant data isolation patterns\n\n==== Acceptance Criteria\n\n* Salesforce sandbox configured with all custom fields, Record Types, Queues\n* Field mapping documented and approved by OTR business stakeholders\n* Webhook configuration tested and delivering Case update notifications\n* Data isolation validated (OTR data separate from other Viva Energy business units)\n* API authentication working for ProfileService and EngagementService\n* Salesforce API rate limits monitored and acceptable for expected volume\n* Configuration replicated to Salesforce production environment\n\n[[wp-cs-008]]\n=== WP-CS-008: Contact Data Migration\n\n==== Description\n\nExecute one-time Contact migration from app-specific database to Salesforce Service Cloud production.\n\n==== Deliverables\n\n* Pre-migration activities\n** Final validation of migration tool in sandbox\n** Communication plan (notify users of maintenance window if needed)\n** Freeze app-specific database Contact updates\n** Backup app-specific database\n** Export snapshot of Salesforce Contacts (rollback preparation)\n* Migration execution\n** Execute migration tool against Salesforce production\n** Monitor migration progress\n** Handle failed upserts (manual intervention if needed)\n* Post-migration validation\n** 100% Contact reconciliation (app database vs Salesforce)\n** Email/phone/VCI matching accuracy report\n** Reconciliation report (Contacts created vs updated)\n** Data integrity checks (no duplicate Contacts, no missing Contacts)\n* ProfileService smoke testing\n** Verify Contact ID retrieval works in production\n** Test cache behavior\n** Validate Salesforce Contact upserts from ProfileService\n* Migration report\n** Total Contacts migrated\n** Contacts created vs updated\n** Failed upserts (if any) with resolution\n** Matching accuracy metrics\n** Migration execution time\n\n==== Dependencies\n\n*Prerequisites*:\n\n* <<wp-cs-004,WP-CS-004>> (Contact Migration Tooling) completed\n* <<wp-cs-001,WP-CS-001>> (ProfileService Development) deployed to production (not yet integrated with Mobile App)\n* <<wp-cs-007,WP-CS-007>> (Salesforce Configuration) production configuration completed\n* Salesforce production access granted\n* Migration approved by business stakeholders\n\n*Dependent Work Packages*:\n\n* Must complete after <<wp-cs-001,WP-CS-001>>, <<wp-cs-004,WP-CS-004>>, <<wp-cs-007,WP-CS-007>>\n* Must complete before <<wp-cs-009,WP-CS-009>> (Production Deployment)\n\n==== Skills Required\n\n* Data migration execution\n* Salesforce administration\n* Database operations\n* Data validation and reconciliation\n* Incident management (if issues arise)\n\n==== Acceptance Criteria\n\n* 100% of Contacts migrated with zero data loss\n* Email/phone/VCI matching accuracy > 95%\n* ProfileService smoke tests pass in production\n* Reconciliation report approved by business stakeholders\n* App-specific database Contact updates frozen (read-only mode)\n* Rollback procedure ready (but not executed if migration successful)\n\n[[wp-cs-009]]\n=== WP-CS-009: Production Deployment\n\n==== Description\n\nDeploy all solution components to production and execute cutover from D365 CE to Salesforce Service Cloud.\n\n==== Deliverables\n\n* Production deployment\n** EngagementService deployed to production\n** Event Bus production infrastructure validated\n** Salesforce webhook configured in production\n** Mobile App released to production (App Store, Google Play)\n* Go-live activities\n** Smoke testing (end-to-end feedback submission)\n** Feature flag enabled: `enable_salesforce_feedback_submission = ON`\n** D365 CE integration disabled in Mobile App\n** Monitor Event Bus queue depth, DLQ, Salesforce API rate limits\n** Monitor Mobile App feedback submission success rate\n* Go/No-Go decision\n** Validate success criteria before final cutover\n** Business stakeholder approval\n** Technical validation (smoke tests pass, monitoring healthy)\n* Cutover communication\n** Notify support agents of new Salesforce integration\n** Provide training materials for support agents\n** Customer communication (if visible change)\n* Rollback plan\n** Documented rollback procedure\n** Feature flag can disable Salesforce integration and re-enable D365 CE\n** Rollback decision criteria (P1/P2 incidents, feedback submission success rate < 99%)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* <<wp-cs-001,WP-CS-001>> (ProfileService Development) completed\n* <<wp-cs-002,WP-CS-002>> (EngagementService Development) completed\n* <<wp-cs-003,WP-CS-003>> (Event Bus Infrastructure) completed\n* <<wp-cs-005,WP-CS-005>> (Mobile App Integration) completed\n* <<wp-cs-006,WP-CS-006>> (Integration Testing) completed with UAT sign-off\n* <<wp-cs-007,WP-CS-007>> (Salesforce Configuration) production configuration completed\n* <<wp-cs-008,WP-CS-008>> (Contact Data Migration) completed successfully\n* Mobile App release approval (App Store, Google Play)\n\n*Dependent Work Packages*:\n\n* Must complete after all prior work packages (final cutover)\n\n==== Skills Required\n\n* Production deployment and release management\n* Incident management and troubleshooting\n* Monitoring and observability\n* Change management and communication\n* Rollback execution (if needed)\n\n==== Acceptance Criteria\n\n* Mobile App feedback submission success rate > 99.5%\n* End-to-end flow validated (Mobile App → ProfileService → EngagementService → Salesforce Case created)\n* Braze push notifications delivered successfully\n* Event Bus queue depth normal, DLQ empty\n* No critical incidents (P1/P2) in first 24 hours\n* D365 CE integration disabled\n* Support agents successfully using Salesforce for OTR digital customer Cases\n\n[[wp-cs-010]]\n=== WP-CS-010: Post-Cutover Support\n\n==== Description\n\nMonitor production stability, resolve issues, validate success criteria, and execute D365 CE retirement.\n\n==== Deliverables\n\n* Monitoring and support\n** 24/7 on-call support for first week post-cutover\n** Daily monitoring reports (feedback submission success rate, Case creation success rate)\n** Incident response and resolution\n** Performance tuning (if needed)\n* Success criteria validation\n** Validate feedback submission success rate > 99.5%\n** Monitor customer satisfaction score (target: +15% improvement within 6 months)\n** Monitor average case resolution time (target: -20% improvement within 6 months)\n** Support agent feedback survey\n* D365 CE retirement\n** D365 CE set to read-only mode (historical Case lookups only)\n** Archive D365 CE data for compliance/auditing\n** Decommission D365 CE infrastructure (after 90-day stabilization period)\n** Remove D365 CE integration code from Mobile App\n* Documentation updates\n** Production runbook\n** Troubleshooting guide (based on incidents resolved)\n** Operational procedures for support team\n** Lessons learned document\n\n==== Dependencies\n\n*Prerequisites*:\n\n* <<wp-cs-009,WP-CS-009>> (Production Deployment) completed\n* Cutover successful with no critical incidents\n\n*Dependent Work Packages*:\n\n* Final work package in sequence\n\n==== Skills Required\n\n* Production support and incident management\n* Performance monitoring and tuning\n* Data archival and compliance\n* Infrastructure decommissioning\n* Documentation\n\n==== Acceptance Criteria\n\n* Zero critical incidents (P1/P2) in first 30 days post-cutover\n* Feedback submission success rate sustained > 99.5%\n* Customer satisfaction improvement validated (baseline established, ongoing measurement)\n* Support agents reporting positive experience with Salesforce unified view\n* D365 CE successfully decommissioned\n* All production documentation complete and approved\n* Lessons learned document published\n\n=== Work Package Sequencing\n\n==== Parallel Track 1: Infrastructure & Configuration\n\nCan start immediately and run in parallel:\n\n* <<wp-cs-003,WP-CS-003>> (Event Bus Infrastructure)\n* <<wp-cs-007,WP-CS-007>> (Salesforce Configuration)\n\n==== Parallel Track 2: Development\n\nCan start after Track 1 infrastructure decisions made:\n\n* <<wp-cs-001,WP-CS-001>> (ProfileService Development) - Independent\n* <<wp-cs-002,WP-CS-002>> (EngagementService Development) - Requires <<wp-cs-003,WP-CS-003>> completed\n* <<wp-cs-004,WP-CS-004>> (Contact Migration Tooling) - Requires <<wp-cs-001,WP-CS-001>> completed (reuses code)\n\n==== Sequential Track 3: Integration & Testing\n\nMust complete after development:\n\n* <<wp-cs-005,WP-CS-005>> (Mobile App Integration) - Requires <<wp-cs-001,WP-CS-001>>, <<wp-cs-002,WP-CS-002>>\n* <<wp-cs-006,WP-CS-006>> (Integration Testing) - Requires <<wp-cs-001,WP-CS-001>>, <<wp-cs-002,WP-CS-002>>, <<wp-cs-003,WP-CS-003>>, <<wp-cs-005,WP-CS-005>>, <<wp-cs-007,WP-CS-007>>\n\n==== Sequential Track 4: Migration & Cutover\n\nMust complete sequentially:\n\n* WP-CS-008 (Contact Data Migration) - Requires WP-CS-001, WP-CS-004, WP-CS-006 UAT sign-off\n* WP-CS-009 (Production Deployment) - Requires all prior work packages completed\n* WP-CS-010 (Post-Cutover Support) - Requires WP-CS-009\n\n==== Critical Path\n\nThe critical path for this project is:\n\n. WP-CS-003 (Event Bus Infrastructure)\n. WP-CS-002 (EngagementService Development) - blocks on WP-CS-003\n. WP-CS-005 (Mobile App Integration) - blocks on WP-CS-001, WP-CS-002\n. WP-CS-006 (Integration Testing) - blocks on WP-CS-001 through WP-CS-005, WP-CS-007\n. WP-CS-008 (Contact Data Migration) - blocks on WP-CS-006 UAT sign-off\n. WP-CS-009 (Production Deployment) - blocks on WP-CS-008\n. WP-CS-010 (Post-Cutover Support) - final deliverable\n\nAny delays in critical path work packages will delay the overall cutover date.\n\n<<<\n== Transition Architecture\n\nThis section defines the evolution from baseline (D365 CE) to target state (Salesforce Service Cloud + ProfileService + EngagementService).\n\n=== Transition Approach\n\n*Big Bang Cutover*: Per ADR-CS-006, this transition uses a single cutover approach rather than phased rollout. All users switch from D365 CE to Salesforce simultaneously after Contact migration completion.\n\n=== Transition States\n\n==== TS-0: Baseline State (Current)\n\n===== Characteristics\n\n* D365 Customer Engagement handles all digital customer feedback\n* App-specific database stores customer Contact data\n* No ProfileService or EngagementService\n* No event-driven architecture\n* Synchronous feedback submission\n\n===== Components Active\n\n- D365 Customer Engagement\n- App-specific customer database\n- Mobile App (current version with D365 CE integration)\n\n==== TS-1: Build & Test\n\n===== Activities\n\n* Build ProfileService microservice (JIT Contact reconciliation API)\n* Build EngagementService microservice (feedback submission API, ACL for Salesforce Case creation, Braze integration, webhook receiver)\n* Implement Event Bus infrastructure (SNS+SQS/EventBridge/Kinesis)\n* Develop Contact migration tool (app database → Salesforce upsert by email/phone/VCI)\n* Update Mobile App API integration (ProfileService + EngagementService endpoints - feedback form UI already complete)\n* Integration testing (ProfileService ↔ Salesforce, EngagementService ↔ Salesforce, EngagementService ↔ Braze)\n* UAT with test Salesforce sandbox environment\n\n===== Components Active\n\n- D365 Customer Engagement (still active, unchanged)\n- App-specific customer database (still active)\n- ProfileService (non-production, testing only)\n- EngagementService (non-production, testing only)\n- Event Bus (non-production)\n- Salesforce Sandbox (testing)\n\n===== Exit Criteria\n\n- All integration tests pass\n- UAT sign-off from business stakeholders\n- Contact migration tool validated in sandbox\n- Mobile App updates tested with non-production APIs\n\n==== TS-2: Contact Migration\n\n===== Activities\n* Execute Contact migration (app database → Salesforce production)\n* Validation: 100% data integrity check (email/phone/VCI matching)\n* Reconciliation report: New Contacts created vs existing Contacts updated\n* Freeze app database Contact updates during migration window\n* ProfileService smoke testing (verify Contact lookups work in Salesforce production)\n\n===== Components Active\n- D365 Customer Engagement (still active, users unaffected)\n- Salesforce Production (Contacts migrated, no Cases yet)\n- ProfileService (production deployed, not integrated with Mobile App yet)\n- App-specific customer database (frozen, read-only)\n\n===== Exit Criteria\n- 100% of Contacts migrated with zero data loss\n- Email/phone/VCI matching accuracy > 95%\n- ProfileService smoke tests pass (JIT lookups return correct Contact IDs)\n- Reconciliation report approved\n\n==== TS-3: Cutover (Go-Live)\n\n===== Go-Live Activities\n\n* Deploy EngagementService to production\n* Deploy Mobile App updates (ProfileService + EngagementService API integration)\n* Configure Salesforce webhook (Case update notifications → EngagementService)\n* Smoke testing: End-to-end feedback submission (Mobile App → EngagementService → Salesforce → Braze notification)\n* Monitor Event Bus queue depth, dead letter queue, Salesforce API rate limits\n* **Go/No-Go decision**: Validate success criteria before final cutover\n* Enable feature flag: `enable_salesforce_feedback_submission = ON`\n* Disable D365 CE integration in Mobile App\n\n===== Components Active\n\n- ProfileService (production, integrated with Mobile App)\n- EngagementService (production, integrated with Mobile App)\n- Event Bus (production, processing async Case creation)\n- Salesforce Production (receiving Cases from digital customers)\n- Braze (sending push notifications)\n- Mobile App (new version with Salesforce integration)\n- D365 Customer Engagement (disabled, read-only for historical lookups)\n\n===== Exit Criteria\n\n- Mobile App feedback submission success rate > 99.5%\n- End-to-end flow validated (Mobile App → Salesforce Case created)\n- Braze push notifications delivered successfully\n- Event Bus queue depth normal, DLQ empty\n- No critical incidents (P1/P2) in first 24 hours\n\n==== TS-4: Target State (Stable Production)\n\n===== Characteristics\n\n* ProfileService and EngagementService fully operational\n* All digital customer feedback routed to Salesforce\n* Event-driven architecture established\n* D365 CE decommissioned\n* First DDD bounded contexts implemented successfully\n\n===== Monitoring Period\n\n* Validate success criteria: feedback submission rate > 99.5%, no data loss\n* Monitor customer satisfaction score (target: +15% improvement)\n* Monitor average case resolution time (target: -20% improvement)\n* Support agents using unified Salesforce view across all channels\n\n===== D365 CE Retirement\n\n* D365 CE read-only access for historical Case lookups (if needed)\n* Decommission D365 CE infrastructure after 90 days\n* Archive D365 CE data for compliance/auditing\n\n===== Components Active\n\n- ProfileService (production)\n- EngagementService (production)\n- Event Bus (production)\n- Salesforce Production (system of record)\n- Braze (push notifications)\n- Mobile App (Salesforce integration)\n- App-specific database (deprecated, Contact data no longer updated)\n\n===== Success Criteria Achieved\n\n- All digital customer feedback routed to Salesforce\n- Support agents have unified customer view\n- D365 CE decommissioned\n- Customer satisfaction improved by 15%\n- Average case resolution time decreased by 20%\n- Zero data loss during transition\n\n=== Transition Dependencies\n\n[width=\"100%\",cols=\"40%,60%\",options=\"header\",]\n|===\n|Dependency |Owner/Status\n\n|*Salesforce production access*\n|Viva Energy Salesforce admin team - TBD\n\n|*Salesforce Case field mapping*\n|Viva Energy Salesforce admin team - TBD (map OTR feedback categories to Salesforce fields)\n\n|*Salesforce data isolation strategy*\n|Viva Energy Salesforce admin team - TBD (Record Types, queues, custom fields)\n\n|*Salesforce webhook configuration*\n|Viva Energy Salesforce admin team - TBD (Outbound Messages vs Platform Events)\n\n|*Event Bus infrastructure*\n|OTR Platform team - Existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis)\n\n|*Braze integration*\n|OTR Marketing team - Existing Braze account, EngagementService creates new campaigns\n\n|*Mobile App release window*\n|OTR Mobile team - Coordinate cutover timing with app release schedule\n\n|*App database access*\n|OTR Platform team - Read access for Contact migration\n\n|===\n\n=== Transition Validation Criteria\n\n==== Contact Migration Validation\n\n* 100% of app database Contacts migrated to Salesforce (zero data loss)\n* Email/phone/VCI matching accuracy > 95% (minimize duplicate Contacts)\n* ProfileService JIT lookups return correct Salesforce Contact IDs (smoke test sample)\n* Reconciliation report shows: X new Contacts created, Y existing Contacts updated\n\n==== Cutover Validation\n\n* Mobile App feedback submission success rate > 99.5% (including async Case creation)\n* End-to-end flow validated: Mobile App → ProfileService → EngagementService → Salesforce Case created\n* Braze push notifications delivered for Case creation and Case resolution\n* Event Bus queue depth within normal range (no backlog)\n* Dead letter queue empty (no failed Case creations)\n* Salesforce API rate limits not exceeded\n\n==== Production Monitoring (30 days)\n\n* Customer satisfaction score improves by 15% (compared to D365 CE baseline)\n* Average case resolution time decreases by 20% (Salesforce vs D365 CE)\n* Support agents confirm unified customer view across all channels\n* Zero critical incidents (P1 outages, data loss)\n\n=== Rollback Plan\n\n==== Rollback Triggers\n\n* Feedback submission success rate < 95% (below acceptable threshold)\n* Data loss or corruption detected in Salesforce\n* Salesforce API rate limits exceeded (Cases not created within SLA)\n* Critical bug blocking customer feedback submission\n\n==== Rollback Procedure\n\n1. **Revert Mobile App** to previous version (remove ProfileService/EngagementService integration, restore D365 CE integration)\n2. **Stop EngagementService** Case creation (prevent duplicate Cases in Salesforce)\n3. **Re-enable D365 CE** for customer feedback submission\n4. **Investigate root cause** (EngagementService logs, Salesforce API errors, Event Bus queue issues)\n5. **Fix and re-test** in sandbox environment\n6. **Retry cutover** when issues resolved\n\n==== Rollback Limitations\n\n* Cases created in Salesforce during cutover period remain in Salesforce (no reverse migration)\n* Contacts migrated to Salesforce remain (no rollback to app database)\n* Rollback only affects Mobile App integration (not data migration)\n\n=== Architectural Scope Boundaries\n\n==== Capabilities Included\n\n===== Business Capabilities\n\n* **Customer Feedback Submission**: Mobile App users can submit structured feedback (Category, Store Name, Time of Visit, Phone, Free Text Message) via EngagementService\n* **Customer Contact Management**: Just-In-Time (JIT) Contact reconciliation with Salesforce via ProfileService, ensuring every Mobile App user has a Salesforce Contact record\n* **Case Management Integration**: EngagementService creates Salesforce Cases asynchronously for customer feedback, support agents manage Cases in Salesforce Service Cloud\n* **Customer Notifications**: Push notifications via Braze when Cases are created, updated, or resolved (bidirectional integration: Mobile App → Salesforce → Mobile App)\n* **Unified Customer View**: Support agents see OTR digital customer feedback alongside other Viva Energy channels (fuel wholesale, Shell Card, retail) in single Salesforce instance\n* **Contact Data Migration**: One-time migration of app-specific customer database Contacts to Salesforce with upsert logic (email/phone/VCI matching)\n\n===== Technical Capabilities\n\n* **ProfileService Bounded Context**: First DDD bounded context implementation - JIT Contact reconciliation, Salesforce API facade, foundation for Flybuys integration\n* **EngagementService Bounded Context**: First DDD bounded context implementation - Customer feedback submission BFF, Anti-Corruption Layer for Salesforce, Braze integration orchestration\n* **Event-Driven Architecture**: Domain event publishing via Event Bus (SNS+SQS/EventBridge/Kinesis) for `SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted` events\n* **Async Processing Pattern**: Non-blocking Case creation with retry logic, exponential backoff, dead letter queue for operational resilience\n* **Anti-Corruption Layer Pattern**: EngagementService protects digital channels from Salesforce API changes, translates between OTR domain language and Salesforce\n* **Conformist Pattern**: ProfileService and EngagementService conform to existing Salesforce configuration (shared Viva Energy instance, multi-tenant governance)\n* **Salesforce Integration**: REST API integration for Contact CRUD and Case creation, webhook receiver for Case update notifications\n* **Braze Integration**: Push notification campaign triggers for Case lifecycle events (created, updated, resolved)\n* **Observability & Monitoring**: Dashboards, metrics, alerting for feedback submission rate, queue depth, API errors, Case creation latency\n* **Feature Flag Management**: Kill switches for emergency rollback (enable_salesforce_feedback_submission, enable_async_case_creation, etc.)\n\n==== Capabilities Excluded\n\n===== Business Capabilities Explicitly Out of Scope\n\n* **Historical Case Migration**: D365 CE Cases not migrated to Salesforce (ADR-CS-005 - fresh start, no Case migration)\n* **Multi-Channel Feedback Submission**: Web app, POS, call centre, email feedback channels not included (Mobile App only in this phase)\n* **Case Resolution by Digital Channels**: Support agents resolve Cases in Salesforce, not via Mobile App self-service\n* **Knowledge Base Integration**: Salesforce Knowledge Base articles not surfaced in Mobile App (future enhancement)\n* **Live Chat/Messaging**: Real-time chat support not included (Salesforce omnichannel capabilities not activated)\n* **Sentiment Analysis**: Automated feedback sentiment analysis not included (future enhancement with AI/ML)\n* **Customer Satisfaction Surveys**: Post-resolution CSAT surveys not included (separate initiative)\n* **Case Attachments**: Mobile App feedback submission does not support file uploads (photos, receipts) - text only\n* **Agent Desktop Integration**: Custom Salesforce UI for support agents not included (use standard Salesforce Service Console)\n* **Social Media Feedback**: Facebook, Twitter, Instagram feedback channels not integrated\n\n===== Technical Capabilities Explicitly Out of Scope\n\n* **Event Sourcing**: Domain events are ephemeral (not persisted for event sourcing/replay) - Event Bus only, no Event Store\n* **CQRS (Command Query Responsibility Segregation)**: ProfileService and EngagementService use same data model for reads/writes (no separate read models)\n* **Local Aggregate Persistence**: ProfileService and EngagementService are stateless (Salesforce is System of Record, no local database for Contact/Case)\n* **Saga Orchestration**: No distributed transactions or saga patterns required (single-step Case creation, not multi-step workflow)\n* **API Gateway Advanced Features**: Rate limiting, API versioning, API key management deferred to detailed design (basic routing only)\n* **GraphQL API**: ProfileService and EngagementService expose REST APIs only (GraphQL not required)\n* **Real-Time Sync**: Salesforce Contact updates by support agents not synced back to ProfileService (eventual consistency acceptable via JIT reconciliation)\n* **Multi-Region Deployment**: Single AWS region deployment (no multi-region failover/disaster recovery in this phase)\n* **Blue-Green Deployment**: Big bang cutover (ADR-CS-006), not blue-green or canary deployment strategy\n* **A/B Testing Framework**: Feature flags for rollback only, not for A/B testing or experimentation\n* **Custom Authentication**: Microsoft Entra External ID used for Mobile App authentication (no custom authentication logic in ProfileService/EngagementService)\n* **Data Residency Compliance**: Salesforce data residency governed by Viva Energy Salesforce configuration (no OTR-specific data residency requirements)\n\n===== Future Bounded Contexts Not in Scope\n\n* **LoyaltyService**: Flybuys integration, reward preferences, transaction adjudication (separate initiative)\n* **LocationService**: Store finder, proximity features, geofencing (separate initiative)\n* **PaymentService**: Payment processing, subscription billing (separate initiative)\n* **RecommendationService**: Personalized recommendations, next-best offers (separate initiative)\n\n===== Integration Patterns Not in Scope\n\n* **Shared Kernel**: No shared domain model between ProfileService and EngagementService (separate bounded contexts with clear boundaries)\n* **Partnership**: No joint development or coordination with external teams (Conformist pattern - we conform to Salesforce)\n* **Customer-Supplier (we're upstream)**: No downstream systems depend on ProfileService/EngagementService APIs yet (future bounded contexts will consume domain events)\n\n==== Architectural Dependencies on Future Initiatives\n\n*This Architecture Enables Future Initiatives*:\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Future Initiative |Architectural Enablement\n\n|*Flybuys Integration*\n|**ProfileService Contact Reconciliation Reused**: ProfileService establishes pattern for JIT Contact reconciliation with Salesforce, which will be extended for Flybuys partner linking (link:../architecture_definitions/flybuys_integration.adoc[see Flybuys Integration architecture]) +\n**Event Bus Infrastructure**: Domain event publishing pattern (`CustomerEnrolledInLoyalty`, `PartnerLinked`, etc.) reuses Event Bus established for EngagementService\n\n|*LoyaltyService Bounded Context*\n|**Event Bus Subscription**: LoyaltyService will consume `CustomerProfileCreated` events published by ProfileService (future enhancement) +\n**Salesforce Contact Integration**: LoyaltyService may query Salesforce Contacts for customer reward preferences (via ProfileService facade or direct Salesforce API)\n\n|*Web App Feedback Submission*\n|**EngagementService API Reuse**: Web app will call same EngagementService REST API for feedback submission (multi-channel support) +\n**Conformist Pattern**: Web app conforms to EngagementService API contract (no translation required)\n\n|*Multi-Channel Customer Support*\n|**EngagementService Extension**: Add support for email, call centre, POS feedback channels (extend EngagementService to handle multiple origins) +\n**Salesforce Case Origin Field**: Cases already tagged with Origin=Mobile App, extend to Origin=Web, POS, Call Centre, Email\n\n|*Knowledge Base Integration*\n|**EngagementService API Extension**: Add endpoint to query Salesforce Knowledge Base articles, surface in Mobile App for self-service support +\n**Anti-Corruption Layer**: EngagementService translates Salesforce Knowledge API to OTR domain language\n\n|*Customer Satisfaction Surveys*\n|**Event-Driven Trigger**: Subscribe to `SupportCaseResolved` events published by EngagementService, trigger CSAT survey via Braze +\n**Braze Integration Pattern**: Reuse EngagementService → Braze integration pattern for survey campaigns\n\n|*Sentiment Analysis*\n|**Event Subscription**: Subscribe to `CustomerFeedbackSubmitted` events, analyse feedback sentiment (AI/ML service) +\n**EngagementService Extension**: Enrich Case with sentiment score before creating in Salesforce\n\n|*RecommendationService Bounded Context*\n|**Event Subscription**: RecommendationService subscribes to `SupportCaseCreated` events to understand customer pain points and personalize recommendations +\n**Domain Event Pattern**: Reuse Event Bus publishing pattern established by EngagementService\n\n|===\n\n*This Architecture Depends on Future Initiatives*:\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Future Initiative |Dependency Description\n\n|*Salesforce Data Isolation Strategy*\n|**BLOCKER**: Viva Energy Salesforce admin team must define data isolation strategy (Record Types, custom fields, queues) before production deployment +\n**Impact**: Multi-tenant data visibility and security governance\n\n|*Salesforce Case Field Mapping*\n|**BLOCKER**: Viva Energy Salesforce admin team must define field mapping for OTR feedback categories (App, Service, Order, Rewards, Refund, Delete Account) +\n**Impact**: Case creation logic in EngagementService depends on finalized Salesforce schema\n\n|*Salesforce Webhook Mechanism*\n|**BLOCKER**: Viva Energy Salesforce admin team must configure webhook mechanism (Outbound Messages vs Platform Events vs Process Builder) for Case update notifications +\n**Impact**: EngagementService webhook receiver implementation depends on chosen mechanism\n\n|*Event Bus Technology Selection*\n|**DECISION REQUIRED**: Choose Event Bus implementation (SNS+SQS vs EventBridge vs Kinesis) for domain event publishing +\n**Impact**: Infrastructure provisioning, event schema design, consumer implementation\n\n|*Microservice Hosting Platform*\n|**DECISION REQUIRED**: Choose hosting platform for ProfileService and EngagementService (AWS Lambda vs ECS vs EKS) +\n**Impact**: Deployment architecture, auto-scaling strategy, operational overhead\n\n|*Observability Platform*\n|**DECISION REQUIRED**: Choose observability platform (AWS CloudWatch vs Datadog vs New Relic) for monitoring and alerting +\n**Impact**: Dashboard configuration, metric collection, alerting setup\n\n|===\n\n*Future Work After This Initiative*:\n\n* **Event Schema Registry**: Implement event schema versioning and registry for domain events (currently ad-hoc schemas)\n* **API Versioning Strategy**: Define API versioning approach for ProfileService and EngagementService (currently v1 only)\n* **Multi-Region Deployment**: Extend to multi-region for disaster recovery and global availability\n* **Event Store**: Persist domain events for event sourcing and audit trail (currently ephemeral Event Bus only)\n* **CQRS Pattern**: Separate read models for high-volume queries (currently same model for reads/writes)\n* **GraphQL API**: Expose GraphQL API for flexible client queries (currently REST only)\n* **Real-Time Sync**: Bi-directional sync between Salesforce and ProfileService for Contact updates (currently JIT reconciliation only)\n\n=== Technical Risks and Mitigation\n\n[width=\"100%\",cols=\"5%,20%,25%,25%,25%\",options=\"header\",]\n|===\n|ID |Risk |Impact |Likelihood |Mitigation\n\n|RISK-CS-001\n|*Salesforce API rate limits exceeded*: High feedback volume exceeds Salesforce API limits, Cases not created\n|HIGH (customers don't receive Case confirmation, support tickets lost)\n|MEDIUM (volume unknown, rate limits TBD)\n|• Gather expected feedback volume data before cutover +\n• Implement Event Bus queue throttling/rate limiting +\n• Monitor queue depth and API usage +\n• Scale background workers based on queue depth +\n• Alert ops team when approaching rate limits\n\n|RISK-CS-002\n|*Salesforce downtime*: Salesforce Service Cloud outage prevents Case creation\n|MEDIUM (Cases delayed but queued, customers wait for confirmation)\n|LOW (Salesforce SLA 99.9% uptime)\n|• Async Case creation with retry logic +\n• Event Bus queues buffer work during outage +\n• Customers get immediate \"Feedback submitted\" (not blocked) +\n• Monitor Salesforce status page, alert ops team +\n• Automatic retry when Salesforce recovers\n\n|RISK-CS-003\n|*Contact migration data quality issues*: App database Contact data incomplete or invalid\n|HIGH (migration fails validation, cutover delayed)\n|MEDIUM (legacy data quality unknown)\n|• Pre-migration data quality assessment +\n• Flexible upsert logic (match by email/phone/VCI) +\n• Validation report identifies data issues before production migration +\n• Manual cleanup for invalid records +\n• Dry-run migration in sandbox environment\n\n|RISK-CS-004\n|*Duplicate Contacts created*: Email matching fails, ProfileService creates duplicate Contacts\n|MEDIUM (support agents see multiple profiles for same customer)\n|MEDIUM (email changes, data quality issues)\n|• Salesforce duplicate detection rules (if available) +\n• ProfileService logs Contact creation for audit trail +\n• Manual duplicate cleanup process (support team) +\n• Future enhancement: VCI as Salesforce External ID for stable matching\n\n|RISK-CS-005\n|*Dead letter queue accumulation*: Failed Case creations not processed, queue grows\n|HIGH (customers don't receive Case confirmation, feedback lost)\n|LOW (retry logic handles most failures)\n|• Dead letter queue monitoring and alerting +\n• Ops team dashboard showing DLQ depth +\n• Manual intervention process (investigate and reprocess) +\n• Automated alerts when DLQ depth exceeds threshold +\n• Root cause analysis for recurring failures\n\n|RISK-CS-006\n|*Salesforce webhook failures*: Salesforce can't deliver Case update notifications to EngagementService\n|MEDIUM (customers don't get push notifications for Case resolution)\n|LOW (webhook mechanism reliable)\n|• Webhook retry logic and exponential backoff +\n• EngagementService logs webhook deliveries +\n• Monitor webhook delivery success rate +\n• Fallback: Poll Salesforce API for Case updates (if webhook fails persistently) +\n• Alert ops team when webhook delivery rate drops\n\n|RISK-CS-007\n|*Multi-tenant data isolation breach*: OTR digital Cases visible to other Viva Energy support teams\n|HIGH (privacy violation, compliance risk)\n|LOW (Salesforce governance controls)\n|• Work with Viva Energy Salesforce admin team on data isolation strategy +\n• Test data visibility in Salesforce sandbox (UAT with different user roles) +\n• Validate Record Types, queues, field-level security before production +\n• Audit Salesforce user permissions and sharing rules\n\n|RISK-CS-008\n|*Mobile App release coordination*: App release delayed, cutover window missed\n|MEDIUM (cutover delayed, D365 CE retirement delayed)\n|MEDIUM (release schedule conflicts)\n|• Coordinate cutover timing with Mobile team early +\n• Buffer time in migration plan (2-week contingency) +\n• Decouple backend deployment from Mobile App release (backend deployed first, app follows) +\n• Feature flag for feedback submission (enable when ready)\n\n|RISK-CS-009\n|*Event Bus infrastructure issues*: SNS/SQS/EventBridge downtime or misconfiguration\n|HIGH (Case creation blocked, domain events not published)\n|LOW (AWS SLA 99.99% uptime)\n|• Leverage existing AWS infrastructure (proven, reliable) +\n• Infrastructure as Code (IaC) for Event Bus configuration +\n• Integration testing in non-production environment +\n• Monitor Event Bus metrics (queue depth, throughput, errors) +\n• Alert ops team on Event Bus failures\n\n|RISK-CS-010\n|*Team DDD knowledge gap*: Team unfamiliar with DDD patterns, bounded contexts, event-driven architecture\n|MEDIUM (implementation delays, architectural inconsistencies)\n|HIGH (first DDD implementation)\n|• DDD training for development team (workshops, documentation) +\n• Architecture review sessions (validate bounded context design) +\n• Pair programming with experienced DDD practitioners +\n• Incremental implementation (start small, iterate) +\n• Document architectural patterns in CLAUDE.md\n\n|===\n\n== Assumptions and Constraints\n\n=== Assumptions\n\n[width=\"100%\",cols=\"8%,92%\",options=\"header\",]\n|===\n|ID |Assumption\n\n|ASM-CS-001\n|Viva Energy Salesforce admin team will provide Salesforce production access, sandbox environment, and support for Case field mapping and data isolation configuration\n\n|ASM-CS-002\n|App database Contact data is sufficiently complete for migration (email/phone/VCI available for matching)\n\n|ASM-CS-003\n|Expected customer feedback volume (100-150 submissions/day from 20k DAU) is well within Salesforce API rate limits, with capacity planning for 3x-10x growth\n\n|ASM-CS-004\n|Existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis) is sufficient for Event Bus implementation (no additional infrastructure provisioning required)\n\n|ASM-CS-005\n|Braze integration already exists and can be extended for Case-related push notifications (no new Braze account or major configuration changes)\n\n|ASM-CS-006\n|Mobile App users have email addresses associated with their accounts (required for ProfileService Contact reconciliation)\n\n|ASM-CS-007\n|D365 Customer Engagement historical Cases have limited business value and do not require migration to Salesforce\n\n|ASM-CS-008\n|Support agents are trained on Salesforce Service Cloud and require minimal additional training for OTR digital customer Cases\n\n|ASM-CS-009\n|Salesforce Service Cloud shared instance has capacity for OTR digital customer Contacts and Cases (no additional licensing or storage costs)\n\n|ASM-CS-010\n|Mobile App release schedule can accommodate cutover timing (Week 10 in migration plan)\n\n|===\n\n=== Constraints\n\n[width=\"100%\",cols=\"8%,92%\",options=\"header\",]\n|===\n|ID |Constraint\n\n|CON-CS-001\n|Must use shared Viva Energy Salesforce Service Cloud instance (cannot deploy separate OTR-specific instance)\n\n|CON-CS-002\n|Must conform to existing Salesforce configuration and governance (Record Types, custom fields, queues, data isolation strategy defined by Viva Energy admin team)\n\n|CON-CS-003\n|Contact migration must complete before Mobile App cutover (no parallel run of D365 CE and Salesforce)\n\n|CON-CS-004\n|Big bang cutover only (no phased rollout with feature flags or pilot users)\n\n|CON-CS-005\n|Salesforce API rate limits and authentication method constrained by Viva Energy Salesforce configuration (TBD)\n\n|CON-CS-006\n|Event Bus implementation must use existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis - cannot introduce new infrastructure components)\n\n|CON-CS-007\n|Mobile App feedback form must include specific fields: Category, Store Name, Time of Visit, Contact Phone Number, Free Text Message (no attachments)\n\n|CON-CS-008\n|D365 Customer Engagement must be decommissioned within 90 days post-cutover (ADR-CS-006)\n\n|CON-CS-009\n|ProfileService and EngagementService must be stateless (no local aggregate persistence, Salesforce is System of Record)\n\n|CON-CS-010\n|First DDD bounded context implementation (team learning curve, architectural patterns must be documented for future bounded contexts)\n\n|===\n\n== Non-Functional Requirements\n\n=== Performance Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-PERF-001\n|Mobile App feedback submission API response time (ProfileService + EngagementService)\n|p95 < 1 second, p99 < 2 seconds\n\n|NFR-PERF-002\n|ProfileService Contact reconciliation API response time (JIT lookup)\n|p95 < 500ms, p99 < 1 second\n\n|NFR-PERF-003\n|EngagementService async Case creation latency (end-to-end: feedback submitted → Case created in Salesforce)\n|p95 < 5 minutes, p99 < 10 minutes\n\n|NFR-PERF-004\n|Salesforce API call latency (Contact query, Contact create, Case create)\n|p95 < 2 seconds, p99 < 5 seconds\n\n|NFR-PERF-005\n|Event Bus message processing throughput\n|> 100 messages/second (support peak feedback volume)\n\n|NFR-PERF-006\n|Braze push notification delivery latency (Case created → notification delivered)\n|p95 < 30 seconds, p99 < 60 seconds\n\n|===\n\n=== Availability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-AVAIL-001\n|ProfileService availability\n|99.9% uptime (8.76 hours downtime/year)\n\n|NFR-AVAIL-002\n|EngagementService availability\n|99.9% uptime (8.76 hours downtime/year)\n\n|NFR-AVAIL-003\n|Feedback submission success rate (including async Case creation)\n|> 99.5% (includes retry logic for transient failures)\n\n|NFR-AVAIL-004\n|Graceful degradation: Salesforce downtime handling\n|Feedback submission still succeeds, Cases queued for async creation when Salesforce recovers\n\n|NFR-AVAIL-005\n|Graceful degradation: Braze downtime handling\n|Case creation proceeds, push notifications disabled temporarily (feature flag)\n\n|NFR-AVAIL-006\n|Planned maintenance window\n|< 4 hours/month, scheduled during low-traffic periods (2-6am ACST)\n\n|===\n\n=== Scalability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-SCALE-001\n|Concurrent Mobile App users (peak)\n|Support 20,000 DAU (Daily Active Users), ~150 concurrent users submitting feedback during peak hours\n\n|NFR-SCALE-002\n|Feedback submissions per day\n|Expected: 100-150 submissions/day based on 20k DAU (~0.5-0.75% submission rate) +\nCapacity: Support 500 submissions/day (3x expected volume for growth), 2,000 submissions/day (peak/incident scenarios)\n\n|NFR-SCALE-003\n|Auto-scaling: ProfileService and EngagementService\n|Auto-scale based on CPU/memory/request rate, scale up within 2 minutes\n\n|NFR-SCALE-004\n|Event Bus queue capacity\n|Support 100,000 queued messages (buffer for Salesforce downtime)\n\n|NFR-SCALE-005\n|Salesforce API rate limit compliance\n|Stay within 80% of Salesforce API rate limits (buffer for spikes)\n\n|NFR-SCALE-006\n|Future growth capacity\n|Architecture supports 10x growth (1,000-1,500 submissions/day based on 200k DAU) without major redesign\n\n|===\n\n=== Security Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-SEC-001\n|Mobile App authentication\n|Microsoft Entra External ID OAuth 2.0 with JWT tokens (existing CIAM)\n\n|NFR-SEC-002\n|API authorisation: ProfileService and EngagementService\n|JWT token validation, authenticated users only, user context propagation\n\n|NFR-SEC-003\n|Salesforce API authentication\n|OAuth 2.0 with Connected App and JWT bearer flow (service account)\n\n|NFR-SEC-004\n|Data encryption in transit\n|TLS 1.2+ for all API calls (Mobile App ↔ ProfileService/EngagementService ↔ Salesforce ↔ Braze)\n\n|NFR-SEC-005\n|Data encryption at rest\n|Salesforce encryption at rest (managed by Salesforce), Event Bus message encryption (AWS KMS)\n\n|NFR-SEC-006\n|Secret management\n|AWS Secrets Manager for Salesforce credentials, Braze API keys, OAuth tokens (no hardcoded secrets)\n\n|NFR-SEC-007\n|PII data handling\n|Contact data (email, phone, name) treated as PII, GDPR-compliant retention policies (Salesforce governance)\n\n|NFR-SEC-008\n|API rate limiting and throttling\n|API Gateway rate limiting (100 requests/second per user), prevent abuse and DoS\n\n|NFR-SEC-009\n|Logging and auditing\n|Log all API calls, Salesforce Contact/Case creates/updates, Event Bus publishes (no PII in logs)\n\n|NFR-SEC-010\n|Salesforce data isolation\n|Multi-tenant data isolation via Salesforce Record Types, queues, sharing rules (defined by Viva Energy admin team)\n\n|===\n\n=== Reliability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-REL-001\n|Retry logic: EngagementService → Salesforce Case creation\n|Exponential backoff (1s, 2s, 4s, 8s, 16s), max 5 retries, then dead letter queue\n\n|NFR-REL-002\n|Dead letter queue monitoring\n|Alert ops team immediately when DLQ depth > 0 (failed Case creations require manual intervention)\n\n|NFR-REL-003\n|Event Bus message durability\n|Messages persisted in Event Bus (SNS+SQS/EventBridge/Kinesis), not lost on service restart\n\n|NFR-REL-004\n|Idempotency: Case creation\n|EngagementService ensures duplicate feedback submissions don't create duplicate Cases (idempotency key)\n\n|NFR-REL-005\n|Circuit breaker: Salesforce API calls\n|Open circuit after 5 consecutive failures, half-open retry after 30 seconds\n\n|NFR-REL-006\n|Health checks: ProfileService and EngagementService\n|Health endpoints for load balancer checks, readiness and liveness probes\n\n|NFR-REL-007\n|Disaster recovery: Event Bus\n|Event Bus messages replicated across AWS availability zones (SQS/EventBridge/Kinesis HA)\n\n|===\n\n=== Maintainability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-MAINT-001\n|Code quality: ProfileService and EngagementService\n|> 80% test coverage (unit + integration tests), automated CI/CD pipeline\n\n|NFR-MAINT-002\n|API documentation\n|OpenAPI/Swagger specs for ProfileService and EngagementService, auto-generated API docs\n\n|NFR-MAINT-003\n|Deployment automation\n|Infrastructure as Code (Terraform/CloudFormation/CDK), zero-downtime deployments\n\n|NFR-MAINT-004\n|Logging: structured logs\n|JSON-formatted logs with correlation IDs, log levels (DEBUG, INFO, WARN, ERROR), centralized log aggregation\n\n|NFR-MAINT-005\n|Monitoring dashboards\n|Real-time dashboards for ProfileService, EngagementService, Event Bus (see Monitoring and Observability section)\n\n|NFR-MAINT-006\n|Alerting and on-call\n|PagerDuty/Opsgenie integration for P1/P2 alerts, on-call rotation for ops team\n\n|NFR-MAINT-007\n|Configuration management\n|Externalized configuration (environment variables, AWS Parameter Store), no hardcoded config\n\n|NFR-MAINT-008\n|Versioning: API and events\n|Semantic versioning (v1, v2), backward compatibility for API changes, event schema evolution\n\n|===\n\n=== Usability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-USE-001\n|Feedback submission UX\n|Mobile App user receives immediate \"Feedback submitted\" confirmation (< 1 second), not blocked by async Case creation\n\n|NFR-USE-002\n|Push notification delivery\n|Customer receives \"Your feedback has been received\" notification within 30 seconds of Case creation in Salesforce\n\n|NFR-USE-003\n|Case resolution notification\n|Customer receives \"Your case has been resolved\" notification within 30 seconds of support agent resolving Case\n\n|NFR-USE-004\n|Error messaging\n|User-friendly error messages for failed feedback submission (not technical errors), retry prompts\n\n|NFR-USE-005\n|Accessibility\n|Mobile App feedback form meets WCAG 2.1 AA accessibility standards (existing Mobile App compliance)\n\n|===\n\n=== Compliance Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-COMP-001\n|GDPR compliance: PII data\n|Customer Contact data (email, phone, name) managed per GDPR retention policies (Salesforce governance)\n\n|NFR-COMP-002\n|GDPR compliance: Right to erasure\n|Support \"Delete Account\" feedback category, trigger Contact deletion in Salesforce per GDPR Article 17\n\n|NFR-COMP-003\n|Data residency\n|Salesforce data residency governed by Viva Energy Salesforce configuration (regional compliance)\n\n|NFR-COMP-004\n|Audit trail\n|All Contact creates/updates, Case creates/updates logged for compliance auditing (Salesforce audit logs)\n\n|NFR-COMP-005\n|API security standards\n|OWASP API Security Top 10 compliance (injection prevention, authentication, authorisation, data exposure)\n\n|===\n\n== Monitoring and Observability\n\n=== Key Metrics\n\n[width=\"100%\",cols=\"25%,40%,35%\",options=\"header\",]\n|===\n|Metric Category |Metric |Target/Threshold\n\n|*Feedback Submission*\n|Feedback submission success rate (Mobile App → EngagementService)\n|> 99.5%\n\n|*Async Case Creation*\n|Case creation success rate (EngagementService → Salesforce)\n|> 99%\n\n|*Async Case Creation*\n|Case creation latency (time from feedback submission to Case created in Salesforce)\n|p95 < 5 minutes\n\n|*Event Bus*\n|Event Bus queue depth (pending Case creations)\n|< 100 messages\n\n|*Event Bus*\n|Dead letter queue depth (failed Case creations)\n|= 0 (alert on any failures)\n\n|*Salesforce API*\n|Salesforce API error rate\n|< 1%\n\n|*Salesforce API*\n|Salesforce API latency (Case creation)\n|p95 < 2 seconds\n\n|*Salesforce API*\n|Salesforce API rate limit utilization\n|< 80% of limit\n\n|*ProfileService*\n|Contact reconciliation success rate (JIT lookups)\n|> 99.5%\n\n|*ProfileService*\n|Contact reconciliation latency\n|p95 < 500ms\n\n|*Braze Notifications*\n|Push notification delivery rate (Case created/updated)\n|> 95%\n\n|*Salesforce Webhook*\n|Webhook delivery success rate (Salesforce → EngagementService)\n|> 99%\n\n|*Customer Satisfaction*\n|Customer satisfaction score (CSAT)\n|> 4.0/5.0 (improve by 15% from D365 CE baseline)\n\n|*Support Operations*\n|Average case resolution time\n|Decrease by 20% from D365 CE baseline\n\n|===\n\n=== Alerting Thresholds\n\n[width=\"100%\",cols=\"25%,50%,25%\",options=\"header\",]\n|===\n|Alert |Condition |Severity\n\n|*Feedback submission failures*\n|Feedback submission success rate < 95% over 5-minute window\n|P1 - Critical\n\n|*Dead letter queue accumulation*\n|Dead letter queue depth > 0 (any failed Case creations)\n|P2 - High\n\n|*Event Bus queue backlog*\n|Event Bus queue depth > 100 messages for > 15 minutes\n|P2 - High\n\n|*Salesforce API errors*\n|Salesforce API error rate > 5% over 5-minute window\n|P1 - Critical\n\n|*Salesforce API rate limits*\n|Salesforce API rate limit utilization > 90%\n|P2 - High\n\n|*Contact reconciliation failures*\n|ProfileService Contact reconciliation failure rate > 5% over 5-minute window\n|P2 - High\n\n|*Braze notification failures*\n|Braze push notification delivery rate < 80% over 15-minute window\n|P3 - Medium\n\n|*Salesforce webhook failures*\n|Salesforce webhook delivery success rate < 90% over 15-minute window\n|P2 - High\n\n|*Case creation latency*\n|Case creation latency p95 > 10 minutes\n|P3 - Medium\n\n|===\n\n=== Dashboards\n\n*ProfileService Dashboard:*\n\n* Contact reconciliation success rate (JIT lookups)\n* Contact reconciliation latency (p50, p95, p99)\n* Contact creation vs update ratio (new Contacts created vs existing Contacts updated)\n* Salesforce API error rate (Contact queries and creates)\n* Request rate and throughput\n\n*EngagementService Dashboard:*\n\n* Feedback submission success rate\n* Case creation success rate (async workflow)\n* Case creation latency (p50, p95, p99)\n* Event Bus queue depth (pending Case creations)\n* Dead letter queue depth (failed Case creations)\n* Salesforce API error rate (Case creation)\n* Salesforce API latency\n* Salesforce API rate limit utilization\n* Braze push notification delivery rate\n* Salesforce webhook delivery success rate\n\n*Event Bus Dashboard:*\n\n* Queue depth (pending messages)\n* Throughput (messages published/consumed per minute)\n* Dead letter queue depth (failed messages)\n* Consumer lag (time between publish and consume)\n\n*Customer Support Dashboard (Business Metrics):*\n\n* Total feedback submissions per day/week/month\n* Feedback category breakdown (App, Service, Order, Rewards, Refund, Delete Account)\n* Customer satisfaction score (CSAT) trend\n* Average case resolution time trend\n* Case volume by support team/queue\n* Unified customer view adoption (support agent feedback)\n<<<\n== Solution Validation\n\nThis section defines the validation criteria and testing approach for the solution.\n\n=== Functional Validation\n\n==== ProfileService API Testing\n\n*Test Scenarios*:\n1. **Happy Path**: Authenticated user requests Contact ID, existing Contact found in Salesforce, Contact ID returned\n2. **JIT Creation**: Authenticated user requests Contact ID, no existing Contact, new Contact created in Salesforce, Contact ID returned\n3. **Salesforce API Failure**: Salesforce unavailable, ProfileService returns 500 error, user retries\n4. **Invalid JWT**: Unauthenticated request, ProfileService returns 401 error\n\n*Acceptance Criteria*:\n- Contact reconciliation success rate > 99.5%\n- JIT Contact creation completes within 500ms (p95)\n\n==== EngagementService API Testing\n\n*Test Scenarios*:\n1. **Happy Path**: Valid feedback submission, immediate 202 Accepted response, Case created in Salesforce within 5 minutes, Braze notification delivered\n2. **Invalid Category**: Invalid feedback category, 400 Bad Request response with validation error\n3. **Salesforce Downtime**: Salesforce unavailable during async Case creation, message queued, retry logic executes, Case created when Salesforce recovers\n4. **Dead Letter Queue**: Case creation fails after 5 retries, message moved to DLQ, ops team alerted\n5. **Webhook Notification**: Support agent resolves Case in Salesforce, webhook triggers EngagementService, Braze push notification sent to customer\n\n*Acceptance Criteria*:\n- Feedback submission success rate > 99.5% (including async Case creation)\n- Async Case creation completes within 5 minutes (p95)\n- Webhook delivery success rate > 99%\n\n=== Non-Functional Validation\n\n==== Performance Testing\n\n*Load Testing*:\n\n*Baseline*: Expected 100-150 submissions/day from 20k DAU (~0.5-0.75% submission rate)\n\n- **Normal Load**: 1 submission/minute sustained for 2 hours (simulate typical daily pattern)\n- **3x Load**: 3 submissions/minute sustained for 1 hour (simulate busy period, 450 submissions/day)\n- **Peak Load (10x)**: 10 submissions/minute for 15 minutes (simulate incident scenario, app outage causing backlog)\n- **Stress Test**: 50 submissions/minute for 5 minutes (find breaking point, 20x normal)\n\n*Validation*:\n- API response time p95 < 1 second under 10x load\n- Event Bus queue depth remains manageable (< 100 messages)\n- No Case creation failures, all submissions processed successfully\n- Auto-scaling triggers appropriately for sustained load > 3x baseline\n\n*Acceptance Criteria*:\n- NFR-PERF-001 through NFR-PERF-006 validated under realistic load (3x and 10x baseline)\n- Auto-scaling triggers within 2 minutes of load increase\n- System handles 10x peak gracefully, 20x stress test identifies limits\n\n==== Resilience Testing\n\n*Salesforce API Failure Scenarios*:\n1. **Complete Outage**: Salesforce unavailable for 2 hours, Event Bus queues buffer work, Cases created when Salesforce recovers\n2. **Rate Limit Exceeded**: Salesforce rate limit hit, queue throttling activates, Cases created within SLA\n\n*Acceptance Criteria*:\n- NFR-AVAIL-004 validated (graceful degradation during Salesforce downtime)\n- Circuit breaker activates after 5 consecutive failures\n\n==== Security Validation\n\n*Penetration Testing*:\n- API authentication bypass attempts\n- SQL injection attempts\n- Webhook signature validation bypass\n\n*Acceptance Criteria*:\n- NFR-SEC-001 through NFR-SEC-010 validated\n- OWASP API Security Top 10 compliance verified\n\n=== Integration Validation\n\n==== End-to-End Testing\n\n*Full User Journey*:\n1. User authenticates via Microsoft Entra External ID\n2. Mobile App requests Contact ID from ProfileService (JIT reconciliation)\n3. User submits feedback via EngagementService\n4. Background worker creates Case in Salesforce\n5. Braze notification delivered to user\n6. Support agent resolves Case in Salesforce\n7. Salesforce webhook triggers EngagementService\n8. Braze notification delivered to user\n\n*Acceptance Criteria*:\n- End-to-end flow completes successfully in UAT\n- User receives both \"feedback submitted\" and \"case resolved\" notifications\n","structuredPatch":[{"oldStart":2220,"oldLines":9,"newStart":2220,"newLines":9,"lines":[" "," Must complete sequentially:"," ","-* WP-CS-008 (Contact Data Migration) - Requires WP-CS-001, WP-CS-004, WP-CS-006 UAT sign-off","-* WP-CS-009 (Production Deployment) - Requires all prior work packages completed","-* WP-CS-010 (Post-Cutover Support) - Requires WP-CS-009","+* <<wp-cs-008,WP-CS-008>> (Contact Data Migration) - Requires <<wp-cs-001,WP-CS-001>>, <<wp-cs-004,WP-CS-004>>, <<wp-cs-006,WP-CS-006>> UAT sign-off","+* <<wp-cs-009,WP-CS-009>> (Production Deployment) - Requires all prior work packages completed","+* <<wp-cs-010,WP-CS-010>> (Post-Cutover Support) - Requires <<wp-cs-009,WP-CS-009>>"," "," ==== Critical Path"," "]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"41fd2be5-eef1-4292-8aa4-b47711f9b321"}
{"parentUuid":"5440ee7f-0176-4d15-acc2-6888bb48f43b","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_016ywFyVmzvCjzF7FWqWrEc7","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Good! Now let me check the Critical Path section as well and update any remaining references.","signature":"EoUCCkYICxgCKkAHlXRRserugXjhhC5INb5KEwlOOhYa+TaF6G/yXW/X1N4u5z/iuuEpk7sX62b2PyReEQ/MIhFBvW1ygSnlcicuEgyW3F8Q63xsRaHRq6gaDK4bQjMBojY/j6DM1CIwQAkOXc/jSlugjRFXPCfsn+XWC8C1DSauRniQnhjdq74vTpzuvCetnfGOjARerDSeKm3ND20BrKEyXY6/+lkXLw0WFVfJ7v9w71iFSD35N8SUsT+K3wWJr4hGNA2x4TfZKLSJBvq6JAsvXllRrkPaI7wEnicpaXt1lWq6UAd1pfJtIVW6Yx0sPmLu0/meWiWHtn7TOmvnJYyQgNUSY1HvGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":3051,"cache_read_input_tokens":45413,"cache_creation":{"ephemeral_5m_input_tokens":3051,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWw5CJteM1gAyGpmx8XcD","type":"assistant","uuid":"571539d7-5a59-48af-a413-83b6243daebd","timestamp":"2026-01-09T03:12:25.543Z"}
{"parentUuid":"571539d7-5a59-48af-a413-83b6243daebd","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_016ywFyVmzvCjzF7FWqWrEc7","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_013SafGTrjgvJBQ5SwsY3CSa","name":"Read","input":{"file_path":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","offset":2227,"limit":20}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":3051,"cache_read_input_tokens":45413,"cache_creation":{"ephemeral_5m_input_tokens":3051,"ephemeral_1h_input_tokens":0},"output_tokens":143,"service_tier":"standard"}},"requestId":"req_011CWw5CJteM1gAyGpmx8XcD","type":"assistant","uuid":"61b749bd-8c49-497a-92e2-7b646626d371","timestamp":"2026-01-09T03:12:26.374Z"}
{"parentUuid":"61b749bd-8c49-497a-92e2-7b646626d371","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_013SafGTrjgvJBQ5SwsY3CSa","type":"tool_result","content":"  2227→==== Critical Path\n  2228→\n  2229→The critical path for this project is:\n  2230→\n  2231→. WP-CS-003 (Event Bus Infrastructure)\n  2232→. WP-CS-002 (EngagementService Development) - blocks on WP-CS-003\n  2233→. WP-CS-005 (Mobile App Integration) - blocks on WP-CS-001, WP-CS-002\n  2234→. WP-CS-006 (Integration Testing) - blocks on WP-CS-001 through WP-CS-005, WP-CS-007\n  2235→. WP-CS-008 (Contact Data Migration) - blocks on WP-CS-006 UAT sign-off\n  2236→. WP-CS-009 (Production Deployment) - blocks on WP-CS-008\n  2237→. WP-CS-010 (Post-Cutover Support) - final deliverable\n  2238→\n  2239→Any delays in critical path work packages will delay the overall cutover date.\n  2240→\n  2241→<<<\n  2242→== Transition Architecture\n  2243→\n  2244→This section defines the evolution from baseline (D365 CE) to target state (Salesforce Service Cloud + ProfileService + EngagementService).\n  2245→\n  2246→=== Transition Approach\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"abcb1795-8c92-4e5d-8e70-34f46475c71d","timestamp":"2026-01-09T03:12:26.510Z","toolUseResult":{"type":"text","file":{"filePath":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","content":"==== Critical Path\n\nThe critical path for this project is:\n\n. WP-CS-003 (Event Bus Infrastructure)\n. WP-CS-002 (EngagementService Development) - blocks on WP-CS-003\n. WP-CS-005 (Mobile App Integration) - blocks on WP-CS-001, WP-CS-002\n. WP-CS-006 (Integration Testing) - blocks on WP-CS-001 through WP-CS-005, WP-CS-007\n. WP-CS-008 (Contact Data Migration) - blocks on WP-CS-006 UAT sign-off\n. WP-CS-009 (Production Deployment) - blocks on WP-CS-008\n. WP-CS-010 (Post-Cutover Support) - final deliverable\n\nAny delays in critical path work packages will delay the overall cutover date.\n\n<<<\n== Transition Architecture\n\nThis section defines the evolution from baseline (D365 CE) to target state (Salesforce Service Cloud + ProfileService + EngagementService).\n\n=== Transition Approach","numLines":20,"startLine":2227,"totalLines":3329}},"sourceToolAssistantUUID":"61b749bd-8c49-497a-92e2-7b646626d371"}
{"parentUuid":"abcb1795-8c92-4e5d-8e70-34f46475c71d","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_018XdGeDVDSWPDXAYDM1uKQK","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Perfect! Now let me update the Critical Path section as well.","signature":"EuUBCkYICxgCKkDQH41a4eQtAtiAJxMXJbwLq5QoNYEaE5VrAZmqEg1azhGR6zcZjA60RP/rPslSEiw0LN58el696RS1yzU4oSusEgyx5oMH5mz1v+uhM4EaDDYRH7Q4IeWe07UUMiIwKX/F2Ds+XnkpNvlUWI4N3sjlCLqbNh1Qgacr4v3ejf6CJYW11dSRWqMHAWACcvQYKk01jJ5VE6My5xxT5SLCiRVaDO+jiHbtlehjVsXS6E7gz4WTj317enZicZT6Is3WNhlQVDB4L/5JjrMvkrjHl31GVrIDc6Vry6HE4ixtlhgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":585,"cache_read_input_tokens":48464,"cache_creation":{"ephemeral_5m_input_tokens":585,"ephemeral_1h_input_tokens":0},"output_tokens":8,"service_tier":"standard"}},"requestId":"req_011CWw5Cdmx6dqf5S5a1WX8B","type":"assistant","uuid":"3aa1e686-3a62-41bf-858f-7676f806abc2","timestamp":"2026-01-09T03:12:29.747Z"}
{"parentUuid":"3aa1e686-3a62-41bf-858f-7676f806abc2","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_018XdGeDVDSWPDXAYDM1uKQK","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_012LnoRbKv2DvTEqjwMDZkXx","name":"Edit","input":{"replace_all":false,"file_path":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","old_string":"==== Critical Path\n\nThe critical path for this project is:\n\n. WP-CS-003 (Event Bus Infrastructure)\n. WP-CS-002 (EngagementService Development) - blocks on WP-CS-003\n. WP-CS-005 (Mobile App Integration) - blocks on WP-CS-001, WP-CS-002\n. WP-CS-006 (Integration Testing) - blocks on WP-CS-001 through WP-CS-005, WP-CS-007\n. WP-CS-008 (Contact Data Migration) - blocks on WP-CS-006 UAT sign-off\n. WP-CS-009 (Production Deployment) - blocks on WP-CS-008\n. WP-CS-010 (Post-Cutover Support) - final deliverable","new_string":"==== Critical Path\n\nThe critical path for this project is:\n\n. <<wp-cs-003,WP-CS-003>> (Event Bus Infrastructure)\n. <<wp-cs-002,WP-CS-002>> (EngagementService Development) - blocks on <<wp-cs-003,WP-CS-003>>\n. <<wp-cs-005,WP-CS-005>> (Mobile App Integration) - blocks on <<wp-cs-001,WP-CS-001>>, <<wp-cs-002,WP-CS-002>>\n. <<wp-cs-006,WP-CS-006>> (Integration Testing) - blocks on <<wp-cs-001,WP-CS-001>> through <<wp-cs-005,WP-CS-005>>, <<wp-cs-007,WP-CS-007>>\n. <<wp-cs-008,WP-CS-008>> (Contact Data Migration) - blocks on <<wp-cs-006,WP-CS-006>> UAT sign-off\n. <<wp-cs-009,WP-CS-009>> (Production Deployment) - blocks on <<wp-cs-008,WP-CS-008>>\n. <<wp-cs-010,WP-CS-010>> (Post-Cutover Support) - final deliverable"}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":585,"cache_read_input_tokens":48464,"cache_creation":{"ephemeral_5m_input_tokens":585,"ephemeral_1h_input_tokens":0},"output_tokens":655,"service_tier":"standard"}},"requestId":"req_011CWw5Cdmx6dqf5S5a1WX8B","type":"assistant","uuid":"83612c8e-1205-4e65-b774-1bfbef099025","timestamp":"2026-01-09T03:12:34.538Z"}
{"parentUuid":"83612c8e-1205-4e65-b774-1bfbef099025","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_012LnoRbKv2DvTEqjwMDZkXx","type":"tool_result","content":"The file /mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n  2223→* <<wp-cs-008,WP-CS-008>> (Contact Data Migration) - Requires <<wp-cs-001,WP-CS-001>>, <<wp-cs-004,WP-CS-004>>, <<wp-cs-006,WP-CS-006>> UAT sign-off\n  2224→* <<wp-cs-009,WP-CS-009>> (Production Deployment) - Requires all prior work packages completed\n  2225→* <<wp-cs-010,WP-CS-010>> (Post-Cutover Support) - Requires <<wp-cs-009,WP-CS-009>>\n  2226→\n  2227→==== Critical Path\n  2228→\n  2229→The critical path for this project is:\n  2230→\n  2231→. <<wp-cs-003,WP-CS-003>> (Event Bus Infrastructure)\n  2232→. <<wp-cs-002,WP-CS-002>> (EngagementService Development) - blocks on <<wp-cs-003,WP-CS-003>>\n  2233→. <<wp-cs-005,WP-CS-005>> (Mobile App Integration) - blocks on <<wp-cs-001,WP-CS-001>>, <<wp-cs-002,WP-CS-002>>\n  2234→. <<wp-cs-006,WP-CS-006>> (Integration Testing) - blocks on <<wp-cs-001,WP-CS-001>> through <<wp-cs-005,WP-CS-005>>, <<wp-cs-007,WP-CS-007>>\n  2235→. <<wp-cs-008,WP-CS-008>> (Contact Data Migration) - blocks on <<wp-cs-006,WP-CS-006>> UAT sign-off\n  2236→. <<wp-cs-009,WP-CS-009>> (Production Deployment) - blocks on <<wp-cs-008,WP-CS-008>>\n  2237→. <<wp-cs-010,WP-CS-010>> (Post-Cutover Support) - final deliverable\n  2238→\n  2239→Any delays in critical path work packages will delay the overall cutover date.\n  2240→\n  2241→<<<"}]},"uuid":"791ddbdc-2945-4205-b516-c1af6e082b77","timestamp":"2026-01-09T03:12:34.698Z","toolUseResult":{"filePath":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","oldString":"==== Critical Path\n\nThe critical path for this project is:\n\n. WP-CS-003 (Event Bus Infrastructure)\n. WP-CS-002 (EngagementService Development) - blocks on WP-CS-003\n. WP-CS-005 (Mobile App Integration) - blocks on WP-CS-001, WP-CS-002\n. WP-CS-006 (Integration Testing) - blocks on WP-CS-001 through WP-CS-005, WP-CS-007\n. WP-CS-008 (Contact Data Migration) - blocks on WP-CS-006 UAT sign-off\n. WP-CS-009 (Production Deployment) - blocks on WP-CS-008\n. WP-CS-010 (Post-Cutover Support) - final deliverable","newString":"==== Critical Path\n\nThe critical path for this project is:\n\n. <<wp-cs-003,WP-CS-003>> (Event Bus Infrastructure)\n. <<wp-cs-002,WP-CS-002>> (EngagementService Development) - blocks on <<wp-cs-003,WP-CS-003>>\n. <<wp-cs-005,WP-CS-005>> (Mobile App Integration) - blocks on <<wp-cs-001,WP-CS-001>>, <<wp-cs-002,WP-CS-002>>\n. <<wp-cs-006,WP-CS-006>> (Integration Testing) - blocks on <<wp-cs-001,WP-CS-001>> through <<wp-cs-005,WP-CS-005>>, <<wp-cs-007,WP-CS-007>>\n. <<wp-cs-008,WP-CS-008>> (Contact Data Migration) - blocks on <<wp-cs-006,WP-CS-006>> UAT sign-off\n. <<wp-cs-009,WP-CS-009>> (Production Deployment) - blocks on <<wp-cs-008,WP-CS-008>>\n. <<wp-cs-010,WP-CS-010>> (Post-Cutover Support) - final deliverable","originalFile":"= Salesforce Customer Support - Solution Architecture\n:project-name: Salesforce Customer Support\n:togaf-adm-phase: Phase E: Opportunities & Solutions\n:last-updated: 2026-01-07\n:document-type: Solution Architecture Document\n:status: Discovery\n:version: 0.1\n:domain: Customer Support & Engagement\n:programme-lead:\n:domain-architect: O.Young@otr.com.au\n:architecture-definition: xref:architecture-definitions:salesforce_customer_support.adoc[Architecture Definitions/Salesforce Customer Support]\n:doctype: article\n:toc: left\n:toclevels: 4\n:sectanchors:\n:sectlinks:\n:sectnums:\n:icons: font\n:source-highlighter: highlightjs\n:experimental:\n:description:\n:keywords:\n\n<<<\n== Purpose and Scope\n\n=== Purpose\n\nThis Solution Architecture defines how the Salesforce Customer Support consolidation will be implemented - the specific technology products, configurations, interfaces, and deployment architecture that realise the xref:architecture-definitions:salesforce_customer_support.adoc[Salesforce Customer Support Architecture Definition].\n\nThis solution establishes the **first implementation of OTR's target Domain-Driven Design (DDD) architecture** by deploying two new bounded contexts (`ProfileService` and `EngagementService`) as microservices, consolidating customer support onto Salesforce Service Cloud, and implementing event-driven integration patterns that will serve as the foundation for future bounded contexts (including Flybuys integration).\n\n=== Vision\n\n> Unify customer support across all OTRG channels by consolidating OTR digital customer feedback onto Salesforce Service Cloud, establishing the foundational DDD architecture with ProfileService and EngagementService bounded contexts that protect digital channels from external system changes while enabling support agents to deliver exceptional customer experiences with complete interaction history.\n\n=== Architectural Approach\n\nThis architecture establishes OTR's **first bounded context implementation** using Domain-Driven Design strategic patterns:\n\n* *link:../bounded_context/profile.adoc[ProfileService]* (NEW bounded context): Just-In-Time Contact reconciliation with Salesforce, upsert by email, returns Salesforce Contact ID to digital channels - foundation for future Flybuys partner linking\n* *link:../bounded_context/engagement.adoc[EngagementService]* (NEW bounded context): Customer feedback submission facade, Anti-Corruption Layer for Salesforce Case creation, Braze integration for all outbound customer communications (push, email, SMS), async Case processing via Event Bus\n* *Event-driven integration* (NEW pattern): Domain event publishing using existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis) - first implementation establishing pattern for future bounded contexts\n* *Anti-Corruption Layer*: EngagementService isolates digital channels from Salesforce API changes, translates between OTR domain language and Salesforce Service Cloud API\n* *Conformist Pattern*: ProfileService and EngagementService conform to existing Salesforce configuration (shared Viva Energy instance, multi-tenant governance)\n* *Big bang cutover*: Single deployment after Contact migration, no phased rollout, D365 CE retirement post-cutover\n\n=== Scope\n\n==== In Scope\n\n* Solution Building Blocks (SBBs) - specific technology products and versions\n* Interface specifications (APIs, events, data formats)\n* Data architecture and schema specifications\n* Deployment architecture and infrastructure configuration\n* Transition architecture with migration phases\n* Technical validation criteria and testing approach\n* External system integration specifications\n* Physical data models and API schemas\n\n==== Out of Scope\n\n===== Covered in xref:architecture-definitions:salesforce_customer_support.adoc[Architecture Definition]\n\n* Business requirements and stakeholder analysis\n* Architecture decisions and rationale (ADRs)\n* Bounded context definitions and responsibilities\n* High-level integration patterns (ACL, Conformist, OHS+PL)\n* Business capability mapping and value streams\n* Architecture principles and governance\n\n===== Covered in Other Documents\n\n* Detailed design (class diagrams, sequence diagrams for all flows)\n* Implementation code and unit tests\n* Business case and return-on-investment analysis\n* Operational run books and support procedures\n\n<<<\n=== Architecture Overview\n\n[mermaid]\n----\n---\nconfig:\n  layout: elk\n---\nflowchart TB\n    Customer([\"Customer\"]) -- Uses --> MobileApp[\"Mobile App<br>iOS/Android\"]\n    Customer -- Shops at --> POS[\"OTR/OTR+ POS<br>D365 Commerce\"]\n    MobileApp -- Authenticate --> EntraID[\"Microsoft Entra\"]\n    MobileApp -- Identifies & Reconciles --> ProfileService[\"ProfileService\"]\n    ProfileService <-- Reconcile App User as Salesforce Contact --> Salesforce[\"Salesforce\"]\n    ProfileService -- On Create --> EventBus[\"EventBus\"]\n    EventBus -- Emits CreateUser Event --> LoyaltyService[\"LoyaltyService\"] & EngagementService[\"EngagementService\"]\n    LoyaltyService -- Reconcile Wallet --> EagleEye[\"EagleEye\"]\n    EngagementService -- Reconcile Braze Profile --> Braze[\"Braze\"]\n    EngagementService --> Salesforce\n    D365CE[\"D365CE\"] -- Data Migration --> Salesforce\n    MobileApp -- Submits Feedback --> EngagementService\n\n    Customer:::customer\n    MobileApp:::presentation\n    POS:::presentation\n    EntraID:::external\n    ProfileService:::newService\n    Salesforce:::external\n    EventBus:::infrastructure\n    LoyaltyService:::newService\n    EngagementService:::newService\n    EagleEye:::external\n    Braze:::external\n    D365CE:::external\n    classDef newService fill:#4CAF50,stroke:#2E7D32,stroke-width:3px,color:#fff\n    classDef external fill:#FF9800,stroke:#E65100,stroke-width:2px,color:#fff\n    classDef infrastructure fill:#2196F3,stroke:#0D47A1,stroke-width:2px,color:#fff\n    classDef presentation fill:#9C27B0,stroke:#4A148C,stroke-width:2px,color:#fff\n    classDef customer fill:#607D8B,stroke:#263238,stroke-width:2px,color:#fff\n----\n\n\n==== Key Architectural Patterns\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Pattern |Application |Rationale\n\n|*Anti-Corruption Layer (ACL)*\n|EngagementService → Salesforce Service Cloud\n|Protects digital channels (Mobile App, Web) from Salesforce API changes, translates between OTR domain language and Salesforce Case/Contact model, enables independent evolution of internal domain model\n\n|*Conformist*\n|ProfileService → Salesforce, EngagementService → Salesforce\n|Shared Viva Energy Salesforce instance - we conform to existing configuration, governance, and API contracts (external system we don't control)\n\n|*Backend-for-Frontend (BFF)*\n|EngagementService\n|Aggregates customer feedback submission, Contact lookup, async Case creation, and Braze notification orchestration for digital channel clients\n\n|*Event-Driven Architecture (OHS+PL)*\n|Event Bus (SNS+SQS/EventBridge/Kinesis)\n|Loose coupling between bounded contexts, async domain event publishing (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`), foundation for future bounded contexts\n\n|*Just-In-Time (JIT) Integration*\n|ProfileService → Salesforce Contact reconciliation\n|Reconcile app users as Salesforce Contacts on-demand (upsert by email), no pre-sync required, ensures Salesforce has current Contact data\n\n|*Async Processing*\n|EngagementService Case creation via Event Bus\n|Non-blocking user experience, resilience to Salesforce downtime, automatic retry with exponential backoff, dead letter queue for operations team intervention\n\n|*Strangler Fig*\n|Not applicable\n|Big bang cutover (no gradual migration) - D365 CE fully replaced, not incrementally strangled\n\n|===\n\n<<<\n== Solution Approach\n\n* Deploy xref:bounded-contexts:profile.adoc[ProfileService] and xref:bounded-contexts:engagement.adoc[EngagementService] as bounded context microservices\n* Implement Anti-Corruption Layers (ACLs) for Salesforce and Braze integration\n* Establish event-driven architecture as the foundational integration pattern\n* Big bang cutover (TS-1 → TS-4)\n\n=== Related Documentation\n\nThis solution architecture references detailed technical specifications:\n\n==== Architecture Definition\n\n* xref:architecture-definitions:salesforce_customer_support.adoc[Salesforce Customer Support - Architecture Definition] - Business requirements, architecture decisions (ADRs), bounded context definitions, high-level integration patterns\n\n==== Bounded Context Specifications\n\n* xref:bounded-contexts:profile.adoc[ProfileService Bounded Context] - JIT Contact reconciliation, aggregate definitions\n* xref:bounded-contexts:engagement.adoc[EngagementService Bounded Context] - Customer feedback facade, Anti-Corruption Layer\n\n==== Interface Specifications\n\nDetailed API specifications available in the specifications directory:\n\n* link:../../specifications/rest/profile-service-v1.yaml[ProfileService REST API v1] - OpenAPI 3.0 specification for `/profile/v1` endpoints (includes Salesforce Contact reconciliation `GET /contact-id`)\n* link:../../specifications/rest/engagement-service-v1.yaml[EngagementService REST API v1] - OpenAPI 3.0 specification for `/engagement/v1` endpoints (includes `POST /feedback`)\n* link:../../specifications/events/engagement-events.json[Engagement Domain Events] - CloudEvents 1.0 JSON Schema for `SupportCaseCreated`, `SupportCaseUpdated`, `SupportCaseResolved`, `CustomerFeedbackSubmitted`\n\n==== External System Documentation\n\n* https://developer.salesforce.com/docs/atlas.en-us.api_rest.meta/api_rest/[Salesforce REST API Documentation] - Contact and Case object APIs\n* https://www.braze.com/docs/api/endpoints/messaging/send_messages/post_send_triggered_campaigns/[Braze Campaign Trigger API] - Push notification campaigns\n\n<<<\n== Executive Summary\n\n=== Challenge\n\nOTR digital customers (Mobile App, Web) currently submit feedback and support requests to D365 Customer Engagement, while Viva Energy's broader business units (fuel wholesale, Shell Card customers, other retail channels) use Salesforce Service Cloud. This creates:\n\n* *Fragmented customer support platform*: Customer support data split across two systems, preventing support agents from having a unified view of customer interactions across all channels\n* *Operational inefficiency*: Maintaining two separate customer support platforms increases operational overhead and costs\n* *Poor support experience*: D365 CE is not working well for digital customer support, impacting customer satisfaction and case resolution times\n* *Post-merger consolidation opportunity*: Following Viva Energy's acquisition of OTR, strategic alignment on Salesforce as the enterprise customer support platform\n\n=== Solution\n\nThis architecture establishes the **foundational Domain-Driven Design (DDD) implementation** for OTR's target state architecture by introducing two new bounded contexts (link:../bounded_context/profile.adoc[ProfileService], link:../bounded_context/engagement.adoc[EngagementService]) and event-driven integration patterns:\n\n==== New Bounded Contexts\n\n* *link:../bounded_context/profile.adoc[ProfileService]* (NEW): Just-In-Time (JIT) Contact reconciliation with Salesforce, upsert by email, returns Salesforce Contact ID to Mobile App\n* *link:../bounded_context/engagement.adoc[EngagementService]* (NEW): Customer feedback submission, Anti-Corruption Layer (ACL) for Salesforce Case creation, Braze integration for all outbound customer communications (push, email, SMS), async Case processing via Event Bus\n* *Event Bus* (NEW pattern): Domain event publishing using existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis) - first implementation of event-driven architecture pattern\n\n==== Integration Architecture\n\n* *Salesforce = System of Record*: Salesforce Service Cloud (shared Viva Energy instance) owns Contact and Case data\n* *Conformist Pattern*: ProfileService and EngagementService conform to existing Salesforce configuration and API contracts\n* *Anti-Corruption Layer*: EngagementService protects digital channels from Salesforce API changes, translates between OTR domain language and Salesforce\n* *Async Case Creation*: Non-blocking user experience, resilience to Salesforce downtime, automatic retry with exponential backoff, dead letter queue for failed Cases\n* *Event-Driven Notifications*: Salesforce webhook → EngagementService → Braze for all customer communications (push, email, SMS) on Case status updates\n\n==== Migration Approach\n\n* *Contact Migration*: One-time migration from app-specific database → Salesforce (upsert with flexible matching by email/phone/VCI)\n* *No Case Migration*: Historical D365 CE Cases not migrated (fresh start in Salesforce)\n* *Big Bang Cutover*: Single deployment, no phased rollout or parallel run\n* *D365 CE Retirement*: Complete decommissioning of D365 Customer Engagement post-cutover\n\n=== Key Architectural Significance\n\nThis migration establishes the first implementation of OTR's target DDD architecture:\n\n* First bounded contexts implemented (ProfileService, EngagementService)\n* First event-driven domain event pattern (foundation for future bounded contexts)\n* Foundation for Flybuys integration (ProfileService Contact reconciliation reused)\n* Establishes integration patterns (Conformist, ACL, Event-Driven) for future services\n\n=== Success Criteria\n\n* All digital customer feedback routed to Salesforce Service Cloud within 30 days of launch\n* Support agents have unified customer view across all Viva Energy channels (digital, wholesale, Shell Card, other retail)\n* D365 Customer Engagement decommissioned within 90 days post-cutover\n* Customer satisfaction score improves by 15% within 6 months\n* Average case resolution time decreases by 20% within 6 months\n* Zero data loss during Contact migration (100% validation pass rate)\n* Mobile App feedback submission success rate > 99.5% (including async Case creation)\n\n=== Technical Constraints\n\n* Shared Salesforce instance (Viva Energy multi-tenant environment)\n* Conform to existing Salesforce configuration and governance (data isolation strategy TBD with Salesforce admin team)\n* Contact migration must complete before cutover (no parallel run)\n* Async Case creation mandatory (non-blocking user experience)\n* Expected volume: 100-150 feedback submissions/day from 20k DAU (~0.5-0.75% submission rate), architecture capacity planned for 3x-10x growth\n\n=== Open Technical Decisions (TBD)\n\n* Salesforce Case field mapping for digital feedback categories (App, Service, Order, Rewards, Refund, Delete Account)\n* Salesforce data isolation strategy (Record Types, custom fields, queues)\n* Salesforce REST API authentication method (OAuth 2.0, Connected App, JWT bearer flow)\n* Salesforce webhook mechanism for Case updates (Outbound Messages, Platform Events, Process Builder)\n* Retry policy configuration (attempts, backoff intervals)\n* Salesforce API rate limit strategy (expected volume: 100-150 submissions/day from 20k DAU, capacity planning for 3x-10x growth)\n\n== Technical Requirements\n\n[width=\"100%\",cols=\"8%,92%\",options=\"header\",]\n|===\n|ID |Description\n\n|TR-CS-001\n|Every Mobile App user must have a Salesforce Contact record in Salesforce Service Cloud (shared Viva Energy instance)\n\n|TR-CS-002\n|ProfileService must reconcile Mobile App users as Salesforce Contacts using Just-In-Time (JIT) upsert by email address\n\n|TR-CS-003\n|ProfileService must return Salesforce Contact ID to Mobile App for feedback submission\n\n|TR-CS-004\n|Mobile App must support customer feedback submission with fields: Category (App, Service, Order, Rewards, Refund, Delete Account), Store Name, Time of Visit, Contact Phone Number, Free Text Message\n\n|TR-CS-005\n|EngagementService must create Salesforce Cases asynchronously via Event Bus (non-blocking user experience)\n\n|TR-CS-006\n|EngagementService must acknowledge feedback submission immediately to Mobile App user (\"Feedback submitted\" confirmation)\n\n|TR-CS-007\n|EngagementService must send push notification to customer via Braze when Case is successfully created in Salesforce\n\n|TR-CS-008\n|EngagementService must retry failed Case creation with configurable exponential backoff and dead letter queue for operations team intervention\n\n|TR-CS-009\n|Salesforce must be the System of Record for Contact and Case data (no local persistence in ProfileService or EngagementService)\n\n|TR-CS-010\n|Contact migration from app-specific database to Salesforce must complete before Mobile App cutover (upsert with flexible matching by email/phone/VCI)\n\n|TR-CS-011\n|No Case migration from D365 Customer Engagement to Salesforce (fresh start, historical Cases not migrated)\n\n|TR-CS-012\n|EngagementService must publish domain events (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`) to Event Bus for consumption by other bounded contexts\n\n|TR-CS-013\n|EngagementService must receive Salesforce webhook notifications when Cases are updated/resolved by support agents\n\n|TR-CS-014\n|EngagementService must trigger Braze push notifications to customers when Cases are updated/resolved (via Salesforce webhook → EngagementService → Braze)\n\n|TR-CS-015\n|ProfileService and EngagementService must conform to existing Salesforce configuration and API contracts (Conformist pattern)\n\n|TR-CS-016\n|All changes must be communicated using event-driven architecture via Event Bus (using existing AWS infrastructure: SNS+SQS/EventBridge/Kinesis)\n\n|TR-CS-017\n|Mobile App feedback submission success rate must exceed 99.5% (including async Case creation completion)\n\n|TR-CS-018\n|Contact migration must achieve 100% validation pass rate (zero data loss)\n\n|TR-CS-019\n|D365 Customer Engagement must be fully decommissioned within 90 days post-cutover\n\n|===\n\n== Technical Architecture\n\n=== Technical Capability Requirements\n\n==== Requirements Traceability\n\n[width=\"100%\",cols=\"15%,50%,35%\",options=\"header\",]\n|===\n|Requirement ID |Requirement Summary |Architectural Building Blocks\n\n|TR-CS-001\n|Every Mobile App user must have Salesforce Contact record\n|ABB-CS-001 (ProfileService), ABB-CS-004 (Salesforce), ABB-CS-007 (Contact Migration Tool)\n\n|TR-CS-002\n|ProfileService JIT Contact reconciliation via upsert by email\n|ABB-CS-001 (ProfileService), ABB-CS-004 (Salesforce)\n\n|TR-CS-003\n|ProfileService returns Salesforce Contact ID to Mobile App\n|ABB-CS-001 (ProfileService), ABB-CS-006 (Mobile App)\n\n|TR-CS-004\n|Mobile App supports feedback submission with structured fields\n|ABB-CS-006 (Mobile App), ABB-CS-002 (EngagementService)\n\n|TR-CS-005\n|EngagementService creates Salesforce Cases asynchronously\n|ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus), ABB-CS-004 (Salesforce)\n\n|TR-CS-006\n|EngagementService immediate acknowledgment to Mobile App\n|ABB-CS-002 (EngagementService), ABB-CS-006 (Mobile App)\n\n|TR-CS-007\n|EngagementService sends push notification via Braze on Case creation\n|ABB-CS-002 (EngagementService), ABB-CS-005 (Braze)\n\n|TR-CS-008\n|EngagementService retry logic with exponential backoff and DLQ\n|ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus)\n\n|TR-CS-009\n|Salesforce is System of Record for Contact and Case data\n|ABB-CS-004 (Salesforce), ABB-CS-001 (ProfileService - stateless), ABB-CS-002 (EngagementService - stateless)\n\n|TR-CS-010\n|Contact migration before Mobile App cutover\n|ABB-CS-007 (Contact Migration Tool), ABB-CS-004 (Salesforce)\n\n|TR-CS-011\n|No Case migration from D365 CE (fresh start)\n|ABB-CS-004 (Salesforce) - no migration tooling required\n\n|TR-CS-012\n|EngagementService publishes domain events to Event Bus\n|ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus)\n\n|TR-CS-013\n|EngagementService receives Salesforce webhook notifications\n|ABB-CS-002 (EngagementService), ABB-CS-004 (Salesforce)\n\n|TR-CS-014\n|EngagementService triggers Braze notifications on Case updates\n|ABB-CS-002 (EngagementService), ABB-CS-004 (Salesforce), ABB-CS-005 (Braze)\n\n|TR-CS-015\n|ProfileService and EngagementService conform to Salesforce config\n|ABB-CS-001 (ProfileService), ABB-CS-002 (EngagementService), ABB-CS-004 (Salesforce)\n\n|TR-CS-016\n|Event-driven architecture via Event Bus\n|ABB-CS-003 (Event Bus), ABB-CS-002 (EngagementService)\n\n|TR-CS-017\n|Mobile App feedback submission success rate > 99.5%\n|ABB-CS-006 (Mobile App), ABB-CS-002 (EngagementService), ABB-CS-003 (Event Bus), ABB-CS-004 (Salesforce)\n\n|TR-CS-018\n|Contact migration 100% validation pass rate\n|ABB-CS-007 (Contact Migration Tool), ABB-CS-004 (Salesforce)\n\n|TR-CS-019\n|D365 CE decommissioned within 90 days post-cutover\n|All ABBs (replacement system operational)\n\n|===\n\n=== Service Catalogues\n\n==== Application Portfolio Catalogue\n\n[width=\"100%\",cols=\"20%,15%,15%,15%,35%\",options=\"header\",]\n|===\n|Application |Lifecycle State |Owner |Hosting Platform |Description\n\n|*ProfileService*\n|NEW\n|OTR Platform Team\n|AWS (TBD: Lambda/ECS/EKS)\n|JIT Contact reconciliation with Salesforce, returns Salesforce Contact ID, foundation for Flybuys integration\n\n|*EngagementService*\n|NEW\n|OTR Platform Team\n|AWS (TBD: Lambda/ECS/EKS)\n|Customer feedback submission facade, ACL for Salesforce Case creation, Braze integration for all outbound communications (push, email, SMS), webhook receiver\n\n|*Mobile App (iOS)*\n|ACTIVE (UPDATE)\n|OTR Mobile Team\n|Apple App Store\n|iOS native app with feedback form, integrate with ProfileService and EngagementService APIs\n\n|*Mobile App (Android)*\n|ACTIVE (UPDATE)\n|OTR Mobile Team\n|Google Play Store\n|Android native app with feedback form, integrate with ProfileService and EngagementService APIs\n\n|*Salesforce Service Cloud*\n|ACTIVE (EXPAND)\n|Viva Energy Salesforce Admin Team\n|Salesforce (SaaS)\n|Shared Viva Energy instance, System of Record for Contact and Case data, adding OTR digital customer support\n\n|*Braze*\n|ACTIVE (EXTEND)\n|OTR Marketing Team\n|Braze (SaaS)\n|Marketing automation platform, EngagementService triggers push notifications for Case updates\n\n|*D365 Customer Engagement*\n|RETIRE\n|OTR Support Team\n|Microsoft Azure (SaaS)\n|Legacy customer support platform, decommissioned within 90 days post-cutover\n\n|*App-Specific Customer Database*\n|RETIRE\n|OTR Platform Team\n|AWS (RDS/DynamoDB)\n|Legacy customer contact storage, one-time migration to Salesforce, then deprecated\n\n|*Event Bus*\n|NEW\n|OTR Platform Team\n|AWS (SNS+SQS/EventBridge/Kinesis)\n|Domain event publishing infrastructure for bounded context integration\n\n|*Contact Migration Tool*\n|TEMPORARY\n|OTR Platform Team\n|AWS (Script/Lambda)\n|One-time migration app database → Salesforce with upsert logic, retired after migration complete\n\n|===\n\n==== Technology Capability Requirements\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Technology Capability |Implementation Technology (TBD in detailed design) |Requirements\n\n|*Microservice Hosting*\n|AWS Lambda / ECS / EKS\n|Host ProfileService and EngagementService with auto-scaling, high availability, monitoring\n\n|*API Gateway*\n|AWS API Gateway / Application Load Balancer\n|REST API routing, authentication, rate limiting, request validation for ProfileService and EngagementService\n\n|*Event Bus*\n|AWS SNS+SQS / EventBridge / Kinesis\n|Domain event publishing, async message processing, retry logic, dead letter queue\n\n|*Salesforce Integration*\n|Salesforce REST API / SOAP API\n|Contact CRUD operations, Case creation, webhook notifications, OAuth 2.0 authentication\n\n|*Braze Integration*\n|Braze REST API / SDK\n|Push notification campaign triggers, customer profile reconciliation\n\n|*Authentication & Authorisation*\n|Microsoft Entra External ID / AWS Cognito\n|Mobile App user authentication, API authorisation, JWT token validation\n\n|*Observability & Monitoring*\n|AWS CloudWatch / Datadog / New Relic\n|Application metrics, logs, traces, dashboards, alerting (feedback submission rate, queue depth, API errors)\n\n|*Secret Management*\n|AWS Secrets Manager / Parameter Store\n|Salesforce credentials, Braze API keys, OAuth tokens, encryption keys\n\n|*Database (Migration Tool)*\n|AWS RDS / DynamoDB (read-only access)\n|Contact migration from app-specific database\n\n|*CI/CD Pipeline*\n|GitHub Actions / AWS CodePipeline\n|Automated build, test, deployment for ProfileService, EngagementService, Mobile App\n\n|*Infrastructure as Code*\n|Terraform / AWS CloudFormation / CDK\n|Declarative infrastructure provisioning for Event Bus, microservices, monitoring\n\n|*API Documentation*\n|OpenAPI / Swagger\n|ProfileService and EngagementService API specifications for Mobile App integration\n\n|===\n\n==== Feature Flag Register\n\n*Note*: Per ADR-CS-006 (big bang cutover, not phased rollout), feature flags are minimal and used primarily for emergency rollback/kill switches.\n\n[width=\"100%\",cols=\"20%,15%,35%,30%\",options=\"header\",]\n|===\n|Feature Flag |Default State |Purpose |Rollback Scenario\n\n|*enable_salesforce_feedback_submission*\n|OFF (pre-cutover), ON (post-cutover)\n|Enable/disable feedback submission to EngagementService → Salesforce (kill switch for emergency rollback to D365 CE)\n|Feedback submission success rate < 95%, Salesforce API failures, critical bugs - revert to D365 CE integration\n\n|*enable_async_case_creation*\n|ON\n|Enable/disable async Case creation via Event Bus (fallback to synchronous processing if Event Bus issues)\n|Event Bus infrastructure failures, queue backlog unmanageable - temporary synchronous processing\n\n|*enable_braze_notifications*\n|ON\n|Enable/disable Braze push notifications for Case updates (degrade gracefully if Braze integration fails)\n|Braze API failures, notification delivery rate < 80% - disable notifications temporarily\n\n|*enable_jit_contact_reconciliation*\n|ON\n|Enable/disable ProfileService JIT Contact reconciliation (fallback to cached Contact IDs if Salesforce unavailable)\n|Salesforce API downtime, Contact reconciliation failures > 5% - use cached Contact IDs temporarily\n\n|*enable_salesforce_webhook_processing*\n|ON\n|Enable/disable Salesforce webhook processing for Case updates (fallback to polling if webhook failures)\n|Webhook delivery failures, authentication issues - temporary polling fallback\n\n|===\n\n*Feature Flag Management*:\n\n* Feature flags managed via AWS AppConfig / LaunchDarkly / custom feature flag service (TBD in detailed design)\n* Mobile App feature flags controlled server-side (no app release required for flag changes)\n* Backend service feature flags configured via environment variables / configuration service\n* Feature flag changes logged and audited (who changed, when, reason)\n* Post-cutover monitoring: Gradual removal of feature flags once system stability confirmed (30-60 days)\n\n==== Data Entity Catalogue\n\n[width=\"100%\",cols=\"20%,15%,35%,30%\",options=\"header\",]\n|===\n|Data Entity |System of Record |Key Attributes |Lifecycle\n\n|*Contact*\n|Salesforce Service Cloud\n|• Contact ID (Salesforce 15/18-char ID) +\n• Email (primary matching key) +\n• First Name, Last Name +\n• Phone Number +\n• Viva Consumer ID (VCI) +\n• Account (Viva Energy customer account) +\n• Record Type (OTR Digital vs other channels)\n|Created: ProfileService JIT reconciliation or Contact Migration Tool +\nUpdated: ProfileService JIT upsert (email changes), Salesforce (manual updates by support agents) +\nDeleted: Salesforce retention policy (GDPR/compliance)\n\n|*Case*\n|Salesforce Service Cloud\n|• Case Number (Salesforce auto-generated) +\n• Contact ID (reference to Contact) +\n• Subject (derived from Category) +\n• Description (Free Text Message) +\n• Category (App, Service, Order, Rewards, Refund, Delete Account) +\n• Store Name (OTR location) +\n• Time of Visit +\n• Status (New, In Progress, Resolved, Closed) +\n• Priority, Origin (Mobile App) +\n• Owner (support agent/queue)\n|Created: EngagementService async Case creation +\nUpdated: Support agents (Salesforce UI), EngagementService (webhook processing) +\nDeleted: Salesforce retention policy (archive after X years)\n\n|*Feedback Submission (transient)*\n|None (not persisted)\n|• Salesforce Contact ID +\n• Category +\n• Store Name +\n• Time of Visit +\n• Contact Phone Number +\n• Free Text Message\n|Created: Mobile App user submission +\nProcessed: EngagementService publishes to Event Bus, Case created in Salesforce +\nNot persisted in ProfileService/EngagementService (stateless)\n\n|*Domain Events*\n|Event Bus (ephemeral)\n|**SupportCaseCreated**: +\n• Case Number, Contact ID, Category, Timestamp +\n**SupportCaseUpdated**: +\n• Case Number, Status, Updated By, Timestamp +\n**SupportCaseResolved**: +\n• Case Number, Resolution, Resolved By, Timestamp +\n**CustomerFeedbackSubmitted**: +\n• Contact ID, Category, Timestamp\n|Published: EngagementService +\nConsumed: Other bounded contexts (future), Braze notification triggers +\nRetention: Short-lived (minutes to hours), not persisted for event sourcing\n\n|*Braze Customer Profile*\n|Braze\n|• External User ID (VCI or Email) +\n• Push Notification Tokens (iOS/Android) +\n• Notification Preferences +\n• Campaign Engagement History\n|Created/Updated: EngagementService on Case creation/update +\nManaged: Braze (external SaaS)\n\n|===\n\n*Data Migration Entities*:\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Source Entity |Target Entity |Migration Strategy\n\n|*App Database Contact*\n|Salesforce Contact\n|One-time migration via Contact Migration Tool: +\n• Upsert by email (primary), phone (secondary), VCI (tertiary) +\n• Map: Email → Email, Name → First/Last Name, Phone → Phone, VCI → External ID +\n• Validation: 100% data integrity check, reconciliation report\n\n|*D365 CE Case*\n|Not migrated\n|ADR-CS-005: No Case migration (fresh start in Salesforce) +\nD365 CE Cases archived separately for compliance if needed\n\n|===\n\n==== Data Quality & Validation\n\n*Contact Migration Validation Rules*:\n\n* Email format validation (RFC 5322 compliance)\n* Phone number format validation (E.164 international format)\n* VCI format validation (alphanumeric, length constraints)\n* Duplicate detection: Flag potential duplicates for manual review (same email/phone combination)\n* Mandatory fields: Email (required), First Name, Last Name (required for Salesforce Contact)\n\n*Case Creation Validation Rules*:\n\n* Contact ID must exist in Salesforce (validated by EngagementService before Case creation)\n* Category must be one of: App, Service, Order, Rewards, Refund, Delete Account\n* Free Text Message maximum length: 32,000 characters (Salesforce Case Description limit)\n* Store Name validated against OTR location master data (optional - warn if not found)\n\n<<<\n== Solution Building Blocks\n\nThis section defines the specific technology products, configurations, and implementation details for each Solution Building Block (SBB).\n\n=== Technology Portfolio Catalogue\n\n[width=\"100%\",cols=\"10%,20%,25%,25%,20%\",options=\"header\",]\n|===\n|SBB ID |Component |Technology Product |Version/Configuration |Deployment Platform\n\n|SBB-CS-001\n|ProfileService Microservice\n|.NET 8 / Node.js 20 LTS\n|RESTful API, containerised\n|AWS ECS Fargate / Lambda\n\n|SBB-CS-002\n|EngagementService Microservice\n|.NET 8 / Node.js 20 LTS\n|RESTful API, containerised, async workers\n|AWS ECS Fargate / Lambda\n\n|SBB-CS-003\n|Event Bus\n|AWS SNS + SQS / EventBridge\n|Standard queues, FIFO for ordering\n|AWS (managed service)\n\n|SBB-CS-004\n|API Gateway\n|AWS API Gateway / ALB\n|REST API, JWT validation\n|AWS (managed service)\n\n|SBB-CS-005\n|Salesforce Integration Layer\n|Salesforce REST API Client\n|OAuth 2.0 JWT bearer flow\n|Embedded in SBB-CS-001/002\n\n|SBB-CS-006\n|Braze Integration Layer\n|Braze REST API SDK\n|API key authentication\n|Embedded in SBB-CS-002\n\n|SBB-CS-007\n|Contact Migration Tool\n|Python 3.11 / .NET 8\n|One-time batch script\n|AWS Lambda / EC2\n\n|SBB-CS-008\n|Application Monitoring\n|AWS CloudWatch / Datadog\n|Metrics, logs, traces, dashboards\n|AWS / SaaS\n\n|SBB-CS-009\n|Secret Management\n|AWS Secrets Manager\n|KMS encryption\n|AWS (managed service)\n\n|SBB-CS-010\n|Mobile App (iOS)\n|SwiftUI, Kotlin Multiplatform\n|iOS 15+\n|Apple App Store\n\n|SBB-CS-011\n|Mobile App (Android)\n|Jetpack Compose, Kotlin Multiplatform\n|Android 8+\n|Google Play Store\n\n|SBB-CS-012\n|Feature Flag Service\n|AWS AppConfig / LaunchDarkly\n|Server-side flags, real-time updates\n|AWS / SaaS\n\n|===\n\n<<<\n== Data Architecture\n\nThis section defines the physical data models, event schemas, and API request/response formats.\n\n=== Domain Event Schemas\n\nAll domain events follow the https://cloudevents.io/[CloudEvents 1.0] specification for consistency and interoperability.\n\n*Event Schema Specifications*: See // TODO: Add to Antora - specifications/events/engagement-events.json[Engagement Service Event Schemas] for complete JSON schemas and examples.\n\n==== Event Catalogue\n\n[width=\"100%\",cols=\"30%,20%,50%\",options=\"header\",]\n|===\n|Event Type |Publisher |Description\n\n|`SupportCaseCreated`\n|EngagementService\n|Published when EngagementService successfully creates a Case in Salesforce after async processing\n\n|`SupportCaseUpdated`\n|EngagementService (via Salesforce webhook)\n|Published when a support agent updates a Case in Salesforce (status, priority, comment changes)\n\n|`SupportCaseResolved`\n|EngagementService (via Salesforce webhook)\n|Published when a support agent resolves/closes a Case in Salesforce\n\n|`CustomerFeedbackSubmitted`\n|EngagementService\n|Published when customer submits feedback via Mobile App (before async Case creation)\n\n|===\n\n*Event Format*: All events use CloudEvents 1.0 envelope with event-specific payload in the `data` field.\n\n*Schema Location*: `specifications/events/engagement-events.json`\n\n=== API Request/Response Schemas\n\n==== ProfileService: GET /profile/contact-id\n\n*Response* (200 OK):\n[source,json]\n----\n{\n  \"contactId\": \"0034X00000ABCDEFG\",\n  \"email\": \"customer@example.com\",\n  \"firstName\": \"John\",\n  \"lastName\": \"Smith\"\n}\n----\n\n==== EngagementService: POST /feedback\n\n*Request*:\n[source,json]\n----\n{\n  \"contactId\": \"0034X00000ABCDEFG\",\n  \"category\": \"App\",\n  \"storeName\": \"OTR Adelaide\",\n  \"timeOfVisit\": \"2026-01-07T12:00:00Z\",\n  \"contactPhoneNumber\": \"+61412345678\",\n  \"message\": \"App crashed when submitting feedback\"\n}\n----\n\n*Response* (202 Accepted):\n[source,json]\n----\n{\n  \"feedbackId\": \"fb-2026-01-07-12345\",\n  \"status\": \"submitted\",\n  \"message\": \"Your feedback has been submitted!\"\n}\n----\n\n=== Salesforce Field Mappings\n\n==== Case Object Mapping\n\n[width=\"100%\",cols=\"25%,25%,25%,25%\",options=\"header\",]\n|===\n|OTR Field |Salesforce Field |Data Type |Notes\n\n|Category\n|Feedback_Category__c\n|Picklist\n|App, Service, Order, Rewards, Refund, Delete Account\n\n|Store Name\n|Store_Name__c\n|String (255)\n|OTR location name\n\n|Time of Visit\n|Time_of_Visit__c\n|DateTime\n|When customer visited store\n\n|Free Text Message\n|Description\n|Long Text (32,000)\n|Customer feedback message\n\n|===\n\n<<<\n=== Baseline Architecture\n\n==== Existing System Components\n\n[width=\"100%\",cols=\"25%,35%,40%\",options=\"header\",]\n|===\n|Component |Current State |Status\n\n|*D365 Customer Engagement*\n|Customer support platform for OTR digital customers (Mobile App, Web), handles feedback submission and case management\n|**DEPRECATED** - Being replaced by Salesforce Service Cloud\n\n|*App-Specific Customer Database*\n|Stores customer contact data for Mobile App users, separate from Viva Energy systems\n|**MIGRATING** - One-time migration to Salesforce, then deprecated\n\n|*Mobile App*\n|iOS/Android native apps with feedback submission form including Category, Store Name, Time of Visit, Contact Phone Number, and Free Text Message fields\n|**REQUIRES UPDATE** - Integrate with ProfileService and EngagementService APIs (feedback form UI already complete)\n\n|*Salesforce Service Cloud*\n|Shared Viva Energy instance handling customer support for fuel wholesale, Shell Card customers, other retail channels\n|**EXPANDING** - Adding OTR digital customer support Cases and Contacts\n\n|*Existing AWS Infrastructure*\n|SNS+SQS / EventBridge / Kinesis available for event-driven architecture\n|**REUSING** - Event Bus implementation leverages existing infrastructure\n\n|===\n\n==== Integration Architecture\n\n*Current state:*\n\n* Mobile App → D365 Customer Engagement (direct integration)\n* App-specific customer database → standalone (no Salesforce integration)\n* No event-driven architecture (synchronous, tightly coupled)\n* No Anti-Corruption Layer protecting digital channels\n* Viva Energy support teams use Salesforce, OTR digital support uses D365 CE (fragmented)\n\n==== Technical Debt\n\n*No longer relevant* - D365 CE being deprecated, not documenting technical debt of system being retired.\n\n*New technical debt introduced by this migration:*\n\n* Salesforce field mapping TBD (requires coordination with Viva Energy Salesforce admin team)\n* Data isolation strategy TBD (Record Types, custom fields, queues - multi-tenant governance)\n* Salesforce webhook mechanism TBD (Outbound Messages vs Platform Events vs Process Builder)\n* Expected feedback volume unknown (gathering data for rate limit planning)\n\n=== Gap Analysis\n\n==== Missing Capabilities\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Missing Capability |Description\n\n|*ProfileService bounded context*\n|No existing service for Contact reconciliation with Salesforce - requires new microservice implementing JIT upsert by email, returning Salesforce Contact ID\n\n|*EngagementService bounded context*\n|No existing service for customer feedback facade - requires new microservice implementing Anti-Corruption Layer for Salesforce Case creation, Braze integration, async processing via Event Bus\n\n|*Event Bus domain event pattern*\n|No existing domain event publishing infrastructure - requires implementing event-driven architecture pattern using existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis)\n\n|*Async Case creation workflow*\n|Current D365 CE integration is synchronous - requires implementing async processing with retry logic, exponential backoff, dead letter queue\n\n|*Salesforce webhook integration*\n|No existing capability to receive Salesforce notifications - requires implementing webhook receiver in EngagementService for Case update notifications\n\n|*Braze push notification orchestration*\n|No existing integration for Case-related push notifications - requires implementing Braze campaign triggers from EngagementService\n\n|*Contact migration tooling*\n|No existing tooling for app database → Salesforce Contact migration with upsert logic (match by email/phone/VCI)\n\n|*Feedback form enhancements*\n|Mobile App feedback form lacks structured fields (Category, Store Name, Time of Visit, Contact Phone Number) - requires UI updates\n\n|===\n\n==== Missing Bounded Contexts\n\n[width=\"100%\",cols=\"30%,30%,40%\",options=\"header\",]\n|===\n|Bounded Context |Responsibilities |Implementation Status\n\n|*link:../bounded_context/profile.adoc[ProfileService]*\n|JIT Contact reconciliation with Salesforce (upsert by email), return Salesforce Contact ID to digital channels, foundation for future Flybuys partner linking\n|**NEW** - First bounded context implementation\n\n|*link:../bounded_context/engagement.adoc[EngagementService]*\n|Customer feedback submission facade, Anti-Corruption Layer for Salesforce Case creation, Braze integration for push notifications, async Case processing, webhook receiver for Case updates\n|**NEW** - First bounded context implementation\n\n|===\n\n==== Missing Integration Patterns\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Integration Pattern |Description\n\n|*Anti-Corruption Layer (ACL)*\n|EngagementService → Salesforce Service Cloud - protects digital channels from Salesforce API changes, translates between OTR domain language and Salesforce\n\n|*Conformist*\n|ProfileService/EngagementService → Salesforce - conform to existing Salesforce configuration and API contracts (shared Viva Energy instance)\n\n|*Event-Driven Architecture (OHS+PL)*\n|Event Bus publishing domain events (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`) for loose coupling between bounded contexts\n\n|*Just-In-Time (JIT) Integration*\n|ProfileService → Salesforce Contact reconciliation on-demand (no pre-sync)\n\n|*Async Processing*\n|EngagementService Case creation via Event Bus with retry, exponential backoff, dead letter queue\n\n|===\n\n=== Target State Architecture\n\n==== Architectural Building Blocks (ABB)\n\n[width=\"100%\",cols=\"20%,25%,30%,25%\",options=\"header\",]\n|===\n|ABB ID |Bounded Context |Responsibilities |Technology (TBD in Solution Architecture)\n\n|ABB-CS-001\n|*link:../bounded_context/profile.adoc[ProfileService]*\n|JIT Contact reconciliation with Salesforce (upsert by email), return Salesforce Contact ID, foundation for Flybuys partner linking\n|Microservice (.NET/Node.js), REST API, Salesforce REST API client\n\n|ABB-CS-002\n|*link:../bounded_context/engagement.adoc[EngagementService]*\n|Customer feedback submission facade, ACL for Salesforce Case creation, Braze integration, async processing, webhook receiver\n|Microservice (.NET/Node.js), REST API, Event Bus publisher/subscriber, Salesforce webhook receiver\n\n|ABB-CS-003\n|*Event Bus*\n|Domain event publishing infrastructure (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`)\n|AWS SNS+SQS / EventBridge / Kinesis\n\n|ABB-CS-004\n|*Salesforce Service Cloud*\n|System of Record for Contact and Case data (shared Viva Energy instance)\n|Salesforce Service Cloud (external SaaS)\n\n|ABB-CS-005\n|*Braze*\n|Marketing automation platform for push notifications\n|Braze (external SaaS) - existing integration\n\n|ABB-CS-006\n|*Mobile App*\n|iOS/Android native apps with enhanced feedback form (Category, Store Name, Time of Visit, Contact Phone Number, Free Text Message)\n|Kotlin Multiplatform, SwiftUI, Jetpack Compose\n\n|ABB-CS-007\n|*Contact Migration Tool*\n|One-time migration app database → Salesforce with upsert logic (match by email/phone/VCI)\n|Script/tool (.NET/Python/Node.js)\n\n|===\n\n==== Integration Architecture\n\n===== Integration Flows\n\n*Customer Feedback Submission (Async):*\n\n1. *Mobile App* → ProfileService: Authenticate user, get Salesforce Contact ID (JIT reconciliation)\n2. *Mobile App* → EngagementService: Submit feedback (POST /feedback with Contact ID, Category, Store Name, Time of Visit, Phone, Message)\n3. *EngagementService* → Mobile App: Immediate acknowledgment (\"Feedback submitted\")\n4. *EngagementService* → Event Bus: Publish work item for async Case creation\n5. *Background Worker* (EngagementService) → Salesforce: Create Case via REST API\n6. *Success*: EngagementService → Event Bus: Publish `SupportCaseCreated` event\n7. *EngagementService* → Braze: Trigger push notification campaign (\"Your feedback has been received, Case #12345\")\n8. *Failure*: Retry with exponential backoff → Dead Letter Queue → Ops team alert\n\n*Case Update Notification (Bidirectional):*\n\n1. *Support Agent* updates/resolves Case in Salesforce\n2. *Salesforce* → EngagementService: Webhook notification (Case updated)\n3. *EngagementService* → Event Bus: Publish `SupportCaseUpdated` or `SupportCaseResolved` event\n4. *EngagementService* → Braze: Trigger push notification campaign (\"Your case has been resolved\")\n\n*Contact Reconciliation (JIT):*\n\n1. *Mobile App user* authenticates\n2. *Mobile App* → ProfileService: GET /profile/contact-id\n3. *ProfileService* → Salesforce: Query Contact by email\n4. *Match found*: Return existing Salesforce Contact ID\n5. *No match*: Create new Contact in Salesforce, return new Contact ID\n6. *ProfileService* → Mobile App: Return Salesforce Contact ID (cached by Mobile App)\n\n===== System of Record Boundaries\n\n[width=\"100%\",cols=\"30%,35%,35%\",options=\"header\",]\n|===\n|Data Entity |System of Record |Rationale\n\n|*Contact*\n|Salesforce Service Cloud\n|Shared Viva Energy instance, unified customer profile across all channels (digital, wholesale, Shell Card, retail)\n\n|*Case*\n|Salesforce Service Cloud\n|Support agents manage Cases in Salesforce, digital channels submit via EngagementService ACL\n\n|*Feedback Submission (transient)*\n|None (no persistence)\n|EngagementService processes feedback and creates Case in Salesforce, no local storage\n\n|*Domain Events*\n|Event Bus (ephemeral)\n|Events published to Event Bus, consumed by subscribers, not persisted long-term (event sourcing not in scope)\n\n|===\n\n==== Data Architecture Principles\n\n===== Aggregate Persistence\n\n*ProfileService:*\n\n* **No local aggregate persistence** - ProfileService is stateless, queries Salesforce on-demand\n* Salesforce Contact is the aggregate root (owned by Salesforce)\n* ProfileService acts as facade/translator, not system of record\n\n*EngagementService:*\n\n* **No local aggregate persistence** - EngagementService is stateless, creates Cases in Salesforce via ACL\n* Salesforce Case is the aggregate root (owned by Salesforce)\n* EngagementService maintains no local Case state (Conformist pattern - trust Salesforce as source of truth)\n* Async processing state managed via Event Bus (work items in queue, not database)\n\n===== Event Store\n\n* **Event Bus** (SNS+SQS/EventBridge/Kinesis) handles domain event publishing\n* Events are **ephemeral** (consumed and discarded, not persisted for event sourcing)\n* No Event Store implementation in this architecture (future enhancement if needed)\n* Event schema versioning TBD in Solution Architecture\n\n\n=== Architecture Decisions\n\n==== ADR-CS-001: Consolidate onto Salesforce Service Cloud (not build custom solution)\n\n*Status*: Accepted\n\n*Context*:\n\n* D365 Customer Engagement not working well for digital customer support\n* Viva Energy already uses Salesforce Service Cloud for fuel wholesale, Shell Card, other retail channels\n* Post-merger opportunity to consolidate onto single platform\n* Alternative: Build custom support platform or use different SaaS\n\n*Decision*:\n\nConsolidate OTR digital customer support onto Salesforce Service Cloud (shared Viva Energy instance).\n\n*Rationale*:\n\n* **Unified customer view**: Support agents see all interactions across channels (digital, wholesale, Shell Card, retail)\n* **Platform consolidation**: Single support platform reduces operational overhead and costs\n* **Proven solution**: Salesforce Service Cloud is established, feature-rich, well-supported\n* **Post-merger alignment**: Strategic decision to standardize on Viva Energy platforms\n* **Avoid custom development**: Building custom support platform would be costly and high-risk\n\n*Consequences*:\n\n* Unified customer support across Viva Energy Group\n* Reduced operational complexity (single platform vs two)\n* Leverage Salesforce capabilities (case routing, knowledge base, AI, omnichannel)\n* ⚠️ Conformist pattern required (shared instance, conform to existing configuration)\n* ⚠️ Multi-tenant governance needed (data isolation, security, queues)\n* ❌ Less control over platform evolution (SaaS vendor, shared instance)\n\n==== ADR-CS-002: Implement ProfileService and EngagementService as first DDD bounded contexts\n\n*Status*: Accepted\n\n*Context*:\n\n* OTR target architecture uses Domain-Driven Design with bounded contexts\n* This migration is opportunity to establish first implementation\n* Alternative: Direct Mobile App → Salesforce integration (no bounded contexts)\n* Alternative: Single monolithic service for all customer-facing APIs\n\n*Decision*:\n\nImplement ProfileService and EngagementService as separate bounded contexts following DDD strategic patterns.\n\n*Rationale*:\n\n* **Foundation for target architecture**: First implementation of DDD pattern for future bounded contexts (Flybuys, LocationService, PaymentService)\n* **Separation of concerns**: ProfileService handles identity/Contact reconciliation, EngagementService handles support/feedback (different responsibilities, different change rates)\n* **Anti-Corruption Layer**: EngagementService protects digital channels from Salesforce API changes\n* **Reusability**: ProfileService Contact reconciliation reused for Flybuys integration\n* **Event-driven architecture**: Establishes pattern for loose coupling between bounded contexts\n\n*Consequences*:\n\n* Establishes DDD architecture foundation for OTR\n* Reusable ProfileService for Flybuys and future integrations\n* Digital channels protected from Salesforce API changes (ACL)\n* Clear bounded context boundaries and responsibilities\n* ⚠️ Increased initial complexity (two new microservices vs direct integration)\n* ⚠️ Requires Event Bus infrastructure implementation\n* ⚠️ Team must learn DDD patterns and bounded context design\n\n==== ADR-CS-003: Async Case creation via Event Bus (not synchronous)\n\n*Status*: Accepted\n\n*Context*:\n\n* Current D365 CE integration is synchronous (user waits for Case creation)\n* Alternative: Keep synchronous integration (Mobile App → EngagementService → Salesforce synchronously)\n* Salesforce API may experience downtime or latency\n\n*Decision*:\n\nImplement async Case creation via Event Bus with immediate user acknowledgment, retry logic, exponential backoff, and dead letter queue.\n\n*Rationale*:\n\n* **Non-blocking user experience**: User gets immediate \"Feedback submitted\" confirmation, not waiting for Salesforce API\n* **Resilience**: If Salesforce is down, feedback still accepted, Case created when Salesforce recovers\n* **Retry logic**: Automatic retry with exponential backoff handles transient failures\n* **Operational visibility**: Dead letter queue alerts ops team to persistent failures\n* **Scalability**: Queue buffering handles traffic spikes\n\n*Consequences*:\n\n* Better user experience (no waiting for Salesforce API)\n* Resilient to Salesforce downtime (queue buffers work)\n* Automatic retry reduces manual intervention\n* Queue depth monitoring provides operational visibility\n* ⚠️ Eventual consistency (user gets success notification after Case created, not immediately)\n* ⚠️ Increased complexity (Event Bus, background workers, retry logic, DLQ)\n* ⚠️ Requires monitoring and alerting for DLQ\n\n==== ADR-CS-004: ProfileService uses email as primary matching key (not VCI)\n\n*Status*: Accepted\n\n*Context*:\n\n* ProfileService needs to reconcile Mobile App users as Salesforce Contacts\n* Alternative matching keys: VCI (Viva Consumer ID), email, phone, Salesforce External ID\n* Email changes are rare but possible\n\n*Decision*:\n\nUse email address as primary matching key for Contact reconciliation (JIT upsert by email).\n\n*Rationale*:\n\n* **Availability**: Email always available for authenticated users\n* **Uniqueness**: Email is unique identifier in Salesforce and Mobile App\n* **Salesforce standard**: Salesforce Contact uses email as standard lookup field\n* **Simplicity**: Single matching key simplifies upsert logic\n* **Edge case acceptable**: Email changes are rare, manual cleanup acceptable\n\n*Consequences*:\n\n* Simple upsert logic (query by email, create if not found)\n* Leverages Salesforce standard email field\n* Email always available from authentication\n* ⚠️ Email changes create duplicate Contacts (rare edge case, manual cleanup)\n* ⚠️ Future enhancement: Add VCI as Salesforce External ID for stable matching\n\n==== ADR-CS-005: No Case migration from D365 CE (fresh start)\n\n*Status*: Accepted\n\n*Context*:\n\n* D365 CE contains historical customer support Cases\n* Alternative: Migrate historical Cases to Salesforce (preserve support history)\n* Alternative: Archive D365 CE Cases separately (read-only access)\n\n*Decision*:\n\nDo not migrate historical Cases from D365 CE to Salesforce. Start fresh in Salesforce.\n\n*Rationale*:\n\n* **Limited value**: Historical D365 CE Cases not critical for future support\n* **Data quality**: D365 CE Case data may be inconsistent or incomplete\n* **Complexity**: Case migration requires mapping D365 CE schema to Salesforce, data transformation, validation\n* **Cost-benefit**: Migration effort outweighs value of historical data\n* **Archive option**: D365 CE Cases can be archived separately if needed (read-only access for auditing)\n\n*Consequences*:\n\n* Simpler migration (Contacts only, no Case migration)\n* Faster time to value (no Case migration delay)\n* Clean start in Salesforce (no legacy data quality issues)\n* ⚠️ Historical Cases not visible in Salesforce (support agents can't see old Cases)\n* ⚠️ D365 CE must remain accessible temporarily for historical Case lookups (if needed)\n* ❌ Loss of historical Case insights (reporting, analytics on old Cases)\n\n==== ADR-CS-006: Big bang cutover (not phased rollout)\n\n*Status*: Accepted\n\n*Context*:\n\n* Alternative: Phased rollout with feature flags (pilot users first, gradual enablement)\n* Alternative: Parallel run (submit to both D365 CE and Salesforce temporarily)\n* Flybuys integration uses phased rollout (AS-1, AS-2, AS-3 architecture states)\n\n*Decision*:\n\nBig bang cutover - migrate Contacts, deploy ProfileService and EngagementService, switch Mobile App, retire D365 CE.\n\n*Rationale*:\n\n* **Simplicity**: No parallel run complexity, no feature flag management\n* **Faster D365 CE retirement**: No extended transition period maintaining two systems\n* **Limited risk**: Customer support not mission-critical (not payment processing), rollback possible\n* **User base manageable**: OTR digital customers smaller than Flybuys integration scope\n* **Different use case**: Flybuys phased rollout manages points accrual complexity, support feedback is simpler\n\n*Consequences*:\n\n* Simpler deployment (single cutover, no AS-1/AS-2/AS-3 states)\n* Faster D365 CE retirement (no extended parallel run)\n* No feature flag complexity or pilot user management\n* ⚠️ Higher cutover risk (all users switch at once)\n* ⚠️ Requires comprehensive testing before cutover\n* ⚠️ Rollback plan required (revert to D365 CE if critical issues)\n\n==== ADR-CS-007: EngagementService receives Salesforce webhooks for Case updates\n\n*Status*: Accepted\n\n*Context*:\n\n* Support agents update/resolve Cases in Salesforce\n* Need to notify customers of Case status changes via push notifications\n* Alternative: Poll Salesforce API for Case updates (inefficient)\n* Alternative: No customer notifications (agents contact customers directly)\n\n*Decision*:\n\nSalesforce sends webhook notifications to EngagementService when Cases are updated/resolved. EngagementService triggers Braze push notifications.\n\n*Rationale*:\n\n* **Real-time notifications**: Customer notified immediately when agent resolves Case\n* **Efficient**: Webhook push model (not polling)\n* **Event-driven**: Aligns with event-driven architecture pattern\n* **Better customer experience**: Proactive notification vs waiting for agent contact\n\n*Consequences*:\n\n* Real-time customer notifications for Case updates\n* Efficient push model (no polling overhead)\n* Bidirectional integration (Mobile App → Salesforce → Mobile App)\n* ⚠️ Salesforce webhook mechanism TBD (Outbound Messages vs Platform Events vs Process Builder)\n* ⚠️ Webhook authentication and security required\n* ⚠️ EngagementService must handle webhook retries and failures\n\n<<<\n== Interface Specifications\n\nThis section provides references to the complete API specifications and event catalogue for ProfileService and EngagementService.\n\n=== REST API Specifications\n\nComplete OpenAPI 3.0 specifications are maintained in the `specifications/rest/` directory:\n\n==== ProfileService API v1\n\n*Specification*: link:../../specifications/rest/profile-service-v1.yaml[profile-service-v1.yaml]\n\n*Base URL*: `https://api.otr.com.au/profile/v1`\n\n*Authentication*: Bearer token (Microsoft Entra External ID JWT)\n\n*Key Endpoints*:\n\n* `GET /contact-id` - Retrieve or create Salesforce Contact ID for authenticated user (Just-In-Time reconciliation)\n** Used by Mobile App before submitting feedback to EngagementService\n** Upserts Salesforce Contact record using email as external key\n** Returns 18-character Salesforce Contact ID with caching (15-minute TTL)\n** Performance SLA: p95 < 300ms (uncached), p95 < 50ms (cached)\n\n==== EngagementService API v1\n\n*Specification*: link:../../specifications/rest/engagement-service-v1.yaml[engagement-service-v1.yaml]\n\n*Base URL*: `https://api.otr.com.au/engagement/v1`\n\n*Authentication*: Bearer token (Microsoft Entra External ID JWT)\n\n*Key Endpoints*:\n\n* `POST /feedback` - Submit customer feedback for async Case creation in Salesforce\n** Accepts contactId, category, storeName, timeOfVisit, contactPhoneNumber, message\n** Returns 202 Accepted immediately (async Case creation in background)\n** Publishes `CustomerFeedbackSubmitted` event for analytics\n** Creates Salesforce Case via Anti-Corruption Layer with retry logic\n** Performance SLA: p95 < 200ms (feedback accepted, not Case creation)\n\n=== Domain Events (AsyncAPI)\n\nComplete CloudEvents 1.0 JSON Schema specifications are maintained in the `specifications/events/` directory:\n\n*Specification*: link:../../specifications/events/engagement-events.json[engagement-events.json]\n\n==== Event Catalogue\n\n[width=\"100%\",cols=\"30%,20%,50%\",options=\"header\",]\n|===\n|Event Type |Publisher |Consumers\n\n|`CustomerFeedbackSubmitted`\n|EngagementService\n|Future bounded contexts, analytics, sentiment analysis\n\n|`SupportCaseCreated`\n|EngagementService\n|Future bounded contexts, analytics\n\n|`SupportCaseUpdated`\n|EngagementService (via Salesforce webhook)\n|Future bounded contexts, analytics\n\n|`SupportCaseResolved`\n|EngagementService (via Salesforce webhook)\n|Future bounded contexts, analytics\n\n|===\n\n==== Event Delivery Guarantees\n\n* **At-least-once delivery**: Events may be delivered multiple times, consumers must handle idempotency\n* **Ordering**: FIFO queues guarantee ordering for events with same `contactId`\n* **Retention**: 4 days (96 hours) in Event Bus\n* **Dead Letter Queue**: Failed events after 5 retries moved to DLQ for manual intervention\n* **Format**: CloudEvents 1.0 specification with JSON payload\n\n=== API Versioning Policy\n\n==== Version Numbering\n\n* **Format**: `/v{major}` in URL path (e.g., `/profile/v1`, `/engagement/v1`)\n* **Semantic Versioning**: Major version incremented for breaking changes only\n* **Backwards Compatibility**: Minor changes (new optional fields, new endpoints) don't require version bump\n\n==== When to Version\n\n*Breaking changes requiring new major version*:\n\n- Removing or renaming fields in request/response\n- Changing field data types (e.g., string → number)\n- Changing authentication mechanism\n- Removing endpoints\n\n*Non-breaking changes not requiring version bump*:\n\n- Adding new optional fields to request/response\n- Adding new endpoints\n- Expanding enum values (e.g., adding new feedback category)\n- Improving error messages\n\n==== Parallel Version Support\n\n* Support N and N-1 versions concurrently for 6 months\n* Deprecation notice: 3 months before sunsetting old version\n* Mobile App must upgrade to new version within deprecation window\n\n<<<\n== Work Packages\n\nThis section consolidates gaps and activities into implementable work packages aligned with TOGAF Phase E requirements.\n\n=== Work Package Overview\n\n[width=\"100%\",cols=\"15%,35%,25%,25%\",options=\"header\",]\n|===\n|Work Package ID |Name |Transition State |Key Deliverables\n\n|WP-CS-001\n|ProfileService Development\n|TS-1 (Build & Test)\n|ProfileService microservice, Salesforce Contact integration, REST API\n\n|WP-CS-002\n|EngagementService Development\n|TS-1 (Build & Test)\n|EngagementService microservice, Anti-Corruption Layer, Braze integration\n\n|WP-CS-003\n|Event Bus Infrastructure\n|TS-1 (Build & Test)\n|Event Bus configuration, CloudEvents schemas, monitoring\n\n|WP-CS-004\n|Contact Migration Tooling\n|TS-1 (Build & Test)\n|Migration tool, validation scripts, reconciliation reporting\n\n|WP-CS-005\n|Mobile App Integration\n|TS-1 (Build & Test)\n|Mobile App API integration, feedback form enhancements, testing\n\n|WP-CS-006\n|Integration Testing\n|TS-1 (Build & Test)\n|Test environments, integration test suites, UAT execution\n\n|WP-CS-007\n|Salesforce Configuration\n|TS-1 (Build & Test)\n|Salesforce field mapping, data isolation, webhook configuration\n\n|WP-CS-008\n|Contact Data Migration\n|TS-2 (Contact Migration)\n|Contact migration execution, validation, reconciliation\n\n|WP-CS-009\n|Production Deployment\n|TS-3 (Cutover)\n|Production deployment, smoke testing, go-live execution\n\n|WP-CS-010\n|Post-Cutover Support\n|TS-4 (Target State)\n|Monitoring, issue resolution, D365 CE retirement\n\n|===\n\n[[wp-cs-001]]\n=== WP-CS-001: ProfileService Development\n\n==== Description\n\nBuild ProfileService bounded context microservice implementing Just-In-Time Contact reconciliation with Salesforce Service Cloud.\n\n==== Deliverables\n\n* ProfileService microservice application\n** REST API implementation (OpenAPI 3.0 specification)\n** `GET /contact-id` endpoint (Salesforce Contact reconciliation)\n** Authentication/authorization with Microsoft Entra External ID\n** Caching layer (15-minute TTL for Contact IDs)\n* Salesforce integration\n** Salesforce REST API client\n** Contact upsert by email (external key matching)\n** Error handling and retry logic\n* Unit tests (>80% code coverage)\n* Integration tests with Salesforce sandbox\n* API documentation\n* Deployment configuration (IaC - Infrastructure as Code)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* Salesforce sandbox environment provisioned\n* Microsoft Entra External ID OAuth configuration\n* Development environment setup (AWS dev account, CI/CD pipeline)\n\n*Dependent Work Packages*:\n\n* None (can start immediately after prerequisites met)\n\n==== Skills Required\n\n* Backend development (.NET Core or Node.js)\n* REST API design and implementation\n* Salesforce REST API integration\n* OAuth 2.0 / JWT authentication\n* Caching strategies (Redis/ElastiCache)\n* Unit/integration testing frameworks\n* Infrastructure as Code (Terraform/CloudFormation)\n\n==== Acceptance Criteria\n\n* All API endpoints return correct HTTP status codes per OpenAPI specification\n* Contact ID retrieval achieves p95 < 300ms (uncached), p95 < 50ms (cached)\n* Salesforce Contact upsert succeeds with 100% accuracy in sandbox testing\n* Unit test coverage > 80%\n* Integration tests pass in sandbox environment\n* API documentation generated from OpenAPI specification\n\n[[wp-cs-002]]\n=== WP-CS-002: EngagementService Development\n\n==== Description\n\nBuild EngagementService bounded context microservice implementing customer feedback submission, Anti-Corruption Layer for Salesforce Case creation, Braze integration, and webhook receiver for Case updates.\n\n==== Deliverables\n\n* EngagementService microservice application\n** REST API implementation (OpenAPI 3.0 specification)\n** `POST /feedback` endpoint (async feedback submission)\n** Authentication/authorization with Microsoft Entra External ID\n** Webhook receiver endpoint for Salesforce Case updates\n* Anti-Corruption Layer (ACL)\n** OTR domain model to Salesforce API translation\n** Category enum mapping (App/Service/Order/Rewards → Salesforce Case fields)\n** Salesforce REST API client for Case creation\n* Async processing infrastructure\n** Event Bus publisher integration\n** Background worker for Case creation\n** Retry logic with exponential backoff (5 attempts)\n** Dead Letter Queue integration\n* Braze integration\n** Braze campaign trigger API client\n** Push notification orchestration for Case updates\n* Domain event publishing\n** `CustomerFeedbackSubmitted` event publisher\n** `SupportCaseCreated` event publisher\n** `SupportCaseUpdated` event translator (Salesforce webhook → domain event)\n** `SupportCaseResolved` event translator (Salesforce webhook → domain event)\n* Unit tests (>80% code coverage)\n* Integration tests (EngagementService ↔ Salesforce, EngagementService ↔ Braze)\n* API documentation\n* Deployment configuration (IaC)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* <<wp-cs-003,WP-CS-003>> (Event Bus Infrastructure) completed\n* Salesforce sandbox environment provisioned\n* Braze API credentials and campaign templates configured\n* Microsoft Entra External ID OAuth configuration\n\n*Dependent Work Packages*:\n\n* <<wp-cs-003,WP-CS-003>> must be completed first (Event Bus required for async processing)\n* <<wp-cs-007,WP-CS-007>> (Salesforce Configuration) must be in progress (field mapping needed)\n\n==== Skills Required\n\n* Backend development (.NET Core or Node.js)\n* REST API design and implementation\n* Salesforce REST API integration\n* Event-driven architecture patterns\n* Async/background processing (queues, workers)\n* Braze API integration\n* Webhook design and security\n* OAuth 2.0 / JWT authentication\n* Domain-Driven Design (DDD) - Anti-Corruption Layer pattern\n* Unit/integration testing frameworks\n* Infrastructure as Code (Terraform/CloudFormation)\n\n==== Acceptance Criteria\n\n* Feedback submission endpoint returns 202 Accepted within p95 < 200ms\n* Async Case creation succeeds with >99.5% success rate (including retries)\n* Anti-Corruption Layer correctly maps all feedback categories to Salesforce Case fields\n* Webhook receiver processes Salesforce Case updates and publishes domain events\n* Braze push notifications sent successfully for Case updates\n* Failed Case creation moves to Dead Letter Queue after 5 retry attempts\n* Unit test coverage > 80%\n* Integration tests pass with Salesforce sandbox and Braze staging environment\n\n[[wp-cs-003]]\n=== WP-CS-003: Event Bus Infrastructure\n\n==== Description\n\nImplement Event Bus infrastructure for domain event publishing using existing AWS infrastructure (SNS+SQS, EventBridge, or Kinesis).\n\n==== Deliverables\n\n* Event Bus infrastructure configuration\n** Topic/stream provisioning (technology choice: SNS+SQS / EventBridge / Kinesis)\n** FIFO queue configuration (ordering by `contactId`)\n** Dead Letter Queue (DLQ) setup\n** Retention policy (4 days / 96 hours)\n** Access control policies (IAM roles, permissions)\n* CloudEvents 1.0 schema definitions\n** JSON Schema specifications for all domain events\n** Schema validation configuration\n** Schema registry (if using EventBridge/Kinesis)\n* Monitoring and alerting\n** CloudWatch dashboards for queue metrics\n** Alarms for DLQ depth, queue age, processing failures\n** Event Bus throughput monitoring\n* Documentation\n** Event Bus architecture diagram\n** Event publishing guidelines\n** Consumer integration guide\n* Infrastructure as Code (IaC)\n** Terraform/CloudFormation templates for all infrastructure\n\n==== Dependencies\n\n*Prerequisites*:\n\n* AWS account access (existing infrastructure)\n* Technology selection decision (SNS+SQS vs EventBridge vs Kinesis)\n* CloudEvents 1.0 schema design approval\n\n*Dependent Work Packages*:\n\n* None (foundational infrastructure, can start early)\n\n==== Skills Required\n\n* AWS messaging services (SNS, SQS, EventBridge, Kinesis)\n* Event-driven architecture patterns\n* CloudEvents specification\n* JSON Schema design\n* Infrastructure as Code (Terraform/CloudFormation)\n* AWS IAM security configuration\n* CloudWatch monitoring and alerting\n\n==== Acceptance Criteria\n\n* Event Bus infrastructure provisioned in all environments (dev, staging, production)\n* FIFO ordering validated for events with same `contactId`\n* Dead Letter Queue triggers alarms when messages arrive\n* Event retention policy enforced (4 days)\n* CloudEvents 1.0 schema validation enabled\n* Monitoring dashboards operational\n* Infrastructure fully codified (IaC)\n\n[[wp-cs-004]]\n=== WP-CS-004: Contact Migration Tooling\n\n==== Description\n\nDevelop Contact migration tool for one-time migration from app-specific database to Salesforce Service Cloud with upsert logic and validation.\n\n==== Deliverables\n\n* Contact migration tool\n** Extract Contacts from app-specific database\n** Transform to Salesforce Contact API format\n** Upsert to Salesforce using email as external key\n** Fallback matching by phone number or Viva Consumer ID\n** Batch processing with rate limiting (respect Salesforce API limits)\n** Idempotent operation (can be re-run safely)\n* Validation scripts\n** Pre-migration validation (data quality checks)\n** Post-migration validation (100% Contact reconciliation)\n** Email/phone/VCI matching accuracy report\n* Reconciliation reporting\n** Contacts created vs updated statistics\n** Failed upserts with error details\n** Matching accuracy metrics\n* Rollback capability\n** Export snapshot of Salesforce Contacts before migration\n** Rollback procedure documentation\n* Documentation\n** Migration tool user guide\n** Troubleshooting guide\n** Runbook for migration execution\n\n==== Dependencies\n\n*Prerequisites*:\n\n* <<wp-cs-001,WP-CS-001>> (ProfileService Development) completed (reuses Salesforce integration code)\n* Salesforce sandbox environment for migration testing\n* App-specific database access (read-only sufficient)\n* Salesforce production access granted\n\n*Dependent Work Packages*:\n\n* <<wp-cs-001,WP-CS-001>> provides Salesforce Contact upsert logic to reuse\n\n==== Skills Required\n\n* Database development (SQL, data extraction)\n* Salesforce REST API integration\n* Batch processing and ETL patterns\n* Data validation and reconciliation\n* Error handling and logging\n* Scripting (Python, PowerShell, or similar)\n\n==== Acceptance Criteria\n\n* Migration tool successfully migrates 100% of Contacts in sandbox with zero data loss\n* Email/phone/VCI matching accuracy > 95% in sandbox testing\n* Failed upserts captured with actionable error messages\n* Reconciliation report matches actual Salesforce Contact counts\n* Migration tool execution time acceptable for production (freezes app database for minimum time)\n* Rollback procedure validated in sandbox\n* Documentation complete and approved\n\n[[wp-cs-005]]\n=== WP-CS-005: Mobile App Integration\n\n==== Description\n\nUpdate Mobile App to integrate with ProfileService and EngagementService APIs, replacing D365 CE integration.\n\n==== Deliverables\n\n* Feedback form UI enhancements\n** Add Category dropdown (App, Service, Order, Rewards, Refund, Delete Account)\n** Add Store Name field (optional)\n** Add Time of Visit field (optional, datetime picker)\n** Add Contact Phone Number field (optional, E.164 validation)\n** Update Message field (1-2000 character limit with counter)\n* API integration (Kotlin Multiplatform shared code)\n** ProfileService client (`GET /contact-id`)\n** EngagementService client (`POST /feedback`)\n** JWT token management (Microsoft Entra External ID)\n** Error handling (network failures, API errors, validation errors)\n** Retry logic for transient failures\n* Platform-specific UI (SwiftUI for iOS, Jetpack Compose for Android)\n** Feedback form screens\n** Success/error confirmation screens\n** Loading states and progress indicators\n* Feature flag integration\n** `enable_salesforce_feedback_submission` flag\n** Fallback to D365 CE if flag disabled (during rollout)\n* Unit tests for shared business logic\n* UI tests for platform-specific screens\n* API integration tests (mocked APIs)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* <<wp-cs-001,WP-CS-001>> (ProfileService Development) completed and deployed to dev/staging\n* <<wp-cs-002,WP-CS-002>> (EngagementService Development) completed and deployed to dev/staging\n* ProfileService and EngagementService OpenAPI specifications finalized\n* Feature flag service configured\n\n*Dependent Work Packages*:\n\n* Must complete after <<wp-cs-001,WP-CS-001>> and <<wp-cs-002,WP-CS-002>> (requires API endpoints available for integration testing)\n\n==== Skills Required\n\n* Kotlin Multiplatform development\n* SwiftUI (iOS native UI)\n* Jetpack Compose (Android native UI)\n* REST API client development\n* OAuth 2.0 / JWT authentication\n* Form validation and UX design\n* Unit testing (Kotlin, Swift)\n* UI testing frameworks (XCTest, Espresso)\n\n==== Acceptance Criteria\n\n* Feedback form UI matches UX design specifications\n* All form fields validate correctly (client-side validation)\n* API integration successfully calls ProfileService and EngagementService in dev/staging\n* Error handling provides user-friendly error messages\n* Feature flag correctly toggles between Salesforce and D365 CE integration\n* Unit test coverage > 80% for shared business logic\n* UI tests pass for all feedback form workflows (happy path, error states)\n* App builds and deploys successfully to TestFlight (iOS) and Google Play Internal Testing (Android)\n\n[[wp-cs-006]]\n=== WP-CS-006: Integration Testing\n\n==== Description\n\nExecute comprehensive integration testing across all system components in non-production environments.\n\n==== Deliverables\n\n* Test environment setup\n** Salesforce sandbox configured with test data\n** ProfileService deployed to staging\n** EngagementService deployed to staging\n** Event Bus staging infrastructure\n** Braze staging environment configured\n** Mobile App TestFlight/Internal Testing builds\n* Integration test suites\n** ProfileService ↔ Salesforce (Contact upsert scenarios)\n** EngagementService ↔ Salesforce (Case creation scenarios)\n** EngagementService ↔ Braze (push notification scenarios)\n** Mobile App ↔ ProfileService ↔ EngagementService (end-to-end workflows)\n** Event Bus publishing and consumption\n** Webhook receiver (Salesforce → EngagementService)\n* Test scenarios\n** Happy path: Successful feedback submission and Case creation\n** Error scenarios: Salesforce API failures, Braze API failures, network timeouts\n** Retry scenarios: Async Case creation retries, DLQ validation\n** Performance testing: p95 latency validation for ProfileService and EngagementService\n** Load testing: Simulate 3x-10x expected volume\n* UAT execution\n** Business stakeholder UAT sessions\n** UAT test cases covering all feedback categories\n** UAT sign-off documentation\n* Test results documentation\n** Test execution reports\n** Defect tracking and resolution\n** Performance test results\n\n==== Dependencies\n\n*Prerequisites*:\n\n* <<wp-cs-001,WP-CS-001>> (ProfileService Development) completed\n* <<wp-cs-002,WP-CS-002>> (EngagementService Development) completed\n* <<wp-cs-003,WP-CS-003>> (Event Bus Infrastructure) completed\n* <<wp-cs-005,WP-CS-005>> (Mobile App Integration) completed\n* <<wp-cs-007,WP-CS-007>> (Salesforce Configuration) sandbox configuration completed\n\n*Dependent Work Packages*:\n\n* Must complete after <<wp-cs-001,WP-CS-001>>, <<wp-cs-002,WP-CS-002>>, <<wp-cs-003,WP-CS-003>>, <<wp-cs-005,WP-CS-005>> (requires all components available)\n\n==== Skills Required\n\n* Integration testing strategy and execution\n* Test automation frameworks (Postman, Newman, Selenium)\n* Performance testing tools (JMeter, k6, Gatling)\n* Salesforce sandbox administration\n* Test data management\n* Defect tracking and triage\n* UAT facilitation\n\n==== Acceptance Criteria\n\n* All integration test scenarios pass (happy path, error scenarios, retry scenarios)\n* Performance SLAs validated (ProfileService p95 < 300ms, EngagementService p95 < 200ms)\n* Load testing confirms system handles 3x expected volume without degradation\n* UAT sign-off obtained from business stakeholders\n* Zero critical defects (P1/P2) open before moving to Contact Migration\n* Test results documented and approved\n\n[[wp-cs-007]]\n=== WP-CS-007: Salesforce Configuration\n\n==== Description\n\nConfigure Salesforce Service Cloud for OTR digital customer support integration, including field mapping, data isolation, and webhook setup.\n\n==== Deliverables\n\n* Salesforce Contact configuration\n** Custom fields for OTR-specific data (if needed)\n** Email as external key configuration\n** Record Type for OTR digital customers (data isolation)\n** Validation rules\n* Salesforce Case configuration\n** Custom fields for feedback categories (App, Service, Order, Rewards, Refund, Delete Account)\n** Case Type and Reason picklist mapping\n** Queue assignment rules (OTR digital support queue)\n** Case escalation rules\n** Case routing rules\n* Salesforce webhook configuration\n** Platform Events / Outbound Messages for Case updates\n** Webhook authentication (API key, JWT, or OAuth)\n** Case status change triggers (New → In Progress, Resolved, Closed)\n** Webhook payload format (JSON)\n* Data isolation strategy\n** Record Types for OTR vs other Viva Energy business units\n** Queues for OTR-specific Cases\n** Reporting and dashboards scoped to OTR data\n* Salesforce API access\n** Connected App configuration\n** OAuth 2.0 JWT bearer flow setup\n** API user credentials\n** API rate limit monitoring\n* Documentation\n** Salesforce field mapping specification\n** Webhook configuration guide\n** Data isolation architecture diagram\n** API authentication setup guide\n\n==== Dependencies\n\n*Prerequisites*:\n\n* Viva Energy Salesforce admin team engagement\n* Salesforce governance approval (multi-tenant environment)\n* Technical decision on webhook mechanism (Platform Events vs Outbound Messages)\n* Technical decision on authentication method (OAuth 2.0 JWT bearer flow recommended)\n\n*Dependent Work Packages*:\n\n* None (can start in parallel with development work packages)\n* Required for <<wp-cs-002,WP-CS-002>> (EngagementService needs field mapping)\n* Required for <<wp-cs-006,WP-CS-006>> (Integration Testing needs sandbox configuration)\n\n==== Skills Required\n\n* Salesforce administration\n* Salesforce configuration (Record Types, Queues, Validation Rules)\n* Salesforce API integration (REST API, Platform Events, Outbound Messages)\n* Salesforce security and authentication (OAuth, Connected Apps)\n* Multi-tenant data isolation patterns\n\n==== Acceptance Criteria\n\n* Salesforce sandbox configured with all custom fields, Record Types, Queues\n* Field mapping documented and approved by OTR business stakeholders\n* Webhook configuration tested and delivering Case update notifications\n* Data isolation validated (OTR data separate from other Viva Energy business units)\n* API authentication working for ProfileService and EngagementService\n* Salesforce API rate limits monitored and acceptable for expected volume\n* Configuration replicated to Salesforce production environment\n\n[[wp-cs-008]]\n=== WP-CS-008: Contact Data Migration\n\n==== Description\n\nExecute one-time Contact migration from app-specific database to Salesforce Service Cloud production.\n\n==== Deliverables\n\n* Pre-migration activities\n** Final validation of migration tool in sandbox\n** Communication plan (notify users of maintenance window if needed)\n** Freeze app-specific database Contact updates\n** Backup app-specific database\n** Export snapshot of Salesforce Contacts (rollback preparation)\n* Migration execution\n** Execute migration tool against Salesforce production\n** Monitor migration progress\n** Handle failed upserts (manual intervention if needed)\n* Post-migration validation\n** 100% Contact reconciliation (app database vs Salesforce)\n** Email/phone/VCI matching accuracy report\n** Reconciliation report (Contacts created vs updated)\n** Data integrity checks (no duplicate Contacts, no missing Contacts)\n* ProfileService smoke testing\n** Verify Contact ID retrieval works in production\n** Test cache behavior\n** Validate Salesforce Contact upserts from ProfileService\n* Migration report\n** Total Contacts migrated\n** Contacts created vs updated\n** Failed upserts (if any) with resolution\n** Matching accuracy metrics\n** Migration execution time\n\n==== Dependencies\n\n*Prerequisites*:\n\n* <<wp-cs-004,WP-CS-004>> (Contact Migration Tooling) completed\n* <<wp-cs-001,WP-CS-001>> (ProfileService Development) deployed to production (not yet integrated with Mobile App)\n* <<wp-cs-007,WP-CS-007>> (Salesforce Configuration) production configuration completed\n* Salesforce production access granted\n* Migration approved by business stakeholders\n\n*Dependent Work Packages*:\n\n* Must complete after <<wp-cs-001,WP-CS-001>>, <<wp-cs-004,WP-CS-004>>, <<wp-cs-007,WP-CS-007>>\n* Must complete before <<wp-cs-009,WP-CS-009>> (Production Deployment)\n\n==== Skills Required\n\n* Data migration execution\n* Salesforce administration\n* Database operations\n* Data validation and reconciliation\n* Incident management (if issues arise)\n\n==== Acceptance Criteria\n\n* 100% of Contacts migrated with zero data loss\n* Email/phone/VCI matching accuracy > 95%\n* ProfileService smoke tests pass in production\n* Reconciliation report approved by business stakeholders\n* App-specific database Contact updates frozen (read-only mode)\n* Rollback procedure ready (but not executed if migration successful)\n\n[[wp-cs-009]]\n=== WP-CS-009: Production Deployment\n\n==== Description\n\nDeploy all solution components to production and execute cutover from D365 CE to Salesforce Service Cloud.\n\n==== Deliverables\n\n* Production deployment\n** EngagementService deployed to production\n** Event Bus production infrastructure validated\n** Salesforce webhook configured in production\n** Mobile App released to production (App Store, Google Play)\n* Go-live activities\n** Smoke testing (end-to-end feedback submission)\n** Feature flag enabled: `enable_salesforce_feedback_submission = ON`\n** D365 CE integration disabled in Mobile App\n** Monitor Event Bus queue depth, DLQ, Salesforce API rate limits\n** Monitor Mobile App feedback submission success rate\n* Go/No-Go decision\n** Validate success criteria before final cutover\n** Business stakeholder approval\n** Technical validation (smoke tests pass, monitoring healthy)\n* Cutover communication\n** Notify support agents of new Salesforce integration\n** Provide training materials for support agents\n** Customer communication (if visible change)\n* Rollback plan\n** Documented rollback procedure\n** Feature flag can disable Salesforce integration and re-enable D365 CE\n** Rollback decision criteria (P1/P2 incidents, feedback submission success rate < 99%)\n\n==== Dependencies\n\n*Prerequisites*:\n\n* <<wp-cs-001,WP-CS-001>> (ProfileService Development) completed\n* <<wp-cs-002,WP-CS-002>> (EngagementService Development) completed\n* <<wp-cs-003,WP-CS-003>> (Event Bus Infrastructure) completed\n* <<wp-cs-005,WP-CS-005>> (Mobile App Integration) completed\n* <<wp-cs-006,WP-CS-006>> (Integration Testing) completed with UAT sign-off\n* <<wp-cs-007,WP-CS-007>> (Salesforce Configuration) production configuration completed\n* <<wp-cs-008,WP-CS-008>> (Contact Data Migration) completed successfully\n* Mobile App release approval (App Store, Google Play)\n\n*Dependent Work Packages*:\n\n* Must complete after all prior work packages (final cutover)\n\n==== Skills Required\n\n* Production deployment and release management\n* Incident management and troubleshooting\n* Monitoring and observability\n* Change management and communication\n* Rollback execution (if needed)\n\n==== Acceptance Criteria\n\n* Mobile App feedback submission success rate > 99.5%\n* End-to-end flow validated (Mobile App → ProfileService → EngagementService → Salesforce Case created)\n* Braze push notifications delivered successfully\n* Event Bus queue depth normal, DLQ empty\n* No critical incidents (P1/P2) in first 24 hours\n* D365 CE integration disabled\n* Support agents successfully using Salesforce for OTR digital customer Cases\n\n[[wp-cs-010]]\n=== WP-CS-010: Post-Cutover Support\n\n==== Description\n\nMonitor production stability, resolve issues, validate success criteria, and execute D365 CE retirement.\n\n==== Deliverables\n\n* Monitoring and support\n** 24/7 on-call support for first week post-cutover\n** Daily monitoring reports (feedback submission success rate, Case creation success rate)\n** Incident response and resolution\n** Performance tuning (if needed)\n* Success criteria validation\n** Validate feedback submission success rate > 99.5%\n** Monitor customer satisfaction score (target: +15% improvement within 6 months)\n** Monitor average case resolution time (target: -20% improvement within 6 months)\n** Support agent feedback survey\n* D365 CE retirement\n** D365 CE set to read-only mode (historical Case lookups only)\n** Archive D365 CE data for compliance/auditing\n** Decommission D365 CE infrastructure (after 90-day stabilization period)\n** Remove D365 CE integration code from Mobile App\n* Documentation updates\n** Production runbook\n** Troubleshooting guide (based on incidents resolved)\n** Operational procedures for support team\n** Lessons learned document\n\n==== Dependencies\n\n*Prerequisites*:\n\n* <<wp-cs-009,WP-CS-009>> (Production Deployment) completed\n* Cutover successful with no critical incidents\n\n*Dependent Work Packages*:\n\n* Final work package in sequence\n\n==== Skills Required\n\n* Production support and incident management\n* Performance monitoring and tuning\n* Data archival and compliance\n* Infrastructure decommissioning\n* Documentation\n\n==== Acceptance Criteria\n\n* Zero critical incidents (P1/P2) in first 30 days post-cutover\n* Feedback submission success rate sustained > 99.5%\n* Customer satisfaction improvement validated (baseline established, ongoing measurement)\n* Support agents reporting positive experience with Salesforce unified view\n* D365 CE successfully decommissioned\n* All production documentation complete and approved\n* Lessons learned document published\n\n=== Work Package Sequencing\n\n==== Parallel Track 1: Infrastructure & Configuration\n\nCan start immediately and run in parallel:\n\n* <<wp-cs-003,WP-CS-003>> (Event Bus Infrastructure)\n* <<wp-cs-007,WP-CS-007>> (Salesforce Configuration)\n\n==== Parallel Track 2: Development\n\nCan start after Track 1 infrastructure decisions made:\n\n* <<wp-cs-001,WP-CS-001>> (ProfileService Development) - Independent\n* <<wp-cs-002,WP-CS-002>> (EngagementService Development) - Requires <<wp-cs-003,WP-CS-003>> completed\n* <<wp-cs-004,WP-CS-004>> (Contact Migration Tooling) - Requires <<wp-cs-001,WP-CS-001>> completed (reuses code)\n\n==== Sequential Track 3: Integration & Testing\n\nMust complete after development:\n\n* <<wp-cs-005,WP-CS-005>> (Mobile App Integration) - Requires <<wp-cs-001,WP-CS-001>>, <<wp-cs-002,WP-CS-002>>\n* <<wp-cs-006,WP-CS-006>> (Integration Testing) - Requires <<wp-cs-001,WP-CS-001>>, <<wp-cs-002,WP-CS-002>>, <<wp-cs-003,WP-CS-003>>, <<wp-cs-005,WP-CS-005>>, <<wp-cs-007,WP-CS-007>>\n\n==== Sequential Track 4: Migration & Cutover\n\nMust complete sequentially:\n\n* <<wp-cs-008,WP-CS-008>> (Contact Data Migration) - Requires <<wp-cs-001,WP-CS-001>>, <<wp-cs-004,WP-CS-004>>, <<wp-cs-006,WP-CS-006>> UAT sign-off\n* <<wp-cs-009,WP-CS-009>> (Production Deployment) - Requires all prior work packages completed\n* <<wp-cs-010,WP-CS-010>> (Post-Cutover Support) - Requires <<wp-cs-009,WP-CS-009>>\n\n==== Critical Path\n\nThe critical path for this project is:\n\n. WP-CS-003 (Event Bus Infrastructure)\n. WP-CS-002 (EngagementService Development) - blocks on WP-CS-003\n. WP-CS-005 (Mobile App Integration) - blocks on WP-CS-001, WP-CS-002\n. WP-CS-006 (Integration Testing) - blocks on WP-CS-001 through WP-CS-005, WP-CS-007\n. WP-CS-008 (Contact Data Migration) - blocks on WP-CS-006 UAT sign-off\n. WP-CS-009 (Production Deployment) - blocks on WP-CS-008\n. WP-CS-010 (Post-Cutover Support) - final deliverable\n\nAny delays in critical path work packages will delay the overall cutover date.\n\n<<<\n== Transition Architecture\n\nThis section defines the evolution from baseline (D365 CE) to target state (Salesforce Service Cloud + ProfileService + EngagementService).\n\n=== Transition Approach\n\n*Big Bang Cutover*: Per ADR-CS-006, this transition uses a single cutover approach rather than phased rollout. All users switch from D365 CE to Salesforce simultaneously after Contact migration completion.\n\n=== Transition States\n\n==== TS-0: Baseline State (Current)\n\n===== Characteristics\n\n* D365 Customer Engagement handles all digital customer feedback\n* App-specific database stores customer Contact data\n* No ProfileService or EngagementService\n* No event-driven architecture\n* Synchronous feedback submission\n\n===== Components Active\n\n- D365 Customer Engagement\n- App-specific customer database\n- Mobile App (current version with D365 CE integration)\n\n==== TS-1: Build & Test\n\n===== Activities\n\n* Build ProfileService microservice (JIT Contact reconciliation API)\n* Build EngagementService microservice (feedback submission API, ACL for Salesforce Case creation, Braze integration, webhook receiver)\n* Implement Event Bus infrastructure (SNS+SQS/EventBridge/Kinesis)\n* Develop Contact migration tool (app database → Salesforce upsert by email/phone/VCI)\n* Update Mobile App API integration (ProfileService + EngagementService endpoints - feedback form UI already complete)\n* Integration testing (ProfileService ↔ Salesforce, EngagementService ↔ Salesforce, EngagementService ↔ Braze)\n* UAT with test Salesforce sandbox environment\n\n===== Components Active\n\n- D365 Customer Engagement (still active, unchanged)\n- App-specific customer database (still active)\n- ProfileService (non-production, testing only)\n- EngagementService (non-production, testing only)\n- Event Bus (non-production)\n- Salesforce Sandbox (testing)\n\n===== Exit Criteria\n\n- All integration tests pass\n- UAT sign-off from business stakeholders\n- Contact migration tool validated in sandbox\n- Mobile App updates tested with non-production APIs\n\n==== TS-2: Contact Migration\n\n===== Activities\n* Execute Contact migration (app database → Salesforce production)\n* Validation: 100% data integrity check (email/phone/VCI matching)\n* Reconciliation report: New Contacts created vs existing Contacts updated\n* Freeze app database Contact updates during migration window\n* ProfileService smoke testing (verify Contact lookups work in Salesforce production)\n\n===== Components Active\n- D365 Customer Engagement (still active, users unaffected)\n- Salesforce Production (Contacts migrated, no Cases yet)\n- ProfileService (production deployed, not integrated with Mobile App yet)\n- App-specific customer database (frozen, read-only)\n\n===== Exit Criteria\n- 100% of Contacts migrated with zero data loss\n- Email/phone/VCI matching accuracy > 95%\n- ProfileService smoke tests pass (JIT lookups return correct Contact IDs)\n- Reconciliation report approved\n\n==== TS-3: Cutover (Go-Live)\n\n===== Go-Live Activities\n\n* Deploy EngagementService to production\n* Deploy Mobile App updates (ProfileService + EngagementService API integration)\n* Configure Salesforce webhook (Case update notifications → EngagementService)\n* Smoke testing: End-to-end feedback submission (Mobile App → EngagementService → Salesforce → Braze notification)\n* Monitor Event Bus queue depth, dead letter queue, Salesforce API rate limits\n* **Go/No-Go decision**: Validate success criteria before final cutover\n* Enable feature flag: `enable_salesforce_feedback_submission = ON`\n* Disable D365 CE integration in Mobile App\n\n===== Components Active\n\n- ProfileService (production, integrated with Mobile App)\n- EngagementService (production, integrated with Mobile App)\n- Event Bus (production, processing async Case creation)\n- Salesforce Production (receiving Cases from digital customers)\n- Braze (sending push notifications)\n- Mobile App (new version with Salesforce integration)\n- D365 Customer Engagement (disabled, read-only for historical lookups)\n\n===== Exit Criteria\n\n- Mobile App feedback submission success rate > 99.5%\n- End-to-end flow validated (Mobile App → Salesforce Case created)\n- Braze push notifications delivered successfully\n- Event Bus queue depth normal, DLQ empty\n- No critical incidents (P1/P2) in first 24 hours\n\n==== TS-4: Target State (Stable Production)\n\n===== Characteristics\n\n* ProfileService and EngagementService fully operational\n* All digital customer feedback routed to Salesforce\n* Event-driven architecture established\n* D365 CE decommissioned\n* First DDD bounded contexts implemented successfully\n\n===== Monitoring Period\n\n* Validate success criteria: feedback submission rate > 99.5%, no data loss\n* Monitor customer satisfaction score (target: +15% improvement)\n* Monitor average case resolution time (target: -20% improvement)\n* Support agents using unified Salesforce view across all channels\n\n===== D365 CE Retirement\n\n* D365 CE read-only access for historical Case lookups (if needed)\n* Decommission D365 CE infrastructure after 90 days\n* Archive D365 CE data for compliance/auditing\n\n===== Components Active\n\n- ProfileService (production)\n- EngagementService (production)\n- Event Bus (production)\n- Salesforce Production (system of record)\n- Braze (push notifications)\n- Mobile App (Salesforce integration)\n- App-specific database (deprecated, Contact data no longer updated)\n\n===== Success Criteria Achieved\n\n- All digital customer feedback routed to Salesforce\n- Support agents have unified customer view\n- D365 CE decommissioned\n- Customer satisfaction improved by 15%\n- Average case resolution time decreased by 20%\n- Zero data loss during transition\n\n=== Transition Dependencies\n\n[width=\"100%\",cols=\"40%,60%\",options=\"header\",]\n|===\n|Dependency |Owner/Status\n\n|*Salesforce production access*\n|Viva Energy Salesforce admin team - TBD\n\n|*Salesforce Case field mapping*\n|Viva Energy Salesforce admin team - TBD (map OTR feedback categories to Salesforce fields)\n\n|*Salesforce data isolation strategy*\n|Viva Energy Salesforce admin team - TBD (Record Types, queues, custom fields)\n\n|*Salesforce webhook configuration*\n|Viva Energy Salesforce admin team - TBD (Outbound Messages vs Platform Events)\n\n|*Event Bus infrastructure*\n|OTR Platform team - Existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis)\n\n|*Braze integration*\n|OTR Marketing team - Existing Braze account, EngagementService creates new campaigns\n\n|*Mobile App release window*\n|OTR Mobile team - Coordinate cutover timing with app release schedule\n\n|*App database access*\n|OTR Platform team - Read access for Contact migration\n\n|===\n\n=== Transition Validation Criteria\n\n==== Contact Migration Validation\n\n* 100% of app database Contacts migrated to Salesforce (zero data loss)\n* Email/phone/VCI matching accuracy > 95% (minimize duplicate Contacts)\n* ProfileService JIT lookups return correct Salesforce Contact IDs (smoke test sample)\n* Reconciliation report shows: X new Contacts created, Y existing Contacts updated\n\n==== Cutover Validation\n\n* Mobile App feedback submission success rate > 99.5% (including async Case creation)\n* End-to-end flow validated: Mobile App → ProfileService → EngagementService → Salesforce Case created\n* Braze push notifications delivered for Case creation and Case resolution\n* Event Bus queue depth within normal range (no backlog)\n* Dead letter queue empty (no failed Case creations)\n* Salesforce API rate limits not exceeded\n\n==== Production Monitoring (30 days)\n\n* Customer satisfaction score improves by 15% (compared to D365 CE baseline)\n* Average case resolution time decreases by 20% (Salesforce vs D365 CE)\n* Support agents confirm unified customer view across all channels\n* Zero critical incidents (P1 outages, data loss)\n\n=== Rollback Plan\n\n==== Rollback Triggers\n\n* Feedback submission success rate < 95% (below acceptable threshold)\n* Data loss or corruption detected in Salesforce\n* Salesforce API rate limits exceeded (Cases not created within SLA)\n* Critical bug blocking customer feedback submission\n\n==== Rollback Procedure\n\n1. **Revert Mobile App** to previous version (remove ProfileService/EngagementService integration, restore D365 CE integration)\n2. **Stop EngagementService** Case creation (prevent duplicate Cases in Salesforce)\n3. **Re-enable D365 CE** for customer feedback submission\n4. **Investigate root cause** (EngagementService logs, Salesforce API errors, Event Bus queue issues)\n5. **Fix and re-test** in sandbox environment\n6. **Retry cutover** when issues resolved\n\n==== Rollback Limitations\n\n* Cases created in Salesforce during cutover period remain in Salesforce (no reverse migration)\n* Contacts migrated to Salesforce remain (no rollback to app database)\n* Rollback only affects Mobile App integration (not data migration)\n\n=== Architectural Scope Boundaries\n\n==== Capabilities Included\n\n===== Business Capabilities\n\n* **Customer Feedback Submission**: Mobile App users can submit structured feedback (Category, Store Name, Time of Visit, Phone, Free Text Message) via EngagementService\n* **Customer Contact Management**: Just-In-Time (JIT) Contact reconciliation with Salesforce via ProfileService, ensuring every Mobile App user has a Salesforce Contact record\n* **Case Management Integration**: EngagementService creates Salesforce Cases asynchronously for customer feedback, support agents manage Cases in Salesforce Service Cloud\n* **Customer Notifications**: Push notifications via Braze when Cases are created, updated, or resolved (bidirectional integration: Mobile App → Salesforce → Mobile App)\n* **Unified Customer View**: Support agents see OTR digital customer feedback alongside other Viva Energy channels (fuel wholesale, Shell Card, retail) in single Salesforce instance\n* **Contact Data Migration**: One-time migration of app-specific customer database Contacts to Salesforce with upsert logic (email/phone/VCI matching)\n\n===== Technical Capabilities\n\n* **ProfileService Bounded Context**: First DDD bounded context implementation - JIT Contact reconciliation, Salesforce API facade, foundation for Flybuys integration\n* **EngagementService Bounded Context**: First DDD bounded context implementation - Customer feedback submission BFF, Anti-Corruption Layer for Salesforce, Braze integration orchestration\n* **Event-Driven Architecture**: Domain event publishing via Event Bus (SNS+SQS/EventBridge/Kinesis) for `SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted` events\n* **Async Processing Pattern**: Non-blocking Case creation with retry logic, exponential backoff, dead letter queue for operational resilience\n* **Anti-Corruption Layer Pattern**: EngagementService protects digital channels from Salesforce API changes, translates between OTR domain language and Salesforce\n* **Conformist Pattern**: ProfileService and EngagementService conform to existing Salesforce configuration (shared Viva Energy instance, multi-tenant governance)\n* **Salesforce Integration**: REST API integration for Contact CRUD and Case creation, webhook receiver for Case update notifications\n* **Braze Integration**: Push notification campaign triggers for Case lifecycle events (created, updated, resolved)\n* **Observability & Monitoring**: Dashboards, metrics, alerting for feedback submission rate, queue depth, API errors, Case creation latency\n* **Feature Flag Management**: Kill switches for emergency rollback (enable_salesforce_feedback_submission, enable_async_case_creation, etc.)\n\n==== Capabilities Excluded\n\n===== Business Capabilities Explicitly Out of Scope\n\n* **Historical Case Migration**: D365 CE Cases not migrated to Salesforce (ADR-CS-005 - fresh start, no Case migration)\n* **Multi-Channel Feedback Submission**: Web app, POS, call centre, email feedback channels not included (Mobile App only in this phase)\n* **Case Resolution by Digital Channels**: Support agents resolve Cases in Salesforce, not via Mobile App self-service\n* **Knowledge Base Integration**: Salesforce Knowledge Base articles not surfaced in Mobile App (future enhancement)\n* **Live Chat/Messaging**: Real-time chat support not included (Salesforce omnichannel capabilities not activated)\n* **Sentiment Analysis**: Automated feedback sentiment analysis not included (future enhancement with AI/ML)\n* **Customer Satisfaction Surveys**: Post-resolution CSAT surveys not included (separate initiative)\n* **Case Attachments**: Mobile App feedback submission does not support file uploads (photos, receipts) - text only\n* **Agent Desktop Integration**: Custom Salesforce UI for support agents not included (use standard Salesforce Service Console)\n* **Social Media Feedback**: Facebook, Twitter, Instagram feedback channels not integrated\n\n===== Technical Capabilities Explicitly Out of Scope\n\n* **Event Sourcing**: Domain events are ephemeral (not persisted for event sourcing/replay) - Event Bus only, no Event Store\n* **CQRS (Command Query Responsibility Segregation)**: ProfileService and EngagementService use same data model for reads/writes (no separate read models)\n* **Local Aggregate Persistence**: ProfileService and EngagementService are stateless (Salesforce is System of Record, no local database for Contact/Case)\n* **Saga Orchestration**: No distributed transactions or saga patterns required (single-step Case creation, not multi-step workflow)\n* **API Gateway Advanced Features**: Rate limiting, API versioning, API key management deferred to detailed design (basic routing only)\n* **GraphQL API**: ProfileService and EngagementService expose REST APIs only (GraphQL not required)\n* **Real-Time Sync**: Salesforce Contact updates by support agents not synced back to ProfileService (eventual consistency acceptable via JIT reconciliation)\n* **Multi-Region Deployment**: Single AWS region deployment (no multi-region failover/disaster recovery in this phase)\n* **Blue-Green Deployment**: Big bang cutover (ADR-CS-006), not blue-green or canary deployment strategy\n* **A/B Testing Framework**: Feature flags for rollback only, not for A/B testing or experimentation\n* **Custom Authentication**: Microsoft Entra External ID used for Mobile App authentication (no custom authentication logic in ProfileService/EngagementService)\n* **Data Residency Compliance**: Salesforce data residency governed by Viva Energy Salesforce configuration (no OTR-specific data residency requirements)\n\n===== Future Bounded Contexts Not in Scope\n\n* **LoyaltyService**: Flybuys integration, reward preferences, transaction adjudication (separate initiative)\n* **LocationService**: Store finder, proximity features, geofencing (separate initiative)\n* **PaymentService**: Payment processing, subscription billing (separate initiative)\n* **RecommendationService**: Personalized recommendations, next-best offers (separate initiative)\n\n===== Integration Patterns Not in Scope\n\n* **Shared Kernel**: No shared domain model between ProfileService and EngagementService (separate bounded contexts with clear boundaries)\n* **Partnership**: No joint development or coordination with external teams (Conformist pattern - we conform to Salesforce)\n* **Customer-Supplier (we're upstream)**: No downstream systems depend on ProfileService/EngagementService APIs yet (future bounded contexts will consume domain events)\n\n==== Architectural Dependencies on Future Initiatives\n\n*This Architecture Enables Future Initiatives*:\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Future Initiative |Architectural Enablement\n\n|*Flybuys Integration*\n|**ProfileService Contact Reconciliation Reused**: ProfileService establishes pattern for JIT Contact reconciliation with Salesforce, which will be extended for Flybuys partner linking (link:../architecture_definitions/flybuys_integration.adoc[see Flybuys Integration architecture]) +\n**Event Bus Infrastructure**: Domain event publishing pattern (`CustomerEnrolledInLoyalty`, `PartnerLinked`, etc.) reuses Event Bus established for EngagementService\n\n|*LoyaltyService Bounded Context*\n|**Event Bus Subscription**: LoyaltyService will consume `CustomerProfileCreated` events published by ProfileService (future enhancement) +\n**Salesforce Contact Integration**: LoyaltyService may query Salesforce Contacts for customer reward preferences (via ProfileService facade or direct Salesforce API)\n\n|*Web App Feedback Submission*\n|**EngagementService API Reuse**: Web app will call same EngagementService REST API for feedback submission (multi-channel support) +\n**Conformist Pattern**: Web app conforms to EngagementService API contract (no translation required)\n\n|*Multi-Channel Customer Support*\n|**EngagementService Extension**: Add support for email, call centre, POS feedback channels (extend EngagementService to handle multiple origins) +\n**Salesforce Case Origin Field**: Cases already tagged with Origin=Mobile App, extend to Origin=Web, POS, Call Centre, Email\n\n|*Knowledge Base Integration*\n|**EngagementService API Extension**: Add endpoint to query Salesforce Knowledge Base articles, surface in Mobile App for self-service support +\n**Anti-Corruption Layer**: EngagementService translates Salesforce Knowledge API to OTR domain language\n\n|*Customer Satisfaction Surveys*\n|**Event-Driven Trigger**: Subscribe to `SupportCaseResolved` events published by EngagementService, trigger CSAT survey via Braze +\n**Braze Integration Pattern**: Reuse EngagementService → Braze integration pattern for survey campaigns\n\n|*Sentiment Analysis*\n|**Event Subscription**: Subscribe to `CustomerFeedbackSubmitted` events, analyse feedback sentiment (AI/ML service) +\n**EngagementService Extension**: Enrich Case with sentiment score before creating in Salesforce\n\n|*RecommendationService Bounded Context*\n|**Event Subscription**: RecommendationService subscribes to `SupportCaseCreated` events to understand customer pain points and personalize recommendations +\n**Domain Event Pattern**: Reuse Event Bus publishing pattern established by EngagementService\n\n|===\n\n*This Architecture Depends on Future Initiatives*:\n\n[width=\"100%\",cols=\"30%,70%\",options=\"header\",]\n|===\n|Future Initiative |Dependency Description\n\n|*Salesforce Data Isolation Strategy*\n|**BLOCKER**: Viva Energy Salesforce admin team must define data isolation strategy (Record Types, custom fields, queues) before production deployment +\n**Impact**: Multi-tenant data visibility and security governance\n\n|*Salesforce Case Field Mapping*\n|**BLOCKER**: Viva Energy Salesforce admin team must define field mapping for OTR feedback categories (App, Service, Order, Rewards, Refund, Delete Account) +\n**Impact**: Case creation logic in EngagementService depends on finalized Salesforce schema\n\n|*Salesforce Webhook Mechanism*\n|**BLOCKER**: Viva Energy Salesforce admin team must configure webhook mechanism (Outbound Messages vs Platform Events vs Process Builder) for Case update notifications +\n**Impact**: EngagementService webhook receiver implementation depends on chosen mechanism\n\n|*Event Bus Technology Selection*\n|**DECISION REQUIRED**: Choose Event Bus implementation (SNS+SQS vs EventBridge vs Kinesis) for domain event publishing +\n**Impact**: Infrastructure provisioning, event schema design, consumer implementation\n\n|*Microservice Hosting Platform*\n|**DECISION REQUIRED**: Choose hosting platform for ProfileService and EngagementService (AWS Lambda vs ECS vs EKS) +\n**Impact**: Deployment architecture, auto-scaling strategy, operational overhead\n\n|*Observability Platform*\n|**DECISION REQUIRED**: Choose observability platform (AWS CloudWatch vs Datadog vs New Relic) for monitoring and alerting +\n**Impact**: Dashboard configuration, metric collection, alerting setup\n\n|===\n\n*Future Work After This Initiative*:\n\n* **Event Schema Registry**: Implement event schema versioning and registry for domain events (currently ad-hoc schemas)\n* **API Versioning Strategy**: Define API versioning approach for ProfileService and EngagementService (currently v1 only)\n* **Multi-Region Deployment**: Extend to multi-region for disaster recovery and global availability\n* **Event Store**: Persist domain events for event sourcing and audit trail (currently ephemeral Event Bus only)\n* **CQRS Pattern**: Separate read models for high-volume queries (currently same model for reads/writes)\n* **GraphQL API**: Expose GraphQL API for flexible client queries (currently REST only)\n* **Real-Time Sync**: Bi-directional sync between Salesforce and ProfileService for Contact updates (currently JIT reconciliation only)\n\n=== Technical Risks and Mitigation\n\n[width=\"100%\",cols=\"5%,20%,25%,25%,25%\",options=\"header\",]\n|===\n|ID |Risk |Impact |Likelihood |Mitigation\n\n|RISK-CS-001\n|*Salesforce API rate limits exceeded*: High feedback volume exceeds Salesforce API limits, Cases not created\n|HIGH (customers don't receive Case confirmation, support tickets lost)\n|MEDIUM (volume unknown, rate limits TBD)\n|• Gather expected feedback volume data before cutover +\n• Implement Event Bus queue throttling/rate limiting +\n• Monitor queue depth and API usage +\n• Scale background workers based on queue depth +\n• Alert ops team when approaching rate limits\n\n|RISK-CS-002\n|*Salesforce downtime*: Salesforce Service Cloud outage prevents Case creation\n|MEDIUM (Cases delayed but queued, customers wait for confirmation)\n|LOW (Salesforce SLA 99.9% uptime)\n|• Async Case creation with retry logic +\n• Event Bus queues buffer work during outage +\n• Customers get immediate \"Feedback submitted\" (not blocked) +\n• Monitor Salesforce status page, alert ops team +\n• Automatic retry when Salesforce recovers\n\n|RISK-CS-003\n|*Contact migration data quality issues*: App database Contact data incomplete or invalid\n|HIGH (migration fails validation, cutover delayed)\n|MEDIUM (legacy data quality unknown)\n|• Pre-migration data quality assessment +\n• Flexible upsert logic (match by email/phone/VCI) +\n• Validation report identifies data issues before production migration +\n• Manual cleanup for invalid records +\n• Dry-run migration in sandbox environment\n\n|RISK-CS-004\n|*Duplicate Contacts created*: Email matching fails, ProfileService creates duplicate Contacts\n|MEDIUM (support agents see multiple profiles for same customer)\n|MEDIUM (email changes, data quality issues)\n|• Salesforce duplicate detection rules (if available) +\n• ProfileService logs Contact creation for audit trail +\n• Manual duplicate cleanup process (support team) +\n• Future enhancement: VCI as Salesforce External ID for stable matching\n\n|RISK-CS-005\n|*Dead letter queue accumulation*: Failed Case creations not processed, queue grows\n|HIGH (customers don't receive Case confirmation, feedback lost)\n|LOW (retry logic handles most failures)\n|• Dead letter queue monitoring and alerting +\n• Ops team dashboard showing DLQ depth +\n• Manual intervention process (investigate and reprocess) +\n• Automated alerts when DLQ depth exceeds threshold +\n• Root cause analysis for recurring failures\n\n|RISK-CS-006\n|*Salesforce webhook failures*: Salesforce can't deliver Case update notifications to EngagementService\n|MEDIUM (customers don't get push notifications for Case resolution)\n|LOW (webhook mechanism reliable)\n|• Webhook retry logic and exponential backoff +\n• EngagementService logs webhook deliveries +\n• Monitor webhook delivery success rate +\n• Fallback: Poll Salesforce API for Case updates (if webhook fails persistently) +\n• Alert ops team when webhook delivery rate drops\n\n|RISK-CS-007\n|*Multi-tenant data isolation breach*: OTR digital Cases visible to other Viva Energy support teams\n|HIGH (privacy violation, compliance risk)\n|LOW (Salesforce governance controls)\n|• Work with Viva Energy Salesforce admin team on data isolation strategy +\n• Test data visibility in Salesforce sandbox (UAT with different user roles) +\n• Validate Record Types, queues, field-level security before production +\n• Audit Salesforce user permissions and sharing rules\n\n|RISK-CS-008\n|*Mobile App release coordination*: App release delayed, cutover window missed\n|MEDIUM (cutover delayed, D365 CE retirement delayed)\n|MEDIUM (release schedule conflicts)\n|• Coordinate cutover timing with Mobile team early +\n• Buffer time in migration plan (2-week contingency) +\n• Decouple backend deployment from Mobile App release (backend deployed first, app follows) +\n• Feature flag for feedback submission (enable when ready)\n\n|RISK-CS-009\n|*Event Bus infrastructure issues*: SNS/SQS/EventBridge downtime or misconfiguration\n|HIGH (Case creation blocked, domain events not published)\n|LOW (AWS SLA 99.99% uptime)\n|• Leverage existing AWS infrastructure (proven, reliable) +\n• Infrastructure as Code (IaC) for Event Bus configuration +\n• Integration testing in non-production environment +\n• Monitor Event Bus metrics (queue depth, throughput, errors) +\n• Alert ops team on Event Bus failures\n\n|RISK-CS-010\n|*Team DDD knowledge gap*: Team unfamiliar with DDD patterns, bounded contexts, event-driven architecture\n|MEDIUM (implementation delays, architectural inconsistencies)\n|HIGH (first DDD implementation)\n|• DDD training for development team (workshops, documentation) +\n• Architecture review sessions (validate bounded context design) +\n• Pair programming with experienced DDD practitioners +\n• Incremental implementation (start small, iterate) +\n• Document architectural patterns in CLAUDE.md\n\n|===\n\n== Assumptions and Constraints\n\n=== Assumptions\n\n[width=\"100%\",cols=\"8%,92%\",options=\"header\",]\n|===\n|ID |Assumption\n\n|ASM-CS-001\n|Viva Energy Salesforce admin team will provide Salesforce production access, sandbox environment, and support for Case field mapping and data isolation configuration\n\n|ASM-CS-002\n|App database Contact data is sufficiently complete for migration (email/phone/VCI available for matching)\n\n|ASM-CS-003\n|Expected customer feedback volume (100-150 submissions/day from 20k DAU) is well within Salesforce API rate limits, with capacity planning for 3x-10x growth\n\n|ASM-CS-004\n|Existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis) is sufficient for Event Bus implementation (no additional infrastructure provisioning required)\n\n|ASM-CS-005\n|Braze integration already exists and can be extended for Case-related push notifications (no new Braze account or major configuration changes)\n\n|ASM-CS-006\n|Mobile App users have email addresses associated with their accounts (required for ProfileService Contact reconciliation)\n\n|ASM-CS-007\n|D365 Customer Engagement historical Cases have limited business value and do not require migration to Salesforce\n\n|ASM-CS-008\n|Support agents are trained on Salesforce Service Cloud and require minimal additional training for OTR digital customer Cases\n\n|ASM-CS-009\n|Salesforce Service Cloud shared instance has capacity for OTR digital customer Contacts and Cases (no additional licensing or storage costs)\n\n|ASM-CS-010\n|Mobile App release schedule can accommodate cutover timing (Week 10 in migration plan)\n\n|===\n\n=== Constraints\n\n[width=\"100%\",cols=\"8%,92%\",options=\"header\",]\n|===\n|ID |Constraint\n\n|CON-CS-001\n|Must use shared Viva Energy Salesforce Service Cloud instance (cannot deploy separate OTR-specific instance)\n\n|CON-CS-002\n|Must conform to existing Salesforce configuration and governance (Record Types, custom fields, queues, data isolation strategy defined by Viva Energy admin team)\n\n|CON-CS-003\n|Contact migration must complete before Mobile App cutover (no parallel run of D365 CE and Salesforce)\n\n|CON-CS-004\n|Big bang cutover only (no phased rollout with feature flags or pilot users)\n\n|CON-CS-005\n|Salesforce API rate limits and authentication method constrained by Viva Energy Salesforce configuration (TBD)\n\n|CON-CS-006\n|Event Bus implementation must use existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis - cannot introduce new infrastructure components)\n\n|CON-CS-007\n|Mobile App feedback form must include specific fields: Category, Store Name, Time of Visit, Contact Phone Number, Free Text Message (no attachments)\n\n|CON-CS-008\n|D365 Customer Engagement must be decommissioned within 90 days post-cutover (ADR-CS-006)\n\n|CON-CS-009\n|ProfileService and EngagementService must be stateless (no local aggregate persistence, Salesforce is System of Record)\n\n|CON-CS-010\n|First DDD bounded context implementation (team learning curve, architectural patterns must be documented for future bounded contexts)\n\n|===\n\n== Non-Functional Requirements\n\n=== Performance Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-PERF-001\n|Mobile App feedback submission API response time (ProfileService + EngagementService)\n|p95 < 1 second, p99 < 2 seconds\n\n|NFR-PERF-002\n|ProfileService Contact reconciliation API response time (JIT lookup)\n|p95 < 500ms, p99 < 1 second\n\n|NFR-PERF-003\n|EngagementService async Case creation latency (end-to-end: feedback submitted → Case created in Salesforce)\n|p95 < 5 minutes, p99 < 10 minutes\n\n|NFR-PERF-004\n|Salesforce API call latency (Contact query, Contact create, Case create)\n|p95 < 2 seconds, p99 < 5 seconds\n\n|NFR-PERF-005\n|Event Bus message processing throughput\n|> 100 messages/second (support peak feedback volume)\n\n|NFR-PERF-006\n|Braze push notification delivery latency (Case created → notification delivered)\n|p95 < 30 seconds, p99 < 60 seconds\n\n|===\n\n=== Availability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-AVAIL-001\n|ProfileService availability\n|99.9% uptime (8.76 hours downtime/year)\n\n|NFR-AVAIL-002\n|EngagementService availability\n|99.9% uptime (8.76 hours downtime/year)\n\n|NFR-AVAIL-003\n|Feedback submission success rate (including async Case creation)\n|> 99.5% (includes retry logic for transient failures)\n\n|NFR-AVAIL-004\n|Graceful degradation: Salesforce downtime handling\n|Feedback submission still succeeds, Cases queued for async creation when Salesforce recovers\n\n|NFR-AVAIL-005\n|Graceful degradation: Braze downtime handling\n|Case creation proceeds, push notifications disabled temporarily (feature flag)\n\n|NFR-AVAIL-006\n|Planned maintenance window\n|< 4 hours/month, scheduled during low-traffic periods (2-6am ACST)\n\n|===\n\n=== Scalability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-SCALE-001\n|Concurrent Mobile App users (peak)\n|Support 20,000 DAU (Daily Active Users), ~150 concurrent users submitting feedback during peak hours\n\n|NFR-SCALE-002\n|Feedback submissions per day\n|Expected: 100-150 submissions/day based on 20k DAU (~0.5-0.75% submission rate) +\nCapacity: Support 500 submissions/day (3x expected volume for growth), 2,000 submissions/day (peak/incident scenarios)\n\n|NFR-SCALE-003\n|Auto-scaling: ProfileService and EngagementService\n|Auto-scale based on CPU/memory/request rate, scale up within 2 minutes\n\n|NFR-SCALE-004\n|Event Bus queue capacity\n|Support 100,000 queued messages (buffer for Salesforce downtime)\n\n|NFR-SCALE-005\n|Salesforce API rate limit compliance\n|Stay within 80% of Salesforce API rate limits (buffer for spikes)\n\n|NFR-SCALE-006\n|Future growth capacity\n|Architecture supports 10x growth (1,000-1,500 submissions/day based on 200k DAU) without major redesign\n\n|===\n\n=== Security Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-SEC-001\n|Mobile App authentication\n|Microsoft Entra External ID OAuth 2.0 with JWT tokens (existing CIAM)\n\n|NFR-SEC-002\n|API authorisation: ProfileService and EngagementService\n|JWT token validation, authenticated users only, user context propagation\n\n|NFR-SEC-003\n|Salesforce API authentication\n|OAuth 2.0 with Connected App and JWT bearer flow (service account)\n\n|NFR-SEC-004\n|Data encryption in transit\n|TLS 1.2+ for all API calls (Mobile App ↔ ProfileService/EngagementService ↔ Salesforce ↔ Braze)\n\n|NFR-SEC-005\n|Data encryption at rest\n|Salesforce encryption at rest (managed by Salesforce), Event Bus message encryption (AWS KMS)\n\n|NFR-SEC-006\n|Secret management\n|AWS Secrets Manager for Salesforce credentials, Braze API keys, OAuth tokens (no hardcoded secrets)\n\n|NFR-SEC-007\n|PII data handling\n|Contact data (email, phone, name) treated as PII, GDPR-compliant retention policies (Salesforce governance)\n\n|NFR-SEC-008\n|API rate limiting and throttling\n|API Gateway rate limiting (100 requests/second per user), prevent abuse and DoS\n\n|NFR-SEC-009\n|Logging and auditing\n|Log all API calls, Salesforce Contact/Case creates/updates, Event Bus publishes (no PII in logs)\n\n|NFR-SEC-010\n|Salesforce data isolation\n|Multi-tenant data isolation via Salesforce Record Types, queues, sharing rules (defined by Viva Energy admin team)\n\n|===\n\n=== Reliability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-REL-001\n|Retry logic: EngagementService → Salesforce Case creation\n|Exponential backoff (1s, 2s, 4s, 8s, 16s), max 5 retries, then dead letter queue\n\n|NFR-REL-002\n|Dead letter queue monitoring\n|Alert ops team immediately when DLQ depth > 0 (failed Case creations require manual intervention)\n\n|NFR-REL-003\n|Event Bus message durability\n|Messages persisted in Event Bus (SNS+SQS/EventBridge/Kinesis), not lost on service restart\n\n|NFR-REL-004\n|Idempotency: Case creation\n|EngagementService ensures duplicate feedback submissions don't create duplicate Cases (idempotency key)\n\n|NFR-REL-005\n|Circuit breaker: Salesforce API calls\n|Open circuit after 5 consecutive failures, half-open retry after 30 seconds\n\n|NFR-REL-006\n|Health checks: ProfileService and EngagementService\n|Health endpoints for load balancer checks, readiness and liveness probes\n\n|NFR-REL-007\n|Disaster recovery: Event Bus\n|Event Bus messages replicated across AWS availability zones (SQS/EventBridge/Kinesis HA)\n\n|===\n\n=== Maintainability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-MAINT-001\n|Code quality: ProfileService and EngagementService\n|> 80% test coverage (unit + integration tests), automated CI/CD pipeline\n\n|NFR-MAINT-002\n|API documentation\n|OpenAPI/Swagger specs for ProfileService and EngagementService, auto-generated API docs\n\n|NFR-MAINT-003\n|Deployment automation\n|Infrastructure as Code (Terraform/CloudFormation/CDK), zero-downtime deployments\n\n|NFR-MAINT-004\n|Logging: structured logs\n|JSON-formatted logs with correlation IDs, log levels (DEBUG, INFO, WARN, ERROR), centralized log aggregation\n\n|NFR-MAINT-005\n|Monitoring dashboards\n|Real-time dashboards for ProfileService, EngagementService, Event Bus (see Monitoring and Observability section)\n\n|NFR-MAINT-006\n|Alerting and on-call\n|PagerDuty/Opsgenie integration for P1/P2 alerts, on-call rotation for ops team\n\n|NFR-MAINT-007\n|Configuration management\n|Externalized configuration (environment variables, AWS Parameter Store), no hardcoded config\n\n|NFR-MAINT-008\n|Versioning: API and events\n|Semantic versioning (v1, v2), backward compatibility for API changes, event schema evolution\n\n|===\n\n=== Usability Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-USE-001\n|Feedback submission UX\n|Mobile App user receives immediate \"Feedback submitted\" confirmation (< 1 second), not blocked by async Case creation\n\n|NFR-USE-002\n|Push notification delivery\n|Customer receives \"Your feedback has been received\" notification within 30 seconds of Case creation in Salesforce\n\n|NFR-USE-003\n|Case resolution notification\n|Customer receives \"Your case has been resolved\" notification within 30 seconds of support agent resolving Case\n\n|NFR-USE-004\n|Error messaging\n|User-friendly error messages for failed feedback submission (not technical errors), retry prompts\n\n|NFR-USE-005\n|Accessibility\n|Mobile App feedback form meets WCAG 2.1 AA accessibility standards (existing Mobile App compliance)\n\n|===\n\n=== Compliance Requirements\n\n[width=\"100%\",cols=\"10%,45%,45%\",options=\"header\",]\n|===\n|ID |Requirement |Target\n\n|NFR-COMP-001\n|GDPR compliance: PII data\n|Customer Contact data (email, phone, name) managed per GDPR retention policies (Salesforce governance)\n\n|NFR-COMP-002\n|GDPR compliance: Right to erasure\n|Support \"Delete Account\" feedback category, trigger Contact deletion in Salesforce per GDPR Article 17\n\n|NFR-COMP-003\n|Data residency\n|Salesforce data residency governed by Viva Energy Salesforce configuration (regional compliance)\n\n|NFR-COMP-004\n|Audit trail\n|All Contact creates/updates, Case creates/updates logged for compliance auditing (Salesforce audit logs)\n\n|NFR-COMP-005\n|API security standards\n|OWASP API Security Top 10 compliance (injection prevention, authentication, authorisation, data exposure)\n\n|===\n\n== Monitoring and Observability\n\n=== Key Metrics\n\n[width=\"100%\",cols=\"25%,40%,35%\",options=\"header\",]\n|===\n|Metric Category |Metric |Target/Threshold\n\n|*Feedback Submission*\n|Feedback submission success rate (Mobile App → EngagementService)\n|> 99.5%\n\n|*Async Case Creation*\n|Case creation success rate (EngagementService → Salesforce)\n|> 99%\n\n|*Async Case Creation*\n|Case creation latency (time from feedback submission to Case created in Salesforce)\n|p95 < 5 minutes\n\n|*Event Bus*\n|Event Bus queue depth (pending Case creations)\n|< 100 messages\n\n|*Event Bus*\n|Dead letter queue depth (failed Case creations)\n|= 0 (alert on any failures)\n\n|*Salesforce API*\n|Salesforce API error rate\n|< 1%\n\n|*Salesforce API*\n|Salesforce API latency (Case creation)\n|p95 < 2 seconds\n\n|*Salesforce API*\n|Salesforce API rate limit utilization\n|< 80% of limit\n\n|*ProfileService*\n|Contact reconciliation success rate (JIT lookups)\n|> 99.5%\n\n|*ProfileService*\n|Contact reconciliation latency\n|p95 < 500ms\n\n|*Braze Notifications*\n|Push notification delivery rate (Case created/updated)\n|> 95%\n\n|*Salesforce Webhook*\n|Webhook delivery success rate (Salesforce → EngagementService)\n|> 99%\n\n|*Customer Satisfaction*\n|Customer satisfaction score (CSAT)\n|> 4.0/5.0 (improve by 15% from D365 CE baseline)\n\n|*Support Operations*\n|Average case resolution time\n|Decrease by 20% from D365 CE baseline\n\n|===\n\n=== Alerting Thresholds\n\n[width=\"100%\",cols=\"25%,50%,25%\",options=\"header\",]\n|===\n|Alert |Condition |Severity\n\n|*Feedback submission failures*\n|Feedback submission success rate < 95% over 5-minute window\n|P1 - Critical\n\n|*Dead letter queue accumulation*\n|Dead letter queue depth > 0 (any failed Case creations)\n|P2 - High\n\n|*Event Bus queue backlog*\n|Event Bus queue depth > 100 messages for > 15 minutes\n|P2 - High\n\n|*Salesforce API errors*\n|Salesforce API error rate > 5% over 5-minute window\n|P1 - Critical\n\n|*Salesforce API rate limits*\n|Salesforce API rate limit utilization > 90%\n|P2 - High\n\n|*Contact reconciliation failures*\n|ProfileService Contact reconciliation failure rate > 5% over 5-minute window\n|P2 - High\n\n|*Braze notification failures*\n|Braze push notification delivery rate < 80% over 15-minute window\n|P3 - Medium\n\n|*Salesforce webhook failures*\n|Salesforce webhook delivery success rate < 90% over 15-minute window\n|P2 - High\n\n|*Case creation latency*\n|Case creation latency p95 > 10 minutes\n|P3 - Medium\n\n|===\n\n=== Dashboards\n\n*ProfileService Dashboard:*\n\n* Contact reconciliation success rate (JIT lookups)\n* Contact reconciliation latency (p50, p95, p99)\n* Contact creation vs update ratio (new Contacts created vs existing Contacts updated)\n* Salesforce API error rate (Contact queries and creates)\n* Request rate and throughput\n\n*EngagementService Dashboard:*\n\n* Feedback submission success rate\n* Case creation success rate (async workflow)\n* Case creation latency (p50, p95, p99)\n* Event Bus queue depth (pending Case creations)\n* Dead letter queue depth (failed Case creations)\n* Salesforce API error rate (Case creation)\n* Salesforce API latency\n* Salesforce API rate limit utilization\n* Braze push notification delivery rate\n* Salesforce webhook delivery success rate\n\n*Event Bus Dashboard:*\n\n* Queue depth (pending messages)\n* Throughput (messages published/consumed per minute)\n* Dead letter queue depth (failed messages)\n* Consumer lag (time between publish and consume)\n\n*Customer Support Dashboard (Business Metrics):*\n\n* Total feedback submissions per day/week/month\n* Feedback category breakdown (App, Service, Order, Rewards, Refund, Delete Account)\n* Customer satisfaction score (CSAT) trend\n* Average case resolution time trend\n* Case volume by support team/queue\n* Unified customer view adoption (support agent feedback)\n<<<\n== Solution Validation\n\nThis section defines the validation criteria and testing approach for the solution.\n\n=== Functional Validation\n\n==== ProfileService API Testing\n\n*Test Scenarios*:\n1. **Happy Path**: Authenticated user requests Contact ID, existing Contact found in Salesforce, Contact ID returned\n2. **JIT Creation**: Authenticated user requests Contact ID, no existing Contact, new Contact created in Salesforce, Contact ID returned\n3. **Salesforce API Failure**: Salesforce unavailable, ProfileService returns 500 error, user retries\n4. **Invalid JWT**: Unauthenticated request, ProfileService returns 401 error\n\n*Acceptance Criteria*:\n- Contact reconciliation success rate > 99.5%\n- JIT Contact creation completes within 500ms (p95)\n\n==== EngagementService API Testing\n\n*Test Scenarios*:\n1. **Happy Path**: Valid feedback submission, immediate 202 Accepted response, Case created in Salesforce within 5 minutes, Braze notification delivered\n2. **Invalid Category**: Invalid feedback category, 400 Bad Request response with validation error\n3. **Salesforce Downtime**: Salesforce unavailable during async Case creation, message queued, retry logic executes, Case created when Salesforce recovers\n4. **Dead Letter Queue**: Case creation fails after 5 retries, message moved to DLQ, ops team alerted\n5. **Webhook Notification**: Support agent resolves Case in Salesforce, webhook triggers EngagementService, Braze push notification sent to customer\n\n*Acceptance Criteria*:\n- Feedback submission success rate > 99.5% (including async Case creation)\n- Async Case creation completes within 5 minutes (p95)\n- Webhook delivery success rate > 99%\n\n=== Non-Functional Validation\n\n==== Performance Testing\n\n*Load Testing*:\n\n*Baseline*: Expected 100-150 submissions/day from 20k DAU (~0.5-0.75% submission rate)\n\n- **Normal Load**: 1 submission/minute sustained for 2 hours (simulate typical daily pattern)\n- **3x Load**: 3 submissions/minute sustained for 1 hour (simulate busy period, 450 submissions/day)\n- **Peak Load (10x)**: 10 submissions/minute for 15 minutes (simulate incident scenario, app outage causing backlog)\n- **Stress Test**: 50 submissions/minute for 5 minutes (find breaking point, 20x normal)\n\n*Validation*:\n- API response time p95 < 1 second under 10x load\n- Event Bus queue depth remains manageable (< 100 messages)\n- No Case creation failures, all submissions processed successfully\n- Auto-scaling triggers appropriately for sustained load > 3x baseline\n\n*Acceptance Criteria*:\n- NFR-PERF-001 through NFR-PERF-006 validated under realistic load (3x and 10x baseline)\n- Auto-scaling triggers within 2 minutes of load increase\n- System handles 10x peak gracefully, 20x stress test identifies limits\n\n==== Resilience Testing\n\n*Salesforce API Failure Scenarios*:\n1. **Complete Outage**: Salesforce unavailable for 2 hours, Event Bus queues buffer work, Cases created when Salesforce recovers\n2. **Rate Limit Exceeded**: Salesforce rate limit hit, queue throttling activates, Cases created within SLA\n\n*Acceptance Criteria*:\n- NFR-AVAIL-004 validated (graceful degradation during Salesforce downtime)\n- Circuit breaker activates after 5 consecutive failures\n\n==== Security Validation\n\n*Penetration Testing*:\n- API authentication bypass attempts\n- SQL injection attempts\n- Webhook signature validation bypass\n\n*Acceptance Criteria*:\n- NFR-SEC-001 through NFR-SEC-010 validated\n- OWASP API Security Top 10 compliance verified\n\n=== Integration Validation\n\n==== End-to-End Testing\n\n*Full User Journey*:\n1. User authenticates via Microsoft Entra External ID\n2. Mobile App requests Contact ID from ProfileService (JIT reconciliation)\n3. User submits feedback via EngagementService\n4. Background worker creates Case in Salesforce\n5. Braze notification delivered to user\n6. Support agent resolves Case in Salesforce\n7. Salesforce webhook triggers EngagementService\n8. Braze notification delivered to user\n\n*Acceptance Criteria*:\n- End-to-end flow completes successfully in UAT\n- User receives both \"feedback submitted\" and \"case resolved\" notifications\n","structuredPatch":[{"oldStart":2228,"oldLines":13,"newStart":2228,"newLines":13,"lines":[" "," The critical path for this project is:"," ","-. WP-CS-003 (Event Bus Infrastructure)","-. WP-CS-002 (EngagementService Development) - blocks on WP-CS-003","-. WP-CS-005 (Mobile App Integration) - blocks on WP-CS-001, WP-CS-002","-. WP-CS-006 (Integration Testing) - blocks on WP-CS-001 through WP-CS-005, WP-CS-007","-. WP-CS-008 (Contact Data Migration) - blocks on WP-CS-006 UAT sign-off","-. WP-CS-009 (Production Deployment) - blocks on WP-CS-008","-. WP-CS-010 (Post-Cutover Support) - final deliverable","+. <<wp-cs-003,WP-CS-003>> (Event Bus Infrastructure)","+. <<wp-cs-002,WP-CS-002>> (EngagementService Development) - blocks on <<wp-cs-003,WP-CS-003>>","+. <<wp-cs-005,WP-CS-005>> (Mobile App Integration) - blocks on <<wp-cs-001,WP-CS-001>>, <<wp-cs-002,WP-CS-002>>","+. <<wp-cs-006,WP-CS-006>> (Integration Testing) - blocks on <<wp-cs-001,WP-CS-001>> through <<wp-cs-005,WP-CS-005>>, <<wp-cs-007,WP-CS-007>>","+. <<wp-cs-008,WP-CS-008>> (Contact Data Migration) - blocks on <<wp-cs-006,WP-CS-006>> UAT sign-off","+. <<wp-cs-009,WP-CS-009>> (Production Deployment) - blocks on <<wp-cs-008,WP-CS-008>>","+. <<wp-cs-010,WP-CS-010>> (Post-Cutover Support) - final deliverable"," "," Any delays in critical path work packages will delay the overall cutover date."," "]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"83612c8e-1205-4e65-b774-1bfbef099025"}
{"parentUuid":"791ddbdc-2945-4205-b516-c1af6e082b77","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01G5nPhDR3JuS1me7P2rjBk3","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Excellent! Now let me check if there are any more references throughout the document. Let me search for any remaining plain text references that might have been missed.","signature":"EtECCkYICxgCKkA9WvbnmyldVw3vJnYNVknyorfOYXFm9CbNED0T72bD6S4O5exEnEX6Uy0HejOChGnbh5aBh3Kt6C7cbyW3OoEJEgz1YfK03f46LjivIM0aDPBkDtm7jPaBqr3oVCIwEDPEcRm6S+XUpD7XYHGLVrqo+bXHrYdcnSky/wfZ8j8oOUioOURP1CwCLYt5/ywOKrgBxXqqPUR9BRwT/EuqunKBIarFqUOnGmEUVzTiNVyUwiExiL0rAbtRSVIoWuZa78TTuwMSeGtsRvOhIzhsiZKDKneelaIADo56NbnciUMhDU37/V7GILX46DxOG3WAyfLrSEvlpEa9dVbNAcCY+fDLn/KCEEd1OtOuvNN7L0vEFPJPyM/WzytVyBOluKSjOzDNODEvag+6uj9oZEnRHuryFejmDC6KzsbGxNeyD2lNgCf7An8kJ2GBnRgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":1276,"cache_read_input_tokens":49049,"cache_creation":{"ephemeral_5m_input_tokens":1276,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CWw5DEkP6UwwtjG6S1gER","type":"assistant","uuid":"0ee4f10f-6e29-4ce1-beda-e941f52ff629","timestamp":"2026-01-09T03:12:38.185Z"}
{"parentUuid":"0ee4f10f-6e29-4ce1-beda-e941f52ff629","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01G5nPhDR3JuS1me7P2rjBk3","type":"message","role":"assistant","content":[{"type":"text","text":"Let me check if there are any other work package references I might have missed."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":1276,"cache_read_input_tokens":49049,"cache_creation":{"ephemeral_5m_input_tokens":1276,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CWw5DEkP6UwwtjG6S1gER","type":"assistant","uuid":"3ec65e23-88bd-41f3-bf1a-26f7fe883510","timestamp":"2026-01-09T03:12:38.800Z"}
{"parentUuid":"3ec65e23-88bd-41f3-bf1a-26f7fe883510","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01G5nPhDR3JuS1me7P2rjBk3","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_016bMfWhjWoPMpjHt9bq7hKF","name":"Grep","input":{"pattern":"(?&lt;!&lt;&lt;wp-cs-)\\bWP-CS-\\d{3}\\b","path":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc","output_mode":"content","-n":true}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":1276,"cache_read_input_tokens":49049,"cache_creation":{"ephemeral_5m_input_tokens":1276,"ephemeral_1h_input_tokens":0},"output_tokens":218,"service_tier":"standard"}},"requestId":"req_011CWw5DEkP6UwwtjG6S1gER","type":"assistant","uuid":"c48a53c1-d81d-4d93-b2bb-825762ca7b75","timestamp":"2026-01-09T03:12:40.542Z"}
{"parentUuid":"c48a53c1-d81d-4d93-b2bb-825762ca7b75","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_016bMfWhjWoPMpjHt9bq7hKF","type":"tool_result","content":"No matches found"}]},"uuid":"403dcd20-9354-4642-8305-6c250e353f78","timestamp":"2026-01-09T03:12:41.784Z","toolUseResult":{"mode":"content","numFiles":0,"filenames":[],"content":"","numLines":0},"sourceToolAssistantUUID":"c48a53c1-d81d-4d93-b2bb-825762ca7b75"}
{"parentUuid":"403dcd20-9354-4642-8305-6c250e353f78","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01Ewofa7o9PZYey9716yCx8a","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Hmm, that regex might not have worked correctly. Let me try a different approach - just search for WP-CS- and see what's left.","signature":"EqcCCkYICxgCKkCL32FIYEGrHOLldtdnrBbknbjY7K7hCVPYvzFkaQPr2joc49WC+Oo4aUOsvnxMsHHYesmg1R3RY0EiriR1a3FnEgxQV1kVwEAOORNXWI8aDCo6Cp72VW1d7xKdgiIwYM+sJi9iTe9XAMIoa7uNozFIq0sYXdvtpwnXRe7ysXKOfM9h9uT1otFiIxHABHscKo4Bd999jzm/9LdXlPb+hji6DmKr+mvquPyOMrtyg/v67BAh9JPJ6bjqlJO2trtX/DZ/r4oOL98oNUbro2f7qfr9zxTD/x/KFWfVQ8O3fQINbRdwz7axz246PX9aYfFYB4e1Wv8C+u4Ha9uT1wWqTO4jbIzwoXC6r5xeNm6tzYpxgGhA8xUGjSShMF1lPBt96xgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":240,"cache_read_input_tokens":50325,"cache_creation":{"ephemeral_5m_input_tokens":240,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CWw5Dm33GXEE1DtuWojDj","type":"assistant","uuid":"2da04c7a-d631-46a6-b3cc-b129d33a76ca","timestamp":"2026-01-09T03:12:46.627Z"}
{"parentUuid":"2da04c7a-d631-46a6-b3cc-b129d33a76ca","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01Ewofa7o9PZYey9716yCx8a","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01B8ZzYhtSzapE3n69UDLRVR","name":"Bash","input":{"command":"grep -n \"WP-CS-\" /mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc | grep -v \"<<wp-cs-\" | head -20","description":"Find remaining non-linked WP-CS references"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":240,"cache_read_input_tokens":50325,"cache_creation":{"ephemeral_5m_input_tokens":240,"ephemeral_1h_input_tokens":0},"output_tokens":173,"service_tier":"standard"}},"requestId":"req_011CWw5Dm33GXEE1DtuWojDj","type":"assistant","uuid":"c7e48a11-1900-42d9-bc22-9fee5bcafd96","timestamp":"2026-01-09T03:12:47.848Z"}
{"parentUuid":"c7e48a11-1900-42d9-bc22-9fee5bcafd96","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01B8ZzYhtSzapE3n69UDLRVR","type":"tool_result","content":"1483:|WP-CS-001\n1488:|WP-CS-002\n1493:|WP-CS-003\n1498:|WP-CS-004\n1503:|WP-CS-005\n1508:|WP-CS-006\n1513:|WP-CS-007\n1518:|WP-CS-008\n1523:|WP-CS-009\n1528:|WP-CS-010\n1536:=== WP-CS-001: ProfileService Development\n1590:=== WP-CS-002: EngagementService Development\n1665:=== WP-CS-003: Event Bus Infrastructure\n1727:=== WP-CS-004: Contact Migration Tooling\n1791:=== WP-CS-005: Mobile App Integration\n1858:=== WP-CS-006: Integration Testing\n1929:=== WP-CS-007: Salesforce Configuration\n2002:=== WP-CS-008: Contact Data Migration\n2069:=== WP-CS-009: Production Deployment\n2137:=== WP-CS-010: Post-Cutover Support","is_error":false}]},"uuid":"f78706b4-55d9-4266-b1e3-40e92a2745b3","timestamp":"2026-01-09T03:12:48.617Z","toolUseResult":{"stdout":"1483:|WP-CS-001\n1488:|WP-CS-002\n1493:|WP-CS-003\n1498:|WP-CS-004\n1503:|WP-CS-005\n1508:|WP-CS-006\n1513:|WP-CS-007\n1518:|WP-CS-008\n1523:|WP-CS-009\n1528:|WP-CS-010\n1536:=== WP-CS-001: ProfileService Development\n1590:=== WP-CS-002: EngagementService Development\n1665:=== WP-CS-003: Event Bus Infrastructure\n1727:=== WP-CS-004: Contact Migration Tooling\n1791:=== WP-CS-005: Mobile App Integration\n1858:=== WP-CS-006: Integration Testing\n1929:=== WP-CS-007: Salesforce Configuration\n2002:=== WP-CS-008: Contact Data Migration\n2069:=== WP-CS-009: Production Deployment\n2137:=== WP-CS-010: Post-Cutover Support","stderr":"","interrupted":false,"isImage":false},"sourceToolAssistantUUID":"c7e48a11-1900-42d9-bc22-9fee5bcafd96"}
{"parentUuid":"f78706b4-55d9-4266-b1e3-40e92a2745b3","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01Q6LqLBv3khRbkzmPRgxnsG","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Perfect! The remaining references are:\n1. The table rows (lines 1483-1533) - these should stay as plain text in the table\n2. The heading titles themselves (lines 1536, 1590, etc.) - these should also stay as plain text\n\nSo I've successfully converted all the narrative references to xrefs. The only remaining plain text references are in the table and in the section headings themselves, which is correct.\n\nLet me mark the todo as completed and we're done!","signature":"EusECkYICxgCKkDe3U1TQU/qrmH7z5Jh7eeiPBT4kGZQVN0gBMtxUXCNyVu+b/Jt/DfFgD1XHPa7/BkrXaoa2n7cBsTN0tkiD079EgyXNlMGo+uEq8hkBXUaDIxmDxi/3CGpuBwKEyIwRKVzBgJJf95zqeQ76VRxDJ6U6y++E4rQJRllfWw+QAsvFuza61GIJ1bDG9GxsIK8KtIDcUcHeKwyK0Jn7xrGtz3wYdZOXHcFrTdCJdUx9YHVG9OwQdY3Zq8zfVVafM+nY0OtGCU4a24pIyMyC4yQLozK5tK/1nrkh3Ns1iRfN9pI62Qk3SQoxyZrKPm7qs97G3hID1xCqloGYMgHA7eflr+5AOc3sZDFXbdbAvHjNx/wclV8ETV7VxlX/MNWpdsZ9hL4u8rkQKdEyCtBiBrUqoge21AQ/mCYa79vCeWEvXbVyf7sU47r91+jjV0NYXjbAHXR+0rz2bqNh391PiPdxH1WsBMrHYz8PdSkLmdLr5DwImIFOWWO/yT/TYiH5WrRHZYFzxgLcMUOskWSbLAGI+CMPj0NBwhtfx9beBsBoVnts/vm/5ClHD+cQjSf4/Hjq31IvJEXrhTUZR9osOXewJepQ57Ovhj6Lh8pRyFaTgjRcUbqFwpoNZT8GsFiSI08ulSRzD73DGNcFP38REww6EDDfQlXDPMZMX9ClWqIlhVSIL35OxtQWtzEB6nH2KMwQMeqiXYig7MSEETefeU5PZcUSPCdgQwz7PJ8ITwIXlBNG/z0YYA0lE4hJbdiWxyLn7OeIEzJ8nDFLIiDRlam+iFqdG/xElGrb9rFy6PrHOeWEFKZYRgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":459,"cache_read_input_tokens":50565,"cache_creation":{"ephemeral_5m_input_tokens":459,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWw5EGqv6q6KwRGMF9GDK","type":"assistant","uuid":"dcfcbba4-2a8b-4ef9-b3d5-2aec157c614c","timestamp":"2026-01-09T03:12:55.122Z"}
{"parentUuid":"dcfcbba4-2a8b-4ef9-b3d5-2aec157c614c","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01Q6LqLBv3khRbkzmPRgxnsG","type":"message","role":"assistant","content":[{"type":"text","text":"Perfect! All the work package references in the dependencies and sequencing sections have been converted to cross-links. The remaining plain text references are in the overview table and the section headings themselves, which should stay as plain text."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":459,"cache_read_input_tokens":50565,"cache_creation":{"ephemeral_5m_input_tokens":459,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWw5EGqv6q6KwRGMF9GDK","type":"assistant","uuid":"186f7db3-f2a6-470b-a9de-b36007aa4ff2","timestamp":"2026-01-09T03:12:56.362Z"}
{"parentUuid":"186f7db3-f2a6-470b-a9de-b36007aa4ff2","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01Q6LqLBv3khRbkzmPRgxnsG","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_018dTbSAhh9kHPETuhzy8gPh","name":"TodoWrite","input":{"todos":[{"content":"Add anchor IDs to all 10 work package headings","activeForm":"Adding anchor IDs to work package headings","status":"completed"},{"content":"Convert plain text work package references to xrefs","activeForm":"Converting work package references to xrefs","status":"completed"}]}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":459,"cache_read_input_tokens":50565,"cache_creation":{"ephemeral_5m_input_tokens":459,"ephemeral_1h_input_tokens":0},"output_tokens":292,"service_tier":"standard"}},"requestId":"req_011CWw5EGqv6q6KwRGMF9GDK","type":"assistant","uuid":"90af10d2-2ba0-4594-83b7-549dc25a4aaa","timestamp":"2026-01-09T03:12:57.851Z"}
{"parentUuid":"90af10d2-2ba0-4594-83b7-549dc25a4aaa","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_018dTbSAhh9kHPETuhzy8gPh","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"uuid":"195af1eb-b101-4b09-8422-5fbabf0b4a89","timestamp":"2026-01-09T03:12:57.946Z","toolUseResult":{"oldTodos":[{"content":"Add anchor IDs to all 10 work package headings","status":"completed","activeForm":"Adding anchor IDs to work package headings"},{"content":"Convert plain text work package references to xrefs","status":"in_progress","activeForm":"Converting work package references to xrefs"}],"newTodos":[{"content":"Add anchor IDs to all 10 work package headings","status":"completed","activeForm":"Adding anchor IDs to work package headings"},{"content":"Convert plain text work package references to xrefs","status":"completed","activeForm":"Converting work package references to xrefs"}]},"sourceToolAssistantUUID":"90af10d2-2ba0-4594-83b7-549dc25a4aaa"}
{"parentUuid":"195af1eb-b101-4b09-8422-5fbabf0b4a89","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01Mv2LrwTX3CxHyWVq3uQtFf","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Great! All the work is done. Let me now give a summary to the user of what was accomplished.","signature":"EoQCCkYICxgCKkCQfW32KkIFZgiu5e5c41j+69T8x/+7fFN8pWDIBgzjZm+43huHIEzgPvO9kYTMYHqMASeYrJ3CqD9PgQ99MGVOEgydRh9jBPspP2dwKboaDOsohOawtg5yUuRiuSIw6hKn4b6j/oUlSo20idE20hJWQWXmCdMHwVSuH+GcQe4G1p9tt7Mf4AZc0nBEzhruKmznImRRq/H6QVOOHzOrpIVOs6iFsUvxiOJqlkM9H7FOyjm0C+N1EeRNgsvTCpp2KhdeCccCtbg6P1Hd3RpOlMfq9JjFQVfHfLbBEKEpgEF9LBFAhNKgllOavJ0tPi2EN4U5GyB9U/06B6AlrbkYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":338,"cache_read_input_tokens":51024,"cache_creation":{"ephemeral_5m_input_tokens":338,"ephemeral_1h_input_tokens":0},"output_tokens":6,"service_tier":"standard"}},"requestId":"req_011CWw5ExY7cFhcqwBAuJQLt","type":"assistant","uuid":"6b6cf959-bfe9-40da-81bc-99c46d5dc28f","timestamp":"2026-01-09T03:13:01.578Z"}
{"parentUuid":"6b6cf959-bfe9-40da-81bc-99c46d5dc28f","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01Mv2LrwTX3CxHyWVq3uQtFf","type":"message","role":"assistant","content":[{"type":"text","text":"I've successfully added internal cross-reference links to all work packages in the Salesforce solution architecture document. Here's what was done:\n\n## Changes Made\n\n1. **Added anchor IDs** to all 10 work package section headings (`[[wp-cs-001]]` through `[[wp-cs-010]]`)\n\n2. **Converted work package references to cross-links** throughout the document:\n   - All references in Dependencies sections (Prerequisites and Dependent Work Packages)\n   - All references in the Work Package Sequencing section (Parallel Tracks 1-2, Sequential Tracks 3-4)\n   - All references in the Critical Path section\n\n3. **Preserved plain text references** where appropriate:\n   - Work Package Overview table (lines 1483-1533)\n   - Section headings themselves\n\nNow readers can click on any work package reference (e.g., `<<wp-cs-003,WP-CS-003>>`) to jump directly to that work package's detailed section. This makes it much easier to navigate the dependencies and understand the relationships between work packages.\n\nThe file is ready at: `/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc`"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":338,"cache_read_input_tokens":51024,"cache_creation":{"ephemeral_5m_input_tokens":338,"ephemeral_1h_input_tokens":0},"output_tokens":312,"service_tier":"standard"}},"requestId":"req_011CWw5ExY7cFhcqwBAuJQLt","type":"assistant","uuid":"a757969f-3671-4686-8053-665806bee403","timestamp":"2026-01-09T03:13:07.107Z"}
{"parentUuid":"a757969f-3671-4686-8053-665806bee403","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"system","subtype":"turn_duration","durationMs":231127,"timestamp":"2026-01-09T03:13:09.050Z","uuid":"5f368f91-f28a-44c9-ac9e-38cd73a24bbc","isMeta":false}
{"type":"file-history-snapshot","messageId":"75fd9c9a-3ba5-4638-8798-6c83f962ef56","snapshot":{"messageId":"75fd9c9a-3ba5-4638-8798-6c83f962ef56","trackedFileBackups":{"solution_architectures/salesforce_customer_support.adoc":{"backupFileName":"ef19bf3282a777f7@v2","version":2,"backupTime":"2026-01-09T03:13:31.966Z"}},"timestamp":"2026-01-09T03:13:31.940Z"},"isSnapshotUpdate":false}
{"parentUuid":"5f368f91-f28a-44c9-ac9e-38cd73a24bbc","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":"Commit and push this"},"uuid":"75fd9c9a-3ba5-4638-8798-6c83f962ef56","timestamp":"2026-01-09T03:13:31.901Z","thinkingMetadata":{"level":"high","disabled":false,"triggers":[]},"todos":[]}
{"parentUuid":"75fd9c9a-3ba5-4638-8798-6c83f962ef56","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01BGVnHZq2dWUcDNQNKDhhzM","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"The user wants me to commit and push the changes. Let me follow the git safety protocol:\n\n1. First, I'll run git status and git diff in parallel to see what will be committed\n2. Look at recent commit messages to follow the repository's style\n3. Draft a commit message\n4. Add the files and commit\n5. Push to remote\n\nLet me start by examining the current git state.","signature":"EpEECkYICxgCKkAPcqfa9oBf/jnOsJIxUwhHNYps9Eq/76ZGL4oVK2jKBWZmw4Y/Q2b9SPFvZJQ5x/xJ40/ObDc55ITiS8cdooCQEgxutmgzy7JRIMo+xFMaDAaeQVQWnnr6KqDUCiIwAyQZSkY9T5GG4OhUqHMfrM0aeAbY7I/FYQUiBybdrfKrxSw0zFGhIshEV76Y5cBwKvgCFJcnrSf9SWd8vE5Cz1X9Bq9bvow4a/pr1x5y154s94KUHg9MCzuqsp4rk+GXIR/h51wgQdkM6YwoIbtMtMZUe8vfUlPh+dMr/VP294PnmkLtSV9avbqCCLoDBWuQaIgpsk4jZRMSjLxvaEDdGJaMlgB9XnbcaARXyLGLYPNSfpN+VDnz/8tr1Y1HeeWFHAMPW4d8VyxLdBQQFerpi8rXntCWAQDEydoBgSLoRC9b9qWxwCiffpgFXwRrZvl/H/YuyzfVfpxW8ThqUJfYGS0jFAI0WwhiLfSRYSQBzgKjwLRrQIwi/30dTHDXUpsUz8MtF1hJpl2qm7N/EvzkPrrZiQYHafRkv5a3hvSD4LUI+9QnjbmX8PoLRmv2Zk5NVvct8ti2vQKAV3hhQT3GOdofIDHKlLnOIYbKovHUvokYmr/vUbvBfSOjPRjUxjMXqKnsXVDg3t4/tlI5eFQy3Z9Mv8lAp48AIkWW1ssQEqYcB7/Qht6Q52XsKxgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":31148,"cache_read_input_tokens":18662,"cache_creation":{"ephemeral_5m_input_tokens":31148,"ephemeral_1h_input_tokens":0},"output_tokens":8,"service_tier":"standard"}},"requestId":"req_011CWw5HTauumNxkXaJpJHkv","type":"assistant","uuid":"e555f65d-778a-4d34-aa24-e6394df5c9c1","timestamp":"2026-01-09T03:13:37.488Z"}
{"parentUuid":"e555f65d-778a-4d34-aa24-e6394df5c9c1","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01BGVnHZq2dWUcDNQNKDhhzM","type":"message","role":"assistant","content":[{"type":"text","text":"I'll commit and push these changes. Let me first check the current git status and see what will be committed."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":31148,"cache_read_input_tokens":18662,"cache_creation":{"ephemeral_5m_input_tokens":31148,"ephemeral_1h_input_tokens":0},"output_tokens":8,"service_tier":"standard"}},"requestId":"req_011CWw5HTauumNxkXaJpJHkv","type":"assistant","uuid":"3ad1b547-0437-410a-ace8-977fc4a9d88a","timestamp":"2026-01-09T03:13:37.992Z"}
{"parentUuid":"3ad1b547-0437-410a-ace8-977fc4a9d88a","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01BGVnHZq2dWUcDNQNKDhhzM","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Ux4BaR6L3xJWv6n5CBx4Xt","name":"Bash","input":{"command":"git status","description":"Check git status"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":31148,"cache_read_input_tokens":18662,"cache_creation":{"ephemeral_5m_input_tokens":31148,"ephemeral_1h_input_tokens":0},"output_tokens":8,"service_tier":"standard"}},"requestId":"req_011CWw5HTauumNxkXaJpJHkv","type":"assistant","uuid":"ec10db11-b6f7-4070-aa58-1bfe44a4a8a0","timestamp":"2026-01-09T03:13:38.655Z"}
{"parentUuid":"ec10db11-b6f7-4070-aa58-1bfe44a4a8a0","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01BGVnHZq2dWUcDNQNKDhhzM","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_013rExH5z62xVx2kWN5KJqmL","name":"Bash","input":{"command":"git diff solution_architectures/salesforce_customer_support.adoc | head -100","description":"View changes to Salesforce file"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":31148,"cache_read_input_tokens":18662,"cache_creation":{"ephemeral_5m_input_tokens":31148,"ephemeral_1h_input_tokens":0},"output_tokens":8,"service_tier":"standard"}},"requestId":"req_011CWw5HTauumNxkXaJpJHkv","type":"assistant","uuid":"c8e5fc53-8096-498b-b444-b7fc6a457487","timestamp":"2026-01-09T03:13:39.353Z"}
{"parentUuid":"c8e5fc53-8096-498b-b444-b7fc6a457487","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01BGVnHZq2dWUcDNQNKDhhzM","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01AwFELXJsXeffN4pAuANdkX","name":"Bash","input":{"command":"git log --oneline -5","description":"View recent commit messages"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":31148,"cache_read_input_tokens":18662,"cache_creation":{"ephemeral_5m_input_tokens":31148,"ephemeral_1h_input_tokens":0},"output_tokens":328,"service_tier":"standard"}},"requestId":"req_011CWw5HTauumNxkXaJpJHkv","type":"assistant","uuid":"83a9f44c-e4f7-48d3-a88b-7193f7c9244b","timestamp":"2026-01-09T03:13:39.906Z"}
{"parentUuid":"83a9f44c-e4f7-48d3-a88b-7193f7c9244b","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01AwFELXJsXeffN4pAuANdkX","type":"tool_result","content":"79bc384 feat: Add TOGAF Phase E work packages and gap analysis to solution architectures\n440153b Re-enable Kroki extension for Mermaid diagram support\n6a21ee6 fix: Restore Antora base CSS styling by removing supplemental UI override\n92803c0 fix: Resolve all Antora cross-reference errors in documentation\n221b8c7 feat: Clarify Braze handles all outbound communications from Salesforce Service Cloud","is_error":false}]},"uuid":"220bfece-d070-4034-959f-a88d466ec704","timestamp":"2026-01-09T03:13:40.267Z","toolUseResult":{"stdout":"79bc384 feat: Add TOGAF Phase E work packages and gap analysis to solution architectures\n440153b Re-enable Kroki extension for Mermaid diagram support\n6a21ee6 fix: Restore Antora base CSS styling by removing supplemental UI override\n92803c0 fix: Resolve all Antora cross-reference errors in documentation\n221b8c7 feat: Clarify Braze handles all outbound communications from Salesforce Service Cloud","stderr":"","interrupted":false,"isImage":false},"sourceToolAssistantUUID":"83a9f44c-e4f7-48d3-a88b-7193f7c9244b"}
{"parentUuid":"c8e5fc53-8096-498b-b444-b7fc6a457487","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_013rExH5z62xVx2kWN5KJqmL","type":"tool_result","content":"diff --git a/solution_architectures/salesforce_customer_support.adoc b/solution_architectures/salesforce_customer_support.adoc\nindex 07290b8..b595e12 100644\n--- a/solution_architectures/salesforce_customer_support.adoc\n+++ b/solution_architectures/salesforce_customer_support.adoc\n@@ -1532,6 +1532,7 @@ This section consolidates gaps and activities into implementable work packages a\n \n |===\n \n+[[wp-cs-001]]\n === WP-CS-001: ProfileService Development\n \n ==== Description\n@@ -1585,6 +1586,7 @@ Build ProfileService bounded context microservice implementing Just-In-Time Cont\n * Integration tests pass in sandbox environment\n * API documentation generated from OpenAPI specification\n \n+[[wp-cs-002]]\n === WP-CS-002: EngagementService Development\n \n ==== Description\n@@ -1624,15 +1626,15 @@ Build EngagementService bounded context microservice implementing customer feedb\n \n *Prerequisites*:\n \n-* WP-CS-003 (Event Bus Infrastructure) completed\n+* <<wp-cs-003,WP-CS-003>> (Event Bus Infrastructure) completed\n * Salesforce sandbox environment provisioned\n * Braze API credentials and campaign templates configured\n * Microsoft Entra External ID OAuth configuration\n \n *Dependent Work Packages*:\n \n-* WP-CS-003 must be completed first (Event Bus required for async processing)\n-* WP-CS-007 (Salesforce Configuration) must be in progress (field mapping needed)\n+* <<wp-cs-003,WP-CS-003>> must be completed first (Event Bus required for async processing)\n+* <<wp-cs-007,WP-CS-007>> (Salesforce Configuration) must be in progress (field mapping needed)\n \n ==== Skills Required\n \n@@ -1659,6 +1661,7 @@ Build EngagementService bounded context microservice implementing customer feedb\n * Unit test coverage > 80%\n * Integration tests pass with Salesforce sandbox and Braze staging environment\n \n+[[wp-cs-003]]\n === WP-CS-003: Event Bus Infrastructure\n \n ==== Description\n@@ -1720,6 +1723,7 @@ Implement Event Bus infrastructure for domain event publishing using existing AW\n * Monitoring dashboards operational\n * Infrastructure fully codified (IaC)\n \n+[[wp-cs-004]]\n === WP-CS-004: Contact Migration Tooling\n \n ==== Description\n@@ -1755,14 +1759,14 @@ Develop Contact migration tool for one-time migration from app-specific database\n \n *Prerequisites*:\n \n-* WP-CS-001 (ProfileService Development) completed (reuses Salesforce integration code)\n+* <<wp-cs-001,WP-CS-001>> (ProfileService Development) completed (reuses Salesforce integration code)\n * Salesforce sandbox environment for migration testing\n * App-specific database access (read-only sufficient)\n * Salesforce production access granted\n \n *Dependent Work Packages*:\n \n-* WP-CS-001 provides Salesforce Contact upsert logic to reuse\n+* <<wp-cs-001,WP-CS-001>> provides Salesforce Contact upsert logic to reuse\n \n ==== Skills Required\n \n@@ -1783,6 +1787,7 @@ Develop Contact migration tool for one-time migration from app-specific database\n * Rollback procedure validated in sandbox\n * Documentation complete and approved\n \n+[[wp-cs-005]]\n === WP-CS-005: Mobile App Integration\n \n ==== Description\n@@ -1818,14 +1823,14 @@ Update Mobile App to integrate with ProfileService and EngagementService APIs, r\n \n *Prerequisites*:\n \n-* WP-CS-001 (ProfileService Development) completed and deployed to dev/staging\n-* WP-CS-002 (EngagementService Development) completed and deployed to dev/staging\n+* <<wp-cs-001,WP-CS-001>> (ProfileService Development) completed and deployed to dev/staging\n+* <<wp-cs-002,WP-CS-002>> (EngagementService Development) completed and deployed to dev/staging\n * ProfileService and EngagementService OpenAPI specifications finalized\n * Feature flag service configured\n \n *Dependent Work Packages*:\n \n-* Must complete after WP-CS-001 and WP-CS-002 (requires API endpoints available for integration testing)\n+* Must complete after <<wp-cs-001,WP-CS-001>> and <<wp-cs-002,WP-CS-002>> (requires API endpoints available for integration testing)\n \n ==== Skills Required\n \n@@ -1849,6 +1854,7 @@ Update Mobile App to integrate with ProfileService and EngagementService APIs, r\n * UI tests pass for all feedback form workflows (happy path, error states)","is_error":false}]},"uuid":"c64ee3f2-c502-4307-8798-9fd4e881e4f3","timestamp":"2026-01-09T03:13:40.336Z","toolUseResult":{"stdout":"diff --git a/solution_architectures/salesforce_customer_support.adoc b/solution_architectures/salesforce_customer_support.adoc\nindex 07290b8..b595e12 100644\n--- a/solution_architectures/salesforce_customer_support.adoc\n+++ b/solution_architectures/salesforce_customer_support.adoc\n@@ -1532,6 +1532,7 @@ This section consolidates gaps and activities into implementable work packages a\n \n |===\n \n+[[wp-cs-001]]\n === WP-CS-001: ProfileService Development\n \n ==== Description\n@@ -1585,6 +1586,7 @@ Build ProfileService bounded context microservice implementing Just-In-Time Cont\n * Integration tests pass in sandbox environment\n * API documentation generated from OpenAPI specification\n \n+[[wp-cs-002]]\n === WP-CS-002: EngagementService Development\n \n ==== Description\n@@ -1624,15 +1626,15 @@ Build EngagementService bounded context microservice implementing customer feedb\n \n *Prerequisites*:\n \n-* WP-CS-003 (Event Bus Infrastructure) completed\n+* <<wp-cs-003,WP-CS-003>> (Event Bus Infrastructure) completed\n * Salesforce sandbox environment provisioned\n * Braze API credentials and campaign templates configured\n * Microsoft Entra External ID OAuth configuration\n \n *Dependent Work Packages*:\n \n-* WP-CS-003 must be completed first (Event Bus required for async processing)\n-* WP-CS-007 (Salesforce Configuration) must be in progress (field mapping needed)\n+* <<wp-cs-003,WP-CS-003>> must be completed first (Event Bus required for async processing)\n+* <<wp-cs-007,WP-CS-007>> (Salesforce Configuration) must be in progress (field mapping needed)\n \n ==== Skills Required\n \n@@ -1659,6 +1661,7 @@ Build EngagementService bounded context microservice implementing customer feedb\n * Unit test coverage > 80%\n * Integration tests pass with Salesforce sandbox and Braze staging environment\n \n+[[wp-cs-003]]\n === WP-CS-003: Event Bus Infrastructure\n \n ==== Description\n@@ -1720,6 +1723,7 @@ Implement Event Bus infrastructure for domain event publishing using existing AW\n * Monitoring dashboards operational\n * Infrastructure fully codified (IaC)\n \n+[[wp-cs-004]]\n === WP-CS-004: Contact Migration Tooling\n \n ==== Description\n@@ -1755,14 +1759,14 @@ Develop Contact migration tool for one-time migration from app-specific database\n \n *Prerequisites*:\n \n-* WP-CS-001 (ProfileService Development) completed (reuses Salesforce integration code)\n+* <<wp-cs-001,WP-CS-001>> (ProfileService Development) completed (reuses Salesforce integration code)\n * Salesforce sandbox environment for migration testing\n * App-specific database access (read-only sufficient)\n * Salesforce production access granted\n \n *Dependent Work Packages*:\n \n-* WP-CS-001 provides Salesforce Contact upsert logic to reuse\n+* <<wp-cs-001,WP-CS-001>> provides Salesforce Contact upsert logic to reuse\n \n ==== Skills Required\n \n@@ -1783,6 +1787,7 @@ Develop Contact migration tool for one-time migration from app-specific database\n * Rollback procedure validated in sandbox\n * Documentation complete and approved\n \n+[[wp-cs-005]]\n === WP-CS-005: Mobile App Integration\n \n ==== Description\n@@ -1818,14 +1823,14 @@ Update Mobile App to integrate with ProfileService and EngagementService APIs, r\n \n *Prerequisites*:\n \n-* WP-CS-001 (ProfileService Development) completed and deployed to dev/staging\n-* WP-CS-002 (EngagementService Development) completed and deployed to dev/staging\n+* <<wp-cs-001,WP-CS-001>> (ProfileService Development) completed and deployed to dev/staging\n+* <<wp-cs-002,WP-CS-002>> (EngagementService Development) completed and deployed to dev/staging\n * ProfileService and EngagementService OpenAPI specifications finalized\n * Feature flag service configured\n \n *Dependent Work Packages*:\n \n-* Must complete after WP-CS-001 and WP-CS-002 (requires API endpoints available for integration testing)\n+* Must complete after <<wp-cs-001,WP-CS-001>> and <<wp-cs-002,WP-CS-002>> (requires API endpoints available for integration testing)\n \n ==== Skills Required\n \n@@ -1849,6 +1854,7 @@ Update Mobile App to integrate with ProfileService and EngagementService APIs, r\n * UI tests pass for all feedback form workflows (happy path, error states)","stderr":"","interrupted":false,"isImage":false},"sourceToolAssistantUUID":"c8e5fc53-8096-498b-b444-b7fc6a457487"}
{"parentUuid":"ec10db11-b6f7-4070-aa58-1bfe44a4a8a0","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Ux4BaR6L3xJWv6n5CBx4Xt","type":"tool_result","content":"On branch main\nYour branch is up to date with 'origin/main'.\n\nChanges not staged for commit:\n  (use \"git add/rm <file>...\" to update what will be committed)\n  (use \"git restore <file>...\" to discard changes in working directory)\n\tmodified:   .claude/settings.local.json\n\tmodified:   architecture_definitions/flybuys_integration.adoc\n\tmodified:   architecture_definitions/salesforce_customer_support.adoc\n\tdeleted:    convert-xrefs.py\n\tdeleted:    executive_summaries/flybuys_integration.adoc\n\tdeleted:    executive_summaries/salesforce_customer_support.adoc\n\tmodified:   modules/ROOT/nav.adoc\n\tmodified:   modules/architecture-definitions/nav.adoc\n\tmodified:   modules/bounded-contexts/nav.adoc\n\tmodified:   modules/solution-architectures/nav.adoc\n\tmodified:   solution_architectures/salesforce_customer_support.adoc\n\nUntracked files:\n  (use \"git add <file>...\" to include in what will be committed)\n\tinitiatives/\n\tmodules/ROOT/pages/salesforce_customer_support.adoc\n\nno changes added to commit (use \"git add\" and/or \"git commit -a\")","is_error":false}]},"uuid":"78c666d9-f5ce-4865-bbd6-1e0c7b2d7e1e","timestamp":"2026-01-09T03:13:41.106Z","toolUseResult":{"stdout":"On branch main\nYour branch is up to date with 'origin/main'.\n\nChanges not staged for commit:\n  (use \"git add/rm <file>...\" to update what will be committed)\n  (use \"git restore <file>...\" to discard changes in working directory)\n\tmodified:   .claude/settings.local.json\n\tmodified:   architecture_definitions/flybuys_integration.adoc\n\tmodified:   architecture_definitions/salesforce_customer_support.adoc\n\tdeleted:    convert-xrefs.py\n\tdeleted:    executive_summaries/flybuys_integration.adoc\n\tdeleted:    executive_summaries/salesforce_customer_support.adoc\n\tmodified:   modules/ROOT/nav.adoc\n\tmodified:   modules/architecture-definitions/nav.adoc\n\tmodified:   modules/bounded-contexts/nav.adoc\n\tmodified:   modules/solution-architectures/nav.adoc\n\tmodified:   solution_architectures/salesforce_customer_support.adoc\n\nUntracked files:\n  (use \"git add <file>...\" to include in what will be committed)\n\tinitiatives/\n\tmodules/ROOT/pages/salesforce_customer_support.adoc\n\nno changes added to commit (use \"git add\" and/or \"git commit -a\")","stderr":"","interrupted":false,"isImage":false},"sourceToolAssistantUUID":"ec10db11-b6f7-4070-aa58-1bfe44a4a8a0"}
{"parentUuid":"78c666d9-f5ce-4865-bbd6-1e0c7b2d7e1e","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01HMkVGRfsPN3VzWDJokGKbA","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Looking at the git status, I can see there are multiple modified files and some deleted files. The user asked specifically to commit and push \"this\", referring to the work package internal linking changes I just made. \n\nSo I should only commit the solution_architectures/salesforce_customer_support.adoc file, not all the other changes.\n\nLooking at the recent commit messages, they follow a conventional commits style with prefixes like \"feat:\", \"fix:\", etc.\n\nFor this change, I'm adding internal cross-references/links to work packages. This is an enhancement to the documentation. I'd say this is a \"feat:\" or maybe a \"docs:\" type commit.\n\nLet me craft a good commit message following their style:\n- \"feat: Add internal cross-references to work packages in Salesforce solution architecture\"\n\nThat seems appropriate. Let me commit just the solution_architectures/salesforce_customer_support.adoc file.","signature":"EqcICkYICxgCKkAR3W62/TppVSmlCkegyi/4iWsaw3x8ZpX8ym2E4WX7Yx+8Xf2hpVHc2R2kVJNLM42kmpK0kpBmbZH1pK84YjtgEgxyQhzIZN0wyL9WoUYaDNrTSL1WIJ/0LIMasyIwIuqiIxJuwKD0M8pPN45WO0aiha2SDArotxopL7Jc5Hxe4TWoFjcaZJO9UUxL6JHfKo4HkTwQ9A6A5C4GONAXD2KO9bk9Bi4R6qfXY/Q+EwcPKKPYgASzw/t5UAvRn+6FcpLJZ6kCDS61KrKatdo9gOncQDW3QRc6ui3Q4bmnD/SuXHMfqE+edwFuZMjA37xGm8Uds6hRd5JkedkUlVxbiE1rqdzgaymDdzCgJP0ErZc48V5+WgydoETYwz31QDZVbnYFUZvtu2rd7yEwK/AUySMeKS7WWGLlxOwD1DdI3Lzu7VdpTl0MiWgoWhQ59iqDJYu2lhPl6DFCQLL87hBFYBWoIeXE1oI11i8Cz9QYJ58ePd13s/RTIdrD7VzIFq36yro43flIJlQzvLsTPF3YuX63X8BP0/OGnzRAXHthaLDIV+Lz9wz3pg5uzSKc63GPzCh1IAf95pIuvPQj2/0mpJAMgnA7nWcXIevXqsOI01DdBDa2fTweDst/XT6ZrNlDBA2A7ma672ap8n86Nl63RKs/+XplJ1Ms+QvVcydK9sR5qumhHTjMV/wmmV9DrshpbB26YuL4yRXdflSOiuQsGQgTCm0iE2qnpRRpbWhf0mNUy6fVLgAkMNgQuG8wuYCxvpvOMLld+ftVkc9XJT6oF4pQHRMkRXqYjp4GOB/IpPhDdD0wmUUKNNB3MZtHX7IJTjS02LbUoHHRSN5xcI2Cpj2mbKqyoHz8he98M8KozFR8ylvxje/o0JQiVYN80Uck7/q8OKKBKVoNvjUZDjcx6SYTlWndfjMX4l86hoopq64tsjr7CBfbhbL1hAZzhsaIRUe+43VKtQ2JimLRkC7Ek3MTiyVp7kbQ6bLi6nApj4cuMSkXD24Sb0F/zDAWtZz3KWlSpJKqTN8UPy0Gvx1UocipQvg12wVlyKRHhS3iOiTNUMRJU/jq03S1GNYA0x4Vy310VhzuFPkj7sF9TXRP8OWZ4UXqSC2ZyAcOdMbKTZF64EQSsHm13yPjSJQujn2LGmlAX9QUqXUsAEs13uiW15FJt7cDZDLNSbHsdYBBxiiQC7T6PWJ2ydkKobZCFlkmm2DS0jscr2qzRDR2ca3/3d7WiVLDx2Ayed9quQLLKTSdw/wGdfoL7QHVzFaobFe0QHOel8Rd/PN8PlCKiMa+0bEpeob1gMOpqXdhvRGTRyG7a2T965D69An53hMIJoQXoURTGCBDYlTn39gfr02TRM05dZ7k4/7Kg03H3ocBluRnwAa1mnWJP8D+bPLAb3cgPRgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1438,"cache_creation_input_tokens":673,"cache_read_input_tokens":49810,"cache_creation":{"ephemeral_5m_input_tokens":673,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CWw5J8sZLGj6wG44No1ZN","type":"assistant","uuid":"494b93b8-cd05-492f-b775-8af2d324783b","timestamp":"2026-01-09T03:13:48.964Z"}
{"parentUuid":"494b93b8-cd05-492f-b775-8af2d324783b","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01HMkVGRfsPN3VzWDJokGKbA","type":"message","role":"assistant","content":[{"type":"text","text":"I'll commit only the Salesforce solution architecture file with the internal linking changes."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1438,"cache_creation_input_tokens":673,"cache_read_input_tokens":49810,"cache_creation":{"ephemeral_5m_input_tokens":673,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CWw5J8sZLGj6wG44No1ZN","type":"assistant","uuid":"27da04b0-6a28-43a2-9ef1-8d542d072209","timestamp":"2026-01-09T03:13:49.536Z"}
{"parentUuid":"27da04b0-6a28-43a2-9ef1-8d542d072209","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01HMkVGRfsPN3VzWDJokGKbA","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01HmkB4ks6CDry9g8T86S1qq","name":"Bash","input":{"command":"git add solution_architectures/salesforce_customer_support.adoc && git commit -m \"$(cat <<'EOF'\nfeat: Add internal cross-references to work packages in Salesforce solution architecture\n\n- Added anchor IDs to all 10 work packages (wp-cs-001 through wp-cs-010)\n- Converted plain text work package references to clickable cross-links\n- Updated all Dependencies sections with xrefs\n- Updated Work Package Sequencing and Critical Path sections with xrefs\n- Improves navigation and readability of work package dependencies\n\nCo-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>\nEOF\n)\" && git status","description":"Commit Salesforce solution architecture changes"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1438,"cache_creation_input_tokens":673,"cache_read_input_tokens":49810,"cache_creation":{"ephemeral_5m_input_tokens":673,"ephemeral_1h_input_tokens":0},"output_tokens":461,"service_tier":"standard"}},"requestId":"req_011CWw5J8sZLGj6wG44No1ZN","type":"assistant","uuid":"743631f0-071e-4650-80cb-c2ab9628b687","timestamp":"2026-01-09T03:13:52.534Z"}
{"parentUuid":"743631f0-071e-4650-80cb-c2ab9628b687","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01HmkB4ks6CDry9g8T86S1qq","type":"tool_result","content":"[main 42c06e2] feat: Add internal cross-references to work packages in Salesforce solution architecture\n 1 file changed, 56 insertions(+), 46 deletions(-)\nOn branch main\nYour branch is ahead of 'origin/main' by 1 commit.\n  (use \"git push\" to publish your local commits)\n\nChanges not staged for commit:\n  (use \"git add/rm <file>...\" to update what will be committed)\n  (use \"git restore <file>...\" to discard changes in working directory)\n\tmodified:   .claude/settings.local.json\n\tmodified:   architecture_definitions/flybuys_integration.adoc\n\tmodified:   architecture_definitions/salesforce_customer_support.adoc\n\tdeleted:    convert-xrefs.py\n\tdeleted:    executive_summaries/flybuys_integration.adoc\n\tdeleted:    executive_summaries/salesforce_customer_support.adoc\n\tmodified:   modules/ROOT/nav.adoc\n\tmodified:   modules/architecture-definitions/nav.adoc\n\tmodified:   modules/bounded-contexts/nav.adoc\n\tmodified:   modules/solution-architectures/nav.adoc\n\nUntracked files:\n  (use \"git add <file>...\" to include in what will be committed)\n\tinitiatives/\n\tmodules/ROOT/pages/salesforce_customer_support.adoc\n\nno changes added to commit (use \"git add\" and/or \"git commit -a\")","is_error":false}]},"uuid":"b87099cb-bc29-4724-be42-51fb45b8cade","timestamp":"2026-01-09T03:13:55.434Z","toolUseResult":{"stdout":"[main 42c06e2] feat: Add internal cross-references to work packages in Salesforce solution architecture\n 1 file changed, 56 insertions(+), 46 deletions(-)\nOn branch main\nYour branch is ahead of 'origin/main' by 1 commit.\n  (use \"git push\" to publish your local commits)\n\nChanges not staged for commit:\n  (use \"git add/rm <file>...\" to update what will be committed)\n  (use \"git restore <file>...\" to discard changes in working directory)\n\tmodified:   .claude/settings.local.json\n\tmodified:   architecture_definitions/flybuys_integration.adoc\n\tmodified:   architecture_definitions/salesforce_customer_support.adoc\n\tdeleted:    convert-xrefs.py\n\tdeleted:    executive_summaries/flybuys_integration.adoc\n\tdeleted:    executive_summaries/salesforce_customer_support.adoc\n\tmodified:   modules/ROOT/nav.adoc\n\tmodified:   modules/architecture-definitions/nav.adoc\n\tmodified:   modules/bounded-contexts/nav.adoc\n\tmodified:   modules/solution-architectures/nav.adoc\n\nUntracked files:\n  (use \"git add <file>...\" to include in what will be committed)\n\tinitiatives/\n\tmodules/ROOT/pages/salesforce_customer_support.adoc\n\nno changes added to commit (use \"git add\" and/or \"git commit -a\")","stderr":"","interrupted":false,"isImage":false},"sourceToolAssistantUUID":"743631f0-071e-4650-80cb-c2ab9628b687"}
{"parentUuid":"b87099cb-bc29-4724-be42-51fb45b8cade","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01KR29X747LUtSbhgGepXAWX","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Good! The commit was successful. Now I need to push to the remote repository.","signature":"EvUBCkYICxgCKkB8v5/4wtfPL/+ISzmisFRFoWIScn8mXe8CsX/CcE66f7M3vu0DHNNbC6D177nMzgJff7NR5N+l2N7qSEenUTvJEgy6xSSS5Mu157o6s9kaDL+hbM4pmdwV0SPTUCIwbTayPPxr5l3sOqGCNQ7B/BJ0ksji8MOWBp5+l03ms5c5O9Wp4oXcytpn/FjSTjbDKl3kdYVdU+aQq90HHRUO/wD50ltDfRxg2c5sFhViavepEiQM2cv0oz0RW50nElrOmUN9PPLzuNPRiN46bGUNrd/03m7FYS1o5/fh63KNjrv6cNdzRCXwCAUbpR3PY6AYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":2252,"cache_read_input_tokens":50483,"cache_creation":{"ephemeral_5m_input_tokens":2252,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWw5KCEjiHMsP6prznhf2","type":"assistant","uuid":"f1fa0141-5a8c-441b-bd6b-9b9df271c58d","timestamp":"2026-01-09T03:13:59.199Z"}
{"parentUuid":"f1fa0141-5a8c-441b-bd6b-9b9df271c58d","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01KR29X747LUtSbhgGepXAWX","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_017rpU83thVzGyKwYxLyPQu7","name":"Bash","input":{"command":"git push","description":"Push commit to remote repository"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":2252,"cache_read_input_tokens":50483,"cache_creation":{"ephemeral_5m_input_tokens":2252,"ephemeral_1h_input_tokens":0},"output_tokens":99,"service_tier":"standard"}},"requestId":"req_011CWw5KCEjiHMsP6prznhf2","type":"assistant","uuid":"8841cdbb-18f4-4862-8664-eef1d2d89bea","timestamp":"2026-01-09T03:13:59.558Z"}
{"parentUuid":"8841cdbb-18f4-4862-8664-eef1d2d89bea","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_017rpU83thVzGyKwYxLyPQu7","type":"tool_result","content":"To https://github.com/otr-digital/architecture.git\n   79bc384..42c06e2  main -> main","is_error":false}]},"uuid":"a674c325-c106-47af-ac4e-1326893b5795","timestamp":"2026-01-09T03:14:01.966Z","toolUseResult":{"stdout":"To https://github.com/otr-digital/architecture.git\n   79bc384..42c06e2  main -> main","stderr":"","interrupted":false,"isImage":false},"sourceToolAssistantUUID":"8841cdbb-18f4-4862-8664-eef1d2d89bea"}
{"parentUuid":"a674c325-c106-47af-ac4e-1326893b5795","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_013LJKLB4WsSNJvEJRATFfP2","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Great! The push was successful. Let me update the todo list to mark everything complete and then provide a summary to the user.","signature":"EqgCCkYICxgCKkAbZfqBAdp5o37mk+3TuTUGBg6T/OWEuJjPGkiszPbqzQVET27x2twDh7PPoncHP2SsLehIT38UAPukzrq8QJVMEgyYkJb2paNi69xfQ48aDNPSSXpmqgUiLeGRkiIw/ukt9yA6Od6wJpJas8CC/fxRw+bsF7vI7QxVnotQuH3RjvoRdxD5Q6CoG47IzaysKo8BQmfMW2FvFibgG3acUAYkedRoIIvAis+WntrQCdsDXD1UlSIdV9FEq02kpCUxTk5yrVr8YNfnxoVEntlvLrAeo9hzCEmparN6w4lQu+OSm3LGMJQ+Qjzdih8Z70wIGX2pudRuWQRQ6IuEgfkIdgucHPpSs2gTc2dHhOPO+9gmtBHt3gazbYZrw5/XGwEfrcAYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":148,"cache_read_input_tokens":52735,"cache_creation":{"ephemeral_5m_input_tokens":148,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CWw5KfvdMFY12gs7zxtyT","type":"assistant","uuid":"ee7eb690-0607-498c-b9e5-291ab7283ebd","timestamp":"2026-01-09T03:14:05.710Z"}
{"parentUuid":"ee7eb690-0607-498c-b9e5-291ab7283ebd","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_013LJKLB4WsSNJvEJRATFfP2","type":"message","role":"assistant","content":[{"type":"text","text":"Perfect! I've successfully committed and pushed the changes. \n\n## Summary\n\n**Commit:** `42c06e2` - \"feat: Add internal cross-references to work packages in Salesforce solution architecture\"\n\n**Changes:**\n- Added anchor IDs to all 10 work packages (wp-cs-001 through wp-cs-010)\n- Converted 46 plain text work package references to clickable cross-links\n- Updated Dependencies, Work Package Sequencing, and Critical Path sections\n\nThe changes have been pushed to the remote repository at `https://github.com/otr-digital/architecture.git` on the main branch. The internal links will now allow readers to easily navigate between related work packages in the Salesforce solution architecture document."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":148,"cache_read_input_tokens":52735,"cache_creation":{"ephemeral_5m_input_tokens":148,"ephemeral_1h_input_tokens":0},"output_tokens":202,"service_tier":"standard"}},"requestId":"req_011CWw5KfvdMFY12gs7zxtyT","type":"assistant","uuid":"8a2d1dc4-0e56-495c-921a-776269e57798","timestamp":"2026-01-09T03:14:08.026Z"}
{"parentUuid":"8a2d1dc4-0e56-495c-921a-776269e57798","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"system","subtype":"turn_duration","durationMs":37472,"timestamp":"2026-01-09T03:14:09.421Z","uuid":"92d9e90b-53e8-4d75-baa4-64fcde9ae5a7","isMeta":false}
{"type":"file-history-snapshot","messageId":"ad8629a6-c9be-452c-afff-5fea6b01d503","snapshot":{"messageId":"ad8629a6-c9be-452c-afff-5fea6b01d503","trackedFileBackups":{"solution_architectures/salesforce_customer_support.adoc":{"backupFileName":"ef19bf3282a777f7@v2","version":2,"backupTime":"2026-01-09T03:13:31.966Z"}},"timestamp":"2026-01-09T04:02:34.028Z"},"isSnapshotUpdate":false}
{"parentUuid":"92d9e90b-53e8-4d75-baa4-64fcde9ae5a7","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":" Why are my initiative documents not linking properly in the navigation "},"uuid":"ad8629a6-c9be-452c-afff-5fea6b01d503","timestamp":"2026-01-09T04:02:34.010Z","thinkingMetadata":{"level":"high","disabled":false,"triggers":[]},"todos":[]}
{"parentUuid":"ad8629a6-c9be-452c-afff-5fea6b01d503","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01UJ37d2DyE5CZvAyr4LWdRC","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"The user is asking about initiative documents not linking properly in the navigation. Let me look at the current state and see what's happening with the initiatives.\n\nFrom the git status, I can see:\n- There's an untracked `initiatives/` directory\n- There's a new file `modules/ROOT/pages/salesforce_customer_support.adoc`\n- Navigation files have been modified\n\nLet me investigate the navigation structure and see what's going on with the initiatives.","signature":"EugECkYICxgCKkAqEm/i2iUU/ydF70VaJOwVDvMNCLJWX7hpW6Owmv+SiThu3Vt0xNHoxKJcAZHLWgr+5z/+QU1tdGotIRVZPPlOEgyENreun+vULWXa3p4aDJcCWEiSy/CiB8Xg+SIwllDqh4RKcnI+6DCiV+BP4sAqwbuganXsXQTmQMMFX4HesTe3IjbmlpgMPjvO+DE8Ks8DVIRUIme3uvTJEimEWfxsVCPrLuxytHm9EXLYFj5OpCMciaj9Rxsb6QVCCq/tq60nBCwAMGIdf8wEq3BCzlEdloD3fvIgPHSouTaM+IGcyW4zFPRiMUB9k2K/nwUBc1X/e2uFdg09kWxnV2e63YdLnP8hyWJMmf91cIPftIO6VehH2oKaz1jzfRHbvN+UJBqCPZpOGB4WcPtEZH4Q8VVIjU1/N7urucmbURen69mcgLsAA7PqvEqBP9CJ1j9lnYb7yvniGZSb++627DPnc7+fit0IANZRlWfddB9uEcuyMOTiynPBccGQg8f2TnUTM4zER4JZ6XDHrrGetF3C4xXdizZh9XkrLGk/RUJfBV1RIfUDeg6WrbLlYDoQOB57L/7fPseGFPf1TAaPpO2QnPCfLl/1nKD7r6Zp4Patr8MEFq03jZby2LHfFhoVT9SaytPIbCPOCjCVVKayP61Yyo4TX2okna+9TxTZ9cYjDzdEdePl6JTaxpcpPUvTTqOfQajCnnkvjmOKa5QB4Kbvar1iun2AFVhUxqWdTCH0ti8meTnV3y7pAjCQQoMipeFYenE8JwbaXgO77ntAPnDTLK9JpPHAMt4uykZg9mepJmeYWRgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":52727,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":52727,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CWw92Kx5fyPPvpBpk1HwP","type":"assistant","uuid":"daf48a6c-da49-499e-ab51-f31b56d4f3a2","timestamp":"2026-01-09T04:02:39.352Z"}
{"parentUuid":"daf48a6c-da49-499e-ab51-f31b56d4f3a2","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01UJ37d2DyE5CZvAyr4LWdRC","type":"message","role":"assistant","content":[{"type":"text","text":"Let me investigate the navigation setup and the initiatives directory to see why the links aren't working properly."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":52727,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":52727,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CWw92Kx5fyPPvpBpk1HwP","type":"assistant","uuid":"a254d581-c8a1-4c76-95b5-8098dba35ac6","timestamp":"2026-01-09T04:02:39.917Z"}
{"parentUuid":"a254d581-c8a1-4c76-95b5-8098dba35ac6","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01UJ37d2DyE5CZvAyr4LWdRC","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Hbozr2UhNk5SFTxCYHW1Zk","name":"Bash","input":{"command":"ls -la initiatives/","description":"List contents of initiatives directory"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":52727,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":52727,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CWw92Kx5fyPPvpBpk1HwP","type":"assistant","uuid":"d6d0c0a6-e0a3-4cec-99e7-687bb08a3c4b","timestamp":"2026-01-09T04:02:40.452Z"}
{"parentUuid":"d6d0c0a6-e0a3-4cec-99e7-687bb08a3c4b","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01UJ37d2DyE5CZvAyr4LWdRC","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01XDuqBcgg1irBePgZRHSej3","name":"Read","input":{"file_path":"/mnt/c/Users/o.young/work/architecture/modules/ROOT/nav.adoc"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":52727,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":52727,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CWw92Kx5fyPPvpBpk1HwP","type":"assistant","uuid":"b4542c50-c922-490a-88ea-0f01043d2c3d","timestamp":"2026-01-09T04:02:41.159Z"}
{"parentUuid":"b4542c50-c922-490a-88ea-0f01043d2c3d","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01UJ37d2DyE5CZvAyr4LWdRC","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01PFHbqGfUadwWCDE8Wr2XZB","name":"Bash","input":{"command":"find . -name \"nav.adoc\" -type f","description":"Find all navigation files"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":52727,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":52727,"ephemeral_1h_input_tokens":0},"output_tokens":333,"service_tier":"standard"}},"requestId":"req_011CWw92Kx5fyPPvpBpk1HwP","type":"assistant","uuid":"4686f0e3-6c01-44d9-86e4-8d5f8f1b9fc3","timestamp":"2026-01-09T04:02:41.793Z"}
{"parentUuid":"b4542c50-c922-490a-88ea-0f01043d2c3d","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01XDuqBcgg1irBePgZRHSej3","type":"tool_result","content":"     1→* xref:index.adoc[Home]\n     2→* xref:ubiquitous_language.adoc[Ubiquitous Language]\n     3→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"cd70c428-d134-4100-9d74-2e3a28d6e31c","timestamp":"2026-01-09T04:02:42.039Z","toolUseResult":{"type":"text","file":{"filePath":"/mnt/c/Users/o.young/work/architecture/modules/ROOT/nav.adoc","content":"* xref:index.adoc[Home]\n* xref:ubiquitous_language.adoc[Ubiquitous Language]\n","numLines":3,"startLine":1,"totalLines":3}},"sourceToolAssistantUUID":"b4542c50-c922-490a-88ea-0f01043d2c3d"}
{"parentUuid":"d6d0c0a6-e0a3-4cec-99e7-687bb08a3c4b","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Hbozr2UhNk5SFTxCYHW1Zk","type":"tool_result","content":"total 32\ndrwxrwxrwx 1 oliy oliy  4096 Jan  9 11:32 .\ndrwxrwxrwx 1 oliy oliy  4096 Jan  9 12:21 ..\n-rwxrwxrwx 1 oliy oliy 12077 Jan  9 12:22 flybuys_integration.adoc\n-rwxrwxrwx 1 oliy oliy 17377 Jan  9 12:30 salesforce_customer_support.adoc","is_error":false}]},"uuid":"d61d1300-011a-4b45-a133-9b032df06018","timestamp":"2026-01-09T04:02:42.164Z","toolUseResult":{"stdout":"total 32\ndrwxrwxrwx 1 oliy oliy  4096 Jan  9 11:32 .\ndrwxrwxrwx 1 oliy oliy  4096 Jan  9 12:21 ..\n-rwxrwxrwx 1 oliy oliy 12077 Jan  9 12:22 flybuys_integration.adoc\n-rwxrwxrwx 1 oliy oliy 17377 Jan  9 12:30 salesforce_customer_support.adoc","stderr":"","interrupted":false,"isImage":false},"sourceToolAssistantUUID":"d6d0c0a6-e0a3-4cec-99e7-687bb08a3c4b"}
{"parentUuid":"4686f0e3-6c01-44d9-86e4-8d5f8f1b9fc3","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01PFHbqGfUadwWCDE8Wr2XZB","type":"tool_result","content":"./modules/architecture-definitions/nav.adoc\n./modules/bounded-contexts/nav.adoc\n./modules/domains/nav.adoc\n./modules/events/nav.adoc\n./modules/initiatives/nav.adoc\n./modules/ROOT/nav.adoc\n./modules/solution-architectures/nav.adoc","is_error":false}]},"uuid":"301b9376-a72f-4729-ad7d-1875f2774eb9","timestamp":"2026-01-09T04:02:46.619Z","toolUseResult":{"stdout":"./modules/architecture-definitions/nav.adoc\n./modules/bounded-contexts/nav.adoc\n./modules/domains/nav.adoc\n./modules/events/nav.adoc\n./modules/initiatives/nav.adoc\n./modules/ROOT/nav.adoc\n./modules/solution-architectures/nav.adoc","stderr":"","interrupted":false,"isImage":false},"sourceToolAssistantUUID":"4686f0e3-6c01-44d9-86e4-8d5f8f1b9fc3"}
{"parentUuid":"301b9376-a72f-4729-ad7d-1875f2774eb9","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_014ogydGejtwRdDgXzXaHSzB","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"I can see there are initiative files in the `initiatives/` directory at the root, and there's a `modules/initiatives/nav.adoc` file. Let me check the initiatives navigation file and see what's going on.","signature":"EvMCCkYICxgCKkAriWheOUpW4cebajfL+Xh5D299780xcgLyHoTOd5kKvucNwuw9+B+Oe0MJWKjFwGp/v+zB7KOeRQ8Bd/jeCUxdEgybffeCQcfgtgkOkREaDI7DXRVszXGfRg9SViIwb1OT8ODve43UgmWgJIx5x9miRvvTARwDltq43D3eUBS6yt9o/9mC6ylfkeqdkS0fKtoBaXmQeNNaq31CV83abWeh/jq+RAJYs6dzjxoL2tctkxm7Qr/Y3if1hQQb1IQaE6lXRY8Di66FcDN3NLs00aK+YFlxn2NWdmlxBBwrTk2+zY0DB5GsSaLzHpNm8UUAHFRkT5eWUina1n2mRxLRXSIqvEmUGfdaJ/1mPHMUS0ZLsN1WfVPI8Z/tP37iog2WvSoy12c6+IxN5H2QvDpEvD9nCYly+Yc0nltoRNaoqZlq89USJh8+4+EDxZHCnvEvTVkbk7ougoWn6n1CHS7K4RU37r4ymHN8dXji9R0YAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":14,"cache_creation_input_tokens":858,"cache_read_input_tokens":52727,"cache_creation":{"ephemeral_5m_input_tokens":858,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CWw93G5wVgNZsdCFCaSaR","type":"assistant","uuid":"6f34a8ba-7703-4b32-a04b-6414ac4ea285","timestamp":"2026-01-09T04:02:51.065Z"}
{"parentUuid":"6f34a8ba-7703-4b32-a04b-6414ac4ea285","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_014ogydGejtwRdDgXzXaHSzB","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01FNriQanUkJ7TSk4BRhammQ","name":"Read","input":{"file_path":"/mnt/c/Users/o.young/work/architecture/modules/initiatives/nav.adoc"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":14,"cache_creation_input_tokens":858,"cache_read_input_tokens":52727,"cache_creation":{"ephemeral_5m_input_tokens":858,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CWw93G5wVgNZsdCFCaSaR","type":"assistant","uuid":"094ae069-aebf-4702-8fc8-3efef15a0888","timestamp":"2026-01-09T04:02:51.545Z"}
{"parentUuid":"094ae069-aebf-4702-8fc8-3efef15a0888","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_014ogydGejtwRdDgXzXaHSzB","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01E6ukHJD8k8k94423YpQ4d5","name":"Bash","input":{"command":"ls -la modules/initiatives/","description":"List initiatives module directory"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":14,"cache_creation_input_tokens":858,"cache_read_input_tokens":52727,"cache_creation":{"ephemeral_5m_input_tokens":858,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CWw93G5wVgNZsdCFCaSaR","type":"assistant","uuid":"058af32d-52af-45ca-afaa-2cbc6ef192d6","timestamp":"2026-01-09T04:02:52.196Z"}
{"parentUuid":"058af32d-52af-45ca-afaa-2cbc6ef192d6","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_014ogydGejtwRdDgXzXaHSzB","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01BGUTMGD47MpnK7pCgZs1R7","name":"Bash","input":{"command":"find modules/initiatives -type f -name \"*.adoc\"","description":"Find adoc files in initiatives module"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":14,"cache_creation_input_tokens":858,"cache_read_input_tokens":52727,"cache_creation":{"ephemeral_5m_input_tokens":858,"ephemeral_1h_input_tokens":0},"output_tokens":264,"service_tier":"standard"}},"requestId":"req_011CWw93G5wVgNZsdCFCaSaR","type":"assistant","uuid":"904336d6-0d3c-4066-8492-b5dbaaa8843d","timestamp":"2026-01-09T04:02:52.776Z"}
{"parentUuid":"094ae069-aebf-4702-8fc8-3efef15a0888","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01FNriQanUkJ7TSk4BRhammQ","type":"tool_result","content":"     1→\n     2→.Initiatives\n     3→* xref:flybuys_integration.adoc[Flybuys Integration]\n     4→* xref:salesforce_customer_support.adoc[Salesforce Customer Support]\n     5→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"da0f1c55-16e5-4299-8861-f259293aaa29","timestamp":"2026-01-09T04:02:53.002Z","toolUseResult":{"type":"text","file":{"filePath":"/mnt/c/Users/o.young/work/architecture/modules/initiatives/nav.adoc","content":"\n.Initiatives\n* xref:flybuys_integration.adoc[Flybuys Integration]\n* xref:salesforce_customer_support.adoc[Salesforce Customer Support]\n","numLines":5,"startLine":1,"totalLines":5}},"sourceToolAssistantUUID":"094ae069-aebf-4702-8fc8-3efef15a0888"}
{"parentUuid":"904336d6-0d3c-4066-8492-b5dbaaa8843d","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01BGUTMGD47MpnK7pCgZs1R7","type":"tool_result","content":"modules/initiatives/nav.adoc","is_error":false}]},"uuid":"082b93bc-1665-45b1-a863-cae3db6c7a50","timestamp":"2026-01-09T04:02:53.073Z","toolUseResult":{"stdout":"modules/initiatives/nav.adoc","stderr":"","interrupted":false,"isImage":false},"sourceToolAssistantUUID":"904336d6-0d3c-4066-8492-b5dbaaa8843d"}
{"parentUuid":"058af32d-52af-45ca-afaa-2cbc6ef192d6","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01E6ukHJD8k8k94423YpQ4d5","type":"tool_result","content":"total 0\ndrwxrwxrwx 1 oliy oliy 4096 Jan  9 13:53 .\ndrwxrwxrwx 1 oliy oliy 4096 Jan  9 13:45 ..\n-rwxrwxrwx 1 oliy oliy  140 Jan  9 13:45 nav.adoc\ndrwxrwxrwx 1 oliy oliy 4096 Jan  9 13:53 pages","is_error":false}]},"uuid":"b4c979af-216d-4a0d-a0ff-51ba584f337e","timestamp":"2026-01-09T04:02:53.138Z","toolUseResult":{"stdout":"total 0\ndrwxrwxrwx 1 oliy oliy 4096 Jan  9 13:53 .\ndrwxrwxrwx 1 oliy oliy 4096 Jan  9 13:45 ..\n-rwxrwxrwx 1 oliy oliy  140 Jan  9 13:45 nav.adoc\ndrwxrwxrwx 1 oliy oliy 4096 Jan  9 13:53 pages","stderr":"","interrupted":false,"isImage":false},"sourceToolAssistantUUID":"058af32d-52af-45ca-afaa-2cbc6ef192d6"}
{"parentUuid":"b4c979af-216d-4a0d-a0ff-51ba584f337e","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01H1XvNi943tDnqH6eYRBRHR","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now let me check what's in the pages directory:","signature":"EtcBCkYICxgCKkDYPJEFGlsNmS7p/DGTfE0BEBrtn5dYMZFBYEIw+lJPTD2rc2XETR3cN5cP7YRT3pQ3SOXTZAaI/km6pW5+QvEyEgyIimEHnn6wChgksicaDFxEwUyDDZcmIxiSGiIwcrwnpd+Exz6DN16EPIn2M3ZajfKE0YY6AqyTl4i2Fzp6iY4uoujRV1FuUODTJqV7Kj+KT5B5KTAiGcSANm0i+s57Wl/G6RmtFX0Uu/xaeVL3Hxr+/RHZDu8pb23Y1PXmVHbT4aWgaMeJX8zHupFzNYUYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":46,"cache_creation_input_tokens":597,"cache_read_input_tokens":53585,"cache_creation":{"ephemeral_5m_input_tokens":597,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWw93kBdXT5y4SQ8cwNwP","type":"assistant","uuid":"9c8d547c-4069-4646-8334-11bf32a0163c","timestamp":"2026-01-09T04:02:56.645Z"}
{"parentUuid":"9c8d547c-4069-4646-8334-11bf32a0163c","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01H1XvNi943tDnqH6eYRBRHR","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01XRyW4KTqE2sPFf2X8Cwftw","name":"Bash","input":{"command":"ls -la modules/initiatives/pages/","description":"List initiative pages"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":46,"cache_creation_input_tokens":597,"cache_read_input_tokens":53585,"cache_creation":{"ephemeral_5m_input_tokens":597,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWw93kBdXT5y4SQ8cwNwP","type":"assistant","uuid":"ec0a57bd-2fa0-47b3-9cef-765483d5bfb6","timestamp":"2026-01-09T04:02:57.145Z"}
{"parentUuid":"ec0a57bd-2fa0-47b3-9cef-765483d5bfb6","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01H1XvNi943tDnqH6eYRBRHR","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01NLWP5SDmz14yookzSqxBUF","name":"Read","input":{"file_path":"/mnt/c/Users/o.young/work/architecture/antora.yml"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":46,"cache_creation_input_tokens":597,"cache_read_input_tokens":53585,"cache_creation":{"ephemeral_5m_input_tokens":597,"ephemeral_1h_input_tokens":0},"output_tokens":153,"service_tier":"standard"}},"requestId":"req_011CWw93kBdXT5y4SQ8cwNwP","type":"assistant","uuid":"589cda50-3143-4ea6-8afe-5a5ad63530c9","timestamp":"2026-01-09T04:02:57.639Z"}
{"parentUuid":"589cda50-3143-4ea6-8afe-5a5ad63530c9","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01NLWP5SDmz14yookzSqxBUF","type":"tool_result","content":"     1→name: architecture\n     2→title: OTR Digital Architecture\n     3→version: main\n     4→nav:\n     5→  - modules/ROOT/nav.adoc\n     6→  - modules/initiatives/nav.adoc\n     7→  - modules/bounded-contexts/nav.adoc\n     8→  - modules/domains/nav.adoc\n     9→  - modules/architecture-definitions/nav.adoc\n    10→  - modules/solution-architectures/nav.adoc\n    11→  - modules/events/nav.adoc\n    12→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"629869dd-7cf8-4ede-9a08-8cad6ed3d8c1","timestamp":"2026-01-09T04:02:58.017Z","toolUseResult":{"type":"text","file":{"filePath":"/mnt/c/Users/o.young/work/architecture/antora.yml","content":"name: architecture\ntitle: OTR Digital Architecture\nversion: main\nnav:\n  - modules/ROOT/nav.adoc\n  - modules/initiatives/nav.adoc\n  - modules/bounded-contexts/nav.adoc\n  - modules/domains/nav.adoc\n  - modules/architecture-definitions/nav.adoc\n  - modules/solution-architectures/nav.adoc\n  - modules/events/nav.adoc\n","numLines":12,"startLine":1,"totalLines":12}},"sourceToolAssistantUUID":"589cda50-3143-4ea6-8afe-5a5ad63530c9"}
{"parentUuid":"ec0a57bd-2fa0-47b3-9cef-765483d5bfb6","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01XRyW4KTqE2sPFf2X8Cwftw","type":"tool_result","content":"total 0\ndrwxrwxrwx 1 oliy oliy 4096 Jan  9 13:53 .\ndrwxrwxrwx 1 oliy oliy 4096 Jan  9 13:53 ..","is_error":false}]},"uuid":"ea171655-160c-43ce-aaf2-4dd1239cdf9c","timestamp":"2026-01-09T04:02:58.148Z","toolUseResult":{"stdout":"total 0\ndrwxrwxrwx 1 oliy oliy 4096 Jan  9 13:53 .\ndrwxrwxrwx 1 oliy oliy 4096 Jan  9 13:53 ..","stderr":"","interrupted":false,"isImage":false},"sourceToolAssistantUUID":"ec0a57bd-2fa0-47b3-9cef-765483d5bfb6"}
{"parentUuid":"ea171655-160c-43ce-aaf2-4dd1239cdf9c","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01FNqoMru3YvZZAVUhr6521T","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"I see the issue now. The navigation file at `modules/initiatives/nav.adoc` is referencing:\n- `xref:flybuys_integration.adoc`\n- `xref:salesforce_customer_support.adoc`\n\nBut the `modules/initiatives/pages/` directory is empty. The actual files are in the root-level `initiatives/` directory, not in the Antora module structure.\n\nIn Antora, pages need to be in `modules/<module-name>/pages/` for the navigation links to work. The xrefs are looking for files in `modules/initiatives/pages/` but they're not there.\n\nThe user needs to either:\n1. Move the files from `initiatives/` to `modules/initiatives/pages/`\n2. Or update the navigation to point to wherever the files actually are\n\nLet me check if there are other similar patterns in the repo to understand the intended structure.","signature":"EqwHCkYICxgCKkADSldDakLyq8fA4AN000cmVyeuKUNdPaC09HNW1+OgMfc8hUrXcBSZ8t6xF5f8QB43Lo+VRWUVoJsumnYy3KIdEgzGygDjQe2xmEw1B08aDCm58vUPy9NL2SduriIw6ralVus+/njsbQUs5ozMSm/Mcfwz96rqfmvA0upnSF0QqpU9MPeEY/ijllll5u77KpMGacjDQV0NWQZYiI7m7ypwocnICPuARn0LDHqwx79qhWutYhbeKGi3WAB1y7fSMV1ZRKESFXiVXq0qZ1dcER9bSqStCn/7oYLbq6KdjRNClyW3RwYBFRqUfb0h+DU254U1UauonhazMF0JFEGEDj+qHBH8Vpmrx0h6ocyJzo9hI0Rj4AjeQO/SkvzOhnvQn9eBRahPcNrcPRXQXuZoQqoEAQOHwsHn4XHUrhmfeO0jlRZHQomb9m6UWEwuFuUQ+dD0d7mtggQvLxQ2ePsVF0vp0YxAS5Pe+AJrtm81TQin7Sl0eE7IV7BcMFw2taCiE0suhis/0Ei2i8UXpOFcmybQCtW8FcEVcT4kKaVANvuqhFmlimwQ8eMhgK9u1Dw3EmS0sSicNyEzSOXPUocQaNoVzd047MXC55BN0tSCl0qrVAHVQUqusfRXuk/A5mxLkntylapllSIKhxpQWRp7EzRCbv9JhJ64P66/ECxzCanWXGmS/ikSRJjB20AzRzfIKQu6f1ad6VRpPwKLxdODG+INCkFgUciiCT7kBIS0THR8+XB9/0xKk8TjaY06fB7kW0Yx/zFXAYfVBhtdpinsrwJ9MfpJs1LcJLEYX/KLfidCi330rhMEk5ewo14Ke12aE/mbs5V8xVQ9T4GUzU844KTIFc6WAsHCZWUnQaT8xkge/5Hen1MjFyyR00tQh8ix3w2+XgOpsFC1X3RM9XbYnfj25L9Jt4nyT7yo1rOrSAJBGSwKWBA4eZwijT4r/AZAk8VXfsFsvW3CMrxow3a/J2lrfCrJXwCZnbQMk3fviiPWcPaV04KGDEX4pzqcsEilpghxjtMqtL34mdkirJ8jjKZh00alVGrrK+glLRaWYKIn3TpItNxPkH2ILl/vOID/JqkXa5uvBoJrb6G5SUA1ockMQ3XDhsl9P8ADLGKn/QJo7Z0de//MGiudzW9Qsz1H1ijhmbLRmg551F/plNFMXY/23TDs76goNxvUKKvKae32KFoToHFf0r4YhP4bCMqIoe8d+4HU094ncPnGlQxVyboD2k21vxgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":256,"cache_creation_input_tokens":292,"cache_read_input_tokens":54182,"cache_creation":{"ephemeral_5m_input_tokens":292,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CWw947VnNoyaU9KvJmt22","type":"assistant","uuid":"2ad69510-b779-444b-adf9-20306991a581","timestamp":"2026-01-09T04:03:05.079Z"}
{"parentUuid":"2ad69510-b779-444b-adf9-20306991a581","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01FNqoMru3YvZZAVUhr6521T","type":"message","role":"assistant","content":[{"type":"text","text":"I can see the issue. Your navigation file at `modules/initiatives/nav.adoc` is referencing:\n- `xref:flybuys_integration.adoc`\n- `xref:salesforce_customer_support.adoc`\n\nBut the `modules/initiatives/pages/` directory is **empty**, while the actual files are in the root-level `initiatives/` directory.\n\nIn Antora, pages must be located in `modules/<module-name>/pages/` for navigation links to work. Let me check the structure of other modules to confirm the pattern:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":256,"cache_creation_input_tokens":292,"cache_read_input_tokens":54182,"cache_creation":{"ephemeral_5m_input_tokens":292,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CWw947VnNoyaU9KvJmt22","type":"assistant","uuid":"7182a2e8-3c70-449b-95db-2865dc0a2f9e","timestamp":"2026-01-09T04:03:07.065Z"}
{"parentUuid":"7182a2e8-3c70-449b-95db-2865dc0a2f9e","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01FNqoMru3YvZZAVUhr6521T","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_011a4UkpwXKRkn3v4Lz31KxT","name":"Bash","input":{"command":"ls -la modules/solution-architectures/pages/ | head -10","description":"Check solution architectures structure"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":256,"cache_creation_input_tokens":292,"cache_read_input_tokens":54182,"cache_creation":{"ephemeral_5m_input_tokens":292,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CWw947VnNoyaU9KvJmt22","type":"assistant","uuid":"d327473f-df9e-4b15-9306-f1935e398dc2","timestamp":"2026-01-09T04:03:07.895Z"}
{"parentUuid":"d327473f-df9e-4b15-9306-f1935e398dc2","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01FNqoMru3YvZZAVUhr6521T","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01CWtcMtozz5e3rjr4i8mTeP","name":"Bash","input":{"command":"head -5 modules/solution-architectures/nav.adoc","description":"Check solution architectures nav"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":256,"cache_creation_input_tokens":292,"cache_read_input_tokens":54182,"cache_creation":{"ephemeral_5m_input_tokens":292,"ephemeral_1h_input_tokens":0},"output_tokens":500,"service_tier":"standard"}},"requestId":"req_011CWw947VnNoyaU9KvJmt22","type":"assistant","uuid":"ff214aac-e8bf-4555-8575-3db3d797ca68","timestamp":"2026-01-09T04:03:08.609Z"}
{"parentUuid":"ff214aac-e8bf-4555-8575-3db3d797ca68","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01CWtcMtozz5e3rjr4i8mTeP","type":"tool_result","content":".Solution Architectures\n* xref:flybuys_integration.adoc[Flybuys Integration]\n* xref:salesforce_customer_support.adoc[Salesforce Customer Support]","is_error":false}]},"uuid":"9bceaafc-77ae-4d87-bd46-4953d69d8c29","timestamp":"2026-01-09T04:03:08.871Z","toolUseResult":{"stdout":".Solution Architectures\n* xref:flybuys_integration.adoc[Flybuys Integration]\n* xref:salesforce_customer_support.adoc[Salesforce Customer Support]","stderr":"","interrupted":false,"isImage":false},"sourceToolAssistantUUID":"ff214aac-e8bf-4555-8575-3db3d797ca68"}
{"parentUuid":"d327473f-df9e-4b15-9306-f1935e398dc2","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_011a4UkpwXKRkn3v4Lz31KxT","type":"tool_result","content":"total 0\ndrwxrwxrwx 1 oliy oliy 4096 Jan  9 09:11 .\ndrwxrwxrwx 1 oliy oliy 4096 Jan  9 10:55 ..\nlrwxrwxrwx 1 oliy oliy   56 Jan  9 09:11 flybuys_integration.adoc -> ../../../solution_architectures/flybuys_integration.adoc\nlrwxrwxrwx 1 oliy oliy   64 Jan  9 09:11 salesforce_customer_support.adoc -> ../../../solution_architectures/salesforce_customer_support.adoc","is_error":false}]},"uuid":"2311b555-e112-4dda-baab-f33732353a5d","timestamp":"2026-01-09T04:03:08.956Z","toolUseResult":{"stdout":"total 0\ndrwxrwxrwx 1 oliy oliy 4096 Jan  9 09:11 .\ndrwxrwxrwx 1 oliy oliy 4096 Jan  9 10:55 ..\nlrwxrwxrwx 1 oliy oliy   56 Jan  9 09:11 flybuys_integration.adoc -> ../../../solution_architectures/flybuys_integration.adoc\nlrwxrwxrwx 1 oliy oliy   64 Jan  9 09:11 salesforce_customer_support.adoc -> ../../../solution_architectures/salesforce_customer_support.adoc","stderr":"","interrupted":false,"isImage":false},"sourceToolAssistantUUID":"d327473f-df9e-4b15-9306-f1935e398dc2"}
{"parentUuid":"2311b555-e112-4dda-baab-f33732353a5d","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01UHYRR5jNEdKFCpPQ8nT36F","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Aha! I see the pattern now. The solution architectures module uses symlinks from `modules/solution-architectures/pages/` pointing back to the actual files in `solution_architectures/` at the root level.\n\nSo the user needs to create symlinks from `modules/initiatives/pages/` to the actual files in `initiatives/` at the root level.","signature":"EvIDCkYICxgCKkDZGXbcoXONYqcv+ziyNd4+gGIXgfHN12HS53bTPA7C4+tqZ4DZsc4eVDbo+TsWi2fryuYjvzD/iQTjKI8lZ3xQEgyDVDJvUs8rRBUPjvUaDGMhGUnEBWZ2CsmnLyIw5HfltQkhaiWd7M38fAQYV7+1oYiuZ2bFDPRPNUTFa+BThtB5+7oCfK3D/tBAm5e5KtkCzFyIiPtO80FZuXf8kya9P0mtkyRKUooQeyZ9IHpV1qHgrqO9Rh4G7f8ch8PAmPfcM7vOIOW0mZsOSETAx1ZF7vdg5NHFm+i34c3n/nGbYKKcfzsW+KQd9z6LYewAL4rtf837QTbyaqPg8NFCP95go4j7dakwcDGtJnMs9Q4aA/Qrxl+VDXboBDJqL5E4ZTsSxocjjfPcZxrU/PuSNYTGWBrvPoMi+4XzFd7tldYMKscYIYaHgE3nbjIUVVDG/uEkckdK4uXWe9PbBR8PX4kDqNCj8LM6vyeFbzUCSdRRFBOiXlgLPwM4l3iXK9zzxkzESrHx8MOlGVkC3anE50Ho+HZBDwues+NwhvvC81PdjoImKSBvdtJqM2XqRgZNqYX7NvmrYLNZ2zYOlPS43yaSOw6A56VOWh+f6DsE1KU+I2UlYIJHc1ARAzq4eO4F0SHWw39ODv8GePAOGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":83,"cache_creation_input_tokens":952,"cache_read_input_tokens":54474,"cache_creation":{"ephemeral_5m_input_tokens":952,"ephemeral_1h_input_tokens":0},"output_tokens":10,"service_tier":"standard"}},"requestId":"req_011CWw94uGr9FruSKDTNFCr2","type":"assistant","uuid":"abb751a9-56fe-4a6c-84b0-4b64f96ebddc","timestamp":"2026-01-09T04:03:14.064Z"}
{"parentUuid":"abb751a9-56fe-4a6c-84b0-4b64f96ebddc","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01UHYRR5jNEdKFCpPQ8nT36F","type":"message","role":"assistant","content":[{"type":"text","text":"Perfect! I can see the pattern. The `modules/solution-architectures/pages/` directory uses **symlinks** pointing to the actual files in the root-level `solution_architectures/` directory.\n\nYou need to create similar symlinks for your initiatives. Here's the fix:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":83,"cache_creation_input_tokens":952,"cache_read_input_tokens":54474,"cache_creation":{"ephemeral_5m_input_tokens":952,"ephemeral_1h_input_tokens":0},"output_tokens":10,"service_tier":"standard"}},"requestId":"req_011CWw94uGr9FruSKDTNFCr2","type":"assistant","uuid":"82a1cf51-8d0a-485b-94e3-358795a53f19","timestamp":"2026-01-09T04:03:15.267Z"}
{"parentUuid":"82a1cf51-8d0a-485b-94e3-358795a53f19","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01UHYRR5jNEdKFCpPQ8nT36F","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_015V3ap6cUyxwmZPYnNJ3CQT","name":"Bash","input":{"command":"cd modules/initiatives/pages && ln -s ../../../initiatives/flybuys_integration.adoc flybuys_integration.adoc && ln -s ../../../initiatives/salesforce_customer_support.adoc salesforce_customer_support.adoc && ls -la","description":"Create symlinks for initiative pages"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":83,"cache_creation_input_tokens":952,"cache_read_input_tokens":54474,"cache_creation":{"ephemeral_5m_input_tokens":952,"ephemeral_1h_input_tokens":0},"output_tokens":285,"service_tier":"standard"}},"requestId":"req_011CWw94uGr9FruSKDTNFCr2","type":"assistant","uuid":"1f6ebb70-f9fa-4dac-9066-eca7b6a7ea04","timestamp":"2026-01-09T04:03:16.420Z"}
{"parentUuid":"1f6ebb70-f9fa-4dac-9066-eca7b6a7ea04","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture/modules/initiatives/pages","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_015V3ap6cUyxwmZPYnNJ3CQT","type":"tool_result","content":"total 0\ndrwxrwxrwx 1 oliy oliy 4096 Jan  9 14:33 .\ndrwxrwxrwx 1 oliy oliy 4096 Jan  9 13:53 ..\nlrwxrwxrwx 1 oliy oliy   45 Jan  9 14:33 flybuys_integration.adoc -> ../../../initiatives/flybuys_integration.adoc\nlrwxrwxrwx 1 oliy oliy   53 Jan  9 14:33 salesforce_customer_support.adoc -> ../../../initiatives/salesforce_customer_support.adoc","is_error":false}]},"uuid":"eae468e3-9146-4c61-b7c5-c69d99f9cf62","timestamp":"2026-01-09T04:03:16.725Z","toolUseResult":{"stdout":"total 0\ndrwxrwxrwx 1 oliy oliy 4096 Jan  9 14:33 .\ndrwxrwxrwx 1 oliy oliy 4096 Jan  9 13:53 ..\nlrwxrwxrwx 1 oliy oliy   45 Jan  9 14:33 flybuys_integration.adoc -> ../../../initiatives/flybuys_integration.adoc\nlrwxrwxrwx 1 oliy oliy   53 Jan  9 14:33 salesforce_customer_support.adoc -> ../../../initiatives/salesforce_customer_support.adoc","stderr":"","interrupted":false,"isImage":false},"sourceToolAssistantUUID":"1f6ebb70-f9fa-4dac-9066-eca7b6a7ea04"}
{"parentUuid":"eae468e3-9146-4c61-b7c5-c69d99f9cf62","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture/modules/initiatives/pages","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01P1tGt6pbnqtkSNmCAFyfaz","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Great! The symlinks have been created. Now let me verify that the navigation should work properly. Let me also check what the git status looks like now.","signature":"EsECCkYICxgCKkBV+P7Frakj6BmJ8vhR0rC8N47iHy/NPEa7Jxw0FMlHeP7Lyszg685FXRAJJdNYjJcPkjHpiRuWAxXLgOyYlL/REgzHWdcrNaKib+g8K9YaDJwPyteW93x7akgmECIwK2/7I8ddDFYHMcQ+D3TJSuKpwZZiOJieQ+4GrlbQbXrwnSIi3lUG07njjetdlr3AKqgBLqn/VMzfSOU6NrSCxxKSTF9hKAsqY0RiCOMTP45qzs4IP+5ZhknHx6KYmt5s5iv8GIws2e32ADsKyj9PG0PGlhR0WQ0PC+YUTMm/AVSIMiTJ8fp1A5PIbELIOp915pV8p042jpIboHKfVTcE/L8Ga5YMc9sqtPQmyEMM9nV7eaet6SAGd+5E+91JkIB9Dr39PPMfIYUVP6LkgogRnfn+gQLd631qfoGlGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":642,"cache_read_input_tokens":55426,"cache_creation":{"ephemeral_5m_input_tokens":642,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWw95UjW6Fud3t4UrZAWF","type":"assistant","uuid":"a9628d5a-3ec9-43fc-9bf0-a5ca839ef131","timestamp":"2026-01-09T04:03:21.195Z"}
{"parentUuid":"a9628d5a-3ec9-43fc-9bf0-a5ca839ef131","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture/modules/initiatives/pages","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01P1tGt6pbnqtkSNmCAFyfaz","type":"message","role":"assistant","content":[{"type":"text","text":"Perfect! I've created the symlinks. Now let me verify the setup and commit these changes:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":642,"cache_read_input_tokens":55426,"cache_creation":{"ephemeral_5m_input_tokens":642,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWw95UjW6Fud3t4UrZAWF","type":"assistant","uuid":"27278d6f-2471-4797-aa56-38b6bd4a9547","timestamp":"2026-01-09T04:03:21.864Z"}
{"parentUuid":"27278d6f-2471-4797-aa56-38b6bd4a9547","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture/modules/initiatives/pages","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01P1tGt6pbnqtkSNmCAFyfaz","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_015okFpQ8CUQMRxNUacMwV5D","name":"Bash","input":{"command":"git status","description":"Check git status after creating symlinks"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":642,"cache_read_input_tokens":55426,"cache_creation":{"ephemeral_5m_input_tokens":642,"ephemeral_1h_input_tokens":0},"output_tokens":137,"service_tier":"standard"}},"requestId":"req_011CWw95UjW6Fud3t4UrZAWF","type":"assistant","uuid":"494ac5a3-a9c0-4745-bde6-273e96853bec","timestamp":"2026-01-09T04:03:22.367Z"}
{"parentUuid":"494ac5a3-a9c0-4745-bde6-273e96853bec","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture/modules/initiatives/pages","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_015okFpQ8CUQMRxNUacMwV5D","type":"tool_result","content":"On branch main\nYour branch is up to date with 'origin/main'.\n\nChanges not staged for commit:\n  (use \"git add/rm <file>...\" to update what will be committed)\n  (use \"git restore <file>...\" to discard changes in working directory)\n\tmodified:   ../../../.claude/settings.local.json\n\tmodified:   ../../../antora.yml\n\tmodified:   ../../../architecture_definitions/flybuys_integration.adoc\n\tmodified:   ../../../architecture_definitions/salesforce_customer_support.adoc\n\tdeleted:    ../../../convert-xrefs.py\n\tdeleted:    ../../../executive_summaries/flybuys_integration.adoc\n\tdeleted:    ../../../executive_summaries/salesforce_customer_support.adoc\n\tmodified:   ../../ROOT/nav.adoc\n\tmodified:   ../../ROOT/pages/index.adoc\n\tmodified:   ../../architecture-definitions/nav.adoc\n\tmodified:   ../../bounded-contexts/nav.adoc\n\tmodified:   ../../solution-architectures/nav.adoc\n\nUntracked files:\n  (use \"git add <file>...\" to include in what will be committed)\n\t../../../initiatives/\n\t../../ROOT/pages/salesforce_customer_support.adoc\n\t../\n\nno changes added to commit (use \"git add\" and/or \"git commit -a\")","is_error":false}]},"uuid":"92ca0daa-d04c-4ab6-8e8c-19a83d847867","timestamp":"2026-01-09T04:03:23.313Z","toolUseResult":{"stdout":"On branch main\nYour branch is up to date with 'origin/main'.\n\nChanges not staged for commit:\n  (use \"git add/rm <file>...\" to update what will be committed)\n  (use \"git restore <file>...\" to discard changes in working directory)\n\tmodified:   ../../../.claude/settings.local.json\n\tmodified:   ../../../antora.yml\n\tmodified:   ../../../architecture_definitions/flybuys_integration.adoc\n\tmodified:   ../../../architecture_definitions/salesforce_customer_support.adoc\n\tdeleted:    ../../../convert-xrefs.py\n\tdeleted:    ../../../executive_summaries/flybuys_integration.adoc\n\tdeleted:    ../../../executive_summaries/salesforce_customer_support.adoc\n\tmodified:   ../../ROOT/nav.adoc\n\tmodified:   ../../ROOT/pages/index.adoc\n\tmodified:   ../../architecture-definitions/nav.adoc\n\tmodified:   ../../bounded-contexts/nav.adoc\n\tmodified:   ../../solution-architectures/nav.adoc\n\nUntracked files:\n  (use \"git add <file>...\" to include in what will be committed)\n\t../../../initiatives/\n\t../../ROOT/pages/salesforce_customer_support.adoc\n\t../\n\nno changes added to commit (use \"git add\" and/or \"git commit -a\")","stderr":"","interrupted":false,"isImage":false},"sourceToolAssistantUUID":"494ac5a3-a9c0-4745-bde6-273e96853bec"}
{"parentUuid":"92ca0daa-d04c-4ab6-8e8c-19a83d847867","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture/modules/initiatives/pages","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01FxeVG98SrLpP4WoGC9EXpL","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Let me go back to the root directory to see the full picture better.","signature":"EuwBCkYICxgCKkB2Pb3zhs85RjWhWss89MaK22ud4uU9xbj45YtRqAa/WQ+QVBaiP2JCp203ir0TIjrz6qcVGue9n8j6RSTNJQN0EgzzNpu187SltDH2AkYaDElR+pGv/UbC/sTX/SIwZ3DJrJ/rmCmqcA1tmgjoP/Y7kbOKTZfaktb2UP0eLOi5txxgX+bKSB+P/HP+rbiOKlQsV9zqVN9L/+theSUh+tcN9z3iQ9rkcYUM5kUqB4oJmfvBVILMmclEunZd9JXiSQfabji2eEq8FCkCCE+XCbOdmau3ItS9jAE4i//6dL3mzSmvSwcYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":485,"cache_read_input_tokens":56068,"cache_creation":{"ephemeral_5m_input_tokens":485,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CWw95xdHitqmkZnET1rFo","type":"assistant","uuid":"aa09fdf1-e530-4745-86c1-a0cbd4e3bd57","timestamp":"2026-01-09T04:03:27.163Z"}
{"parentUuid":"aa09fdf1-e530-4745-86c1-a0cbd4e3bd57","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture/modules/initiatives/pages","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01FxeVG98SrLpP4WoGC9EXpL","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01V7vcaLUACgv5xbkb96S3DJ","name":"Bash","input":{"command":"cd /mnt/c/Users/o.young/work/architecture && git status","description":"Check git status from root"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":485,"cache_read_input_tokens":56068,"cache_creation":{"ephemeral_5m_input_tokens":485,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CWw95xdHitqmkZnET1rFo","type":"assistant","uuid":"5752ac54-873a-4d78-a7b5-431168be2831","timestamp":"2026-01-09T04:03:27.769Z"}
{"parentUuid":"5752ac54-873a-4d78-a7b5-431168be2831","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture/modules/initiatives/pages","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01FxeVG98SrLpP4WoGC9EXpL","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01X3WDn5eZDACFz71M1pNkWv","name":"Bash","input":{"command":"git add initiatives/ modules/initiatives/pages/ && git status","description":"Add initiatives files and symlinks"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":485,"cache_read_input_tokens":56068,"cache_creation":{"ephemeral_5m_input_tokens":485,"ephemeral_1h_input_tokens":0},"output_tokens":183,"service_tier":"standard"}},"requestId":"req_011CWw95xdHitqmkZnET1rFo","type":"assistant","uuid":"c3edda00-39fc-46c9-9e87-53e13fbfde75","timestamp":"2026-01-09T04:03:28.759Z"}
{"parentUuid":"5752ac54-873a-4d78-a7b5-431168be2831","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01V7vcaLUACgv5xbkb96S3DJ","type":"tool_result","content":"On branch main\nYour branch is up to date with 'origin/main'.\n\nChanges not staged for commit:\n  (use \"git add/rm <file>...\" to update what will be committed)\n  (use \"git restore <file>...\" to discard changes in working directory)\n\tmodified:   .claude/settings.local.json\n\tmodified:   antora.yml\n\tmodified:   architecture_definitions/flybuys_integration.adoc\n\tmodified:   architecture_definitions/salesforce_customer_support.adoc\n\tdeleted:    convert-xrefs.py\n\tdeleted:    executive_summaries/flybuys_integration.adoc\n\tdeleted:    executive_summaries/salesforce_customer_support.adoc\n\tmodified:   modules/ROOT/nav.adoc\n\tmodified:   modules/ROOT/pages/index.adoc\n\tmodified:   modules/architecture-definitions/nav.adoc\n\tmodified:   modules/bounded-contexts/nav.adoc\n\tmodified:   modules/solution-architectures/nav.adoc\n\nUntracked files:\n  (use \"git add <file>...\" to include in what will be committed)\n\tinitiatives/\n\tmodules/ROOT/pages/salesforce_customer_support.adoc\n\tmodules/initiatives/\n\nno changes added to commit (use \"git add\" and/or \"git commit -a\")","is_error":false}]},"uuid":"df631c54-b087-40a2-9c61-6b5abb00ace7","timestamp":"2026-01-09T04:03:34.782Z","toolUseResult":{"stdout":"On branch main\nYour branch is up to date with 'origin/main'.\n\nChanges not staged for commit:\n  (use \"git add/rm <file>...\" to update what will be committed)\n  (use \"git restore <file>...\" to discard changes in working directory)\n\tmodified:   .claude/settings.local.json\n\tmodified:   antora.yml\n\tmodified:   architecture_definitions/flybuys_integration.adoc\n\tmodified:   architecture_definitions/salesforce_customer_support.adoc\n\tdeleted:    convert-xrefs.py\n\tdeleted:    executive_summaries/flybuys_integration.adoc\n\tdeleted:    executive_summaries/salesforce_customer_support.adoc\n\tmodified:   modules/ROOT/nav.adoc\n\tmodified:   modules/ROOT/pages/index.adoc\n\tmodified:   modules/architecture-definitions/nav.adoc\n\tmodified:   modules/bounded-contexts/nav.adoc\n\tmodified:   modules/solution-architectures/nav.adoc\n\nUntracked files:\n  (use \"git add <file>...\" to include in what will be committed)\n\tinitiatives/\n\tmodules/ROOT/pages/salesforce_customer_support.adoc\n\tmodules/initiatives/\n\nno changes added to commit (use \"git add\" and/or \"git commit -a\")","stderr":"","interrupted":false,"isImage":false},"sourceToolAssistantUUID":"5752ac54-873a-4d78-a7b5-431168be2831"}
{"parentUuid":"c3edda00-39fc-46c9-9e87-53e13fbfde75","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01X3WDn5eZDACFz71M1pNkWv","type":"tool_result","content":"On branch main\nYour branch is up to date with 'origin/main'.\n\nChanges to be committed:\n  (use \"git restore --staged <file>...\" to unstage)\n\tnew file:   initiatives/flybuys_integration.adoc\n\tnew file:   initiatives/salesforce_customer_support.adoc\n\tnew file:   modules/initiatives/pages/flybuys_integration.adoc\n\tnew file:   modules/initiatives/pages/salesforce_customer_support.adoc\n\nChanges not staged for commit:\n  (use \"git add/rm <file>...\" to update what will be committed)\n  (use \"git restore <file>...\" to discard changes in working directory)\n\tmodified:   .claude/settings.local.json\n\tmodified:   antora.yml\n\tmodified:   architecture_definitions/flybuys_integration.adoc\n\tmodified:   architecture_definitions/salesforce_customer_support.adoc\n\tdeleted:    convert-xrefs.py\n\tdeleted:    executive_summaries/flybuys_integration.adoc\n\tdeleted:    executive_summaries/salesforce_customer_support.adoc\n\tmodified:   modules/ROOT/nav.adoc\n\tmodified:   modules/ROOT/pages/index.adoc\n\tmodified:   modules/architecture-definitions/nav.adoc\n\tmodified:   modules/bounded-contexts/nav.adoc\n\tmodified:   modules/solution-architectures/nav.adoc\n\nUntracked files:\n  (use \"git add <file>...\" to include in what will be committed)\n\tmodules/ROOT/pages/salesforce_customer_support.adoc\n\tmodules/initiatives/nav.adoc\nwarning: in the working copy of 'initiatives/flybuys_integration.adoc', CRLF will be replaced by LF the next time Git touches it","is_error":false}]},"uuid":"6a9c7112-345b-4c34-a306-d54d9e4e4a2e","timestamp":"2026-01-09T04:03:37.497Z","toolUseResult":{"stdout":"On branch main\nYour branch is up to date with 'origin/main'.\n\nChanges to be committed:\n  (use \"git restore --staged <file>...\" to unstage)\n\tnew file:   initiatives/flybuys_integration.adoc\n\tnew file:   initiatives/salesforce_customer_support.adoc\n\tnew file:   modules/initiatives/pages/flybuys_integration.adoc\n\tnew file:   modules/initiatives/pages/salesforce_customer_support.adoc\n\nChanges not staged for commit:\n  (use \"git add/rm <file>...\" to update what will be committed)\n  (use \"git restore <file>...\" to discard changes in working directory)\n\tmodified:   .claude/settings.local.json\n\tmodified:   antora.yml\n\tmodified:   architecture_definitions/flybuys_integration.adoc\n\tmodified:   architecture_definitions/salesforce_customer_support.adoc\n\tdeleted:    convert-xrefs.py\n\tdeleted:    executive_summaries/flybuys_integration.adoc\n\tdeleted:    executive_summaries/salesforce_customer_support.adoc\n\tmodified:   modules/ROOT/nav.adoc\n\tmodified:   modules/ROOT/pages/index.adoc\n\tmodified:   modules/architecture-definitions/nav.adoc\n\tmodified:   modules/bounded-contexts/nav.adoc\n\tmodified:   modules/solution-architectures/nav.adoc\n\nUntracked files:\n  (use \"git add <file>...\" to include in what will be committed)\n\tmodules/ROOT/pages/salesforce_customer_support.adoc\n\tmodules/initiatives/nav.adoc\nwarning: in the working copy of 'initiatives/flybuys_integration.adoc', CRLF will be replaced by LF the next time Git touches it","stderr":"","interrupted":false,"isImage":false},"sourceToolAssistantUUID":"c3edda00-39fc-46c9-9e87-53e13fbfde75"}
{"parentUuid":"6a9c7112-345b-4c34-a306-d54d9e4e4a2e","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01HMNnFAqptVuZG5GfLAK4QF","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"I see the initiatives module nav.adoc file is showing as untracked. I should add that as well. Let me add it and then commit all the initiative-related changes together.","signature":"EtICCkYICxgCKkBrr4FBon+pqUoVEsqnYx6LZvnMWNZnFnlKUeOKxn2TtGA1SEI2K6Vz/tIw6C/hT1/YsspKCP+XmdUAHFkEv7kgEgwavxHUthoFe1Ruv4EaDJX6UiX9dKDmozzRQSIwDM5sP2VSQWy5qZkY4dCFljvn4ULS4Sy60btpf//9H9GssHu2IO4TzBnqkCRUR3nDKrkBfANXuq7TJawJtjFjoS9XkAJBSi64bnWO/bF+GDnrZSRP9ntmICSi+umzOe6dl8NJPHBgvDxtJpV5m6t87g9Xw2BztbYoMK4Br7uVRQ5v6aZbZd4cdX2Ie/qMcf14XZlJcq3yTg88AW00fIUBNWUam495hIZ71q/7wf0hzkGz1eZOmjpqrqai1Lpe0iaHnvO6hN3iQx6BXyMbFDOULxdpbCj7019v3Okbf7c6PU4vNYKxEkRa2twUgnYYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":997,"cache_read_input_tokens":56553,"cache_creation":{"ephemeral_5m_input_tokens":997,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWw971e96SRFVKePhRitK","type":"assistant","uuid":"c5fb4f4f-6941-416e-a2d4-32d29afd60f1","timestamp":"2026-01-09T04:03:41.720Z"}
{"parentUuid":"c5fb4f4f-6941-416e-a2d4-32d29afd60f1","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01HMNnFAqptVuZG5GfLAK4QF","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01NKZAUs5RheNhxiVu8X11gb","name":"Bash","input":{"command":"git add modules/initiatives/nav.adoc && git status","description":"Add initiatives nav file"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":997,"cache_read_input_tokens":56553,"cache_creation":{"ephemeral_5m_input_tokens":997,"ephemeral_1h_input_tokens":0},"output_tokens":131,"service_tier":"standard"}},"requestId":"req_011CWw971e96SRFVKePhRitK","type":"assistant","uuid":"931d7092-5085-4234-8dac-e58937533c15","timestamp":"2026-01-09T04:03:42.392Z"}
{"parentUuid":"931d7092-5085-4234-8dac-e58937533c15","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01NKZAUs5RheNhxiVu8X11gb","type":"tool_result","content":"On branch main\nYour branch is up to date with 'origin/main'.\n\nChanges to be committed:\n  (use \"git restore --staged <file>...\" to unstage)\n\tnew file:   initiatives/flybuys_integration.adoc\n\tnew file:   initiatives/salesforce_customer_support.adoc\n\tnew file:   modules/initiatives/nav.adoc\n\tnew file:   modules/initiatives/pages/flybuys_integration.adoc\n\tnew file:   modules/initiatives/pages/salesforce_customer_support.adoc\n\nChanges not staged for commit:\n  (use \"git add/rm <file>...\" to update what will be committed)\n  (use \"git restore <file>...\" to discard changes in working directory)\n\tmodified:   .claude/settings.local.json\n\tmodified:   antora.yml\n\tmodified:   architecture_definitions/flybuys_integration.adoc\n\tmodified:   architecture_definitions/salesforce_customer_support.adoc\n\tdeleted:    convert-xrefs.py\n\tdeleted:    executive_summaries/flybuys_integration.adoc\n\tdeleted:    executive_summaries/salesforce_customer_support.adoc\n\tmodified:   modules/ROOT/nav.adoc\n\tmodified:   modules/ROOT/pages/index.adoc\n\tmodified:   modules/architecture-definitions/nav.adoc\n\tmodified:   modules/bounded-contexts/nav.adoc\n\tmodified:   modules/solution-architectures/nav.adoc\n\nUntracked files:\n  (use \"git add <file>...\" to include in what will be committed)\n\tmodules/ROOT/pages/salesforce_customer_support.adoc\nwarning: in the working copy of 'modules/initiatives/nav.adoc', CRLF will be replaced by LF the next time Git touches it","is_error":false}]},"uuid":"a8581eb8-dba2-4b94-9d7e-647f18bb766a","timestamp":"2026-01-09T04:03:43.725Z","toolUseResult":{"stdout":"On branch main\nYour branch is up to date with 'origin/main'.\n\nChanges to be committed:\n  (use \"git restore --staged <file>...\" to unstage)\n\tnew file:   initiatives/flybuys_integration.adoc\n\tnew file:   initiatives/salesforce_customer_support.adoc\n\tnew file:   modules/initiatives/nav.adoc\n\tnew file:   modules/initiatives/pages/flybuys_integration.adoc\n\tnew file:   modules/initiatives/pages/salesforce_customer_support.adoc\n\nChanges not staged for commit:\n  (use \"git add/rm <file>...\" to update what will be committed)\n  (use \"git restore <file>...\" to discard changes in working directory)\n\tmodified:   .claude/settings.local.json\n\tmodified:   antora.yml\n\tmodified:   architecture_definitions/flybuys_integration.adoc\n\tmodified:   architecture_definitions/salesforce_customer_support.adoc\n\tdeleted:    convert-xrefs.py\n\tdeleted:    executive_summaries/flybuys_integration.adoc\n\tdeleted:    executive_summaries/salesforce_customer_support.adoc\n\tmodified:   modules/ROOT/nav.adoc\n\tmodified:   modules/ROOT/pages/index.adoc\n\tmodified:   modules/architecture-definitions/nav.adoc\n\tmodified:   modules/bounded-contexts/nav.adoc\n\tmodified:   modules/solution-architectures/nav.adoc\n\nUntracked files:\n  (use \"git add <file>...\" to include in what will be committed)\n\tmodules/ROOT/pages/salesforce_customer_support.adoc\nwarning: in the working copy of 'modules/initiatives/nav.adoc', CRLF will be replaced by LF the next time Git touches it","stderr":"","interrupted":false,"isImage":false},"sourceToolAssistantUUID":"931d7092-5085-4234-8dac-e58937533c15"}
{"parentUuid":"a8581eb8-dba2-4b94-9d7e-647f18bb766a","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_012h3XJyForJyC1NiKBGyhh1","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Good! Now I'll commit these initiative files with the symlinks that will fix the navigation.","signature":"EoQCCkYICxgCKkCzkVOgbyssWXpkjxHMxjUSspa24zbVw1Qg1gIHzCh1DFbz+L7FCf/Zj+BHdqZnQhZaW6YZlC9VS2l6fLjFt3bLEgy0GMRKGwWyryvkCpwaDBa3G/4JvUGIQ1nisiIwZqCJl5TqYsj5wFG4qr3bU2KJg1Q6bcu84WQv5gHbFsHm7yhtjVaSmKgt9/bunVSIKmxpedilKFF8r87lqVozwclFkKltRpDkn7FLZi/KgfdApEp9RBKt70g5yyz4hd6AiDlaxrz1BZ1BccBFVBIL/E/o9ltZ1MkBv+B8aUVWOX4snPsEjxGYVPD57D0D1EB0/dnuRvsrZU+Hyd8fzncYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":583,"cache_read_input_tokens":57550,"cache_creation":{"ephemeral_5m_input_tokens":583,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWw97U5NTbSTBfMGDnGXk","type":"assistant","uuid":"49000532-adea-4c8a-a405-1ed8e11fc580","timestamp":"2026-01-09T04:03:48.001Z"}
{"parentUuid":"49000532-adea-4c8a-a405-1ed8e11fc580","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_012h3XJyForJyC1NiKBGyhh1","type":"message","role":"assistant","content":[{"type":"text","text":"Now I'll commit these changes to fix the navigation:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":583,"cache_read_input_tokens":57550,"cache_creation":{"ephemeral_5m_input_tokens":583,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWw97U5NTbSTBfMGDnGXk","type":"assistant","uuid":"1eecf883-1fd4-4d9a-bb93-a129500802d1","timestamp":"2026-01-09T04:03:48.289Z"}
{"parentUuid":"1eecf883-1fd4-4d9a-bb93-a129500802d1","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_012h3XJyForJyC1NiKBGyhh1","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01BzbuDWAw75cFaxb2P4gTLD","name":"Bash","input":{"command":"git commit -m \"$(cat <<'EOF'\nfix: Add symlinks for initiatives module to fix navigation\n\n- Created symlinks from modules/initiatives/pages/ to initiatives/ directory\n- Added initiatives navigation file\n- Added initiative documents for Flybuys and Salesforce\n- Follows same pattern as solution-architectures module\n\nThis fixes the broken navigation links for initiative documents.\n\nCo-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>\nEOF\n)\" && git push","description":"Commit and push initiatives fix"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":583,"cache_read_input_tokens":57550,"cache_creation":{"ephemeral_5m_input_tokens":583,"ephemeral_1h_input_tokens":0},"output_tokens":228,"service_tier":"standard"}},"requestId":"req_011CWw97U5NTbSTBfMGDnGXk","type":"assistant","uuid":"e87dc355-09c5-4094-b664-082740b4563a","timestamp":"2026-01-09T04:03:51.720Z"}
{"parentUuid":"e87dc355-09c5-4094-b664-082740b4563a","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01BzbuDWAw75cFaxb2P4gTLD","type":"tool_result","content":"[main dee09e5] fix: Add symlinks for initiatives module to fix navigation\n 5 files changed, 757 insertions(+)\n create mode 100644 initiatives/flybuys_integration.adoc\n create mode 100644 initiatives/salesforce_customer_support.adoc\n create mode 100644 modules/initiatives/nav.adoc\n create mode 120000 modules/initiatives/pages/flybuys_integration.adoc\n create mode 120000 modules/initiatives/pages/salesforce_customer_support.adoc\nTo https://github.com/otr-digital/architecture.git\n   42c06e2..dee09e5  main -> main","is_error":false}]},"uuid":"e734fbf9-89c5-46b5-8b6e-943463a78d13","timestamp":"2026-01-09T04:03:58.083Z","toolUseResult":{"stdout":"[main dee09e5] fix: Add symlinks for initiatives module to fix navigation\n 5 files changed, 757 insertions(+)\n create mode 100644 initiatives/flybuys_integration.adoc\n create mode 100644 initiatives/salesforce_customer_support.adoc\n create mode 100644 modules/initiatives/nav.adoc\n create mode 120000 modules/initiatives/pages/flybuys_integration.adoc\n create mode 120000 modules/initiatives/pages/salesforce_customer_support.adoc\nTo https://github.com/otr-digital/architecture.git\n   42c06e2..dee09e5  main -> main","stderr":"","interrupted":false,"isImage":false},"sourceToolAssistantUUID":"e87dc355-09c5-4094-b664-082740b4563a"}
{"parentUuid":"e734fbf9-89c5-46b5-8b6e-943463a78d13","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01RhCTRAr2iAVYP3xPL8QEhR","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Great! The fix has been committed and pushed. Let me explain what the issue was and what I did to fix it.","signature":"EpECCkYICxgCKkANq8HPF6mlhxxisFUUW3O1KU87EK+ry/QW1pXV20nr14bx79g17dYh+dIRNvNbRjTfnwXuFk2KX3J2Sp3qr/3NEgz6caL/pJ4iUQdYs4waDAWKihBWeDi64c+etCIw+cCbq5dwgQbIu6JKUSPR75XhOD3XYu8BwVdzSV2uxkbQ9Kmr44q/Kohh80bx0iR8Knm7nbLZ6B2vzAxpwX95uWp98+uG/VMsjE3FM4E2QauB4HOxQgpoPa6Voi2Gan38KAHbbL7quGGyAvHlQPCSA2jlebLY05GjuEICtQd7U/3Lw7MD1tyTdKMw0Z/FvZqj5OkeDsoKnf+VurDWTV5NeXinG4Niuykfs0DyGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":409,"cache_read_input_tokens":58133,"cache_creation":{"ephemeral_5m_input_tokens":409,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWw98Y9xkrfBbkqJ3UjzV","type":"assistant","uuid":"78c6c408-a408-4a04-b763-928972190a38","timestamp":"2026-01-09T04:04:01.931Z"}
{"parentUuid":"78c6c408-a408-4a04-b763-928972190a38","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01RhCTRAr2iAVYP3xPL8QEhR","type":"message","role":"assistant","content":[{"type":"text","text":"Perfect! I've fixed your initiative navigation issue and pushed the changes.\n\n## The Problem\n\nYour initiative documents were in the `initiatives/` directory at the root level, but Antora was looking for them in `modules/initiatives/pages/`. In Antora, navigation xrefs like `xref:flybuys_integration.adoc` resolve relative to the module's `pages/` directory.\n\n## The Solution\n\nI created **symlinks** from `modules/initiatives/pages/` pointing back to the actual files in `initiatives/`:\n- `modules/initiatives/pages/flybuys_integration.adoc` → `../../../initiatives/flybuys_integration.adoc`\n- `modules/initiatives/pages/salesforce_customer_support.adoc` → `../../../initiatives/salesforce_customer_support.adoc`\n\nThis follows the same pattern used in your `solution-architectures` module, where the actual files live at the root level but symlinks in the module's `pages/` directory make them accessible to Antora's navigation system.\n\n## Committed Changes\n\n**Commit:** `dee09e5` - \"fix: Add symlinks for initiatives module to fix navigation\"\n\nYour initiative navigation links should now work correctly in the Antora-generated documentation!"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":409,"cache_read_input_tokens":58133,"cache_creation":{"ephemeral_5m_input_tokens":409,"ephemeral_1h_input_tokens":0},"output_tokens":319,"service_tier":"standard"}},"requestId":"req_011CWw98Y9xkrfBbkqJ3UjzV","type":"assistant","uuid":"329ed2be-3da0-4341-9da5-a5efb1a592f3","timestamp":"2026-01-09T04:04:07.031Z"}
{"parentUuid":"329ed2be-3da0-4341-9da5-a5efb1a592f3","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"system","subtype":"turn_duration","durationMs":94322,"timestamp":"2026-01-09T04:04:08.370Z","uuid":"5f3448f0-2945-41f3-a8d9-952793807d48","isMeta":false}
{"type":"file-history-snapshot","messageId":"11c8d3b8-b207-4c56-b1d0-c8c534dd4233","snapshot":{"messageId":"11c8d3b8-b207-4c56-b1d0-c8c534dd4233","trackedFileBackups":{"solution_architectures/salesforce_customer_support.adoc":{"backupFileName":"ef19bf3282a777f7@v2","version":2,"backupTime":"2026-01-09T03:13:31.966Z"}},"timestamp":"2026-01-09T04:32:33.163Z"},"isSnapshotUpdate":false}
{"parentUuid":"5f3448f0-2945-41f3-a8d9-952793807d48","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":"Update the Profile Service bounded context to reflect both initiatives and it's paired CML file"},"uuid":"11c8d3b8-b207-4c56-b1d0-c8c534dd4233","timestamp":"2026-01-09T04:32:33.134Z","thinkingMetadata":{"level":"high","disabled":false,"triggers":[]},"todos":[]}
{"parentUuid":"11c8d3b8-b207-4c56-b1d0-c8c534dd4233","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_019Jpv27B9kcW3q79hZQy8sZ","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"The user wants me to update the ProfileService bounded context to reflect both initiatives (Flybuys and Salesforce) and ensure it's properly paired with its CML file. Let me first understand what we have:\n\n1. There should be a ProfileService CML file\n2. There should be a ProfileService markdown file (paired documentation)\n3. The ProfileService needs to reflect both the Flybuys integration and Salesforce Customer Support initiatives\n\nLet me find and examine the current ProfileService files.","signature":"EpUFCkYICxgCKkAKAGkM8hMyJhGRjL08zO+HaKaiufQjhROQ/vf0tkghEkuwFp5+vL8+dbMvxvarUH/BVftBppvVXugf4BjfQihiEgwmvDwNn7vCklG7WpkaDKl1y0ERTSbm4eLD1CIwlI6qJcgMZNooqdEqQMnTkb3J1qsZ7KGHt7Kj+RWIsql3kZ4QjdOoG5Qf+WYsrYMzKvwDJM/KODSeVFdlBv052DTc1CYFGPwPGrB7A4TLHAF9iVjjZ839fEbyn3vUmV58nWrlIgXNlg/xZ3QdnNYe6IifsripHB3DJcmaNm9IFAasYqShdRZ5ewNzh1w4PSyX/n3Cbg39oc/jgbs6hy4D6stVCNxyygrixCGbFH9nvg8+mVKHo7g2qmAtsdPO6LThV3HgDvMbDQ3/bzkksU3EcWJSWOoB4oFhvCGIZa6k/ViCPwoy/CPhvkfQkuHg6EAIn8adKM7Rr29ebkanQR64nY4iww2hbwq94k3vW+RX5HdBAH1vC56prPVpTy2U60nl4cYzEArk5aXeEd2s1bYQBHHgZ/YV/X2TjzDFxMFdSsIDGgwxZvw2jug0m9cvUEvFG8Aq4xkdM8jG5Uss/Cty3FlWi0qP9JuszdT8rHb0d1NV6iv3wkWmSgVKFrbdoPVr9ckRJ28yoBn4kTnaf/Zvqr86dcLxvnKwYoOB+f6eydX27R8mTFI0qGNe7eKnARAo3PaOWgRUNitSdNO7YEjPUJztFJ/rCs+fl1NWIaSFRI5aDNR2WXsGxk8VvQw7Zx3VMeXP5dQvNPMeUnxv8G5eoSD9vh76woq9xqcrk+1twapzLePEQ++OLEXy6QGQ0cR/PMroAtXuoRQe2KAvI0BJtnkjpE5BF1DgKo220SAtcxgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":58171,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":58171,"ephemeral_1h_input_tokens":0},"output_tokens":8,"service_tier":"standard"}},"requestId":"req_011CWwBJxDakou3v713mbxsq","type":"assistant","uuid":"794235ae-f996-4b09-a247-d6d33e4af295","timestamp":"2026-01-09T04:32:38.605Z"}
{"parentUuid":"794235ae-f996-4b09-a247-d6d33e4af295","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_019Jpv27B9kcW3q79hZQy8sZ","type":"message","role":"assistant","content":[{"type":"text","text":"I'll update the ProfileService bounded context to reflect both the Flybuys integration and Salesforce Customer Support initiatives, and ensure it's properly paired with its CML file."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":58171,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":58171,"ephemeral_1h_input_tokens":0},"output_tokens":8,"service_tier":"standard"}},"requestId":"req_011CWwBJxDakou3v713mbxsq","type":"assistant","uuid":"2a603f27-bf0e-4c11-add3-00e66099ae28","timestamp":"2026-01-09T04:32:39.148Z"}
{"parentUuid":"2a603f27-bf0e-4c11-add3-00e66099ae28","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_019Jpv27B9kcW3q79hZQy8sZ","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01UCpjrcXVSWnipf9eLGTJ5J","name":"Glob","input":{"pattern":"**/profile*.cml"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":58171,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":58171,"ephemeral_1h_input_tokens":0},"output_tokens":8,"service_tier":"standard"}},"requestId":"req_011CWwBJxDakou3v713mbxsq","type":"assistant","uuid":"2f11381c-3014-4744-af1e-764a06186934","timestamp":"2026-01-09T04:32:39.650Z"}
{"parentUuid":"2f11381c-3014-4744-af1e-764a06186934","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_019Jpv27B9kcW3q79hZQy8sZ","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01EbcumsBbTc3jhz1ArcM8d5","name":"Glob","input":{"pattern":"**/profile*.md"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":58171,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":58171,"ephemeral_1h_input_tokens":0},"output_tokens":8,"service_tier":"standard"}},"requestId":"req_011CWwBJxDakou3v713mbxsq","type":"assistant","uuid":"129a4b48-41de-4eab-ad83-7d31031ef536","timestamp":"2026-01-09T04:32:40.010Z"}
{"parentUuid":"129a4b48-41de-4eab-ad83-7d31031ef536","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_019Jpv27B9kcW3q79hZQy8sZ","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01X8C17KLo7hmmqxAHSTTY8u","name":"Bash","input":{"command":"find . -iname \"*profile*\" -name \"*.cml\" -o -iname \"*profile*\" -name \"*.md\" | grep -E \"(bounded-contexts|domains)\"","description":"Find ProfileService related files"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":58171,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":58171,"ephemeral_1h_input_tokens":0},"output_tokens":346,"service_tier":"standard"}},"requestId":"req_011CWwBJxDakou3v713mbxsq","type":"assistant","uuid":"a34be3ea-ab16-480b-bb2e-713cac3f3ff5","timestamp":"2026-01-09T04:32:41.500Z"}
{"parentUuid":"2f11381c-3014-4744-af1e-764a06186934","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01UCpjrcXVSWnipf9eLGTJ5J","type":"tool_result","content":"/mnt/c/Users/o.young/work/architecture/bounded_context/profile.cml"}]},"uuid":"0651636d-1301-4a2c-bb69-13058dc9c79a","timestamp":"2026-01-09T04:32:47.279Z","toolUseResult":{"filenames":["/mnt/c/Users/o.young/work/architecture/bounded_context/profile.cml"],"durationMs":5561,"numFiles":1,"truncated":false},"sourceToolAssistantUUID":"2f11381c-3014-4744-af1e-764a06186934"}
{"parentUuid":"129a4b48-41de-4eab-ad83-7d31031ef536","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01EbcumsBbTc3jhz1ArcM8d5","type":"tool_result","content":"No files found"}]},"uuid":"1846b8da-0728-48d5-9cc4-b0c9235cf32a","timestamp":"2026-01-09T04:32:47.294Z","toolUseResult":{"filenames":[],"durationMs":5577,"numFiles":0,"truncated":false},"sourceToolAssistantUUID":"129a4b48-41de-4eab-ad83-7d31031ef536"}
{"parentUuid":"a34be3ea-ab16-480b-bb2e-713cac3f3ff5","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01X8C17KLo7hmmqxAHSTTY8u","type":"tool_result","content":"","is_error":false}]},"uuid":"4141b541-a981-43d9-9b87-6aba3b95bd10","timestamp":"2026-01-09T04:32:47.430Z","toolUseResult":{"stdout":"","stderr":"","interrupted":false,"isImage":false,"returnCodeInterpretation":"No matches found"},"sourceToolAssistantUUID":"a34be3ea-ab16-480b-bb2e-713cac3f3ff5"}
{"parentUuid":"4141b541-a981-43d9-9b87-6aba3b95bd10","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_014jX4LfAUJQNE6nomMnf5PS","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Let me check what's in the bounded_context directory and read the current profile.cml file.","signature":"EoMCCkYICxgCKkD3Pdhv+E8ySJxy2G7q3k2B5QugKkhGjarwLmcVCXQI1AFlVdDEvohawO3fbvyT9e7kq96RtVzubg77dtZYjmZzEgw3Dx8Ds9CHD1ueAPIaDLp4zFlUPlCRcLYCPyIwkTBWkTnUzLm4ifMcvkgNXklIHcConbJyyCsqqdgx/qE0QXOVBASXXkyfh7eOzHMaKmt8kAt8UVP2gmt7OTXcNxF4Judjb0tCpLPUnf1MDUdmb73G3S/OpzbB7u9NNePcqj63UVTUkY+g9NNw+qk2mhetTyRdTDdeVOgpI3G4qsOyDDynvkx6SDhqa2mRKN2SDfSnTeDmT3W0Jjjg7BgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":14,"cache_creation_input_tokens":563,"cache_read_input_tokens":58171,"cache_creation":{"ephemeral_5m_input_tokens":563,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CWwBL1YXgM7Ca6TZ4bTk2","type":"assistant","uuid":"3fabeaa7-7a39-4de4-87bb-770c732bd933","timestamp":"2026-01-09T04:32:50.945Z"}
{"parentUuid":"3fabeaa7-7a39-4de4-87bb-770c732bd933","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_014jX4LfAUJQNE6nomMnf5PS","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01XgyNqU7RZrN2jtovQsQzc6","name":"Bash","input":{"command":"ls -la bounded_context/ | head -20","description":"List bounded context directory"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":14,"cache_creation_input_tokens":563,"cache_read_input_tokens":58171,"cache_creation":{"ephemeral_5m_input_tokens":563,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CWwBL1YXgM7Ca6TZ4bTk2","type":"assistant","uuid":"b54a2f1a-8d8f-41c6-bf0e-442a4b1ac024","timestamp":"2026-01-09T04:32:51.703Z"}
{"parentUuid":"b54a2f1a-8d8f-41c6-bf0e-442a4b1ac024","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_014jX4LfAUJQNE6nomMnf5PS","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_015wXkbUBo91vPRChDMGuZZ5","name":"Read","input":{"file_path":"/mnt/c/Users/o.young/work/architecture/bounded_context/profile.cml"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":14,"cache_creation_input_tokens":563,"cache_read_input_tokens":58171,"cache_creation":{"ephemeral_5m_input_tokens":563,"ephemeral_1h_input_tokens":0},"output_tokens":170,"service_tier":"standard"}},"requestId":"req_011CWwBL1YXgM7Ca6TZ4bTk2","type":"assistant","uuid":"8df07f34-8991-4cbd-a624-02c12aa705b8","timestamp":"2026-01-09T04:32:52.133Z"}
{"parentUuid":"b54a2f1a-8d8f-41c6-bf0e-442a4b1ac024","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01XgyNqU7RZrN2jtovQsQzc6","type":"tool_result","content":"total 276\ndrwxrwxrwx 1 oliy oliy  4096 Jan  5 15:11 .\ndrwxrwxrwx 1 oliy oliy  4096 Jan  9 12:21 ..\n-rwxrwxrwx 1 oliy oliy 16110 Jan  5 15:11 engagement.adoc\n-rwxrwxrwx 1 oliy oliy 24365 Jan  5 11:12 engagement.cml\ndrwxrwxrwx 1 oliy oliy  4096 Dec 19 15:02 external\n-rwxrwxrwx 1 oliy oliy  1466 Dec 19 14:47 fuel.adoc\n-rwxrwxrwx 1 oliy oliy     0 Dec 17 10:34 fuel.cml\n-rwxrwxrwx 1 oliy oliy 11362 Jan  5 10:49 handover.adoc\n-rwxrwxrwx 1 oliy oliy 18363 Jan  5 11:14 handover.cml\ndrwxrwxrwx 1 oliy oliy  4096 Jan  5 10:52 interfaces\n-rwxrwxrwx 1 oliy oliy  7027 Jan  5 11:06 location.adoc\n-rwxrwxrwx 1 oliy oliy 12556 Jan  5 11:13 location.cml\n-rwxrwxrwx 1 oliy oliy 25476 Jan  5 12:35 loyalty.adoc\n-rwxrwxrwx 1 oliy oliy 36270 Jan  5 11:13 loyalty.cml\n-rwxrwxrwx 1 oliy oliy 11839 Jan  5 10:51 payment.adoc\n-rwxrwxrwx 1 oliy oliy 18023 Jan  5 11:14 payment.cml\n-rwxrwxrwx 1 oliy oliy 14953 Jan  5 11:06 profile.adoc\n-rwxrwxrwx 1 oliy oliy 25438 Jan  5 11:13 profile.cml\n-rwxrwxrwx 1 oliy oliy 14607 Jan  5 11:06 recommendation.adoc","is_error":false}]},"uuid":"ee5e74b7-6535-43ed-b382-cba0ec8d614c","timestamp":"2026-01-09T04:32:52.463Z","toolUseResult":{"stdout":"total 276\ndrwxrwxrwx 1 oliy oliy  4096 Jan  5 15:11 .\ndrwxrwxrwx 1 oliy oliy  4096 Jan  9 12:21 ..\n-rwxrwxrwx 1 oliy oliy 16110 Jan  5 15:11 engagement.adoc\n-rwxrwxrwx 1 oliy oliy 24365 Jan  5 11:12 engagement.cml\ndrwxrwxrwx 1 oliy oliy  4096 Dec 19 15:02 external\n-rwxrwxrwx 1 oliy oliy  1466 Dec 19 14:47 fuel.adoc\n-rwxrwxrwx 1 oliy oliy     0 Dec 17 10:34 fuel.cml\n-rwxrwxrwx 1 oliy oliy 11362 Jan  5 10:49 handover.adoc\n-rwxrwxrwx 1 oliy oliy 18363 Jan  5 11:14 handover.cml\ndrwxrwxrwx 1 oliy oliy  4096 Jan  5 10:52 interfaces\n-rwxrwxrwx 1 oliy oliy  7027 Jan  5 11:06 location.adoc\n-rwxrwxrwx 1 oliy oliy 12556 Jan  5 11:13 location.cml\n-rwxrwxrwx 1 oliy oliy 25476 Jan  5 12:35 loyalty.adoc\n-rwxrwxrwx 1 oliy oliy 36270 Jan  5 11:13 loyalty.cml\n-rwxrwxrwx 1 oliy oliy 11839 Jan  5 10:51 payment.adoc\n-rwxrwxrwx 1 oliy oliy 18023 Jan  5 11:14 payment.cml\n-rwxrwxrwx 1 oliy oliy 14953 Jan  5 11:06 profile.adoc\n-rwxrwxrwx 1 oliy oliy 25438 Jan  5 11:13 profile.cml\n-rwxrwxrwx 1 oliy oliy 14607 Jan  5 11:06 recommendation.adoc","stderr":"","interrupted":false,"isImage":false},"sourceToolAssistantUUID":"b54a2f1a-8d8f-41c6-bf0e-442a4b1ac024"}
{"parentUuid":"8df07f34-8991-4cbd-a624-02c12aa705b8","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_015wXkbUBo91vPRChDMGuZZ5","type":"tool_result","content":"     1→/*\n     2→ * ProfileService - Bounded Context Definition\n     3→ * ============================================\n     4→ *\n     5→ * Unified customer profile service providing enriched customer data for OTR ecosystem.\n     6→ *\n     7→ * See profile.adoc for comprehensive architecture documentation, decision log, and patterns.\n     8→ */\n     9→\n    10→import \"../domains/profile.cml\"\n    11→\n    12→BoundedContext ProfileService implements ProfileDomain {\n    13→\n    14→    type = APPLICATION\n    15→\n    16→    // Strategic DDD Classification: CORE_DOMAIN | SUPPORTING_DOMAIN | GENERIC_DOMAIN\n    17→    // CORE_DOMAIN: Competitive differentiator - customer intelligence, risk assessment, and behavioral\n    18→    // insights drive personalization and business outcomes\n    19→    strategicClassification = \"CORE_DOMAIN\"\n    20→\n    21→    domainVisionStatement = \"Provide unified, enriched customer profiles bridging Salesforce canonical data with OTR-specific attributes, behavioral insights, and risk assessments\"\n    22→\n    23→    responsibilities = \"OTRG-specific customer profile management\",\n    24→                      \"Customer lifecycle stage and onboarding tracking\",\n    25→                      \"Partner linking status tracking\",\n    26→                      \"Customer risk assessment (fraud, refund, churn)\",\n    27→                      \"Refund history tracking\",\n    28→                      \"Engagement metrics caching for profile enrichment\"\n    29→\n    30→    implementationTechnology = \"Azure Functions, .NET Core, Azure SQL, Salesforce API, Event Bus\"\n    31→\n    32→    // ========================================================================\n    33→    // SECTION 1: CORE AGGREGATES\n    34→    // ========================================================================\n    35→    // Aggregates represent transactional consistency boundaries.\n    36→    // Each aggregate root controls access to entities within its boundary.\n    37→    // ========================================================================\n    38→\n    39→    // 1.1 CustomerProfile Aggregate\n    40→    // ------------------------------\n    41→    // OTR-specific customer profile attributes enriching Salesforce canonical data.\n    42→    // Stores behavioral data, preferences, and app-specific attributes.\n    43→    //\n    44→    // Invariants:\n    45→    // - Must have valid VCI reference to Salesforce\n    46→    // - Email verification status must be tracked\n    47→    // - Account status must be valid enum value\n    48→    // - Profile completeness score must be 0-100\n    49→    // - Onboarding completion percentage must be 0-100\n    50→    // - lifecycle stage must be valid enum value\n    51→    //\n    52→    // Bounded Context Note:\n    53→    // - Canonical customer data (name, email, phone) owned by Salesforce\n    54→    // - ProfileService stores OTR-specific enrichment only\n    55→    // - Queries Salesforce for canonical data, does not cache it\n    56→    Aggregate CustomerProfile {\n    57→        Entity CustomerProfileRecord {\n    58→            aggregateRoot\n    59→\n    60→            - ProfileId id\n    61→            - String VivaConsumerId           // Salesforce customer identifier (VCI)\n    62→            - AccountStatus status\n    63→            - DateTime createdAt\n    64→            - DateTime lastUpdatedAt\n    65→            - DateTime lastLoginAt\n    66→\n    67→            // Identity Verification\n    68→            - IdentityVerification verification\n    69→\n    70→            // App Preferences\n    71→            - AppPreferences appPreferences\n    72→\n    73→            // Profile Completeness\n    74→            - int completenessScore          // 0-100 calculated score\n    75→\n    76→            // Customer lifecycle\n    77→            - LifeCycleStage lifeCycleStage  // PROSPECT | NEW | ACTIVE | DORMANT | AT_RISK | CHURNED\n    78→            - DateTime lifeCycleChangedAt\n    79→\n    80→            // Onboarding Progress\n    81→            - OnboardingStatus onboardingStatus\n    82→            - int onboardingCompletionPercentage  // 0-100\n    83→            - DateTime onboardingCompletedAt\n    84→\n    85→            // Customer Value\n    86→            - CustomerValue valueMetrics\n    87→\n    88→            // Special Handling\n    89→            - boolean isStaffMember          // Employee customer flag\n    90→\n    91→            // Operations\n    92→            def updateLastLogin(): void\n    93→            def calculateCompletenessScore(): int\n    94→            def updateLifeCycleStage(newStage: LifeCycleStage): void\n    95→            def updateOnboardingProgress(percentage: int): void\n    96→        }\n    97→\n    98→        ValueObject IdentityVerification {\n    99→            - boolean emailVerified\n   100→            - boolean phoneVerified\n   101→            - VerificationLevel level        // UNVERIFIED | BASIC | FULL\n   102→            - DateTime lastVerifiedAt\n   103→        }\n   104→\n   105→        ValueObject AppPreferences {\n   106→            - String preferredStore\n   107→            - String languagePreference      // ISO 639-1 code (en, zh, vi, etc.)\n   108→            - boolean pushNotificationsEnabled\n   109→            - boolean locationServicesEnabled\n   110→            - String preferredPaymentMethod\n   111→            - Map<String, String> customPreferences\n   112→        }\n   113→\n   114→        ValueObject CustomerValue {\n   115→            - Money lifetimeValue\n   116→            - Money totalSpend\n   117→            - int transactionCount\n   118→            - Money averageBasketValue\n   119→            - DateTime firstPurchaseDate\n   120→            - ProfitabilityScore profitability\n   121→        }\n   122→\n   123→        enum VerificationLevel {\n   124→            UNVERIFIED,                      // No verification\n   125→            BASIC,                           // Email or phone verified\n   126→            FULL                             // Multiple factors verified\n   127→        }\n   128→\n   129→        enum ProfitabilityScore {\n   130→            LOW, MEDIUM, HIGH, VIP\n   131→        }\n   132→\n   133→        enum LifeCycleStage {\n   134→            PROSPECT,                        // Registered but no purchase\n   135→            NEW,                             // First purchase within 90 days\n   136→            ACTIVE,                          // Regular transactions\n   137→            DORMANT,                         // No transactions 90+ days\n   138→            AT_RISK,                         // Declining engagement/transactions\n   139→            CHURNED                          // No transactions 180+ days\n   140→        }\n   141→\n   142→        enum OnboardingStatus {\n   143→            NOT_STARTED,                     // Account created, onboarding not begun\n   144→            IN_PROGRESS,                     // Onboarding steps partially complete\n   145→            COMPLETED,                       // All onboarding steps finished\n   146→            SKIPPED                          // User skipped onboarding flow\n   147→        }\n   148→    }\n   149→\n   150→    // 1.2 PartnerLink Aggregate\n   151→    // ------------------------------------------------------\n   152→    // Records customer linkages to external loyalty partners (Flybuys, Shell).\n   153→    // Tracks linking status and synchronization state for partner integrations.\n   154→    //\n   155→    // Invariants:\n   156→    // - Customer can only have one active link per partner type\n   157→    // - External member ID must be unique within partner\n   158→    // - Reward preference must be one of: FLYBUYS_POINTS, FUEL_DISCOUNT_SHELL, OTR_REWARDS\n   159→    // - If preference is FLYBUYS_POINTS, PartnerLink must exist with status=LINKED\n   160→    // - Default preference when no partner linked: OTR_REWARDS (fallback)\n   161→    //\n   162→    // Bounded Context Note:\n   163→    // - OAuth tokens are managed by infrastructure OAuth Service\n   164→    // - This aggregate tracks: \"customer linked partner account\"\n   165→    // - Created in response to OAuthLinkEstablished event from OAuth Service\n   166→    Aggregate PartnerLink {\n   167→        Entity CustomerPartnerLink {\n   168→            aggregateRoot\n   169→\n   170→            - PartnerLinkId id\n   171→            - String VivaConsumerId           // Salesforce customer identifier\n   172→            - PartnerType partner             // FLYBUYS, SHELL_CARD\n   173→            - String externalMemberId         // Partner's member/account number\n   174→            - LinkingStatus status\n   175→            - RewardPreference rewardPreference   // Customer's chosen reward type\n   176→            - DateTime linkedAt\n   177→            - DateTime lastSyncedAt           // Last successful sync\n   178→            - String oauthProviderId          // Reference to OAuth Service token\n   179→\n   180→            // Operations\n   181→            def updateRewardPreference(newPreference: RewardPreference): void {\n   182→                // Invariant: Cannot select FLYBUYS_POINTS unless Flybuys account linked\n   183→                // Invariant: Unlinking Flybuys resets preference to OTR_REWARDS (fallback)\n   184→            }\n   185→\n   186→            def recordSync(syncStatus: SyncStatus): void\n   187→        }\n   188→\n   189→        ValueObject LinkingStatus {\n   190→            - LinkState state                 // LINKED, UNLINKED, SYNC_FAILED\n   191→            - String errorMessage\n   192→            - int failedSyncAttempts\n   193→        }\n   194→\n   195→        ValueObject RewardPreference {\n   196→            - RewardPreferenceType type       // FLYBUYS_POINTS, FUEL_DISCOUNT_SHELL, OTR_REWARDS\n   197→        }\n   198→\n   199→        enum LinkState {\n   200→            LINKED,                           // Active partner link\n   201→            UNLINKED,                         // No partner link\n   202→            SYNC_FAILED                       // Link exists but sync failing\n   203→        }\n   204→\n   205→        enum RewardPreferenceType {\n   206→            FLYBUYS_POINTS,                   // Earn Flybuys points (requires linking)\n   207→            FUEL_DISCOUNT_SHELL,              // Shell Price Save fuel discount (4c/L)\n   208→            OTR_REWARDS                       // OTR native loyalty points (default fallback)\n   209→        }\n   210→\n   211→        enum PartnerType {\n   212→            FLYBUYS, SHELL_CARD\n   213→        }\n   214→    }\n   215→\n   216→    // 1.3 RiskAssessment Aggregate\n   217→    // -----------------------------\n   218→    // Customer risk, fraud, and value scores for instant refund decisions.\n   219→    // Provides both computed scores and raw factors for transparency.\n   220→    //\n   221→    // Invariants:\n   222→    // - Risk scores must be 0-100\n   223→    // - Assessment must have calculated timestamp\n   224→    // - Factors must be populated when score is calculated\n   225→    //\n   226→    // Use Case: Instant Refunds\n   227→    // - Provides scored assessment to other business units\n   228→    // - Exposes raw factors for custom scoring logic\n   229→    // - Enables risk-based refund approval workflows\n   230→    Aggregate RiskAssessment {\n   231→        Entity CustomerRiskAssessment {\n   232→            aggregateRoot\n   233→\n   234→            - RiskAssessmentId id\n   235→            - String VivaConsumerId\n   236→            - DateTime assessedAt\n   237→            - DateTime lastUpdatedAt\n   238→\n   239→            // Computed Scores (0-100)\n   240→            - int overallRiskScore           // Combined risk score\n   241→            - int fraudRiskScore             // Fraud-specific risk\n   242→            - int refundRiskScore            // Refund abuse risk\n   243→            - int churnRiskScore             // Customer churn/attrition risk\n   244→            - int customerValueScore         // Customer lifetime value score\n   245→\n   246→            // Risk Factors (raw data for transparency)\n   247→            - RiskFactors factors\n   248→\n   249→            // Operations\n   250→            def calculateRiskScore(): int\n   251→            def updateFactors(newFactors: RiskFactors): void\n   252→        }\n   253→\n   254→        ValueObject RiskFactors {\n   255→            // Refund History\n   256→            - int totalRefundCount\n   257→            - int refundsLast30Days\n   258→            - int refundsLast60Days\n   259→            - int refundsLast90Days\n   260→            - Money totalRefundAmount\n   261→            - Decimal refundToPurchaseRatio\n   262→            - List<String> refundReasonDistribution\n   263→\n   264→            // Transaction Behavior\n   265→            - int transactionFrequency       // Transactions per month\n   266→            - DateTime lastTransactionDate\n   267→            - Money averageBasketValue\n   268→            - Decimal basketValueVariance\n   269→            - int locationDiversity          // Number of unique stores visited\n   270→            - boolean hasUnusualPatterns\n   271→\n   272→            // Fraud Indicators\n   273→            - int disputedTransactionCount\n   274→            - int chargebackCount\n   275→            - Decimal failedPaymentRate\n   276→            - boolean multipleAccountDetected\n   277→            - boolean loginAnomaliesDetected\n   278→            - int fraudFlagCount\n   279→\n   280→            // Account Health\n   281→            - int accountTenureDays\n   282→            - VerificationLevel verificationLevel\n   283→            - AccountStatus accountStatus\n   284→\n   285→            // Engagement Metrics (cached from EngagementService)\n   286→            - int appUsageFrequency          // Logins per week\n   287→            - DateTime lastLoginDate\n   288→            - int supportInteractionCount\n   289→            - Decimal campaignEngagementRate\n   290→\n   291→            // Churn Indicators\n   292→            - int daysSinceLastPurchase\n   293→            - int daysSinceLastLogin\n   294→            - Decimal transactionFrequencyTrend  // +/- percentage change\n   295→            - Decimal basketValueTrend           // +/- percentage change\n   296→            - boolean engagementDeclining        // Trend analysis flag\n   297→            - LifeCycleStage currentLifeCycleStage\n   298→\n   299→            // Customer Value\n   300→            - Money lifetimeValue\n   301→            - Money totalSpend\n   302→            - ProfitabilityScore profitability\n   303→        }\n   304→\n   305→        enum AccountStatus {\n   306→            ACTIVE, SUSPENDED, FLAGGED, CLOSED\n   307→        }\n   308→    }\n   309→\n   310→    // 1.4 RefundHistory Aggregate\n   311→    // ----------------------------\n   312→    // Customer refund transaction history for risk assessment.\n   313→    //\n   314→    // Invariants:\n   315→    // - Refund amount must be positive\n   316→    // - Refund must reference original transaction\n   317→    // - Refund reason must be provided\n   318→    Aggregate RefundHistory {\n   319→        Entity RefundRecord {\n   320→            aggregateRoot\n   321→\n   322→            - RefundId id\n   323→            - String VivaConsumerId\n   324→            - TransactionId originalTransactionId\n   325→            - Money refundAmount\n   326→            - RefundReason reason\n   327→            - RefundStatus status\n   328→            - DateTime requestedAt\n   329→            - DateTime processedAt\n   330→            - String processedBy              // System or agent identifier\n   331→            - int processingTimeDays          // Turnaround time tracking\n   332→        }\n   333→\n   334→        enum RefundReason {\n   335→            PRICING_ERROR,\n   336→            PRODUCT_QUALITY,\n   337→            TRANSACTION_ERROR,\n   338→            CUSTOMER_DISPUTE,\n   339→            PROMOTIONAL_ISSUE,\n   340→            OTHER\n   341→        }\n   342→\n   343→        enum RefundStatus {\n   344→            PENDING,\n   345→            APPROVED,\n   346→            REJECTED,\n   347→            PROCESSED,\n   348→            CANCELLED\n   349→        }\n   350→    }\n   351→\n   352→\n   353→    // ========================================================================\n   354→    // SECTION 2: DOMAIN EVENTS\n   355→    // ========================================================================\n   356→    // Events published to Event Bus for downstream consumption.\n   357→    //\n   358→    // Event Categories:\n   359→    // 1. Profile lifecycle events (creation, updates, verification, completeness, lifecycle stage, onboarding)\n   360→    // 2. Partner linking events\n   361→    // 3. Risk assessment events\n   362→    // 4. Refund history events\n   363→    // ========================================================================\n   364→\n   365→    // --- Profile lifecycle Events ---\n   366→\n   367→    DomainEvent ProfileCreated {\n   368→        - String VivaConsumerId\n   369→        - ProfileId profileId\n   370→        - DateTime createdAt\n   371→        - VerificationLevel initialVerificationLevel\n   372→    }\n   373→\n   374→    DomainEvent ProfileUpdated {\n   375→        - String VivaConsumerId\n   376→        - ProfileId profileId\n   377→        - DateTime updatedAt\n   378→        - List<String> changedFields\n   379→    }\n   380→\n   381→    DomainEvent ProfileVerificationChanged {\n   382→        - String VivaConsumerId\n   383→        - VerificationLevel previousLevel\n   384→        - VerificationLevel newLevel\n   385→        - DateTime changedAt\n   386→    }\n   387→\n   388→    DomainEvent ProfileCompletenessChanged {\n   389→        - String VivaConsumerId\n   390→        - int previousScore\n   391→        - int newScore\n   392→        - DateTime changedAt\n   393→    }\n   394→\n   395→    DomainEvent LifeCycleStageChanged {\n   396→        - String VivaConsumerId\n   397→        - LifeCycleStage previousStage\n   398→        - LifeCycleStage newStage\n   399→        - DateTime changedAt\n   400→        - String trigger                   // TRANSACTION_INACTIVITY | ENGAGEMENT_CHANGE | MANUAL_UPDATE\n   401→    }\n   402→\n   403→    DomainEvent OnboardingCompleted {\n   404→        - String VivaConsumerId\n   405→        - DateTime completedAt\n   406→        - int completionPercentage\n   407→        - List<String> completedSteps\n   408→    }\n   409→\n   410→    DomainEvent OnboardingProgressUpdated {\n   411→        - String VivaConsumerId\n   412→        - int previousPercentage\n   413→        - int newPercentage\n   414→        - String completedStep\n   415→        - DateTime updatedAt\n   416→    }\n   417→\n   418→    // --- Partner Linking Events (MOVED from LoyaltyService) ---\n   419→\n   420→    DomainEvent PartnerLinked {\n   421→        - String VivaConsumerId\n   422→        - PartnerType partner\n   423→        - String externalMemberId\n   424→        - DateTime linkedAt\n   425→    }\n   426→\n   427→    DomainEvent PartnerUnlinked {\n   428→        - String VivaConsumerId\n   429→        - PartnerType partner\n   430→        - DateTime unlinkedAt\n   431→        - String reason\n   432→    }\n   433→\n   434→    DomainEvent PartnerLinkChanged {\n   435→        - String VivaConsumerId\n   436→        - PartnerType partner\n   437→        - LinkState previousState\n   438→        - LinkState newState\n   439→        - DateTime changedAt\n   440→    }\n   441→\n   442→    DomainEvent RewardPreferenceChanged {\n   443→        - String VivaConsumerId\n   444→        - RewardPreferenceType previousPreference\n   445→        - RewardPreferenceType newPreference\n   446→        - DateTime changedAt\n   447→        - String changeReason              // USER_SELECTED, PARTNER_UNLINKED, FALLBACK_APPLIED\n   448→        - PartnerType affectedPartner      // Which partner this change affects (if applicable)\n   449→    }\n   450→\n   451→    // --- Risk Assessment Events ---\n   452→\n   453→    DomainEvent RiskStatusChanged {\n   454→        - String VivaConsumerId\n   455→        - RiskLevel previousLevel\n   456→        - RiskLevel newLevel\n   457→        - DateTime changedAt\n   458→        - String trigger                   // REFUND_THRESHOLD | FRAUD_DETECTED | MANUAL_REVIEW\n   459→    }\n   460→\n   461→    DomainEvent FraudIndicatorDetected {\n   462→        - String VivaConsumerId\n   463→        - FraudIndicatorType indicatorType\n   464→        - String description\n   465→        - Severity severity\n   466→        - DateTime detectedAt\n   467→        - boolean requiresInvestigation\n   468→    }\n   469→\n   470→    enum RiskLevel {\n   471→        LOW, MEDIUM, HIGH, CRITICAL\n   472→    }\n   473→\n   474→    enum FraudIndicatorType {\n   475→        MULTIPLE_ACCOUNTS,\n   476→        CHARGEBACK_PATTERN,\n   477→        LOGIN_ANOMALY,\n   478→        TRANSACTION_ANOMALY,\n   479→        REFUND_ABUSE,\n   480→        DISPUTE_PATTERN\n   481→    }\n   482→\n   483→    enum Severity {\n   484→        LOW, MEDIUM, HIGH, CRITICAL\n   485→    }\n   486→\n   487→    // --- Refund History Events ---\n   488→\n   489→    DomainEvent RefundRequested {\n   490→        - RefundId refundId\n   491→        - String VivaConsumerId\n   492→        - TransactionId originalTransactionId\n   493→        - Money refundAmount\n   494→        - RefundReason reason\n   495→        - DateTime requestedAt\n   496→    }\n   497→\n   498→    DomainEvent RefundProcessed {\n   499→        - RefundId refundId\n   500→        - String VivaConsumerId\n   501→        - Money refundAmount\n   502→        - RefundStatus status\n   503→        - DateTime processedAt\n   504→        - int processingTimeDays\n   505→    }\n   506→\n   507→    // ========================================================================\n   508→    // SECTION 3: ORCHESTRATION & QUERY SERVICES\n   509→    // ========================================================================\n   510→    // Services orchestrate calls to external systems and provide query APIs.\n   511→    // ========================================================================\n   512→\n   513→    Service ProfileQueryService {\n   514→        // Query customer profile (Salesforce canonical + OTR enrichment)\n   515→        getProfile(@String VivaConsumerId) : CustomerProfileResponse\n   516→\n   517→        // Query profile completeness\n   518→        getProfileCompleteness(@String VivaConsumerId) : int\n   519→\n   520→        // Query partner links\n   521→        getPartnerLinks(@String VivaConsumerId) : List<CustomerPartnerLink>\n   522→\n   523→        // Query specific partner link status\n   524→        getPartnerLinkStatus(@String VivaConsumerId, @PartnerType partner) : LinkingStatus\n   525→    }\n   526→\n   527→    Service RiskAssessmentService {\n   528→        // Get comprehensive risk assessment (scores + raw factors)\n   529→        getRiskAssessment(@String VivaConsumerId) : RiskAssessmentResponse\n   530→\n   531→        // Calculate risk score from factors\n   532→        calculateRiskScore(@RiskFactors factors) : int\n   533→\n   534→        // Update risk factors\n   535→        updateRiskFactors(@String VivaConsumerId, @RiskFactors factors): void\n   536→\n   537→        // Specific risk queries\n   538→        getFraudRisk(@String VivaConsumerId) : int\n   539→        getRefundRisk(@String VivaConsumerId) : int\n   540→        getChurnRisk(@String VivaConsumerId) : int\n   541→        getCustomerValueScore(@String VivaConsumerId) : int\n   542→    }\n   543→\n   544→    Service RefundHistoryService {\n   545→        // Query refund history\n   546→        getRefundHistory(@String VivaConsumerId) : List<RefundRecord>\n   547→\n   548→        // Record new refund request\n   549→        recordRefund(@RefundRecord refund) : void\n   550→\n   551→        // Calculate refund statistics\n   552→        getRefundStatistics(@String VivaConsumerId) : RefundStatistics\n   553→    }\n   554→\n   555→    Service PartnerLinkService {\n   556→        // Create partner link\n   557→        createPartnerLink(@String VivaConsumerId, @PartnerType partner, @String externalMemberId) : PartnerLinkId\n   558→\n   559→        // Update reward preference\n   560→        updateRewardPreference(@String VivaConsumerId, @RewardPreferenceType preference) : void\n   561→\n   562→        // Sync with partner (calls partner APIs)\n   563→        syncWithPartner(@PartnerLinkId linkId) : boolean\n   564→\n   565→        // Revoke partner link\n   566→        revokePartnerLink(@PartnerLinkId linkId) : void\n   567→    }\n   568→\n   569→    Service EngagementSyncService {\n   570→        // Update cached engagement summary (from EngagementService)\n   571→        updateEngagementSummary(@String VivaConsumerId, @EngagementMetrics metrics) : void\n   572→\n   573→        // Get cached engagement summary\n   574→        getEngagementSummary(@String VivaConsumerId) : CustomerEngagementSummary\n   575→    }\n   576→\n   577→    Service SalesforceProfileAdapter {\n   578→        // ACL for Salesforce integration\n   579→        // Translates between Salesforce Contact/Person Account and OTR profile model\n   580→\n   581→        // Query canonical customer data from Salesforce\n   582→        getCustomer(@String VivaConsumerId) : SalesforceCustomer\n   583→\n   584→        // Resolve email to VCI (for legacy email-keyed lookups)\n   585→        resolveEmailToVCI(@String email) : String\n   586→\n   587→        // Validate VCI exists in Salesforce\n   588→        validateVCI(@String VivaConsumerId) : boolean\n   589→    }\n   590→\n   591→    // ========================================================================\n   592→    // SECTION 4: SHARED VALUE OBJECTS\n   593→    // ========================================================================\n   594→    // Reusable value objects used across multiple aggregates.\n   595→    // ========================================================================\n   596→\n   597→    ValueObject Money {\n   598→        - Decimal amount\n   599→        - String currency                 // AUD, USD\n   600→    }\n   601→\n   602→    ValueObject ProfileId {\n   603→        - String id\n   604→    }\n   605→\n   606→    ValueObject PartnerLinkId {\n   607→        - String id\n   608→    }\n   609→\n   610→    ValueObject RiskAssessmentId {\n   611→        - String id\n   612→    }\n   613→\n   614→    ValueObject RefundId {\n   615→        - String id\n   616→    }\n   617→\n   618→    ValueObject EngagementSummaryId {\n   619→        - String id\n   620→    }\n   621→\n   622→    ValueObject TransactionId {\n   623→        - String id\n   624→    }\n   625→\n   626→    ValueObject CustomerProfileResponse {\n   627→        // Combined response from Salesforce + ProfileService\n   628→        - String VivaConsumerId\n   629→        - SalesforceCustomer salesforceData   // Canonical data from Salesforce\n   630→        - CustomerProfileRecord otrData       // OTR-specific enrichment\n   631→        - List<CustomerPartnerLink> partnerLinks\n   632→        - int completenessScore\n   633→    }\n   634→\n   635→    ValueObject SalesforceCustomer {\n   636→        // Canonical customer data from Salesforce\n   637→        - String VivaConsumerId\n   638→        - String firstName\n   639→        - String lastName\n   640→        - String email\n   641→        - String phone\n   642→        - Address mailingAddress\n   643→        - DateTime createdDate\n   644→        - DateTime lastModifiedDate\n   645→    }\n   646→\n   647→    ValueObject Address {\n   648→        - String street\n   649→        - String city\n   650→        - String state\n   651→        - String postalCode\n   652→        - String country\n   653→    }\n   654→\n   655→    ValueObject RiskAssessmentResponse {\n   656→        // Comprehensive risk assessment with scores and raw factors\n   657→        - String VivaConsumerId\n   658→        - DateTime assessedAt\n   659→\n   660→        // Computed Scores\n   661→        - int overallRiskScore\n   662→        - int fraudRiskScore\n   663→        - int refundRiskScore\n   664→        - int churnRiskScore\n   665→        - int customerValueScore\n   666→\n   667→        // Raw Factors (for transparency and custom scoring)\n   668→        - RiskFactors factors\n   669→\n   670→        // Aggregated from Other Services\n   671→        - String loyaltyTier              // From LoyaltyService\n   672→        - int loyaltyPointsBalance        // From LoyaltyService\n   673→    }\n   674→\n   675→    ValueObject RefundStatistics {\n   676→        - int totalRefundCount\n   677→        - Money totalRefundAmount\n   678→        - Decimal refundToPurchaseRatio\n   679→        - Money averageRefundAmount\n   680→        - int refundsLast30Days\n   681→        - int refundsLast90Days\n   682→        - List<String> topRefundReasons\n   683→    }\n   684→\n   685→    ValueObject EngagementMetrics {\n   686→        // Metrics from EngagementService for caching\n   687→        - int emailOpenRate\n   688→        - int emailClickRate\n   689→        - int pushNotificationEngagement\n   690→        - int campaignResponseCount\n   691→        - DateTime lastCampaignInteraction\n   692→        - EngagementTier engagementTier\n   693→    }\n   694→\n   695→    // ========================================================================\n   696→    // SECTION 5: REPOSITORIES (Persistence Abstractions)\n   697→    // ========================================================================\n   698→    // Repository interfaces define persistence operations for owned aggregates.\n   699→    // ========================================================================\n   700→\n   701→    // Repository CustomerProfileRepository\n   702→    // Repository PartnerLinkRepository\n   703→    // Repository RiskAssessmentRepository\n   704→    // Repository RefundHistoryRepository\n   705→    // Repository EngagementSummaryRepository\n   706→}\n   707→\n   708→// ============================================================================\n   709→// END OF BOUNDED CONTEXT\n   710→// ============================================================================\n   711→//\n   712→// Implementation Notes:\n   713→// - Database: Azure SQL (optimized for high-frequency updates)\n   714→// - Events published to Event Bus topic: \"profile-events\"\n   715→// - Salesforce integration via REST API with OAuth 2.0\n   716→// - EngagementService integration via Event Bus + batch sync\n   717→// - LoyaltyService queries ProfileService synchronously\n   718→// - Admin portal enhanced to use ProfileService APIs\n   719→// - VCI introduced through Flybuys initiative\n   720→// ============================================================================\n   721→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"e73da9cc-60a4-457b-9ae5-b0373a5f0bbb","timestamp":"2026-01-09T04:32:52.638Z","toolUseResult":{"type":"text","file":{"filePath":"/mnt/c/Users/o.young/work/architecture/bounded_context/profile.cml","content":"/*\n * ProfileService - Bounded Context Definition\n * ============================================\n *\n * Unified customer profile service providing enriched customer data for OTR ecosystem.\n *\n * See profile.adoc for comprehensive architecture documentation, decision log, and patterns.\n */\n\nimport \"../domains/profile.cml\"\n\nBoundedContext ProfileService implements ProfileDomain {\n\n    type = APPLICATION\n\n    // Strategic DDD Classification: CORE_DOMAIN | SUPPORTING_DOMAIN | GENERIC_DOMAIN\n    // CORE_DOMAIN: Competitive differentiator - customer intelligence, risk assessment, and behavioral\n    // insights drive personalization and business outcomes\n    strategicClassification = \"CORE_DOMAIN\"\n\n    domainVisionStatement = \"Provide unified, enriched customer profiles bridging Salesforce canonical data with OTR-specific attributes, behavioral insights, and risk assessments\"\n\n    responsibilities = \"OTRG-specific customer profile management\",\n                      \"Customer lifecycle stage and onboarding tracking\",\n                      \"Partner linking status tracking\",\n                      \"Customer risk assessment (fraud, refund, churn)\",\n                      \"Refund history tracking\",\n                      \"Engagement metrics caching for profile enrichment\"\n\n    implementationTechnology = \"Azure Functions, .NET Core, Azure SQL, Salesforce API, Event Bus\"\n\n    // ========================================================================\n    // SECTION 1: CORE AGGREGATES\n    // ========================================================================\n    // Aggregates represent transactional consistency boundaries.\n    // Each aggregate root controls access to entities within its boundary.\n    // ========================================================================\n\n    // 1.1 CustomerProfile Aggregate\n    // ------------------------------\n    // OTR-specific customer profile attributes enriching Salesforce canonical data.\n    // Stores behavioral data, preferences, and app-specific attributes.\n    //\n    // Invariants:\n    // - Must have valid VCI reference to Salesforce\n    // - Email verification status must be tracked\n    // - Account status must be valid enum value\n    // - Profile completeness score must be 0-100\n    // - Onboarding completion percentage must be 0-100\n    // - lifecycle stage must be valid enum value\n    //\n    // Bounded Context Note:\n    // - Canonical customer data (name, email, phone) owned by Salesforce\n    // - ProfileService stores OTR-specific enrichment only\n    // - Queries Salesforce for canonical data, does not cache it\n    Aggregate CustomerProfile {\n        Entity CustomerProfileRecord {\n            aggregateRoot\n\n            - ProfileId id\n            - String VivaConsumerId           // Salesforce customer identifier (VCI)\n            - AccountStatus status\n            - DateTime createdAt\n            - DateTime lastUpdatedAt\n            - DateTime lastLoginAt\n\n            // Identity Verification\n            - IdentityVerification verification\n\n            // App Preferences\n            - AppPreferences appPreferences\n\n            // Profile Completeness\n            - int completenessScore          // 0-100 calculated score\n\n            // Customer lifecycle\n            - LifeCycleStage lifeCycleStage  // PROSPECT | NEW | ACTIVE | DORMANT | AT_RISK | CHURNED\n            - DateTime lifeCycleChangedAt\n\n            // Onboarding Progress\n            - OnboardingStatus onboardingStatus\n            - int onboardingCompletionPercentage  // 0-100\n            - DateTime onboardingCompletedAt\n\n            // Customer Value\n            - CustomerValue valueMetrics\n\n            // Special Handling\n            - boolean isStaffMember          // Employee customer flag\n\n            // Operations\n            def updateLastLogin(): void\n            def calculateCompletenessScore(): int\n            def updateLifeCycleStage(newStage: LifeCycleStage): void\n            def updateOnboardingProgress(percentage: int): void\n        }\n\n        ValueObject IdentityVerification {\n            - boolean emailVerified\n            - boolean phoneVerified\n            - VerificationLevel level        // UNVERIFIED | BASIC | FULL\n            - DateTime lastVerifiedAt\n        }\n\n        ValueObject AppPreferences {\n            - String preferredStore\n            - String languagePreference      // ISO 639-1 code (en, zh, vi, etc.)\n            - boolean pushNotificationsEnabled\n            - boolean locationServicesEnabled\n            - String preferredPaymentMethod\n            - Map<String, String> customPreferences\n        }\n\n        ValueObject CustomerValue {\n            - Money lifetimeValue\n            - Money totalSpend\n            - int transactionCount\n            - Money averageBasketValue\n            - DateTime firstPurchaseDate\n            - ProfitabilityScore profitability\n        }\n\n        enum VerificationLevel {\n            UNVERIFIED,                      // No verification\n            BASIC,                           // Email or phone verified\n            FULL                             // Multiple factors verified\n        }\n\n        enum ProfitabilityScore {\n            LOW, MEDIUM, HIGH, VIP\n        }\n\n        enum LifeCycleStage {\n            PROSPECT,                        // Registered but no purchase\n            NEW,                             // First purchase within 90 days\n            ACTIVE,                          // Regular transactions\n            DORMANT,                         // No transactions 90+ days\n            AT_RISK,                         // Declining engagement/transactions\n            CHURNED                          // No transactions 180+ days\n        }\n\n        enum OnboardingStatus {\n            NOT_STARTED,                     // Account created, onboarding not begun\n            IN_PROGRESS,                     // Onboarding steps partially complete\n            COMPLETED,                       // All onboarding steps finished\n            SKIPPED                          // User skipped onboarding flow\n        }\n    }\n\n    // 1.2 PartnerLink Aggregate\n    // ------------------------------------------------------\n    // Records customer linkages to external loyalty partners (Flybuys, Shell).\n    // Tracks linking status and synchronization state for partner integrations.\n    //\n    // Invariants:\n    // - Customer can only have one active link per partner type\n    // - External member ID must be unique within partner\n    // - Reward preference must be one of: FLYBUYS_POINTS, FUEL_DISCOUNT_SHELL, OTR_REWARDS\n    // - If preference is FLYBUYS_POINTS, PartnerLink must exist with status=LINKED\n    // - Default preference when no partner linked: OTR_REWARDS (fallback)\n    //\n    // Bounded Context Note:\n    // - OAuth tokens are managed by infrastructure OAuth Service\n    // - This aggregate tracks: \"customer linked partner account\"\n    // - Created in response to OAuthLinkEstablished event from OAuth Service\n    Aggregate PartnerLink {\n        Entity CustomerPartnerLink {\n            aggregateRoot\n\n            - PartnerLinkId id\n            - String VivaConsumerId           // Salesforce customer identifier\n            - PartnerType partner             // FLYBUYS, SHELL_CARD\n            - String externalMemberId         // Partner's member/account number\n            - LinkingStatus status\n            - RewardPreference rewardPreference   // Customer's chosen reward type\n            - DateTime linkedAt\n            - DateTime lastSyncedAt           // Last successful sync\n            - String oauthProviderId          // Reference to OAuth Service token\n\n            // Operations\n            def updateRewardPreference(newPreference: RewardPreference): void {\n                // Invariant: Cannot select FLYBUYS_POINTS unless Flybuys account linked\n                // Invariant: Unlinking Flybuys resets preference to OTR_REWARDS (fallback)\n            }\n\n            def recordSync(syncStatus: SyncStatus): void\n        }\n\n        ValueObject LinkingStatus {\n            - LinkState state                 // LINKED, UNLINKED, SYNC_FAILED\n            - String errorMessage\n            - int failedSyncAttempts\n        }\n\n        ValueObject RewardPreference {\n            - RewardPreferenceType type       // FLYBUYS_POINTS, FUEL_DISCOUNT_SHELL, OTR_REWARDS\n        }\n\n        enum LinkState {\n            LINKED,                           // Active partner link\n            UNLINKED,                         // No partner link\n            SYNC_FAILED                       // Link exists but sync failing\n        }\n\n        enum RewardPreferenceType {\n            FLYBUYS_POINTS,                   // Earn Flybuys points (requires linking)\n            FUEL_DISCOUNT_SHELL,              // Shell Price Save fuel discount (4c/L)\n            OTR_REWARDS                       // OTR native loyalty points (default fallback)\n        }\n\n        enum PartnerType {\n            FLYBUYS, SHELL_CARD\n        }\n    }\n\n    // 1.3 RiskAssessment Aggregate\n    // -----------------------------\n    // Customer risk, fraud, and value scores for instant refund decisions.\n    // Provides both computed scores and raw factors for transparency.\n    //\n    // Invariants:\n    // - Risk scores must be 0-100\n    // - Assessment must have calculated timestamp\n    // - Factors must be populated when score is calculated\n    //\n    // Use Case: Instant Refunds\n    // - Provides scored assessment to other business units\n    // - Exposes raw factors for custom scoring logic\n    // - Enables risk-based refund approval workflows\n    Aggregate RiskAssessment {\n        Entity CustomerRiskAssessment {\n            aggregateRoot\n\n            - RiskAssessmentId id\n            - String VivaConsumerId\n            - DateTime assessedAt\n            - DateTime lastUpdatedAt\n\n            // Computed Scores (0-100)\n            - int overallRiskScore           // Combined risk score\n            - int fraudRiskScore             // Fraud-specific risk\n            - int refundRiskScore            // Refund abuse risk\n            - int churnRiskScore             // Customer churn/attrition risk\n            - int customerValueScore         // Customer lifetime value score\n\n            // Risk Factors (raw data for transparency)\n            - RiskFactors factors\n\n            // Operations\n            def calculateRiskScore(): int\n            def updateFactors(newFactors: RiskFactors): void\n        }\n\n        ValueObject RiskFactors {\n            // Refund History\n            - int totalRefundCount\n            - int refundsLast30Days\n            - int refundsLast60Days\n            - int refundsLast90Days\n            - Money totalRefundAmount\n            - Decimal refundToPurchaseRatio\n            - List<String> refundReasonDistribution\n\n            // Transaction Behavior\n            - int transactionFrequency       // Transactions per month\n            - DateTime lastTransactionDate\n            - Money averageBasketValue\n            - Decimal basketValueVariance\n            - int locationDiversity          // Number of unique stores visited\n            - boolean hasUnusualPatterns\n\n            // Fraud Indicators\n            - int disputedTransactionCount\n            - int chargebackCount\n            - Decimal failedPaymentRate\n            - boolean multipleAccountDetected\n            - boolean loginAnomaliesDetected\n            - int fraudFlagCount\n\n            // Account Health\n            - int accountTenureDays\n            - VerificationLevel verificationLevel\n            - AccountStatus accountStatus\n\n            // Engagement Metrics (cached from EngagementService)\n            - int appUsageFrequency          // Logins per week\n            - DateTime lastLoginDate\n            - int supportInteractionCount\n            - Decimal campaignEngagementRate\n\n            // Churn Indicators\n            - int daysSinceLastPurchase\n            - int daysSinceLastLogin\n            - Decimal transactionFrequencyTrend  // +/- percentage change\n            - Decimal basketValueTrend           // +/- percentage change\n            - boolean engagementDeclining        // Trend analysis flag\n            - LifeCycleStage currentLifeCycleStage\n\n            // Customer Value\n            - Money lifetimeValue\n            - Money totalSpend\n            - ProfitabilityScore profitability\n        }\n\n        enum AccountStatus {\n            ACTIVE, SUSPENDED, FLAGGED, CLOSED\n        }\n    }\n\n    // 1.4 RefundHistory Aggregate\n    // ----------------------------\n    // Customer refund transaction history for risk assessment.\n    //\n    // Invariants:\n    // - Refund amount must be positive\n    // - Refund must reference original transaction\n    // - Refund reason must be provided\n    Aggregate RefundHistory {\n        Entity RefundRecord {\n            aggregateRoot\n\n            - RefundId id\n            - String VivaConsumerId\n            - TransactionId originalTransactionId\n            - Money refundAmount\n            - RefundReason reason\n            - RefundStatus status\n            - DateTime requestedAt\n            - DateTime processedAt\n            - String processedBy              // System or agent identifier\n            - int processingTimeDays          // Turnaround time tracking\n        }\n\n        enum RefundReason {\n            PRICING_ERROR,\n            PRODUCT_QUALITY,\n            TRANSACTION_ERROR,\n            CUSTOMER_DISPUTE,\n            PROMOTIONAL_ISSUE,\n            OTHER\n        }\n\n        enum RefundStatus {\n            PENDING,\n            APPROVED,\n            REJECTED,\n            PROCESSED,\n            CANCELLED\n        }\n    }\n\n\n    // ========================================================================\n    // SECTION 2: DOMAIN EVENTS\n    // ========================================================================\n    // Events published to Event Bus for downstream consumption.\n    //\n    // Event Categories:\n    // 1. Profile lifecycle events (creation, updates, verification, completeness, lifecycle stage, onboarding)\n    // 2. Partner linking events\n    // 3. Risk assessment events\n    // 4. Refund history events\n    // ========================================================================\n\n    // --- Profile lifecycle Events ---\n\n    DomainEvent ProfileCreated {\n        - String VivaConsumerId\n        - ProfileId profileId\n        - DateTime createdAt\n        - VerificationLevel initialVerificationLevel\n    }\n\n    DomainEvent ProfileUpdated {\n        - String VivaConsumerId\n        - ProfileId profileId\n        - DateTime updatedAt\n        - List<String> changedFields\n    }\n\n    DomainEvent ProfileVerificationChanged {\n        - String VivaConsumerId\n        - VerificationLevel previousLevel\n        - VerificationLevel newLevel\n        - DateTime changedAt\n    }\n\n    DomainEvent ProfileCompletenessChanged {\n        - String VivaConsumerId\n        - int previousScore\n        - int newScore\n        - DateTime changedAt\n    }\n\n    DomainEvent LifeCycleStageChanged {\n        - String VivaConsumerId\n        - LifeCycleStage previousStage\n        - LifeCycleStage newStage\n        - DateTime changedAt\n        - String trigger                   // TRANSACTION_INACTIVITY | ENGAGEMENT_CHANGE | MANUAL_UPDATE\n    }\n\n    DomainEvent OnboardingCompleted {\n        - String VivaConsumerId\n        - DateTime completedAt\n        - int completionPercentage\n        - List<String> completedSteps\n    }\n\n    DomainEvent OnboardingProgressUpdated {\n        - String VivaConsumerId\n        - int previousPercentage\n        - int newPercentage\n        - String completedStep\n        - DateTime updatedAt\n    }\n\n    // --- Partner Linking Events (MOVED from LoyaltyService) ---\n\n    DomainEvent PartnerLinked {\n        - String VivaConsumerId\n        - PartnerType partner\n        - String externalMemberId\n        - DateTime linkedAt\n    }\n\n    DomainEvent PartnerUnlinked {\n        - String VivaConsumerId\n        - PartnerType partner\n        - DateTime unlinkedAt\n        - String reason\n    }\n\n    DomainEvent PartnerLinkChanged {\n        - String VivaConsumerId\n        - PartnerType partner\n        - LinkState previousState\n        - LinkState newState\n        - DateTime changedAt\n    }\n\n    DomainEvent RewardPreferenceChanged {\n        - String VivaConsumerId\n        - RewardPreferenceType previousPreference\n        - RewardPreferenceType newPreference\n        - DateTime changedAt\n        - String changeReason              // USER_SELECTED, PARTNER_UNLINKED, FALLBACK_APPLIED\n        - PartnerType affectedPartner      // Which partner this change affects (if applicable)\n    }\n\n    // --- Risk Assessment Events ---\n\n    DomainEvent RiskStatusChanged {\n        - String VivaConsumerId\n        - RiskLevel previousLevel\n        - RiskLevel newLevel\n        - DateTime changedAt\n        - String trigger                   // REFUND_THRESHOLD | FRAUD_DETECTED | MANUAL_REVIEW\n    }\n\n    DomainEvent FraudIndicatorDetected {\n        - String VivaConsumerId\n        - FraudIndicatorType indicatorType\n        - String description\n        - Severity severity\n        - DateTime detectedAt\n        - boolean requiresInvestigation\n    }\n\n    enum RiskLevel {\n        LOW, MEDIUM, HIGH, CRITICAL\n    }\n\n    enum FraudIndicatorType {\n        MULTIPLE_ACCOUNTS,\n        CHARGEBACK_PATTERN,\n        LOGIN_ANOMALY,\n        TRANSACTION_ANOMALY,\n        REFUND_ABUSE,\n        DISPUTE_PATTERN\n    }\n\n    enum Severity {\n        LOW, MEDIUM, HIGH, CRITICAL\n    }\n\n    // --- Refund History Events ---\n\n    DomainEvent RefundRequested {\n        - RefundId refundId\n        - String VivaConsumerId\n        - TransactionId originalTransactionId\n        - Money refundAmount\n        - RefundReason reason\n        - DateTime requestedAt\n    }\n\n    DomainEvent RefundProcessed {\n        - RefundId refundId\n        - String VivaConsumerId\n        - Money refundAmount\n        - RefundStatus status\n        - DateTime processedAt\n        - int processingTimeDays\n    }\n\n    // ========================================================================\n    // SECTION 3: ORCHESTRATION & QUERY SERVICES\n    // ========================================================================\n    // Services orchestrate calls to external systems and provide query APIs.\n    // ========================================================================\n\n    Service ProfileQueryService {\n        // Query customer profile (Salesforce canonical + OTR enrichment)\n        getProfile(@String VivaConsumerId) : CustomerProfileResponse\n\n        // Query profile completeness\n        getProfileCompleteness(@String VivaConsumerId) : int\n\n        // Query partner links\n        getPartnerLinks(@String VivaConsumerId) : List<CustomerPartnerLink>\n\n        // Query specific partner link status\n        getPartnerLinkStatus(@String VivaConsumerId, @PartnerType partner) : LinkingStatus\n    }\n\n    Service RiskAssessmentService {\n        // Get comprehensive risk assessment (scores + raw factors)\n        getRiskAssessment(@String VivaConsumerId) : RiskAssessmentResponse\n\n        // Calculate risk score from factors\n        calculateRiskScore(@RiskFactors factors) : int\n\n        // Update risk factors\n        updateRiskFactors(@String VivaConsumerId, @RiskFactors factors): void\n\n        // Specific risk queries\n        getFraudRisk(@String VivaConsumerId) : int\n        getRefundRisk(@String VivaConsumerId) : int\n        getChurnRisk(@String VivaConsumerId) : int\n        getCustomerValueScore(@String VivaConsumerId) : int\n    }\n\n    Service RefundHistoryService {\n        // Query refund history\n        getRefundHistory(@String VivaConsumerId) : List<RefundRecord>\n\n        // Record new refund request\n        recordRefund(@RefundRecord refund) : void\n\n        // Calculate refund statistics\n        getRefundStatistics(@String VivaConsumerId) : RefundStatistics\n    }\n\n    Service PartnerLinkService {\n        // Create partner link\n        createPartnerLink(@String VivaConsumerId, @PartnerType partner, @String externalMemberId) : PartnerLinkId\n\n        // Update reward preference\n        updateRewardPreference(@String VivaConsumerId, @RewardPreferenceType preference) : void\n\n        // Sync with partner (calls partner APIs)\n        syncWithPartner(@PartnerLinkId linkId) : boolean\n\n        // Revoke partner link\n        revokePartnerLink(@PartnerLinkId linkId) : void\n    }\n\n    Service EngagementSyncService {\n        // Update cached engagement summary (from EngagementService)\n        updateEngagementSummary(@String VivaConsumerId, @EngagementMetrics metrics) : void\n\n        // Get cached engagement summary\n        getEngagementSummary(@String VivaConsumerId) : CustomerEngagementSummary\n    }\n\n    Service SalesforceProfileAdapter {\n        // ACL for Salesforce integration\n        // Translates between Salesforce Contact/Person Account and OTR profile model\n\n        // Query canonical customer data from Salesforce\n        getCustomer(@String VivaConsumerId) : SalesforceCustomer\n\n        // Resolve email to VCI (for legacy email-keyed lookups)\n        resolveEmailToVCI(@String email) : String\n\n        // Validate VCI exists in Salesforce\n        validateVCI(@String VivaConsumerId) : boolean\n    }\n\n    // ========================================================================\n    // SECTION 4: SHARED VALUE OBJECTS\n    // ========================================================================\n    // Reusable value objects used across multiple aggregates.\n    // ========================================================================\n\n    ValueObject Money {\n        - Decimal amount\n        - String currency                 // AUD, USD\n    }\n\n    ValueObject ProfileId {\n        - String id\n    }\n\n    ValueObject PartnerLinkId {\n        - String id\n    }\n\n    ValueObject RiskAssessmentId {\n        - String id\n    }\n\n    ValueObject RefundId {\n        - String id\n    }\n\n    ValueObject EngagementSummaryId {\n        - String id\n    }\n\n    ValueObject TransactionId {\n        - String id\n    }\n\n    ValueObject CustomerProfileResponse {\n        // Combined response from Salesforce + ProfileService\n        - String VivaConsumerId\n        - SalesforceCustomer salesforceData   // Canonical data from Salesforce\n        - CustomerProfileRecord otrData       // OTR-specific enrichment\n        - List<CustomerPartnerLink> partnerLinks\n        - int completenessScore\n    }\n\n    ValueObject SalesforceCustomer {\n        // Canonical customer data from Salesforce\n        - String VivaConsumerId\n        - String firstName\n        - String lastName\n        - String email\n        - String phone\n        - Address mailingAddress\n        - DateTime createdDate\n        - DateTime lastModifiedDate\n    }\n\n    ValueObject Address {\n        - String street\n        - String city\n        - String state\n        - String postalCode\n        - String country\n    }\n\n    ValueObject RiskAssessmentResponse {\n        // Comprehensive risk assessment with scores and raw factors\n        - String VivaConsumerId\n        - DateTime assessedAt\n\n        // Computed Scores\n        - int overallRiskScore\n        - int fraudRiskScore\n        - int refundRiskScore\n        - int churnRiskScore\n        - int customerValueScore\n\n        // Raw Factors (for transparency and custom scoring)\n        - RiskFactors factors\n\n        // Aggregated from Other Services\n        - String loyaltyTier              // From LoyaltyService\n        - int loyaltyPointsBalance        // From LoyaltyService\n    }\n\n    ValueObject RefundStatistics {\n        - int totalRefundCount\n        - Money totalRefundAmount\n        - Decimal refundToPurchaseRatio\n        - Money averageRefundAmount\n        - int refundsLast30Days\n        - int refundsLast90Days\n        - List<String> topRefundReasons\n    }\n\n    ValueObject EngagementMetrics {\n        // Metrics from EngagementService for caching\n        - int emailOpenRate\n        - int emailClickRate\n        - int pushNotificationEngagement\n        - int campaignResponseCount\n        - DateTime lastCampaignInteraction\n        - EngagementTier engagementTier\n    }\n\n    // ========================================================================\n    // SECTION 5: REPOSITORIES (Persistence Abstractions)\n    // ========================================================================\n    // Repository interfaces define persistence operations for owned aggregates.\n    // ========================================================================\n\n    // Repository CustomerProfileRepository\n    // Repository PartnerLinkRepository\n    // Repository RiskAssessmentRepository\n    // Repository RefundHistoryRepository\n    // Repository EngagementSummaryRepository\n}\n\n// ============================================================================\n// END OF BOUNDED CONTEXT\n// ============================================================================\n//\n// Implementation Notes:\n// - Database: Azure SQL (optimized for high-frequency updates)\n// - Events published to Event Bus topic: \"profile-events\"\n// - Salesforce integration via REST API with OAuth 2.0\n// - EngagementService integration via Event Bus + batch sync\n// - LoyaltyService queries ProfileService synchronously\n// - Admin portal enhanced to use ProfileService APIs\n// - VCI introduced through Flybuys initiative\n// ============================================================================\n","numLines":721,"startLine":1,"totalLines":721}},"sourceToolAssistantUUID":"8df07f34-8991-4cbd-a624-02c12aa705b8"}
{"parentUuid":"e73da9cc-60a4-457b-9ae5-b0373a5f0bbb","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01ViMW74CuXNb7Mek6XrdurA","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now let me read the paired markdown file to understand its current content, then I'll need to look at the initiatives to understand what needs to be reflected.","signature":"EsgCCkYICxgCKkALeeXmulJHLcmfy4M36oqq7Cn3a/ae1TjQk97yAKd0YnPI8SzViUa5oK2xWGyKJdSAIM94RQau1AwZatsKfj3dEgxIfv4L7/MHNzjQB2gaDCkgPu2+jf1dIXrvYiIwgY+5t7OhN640vV3JcWOzWw6MluHp8xEJxNGxDRWWsdkAlrTQxCD41GeA4PcN9770Kq8Bb0vueB1dTL7/aJ+fZyyQsN8gPM3UhW14uEGG9vUT1pwofLC34/eh31cHIF0hcLWsNGxvBUFLPfg/H1gqQRE23Ec75p5c7ZTKs/cPM0oaP+UpAQ0RFLySP2zucEJVbOlKxbWQ1GPN0FuifyGzMqQo3pKn3yavXpJtsPTnpaKh31fTZsZAqNdnMxOwoDjaxVcXzgocs2yPxzqbz35X9oLVvIFRiJLOMJ7mOC+eew+YzBgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":14,"cache_creation_input_tokens":9310,"cache_read_input_tokens":58734,"cache_creation":{"ephemeral_5m_input_tokens":9310,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWwBLPthKf5cwhPh1mbzL","type":"assistant","uuid":"708eb420-edc3-48e1-93b9-51ee9eb65e52","timestamp":"2026-01-09T04:32:57.150Z"}
{"parentUuid":"708eb420-edc3-48e1-93b9-51ee9eb65e52","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01ViMW74CuXNb7Mek6XrdurA","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01NnG1kQVReHcyUutBzPk4iP","name":"Read","input":{"file_path":"/mnt/c/Users/o.young/work/architecture/bounded_context/profile.adoc"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":14,"cache_creation_input_tokens":9310,"cache_read_input_tokens":58734,"cache_creation":{"ephemeral_5m_input_tokens":9310,"ephemeral_1h_input_tokens":0},"output_tokens":115,"service_tier":"standard"}},"requestId":"req_011CWwBLPthKf5cwhPh1mbzL","type":"assistant","uuid":"df581c66-c2d7-4ed0-b415-37ef3f0430ad","timestamp":"2026-01-09T04:32:58.377Z"}
{"parentUuid":"df581c66-c2d7-4ed0-b415-37ef3f0430ad","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01NnG1kQVReHcyUutBzPk4iP","type":"tool_result","content":"     1→= Profile Bounded Context\n     2→O.Young@otr.com.au\n     3→v0.1, 2025-12-19\n     4→:project-name: OTRG Apps & Ecommerce Architecture\n     5→:togaf-adm-phase: Phase C: Information Systems Architectures\n     6→:document-type: Bounded Context\n     7→:status: Draft\n     8→:version: 0.1\n     9→:domain: Profile\n    10→:bounded-context-type: APPLICATION\n    11→:domain-architect: O.Young@otr.com.au\n    12→:doctype: article\n    13→:toc: left\n    14→:toclevels: 4\n    15→:sectanchors:\n    16→:sectlinks:\n    17→:sectnums:\n    18→:icons: font\n    19→:source-highlighter: highlightjs\n    20→:experimental:\n    21→:description: Bounded Context for the Profile Domain\n    22→:keywords: profile, customer, bounded context, togaf, ddd\n    23→\n    24→== ProfileService\n    25→\n    26→Unified customer profile service providing enriched customer data for\n    27→OTRG ecosystem.\n    28→\n    29→=== Domain Vision Statement\n    30→\n    31→Provide unified, enriched customer profiles bridging\n    32→link:external/salesforce_crm.adoc[Salesforce] canonical\n    33→data with OTRG-specific attributes, behavioral insights, and risk\n    34→assessments.\n    35→\n    36→=== Responsibilities\n    37→\n    38→* OTR-specific customer profile management\n    39→* Customer lifecycle stage and onboarding tracking\n    40→* Partner linking status tracking\n    41→* Customer risk assessment (fraud, refund, churn)\n    42→* Refund history tracking\n    43→* Engagement metrics caching for profile enrichment\n    44→\n    45→=== Implementation Technology\n    46→\n    47→Azure Functions, .NET Core, Azure SQL,\n    48→link:external/salesforce_crm.adoc[Salesforce] API,\n    49→link:interfaces/[Event Bus]\n    50→\n    51→=== What This Service Owns\n    52→\n    53→ProfileService owns OTR-specific enrichment data and bridges\n    54→link:external/salesforce_crm.adoc[Salesforce] canonical\n    55→customer records.\n    56→\n    57→==== Core Aggregates\n    58→\n    59→[width=\"100%\",cols=\"9%,91%\",options=\"header\",]\n    60→|===\n    61→|Aggregate Name |Description\n    62→|`CustomerProfile` |OTRG-specific Customer profile attributes enriching\n    63→link:external/salesforce_crm.adoc[Salesforce] canonical\n    64→data. Stores behavioural data, preferences, and app-specific attributes.\n    65→\n    66→|`PartnerLink` |Securely connects Customers’ OTRG accounts to external\n    67→partner services (like Flybuys and Shell) using industry-standard\n    68→authentication. Manages the connection status and customer preferences.\n    69→\n    70→|`RiskAssessment` |Customer risk, fraud, and value scores for instant\n    71→refund decisions. Provides both computed scores and raw factors for\n    72→transparency.\n    73→\n    74→|`RefundHistory` |Customer refund transaction history for risk\n    75→assessment. Tracks refund requests, processing, and outcomes.\n    76→|===\n    77→\n    78→==== NOT in this Context (Owned by Other Systems)\n    79→\n    80→[width=\"100%\",cols=\"26%,65%,9%\",options=\"header\",]\n    81→|===\n    82→|Action / Entity |Description |Relationship\n    83→|Canonical Customer data |Name, email, phone →\n    84→link:external/salesforce_crm.adoc[Salesforce] CRM |HTTPS\n    85→API\n    86→\n    87→|Viva Consumer ID (VCI) generation |Customer identifier generation →\n    88→link:external/salesforce_crm.adoc[Salesforce] CRM |HTTPS\n    89→API\n    90→\n    91→|Marketing communication preferences |Communication preferences → Braze\n    92→(via EngagementService) |Event Bus\n    93→\n    94→|Loyalty status |Points, tiers, wallet → EagleEye (via LoyaltyService)\n    95→|Event Bus\n    96→\n    97→|Transaction details |Full transaction data → D365 Commerce (POS\n    98→Context) |Event Bus\n    99→\n   100→|Reward transaction adjudication |Transaction reward processing →\n   101→LoyaltyService |HTTPS API\n   102→\n   103→|OAuth tokens |OAuth token management → OAuth Service (Infrastructure)\n   104→|Infrastructure\n   105→|===\n   106→\n   107→=== Domain Events\n   108→\n   109→==== Profile Lifecycle Events\n   110→\n   111→* *ProfileCreated*: New customer profile created\n   112→* *ProfileUpdated*: Customer profile information updated\n   113→* *ProfileVerificationChanged*: Profile verification status changed\n   114→(email/phone verification)\n   115→* *ProfileCompletenessChanged*: Profile completeness score changed\n   116→(0-100)\n   117→* *LifeCycleStageChanged*: Customer lifecycle stage changed (PROSPECT →\n   118→NEW → ACTIVE → DORMANT → AT_RISK → CHURNED)\n   119→* *OnboardingCompleted*: Customer completed onboarding flow\n   120→* *OnboardingProgressUpdated*: Customer progressed through onboarding\n   121→steps\n   122→\n   123→==== Partner Linking Events (Moved from LoyaltyService)\n   124→\n   125→* *PartnerLinked*: Customer linked external partner account (Flybuys,\n   126→Shell)\n   127→* *PartnerUnlinked*: Customer unlinked external partner account\n   128→* *PartnerLinkChanged*: Partner link status changed (LINKED →\n   129→SYNC_FAILED → UNLINKED)\n   130→* *RewardPreferenceChanged*: Customer changed reward program preference\n   131→(FLYBUYS_POINTS, FUEL_DISCOUNT_SHELL, OTR_REWARDS)\n   132→\n   133→==== Risk Assessment Events\n   134→\n   135→* *RiskStatusChanged*: Customer risk status changed (LOW → MEDIUM → HIGH\n   136→→ CRITICAL)\n   137→* *FraudIndicatorDetected*: Potential fraud indicator detected (multiple\n   138→accounts, chargeback pattern, login anomaly, etc.)\n   139→\n   140→==== Refund History Events\n   141→\n   142→* *RefundRequested*: Customer requested refund\n   143→* *RefundProcessed*: Refund processed and completed\n   144→\n   145→=== Key Services\n   146→\n   147→[width=\"100%\",cols=\"19%,81%\",options=\"header\",]\n   148→|===\n   149→|Service Name |Description\n   150→|`ProfileQueryService` |Query customer profile\n   151→(link:external/salesforce_crm.adoc[Salesforce] canonical\n   152→+ OTR enrichment), profile completeness, partner links\n   153→\n   154→|`RiskAssessmentService` |Get comprehensive risk assessment (scores +\n   155→raw factors), calculate risk scores, fraud/refund/churn risk queries\n   156→\n   157→|`RefundHistoryService` |Query refund history, record new refund\n   158→requests, calculate refund statistics\n   159→\n   160→|`PartnerLinkService` |Create partner link, update reward preference,\n   161→sync with partner, revoke partner link\n   162→\n   163→|`EngagementSyncService` |Update cached engagement summary from\n   164→EngagementService, get cached engagement summary\n   165→\n   166→|`[Salesforce](external/salesforce_crm.adoc)ProfileAdapter`\n   167→|ACL for link:external/salesforce_crm.adoc[Salesforce]\n   168→integration - query canonical customer data, resolve email to VCI,\n   169→validate VCI\n   170→|===\n   171→\n   172→=== Integration Points\n   173→\n   174→* *Upstream*:\n   175→link:external/salesforce_crm.adoc[Salesforce] (canonical\n   176→customer data), EngagementService (engagement metrics)\n   177→* *Downstream*: LoyaltyService, EngagementService, RefundService\n   178→(future)\n   179→* *Bidirectional*: EngagementService (profile enrichment ↔ engagement\n   180→summaries)\n   181→\n   182→=== Bounded Context Boundaries\n   183→\n   184→* ProfileService enriches\n   185→link:external/salesforce_crm.adoc[Salesforce] canonical\n   186→data with OTR-specific attributes\n   187→* link:external/salesforce_crm.adoc[Salesforce] is system\n   188→of record for customer identity and core contact details\n   189→* ProfileService is system of record for OTR-specific behavior and risk\n   190→data\n   191→* More volatile than\n   192→link:external/salesforce_crm.adoc[Salesforce] (frequent\n   193→updates from app usage, transactions)\n   194→\n   195→=== Architecture Decision Log\n   196→\n   197→==== Decision 1: ProfileService Bridges link:external/salesforce_crm.adoc[Salesforce] and OTR Ecosystem\n   198→\n   199→*Decision:* ProfileService acts as an Anti-Corruption Layer between\n   200→link:external/salesforce_crm.adoc[Salesforce] (canonical\n   201→customer records) and OTR-specific profile data.\n   202→\n   203→*Rationale:*\n   204→\n   205→* link:external/salesforce_crm.adoc[Salesforce] owns\n   206→canonical customer identity (VCI, name, email, phone)\n   207→* OTR App Database contains richer OTR-specific profile data\n   208→* Admin portal currently operates independently from\n   209→link:external/salesforce_crm.adoc[Salesforce]\n   210→* ProfileService evolves existing OTR App database to bridge both\n   211→systems\n   212→* VCI will be introduced through Flybuys initiative\n   213→\n   214→*Current State:*\n   215→\n   216→* OTR App Database → Admin Portal (email-keyed, no VCI)\n   217→* link:external/salesforce_crm.adoc[Salesforce] → Viva\n   218→brands (VCI-keyed)\n   219→* No connection between systems\n   220→\n   221→*Future State:*\n   222→\n   223→* ProfileService stores OTR-specific enrichment with VCI\n   224→* Queries link:external/salesforce_crm.adoc[Salesforce]\n   225→for canonical customer data\n   226→* Admin portal enhanced to use VCI\n   227→* External systems (EagleEye, Braze) keyed by VCI\n   228→\n   229→*Implementation:*\n   230→\n   231→* ProfileService stores OTR-specific attributes with VCI reference\n   232→* Synchronous queries to\n   233→link:external/salesforce_crm.adoc[Salesforce] for\n   234→canonical customer data\n   235→* Customer-Supplier (Conformist) pattern with\n   236→link:external/salesforce_crm.adoc[Salesforce]\n   237→* ProfileService owns OTR enrichment,\n   238→link:external/salesforce_crm.adoc[Salesforce] owns\n   239→identity\n   240→\n   241→==== Decision 2: Risk Assessment for Instant Refunds\n   242→\n   243→*Decision:* ProfileService provides scored risk assessment and raw\n   244→factors to enable instant refund decisions by other business units.\n   245→\n   246→*Rationale:*\n   247→\n   248→* Current refund turnaround is 15 days due to poor workflows\n   249→* Target: Immediate refunds for right customers based on risk profile\n   250→* Risk profile = loyalty + fraud + behavioral factors\n   251→* ProfileService doesn’t process refunds, just provides assessment\n   252→\n   253→*Risk Assessment Factors:*\n   254→\n   255→*ProfileService Owned:*\n   256→\n   257→* Refund history (count, frequency, amounts, reasons)\n   258→* Transaction behavior (frequency, recency, transaction value)\n   259→* Account health (tenure, verification status)\n   260→* Fraud indicators (disputes, chargebacks, anomalies)\n   261→* Engagement metrics (app usage, support interactions)\n   262→* Customer value (lifetime value, profitability)\n   263→\n   264→*Aggregated from Other Services:*\n   265→\n   266→* Loyalty tier/status → LoyaltyService\n   267→\n   268→*API Design:*\n   269→\n   270→* Provides both computed risk score AND raw factors\n   271→* Enables other business units to apply their own scoring logic\n   272→* Transparency for audit and debugging\n   273→\n   274→*Implementation:*\n   275→\n   276→* RiskAssessment aggregate calculates scores\n   277→* REST API endpoint: GET /profiles/\\{vci}/risk-assessment\n   278→* Admin portal can display for customer service agents\n   279→* Future: RefundService orchestrates instant refund decisions\n   280→\n   281→==== Decision 3: PartnerLink Aggregate Moved from LoyaltyService\n   282→\n   283→*Decision:* PartnerLink aggregate moved from LoyaltyService to\n   284→ProfileService.\n   285→\n   286→*Rationale:*\n   287→\n   288→* Partner linking is customer profile data, not loyalty transaction data\n   289→* ProfileService is natural home for customer relationships\n   290→* Reduces LoyaltyService complexity to single aggregate\n   291→(RewardTransaction)\n   292→\n   293→*Migration Impact:*\n   294→\n   295→* LoyaltyService queries ProfileService synchronously for partner link\n   296→status\n   297→* Pattern: GET /profiles/\\{vci}/partner-links\n   298→* Similar to how LoyaltyService queries EagleEye (real-time\n   299→orchestration)\n   300→\n   301→*Implementation:*\n   302→\n   303→* PartnerLink aggregate tracks linking status and reward preference\n   304→* OAuth tokens managed by infrastructure OAuth Service (not in\n   305→aggregate)\n   306→* ProfileService publishes PartnerLinked/PartnerUnlinked events\n   307→* LoyaltyService consumes events for auditing/analytics\n   308→\n   309→==== Decision 4: Bidirectional Integration with EngagementService\n   310→\n   311→*Decision:* ProfileService and EngagementService have bidirectional\n   312→integration with hybrid event/batch synchronization pattern.\n   313→\n   314→*Rationale:*\n   315→\n   316→* Both services need data from each other\n   317→* Each maintains system of record status for their domain\n   318→* Eventual consistency acceptable (not real-time)\n   319→* Strong event-based architecture with pragmatic batching\n   320→\n   321→*ProfileService → EngagementService (for segmentation/targeting):*\n   322→\n   323→* Events: ProfileCreated, ProfileUpdated, PartnerLinkChanged,\n   324→RiskStatusChanged\n   325→* Batch: Daily profile enrichment (risk scores, profile completeness)\n   326→* Use case: Campaign targeting, segmentation\n   327→\n   328→*EngagementService → ProfileService (for profile enrichment):*\n   329→\n   330→* Events: EngagementTierChanged (highly engaged → disengaged)\n   331→* Batch: Daily engagement score rollup (click rates, app usage\n   332→summaries)\n   333→* Use case: Risk assessment, profile completeness\n   334→\n   335→*Each Service is System of Record:*\n   336→\n   337→* EngagementService owns: Campaign interactions, notification\n   338→preferences\n   339→* ProfileService owns: Customer attributes, risk scores, partner links\n   340→\n   341→*Implementation:*\n   342→\n   343→* Open Host Service + Published Language pattern (both directions)\n   344→* Event Bus for real-time critical changes\n   345→* Scheduled batch jobs for comprehensive summaries\n   346→* Cached summaries stored locally (eventual consistency)\n   347→\n   348→==== Decision 5: ProfileService More Volatile Than link:external/salesforce_crm.adoc[Salesforce]\n   349→\n   350→*Decision:* ProfileService updates more frequently than\n   351→link:external/salesforce_crm.adoc[Salesforce] because it\n   352→tracks behavioral and transactional data.\n   353→\n   354→*Rationale:*\n   355→\n   356→* link:external/salesforce_crm.adoc[Salesforce]:\n   357→Canonical customer data changes infrequently (name, email)\n   358→* ProfileService: Behavioral data changes constantly (app usage,\n   359→transactions)\n   360→* ProfileService optimized for high-frequency updates\n   361→* link:external/salesforce_crm.adoc[Salesforce] optimized\n   362→for identity and contact management\n   363→\n   364→*Volatility Comparison:*\n   365→\n   366→* link:external/salesforce_crm.adoc[Salesforce] updates:\n   367→Customer changes email, phone, address (infrequent)\n   368→* ProfileService updates: Every transaction, login, app interaction\n   369→(frequent)\n   370→\n   371→*Implementation:*\n   372→\n   373→* ProfileService database optimized for write-heavy workload\n   374→* link:external/salesforce_crm.adoc[Salesforce] sync\n   375→handles identity changes only\n   376→* No need for ProfileService to push behavioral data to\n   377→link:external/salesforce_crm.adoc[Salesforce]\n   378→* ProfileService is authoritative for OTR behavioral data\n   379→\n   380→==== Decision 6: Synchronous Integration from LoyaltyService\n   381→\n   382→*Decision:* LoyaltyService queries ProfileService synchronously for\n   383→partner link status during transaction adjudication.\n   384→\n   385→*Rationale:*\n   386→\n   387→* Transaction adjudication needs current partner status\n   388→* Real-time query ensures accuracy\n   389→* Similar pattern to LoyaltyService querying EagleEye\n   390→* No local caching complexity\n   391→\n   392→*Flow:*\n   393→\n   394→[arabic]\n   395→. Transaction adjudication request arrives at LoyaltyService\n   396→. LoyaltyService queries ProfileService: GET\n   397→/profiles/\\{vci}/partner-links\n   398→. ProfileService returns partner linking status\n   399→. LoyaltyService uses status for reward calculation\n   400→. Transaction adjudication completes\n   401→\n   402→*Implementation:*\n   403→\n   404→* REST API for partner link queries\n   405→* Low latency required (<100ms)\n   406→* Circuit breaker pattern for resilience\n   407→* Fallback to default (OTR Rewards) if ProfileService unavailable\n   408→\n   409→=== Key Architectural Patterns\n   410→\n   411→==== 1. Anti-Corruption Layer (ACL)\n   412→\n   413→* link:external/salesforce_crm.adoc[Salesforce]ProfileAdapter:\n   414→Protects domain from\n   415→link:external/salesforce_crm.adoc[Salesforce] API changes\n   416→* Translates between\n   417→link:external/salesforce_crm.adoc[Salesforce]\n   418→Contact/Person Account and OTR profile model\n   419→* Single place to update when\n   420→link:external/salesforce_crm.adoc[Salesforce] changes\n   421→\n   422→==== 2. Backend-for-Frontend (BFF)\n   423→\n   424→* ProfileService aggregates from multiple sources\n   425→(link:external/salesforce_crm.adoc[Salesforce],\n   426→EngagementService)\n   427→* Provides unified profile API for mobile app and other services\n   428→* Enriches canonical data with OTR-specific attributes\n   429→\n   430→==== 3. Hybrid Event/Batch Synchronization\n   431→\n   432→* Critical changes via domain events (real-time)\n   433→* Comprehensive summaries via batch jobs (periodic)\n   434→* Balances consistency needs with performance\n   435→\n   436→==== 4. Query-and-Enrich Pattern\n   437→\n   438→* Queries link:external/salesforce_crm.adoc[Salesforce]\n   439→for canonical customer data (real-time)\n   440→* Enriches with OTR-specific attributes from local database\n   441→* Returns unified CustomerProfileResponse\n   442→* No local caching of\n   443→link:external/salesforce_crm.adoc[Salesforce] data\n   444→(always fresh)\n   445→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"bf9e6a7f-0c30-4e71-961a-116d2f47af3c","timestamp":"2026-01-09T04:32:58.538Z","toolUseResult":{"type":"text","file":{"filePath":"/mnt/c/Users/o.young/work/architecture/bounded_context/profile.adoc","content":"= Profile Bounded Context\nO.Young@otr.com.au\nv0.1, 2025-12-19\n:project-name: OTRG Apps & Ecommerce Architecture\n:togaf-adm-phase: Phase C: Information Systems Architectures\n:document-type: Bounded Context\n:status: Draft\n:version: 0.1\n:domain: Profile\n:bounded-context-type: APPLICATION\n:domain-architect: O.Young@otr.com.au\n:doctype: article\n:toc: left\n:toclevels: 4\n:sectanchors:\n:sectlinks:\n:sectnums:\n:icons: font\n:source-highlighter: highlightjs\n:experimental:\n:description: Bounded Context for the Profile Domain\n:keywords: profile, customer, bounded context, togaf, ddd\n\n== ProfileService\n\nUnified customer profile service providing enriched customer data for\nOTRG ecosystem.\n\n=== Domain Vision Statement\n\nProvide unified, enriched customer profiles bridging\nlink:external/salesforce_crm.adoc[Salesforce] canonical\ndata with OTRG-specific attributes, behavioral insights, and risk\nassessments.\n\n=== Responsibilities\n\n* OTR-specific customer profile management\n* Customer lifecycle stage and onboarding tracking\n* Partner linking status tracking\n* Customer risk assessment (fraud, refund, churn)\n* Refund history tracking\n* Engagement metrics caching for profile enrichment\n\n=== Implementation Technology\n\nAzure Functions, .NET Core, Azure SQL,\nlink:external/salesforce_crm.adoc[Salesforce] API,\nlink:interfaces/[Event Bus]\n\n=== What This Service Owns\n\nProfileService owns OTR-specific enrichment data and bridges\nlink:external/salesforce_crm.adoc[Salesforce] canonical\ncustomer records.\n\n==== Core Aggregates\n\n[width=\"100%\",cols=\"9%,91%\",options=\"header\",]\n|===\n|Aggregate Name |Description\n|`CustomerProfile` |OTRG-specific Customer profile attributes enriching\nlink:external/salesforce_crm.adoc[Salesforce] canonical\ndata. Stores behavioural data, preferences, and app-specific attributes.\n\n|`PartnerLink` |Securely connects Customers’ OTRG accounts to external\npartner services (like Flybuys and Shell) using industry-standard\nauthentication. Manages the connection status and customer preferences.\n\n|`RiskAssessment` |Customer risk, fraud, and value scores for instant\nrefund decisions. Provides both computed scores and raw factors for\ntransparency.\n\n|`RefundHistory` |Customer refund transaction history for risk\nassessment. Tracks refund requests, processing, and outcomes.\n|===\n\n==== NOT in this Context (Owned by Other Systems)\n\n[width=\"100%\",cols=\"26%,65%,9%\",options=\"header\",]\n|===\n|Action / Entity |Description |Relationship\n|Canonical Customer data |Name, email, phone →\nlink:external/salesforce_crm.adoc[Salesforce] CRM |HTTPS\nAPI\n\n|Viva Consumer ID (VCI) generation |Customer identifier generation →\nlink:external/salesforce_crm.adoc[Salesforce] CRM |HTTPS\nAPI\n\n|Marketing communication preferences |Communication preferences → Braze\n(via EngagementService) |Event Bus\n\n|Loyalty status |Points, tiers, wallet → EagleEye (via LoyaltyService)\n|Event Bus\n\n|Transaction details |Full transaction data → D365 Commerce (POS\nContext) |Event Bus\n\n|Reward transaction adjudication |Transaction reward processing →\nLoyaltyService |HTTPS API\n\n|OAuth tokens |OAuth token management → OAuth Service (Infrastructure)\n|Infrastructure\n|===\n\n=== Domain Events\n\n==== Profile Lifecycle Events\n\n* *ProfileCreated*: New customer profile created\n* *ProfileUpdated*: Customer profile information updated\n* *ProfileVerificationChanged*: Profile verification status changed\n(email/phone verification)\n* *ProfileCompletenessChanged*: Profile completeness score changed\n(0-100)\n* *LifeCycleStageChanged*: Customer lifecycle stage changed (PROSPECT →\nNEW → ACTIVE → DORMANT → AT_RISK → CHURNED)\n* *OnboardingCompleted*: Customer completed onboarding flow\n* *OnboardingProgressUpdated*: Customer progressed through onboarding\nsteps\n\n==== Partner Linking Events (Moved from LoyaltyService)\n\n* *PartnerLinked*: Customer linked external partner account (Flybuys,\nShell)\n* *PartnerUnlinked*: Customer unlinked external partner account\n* *PartnerLinkChanged*: Partner link status changed (LINKED →\nSYNC_FAILED → UNLINKED)\n* *RewardPreferenceChanged*: Customer changed reward program preference\n(FLYBUYS_POINTS, FUEL_DISCOUNT_SHELL, OTR_REWARDS)\n\n==== Risk Assessment Events\n\n* *RiskStatusChanged*: Customer risk status changed (LOW → MEDIUM → HIGH\n→ CRITICAL)\n* *FraudIndicatorDetected*: Potential fraud indicator detected (multiple\naccounts, chargeback pattern, login anomaly, etc.)\n\n==== Refund History Events\n\n* *RefundRequested*: Customer requested refund\n* *RefundProcessed*: Refund processed and completed\n\n=== Key Services\n\n[width=\"100%\",cols=\"19%,81%\",options=\"header\",]\n|===\n|Service Name |Description\n|`ProfileQueryService` |Query customer profile\n(link:external/salesforce_crm.adoc[Salesforce] canonical\n+ OTR enrichment), profile completeness, partner links\n\n|`RiskAssessmentService` |Get comprehensive risk assessment (scores +\nraw factors), calculate risk scores, fraud/refund/churn risk queries\n\n|`RefundHistoryService` |Query refund history, record new refund\nrequests, calculate refund statistics\n\n|`PartnerLinkService` |Create partner link, update reward preference,\nsync with partner, revoke partner link\n\n|`EngagementSyncService` |Update cached engagement summary from\nEngagementService, get cached engagement summary\n\n|`[Salesforce](external/salesforce_crm.adoc)ProfileAdapter`\n|ACL for link:external/salesforce_crm.adoc[Salesforce]\nintegration - query canonical customer data, resolve email to VCI,\nvalidate VCI\n|===\n\n=== Integration Points\n\n* *Upstream*:\nlink:external/salesforce_crm.adoc[Salesforce] (canonical\ncustomer data), EngagementService (engagement metrics)\n* *Downstream*: LoyaltyService, EngagementService, RefundService\n(future)\n* *Bidirectional*: EngagementService (profile enrichment ↔ engagement\nsummaries)\n\n=== Bounded Context Boundaries\n\n* ProfileService enriches\nlink:external/salesforce_crm.adoc[Salesforce] canonical\ndata with OTR-specific attributes\n* link:external/salesforce_crm.adoc[Salesforce] is system\nof record for customer identity and core contact details\n* ProfileService is system of record for OTR-specific behavior and risk\ndata\n* More volatile than\nlink:external/salesforce_crm.adoc[Salesforce] (frequent\nupdates from app usage, transactions)\n\n=== Architecture Decision Log\n\n==== Decision 1: ProfileService Bridges link:external/salesforce_crm.adoc[Salesforce] and OTR Ecosystem\n\n*Decision:* ProfileService acts as an Anti-Corruption Layer between\nlink:external/salesforce_crm.adoc[Salesforce] (canonical\ncustomer records) and OTR-specific profile data.\n\n*Rationale:*\n\n* link:external/salesforce_crm.adoc[Salesforce] owns\ncanonical customer identity (VCI, name, email, phone)\n* OTR App Database contains richer OTR-specific profile data\n* Admin portal currently operates independently from\nlink:external/salesforce_crm.adoc[Salesforce]\n* ProfileService evolves existing OTR App database to bridge both\nsystems\n* VCI will be introduced through Flybuys initiative\n\n*Current State:*\n\n* OTR App Database → Admin Portal (email-keyed, no VCI)\n* link:external/salesforce_crm.adoc[Salesforce] → Viva\nbrands (VCI-keyed)\n* No connection between systems\n\n*Future State:*\n\n* ProfileService stores OTR-specific enrichment with VCI\n* Queries link:external/salesforce_crm.adoc[Salesforce]\nfor canonical customer data\n* Admin portal enhanced to use VCI\n* External systems (EagleEye, Braze) keyed by VCI\n\n*Implementation:*\n\n* ProfileService stores OTR-specific attributes with VCI reference\n* Synchronous queries to\nlink:external/salesforce_crm.adoc[Salesforce] for\ncanonical customer data\n* Customer-Supplier (Conformist) pattern with\nlink:external/salesforce_crm.adoc[Salesforce]\n* ProfileService owns OTR enrichment,\nlink:external/salesforce_crm.adoc[Salesforce] owns\nidentity\n\n==== Decision 2: Risk Assessment for Instant Refunds\n\n*Decision:* ProfileService provides scored risk assessment and raw\nfactors to enable instant refund decisions by other business units.\n\n*Rationale:*\n\n* Current refund turnaround is 15 days due to poor workflows\n* Target: Immediate refunds for right customers based on risk profile\n* Risk profile = loyalty + fraud + behavioral factors\n* ProfileService doesn’t process refunds, just provides assessment\n\n*Risk Assessment Factors:*\n\n*ProfileService Owned:*\n\n* Refund history (count, frequency, amounts, reasons)\n* Transaction behavior (frequency, recency, transaction value)\n* Account health (tenure, verification status)\n* Fraud indicators (disputes, chargebacks, anomalies)\n* Engagement metrics (app usage, support interactions)\n* Customer value (lifetime value, profitability)\n\n*Aggregated from Other Services:*\n\n* Loyalty tier/status → LoyaltyService\n\n*API Design:*\n\n* Provides both computed risk score AND raw factors\n* Enables other business units to apply their own scoring logic\n* Transparency for audit and debugging\n\n*Implementation:*\n\n* RiskAssessment aggregate calculates scores\n* REST API endpoint: GET /profiles/\\{vci}/risk-assessment\n* Admin portal can display for customer service agents\n* Future: RefundService orchestrates instant refund decisions\n\n==== Decision 3: PartnerLink Aggregate Moved from LoyaltyService\n\n*Decision:* PartnerLink aggregate moved from LoyaltyService to\nProfileService.\n\n*Rationale:*\n\n* Partner linking is customer profile data, not loyalty transaction data\n* ProfileService is natural home for customer relationships\n* Reduces LoyaltyService complexity to single aggregate\n(RewardTransaction)\n\n*Migration Impact:*\n\n* LoyaltyService queries ProfileService synchronously for partner link\nstatus\n* Pattern: GET /profiles/\\{vci}/partner-links\n* Similar to how LoyaltyService queries EagleEye (real-time\norchestration)\n\n*Implementation:*\n\n* PartnerLink aggregate tracks linking status and reward preference\n* OAuth tokens managed by infrastructure OAuth Service (not in\naggregate)\n* ProfileService publishes PartnerLinked/PartnerUnlinked events\n* LoyaltyService consumes events for auditing/analytics\n\n==== Decision 4: Bidirectional Integration with EngagementService\n\n*Decision:* ProfileService and EngagementService have bidirectional\nintegration with hybrid event/batch synchronization pattern.\n\n*Rationale:*\n\n* Both services need data from each other\n* Each maintains system of record status for their domain\n* Eventual consistency acceptable (not real-time)\n* Strong event-based architecture with pragmatic batching\n\n*ProfileService → EngagementService (for segmentation/targeting):*\n\n* Events: ProfileCreated, ProfileUpdated, PartnerLinkChanged,\nRiskStatusChanged\n* Batch: Daily profile enrichment (risk scores, profile completeness)\n* Use case: Campaign targeting, segmentation\n\n*EngagementService → ProfileService (for profile enrichment):*\n\n* Events: EngagementTierChanged (highly engaged → disengaged)\n* Batch: Daily engagement score rollup (click rates, app usage\nsummaries)\n* Use case: Risk assessment, profile completeness\n\n*Each Service is System of Record:*\n\n* EngagementService owns: Campaign interactions, notification\npreferences\n* ProfileService owns: Customer attributes, risk scores, partner links\n\n*Implementation:*\n\n* Open Host Service + Published Language pattern (both directions)\n* Event Bus for real-time critical changes\n* Scheduled batch jobs for comprehensive summaries\n* Cached summaries stored locally (eventual consistency)\n\n==== Decision 5: ProfileService More Volatile Than link:external/salesforce_crm.adoc[Salesforce]\n\n*Decision:* ProfileService updates more frequently than\nlink:external/salesforce_crm.adoc[Salesforce] because it\ntracks behavioral and transactional data.\n\n*Rationale:*\n\n* link:external/salesforce_crm.adoc[Salesforce]:\nCanonical customer data changes infrequently (name, email)\n* ProfileService: Behavioral data changes constantly (app usage,\ntransactions)\n* ProfileService optimized for high-frequency updates\n* link:external/salesforce_crm.adoc[Salesforce] optimized\nfor identity and contact management\n\n*Volatility Comparison:*\n\n* link:external/salesforce_crm.adoc[Salesforce] updates:\nCustomer changes email, phone, address (infrequent)\n* ProfileService updates: Every transaction, login, app interaction\n(frequent)\n\n*Implementation:*\n\n* ProfileService database optimized for write-heavy workload\n* link:external/salesforce_crm.adoc[Salesforce] sync\nhandles identity changes only\n* No need for ProfileService to push behavioral data to\nlink:external/salesforce_crm.adoc[Salesforce]\n* ProfileService is authoritative for OTR behavioral data\n\n==== Decision 6: Synchronous Integration from LoyaltyService\n\n*Decision:* LoyaltyService queries ProfileService synchronously for\npartner link status during transaction adjudication.\n\n*Rationale:*\n\n* Transaction adjudication needs current partner status\n* Real-time query ensures accuracy\n* Similar pattern to LoyaltyService querying EagleEye\n* No local caching complexity\n\n*Flow:*\n\n[arabic]\n. Transaction adjudication request arrives at LoyaltyService\n. LoyaltyService queries ProfileService: GET\n/profiles/\\{vci}/partner-links\n. ProfileService returns partner linking status\n. LoyaltyService uses status for reward calculation\n. Transaction adjudication completes\n\n*Implementation:*\n\n* REST API for partner link queries\n* Low latency required (<100ms)\n* Circuit breaker pattern for resilience\n* Fallback to default (OTR Rewards) if ProfileService unavailable\n\n=== Key Architectural Patterns\n\n==== 1. Anti-Corruption Layer (ACL)\n\n* link:external/salesforce_crm.adoc[Salesforce]ProfileAdapter:\nProtects domain from\nlink:external/salesforce_crm.adoc[Salesforce] API changes\n* Translates between\nlink:external/salesforce_crm.adoc[Salesforce]\nContact/Person Account and OTR profile model\n* Single place to update when\nlink:external/salesforce_crm.adoc[Salesforce] changes\n\n==== 2. Backend-for-Frontend (BFF)\n\n* ProfileService aggregates from multiple sources\n(link:external/salesforce_crm.adoc[Salesforce],\nEngagementService)\n* Provides unified profile API for mobile app and other services\n* Enriches canonical data with OTR-specific attributes\n\n==== 3. Hybrid Event/Batch Synchronization\n\n* Critical changes via domain events (real-time)\n* Comprehensive summaries via batch jobs (periodic)\n* Balances consistency needs with performance\n\n==== 4. Query-and-Enrich Pattern\n\n* Queries link:external/salesforce_crm.adoc[Salesforce]\nfor canonical customer data (real-time)\n* Enriches with OTR-specific attributes from local database\n* Returns unified CustomerProfileResponse\n* No local caching of\nlink:external/salesforce_crm.adoc[Salesforce] data\n(always fresh)\n","numLines":445,"startLine":1,"totalLines":445}},"sourceToolAssistantUUID":"df581c66-c2d7-4ed0-b415-37ef3f0430ad"}
{"parentUuid":"bf9e6a7f-0c30-4e71-961a-116d2f47af3c","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_017xQd8nSpRnish2aJuLKUUt","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now let me examine the initiatives to understand what needs to be reflected:\n\n1. Flybuys integration initiative\n2. Salesforce Customer Support initiative\n\nLet me read these to understand what ProfileService changes are needed.","signature":"EoYDCkYICxgCKkAXLYdM8x8vjDdx6SuSZXqGmwGAv+gXVQw+jLsgCJa0Q6usNPnTzYfg7pMPXdMf37xur/+Jm7Tyi5jB5E+iOQUqEgzXI4bUncUQKJUj7xwaDDFKh+QSaamHcYLDMCIw3CDBdWKZDy1NM6jKZI77x1AOqxY04rIX1XLJ8KrsFS1aMkc5ynwOCZUax7UssZzkKu0BPuKqEvBnXquuRaGGpLRb9QRjf/PEfqiNqQcJ0MaHB21wi8BegDTVhU1cyQJDq1wRx6QP2h6t1RXfTxcHgQNLC244YSPUH5XotelBdINsxnFM14yUYoQXeWvltUbkXCrDA9U+r3Y8zcKpPcx29kAUIuvyMCNK6m5EreOhesggNgDKgfjYXcx/i6rGxwTMQXY5ombXJ988N2T/GjJD+pqOUU2R3s+ZJKz1yw11nGKP6X9DM3qVqYg3hgHjVxbkJqOr0Cm1LzoPlqQ5A5mKzpilHY6VP913IGb8KJIOtuyHsSztkf7UfNBlfRD8i+KeGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":5628,"cache_read_input_tokens":68044,"cache_creation":{"ephemeral_5m_input_tokens":5628,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWwBLpwLLcEMCE5Hw4gvE","type":"assistant","uuid":"46fa60e0-966d-4587-806a-a5a59b549670","timestamp":"2026-01-09T04:33:03.347Z"}
{"parentUuid":"46fa60e0-966d-4587-806a-a5a59b549670","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_017xQd8nSpRnish2aJuLKUUt","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01VP5acHtcEEbVaJDBpmeAts","name":"Read","input":{"file_path":"/mnt/c/Users/o.young/work/architecture/initiatives/flybuys_integration.adoc","limit":200}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":5628,"cache_read_input_tokens":68044,"cache_creation":{"ephemeral_5m_input_tokens":5628,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWwBLpwLLcEMCE5Hw4gvE","type":"assistant","uuid":"d8c64f17-5849-4439-b1dc-74944abee7cc","timestamp":"2026-01-09T04:33:04.478Z"}
{"parentUuid":"d8c64f17-5849-4439-b1dc-74944abee7cc","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_017xQd8nSpRnish2aJuLKUUt","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01MuMH6Vos7Ge617Dxfos82n","name":"Read","input":{"file_path":"/mnt/c/Users/o.young/work/architecture/initiatives/salesforce_customer_support.adoc","limit":200}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":5628,"cache_read_input_tokens":68044,"cache_creation":{"ephemeral_5m_input_tokens":5628,"ephemeral_1h_input_tokens":0},"output_tokens":228,"service_tier":"standard"}},"requestId":"req_011CWwBLpwLLcEMCE5Hw4gvE","type":"assistant","uuid":"291567ad-43dd-4df1-8693-0d22040b1746","timestamp":"2026-01-09T04:33:05.028Z"}
{"parentUuid":"d8c64f17-5849-4439-b1dc-74944abee7cc","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01VP5acHtcEEbVaJDBpmeAts","type":"tool_result","content":"     1→= OTR-002 Flybuys Integration\n     2→:domain: Loyalty\n     3→:domain-architect: O.Young@otr.com.au\n     4→:project: OTR-002\n     5→:doctype: article\n     6→:toc: left\n     7→:toclevels: 3\n     8→:sectanchors:\n     9→:sectlinks:\n    10→:sectnums:\n    11→:icons: font\n    12→:source-highlighter: highlightjs\n    13→:experimental:\n    14→\n    15→== What We're Building\n    16→\n    17→A new Loyalty system that allows all OTRG customers to\n    18→\n    19→[cols=\"1,2\"]\n    20→|===\n    21→| Feature | Description\n    22→\n    23→| Link their Flybuys account\n    24→| via the OTR mobile app (OAuth secure linking)\n    25→\n    26→| Choose their reward preference\n    27→| earn Flybuys points OR OTR fuel discounts at every transaction\n    28→\n    29→| Scan Flybuys cards at POS\n    30→| physical cards, mobile app barcodes, or Apple/Google Wallet passes\n    31→\n    32→| Earn Flybuys points automatically\n    33→| points post to Flybuys account within 24 hours\n    34→\n    35→| Check Flybuys balance\n    36→| in OTR mobile app - real-time balance queries with caching\n    37→|===\n    38→\n    39→== Architecture Approach\n    40→\n    41→NOTE: This and the xref:initiatives:salesforce_customer_support.adoc[Salesforce Customer Support] initiative are the first implementations of the overall Domain-Driven Design (DDD) architecture for OTR Group's digital platform. Depending on sequencing, some architectural elements may be delivered in either initiative.\n    42→\n    43→At its core, this is a foundational architecture with the goal of creating a clear, shared structure for how our digital platforms represent Customers, Decisions, and Outcomes, and to distribute a common understanding of domain knowledge between business and technology.\n    44→\n    45→Instead of embedding business rules and assumptions across apps, POS flows, and third-party tools, it gives teams a common frame of reference, improves communication across product and technology, and makes complex customer journeys easier to reason about, change, and govern.\n    46→\n    47→Importantly, this structure is not specific to this single project, or even loyalty as a capability, it aims to provide a repeatable way to introduce all the capabilities presented in the road-map, from promotions or subscriptions to future partners, without re-wiring core customer and commerce flows each time.\n    48→\n    49→By making domain knowledge explicit and stable, the architecture reduces long-term complexity, lowers delivery risk, and enables the digital and eCommerce ecosystem to evolve with confidence as business priorities shift.\n    50→\n    51→=== New \"Profile Service\"\n    52→\n    53→Customer partner account management\n    54→\n    55→- Handles Flybuys account linking via OAuth\n    56→- Stores customer reward preferences (Flybuys vs OTR)\n    57→- Manages partner link status (linked/unlinked)\n    58→\n    59→=== New \"Loyalty Service\"\n    60→\n    61→Transaction processing and partner integration\n    62→\n    63→- Resolves loyalty credentials at POS (Flybuys cards → customer identity)\n    64→- Processes transaction adjudication (calculates rewards)\n    65→- Generates nightly batch files for Flybuys\n    66→- Queries Flybuys balances (with Redis caching)\n    67→\n    68→=== New \"Engagement Service\"\n    69→\n    70→Customer engagement and notifications\n    71→\n    72→- Consumes domain events from Profile and Loyalty services\n    73→- Triggers customer campaigns and notifications (push, email, in-app)\n    74→- Anti-Corruption Layer for Braze marketing automation\n    75→- Tracks campaign delivery and customer engagement\n    76→\n    77→=== Integration Points\n    78→\n    79→[cols=\"1,2\"]\n    80→|===\n    81→| Integration | Description\n    82→\n    83→| Flybuys APIs\n    84→| OAuth linking, balance queries, batch file acknowledgements\n    85→\n    86→| EagleEye\n    87→| Transaction adjudication engine (determines point earnings)\n    88→\n    89→| Braze\n    90→| Marketing automation platform (via Engagement Service ACL)\n    91→\n    92→| D365 Commerce\n    93→| POS transaction data source\n    94→\n    95→| Azure Key Vault\n    96→| Secure OAuth token storage\n    97→\n    98→| Event Bus\n    99→| Domain events for service coordination\n   100→|===\n   101→\n   102→== Key Capabilities Delivered\n   103→\n   104→[cols=\"1,2,2\"]\n   105→|===\n   106→| Capability | How It Works | Business Value\n   107→\n   108→| *Secure Linking*\n   109→| OAuth 2.0 + PKCE flow (industry standard)\n   110→| Customer trust, compliance with Flybuys security requirements\n   111→\n   112→| *Dual Reward Options*\n   113→| Customer chooses Flybuys points OR OTR fuel discount per transaction\n   114→| Flexibility increases customer satisfaction\n   115→\n   116→| *POS Integration*\n   117→| Barcode scanning (5 credential types supported)\n   118→| Works with existing POS hardware, no customer friction\n   119→\n   120→| *Fast Credential Resolution*\n   121→| <500ms p95 response time\n   122→| No POS checkout delays\n   123→\n   124→| *Batch Points Posting*\n   125→| Nightly batch file to Flybuys (SFTP, PGP encrypted)\n   126→| Meets Flybuys integration standards\n   127→\n   128→| *Balance Visibility*\n   129→| Real-time balance queries with 5-minute cache\n   130→| Reduces Flybuys API costs, fast app response\n   131→\n   132→| *Automated Notifications*\n   133→| Event-driven campaigns via Engagement Service (push, email, in-app)\n   134→| Timely customer communication, improved engagement\n   135→|===\n   136→\n   137→== Customer Journey\n   138→\n   139→=== Mobile App (Account Linking)\n   140→\n   141→. Customer taps \"_Link Flybuys Account_\" in OTR app\n   142→. Redirects to Flybuys for secure login\n   143→. Customer authorises OTR to access their Flybuys account\n   144→. Returns to OTR app - account linked, reward preference set to Flybuys Points\n   145→. *Customer receives welcome notification*: \"_You're earning Flybuys points now!_\" (via Engagement Service)\n   146→\n   147→[mermaid]\n   148→----\n   149→sequenceDiagram\n   150→    actor Customer\n   151→    participant OTR as OTR Mobile App\n   152→    participant Flybuys as Flybuys Website\n   153→    participant Engagement as Engagement Service\n   154→\n   155→    Customer ->> OTR: Tap \"Link Flybuys Account\"\n   156→    OTR ->> Flybuys: Redirect for secure login\n   157→    Customer ->> Flybuys: Enter credentials & authorize OTR\n   158→    Flybuys -->> OTR: Authorization success + redirect\n   159→    OTR ->> OTR: Link Flybuys account\\nSet reward preference = Flybuys Points\n   160→    OTR ->> Engagement: Trigger welcome notification\n   161→    Engagement -->> Customer: \"You're earning Flybuys points now!\"\n   162→----\n   163→\n   164→=== Point-of-Sale (Earning Rewards)\n   165→\n   166→. *Customer* scans *Loyalty Credentials* at POS\n   167→. POS sends *Loyalty Credentials* to Loyalty Service for resolution\n   168→. *Loyalty Service* identifies customer and reward preference\n   169→. Transaction processed through *EagleEye* for *Transaction Adjudication*\n   170→. Points earned, stored locally, batch sent to Flybuys overnight\n   171→. *Customer receives transaction notification*: \"_You earned 150 Flybuys points!_\" (within seconds via Engagement Service)\n   172→. Customer sees points in Flybuys app within 24 hours\n   173→\n   174→[mermaid]\n   175→----\n   176→sequenceDiagram\n   177→    actor Customer\n   178→    participant POS as POS Terminal\n   179→    participant Loyalty as Loyalty Service\n   180→    participant EagleEye as EagleEye Adjudication\n   181→    participant Engagement as Engagement Service\n   182→    participant Flybuys as Flybuys Platform\n   183→\n   184→    Customer ->> POS: Scan Flybuys card / barcode\n   185→    POS ->> Loyalty: Send barcode for resolution\\n(<500ms)\n   186→    Loyalty -->> POS: Customer identified\\nReward preference = Flybuys\n   187→    POS ->> EagleEye: Submit transaction for adjudication\n   188→    EagleEye -->> Loyalty: Points earned\n   189→    Loyalty ->> Loyalty: Store points locally\n   190→    Loyalty ->> Flybuys: Batch points (overnight)\n   191→    Loyalty ->> Engagement: Trigger transaction notification\n   192→    Engagement -->> Customer: \"You earned 150 Flybuys points!\"\n   193→    Flybuys -->> Customer: Points visible in Flybuys app\\n(within 24 hours)\n   194→----\n   195→\n   196→== Implementation Phases\n   197→\n   198→Phased Rollout via Feature Flags\n   199→\n   200→[cols=\"1,2,1,2\"]\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"bf1421af-f8a6-4888-b34e-b2962b06a266","timestamp":"2026-01-09T04:33:05.219Z","toolUseResult":{"type":"text","file":{"filePath":"/mnt/c/Users/o.young/work/architecture/initiatives/flybuys_integration.adoc","content":"= OTR-002 Flybuys Integration\n:domain: Loyalty\n:domain-architect: O.Young@otr.com.au\n:project: OTR-002\n:doctype: article\n:toc: left\n:toclevels: 3\n:sectanchors:\n:sectlinks:\n:sectnums:\n:icons: font\n:source-highlighter: highlightjs\n:experimental:\n\n== What We're Building\n\nA new Loyalty system that allows all OTRG customers to\n\n[cols=\"1,2\"]\n|===\n| Feature | Description\n\n| Link their Flybuys account\n| via the OTR mobile app (OAuth secure linking)\n\n| Choose their reward preference\n| earn Flybuys points OR OTR fuel discounts at every transaction\n\n| Scan Flybuys cards at POS\n| physical cards, mobile app barcodes, or Apple/Google Wallet passes\n\n| Earn Flybuys points automatically\n| points post to Flybuys account within 24 hours\n\n| Check Flybuys balance\n| in OTR mobile app - real-time balance queries with caching\n|===\n\n== Architecture Approach\n\nNOTE: This and the xref:initiatives:salesforce_customer_support.adoc[Salesforce Customer Support] initiative are the first implementations of the overall Domain-Driven Design (DDD) architecture for OTR Group's digital platform. Depending on sequencing, some architectural elements may be delivered in either initiative.\n\nAt its core, this is a foundational architecture with the goal of creating a clear, shared structure for how our digital platforms represent Customers, Decisions, and Outcomes, and to distribute a common understanding of domain knowledge between business and technology.\n\nInstead of embedding business rules and assumptions across apps, POS flows, and third-party tools, it gives teams a common frame of reference, improves communication across product and technology, and makes complex customer journeys easier to reason about, change, and govern.\n\nImportantly, this structure is not specific to this single project, or even loyalty as a capability, it aims to provide a repeatable way to introduce all the capabilities presented in the road-map, from promotions or subscriptions to future partners, without re-wiring core customer and commerce flows each time.\n\nBy making domain knowledge explicit and stable, the architecture reduces long-term complexity, lowers delivery risk, and enables the digital and eCommerce ecosystem to evolve with confidence as business priorities shift.\n\n=== New \"Profile Service\"\n\nCustomer partner account management\n\n- Handles Flybuys account linking via OAuth\n- Stores customer reward preferences (Flybuys vs OTR)\n- Manages partner link status (linked/unlinked)\n\n=== New \"Loyalty Service\"\n\nTransaction processing and partner integration\n\n- Resolves loyalty credentials at POS (Flybuys cards → customer identity)\n- Processes transaction adjudication (calculates rewards)\n- Generates nightly batch files for Flybuys\n- Queries Flybuys balances (with Redis caching)\n\n=== New \"Engagement Service\"\n\nCustomer engagement and notifications\n\n- Consumes domain events from Profile and Loyalty services\n- Triggers customer campaigns and notifications (push, email, in-app)\n- Anti-Corruption Layer for Braze marketing automation\n- Tracks campaign delivery and customer engagement\n\n=== Integration Points\n\n[cols=\"1,2\"]\n|===\n| Integration | Description\n\n| Flybuys APIs\n| OAuth linking, balance queries, batch file acknowledgements\n\n| EagleEye\n| Transaction adjudication engine (determines point earnings)\n\n| Braze\n| Marketing automation platform (via Engagement Service ACL)\n\n| D365 Commerce\n| POS transaction data source\n\n| Azure Key Vault\n| Secure OAuth token storage\n\n| Event Bus\n| Domain events for service coordination\n|===\n\n== Key Capabilities Delivered\n\n[cols=\"1,2,2\"]\n|===\n| Capability | How It Works | Business Value\n\n| *Secure Linking*\n| OAuth 2.0 + PKCE flow (industry standard)\n| Customer trust, compliance with Flybuys security requirements\n\n| *Dual Reward Options*\n| Customer chooses Flybuys points OR OTR fuel discount per transaction\n| Flexibility increases customer satisfaction\n\n| *POS Integration*\n| Barcode scanning (5 credential types supported)\n| Works with existing POS hardware, no customer friction\n\n| *Fast Credential Resolution*\n| <500ms p95 response time\n| No POS checkout delays\n\n| *Batch Points Posting*\n| Nightly batch file to Flybuys (SFTP, PGP encrypted)\n| Meets Flybuys integration standards\n\n| *Balance Visibility*\n| Real-time balance queries with 5-minute cache\n| Reduces Flybuys API costs, fast app response\n\n| *Automated Notifications*\n| Event-driven campaigns via Engagement Service (push, email, in-app)\n| Timely customer communication, improved engagement\n|===\n\n== Customer Journey\n\n=== Mobile App (Account Linking)\n\n. Customer taps \"_Link Flybuys Account_\" in OTR app\n. Redirects to Flybuys for secure login\n. Customer authorises OTR to access their Flybuys account\n. Returns to OTR app - account linked, reward preference set to Flybuys Points\n. *Customer receives welcome notification*: \"_You're earning Flybuys points now!_\" (via Engagement Service)\n\n[mermaid]\n----\nsequenceDiagram\n    actor Customer\n    participant OTR as OTR Mobile App\n    participant Flybuys as Flybuys Website\n    participant Engagement as Engagement Service\n\n    Customer ->> OTR: Tap \"Link Flybuys Account\"\n    OTR ->> Flybuys: Redirect for secure login\n    Customer ->> Flybuys: Enter credentials & authorize OTR\n    Flybuys -->> OTR: Authorization success + redirect\n    OTR ->> OTR: Link Flybuys account\\nSet reward preference = Flybuys Points\n    OTR ->> Engagement: Trigger welcome notification\n    Engagement -->> Customer: \"You're earning Flybuys points now!\"\n----\n\n=== Point-of-Sale (Earning Rewards)\n\n. *Customer* scans *Loyalty Credentials* at POS\n. POS sends *Loyalty Credentials* to Loyalty Service for resolution\n. *Loyalty Service* identifies customer and reward preference\n. Transaction processed through *EagleEye* for *Transaction Adjudication*\n. Points earned, stored locally, batch sent to Flybuys overnight\n. *Customer receives transaction notification*: \"_You earned 150 Flybuys points!_\" (within seconds via Engagement Service)\n. Customer sees points in Flybuys app within 24 hours\n\n[mermaid]\n----\nsequenceDiagram\n    actor Customer\n    participant POS as POS Terminal\n    participant Loyalty as Loyalty Service\n    participant EagleEye as EagleEye Adjudication\n    participant Engagement as Engagement Service\n    participant Flybuys as Flybuys Platform\n\n    Customer ->> POS: Scan Flybuys card / barcode\n    POS ->> Loyalty: Send barcode for resolution\\n(<500ms)\n    Loyalty -->> POS: Customer identified\\nReward preference = Flybuys\n    POS ->> EagleEye: Submit transaction for adjudication\n    EagleEye -->> Loyalty: Points earned\n    Loyalty ->> Loyalty: Store points locally\n    Loyalty ->> Flybuys: Batch points (overnight)\n    Loyalty ->> Engagement: Trigger transaction notification\n    Engagement -->> Customer: \"You earned 150 Flybuys points!\"\n    Flybuys -->> Customer: Points visible in Flybuys app\\n(within 24 hours)\n----\n\n== Implementation Phases\n\nPhased Rollout via Feature Flags\n\n[cols=\"1,2,1,2\"]","numLines":200,"startLine":1,"totalLines":365}},"sourceToolAssistantUUID":"d8c64f17-5849-4439-b1dc-74944abee7cc"}
{"parentUuid":"291567ad-43dd-4df1-8693-0d22040b1746","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01MuMH6Vos7Ge617Dxfos82n","type":"tool_result","content":"     1→= OTR-001 Salesforce Customer Support\n     2→:domain: Customer Support & Engagement\n     3→:domain-architect: O.Young@otr.com.au\n     4→:project: OTR-001\n     5→:doctype: article\n     6→:toc: left\n     7→:toclevels: 3\n     8→:sectanchors:\n     9→:sectlinks:\n    10→:sectnums:\n    11→:icons: font\n    12→:source-highlighter: highlightjs\n    13→:experimental:\n    14→\n    15→== What We're Building\n    16→\n    17→A unified customer support platform that consolidates OTR digital customer feedback onto xref:bounded-contexts:salesforce_service_cloud.adoc[Salesforce Service Cloud] and establishes a foundational Domain-Driven Design architecture with xref:bounded-contexts:profile.adoc[Profile Service] and xref:bounded-contexts:engagement.adoc[Engagement Service] bounded contexts.\n    18→\n    19→[cols=\"1,2\"]\n    20→|===\n    21→| Feature | Description\n    22→\n    23→| Submit feedback from Mobile App\n    24→| Customers continue to submit support requests with structured categories (App, Service, Order, Rewards, Refund, Delete Account)\n    25→\n    26→| Immediate feedback confirmation\n    27→| Non-blocking user experience with *instant acknowledgement*\n    28→\n    29→| Automated Case creation\n    30→| Asynchronous Case creation in xref:bounded-contexts:salesforce_service_cloud.adoc[Salesforce Service Cloud] with retry logic and dead letter queue\n    31→\n    32→| Push notification updates\n    33→| Customers receive notifications via xref:bounded-contexts:braze.adoc[Braze] when support agents update or resolve their Cases\n    34→\n    35→| Unified agent view\n    36→| Support agents see all customer interactions across digital, fuel wholesale, Shell Card, and other Viva Energy channels\n    37→\n    38→| Just-In-Time Contact reconciliation\n    39→| Mobile App users automatically reconciled as Salesforce Contacts (upsert by email)\n    40→|===\n    41→\n    42→== Architecture Approach\n    43→\n    44→NOTE: This and the xref:initiatives:flybuys_integration.adoc[Flybuys Integration] initiative are the first implementations of the overall Domain-Driven Design (DDD) architecture for OTR Group's digital platform. Depending on sequencing, some architectural elements may be delivered in either initiative.\n    45→\n    46→This is the **first implementation of OTR's target Domain-Driven Design (DDD) architecture**, establishing two new bounded contexts (xref:bounded-contexts:profile.adoc[Profile Service], xref:bounded-contexts:engagement.adoc[Engagement Service]) and event-driven integration patterns that let serve as the foundation for future bounded contexts including Flybuys integration.\n    47→\n    48→At its core, this architecture creates a clear separation of concerns: xref:bounded-contexts:profile.adoc[Profile Service] owns customer identity reconciliation with Salesforce, while xref:bounded-contexts:engagement.adoc[Engagement Service] acts as an Anti-Corruption Layer protecting digital channels from external system changes.\n    49→\n    50→By implementing these patterns now, OTR establishes a repeatable approach for future bounded contexts (xref:bounded-contexts:loyalty.adoc[Loyalty Service], xref:bounded-contexts:location.adoc[Location Service], xref:bounded-contexts:payment.adoc[Payment Service]), reducing delivery risk and enabling the platform to evolve confidently and with agility as business priorities shift.\n    51→\n    52→=== New xref:bounded-contexts:profile.adoc[Profile Service]\n    53→\n    54→Customer identity and Contact reconciliation\n    55→\n    56→- Just-In-Time Contact reconciliation with Salesforce (upsert by email)\n    57→- Returns Salesforce Contact ID to Mobile App\n    58→- Foundation for Flybuys partner linking (reused in future integration)\n    59→- Stateless service (Salesforce is System of Record)\n    60→\n    61→=== New xref:bounded-contexts:engagement.adoc[Engagement Service]\n    62→\n    63→Customer feedback and support coordination\n    64→\n    65→- Customer feedback submission facade (Backend-for-Frontend pattern)\n    66→- Anti-Corruption Layer for xref:bounded-contexts:salesforce_service_cloud.adoc[Salesforce Service Cloud] Case creation\n    67→- Asynchronous Case creation via Event Bus (non-blocking user experience)\n    68→- xref:bounded-contexts:braze.adoc[Braze] integration for all outbound customer communications (push, email, SMS)\n    69→- Webhook receiver for Salesforce Case updates\n    70→\n    71→=== New \"Event Bus\"\n    72→\n    73→Event-driven integration infrastructure\n    74→\n    75→- Domain event publishing using AWS infrastructure (SNS+SQS/EventBridge/Kinesis)\n    76→- Asynchronous Case creation with retry logic and exponential backoff\n    77→- Dead letter queue for operations team intervention\n    78→- Foundation pattern for future bounded context integration\n    79→\n    80→=== Integration Points\n    81→\n    82→[cols=\"1,2\"]\n    83→|===\n    84→| Integration | Description\n    85→\n    86→| xref:bounded-contexts:salesforce_service_cloud.adoc[Salesforce Service Cloud]\n    87→| System of Record for Contact and Case data (shared Viva Energy instance)\n    88→\n    89→| xref:bounded-contexts:braze.adoc[Braze]\n    90→| Customer communication platform for all outbound notifications (push, email, SMS) triggered by Salesforce Case updates (via Engagement Service ACL)\n    91→\n    92→| xref:bounded-contexts:microsoft_entra_external_id.adoc[Microsoft Entra External ID]\n    93→| Customer authentication (existing CIAM service)\n    94→\n    95→| Event Bus\n    96→| Domain events for service coordination (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`)\n    97→\n    98→| D365 Customer Engagement\n    99→| Legacy platform (retired within 90 days post-cutover)\n   100→\n   101→| App-Specific Customer Database\n   102→| Legacy Contact storage (one-time migration to Salesforce, then deprecated)\n   103→|===\n   104→\n   105→== Key Capabilities Delivered\n   106→\n   107→[cols=\"1,2,2\"]\n   108→|===\n   109→| Capability | How It Works | Business Value\n   110→\n   111→| *Unified Customer View*\n   112→| xref:bounded-contexts:salesforce_service_cloud.adoc[Salesforce Service Cloud] consolidates support data across all Viva Energy channels\n   113→| Support agents have complete interaction history (digital, wholesale, Shell Card, retail)\n   114→\n   115→| *Non-Blocking Feedback Submission*\n   116→| Async Case creation via Event Bus with immediate user acknowledgement\n   117→| Faster user experience, resilient to Salesforce downtime\n   118→\n   119→| *Automated Notifications*\n   120→| xref:bounded-contexts:salesforce_service_cloud.adoc[Salesforce Service Cloud] webhook → xref:bounded-contexts:engagement.adoc[Engagement Service] → xref:bounded-contexts:braze.adoc[Braze] push notifications\n   121→| Customers informed of Case status without manual agent follow-up\n   122→\n   123→| *Just-In-Time Reconciliation*\n   124→| xref:bounded-contexts:profile.adoc[Profile Service] upserts Contacts by email on-demand\n   125→| No pre-sync required, Salesforce always has current Contact data\n   126→\n   127→| *Anti-Corruption Layer*\n   128→| xref:bounded-contexts:engagement.adoc[Engagement Service] translates between OTR domain and Salesforce API\n   129→| Digital channels protected from Salesforce API changes\n   130→\n   131→| *Automatic Retry Logic*\n   132→| Exponential backoff with dead letter queue\n   133→| Handles transient failures without manual intervention\n   134→\n   135→| *DDD Foundation*\n   136→| First bounded contexts (xref:bounded-contexts:profile.adoc[Profile Service], xref:bounded-contexts:engagement.adoc[Engagement Service])\n   137→| Establishes architecture pattern for future services (Flybuys, Loyalty, Location)\n   138→|===\n   139→\n   140→== Customer Journey\n   141→\n   142→=== Mobile App (Feedback Submission)\n   143→\n   144→. Customer taps \"_Get In Touch_\" --> \"_Contact Us_\" in xref:bounded-contexts:otr_app.adoc[OTR app]\n   145→. Selects feedback category (App, Service, Order, Rewards, Refund, Delete Account)\n   146→. Provides optional details: Store Name, Time of Visit, Phone Number, Free Text Message\n   147→. Taps \"_Submit Feedback_\"\n   148→. *Immediate confirmation*: \"_Thank you, we've received your feedback_\"\n   149→. xref:bounded-contexts:profile.adoc[Profile Service] reconciles customer as Salesforce Contact (JIT upsert by email)\n   150→. xref:bounded-contexts:engagement.adoc[Engagement Service] publishes feedback submission to Event Bus\n   151→. Background worker creates Case in xref:bounded-contexts:salesforce_service_cloud.adoc[Salesforce Service Cloud] asynchronously\n   152→. *Customer receives notification*: \"_Your support request has been created (Case #12345)_\" (within 5 minutes)\n   153→\n   154→[mermaid]\n   155→----\n   156→sequenceDiagram\n   157→    actor Customer\n   158→    participant Mobile as Mobile App\n   159→    participant Profile as Profile Service\n   160→    participant Engagement as Engagement Service\n   161→    participant EventBus as Event Bus\n   162→    participant Salesforce as Salesforce\n   163→    participant Braze as Braze\n   164→\n   165→    Customer ->> Mobile: Tap \"Contact Support\" & submit feedback\n   166→    Mobile ->> Profile: Reconcile Contact (JIT upsert by email)\n   167→    Profile ->> Salesforce: Query/Create Contact\n   168→    Salesforce -->> Profile: Contact ID\n   169→    Profile -->> Mobile: Contact ID\n   170→    Mobile ->> Engagement: Submit feedback (with Contact ID)\n   171→    Engagement -->> Mobile: Immediate acknowledgement\\n\"Feedback submitted\"\n   172→    Mobile -->> Customer: \"Thank you, we've received your feedback\"\n   173→    Engagement ->> EventBus: Publish CustomerFeedbackSubmitted event\n   174→    EventBus ->> Engagement: Async Case creation worker\n   175→    Engagement ->> Salesforce: Create Case\n   176→    Salesforce -->> Engagement: Case ID\n   177→    Engagement ->> Braze: Trigger push notification\\n\"Your support request #12345 has been created\"\n   178→    Braze -->> Customer: Push notification received\\n(within 5 minutes)\n   179→----\n   180→\n   181→=== Support Agent (Case Resolution)\n   182→\n   183→. Support agent logs into xref:bounded-contexts:salesforce_service_cloud.adoc[Salesforce Service Cloud]\n   184→. Views Case assigned to their queue (sees complete customer interaction history)\n   185→. Updates Case status, adds internal notes, contacts customer if needed\n   186→. Resolves Case and adds resolution notes\n   187→. Salesforce webhook notifies Engagement Service of Case update\n   188→. *Customer receives push notification*: \"_Your support request #12345 has been resolved_\"\n   189→. Customer can view resolution in Mobile App (future enhancement)\n   190→\n   191→[mermaid]\n   192→----\n   193→sequenceDiagram\n   194→    actor Agent as Support Agent\n   195→    participant Salesforce as Salesforce\n   196→    participant Engagement as Engagement Service\n   197→    participant Braze as Braze\n   198→    actor Customer\n   199→\n   200→    Agent ->> Salesforce: View assigned Case\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"57f647f9-0c5f-4b22-ad8f-d059ea0954e3","timestamp":"2026-01-09T04:33:05.220Z","toolUseResult":{"type":"text","file":{"filePath":"/mnt/c/Users/o.young/work/architecture/initiatives/salesforce_customer_support.adoc","content":"= OTR-001 Salesforce Customer Support\n:domain: Customer Support & Engagement\n:domain-architect: O.Young@otr.com.au\n:project: OTR-001\n:doctype: article\n:toc: left\n:toclevels: 3\n:sectanchors:\n:sectlinks:\n:sectnums:\n:icons: font\n:source-highlighter: highlightjs\n:experimental:\n\n== What We're Building\n\nA unified customer support platform that consolidates OTR digital customer feedback onto xref:bounded-contexts:salesforce_service_cloud.adoc[Salesforce Service Cloud] and establishes a foundational Domain-Driven Design architecture with xref:bounded-contexts:profile.adoc[Profile Service] and xref:bounded-contexts:engagement.adoc[Engagement Service] bounded contexts.\n\n[cols=\"1,2\"]\n|===\n| Feature | Description\n\n| Submit feedback from Mobile App\n| Customers continue to submit support requests with structured categories (App, Service, Order, Rewards, Refund, Delete Account)\n\n| Immediate feedback confirmation\n| Non-blocking user experience with *instant acknowledgement*\n\n| Automated Case creation\n| Asynchronous Case creation in xref:bounded-contexts:salesforce_service_cloud.adoc[Salesforce Service Cloud] with retry logic and dead letter queue\n\n| Push notification updates\n| Customers receive notifications via xref:bounded-contexts:braze.adoc[Braze] when support agents update or resolve their Cases\n\n| Unified agent view\n| Support agents see all customer interactions across digital, fuel wholesale, Shell Card, and other Viva Energy channels\n\n| Just-In-Time Contact reconciliation\n| Mobile App users automatically reconciled as Salesforce Contacts (upsert by email)\n|===\n\n== Architecture Approach\n\nNOTE: This and the xref:initiatives:flybuys_integration.adoc[Flybuys Integration] initiative are the first implementations of the overall Domain-Driven Design (DDD) architecture for OTR Group's digital platform. Depending on sequencing, some architectural elements may be delivered in either initiative.\n\nThis is the **first implementation of OTR's target Domain-Driven Design (DDD) architecture**, establishing two new bounded contexts (xref:bounded-contexts:profile.adoc[Profile Service], xref:bounded-contexts:engagement.adoc[Engagement Service]) and event-driven integration patterns that let serve as the foundation for future bounded contexts including Flybuys integration.\n\nAt its core, this architecture creates a clear separation of concerns: xref:bounded-contexts:profile.adoc[Profile Service] owns customer identity reconciliation with Salesforce, while xref:bounded-contexts:engagement.adoc[Engagement Service] acts as an Anti-Corruption Layer protecting digital channels from external system changes.\n\nBy implementing these patterns now, OTR establishes a repeatable approach for future bounded contexts (xref:bounded-contexts:loyalty.adoc[Loyalty Service], xref:bounded-contexts:location.adoc[Location Service], xref:bounded-contexts:payment.adoc[Payment Service]), reducing delivery risk and enabling the platform to evolve confidently and with agility as business priorities shift.\n\n=== New xref:bounded-contexts:profile.adoc[Profile Service]\n\nCustomer identity and Contact reconciliation\n\n- Just-In-Time Contact reconciliation with Salesforce (upsert by email)\n- Returns Salesforce Contact ID to Mobile App\n- Foundation for Flybuys partner linking (reused in future integration)\n- Stateless service (Salesforce is System of Record)\n\n=== New xref:bounded-contexts:engagement.adoc[Engagement Service]\n\nCustomer feedback and support coordination\n\n- Customer feedback submission facade (Backend-for-Frontend pattern)\n- Anti-Corruption Layer for xref:bounded-contexts:salesforce_service_cloud.adoc[Salesforce Service Cloud] Case creation\n- Asynchronous Case creation via Event Bus (non-blocking user experience)\n- xref:bounded-contexts:braze.adoc[Braze] integration for all outbound customer communications (push, email, SMS)\n- Webhook receiver for Salesforce Case updates\n\n=== New \"Event Bus\"\n\nEvent-driven integration infrastructure\n\n- Domain event publishing using AWS infrastructure (SNS+SQS/EventBridge/Kinesis)\n- Asynchronous Case creation with retry logic and exponential backoff\n- Dead letter queue for operations team intervention\n- Foundation pattern for future bounded context integration\n\n=== Integration Points\n\n[cols=\"1,2\"]\n|===\n| Integration | Description\n\n| xref:bounded-contexts:salesforce_service_cloud.adoc[Salesforce Service Cloud]\n| System of Record for Contact and Case data (shared Viva Energy instance)\n\n| xref:bounded-contexts:braze.adoc[Braze]\n| Customer communication platform for all outbound notifications (push, email, SMS) triggered by Salesforce Case updates (via Engagement Service ACL)\n\n| xref:bounded-contexts:microsoft_entra_external_id.adoc[Microsoft Entra External ID]\n| Customer authentication (existing CIAM service)\n\n| Event Bus\n| Domain events for service coordination (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`)\n\n| D365 Customer Engagement\n| Legacy platform (retired within 90 days post-cutover)\n\n| App-Specific Customer Database\n| Legacy Contact storage (one-time migration to Salesforce, then deprecated)\n|===\n\n== Key Capabilities Delivered\n\n[cols=\"1,2,2\"]\n|===\n| Capability | How It Works | Business Value\n\n| *Unified Customer View*\n| xref:bounded-contexts:salesforce_service_cloud.adoc[Salesforce Service Cloud] consolidates support data across all Viva Energy channels\n| Support agents have complete interaction history (digital, wholesale, Shell Card, retail)\n\n| *Non-Blocking Feedback Submission*\n| Async Case creation via Event Bus with immediate user acknowledgement\n| Faster user experience, resilient to Salesforce downtime\n\n| *Automated Notifications*\n| xref:bounded-contexts:salesforce_service_cloud.adoc[Salesforce Service Cloud] webhook → xref:bounded-contexts:engagement.adoc[Engagement Service] → xref:bounded-contexts:braze.adoc[Braze] push notifications\n| Customers informed of Case status without manual agent follow-up\n\n| *Just-In-Time Reconciliation*\n| xref:bounded-contexts:profile.adoc[Profile Service] upserts Contacts by email on-demand\n| No pre-sync required, Salesforce always has current Contact data\n\n| *Anti-Corruption Layer*\n| xref:bounded-contexts:engagement.adoc[Engagement Service] translates between OTR domain and Salesforce API\n| Digital channels protected from Salesforce API changes\n\n| *Automatic Retry Logic*\n| Exponential backoff with dead letter queue\n| Handles transient failures without manual intervention\n\n| *DDD Foundation*\n| First bounded contexts (xref:bounded-contexts:profile.adoc[Profile Service], xref:bounded-contexts:engagement.adoc[Engagement Service])\n| Establishes architecture pattern for future services (Flybuys, Loyalty, Location)\n|===\n\n== Customer Journey\n\n=== Mobile App (Feedback Submission)\n\n. Customer taps \"_Get In Touch_\" --> \"_Contact Us_\" in xref:bounded-contexts:otr_app.adoc[OTR app]\n. Selects feedback category (App, Service, Order, Rewards, Refund, Delete Account)\n. Provides optional details: Store Name, Time of Visit, Phone Number, Free Text Message\n. Taps \"_Submit Feedback_\"\n. *Immediate confirmation*: \"_Thank you, we've received your feedback_\"\n. xref:bounded-contexts:profile.adoc[Profile Service] reconciles customer as Salesforce Contact (JIT upsert by email)\n. xref:bounded-contexts:engagement.adoc[Engagement Service] publishes feedback submission to Event Bus\n. Background worker creates Case in xref:bounded-contexts:salesforce_service_cloud.adoc[Salesforce Service Cloud] asynchronously\n. *Customer receives notification*: \"_Your support request has been created (Case #12345)_\" (within 5 minutes)\n\n[mermaid]\n----\nsequenceDiagram\n    actor Customer\n    participant Mobile as Mobile App\n    participant Profile as Profile Service\n    participant Engagement as Engagement Service\n    participant EventBus as Event Bus\n    participant Salesforce as Salesforce\n    participant Braze as Braze\n\n    Customer ->> Mobile: Tap \"Contact Support\" & submit feedback\n    Mobile ->> Profile: Reconcile Contact (JIT upsert by email)\n    Profile ->> Salesforce: Query/Create Contact\n    Salesforce -->> Profile: Contact ID\n    Profile -->> Mobile: Contact ID\n    Mobile ->> Engagement: Submit feedback (with Contact ID)\n    Engagement -->> Mobile: Immediate acknowledgement\\n\"Feedback submitted\"\n    Mobile -->> Customer: \"Thank you, we've received your feedback\"\n    Engagement ->> EventBus: Publish CustomerFeedbackSubmitted event\n    EventBus ->> Engagement: Async Case creation worker\n    Engagement ->> Salesforce: Create Case\n    Salesforce -->> Engagement: Case ID\n    Engagement ->> Braze: Trigger push notification\\n\"Your support request #12345 has been created\"\n    Braze -->> Customer: Push notification received\\n(within 5 minutes)\n----\n\n=== Support Agent (Case Resolution)\n\n. Support agent logs into xref:bounded-contexts:salesforce_service_cloud.adoc[Salesforce Service Cloud]\n. Views Case assigned to their queue (sees complete customer interaction history)\n. Updates Case status, adds internal notes, contacts customer if needed\n. Resolves Case and adds resolution notes\n. Salesforce webhook notifies Engagement Service of Case update\n. *Customer receives push notification*: \"_Your support request #12345 has been resolved_\"\n. Customer can view resolution in Mobile App (future enhancement)\n\n[mermaid]\n----\nsequenceDiagram\n    actor Agent as Support Agent\n    participant Salesforce as Salesforce\n    participant Engagement as Engagement Service\n    participant Braze as Braze\n    actor Customer\n\n    Agent ->> Salesforce: View assigned Case","numLines":200,"startLine":1,"totalLines":392}},"sourceToolAssistantUUID":"291567ad-43dd-4df1-8693-0d22040b1746"}
{"parentUuid":"57f647f9-0c5f-4b22-ad8f-d059ea0954e3","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01DMxeMb8eFZtSvzx1SxT3fp","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now I understand what needs to be done. I need to update the ProfileService documentation to reflect both initiatives:\n\n1. **Salesforce Customer Support (OTR-001)**: ProfileService provides Just-In-Time Contact reconciliation with Salesforce\n2. **Flybuys Integration (OTR-002)**: ProfileService handles partner account linking (Flybuys) and reward preference management\n\nThe CML file already has the right structure with:\n- CustomerProfile aggregate\n- PartnerLink aggregate (for Flybuys linking)\n- Events for partner linking\n\nThe markdown file needs to be updated to:\n1. Reference both initiatives\n2. Explain how ProfileService supports both use cases\n3. Update the architecture decision log to reflect both initiatives\n4. Add cross-references to the initiative documents\n\nLet me update the profile.adoc file to add this context.","signature":"Et4HCkYICxgCKkDKZPJWYQD01aJEBr1vVB93GuYfFzrNiKefkesmyPXfQjqBmrku8xTEXqtCQohSwb5cEtwohuWsOMtqe7wH0fOUEgzsGHOw40qDqbjI49oaDGbFRYUvcjYXgb0QfiIwUYyzdK9+df2sKXEsNH86M3CDW9lxWCCygAWUfDPFIRUoM1c9gnr+YsNKRbg95iKEKsUGE3pcbtoS/2Ky7PyT1UDr1oaHPMQ8BrreOpJfuaY/n/uMDMBBEWOqg2Xl7q+7nPGWkfVOVrc9LBeSswyerBLnZqCD6JIqTxFaR20TEhvvgCdPEWnXJ3i7kkyqrPibe6nTFuWAIB3Tmlj45lovfg9ObhmeRricApJU28WdtI6hGQCZ+g8zwlCy4eEEITABem+Yj7P3MdNTjljI17oat8nS17HguW++Qu71D3w3DD8NzEDS9eiBSc/qXENsNi+aUCF8Mcp6Y6RfFfZN2iftXuc3JymjlR9Ghax1HlT85r9suSwevj0oV9KWneAkN7CBhfieVq4zmw1tlgSJ0u4wQGVeQWS8TR9aa8qIoFW/wLn/JnQVqEh6XTrFwnu+GoG32cVROmSwmGvlovBVP7bLKe1+c5inqvcxcJ/Y2OVmDMebW6HdWbhCDMwz5gsqLqJUyLEj6Y/y16xAlZEMGkWkUUXj/rlC1gGxqWebboUvT3HDhqweD4ecBGZVAXTvNz/dlE7NkAX/b9QR6XepBJInX080guFCGulDqkCLWqi2UIMkzNGcVc8UKJclSXfk89TjzGxbrWoN2aH32xaDkglbLgAW5s3vwYKku92E7PpOKeqZm5QD7D/6bAGqvYOzukH7xoU5aC8ffgKiTqQiDkb7bsEkHR7uztef1KrbfGjb4GrS2kh4OJy2ijkMxr7B3fS9nqYxDvaAWanIGHGdrsUJsA6QRKpllEwc/q6lmjXbDLwucHD4N2DSJkYLA2BWcAk9zytQOsXSKOIuLzJrGYxlyxreYLDN+7URYWmjSlBiN0cX0qUSeGfE6Vo13NSosBAibUKhwJLUOFHagKniW/CYo9GE8pPeq2Faz1BvZABK4ytjRmqRtMGgqAc7WowYneLEF8aO54EerZDSbxRFwCXJDFZ26PEztWdEf+kcQfPIueKtAcSlNBJlmvlMs8444P2TKPPfpTRvds78JP6Y1q1KBEZSVJ7TqmHyD/cJlsUgqlMnJSpGg23V3CTSWey9y+qsdp8pvsz9q3YWMqJ0D3fpArHWTdgM5E/SpL+51IchuelrQFa0QJYW+aD8h4rghx91jFx25OknEdZYIizeXA8JIEP8HKk4JOjgGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":14,"cache_creation_input_tokens":6049,"cache_read_input_tokens":73672,"cache_creation":{"ephemeral_5m_input_tokens":6049,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWwBMKWYoCqJrwQBoMYcs","type":"assistant","uuid":"1ee689e6-b7aa-4324-ab63-2aaa5f1badec","timestamp":"2026-01-09T04:33:13.668Z"}
{"parentUuid":"1ee689e6-b7aa-4324-ab63-2aaa5f1badec","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01DMxeMb8eFZtSvzx1SxT3fp","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01EVdkaQvYVaNGRU3HtSbLJk","name":"TodoWrite","input":{"todos":[{"content":"Add initiative context to ProfileService documentation header","activeForm":"Adding initiative context to header","status":"in_progress"},{"content":"Update profile.adoc to reference both OTR-001 and OTR-002 initiatives","activeForm":"Updating initiative references","status":"pending"},{"content":"Add architecture decision about dual initiative support","activeForm":"Adding dual initiative decision","status":"pending"},{"content":"Update CML file header to reference initiatives","activeForm":"Updating CML header","status":"pending"},{"content":"Ensure consistency between CML and markdown files","activeForm":"Ensuring CML/markdown consistency","status":"pending"}]}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":14,"cache_creation_input_tokens":6049,"cache_read_input_tokens":73672,"cache_creation":{"ephemeral_5m_input_tokens":6049,"ephemeral_1h_input_tokens":0},"output_tokens":429,"service_tier":"standard"}},"requestId":"req_011CWwBMKWYoCqJrwQBoMYcs","type":"assistant","uuid":"8b44ffb8-4201-4810-992e-e9fc0c3d914c","timestamp":"2026-01-09T04:33:16.989Z"}
{"parentUuid":"8b44ffb8-4201-4810-992e-e9fc0c3d914c","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01EVdkaQvYVaNGRU3HtSbLJk","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"uuid":"480b156f-61be-4803-890e-0870a6a7a0d9","timestamp":"2026-01-09T04:33:17.065Z","toolUseResult":{"oldTodos":[],"newTodos":[{"content":"Add initiative context to ProfileService documentation header","status":"in_progress","activeForm":"Adding initiative context to header"},{"content":"Update profile.adoc to reference both OTR-001 and OTR-002 initiatives","status":"pending","activeForm":"Updating initiative references"},{"content":"Add architecture decision about dual initiative support","status":"pending","activeForm":"Adding dual initiative decision"},{"content":"Update CML file header to reference initiatives","status":"pending","activeForm":"Updating CML header"},{"content":"Ensure consistency between CML and markdown files","status":"pending","activeForm":"Ensuring CML/markdown consistency"}]},"sourceToolAssistantUUID":"8b44ffb8-4201-4810-992e-e9fc0c3d914c"}
{"parentUuid":"480b156f-61be-4803-890e-0870a6a7a0d9","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01SDzKr64Q6bPz4J5h25hurC","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Let me start by updating the profile.adoc file to add initiative context. I'll add a new section near the top explaining how ProfileService supports both initiatives.","signature":"Es8CCkYICxgCKkCbuz7pEZrEg+YnZcO/RskyFsE2rH38liYUgjLxa+ZlK1jbuoJckDfQP34l9wenbFIByN9Jj7O/hJ2BK1lb6fSIEgw6kvvqG0/9dLKGb9gaDPqCn5/SYfYtHGJAYyIw/kvd2nRnM6mGWESzAEKVJmMhMHk/wk7N85KBl8Lxtem8cuVn6KjZZjiZJGZ4CckaKrYB9uNj5kd5wXV7qiFYV5Y72s09wfvMnc6DbbmawGVR7rlemzL+1xWTdVoe946eTQmDGkH/EZq5Ey/uSLfK8oBWjISoG0bbJnTM4JAysWZ2tUrpxZxiX/ipzMPvZ7Uv5ZIp6KBmrhBarXmb9Uxz8we2BhrN75ZtBcBE2s3jcZ8vZOF3AF2xM8pnA7NaO8c9vQhxdXDkiyc8lqhtmZzdpPiGaN6yHR8RD2K7PITB3C3k9AK0IcDWxocYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":470,"cache_read_input_tokens":79721,"cache_creation":{"ephemeral_5m_input_tokens":470,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWwBNC3cToj5h9P1QQfLK","type":"assistant","uuid":"1f6f1a8c-be9a-4ca1-8b4c-b175e024e604","timestamp":"2026-01-09T04:33:21.278Z"}
{"parentUuid":"1f6f1a8c-be9a-4ca1-8b4c-b175e024e604","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01SDzKr64Q6bPz4J5h25hurC","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_016TVSCPtDBixpZx6AayejeD","name":"Edit","input":{"replace_all":false,"file_path":"/mnt/c/Users/o.young/work/architecture/bounded_context/profile.adoc","old_string":"== ProfileService\n\nUnified customer profile service providing enriched customer data for\nOTRG ecosystem.\n\n=== Domain Vision Statement","new_string":"== ProfileService\n\nUnified customer profile service providing enriched customer data for\nOTRG ecosystem.\n\n=== Related Initiatives\n\nProfileService is a foundational bounded context supporting multiple strategic initiatives:\n\n* **xref:initiatives:salesforce_customer_support.adoc[OTR-001 Salesforce Customer Support]**: Provides Just-In-Time Contact reconciliation with Salesforce Service Cloud\n* **xref:initiatives:flybuys_integration.adoc[OTR-002 Flybuys Integration]**: Manages customer partner account linking (Flybuys, Shell) and reward preference tracking\n\nNOTE: These initiatives are the first implementations of OTR's Domain-Driven Design (DDD) architecture. Depending on sequencing, ProfileService capabilities may be delivered incrementally across either initiative.\n\n=== Domain Vision Statement"}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":470,"cache_read_input_tokens":79721,"cache_creation":{"ephemeral_5m_input_tokens":470,"ephemeral_1h_input_tokens":0},"output_tokens":367,"service_tier":"standard"}},"requestId":"req_011CWwBNC3cToj5h9P1QQfLK","type":"assistant","uuid":"3fcfe7b4-0299-4c83-b15d-750344c0f0e1","timestamp":"2026-01-09T04:33:26.735Z"}
{"type":"file-history-snapshot","messageId":"3fcfe7b4-0299-4c83-b15d-750344c0f0e1","snapshot":{"messageId":"11c8d3b8-b207-4c56-b1d0-c8c534dd4233","trackedFileBackups":{"solution_architectures/salesforce_customer_support.adoc":{"backupFileName":"ef19bf3282a777f7@v2","version":2,"backupTime":"2026-01-09T03:13:31.966Z"},"bounded_context/profile.adoc":{"backupFileName":"5794d0bd8cc1c5d2@v1","version":1,"backupTime":"2026-01-09T04:33:27.418Z"}},"timestamp":"2026-01-09T04:32:33.163Z"},"isSnapshotUpdate":true}
{"parentUuid":"3fcfe7b4-0299-4c83-b15d-750344c0f0e1","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_016TVSCPtDBixpZx6AayejeD","type":"tool_result","content":"The file /mnt/c/Users/o.young/work/architecture/bounded_context/profile.adoc has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n    20→:experimental:\n    21→:description: Bounded Context for the Profile Domain\n    22→:keywords: profile, customer, bounded context, togaf, ddd\n    23→\n    24→== ProfileService\n    25→\n    26→Unified customer profile service providing enriched customer data for\n    27→OTRG ecosystem.\n    28→\n    29→=== Related Initiatives\n    30→\n    31→ProfileService is a foundational bounded context supporting multiple strategic initiatives:\n    32→\n    33→* **xref:initiatives:salesforce_customer_support.adoc[OTR-001 Salesforce Customer Support]**: Provides Just-In-Time Contact reconciliation with Salesforce Service Cloud\n    34→* **xref:initiatives:flybuys_integration.adoc[OTR-002 Flybuys Integration]**: Manages customer partner account linking (Flybuys, Shell) and reward preference tracking\n    35→\n    36→NOTE: These initiatives are the first implementations of OTR's Domain-Driven Design (DDD) architecture. Depending on sequencing, ProfileService capabilities may be delivered incrementally across either initiative.\n    37→\n    38→=== Domain Vision Statement\n    39→\n    40→Provide unified, enriched customer profiles bridging\n    41→link:external/salesforce_crm.adoc[Salesforce] canonical\n    42→data with OTRG-specific attributes, behavioral insights, and risk"}]},"uuid":"e93af460-c17e-4ffd-b791-1725e2f951a9","timestamp":"2026-01-09T04:33:27.363Z","toolUseResult":{"filePath":"/mnt/c/Users/o.young/work/architecture/bounded_context/profile.adoc","oldString":"== ProfileService\n\nUnified customer profile service providing enriched customer data for\nOTRG ecosystem.\n\n=== Domain Vision Statement","newString":"== ProfileService\n\nUnified customer profile service providing enriched customer data for\nOTRG ecosystem.\n\n=== Related Initiatives\n\nProfileService is a foundational bounded context supporting multiple strategic initiatives:\n\n* **xref:initiatives:salesforce_customer_support.adoc[OTR-001 Salesforce Customer Support]**: Provides Just-In-Time Contact reconciliation with Salesforce Service Cloud\n* **xref:initiatives:flybuys_integration.adoc[OTR-002 Flybuys Integration]**: Manages customer partner account linking (Flybuys, Shell) and reward preference tracking\n\nNOTE: These initiatives are the first implementations of OTR's Domain-Driven Design (DDD) architecture. Depending on sequencing, ProfileService capabilities may be delivered incrementally across either initiative.\n\n=== Domain Vision Statement","originalFile":"= Profile Bounded Context\nO.Young@otr.com.au\nv0.1, 2025-12-19\n:project-name: OTRG Apps & Ecommerce Architecture\n:togaf-adm-phase: Phase C: Information Systems Architectures\n:document-type: Bounded Context\n:status: Draft\n:version: 0.1\n:domain: Profile\n:bounded-context-type: APPLICATION\n:domain-architect: O.Young@otr.com.au\n:doctype: article\n:toc: left\n:toclevels: 4\n:sectanchors:\n:sectlinks:\n:sectnums:\n:icons: font\n:source-highlighter: highlightjs\n:experimental:\n:description: Bounded Context for the Profile Domain\n:keywords: profile, customer, bounded context, togaf, ddd\n\n== ProfileService\n\nUnified customer profile service providing enriched customer data for\nOTRG ecosystem.\n\n=== Domain Vision Statement\n\nProvide unified, enriched customer profiles bridging\nlink:external/salesforce_crm.adoc[Salesforce] canonical\ndata with OTRG-specific attributes, behavioral insights, and risk\nassessments.\n\n=== Responsibilities\n\n* OTR-specific customer profile management\n* Customer lifecycle stage and onboarding tracking\n* Partner linking status tracking\n* Customer risk assessment (fraud, refund, churn)\n* Refund history tracking\n* Engagement metrics caching for profile enrichment\n\n=== Implementation Technology\n\nAzure Functions, .NET Core, Azure SQL,\nlink:external/salesforce_crm.adoc[Salesforce] API,\nlink:interfaces/[Event Bus]\n\n=== What This Service Owns\n\nProfileService owns OTR-specific enrichment data and bridges\nlink:external/salesforce_crm.adoc[Salesforce] canonical\ncustomer records.\n\n==== Core Aggregates\n\n[width=\"100%\",cols=\"9%,91%\",options=\"header\",]\n|===\n|Aggregate Name |Description\n|`CustomerProfile` |OTRG-specific Customer profile attributes enriching\nlink:external/salesforce_crm.adoc[Salesforce] canonical\ndata. Stores behavioural data, preferences, and app-specific attributes.\n\n|`PartnerLink` |Securely connects Customers’ OTRG accounts to external\npartner services (like Flybuys and Shell) using industry-standard\nauthentication. Manages the connection status and customer preferences.\n\n|`RiskAssessment` |Customer risk, fraud, and value scores for instant\nrefund decisions. Provides both computed scores and raw factors for\ntransparency.\n\n|`RefundHistory` |Customer refund transaction history for risk\nassessment. Tracks refund requests, processing, and outcomes.\n|===\n\n==== NOT in this Context (Owned by Other Systems)\n\n[width=\"100%\",cols=\"26%,65%,9%\",options=\"header\",]\n|===\n|Action / Entity |Description |Relationship\n|Canonical Customer data |Name, email, phone →\nlink:external/salesforce_crm.adoc[Salesforce] CRM |HTTPS\nAPI\n\n|Viva Consumer ID (VCI) generation |Customer identifier generation →\nlink:external/salesforce_crm.adoc[Salesforce] CRM |HTTPS\nAPI\n\n|Marketing communication preferences |Communication preferences → Braze\n(via EngagementService) |Event Bus\n\n|Loyalty status |Points, tiers, wallet → EagleEye (via LoyaltyService)\n|Event Bus\n\n|Transaction details |Full transaction data → D365 Commerce (POS\nContext) |Event Bus\n\n|Reward transaction adjudication |Transaction reward processing →\nLoyaltyService |HTTPS API\n\n|OAuth tokens |OAuth token management → OAuth Service (Infrastructure)\n|Infrastructure\n|===\n\n=== Domain Events\n\n==== Profile Lifecycle Events\n\n* *ProfileCreated*: New customer profile created\n* *ProfileUpdated*: Customer profile information updated\n* *ProfileVerificationChanged*: Profile verification status changed\n(email/phone verification)\n* *ProfileCompletenessChanged*: Profile completeness score changed\n(0-100)\n* *LifeCycleStageChanged*: Customer lifecycle stage changed (PROSPECT →\nNEW → ACTIVE → DORMANT → AT_RISK → CHURNED)\n* *OnboardingCompleted*: Customer completed onboarding flow\n* *OnboardingProgressUpdated*: Customer progressed through onboarding\nsteps\n\n==== Partner Linking Events (Moved from LoyaltyService)\n\n* *PartnerLinked*: Customer linked external partner account (Flybuys,\nShell)\n* *PartnerUnlinked*: Customer unlinked external partner account\n* *PartnerLinkChanged*: Partner link status changed (LINKED →\nSYNC_FAILED → UNLINKED)\n* *RewardPreferenceChanged*: Customer changed reward program preference\n(FLYBUYS_POINTS, FUEL_DISCOUNT_SHELL, OTR_REWARDS)\n\n==== Risk Assessment Events\n\n* *RiskStatusChanged*: Customer risk status changed (LOW → MEDIUM → HIGH\n→ CRITICAL)\n* *FraudIndicatorDetected*: Potential fraud indicator detected (multiple\naccounts, chargeback pattern, login anomaly, etc.)\n\n==== Refund History Events\n\n* *RefundRequested*: Customer requested refund\n* *RefundProcessed*: Refund processed and completed\n\n=== Key Services\n\n[width=\"100%\",cols=\"19%,81%\",options=\"header\",]\n|===\n|Service Name |Description\n|`ProfileQueryService` |Query customer profile\n(link:external/salesforce_crm.adoc[Salesforce] canonical\n+ OTR enrichment), profile completeness, partner links\n\n|`RiskAssessmentService` |Get comprehensive risk assessment (scores +\nraw factors), calculate risk scores, fraud/refund/churn risk queries\n\n|`RefundHistoryService` |Query refund history, record new refund\nrequests, calculate refund statistics\n\n|`PartnerLinkService` |Create partner link, update reward preference,\nsync with partner, revoke partner link\n\n|`EngagementSyncService` |Update cached engagement summary from\nEngagementService, get cached engagement summary\n\n|`[Salesforce](external/salesforce_crm.adoc)ProfileAdapter`\n|ACL for link:external/salesforce_crm.adoc[Salesforce]\nintegration - query canonical customer data, resolve email to VCI,\nvalidate VCI\n|===\n\n=== Integration Points\n\n* *Upstream*:\nlink:external/salesforce_crm.adoc[Salesforce] (canonical\ncustomer data), EngagementService (engagement metrics)\n* *Downstream*: LoyaltyService, EngagementService, RefundService\n(future)\n* *Bidirectional*: EngagementService (profile enrichment ↔ engagement\nsummaries)\n\n=== Bounded Context Boundaries\n\n* ProfileService enriches\nlink:external/salesforce_crm.adoc[Salesforce] canonical\ndata with OTR-specific attributes\n* link:external/salesforce_crm.adoc[Salesforce] is system\nof record for customer identity and core contact details\n* ProfileService is system of record for OTR-specific behavior and risk\ndata\n* More volatile than\nlink:external/salesforce_crm.adoc[Salesforce] (frequent\nupdates from app usage, transactions)\n\n=== Architecture Decision Log\n\n==== Decision 1: ProfileService Bridges link:external/salesforce_crm.adoc[Salesforce] and OTR Ecosystem\n\n*Decision:* ProfileService acts as an Anti-Corruption Layer between\nlink:external/salesforce_crm.adoc[Salesforce] (canonical\ncustomer records) and OTR-specific profile data.\n\n*Rationale:*\n\n* link:external/salesforce_crm.adoc[Salesforce] owns\ncanonical customer identity (VCI, name, email, phone)\n* OTR App Database contains richer OTR-specific profile data\n* Admin portal currently operates independently from\nlink:external/salesforce_crm.adoc[Salesforce]\n* ProfileService evolves existing OTR App database to bridge both\nsystems\n* VCI will be introduced through Flybuys initiative\n\n*Current State:*\n\n* OTR App Database → Admin Portal (email-keyed, no VCI)\n* link:external/salesforce_crm.adoc[Salesforce] → Viva\nbrands (VCI-keyed)\n* No connection between systems\n\n*Future State:*\n\n* ProfileService stores OTR-specific enrichment with VCI\n* Queries link:external/salesforce_crm.adoc[Salesforce]\nfor canonical customer data\n* Admin portal enhanced to use VCI\n* External systems (EagleEye, Braze) keyed by VCI\n\n*Implementation:*\n\n* ProfileService stores OTR-specific attributes with VCI reference\n* Synchronous queries to\nlink:external/salesforce_crm.adoc[Salesforce] for\ncanonical customer data\n* Customer-Supplier (Conformist) pattern with\nlink:external/salesforce_crm.adoc[Salesforce]\n* ProfileService owns OTR enrichment,\nlink:external/salesforce_crm.adoc[Salesforce] owns\nidentity\n\n==== Decision 2: Risk Assessment for Instant Refunds\n\n*Decision:* ProfileService provides scored risk assessment and raw\nfactors to enable instant refund decisions by other business units.\n\n*Rationale:*\n\n* Current refund turnaround is 15 days due to poor workflows\n* Target: Immediate refunds for right customers based on risk profile\n* Risk profile = loyalty + fraud + behavioral factors\n* ProfileService doesn’t process refunds, just provides assessment\n\n*Risk Assessment Factors:*\n\n*ProfileService Owned:*\n\n* Refund history (count, frequency, amounts, reasons)\n* Transaction behavior (frequency, recency, transaction value)\n* Account health (tenure, verification status)\n* Fraud indicators (disputes, chargebacks, anomalies)\n* Engagement metrics (app usage, support interactions)\n* Customer value (lifetime value, profitability)\n\n*Aggregated from Other Services:*\n\n* Loyalty tier/status → LoyaltyService\n\n*API Design:*\n\n* Provides both computed risk score AND raw factors\n* Enables other business units to apply their own scoring logic\n* Transparency for audit and debugging\n\n*Implementation:*\n\n* RiskAssessment aggregate calculates scores\n* REST API endpoint: GET /profiles/\\{vci}/risk-assessment\n* Admin portal can display for customer service agents\n* Future: RefundService orchestrates instant refund decisions\n\n==== Decision 3: PartnerLink Aggregate Moved from LoyaltyService\n\n*Decision:* PartnerLink aggregate moved from LoyaltyService to\nProfileService.\n\n*Rationale:*\n\n* Partner linking is customer profile data, not loyalty transaction data\n* ProfileService is natural home for customer relationships\n* Reduces LoyaltyService complexity to single aggregate\n(RewardTransaction)\n\n*Migration Impact:*\n\n* LoyaltyService queries ProfileService synchronously for partner link\nstatus\n* Pattern: GET /profiles/\\{vci}/partner-links\n* Similar to how LoyaltyService queries EagleEye (real-time\norchestration)\n\n*Implementation:*\n\n* PartnerLink aggregate tracks linking status and reward preference\n* OAuth tokens managed by infrastructure OAuth Service (not in\naggregate)\n* ProfileService publishes PartnerLinked/PartnerUnlinked events\n* LoyaltyService consumes events for auditing/analytics\n\n==== Decision 4: Bidirectional Integration with EngagementService\n\n*Decision:* ProfileService and EngagementService have bidirectional\nintegration with hybrid event/batch synchronization pattern.\n\n*Rationale:*\n\n* Both services need data from each other\n* Each maintains system of record status for their domain\n* Eventual consistency acceptable (not real-time)\n* Strong event-based architecture with pragmatic batching\n\n*ProfileService → EngagementService (for segmentation/targeting):*\n\n* Events: ProfileCreated, ProfileUpdated, PartnerLinkChanged,\nRiskStatusChanged\n* Batch: Daily profile enrichment (risk scores, profile completeness)\n* Use case: Campaign targeting, segmentation\n\n*EngagementService → ProfileService (for profile enrichment):*\n\n* Events: EngagementTierChanged (highly engaged → disengaged)\n* Batch: Daily engagement score rollup (click rates, app usage\nsummaries)\n* Use case: Risk assessment, profile completeness\n\n*Each Service is System of Record:*\n\n* EngagementService owns: Campaign interactions, notification\npreferences\n* ProfileService owns: Customer attributes, risk scores, partner links\n\n*Implementation:*\n\n* Open Host Service + Published Language pattern (both directions)\n* Event Bus for real-time critical changes\n* Scheduled batch jobs for comprehensive summaries\n* Cached summaries stored locally (eventual consistency)\n\n==== Decision 5: ProfileService More Volatile Than link:external/salesforce_crm.adoc[Salesforce]\n\n*Decision:* ProfileService updates more frequently than\nlink:external/salesforce_crm.adoc[Salesforce] because it\ntracks behavioral and transactional data.\n\n*Rationale:*\n\n* link:external/salesforce_crm.adoc[Salesforce]:\nCanonical customer data changes infrequently (name, email)\n* ProfileService: Behavioral data changes constantly (app usage,\ntransactions)\n* ProfileService optimized for high-frequency updates\n* link:external/salesforce_crm.adoc[Salesforce] optimized\nfor identity and contact management\n\n*Volatility Comparison:*\n\n* link:external/salesforce_crm.adoc[Salesforce] updates:\nCustomer changes email, phone, address (infrequent)\n* ProfileService updates: Every transaction, login, app interaction\n(frequent)\n\n*Implementation:*\n\n* ProfileService database optimized for write-heavy workload\n* link:external/salesforce_crm.adoc[Salesforce] sync\nhandles identity changes only\n* No need for ProfileService to push behavioral data to\nlink:external/salesforce_crm.adoc[Salesforce]\n* ProfileService is authoritative for OTR behavioral data\n\n==== Decision 6: Synchronous Integration from LoyaltyService\n\n*Decision:* LoyaltyService queries ProfileService synchronously for\npartner link status during transaction adjudication.\n\n*Rationale:*\n\n* Transaction adjudication needs current partner status\n* Real-time query ensures accuracy\n* Similar pattern to LoyaltyService querying EagleEye\n* No local caching complexity\n\n*Flow:*\n\n[arabic]\n. Transaction adjudication request arrives at LoyaltyService\n. LoyaltyService queries ProfileService: GET\n/profiles/\\{vci}/partner-links\n. ProfileService returns partner linking status\n. LoyaltyService uses status for reward calculation\n. Transaction adjudication completes\n\n*Implementation:*\n\n* REST API for partner link queries\n* Low latency required (<100ms)\n* Circuit breaker pattern for resilience\n* Fallback to default (OTR Rewards) if ProfileService unavailable\n\n=== Key Architectural Patterns\n\n==== 1. Anti-Corruption Layer (ACL)\n\n* link:external/salesforce_crm.adoc[Salesforce]ProfileAdapter:\nProtects domain from\nlink:external/salesforce_crm.adoc[Salesforce] API changes\n* Translates between\nlink:external/salesforce_crm.adoc[Salesforce]\nContact/Person Account and OTR profile model\n* Single place to update when\nlink:external/salesforce_crm.adoc[Salesforce] changes\n\n==== 2. Backend-for-Frontend (BFF)\n\n* ProfileService aggregates from multiple sources\n(link:external/salesforce_crm.adoc[Salesforce],\nEngagementService)\n* Provides unified profile API for mobile app and other services\n* Enriches canonical data with OTR-specific attributes\n\n==== 3. Hybrid Event/Batch Synchronization\n\n* Critical changes via domain events (real-time)\n* Comprehensive summaries via batch jobs (periodic)\n* Balances consistency needs with performance\n\n==== 4. Query-and-Enrich Pattern\n\n* Queries link:external/salesforce_crm.adoc[Salesforce]\nfor canonical customer data (real-time)\n* Enriches with OTR-specific attributes from local database\n* Returns unified CustomerProfileResponse\n* No local caching of\nlink:external/salesforce_crm.adoc[Salesforce] data\n(always fresh)\n","structuredPatch":[{"oldStart":26,"oldLines":6,"newStart":26,"newLines":15,"lines":[" Unified customer profile service providing enriched customer data for"," OTRG ecosystem."," ","+=== Related Initiatives","+","+ProfileService is a foundational bounded context supporting multiple strategic initiatives:","+","+* **xref:initiatives:salesforce_customer_support.adoc[OTR-001 Salesforce Customer Support]**: Provides Just-In-Time Contact reconciliation with Salesforce Service Cloud","+* **xref:initiatives:flybuys_integration.adoc[OTR-002 Flybuys Integration]**: Manages customer partner account linking (Flybuys, Shell) and reward preference tracking","+","+NOTE: These initiatives are the first implementations of OTR's Domain-Driven Design (DDD) architecture. Depending on sequencing, ProfileService capabilities may be delivered incrementally across either initiative.","+"," === Domain Vision Statement"," "," Provide unified, enriched customer profiles bridging"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"3fcfe7b4-0299-4c83-b15d-750344c0f0e1"}
{"parentUuid":"e93af460-c17e-4ffd-b791-1725e2f951a9","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01VhMcfX11pnNFXcpTrCZ5mb","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Good! Now let me update the responsibilities section to make it clearer which capabilities support which initiative.","signature":"Ep0CCkYICxgCKkAIT3Zz7dRactTGGUlMNZkaqAtrRwaCgmU9OPmB9oKOmJqqG36Yr0S/haqMYVkQBhGk9ZLXogaULjXCdQsZs+y9Egw1RQSQNm7Y656n3IoaDJJNcWQHWr+yd3/rqiIwl6AmHEFRmCLEilbcZEuBW57sBZRPgkcxmvZkZvPsigu6xQV3hKeh4camf3YlwTnwKoQB8rjIhehaFWIaCNWUJP+kyuuCxzmjVSDmvh1MgLB2cCiFZ4aK+vMTxGl1Cji/Xl4n9GfAxpyHPefFH52G65x5UHDn2dMXB+NqZxLA0OW7eovfCt3cgX/DKICacBO7Ds2OqYe/s4ap1zdqVZR5Q4hxDb9YhUXlRG2N79s2dUXb7OzsK3qrGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":795,"cache_read_input_tokens":80191,"cache_creation":{"ephemeral_5m_input_tokens":795,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWwBNz8YAN9n1EwRr8umN","type":"assistant","uuid":"581accab-8038-4b0c-a0f6-37f406bcd0ab","timestamp":"2026-01-09T04:33:31.885Z"}
{"parentUuid":"581accab-8038-4b0c-a0f6-37f406bcd0ab","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01VhMcfX11pnNFXcpTrCZ5mb","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_014kz1di8fFoemhCwqZjPY6b","name":"TodoWrite","input":{"todos":[{"content":"Add initiative context to ProfileService documentation header","activeForm":"Adding initiative context to header","status":"completed"},{"content":"Update profile.adoc to reference both OTR-001 and OTR-002 initiatives","activeForm":"Updating initiative references","status":"in_progress"},{"content":"Add architecture decision about dual initiative support","activeForm":"Adding dual initiative decision","status":"pending"},{"content":"Update CML file header to reference initiatives","activeForm":"Updating CML header","status":"pending"},{"content":"Ensure consistency between CML and markdown files","activeForm":"Ensuring CML/markdown consistency","status":"pending"}]}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":795,"cache_read_input_tokens":80191,"cache_creation":{"ephemeral_5m_input_tokens":795,"ephemeral_1h_input_tokens":0},"output_tokens":251,"service_tier":"standard"}},"requestId":"req_011CWwBNz8YAN9n1EwRr8umN","type":"assistant","uuid":"09d7ccc0-87b8-4e83-ab69-e4bb4ddcc01a","timestamp":"2026-01-09T04:33:33.419Z"}
{"parentUuid":"09d7ccc0-87b8-4e83-ab69-e4bb4ddcc01a","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_014kz1di8fFoemhCwqZjPY6b","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"uuid":"733239b2-9e6a-4754-a7f4-a773afcd23c8","timestamp":"2026-01-09T04:33:33.575Z","toolUseResult":{"oldTodos":[{"content":"Add initiative context to ProfileService documentation header","status":"in_progress","activeForm":"Adding initiative context to header"},{"content":"Update profile.adoc to reference both OTR-001 and OTR-002 initiatives","status":"pending","activeForm":"Updating initiative references"},{"content":"Add architecture decision about dual initiative support","status":"pending","activeForm":"Adding dual initiative decision"},{"content":"Update CML file header to reference initiatives","status":"pending","activeForm":"Updating CML header"},{"content":"Ensure consistency between CML and markdown files","status":"pending","activeForm":"Ensuring CML/markdown consistency"}],"newTodos":[{"content":"Add initiative context to ProfileService documentation header","status":"completed","activeForm":"Adding initiative context to header"},{"content":"Update profile.adoc to reference both OTR-001 and OTR-002 initiatives","status":"in_progress","activeForm":"Updating initiative references"},{"content":"Add architecture decision about dual initiative support","status":"pending","activeForm":"Adding dual initiative decision"},{"content":"Update CML file header to reference initiatives","status":"pending","activeForm":"Updating CML header"},{"content":"Ensure consistency between CML and markdown files","status":"pending","activeForm":"Ensuring CML/markdown consistency"}]},"sourceToolAssistantUUID":"09d7ccc0-87b8-4e83-ab69-e4bb4ddcc01a"}
{"parentUuid":"733239b2-9e6a-4754-a7f4-a773afcd23c8","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01MXW8NA7AVM8LrVrfhw4jX6","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now let me update the Responsibilities section to map them to the initiatives.","signature":"EvYBCkYICxgCKkCaRFEGynQ9mT8L4U+iDcOr1sQ9fHFpFV9QEz4b9ln3VU5RJ/0VlMGJSfGZSdRTlUgCdkQqBL/jKUdeKRFnaE7dEgxtQWqTWALcTI84HcEaDIZldlN2VsNF0Fbf/yIwwf91tOeKOt0dmhlwgGBpZEC51xbUtO1UEQpgy+fOJG3/LchVeAtnUuipma6sAez4Kl4lQCfdHPNz/lYCjMRXM+nIgtCZhxr8IVcUEOooEKTQelkiYtjufu/C9F1OHEqa4c2MTLBcBG6CkL2RuwtFjxLx0Q0GHG7LggTNSa6bH/9I7xhUnG1PUmsTpVyr4NwtGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":300,"cache_read_input_tokens":80986,"cache_creation":{"ephemeral_5m_input_tokens":300,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWwBPQymAhBZCpm7yH3XR","type":"assistant","uuid":"ff6b9546-6eab-425a-bbd0-6804384b28cd","timestamp":"2026-01-09T04:33:37.296Z"}
{"parentUuid":"ff6b9546-6eab-425a-bbd0-6804384b28cd","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01MXW8NA7AVM8LrVrfhw4jX6","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01GVgNGDkKAkxEhfpEpmPm9a","name":"Edit","input":{"replace_all":false,"file_path":"/mnt/c/Users/o.young/work/architecture/bounded_context/profile.adoc","old_string":"=== Responsibilities\n\n* OTR-specific customer profile management\n* Customer lifecycle stage and onboarding tracking\n* Partner linking status tracking\n* Customer risk assessment (fraud, refund, churn)\n* Refund history tracking\n* Engagement metrics caching for profile enrichment","new_string":"=== Responsibilities\n\n**Core Capabilities (All Initiatives):**\n\n* OTR-specific customer profile management\n* Customer lifecycle stage and onboarding tracking\n* Engagement metrics caching for profile enrichment\n\n**Salesforce Customer Support (OTR-001):**\n\n* Just-In-Time Contact reconciliation with Salesforce Service Cloud\n* Contact ID resolution for feedback submission\n* Foundation for unified customer view across Viva Energy channels\n\n**Flybuys Integration (OTR-002):**\n\n* Partner linking status tracking (Flybuys, Shell Card)\n* Reward preference management (Flybuys Points, Fuel Discount, OTR Rewards)\n* OAuth partner account linking coordination\n\n**Future Capabilities:**\n\n* Customer risk assessment (fraud, refund, churn)\n* Refund history tracking"}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":300,"cache_read_input_tokens":80986,"cache_creation":{"ephemeral_5m_input_tokens":300,"ephemeral_1h_input_tokens":0},"output_tokens":402,"service_tier":"standard"}},"requestId":"req_011CWwBPQymAhBZCpm7yH3XR","type":"assistant","uuid":"9b0e9a7c-24e7-405b-905c-93d09a7c167e","timestamp":"2026-01-09T04:33:42.996Z"}
{"parentUuid":"9b0e9a7c-24e7-405b-905c-93d09a7c167e","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01GVgNGDkKAkxEhfpEpmPm9a","type":"tool_result","content":"The file /mnt/c/Users/o.young/work/architecture/bounded_context/profile.adoc has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n    41→link:external/salesforce_crm.adoc[Salesforce] canonical\n    42→data with OTRG-specific attributes, behavioral insights, and risk\n    43→assessments.\n    44→\n    45→=== Responsibilities\n    46→\n    47→**Core Capabilities (All Initiatives):**\n    48→\n    49→* OTR-specific customer profile management\n    50→* Customer lifecycle stage and onboarding tracking\n    51→* Engagement metrics caching for profile enrichment\n    52→\n    53→**Salesforce Customer Support (OTR-001):**\n    54→\n    55→* Just-In-Time Contact reconciliation with Salesforce Service Cloud\n    56→* Contact ID resolution for feedback submission\n    57→* Foundation for unified customer view across Viva Energy channels\n    58→\n    59→**Flybuys Integration (OTR-002):**\n    60→\n    61→* Partner linking status tracking (Flybuys, Shell Card)\n    62→* Reward preference management (Flybuys Points, Fuel Discount, OTR Rewards)\n    63→* OAuth partner account linking coordination\n    64→\n    65→**Future Capabilities:**\n    66→\n    67→* Customer risk assessment (fraud, refund, churn)\n    68→* Refund history tracking\n    69→\n    70→=== Implementation Technology\n    71→\n    72→Azure Functions, .NET Core, Azure SQL,"}]},"uuid":"989dee01-71e1-49ee-8a62-e419047a79c3","timestamp":"2026-01-09T04:33:43.168Z","toolUseResult":{"filePath":"/mnt/c/Users/o.young/work/architecture/bounded_context/profile.adoc","oldString":"=== Responsibilities\n\n* OTR-specific customer profile management\n* Customer lifecycle stage and onboarding tracking\n* Partner linking status tracking\n* Customer risk assessment (fraud, refund, churn)\n* Refund history tracking\n* Engagement metrics caching for profile enrichment","newString":"=== Responsibilities\n\n**Core Capabilities (All Initiatives):**\n\n* OTR-specific customer profile management\n* Customer lifecycle stage and onboarding tracking\n* Engagement metrics caching for profile enrichment\n\n**Salesforce Customer Support (OTR-001):**\n\n* Just-In-Time Contact reconciliation with Salesforce Service Cloud\n* Contact ID resolution for feedback submission\n* Foundation for unified customer view across Viva Energy channels\n\n**Flybuys Integration (OTR-002):**\n\n* Partner linking status tracking (Flybuys, Shell Card)\n* Reward preference management (Flybuys Points, Fuel Discount, OTR Rewards)\n* OAuth partner account linking coordination\n\n**Future Capabilities:**\n\n* Customer risk assessment (fraud, refund, churn)\n* Refund history tracking","originalFile":"= Profile Bounded Context\nO.Young@otr.com.au\nv0.1, 2025-12-19\n:project-name: OTRG Apps & Ecommerce Architecture\n:togaf-adm-phase: Phase C: Information Systems Architectures\n:document-type: Bounded Context\n:status: Draft\n:version: 0.1\n:domain: Profile\n:bounded-context-type: APPLICATION\n:domain-architect: O.Young@otr.com.au\n:doctype: article\n:toc: left\n:toclevels: 4\n:sectanchors:\n:sectlinks:\n:sectnums:\n:icons: font\n:source-highlighter: highlightjs\n:experimental:\n:description: Bounded Context for the Profile Domain\n:keywords: profile, customer, bounded context, togaf, ddd\n\n== ProfileService\n\nUnified customer profile service providing enriched customer data for\nOTRG ecosystem.\n\n=== Related Initiatives\n\nProfileService is a foundational bounded context supporting multiple strategic initiatives:\n\n* **xref:initiatives:salesforce_customer_support.adoc[OTR-001 Salesforce Customer Support]**: Provides Just-In-Time Contact reconciliation with Salesforce Service Cloud\n* **xref:initiatives:flybuys_integration.adoc[OTR-002 Flybuys Integration]**: Manages customer partner account linking (Flybuys, Shell) and reward preference tracking\n\nNOTE: These initiatives are the first implementations of OTR's Domain-Driven Design (DDD) architecture. Depending on sequencing, ProfileService capabilities may be delivered incrementally across either initiative.\n\n=== Domain Vision Statement\n\nProvide unified, enriched customer profiles bridging\nlink:external/salesforce_crm.adoc[Salesforce] canonical\ndata with OTRG-specific attributes, behavioral insights, and risk\nassessments.\n\n=== Responsibilities\n\n* OTR-specific customer profile management\n* Customer lifecycle stage and onboarding tracking\n* Partner linking status tracking\n* Customer risk assessment (fraud, refund, churn)\n* Refund history tracking\n* Engagement metrics caching for profile enrichment\n\n=== Implementation Technology\n\nAzure Functions, .NET Core, Azure SQL,\nlink:external/salesforce_crm.adoc[Salesforce] API,\nlink:interfaces/[Event Bus]\n\n=== What This Service Owns\n\nProfileService owns OTR-specific enrichment data and bridges\nlink:external/salesforce_crm.adoc[Salesforce] canonical\ncustomer records.\n\n==== Core Aggregates\n\n[width=\"100%\",cols=\"9%,91%\",options=\"header\",]\n|===\n|Aggregate Name |Description\n|`CustomerProfile` |OTRG-specific Customer profile attributes enriching\nlink:external/salesforce_crm.adoc[Salesforce] canonical\ndata. Stores behavioural data, preferences, and app-specific attributes.\n\n|`PartnerLink` |Securely connects Customers’ OTRG accounts to external\npartner services (like Flybuys and Shell) using industry-standard\nauthentication. Manages the connection status and customer preferences.\n\n|`RiskAssessment` |Customer risk, fraud, and value scores for instant\nrefund decisions. Provides both computed scores and raw factors for\ntransparency.\n\n|`RefundHistory` |Customer refund transaction history for risk\nassessment. Tracks refund requests, processing, and outcomes.\n|===\n\n==== NOT in this Context (Owned by Other Systems)\n\n[width=\"100%\",cols=\"26%,65%,9%\",options=\"header\",]\n|===\n|Action / Entity |Description |Relationship\n|Canonical Customer data |Name, email, phone →\nlink:external/salesforce_crm.adoc[Salesforce] CRM |HTTPS\nAPI\n\n|Viva Consumer ID (VCI) generation |Customer identifier generation →\nlink:external/salesforce_crm.adoc[Salesforce] CRM |HTTPS\nAPI\n\n|Marketing communication preferences |Communication preferences → Braze\n(via EngagementService) |Event Bus\n\n|Loyalty status |Points, tiers, wallet → EagleEye (via LoyaltyService)\n|Event Bus\n\n|Transaction details |Full transaction data → D365 Commerce (POS\nContext) |Event Bus\n\n|Reward transaction adjudication |Transaction reward processing →\nLoyaltyService |HTTPS API\n\n|OAuth tokens |OAuth token management → OAuth Service (Infrastructure)\n|Infrastructure\n|===\n\n=== Domain Events\n\n==== Profile Lifecycle Events\n\n* *ProfileCreated*: New customer profile created\n* *ProfileUpdated*: Customer profile information updated\n* *ProfileVerificationChanged*: Profile verification status changed\n(email/phone verification)\n* *ProfileCompletenessChanged*: Profile completeness score changed\n(0-100)\n* *LifeCycleStageChanged*: Customer lifecycle stage changed (PROSPECT →\nNEW → ACTIVE → DORMANT → AT_RISK → CHURNED)\n* *OnboardingCompleted*: Customer completed onboarding flow\n* *OnboardingProgressUpdated*: Customer progressed through onboarding\nsteps\n\n==== Partner Linking Events (Moved from LoyaltyService)\n\n* *PartnerLinked*: Customer linked external partner account (Flybuys,\nShell)\n* *PartnerUnlinked*: Customer unlinked external partner account\n* *PartnerLinkChanged*: Partner link status changed (LINKED →\nSYNC_FAILED → UNLINKED)\n* *RewardPreferenceChanged*: Customer changed reward program preference\n(FLYBUYS_POINTS, FUEL_DISCOUNT_SHELL, OTR_REWARDS)\n\n==== Risk Assessment Events\n\n* *RiskStatusChanged*: Customer risk status changed (LOW → MEDIUM → HIGH\n→ CRITICAL)\n* *FraudIndicatorDetected*: Potential fraud indicator detected (multiple\naccounts, chargeback pattern, login anomaly, etc.)\n\n==== Refund History Events\n\n* *RefundRequested*: Customer requested refund\n* *RefundProcessed*: Refund processed and completed\n\n=== Key Services\n\n[width=\"100%\",cols=\"19%,81%\",options=\"header\",]\n|===\n|Service Name |Description\n|`ProfileQueryService` |Query customer profile\n(link:external/salesforce_crm.adoc[Salesforce] canonical\n+ OTR enrichment), profile completeness, partner links\n\n|`RiskAssessmentService` |Get comprehensive risk assessment (scores +\nraw factors), calculate risk scores, fraud/refund/churn risk queries\n\n|`RefundHistoryService` |Query refund history, record new refund\nrequests, calculate refund statistics\n\n|`PartnerLinkService` |Create partner link, update reward preference,\nsync with partner, revoke partner link\n\n|`EngagementSyncService` |Update cached engagement summary from\nEngagementService, get cached engagement summary\n\n|`[Salesforce](external/salesforce_crm.adoc)ProfileAdapter`\n|ACL for link:external/salesforce_crm.adoc[Salesforce]\nintegration - query canonical customer data, resolve email to VCI,\nvalidate VCI\n|===\n\n=== Integration Points\n\n* *Upstream*:\nlink:external/salesforce_crm.adoc[Salesforce] (canonical\ncustomer data), EngagementService (engagement metrics)\n* *Downstream*: LoyaltyService, EngagementService, RefundService\n(future)\n* *Bidirectional*: EngagementService (profile enrichment ↔ engagement\nsummaries)\n\n=== Bounded Context Boundaries\n\n* ProfileService enriches\nlink:external/salesforce_crm.adoc[Salesforce] canonical\ndata with OTR-specific attributes\n* link:external/salesforce_crm.adoc[Salesforce] is system\nof record for customer identity and core contact details\n* ProfileService is system of record for OTR-specific behavior and risk\ndata\n* More volatile than\nlink:external/salesforce_crm.adoc[Salesforce] (frequent\nupdates from app usage, transactions)\n\n=== Architecture Decision Log\n\n==== Decision 1: ProfileService Bridges link:external/salesforce_crm.adoc[Salesforce] and OTR Ecosystem\n\n*Decision:* ProfileService acts as an Anti-Corruption Layer between\nlink:external/salesforce_crm.adoc[Salesforce] (canonical\ncustomer records) and OTR-specific profile data.\n\n*Rationale:*\n\n* link:external/salesforce_crm.adoc[Salesforce] owns\ncanonical customer identity (VCI, name, email, phone)\n* OTR App Database contains richer OTR-specific profile data\n* Admin portal currently operates independently from\nlink:external/salesforce_crm.adoc[Salesforce]\n* ProfileService evolves existing OTR App database to bridge both\nsystems\n* VCI will be introduced through Flybuys initiative\n\n*Current State:*\n\n* OTR App Database → Admin Portal (email-keyed, no VCI)\n* link:external/salesforce_crm.adoc[Salesforce] → Viva\nbrands (VCI-keyed)\n* No connection between systems\n\n*Future State:*\n\n* ProfileService stores OTR-specific enrichment with VCI\n* Queries link:external/salesforce_crm.adoc[Salesforce]\nfor canonical customer data\n* Admin portal enhanced to use VCI\n* External systems (EagleEye, Braze) keyed by VCI\n\n*Implementation:*\n\n* ProfileService stores OTR-specific attributes with VCI reference\n* Synchronous queries to\nlink:external/salesforce_crm.adoc[Salesforce] for\ncanonical customer data\n* Customer-Supplier (Conformist) pattern with\nlink:external/salesforce_crm.adoc[Salesforce]\n* ProfileService owns OTR enrichment,\nlink:external/salesforce_crm.adoc[Salesforce] owns\nidentity\n\n==== Decision 2: Risk Assessment for Instant Refunds\n\n*Decision:* ProfileService provides scored risk assessment and raw\nfactors to enable instant refund decisions by other business units.\n\n*Rationale:*\n\n* Current refund turnaround is 15 days due to poor workflows\n* Target: Immediate refunds for right customers based on risk profile\n* Risk profile = loyalty + fraud + behavioral factors\n* ProfileService doesn’t process refunds, just provides assessment\n\n*Risk Assessment Factors:*\n\n*ProfileService Owned:*\n\n* Refund history (count, frequency, amounts, reasons)\n* Transaction behavior (frequency, recency, transaction value)\n* Account health (tenure, verification status)\n* Fraud indicators (disputes, chargebacks, anomalies)\n* Engagement metrics (app usage, support interactions)\n* Customer value (lifetime value, profitability)\n\n*Aggregated from Other Services:*\n\n* Loyalty tier/status → LoyaltyService\n\n*API Design:*\n\n* Provides both computed risk score AND raw factors\n* Enables other business units to apply their own scoring logic\n* Transparency for audit and debugging\n\n*Implementation:*\n\n* RiskAssessment aggregate calculates scores\n* REST API endpoint: GET /profiles/\\{vci}/risk-assessment\n* Admin portal can display for customer service agents\n* Future: RefundService orchestrates instant refund decisions\n\n==== Decision 3: PartnerLink Aggregate Moved from LoyaltyService\n\n*Decision:* PartnerLink aggregate moved from LoyaltyService to\nProfileService.\n\n*Rationale:*\n\n* Partner linking is customer profile data, not loyalty transaction data\n* ProfileService is natural home for customer relationships\n* Reduces LoyaltyService complexity to single aggregate\n(RewardTransaction)\n\n*Migration Impact:*\n\n* LoyaltyService queries ProfileService synchronously for partner link\nstatus\n* Pattern: GET /profiles/\\{vci}/partner-links\n* Similar to how LoyaltyService queries EagleEye (real-time\norchestration)\n\n*Implementation:*\n\n* PartnerLink aggregate tracks linking status and reward preference\n* OAuth tokens managed by infrastructure OAuth Service (not in\naggregate)\n* ProfileService publishes PartnerLinked/PartnerUnlinked events\n* LoyaltyService consumes events for auditing/analytics\n\n==== Decision 4: Bidirectional Integration with EngagementService\n\n*Decision:* ProfileService and EngagementService have bidirectional\nintegration with hybrid event/batch synchronization pattern.\n\n*Rationale:*\n\n* Both services need data from each other\n* Each maintains system of record status for their domain\n* Eventual consistency acceptable (not real-time)\n* Strong event-based architecture with pragmatic batching\n\n*ProfileService → EngagementService (for segmentation/targeting):*\n\n* Events: ProfileCreated, ProfileUpdated, PartnerLinkChanged,\nRiskStatusChanged\n* Batch: Daily profile enrichment (risk scores, profile completeness)\n* Use case: Campaign targeting, segmentation\n\n*EngagementService → ProfileService (for profile enrichment):*\n\n* Events: EngagementTierChanged (highly engaged → disengaged)\n* Batch: Daily engagement score rollup (click rates, app usage\nsummaries)\n* Use case: Risk assessment, profile completeness\n\n*Each Service is System of Record:*\n\n* EngagementService owns: Campaign interactions, notification\npreferences\n* ProfileService owns: Customer attributes, risk scores, partner links\n\n*Implementation:*\n\n* Open Host Service + Published Language pattern (both directions)\n* Event Bus for real-time critical changes\n* Scheduled batch jobs for comprehensive summaries\n* Cached summaries stored locally (eventual consistency)\n\n==== Decision 5: ProfileService More Volatile Than link:external/salesforce_crm.adoc[Salesforce]\n\n*Decision:* ProfileService updates more frequently than\nlink:external/salesforce_crm.adoc[Salesforce] because it\ntracks behavioral and transactional data.\n\n*Rationale:*\n\n* link:external/salesforce_crm.adoc[Salesforce]:\nCanonical customer data changes infrequently (name, email)\n* ProfileService: Behavioral data changes constantly (app usage,\ntransactions)\n* ProfileService optimized for high-frequency updates\n* link:external/salesforce_crm.adoc[Salesforce] optimized\nfor identity and contact management\n\n*Volatility Comparison:*\n\n* link:external/salesforce_crm.adoc[Salesforce] updates:\nCustomer changes email, phone, address (infrequent)\n* ProfileService updates: Every transaction, login, app interaction\n(frequent)\n\n*Implementation:*\n\n* ProfileService database optimized for write-heavy workload\n* link:external/salesforce_crm.adoc[Salesforce] sync\nhandles identity changes only\n* No need for ProfileService to push behavioral data to\nlink:external/salesforce_crm.adoc[Salesforce]\n* ProfileService is authoritative for OTR behavioral data\n\n==== Decision 6: Synchronous Integration from LoyaltyService\n\n*Decision:* LoyaltyService queries ProfileService synchronously for\npartner link status during transaction adjudication.\n\n*Rationale:*\n\n* Transaction adjudication needs current partner status\n* Real-time query ensures accuracy\n* Similar pattern to LoyaltyService querying EagleEye\n* No local caching complexity\n\n*Flow:*\n\n[arabic]\n. Transaction adjudication request arrives at LoyaltyService\n. LoyaltyService queries ProfileService: GET\n/profiles/\\{vci}/partner-links\n. ProfileService returns partner linking status\n. LoyaltyService uses status for reward calculation\n. Transaction adjudication completes\n\n*Implementation:*\n\n* REST API for partner link queries\n* Low latency required (<100ms)\n* Circuit breaker pattern for resilience\n* Fallback to default (OTR Rewards) if ProfileService unavailable\n\n=== Key Architectural Patterns\n\n==== 1. Anti-Corruption Layer (ACL)\n\n* link:external/salesforce_crm.adoc[Salesforce]ProfileAdapter:\nProtects domain from\nlink:external/salesforce_crm.adoc[Salesforce] API changes\n* Translates between\nlink:external/salesforce_crm.adoc[Salesforce]\nContact/Person Account and OTR profile model\n* Single place to update when\nlink:external/salesforce_crm.adoc[Salesforce] changes\n\n==== 2. Backend-for-Frontend (BFF)\n\n* ProfileService aggregates from multiple sources\n(link:external/salesforce_crm.adoc[Salesforce],\nEngagementService)\n* Provides unified profile API for mobile app and other services\n* Enriches canonical data with OTR-specific attributes\n\n==== 3. Hybrid Event/Batch Synchronization\n\n* Critical changes via domain events (real-time)\n* Comprehensive summaries via batch jobs (periodic)\n* Balances consistency needs with performance\n\n==== 4. Query-and-Enrich Pattern\n\n* Queries link:external/salesforce_crm.adoc[Salesforce]\nfor canonical customer data (real-time)\n* Enriches with OTR-specific attributes from local database\n* Returns unified CustomerProfileResponse\n* No local caching of\nlink:external/salesforce_crm.adoc[Salesforce] data\n(always fresh)\n","structuredPatch":[{"oldStart":44,"oldLines":12,"newStart":44,"newLines":28,"lines":[" "," === Responsibilities"," ","+**Core Capabilities (All Initiatives):**","+"," * OTR-specific customer profile management"," * Customer lifecycle stage and onboarding tracking","-* Partner linking status tracking","+* Engagement metrics caching for profile enrichment","+","+**Salesforce Customer Support (OTR-001):**","+","+* Just-In-Time Contact reconciliation with Salesforce Service Cloud","+* Contact ID resolution for feedback submission","+* Foundation for unified customer view across Viva Energy channels","+","+**Flybuys Integration (OTR-002):**","+","+* Partner linking status tracking (Flybuys, Shell Card)","+* Reward preference management (Flybuys Points, Fuel Discount, OTR Rewards)","+* OAuth partner account linking coordination","+","+**Future Capabilities:**","+"," * Customer risk assessment (fraud, refund, churn)"," * Refund history tracking","-* Engagement metrics caching for profile enrichment"," "," === Implementation Technology"," "]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"9b0e9a7c-24e7-405b-905c-93d09a7c167e"}
{"parentUuid":"989dee01-71e1-49ee-8a62-e419047a79c3","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_017EPxjcJrgovxc9jKetJQLZ","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Good! Now let me add a new architecture decision explaining how ProfileService supports both initiatives. I'll add this to the Architecture Decision Log section.","signature":"EsoCCkYICxgCKkCy7Z9vrHkBPMSr3Hp+RDaUrM+j8c46neDWWE+pF9Pui1J15f09Yf/FRtQG38dUZpziTAkcd+xRv1cXgv2oArbAEgwLUaSOuPeplJj0pPoaDG13BgnEvBJpk680rCIwFvWlLVW1T8CVyYyieLhYPm4b1VpcwiUWMmBOPbQ4GqN46NAwXdRmgP2XiulMxT+VKrEBWQY/bmYRx9mgonNtSmHYWkCB+ljrExdy5xSCxeWhcnRg7bDYh9ZP/3PsnFb0RXvskTjBxr3Qid5dIZ5H5LTH3l4iJxv+Q0t69RTbk2Q3EdsS8vNWBZMNrSaXc5hRwHQqfuUZ3gMPkvr66PD9mZUD1xKr2Qw35yYD/h23XpQi6HSIiUy4V/W2kfVJpIpvyDhtTKJ9WF11hI/d/Py1ODni/F0E+z15jIa+DiMJ5fjwSmwYGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":819,"cache_read_input_tokens":81286,"cache_creation":{"ephemeral_5m_input_tokens":819,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWwBQ7vNaUZiJYtEwwMZH","type":"assistant","uuid":"8477684e-a2d2-4abc-b965-0470a0b47037","timestamp":"2026-01-09T04:33:47.531Z"}
{"parentUuid":"8477684e-a2d2-4abc-b965-0470a0b47037","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_017EPxjcJrgovxc9jKetJQLZ","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01CrRHgtMnjj8VW45CaxFfri","name":"Edit","input":{"replace_all":false,"file_path":"/mnt/c/Users/o.young/work/architecture/bounded_context/profile.adoc","old_string":"=== Architecture Decision Log\n\n==== Decision 1: ProfileService Bridges link:external/salesforce_crm.adoc[Salesforce] and OTR Ecosystem","new_string":"=== Architecture Decision Log\n\n==== Decision 0: ProfileService as Foundation for Multiple Initiatives\n\n*Decision:* ProfileService is designed as a foundational bounded context supporting both xref:initiatives:salesforce_customer_support.adoc[OTR-001 (Salesforce Customer Support)] and xref:initiatives:flybuys_integration.adoc[OTR-002 (Flybuys Integration)] initiatives.\n\n*Rationale:*\n\n* Both initiatives require customer identity management\n* Both initiatives integrate with Salesforce (OTR-001 for Cases, OTR-002 for VCI)\n* ProfileService provides reusable capabilities across initiatives\n* Implementing ProfileService once reduces duplication and complexity\n* Establishes DDD architecture pattern for future bounded contexts\n\n*Capabilities per Initiative:*\n\n**Salesforce Customer Support (OTR-001):**\n\n* Just-In-Time Contact reconciliation (upsert by email)\n* Salesforce Contact ID resolution for feedback submission\n* Foundation for unified customer view\n* Enables Case creation with validated Contact IDs\n\n**Flybuys Integration (OTR-002):**\n\n* Partner account linking (Flybuys, Shell Card)\n* Reward preference tracking (Flybuys Points vs Fuel Discount)\n* OAuth token coordination with infrastructure OAuth Service\n* Enables Flybuys earning at POS\n\n*Implementation Approach:*\n\n* Core ProfileService aggregates support both use cases\n* `CustomerProfile` aggregate stores Salesforce VCI and OTR enrichment\n* `PartnerLink` aggregate (OTR-002) can be implemented independently\n* Salesforce integration (OTR-001) establishes VCI as customer identifier\n* Either initiative can deliver ProfileService first, other reuses foundation\n\n*Sequencing Flexibility:*\n\n* If OTR-001 first: ProfileService Contact reconciliation enables feedback, `PartnerLink` added later\n* If OTR-002 first: ProfileService partner linking enables Flybuys, Contact reconciliation added later\n* Both initiatives benefit from shared Salesforce integration patterns\n\n==== Decision 1: ProfileService Bridges link:external/salesforce_crm.adoc[Salesforce] and OTR Ecosystem"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":819,"cache_read_input_tokens":81286,"cache_creation":{"ephemeral_5m_input_tokens":819,"ephemeral_1h_input_tokens":0},"output_tokens":718,"service_tier":"standard"}},"requestId":"req_011CWwBQ7vNaUZiJYtEwwMZH","type":"assistant","uuid":"4dc1156b-20b1-45ff-9cbd-68e2d5a5c9ff","timestamp":"2026-01-09T04:33:58.167Z"}
{"parentUuid":"4dc1156b-20b1-45ff-9cbd-68e2d5a5c9ff","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01CrRHgtMnjj8VW45CaxFfri","type":"tool_result","content":"The file /mnt/c/Users/o.young/work/architecture/bounded_context/profile.adoc has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n   216→* More volatile than\n   217→link:external/salesforce_crm.adoc[Salesforce] (frequent\n   218→updates from app usage, transactions)\n   219→\n   220→=== Architecture Decision Log\n   221→\n   222→==== Decision 0: ProfileService as Foundation for Multiple Initiatives\n   223→\n   224→*Decision:* ProfileService is designed as a foundational bounded context supporting both xref:initiatives:salesforce_customer_support.adoc[OTR-001 (Salesforce Customer Support)] and xref:initiatives:flybuys_integration.adoc[OTR-002 (Flybuys Integration)] initiatives.\n   225→\n   226→*Rationale:*\n   227→\n   228→* Both initiatives require customer identity management\n   229→* Both initiatives integrate with Salesforce (OTR-001 for Cases, OTR-002 for VCI)\n   230→* ProfileService provides reusable capabilities across initiatives\n   231→* Implementing ProfileService once reduces duplication and complexity\n   232→* Establishes DDD architecture pattern for future bounded contexts\n   233→\n   234→*Capabilities per Initiative:*\n   235→\n   236→**Salesforce Customer Support (OTR-001):**\n   237→\n   238→* Just-In-Time Contact reconciliation (upsert by email)\n   239→* Salesforce Contact ID resolution for feedback submission\n   240→* Foundation for unified customer view\n   241→* Enables Case creation with validated Contact IDs\n   242→\n   243→**Flybuys Integration (OTR-002):**\n   244→\n   245→* Partner account linking (Flybuys, Shell Card)\n   246→* Reward preference tracking (Flybuys Points vs Fuel Discount)\n   247→* OAuth token coordination with infrastructure OAuth Service\n   248→* Enables Flybuys earning at POS\n   249→\n   250→*Implementation Approach:*\n   251→\n   252→* Core ProfileService aggregates support both use cases\n   253→* `CustomerProfile` aggregate stores Salesforce VCI and OTR enrichment\n   254→* `PartnerLink` aggregate (OTR-002) can be implemented independently\n   255→* Salesforce integration (OTR-001) establishes VCI as customer identifier\n   256→* Either initiative can deliver ProfileService first, other reuses foundation\n   257→\n   258→*Sequencing Flexibility:*\n   259→\n   260→* If OTR-001 first: ProfileService Contact reconciliation enables feedback, `PartnerLink` added later\n   261→* If OTR-002 first: ProfileService partner linking enables Flybuys, Contact reconciliation added later\n   262→* Both initiatives benefit from shared Salesforce integration patterns\n   263→\n   264→==== Decision 1: ProfileService Bridges link:external/salesforce_crm.adoc[Salesforce] and OTR Ecosystem\n   265→\n   266→*Decision:* ProfileService acts as an Anti-Corruption Layer between\n   267→link:external/salesforce_crm.adoc[Salesforce] (canonical\n   268→customer records) and OTR-specific profile data."}]},"uuid":"42af2f20-ec83-4113-8658-13a8dcf6d69a","timestamp":"2026-01-09T04:33:58.354Z","toolUseResult":{"filePath":"/mnt/c/Users/o.young/work/architecture/bounded_context/profile.adoc","oldString":"=== Architecture Decision Log\n\n==== Decision 1: ProfileService Bridges link:external/salesforce_crm.adoc[Salesforce] and OTR Ecosystem","newString":"=== Architecture Decision Log\n\n==== Decision 0: ProfileService as Foundation for Multiple Initiatives\n\n*Decision:* ProfileService is designed as a foundational bounded context supporting both xref:initiatives:salesforce_customer_support.adoc[OTR-001 (Salesforce Customer Support)] and xref:initiatives:flybuys_integration.adoc[OTR-002 (Flybuys Integration)] initiatives.\n\n*Rationale:*\n\n* Both initiatives require customer identity management\n* Both initiatives integrate with Salesforce (OTR-001 for Cases, OTR-002 for VCI)\n* ProfileService provides reusable capabilities across initiatives\n* Implementing ProfileService once reduces duplication and complexity\n* Establishes DDD architecture pattern for future bounded contexts\n\n*Capabilities per Initiative:*\n\n**Salesforce Customer Support (OTR-001):**\n\n* Just-In-Time Contact reconciliation (upsert by email)\n* Salesforce Contact ID resolution for feedback submission\n* Foundation for unified customer view\n* Enables Case creation with validated Contact IDs\n\n**Flybuys Integration (OTR-002):**\n\n* Partner account linking (Flybuys, Shell Card)\n* Reward preference tracking (Flybuys Points vs Fuel Discount)\n* OAuth token coordination with infrastructure OAuth Service\n* Enables Flybuys earning at POS\n\n*Implementation Approach:*\n\n* Core ProfileService aggregates support both use cases\n* `CustomerProfile` aggregate stores Salesforce VCI and OTR enrichment\n* `PartnerLink` aggregate (OTR-002) can be implemented independently\n* Salesforce integration (OTR-001) establishes VCI as customer identifier\n* Either initiative can deliver ProfileService first, other reuses foundation\n\n*Sequencing Flexibility:*\n\n* If OTR-001 first: ProfileService Contact reconciliation enables feedback, `PartnerLink` added later\n* If OTR-002 first: ProfileService partner linking enables Flybuys, Contact reconciliation added later\n* Both initiatives benefit from shared Salesforce integration patterns\n\n==== Decision 1: ProfileService Bridges link:external/salesforce_crm.adoc[Salesforce] and OTR Ecosystem","originalFile":"= Profile Bounded Context\nO.Young@otr.com.au\nv0.1, 2025-12-19\n:project-name: OTRG Apps & Ecommerce Architecture\n:togaf-adm-phase: Phase C: Information Systems Architectures\n:document-type: Bounded Context\n:status: Draft\n:version: 0.1\n:domain: Profile\n:bounded-context-type: APPLICATION\n:domain-architect: O.Young@otr.com.au\n:doctype: article\n:toc: left\n:toclevels: 4\n:sectanchors:\n:sectlinks:\n:sectnums:\n:icons: font\n:source-highlighter: highlightjs\n:experimental:\n:description: Bounded Context for the Profile Domain\n:keywords: profile, customer, bounded context, togaf, ddd\n\n== ProfileService\n\nUnified customer profile service providing enriched customer data for\nOTRG ecosystem.\n\n=== Related Initiatives\n\nProfileService is a foundational bounded context supporting multiple strategic initiatives:\n\n* **xref:initiatives:salesforce_customer_support.adoc[OTR-001 Salesforce Customer Support]**: Provides Just-In-Time Contact reconciliation with Salesforce Service Cloud\n* **xref:initiatives:flybuys_integration.adoc[OTR-002 Flybuys Integration]**: Manages customer partner account linking (Flybuys, Shell) and reward preference tracking\n\nNOTE: These initiatives are the first implementations of OTR's Domain-Driven Design (DDD) architecture. Depending on sequencing, ProfileService capabilities may be delivered incrementally across either initiative.\n\n=== Domain Vision Statement\n\nProvide unified, enriched customer profiles bridging\nlink:external/salesforce_crm.adoc[Salesforce] canonical\ndata with OTRG-specific attributes, behavioral insights, and risk\nassessments.\n\n=== Responsibilities\n\n**Core Capabilities (All Initiatives):**\n\n* OTR-specific customer profile management\n* Customer lifecycle stage and onboarding tracking\n* Engagement metrics caching for profile enrichment\n\n**Salesforce Customer Support (OTR-001):**\n\n* Just-In-Time Contact reconciliation with Salesforce Service Cloud\n* Contact ID resolution for feedback submission\n* Foundation for unified customer view across Viva Energy channels\n\n**Flybuys Integration (OTR-002):**\n\n* Partner linking status tracking (Flybuys, Shell Card)\n* Reward preference management (Flybuys Points, Fuel Discount, OTR Rewards)\n* OAuth partner account linking coordination\n\n**Future Capabilities:**\n\n* Customer risk assessment (fraud, refund, churn)\n* Refund history tracking\n\n=== Implementation Technology\n\nAzure Functions, .NET Core, Azure SQL,\nlink:external/salesforce_crm.adoc[Salesforce] API,\nlink:interfaces/[Event Bus]\n\n=== What This Service Owns\n\nProfileService owns OTR-specific enrichment data and bridges\nlink:external/salesforce_crm.adoc[Salesforce] canonical\ncustomer records.\n\n==== Core Aggregates\n\n[width=\"100%\",cols=\"9%,91%\",options=\"header\",]\n|===\n|Aggregate Name |Description\n|`CustomerProfile` |OTRG-specific Customer profile attributes enriching\nlink:external/salesforce_crm.adoc[Salesforce] canonical\ndata. Stores behavioural data, preferences, and app-specific attributes.\n\n|`PartnerLink` |Securely connects Customers’ OTRG accounts to external\npartner services (like Flybuys and Shell) using industry-standard\nauthentication. Manages the connection status and customer preferences.\n\n|`RiskAssessment` |Customer risk, fraud, and value scores for instant\nrefund decisions. Provides both computed scores and raw factors for\ntransparency.\n\n|`RefundHistory` |Customer refund transaction history for risk\nassessment. Tracks refund requests, processing, and outcomes.\n|===\n\n==== NOT in this Context (Owned by Other Systems)\n\n[width=\"100%\",cols=\"26%,65%,9%\",options=\"header\",]\n|===\n|Action / Entity |Description |Relationship\n|Canonical Customer data |Name, email, phone →\nlink:external/salesforce_crm.adoc[Salesforce] CRM |HTTPS\nAPI\n\n|Viva Consumer ID (VCI) generation |Customer identifier generation →\nlink:external/salesforce_crm.adoc[Salesforce] CRM |HTTPS\nAPI\n\n|Marketing communication preferences |Communication preferences → Braze\n(via EngagementService) |Event Bus\n\n|Loyalty status |Points, tiers, wallet → EagleEye (via LoyaltyService)\n|Event Bus\n\n|Transaction details |Full transaction data → D365 Commerce (POS\nContext) |Event Bus\n\n|Reward transaction adjudication |Transaction reward processing →\nLoyaltyService |HTTPS API\n\n|OAuth tokens |OAuth token management → OAuth Service (Infrastructure)\n|Infrastructure\n|===\n\n=== Domain Events\n\n==== Profile Lifecycle Events\n\n* *ProfileCreated*: New customer profile created\n* *ProfileUpdated*: Customer profile information updated\n* *ProfileVerificationChanged*: Profile verification status changed\n(email/phone verification)\n* *ProfileCompletenessChanged*: Profile completeness score changed\n(0-100)\n* *LifeCycleStageChanged*: Customer lifecycle stage changed (PROSPECT →\nNEW → ACTIVE → DORMANT → AT_RISK → CHURNED)\n* *OnboardingCompleted*: Customer completed onboarding flow\n* *OnboardingProgressUpdated*: Customer progressed through onboarding\nsteps\n\n==== Partner Linking Events (Moved from LoyaltyService)\n\n* *PartnerLinked*: Customer linked external partner account (Flybuys,\nShell)\n* *PartnerUnlinked*: Customer unlinked external partner account\n* *PartnerLinkChanged*: Partner link status changed (LINKED →\nSYNC_FAILED → UNLINKED)\n* *RewardPreferenceChanged*: Customer changed reward program preference\n(FLYBUYS_POINTS, FUEL_DISCOUNT_SHELL, OTR_REWARDS)\n\n==== Risk Assessment Events\n\n* *RiskStatusChanged*: Customer risk status changed (LOW → MEDIUM → HIGH\n→ CRITICAL)\n* *FraudIndicatorDetected*: Potential fraud indicator detected (multiple\naccounts, chargeback pattern, login anomaly, etc.)\n\n==== Refund History Events\n\n* *RefundRequested*: Customer requested refund\n* *RefundProcessed*: Refund processed and completed\n\n=== Key Services\n\n[width=\"100%\",cols=\"19%,81%\",options=\"header\",]\n|===\n|Service Name |Description\n|`ProfileQueryService` |Query customer profile\n(link:external/salesforce_crm.adoc[Salesforce] canonical\n+ OTR enrichment), profile completeness, partner links\n\n|`RiskAssessmentService` |Get comprehensive risk assessment (scores +\nraw factors), calculate risk scores, fraud/refund/churn risk queries\n\n|`RefundHistoryService` |Query refund history, record new refund\nrequests, calculate refund statistics\n\n|`PartnerLinkService` |Create partner link, update reward preference,\nsync with partner, revoke partner link\n\n|`EngagementSyncService` |Update cached engagement summary from\nEngagementService, get cached engagement summary\n\n|`[Salesforce](external/salesforce_crm.adoc)ProfileAdapter`\n|ACL for link:external/salesforce_crm.adoc[Salesforce]\nintegration - query canonical customer data, resolve email to VCI,\nvalidate VCI\n|===\n\n=== Integration Points\n\n* *Upstream*:\nlink:external/salesforce_crm.adoc[Salesforce] (canonical\ncustomer data), EngagementService (engagement metrics)\n* *Downstream*: LoyaltyService, EngagementService, RefundService\n(future)\n* *Bidirectional*: EngagementService (profile enrichment ↔ engagement\nsummaries)\n\n=== Bounded Context Boundaries\n\n* ProfileService enriches\nlink:external/salesforce_crm.adoc[Salesforce] canonical\ndata with OTR-specific attributes\n* link:external/salesforce_crm.adoc[Salesforce] is system\nof record for customer identity and core contact details\n* ProfileService is system of record for OTR-specific behavior and risk\ndata\n* More volatile than\nlink:external/salesforce_crm.adoc[Salesforce] (frequent\nupdates from app usage, transactions)\n\n=== Architecture Decision Log\n\n==== Decision 1: ProfileService Bridges link:external/salesforce_crm.adoc[Salesforce] and OTR Ecosystem\n\n*Decision:* ProfileService acts as an Anti-Corruption Layer between\nlink:external/salesforce_crm.adoc[Salesforce] (canonical\ncustomer records) and OTR-specific profile data.\n\n*Rationale:*\n\n* link:external/salesforce_crm.adoc[Salesforce] owns\ncanonical customer identity (VCI, name, email, phone)\n* OTR App Database contains richer OTR-specific profile data\n* Admin portal currently operates independently from\nlink:external/salesforce_crm.adoc[Salesforce]\n* ProfileService evolves existing OTR App database to bridge both\nsystems\n* VCI will be introduced through Flybuys initiative\n\n*Current State:*\n\n* OTR App Database → Admin Portal (email-keyed, no VCI)\n* link:external/salesforce_crm.adoc[Salesforce] → Viva\nbrands (VCI-keyed)\n* No connection between systems\n\n*Future State:*\n\n* ProfileService stores OTR-specific enrichment with VCI\n* Queries link:external/salesforce_crm.adoc[Salesforce]\nfor canonical customer data\n* Admin portal enhanced to use VCI\n* External systems (EagleEye, Braze) keyed by VCI\n\n*Implementation:*\n\n* ProfileService stores OTR-specific attributes with VCI reference\n* Synchronous queries to\nlink:external/salesforce_crm.adoc[Salesforce] for\ncanonical customer data\n* Customer-Supplier (Conformist) pattern with\nlink:external/salesforce_crm.adoc[Salesforce]\n* ProfileService owns OTR enrichment,\nlink:external/salesforce_crm.adoc[Salesforce] owns\nidentity\n\n==== Decision 2: Risk Assessment for Instant Refunds\n\n*Decision:* ProfileService provides scored risk assessment and raw\nfactors to enable instant refund decisions by other business units.\n\n*Rationale:*\n\n* Current refund turnaround is 15 days due to poor workflows\n* Target: Immediate refunds for right customers based on risk profile\n* Risk profile = loyalty + fraud + behavioral factors\n* ProfileService doesn’t process refunds, just provides assessment\n\n*Risk Assessment Factors:*\n\n*ProfileService Owned:*\n\n* Refund history (count, frequency, amounts, reasons)\n* Transaction behavior (frequency, recency, transaction value)\n* Account health (tenure, verification status)\n* Fraud indicators (disputes, chargebacks, anomalies)\n* Engagement metrics (app usage, support interactions)\n* Customer value (lifetime value, profitability)\n\n*Aggregated from Other Services:*\n\n* Loyalty tier/status → LoyaltyService\n\n*API Design:*\n\n* Provides both computed risk score AND raw factors\n* Enables other business units to apply their own scoring logic\n* Transparency for audit and debugging\n\n*Implementation:*\n\n* RiskAssessment aggregate calculates scores\n* REST API endpoint: GET /profiles/\\{vci}/risk-assessment\n* Admin portal can display for customer service agents\n* Future: RefundService orchestrates instant refund decisions\n\n==== Decision 3: PartnerLink Aggregate Moved from LoyaltyService\n\n*Decision:* PartnerLink aggregate moved from LoyaltyService to\nProfileService.\n\n*Rationale:*\n\n* Partner linking is customer profile data, not loyalty transaction data\n* ProfileService is natural home for customer relationships\n* Reduces LoyaltyService complexity to single aggregate\n(RewardTransaction)\n\n*Migration Impact:*\n\n* LoyaltyService queries ProfileService synchronously for partner link\nstatus\n* Pattern: GET /profiles/\\{vci}/partner-links\n* Similar to how LoyaltyService queries EagleEye (real-time\norchestration)\n\n*Implementation:*\n\n* PartnerLink aggregate tracks linking status and reward preference\n* OAuth tokens managed by infrastructure OAuth Service (not in\naggregate)\n* ProfileService publishes PartnerLinked/PartnerUnlinked events\n* LoyaltyService consumes events for auditing/analytics\n\n==== Decision 4: Bidirectional Integration with EngagementService\n\n*Decision:* ProfileService and EngagementService have bidirectional\nintegration with hybrid event/batch synchronization pattern.\n\n*Rationale:*\n\n* Both services need data from each other\n* Each maintains system of record status for their domain\n* Eventual consistency acceptable (not real-time)\n* Strong event-based architecture with pragmatic batching\n\n*ProfileService → EngagementService (for segmentation/targeting):*\n\n* Events: ProfileCreated, ProfileUpdated, PartnerLinkChanged,\nRiskStatusChanged\n* Batch: Daily profile enrichment (risk scores, profile completeness)\n* Use case: Campaign targeting, segmentation\n\n*EngagementService → ProfileService (for profile enrichment):*\n\n* Events: EngagementTierChanged (highly engaged → disengaged)\n* Batch: Daily engagement score rollup (click rates, app usage\nsummaries)\n* Use case: Risk assessment, profile completeness\n\n*Each Service is System of Record:*\n\n* EngagementService owns: Campaign interactions, notification\npreferences\n* ProfileService owns: Customer attributes, risk scores, partner links\n\n*Implementation:*\n\n* Open Host Service + Published Language pattern (both directions)\n* Event Bus for real-time critical changes\n* Scheduled batch jobs for comprehensive summaries\n* Cached summaries stored locally (eventual consistency)\n\n==== Decision 5: ProfileService More Volatile Than link:external/salesforce_crm.adoc[Salesforce]\n\n*Decision:* ProfileService updates more frequently than\nlink:external/salesforce_crm.adoc[Salesforce] because it\ntracks behavioral and transactional data.\n\n*Rationale:*\n\n* link:external/salesforce_crm.adoc[Salesforce]:\nCanonical customer data changes infrequently (name, email)\n* ProfileService: Behavioral data changes constantly (app usage,\ntransactions)\n* ProfileService optimized for high-frequency updates\n* link:external/salesforce_crm.adoc[Salesforce] optimized\nfor identity and contact management\n\n*Volatility Comparison:*\n\n* link:external/salesforce_crm.adoc[Salesforce] updates:\nCustomer changes email, phone, address (infrequent)\n* ProfileService updates: Every transaction, login, app interaction\n(frequent)\n\n*Implementation:*\n\n* ProfileService database optimized for write-heavy workload\n* link:external/salesforce_crm.adoc[Salesforce] sync\nhandles identity changes only\n* No need for ProfileService to push behavioral data to\nlink:external/salesforce_crm.adoc[Salesforce]\n* ProfileService is authoritative for OTR behavioral data\n\n==== Decision 6: Synchronous Integration from LoyaltyService\n\n*Decision:* LoyaltyService queries ProfileService synchronously for\npartner link status during transaction adjudication.\n\n*Rationale:*\n\n* Transaction adjudication needs current partner status\n* Real-time query ensures accuracy\n* Similar pattern to LoyaltyService querying EagleEye\n* No local caching complexity\n\n*Flow:*\n\n[arabic]\n. Transaction adjudication request arrives at LoyaltyService\n. LoyaltyService queries ProfileService: GET\n/profiles/\\{vci}/partner-links\n. ProfileService returns partner linking status\n. LoyaltyService uses status for reward calculation\n. Transaction adjudication completes\n\n*Implementation:*\n\n* REST API for partner link queries\n* Low latency required (<100ms)\n* Circuit breaker pattern for resilience\n* Fallback to default (OTR Rewards) if ProfileService unavailable\n\n=== Key Architectural Patterns\n\n==== 1. Anti-Corruption Layer (ACL)\n\n* link:external/salesforce_crm.adoc[Salesforce]ProfileAdapter:\nProtects domain from\nlink:external/salesforce_crm.adoc[Salesforce] API changes\n* Translates between\nlink:external/salesforce_crm.adoc[Salesforce]\nContact/Person Account and OTR profile model\n* Single place to update when\nlink:external/salesforce_crm.adoc[Salesforce] changes\n\n==== 2. Backend-for-Frontend (BFF)\n\n* ProfileService aggregates from multiple sources\n(link:external/salesforce_crm.adoc[Salesforce],\nEngagementService)\n* Provides unified profile API for mobile app and other services\n* Enriches canonical data with OTR-specific attributes\n\n==== 3. Hybrid Event/Batch Synchronization\n\n* Critical changes via domain events (real-time)\n* Comprehensive summaries via batch jobs (periodic)\n* Balances consistency needs with performance\n\n==== 4. Query-and-Enrich Pattern\n\n* Queries link:external/salesforce_crm.adoc[Salesforce]\nfor canonical customer data (real-time)\n* Enriches with OTR-specific attributes from local database\n* Returns unified CustomerProfileResponse\n* No local caching of\nlink:external/salesforce_crm.adoc[Salesforce] data\n(always fresh)\n","structuredPatch":[{"oldStart":219,"oldLines":6,"newStart":219,"newLines":48,"lines":[" "," === Architecture Decision Log"," ","+==== Decision 0: ProfileService as Foundation for Multiple Initiatives","+","+*Decision:* ProfileService is designed as a foundational bounded context supporting both xref:initiatives:salesforce_customer_support.adoc[OTR-001 (Salesforce Customer Support)] and xref:initiatives:flybuys_integration.adoc[OTR-002 (Flybuys Integration)] initiatives.","+","+*Rationale:*","+","+* Both initiatives require customer identity management","+* Both initiatives integrate with Salesforce (OTR-001 for Cases, OTR-002 for VCI)","+* ProfileService provides reusable capabilities across initiatives","+* Implementing ProfileService once reduces duplication and complexity","+* Establishes DDD architecture pattern for future bounded contexts","+","+*Capabilities per Initiative:*","+","+**Salesforce Customer Support (OTR-001):**","+","+* Just-In-Time Contact reconciliation (upsert by email)","+* Salesforce Contact ID resolution for feedback submission","+* Foundation for unified customer view","+* Enables Case creation with validated Contact IDs","+","+**Flybuys Integration (OTR-002):**","+","+* Partner account linking (Flybuys, Shell Card)","+* Reward preference tracking (Flybuys Points vs Fuel Discount)","+* OAuth token coordination with infrastructure OAuth Service","+* Enables Flybuys earning at POS","+","+*Implementation Approach:*","+","+* Core ProfileService aggregates support both use cases","+* `CustomerProfile` aggregate stores Salesforce VCI and OTR enrichment","+* `PartnerLink` aggregate (OTR-002) can be implemented independently","+* Salesforce integration (OTR-001) establishes VCI as customer identifier","+* Either initiative can deliver ProfileService first, other reuses foundation","+","+*Sequencing Flexibility:*","+","+* If OTR-001 first: ProfileService Contact reconciliation enables feedback, `PartnerLink` added later","+* If OTR-002 first: ProfileService partner linking enables Flybuys, Contact reconciliation added later","+* Both initiatives benefit from shared Salesforce integration patterns","+"," ==== Decision 1: ProfileService Bridges link:external/salesforce_crm.adoc[Salesforce] and OTR Ecosystem"," "," *Decision:* ProfileService acts as an Anti-Corruption Layer between"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"4dc1156b-20b1-45ff-9cbd-68e2d5a5c9ff"}
{"parentUuid":"42af2f20-ec83-4113-8658-13a8dcf6d69a","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01WW6Kc7ttqiZJzkSmTbqR6X","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Good! Now let me update the CML file header to reference the initiatives and ensure consistency.","signature":"EogCCkYICxgCKkCWbNSx4GEIOyXzDBhts3cMfW78LHDyvNOukglj4q9bY/Hwn7LiOvxMP7Zdw9QT5YnOSN/+Y6J7tbrzkJFIAyT4Egzzeu7H++mb8drzRoYaDByNC9vfHmi+JOqBcSIwggYUQ2CLwFcfhAODvg5A1SnjQ6tNz3CWPJCNeKEllJCbtSoiRpFgVwdL+oPj/EERKnCmtDqJ8xJLHDjeIol6AwBBFAbEtq0yB7gjTNyLKodeu8XfXCGdWYSbNOFEG3IPnVjCl4ZLYLXwutpWnZsfjIVIrU8rkkfvI47KKvYortQJ2ikgkt81sI3A8TGD+GOdgSf/jaKbgyAA5ZQQnQ+HhawPGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":1555,"cache_read_input_tokens":82105,"cache_creation":{"ephemeral_5m_input_tokens":1555,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWwBREo9NsoWvKPi9SgJL","type":"assistant","uuid":"1f2bf99d-65ae-43de-a147-97608bbc8b45","timestamp":"2026-01-09T04:34:02.683Z"}
{"parentUuid":"1f2bf99d-65ae-43de-a147-97608bbc8b45","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01WW6Kc7ttqiZJzkSmTbqR6X","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01K6shV1H31XSuhnFxtFSVcZ","name":"TodoWrite","input":{"todos":[{"content":"Add initiative context to ProfileService documentation header","activeForm":"Adding initiative context to header","status":"completed"},{"content":"Update profile.adoc to reference both OTR-001 and OTR-002 initiatives","activeForm":"Updating initiative references","status":"completed"},{"content":"Add architecture decision about dual initiative support","activeForm":"Adding dual initiative decision","status":"completed"},{"content":"Update CML file header to reference initiatives","activeForm":"Updating CML header","status":"in_progress"},{"content":"Ensure consistency between CML and markdown files","activeForm":"Ensuring CML/markdown consistency","status":"pending"}]}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":1555,"cache_read_input_tokens":82105,"cache_creation":{"ephemeral_5m_input_tokens":1555,"ephemeral_1h_input_tokens":0},"output_tokens":250,"service_tier":"standard"}},"requestId":"req_011CWwBREo9NsoWvKPi9SgJL","type":"assistant","uuid":"07855c78-de6d-4d18-a008-420ada0747b5","timestamp":"2026-01-09T04:34:04.500Z"}
{"parentUuid":"07855c78-de6d-4d18-a008-420ada0747b5","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01K6shV1H31XSuhnFxtFSVcZ","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"uuid":"24049958-5b29-4764-9626-7a9ca1668778","timestamp":"2026-01-09T04:34:04.557Z","toolUseResult":{"oldTodos":[{"content":"Add initiative context to ProfileService documentation header","status":"completed","activeForm":"Adding initiative context to header"},{"content":"Update profile.adoc to reference both OTR-001 and OTR-002 initiatives","status":"in_progress","activeForm":"Updating initiative references"},{"content":"Add architecture decision about dual initiative support","status":"pending","activeForm":"Adding dual initiative decision"},{"content":"Update CML file header to reference initiatives","status":"pending","activeForm":"Updating CML header"},{"content":"Ensure consistency between CML and markdown files","status":"pending","activeForm":"Ensuring CML/markdown consistency"}],"newTodos":[{"content":"Add initiative context to ProfileService documentation header","status":"completed","activeForm":"Adding initiative context to header"},{"content":"Update profile.adoc to reference both OTR-001 and OTR-002 initiatives","status":"completed","activeForm":"Updating initiative references"},{"content":"Add architecture decision about dual initiative support","status":"completed","activeForm":"Adding dual initiative decision"},{"content":"Update CML file header to reference initiatives","status":"in_progress","activeForm":"Updating CML header"},{"content":"Ensure consistency between CML and markdown files","status":"pending","activeForm":"Ensuring CML/markdown consistency"}]},"sourceToolAssistantUUID":"07855c78-de6d-4d18-a008-420ada0747b5"}
{"parentUuid":"24049958-5b29-4764-9626-7a9ca1668778","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01TzftR71kMH93nqGyU1zj5y","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now let me update the CML file header to reference both initiatives and provide context about which aggregates support which initiatives.","signature":"ErICCkYICxgCKkD6ABCQCNzdlI2CsCCFajz9dI5H0mMo90UYifiisQTUt3SBm4JxnfWtEahnkZ0BiA8t3vRGjcyUOUrGmZktHJYJEgyy/pBoxD0WzIFCB14aDGBkAjN6Ea4X5A0BEiIwYk8hSHsGZldqt5GniiqoMuHbs3GbagthUSlLKTIFpwX4eEXP8RTVuwrKwglk925JKpkBZVluM1OqbC8aKatOYGjWQ4hDdtox1VR25jHoAm/mUlLeWU9rshByRsC/pgQ7emNlDmeW/yuw5KStTDjTuF/1JeSvJRAd9pCJ6A6zNbuvi53OGmG8o2xN2kbMjOU+UPK8Vs/MRa1kvfupMwB47Gx5PIVxo+H14BdJw1BtjzR2kjHj+ePS1xQMgt8kEbIOa7V6x4U6TYK+WOAkGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":299,"cache_read_input_tokens":83660,"cache_creation":{"ephemeral_5m_input_tokens":299,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWwBRh2UFrvsMJ3gEBjRU","type":"assistant","uuid":"64bb9cf1-c685-4a5d-9c9c-82c149e55dda","timestamp":"2026-01-09T04:34:08.624Z"}
{"parentUuid":"64bb9cf1-c685-4a5d-9c9c-82c149e55dda","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01TzftR71kMH93nqGyU1zj5y","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01WcvUL4cmaUDW3TrYYVT7ar","name":"Edit","input":{"replace_all":false,"file_path":"/mnt/c/Users/o.young/work/architecture/bounded_context/profile.cml","old_string":"/*\n * ProfileService - Bounded Context Definition\n * ============================================\n *\n * Unified customer profile service providing enriched customer data for OTR ecosystem.\n *\n * See profile.adoc for comprehensive architecture documentation, decision log, and patterns.\n */","new_string":"/*\n * ProfileService - Bounded Context Definition\n * ============================================\n *\n * Unified customer profile service providing enriched customer data for OTR ecosystem.\n *\n * RELATED INITIATIVES:\n * - OTR-001 Salesforce Customer Support: Just-In-Time Contact reconciliation with Salesforce\n * - OTR-002 Flybuys Integration: Partner account linking and reward preference management\n *\n * NOTE: ProfileService is a foundational bounded context supporting multiple strategic initiatives.\n * Depending on sequencing, capabilities may be delivered incrementally across either initiative.\n *\n * See profile.adoc for comprehensive architecture documentation, decision log, and patterns.\n */"}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":299,"cache_read_input_tokens":83660,"cache_creation":{"ephemeral_5m_input_tokens":299,"ephemeral_1h_input_tokens":0},"output_tokens":393,"service_tier":"standard"}},"requestId":"req_011CWwBRh2UFrvsMJ3gEBjRU","type":"assistant","uuid":"497f4211-d145-4d91-9c86-671d23be1d1d","timestamp":"2026-01-09T04:34:12.465Z"}
{"type":"file-history-snapshot","messageId":"497f4211-d145-4d91-9c86-671d23be1d1d","snapshot":{"messageId":"11c8d3b8-b207-4c56-b1d0-c8c534dd4233","trackedFileBackups":{"solution_architectures/salesforce_customer_support.adoc":{"backupFileName":"ef19bf3282a777f7@v2","version":2,"backupTime":"2026-01-09T03:13:31.966Z"},"bounded_context/profile.adoc":{"backupFileName":"5794d0bd8cc1c5d2@v1","version":1,"backupTime":"2026-01-09T04:33:27.418Z"},"bounded_context/profile.cml":{"backupFileName":"082a4df2066ba3ba@v1","version":1,"backupTime":"2026-01-09T04:34:12.695Z"}},"timestamp":"2026-01-09T04:32:33.163Z"},"isSnapshotUpdate":true}
{"parentUuid":"497f4211-d145-4d91-9c86-671d23be1d1d","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01WcvUL4cmaUDW3TrYYVT7ar","type":"tool_result","content":"The file /mnt/c/Users/o.young/work/architecture/bounded_context/profile.cml has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n     1→/*\n     2→ * ProfileService - Bounded Context Definition\n     3→ * ============================================\n     4→ *\n     5→ * Unified customer profile service providing enriched customer data for OTR ecosystem.\n     6→ *\n     7→ * RELATED INITIATIVES:\n     8→ * - OTR-001 Salesforce Customer Support: Just-In-Time Contact reconciliation with Salesforce\n     9→ * - OTR-002 Flybuys Integration: Partner account linking and reward preference management\n    10→ *\n    11→ * NOTE: ProfileService is a foundational bounded context supporting multiple strategic initiatives.\n    12→ * Depending on sequencing, capabilities may be delivered incrementally across either initiative.\n    13→ *\n    14→ * See profile.adoc for comprehensive architecture documentation, decision log, and patterns.\n    15→ */\n    16→\n    17→import \"../domains/profile.cml\"\n    18→\n    19→BoundedContext ProfileService implements ProfileDomain {"}]},"uuid":"d0583817-e29f-4a84-a8f1-0b7aaaf68233","timestamp":"2026-01-09T04:34:12.653Z","toolUseResult":{"filePath":"/mnt/c/Users/o.young/work/architecture/bounded_context/profile.cml","oldString":"/*\n * ProfileService - Bounded Context Definition\n * ============================================\n *\n * Unified customer profile service providing enriched customer data for OTR ecosystem.\n *\n * See profile.adoc for comprehensive architecture documentation, decision log, and patterns.\n */","newString":"/*\n * ProfileService - Bounded Context Definition\n * ============================================\n *\n * Unified customer profile service providing enriched customer data for OTR ecosystem.\n *\n * RELATED INITIATIVES:\n * - OTR-001 Salesforce Customer Support: Just-In-Time Contact reconciliation with Salesforce\n * - OTR-002 Flybuys Integration: Partner account linking and reward preference management\n *\n * NOTE: ProfileService is a foundational bounded context supporting multiple strategic initiatives.\n * Depending on sequencing, capabilities may be delivered incrementally across either initiative.\n *\n * See profile.adoc for comprehensive architecture documentation, decision log, and patterns.\n */","originalFile":"/*\n * ProfileService - Bounded Context Definition\n * ============================================\n *\n * Unified customer profile service providing enriched customer data for OTR ecosystem.\n *\n * See profile.adoc for comprehensive architecture documentation, decision log, and patterns.\n */\n\nimport \"../domains/profile.cml\"\n\nBoundedContext ProfileService implements ProfileDomain {\n\n    type = APPLICATION\n\n    // Strategic DDD Classification: CORE_DOMAIN | SUPPORTING_DOMAIN | GENERIC_DOMAIN\n    // CORE_DOMAIN: Competitive differentiator - customer intelligence, risk assessment, and behavioral\n    // insights drive personalization and business outcomes\n    strategicClassification = \"CORE_DOMAIN\"\n\n    domainVisionStatement = \"Provide unified, enriched customer profiles bridging Salesforce canonical data with OTR-specific attributes, behavioral insights, and risk assessments\"\n\n    responsibilities = \"OTRG-specific customer profile management\",\n                      \"Customer lifecycle stage and onboarding tracking\",\n                      \"Partner linking status tracking\",\n                      \"Customer risk assessment (fraud, refund, churn)\",\n                      \"Refund history tracking\",\n                      \"Engagement metrics caching for profile enrichment\"\n\n    implementationTechnology = \"Azure Functions, .NET Core, Azure SQL, Salesforce API, Event Bus\"\n\n    // ========================================================================\n    // SECTION 1: CORE AGGREGATES\n    // ========================================================================\n    // Aggregates represent transactional consistency boundaries.\n    // Each aggregate root controls access to entities within its boundary.\n    // ========================================================================\n\n    // 1.1 CustomerProfile Aggregate\n    // ------------------------------\n    // OTR-specific customer profile attributes enriching Salesforce canonical data.\n    // Stores behavioral data, preferences, and app-specific attributes.\n    //\n    // Invariants:\n    // - Must have valid VCI reference to Salesforce\n    // - Email verification status must be tracked\n    // - Account status must be valid enum value\n    // - Profile completeness score must be 0-100\n    // - Onboarding completion percentage must be 0-100\n    // - lifecycle stage must be valid enum value\n    //\n    // Bounded Context Note:\n    // - Canonical customer data (name, email, phone) owned by Salesforce\n    // - ProfileService stores OTR-specific enrichment only\n    // - Queries Salesforce for canonical data, does not cache it\n    Aggregate CustomerProfile {\n        Entity CustomerProfileRecord {\n            aggregateRoot\n\n            - ProfileId id\n            - String VivaConsumerId           // Salesforce customer identifier (VCI)\n            - AccountStatus status\n            - DateTime createdAt\n            - DateTime lastUpdatedAt\n            - DateTime lastLoginAt\n\n            // Identity Verification\n            - IdentityVerification verification\n\n            // App Preferences\n            - AppPreferences appPreferences\n\n            // Profile Completeness\n            - int completenessScore          // 0-100 calculated score\n\n            // Customer lifecycle\n            - LifeCycleStage lifeCycleStage  // PROSPECT | NEW | ACTIVE | DORMANT | AT_RISK | CHURNED\n            - DateTime lifeCycleChangedAt\n\n            // Onboarding Progress\n            - OnboardingStatus onboardingStatus\n            - int onboardingCompletionPercentage  // 0-100\n            - DateTime onboardingCompletedAt\n\n            // Customer Value\n            - CustomerValue valueMetrics\n\n            // Special Handling\n            - boolean isStaffMember          // Employee customer flag\n\n            // Operations\n            def updateLastLogin(): void\n            def calculateCompletenessScore(): int\n            def updateLifeCycleStage(newStage: LifeCycleStage): void\n            def updateOnboardingProgress(percentage: int): void\n        }\n\n        ValueObject IdentityVerification {\n            - boolean emailVerified\n            - boolean phoneVerified\n            - VerificationLevel level        // UNVERIFIED | BASIC | FULL\n            - DateTime lastVerifiedAt\n        }\n\n        ValueObject AppPreferences {\n            - String preferredStore\n            - String languagePreference      // ISO 639-1 code (en, zh, vi, etc.)\n            - boolean pushNotificationsEnabled\n            - boolean locationServicesEnabled\n            - String preferredPaymentMethod\n            - Map<String, String> customPreferences\n        }\n\n        ValueObject CustomerValue {\n            - Money lifetimeValue\n            - Money totalSpend\n            - int transactionCount\n            - Money averageBasketValue\n            - DateTime firstPurchaseDate\n            - ProfitabilityScore profitability\n        }\n\n        enum VerificationLevel {\n            UNVERIFIED,                      // No verification\n            BASIC,                           // Email or phone verified\n            FULL                             // Multiple factors verified\n        }\n\n        enum ProfitabilityScore {\n            LOW, MEDIUM, HIGH, VIP\n        }\n\n        enum LifeCycleStage {\n            PROSPECT,                        // Registered but no purchase\n            NEW,                             // First purchase within 90 days\n            ACTIVE,                          // Regular transactions\n            DORMANT,                         // No transactions 90+ days\n            AT_RISK,                         // Declining engagement/transactions\n            CHURNED                          // No transactions 180+ days\n        }\n\n        enum OnboardingStatus {\n            NOT_STARTED,                     // Account created, onboarding not begun\n            IN_PROGRESS,                     // Onboarding steps partially complete\n            COMPLETED,                       // All onboarding steps finished\n            SKIPPED                          // User skipped onboarding flow\n        }\n    }\n\n    // 1.2 PartnerLink Aggregate\n    // ------------------------------------------------------\n    // Records customer linkages to external loyalty partners (Flybuys, Shell).\n    // Tracks linking status and synchronization state for partner integrations.\n    //\n    // Invariants:\n    // - Customer can only have one active link per partner type\n    // - External member ID must be unique within partner\n    // - Reward preference must be one of: FLYBUYS_POINTS, FUEL_DISCOUNT_SHELL, OTR_REWARDS\n    // - If preference is FLYBUYS_POINTS, PartnerLink must exist with status=LINKED\n    // - Default preference when no partner linked: OTR_REWARDS (fallback)\n    //\n    // Bounded Context Note:\n    // - OAuth tokens are managed by infrastructure OAuth Service\n    // - This aggregate tracks: \"customer linked partner account\"\n    // - Created in response to OAuthLinkEstablished event from OAuth Service\n    Aggregate PartnerLink {\n        Entity CustomerPartnerLink {\n            aggregateRoot\n\n            - PartnerLinkId id\n            - String VivaConsumerId           // Salesforce customer identifier\n            - PartnerType partner             // FLYBUYS, SHELL_CARD\n            - String externalMemberId         // Partner's member/account number\n            - LinkingStatus status\n            - RewardPreference rewardPreference   // Customer's chosen reward type\n            - DateTime linkedAt\n            - DateTime lastSyncedAt           // Last successful sync\n            - String oauthProviderId          // Reference to OAuth Service token\n\n            // Operations\n            def updateRewardPreference(newPreference: RewardPreference): void {\n                // Invariant: Cannot select FLYBUYS_POINTS unless Flybuys account linked\n                // Invariant: Unlinking Flybuys resets preference to OTR_REWARDS (fallback)\n            }\n\n            def recordSync(syncStatus: SyncStatus): void\n        }\n\n        ValueObject LinkingStatus {\n            - LinkState state                 // LINKED, UNLINKED, SYNC_FAILED\n            - String errorMessage\n            - int failedSyncAttempts\n        }\n\n        ValueObject RewardPreference {\n            - RewardPreferenceType type       // FLYBUYS_POINTS, FUEL_DISCOUNT_SHELL, OTR_REWARDS\n        }\n\n        enum LinkState {\n            LINKED,                           // Active partner link\n            UNLINKED,                         // No partner link\n            SYNC_FAILED                       // Link exists but sync failing\n        }\n\n        enum RewardPreferenceType {\n            FLYBUYS_POINTS,                   // Earn Flybuys points (requires linking)\n            FUEL_DISCOUNT_SHELL,              // Shell Price Save fuel discount (4c/L)\n            OTR_REWARDS                       // OTR native loyalty points (default fallback)\n        }\n\n        enum PartnerType {\n            FLYBUYS, SHELL_CARD\n        }\n    }\n\n    // 1.3 RiskAssessment Aggregate\n    // -----------------------------\n    // Customer risk, fraud, and value scores for instant refund decisions.\n    // Provides both computed scores and raw factors for transparency.\n    //\n    // Invariants:\n    // - Risk scores must be 0-100\n    // - Assessment must have calculated timestamp\n    // - Factors must be populated when score is calculated\n    //\n    // Use Case: Instant Refunds\n    // - Provides scored assessment to other business units\n    // - Exposes raw factors for custom scoring logic\n    // - Enables risk-based refund approval workflows\n    Aggregate RiskAssessment {\n        Entity CustomerRiskAssessment {\n            aggregateRoot\n\n            - RiskAssessmentId id\n            - String VivaConsumerId\n            - DateTime assessedAt\n            - DateTime lastUpdatedAt\n\n            // Computed Scores (0-100)\n            - int overallRiskScore           // Combined risk score\n            - int fraudRiskScore             // Fraud-specific risk\n            - int refundRiskScore            // Refund abuse risk\n            - int churnRiskScore             // Customer churn/attrition risk\n            - int customerValueScore         // Customer lifetime value score\n\n            // Risk Factors (raw data for transparency)\n            - RiskFactors factors\n\n            // Operations\n            def calculateRiskScore(): int\n            def updateFactors(newFactors: RiskFactors): void\n        }\n\n        ValueObject RiskFactors {\n            // Refund History\n            - int totalRefundCount\n            - int refundsLast30Days\n            - int refundsLast60Days\n            - int refundsLast90Days\n            - Money totalRefundAmount\n            - Decimal refundToPurchaseRatio\n            - List<String> refundReasonDistribution\n\n            // Transaction Behavior\n            - int transactionFrequency       // Transactions per month\n            - DateTime lastTransactionDate\n            - Money averageBasketValue\n            - Decimal basketValueVariance\n            - int locationDiversity          // Number of unique stores visited\n            - boolean hasUnusualPatterns\n\n            // Fraud Indicators\n            - int disputedTransactionCount\n            - int chargebackCount\n            - Decimal failedPaymentRate\n            - boolean multipleAccountDetected\n            - boolean loginAnomaliesDetected\n            - int fraudFlagCount\n\n            // Account Health\n            - int accountTenureDays\n            - VerificationLevel verificationLevel\n            - AccountStatus accountStatus\n\n            // Engagement Metrics (cached from EngagementService)\n            - int appUsageFrequency          // Logins per week\n            - DateTime lastLoginDate\n            - int supportInteractionCount\n            - Decimal campaignEngagementRate\n\n            // Churn Indicators\n            - int daysSinceLastPurchase\n            - int daysSinceLastLogin\n            - Decimal transactionFrequencyTrend  // +/- percentage change\n            - Decimal basketValueTrend           // +/- percentage change\n            - boolean engagementDeclining        // Trend analysis flag\n            - LifeCycleStage currentLifeCycleStage\n\n            // Customer Value\n            - Money lifetimeValue\n            - Money totalSpend\n            - ProfitabilityScore profitability\n        }\n\n        enum AccountStatus {\n            ACTIVE, SUSPENDED, FLAGGED, CLOSED\n        }\n    }\n\n    // 1.4 RefundHistory Aggregate\n    // ----------------------------\n    // Customer refund transaction history for risk assessment.\n    //\n    // Invariants:\n    // - Refund amount must be positive\n    // - Refund must reference original transaction\n    // - Refund reason must be provided\n    Aggregate RefundHistory {\n        Entity RefundRecord {\n            aggregateRoot\n\n            - RefundId id\n            - String VivaConsumerId\n            - TransactionId originalTransactionId\n            - Money refundAmount\n            - RefundReason reason\n            - RefundStatus status\n            - DateTime requestedAt\n            - DateTime processedAt\n            - String processedBy              // System or agent identifier\n            - int processingTimeDays          // Turnaround time tracking\n        }\n\n        enum RefundReason {\n            PRICING_ERROR,\n            PRODUCT_QUALITY,\n            TRANSACTION_ERROR,\n            CUSTOMER_DISPUTE,\n            PROMOTIONAL_ISSUE,\n            OTHER\n        }\n\n        enum RefundStatus {\n            PENDING,\n            APPROVED,\n            REJECTED,\n            PROCESSED,\n            CANCELLED\n        }\n    }\n\n\n    // ========================================================================\n    // SECTION 2: DOMAIN EVENTS\n    // ========================================================================\n    // Events published to Event Bus for downstream consumption.\n    //\n    // Event Categories:\n    // 1. Profile lifecycle events (creation, updates, verification, completeness, lifecycle stage, onboarding)\n    // 2. Partner linking events\n    // 3. Risk assessment events\n    // 4. Refund history events\n    // ========================================================================\n\n    // --- Profile lifecycle Events ---\n\n    DomainEvent ProfileCreated {\n        - String VivaConsumerId\n        - ProfileId profileId\n        - DateTime createdAt\n        - VerificationLevel initialVerificationLevel\n    }\n\n    DomainEvent ProfileUpdated {\n        - String VivaConsumerId\n        - ProfileId profileId\n        - DateTime updatedAt\n        - List<String> changedFields\n    }\n\n    DomainEvent ProfileVerificationChanged {\n        - String VivaConsumerId\n        - VerificationLevel previousLevel\n        - VerificationLevel newLevel\n        - DateTime changedAt\n    }\n\n    DomainEvent ProfileCompletenessChanged {\n        - String VivaConsumerId\n        - int previousScore\n        - int newScore\n        - DateTime changedAt\n    }\n\n    DomainEvent LifeCycleStageChanged {\n        - String VivaConsumerId\n        - LifeCycleStage previousStage\n        - LifeCycleStage newStage\n        - DateTime changedAt\n        - String trigger                   // TRANSACTION_INACTIVITY | ENGAGEMENT_CHANGE | MANUAL_UPDATE\n    }\n\n    DomainEvent OnboardingCompleted {\n        - String VivaConsumerId\n        - DateTime completedAt\n        - int completionPercentage\n        - List<String> completedSteps\n    }\n\n    DomainEvent OnboardingProgressUpdated {\n        - String VivaConsumerId\n        - int previousPercentage\n        - int newPercentage\n        - String completedStep\n        - DateTime updatedAt\n    }\n\n    // --- Partner Linking Events (MOVED from LoyaltyService) ---\n\n    DomainEvent PartnerLinked {\n        - String VivaConsumerId\n        - PartnerType partner\n        - String externalMemberId\n        - DateTime linkedAt\n    }\n\n    DomainEvent PartnerUnlinked {\n        - String VivaConsumerId\n        - PartnerType partner\n        - DateTime unlinkedAt\n        - String reason\n    }\n\n    DomainEvent PartnerLinkChanged {\n        - String VivaConsumerId\n        - PartnerType partner\n        - LinkState previousState\n        - LinkState newState\n        - DateTime changedAt\n    }\n\n    DomainEvent RewardPreferenceChanged {\n        - String VivaConsumerId\n        - RewardPreferenceType previousPreference\n        - RewardPreferenceType newPreference\n        - DateTime changedAt\n        - String changeReason              // USER_SELECTED, PARTNER_UNLINKED, FALLBACK_APPLIED\n        - PartnerType affectedPartner      // Which partner this change affects (if applicable)\n    }\n\n    // --- Risk Assessment Events ---\n\n    DomainEvent RiskStatusChanged {\n        - String VivaConsumerId\n        - RiskLevel previousLevel\n        - RiskLevel newLevel\n        - DateTime changedAt\n        - String trigger                   // REFUND_THRESHOLD | FRAUD_DETECTED | MANUAL_REVIEW\n    }\n\n    DomainEvent FraudIndicatorDetected {\n        - String VivaConsumerId\n        - FraudIndicatorType indicatorType\n        - String description\n        - Severity severity\n        - DateTime detectedAt\n        - boolean requiresInvestigation\n    }\n\n    enum RiskLevel {\n        LOW, MEDIUM, HIGH, CRITICAL\n    }\n\n    enum FraudIndicatorType {\n        MULTIPLE_ACCOUNTS,\n        CHARGEBACK_PATTERN,\n        LOGIN_ANOMALY,\n        TRANSACTION_ANOMALY,\n        REFUND_ABUSE,\n        DISPUTE_PATTERN\n    }\n\n    enum Severity {\n        LOW, MEDIUM, HIGH, CRITICAL\n    }\n\n    // --- Refund History Events ---\n\n    DomainEvent RefundRequested {\n        - RefundId refundId\n        - String VivaConsumerId\n        - TransactionId originalTransactionId\n        - Money refundAmount\n        - RefundReason reason\n        - DateTime requestedAt\n    }\n\n    DomainEvent RefundProcessed {\n        - RefundId refundId\n        - String VivaConsumerId\n        - Money refundAmount\n        - RefundStatus status\n        - DateTime processedAt\n        - int processingTimeDays\n    }\n\n    // ========================================================================\n    // SECTION 3: ORCHESTRATION & QUERY SERVICES\n    // ========================================================================\n    // Services orchestrate calls to external systems and provide query APIs.\n    // ========================================================================\n\n    Service ProfileQueryService {\n        // Query customer profile (Salesforce canonical + OTR enrichment)\n        getProfile(@String VivaConsumerId) : CustomerProfileResponse\n\n        // Query profile completeness\n        getProfileCompleteness(@String VivaConsumerId) : int\n\n        // Query partner links\n        getPartnerLinks(@String VivaConsumerId) : List<CustomerPartnerLink>\n\n        // Query specific partner link status\n        getPartnerLinkStatus(@String VivaConsumerId, @PartnerType partner) : LinkingStatus\n    }\n\n    Service RiskAssessmentService {\n        // Get comprehensive risk assessment (scores + raw factors)\n        getRiskAssessment(@String VivaConsumerId) : RiskAssessmentResponse\n\n        // Calculate risk score from factors\n        calculateRiskScore(@RiskFactors factors) : int\n\n        // Update risk factors\n        updateRiskFactors(@String VivaConsumerId, @RiskFactors factors): void\n\n        // Specific risk queries\n        getFraudRisk(@String VivaConsumerId) : int\n        getRefundRisk(@String VivaConsumerId) : int\n        getChurnRisk(@String VivaConsumerId) : int\n        getCustomerValueScore(@String VivaConsumerId) : int\n    }\n\n    Service RefundHistoryService {\n        // Query refund history\n        getRefundHistory(@String VivaConsumerId) : List<RefundRecord>\n\n        // Record new refund request\n        recordRefund(@RefundRecord refund) : void\n\n        // Calculate refund statistics\n        getRefundStatistics(@String VivaConsumerId) : RefundStatistics\n    }\n\n    Service PartnerLinkService {\n        // Create partner link\n        createPartnerLink(@String VivaConsumerId, @PartnerType partner, @String externalMemberId) : PartnerLinkId\n\n        // Update reward preference\n        updateRewardPreference(@String VivaConsumerId, @RewardPreferenceType preference) : void\n\n        // Sync with partner (calls partner APIs)\n        syncWithPartner(@PartnerLinkId linkId) : boolean\n\n        // Revoke partner link\n        revokePartnerLink(@PartnerLinkId linkId) : void\n    }\n\n    Service EngagementSyncService {\n        // Update cached engagement summary (from EngagementService)\n        updateEngagementSummary(@String VivaConsumerId, @EngagementMetrics metrics) : void\n\n        // Get cached engagement summary\n        getEngagementSummary(@String VivaConsumerId) : CustomerEngagementSummary\n    }\n\n    Service SalesforceProfileAdapter {\n        // ACL for Salesforce integration\n        // Translates between Salesforce Contact/Person Account and OTR profile model\n\n        // Query canonical customer data from Salesforce\n        getCustomer(@String VivaConsumerId) : SalesforceCustomer\n\n        // Resolve email to VCI (for legacy email-keyed lookups)\n        resolveEmailToVCI(@String email) : String\n\n        // Validate VCI exists in Salesforce\n        validateVCI(@String VivaConsumerId) : boolean\n    }\n\n    // ========================================================================\n    // SECTION 4: SHARED VALUE OBJECTS\n    // ========================================================================\n    // Reusable value objects used across multiple aggregates.\n    // ========================================================================\n\n    ValueObject Money {\n        - Decimal amount\n        - String currency                 // AUD, USD\n    }\n\n    ValueObject ProfileId {\n        - String id\n    }\n\n    ValueObject PartnerLinkId {\n        - String id\n    }\n\n    ValueObject RiskAssessmentId {\n        - String id\n    }\n\n    ValueObject RefundId {\n        - String id\n    }\n\n    ValueObject EngagementSummaryId {\n        - String id\n    }\n\n    ValueObject TransactionId {\n        - String id\n    }\n\n    ValueObject CustomerProfileResponse {\n        // Combined response from Salesforce + ProfileService\n        - String VivaConsumerId\n        - SalesforceCustomer salesforceData   // Canonical data from Salesforce\n        - CustomerProfileRecord otrData       // OTR-specific enrichment\n        - List<CustomerPartnerLink> partnerLinks\n        - int completenessScore\n    }\n\n    ValueObject SalesforceCustomer {\n        // Canonical customer data from Salesforce\n        - String VivaConsumerId\n        - String firstName\n        - String lastName\n        - String email\n        - String phone\n        - Address mailingAddress\n        - DateTime createdDate\n        - DateTime lastModifiedDate\n    }\n\n    ValueObject Address {\n        - String street\n        - String city\n        - String state\n        - String postalCode\n        - String country\n    }\n\n    ValueObject RiskAssessmentResponse {\n        // Comprehensive risk assessment with scores and raw factors\n        - String VivaConsumerId\n        - DateTime assessedAt\n\n        // Computed Scores\n        - int overallRiskScore\n        - int fraudRiskScore\n        - int refundRiskScore\n        - int churnRiskScore\n        - int customerValueScore\n\n        // Raw Factors (for transparency and custom scoring)\n        - RiskFactors factors\n\n        // Aggregated from Other Services\n        - String loyaltyTier              // From LoyaltyService\n        - int loyaltyPointsBalance        // From LoyaltyService\n    }\n\n    ValueObject RefundStatistics {\n        - int totalRefundCount\n        - Money totalRefundAmount\n        - Decimal refundToPurchaseRatio\n        - Money averageRefundAmount\n        - int refundsLast30Days\n        - int refundsLast90Days\n        - List<String> topRefundReasons\n    }\n\n    ValueObject EngagementMetrics {\n        // Metrics from EngagementService for caching\n        - int emailOpenRate\n        - int emailClickRate\n        - int pushNotificationEngagement\n        - int campaignResponseCount\n        - DateTime lastCampaignInteraction\n        - EngagementTier engagementTier\n    }\n\n    // ========================================================================\n    // SECTION 5: REPOSITORIES (Persistence Abstractions)\n    // ========================================================================\n    // Repository interfaces define persistence operations for owned aggregates.\n    // ========================================================================\n\n    // Repository CustomerProfileRepository\n    // Repository PartnerLinkRepository\n    // Repository RiskAssessmentRepository\n    // Repository RefundHistoryRepository\n    // Repository EngagementSummaryRepository\n}\n\n// ============================================================================\n// END OF BOUNDED CONTEXT\n// ============================================================================\n//\n// Implementation Notes:\n// - Database: Azure SQL (optimized for high-frequency updates)\n// - Events published to Event Bus topic: \"profile-events\"\n// - Salesforce integration via REST API with OAuth 2.0\n// - EngagementService integration via Event Bus + batch sync\n// - LoyaltyService queries ProfileService synchronously\n// - Admin portal enhanced to use ProfileService APIs\n// - VCI introduced through Flybuys initiative\n// ============================================================================\n","structuredPatch":[{"oldStart":4,"oldLines":6,"newStart":4,"newLines":13,"lines":["  *","  * Unified customer profile service providing enriched customer data for OTR ecosystem.","  *","+ * RELATED INITIATIVES:","+ * - OTR-001 Salesforce Customer Support: Just-In-Time Contact reconciliation with Salesforce","+ * - OTR-002 Flybuys Integration: Partner account linking and reward preference management","+ *","+ * NOTE: ProfileService is a foundational bounded context supporting multiple strategic initiatives.","+ * Depending on sequencing, capabilities may be delivered incrementally across either initiative.","+ *","  * See profile.adoc for comprehensive architecture documentation, decision log, and patterns.","  */"," "]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"497f4211-d145-4d91-9c86-671d23be1d1d"}
{"parentUuid":"d0583817-e29f-4a84-a8f1-0b7aaaf68233","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01XyFH9HidYjEXShPAFBcUmt","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Good! Now let me add comments to the PartnerLink aggregate to clarify that it's specifically for OTR-002 (Flybuys Integration), and add comments to the SalesforceProfileAdapter to clarify it's for both initiatives.","signature":"Ev8CCkYICxgCKkAv8ZETcHxZV1oqeJHRmf66tvj+CaYdOhRQYTjRxEgM8NZjdMaC0Jkq434JubMEjk1p5yq2/dJyP/Xf5GILogWAEgxz61dUlzyypIVmzqUaDCW14wb/aI5TquhUWyIwfyJ3riZUvYUwlM8inWyzJMeqsGYdJ/d2u+a6wUOGHUJPLFlhTnq8ohTanQOtuXoLKuYBx0sWlFlP4NDAd8391nujXz/9pWbbZyAcMGUPRjAaCqdMwLyvpNBeIsWoyIlmH30MylUrm7XMdqHRBzZpobs3Rrp5kgTSgY5TJ5mK/hm3qWOr5PbYV5dl2kT13WSbUkar+d+0k/MwUAglkKCICRJRfmSMopEh03dNMpwEPOa8aRTTVRoWqBIEbjaudb8ruTFt0/J/C1CZpKZJq6Ea6p6MU7t1zxcwHFb7G/d0ZAOpx6DOysyCNH7EKALDvu4GI55ob512BZic7/GzILEcXIkZMhrQ1f1hHE6nVmjL32w9fKNFdVH6x4oYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":709,"cache_read_input_tokens":83959,"cache_creation":{"ephemeral_5m_input_tokens":709,"ephemeral_1h_input_tokens":0},"output_tokens":7,"service_tier":"standard"}},"requestId":"req_011CWwBSJ583JdF1jgQfJQda","type":"assistant","uuid":"0731a760-2b17-4477-8e55-9f47a3ff53f0","timestamp":"2026-01-09T04:34:17.263Z"}
{"parentUuid":"0731a760-2b17-4477-8e55-9f47a3ff53f0","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01XyFH9HidYjEXShPAFBcUmt","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01KdhvAa9gdvspq33Pxz1Zjz","name":"Edit","input":{"replace_all":false,"file_path":"/mnt/c/Users/o.young/work/architecture/bounded_context/profile.cml","old_string":"    // 1.2 PartnerLink Aggregate\n    // ------------------------------------------------------\n    // Records customer linkages to external loyalty partners (Flybuys, Shell).\n    // Tracks linking status and synchronization state for partner integrations.\n    //\n    // Invariants:","new_string":"    // 1.2 PartnerLink Aggregate\n    // ------------------------------------------------------\n    // Records customer linkages to external loyalty partners (Flybuys, Shell).\n    // Tracks linking status and synchronization state for partner integrations.\n    //\n    // INITIATIVE: OTR-002 Flybuys Integration\n    // - Manages customer partner account linking via OAuth\n    // - Tracks reward preference selection (Flybuys Points vs Fuel Discount vs OTR Rewards)\n    // - Enables Flybuys earning at POS\n    //\n    // Invariants:"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":709,"cache_read_input_tokens":83959,"cache_creation":{"ephemeral_5m_input_tokens":709,"ephemeral_1h_input_tokens":0},"output_tokens":7,"service_tier":"standard"}},"requestId":"req_011CWwBSJ583JdF1jgQfJQda","type":"assistant","uuid":"af62d8b3-1dc4-42c8-a2f4-479760f1a2f8","timestamp":"2026-01-09T04:34:21.175Z"}
{"parentUuid":"af62d8b3-1dc4-42c8-a2f4-479760f1a2f8","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01XyFH9HidYjEXShPAFBcUmt","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01JKS8TvTAdH29XGuBSAmmsG","name":"Edit","input":{"replace_all":false,"file_path":"/mnt/c/Users/o.young/work/architecture/bounded_context/profile.cml","old_string":"    Service SalesforceProfileAdapter {\n        // ACL for Salesforce integration\n        // Translates between Salesforce Contact/Person Account and OTR profile model\n\n        // Query canonical customer data from Salesforce\n        getCustomer(@String VivaConsumerId) : SalesforceCustomer\n\n        // Resolve email to VCI (for legacy email-keyed lookups)\n        resolveEmailToVCI(@String email) : String\n\n        // Validate VCI exists in Salesforce\n        validateVCI(@String VivaConsumerId) : boolean\n    }","new_string":"    Service SalesforceProfileAdapter {\n        // ACL for Salesforce integration\n        // Translates between Salesforce Contact/Person Account and OTR profile model\n        //\n        // INITIATIVES:\n        // - OTR-001 Salesforce Customer Support: Just-In-Time Contact reconciliation (upsert by email)\n        // - OTR-002 Flybuys Integration: VCI-based customer identification\n\n        // Query canonical customer data from Salesforce\n        getCustomer(@String VivaConsumerId) : SalesforceCustomer\n\n        // Resolve email to VCI (for legacy email-keyed lookups)\n        // Used by OTR-001 for Just-In-Time Contact reconciliation\n        resolveEmailToVCI(@String email) : String\n\n        // Validate VCI exists in Salesforce\n        validateVCI(@String VivaConsumerId) : boolean\n    }"}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":709,"cache_read_input_tokens":83959,"cache_creation":{"ephemeral_5m_input_tokens":709,"ephemeral_1h_input_tokens":0},"output_tokens":857,"service_tier":"standard"}},"requestId":"req_011CWwBSJ583JdF1jgQfJQda","type":"assistant","uuid":"b72bcb2c-e979-4294-86f4-6e3135dc0400","timestamp":"2026-01-09T04:34:27.423Z"}
{"parentUuid":"af62d8b3-1dc4-42c8-a2f4-479760f1a2f8","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01KdhvAa9gdvspq33Pxz1Zjz","type":"tool_result","content":"The file /mnt/c/Users/o.young/work/architecture/bounded_context/profile.cml has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n   153→            SKIPPED                          // User skipped onboarding flow\n   154→        }\n   155→    }\n   156→\n   157→    // 1.2 PartnerLink Aggregate\n   158→    // ------------------------------------------------------\n   159→    // Records customer linkages to external loyalty partners (Flybuys, Shell).\n   160→    // Tracks linking status and synchronization state for partner integrations.\n   161→    //\n   162→    // INITIATIVE: OTR-002 Flybuys Integration\n   163→    // - Manages customer partner account linking via OAuth\n   164→    // - Tracks reward preference selection (Flybuys Points vs Fuel Discount vs OTR Rewards)\n   165→    // - Enables Flybuys earning at POS\n   166→    //\n   167→    // Invariants:\n   168→    // - Customer can only have one active link per partner type\n   169→    // - External member ID must be unique within partner\n   170→    // - Reward preference must be one of: FLYBUYS_POINTS, FUEL_DISCOUNT_SHELL, OTR_REWARDS\n   171→    // - If preference is FLYBUYS_POINTS, PartnerLink must exist with status=LINKED"}]},"uuid":"60d895d2-50cb-4156-80de-751ac5eb6f3c","timestamp":"2026-01-09T04:34:27.661Z","toolUseResult":{"filePath":"/mnt/c/Users/o.young/work/architecture/bounded_context/profile.cml","oldString":"    // 1.2 PartnerLink Aggregate\n    // ------------------------------------------------------\n    // Records customer linkages to external loyalty partners (Flybuys, Shell).\n    // Tracks linking status and synchronization state for partner integrations.\n    //\n    // Invariants:","newString":"    // 1.2 PartnerLink Aggregate\n    // ------------------------------------------------------\n    // Records customer linkages to external loyalty partners (Flybuys, Shell).\n    // Tracks linking status and synchronization state for partner integrations.\n    //\n    // INITIATIVE: OTR-002 Flybuys Integration\n    // - Manages customer partner account linking via OAuth\n    // - Tracks reward preference selection (Flybuys Points vs Fuel Discount vs OTR Rewards)\n    // - Enables Flybuys earning at POS\n    //\n    // Invariants:","originalFile":"/*\n * ProfileService - Bounded Context Definition\n * ============================================\n *\n * Unified customer profile service providing enriched customer data for OTR ecosystem.\n *\n * RELATED INITIATIVES:\n * - OTR-001 Salesforce Customer Support: Just-In-Time Contact reconciliation with Salesforce\n * - OTR-002 Flybuys Integration: Partner account linking and reward preference management\n *\n * NOTE: ProfileService is a foundational bounded context supporting multiple strategic initiatives.\n * Depending on sequencing, capabilities may be delivered incrementally across either initiative.\n *\n * See profile.adoc for comprehensive architecture documentation, decision log, and patterns.\n */\n\nimport \"../domains/profile.cml\"\n\nBoundedContext ProfileService implements ProfileDomain {\n\n    type = APPLICATION\n\n    // Strategic DDD Classification: CORE_DOMAIN | SUPPORTING_DOMAIN | GENERIC_DOMAIN\n    // CORE_DOMAIN: Competitive differentiator - customer intelligence, risk assessment, and behavioral\n    // insights drive personalization and business outcomes\n    strategicClassification = \"CORE_DOMAIN\"\n\n    domainVisionStatement = \"Provide unified, enriched customer profiles bridging Salesforce canonical data with OTR-specific attributes, behavioral insights, and risk assessments\"\n\n    responsibilities = \"OTRG-specific customer profile management\",\n                      \"Customer lifecycle stage and onboarding tracking\",\n                      \"Partner linking status tracking\",\n                      \"Customer risk assessment (fraud, refund, churn)\",\n                      \"Refund history tracking\",\n                      \"Engagement metrics caching for profile enrichment\"\n\n    implementationTechnology = \"Azure Functions, .NET Core, Azure SQL, Salesforce API, Event Bus\"\n\n    // ========================================================================\n    // SECTION 1: CORE AGGREGATES\n    // ========================================================================\n    // Aggregates represent transactional consistency boundaries.\n    // Each aggregate root controls access to entities within its boundary.\n    // ========================================================================\n\n    // 1.1 CustomerProfile Aggregate\n    // ------------------------------\n    // OTR-specific customer profile attributes enriching Salesforce canonical data.\n    // Stores behavioral data, preferences, and app-specific attributes.\n    //\n    // Invariants:\n    // - Must have valid VCI reference to Salesforce\n    // - Email verification status must be tracked\n    // - Account status must be valid enum value\n    // - Profile completeness score must be 0-100\n    // - Onboarding completion percentage must be 0-100\n    // - lifecycle stage must be valid enum value\n    //\n    // Bounded Context Note:\n    // - Canonical customer data (name, email, phone) owned by Salesforce\n    // - ProfileService stores OTR-specific enrichment only\n    // - Queries Salesforce for canonical data, does not cache it\n    Aggregate CustomerProfile {\n        Entity CustomerProfileRecord {\n            aggregateRoot\n\n            - ProfileId id\n            - String VivaConsumerId           // Salesforce customer identifier (VCI)\n            - AccountStatus status\n            - DateTime createdAt\n            - DateTime lastUpdatedAt\n            - DateTime lastLoginAt\n\n            // Identity Verification\n            - IdentityVerification verification\n\n            // App Preferences\n            - AppPreferences appPreferences\n\n            // Profile Completeness\n            - int completenessScore          // 0-100 calculated score\n\n            // Customer lifecycle\n            - LifeCycleStage lifeCycleStage  // PROSPECT | NEW | ACTIVE | DORMANT | AT_RISK | CHURNED\n            - DateTime lifeCycleChangedAt\n\n            // Onboarding Progress\n            - OnboardingStatus onboardingStatus\n            - int onboardingCompletionPercentage  // 0-100\n            - DateTime onboardingCompletedAt\n\n            // Customer Value\n            - CustomerValue valueMetrics\n\n            // Special Handling\n            - boolean isStaffMember          // Employee customer flag\n\n            // Operations\n            def updateLastLogin(): void\n            def calculateCompletenessScore(): int\n            def updateLifeCycleStage(newStage: LifeCycleStage): void\n            def updateOnboardingProgress(percentage: int): void\n        }\n\n        ValueObject IdentityVerification {\n            - boolean emailVerified\n            - boolean phoneVerified\n            - VerificationLevel level        // UNVERIFIED | BASIC | FULL\n            - DateTime lastVerifiedAt\n        }\n\n        ValueObject AppPreferences {\n            - String preferredStore\n            - String languagePreference      // ISO 639-1 code (en, zh, vi, etc.)\n            - boolean pushNotificationsEnabled\n            - boolean locationServicesEnabled\n            - String preferredPaymentMethod\n            - Map<String, String> customPreferences\n        }\n\n        ValueObject CustomerValue {\n            - Money lifetimeValue\n            - Money totalSpend\n            - int transactionCount\n            - Money averageBasketValue\n            - DateTime firstPurchaseDate\n            - ProfitabilityScore profitability\n        }\n\n        enum VerificationLevel {\n            UNVERIFIED,                      // No verification\n            BASIC,                           // Email or phone verified\n            FULL                             // Multiple factors verified\n        }\n\n        enum ProfitabilityScore {\n            LOW, MEDIUM, HIGH, VIP\n        }\n\n        enum LifeCycleStage {\n            PROSPECT,                        // Registered but no purchase\n            NEW,                             // First purchase within 90 days\n            ACTIVE,                          // Regular transactions\n            DORMANT,                         // No transactions 90+ days\n            AT_RISK,                         // Declining engagement/transactions\n            CHURNED                          // No transactions 180+ days\n        }\n\n        enum OnboardingStatus {\n            NOT_STARTED,                     // Account created, onboarding not begun\n            IN_PROGRESS,                     // Onboarding steps partially complete\n            COMPLETED,                       // All onboarding steps finished\n            SKIPPED                          // User skipped onboarding flow\n        }\n    }\n\n    // 1.2 PartnerLink Aggregate\n    // ------------------------------------------------------\n    // Records customer linkages to external loyalty partners (Flybuys, Shell).\n    // Tracks linking status and synchronization state for partner integrations.\n    //\n    // Invariants:\n    // - Customer can only have one active link per partner type\n    // - External member ID must be unique within partner\n    // - Reward preference must be one of: FLYBUYS_POINTS, FUEL_DISCOUNT_SHELL, OTR_REWARDS\n    // - If preference is FLYBUYS_POINTS, PartnerLink must exist with status=LINKED\n    // - Default preference when no partner linked: OTR_REWARDS (fallback)\n    //\n    // Bounded Context Note:\n    // - OAuth tokens are managed by infrastructure OAuth Service\n    // - This aggregate tracks: \"customer linked partner account\"\n    // - Created in response to OAuthLinkEstablished event from OAuth Service\n    Aggregate PartnerLink {\n        Entity CustomerPartnerLink {\n            aggregateRoot\n\n            - PartnerLinkId id\n            - String VivaConsumerId           // Salesforce customer identifier\n            - PartnerType partner             // FLYBUYS, SHELL_CARD\n            - String externalMemberId         // Partner's member/account number\n            - LinkingStatus status\n            - RewardPreference rewardPreference   // Customer's chosen reward type\n            - DateTime linkedAt\n            - DateTime lastSyncedAt           // Last successful sync\n            - String oauthProviderId          // Reference to OAuth Service token\n\n            // Operations\n            def updateRewardPreference(newPreference: RewardPreference): void {\n                // Invariant: Cannot select FLYBUYS_POINTS unless Flybuys account linked\n                // Invariant: Unlinking Flybuys resets preference to OTR_REWARDS (fallback)\n            }\n\n            def recordSync(syncStatus: SyncStatus): void\n        }\n\n        ValueObject LinkingStatus {\n            - LinkState state                 // LINKED, UNLINKED, SYNC_FAILED\n            - String errorMessage\n            - int failedSyncAttempts\n        }\n\n        ValueObject RewardPreference {\n            - RewardPreferenceType type       // FLYBUYS_POINTS, FUEL_DISCOUNT_SHELL, OTR_REWARDS\n        }\n\n        enum LinkState {\n            LINKED,                           // Active partner link\n            UNLINKED,                         // No partner link\n            SYNC_FAILED                       // Link exists but sync failing\n        }\n\n        enum RewardPreferenceType {\n            FLYBUYS_POINTS,                   // Earn Flybuys points (requires linking)\n            FUEL_DISCOUNT_SHELL,              // Shell Price Save fuel discount (4c/L)\n            OTR_REWARDS                       // OTR native loyalty points (default fallback)\n        }\n\n        enum PartnerType {\n            FLYBUYS, SHELL_CARD\n        }\n    }\n\n    // 1.3 RiskAssessment Aggregate\n    // -----------------------------\n    // Customer risk, fraud, and value scores for instant refund decisions.\n    // Provides both computed scores and raw factors for transparency.\n    //\n    // Invariants:\n    // - Risk scores must be 0-100\n    // - Assessment must have calculated timestamp\n    // - Factors must be populated when score is calculated\n    //\n    // Use Case: Instant Refunds\n    // - Provides scored assessment to other business units\n    // - Exposes raw factors for custom scoring logic\n    // - Enables risk-based refund approval workflows\n    Aggregate RiskAssessment {\n        Entity CustomerRiskAssessment {\n            aggregateRoot\n\n            - RiskAssessmentId id\n            - String VivaConsumerId\n            - DateTime assessedAt\n            - DateTime lastUpdatedAt\n\n            // Computed Scores (0-100)\n            - int overallRiskScore           // Combined risk score\n            - int fraudRiskScore             // Fraud-specific risk\n            - int refundRiskScore            // Refund abuse risk\n            - int churnRiskScore             // Customer churn/attrition risk\n            - int customerValueScore         // Customer lifetime value score\n\n            // Risk Factors (raw data for transparency)\n            - RiskFactors factors\n\n            // Operations\n            def calculateRiskScore(): int\n            def updateFactors(newFactors: RiskFactors): void\n        }\n\n        ValueObject RiskFactors {\n            // Refund History\n            - int totalRefundCount\n            - int refundsLast30Days\n            - int refundsLast60Days\n            - int refundsLast90Days\n            - Money totalRefundAmount\n            - Decimal refundToPurchaseRatio\n            - List<String> refundReasonDistribution\n\n            // Transaction Behavior\n            - int transactionFrequency       // Transactions per month\n            - DateTime lastTransactionDate\n            - Money averageBasketValue\n            - Decimal basketValueVariance\n            - int locationDiversity          // Number of unique stores visited\n            - boolean hasUnusualPatterns\n\n            // Fraud Indicators\n            - int disputedTransactionCount\n            - int chargebackCount\n            - Decimal failedPaymentRate\n            - boolean multipleAccountDetected\n            - boolean loginAnomaliesDetected\n            - int fraudFlagCount\n\n            // Account Health\n            - int accountTenureDays\n            - VerificationLevel verificationLevel\n            - AccountStatus accountStatus\n\n            // Engagement Metrics (cached from EngagementService)\n            - int appUsageFrequency          // Logins per week\n            - DateTime lastLoginDate\n            - int supportInteractionCount\n            - Decimal campaignEngagementRate\n\n            // Churn Indicators\n            - int daysSinceLastPurchase\n            - int daysSinceLastLogin\n            - Decimal transactionFrequencyTrend  // +/- percentage change\n            - Decimal basketValueTrend           // +/- percentage change\n            - boolean engagementDeclining        // Trend analysis flag\n            - LifeCycleStage currentLifeCycleStage\n\n            // Customer Value\n            - Money lifetimeValue\n            - Money totalSpend\n            - ProfitabilityScore profitability\n        }\n\n        enum AccountStatus {\n            ACTIVE, SUSPENDED, FLAGGED, CLOSED\n        }\n    }\n\n    // 1.4 RefundHistory Aggregate\n    // ----------------------------\n    // Customer refund transaction history for risk assessment.\n    //\n    // Invariants:\n    // - Refund amount must be positive\n    // - Refund must reference original transaction\n    // - Refund reason must be provided\n    Aggregate RefundHistory {\n        Entity RefundRecord {\n            aggregateRoot\n\n            - RefundId id\n            - String VivaConsumerId\n            - TransactionId originalTransactionId\n            - Money refundAmount\n            - RefundReason reason\n            - RefundStatus status\n            - DateTime requestedAt\n            - DateTime processedAt\n            - String processedBy              // System or agent identifier\n            - int processingTimeDays          // Turnaround time tracking\n        }\n\n        enum RefundReason {\n            PRICING_ERROR,\n            PRODUCT_QUALITY,\n            TRANSACTION_ERROR,\n            CUSTOMER_DISPUTE,\n            PROMOTIONAL_ISSUE,\n            OTHER\n        }\n\n        enum RefundStatus {\n            PENDING,\n            APPROVED,\n            REJECTED,\n            PROCESSED,\n            CANCELLED\n        }\n    }\n\n\n    // ========================================================================\n    // SECTION 2: DOMAIN EVENTS\n    // ========================================================================\n    // Events published to Event Bus for downstream consumption.\n    //\n    // Event Categories:\n    // 1. Profile lifecycle events (creation, updates, verification, completeness, lifecycle stage, onboarding)\n    // 2. Partner linking events\n    // 3. Risk assessment events\n    // 4. Refund history events\n    // ========================================================================\n\n    // --- Profile lifecycle Events ---\n\n    DomainEvent ProfileCreated {\n        - String VivaConsumerId\n        - ProfileId profileId\n        - DateTime createdAt\n        - VerificationLevel initialVerificationLevel\n    }\n\n    DomainEvent ProfileUpdated {\n        - String VivaConsumerId\n        - ProfileId profileId\n        - DateTime updatedAt\n        - List<String> changedFields\n    }\n\n    DomainEvent ProfileVerificationChanged {\n        - String VivaConsumerId\n        - VerificationLevel previousLevel\n        - VerificationLevel newLevel\n        - DateTime changedAt\n    }\n\n    DomainEvent ProfileCompletenessChanged {\n        - String VivaConsumerId\n        - int previousScore\n        - int newScore\n        - DateTime changedAt\n    }\n\n    DomainEvent LifeCycleStageChanged {\n        - String VivaConsumerId\n        - LifeCycleStage previousStage\n        - LifeCycleStage newStage\n        - DateTime changedAt\n        - String trigger                   // TRANSACTION_INACTIVITY | ENGAGEMENT_CHANGE | MANUAL_UPDATE\n    }\n\n    DomainEvent OnboardingCompleted {\n        - String VivaConsumerId\n        - DateTime completedAt\n        - int completionPercentage\n        - List<String> completedSteps\n    }\n\n    DomainEvent OnboardingProgressUpdated {\n        - String VivaConsumerId\n        - int previousPercentage\n        - int newPercentage\n        - String completedStep\n        - DateTime updatedAt\n    }\n\n    // --- Partner Linking Events (MOVED from LoyaltyService) ---\n\n    DomainEvent PartnerLinked {\n        - String VivaConsumerId\n        - PartnerType partner\n        - String externalMemberId\n        - DateTime linkedAt\n    }\n\n    DomainEvent PartnerUnlinked {\n        - String VivaConsumerId\n        - PartnerType partner\n        - DateTime unlinkedAt\n        - String reason\n    }\n\n    DomainEvent PartnerLinkChanged {\n        - String VivaConsumerId\n        - PartnerType partner\n        - LinkState previousState\n        - LinkState newState\n        - DateTime changedAt\n    }\n\n    DomainEvent RewardPreferenceChanged {\n        - String VivaConsumerId\n        - RewardPreferenceType previousPreference\n        - RewardPreferenceType newPreference\n        - DateTime changedAt\n        - String changeReason              // USER_SELECTED, PARTNER_UNLINKED, FALLBACK_APPLIED\n        - PartnerType affectedPartner      // Which partner this change affects (if applicable)\n    }\n\n    // --- Risk Assessment Events ---\n\n    DomainEvent RiskStatusChanged {\n        - String VivaConsumerId\n        - RiskLevel previousLevel\n        - RiskLevel newLevel\n        - DateTime changedAt\n        - String trigger                   // REFUND_THRESHOLD | FRAUD_DETECTED | MANUAL_REVIEW\n    }\n\n    DomainEvent FraudIndicatorDetected {\n        - String VivaConsumerId\n        - FraudIndicatorType indicatorType\n        - String description\n        - Severity severity\n        - DateTime detectedAt\n        - boolean requiresInvestigation\n    }\n\n    enum RiskLevel {\n        LOW, MEDIUM, HIGH, CRITICAL\n    }\n\n    enum FraudIndicatorType {\n        MULTIPLE_ACCOUNTS,\n        CHARGEBACK_PATTERN,\n        LOGIN_ANOMALY,\n        TRANSACTION_ANOMALY,\n        REFUND_ABUSE,\n        DISPUTE_PATTERN\n    }\n\n    enum Severity {\n        LOW, MEDIUM, HIGH, CRITICAL\n    }\n\n    // --- Refund History Events ---\n\n    DomainEvent RefundRequested {\n        - RefundId refundId\n        - String VivaConsumerId\n        - TransactionId originalTransactionId\n        - Money refundAmount\n        - RefundReason reason\n        - DateTime requestedAt\n    }\n\n    DomainEvent RefundProcessed {\n        - RefundId refundId\n        - String VivaConsumerId\n        - Money refundAmount\n        - RefundStatus status\n        - DateTime processedAt\n        - int processingTimeDays\n    }\n\n    // ========================================================================\n    // SECTION 3: ORCHESTRATION & QUERY SERVICES\n    // ========================================================================\n    // Services orchestrate calls to external systems and provide query APIs.\n    // ========================================================================\n\n    Service ProfileQueryService {\n        // Query customer profile (Salesforce canonical + OTR enrichment)\n        getProfile(@String VivaConsumerId) : CustomerProfileResponse\n\n        // Query profile completeness\n        getProfileCompleteness(@String VivaConsumerId) : int\n\n        // Query partner links\n        getPartnerLinks(@String VivaConsumerId) : List<CustomerPartnerLink>\n\n        // Query specific partner link status\n        getPartnerLinkStatus(@String VivaConsumerId, @PartnerType partner) : LinkingStatus\n    }\n\n    Service RiskAssessmentService {\n        // Get comprehensive risk assessment (scores + raw factors)\n        getRiskAssessment(@String VivaConsumerId) : RiskAssessmentResponse\n\n        // Calculate risk score from factors\n        calculateRiskScore(@RiskFactors factors) : int\n\n        // Update risk factors\n        updateRiskFactors(@String VivaConsumerId, @RiskFactors factors): void\n\n        // Specific risk queries\n        getFraudRisk(@String VivaConsumerId) : int\n        getRefundRisk(@String VivaConsumerId) : int\n        getChurnRisk(@String VivaConsumerId) : int\n        getCustomerValueScore(@String VivaConsumerId) : int\n    }\n\n    Service RefundHistoryService {\n        // Query refund history\n        getRefundHistory(@String VivaConsumerId) : List<RefundRecord>\n\n        // Record new refund request\n        recordRefund(@RefundRecord refund) : void\n\n        // Calculate refund statistics\n        getRefundStatistics(@String VivaConsumerId) : RefundStatistics\n    }\n\n    Service PartnerLinkService {\n        // Create partner link\n        createPartnerLink(@String VivaConsumerId, @PartnerType partner, @String externalMemberId) : PartnerLinkId\n\n        // Update reward preference\n        updateRewardPreference(@String VivaConsumerId, @RewardPreferenceType preference) : void\n\n        // Sync with partner (calls partner APIs)\n        syncWithPartner(@PartnerLinkId linkId) : boolean\n\n        // Revoke partner link\n        revokePartnerLink(@PartnerLinkId linkId) : void\n    }\n\n    Service EngagementSyncService {\n        // Update cached engagement summary (from EngagementService)\n        updateEngagementSummary(@String VivaConsumerId, @EngagementMetrics metrics) : void\n\n        // Get cached engagement summary\n        getEngagementSummary(@String VivaConsumerId) : CustomerEngagementSummary\n    }\n\n    Service SalesforceProfileAdapter {\n        // ACL for Salesforce integration\n        // Translates between Salesforce Contact/Person Account and OTR profile model\n\n        // Query canonical customer data from Salesforce\n        getCustomer(@String VivaConsumerId) : SalesforceCustomer\n\n        // Resolve email to VCI (for legacy email-keyed lookups)\n        resolveEmailToVCI(@String email) : String\n\n        // Validate VCI exists in Salesforce\n        validateVCI(@String VivaConsumerId) : boolean\n    }\n\n    // ========================================================================\n    // SECTION 4: SHARED VALUE OBJECTS\n    // ========================================================================\n    // Reusable value objects used across multiple aggregates.\n    // ========================================================================\n\n    ValueObject Money {\n        - Decimal amount\n        - String currency                 // AUD, USD\n    }\n\n    ValueObject ProfileId {\n        - String id\n    }\n\n    ValueObject PartnerLinkId {\n        - String id\n    }\n\n    ValueObject RiskAssessmentId {\n        - String id\n    }\n\n    ValueObject RefundId {\n        - String id\n    }\n\n    ValueObject EngagementSummaryId {\n        - String id\n    }\n\n    ValueObject TransactionId {\n        - String id\n    }\n\n    ValueObject CustomerProfileResponse {\n        // Combined response from Salesforce + ProfileService\n        - String VivaConsumerId\n        - SalesforceCustomer salesforceData   // Canonical data from Salesforce\n        - CustomerProfileRecord otrData       // OTR-specific enrichment\n        - List<CustomerPartnerLink> partnerLinks\n        - int completenessScore\n    }\n\n    ValueObject SalesforceCustomer {\n        // Canonical customer data from Salesforce\n        - String VivaConsumerId\n        - String firstName\n        - String lastName\n        - String email\n        - String phone\n        - Address mailingAddress\n        - DateTime createdDate\n        - DateTime lastModifiedDate\n    }\n\n    ValueObject Address {\n        - String street\n        - String city\n        - String state\n        - String postalCode\n        - String country\n    }\n\n    ValueObject RiskAssessmentResponse {\n        // Comprehensive risk assessment with scores and raw factors\n        - String VivaConsumerId\n        - DateTime assessedAt\n\n        // Computed Scores\n        - int overallRiskScore\n        - int fraudRiskScore\n        - int refundRiskScore\n        - int churnRiskScore\n        - int customerValueScore\n\n        // Raw Factors (for transparency and custom scoring)\n        - RiskFactors factors\n\n        // Aggregated from Other Services\n        - String loyaltyTier              // From LoyaltyService\n        - int loyaltyPointsBalance        // From LoyaltyService\n    }\n\n    ValueObject RefundStatistics {\n        - int totalRefundCount\n        - Money totalRefundAmount\n        - Decimal refundToPurchaseRatio\n        - Money averageRefundAmount\n        - int refundsLast30Days\n        - int refundsLast90Days\n        - List<String> topRefundReasons\n    }\n\n    ValueObject EngagementMetrics {\n        // Metrics from EngagementService for caching\n        - int emailOpenRate\n        - int emailClickRate\n        - int pushNotificationEngagement\n        - int campaignResponseCount\n        - DateTime lastCampaignInteraction\n        - EngagementTier engagementTier\n    }\n\n    // ========================================================================\n    // SECTION 5: REPOSITORIES (Persistence Abstractions)\n    // ========================================================================\n    // Repository interfaces define persistence operations for owned aggregates.\n    // ========================================================================\n\n    // Repository CustomerProfileRepository\n    // Repository PartnerLinkRepository\n    // Repository RiskAssessmentRepository\n    // Repository RefundHistoryRepository\n    // Repository EngagementSummaryRepository\n}\n\n// ============================================================================\n// END OF BOUNDED CONTEXT\n// ============================================================================\n//\n// Implementation Notes:\n// - Database: Azure SQL (optimized for high-frequency updates)\n// - Events published to Event Bus topic: \"profile-events\"\n// - Salesforce integration via REST API with OAuth 2.0\n// - EngagementService integration via Event Bus + batch sync\n// - LoyaltyService queries ProfileService synchronously\n// - Admin portal enhanced to use ProfileService APIs\n// - VCI introduced through Flybuys initiative\n// ============================================================================\n","structuredPatch":[{"oldStart":159,"oldLines":6,"newStart":159,"newLines":11,"lines":["     // Records customer linkages to external loyalty partners (Flybuys, Shell).","     // Tracks linking status and synchronization state for partner integrations.","     //","+    // INITIATIVE: OTR-002 Flybuys Integration","+    // - Manages customer partner account linking via OAuth","+    // - Tracks reward preference selection (Flybuys Points vs Fuel Discount vs OTR Rewards)","+    // - Enables Flybuys earning at POS","+    //","     // Invariants:","     // - Customer can only have one active link per partner type","     // - External member ID must be unique within partner"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"af62d8b3-1dc4-42c8-a2f4-479760f1a2f8"}
{"parentUuid":"b72bcb2c-e979-4294-86f4-6e3135dc0400","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01JKS8TvTAdH29XGuBSAmmsG","type":"tool_result","content":"The file /mnt/c/Users/o.young/work/architecture/bounded_context/profile.cml has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n   585→        // Get cached engagement summary\n   586→        getEngagementSummary(@String VivaConsumerId) : CustomerEngagementSummary\n   587→    }\n   588→\n   589→    Service SalesforceProfileAdapter {\n   590→        // ACL for Salesforce integration\n   591→        // Translates between Salesforce Contact/Person Account and OTR profile model\n   592→        //\n   593→        // INITIATIVES:\n   594→        // - OTR-001 Salesforce Customer Support: Just-In-Time Contact reconciliation (upsert by email)\n   595→        // - OTR-002 Flybuys Integration: VCI-based customer identification\n   596→\n   597→        // Query canonical customer data from Salesforce\n   598→        getCustomer(@String VivaConsumerId) : SalesforceCustomer\n   599→\n   600→        // Resolve email to VCI (for legacy email-keyed lookups)\n   601→        // Used by OTR-001 for Just-In-Time Contact reconciliation\n   602→        resolveEmailToVCI(@String email) : String\n   603→\n   604→        // Validate VCI exists in Salesforce\n   605→        validateVCI(@String VivaConsumerId) : boolean\n   606→    }\n   607→\n   608→    // ========================================================================\n   609→    // SECTION 4: SHARED VALUE OBJECTS\n   610→    // ========================================================================"}]},"uuid":"d3b1b39d-dcb9-49be-88ed-db1740a516f7","timestamp":"2026-01-09T04:34:27.966Z","toolUseResult":{"filePath":"/mnt/c/Users/o.young/work/architecture/bounded_context/profile.cml","oldString":"    Service SalesforceProfileAdapter {\n        // ACL for Salesforce integration\n        // Translates between Salesforce Contact/Person Account and OTR profile model\n\n        // Query canonical customer data from Salesforce\n        getCustomer(@String VivaConsumerId) : SalesforceCustomer\n\n        // Resolve email to VCI (for legacy email-keyed lookups)\n        resolveEmailToVCI(@String email) : String\n\n        // Validate VCI exists in Salesforce\n        validateVCI(@String VivaConsumerId) : boolean\n    }","newString":"    Service SalesforceProfileAdapter {\n        // ACL for Salesforce integration\n        // Translates between Salesforce Contact/Person Account and OTR profile model\n        //\n        // INITIATIVES:\n        // - OTR-001 Salesforce Customer Support: Just-In-Time Contact reconciliation (upsert by email)\n        // - OTR-002 Flybuys Integration: VCI-based customer identification\n\n        // Query canonical customer data from Salesforce\n        getCustomer(@String VivaConsumerId) : SalesforceCustomer\n\n        // Resolve email to VCI (for legacy email-keyed lookups)\n        // Used by OTR-001 for Just-In-Time Contact reconciliation\n        resolveEmailToVCI(@String email) : String\n\n        // Validate VCI exists in Salesforce\n        validateVCI(@String VivaConsumerId) : boolean\n    }","originalFile":"/*\n * ProfileService - Bounded Context Definition\n * ============================================\n *\n * Unified customer profile service providing enriched customer data for OTR ecosystem.\n *\n * RELATED INITIATIVES:\n * - OTR-001 Salesforce Customer Support: Just-In-Time Contact reconciliation with Salesforce\n * - OTR-002 Flybuys Integration: Partner account linking and reward preference management\n *\n * NOTE: ProfileService is a foundational bounded context supporting multiple strategic initiatives.\n * Depending on sequencing, capabilities may be delivered incrementally across either initiative.\n *\n * See profile.adoc for comprehensive architecture documentation, decision log, and patterns.\n */\n\nimport \"../domains/profile.cml\"\n\nBoundedContext ProfileService implements ProfileDomain {\n\n    type = APPLICATION\n\n    // Strategic DDD Classification: CORE_DOMAIN | SUPPORTING_DOMAIN | GENERIC_DOMAIN\n    // CORE_DOMAIN: Competitive differentiator - customer intelligence, risk assessment, and behavioral\n    // insights drive personalization and business outcomes\n    strategicClassification = \"CORE_DOMAIN\"\n\n    domainVisionStatement = \"Provide unified, enriched customer profiles bridging Salesforce canonical data with OTR-specific attributes, behavioral insights, and risk assessments\"\n\n    responsibilities = \"OTRG-specific customer profile management\",\n                      \"Customer lifecycle stage and onboarding tracking\",\n                      \"Partner linking status tracking\",\n                      \"Customer risk assessment (fraud, refund, churn)\",\n                      \"Refund history tracking\",\n                      \"Engagement metrics caching for profile enrichment\"\n\n    implementationTechnology = \"Azure Functions, .NET Core, Azure SQL, Salesforce API, Event Bus\"\n\n    // ========================================================================\n    // SECTION 1: CORE AGGREGATES\n    // ========================================================================\n    // Aggregates represent transactional consistency boundaries.\n    // Each aggregate root controls access to entities within its boundary.\n    // ========================================================================\n\n    // 1.1 CustomerProfile Aggregate\n    // ------------------------------\n    // OTR-specific customer profile attributes enriching Salesforce canonical data.\n    // Stores behavioral data, preferences, and app-specific attributes.\n    //\n    // Invariants:\n    // - Must have valid VCI reference to Salesforce\n    // - Email verification status must be tracked\n    // - Account status must be valid enum value\n    // - Profile completeness score must be 0-100\n    // - Onboarding completion percentage must be 0-100\n    // - lifecycle stage must be valid enum value\n    //\n    // Bounded Context Note:\n    // - Canonical customer data (name, email, phone) owned by Salesforce\n    // - ProfileService stores OTR-specific enrichment only\n    // - Queries Salesforce for canonical data, does not cache it\n    Aggregate CustomerProfile {\n        Entity CustomerProfileRecord {\n            aggregateRoot\n\n            - ProfileId id\n            - String VivaConsumerId           // Salesforce customer identifier (VCI)\n            - AccountStatus status\n            - DateTime createdAt\n            - DateTime lastUpdatedAt\n            - DateTime lastLoginAt\n\n            // Identity Verification\n            - IdentityVerification verification\n\n            // App Preferences\n            - AppPreferences appPreferences\n\n            // Profile Completeness\n            - int completenessScore          // 0-100 calculated score\n\n            // Customer lifecycle\n            - LifeCycleStage lifeCycleStage  // PROSPECT | NEW | ACTIVE | DORMANT | AT_RISK | CHURNED\n            - DateTime lifeCycleChangedAt\n\n            // Onboarding Progress\n            - OnboardingStatus onboardingStatus\n            - int onboardingCompletionPercentage  // 0-100\n            - DateTime onboardingCompletedAt\n\n            // Customer Value\n            - CustomerValue valueMetrics\n\n            // Special Handling\n            - boolean isStaffMember          // Employee customer flag\n\n            // Operations\n            def updateLastLogin(): void\n            def calculateCompletenessScore(): int\n            def updateLifeCycleStage(newStage: LifeCycleStage): void\n            def updateOnboardingProgress(percentage: int): void\n        }\n\n        ValueObject IdentityVerification {\n            - boolean emailVerified\n            - boolean phoneVerified\n            - VerificationLevel level        // UNVERIFIED | BASIC | FULL\n            - DateTime lastVerifiedAt\n        }\n\n        ValueObject AppPreferences {\n            - String preferredStore\n            - String languagePreference      // ISO 639-1 code (en, zh, vi, etc.)\n            - boolean pushNotificationsEnabled\n            - boolean locationServicesEnabled\n            - String preferredPaymentMethod\n            - Map<String, String> customPreferences\n        }\n\n        ValueObject CustomerValue {\n            - Money lifetimeValue\n            - Money totalSpend\n            - int transactionCount\n            - Money averageBasketValue\n            - DateTime firstPurchaseDate\n            - ProfitabilityScore profitability\n        }\n\n        enum VerificationLevel {\n            UNVERIFIED,                      // No verification\n            BASIC,                           // Email or phone verified\n            FULL                             // Multiple factors verified\n        }\n\n        enum ProfitabilityScore {\n            LOW, MEDIUM, HIGH, VIP\n        }\n\n        enum LifeCycleStage {\n            PROSPECT,                        // Registered but no purchase\n            NEW,                             // First purchase within 90 days\n            ACTIVE,                          // Regular transactions\n            DORMANT,                         // No transactions 90+ days\n            AT_RISK,                         // Declining engagement/transactions\n            CHURNED                          // No transactions 180+ days\n        }\n\n        enum OnboardingStatus {\n            NOT_STARTED,                     // Account created, onboarding not begun\n            IN_PROGRESS,                     // Onboarding steps partially complete\n            COMPLETED,                       // All onboarding steps finished\n            SKIPPED                          // User skipped onboarding flow\n        }\n    }\n\n    // 1.2 PartnerLink Aggregate\n    // ------------------------------------------------------\n    // Records customer linkages to external loyalty partners (Flybuys, Shell).\n    // Tracks linking status and synchronization state for partner integrations.\n    //\n    // INITIATIVE: OTR-002 Flybuys Integration\n    // - Manages customer partner account linking via OAuth\n    // - Tracks reward preference selection (Flybuys Points vs Fuel Discount vs OTR Rewards)\n    // - Enables Flybuys earning at POS\n    //\n    // Invariants:\n    // - Customer can only have one active link per partner type\n    // - External member ID must be unique within partner\n    // - Reward preference must be one of: FLYBUYS_POINTS, FUEL_DISCOUNT_SHELL, OTR_REWARDS\n    // - If preference is FLYBUYS_POINTS, PartnerLink must exist with status=LINKED\n    // - Default preference when no partner linked: OTR_REWARDS (fallback)\n    //\n    // Bounded Context Note:\n    // - OAuth tokens are managed by infrastructure OAuth Service\n    // - This aggregate tracks: \"customer linked partner account\"\n    // - Created in response to OAuthLinkEstablished event from OAuth Service\n    Aggregate PartnerLink {\n        Entity CustomerPartnerLink {\n            aggregateRoot\n\n            - PartnerLinkId id\n            - String VivaConsumerId           // Salesforce customer identifier\n            - PartnerType partner             // FLYBUYS, SHELL_CARD\n            - String externalMemberId         // Partner's member/account number\n            - LinkingStatus status\n            - RewardPreference rewardPreference   // Customer's chosen reward type\n            - DateTime linkedAt\n            - DateTime lastSyncedAt           // Last successful sync\n            - String oauthProviderId          // Reference to OAuth Service token\n\n            // Operations\n            def updateRewardPreference(newPreference: RewardPreference): void {\n                // Invariant: Cannot select FLYBUYS_POINTS unless Flybuys account linked\n                // Invariant: Unlinking Flybuys resets preference to OTR_REWARDS (fallback)\n            }\n\n            def recordSync(syncStatus: SyncStatus): void\n        }\n\n        ValueObject LinkingStatus {\n            - LinkState state                 // LINKED, UNLINKED, SYNC_FAILED\n            - String errorMessage\n            - int failedSyncAttempts\n        }\n\n        ValueObject RewardPreference {\n            - RewardPreferenceType type       // FLYBUYS_POINTS, FUEL_DISCOUNT_SHELL, OTR_REWARDS\n        }\n\n        enum LinkState {\n            LINKED,                           // Active partner link\n            UNLINKED,                         // No partner link\n            SYNC_FAILED                       // Link exists but sync failing\n        }\n\n        enum RewardPreferenceType {\n            FLYBUYS_POINTS,                   // Earn Flybuys points (requires linking)\n            FUEL_DISCOUNT_SHELL,              // Shell Price Save fuel discount (4c/L)\n            OTR_REWARDS                       // OTR native loyalty points (default fallback)\n        }\n\n        enum PartnerType {\n            FLYBUYS, SHELL_CARD\n        }\n    }\n\n    // 1.3 RiskAssessment Aggregate\n    // -----------------------------\n    // Customer risk, fraud, and value scores for instant refund decisions.\n    // Provides both computed scores and raw factors for transparency.\n    //\n    // Invariants:\n    // - Risk scores must be 0-100\n    // - Assessment must have calculated timestamp\n    // - Factors must be populated when score is calculated\n    //\n    // Use Case: Instant Refunds\n    // - Provides scored assessment to other business units\n    // - Exposes raw factors for custom scoring logic\n    // - Enables risk-based refund approval workflows\n    Aggregate RiskAssessment {\n        Entity CustomerRiskAssessment {\n            aggregateRoot\n\n            - RiskAssessmentId id\n            - String VivaConsumerId\n            - DateTime assessedAt\n            - DateTime lastUpdatedAt\n\n            // Computed Scores (0-100)\n            - int overallRiskScore           // Combined risk score\n            - int fraudRiskScore             // Fraud-specific risk\n            - int refundRiskScore            // Refund abuse risk\n            - int churnRiskScore             // Customer churn/attrition risk\n            - int customerValueScore         // Customer lifetime value score\n\n            // Risk Factors (raw data for transparency)\n            - RiskFactors factors\n\n            // Operations\n            def calculateRiskScore(): int\n            def updateFactors(newFactors: RiskFactors): void\n        }\n\n        ValueObject RiskFactors {\n            // Refund History\n            - int totalRefundCount\n            - int refundsLast30Days\n            - int refundsLast60Days\n            - int refundsLast90Days\n            - Money totalRefundAmount\n            - Decimal refundToPurchaseRatio\n            - List<String> refundReasonDistribution\n\n            // Transaction Behavior\n            - int transactionFrequency       // Transactions per month\n            - DateTime lastTransactionDate\n            - Money averageBasketValue\n            - Decimal basketValueVariance\n            - int locationDiversity          // Number of unique stores visited\n            - boolean hasUnusualPatterns\n\n            // Fraud Indicators\n            - int disputedTransactionCount\n            - int chargebackCount\n            - Decimal failedPaymentRate\n            - boolean multipleAccountDetected\n            - boolean loginAnomaliesDetected\n            - int fraudFlagCount\n\n            // Account Health\n            - int accountTenureDays\n            - VerificationLevel verificationLevel\n            - AccountStatus accountStatus\n\n            // Engagement Metrics (cached from EngagementService)\n            - int appUsageFrequency          // Logins per week\n            - DateTime lastLoginDate\n            - int supportInteractionCount\n            - Decimal campaignEngagementRate\n\n            // Churn Indicators\n            - int daysSinceLastPurchase\n            - int daysSinceLastLogin\n            - Decimal transactionFrequencyTrend  // +/- percentage change\n            - Decimal basketValueTrend           // +/- percentage change\n            - boolean engagementDeclining        // Trend analysis flag\n            - LifeCycleStage currentLifeCycleStage\n\n            // Customer Value\n            - Money lifetimeValue\n            - Money totalSpend\n            - ProfitabilityScore profitability\n        }\n\n        enum AccountStatus {\n            ACTIVE, SUSPENDED, FLAGGED, CLOSED\n        }\n    }\n\n    // 1.4 RefundHistory Aggregate\n    // ----------------------------\n    // Customer refund transaction history for risk assessment.\n    //\n    // Invariants:\n    // - Refund amount must be positive\n    // - Refund must reference original transaction\n    // - Refund reason must be provided\n    Aggregate RefundHistory {\n        Entity RefundRecord {\n            aggregateRoot\n\n            - RefundId id\n            - String VivaConsumerId\n            - TransactionId originalTransactionId\n            - Money refundAmount\n            - RefundReason reason\n            - RefundStatus status\n            - DateTime requestedAt\n            - DateTime processedAt\n            - String processedBy              // System or agent identifier\n            - int processingTimeDays          // Turnaround time tracking\n        }\n\n        enum RefundReason {\n            PRICING_ERROR,\n            PRODUCT_QUALITY,\n            TRANSACTION_ERROR,\n            CUSTOMER_DISPUTE,\n            PROMOTIONAL_ISSUE,\n            OTHER\n        }\n\n        enum RefundStatus {\n            PENDING,\n            APPROVED,\n            REJECTED,\n            PROCESSED,\n            CANCELLED\n        }\n    }\n\n\n    // ========================================================================\n    // SECTION 2: DOMAIN EVENTS\n    // ========================================================================\n    // Events published to Event Bus for downstream consumption.\n    //\n    // Event Categories:\n    // 1. Profile lifecycle events (creation, updates, verification, completeness, lifecycle stage, onboarding)\n    // 2. Partner linking events\n    // 3. Risk assessment events\n    // 4. Refund history events\n    // ========================================================================\n\n    // --- Profile lifecycle Events ---\n\n    DomainEvent ProfileCreated {\n        - String VivaConsumerId\n        - ProfileId profileId\n        - DateTime createdAt\n        - VerificationLevel initialVerificationLevel\n    }\n\n    DomainEvent ProfileUpdated {\n        - String VivaConsumerId\n        - ProfileId profileId\n        - DateTime updatedAt\n        - List<String> changedFields\n    }\n\n    DomainEvent ProfileVerificationChanged {\n        - String VivaConsumerId\n        - VerificationLevel previousLevel\n        - VerificationLevel newLevel\n        - DateTime changedAt\n    }\n\n    DomainEvent ProfileCompletenessChanged {\n        - String VivaConsumerId\n        - int previousScore\n        - int newScore\n        - DateTime changedAt\n    }\n\n    DomainEvent LifeCycleStageChanged {\n        - String VivaConsumerId\n        - LifeCycleStage previousStage\n        - LifeCycleStage newStage\n        - DateTime changedAt\n        - String trigger                   // TRANSACTION_INACTIVITY | ENGAGEMENT_CHANGE | MANUAL_UPDATE\n    }\n\n    DomainEvent OnboardingCompleted {\n        - String VivaConsumerId\n        - DateTime completedAt\n        - int completionPercentage\n        - List<String> completedSteps\n    }\n\n    DomainEvent OnboardingProgressUpdated {\n        - String VivaConsumerId\n        - int previousPercentage\n        - int newPercentage\n        - String completedStep\n        - DateTime updatedAt\n    }\n\n    // --- Partner Linking Events (MOVED from LoyaltyService) ---\n\n    DomainEvent PartnerLinked {\n        - String VivaConsumerId\n        - PartnerType partner\n        - String externalMemberId\n        - DateTime linkedAt\n    }\n\n    DomainEvent PartnerUnlinked {\n        - String VivaConsumerId\n        - PartnerType partner\n        - DateTime unlinkedAt\n        - String reason\n    }\n\n    DomainEvent PartnerLinkChanged {\n        - String VivaConsumerId\n        - PartnerType partner\n        - LinkState previousState\n        - LinkState newState\n        - DateTime changedAt\n    }\n\n    DomainEvent RewardPreferenceChanged {\n        - String VivaConsumerId\n        - RewardPreferenceType previousPreference\n        - RewardPreferenceType newPreference\n        - DateTime changedAt\n        - String changeReason              // USER_SELECTED, PARTNER_UNLINKED, FALLBACK_APPLIED\n        - PartnerType affectedPartner      // Which partner this change affects (if applicable)\n    }\n\n    // --- Risk Assessment Events ---\n\n    DomainEvent RiskStatusChanged {\n        - String VivaConsumerId\n        - RiskLevel previousLevel\n        - RiskLevel newLevel\n        - DateTime changedAt\n        - String trigger                   // REFUND_THRESHOLD | FRAUD_DETECTED | MANUAL_REVIEW\n    }\n\n    DomainEvent FraudIndicatorDetected {\n        - String VivaConsumerId\n        - FraudIndicatorType indicatorType\n        - String description\n        - Severity severity\n        - DateTime detectedAt\n        - boolean requiresInvestigation\n    }\n\n    enum RiskLevel {\n        LOW, MEDIUM, HIGH, CRITICAL\n    }\n\n    enum FraudIndicatorType {\n        MULTIPLE_ACCOUNTS,\n        CHARGEBACK_PATTERN,\n        LOGIN_ANOMALY,\n        TRANSACTION_ANOMALY,\n        REFUND_ABUSE,\n        DISPUTE_PATTERN\n    }\n\n    enum Severity {\n        LOW, MEDIUM, HIGH, CRITICAL\n    }\n\n    // --- Refund History Events ---\n\n    DomainEvent RefundRequested {\n        - RefundId refundId\n        - String VivaConsumerId\n        - TransactionId originalTransactionId\n        - Money refundAmount\n        - RefundReason reason\n        - DateTime requestedAt\n    }\n\n    DomainEvent RefundProcessed {\n        - RefundId refundId\n        - String VivaConsumerId\n        - Money refundAmount\n        - RefundStatus status\n        - DateTime processedAt\n        - int processingTimeDays\n    }\n\n    // ========================================================================\n    // SECTION 3: ORCHESTRATION & QUERY SERVICES\n    // ========================================================================\n    // Services orchestrate calls to external systems and provide query APIs.\n    // ========================================================================\n\n    Service ProfileQueryService {\n        // Query customer profile (Salesforce canonical + OTR enrichment)\n        getProfile(@String VivaConsumerId) : CustomerProfileResponse\n\n        // Query profile completeness\n        getProfileCompleteness(@String VivaConsumerId) : int\n\n        // Query partner links\n        getPartnerLinks(@String VivaConsumerId) : List<CustomerPartnerLink>\n\n        // Query specific partner link status\n        getPartnerLinkStatus(@String VivaConsumerId, @PartnerType partner) : LinkingStatus\n    }\n\n    Service RiskAssessmentService {\n        // Get comprehensive risk assessment (scores + raw factors)\n        getRiskAssessment(@String VivaConsumerId) : RiskAssessmentResponse\n\n        // Calculate risk score from factors\n        calculateRiskScore(@RiskFactors factors) : int\n\n        // Update risk factors\n        updateRiskFactors(@String VivaConsumerId, @RiskFactors factors): void\n\n        // Specific risk queries\n        getFraudRisk(@String VivaConsumerId) : int\n        getRefundRisk(@String VivaConsumerId) : int\n        getChurnRisk(@String VivaConsumerId) : int\n        getCustomerValueScore(@String VivaConsumerId) : int\n    }\n\n    Service RefundHistoryService {\n        // Query refund history\n        getRefundHistory(@String VivaConsumerId) : List<RefundRecord>\n\n        // Record new refund request\n        recordRefund(@RefundRecord refund) : void\n\n        // Calculate refund statistics\n        getRefundStatistics(@String VivaConsumerId) : RefundStatistics\n    }\n\n    Service PartnerLinkService {\n        // Create partner link\n        createPartnerLink(@String VivaConsumerId, @PartnerType partner, @String externalMemberId) : PartnerLinkId\n\n        // Update reward preference\n        updateRewardPreference(@String VivaConsumerId, @RewardPreferenceType preference) : void\n\n        // Sync with partner (calls partner APIs)\n        syncWithPartner(@PartnerLinkId linkId) : boolean\n\n        // Revoke partner link\n        revokePartnerLink(@PartnerLinkId linkId) : void\n    }\n\n    Service EngagementSyncService {\n        // Update cached engagement summary (from EngagementService)\n        updateEngagementSummary(@String VivaConsumerId, @EngagementMetrics metrics) : void\n\n        // Get cached engagement summary\n        getEngagementSummary(@String VivaConsumerId) : CustomerEngagementSummary\n    }\n\n    Service SalesforceProfileAdapter {\n        // ACL for Salesforce integration\n        // Translates between Salesforce Contact/Person Account and OTR profile model\n\n        // Query canonical customer data from Salesforce\n        getCustomer(@String VivaConsumerId) : SalesforceCustomer\n\n        // Resolve email to VCI (for legacy email-keyed lookups)\n        resolveEmailToVCI(@String email) : String\n\n        // Validate VCI exists in Salesforce\n        validateVCI(@String VivaConsumerId) : boolean\n    }\n\n    // ========================================================================\n    // SECTION 4: SHARED VALUE OBJECTS\n    // ========================================================================\n    // Reusable value objects used across multiple aggregates.\n    // ========================================================================\n\n    ValueObject Money {\n        - Decimal amount\n        - String currency                 // AUD, USD\n    }\n\n    ValueObject ProfileId {\n        - String id\n    }\n\n    ValueObject PartnerLinkId {\n        - String id\n    }\n\n    ValueObject RiskAssessmentId {\n        - String id\n    }\n\n    ValueObject RefundId {\n        - String id\n    }\n\n    ValueObject EngagementSummaryId {\n        - String id\n    }\n\n    ValueObject TransactionId {\n        - String id\n    }\n\n    ValueObject CustomerProfileResponse {\n        // Combined response from Salesforce + ProfileService\n        - String VivaConsumerId\n        - SalesforceCustomer salesforceData   // Canonical data from Salesforce\n        - CustomerProfileRecord otrData       // OTR-specific enrichment\n        - List<CustomerPartnerLink> partnerLinks\n        - int completenessScore\n    }\n\n    ValueObject SalesforceCustomer {\n        // Canonical customer data from Salesforce\n        - String VivaConsumerId\n        - String firstName\n        - String lastName\n        - String email\n        - String phone\n        - Address mailingAddress\n        - DateTime createdDate\n        - DateTime lastModifiedDate\n    }\n\n    ValueObject Address {\n        - String street\n        - String city\n        - String state\n        - String postalCode\n        - String country\n    }\n\n    ValueObject RiskAssessmentResponse {\n        // Comprehensive risk assessment with scores and raw factors\n        - String VivaConsumerId\n        - DateTime assessedAt\n\n        // Computed Scores\n        - int overallRiskScore\n        - int fraudRiskScore\n        - int refundRiskScore\n        - int churnRiskScore\n        - int customerValueScore\n\n        // Raw Factors (for transparency and custom scoring)\n        - RiskFactors factors\n\n        // Aggregated from Other Services\n        - String loyaltyTier              // From LoyaltyService\n        - int loyaltyPointsBalance        // From LoyaltyService\n    }\n\n    ValueObject RefundStatistics {\n        - int totalRefundCount\n        - Money totalRefundAmount\n        - Decimal refundToPurchaseRatio\n        - Money averageRefundAmount\n        - int refundsLast30Days\n        - int refundsLast90Days\n        - List<String> topRefundReasons\n    }\n\n    ValueObject EngagementMetrics {\n        // Metrics from EngagementService for caching\n        - int emailOpenRate\n        - int emailClickRate\n        - int pushNotificationEngagement\n        - int campaignResponseCount\n        - DateTime lastCampaignInteraction\n        - EngagementTier engagementTier\n    }\n\n    // ========================================================================\n    // SECTION 5: REPOSITORIES (Persistence Abstractions)\n    // ========================================================================\n    // Repository interfaces define persistence operations for owned aggregates.\n    // ========================================================================\n\n    // Repository CustomerProfileRepository\n    // Repository PartnerLinkRepository\n    // Repository RiskAssessmentRepository\n    // Repository RefundHistoryRepository\n    // Repository EngagementSummaryRepository\n}\n\n// ============================================================================\n// END OF BOUNDED CONTEXT\n// ============================================================================\n//\n// Implementation Notes:\n// - Database: Azure SQL (optimized for high-frequency updates)\n// - Events published to Event Bus topic: \"profile-events\"\n// - Salesforce integration via REST API with OAuth 2.0\n// - EngagementService integration via Event Bus + batch sync\n// - LoyaltyService queries ProfileService synchronously\n// - Admin portal enhanced to use ProfileService APIs\n// - VCI introduced through Flybuys initiative\n// ============================================================================\n","structuredPatch":[{"oldStart":589,"oldLines":11,"newStart":589,"newLines":16,"lines":["     Service SalesforceProfileAdapter {","         // ACL for Salesforce integration","         // Translates between Salesforce Contact/Person Account and OTR profile model","+        //","+        // INITIATIVES:","+        // - OTR-001 Salesforce Customer Support: Just-In-Time Contact reconciliation (upsert by email)","+        // - OTR-002 Flybuys Integration: VCI-based customer identification"," ","         // Query canonical customer data from Salesforce","         getCustomer(@String VivaConsumerId) : SalesforceCustomer"," ","         // Resolve email to VCI (for legacy email-keyed lookups)","+        // Used by OTR-001 for Just-In-Time Contact reconciliation","         resolveEmailToVCI(@String email) : String"," ","         // Validate VCI exists in Salesforce"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"b72bcb2c-e979-4294-86f4-6e3135dc0400"}
{"parentUuid":"d3b1b39d-dcb9-49be-88ed-db1740a516f7","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01Ko3U4sApG3aXaUFT6d5Ufc","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Great! Now let me add a note to the implementation notes section at the bottom of the CML file to reference the initiatives.","signature":"EqUCCkYICxgCKkB01BaNBnDFLoq3RAWxdhS0wFWYkagE7/7ljL6w4Ugdu113/QqN/6y8wRoXou7UV233eMZbxpAwF7EppH+irsc7EgyCCkXV6jQ94rLTUUQaDLG3uvNxwP26/e/ifCIwC5PSkDthCOhszuWgCwo77s5fCRIjnpfMTg1jJ05ms1D3tLjd0SzORHqV9aiLx4gxKowBvqcF6PIBJiQEfsCD+D/FC/Y9CR4xu7E6TVg2k6Uvpiw8z8wVrJY5k0SpBsuqR/vA2sz3hZApqKd4QKod3/njU7/9HdMfyI7GoTMmuQY+Bbb3MfWqjp3NlfinjetzO5q6DIXdEyEQ1DSuoX+uipRxIy5ShlV54WZisbMNHWzQJ5mKx1zP+6ubaU8f1bEYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":1685,"cache_read_input_tokens":84668,"cache_creation":{"ephemeral_5m_input_tokens":1685,"ephemeral_1h_input_tokens":0},"output_tokens":7,"service_tier":"standard"}},"requestId":"req_011CWwBTRYrZZhNcaao3gmTV","type":"assistant","uuid":"4ed784b2-0938-43f4-9574-3f48d28c64cf","timestamp":"2026-01-09T04:34:31.809Z"}
{"parentUuid":"4ed784b2-0938-43f4-9574-3f48d28c64cf","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01Ko3U4sApG3aXaUFT6d5Ufc","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Efgj43xhBjUPpbek5h5x5X","name":"Edit","input":{"replace_all":false,"file_path":"/mnt/c/Users/o.young/work/architecture/bounded_context/profile.cml","old_string":"// ============================================================================\n// END OF BOUNDED CONTEXT\n// ============================================================================\n//\n// Implementation Notes:\n// - Database: Azure SQL (optimized for high-frequency updates)\n// - Events published to Event Bus topic: \"profile-events\"\n// - Salesforce integration via REST API with OAuth 2.0\n// - EngagementService integration via Event Bus + batch sync\n// - LoyaltyService queries ProfileService synchronously\n// - Admin portal enhanced to use ProfileService APIs\n// - VCI introduced through Flybuys initiative\n// ============================================================================","new_string":"// ============================================================================\n// END OF BOUNDED CONTEXT\n// ============================================================================\n//\n// Implementation Notes:\n// - Database: Azure SQL (optimized for high-frequency updates)\n// - Events published to Event Bus topic: \"profile-events\"\n// - Salesforce integration via REST API with OAuth 2.0\n// - EngagementService integration via Event Bus + batch sync\n// - LoyaltyService queries ProfileService synchronously\n// - Admin portal enhanced to use ProfileService APIs\n//\n// Initiative Delivery:\n// - OTR-001 (Salesforce Customer Support): SalesforceProfileAdapter, CustomerProfile aggregate\n//   * Just-In-Time Contact reconciliation (upsert by email)\n//   * Contact ID resolution for feedback submission\n// - OTR-002 (Flybuys Integration): PartnerLink aggregate, partner linking services\n//   * OAuth partner account linking (Flybuys, Shell)\n//   * Reward preference management\n//   * VCI as universal customer identifier established\n//\n// Sequencing Flexibility:\n// - Either initiative can deliver ProfileService first\n// - Other initiative reuses foundation and adds its specific aggregates\n// - Both initiatives benefit from shared Salesforce integration patterns\n// ============================================================================"}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":1685,"cache_read_input_tokens":84668,"cache_creation":{"ephemeral_5m_input_tokens":1685,"ephemeral_1h_input_tokens":0},"output_tokens":577,"service_tier":"standard"}},"requestId":"req_011CWwBTRYrZZhNcaao3gmTV","type":"assistant","uuid":"30747ac0-6a41-4c5a-be4c-b79ad6328676","timestamp":"2026-01-09T04:34:39.740Z"}
{"parentUuid":"30747ac0-6a41-4c5a-be4c-b79ad6328676","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Efgj43xhBjUPpbek5h5x5X","type":"tool_result","content":"The file /mnt/c/Users/o.young/work/architecture/bounded_context/profile.cml has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n   721→    // Repository RefundHistoryRepository\n   722→    // Repository EngagementSummaryRepository\n   723→}\n   724→\n   725→// ============================================================================\n   726→// END OF BOUNDED CONTEXT\n   727→// ============================================================================\n   728→//\n   729→// Implementation Notes:\n   730→// - Database: Azure SQL (optimized for high-frequency updates)\n   731→// - Events published to Event Bus topic: \"profile-events\"\n   732→// - Salesforce integration via REST API with OAuth 2.0\n   733→// - EngagementService integration via Event Bus + batch sync\n   734→// - LoyaltyService queries ProfileService synchronously\n   735→// - Admin portal enhanced to use ProfileService APIs\n   736→//\n   737→// Initiative Delivery:\n   738→// - OTR-001 (Salesforce Customer Support): SalesforceProfileAdapter, CustomerProfile aggregate\n   739→//   * Just-In-Time Contact reconciliation (upsert by email)\n   740→//   * Contact ID resolution for feedback submission\n   741→// - OTR-002 (Flybuys Integration): PartnerLink aggregate, partner linking services\n   742→//   * OAuth partner account linking (Flybuys, Shell)\n   743→//   * Reward preference management\n   744→//   * VCI as universal customer identifier established\n   745→//\n   746→// Sequencing Flexibility:\n   747→// - Either initiative can deliver ProfileService first\n   748→// - Other initiative reuses foundation and adds its specific aggregates\n   749→// - Both initiatives benefit from shared Salesforce integration patterns\n   750→// ============================================================================\n   751→"}]},"uuid":"fb24dd8f-0c88-461b-b33c-6f01ee184160","timestamp":"2026-01-09T04:34:39.933Z","toolUseResult":{"filePath":"/mnt/c/Users/o.young/work/architecture/bounded_context/profile.cml","oldString":"// ============================================================================\n// END OF BOUNDED CONTEXT\n// ============================================================================\n//\n// Implementation Notes:\n// - Database: Azure SQL (optimized for high-frequency updates)\n// - Events published to Event Bus topic: \"profile-events\"\n// - Salesforce integration via REST API with OAuth 2.0\n// - EngagementService integration via Event Bus + batch sync\n// - LoyaltyService queries ProfileService synchronously\n// - Admin portal enhanced to use ProfileService APIs\n// - VCI introduced through Flybuys initiative\n// ============================================================================","newString":"// ============================================================================\n// END OF BOUNDED CONTEXT\n// ============================================================================\n//\n// Implementation Notes:\n// - Database: Azure SQL (optimized for high-frequency updates)\n// - Events published to Event Bus topic: \"profile-events\"\n// - Salesforce integration via REST API with OAuth 2.0\n// - EngagementService integration via Event Bus + batch sync\n// - LoyaltyService queries ProfileService synchronously\n// - Admin portal enhanced to use ProfileService APIs\n//\n// Initiative Delivery:\n// - OTR-001 (Salesforce Customer Support): SalesforceProfileAdapter, CustomerProfile aggregate\n//   * Just-In-Time Contact reconciliation (upsert by email)\n//   * Contact ID resolution for feedback submission\n// - OTR-002 (Flybuys Integration): PartnerLink aggregate, partner linking services\n//   * OAuth partner account linking (Flybuys, Shell)\n//   * Reward preference management\n//   * VCI as universal customer identifier established\n//\n// Sequencing Flexibility:\n// - Either initiative can deliver ProfileService first\n// - Other initiative reuses foundation and adds its specific aggregates\n// - Both initiatives benefit from shared Salesforce integration patterns\n// ============================================================================","originalFile":"/*\n * ProfileService - Bounded Context Definition\n * ============================================\n *\n * Unified customer profile service providing enriched customer data for OTR ecosystem.\n *\n * RELATED INITIATIVES:\n * - OTR-001 Salesforce Customer Support: Just-In-Time Contact reconciliation with Salesforce\n * - OTR-002 Flybuys Integration: Partner account linking and reward preference management\n *\n * NOTE: ProfileService is a foundational bounded context supporting multiple strategic initiatives.\n * Depending on sequencing, capabilities may be delivered incrementally across either initiative.\n *\n * See profile.adoc for comprehensive architecture documentation, decision log, and patterns.\n */\n\nimport \"../domains/profile.cml\"\n\nBoundedContext ProfileService implements ProfileDomain {\n\n    type = APPLICATION\n\n    // Strategic DDD Classification: CORE_DOMAIN | SUPPORTING_DOMAIN | GENERIC_DOMAIN\n    // CORE_DOMAIN: Competitive differentiator - customer intelligence, risk assessment, and behavioral\n    // insights drive personalization and business outcomes\n    strategicClassification = \"CORE_DOMAIN\"\n\n    domainVisionStatement = \"Provide unified, enriched customer profiles bridging Salesforce canonical data with OTR-specific attributes, behavioral insights, and risk assessments\"\n\n    responsibilities = \"OTRG-specific customer profile management\",\n                      \"Customer lifecycle stage and onboarding tracking\",\n                      \"Partner linking status tracking\",\n                      \"Customer risk assessment (fraud, refund, churn)\",\n                      \"Refund history tracking\",\n                      \"Engagement metrics caching for profile enrichment\"\n\n    implementationTechnology = \"Azure Functions, .NET Core, Azure SQL, Salesforce API, Event Bus\"\n\n    // ========================================================================\n    // SECTION 1: CORE AGGREGATES\n    // ========================================================================\n    // Aggregates represent transactional consistency boundaries.\n    // Each aggregate root controls access to entities within its boundary.\n    // ========================================================================\n\n    // 1.1 CustomerProfile Aggregate\n    // ------------------------------\n    // OTR-specific customer profile attributes enriching Salesforce canonical data.\n    // Stores behavioral data, preferences, and app-specific attributes.\n    //\n    // Invariants:\n    // - Must have valid VCI reference to Salesforce\n    // - Email verification status must be tracked\n    // - Account status must be valid enum value\n    // - Profile completeness score must be 0-100\n    // - Onboarding completion percentage must be 0-100\n    // - lifecycle stage must be valid enum value\n    //\n    // Bounded Context Note:\n    // - Canonical customer data (name, email, phone) owned by Salesforce\n    // - ProfileService stores OTR-specific enrichment only\n    // - Queries Salesforce for canonical data, does not cache it\n    Aggregate CustomerProfile {\n        Entity CustomerProfileRecord {\n            aggregateRoot\n\n            - ProfileId id\n            - String VivaConsumerId           // Salesforce customer identifier (VCI)\n            - AccountStatus status\n            - DateTime createdAt\n            - DateTime lastUpdatedAt\n            - DateTime lastLoginAt\n\n            // Identity Verification\n            - IdentityVerification verification\n\n            // App Preferences\n            - AppPreferences appPreferences\n\n            // Profile Completeness\n            - int completenessScore          // 0-100 calculated score\n\n            // Customer lifecycle\n            - LifeCycleStage lifeCycleStage  // PROSPECT | NEW | ACTIVE | DORMANT | AT_RISK | CHURNED\n            - DateTime lifeCycleChangedAt\n\n            // Onboarding Progress\n            - OnboardingStatus onboardingStatus\n            - int onboardingCompletionPercentage  // 0-100\n            - DateTime onboardingCompletedAt\n\n            // Customer Value\n            - CustomerValue valueMetrics\n\n            // Special Handling\n            - boolean isStaffMember          // Employee customer flag\n\n            // Operations\n            def updateLastLogin(): void\n            def calculateCompletenessScore(): int\n            def updateLifeCycleStage(newStage: LifeCycleStage): void\n            def updateOnboardingProgress(percentage: int): void\n        }\n\n        ValueObject IdentityVerification {\n            - boolean emailVerified\n            - boolean phoneVerified\n            - VerificationLevel level        // UNVERIFIED | BASIC | FULL\n            - DateTime lastVerifiedAt\n        }\n\n        ValueObject AppPreferences {\n            - String preferredStore\n            - String languagePreference      // ISO 639-1 code (en, zh, vi, etc.)\n            - boolean pushNotificationsEnabled\n            - boolean locationServicesEnabled\n            - String preferredPaymentMethod\n            - Map<String, String> customPreferences\n        }\n\n        ValueObject CustomerValue {\n            - Money lifetimeValue\n            - Money totalSpend\n            - int transactionCount\n            - Money averageBasketValue\n            - DateTime firstPurchaseDate\n            - ProfitabilityScore profitability\n        }\n\n        enum VerificationLevel {\n            UNVERIFIED,                      // No verification\n            BASIC,                           // Email or phone verified\n            FULL                             // Multiple factors verified\n        }\n\n        enum ProfitabilityScore {\n            LOW, MEDIUM, HIGH, VIP\n        }\n\n        enum LifeCycleStage {\n            PROSPECT,                        // Registered but no purchase\n            NEW,                             // First purchase within 90 days\n            ACTIVE,                          // Regular transactions\n            DORMANT,                         // No transactions 90+ days\n            AT_RISK,                         // Declining engagement/transactions\n            CHURNED                          // No transactions 180+ days\n        }\n\n        enum OnboardingStatus {\n            NOT_STARTED,                     // Account created, onboarding not begun\n            IN_PROGRESS,                     // Onboarding steps partially complete\n            COMPLETED,                       // All onboarding steps finished\n            SKIPPED                          // User skipped onboarding flow\n        }\n    }\n\n    // 1.2 PartnerLink Aggregate\n    // ------------------------------------------------------\n    // Records customer linkages to external loyalty partners (Flybuys, Shell).\n    // Tracks linking status and synchronization state for partner integrations.\n    //\n    // INITIATIVE: OTR-002 Flybuys Integration\n    // - Manages customer partner account linking via OAuth\n    // - Tracks reward preference selection (Flybuys Points vs Fuel Discount vs OTR Rewards)\n    // - Enables Flybuys earning at POS\n    //\n    // Invariants:\n    // - Customer can only have one active link per partner type\n    // - External member ID must be unique within partner\n    // - Reward preference must be one of: FLYBUYS_POINTS, FUEL_DISCOUNT_SHELL, OTR_REWARDS\n    // - If preference is FLYBUYS_POINTS, PartnerLink must exist with status=LINKED\n    // - Default preference when no partner linked: OTR_REWARDS (fallback)\n    //\n    // Bounded Context Note:\n    // - OAuth tokens are managed by infrastructure OAuth Service\n    // - This aggregate tracks: \"customer linked partner account\"\n    // - Created in response to OAuthLinkEstablished event from OAuth Service\n    Aggregate PartnerLink {\n        Entity CustomerPartnerLink {\n            aggregateRoot\n\n            - PartnerLinkId id\n            - String VivaConsumerId           // Salesforce customer identifier\n            - PartnerType partner             // FLYBUYS, SHELL_CARD\n            - String externalMemberId         // Partner's member/account number\n            - LinkingStatus status\n            - RewardPreference rewardPreference   // Customer's chosen reward type\n            - DateTime linkedAt\n            - DateTime lastSyncedAt           // Last successful sync\n            - String oauthProviderId          // Reference to OAuth Service token\n\n            // Operations\n            def updateRewardPreference(newPreference: RewardPreference): void {\n                // Invariant: Cannot select FLYBUYS_POINTS unless Flybuys account linked\n                // Invariant: Unlinking Flybuys resets preference to OTR_REWARDS (fallback)\n            }\n\n            def recordSync(syncStatus: SyncStatus): void\n        }\n\n        ValueObject LinkingStatus {\n            - LinkState state                 // LINKED, UNLINKED, SYNC_FAILED\n            - String errorMessage\n            - int failedSyncAttempts\n        }\n\n        ValueObject RewardPreference {\n            - RewardPreferenceType type       // FLYBUYS_POINTS, FUEL_DISCOUNT_SHELL, OTR_REWARDS\n        }\n\n        enum LinkState {\n            LINKED,                           // Active partner link\n            UNLINKED,                         // No partner link\n            SYNC_FAILED                       // Link exists but sync failing\n        }\n\n        enum RewardPreferenceType {\n            FLYBUYS_POINTS,                   // Earn Flybuys points (requires linking)\n            FUEL_DISCOUNT_SHELL,              // Shell Price Save fuel discount (4c/L)\n            OTR_REWARDS                       // OTR native loyalty points (default fallback)\n        }\n\n        enum PartnerType {\n            FLYBUYS, SHELL_CARD\n        }\n    }\n\n    // 1.3 RiskAssessment Aggregate\n    // -----------------------------\n    // Customer risk, fraud, and value scores for instant refund decisions.\n    // Provides both computed scores and raw factors for transparency.\n    //\n    // Invariants:\n    // - Risk scores must be 0-100\n    // - Assessment must have calculated timestamp\n    // - Factors must be populated when score is calculated\n    //\n    // Use Case: Instant Refunds\n    // - Provides scored assessment to other business units\n    // - Exposes raw factors for custom scoring logic\n    // - Enables risk-based refund approval workflows\n    Aggregate RiskAssessment {\n        Entity CustomerRiskAssessment {\n            aggregateRoot\n\n            - RiskAssessmentId id\n            - String VivaConsumerId\n            - DateTime assessedAt\n            - DateTime lastUpdatedAt\n\n            // Computed Scores (0-100)\n            - int overallRiskScore           // Combined risk score\n            - int fraudRiskScore             // Fraud-specific risk\n            - int refundRiskScore            // Refund abuse risk\n            - int churnRiskScore             // Customer churn/attrition risk\n            - int customerValueScore         // Customer lifetime value score\n\n            // Risk Factors (raw data for transparency)\n            - RiskFactors factors\n\n            // Operations\n            def calculateRiskScore(): int\n            def updateFactors(newFactors: RiskFactors): void\n        }\n\n        ValueObject RiskFactors {\n            // Refund History\n            - int totalRefundCount\n            - int refundsLast30Days\n            - int refundsLast60Days\n            - int refundsLast90Days\n            - Money totalRefundAmount\n            - Decimal refundToPurchaseRatio\n            - List<String> refundReasonDistribution\n\n            // Transaction Behavior\n            - int transactionFrequency       // Transactions per month\n            - DateTime lastTransactionDate\n            - Money averageBasketValue\n            - Decimal basketValueVariance\n            - int locationDiversity          // Number of unique stores visited\n            - boolean hasUnusualPatterns\n\n            // Fraud Indicators\n            - int disputedTransactionCount\n            - int chargebackCount\n            - Decimal failedPaymentRate\n            - boolean multipleAccountDetected\n            - boolean loginAnomaliesDetected\n            - int fraudFlagCount\n\n            // Account Health\n            - int accountTenureDays\n            - VerificationLevel verificationLevel\n            - AccountStatus accountStatus\n\n            // Engagement Metrics (cached from EngagementService)\n            - int appUsageFrequency          // Logins per week\n            - DateTime lastLoginDate\n            - int supportInteractionCount\n            - Decimal campaignEngagementRate\n\n            // Churn Indicators\n            - int daysSinceLastPurchase\n            - int daysSinceLastLogin\n            - Decimal transactionFrequencyTrend  // +/- percentage change\n            - Decimal basketValueTrend           // +/- percentage change\n            - boolean engagementDeclining        // Trend analysis flag\n            - LifeCycleStage currentLifeCycleStage\n\n            // Customer Value\n            - Money lifetimeValue\n            - Money totalSpend\n            - ProfitabilityScore profitability\n        }\n\n        enum AccountStatus {\n            ACTIVE, SUSPENDED, FLAGGED, CLOSED\n        }\n    }\n\n    // 1.4 RefundHistory Aggregate\n    // ----------------------------\n    // Customer refund transaction history for risk assessment.\n    //\n    // Invariants:\n    // - Refund amount must be positive\n    // - Refund must reference original transaction\n    // - Refund reason must be provided\n    Aggregate RefundHistory {\n        Entity RefundRecord {\n            aggregateRoot\n\n            - RefundId id\n            - String VivaConsumerId\n            - TransactionId originalTransactionId\n            - Money refundAmount\n            - RefundReason reason\n            - RefundStatus status\n            - DateTime requestedAt\n            - DateTime processedAt\n            - String processedBy              // System or agent identifier\n            - int processingTimeDays          // Turnaround time tracking\n        }\n\n        enum RefundReason {\n            PRICING_ERROR,\n            PRODUCT_QUALITY,\n            TRANSACTION_ERROR,\n            CUSTOMER_DISPUTE,\n            PROMOTIONAL_ISSUE,\n            OTHER\n        }\n\n        enum RefundStatus {\n            PENDING,\n            APPROVED,\n            REJECTED,\n            PROCESSED,\n            CANCELLED\n        }\n    }\n\n\n    // ========================================================================\n    // SECTION 2: DOMAIN EVENTS\n    // ========================================================================\n    // Events published to Event Bus for downstream consumption.\n    //\n    // Event Categories:\n    // 1. Profile lifecycle events (creation, updates, verification, completeness, lifecycle stage, onboarding)\n    // 2. Partner linking events\n    // 3. Risk assessment events\n    // 4. Refund history events\n    // ========================================================================\n\n    // --- Profile lifecycle Events ---\n\n    DomainEvent ProfileCreated {\n        - String VivaConsumerId\n        - ProfileId profileId\n        - DateTime createdAt\n        - VerificationLevel initialVerificationLevel\n    }\n\n    DomainEvent ProfileUpdated {\n        - String VivaConsumerId\n        - ProfileId profileId\n        - DateTime updatedAt\n        - List<String> changedFields\n    }\n\n    DomainEvent ProfileVerificationChanged {\n        - String VivaConsumerId\n        - VerificationLevel previousLevel\n        - VerificationLevel newLevel\n        - DateTime changedAt\n    }\n\n    DomainEvent ProfileCompletenessChanged {\n        - String VivaConsumerId\n        - int previousScore\n        - int newScore\n        - DateTime changedAt\n    }\n\n    DomainEvent LifeCycleStageChanged {\n        - String VivaConsumerId\n        - LifeCycleStage previousStage\n        - LifeCycleStage newStage\n        - DateTime changedAt\n        - String trigger                   // TRANSACTION_INACTIVITY | ENGAGEMENT_CHANGE | MANUAL_UPDATE\n    }\n\n    DomainEvent OnboardingCompleted {\n        - String VivaConsumerId\n        - DateTime completedAt\n        - int completionPercentage\n        - List<String> completedSteps\n    }\n\n    DomainEvent OnboardingProgressUpdated {\n        - String VivaConsumerId\n        - int previousPercentage\n        - int newPercentage\n        - String completedStep\n        - DateTime updatedAt\n    }\n\n    // --- Partner Linking Events (MOVED from LoyaltyService) ---\n\n    DomainEvent PartnerLinked {\n        - String VivaConsumerId\n        - PartnerType partner\n        - String externalMemberId\n        - DateTime linkedAt\n    }\n\n    DomainEvent PartnerUnlinked {\n        - String VivaConsumerId\n        - PartnerType partner\n        - DateTime unlinkedAt\n        - String reason\n    }\n\n    DomainEvent PartnerLinkChanged {\n        - String VivaConsumerId\n        - PartnerType partner\n        - LinkState previousState\n        - LinkState newState\n        - DateTime changedAt\n    }\n\n    DomainEvent RewardPreferenceChanged {\n        - String VivaConsumerId\n        - RewardPreferenceType previousPreference\n        - RewardPreferenceType newPreference\n        - DateTime changedAt\n        - String changeReason              // USER_SELECTED, PARTNER_UNLINKED, FALLBACK_APPLIED\n        - PartnerType affectedPartner      // Which partner this change affects (if applicable)\n    }\n\n    // --- Risk Assessment Events ---\n\n    DomainEvent RiskStatusChanged {\n        - String VivaConsumerId\n        - RiskLevel previousLevel\n        - RiskLevel newLevel\n        - DateTime changedAt\n        - String trigger                   // REFUND_THRESHOLD | FRAUD_DETECTED | MANUAL_REVIEW\n    }\n\n    DomainEvent FraudIndicatorDetected {\n        - String VivaConsumerId\n        - FraudIndicatorType indicatorType\n        - String description\n        - Severity severity\n        - DateTime detectedAt\n        - boolean requiresInvestigation\n    }\n\n    enum RiskLevel {\n        LOW, MEDIUM, HIGH, CRITICAL\n    }\n\n    enum FraudIndicatorType {\n        MULTIPLE_ACCOUNTS,\n        CHARGEBACK_PATTERN,\n        LOGIN_ANOMALY,\n        TRANSACTION_ANOMALY,\n        REFUND_ABUSE,\n        DISPUTE_PATTERN\n    }\n\n    enum Severity {\n        LOW, MEDIUM, HIGH, CRITICAL\n    }\n\n    // --- Refund History Events ---\n\n    DomainEvent RefundRequested {\n        - RefundId refundId\n        - String VivaConsumerId\n        - TransactionId originalTransactionId\n        - Money refundAmount\n        - RefundReason reason\n        - DateTime requestedAt\n    }\n\n    DomainEvent RefundProcessed {\n        - RefundId refundId\n        - String VivaConsumerId\n        - Money refundAmount\n        - RefundStatus status\n        - DateTime processedAt\n        - int processingTimeDays\n    }\n\n    // ========================================================================\n    // SECTION 3: ORCHESTRATION & QUERY SERVICES\n    // ========================================================================\n    // Services orchestrate calls to external systems and provide query APIs.\n    // ========================================================================\n\n    Service ProfileQueryService {\n        // Query customer profile (Salesforce canonical + OTR enrichment)\n        getProfile(@String VivaConsumerId) : CustomerProfileResponse\n\n        // Query profile completeness\n        getProfileCompleteness(@String VivaConsumerId) : int\n\n        // Query partner links\n        getPartnerLinks(@String VivaConsumerId) : List<CustomerPartnerLink>\n\n        // Query specific partner link status\n        getPartnerLinkStatus(@String VivaConsumerId, @PartnerType partner) : LinkingStatus\n    }\n\n    Service RiskAssessmentService {\n        // Get comprehensive risk assessment (scores + raw factors)\n        getRiskAssessment(@String VivaConsumerId) : RiskAssessmentResponse\n\n        // Calculate risk score from factors\n        calculateRiskScore(@RiskFactors factors) : int\n\n        // Update risk factors\n        updateRiskFactors(@String VivaConsumerId, @RiskFactors factors): void\n\n        // Specific risk queries\n        getFraudRisk(@String VivaConsumerId) : int\n        getRefundRisk(@String VivaConsumerId) : int\n        getChurnRisk(@String VivaConsumerId) : int\n        getCustomerValueScore(@String VivaConsumerId) : int\n    }\n\n    Service RefundHistoryService {\n        // Query refund history\n        getRefundHistory(@String VivaConsumerId) : List<RefundRecord>\n\n        // Record new refund request\n        recordRefund(@RefundRecord refund) : void\n\n        // Calculate refund statistics\n        getRefundStatistics(@String VivaConsumerId) : RefundStatistics\n    }\n\n    Service PartnerLinkService {\n        // Create partner link\n        createPartnerLink(@String VivaConsumerId, @PartnerType partner, @String externalMemberId) : PartnerLinkId\n\n        // Update reward preference\n        updateRewardPreference(@String VivaConsumerId, @RewardPreferenceType preference) : void\n\n        // Sync with partner (calls partner APIs)\n        syncWithPartner(@PartnerLinkId linkId) : boolean\n\n        // Revoke partner link\n        revokePartnerLink(@PartnerLinkId linkId) : void\n    }\n\n    Service EngagementSyncService {\n        // Update cached engagement summary (from EngagementService)\n        updateEngagementSummary(@String VivaConsumerId, @EngagementMetrics metrics) : void\n\n        // Get cached engagement summary\n        getEngagementSummary(@String VivaConsumerId) : CustomerEngagementSummary\n    }\n\n    Service SalesforceProfileAdapter {\n        // ACL for Salesforce integration\n        // Translates between Salesforce Contact/Person Account and OTR profile model\n        //\n        // INITIATIVES:\n        // - OTR-001 Salesforce Customer Support: Just-In-Time Contact reconciliation (upsert by email)\n        // - OTR-002 Flybuys Integration: VCI-based customer identification\n\n        // Query canonical customer data from Salesforce\n        getCustomer(@String VivaConsumerId) : SalesforceCustomer\n\n        // Resolve email to VCI (for legacy email-keyed lookups)\n        // Used by OTR-001 for Just-In-Time Contact reconciliation\n        resolveEmailToVCI(@String email) : String\n\n        // Validate VCI exists in Salesforce\n        validateVCI(@String VivaConsumerId) : boolean\n    }\n\n    // ========================================================================\n    // SECTION 4: SHARED VALUE OBJECTS\n    // ========================================================================\n    // Reusable value objects used across multiple aggregates.\n    // ========================================================================\n\n    ValueObject Money {\n        - Decimal amount\n        - String currency                 // AUD, USD\n    }\n\n    ValueObject ProfileId {\n        - String id\n    }\n\n    ValueObject PartnerLinkId {\n        - String id\n    }\n\n    ValueObject RiskAssessmentId {\n        - String id\n    }\n\n    ValueObject RefundId {\n        - String id\n    }\n\n    ValueObject EngagementSummaryId {\n        - String id\n    }\n\n    ValueObject TransactionId {\n        - String id\n    }\n\n    ValueObject CustomerProfileResponse {\n        // Combined response from Salesforce + ProfileService\n        - String VivaConsumerId\n        - SalesforceCustomer salesforceData   // Canonical data from Salesforce\n        - CustomerProfileRecord otrData       // OTR-specific enrichment\n        - List<CustomerPartnerLink> partnerLinks\n        - int completenessScore\n    }\n\n    ValueObject SalesforceCustomer {\n        // Canonical customer data from Salesforce\n        - String VivaConsumerId\n        - String firstName\n        - String lastName\n        - String email\n        - String phone\n        - Address mailingAddress\n        - DateTime createdDate\n        - DateTime lastModifiedDate\n    }\n\n    ValueObject Address {\n        - String street\n        - String city\n        - String state\n        - String postalCode\n        - String country\n    }\n\n    ValueObject RiskAssessmentResponse {\n        // Comprehensive risk assessment with scores and raw factors\n        - String VivaConsumerId\n        - DateTime assessedAt\n\n        // Computed Scores\n        - int overallRiskScore\n        - int fraudRiskScore\n        - int refundRiskScore\n        - int churnRiskScore\n        - int customerValueScore\n\n        // Raw Factors (for transparency and custom scoring)\n        - RiskFactors factors\n\n        // Aggregated from Other Services\n        - String loyaltyTier              // From LoyaltyService\n        - int loyaltyPointsBalance        // From LoyaltyService\n    }\n\n    ValueObject RefundStatistics {\n        - int totalRefundCount\n        - Money totalRefundAmount\n        - Decimal refundToPurchaseRatio\n        - Money averageRefundAmount\n        - int refundsLast30Days\n        - int refundsLast90Days\n        - List<String> topRefundReasons\n    }\n\n    ValueObject EngagementMetrics {\n        // Metrics from EngagementService for caching\n        - int emailOpenRate\n        - int emailClickRate\n        - int pushNotificationEngagement\n        - int campaignResponseCount\n        - DateTime lastCampaignInteraction\n        - EngagementTier engagementTier\n    }\n\n    // ========================================================================\n    // SECTION 5: REPOSITORIES (Persistence Abstractions)\n    // ========================================================================\n    // Repository interfaces define persistence operations for owned aggregates.\n    // ========================================================================\n\n    // Repository CustomerProfileRepository\n    // Repository PartnerLinkRepository\n    // Repository RiskAssessmentRepository\n    // Repository RefundHistoryRepository\n    // Repository EngagementSummaryRepository\n}\n\n// ============================================================================\n// END OF BOUNDED CONTEXT\n// ============================================================================\n//\n// Implementation Notes:\n// - Database: Azure SQL (optimized for high-frequency updates)\n// - Events published to Event Bus topic: \"profile-events\"\n// - Salesforce integration via REST API with OAuth 2.0\n// - EngagementService integration via Event Bus + batch sync\n// - LoyaltyService queries ProfileService synchronously\n// - Admin portal enhanced to use ProfileService APIs\n// - VCI introduced through Flybuys initiative\n// ============================================================================\n","structuredPatch":[{"oldStart":733,"oldLines":5,"newStart":733,"newLines":18,"lines":[" // - EngagementService integration via Event Bus + batch sync"," // - LoyaltyService queries ProfileService synchronously"," // - Admin portal enhanced to use ProfileService APIs","-// - VCI introduced through Flybuys initiative","+//","+// Initiative Delivery:","+// - OTR-001 (Salesforce Customer Support): SalesforceProfileAdapter, CustomerProfile aggregate","+//   * Just-In-Time Contact reconciliation (upsert by email)","+//   * Contact ID resolution for feedback submission","+// - OTR-002 (Flybuys Integration): PartnerLink aggregate, partner linking services","+//   * OAuth partner account linking (Flybuys, Shell)","+//   * Reward preference management","+//   * VCI as universal customer identifier established","+//","+// Sequencing Flexibility:","+// - Either initiative can deliver ProfileService first","+// - Other initiative reuses foundation and adds its specific aggregates","+// - Both initiatives benefit from shared Salesforce integration patterns"," // ============================================================================"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"30747ac0-6a41-4c5a-be4c-b79ad6328676"}
{"parentUuid":"fb24dd8f-0c88-461b-b33c-6f01ee184160","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01CHLmdJ6mgwd68RqNWhmi5x","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Excellent! Now let me update the Decision 1 in profile.adoc to mention that VCI is introduced through either initiative (not just Flybuys as currently stated).","signature":"EsgCCkYICxgCKkCsOQCOY8kAEenmnCtyVdfMW1R2o3LF76jnGcS73sFurTWqihQTKnnxtOY3o4lQeto7hl675C0KXWcqfjqhDVkHEgw/6Z+deJBa43FO4EIaDJLjFgrujGCwbn/C7SIwb4xzdk/qOBivP27li4L/13pUpMb5VUkNCH/W0VvCVvNnk38TC0zPDaqkGPcU5moKKq8BdqLy1N3EKUajcNvalUbaeRB1qxsWMSQKPpZ8R6E3h3Lciu/e/Ro26ryJ+WUlsc93H7QzlNXw5Iu1L+qfTPlTSRdQjT5d1MJEmfqN5Kd0NDCkJnL4vHxXuHWV/HHK/EKpBGPdaoE/aObB6gI2Q+jC958yneIK9YgivM15leWqLIXhx0TiqlJdSCGTEFu3Gc9IVByhyzFoDdQNUW8FnxoGchKdZCjy1PTq0lIHGGfxGhgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":1050,"cache_read_input_tokens":86353,"cache_creation":{"ephemeral_5m_input_tokens":1050,"ephemeral_1h_input_tokens":0},"output_tokens":9,"service_tier":"standard"}},"requestId":"req_011CWwBUJR1wPeeTM6mG26DC","type":"assistant","uuid":"e4d4410b-973c-43d5-83ef-64256347478e","timestamp":"2026-01-09T04:34:44.247Z"}
{"parentUuid":"e4d4410b-973c-43d5-83ef-64256347478e","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01CHLmdJ6mgwd68RqNWhmi5x","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01HMTtTd11Rw7JyCxupmtraT","name":"Edit","input":{"replace_all":false,"file_path":"/mnt/c/Users/o.young/work/architecture/bounded_context/profile.adoc","old_string":"* Admin portal currently operates independently from\nlink:external/salesforce_crm.adoc[Salesforce]\n* ProfileService evolves existing OTR App database to bridge both\nsystems\n* VCI will be introduced through Flybuys initiative","new_string":"* Admin portal currently operates independently from\nlink:external/salesforce_crm.adoc[Salesforce]\n* ProfileService evolves existing OTR App database to bridge both\nsystems\n* VCI (Viva Consumer ID) will be introduced through either xref:initiatives:salesforce_customer_support.adoc[OTR-001] or xref:initiatives:flybuys_integration.adoc[OTR-002] initiative"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":1050,"cache_read_input_tokens":86353,"cache_creation":{"ephemeral_5m_input_tokens":1050,"ephemeral_1h_input_tokens":0},"output_tokens":333,"service_tier":"standard"}},"requestId":"req_011CWwBUJR1wPeeTM6mG26DC","type":"assistant","uuid":"d2ec453e-b01c-4617-8482-c64b2e3919fc","timestamp":"2026-01-09T04:34:47.995Z"}
{"parentUuid":"d2ec453e-b01c-4617-8482-c64b2e3919fc","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01HMTtTd11Rw7JyCxupmtraT","type":"tool_result","content":"The file /mnt/c/Users/o.young/work/architecture/bounded_context/profile.adoc has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n   271→\n   272→* link:external/salesforce_crm.adoc[Salesforce] owns\n   273→canonical customer identity (VCI, name, email, phone)\n   274→* OTR App Database contains richer OTR-specific profile data\n   275→* Admin portal currently operates independently from\n   276→link:external/salesforce_crm.adoc[Salesforce]\n   277→* ProfileService evolves existing OTR App database to bridge both\n   278→systems\n   279→* VCI (Viva Consumer ID) will be introduced through either xref:initiatives:salesforce_customer_support.adoc[OTR-001] or xref:initiatives:flybuys_integration.adoc[OTR-002] initiative\n   280→\n   281→*Current State:*\n   282→\n   283→* OTR App Database → Admin Portal (email-keyed, no VCI)"}]},"uuid":"5d489b9a-291e-4169-a739-6f9c8d077dbe","timestamp":"2026-01-09T04:34:48.202Z","toolUseResult":{"filePath":"/mnt/c/Users/o.young/work/architecture/bounded_context/profile.adoc","oldString":"* Admin portal currently operates independently from\nlink:external/salesforce_crm.adoc[Salesforce]\n* ProfileService evolves existing OTR App database to bridge both\nsystems\n* VCI will be introduced through Flybuys initiative","newString":"* Admin portal currently operates independently from\nlink:external/salesforce_crm.adoc[Salesforce]\n* ProfileService evolves existing OTR App database to bridge both\nsystems\n* VCI (Viva Consumer ID) will be introduced through either xref:initiatives:salesforce_customer_support.adoc[OTR-001] or xref:initiatives:flybuys_integration.adoc[OTR-002] initiative","originalFile":"= Profile Bounded Context\nO.Young@otr.com.au\nv0.1, 2025-12-19\n:project-name: OTRG Apps & Ecommerce Architecture\n:togaf-adm-phase: Phase C: Information Systems Architectures\n:document-type: Bounded Context\n:status: Draft\n:version: 0.1\n:domain: Profile\n:bounded-context-type: APPLICATION\n:domain-architect: O.Young@otr.com.au\n:doctype: article\n:toc: left\n:toclevels: 4\n:sectanchors:\n:sectlinks:\n:sectnums:\n:icons: font\n:source-highlighter: highlightjs\n:experimental:\n:description: Bounded Context for the Profile Domain\n:keywords: profile, customer, bounded context, togaf, ddd\n\n== ProfileService\n\nUnified customer profile service providing enriched customer data for\nOTRG ecosystem.\n\n=== Related Initiatives\n\nProfileService is a foundational bounded context supporting multiple strategic initiatives:\n\n* **xref:initiatives:salesforce_customer_support.adoc[OTR-001 Salesforce Customer Support]**: Provides Just-In-Time Contact reconciliation with Salesforce Service Cloud\n* **xref:initiatives:flybuys_integration.adoc[OTR-002 Flybuys Integration]**: Manages customer partner account linking (Flybuys, Shell) and reward preference tracking\n\nNOTE: These initiatives are the first implementations of OTR's Domain-Driven Design (DDD) architecture. Depending on sequencing, ProfileService capabilities may be delivered incrementally across either initiative.\n\n=== Domain Vision Statement\n\nProvide unified, enriched customer profiles bridging\nlink:external/salesforce_crm.adoc[Salesforce] canonical\ndata with OTRG-specific attributes, behavioral insights, and risk\nassessments.\n\n=== Responsibilities\n\n**Core Capabilities (All Initiatives):**\n\n* OTR-specific customer profile management\n* Customer lifecycle stage and onboarding tracking\n* Engagement metrics caching for profile enrichment\n\n**Salesforce Customer Support (OTR-001):**\n\n* Just-In-Time Contact reconciliation with Salesforce Service Cloud\n* Contact ID resolution for feedback submission\n* Foundation for unified customer view across Viva Energy channels\n\n**Flybuys Integration (OTR-002):**\n\n* Partner linking status tracking (Flybuys, Shell Card)\n* Reward preference management (Flybuys Points, Fuel Discount, OTR Rewards)\n* OAuth partner account linking coordination\n\n**Future Capabilities:**\n\n* Customer risk assessment (fraud, refund, churn)\n* Refund history tracking\n\n=== Implementation Technology\n\nAzure Functions, .NET Core, Azure SQL,\nlink:external/salesforce_crm.adoc[Salesforce] API,\nlink:interfaces/[Event Bus]\n\n=== What This Service Owns\n\nProfileService owns OTR-specific enrichment data and bridges\nlink:external/salesforce_crm.adoc[Salesforce] canonical\ncustomer records.\n\n==== Core Aggregates\n\n[width=\"100%\",cols=\"9%,91%\",options=\"header\",]\n|===\n|Aggregate Name |Description\n|`CustomerProfile` |OTRG-specific Customer profile attributes enriching\nlink:external/salesforce_crm.adoc[Salesforce] canonical\ndata. Stores behavioural data, preferences, and app-specific attributes.\n\n|`PartnerLink` |Securely connects Customers’ OTRG accounts to external\npartner services (like Flybuys and Shell) using industry-standard\nauthentication. Manages the connection status and customer preferences.\n\n|`RiskAssessment` |Customer risk, fraud, and value scores for instant\nrefund decisions. Provides both computed scores and raw factors for\ntransparency.\n\n|`RefundHistory` |Customer refund transaction history for risk\nassessment. Tracks refund requests, processing, and outcomes.\n|===\n\n==== NOT in this Context (Owned by Other Systems)\n\n[width=\"100%\",cols=\"26%,65%,9%\",options=\"header\",]\n|===\n|Action / Entity |Description |Relationship\n|Canonical Customer data |Name, email, phone →\nlink:external/salesforce_crm.adoc[Salesforce] CRM |HTTPS\nAPI\n\n|Viva Consumer ID (VCI) generation |Customer identifier generation →\nlink:external/salesforce_crm.adoc[Salesforce] CRM |HTTPS\nAPI\n\n|Marketing communication preferences |Communication preferences → Braze\n(via EngagementService) |Event Bus\n\n|Loyalty status |Points, tiers, wallet → EagleEye (via LoyaltyService)\n|Event Bus\n\n|Transaction details |Full transaction data → D365 Commerce (POS\nContext) |Event Bus\n\n|Reward transaction adjudication |Transaction reward processing →\nLoyaltyService |HTTPS API\n\n|OAuth tokens |OAuth token management → OAuth Service (Infrastructure)\n|Infrastructure\n|===\n\n=== Domain Events\n\n==== Profile Lifecycle Events\n\n* *ProfileCreated*: New customer profile created\n* *ProfileUpdated*: Customer profile information updated\n* *ProfileVerificationChanged*: Profile verification status changed\n(email/phone verification)\n* *ProfileCompletenessChanged*: Profile completeness score changed\n(0-100)\n* *LifeCycleStageChanged*: Customer lifecycle stage changed (PROSPECT →\nNEW → ACTIVE → DORMANT → AT_RISK → CHURNED)\n* *OnboardingCompleted*: Customer completed onboarding flow\n* *OnboardingProgressUpdated*: Customer progressed through onboarding\nsteps\n\n==== Partner Linking Events (Moved from LoyaltyService)\n\n* *PartnerLinked*: Customer linked external partner account (Flybuys,\nShell)\n* *PartnerUnlinked*: Customer unlinked external partner account\n* *PartnerLinkChanged*: Partner link status changed (LINKED →\nSYNC_FAILED → UNLINKED)\n* *RewardPreferenceChanged*: Customer changed reward program preference\n(FLYBUYS_POINTS, FUEL_DISCOUNT_SHELL, OTR_REWARDS)\n\n==== Risk Assessment Events\n\n* *RiskStatusChanged*: Customer risk status changed (LOW → MEDIUM → HIGH\n→ CRITICAL)\n* *FraudIndicatorDetected*: Potential fraud indicator detected (multiple\naccounts, chargeback pattern, login anomaly, etc.)\n\n==== Refund History Events\n\n* *RefundRequested*: Customer requested refund\n* *RefundProcessed*: Refund processed and completed\n\n=== Key Services\n\n[width=\"100%\",cols=\"19%,81%\",options=\"header\",]\n|===\n|Service Name |Description\n|`ProfileQueryService` |Query customer profile\n(link:external/salesforce_crm.adoc[Salesforce] canonical\n+ OTR enrichment), profile completeness, partner links\n\n|`RiskAssessmentService` |Get comprehensive risk assessment (scores +\nraw factors), calculate risk scores, fraud/refund/churn risk queries\n\n|`RefundHistoryService` |Query refund history, record new refund\nrequests, calculate refund statistics\n\n|`PartnerLinkService` |Create partner link, update reward preference,\nsync with partner, revoke partner link\n\n|`EngagementSyncService` |Update cached engagement summary from\nEngagementService, get cached engagement summary\n\n|`[Salesforce](external/salesforce_crm.adoc)ProfileAdapter`\n|ACL for link:external/salesforce_crm.adoc[Salesforce]\nintegration - query canonical customer data, resolve email to VCI,\nvalidate VCI\n|===\n\n=== Integration Points\n\n* *Upstream*:\nlink:external/salesforce_crm.adoc[Salesforce] (canonical\ncustomer data), EngagementService (engagement metrics)\n* *Downstream*: LoyaltyService, EngagementService, RefundService\n(future)\n* *Bidirectional*: EngagementService (profile enrichment ↔ engagement\nsummaries)\n\n=== Bounded Context Boundaries\n\n* ProfileService enriches\nlink:external/salesforce_crm.adoc[Salesforce] canonical\ndata with OTR-specific attributes\n* link:external/salesforce_crm.adoc[Salesforce] is system\nof record for customer identity and core contact details\n* ProfileService is system of record for OTR-specific behavior and risk\ndata\n* More volatile than\nlink:external/salesforce_crm.adoc[Salesforce] (frequent\nupdates from app usage, transactions)\n\n=== Architecture Decision Log\n\n==== Decision 0: ProfileService as Foundation for Multiple Initiatives\n\n*Decision:* ProfileService is designed as a foundational bounded context supporting both xref:initiatives:salesforce_customer_support.adoc[OTR-001 (Salesforce Customer Support)] and xref:initiatives:flybuys_integration.adoc[OTR-002 (Flybuys Integration)] initiatives.\n\n*Rationale:*\n\n* Both initiatives require customer identity management\n* Both initiatives integrate with Salesforce (OTR-001 for Cases, OTR-002 for VCI)\n* ProfileService provides reusable capabilities across initiatives\n* Implementing ProfileService once reduces duplication and complexity\n* Establishes DDD architecture pattern for future bounded contexts\n\n*Capabilities per Initiative:*\n\n**Salesforce Customer Support (OTR-001):**\n\n* Just-In-Time Contact reconciliation (upsert by email)\n* Salesforce Contact ID resolution for feedback submission\n* Foundation for unified customer view\n* Enables Case creation with validated Contact IDs\n\n**Flybuys Integration (OTR-002):**\n\n* Partner account linking (Flybuys, Shell Card)\n* Reward preference tracking (Flybuys Points vs Fuel Discount)\n* OAuth token coordination with infrastructure OAuth Service\n* Enables Flybuys earning at POS\n\n*Implementation Approach:*\n\n* Core ProfileService aggregates support both use cases\n* `CustomerProfile` aggregate stores Salesforce VCI and OTR enrichment\n* `PartnerLink` aggregate (OTR-002) can be implemented independently\n* Salesforce integration (OTR-001) establishes VCI as customer identifier\n* Either initiative can deliver ProfileService first, other reuses foundation\n\n*Sequencing Flexibility:*\n\n* If OTR-001 first: ProfileService Contact reconciliation enables feedback, `PartnerLink` added later\n* If OTR-002 first: ProfileService partner linking enables Flybuys, Contact reconciliation added later\n* Both initiatives benefit from shared Salesforce integration patterns\n\n==== Decision 1: ProfileService Bridges link:external/salesforce_crm.adoc[Salesforce] and OTR Ecosystem\n\n*Decision:* ProfileService acts as an Anti-Corruption Layer between\nlink:external/salesforce_crm.adoc[Salesforce] (canonical\ncustomer records) and OTR-specific profile data.\n\n*Rationale:*\n\n* link:external/salesforce_crm.adoc[Salesforce] owns\ncanonical customer identity (VCI, name, email, phone)\n* OTR App Database contains richer OTR-specific profile data\n* Admin portal currently operates independently from\nlink:external/salesforce_crm.adoc[Salesforce]\n* ProfileService evolves existing OTR App database to bridge both\nsystems\n* VCI will be introduced through Flybuys initiative\n\n*Current State:*\n\n* OTR App Database → Admin Portal (email-keyed, no VCI)\n* link:external/salesforce_crm.adoc[Salesforce] → Viva\nbrands (VCI-keyed)\n* No connection between systems\n\n*Future State:*\n\n* ProfileService stores OTR-specific enrichment with VCI\n* Queries link:external/salesforce_crm.adoc[Salesforce]\nfor canonical customer data\n* Admin portal enhanced to use VCI\n* External systems (EagleEye, Braze) keyed by VCI\n\n*Implementation:*\n\n* ProfileService stores OTR-specific attributes with VCI reference\n* Synchronous queries to\nlink:external/salesforce_crm.adoc[Salesforce] for\ncanonical customer data\n* Customer-Supplier (Conformist) pattern with\nlink:external/salesforce_crm.adoc[Salesforce]\n* ProfileService owns OTR enrichment,\nlink:external/salesforce_crm.adoc[Salesforce] owns\nidentity\n\n==== Decision 2: Risk Assessment for Instant Refunds\n\n*Decision:* ProfileService provides scored risk assessment and raw\nfactors to enable instant refund decisions by other business units.\n\n*Rationale:*\n\n* Current refund turnaround is 15 days due to poor workflows\n* Target: Immediate refunds for right customers based on risk profile\n* Risk profile = loyalty + fraud + behavioral factors\n* ProfileService doesn’t process refunds, just provides assessment\n\n*Risk Assessment Factors:*\n\n*ProfileService Owned:*\n\n* Refund history (count, frequency, amounts, reasons)\n* Transaction behavior (frequency, recency, transaction value)\n* Account health (tenure, verification status)\n* Fraud indicators (disputes, chargebacks, anomalies)\n* Engagement metrics (app usage, support interactions)\n* Customer value (lifetime value, profitability)\n\n*Aggregated from Other Services:*\n\n* Loyalty tier/status → LoyaltyService\n\n*API Design:*\n\n* Provides both computed risk score AND raw factors\n* Enables other business units to apply their own scoring logic\n* Transparency for audit and debugging\n\n*Implementation:*\n\n* RiskAssessment aggregate calculates scores\n* REST API endpoint: GET /profiles/\\{vci}/risk-assessment\n* Admin portal can display for customer service agents\n* Future: RefundService orchestrates instant refund decisions\n\n==== Decision 3: PartnerLink Aggregate Moved from LoyaltyService\n\n*Decision:* PartnerLink aggregate moved from LoyaltyService to\nProfileService.\n\n*Rationale:*\n\n* Partner linking is customer profile data, not loyalty transaction data\n* ProfileService is natural home for customer relationships\n* Reduces LoyaltyService complexity to single aggregate\n(RewardTransaction)\n\n*Migration Impact:*\n\n* LoyaltyService queries ProfileService synchronously for partner link\nstatus\n* Pattern: GET /profiles/\\{vci}/partner-links\n* Similar to how LoyaltyService queries EagleEye (real-time\norchestration)\n\n*Implementation:*\n\n* PartnerLink aggregate tracks linking status and reward preference\n* OAuth tokens managed by infrastructure OAuth Service (not in\naggregate)\n* ProfileService publishes PartnerLinked/PartnerUnlinked events\n* LoyaltyService consumes events for auditing/analytics\n\n==== Decision 4: Bidirectional Integration with EngagementService\n\n*Decision:* ProfileService and EngagementService have bidirectional\nintegration with hybrid event/batch synchronization pattern.\n\n*Rationale:*\n\n* Both services need data from each other\n* Each maintains system of record status for their domain\n* Eventual consistency acceptable (not real-time)\n* Strong event-based architecture with pragmatic batching\n\n*ProfileService → EngagementService (for segmentation/targeting):*\n\n* Events: ProfileCreated, ProfileUpdated, PartnerLinkChanged,\nRiskStatusChanged\n* Batch: Daily profile enrichment (risk scores, profile completeness)\n* Use case: Campaign targeting, segmentation\n\n*EngagementService → ProfileService (for profile enrichment):*\n\n* Events: EngagementTierChanged (highly engaged → disengaged)\n* Batch: Daily engagement score rollup (click rates, app usage\nsummaries)\n* Use case: Risk assessment, profile completeness\n\n*Each Service is System of Record:*\n\n* EngagementService owns: Campaign interactions, notification\npreferences\n* ProfileService owns: Customer attributes, risk scores, partner links\n\n*Implementation:*\n\n* Open Host Service + Published Language pattern (both directions)\n* Event Bus for real-time critical changes\n* Scheduled batch jobs for comprehensive summaries\n* Cached summaries stored locally (eventual consistency)\n\n==== Decision 5: ProfileService More Volatile Than link:external/salesforce_crm.adoc[Salesforce]\n\n*Decision:* ProfileService updates more frequently than\nlink:external/salesforce_crm.adoc[Salesforce] because it\ntracks behavioral and transactional data.\n\n*Rationale:*\n\n* link:external/salesforce_crm.adoc[Salesforce]:\nCanonical customer data changes infrequently (name, email)\n* ProfileService: Behavioral data changes constantly (app usage,\ntransactions)\n* ProfileService optimized for high-frequency updates\n* link:external/salesforce_crm.adoc[Salesforce] optimized\nfor identity and contact management\n\n*Volatility Comparison:*\n\n* link:external/salesforce_crm.adoc[Salesforce] updates:\nCustomer changes email, phone, address (infrequent)\n* ProfileService updates: Every transaction, login, app interaction\n(frequent)\n\n*Implementation:*\n\n* ProfileService database optimized for write-heavy workload\n* link:external/salesforce_crm.adoc[Salesforce] sync\nhandles identity changes only\n* No need for ProfileService to push behavioral data to\nlink:external/salesforce_crm.adoc[Salesforce]\n* ProfileService is authoritative for OTR behavioral data\n\n==== Decision 6: Synchronous Integration from LoyaltyService\n\n*Decision:* LoyaltyService queries ProfileService synchronously for\npartner link status during transaction adjudication.\n\n*Rationale:*\n\n* Transaction adjudication needs current partner status\n* Real-time query ensures accuracy\n* Similar pattern to LoyaltyService querying EagleEye\n* No local caching complexity\n\n*Flow:*\n\n[arabic]\n. Transaction adjudication request arrives at LoyaltyService\n. LoyaltyService queries ProfileService: GET\n/profiles/\\{vci}/partner-links\n. ProfileService returns partner linking status\n. LoyaltyService uses status for reward calculation\n. Transaction adjudication completes\n\n*Implementation:*\n\n* REST API for partner link queries\n* Low latency required (<100ms)\n* Circuit breaker pattern for resilience\n* Fallback to default (OTR Rewards) if ProfileService unavailable\n\n=== Key Architectural Patterns\n\n==== 1. Anti-Corruption Layer (ACL)\n\n* link:external/salesforce_crm.adoc[Salesforce]ProfileAdapter:\nProtects domain from\nlink:external/salesforce_crm.adoc[Salesforce] API changes\n* Translates between\nlink:external/salesforce_crm.adoc[Salesforce]\nContact/Person Account and OTR profile model\n* Single place to update when\nlink:external/salesforce_crm.adoc[Salesforce] changes\n\n==== 2. Backend-for-Frontend (BFF)\n\n* ProfileService aggregates from multiple sources\n(link:external/salesforce_crm.adoc[Salesforce],\nEngagementService)\n* Provides unified profile API for mobile app and other services\n* Enriches canonical data with OTR-specific attributes\n\n==== 3. Hybrid Event/Batch Synchronization\n\n* Critical changes via domain events (real-time)\n* Comprehensive summaries via batch jobs (periodic)\n* Balances consistency needs with performance\n\n==== 4. Query-and-Enrich Pattern\n\n* Queries link:external/salesforce_crm.adoc[Salesforce]\nfor canonical customer data (real-time)\n* Enriches with OTR-specific attributes from local database\n* Returns unified CustomerProfileResponse\n* No local caching of\nlink:external/salesforce_crm.adoc[Salesforce] data\n(always fresh)\n","structuredPatch":[{"oldStart":276,"oldLines":7,"newStart":276,"newLines":7,"lines":[" link:external/salesforce_crm.adoc[Salesforce]"," * ProfileService evolves existing OTR App database to bridge both"," systems","-* VCI will be introduced through Flybuys initiative","+* VCI (Viva Consumer ID) will be introduced through either xref:initiatives:salesforce_customer_support.adoc[OTR-001] or xref:initiatives:flybuys_integration.adoc[OTR-002] initiative"," "," *Current State:*"," "]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"d2ec453e-b01c-4617-8482-c64b2e3919fc"}
{"parentUuid":"5d489b9a-291e-4169-a739-6f9c8d077dbe","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_013rhYutk5trydjQAvucBfdd","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Perfect! Now let me add a final summary section at the end of the profile.adoc to reinforce the dual-initiative approach. But first let me mark the todos as complete and commit these changes.","signature":"EugCCkYICxgCKkBfU5ZTBj5E29XA+/5HWrOL2c7SFUdGpsV5dcj22OGvifLugfmu0B4bSwy1cSHBlzSH8W3xjq/gqkUuPgjZ6lguEgxxjerna/wwIdbvczMaDDopGg+fXCcSfyQ3aSIwJrBBQf9G9zQjgaeiCHMnpdXzJUr0XZpIjqNPplZZCKsmbio9CZZXa3doRDuLrh8vKs8BgNKtOjid9nJ51TPG5aWzV3NnQ1q63dytOG+ZU2Xvb6iJ1Ktyn+wXYy6McnvAT+3SxwKuojPd8xLvyE5ScJhG+yfE0bymLWx/bNEQBWMEqcQhbgTivFzOcDoVDsjqiPrxRaObr27daXnLrxTpYKCuLpESD64kOqYMloEtJOzHWJkr2AgL/obWNYI27KC72tj+h1VdWmEsXRLgOlyjCzGMqa6FC5VFjyCJQDqjuCIyVNxUjzHn0y+H4x8VBLUa0LJPwc8a8xgzjfNa2np+ZNCxGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":11,"cache_creation_input_tokens":622,"cache_read_input_tokens":87403,"cache_creation":{"ephemeral_5m_input_tokens":622,"ephemeral_1h_input_tokens":0},"output_tokens":8,"service_tier":"standard"}},"requestId":"req_011CWwBUuxvk4Z9q2ZqKj98t","type":"assistant","uuid":"aec060b7-870f-4067-a228-025c30eaec1b","timestamp":"2026-01-09T04:34:52.605Z"}
{"parentUuid":"aec060b7-870f-4067-a228-025c30eaec1b","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_013rhYutk5trydjQAvucBfdd","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_013uf5M9J5z38Bh2J3AUQ2SH","name":"TodoWrite","input":{"todos":[{"content":"Add initiative context to ProfileService documentation header","activeForm":"Adding initiative context to header","status":"completed"},{"content":"Update profile.adoc to reference both OTR-001 and OTR-002 initiatives","activeForm":"Updating initiative references","status":"completed"},{"content":"Add architecture decision about dual initiative support","activeForm":"Adding dual initiative decision","status":"completed"},{"content":"Update CML file header to reference initiatives","activeForm":"Updating CML header","status":"completed"},{"content":"Ensure consistency between CML and markdown files","activeForm":"Ensuring CML/markdown consistency","status":"completed"}]}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":11,"cache_creation_input_tokens":622,"cache_read_input_tokens":87403,"cache_creation":{"ephemeral_5m_input_tokens":622,"ephemeral_1h_input_tokens":0},"output_tokens":271,"service_tier":"standard"}},"requestId":"req_011CWwBUuxvk4Z9q2ZqKj98t","type":"assistant","uuid":"5e89e00d-7b23-4659-a2ea-fef4e19bee0f","timestamp":"2026-01-09T04:34:56.292Z"}
{"parentUuid":"5e89e00d-7b23-4659-a2ea-fef4e19bee0f","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_013uf5M9J5z38Bh2J3AUQ2SH","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"uuid":"04657019-79e8-4382-9516-dc234840e969","timestamp":"2026-01-09T04:34:56.424Z","toolUseResult":{"oldTodos":[{"content":"Add initiative context to ProfileService documentation header","status":"completed","activeForm":"Adding initiative context to header"},{"content":"Update profile.adoc to reference both OTR-001 and OTR-002 initiatives","status":"completed","activeForm":"Updating initiative references"},{"content":"Add architecture decision about dual initiative support","status":"completed","activeForm":"Adding dual initiative decision"},{"content":"Update CML file header to reference initiatives","status":"in_progress","activeForm":"Updating CML header"},{"content":"Ensure consistency between CML and markdown files","status":"pending","activeForm":"Ensuring CML/markdown consistency"}],"newTodos":[{"content":"Add initiative context to ProfileService documentation header","status":"completed","activeForm":"Adding initiative context to header"},{"content":"Update profile.adoc to reference both OTR-001 and OTR-002 initiatives","status":"completed","activeForm":"Updating initiative references"},{"content":"Add architecture decision about dual initiative support","status":"completed","activeForm":"Adding dual initiative decision"},{"content":"Update CML file header to reference initiatives","status":"completed","activeForm":"Updating CML header"},{"content":"Ensure consistency between CML and markdown files","status":"completed","activeForm":"Ensuring CML/markdown consistency"}]},"sourceToolAssistantUUID":"5e89e00d-7b23-4659-a2ea-fef4e19bee0f"}
{"parentUuid":"04657019-79e8-4382-9516-dc234840e969","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_012uNbc3XFkdFte9gZ9JKF8K","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Great! Now let me verify the changes look good and then commit them. Let me quickly check that the files are well-structured.","signature":"EqYCCkYICxgCKkDUTSvxJIqnDjy6DFYK0teGMmTjaGfA81SvKZCH2tHxgO1DKg/sBngfc33UHi8P5SC1UZGnSpfIXqvXS3JgSzmZEgxvaMEHxsNeVSN3dY4aDG0xcvD4+yLx8Ovt5iIwLcjqRhORWOXGnW/aLhaPxam05PylflUj/1P1yiuMvfIR/4kfJSn0zaMibACWGqpGKo0BKFk+J/7JfpTcUJQMPGJ30HUefmuThgEPLpNfHNVphaN3O+cSWIhm4hm0haKzVcxVZWHcQVpB57vF9cQTPjI91AalRIVnqv43zIkzjaIjUAxPhq5NQsXbzPx2OAXpHGgk36N25BhtoBjFwiSZKLEcnPTuZQJd/aiOymWD1CGb0FIX8E0e00C1X7LAXT+FGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":11,"cache_creation_input_tokens":320,"cache_read_input_tokens":88025,"cache_creation":{"ephemeral_5m_input_tokens":320,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWwBVXBFUjKFZ1ETWTpjM","type":"assistant","uuid":"000bbbc3-a13a-4746-aa89-d29d4847c0c3","timestamp":"2026-01-09T04:35:00.507Z"}
{"parentUuid":"000bbbc3-a13a-4746-aa89-d29d4847c0c3","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_012uNbc3XFkdFte9gZ9JKF8K","type":"message","role":"assistant","content":[{"type":"text","text":"Let me verify the updated files and commit the changes."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":11,"cache_creation_input_tokens":320,"cache_read_input_tokens":88025,"cache_creation":{"ephemeral_5m_input_tokens":320,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWwBVXBFUjKFZ1ETWTpjM","type":"assistant","uuid":"932a0045-d86a-4e59-a868-0539a68e7b13","timestamp":"2026-01-09T04:35:00.944Z"}
{"parentUuid":"932a0045-d86a-4e59-a868-0539a68e7b13","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_012uNbc3XFkdFte9gZ9JKF8K","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_017fUKgev3W3hiXn4QoNitE6","name":"Bash","input":{"command":"git diff bounded_context/profile.adoc | head -100","description":"Review profile.adoc changes"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":11,"cache_creation_input_tokens":320,"cache_read_input_tokens":88025,"cache_creation":{"ephemeral_5m_input_tokens":320,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWwBVXBFUjKFZ1ETWTpjM","type":"assistant","uuid":"c407292d-5b43-47d2-9c7e-19fb6985cfdf","timestamp":"2026-01-09T04:35:01.796Z"}
{"parentUuid":"c407292d-5b43-47d2-9c7e-19fb6985cfdf","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_012uNbc3XFkdFte9gZ9JKF8K","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01QkisDoNW2iDr8iisbJTv6q","name":"Bash","input":{"command":"git diff bounded_context/profile.cml | head -100","description":"Review profile.cml changes"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":11,"cache_creation_input_tokens":320,"cache_read_input_tokens":88025,"cache_creation":{"ephemeral_5m_input_tokens":320,"ephemeral_1h_input_tokens":0},"output_tokens":204,"service_tier":"standard"}},"requestId":"req_011CWwBVXBFUjKFZ1ETWTpjM","type":"assistant","uuid":"3519b63d-4c69-4eb9-b9cc-639e5678f875","timestamp":"2026-01-09T04:35:02.285Z"}
{"parentUuid":"c407292d-5b43-47d2-9c7e-19fb6985cfdf","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_017fUKgev3W3hiXn4QoNitE6","type":"tool_result","content":"diff --git a/bounded_context/profile.adoc b/bounded_context/profile.adoc\nindex 92dcc39..8fddca1 100644\n--- a/bounded_context/profile.adoc\n+++ b/bounded_context/profile.adoc\n@@ -26,6 +26,15 @@ v0.1, 2025-12-19\n Unified customer profile service providing enriched customer data for\n OTRG ecosystem.\n \n+=== Related Initiatives\n+\n+ProfileService is a foundational bounded context supporting multiple strategic initiatives:\n+\n+* **xref:initiatives:salesforce_customer_support.adoc[OTR-001 Salesforce Customer Support]**: Provides Just-In-Time Contact reconciliation with Salesforce Service Cloud\n+* **xref:initiatives:flybuys_integration.adoc[OTR-002 Flybuys Integration]**: Manages customer partner account linking (Flybuys, Shell) and reward preference tracking\n+\n+NOTE: These initiatives are the first implementations of OTR's Domain-Driven Design (DDD) architecture. Depending on sequencing, ProfileService capabilities may be delivered incrementally across either initiative.\n+\n === Domain Vision Statement\n \n Provide unified, enriched customer profiles bridging\n@@ -35,12 +44,28 @@ assessments.\n \n === Responsibilities\n \n+**Core Capabilities (All Initiatives):**\n+\n * OTR-specific customer profile management\n * Customer lifecycle stage and onboarding tracking\n-* Partner linking status tracking\n+* Engagement metrics caching for profile enrichment\n+\n+**Salesforce Customer Support (OTR-001):**\n+\n+* Just-In-Time Contact reconciliation with Salesforce Service Cloud\n+* Contact ID resolution for feedback submission\n+* Foundation for unified customer view across Viva Energy channels\n+\n+**Flybuys Integration (OTR-002):**\n+\n+* Partner linking status tracking (Flybuys, Shell Card)\n+* Reward preference management (Flybuys Points, Fuel Discount, OTR Rewards)\n+* OAuth partner account linking coordination\n+\n+**Future Capabilities:**\n+\n * Customer risk assessment (fraud, refund, churn)\n * Refund history tracking\n-* Engagement metrics caching for profile enrichment\n \n === Implementation Technology\n \n@@ -194,6 +219,48 @@ updates from app usage, transactions)\n \n === Architecture Decision Log\n \n+==== Decision 0: ProfileService as Foundation for Multiple Initiatives\n+\n+*Decision:* ProfileService is designed as a foundational bounded context supporting both xref:initiatives:salesforce_customer_support.adoc[OTR-001 (Salesforce Customer Support)] and xref:initiatives:flybuys_integration.adoc[OTR-002 (Flybuys Integration)] initiatives.\n+\n+*Rationale:*\n+\n+* Both initiatives require customer identity management\n+* Both initiatives integrate with Salesforce (OTR-001 for Cases, OTR-002 for VCI)\n+* ProfileService provides reusable capabilities across initiatives\n+* Implementing ProfileService once reduces duplication and complexity\n+* Establishes DDD architecture pattern for future bounded contexts\n+\n+*Capabilities per Initiative:*\n+\n+**Salesforce Customer Support (OTR-001):**\n+\n+* Just-In-Time Contact reconciliation (upsert by email)\n+* Salesforce Contact ID resolution for feedback submission\n+* Foundation for unified customer view\n+* Enables Case creation with validated Contact IDs\n+\n+**Flybuys Integration (OTR-002):**\n+\n+* Partner account linking (Flybuys, Shell Card)\n+* Reward preference tracking (Flybuys Points vs Fuel Discount)\n+* OAuth token coordination with infrastructure OAuth Service\n+* Enables Flybuys earning at POS\n+\n+*Implementation Approach:*\n+\n+* Core ProfileService aggregates support both use cases\n+* `CustomerProfile` aggregate stores Salesforce VCI and OTR enrichment\n+* `PartnerLink` aggregate (OTR-002) can be implemented independently\n+* Salesforce integration (OTR-001) establishes VCI as customer identifier\n+* Either initiative can deliver ProfileService first, other reuses foundation\n+\n+*Sequencing Flexibility:*\n+\n+* If OTR-001 first: ProfileService Contact reconciliation enables feedback, `PartnerLink` added later\n+* If OTR-002 first: ProfileService partner linking enables Flybuys, Contact reconciliation added later\n+* Both initiatives benefit from shared Salesforce integration patterns\n+\n ==== Decision 1: ProfileService Bridges link:external/salesforce_crm.adoc[Salesforce] and OTR Ecosystem\n \n *Decision:* ProfileService acts as an Anti-Corruption Layer between\nwarning: in the working copy of 'bounded_context/profile.adoc', CRLF will be replaced by LF the next time Git touches it","is_error":false}]},"uuid":"2d4af1c8-f1ab-4ae6-96b3-d78a81a46a75","timestamp":"2026-01-09T04:35:02.695Z","toolUseResult":{"stdout":"diff --git a/bounded_context/profile.adoc b/bounded_context/profile.adoc\nindex 92dcc39..8fddca1 100644\n--- a/bounded_context/profile.adoc\n+++ b/bounded_context/profile.adoc\n@@ -26,6 +26,15 @@ v0.1, 2025-12-19\n Unified customer profile service providing enriched customer data for\n OTRG ecosystem.\n \n+=== Related Initiatives\n+\n+ProfileService is a foundational bounded context supporting multiple strategic initiatives:\n+\n+* **xref:initiatives:salesforce_customer_support.adoc[OTR-001 Salesforce Customer Support]**: Provides Just-In-Time Contact reconciliation with Salesforce Service Cloud\n+* **xref:initiatives:flybuys_integration.adoc[OTR-002 Flybuys Integration]**: Manages customer partner account linking (Flybuys, Shell) and reward preference tracking\n+\n+NOTE: These initiatives are the first implementations of OTR's Domain-Driven Design (DDD) architecture. Depending on sequencing, ProfileService capabilities may be delivered incrementally across either initiative.\n+\n === Domain Vision Statement\n \n Provide unified, enriched customer profiles bridging\n@@ -35,12 +44,28 @@ assessments.\n \n === Responsibilities\n \n+**Core Capabilities (All Initiatives):**\n+\n * OTR-specific customer profile management\n * Customer lifecycle stage and onboarding tracking\n-* Partner linking status tracking\n+* Engagement metrics caching for profile enrichment\n+\n+**Salesforce Customer Support (OTR-001):**\n+\n+* Just-In-Time Contact reconciliation with Salesforce Service Cloud\n+* Contact ID resolution for feedback submission\n+* Foundation for unified customer view across Viva Energy channels\n+\n+**Flybuys Integration (OTR-002):**\n+\n+* Partner linking status tracking (Flybuys, Shell Card)\n+* Reward preference management (Flybuys Points, Fuel Discount, OTR Rewards)\n+* OAuth partner account linking coordination\n+\n+**Future Capabilities:**\n+\n * Customer risk assessment (fraud, refund, churn)\n * Refund history tracking\n-* Engagement metrics caching for profile enrichment\n \n === Implementation Technology\n \n@@ -194,6 +219,48 @@ updates from app usage, transactions)\n \n === Architecture Decision Log\n \n+==== Decision 0: ProfileService as Foundation for Multiple Initiatives\n+\n+*Decision:* ProfileService is designed as a foundational bounded context supporting both xref:initiatives:salesforce_customer_support.adoc[OTR-001 (Salesforce Customer Support)] and xref:initiatives:flybuys_integration.adoc[OTR-002 (Flybuys Integration)] initiatives.\n+\n+*Rationale:*\n+\n+* Both initiatives require customer identity management\n+* Both initiatives integrate with Salesforce (OTR-001 for Cases, OTR-002 for VCI)\n+* ProfileService provides reusable capabilities across initiatives\n+* Implementing ProfileService once reduces duplication and complexity\n+* Establishes DDD architecture pattern for future bounded contexts\n+\n+*Capabilities per Initiative:*\n+\n+**Salesforce Customer Support (OTR-001):**\n+\n+* Just-In-Time Contact reconciliation (upsert by email)\n+* Salesforce Contact ID resolution for feedback submission\n+* Foundation for unified customer view\n+* Enables Case creation with validated Contact IDs\n+\n+**Flybuys Integration (OTR-002):**\n+\n+* Partner account linking (Flybuys, Shell Card)\n+* Reward preference tracking (Flybuys Points vs Fuel Discount)\n+* OAuth token coordination with infrastructure OAuth Service\n+* Enables Flybuys earning at POS\n+\n+*Implementation Approach:*\n+\n+* Core ProfileService aggregates support both use cases\n+* `CustomerProfile` aggregate stores Salesforce VCI and OTR enrichment\n+* `PartnerLink` aggregate (OTR-002) can be implemented independently\n+* Salesforce integration (OTR-001) establishes VCI as customer identifier\n+* Either initiative can deliver ProfileService first, other reuses foundation\n+\n+*Sequencing Flexibility:*\n+\n+* If OTR-001 first: ProfileService Contact reconciliation enables feedback, `PartnerLink` added later\n+* If OTR-002 first: ProfileService partner linking enables Flybuys, Contact reconciliation added later\n+* Both initiatives benefit from shared Salesforce integration patterns\n+\n ==== Decision 1: ProfileService Bridges link:external/salesforce_crm.adoc[Salesforce] and OTR Ecosystem\n \n *Decision:* ProfileService acts as an Anti-Corruption Layer between\nwarning: in the working copy of 'bounded_context/profile.adoc', CRLF will be replaced by LF the next time Git touches it","stderr":"","interrupted":false,"isImage":false},"sourceToolAssistantUUID":"c407292d-5b43-47d2-9c7e-19fb6985cfdf"}
{"parentUuid":"3519b63d-4c69-4eb9-b9cc-639e5678f875","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01QkisDoNW2iDr8iisbJTv6q","type":"tool_result","content":"diff --git a/bounded_context/profile.cml b/bounded_context/profile.cml\nindex 0c7f99e..34706e8 100644\n--- a/bounded_context/profile.cml\n+++ b/bounded_context/profile.cml\n@@ -4,6 +4,13 @@\n  *\n  * Unified customer profile service providing enriched customer data for OTR ecosystem.\n  *\n+ * RELATED INITIATIVES:\n+ * - OTR-001 Salesforce Customer Support: Just-In-Time Contact reconciliation with Salesforce\n+ * - OTR-002 Flybuys Integration: Partner account linking and reward preference management\n+ *\n+ * NOTE: ProfileService is a foundational bounded context supporting multiple strategic initiatives.\n+ * Depending on sequencing, capabilities may be delivered incrementally across either initiative.\n+ *\n  * See profile.adoc for comprehensive architecture documentation, decision log, and patterns.\n  */\n \n@@ -152,6 +159,11 @@ BoundedContext ProfileService implements ProfileDomain {\n     // Records customer linkages to external loyalty partners (Flybuys, Shell).\n     // Tracks linking status and synchronization state for partner integrations.\n     //\n+    // INITIATIVE: OTR-002 Flybuys Integration\n+    // - Manages customer partner account linking via OAuth\n+    // - Tracks reward preference selection (Flybuys Points vs Fuel Discount vs OTR Rewards)\n+    // - Enables Flybuys earning at POS\n+    //\n     // Invariants:\n     // - Customer can only have one active link per partner type\n     // - External member ID must be unique within partner\n@@ -577,11 +589,16 @@ BoundedContext ProfileService implements ProfileDomain {\n     Service SalesforceProfileAdapter {\n         // ACL for Salesforce integration\n         // Translates between Salesforce Contact/Person Account and OTR profile model\n+        //\n+        // INITIATIVES:\n+        // - OTR-001 Salesforce Customer Support: Just-In-Time Contact reconciliation (upsert by email)\n+        // - OTR-002 Flybuys Integration: VCI-based customer identification\n \n         // Query canonical customer data from Salesforce\n         getCustomer(@String VivaConsumerId) : SalesforceCustomer\n \n         // Resolve email to VCI (for legacy email-keyed lookups)\n+        // Used by OTR-001 for Just-In-Time Contact reconciliation\n         resolveEmailToVCI(@String email) : String\n \n         // Validate VCI exists in Salesforce\n@@ -716,5 +733,18 @@ BoundedContext ProfileService implements ProfileDomain {\n // - EngagementService integration via Event Bus + batch sync\n // - LoyaltyService queries ProfileService synchronously\n // - Admin portal enhanced to use ProfileService APIs\n-// - VCI introduced through Flybuys initiative\n+//\n+// Initiative Delivery:\n+// - OTR-001 (Salesforce Customer Support): SalesforceProfileAdapter, CustomerProfile aggregate\n+//   * Just-In-Time Contact reconciliation (upsert by email)\n+//   * Contact ID resolution for feedback submission\n+// - OTR-002 (Flybuys Integration): PartnerLink aggregate, partner linking services\n+//   * OAuth partner account linking (Flybuys, Shell)\n+//   * Reward preference management\n+//   * VCI as universal customer identifier established\n+//\n+// Sequencing Flexibility:\n+// - Either initiative can deliver ProfileService first\n+// - Other initiative reuses foundation and adds its specific aggregates\n+// - Both initiatives benefit from shared Salesforce integration patterns\n // ============================================================================","is_error":false}]},"uuid":"9a93c589-acfa-4111-be33-0890198ad0a4","timestamp":"2026-01-09T04:35:02.727Z","toolUseResult":{"stdout":"diff --git a/bounded_context/profile.cml b/bounded_context/profile.cml\nindex 0c7f99e..34706e8 100644\n--- a/bounded_context/profile.cml\n+++ b/bounded_context/profile.cml\n@@ -4,6 +4,13 @@\n  *\n  * Unified customer profile service providing enriched customer data for OTR ecosystem.\n  *\n+ * RELATED INITIATIVES:\n+ * - OTR-001 Salesforce Customer Support: Just-In-Time Contact reconciliation with Salesforce\n+ * - OTR-002 Flybuys Integration: Partner account linking and reward preference management\n+ *\n+ * NOTE: ProfileService is a foundational bounded context supporting multiple strategic initiatives.\n+ * Depending on sequencing, capabilities may be delivered incrementally across either initiative.\n+ *\n  * See profile.adoc for comprehensive architecture documentation, decision log, and patterns.\n  */\n \n@@ -152,6 +159,11 @@ BoundedContext ProfileService implements ProfileDomain {\n     // Records customer linkages to external loyalty partners (Flybuys, Shell).\n     // Tracks linking status and synchronization state for partner integrations.\n     //\n+    // INITIATIVE: OTR-002 Flybuys Integration\n+    // - Manages customer partner account linking via OAuth\n+    // - Tracks reward preference selection (Flybuys Points vs Fuel Discount vs OTR Rewards)\n+    // - Enables Flybuys earning at POS\n+    //\n     // Invariants:\n     // - Customer can only have one active link per partner type\n     // - External member ID must be unique within partner\n@@ -577,11 +589,16 @@ BoundedContext ProfileService implements ProfileDomain {\n     Service SalesforceProfileAdapter {\n         // ACL for Salesforce integration\n         // Translates between Salesforce Contact/Person Account and OTR profile model\n+        //\n+        // INITIATIVES:\n+        // - OTR-001 Salesforce Customer Support: Just-In-Time Contact reconciliation (upsert by email)\n+        // - OTR-002 Flybuys Integration: VCI-based customer identification\n \n         // Query canonical customer data from Salesforce\n         getCustomer(@String VivaConsumerId) : SalesforceCustomer\n \n         // Resolve email to VCI (for legacy email-keyed lookups)\n+        // Used by OTR-001 for Just-In-Time Contact reconciliation\n         resolveEmailToVCI(@String email) : String\n \n         // Validate VCI exists in Salesforce\n@@ -716,5 +733,18 @@ BoundedContext ProfileService implements ProfileDomain {\n // - EngagementService integration via Event Bus + batch sync\n // - LoyaltyService queries ProfileService synchronously\n // - Admin portal enhanced to use ProfileService APIs\n-// - VCI introduced through Flybuys initiative\n+//\n+// Initiative Delivery:\n+// - OTR-001 (Salesforce Customer Support): SalesforceProfileAdapter, CustomerProfile aggregate\n+//   * Just-In-Time Contact reconciliation (upsert by email)\n+//   * Contact ID resolution for feedback submission\n+// - OTR-002 (Flybuys Integration): PartnerLink aggregate, partner linking services\n+//   * OAuth partner account linking (Flybuys, Shell)\n+//   * Reward preference management\n+//   * VCI as universal customer identifier established\n+//\n+// Sequencing Flexibility:\n+// - Either initiative can deliver ProfileService first\n+// - Other initiative reuses foundation and adds its specific aggregates\n+// - Both initiatives benefit from shared Salesforce integration patterns\n // ============================================================================","stderr":"","interrupted":false,"isImage":false},"sourceToolAssistantUUID":"3519b63d-4c69-4eb9-b9cc-639e5678f875"}
{"parentUuid":"9a93c589-acfa-4111-be33-0890198ad0a4","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_012jwtN7aYm8UMyT1Q14iVJB","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Perfect! The changes look good. Now let me commit and push these changes.","signature":"EvEBCkYICxgCKkCqhjB/ZiH0eTEnTolIZvGzwKIFsVBECnuUS8jukjZNl6WibqG5HiMVlnj8Y7ag3wc5s+diBfoPi5yYHIJ45uzwEgyiSc4MwA6foemSu5AaDGrNA/JgIFbOHBtHpSIwVS1v35xuLIBXRTPhjAkCHyMsfqfwbulKdVGKI1yyVeHffjfWUT9/QHWz2W3JoekXKlmRBlQW6+PUP35C1bxm2MEvN1HypyXZrXnB7rzl/dyRcnJHwWFvIPF2+gwRAoMjW1eYdhdBln9wyBKhPryUiu8/81OrJIOBfGkUf6ahAl6tSg81BbRx6vXbuhgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":2402,"cache_read_input_tokens":88345,"cache_creation":{"ephemeral_5m_input_tokens":2402,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWwBVywpRHDs7o3pNvMrD","type":"assistant","uuid":"37814afb-5a58-43c8-8fae-011e14a95d2e","timestamp":"2026-01-09T04:35:06.876Z"}
{"parentUuid":"37814afb-5a58-43c8-8fae-011e14a95d2e","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_012jwtN7aYm8UMyT1Q14iVJB","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_013iFPnRxZimhKxTC6n6EcEx","name":"Bash","input":{"command":"git add bounded_context/profile.cml bounded_context/profile.adoc && git commit -m \"$(cat <<'EOF'\nfeat: Update ProfileService to reflect OTR-001 and OTR-002 initiatives\n\nUpdated both ProfileService CML and paired markdown documentation to clearly\narticulate how this bounded context supports two strategic initiatives:\n\n- OTR-001 Salesforce Customer Support: Just-In-Time Contact reconciliation\n- OTR-002 Flybuys Integration: Partner account linking and reward preferences\n\nChanges to profile.adoc:\n- Added \"Related Initiatives\" section with xrefs to both initiatives\n- Reorganised Responsibilities section by initiative\n- Added Decision 0 explaining ProfileService as foundation for both initiatives\n- Clarified VCI introduction can happen through either initiative\n- Explained sequencing flexibility\n\nChanges to profile.cml:\n- Updated header comment to reference both initiatives\n- Added initiative context to PartnerLink aggregate (OTR-002 specific)\n- Added initiative context to SalesforceProfileAdapter (supports both)\n- Updated implementation notes with initiative delivery mapping\n\nThis maintains separation between domain model (CML) and architecture \ndecisions (markdown) while ensuring both files stay aligned.\n\nCo-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>\nEOF\n)\" && git push","description":"Commit ProfileService initiative updates"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":2402,"cache_read_input_tokens":88345,"cache_creation":{"ephemeral_5m_input_tokens":2402,"ephemeral_1h_input_tokens":0},"output_tokens":407,"service_tier":"standard"}},"requestId":"req_011CWwBVywpRHDs7o3pNvMrD","type":"assistant","uuid":"248fef6b-3aab-4242-93ee-411a132c4ece","timestamp":"2026-01-09T04:35:13.743Z"}
{"parentUuid":"248fef6b-3aab-4242-93ee-411a132c4ece","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_013iFPnRxZimhKxTC6n6EcEx","type":"tool_result","content":"[main 1863d2a] feat: Update ProfileService to reflect OTR-001 and OTR-002 initiatives\n 2 files changed, 101 insertions(+), 4 deletions(-)\nwarning: in the working copy of 'bounded_context/profile.adoc', CRLF will be replaced by LF the next time Git touches it\nTo https://github.com/otr-digital/architecture.git\n   dee09e5..1863d2a  main -> main","is_error":false}]},"uuid":"3329d187-c3c4-4200-979f-0fb3c3237940","timestamp":"2026-01-09T04:35:19.016Z","toolUseResult":{"stdout":"[main 1863d2a] feat: Update ProfileService to reflect OTR-001 and OTR-002 initiatives\n 2 files changed, 101 insertions(+), 4 deletions(-)\nwarning: in the working copy of 'bounded_context/profile.adoc', CRLF will be replaced by LF the next time Git touches it\nTo https://github.com/otr-digital/architecture.git\n   dee09e5..1863d2a  main -> main","stderr":"","interrupted":false,"isImage":false},"sourceToolAssistantUUID":"248fef6b-3aab-4242-93ee-411a132c4ece"}
{"parentUuid":"3329d187-c3c4-4200-979f-0fb3c3237940","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01CgjDDCuLsRxquRtF6A4Axd","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Perfect! I've successfully updated the ProfileService bounded context to reflect both initiatives. Let me provide a summary to the user.","signature":"ErECCkYICxgCKkAPgfipaO5y+i0WgeyFz0ho0ZjekX+lLeHj3sfW7wgm9xX+tGKEBybptnK2KJbG5Yw2j0xkWDbtuB6hqcp6LFgwEgwbNPFAI5xtGyoS9KsaDNuQN+x/w/YBAK4f7CIw2mqCcx0CzLC70OilyDGlnEBBnrPvg99+0YKj6RMnxZHWbhO8LNXbXLR4JWWyRmRLKpgBWEz6f+7p4aSZgajI+waBK4XjWgyVrKH1ad7jpG1ClAKyhd+JdLjYXhfCVhX9QTXqwFQ7pqX642orZSiWpIGEWSxBexbRW9lYSeQzi8OO6kuDHB2egHHqol8IuYAVGg4vBZo40uTZvUfM3BAkHGD3UuJDOVld+qOHgezU2pvyjV39YoJdUZ2Ds5SCwcjNEgSe3Y28C/4N8moYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":11,"cache_creation_input_tokens":545,"cache_read_input_tokens":90747,"cache_creation":{"ephemeral_5m_input_tokens":545,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWwBXBsh9VGWzcpXr5Nfa","type":"assistant","uuid":"b6d54af7-f5ed-466a-893a-474d152b57f7","timestamp":"2026-01-09T04:35:23.265Z"}
{"parentUuid":"b6d54af7-f5ed-466a-893a-474d152b57f7","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01CgjDDCuLsRxquRtF6A4Axd","type":"message","role":"assistant","content":[{"type":"text","text":"Perfect! I've successfully updated the ProfileService bounded context to reflect both OTR-001 (Salesforce Customer Support) and OTR-002 (Flybuys Integration) initiatives, ensuring the CML file and its paired markdown documentation are properly aligned.\n\n## Changes Summary\n\n### profile.adoc (Markdown Documentation)\n\n**Added:**\n- **\"Related Initiatives\" section** with cross-references to both initiative documents\n- **Decision 0**: \"ProfileService as Foundation for Multiple Initiatives\" explaining the dual-purpose design\n- **Reorganised Responsibilities** section mapping capabilities to specific initiatives:\n  - Core Capabilities (both initiatives)\n  - Salesforce Customer Support (OTR-001): JIT Contact reconciliation\n  - Flybuys Integration (OTR-002): Partner linking and reward preferences\n  - Future Capabilities: Risk assessment, refund history\n\n**Updated:**\n- Clarified VCI can be introduced through either initiative\n- Added sequencing flexibility explanation\n\n### profile.cml (Domain Model)\n\n**Added:**\n- **Header comment** referencing both OTR-001 and OTR-002 initiatives\n- **PartnerLink aggregate annotation** identifying it as OTR-002 specific\n- **SalesforceProfileAdapter annotation** showing it supports both initiatives\n- **Implementation notes** mapping aggregates to initiatives with sequencing flexibility\n\n## Key Architecture Decisions Documented\n\n1. **Foundational Design**: ProfileService is designed once, supporting both initiatives\n2. **Sequencing Flexibility**: Either initiative can deliver ProfileService first\n3. **Reusability**: Second initiative reuses foundation and adds specific aggregates\n4. **Separation of Concerns**:\n   - `CustomerProfile` + `SalesforceProfileAdapter` → OTR-001 (Contact reconciliation)\n   - `PartnerLink` + `PartnerLinkService` → OTR-002 (Partner linking)\n\n## Files Updated\n\n**Commit:** `1863d2a` - \"feat: Update ProfileService to reflect OTR-001 and OTR-002 initiatives\"\n\n- `/bounded_context/profile.cml` (101 lines added)\n- `/bounded_context/profile.adoc` (architectural decisions and initiative mapping)\n\nThe documentation now clearly shows how ProfileService serves as a foundational bounded context that reduces duplication and establishes repeatable DDD patterns for future services."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":11,"cache_creation_input_tokens":545,"cache_read_input_tokens":90747,"cache_creation":{"ephemeral_5m_input_tokens":545,"ephemeral_1h_input_tokens":0},"output_tokens":583,"service_tier":"standard"}},"requestId":"req_011CWwBXBsh9VGWzcpXr5Nfa","type":"assistant","uuid":"c76888a9-decd-4104-a01d-916980032759","timestamp":"2026-01-09T04:35:32.163Z"}
{"parentUuid":"c76888a9-decd-4104-a01d-916980032759","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"system","subtype":"turn_duration","durationMs":180118,"timestamp":"2026-01-09T04:35:33.300Z","uuid":"af7bdf61-39bf-4e16-b55d-1a003c9a8660","isMeta":false}
{"type":"file-history-snapshot","messageId":"ac0812f2-8c25-4390-8ee8-3599b6003b24","snapshot":{"messageId":"ac0812f2-8c25-4390-8ee8-3599b6003b24","trackedFileBackups":{"solution_architectures/salesforce_customer_support.adoc":{"backupFileName":"ef19bf3282a777f7@v2","version":2,"backupTime":"2026-01-09T03:13:31.966Z"},"bounded_context/profile.adoc":{"backupFileName":"5794d0bd8cc1c5d2@v2","version":2,"backupTime":"2026-01-09T04:53:10.175Z"},"bounded_context/profile.cml":{"backupFileName":"082a4df2066ba3ba@v2","version":2,"backupTime":"2026-01-09T04:53:10.187Z"}},"timestamp":"2026-01-09T04:53:10.156Z"},"isSnapshotUpdate":false}
{"parentUuid":"af7bdf61-39bf-4e16-b55d-1a003c9a8660","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":"Are teh structures of the solution architectures consistent"},"uuid":"ac0812f2-8c25-4390-8ee8-3599b6003b24","timestamp":"2026-01-09T04:53:10.137Z","thinkingMetadata":{"level":"high","disabled":false,"triggers":[]},"todos":[]}
{"parentUuid":"ac0812f2-8c25-4390-8ee8-3599b6003b24","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01LgKCei8LWXhLwMKCXygX2s","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"The user is asking whether the structures of the solution architectures are consistent. I should check the solution architecture documents to see if they follow a consistent structure/format.\n\nLet me look at both solution architecture files:\n1. flybuys_integration.adoc\n2. salesforce_customer_support.adoc\n\nI need to compare their structures to see if they're consistent.","signature":"EpoECkYICxgCKkALMJgVcC6zK/PQahzDGGyPhA3DKL2dZJL8Ns89O40LWvRy5cWTfe4cjKGCKMbNyTUNa2mc9HjnKpHcZQk0KwuaEgwXkSNTf+nCI+IPNNwaDD7TQBx/Zpqu+rqjZyIwGhb5fbZYmqaCq+wElhKKHL9dkWBtTDz784EsSFGdcXtdtaxgcw0/a5Jq6xeWz5LXKoEDP4973LqilbIL79qHFmYgl5Wdg9wNcE08DlOEUQaTepPRbU59A76IUHC6vzfTOOe97In2wty6VpeUkE1CUn/3lfrXT9L12MQd4tH0AzPrHpeFt+u3JASAcPgs6hEdHrB8jhP9vI2YRcJ+19/ZSb0AjExC/FyyBJUl9bn/4PSRN2emr2hmtIk+9qpA/oRXLBLHUgzK6plh1m+WldIkszriBQkX+lvhw0zaF1/gvM+1T2y+dy8FyLvvxFq2Y5QD8VBu7R5RleT1M+BeeJFkizkKlRRO2SeWiVk55tF+x+WYoaH/p4eLeaXkjsTzXG1y4gv7AB9Q18nMKgoHVFy7rpvFKaP2cKv/Bl3NEgOaSfpJ4PRsYRitkdkftp1ae8eeWgiUwgmFfIZl8EaiXbdfwwSOGZylPNa+5wT2GIQuZVbG6U/36qFDoBRAeaS2m4HsKuXMx3MH/QTvOEEdpH2HHV+fwQA5kKYr4ne30nmnXQvs+bZOjaU9Ph1g4nAIgn9IDW2UzxgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":90862,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":90862,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWwCt9WWr6hVtysVZh8G8","type":"assistant","uuid":"eb1faf2f-c016-4268-99ee-06d52a52c917","timestamp":"2026-01-09T04:53:15.583Z"}
{"parentUuid":"eb1faf2f-c016-4268-99ee-06d52a52c917","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01LgKCei8LWXhLwMKCXygX2s","type":"message","role":"assistant","content":[{"type":"text","text":"I'll check the structures of both solution architecture documents to see if they're consistent."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":90862,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":90862,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWwCt9WWr6hVtysVZh8G8","type":"assistant","uuid":"d64a5dd7-170e-4aab-9507-965ec0c86ba7","timestamp":"2026-01-09T04:53:15.983Z"}
{"parentUuid":"d64a5dd7-170e-4aab-9507-965ec0c86ba7","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01LgKCei8LWXhLwMKCXygX2s","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_014uoewMLJgVNNYq5LLnAssQ","name":"Bash","input":{"command":"grep -E \"^=+ \" solution_architectures/flybuys_integration.adoc | head -40","description":"Extract Flybuys headings structure"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":90862,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":90862,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWwCt9WWr6hVtysVZh8G8","type":"assistant","uuid":"1910710d-2848-425a-93e7-d59702a8d306","timestamp":"2026-01-09T04:53:17.138Z"}
{"parentUuid":"1910710d-2848-425a-93e7-d59702a8d306","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01LgKCei8LWXhLwMKCXygX2s","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01B4D53vcArdJo2QBixUkNFf","name":"Bash","input":{"command":"grep -E \"^=+ \" solution_architectures/salesforce_customer_support.adoc | head -40","description":"Extract Salesforce headings structure"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":90862,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":90862,"ephemeral_1h_input_tokens":0},"output_tokens":289,"service_tier":"standard"}},"requestId":"req_011CWwCt9WWr6hVtysVZh8G8","type":"assistant","uuid":"cbef9f2e-1906-4d26-89a0-a3a36f8bca87","timestamp":"2026-01-09T04:53:17.717Z"}
{"parentUuid":"cbef9f2e-1906-4d26-89a0-a3a36f8bca87","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01B4D53vcArdJo2QBixUkNFf","type":"tool_result","content":"= Salesforce Customer Support - Solution Architecture\n== Purpose and Scope\n=== Purpose\n=== Vision\n=== Architectural Approach\n=== Scope\n==== In Scope\n==== Out of Scope\n===== Covered in xref:architecture-definitions:salesforce_customer_support.adoc[Architecture Definition]\n===== Covered in Other Documents\n=== Architecture Overview\n==== Key Architectural Patterns\n== Solution Approach\n=== Related Documentation\n==== Architecture Definition\n==== Bounded Context Specifications\n==== Interface Specifications\n==== External System Documentation\n== Executive Summary\n=== Challenge\n=== Solution\n==== New Bounded Contexts\n==== Integration Architecture\n==== Migration Approach\n=== Key Architectural Significance\n=== Success Criteria\n=== Technical Constraints\n=== Open Technical Decisions (TBD)\n== Technical Requirements\n== Technical Architecture\n=== Technical Capability Requirements\n==== Requirements Traceability\n=== Service Catalogues\n==== Application Portfolio Catalogue\n==== Technology Capability Requirements\n==== Feature Flag Register\n==== Data Entity Catalogue\n==== Data Quality & Validation\n== Solution Building Blocks\n=== Technology Portfolio Catalogue","is_error":false}]},"uuid":"384fc472-eff1-4af8-a592-265b2a02d6e8","timestamp":"2026-01-09T04:53:17.921Z","toolUseResult":{"stdout":"= Salesforce Customer Support - Solution Architecture\n== Purpose and Scope\n=== Purpose\n=== Vision\n=== Architectural Approach\n=== Scope\n==== In Scope\n==== Out of Scope\n===== Covered in xref:architecture-definitions:salesforce_customer_support.adoc[Architecture Definition]\n===== Covered in Other Documents\n=== Architecture Overview\n==== Key Architectural Patterns\n== Solution Approach\n=== Related Documentation\n==== Architecture Definition\n==== Bounded Context Specifications\n==== Interface Specifications\n==== External System Documentation\n== Executive Summary\n=== Challenge\n=== Solution\n==== New Bounded Contexts\n==== Integration Architecture\n==== Migration Approach\n=== Key Architectural Significance\n=== Success Criteria\n=== Technical Constraints\n=== Open Technical Decisions (TBD)\n== Technical Requirements\n== Technical Architecture\n=== Technical Capability Requirements\n==== Requirements Traceability\n=== Service Catalogues\n==== Application Portfolio Catalogue\n==== Technology Capability Requirements\n==== Feature Flag Register\n==== Data Entity Catalogue\n==== Data Quality & Validation\n== Solution Building Blocks\n=== Technology Portfolio Catalogue","stderr":"","interrupted":false,"isImage":false},"sourceToolAssistantUUID":"cbef9f2e-1906-4d26-89a0-a3a36f8bca87"}
{"parentUuid":"1910710d-2848-425a-93e7-d59702a8d306","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_014uoewMLJgVNNYq5LLnAssQ","type":"tool_result","content":"= Flybuys Integration - Solution Architecture\n== Purpose and Scope\n=== Purpose\n=== Scope\n==== In Scope\n==== Out of Scope\n===== Covered in xref:architecture-definitions:flybuys_integration.adoc[Architecture Definition]\n===== Covered in other documents\n== Executive Summary\n== Solution Approach\n=== Related Documentation\n==== API Specifications\n==== Sequence Diagrams\n==== JSON Schemas\n==== Executive Summary\n== Key Technology Decisions\n=== Implementation Constraints\n=== Success Criteria\n== Solution Building Blocks\n=== Technology Portfolio Catalogue\n=== Solution Building Block Mapping\n=== SBB-001: Profile Service API\n==== Dependencies\n=== SBB-002: Profile Service Database\n=== SBB-003: Loyalty Service API\n==== Capabilities\n===== Loyalty Credential Resolution\n==== Dependencies\n=== SBB-004: Loyalty Service Database\n=== SBB-005: OAuth Token Manager\n==== OAuth Token Refresh Flow\n==== Dependencies\n=== SBB-006: Domain Event Bus\n==== Event Specifications\n===== Topics\n==== Event Documentation\n==== Event Propagation Timeline\n==== Event Flow\n=== SBB-007: Engagement Service API\n==== Responsibilities","is_error":false}]},"uuid":"074b42e7-8524-4fe2-9654-bf7600794e2f","timestamp":"2026-01-09T04:53:17.929Z","toolUseResult":{"stdout":"= Flybuys Integration - Solution Architecture\n== Purpose and Scope\n=== Purpose\n=== Scope\n==== In Scope\n==== Out of Scope\n===== Covered in xref:architecture-definitions:flybuys_integration.adoc[Architecture Definition]\n===== Covered in other documents\n== Executive Summary\n== Solution Approach\n=== Related Documentation\n==== API Specifications\n==== Sequence Diagrams\n==== JSON Schemas\n==== Executive Summary\n== Key Technology Decisions\n=== Implementation Constraints\n=== Success Criteria\n== Solution Building Blocks\n=== Technology Portfolio Catalogue\n=== Solution Building Block Mapping\n=== SBB-001: Profile Service API\n==== Dependencies\n=== SBB-002: Profile Service Database\n=== SBB-003: Loyalty Service API\n==== Capabilities\n===== Loyalty Credential Resolution\n==== Dependencies\n=== SBB-004: Loyalty Service Database\n=== SBB-005: OAuth Token Manager\n==== OAuth Token Refresh Flow\n==== Dependencies\n=== SBB-006: Domain Event Bus\n==== Event Specifications\n===== Topics\n==== Event Documentation\n==== Event Propagation Timeline\n==== Event Flow\n=== SBB-007: Engagement Service API\n==== Responsibilities","stderr":"","interrupted":false,"isImage":false},"sourceToolAssistantUUID":"1910710d-2848-425a-93e7-d59702a8d306"}
{"parentUuid":"074b42e7-8524-4fe2-9654-bf7600794e2f","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01GA2ASLvF9ytxHhJNfzuvcj","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"I can see the structures are quite different. Let me get a more complete view of both structures to compare them properly.","signature":"EqMCCkYICxgCKkBvERkbEflHPudOnmwgTw85eHNFAN9T02cT0rk2kNt8h2qgPLjXlxDB2m2jaFoum3b6GKyF5Posu16OKZoTI5u3EgzvjGN6Hao0ZoQzAucaDDMXX78P9V1Ar49xlyIwGEM6dulErHHfKnsff/16S2qtc1FeRdnbXn0ovuw4SqBgehNLLT9M79MN6ap7D/gOKooBJvI3JGLuh/vNk1U4FjVevvG9WYjtRvf1Ft8TgxzwmwpNBS3MMNNvo0/Xw4UEM9ZTHAYZ+qCfNHqHabY2+pJlQcEkcHUiXPPhnQ0fpCyp0ySUbwCVgGqmKFuDDowJ2jeoZowCWotnIveLFT/R3Ca3kC5/HwLbmArfuTISpwfivunrsDMx39xTqnZ+GAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":309,"cache_creation_input_tokens":628,"cache_read_input_tokens":90862,"cache_creation":{"ephemeral_5m_input_tokens":628,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CWwCtiuT7uio1PUk8VcvQ","type":"assistant","uuid":"2fba1498-c9f3-4d94-b095-2f67378e90a5","timestamp":"2026-01-09T04:53:22.074Z"}
{"parentUuid":"2fba1498-c9f3-4d94-b095-2f67378e90a5","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01GA2ASLvF9ytxHhJNfzuvcj","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_011uv2xycLF9u1uh17vicwaG","name":"Bash","input":{"command":"grep -E \"^=+ \" solution_architectures/flybuys_integration.adoc | nl","description":"Get full Flybuys structure"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":309,"cache_creation_input_tokens":628,"cache_read_input_tokens":90862,"cache_creation":{"ephemeral_5m_input_tokens":628,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CWwCtiuT7uio1PUk8VcvQ","type":"assistant","uuid":"0b5d3791-9997-421c-85c2-431b7e443edc","timestamp":"2026-01-09T04:53:22.861Z"}
{"parentUuid":"0b5d3791-9997-421c-85c2-431b7e443edc","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01GA2ASLvF9ytxHhJNfzuvcj","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_016cxdUJQVw65Z7BZ6Fp8Cg8","name":"Bash","input":{"command":"grep -E \"^=+ \" solution_architectures/salesforce_customer_support.adoc | nl","description":"Get full Salesforce structure"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":309,"cache_creation_input_tokens":628,"cache_read_input_tokens":90862,"cache_creation":{"ephemeral_5m_input_tokens":628,"ephemeral_1h_input_tokens":0},"output_tokens":209,"service_tier":"standard"}},"requestId":"req_011CWwCtiuT7uio1PUk8VcvQ","type":"assistant","uuid":"23c29979-1e5f-4e53-aafd-a2c0dc482b4c","timestamp":"2026-01-09T04:53:23.420Z"}
{"parentUuid":"0b5d3791-9997-421c-85c2-431b7e443edc","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_011uv2xycLF9u1uh17vicwaG","type":"tool_result","content":"     1\t= Flybuys Integration - Solution Architecture\n     2\t== Purpose and Scope\n     3\t=== Purpose\n     4\t=== Scope\n     5\t==== In Scope\n     6\t==== Out of Scope\n     7\t===== Covered in xref:architecture-definitions:flybuys_integration.adoc[Architecture Definition]\n     8\t===== Covered in other documents\n     9\t== Executive Summary\n    10\t== Solution Approach\n    11\t=== Related Documentation\n    12\t==== API Specifications\n    13\t==== Sequence Diagrams\n    14\t==== JSON Schemas\n    15\t==== Executive Summary\n    16\t== Key Technology Decisions\n    17\t=== Implementation Constraints\n    18\t=== Success Criteria\n    19\t== Solution Building Blocks\n    20\t=== Technology Portfolio Catalogue\n    21\t=== Solution Building Block Mapping\n    22\t=== SBB-001: Profile Service API\n    23\t==== Dependencies\n    24\t=== SBB-002: Profile Service Database\n    25\t=== SBB-003: Loyalty Service API\n    26\t==== Capabilities\n    27\t===== Loyalty Credential Resolution\n    28\t==== Dependencies\n    29\t=== SBB-004: Loyalty Service Database\n    30\t=== SBB-005: OAuth Token Manager\n    31\t==== OAuth Token Refresh Flow\n    32\t==== Dependencies\n    33\t=== SBB-006: Domain Event Bus\n    34\t==== Event Specifications\n    35\t===== Topics\n    36\t==== Event Documentation\n    37\t==== Event Propagation Timeline\n    38\t==== Event Flow\n    39\t=== SBB-007: Engagement Service API\n    40\t==== Responsibilities\n    41\t==== Key Events Consumed\n    42\t=== SBB-008: Engagement Service Database\n    43\t=== SBB-009: Braze Integration Adaptor\n    44\t==== Dependencies\n    45\t=== SBB-010: Flybuys Integration Adaptor\n    46\t=== SBB-011: EagleEye Integration Adaptor\n    47\t=== SBB-012: Application Monitoring\n    48\t=== SBB-013: API Gateway\n    49\t=== SBB-014: OTR Mobile App\n    50\t==== Integration\n    51\t=== SBB-015: Batch File Pipeline\n    52\t==== Batch File Processing Flow\n    53\t=== SBB-016: Distributed Cache\n    54\t==== Circuit Breaker Pattern\n    55\t=== SBB-017: Feature Flag Service\n    56\t=== SBB-018: Location\n    57\t== Data Architecture\n    58\t=== Physical Data Models\n    59\t==== Profile Service - PartnerLink Document Schema\n    60\t===== JSON Schema\n    61\t===== Database Configuration\n    62\t===== Key Fields\n    63\t===== Example Document\n    64\t===== Indexes\n    65\t===== Constraints\n    66\t==== Loyalty Service - RewardTransaction Document Schema\n    67\t===== JSON Schema\n    68\t===== Database Configuration\n    69\t===== Key Fields\n    70\t===== Example Document\n    71\t===== Indexes\n    72\t===== Constraints\n    73\t==== OAuth Token Storage Schema (Key Vault)\n    74\t===== JSON Schema\n    75\t===== Key Vault Configuration\n    76\t===== Secret Value (JSON) - Key Fields\n    77\t===== Example Secret\n    78\t===== Metadata\n    79\t===== Encryption\n    80\t== Interface Specifications\n    81\t=== Complete API Documentation\n    82\t=== REST API\n    83\t=== Domain Events\n    84\t==== AsyncAPI Specification\n    85\t==== Event Schemas\n    86\t==== API Versioning Policy\n    87\t===== Version Numbering\n    88\t===== When to Version\n    89\t===== Parallel Version Support\n    90\t===== Deprecation Notification\n    91\t===== Version Discovery\n    92\t===== Consumer Compatibility\n    93\t===== Error Response for Sunset APIs\n    94\t===== Semantic Versioning Alignment\n    95\t==== Loyalty Credential Resolution API\n    96\t==== Customer Profile Creation API\n    97\t==== Customer Profile Retrieval API\n    98\t=== Domain Events\n    99\t==== Event Catalogue\n   100\t==== Event Consumers\n   101\t==== Event Delivery Guarantees\n   102\t=== Correlation ID Propagation Specification\n   103\t==== Standard\n   104\t==== HTTP Propagation\n   105\t==== Event Propagation\n   106\t==== Structured Logging\n   107\t==== Trace Visualization\n   108\t==== Implementation Notes\n   109\t=== Data Formats\n   110\t==== Flybuys Batch File Format (CSV)\n   111\t===== Format\n   112\t===== Field Specifications\n   113\t===== File Requirements\n   114\t===== PGP Encryption Specifications\n   115\t=== Interaction Flows\n   116\t==== OAuth linking Flow (TS-2 linking)\n   117\t==== Just-In-Time Profile Creation Flow (TS-1 Foundation)\n   118\t==== POS Integration Flow (TS-3 Grants)\n   119\t==== POS Transaction Adjudication Flow (TS-3 Grants)\n   120\t==== Batch File Processing Flow (TS-3 Grants)\n   121\t== Gap Analysis\n   122\t=== Missing Capabilities\n   123\t=== Missing Bounded Contexts\n   124\t=== Missing Integration Patterns\n   125\t=== Target State Architecture\n   126\t==== Architectural Building Blocks (ABB)\n   127\t== Work Packages\n   128\t=== Work Package Overview\n   129\t=== WP-FB-001: ProfileService Development\n   130\t==== Description\n   131\t==== Deliverables\n   132\t==== Dependencies\n   133\t==== Skills Required\n   134\t==== Acceptance Criteria\n   135\t=== WP-FB-002: LoyaltyService Development\n   136\t==== Description\n   137\t==== Deliverables\n   138\t==== Dependencies\n   139\t==== Skills Required\n   140\t==== Acceptance Criteria\n   141\t=== WP-FB-003: Event Bus Infrastructure\n   142\t==== Description\n   143\t==== Deliverables\n   144\t==== Dependencies\n   145\t==== Skills Required\n   146\t==== Acceptance Criteria\n   147\t=== WP-FB-004: Flybuys OAuth Integration\n   148\t==== Description\n   149\t==== Deliverables\n   150\t==== Dependencies\n   151\t==== Skills Required\n   152\t==== Acceptance Criteria\n   153\t=== WP-FB-005: EagleEye Integration\n   154\t==== Description\n   155\t==== Deliverables\n   156\t==== Dependencies\n   157\t==== Skills Required\n   158\t==== Acceptance Criteria\n   159\t=== WP-FB-006: Mobile App Integration\n   160\t==== Description\n   161\t==== Deliverables\n   162\t==== Dependencies\n   163\t==== Skills Required\n   164\t==== Acceptance Criteria\n   165\t=== WP-FB-007: POS Integration\n   166\t==== Description\n   167\t==== Deliverables\n   168\t==== Dependencies\n   169\t==== Skills Required\n   170\t==== Acceptance Criteria\n   171\t=== WP-FB-008: Batch Processing System\n   172\t==== Description\n   173\t==== Deliverables\n   174\t==== Dependencies\n   175\t==== Skills Required\n   176\t==== Acceptance Criteria\n   177\t=== WP-FB-009: Integration Testing\n   178\t==== Description\n   179\t==== Deliverables\n   180\t==== Dependencies\n   181\t==== Skills Required\n   182\t==== Acceptance Criteria\n   183\t=== WP-FB-010: Phased Production Deployment\n   184\t==== Description\n   185\t==== Deliverables\n   186\t==== Dependencies\n   187\t==== Skills Required\n   188\t==== Acceptance Criteria\n   189\t=== Work Package Sequencing\n   190\t==== Parallel Track 1: Foundation Infrastructure\n   191\t==== Parallel Track 2: Core Services Development\n   192\t==== Sequential Track 3: Integration Development\n   193\t==== Sequential Track 4: Testing & Deployment\n   194\t==== Critical Path\n   195\t== Transition Architecture\n   196\t=== Transition Phase Matrix\n   197\t=== Rollback Strategy\n   198\t==== TS-1 Foundation Rollback\n   199\t==== TS-2 linking Rollback\n   200\t==== TS-3 Grants Rollback\n   201\t==== Partial Rollback (Batch Posting Issues Only)\n   202\t=== TS-0 Current State\n   203\t==== Active Components\n   204\t==== Technical Debt\n   205\t=== TS-1 Foundation\n   206\t==== New SBBS\n   207\t==== Implementation Approach\n   208\t===== Architecture Diagram\n   209\t===== Rollout Strategy\n   210\t===== Events\n   211\t===== Success Criteria\n   212\t===== Dependencies\n   213\t==== Rollback Approach\n   214\t===== Feature Flags\n   215\t=== TS-2 linking\n   216\t==== New SBB\n   217\t==== New Capabilities\n   218\t==== Implementation Approach\n   219\t===== Monitoring\n   220\t===== Cutover\n   221\t===== Architecture Diagram\n   222\t===== Rollout\n   223\t====== Ring 0 (Internal Validation)\n   224\t====== Ring 1 (Pilot Users)\n   225\t====== Ring 2 (General availability)\n   226\t===== Events\n   227\t===== Dependencies\n   228\t===== Success Criteria\n   229\t==== Rollback Approach\n   230\t===== Feature Flags\n   231\t=== TS-3 Grants\n   232\t==== New SBB\n   233\t==== Implementation Approach\n   234\t===== Feature Flags\n   235\t=== TS-4 Target State\n   236\t==== Success Criteria (Entry to TS-4)\n   237\t==== Characteristics of Target State\n   238\t===== Feature Flags\n   239\t===== Architecture\n   240\t=== Technical Dependency Graph\n   241\t=== Transition Risks\n   242\t== Solution Validation\n   243\t=== Functional Validation\n   244\t=== Non-Functional Validation\n   245\t=== Integration Validation\n   246\t=== Security Validation\n   247\t=== SBB Dependency Flowchart\n   248\t==== Dependency Chain Diagram\n   249\t==== Dependency Layers\n   250\t===== Layer 1: External Systems\n   251\t===== Layer 2: Presentation & Gateway\n   252\t===== Layer 3: Domain Services\n   253\t===== Layer 4: Data Stores\n   254\t===== Layer 5: Infrastructure Services\n   255\t===== Layer 6: Integration Adaptors (Anti-Corruption Layers)\n   256\t===== Layer 7: Batch Processing\n   257\t==== Critical Dependency Paths\n   258\t===== Partner linking Flow\n   259\t===== Transaction Adjudication Flow\n   260\t===== Flybuys Balance Query Flow\n   261\t===== Event-Driven Engagement Flow\n   262\t==== Notes","is_error":false}]},"uuid":"bcb580b8-5c56-45c9-bbcd-da04884e6128","timestamp":"2026-01-09T04:53:23.670Z","toolUseResult":{"stdout":"     1\t= Flybuys Integration - Solution Architecture\n     2\t== Purpose and Scope\n     3\t=== Purpose\n     4\t=== Scope\n     5\t==== In Scope\n     6\t==== Out of Scope\n     7\t===== Covered in xref:architecture-definitions:flybuys_integration.adoc[Architecture Definition]\n     8\t===== Covered in other documents\n     9\t== Executive Summary\n    10\t== Solution Approach\n    11\t=== Related Documentation\n    12\t==== API Specifications\n    13\t==== Sequence Diagrams\n    14\t==== JSON Schemas\n    15\t==== Executive Summary\n    16\t== Key Technology Decisions\n    17\t=== Implementation Constraints\n    18\t=== Success Criteria\n    19\t== Solution Building Blocks\n    20\t=== Technology Portfolio Catalogue\n    21\t=== Solution Building Block Mapping\n    22\t=== SBB-001: Profile Service API\n    23\t==== Dependencies\n    24\t=== SBB-002: Profile Service Database\n    25\t=== SBB-003: Loyalty Service API\n    26\t==== Capabilities\n    27\t===== Loyalty Credential Resolution\n    28\t==== Dependencies\n    29\t=== SBB-004: Loyalty Service Database\n    30\t=== SBB-005: OAuth Token Manager\n    31\t==== OAuth Token Refresh Flow\n    32\t==== Dependencies\n    33\t=== SBB-006: Domain Event Bus\n    34\t==== Event Specifications\n    35\t===== Topics\n    36\t==== Event Documentation\n    37\t==== Event Propagation Timeline\n    38\t==== Event Flow\n    39\t=== SBB-007: Engagement Service API\n    40\t==== Responsibilities\n    41\t==== Key Events Consumed\n    42\t=== SBB-008: Engagement Service Database\n    43\t=== SBB-009: Braze Integration Adaptor\n    44\t==== Dependencies\n    45\t=== SBB-010: Flybuys Integration Adaptor\n    46\t=== SBB-011: EagleEye Integration Adaptor\n    47\t=== SBB-012: Application Monitoring\n    48\t=== SBB-013: API Gateway\n    49\t=== SBB-014: OTR Mobile App\n    50\t==== Integration\n    51\t=== SBB-015: Batch File Pipeline\n    52\t==== Batch File Processing Flow\n    53\t=== SBB-016: Distributed Cache\n    54\t==== Circuit Breaker Pattern\n    55\t=== SBB-017: Feature Flag Service\n    56\t=== SBB-018: Location\n    57\t== Data Architecture\n    58\t=== Physical Data Models\n    59\t==== Profile Service - PartnerLink Document Schema\n    60\t===== JSON Schema\n    61\t===== Database Configuration\n    62\t===== Key Fields\n    63\t===== Example Document\n    64\t===== Indexes\n    65\t===== Constraints\n    66\t==== Loyalty Service - RewardTransaction Document Schema\n    67\t===== JSON Schema\n    68\t===== Database Configuration\n    69\t===== Key Fields\n    70\t===== Example Document\n    71\t===== Indexes\n    72\t===== Constraints\n    73\t==== OAuth Token Storage Schema (Key Vault)\n    74\t===== JSON Schema\n    75\t===== Key Vault Configuration\n    76\t===== Secret Value (JSON) - Key Fields\n    77\t===== Example Secret\n    78\t===== Metadata\n    79\t===== Encryption\n    80\t== Interface Specifications\n    81\t=== Complete API Documentation\n    82\t=== REST API\n    83\t=== Domain Events\n    84\t==== AsyncAPI Specification\n    85\t==== Event Schemas\n    86\t==== API Versioning Policy\n    87\t===== Version Numbering\n    88\t===== When to Version\n    89\t===== Parallel Version Support\n    90\t===== Deprecation Notification\n    91\t===== Version Discovery\n    92\t===== Consumer Compatibility\n    93\t===== Error Response for Sunset APIs\n    94\t===== Semantic Versioning Alignment\n    95\t==== Loyalty Credential Resolution API\n    96\t==== Customer Profile Creation API\n    97\t==== Customer Profile Retrieval API\n    98\t=== Domain Events\n    99\t==== Event Catalogue\n   100\t==== Event Consumers\n   101\t==== Event Delivery Guarantees\n   102\t=== Correlation ID Propagation Specification\n   103\t==== Standard\n   104\t==== HTTP Propagation\n   105\t==== Event Propagation\n   106\t==== Structured Logging\n   107\t==== Trace Visualization\n   108\t==== Implementation Notes\n   109\t=== Data Formats\n   110\t==== Flybuys Batch File Format (CSV)\n   111\t===== Format\n   112\t===== Field Specifications\n   113\t===== File Requirements\n   114\t===== PGP Encryption Specifications\n   115\t=== Interaction Flows\n   116\t==== OAuth linking Flow (TS-2 linking)\n   117\t==== Just-In-Time Profile Creation Flow (TS-1 Foundation)\n   118\t==== POS Integration Flow (TS-3 Grants)\n   119\t==== POS Transaction Adjudication Flow (TS-3 Grants)\n   120\t==== Batch File Processing Flow (TS-3 Grants)\n   121\t== Gap Analysis\n   122\t=== Missing Capabilities\n   123\t=== Missing Bounded Contexts\n   124\t=== Missing Integration Patterns\n   125\t=== Target State Architecture\n   126\t==== Architectural Building Blocks (ABB)\n   127\t== Work Packages\n   128\t=== Work Package Overview\n   129\t=== WP-FB-001: ProfileService Development\n   130\t==== Description\n   131\t==== Deliverables\n   132\t==== Dependencies\n   133\t==== Skills Required\n   134\t==== Acceptance Criteria\n   135\t=== WP-FB-002: LoyaltyService Development\n   136\t==== Description\n   137\t==== Deliverables\n   138\t==== Dependencies\n   139\t==== Skills Required\n   140\t==== Acceptance Criteria\n   141\t=== WP-FB-003: Event Bus Infrastructure\n   142\t==== Description\n   143\t==== Deliverables\n   144\t==== Dependencies\n   145\t==== Skills Required\n   146\t==== Acceptance Criteria\n   147\t=== WP-FB-004: Flybuys OAuth Integration\n   148\t==== Description\n   149\t==== Deliverables\n   150\t==== Dependencies\n   151\t==== Skills Required\n   152\t==== Acceptance Criteria\n   153\t=== WP-FB-005: EagleEye Integration\n   154\t==== Description\n   155\t==== Deliverables\n   156\t==== Dependencies\n   157\t==== Skills Required\n   158\t==== Acceptance Criteria\n   159\t=== WP-FB-006: Mobile App Integration\n   160\t==== Description\n   161\t==== Deliverables\n   162\t==== Dependencies\n   163\t==== Skills Required\n   164\t==== Acceptance Criteria\n   165\t=== WP-FB-007: POS Integration\n   166\t==== Description\n   167\t==== Deliverables\n   168\t==== Dependencies\n   169\t==== Skills Required\n   170\t==== Acceptance Criteria\n   171\t=== WP-FB-008: Batch Processing System\n   172\t==== Description\n   173\t==== Deliverables\n   174\t==== Dependencies\n   175\t==== Skills Required\n   176\t==== Acceptance Criteria\n   177\t=== WP-FB-009: Integration Testing\n   178\t==== Description\n   179\t==== Deliverables\n   180\t==== Dependencies\n   181\t==== Skills Required\n   182\t==== Acceptance Criteria\n   183\t=== WP-FB-010: Phased Production Deployment\n   184\t==== Description\n   185\t==== Deliverables\n   186\t==== Dependencies\n   187\t==== Skills Required\n   188\t==== Acceptance Criteria\n   189\t=== Work Package Sequencing\n   190\t==== Parallel Track 1: Foundation Infrastructure\n   191\t==== Parallel Track 2: Core Services Development\n   192\t==== Sequential Track 3: Integration Development\n   193\t==== Sequential Track 4: Testing & Deployment\n   194\t==== Critical Path\n   195\t== Transition Architecture\n   196\t=== Transition Phase Matrix\n   197\t=== Rollback Strategy\n   198\t==== TS-1 Foundation Rollback\n   199\t==== TS-2 linking Rollback\n   200\t==== TS-3 Grants Rollback\n   201\t==== Partial Rollback (Batch Posting Issues Only)\n   202\t=== TS-0 Current State\n   203\t==== Active Components\n   204\t==== Technical Debt\n   205\t=== TS-1 Foundation\n   206\t==== New SBBS\n   207\t==== Implementation Approach\n   208\t===== Architecture Diagram\n   209\t===== Rollout Strategy\n   210\t===== Events\n   211\t===== Success Criteria\n   212\t===== Dependencies\n   213\t==== Rollback Approach\n   214\t===== Feature Flags\n   215\t=== TS-2 linking\n   216\t==== New SBB\n   217\t==== New Capabilities\n   218\t==== Implementation Approach\n   219\t===== Monitoring\n   220\t===== Cutover\n   221\t===== Architecture Diagram\n   222\t===== Rollout\n   223\t====== Ring 0 (Internal Validation)\n   224\t====== Ring 1 (Pilot Users)\n   225\t====== Ring 2 (General availability)\n   226\t===== Events\n   227\t===== Dependencies\n   228\t===== Success Criteria\n   229\t==== Rollback Approach\n   230\t===== Feature Flags\n   231\t=== TS-3 Grants\n   232\t==== New SBB\n   233\t==== Implementation Approach\n   234\t===== Feature Flags\n   235\t=== TS-4 Target State\n   236\t==== Success Criteria (Entry to TS-4)\n   237\t==== Characteristics of Target State\n   238\t===== Feature Flags\n   239\t===== Architecture\n   240\t=== Technical Dependency Graph\n   241\t=== Transition Risks\n   242\t== Solution Validation\n   243\t=== Functional Validation\n   244\t=== Non-Functional Validation\n   245\t=== Integration Validation\n   246\t=== Security Validation\n   247\t=== SBB Dependency Flowchart\n   248\t==== Dependency Chain Diagram\n   249\t==== Dependency Layers\n   250\t===== Layer 1: External Systems\n   251\t===== Layer 2: Presentation & Gateway\n   252\t===== Layer 3: Domain Services\n   253\t===== Layer 4: Data Stores\n   254\t===== Layer 5: Infrastructure Services\n   255\t===== Layer 6: Integration Adaptors (Anti-Corruption Layers)\n   256\t===== Layer 7: Batch Processing\n   257\t==== Critical Dependency Paths\n   258\t===== Partner linking Flow\n   259\t===== Transaction Adjudication Flow\n   260\t===== Flybuys Balance Query Flow\n   261\t===== Event-Driven Engagement Flow\n   262\t==== Notes","stderr":"","interrupted":false,"isImage":false},"sourceToolAssistantUUID":"0b5d3791-9997-421c-85c2-431b7e443edc"}
{"parentUuid":"23c29979-1e5f-4e53-aafd-a2c0dc482b4c","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_016cxdUJQVw65Z7BZ6Fp8Cg8","type":"tool_result","content":"     1\t= Salesforce Customer Support - Solution Architecture\n     2\t== Purpose and Scope\n     3\t=== Purpose\n     4\t=== Vision\n     5\t=== Architectural Approach\n     6\t=== Scope\n     7\t==== In Scope\n     8\t==== Out of Scope\n     9\t===== Covered in xref:architecture-definitions:salesforce_customer_support.adoc[Architecture Definition]\n    10\t===== Covered in Other Documents\n    11\t=== Architecture Overview\n    12\t==== Key Architectural Patterns\n    13\t== Solution Approach\n    14\t=== Related Documentation\n    15\t==== Architecture Definition\n    16\t==== Bounded Context Specifications\n    17\t==== Interface Specifications\n    18\t==== External System Documentation\n    19\t== Executive Summary\n    20\t=== Challenge\n    21\t=== Solution\n    22\t==== New Bounded Contexts\n    23\t==== Integration Architecture\n    24\t==== Migration Approach\n    25\t=== Key Architectural Significance\n    26\t=== Success Criteria\n    27\t=== Technical Constraints\n    28\t=== Open Technical Decisions (TBD)\n    29\t== Technical Requirements\n    30\t== Technical Architecture\n    31\t=== Technical Capability Requirements\n    32\t==== Requirements Traceability\n    33\t=== Service Catalogues\n    34\t==== Application Portfolio Catalogue\n    35\t==== Technology Capability Requirements\n    36\t==== Feature Flag Register\n    37\t==== Data Entity Catalogue\n    38\t==== Data Quality & Validation\n    39\t== Solution Building Blocks\n    40\t=== Technology Portfolio Catalogue\n    41\t== Data Architecture\n    42\t=== Domain Event Schemas\n    43\t==== Event Catalogue\n    44\t=== API Request/Response Schemas\n    45\t==== ProfileService: GET /profile/contact-id\n    46\t==== EngagementService: POST /feedback\n    47\t=== Salesforce Field Mappings\n    48\t==== Case Object Mapping\n    49\t=== Baseline Architecture\n    50\t==== Existing System Components\n    51\t==== Integration Architecture\n    52\t==== Technical Debt\n    53\t=== Gap Analysis\n    54\t==== Missing Capabilities\n    55\t==== Missing Bounded Contexts\n    56\t==== Missing Integration Patterns\n    57\t=== Target State Architecture\n    58\t==== Architectural Building Blocks (ABB)\n    59\t==== Integration Architecture\n    60\t===== Integration Flows\n    61\t===== System of Record Boundaries\n    62\t==== Data Architecture Principles\n    63\t===== Aggregate Persistence\n    64\t===== Event Store\n    65\t=== Architecture Decisions\n    66\t==== ADR-CS-001: Consolidate onto Salesforce Service Cloud (not build custom solution)\n    67\t==== ADR-CS-002: Implement ProfileService and EngagementService as first DDD bounded contexts\n    68\t==== ADR-CS-003: Async Case creation via Event Bus (not synchronous)\n    69\t==== ADR-CS-004: ProfileService uses email as primary matching key (not VCI)\n    70\t==== ADR-CS-005: No Case migration from D365 CE (fresh start)\n    71\t==== ADR-CS-006: Big bang cutover (not phased rollout)\n    72\t==== ADR-CS-007: EngagementService receives Salesforce webhooks for Case updates\n    73\t== Interface Specifications\n    74\t=== REST API Specifications\n    75\t==== ProfileService API v1\n    76\t==== EngagementService API v1\n    77\t=== Domain Events (AsyncAPI)\n    78\t==== Event Catalogue\n    79\t==== Event Delivery Guarantees\n    80\t=== API Versioning Policy\n    81\t==== Version Numbering\n    82\t==== When to Version\n    83\t==== Parallel Version Support\n    84\t== Work Packages\n    85\t=== Work Package Overview\n    86\t=== WP-CS-001: ProfileService Development\n    87\t==== Description\n    88\t==== Deliverables\n    89\t==== Dependencies\n    90\t==== Skills Required\n    91\t==== Acceptance Criteria\n    92\t=== WP-CS-002: EngagementService Development\n    93\t==== Description\n    94\t==== Deliverables\n    95\t==== Dependencies\n    96\t==== Skills Required\n    97\t==== Acceptance Criteria\n    98\t=== WP-CS-003: Event Bus Infrastructure\n    99\t==== Description\n   100\t==== Deliverables\n   101\t==== Dependencies\n   102\t==== Skills Required\n   103\t==== Acceptance Criteria\n   104\t=== WP-CS-004: Contact Migration Tooling\n   105\t==== Description\n   106\t==== Deliverables\n   107\t==== Dependencies\n   108\t==== Skills Required\n   109\t==== Acceptance Criteria\n   110\t=== WP-CS-005: Mobile App Integration\n   111\t==== Description\n   112\t==== Deliverables\n   113\t==== Dependencies\n   114\t==== Skills Required\n   115\t==== Acceptance Criteria\n   116\t=== WP-CS-006: Integration Testing\n   117\t==== Description\n   118\t==== Deliverables\n   119\t==== Dependencies\n   120\t==== Skills Required\n   121\t==== Acceptance Criteria\n   122\t=== WP-CS-007: Salesforce Configuration\n   123\t==== Description\n   124\t==== Deliverables\n   125\t==== Dependencies\n   126\t==== Skills Required\n   127\t==== Acceptance Criteria\n   128\t=== WP-CS-008: Contact Data Migration\n   129\t==== Description\n   130\t==== Deliverables\n   131\t==== Dependencies\n   132\t==== Skills Required\n   133\t==== Acceptance Criteria\n   134\t=== WP-CS-009: Production Deployment\n   135\t==== Description\n   136\t==== Deliverables\n   137\t==== Dependencies\n   138\t==== Skills Required\n   139\t==== Acceptance Criteria\n   140\t=== WP-CS-010: Post-Cutover Support\n   141\t==== Description\n   142\t==== Deliverables\n   143\t==== Dependencies\n   144\t==== Skills Required\n   145\t==== Acceptance Criteria\n   146\t=== Work Package Sequencing\n   147\t==== Parallel Track 1: Infrastructure & Configuration\n   148\t==== Parallel Track 2: Development\n   149\t==== Sequential Track 3: Integration & Testing\n   150\t==== Sequential Track 4: Migration & Cutover\n   151\t==== Critical Path\n   152\t== Transition Architecture\n   153\t=== Transition Approach\n   154\t=== Transition States\n   155\t==== TS-0: Baseline State (Current)\n   156\t===== Characteristics\n   157\t===== Components Active\n   158\t==== TS-1: Build & Test\n   159\t===== Activities\n   160\t===== Components Active\n   161\t===== Exit Criteria\n   162\t==== TS-2: Contact Migration\n   163\t===== Activities\n   164\t===== Components Active\n   165\t===== Exit Criteria\n   166\t==== TS-3: Cutover (Go-Live)\n   167\t===== Go-Live Activities\n   168\t===== Components Active\n   169\t===== Exit Criteria\n   170\t==== TS-4: Target State (Stable Production)\n   171\t===== Characteristics\n   172\t===== Monitoring Period\n   173\t===== D365 CE Retirement\n   174\t===== Components Active\n   175\t===== Success Criteria Achieved\n   176\t=== Transition Dependencies\n   177\t=== Transition Validation Criteria\n   178\t==== Contact Migration Validation\n   179\t==== Cutover Validation\n   180\t==== Production Monitoring (30 days)\n   181\t=== Rollback Plan\n   182\t==== Rollback Triggers\n   183\t==== Rollback Procedure\n   184\t==== Rollback Limitations\n   185\t=== Architectural Scope Boundaries\n   186\t==== Capabilities Included\n   187\t===== Business Capabilities\n   188\t===== Technical Capabilities\n   189\t==== Capabilities Excluded\n   190\t===== Business Capabilities Explicitly Out of Scope\n   191\t===== Technical Capabilities Explicitly Out of Scope\n   192\t===== Future Bounded Contexts Not in Scope\n   193\t===== Integration Patterns Not in Scope\n   194\t==== Architectural Dependencies on Future Initiatives\n   195\t=== Technical Risks and Mitigation\n   196\t== Assumptions and Constraints\n   197\t=== Assumptions\n   198\t=== Constraints\n   199\t== Non-Functional Requirements\n   200\t=== Performance Requirements\n   201\t=== Availability Requirements\n   202\t=== Scalability Requirements\n   203\t=== Security Requirements\n   204\t=== Reliability Requirements\n   205\t=== Maintainability Requirements\n   206\t=== Usability Requirements\n   207\t=== Compliance Requirements\n   208\t== Monitoring and Observability\n   209\t=== Key Metrics\n   210\t=== Alerting Thresholds\n   211\t=== Dashboards\n   212\t== Solution Validation\n   213\t=== Functional Validation\n   214\t==== ProfileService API Testing\n   215\t==== EngagementService API Testing\n   216\t=== Non-Functional Validation\n   217\t==== Performance Testing\n   218\t==== Resilience Testing\n   219\t==== Security Validation\n   220\t=== Integration Validation\n   221\t==== End-to-End Testing","is_error":false}]},"uuid":"7c946703-efb5-454f-9e45-d7327d4c927a","timestamp":"2026-01-09T04:53:23.679Z","toolUseResult":{"stdout":"     1\t= Salesforce Customer Support - Solution Architecture\n     2\t== Purpose and Scope\n     3\t=== Purpose\n     4\t=== Vision\n     5\t=== Architectural Approach\n     6\t=== Scope\n     7\t==== In Scope\n     8\t==== Out of Scope\n     9\t===== Covered in xref:architecture-definitions:salesforce_customer_support.adoc[Architecture Definition]\n    10\t===== Covered in Other Documents\n    11\t=== Architecture Overview\n    12\t==== Key Architectural Patterns\n    13\t== Solution Approach\n    14\t=== Related Documentation\n    15\t==== Architecture Definition\n    16\t==== Bounded Context Specifications\n    17\t==== Interface Specifications\n    18\t==== External System Documentation\n    19\t== Executive Summary\n    20\t=== Challenge\n    21\t=== Solution\n    22\t==== New Bounded Contexts\n    23\t==== Integration Architecture\n    24\t==== Migration Approach\n    25\t=== Key Architectural Significance\n    26\t=== Success Criteria\n    27\t=== Technical Constraints\n    28\t=== Open Technical Decisions (TBD)\n    29\t== Technical Requirements\n    30\t== Technical Architecture\n    31\t=== Technical Capability Requirements\n    32\t==== Requirements Traceability\n    33\t=== Service Catalogues\n    34\t==== Application Portfolio Catalogue\n    35\t==== Technology Capability Requirements\n    36\t==== Feature Flag Register\n    37\t==== Data Entity Catalogue\n    38\t==== Data Quality & Validation\n    39\t== Solution Building Blocks\n    40\t=== Technology Portfolio Catalogue\n    41\t== Data Architecture\n    42\t=== Domain Event Schemas\n    43\t==== Event Catalogue\n    44\t=== API Request/Response Schemas\n    45\t==== ProfileService: GET /profile/contact-id\n    46\t==== EngagementService: POST /feedback\n    47\t=== Salesforce Field Mappings\n    48\t==== Case Object Mapping\n    49\t=== Baseline Architecture\n    50\t==== Existing System Components\n    51\t==== Integration Architecture\n    52\t==== Technical Debt\n    53\t=== Gap Analysis\n    54\t==== Missing Capabilities\n    55\t==== Missing Bounded Contexts\n    56\t==== Missing Integration Patterns\n    57\t=== Target State Architecture\n    58\t==== Architectural Building Blocks (ABB)\n    59\t==== Integration Architecture\n    60\t===== Integration Flows\n    61\t===== System of Record Boundaries\n    62\t==== Data Architecture Principles\n    63\t===== Aggregate Persistence\n    64\t===== Event Store\n    65\t=== Architecture Decisions\n    66\t==== ADR-CS-001: Consolidate onto Salesforce Service Cloud (not build custom solution)\n    67\t==== ADR-CS-002: Implement ProfileService and EngagementService as first DDD bounded contexts\n    68\t==== ADR-CS-003: Async Case creation via Event Bus (not synchronous)\n    69\t==== ADR-CS-004: ProfileService uses email as primary matching key (not VCI)\n    70\t==== ADR-CS-005: No Case migration from D365 CE (fresh start)\n    71\t==== ADR-CS-006: Big bang cutover (not phased rollout)\n    72\t==== ADR-CS-007: EngagementService receives Salesforce webhooks for Case updates\n    73\t== Interface Specifications\n    74\t=== REST API Specifications\n    75\t==== ProfileService API v1\n    76\t==== EngagementService API v1\n    77\t=== Domain Events (AsyncAPI)\n    78\t==== Event Catalogue\n    79\t==== Event Delivery Guarantees\n    80\t=== API Versioning Policy\n    81\t==== Version Numbering\n    82\t==== When to Version\n    83\t==== Parallel Version Support\n    84\t== Work Packages\n    85\t=== Work Package Overview\n    86\t=== WP-CS-001: ProfileService Development\n    87\t==== Description\n    88\t==== Deliverables\n    89\t==== Dependencies\n    90\t==== Skills Required\n    91\t==== Acceptance Criteria\n    92\t=== WP-CS-002: EngagementService Development\n    93\t==== Description\n    94\t==== Deliverables\n    95\t==== Dependencies\n    96\t==== Skills Required\n    97\t==== Acceptance Criteria\n    98\t=== WP-CS-003: Event Bus Infrastructure\n    99\t==== Description\n   100\t==== Deliverables\n   101\t==== Dependencies\n   102\t==== Skills Required\n   103\t==== Acceptance Criteria\n   104\t=== WP-CS-004: Contact Migration Tooling\n   105\t==== Description\n   106\t==== Deliverables\n   107\t==== Dependencies\n   108\t==== Skills Required\n   109\t==== Acceptance Criteria\n   110\t=== WP-CS-005: Mobile App Integration\n   111\t==== Description\n   112\t==== Deliverables\n   113\t==== Dependencies\n   114\t==== Skills Required\n   115\t==== Acceptance Criteria\n   116\t=== WP-CS-006: Integration Testing\n   117\t==== Description\n   118\t==== Deliverables\n   119\t==== Dependencies\n   120\t==== Skills Required\n   121\t==== Acceptance Criteria\n   122\t=== WP-CS-007: Salesforce Configuration\n   123\t==== Description\n   124\t==== Deliverables\n   125\t==== Dependencies\n   126\t==== Skills Required\n   127\t==== Acceptance Criteria\n   128\t=== WP-CS-008: Contact Data Migration\n   129\t==== Description\n   130\t==== Deliverables\n   131\t==== Dependencies\n   132\t==== Skills Required\n   133\t==== Acceptance Criteria\n   134\t=== WP-CS-009: Production Deployment\n   135\t==== Description\n   136\t==== Deliverables\n   137\t==== Dependencies\n   138\t==== Skills Required\n   139\t==== Acceptance Criteria\n   140\t=== WP-CS-010: Post-Cutover Support\n   141\t==== Description\n   142\t==== Deliverables\n   143\t==== Dependencies\n   144\t==== Skills Required\n   145\t==== Acceptance Criteria\n   146\t=== Work Package Sequencing\n   147\t==== Parallel Track 1: Infrastructure & Configuration\n   148\t==== Parallel Track 2: Development\n   149\t==== Sequential Track 3: Integration & Testing\n   150\t==== Sequential Track 4: Migration & Cutover\n   151\t==== Critical Path\n   152\t== Transition Architecture\n   153\t=== Transition Approach\n   154\t=== Transition States\n   155\t==== TS-0: Baseline State (Current)\n   156\t===== Characteristics\n   157\t===== Components Active\n   158\t==== TS-1: Build & Test\n   159\t===== Activities\n   160\t===== Components Active\n   161\t===== Exit Criteria\n   162\t==== TS-2: Contact Migration\n   163\t===== Activities\n   164\t===== Components Active\n   165\t===== Exit Criteria\n   166\t==== TS-3: Cutover (Go-Live)\n   167\t===== Go-Live Activities\n   168\t===== Components Active\n   169\t===== Exit Criteria\n   170\t==== TS-4: Target State (Stable Production)\n   171\t===== Characteristics\n   172\t===== Monitoring Period\n   173\t===== D365 CE Retirement\n   174\t===== Components Active\n   175\t===== Success Criteria Achieved\n   176\t=== Transition Dependencies\n   177\t=== Transition Validation Criteria\n   178\t==== Contact Migration Validation\n   179\t==== Cutover Validation\n   180\t==== Production Monitoring (30 days)\n   181\t=== Rollback Plan\n   182\t==== Rollback Triggers\n   183\t==== Rollback Procedure\n   184\t==== Rollback Limitations\n   185\t=== Architectural Scope Boundaries\n   186\t==== Capabilities Included\n   187\t===== Business Capabilities\n   188\t===== Technical Capabilities\n   189\t==== Capabilities Excluded\n   190\t===== Business Capabilities Explicitly Out of Scope\n   191\t===== Technical Capabilities Explicitly Out of Scope\n   192\t===== Future Bounded Contexts Not in Scope\n   193\t===== Integration Patterns Not in Scope\n   194\t==== Architectural Dependencies on Future Initiatives\n   195\t=== Technical Risks and Mitigation\n   196\t== Assumptions and Constraints\n   197\t=== Assumptions\n   198\t=== Constraints\n   199\t== Non-Functional Requirements\n   200\t=== Performance Requirements\n   201\t=== Availability Requirements\n   202\t=== Scalability Requirements\n   203\t=== Security Requirements\n   204\t=== Reliability Requirements\n   205\t=== Maintainability Requirements\n   206\t=== Usability Requirements\n   207\t=== Compliance Requirements\n   208\t== Monitoring and Observability\n   209\t=== Key Metrics\n   210\t=== Alerting Thresholds\n   211\t=== Dashboards\n   212\t== Solution Validation\n   213\t=== Functional Validation\n   214\t==== ProfileService API Testing\n   215\t==== EngagementService API Testing\n   216\t=== Non-Functional Validation\n   217\t==== Performance Testing\n   218\t==== Resilience Testing\n   219\t==== Security Validation\n   220\t=== Integration Validation\n   221\t==== End-to-End Testing","stderr":"","interrupted":false,"isImage":false},"sourceToolAssistantUUID":"23c29979-1e5f-4e53-aafd-a2c0dc482b4c"}
{"parentUuid":"7c946703-efb5-454f-9e45-d7327d4c927a","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01FXVzf4D2LQXRRzQPTX147e","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now let me compare the two structures. They have significant differences:\n\n**Common sections (in similar order):**\n1. Title\n2. Purpose and Scope\n3. Executive Summary (but different positions and subsections)\n4. Solution Approach\n5. Solution Building Blocks\n6. Data Architecture\n7. Interface Specifications\n8. Gap Analysis (but in different positions)\n9. Work Packages\n10. Transition Architecture\n11. Solution Validation\n\n**Differences:**\n\n**Flybuys Integration:**\n- Executive Summary comes early (line 9)\n- Key Technology Decisions section (line 16)\n- Implementation Constraints / Success Criteria under Key Technology Decisions\n- Data Architecture after SBBs (line 57)\n- Interface Specifications after Data Architecture (line 80)\n- Gap Analysis after Interface Specifications (line 121)\n- Work Packages after Gap Analysis (line 127)\n- Transition Architecture after Work Packages (line 195)\n- NO separate Technical Requirements section\n- NO separate Technical Architecture section\n- NO Architecture Decisions section (ADRs)\n- NO Assumptions and Constraints section\n- NO Non-Functional Requirements section\n- NO Monitoring and Observability section\n\n**Salesforce Customer Support:**\n- Has Vision and Architectural Approach under Purpose and Scope\n- Has Architecture Overview with Key Architectural Patterns\n- Executive Summary comes later (line 19) with more structured subsections\n- Has Technical Requirements section (line 29)\n- Has Technical Architecture section (line 30) with detailed catalogues\n- Data Architecture comes after SBBs (line 41)\n- Has Baseline Architecture (line 49)\n- Gap Analysis integrated into Technical Architecture/Data Architecture (line 53)\n- Has dedicated Architecture Decisions section with ADRs (line 65)\n- Interface Specifications after Architecture Decisions (line 73)\n- Work Packages after Interface Specifications (line 84)\n- Transition Architecture after Work Packages (line 152)\n- Has Assumptions and Constraints section (line 196)\n\n\n- Has Non-Functional Requirements section (line 199)\n- Has Monitoring and Observability section (line 208)\n\nThe Salesforce document is more thorough and aligns better with TOGAF Phase E standards, while Flybuys lacks critical sections like NFRs, monitoring guidance, and formal ADRs. I should work toward a unified structure that incorporates the best elements from both.","signature":"EqgTCkYICxgCKkDmBv0f8EdhtoFRgiciN1Zk453TX5AgWEeyDXMc3u4AnUc1pzIPhZm7sZgGnIvL5jEEPqePnU7jrw+Y8HfglOXkEgwmxMVzTMUfgVYi2bAaDFCdxftGqcK3w55+7yIwPLsdY7dLxr7IUK0w4wJWH8P3Kg7hG/+Z2800rrAenWN8pR22kJupnJefsuRJjnMcKo8SHKQR05PRhtvzBZJdmK6tCzxJ6CIUT9fmJ5OFS1YQnFnugEtaRYXT54p5WrdjNpwNe6a5edEnrtMU0ZeMVd+LtIrJpXZqULenN5ziHKu0EPEc/f9H1Y8dg5tbjtG4UIM1hFCuPX8sIKvGc2rTSuoHN1Qa7hboLFB/4fMT0cSM3rRlI115qwPazzkGWMfc/HX0U0ieqDGS/vc3D6wjTMVJeiH3kpgguaOcaQYFF37HJrrMXaj6YmfxRi6PR9gaOpGEbegwm5qAq8MpproHBjptzy74hb43k8O+igPNwi8ACVy53Z/nMHlogxtqO4wx0y9wcUQiO3wVeWvPQIel2zoRmQGE03O3Ib5mzjVub7iISJ935WBPAM5pR81i6He9Py7e0o6JEKp68otBHgjRNgK2F7REyWXhdkKme6STqIjhikxFCf0K+QP3dOJEIwdoh50hzgSTbzEK48aeO7H2rzDi3tuOqphp64mD3lT0yut9tGwqIowztGP8WCaX0S9qErRXGB7MCFenh7JpBra6gR4DKBOinofzVrf7yzSkBZ7sCCFIlcN4kt8C57pYvW0Ag74LR+NtFYVUsYTa3J0577mPQoA34Ffh3Lr+jn02x0YpYDDrBumaHj3qsnPJg6sbie5cIr1e6BRhF3VKy0HcwHNBX4HNhBL3jCplYJ3izz8+pOAx8uelRgHAX9oqhgr+6l2PZH0YaF8zPuNBuTMGAYJl7nEywmlt6YuPIdDf/VkDbi6nHkUWsBoQb99/JOr5yOFCbP5jU/RCheivyBMFnkDnRIJdYxsI4V9woHb17sDU2tvC5pSx5PRqRddqKlonpnXuL5jij174NUG9sxv6s9gRiOVkNREg67J6ZIwVCIbyg9AJh2fChPLd6QKQWLRHK3Bn22j69e/r+4Tac/wB+qi45L+g/D5w8zm6WcQQmagtpNGOqYW+wOPnjxCOAj/JfIWJWe4Fn+JvcUD9IyZFOWvbs+gOBtB3cdrraBeSOa0rxUgR+q+XyLgK9L9qTqzbPRiyuTbq5skAkwoPnXKgA/9wbGwqqlaU75X9pVQs3AUUqzLIfHwhrD9xscuozB9mRVD4If/FdcJFCMtAgBg36ywpO/BtxWKX7l+kFB+Qcjvp8KoziNHp5QpGCWgoogvVm1PCqhzufgaQgkXcAdJxEBKmNTD/4WWMbjzm/sTruR1FdeUAYRY/Vw5LNbm8P3Zhq7xOVm9nLnSF8aQmHtlZ+Zs7jFRdwGSTKtWmZuwAnhf0b3pRPenBQGf4UydE60wc7C8BanU/NSv+hZqG8+GBxc8eqUBfN7fFgTVa25aSWTtrT5Snw57DU3eXrjJoH3mPxulqK7QSgiM+7u1DLE+/oPh3KZFHDzZK68V1/l1l8L4DJ1LveAQJJjeR5QaNaOTSB61XGUtBuxl9QNbvCRRdPJuZbQ5lAmRDKRUzJ5iA5LoYdbxodHEEml9Hd+ovsfkZoglbooWTi/Z5LfJyh4D8i+5FaRQP0pbCj6ytGk1AcJVNFiHqhRVDJmUWs9nG3FQOx8GrTtUZdEYciEZNS7LwtckU24YkwSSiZanj2LcD5ZK2IAcbfvPn4A/T9N/854+tEALSo8aKg/TDZ5delcm7nKtukPMgf+e18T+xV7pkda+H/fEQ8GgvUC5FAXLrt3qyzBCJceqqYLuS58g3AmiEbm0F7aZ4UzrDwdFsRegDBOlqNVfvSW6JTgIdEIK1SXF+9uzB9X6TUjBMydqWpF/3h8JVuiiBep+hTVKHvI+/3CMTF4T5LU9YJGy44remTAyIWU9AmViXd3ccf2eF5hKzTMXv7BMrf9RlAblUOLFFcdq+VNMhB/CYFmkXVjN6vqJ5vi3twUGZdJRbzYC6QH0FG6qEgjWvCswDdf1IubzS0dov1txLXgQPp/q6zEh/8grOnTazq2TeWg1sxZxD0B0nxkh5Un3PchBWp0+sKZcHUMVpt1NL+zLPxZ2cCpH6ii4LNGq0ldPEo6WW3j8Emh2+cpd3YeJ+PPHSi/NJ2/nW0yrzEnkGObZkS4HqxJhE2rrSYBQ40lZGKLZecPiEnpUu1YrcP2VZ0gsDLB0SoeX0gp1TYAzqi2vZwqQbfv/jVLN9hHUDiU05nZR1kHX9DFzv2mkZVIs51j7HBYfkeaRr0XwVxno2WneRth1k4Rb8AZxWqTU2dkMx+0hfftf+eMvuCjv8mJbQo6OotcE/LvrpxQZjjKg8pQTaLMmd5p5XPSdfQyv+YB2G2TOdy6E/IwC67ETeoE1zaU/mHyCIKy7R8iX8hkF885bffBc1noS9nBoBZwsYlNtFnS81bndPSt//UfAfPqMELlyDH0V2dgGDIbZNLNf0f0nTSb+8KXAZonIUh9KPxuu7BXSxuVdlgdAzO5FFqtgSTKwbvVJlVw1ObZhypLkL3Tcqt0S+V9wdBVXzG+zZHb3y7msV3ZfSg3LquiCV8JxbeB8a1MZDjpgBGLJl0S29Z6lD2RhzV48SKi0XAJF1lTtqoVaVzNWTsJw96PQul9nOdebCwnTG2Eg8GkmT19nD0s74LDKRsGHES+GFK81CZvlZ6yH/d3dZMZAgwVVXnsxf83xcMam5fdG75/D1fhrqZk+L9tWPNIZ4Q64YmrLZVo0RIor4q0fc5Gl/Cn0h0YlZi/UxuKSQBNX9Ldi1VwnpW9NyBZDCbbNxdTxbAyj0yyo02S+m8JcPF4mQ7LpHIHjhDcpHcCEd5Az6rxgvyTuNOVEQytqRaFnHg645CzKcTHG4y5eeh3S39um+SPVzVTXCcXuNaCHGoEEAG8hAw+K9qrJWxp9P+SiU8TFsEZX56kSBiUqDjHCZkW6x+j/WMlzSb6zhBiPWsT0VeHN7SV9MVz/j6YeIsQQZ966fKL+Em3aBn2JSYzcKtl5ofMg93xPKIw/fgaff5vVScp7/gLro+5i3+fLRJ0N8JSCrXH6Gf23FkaBHfgWj4FzkA9eXpd1qdY2ZWwaDP3W8YvFqaGeKO7cLE0RcOM6stEIdu96hUxBAqz2qNEQ9LQGhjcATHxGPM/fklcoh4YI095U8QoxeO2fWTJAxtGfl6MlmpA3QOY+WFeIR3XGkQ2kBdE5CGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":14,"cache_creation_input_tokens":5845,"cache_read_input_tokens":91490,"cache_creation":{"ephemeral_5m_input_tokens":5845,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWwCu9GQptYmQxwwVbcrN","type":"assistant","uuid":"dc31c5b0-3cca-44cc-870e-1a0191a05386","timestamp":"2026-01-09T04:53:39.278Z"}
{"parentUuid":"dc31c5b0-3cca-44cc-870e-1a0191a05386","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01FXVzf4D2LQXRRzQPTX147e","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01PuPGXmEnbCgZ9wiXYeLbYs","name":"TodoWrite","input":{"todos":[{"content":"Compare section structure of both solution architectures","activeForm":"Comparing solution architecture structures","status":"completed"},{"content":"Document inconsistencies between the two documents","activeForm":"Documenting structural inconsistencies","status":"in_progress"}]}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":14,"cache_creation_input_tokens":5845,"cache_read_input_tokens":91490,"cache_creation":{"ephemeral_5m_input_tokens":5845,"ephemeral_1h_input_tokens":0},"output_tokens":669,"service_tier":"standard"}},"requestId":"req_011CWwCu9GQptYmQxwwVbcrN","type":"assistant","uuid":"09ef5631-602e-4d07-bc8f-809a575f60ca","timestamp":"2026-01-09T04:53:40.375Z"}
{"parentUuid":"09ef5631-602e-4d07-bc8f-809a575f60ca","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01PuPGXmEnbCgZ9wiXYeLbYs","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"uuid":"c27731b5-a937-45fd-b09e-103001ff8b55","timestamp":"2026-01-09T04:53:40.458Z","toolUseResult":{"oldTodos":[],"newTodos":[{"content":"Compare section structure of both solution architectures","status":"completed","activeForm":"Comparing solution architecture structures"},{"content":"Document inconsistencies between the two documents","status":"in_progress","activeForm":"Documenting structural inconsistencies"}]},"sourceToolAssistantUUID":"09ef5631-602e-4d07-bc8f-809a575f60ca"}
{"parentUuid":"c27731b5-a937-45fd-b09e-103001ff8b55","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01GsSqmTLz2JpDnp4VKzQFQm","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Let me create a comparison table showing the differences.","signature":"EuEBCkYICxgCKkDwEeIIN5VTVk/i4Ch3HiX4L0hacrMdoPZpNzWfj3oDgRqxIdgS5L0Fb2bS1KaHsx2pAz/ZdejNSjmf4fhr5iAOEgzcoPDt1WSZ/2x7CXkaDKxAiXY0FVSxycMDCyIwKCvbcWqNnhEz+yctolgG/Y3Isz/WAK6ZQSHouEWdlcDmIldBIqI+w0JfNvKnQQnkKkloWe39Q1NoW/tBe+OXI4W7AvtW3bRoqzbCI4kub/1V1d0ACAXmmAq9E2U4x1zFpnHI5OYpsrl6mk3r3Ea35Q97B7BL10hIjgNoGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":706,"cache_read_input_tokens":97335,"cache_creation":{"ephemeral_5m_input_tokens":706,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWwCvPBr3vyzp3Gpk7dZY","type":"assistant","uuid":"25b8733d-27fb-4460-840f-0162962bb87a","timestamp":"2026-01-09T04:53:44.753Z"}
{"parentUuid":"25b8733d-27fb-4460-840f-0162962bb87a","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01GsSqmTLz2JpDnp4VKzQFQm","type":"message","role":"assistant","content":[{"type":"text","text":"No, the structures are **significantly inconsistent**. Here's a detailed comparison:\n\n## Structural Comparison\n\n### Common Sections (Both Documents)\n\n| Section | Flybuys Position | Salesforce Position | Consistent? |\n|---------|------------------|---------------------|-------------|\n| Purpose and Scope | Lines 2-8 | Lines 2-12 | ✅ (but different subsections) |\n| Executive Summary | Line 9 | Line 19 | ⚠️ (different position) |\n| Solution Approach | Line 10 | Line 13 | ✅ |\n| Solution Building Blocks | Line 19 | Line 39 | ✅ |\n| Data Architecture | Line 57 | Line 41 | ✅ (similar position) |\n| Interface Specifications | Line 80 | Line 73 | ✅ |\n| Work Packages | Line 127 | Line 84 | ✅ |\n| Transition Architecture | Line 195 | Line 152 | ✅ |\n| Solution Validation | Line 242 | Line 212 | ✅ |\n\n### Sections Only in Salesforce (Missing from Flybuys)\n\n| Section | Why Important |\n|---------|---------------|\n| **Vision** (line 4) | Strategic context for the solution |\n| **Architectural Approach** (line 5) | High-level design philosophy |\n| **Architecture Overview** (line 11) | Summary of key patterns |\n| **Technical Requirements** (line 29) | Explicit functional/non-functional requirements |\n| **Technical Architecture** (line 30) | Detailed catalogues and traceability |\n| **Baseline Architecture** (line 49) | Current state analysis |\n| **Gap Analysis** (line 53) | Structured gap identification |\n| **Architecture Decisions (ADRs)** (line 65) | Formal decision log with rationale |\n| **Assumptions and Constraints** (line 196) | Project constraints documentation |\n| **Non-Functional Requirements** (line 199) | Performance, security, scalability specs |\n| **Monitoring and Observability** (line 208) | Operational readiness |\n\n### Sections Only in Flybuys (Missing from Salesforce)\n\n| Section | Notes |\n|---------|-------|\n| **Key Technology Decisions** (line 16) | Less formal than Salesforce ADRs |\n| **Physical Data Models** (line 58) | More detailed JSON schemas |\n| **Complete API Documentation** (line 81) | More detailed API specs |\n| **Correlation ID Propagation** (line 102) | Good operational detail |\n| **SBB Dependency Flowchart** (line 247) | Excellent dependency visualization |\n\n## Key Inconsistencies\n\n### 1. **Executive Summary Position**\n- **Flybuys**: Line 9 (early, brief)\n- **Salesforce**: Line 19 (after overview, more structured with Challenge/Solution/Significance)\n\n### 2. **Architecture Decisions**\n- **Flybuys**: Scattered, informal \"Key Technology Decisions\"\n- **Salesforce**: Formal ADR section with ADR-CS-001 through ADR-CS-007\n\n### 3. **Requirements**\n- **Flybuys**: No explicit Technical Requirements section\n- **Salesforce**: Dedicated Technical Requirements section with traceability\n\n### 4. **Non-Functional Requirements**\n- **Flybuys**: Embedded in \"Success Criteria\" and \"Non-Functional Validation\"\n- **Salesforce**: Dedicated section with 8 categories (Performance, Availability, Scalability, Security, Reliability, Maintainability, Usability, Compliance)\n\n### 5. **Gap Analysis**\n- **Flybuys**: After Interface Specifications (line 121)\n- **Salesforce**: Integrated into Technical Architecture (line 53)\n\n### 6. **Baseline Architecture**\n- **Flybuys**: Covered in Transition Architecture > TS-0\n- **Salesforce**: Dedicated \"Baseline Architecture\" section before Gap Analysis\n\n## Recommendation\n\nThe **Salesforce structure is more comprehensive and TOGAF-aligned**. I recommend:\n\n1. **Standardize on Salesforce structure** as the template\n2. **Add missing sections to Flybuys**:\n   - Vision and Architectural Approach\n   - Technical Requirements\n   - Baseline Architecture (promote TS-0 content)\n   - Architecture Decisions (convert to ADRs)\n   - Assumptions and Constraints\n   - Non-Functional Requirements\n   - Monitoring and Observability\n\n3. **Preserve Flybuys strengths**:\n   - Detailed Physical Data Models (JSON schemas)\n   - Complete API Documentation detail\n   - Correlation ID Propagation specification\n   - SBB Dependency Flowchart\n\nWould you like me to restructure the Flybuys solution architecture to match the Salesforce format?"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":706,"cache_read_input_tokens":97335,"cache_creation":{"ephemeral_5m_input_tokens":706,"ephemeral_1h_input_tokens":0},"output_tokens":1194,"service_tier":"standard"}},"requestId":"req_011CWwCvPBr3vyzp3Gpk7dZY","type":"assistant","uuid":"a8534e43-665b-428e-a0e2-892bb3bb8ec0","timestamp":"2026-01-09T04:54:02.835Z"}
{"parentUuid":"a8534e43-665b-428e-a0e2-892bb3bb8ec0","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"system","subtype":"turn_duration","durationMs":53871,"timestamp":"2026-01-09T04:54:04.049Z","uuid":"52268ae2-b3f2-4138-a514-e50638ed7b83","isMeta":false}
{"type":"file-history-snapshot","messageId":"17466293-a3f0-405d-80e7-c943bd90da7c","snapshot":{"messageId":"17466293-a3f0-405d-80e7-c943bd90da7c","trackedFileBackups":{"solution_architectures/salesforce_customer_support.adoc":{"backupFileName":"ef19bf3282a777f7@v2","version":2,"backupTime":"2026-01-09T03:13:31.966Z"},"bounded_context/profile.adoc":{"backupFileName":"5794d0bd8cc1c5d2@v2","version":2,"backupTime":"2026-01-09T04:53:10.175Z"},"bounded_context/profile.cml":{"backupFileName":"082a4df2066ba3ba@v2","version":2,"backupTime":"2026-01-09T04:53:10.187Z"}},"timestamp":"2026-01-09T04:56:21.635Z"},"isSnapshotUpdate":false}
{"parentUuid":"52268ae2-b3f2-4138-a514-e50638ed7b83","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":"Yep"},"uuid":"17466293-a3f0-405d-80e7-c943bd90da7c","timestamp":"2026-01-09T04:56:21.616Z","thinkingMetadata":{"level":"high","disabled":false,"triggers":[]},"todos":[{"content":"Compare section structure of both solution architectures","status":"completed","activeForm":"Comparing solution architecture structures"},{"content":"Document inconsistencies between the two documents","status":"in_progress","activeForm":"Documenting structural inconsistencies"}]}
{"parentUuid":"17466293-a3f0-405d-80e7-c943bd90da7c","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01DyUGT5RUeqnuezGgRVyPvS","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"The user wants me to restructure the Flybuys solution architecture document to match the more comprehensive Salesforce format. This is a significant task that will involve:\n\n1. Reading the full Flybuys document\n2. Reorganizing sections to match Salesforce structure\n3. Adding missing sections (Vision, Architectural Approach, Technical Requirements, Baseline Architecture, formal ADRs, Assumptions and Constraints, Non-Functional Requirements, Monitoring and Observability)\n4. Preserving Flybuys strengths (detailed schemas, API docs, correlation ID spec, dependency flowchart)\n5. Ensuring TOGAF alignment\n\nThis is a large refactoring task. I should use the TodoWrite tool to track progress and work through it systematically.\n\nLet me create a plan:\n1. Create a backup/read the current Flybuys document\n2. Create the new structure outline\n3. Move/reorganize existing content\n4. Add missing sections\n5. Ensure consistency\n6. Commit changes\n\nThis will be a significant file operation, so I should be careful and methodical.","signature":"EpwJCkYICxgCKkBHww1WFwinyx15xkhxVnLzbqvSxBNdyPc3/44OXTkb6TD7aQpTl8Ps5n+XY6KwGqEivOj1fJug4ZBJgFrYzuGbEgyG6EcwMTVs/kzfwWYaDBR/tqxCkRtysCVbcyIwIzuOV1SRElIARTXHrS6eXwZgQ0U9Psi3GMQ6+jyHfg1fGgGH2q9gcTEm7IImNBjUKoMI5J6c0OnAdvikRJAdGQKJLJeEJdc7wQt34OHJ2Pk92O8ger5vde7HxRcffsOmFl+hsxo0kIdOVk6iivFaXvMXRX1AXi5NlxwKSEmjMpCJ7Ti6j/BIOE9uR7tv8OyUB04CF/7uKRmfV/hxh+OiLqaO0hPkaIUjhFNWKPD8HoYxk/cOIow234C3XQ+nNEw1nkNBC66UTqzTJrjgz5kDutlQ6h2ZB0oVOjUefP7ayRMkV0IsMNeZSqY9wyx5mPr7Q5EoOUxDa7uCMnjDFZ3gvTOebO9wspZ7jw0+FwYFU378RMrsC3RLy/OIL33EgiYfoiq+FFUmjHFKONRuphFI6pKXSE+oM9zFkscDvqWHS04CIxkVkCNstdup7u9ksSWGXisiMMcaFigZdbKk9zykgf7O8otlb/V5ikhpFKJUP2bL8eB2U0gzO/ZCQtvNUR/AaO/5aSsffdOM7UU5wwe+Xj06Wx36N2s47sYbXrIm/swjLiPR79pwOy6MbRYpgPYoev7g564JcoDO9c4N659xPIKL30zvFSADLNcKXkavH4LrHIUPP+AZbnbw8iQeiZyq2gCz+ghUdKv03MPh+n4XBbcvogFj0EARyCcQ3IHzcE1XVQf1RyNr1GiHiFyB3BuaTQau8K134IakhLhlOuV6DbnS4YJub8yrRYQhCDcGHhWCvJuvHvZ1vVrRM4tcPSFa7oRaA3GY3Ge0XgsI23ses6BChzpkv0SiI3JePaOCq7FaFweAoghraFDNT7TKFQsqj+LjGll6H6wU4XCPB75b/WskG7uxFa9M5k8INLv3z+51NPu0qUEkSbpcbtnz4X7f4FngIFPNutPpCV/Py/x4QwVVtZwZMu4+FZ5JD8UILfrE6T7IF/Ifr1SMlc0yM/dphe4irqlpPcS1JBr4Jp8ahRmBAsuhjJ0+YiB8p85MMjr2fYIZGc2CpQT7uYWNyZG718WNAL1LFUMwsby3i94063QAH8LzDHW0bdAYGFBLBM5jJIpuAxaULm76jsouxw4F6529Idwu0rE2cjCYWaGn05896eFWvuwqkP9oosRcCYWnCEBAxDeOrq1fRJ2nfxI8Wgk4C0/XbzCmRBjLL7VRUa4lJfOZLIf9699+nbFetmfF9ZqEEnxtM/LOSYIKX7dCs4UHpyZhTBw+ceQJD9P208vjiDgDaRDdG1wEzofVl4yujcE6sEBtDD5lzK5iTKljgrL7MnRxK2Cr8tfy2ZjKt4V7KZFyWkIxofUu2H5d6oouyWti8DSMrewiRL58LkrF9ndcnnuCK6ixnWkLnTYuhgp+iQ/dedlXGxLCGWslwyKlJtd1N+yT77fZYOBn64w9m0TRQbaJxmtGZUFdccf0P1aPPpEluxgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":7687,"cache_read_input_tokens":90862,"cache_creation":{"ephemeral_5m_input_tokens":7687,"ephemeral_1h_input_tokens":0},"output_tokens":8,"service_tier":"standard"}},"requestId":"req_011CWwD8G6XwhLwohG4YXkxX","type":"assistant","uuid":"51eeeba6-049e-4525-9bd9-e20e2e9254fe","timestamp":"2026-01-09T04:56:29.368Z"}
{"parentUuid":"51eeeba6-049e-4525-9bd9-e20e2e9254fe","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01DyUGT5RUeqnuezGgRVyPvS","type":"message","role":"assistant","content":[{"type":"text","text":"I'll restructure the Flybuys solution architecture to match the more comprehensive Salesforce format. This is a significant refactoring, so let me work through it systematically."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":7687,"cache_read_input_tokens":90862,"cache_creation":{"ephemeral_5m_input_tokens":7687,"ephemeral_1h_input_tokens":0},"output_tokens":8,"service_tier":"standard"}},"requestId":"req_011CWwD8G6XwhLwohG4YXkxX","type":"assistant","uuid":"2171a145-217f-4135-9591-80aef03cfe0e","timestamp":"2026-01-09T04:56:30.016Z"}
{"parentUuid":"2171a145-217f-4135-9591-80aef03cfe0e","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01DyUGT5RUeqnuezGgRVyPvS","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01W6dqhwiHVjXMkCynqwamwV","name":"TodoWrite","input":{"todos":[{"content":"Read and analyze current Flybuys solution architecture","activeForm":"Reading Flybuys document","status":"in_progress"},{"content":"Create new structure outline based on Salesforce template","activeForm":"Creating structure outline","status":"pending"},{"content":"Add Vision and Architectural Approach sections","activeForm":"Adding vision and approach","status":"pending"},{"content":"Extract and restructure Executive Summary","activeForm":"Restructuring executive summary","status":"pending"},{"content":"Add Technical Requirements section","activeForm":"Adding technical requirements","status":"pending"},{"content":"Create Baseline Architecture section from TS-0","activeForm":"Creating baseline architecture","status":"pending"},{"content":"Convert Key Technology Decisions to formal ADRs","activeForm":"Converting to ADRs","status":"pending"},{"content":"Add Assumptions and Constraints section","activeForm":"Adding assumptions and constraints","status":"pending"},{"content":"Add Non-Functional Requirements section","activeForm":"Adding NFRs","status":"pending"},{"content":"Add Monitoring and Observability section","activeForm":"Adding monitoring section","status":"pending"},{"content":"Verify all content preserved and reorganized","activeForm":"Verifying content preservation","status":"pending"},{"content":"Test document structure and cross-references","activeForm":"Testing document","status":"pending"}]}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":7687,"cache_read_input_tokens":90862,"cache_creation":{"ephemeral_5m_input_tokens":7687,"ephemeral_1h_input_tokens":0},"output_tokens":715,"service_tier":"standard"}},"requestId":"req_011CWwD8G6XwhLwohG4YXkxX","type":"assistant","uuid":"218dc5ad-3b71-400e-be44-8e39670fa83f","timestamp":"2026-01-09T04:56:34.587Z"}
{"parentUuid":"218dc5ad-3b71-400e-be44-8e39670fa83f","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01W6dqhwiHVjXMkCynqwamwV","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"uuid":"81c58c31-e5b7-48e4-bb3d-eae0df88f0d7","timestamp":"2026-01-09T04:56:34.664Z","toolUseResult":{"oldTodos":[{"content":"Compare section structure of both solution architectures","status":"completed","activeForm":"Comparing solution architecture structures"},{"content":"Document inconsistencies between the two documents","status":"in_progress","activeForm":"Documenting structural inconsistencies"}],"newTodos":[{"content":"Read and analyze current Flybuys solution architecture","status":"in_progress","activeForm":"Reading Flybuys document"},{"content":"Create new structure outline based on Salesforce template","status":"pending","activeForm":"Creating structure outline"},{"content":"Add Vision and Architectural Approach sections","status":"pending","activeForm":"Adding vision and approach"},{"content":"Extract and restructure Executive Summary","status":"pending","activeForm":"Restructuring executive summary"},{"content":"Add Technical Requirements section","status":"pending","activeForm":"Adding technical requirements"},{"content":"Create Baseline Architecture section from TS-0","status":"pending","activeForm":"Creating baseline architecture"},{"content":"Convert Key Technology Decisions to formal ADRs","status":"pending","activeForm":"Converting to ADRs"},{"content":"Add Assumptions and Constraints section","status":"pending","activeForm":"Adding assumptions and constraints"},{"content":"Add Non-Functional Requirements section","status":"pending","activeForm":"Adding NFRs"},{"content":"Add Monitoring and Observability section","status":"pending","activeForm":"Adding monitoring section"},{"content":"Verify all content preserved and reorganized","status":"pending","activeForm":"Verifying content preservation"},{"content":"Test document structure and cross-references","status":"pending","activeForm":"Testing document"}]},"sourceToolAssistantUUID":"218dc5ad-3b71-400e-be44-8e39670fa83f"}
{"parentUuid":"81c58c31-e5b7-48e4-bb3d-eae0df88f0d7","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_012eWFGtczUJey6Lf2ugwpH3","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"This is a very large file that I need to read and restructure. Let me read it in sections to understand the content, then work on restructuring it. The file is likely too large to read all at once, so I'll use grep and read strategically.","signature":"EpcDCkYICxgCKkBeroT62oBXyU8HhcssYZbdMlOpf2MwGU+RgSjZyxaMvAn84b7wlQRFQLq4tWO5D97BRfii2gi6lbrP6sgW3tFqEgwGwp2WU3pdJzoUAs4aDP4Kmp+8Ly/eOU842CIwSFM+/3Bc7wCHhY3NZc6jsQDQjJIZk7G15aHhZzJBfjkPvrLK6Ui5zQOiJuuroWzeKv4Bw3qFU5+BCddxh6LaupXXkM+WdLT8Bv4kOXgemKLoDpIKJq25OYlD5gkqQSFTZN1+ahEBp4IU4owplF9nO1uHSPYxblbhXslriKv0KBSvJaQVfZzwip/BkDqmdH78neeDCJFtqGdMrRC91GhGmoShy/ZpWA5EtOrxU7DRyblszZLgaCi1T684OWjT6zp4pfGpd98QyHz5SCWBUJeVjyUrnwupRZzj/XtX6P1qFjUepa/4+8i2uATyhOOkV2vWYErh0Uj2oJh2gbrmY2OdWGTXoErgyaKigW/zwYdzzJn9N3ND8jkkVYu+7kd6izx6zAU/OF4U6DVLdyrUqiwN1NsYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":742,"cache_read_input_tokens":98549,"cache_creation":{"ephemeral_5m_input_tokens":742,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWwD9E8zP3mgHovyHmF7C","type":"assistant","uuid":"3d03c0d2-371d-401c-9ea2-8bada70158f8","timestamp":"2026-01-09T04:56:40.199Z"}
{"parentUuid":"3d03c0d2-371d-401c-9ea2-8bada70158f8","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_012eWFGtczUJey6Lf2ugwpH3","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_011qazJfTBiUXbmnB3sNPA7Z","name":"Bash","input":{"command":"wc -l solution_architectures/flybuys_integration.adoc","description":"Check line count of Flybuys doc"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":742,"cache_read_input_tokens":98549,"cache_creation":{"ephemeral_5m_input_tokens":742,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWwD9E8zP3mgHovyHmF7C","type":"assistant","uuid":"9d7fa3d8-48b4-4752-b63f-fee882dc9621","timestamp":"2026-01-09T04:56:41.245Z"}
{"parentUuid":"9d7fa3d8-48b4-4752-b63f-fee882dc9621","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_012eWFGtczUJey6Lf2ugwpH3","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01281yNhQr5jGSDdK3FeLDSt","name":"Bash","input":{"command":"wc -l solution_architectures/salesforce_customer_support.adoc","description":"Check line count of Salesforce doc"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":742,"cache_read_input_tokens":98549,"cache_creation":{"ephemeral_5m_input_tokens":742,"ephemeral_1h_input_tokens":0},"output_tokens":232,"service_tier":"standard"}},"requestId":"req_011CWwD9E8zP3mgHovyHmF7C","type":"assistant","uuid":"c4cbe1e1-de9d-42b5-9a67-f23cbc9d4347","timestamp":"2026-01-09T04:56:41.718Z"}
{"parentUuid":"9d7fa3d8-48b4-4752-b63f-fee882dc9621","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_011qazJfTBiUXbmnB3sNPA7Z","type":"tool_result","content":"5276 solution_architectures/flybuys_integration.adoc","is_error":false}]},"uuid":"a19d5c4e-a4e9-473d-b7d6-348f2b9e744a","timestamp":"2026-01-09T04:56:42.021Z","toolUseResult":{"stdout":"5276 solution_architectures/flybuys_integration.adoc","stderr":"","interrupted":false,"isImage":false},"sourceToolAssistantUUID":"9d7fa3d8-48b4-4752-b63f-fee882dc9621"}
{"parentUuid":"c4cbe1e1-de9d-42b5-9a67-f23cbc9d4347","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01281yNhQr5jGSDdK3FeLDSt","type":"tool_result","content":"3328 solution_architectures/salesforce_customer_support.adoc","is_error":false}]},"uuid":"459ab510-3590-4cab-a4fd-817d9c76f7b2","timestamp":"2026-01-09T04:56:42.038Z","toolUseResult":{"stdout":"3328 solution_architectures/salesforce_customer_support.adoc","stderr":"","interrupted":false,"isImage":false},"sourceToolAssistantUUID":"c4cbe1e1-de9d-42b5-9a67-f23cbc9d4347"}
{"parentUuid":"459ab510-3590-4cab-a4fd-817d9c76f7b2","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01UcErJ7sGG6rrvYFtwHAzTA","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"The Flybuys document is 5276 lines, which is quite large. The Salesforce document is 3328 lines. This is a significant restructuring task. \n\nGiven the size of this task, I should:\n1. Create a new restructured version\n2. Work section by section\n3. Copy and reorganize content methodically\n\nLet me start by reading key sections and then building the new structure. I'll need to be strategic about this to stay within token limits while doing a thorough job.\n\nLet me start with reading the header and key sections to understand what I'm working with.","signature":"EsUFCkYICxgCKkBk4BhkpmY1/nbuSxu7X0/RG+jrdNXOFR15mNfOeHkfPsYJ6lAuuO5FP2SYHo2ABg81SfybeGnwV7tIyDhESLicEgwqntmtdXwsr186vDsaDC2+RFsvrMSMJueF3CIw4q9VWRmU1/84ab1sO2oSTpnWH4F7VFct183mmivxsxilirHCTA7Ptx2yr1jWh6Q+KqwEEmtkVg/uSKBtIEfF48zacBUwDwOdivpTutCAffvCAKLz4VljtNnLT+YJFysOeLL/N5EsSV+rQ15BDoWJ009SpaazEPL8W6ULlXqr2iBNqe1sARzRFH/JEff7QiwF8KGQ1FBMdTsLrveB23ZMjYyfrwTio9JrB2FM1pOiy0mOqYSRMzzkHBcm2dGv0/XaYoaHia69hVUDdwkuEGRsj3IoPdGbEe3GgtrWcQpJ9/0jYgX6j9RGosYibcqaIXn3sn1FAsBgu2OOgjbYEOB+i98W0VKzgWmAcayjPf4vKVymJU/59B4YbwmRtkPFYUuFIyckLcVEY14aI2anzzv9RiLGxyd9hGqcHij6OJuV7g56x+XUIlONLM7prvsf7+paGt13POAqUnlTzuadtHvonXx+VuZN81EYfcVONn+7I3vKtLkPbt+reN+L5RQ8d0kk/Xoqe7TJHPkgB8ryDSA8IMrMPVgTsnoTS8T3Moa8zufmgPr8eoUT1cdXhJRwAd6mfEu/+fOMVegMVXZRiqchTvau3Mpfhjt5vYhN68s25h5vTS+MnTvnanaEH435bpAu2BTiA90/tSbib3OcsCm/ZhiKeqmzWmte9kUbdYoOjeFIcz+j8PgaZ+aJOKvRAI4S463e2ygi3aQiZYWo+e3ix2xLK6xywnkHRsbFk353i4NOga41trK6xxmbJ6XNK7jRejH5uWxlXCFQ5dOHKxjYxIUvSklNU8T4Q2EaJeAv7hgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":14,"cache_creation_input_tokens":332,"cache_read_input_tokens":99291,"cache_creation":{"ephemeral_5m_input_tokens":332,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CWwD9mmmCQH2tCAWg2xng","type":"assistant","uuid":"ed9c4054-a67e-4b58-b019-2e9c4fb4e40a","timestamp":"2026-01-09T04:56:49.713Z"}
{"parentUuid":"ed9c4054-a67e-4b58-b019-2e9c4fb4e40a","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01UcErJ7sGG6rrvYFtwHAzTA","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01DquYEsTrQV5SxJ4zRGwkCM","name":"Read","input":{"file_path":"/mnt/c/Users/o.young/work/architecture/solution_architectures/flybuys_integration.adoc","offset":0,"limit":150}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":14,"cache_creation_input_tokens":332,"cache_read_input_tokens":99291,"cache_creation":{"ephemeral_5m_input_tokens":332,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CWwD9mmmCQH2tCAWg2xng","type":"assistant","uuid":"05cf703b-5039-46f5-874e-312c390444b4","timestamp":"2026-01-09T04:56:50.776Z"}
{"parentUuid":"05cf703b-5039-46f5-874e-312c390444b4","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01DquYEsTrQV5SxJ4zRGwkCM","type":"tool_result","content":"     0→= Flybuys Integration - Solution Architecture\n     1→\n     2→:project-name: Flybuys Integration\n     3→:togaf-adm-phase: Phase E: Opportunities & Solutions\n     4→:document-type: Solution Architecture Document\n     5→:status: Discovery\n     6→:version: 0.1\n     7→:domain: Loyalty\n     8→:programme-lead: Frankie.Mullaly@vivaenergy.com.au\n     9→:domain-architect: O.Young@otr.com.au\n    10→:business-owner: D.Peisley@otr.com.au\n    11→:business-analyst: Fiona.Cheung@vivaenergy.com.au\n    12→:architecture-definition: xref:architecture-definitions:flybuys_integration.adoc[Architecture Definitions/Flybuys Integration]\n    13→:doctype: article\n    14→:toc: left\n    15→:toclevels: 4\n    16→:sectanchors:\n    17→:sectxrefs:\n    18→:sectnums:\n    19→:icons: font\n    20→:source-highlighter: highlightjs\n    21→:experimental:\n    22→:description: Solution Architecture Document for Flybuys Coalition Loyalty Integration\n    23→:keywords: loyalty, flybuys, integration, solution-architecture, togaf\n    24→\n    25→== Purpose and Scope\n    26→\n    27→=== Purpose\n    28→\n    29→This Solution Architecture defines how the Flybuys Integration will be implemented - the specific technology products, configurations, interfaces, and deployment architecture that realise the xref:architecture-definitions:flybuys_integration.adoc[Flybuys Integration].\n    30→\n    31→<<<\n    32→=== Scope\n    33→\n    34→==== In Scope\n    35→\n    36→* Solution Building Blocks (SBBs) - specific technology products and versions\n    37→* Interface specifications (APIs, events, data formats)\n    38→* Data architecture and schema specifications\n    39→* Transition architecture with phased implementation states\n    40→* Technical validation criteria and testing approach\n    41→* External system integration specifications\n    42→\n    43→==== Out of Scope\n    44→\n    45→===== Covered in xref:architecture-definitions:flybuys_integration.adoc[Architecture Definition]\n    46→\n    47→* Business requirements and stakeholder analysis\n    48→* Architecture decisions and rationale\n    49→* Bounded context definitions and responsibilities\n    50→* High-level integration patterns (ACL, Conformist, OHS+PL)\n    51→* Business capability mapping and value streams\n    52→* Non-functional requirements (referenced, not duplicated)\n    53→* Architecture principles and governance\n    54→\n    55→===== Covered in other documents\n    56→\n    57→* Detailed design (class diagrams, sequence diagrams for all flows)\n    58→* Implementation code and unit tests\n    59→* Business case and return-on-investment analysis\n    60→* Operational run books and support procedures\n    61→\n    62→<<<\n    63→== Executive Summary\n    64→\n    65→Integrate xref:bounded-contexts:flybuys.adoc[Flybuys] Coalition Loyalty across all OTRG Digital and In-Person channels without tightly coupling to external partner systems.\n    66→\n    67→Enable xref:ROOT:ubiquitous_language.adoc#customer[Customers] to link their xref:ROOT:ubiquitous_language.adoc#flybuys-digital-identity[Flybuys Digital Identity] with their xref:ROOT:ubiquitous_language.adoc#otr-app[Mobile Application] user profile, and present unified xref:ROOT:ubiquitous_language.adoc#loyalty-credential[Loyalty Credentials] at all xref:bounded-contexts:otr_pos.adoc[OTR POS] and xref:bounded-contexts:otr_plus_pos.adoc[OTR+ POS] stores.\n    68→\n    69→The solution establishes the xref:ROOT:ubiquitous_language.adoc#viva-consumer-id-vci[Viva Consumer ID (VCI)] as *the canonical customer identifier* across all integrated systems, ensuring consistent customer reference throughout the loyalty platform and eliminating identity fragmentation.\n    70→\n    71→<<<\n    72→== Solution Approach\n    73→\n    74→* Deploy xref:bounded-contexts:profile.adoc[Profile Service] and xref:bounded-contexts:loyalty.adoc[Loyalty Service] as bounded context microservices\n    75→* Use NoSQL local document storage with partition key optimisation for caching.\n    76→* Implement **Anti-Corruption Layers** (ACLs) for xref:bounded-contexts:braze.adoc[Braze], xref:bounded-contexts:flybuys.adoc[Flybuys] and xref:bounded-contexts:eagle_eye.adoc[EagleEye] integration\n    77→* Deploy xref:bounded-contexts:oauth.adoc[OAuth Service] with Key Vault token encryption\n    78→* Establish event-driven architecture as the foundational integration pattern for the platform.\n    79→* Phased roll-out (TS-1 → TS-4)\n    80→\n    81→=== Related Documentation\n    82→\n    83→This solution architecture references detailed technical specifications:\n    84→\n    85→==== API Specifications\n    86→\n    87→* `specifications/rest/profile-service-v1.yaml`[Profile Service REST API (OpenAPI 3.0)] - Partner linking, preference management (4 endpoints)\n    88→* `specifications/async_api/otr-event-bus-v1.yaml`[Event Bus (AsyncAPI 2.6.0)] - Domain events, CloudEvents 1.0 format\n    89→\n    90→==== Sequence Diagrams\n    91→\n    92→* Flybuys Integration Flows[Flybuys Integration Flows] - Comprehensive diagrams with happy path + error scenarios:\n    93→** Transaction Adjudication (POS real-time, 4 scenarios)\n    94→** OAuth Partner linking (mobile app, 4 scenarios)\n    95→** Batch File Processing (nightly, 3 scenarios)\n    96→** Circuit Breaker State Transitions\n    97→** Event Propagation Timeline\n    98→** OAuth Token Refresh (proactive + errors, 3 scenarios)\n    99→\n   100→==== JSON Schemas\n   101→\n   102→* specifications[JSON Schemas Directory] - Domain event schemas, request/response models\n   103→\n   104→==== Executive Summary\n   105→\n   106→* xref:ROOT:flybuys_integration.adoc[Executive Summary] - 1-page overview for business stakeholders\n   107→\n   108→<<<\n   109→== Key Technology Decisions\n   110→\n   111→[cols=\"1,2,4,3\"]\n   112→|===\n   113→| ID | Kind | Description | Rationale\n   114→\n   115→| DEC-001\n   116→| Implementation\n   117→| .NET 8.0\n   118→| Aligns with OTR platform standards, team expertise in C#\n   119→\n   120→| DEC-002\n   121→| Hosting\n   122→| #TBD#\n   123→| Autoscaling, managed infrastructure, Docker support\n   124→\n   125→| DEC-003\n   126→| NoSQL Database\n   127→| #TBD#\n   128→| Partition key performance, global distribution, TTL support\n   129→\n   130→| DEC-004\n   131→| Event Bus\n   132→| #TBD#\n   133→| CloudEvents 1.0 standard, built-in retry, dead letter queue\n   134→\n   135→| DEC-005\n   136→| Key Storage\n   137→| #TBD#\n   138→| SaaS OAuth provider, Flybuys IDP integration, reduces custom implementation risk\n   139→\n   140→| DEC-006\n   141→| Data Processing\n   142→| #TBD#\n   143→| SFTP connector, PGP encryption, scheduling\n   144→\n   145→| DEC-007\n   146→| Monitoring\n   147→| #TBD#\n   148→| Native Azure integration, distributed tracing, correlation IDs\n   149→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"fe32db1f-35a0-468f-bd6c-2491db62bf8e","timestamp":"2026-01-09T04:56:51.022Z","toolUseResult":{"type":"text","file":{"filePath":"/mnt/c/Users/o.young/work/architecture/solution_architectures/flybuys_integration.adoc","content":"= Flybuys Integration - Solution Architecture\n\n:project-name: Flybuys Integration\n:togaf-adm-phase: Phase E: Opportunities & Solutions\n:document-type: Solution Architecture Document\n:status: Discovery\n:version: 0.1\n:domain: Loyalty\n:programme-lead: Frankie.Mullaly@vivaenergy.com.au\n:domain-architect: O.Young@otr.com.au\n:business-owner: D.Peisley@otr.com.au\n:business-analyst: Fiona.Cheung@vivaenergy.com.au\n:architecture-definition: xref:architecture-definitions:flybuys_integration.adoc[Architecture Definitions/Flybuys Integration]\n:doctype: article\n:toc: left\n:toclevels: 4\n:sectanchors:\n:sectxrefs:\n:sectnums:\n:icons: font\n:source-highlighter: highlightjs\n:experimental:\n:description: Solution Architecture Document for Flybuys Coalition Loyalty Integration\n:keywords: loyalty, flybuys, integration, solution-architecture, togaf\n\n== Purpose and Scope\n\n=== Purpose\n\nThis Solution Architecture defines how the Flybuys Integration will be implemented - the specific technology products, configurations, interfaces, and deployment architecture that realise the xref:architecture-definitions:flybuys_integration.adoc[Flybuys Integration].\n\n<<<\n=== Scope\n\n==== In Scope\n\n* Solution Building Blocks (SBBs) - specific technology products and versions\n* Interface specifications (APIs, events, data formats)\n* Data architecture and schema specifications\n* Transition architecture with phased implementation states\n* Technical validation criteria and testing approach\n* External system integration specifications\n\n==== Out of Scope\n\n===== Covered in xref:architecture-definitions:flybuys_integration.adoc[Architecture Definition]\n\n* Business requirements and stakeholder analysis\n* Architecture decisions and rationale\n* Bounded context definitions and responsibilities\n* High-level integration patterns (ACL, Conformist, OHS+PL)\n* Business capability mapping and value streams\n* Non-functional requirements (referenced, not duplicated)\n* Architecture principles and governance\n\n===== Covered in other documents\n\n* Detailed design (class diagrams, sequence diagrams for all flows)\n* Implementation code and unit tests\n* Business case and return-on-investment analysis\n* Operational run books and support procedures\n\n<<<\n== Executive Summary\n\nIntegrate xref:bounded-contexts:flybuys.adoc[Flybuys] Coalition Loyalty across all OTRG Digital and In-Person channels without tightly coupling to external partner systems.\n\nEnable xref:ROOT:ubiquitous_language.adoc#customer[Customers] to link their xref:ROOT:ubiquitous_language.adoc#flybuys-digital-identity[Flybuys Digital Identity] with their xref:ROOT:ubiquitous_language.adoc#otr-app[Mobile Application] user profile, and present unified xref:ROOT:ubiquitous_language.adoc#loyalty-credential[Loyalty Credentials] at all xref:bounded-contexts:otr_pos.adoc[OTR POS] and xref:bounded-contexts:otr_plus_pos.adoc[OTR+ POS] stores.\n\nThe solution establishes the xref:ROOT:ubiquitous_language.adoc#viva-consumer-id-vci[Viva Consumer ID (VCI)] as *the canonical customer identifier* across all integrated systems, ensuring consistent customer reference throughout the loyalty platform and eliminating identity fragmentation.\n\n<<<\n== Solution Approach\n\n* Deploy xref:bounded-contexts:profile.adoc[Profile Service] and xref:bounded-contexts:loyalty.adoc[Loyalty Service] as bounded context microservices\n* Use NoSQL local document storage with partition key optimisation for caching.\n* Implement **Anti-Corruption Layers** (ACLs) for xref:bounded-contexts:braze.adoc[Braze], xref:bounded-contexts:flybuys.adoc[Flybuys] and xref:bounded-contexts:eagle_eye.adoc[EagleEye] integration\n* Deploy xref:bounded-contexts:oauth.adoc[OAuth Service] with Key Vault token encryption\n* Establish event-driven architecture as the foundational integration pattern for the platform.\n* Phased roll-out (TS-1 → TS-4)\n\n=== Related Documentation\n\nThis solution architecture references detailed technical specifications:\n\n==== API Specifications\n\n* `specifications/rest/profile-service-v1.yaml`[Profile Service REST API (OpenAPI 3.0)] - Partner linking, preference management (4 endpoints)\n* `specifications/async_api/otr-event-bus-v1.yaml`[Event Bus (AsyncAPI 2.6.0)] - Domain events, CloudEvents 1.0 format\n\n==== Sequence Diagrams\n\n* Flybuys Integration Flows[Flybuys Integration Flows] - Comprehensive diagrams with happy path + error scenarios:\n** Transaction Adjudication (POS real-time, 4 scenarios)\n** OAuth Partner linking (mobile app, 4 scenarios)\n** Batch File Processing (nightly, 3 scenarios)\n** Circuit Breaker State Transitions\n** Event Propagation Timeline\n** OAuth Token Refresh (proactive + errors, 3 scenarios)\n\n==== JSON Schemas\n\n* specifications[JSON Schemas Directory] - Domain event schemas, request/response models\n\n==== Executive Summary\n\n* xref:ROOT:flybuys_integration.adoc[Executive Summary] - 1-page overview for business stakeholders\n\n<<<\n== Key Technology Decisions\n\n[cols=\"1,2,4,3\"]\n|===\n| ID | Kind | Description | Rationale\n\n| DEC-001\n| Implementation\n| .NET 8.0\n| Aligns with OTR platform standards, team expertise in C#\n\n| DEC-002\n| Hosting\n| #TBD#\n| Autoscaling, managed infrastructure, Docker support\n\n| DEC-003\n| NoSQL Database\n| #TBD#\n| Partition key performance, global distribution, TTL support\n\n| DEC-004\n| Event Bus\n| #TBD#\n| CloudEvents 1.0 standard, built-in retry, dead letter queue\n\n| DEC-005\n| Key Storage\n| #TBD#\n| SaaS OAuth provider, Flybuys IDP integration, reduces custom implementation risk\n\n| DEC-006\n| Data Processing\n| #TBD#\n| SFTP connector, PGP encryption, scheduling\n\n| DEC-007\n| Monitoring\n| #TBD#\n| Native Azure integration, distributed tracing, correlation IDs\n","numLines":150,"startLine":0,"totalLines":5277}},"sourceToolAssistantUUID":"05cf703b-5039-46f5-874e-312c390444b4"}
{"parentUuid":"fe32db1f-35a0-468f-bd6c-2491db62bf8e","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01TQ88eTXza3afSTGMGUg8vw","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"This is a large restructuring task. Given the size of the files (5276 lines vs 3328 lines), I should approach this carefully. The best approach is to:\n\n1. Create a comprehensive plan for restructuring\n2. Work section by section, being strategic about what to add/move/reorganize\n3. Preserve all existing detailed content (API specs, schemas, diagrams)\n\nSince this is such a large change, let me use the software-architect agent to help plan the restructuring approach before I start making changes. This will ensure I do it correctly and completely.","signature":"EssFCkYICxgCKkDKcFygc2bc/0HhGD60EtKM6DwhapR/fep6/8Yj0LJHK0ao22SFHJY9mGG8v1e7gqCcJGU9Rv6lvGHwoPd7sZNgEgw1zg8N/e8fP4c6n90aDOEzrSKTQvvWOHFCpSIwB81XpxYk1J69QVz1oCp4S0kutVenSTHWqJIMnz/7wNwHf8V5zby3Whtr6aHdhWUuKrIEMcGtgr3GsW3wsu4AOO33xELt3f/IBmOM0Hzflb/UYyHxa90uYKSKRsFGRSkDPNpABzoVm6iJnM868RyflDDqUC/vrtACgIqgy2WOiMpSiLcDYc12UOt6AbCOy2vKj20vaZRIjxJZ4I4otdbhvzPH9xVgA9odd7ea7o6eV/swS1vQniX6fdom/up+AQ26xkseWcpBxaG2KE1i7SA5KWz8S7sOu7BDbjl62OahUiAs7FsZh2pxEuY4Oo6U3Rf3iXYiXB3SM+3nApmDl0yG08uBUGg0NI/emu+RX4EUcIHRzpTbkrFbxferIrQ/eyvqUNi9qbb0Ozl4IWaav0NeMJCI9Ncigmro2ghQ69XcZTeGg+StRXOpF+BnqxYXC4AaQyWEHvICC+FZdtjMPYdcC86i8cY+FHhDS29XWtA1RFO2aQeskMi3SIxzziv9ETRzdJ6RuMZuM44P+iq56KmXB0urynjC8hnMVg3fyY26iEUeE+wjFrOQF4YKdchHLE8k0Dc3nUx9+mCsYaRQVCbaj9Wt2QrRde/RVPS4yunKzGD23ZWMm5bnNv6HDcLWBa1rHnwt3HCfRAUOeLuSdfzrMVbKObuvEEsZka2HRt01s5fQPzKwtJ3LYWruvMatS0vQwHWUeEg2mGNptI2hugQXFPIX0nvHpVKH5yGiXY/iKB9pLfxvqCX4DbvpqrSfGJH+apP5lPJrrUKSU6t6GrUocHjeIXF/lnXCgJlORng1WBdvOIWArhgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":2425,"cache_read_input_tokens":99623,"cache_creation":{"ephemeral_5m_input_tokens":2425,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWwDARfK9xf8HkxiBi8We","type":"assistant","uuid":"0153ef22-dfb9-4def-8dcd-1fcb85a88b59","timestamp":"2026-01-09T04:56:57.965Z"}
{"parentUuid":"0153ef22-dfb9-4def-8dcd-1fcb85a88b59","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01TQ88eTXza3afSTGMGUg8vw","type":"message","role":"assistant","content":[{"type":"text","text":"Given the size of this restructuring (5276 lines), let me engage the software-architect agent to help plan the best approach for this refactoring while preserving all the valuable detail in the Flybuys document."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":2425,"cache_read_input_tokens":99623,"cache_creation":{"ephemeral_5m_input_tokens":2425,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWwDARfK9xf8HkxiBi8We","type":"assistant","uuid":"6f07b2be-c446-4347-9985-6ba9eaae161e","timestamp":"2026-01-09T04:56:59.173Z"}
{"parentUuid":"6f07b2be-c446-4347-9985-6ba9eaae161e","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01TQ88eTXza3afSTGMGUg8vw","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Kv1yPRJtb5rekKHC5cPRK9","name":"Task","input":{"subagent_type":"software-architect","description":"Plan Flybuys solution architecture restructuring","prompt":"I need to restructure the Flybuys solution architecture document (5276 lines) to match the more comprehensive and TOGAF-aligned structure of the Salesforce solution architecture document (3328 lines).\n\nCurrent Flybuys structure issues:\n- Executive Summary is brief and early (line 9)\n- No Vision or Architectural Approach sections\n- No formal Technical Requirements section  \n- No Baseline Architecture section (content scattered in TS-0)\n- Informal \"Key Technology Decisions\" instead of formal ADRs\n- No dedicated Assumptions and Constraints section\n- No comprehensive Non-Functional Requirements section\n- No Monitoring and Observability section\n- Gap Analysis is after Interface Specifications instead of integrated into architecture\n\nFlybuys strengths to preserve:\n- Detailed Physical Data Models with JSON schemas\n- Complete API Documentation\n- Correlation ID Propagation specification\n- SBB Dependency Flowchart\n- Comprehensive sequence diagrams and interaction flows\n\nSalesforce structure (target):\n1. Purpose and Scope (with Vision, Architectural Approach, Architecture Overview)\n2. Solution Approach\n3. Executive Summary (Challenge/Solution/Significance structure)\n4. Technical Requirements\n5. Technical Architecture (with Baseline, Gap Analysis, Target State, ADRs)\n6. Solution Building Blocks\n7. Data Architecture\n8. Interface Specifications\n9. Work Packages\n10. Transition Architecture\n11. Assumptions and Constraints\n12. Non-Functional Requirements\n13. Monitoring and Observability\n14. Solution Validation\n\nPlease provide:\n1. A detailed restructuring plan with section mappings\n2. Recommendations for converting Key Technology Decisions to ADRs\n3. Strategy for extracting Baseline Architecture from TS-0\n4. Approach for organizing Non-Functional Requirements\n5. Any content that should be created vs moved\n6. Risks and validation checkpoints"}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":2425,"cache_read_input_tokens":99623,"cache_creation":{"ephemeral_5m_input_tokens":2425,"ephemeral_1h_input_tokens":0},"output_tokens":706,"service_tier":"standard"}},"requestId":"req_011CWwDARfK9xf8HkxiBi8We","type":"assistant","uuid":"9652d651-4705-4a02-85df-bbe8f7e0a422","timestamp":"2026-01-09T04:57:09.202Z"}
{"parentUuid":"9652d651-4705-4a02-85df-bbe8f7e0a422","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Kv1yPRJtb5rekKHC5cPRK9","type":"tool_result","content":[{"type":"text","text":"## Summary\n\nI've created a comprehensive restructuring plan for the Flybuys Integration Solution Architecture document. Here's what I've delivered:\n\n### 1. Detailed Restructuring Plan (`notes/flybuys_restructuring_plan.md`)\n\n**Comprehensive 21-28 hour execution plan** covering:\n\n- **Current Issues Identified**: 10 structural gaps (missing Vision, Baseline Architecture, NFRs, Monitoring, etc.)\n- **Strengths to Preserve**: Physical data models, API documentation, correlation ID propagation, transition architecture\n- **Target Structure**: 14 sections following Salesforce TOGAF-aligned pattern\n- **Detailed Section Mappings**: Move/convert/create actions for each section\n- **ADR Conversion Strategy**: 10+ formal Architecture Decision Records with Status/Context/Rationale/Consequences\n- **Content Examples**: Complete examples for Executive Summary, Baseline Architecture, ADRs, NFRs, Monitoring, Solution Validation\n- **Validation Checkpoints**: 6 checkpoints to ensure quality (Executive, Technical Architecture, NFRs, Monitoring, Validation, Work Packages)\n- **Execution Approach**: 5 phases from structure mapping to validation and polish\n- **Risk Mitigation**: 5 risks identified with mitigation strategies\n\n### 2. Executive Summary (`notes/flybuys_restructuring_summary.md`)\n\n**Quick-reference guide** covering:\n\n- Goal and key problems\n- Target structure overview\n- Major transformations (Key Tech Decisions → ADRs, Executive Summary enhancement, Baseline extraction)\n- Content movement map\n- Content creation checklist\n- 6 validation checkpoints\n- 5-phase execution plan\n- Risks and success criteria\n\n### Key Recommendations\n\n#### 1. Converting Key Technology Decisions to ADRs\n\n**10+ Formal ADRs to Create**:\n\n- ADR-FB-001: .NET 8.0 Implementation Stack (Accepted)\n- ADR-FB-002: OAuth 2.0 + PKCE for Partner Linking (Accepted)\n- ADR-FB-003: NoSQL Database (Accepted, technology TBD)\n- ADR-FB-004: Event-Driven Integration (Accepted, technology TBD)\n- ADR-FB-005: Phased Rollout with Feature Flags (Accepted)\n- ADR-FB-006: AES-256 Encryption for OAuth Tokens (Accepted)\n- ADR-FB-007: Nightly Batch SFTP (Accepted)\n- ADR-FB-008: Circuit Breaker Pattern (Accepted)\n- ADR-FB-009: Correlation ID Propagation (Accepted)\n- ADR-FB-010: Conformist Pattern for Flybuys (Accepted)\n\n**Template**: Status, Context, Decision, Rationale, Consequences, Implementation Notes\n\n#### 2. Extracting Baseline Architecture from TS-0\n\n**Current State**: TS-0 content scattered in Transition Architecture section (lines 4421-4438)\n\n**Target State**: Comprehensive Baseline Architecture section in Technical Architecture with:\n\n- Current Business Capability (from Architecture Definition)\n- Current Value Stream with sequence diagram (from Architecture Definition)\n- Existing System Components (OTR App API, Reddy Express, Salesforce, EagleEye, Coupon Scanner)\n- Integration Architecture diagram (to be created)\n- Pain Points (from Architecture Definition)\n- Technical Debt (from TS-0)\n\n**Why**: TOGAF requires baseline-gap-target progression. Salesforce has comprehensive baseline before gap analysis.\n\n#### 3. Organizing Non-Functional Requirements\n\n**8 Subsections**:\n\n1. Performance Requirements (6 NFRs: API latency, adjudication latency, OAuth flow, balance query, Event Bus, batch processing)\n2. Availability Requirements (5 NFRs: service uptime, graceful degradation, disaster recovery)\n3. Scalability Requirements (6 NFRs: transaction volume 1x/3x/10x, auto-scaling)\n4. Security Requirements (10 NFRs: authentication, authorisation, encryption, secret management, PII handling, rate limiting)\n5. Reliability Requirements (8 NFRs: retry logic, DLQ monitoring, idempotency, circuit breaker, health checks)\n6. Maintainability Requirements (8 NFRs: code quality, API docs, deployment automation, logging, monitoring, alerting)\n7. Usability Requirements (5 NFRs: OAuth UX, balance display, transaction confirmation, error messaging, accessibility)\n8. Compliance Requirements (6 NFRs: GDPR, data residency, audit trail, API security, PCI-DSS)\n\n**Total**: 40+ NFRs with measurable targets\n\n#### 4. Content to Create vs. Move\n\n**Move** (no creation):\n- Gap Analysis (line 3242 → Technical Architecture)\n- Implementation Constraints → Assumptions and Constraints\n- Success Criteria → Executive Summary\n- TS-0 Baseline → Baseline Architecture\n- Domain Event Schemas → Data Architecture\n\n**Convert** (transformation):\n- Key Technology Decisions table → Formal ADRs (10+ ADRs)\n\n**Create** (new sections):\n- Vision, Architectural Approach, Architecture Overview (copy from Architecture Definition)\n- Technical Requirements (copy from Architecture Definition)\n- Executive Summary - Challenge/Key Architectural Significance/Open Technical Decisions\n- Baseline Architecture - Existing System Components/Integration Architecture\n- Data Quality & Validation\n- Work Package Sequencing\n- Assumptions and Constraints (10+ assumptions)\n- Non-Functional Requirements (8 subsections, 40+ NFRs)\n- Monitoring and Observability (metrics, alerting, dashboards)\n- Solution Validation (functional, non-functional, integration testing)\n\n#### 5. Validation Checkpoints\n\n**6 Checkpoints**:\n\n1. **Executive Summary**: Can executive understand business problem, solution, strategic value?\n2. **Technical Architecture**: Can Domain Architect understand baseline, gaps, target state, decisions?\n3. **Non-Functional Requirements**: Can Senior Engineer design load/resilience/security tests?\n4. **Monitoring and Observability**: Can Platform SRE configure monitoring/alerting?\n5. **Solution Validation**: Can QA Lead design test plans?\n6. **Work Package Sequencing**: Can Programme Lead plan resource allocation/timeline?\n\n### Estimated Effort\n\n**Total**: 21-28 hours across 5 phases\n\n**Final Document Size**: 6000-6500 lines (+1000 lines from current 5276 lines)\n\nBoth planning documents are saved in `/mnt/c/Users/o.young/work/architecture/notes/` for your review."},{"type":"text","text":"agentId: a7dc162 (for resuming to continue this agent's work if needed)"}]}]},"uuid":"db7b4c01-4ad3-4f1e-bd5c-27920adadd77","timestamp":"2026-01-09T05:10:02.364Z","toolUseResult":{"status":"completed","prompt":"I need to restructure the Flybuys solution architecture document (5276 lines) to match the more comprehensive and TOGAF-aligned structure of the Salesforce solution architecture document (3328 lines).\n\nCurrent Flybuys structure issues:\n- Executive Summary is brief and early (line 9)\n- No Vision or Architectural Approach sections\n- No formal Technical Requirements section  \n- No Baseline Architecture section (content scattered in TS-0)\n- Informal \"Key Technology Decisions\" instead of formal ADRs\n- No dedicated Assumptions and Constraints section\n- No comprehensive Non-Functional Requirements section\n- No Monitoring and Observability section\n- Gap Analysis is after Interface Specifications instead of integrated into architecture\n\nFlybuys strengths to preserve:\n- Detailed Physical Data Models with JSON schemas\n- Complete API Documentation\n- Correlation ID Propagation specification\n- SBB Dependency Flowchart\n- Comprehensive sequence diagrams and interaction flows\n\nSalesforce structure (target):\n1. Purpose and Scope (with Vision, Architectural Approach, Architecture Overview)\n2. Solution Approach\n3. Executive Summary (Challenge/Solution/Significance structure)\n4. Technical Requirements\n5. Technical Architecture (with Baseline, Gap Analysis, Target State, ADRs)\n6. Solution Building Blocks\n7. Data Architecture\n8. Interface Specifications\n9. Work Packages\n10. Transition Architecture\n11. Assumptions and Constraints\n12. Non-Functional Requirements\n13. Monitoring and Observability\n14. Solution Validation\n\nPlease provide:\n1. A detailed restructuring plan with section mappings\n2. Recommendations for converting Key Technology Decisions to ADRs\n3. Strategy for extracting Baseline Architecture from TS-0\n4. Approach for organizing Non-Functional Requirements\n5. Any content that should be created vs moved\n6. Risks and validation checkpoints","agentId":"a7dc162","content":[{"type":"text","text":"## Summary\n\nI've created a comprehensive restructuring plan for the Flybuys Integration Solution Architecture document. Here's what I've delivered:\n\n### 1. Detailed Restructuring Plan (`notes/flybuys_restructuring_plan.md`)\n\n**Comprehensive 21-28 hour execution plan** covering:\n\n- **Current Issues Identified**: 10 structural gaps (missing Vision, Baseline Architecture, NFRs, Monitoring, etc.)\n- **Strengths to Preserve**: Physical data models, API documentation, correlation ID propagation, transition architecture\n- **Target Structure**: 14 sections following Salesforce TOGAF-aligned pattern\n- **Detailed Section Mappings**: Move/convert/create actions for each section\n- **ADR Conversion Strategy**: 10+ formal Architecture Decision Records with Status/Context/Rationale/Consequences\n- **Content Examples**: Complete examples for Executive Summary, Baseline Architecture, ADRs, NFRs, Monitoring, Solution Validation\n- **Validation Checkpoints**: 6 checkpoints to ensure quality (Executive, Technical Architecture, NFRs, Monitoring, Validation, Work Packages)\n- **Execution Approach**: 5 phases from structure mapping to validation and polish\n- **Risk Mitigation**: 5 risks identified with mitigation strategies\n\n### 2. Executive Summary (`notes/flybuys_restructuring_summary.md`)\n\n**Quick-reference guide** covering:\n\n- Goal and key problems\n- Target structure overview\n- Major transformations (Key Tech Decisions → ADRs, Executive Summary enhancement, Baseline extraction)\n- Content movement map\n- Content creation checklist\n- 6 validation checkpoints\n- 5-phase execution plan\n- Risks and success criteria\n\n### Key Recommendations\n\n#### 1. Converting Key Technology Decisions to ADRs\n\n**10+ Formal ADRs to Create**:\n\n- ADR-FB-001: .NET 8.0 Implementation Stack (Accepted)\n- ADR-FB-002: OAuth 2.0 + PKCE for Partner Linking (Accepted)\n- ADR-FB-003: NoSQL Database (Accepted, technology TBD)\n- ADR-FB-004: Event-Driven Integration (Accepted, technology TBD)\n- ADR-FB-005: Phased Rollout with Feature Flags (Accepted)\n- ADR-FB-006: AES-256 Encryption for OAuth Tokens (Accepted)\n- ADR-FB-007: Nightly Batch SFTP (Accepted)\n- ADR-FB-008: Circuit Breaker Pattern (Accepted)\n- ADR-FB-009: Correlation ID Propagation (Accepted)\n- ADR-FB-010: Conformist Pattern for Flybuys (Accepted)\n\n**Template**: Status, Context, Decision, Rationale, Consequences, Implementation Notes\n\n#### 2. Extracting Baseline Architecture from TS-0\n\n**Current State**: TS-0 content scattered in Transition Architecture section (lines 4421-4438)\n\n**Target State**: Comprehensive Baseline Architecture section in Technical Architecture with:\n\n- Current Business Capability (from Architecture Definition)\n- Current Value Stream with sequence diagram (from Architecture Definition)\n- Existing System Components (OTR App API, Reddy Express, Salesforce, EagleEye, Coupon Scanner)\n- Integration Architecture diagram (to be created)\n- Pain Points (from Architecture Definition)\n- Technical Debt (from TS-0)\n\n**Why**: TOGAF requires baseline-gap-target progression. Salesforce has comprehensive baseline before gap analysis.\n\n#### 3. Organizing Non-Functional Requirements\n\n**8 Subsections**:\n\n1. Performance Requirements (6 NFRs: API latency, adjudication latency, OAuth flow, balance query, Event Bus, batch processing)\n2. Availability Requirements (5 NFRs: service uptime, graceful degradation, disaster recovery)\n3. Scalability Requirements (6 NFRs: transaction volume 1x/3x/10x, auto-scaling)\n4. Security Requirements (10 NFRs: authentication, authorisation, encryption, secret management, PII handling, rate limiting)\n5. Reliability Requirements (8 NFRs: retry logic, DLQ monitoring, idempotency, circuit breaker, health checks)\n6. Maintainability Requirements (8 NFRs: code quality, API docs, deployment automation, logging, monitoring, alerting)\n7. Usability Requirements (5 NFRs: OAuth UX, balance display, transaction confirmation, error messaging, accessibility)\n8. Compliance Requirements (6 NFRs: GDPR, data residency, audit trail, API security, PCI-DSS)\n\n**Total**: 40+ NFRs with measurable targets\n\n#### 4. Content to Create vs. Move\n\n**Move** (no creation):\n- Gap Analysis (line 3242 → Technical Architecture)\n- Implementation Constraints → Assumptions and Constraints\n- Success Criteria → Executive Summary\n- TS-0 Baseline → Baseline Architecture\n- Domain Event Schemas → Data Architecture\n\n**Convert** (transformation):\n- Key Technology Decisions table → Formal ADRs (10+ ADRs)\n\n**Create** (new sections):\n- Vision, Architectural Approach, Architecture Overview (copy from Architecture Definition)\n- Technical Requirements (copy from Architecture Definition)\n- Executive Summary - Challenge/Key Architectural Significance/Open Technical Decisions\n- Baseline Architecture - Existing System Components/Integration Architecture\n- Data Quality & Validation\n- Work Package Sequencing\n- Assumptions and Constraints (10+ assumptions)\n- Non-Functional Requirements (8 subsections, 40+ NFRs)\n- Monitoring and Observability (metrics, alerting, dashboards)\n- Solution Validation (functional, non-functional, integration testing)\n\n#### 5. Validation Checkpoints\n\n**6 Checkpoints**:\n\n1. **Executive Summary**: Can executive understand business problem, solution, strategic value?\n2. **Technical Architecture**: Can Domain Architect understand baseline, gaps, target state, decisions?\n3. **Non-Functional Requirements**: Can Senior Engineer design load/resilience/security tests?\n4. **Monitoring and Observability**: Can Platform SRE configure monitoring/alerting?\n5. **Solution Validation**: Can QA Lead design test plans?\n6. **Work Package Sequencing**: Can Programme Lead plan resource allocation/timeline?\n\n### Estimated Effort\n\n**Total**: 21-28 hours across 5 phases\n\n**Final Document Size**: 6000-6500 lines (+1000 lines from current 5276 lines)\n\nBoth planning documents are saved in `/mnt/c/Users/o.young/work/architecture/notes/` for your review."}],"totalDurationMs":773093,"totalTokens":75711,"totalToolUseCount":25,"usage":{"input_tokens":4,"cache_creation_input_tokens":3817,"cache_read_input_tokens":70317,"cache_creation":{"ephemeral_5m_input_tokens":3817,"ephemeral_1h_input_tokens":0},"output_tokens":1573,"service_tier":"standard"}},"sourceToolAssistantUUID":"9652d651-4705-4a02-85df-bbe8f7e0a422"}
{"parentUuid":"db7b4c01-4ad3-4f1e-bd5c-27920adadd77","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_016D27QSNtz5gpoMDgea2s1V","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Great! The software-architect agent has created a comprehensive plan. Now I should read those plan files and then proceed with the restructuring. This is a big task (21-28 hours estimated), so I should work systematically through it.\n\nLet me start with Phase 1: Understanding and Mapping, then proceed to restructure the document section by section.\n\nGiven the scope, let me focus on the key structural changes first:\n1. Add Vision and Architectural Approach\n2. Restructure Executive Summary\n3. Add Technical Requirements\n4. Create Baseline Architecture from TS-0\n5. Convert Key Technology Decisions to ADRs\n6. Add NFRs, Monitoring, Assumptions\n\nThis is a substantial task. Let me start with the restructuring.","signature":"EugGCkYICxgCKkCATItYl1KT3JhYyswikS+9aalz5EHSdbiVnTu/e+mVsEvq2ybVrm8O8zXQ00myLlXc+EAJswzC0Ou4nyH1V5uzEgwvgX36x6ZNfs+rMN0aDDdpd51gWHvrJpAwSSIwFYB1mKdpAQjl+JeXa+j0YgKKEnlsiGwZtqovqairD7HKKDuRhvhFrsW+dCnpzoOgKs8Fcae2+s2LMznRejeiVHmIFqxYCkySkTtWCqWzifvzMcpZ1RIHgwqCMG03zjwMqnu3NI7NYPdf+TBjLJErVu6l7xUkuBQTWxnHIZWt/Onzp0u/zYG4uLOFvZ7FYPA/E/WgEUNm+QYmxm6LSkenLJ6S+uFN7oOSddqUIl4rKLdJ3cEAJFL6DQGfdhMbHzgR13WJ+LBXUKbMFq5xAFaOiV3p0fwZCDTEQ23nHMnXsBFeI2NdKLY5wWtQNQDybQwgTfMLV/IwRyb3CMMLf0FlCLM+a/5p8WqK8D0NGGeoEg3HDXDPqaSxZWiyhZrixfMByIivkpk8GBwOJyUz5eAcVxfsGy9Bf3h2kiJToDENpw9urmnDy0tI70Dkvc3BX3MyBGeysLRUcwchdyDQYWfA83ak8i1ULrRYmyk/EXOBa0FMxMyuzfHUs/1GDfuzopsHhu5oONxQWhhmOtQwA/YFLUzR0tGnNdAID5mFe4zcwRUGpoLtaFrpQtlNtGEYUQoB2pRzXFR9gXwvA9Cry6icrJohUDNmkeGs8QEhrBsPIE/X64fVICrluAo1fsd0n5oBFUER/7/RuM/iGSbwHnxCgzFfl1ixfB92xNhKsHqrLOU3wbKRK66rEMiYBZJWCLkaA78FqKi1cuZ1qdynFctgAd4JB56BdiXx6miVgj+UsI/WtMcHi0TY5+cOIahtpdAoic4OwP4KPEnhXKPQSuN4ZFuxL2nl2VS7yfzl3KH/fCoMNHp9QkKA3JkQu3CdRmCStPX7z5GvTk46qbHKMP1d53fBnjsJ4Kgtz7lwM9tx0G4tN6C2BfCcTnokg20bHU5Gdp2FvN4ONRo9zCfayfeCMqtaJs7er3THn5q4g0s6T8QyKkjSkfD+yHSiTMWkeAPCtbAptuV5s5jUt9Af+akzYpWKjYQRW4DmW1jlZ6lJ6mwhEKGAaTidECR+QJREIoF5vC8YAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":104363,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":104363,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWwEAkYEgZsP7WD5KC37r","type":"assistant","uuid":"13addd1c-451b-41d5-8071-38caa29c30fd","timestamp":"2026-01-09T05:10:10.041Z"}
{"parentUuid":"13addd1c-451b-41d5-8071-38caa29c30fd","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_016D27QSNtz5gpoMDgea2s1V","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01BraLRFdXkDpiT9hibqZCts","name":"Read","input":{"file_path":"/mnt/c/Users/o.young/work/architecture/notes/flybuys_restructuring_summary.md"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":104363,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":104363,"ephemeral_1h_input_tokens":0},"output_tokens":254,"service_tier":"standard"}},"requestId":"req_011CWwEAkYEgZsP7WD5KC37r","type":"assistant","uuid":"fa1f52aa-ebd1-4166-8331-7e30dc200d4a","timestamp":"2026-01-09T05:10:10.655Z"}
{"parentUuid":"fa1f52aa-ebd1-4166-8331-7e30dc200d4a","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01BraLRFdXkDpiT9hibqZCts","type":"tool_result","content":"     1→# Flybuys Integration Solution Architecture Restructuring - Executive Summary\n     2→\n     3→## Goal\n     4→\n     5→Restructure Flybuys Integration Solution Architecture (5276 lines) to match the comprehensive TOGAF-aligned structure of Salesforce Customer Support Solution Architecture (3328 lines), while preserving Flybuys' technical strengths.\n     6→\n     7→## Key Problems Identified\n     8→\n     9→1. **Executive Summary**: Brief, early placement (line 64), lacks Challenge/Solution/Significance structure\n    10→2. **Missing Sections**: No Vision, Architectural Approach, Baseline Architecture, Assumptions/Constraints, NFRs, Monitoring/Observability, Solution Validation\n    11→3. **Informal Technology Decisions**: Table format instead of formal ADRs with Status/Context/Rationale/Consequences\n    12→4. **Gap Analysis Placement**: After Interface Specifications (line 3242) instead of in Technical Architecture\n    13→5. **Scattered Content**: Baseline in TS-0, constraints in multiple locations, NFRs implicit\n    14→\n    15→## Strengths to Preserve\n    16→\n    17→1. **Detailed Physical Data Models**: JSON schemas for PartnerLink, RewardTransaction, OAuth tokens\n    18→2. **Complete API Documentation**: REST APIs, AsyncAPI events, versioning policy\n    19→3. **Correlation ID Propagation**: Comprehensive distributed tracing specification\n    20→4. **Comprehensive Interaction Flows**: OAuth linking, JIT profile creation, POS integration, batch processing\n    21→5. **Detailed Transition Architecture**: Feature flag matrix, rollback strategies, TS-0 → TS-4 phases\n    22→\n    23→## Target Structure (14 Sections)\n    24→\n    25→```\n    26→1. Purpose and Scope (+150 lines)\n    27→   - Copy Vision, Architectural Approach, Architecture Overview from Arch Def\n    28→\n    29→2. Solution Approach (+10 lines)\n    30→   - Minor expansion\n    31→\n    32→3. Executive Summary (+240 lines) ← MAJOR RESTRUCTURING\n    33→   - Challenge (new)\n    34→   - Solution with 3 subsections (new)\n    35→   - Key Architectural Significance (new)\n    36→   - Success Criteria (existing)\n    37→   - Technical Constraints (relocated)\n    38→   - Open Technical Decisions (new)\n    39→\n    40→4. Technical Requirements (+150 lines) ← NEW SECTION\n    41→   - Copy from Architecture Definition\n    42→\n    43→5. Technical Architecture (+600 lines) ← MAJOR REORGANIZATION\n    44→   - Baseline Architecture (extracted from TS-0)\n    45→   - Gap Analysis (relocated from line 3242)\n    46→   - Target State Architecture (existing)\n    47→   - Architecture Decisions (converted from Key Tech Decisions)\n    48→\n    49→6. Solution Building Blocks (0 change)\n    50→   - Keep detailed SBB specifications\n    51→\n    52→7. Data Architecture (+200 lines)\n    53→   - Physical Data Models (existing)\n    54→   - Domain Event Schemas (extracted from Interface Specs)\n    55→   - Data Quality & Validation (new)\n    56→\n    57→8. Interface Specifications (-500 lines)\n    58→   - Reorganized subsections\n    59→   - Move event schemas to Data Architecture\n    60→\n    61→9. Work Packages (+100 lines)\n    62→   - Add Work Package Sequencing subsection\n    63→\n    64→10. Transition Architecture (0 change)\n    65→    - Keep detailed TS-0 → TS-4 phases\n    66→\n    67→11. Assumptions and Constraints (+100 lines) ← NEW SECTION\n    68→    - 10+ assumptions\n    69→    - Consolidated constraints\n    70→\n    71→12. Non-Functional Requirements (+400 lines) ← NEW SECTION\n    72→    - 8 subsections: Performance, Availability, Scalability, Security, Reliability, Maintainability, Usability, Compliance\n    73→    - 40+ NFRs with measurable targets\n    74→\n    75→13. Monitoring and Observability (+250 lines) ← NEW SECTION\n    76→    - Key Metrics\n    77→    - Alerting Thresholds\n    78→    - Dashboards\n    79→\n    80→14. Solution Validation (+300 lines) ← NEW SECTION\n    81→    - Functional Validation\n    82→    - Non-Functional Validation\n    83→    - Acceptance Criteria\n    84→```\n    85→\n    86→**Final Document Size**: 6000-6500 lines (+1000 lines from current)\n    87→\n    88→## Major Transformations\n    89→\n    90→### 1. Key Technology Decisions → Architecture Decisions (ADRs)\n    91→\n    92→**From**: Simple table with ID/Kind/Description/Rationale\n    93→\n    94→**To**: Formal ADRs with Status/Context/Decision/Rationale/Consequences/Implementation Notes\n    95→\n    96→**Example ADRs to Create**:\n    97→\n    98→- ADR-FB-001: .NET 8.0 Implementation Stack\n    99→- ADR-FB-002: OAuth 2.0 + PKCE for Partner Linking\n   100→- ADR-FB-003: NoSQL Database for Profile and Loyalty Services\n   101→- ADR-FB-004: Event-Driven Integration via Event Bus\n   102→- ADR-FB-005: Phased Rollout with Feature Flags (not big-bang)\n   103→- ADR-FB-006: AES-256 Encryption for OAuth Tokens\n   104→- ADR-FB-007: Nightly Batch SFTP for Flybuys Transaction Posting\n   105→- ADR-FB-008: Circuit Breaker Pattern for External API Resilience\n   106→- ADR-FB-009: Correlation ID Propagation for Distributed Tracing\n   107→- ADR-FB-010: Conformist Pattern for Flybuys API Integration\n   108→\n   109→**TBD Decisions**: Mark as \"Under Evaluation\" with technology options (Hosting, NoSQL DB, Event Bus, Secrets Manager, etc.)\n   110→\n   111→### 2. Executive Summary Enhancement\n   112→\n   113→**From**: 10-line brief summary\n   114→\n   115→**To**: 250-line comprehensive summary with:\n   116→\n   117→- **Challenge**: Fragmented loyalty, manual batch processing, no coalition partner linking, high operational overhead\n   118→- **Solution**: Three bounded contexts (Profile, Loyalty, Engagement), OAuth 2.0 + PKCE, event-driven architecture, phased migration\n   119→- **Key Architectural Significance**: First DDD bounded contexts, event-driven foundation, partner flexibility, platform consolidation\n   120→- **Success Criteria**: Measurable targets (>95% OAuth linking, <500ms adjudication, >98% batch acknowledgement)\n   121→- **Technical Constraints**: Flybuys conformance, AES-256 encryption, Australia East data residency, phased rollout\n   122→- **Open Technical Decisions**: TBD technology choices with evaluation status\n   123→\n   124→### 3. Baseline Architecture Extraction\n   125→\n   126→**From**: TS-0 Current State buried in Transition Architecture section (lines 4421-4438)\n   127→\n   128→**To**: Comprehensive Baseline Architecture section in Technical Architecture with:\n   129→\n   130→- Current Business Capability (from Arch Def)\n   131→- Current Value Stream (from Arch Def)\n   132→- Existing System Components (expanded from TS-0)\n   133→  - OTR App API (platform, capabilities, limitations)\n   134→  - Reddy Express Legacy Loyalty (platform, capabilities, limitations)\n   135→  - Salesforce CRM, EagleEye, Coupon Scanner\n   136→- Integration Architecture (new diagram)\n   137→- Pain Points (from Arch Def)\n   138→- Technical Debt (from TS-0)\n   139→\n   140→## Content Movement Map\n   141→\n   142→| Content | From | To | Action |\n   143→|---------|------|-----|--------|\n   144→| Gap Analysis | Line 3242 (after Interface Specs) | Technical Architecture | Move |\n   145→| Implementation Constraints | Line 212 | Assumptions and Constraints | Move |\n   146→| Success Criteria | Line 220 | Executive Summary | Move |\n   147→| TS-0 Baseline | Line 4421 (Transition Architecture) | Baseline Architecture | Extract |\n   148→| Domain Event Schemas | Interface Specifications | Data Architecture | Extract |\n   149→| Key Technology Decisions | Line 110 | Architecture Decisions (ADRs) | Convert |\n   150→| Vision, Architectural Approach | Architecture Definition | Purpose and Scope | Copy |\n   151→| Technical Requirements | Architecture Definition | Technical Requirements | Copy |\n   152→\n   153→## Content Creation Checklist\n   154→\n   155→- [ ] Vision (copy from Architecture Definition)\n   156→- [ ] Architectural Approach (copy from Architecture Definition)\n   157→- [ ] Architecture Overview diagram (copy from Architecture Definition)\n   158→- [ ] Executive Summary - Challenge subsection (synthesize from pain points)\n   159→- [ ] Executive Summary - Key Architectural Significance (new analysis)\n   160→- [ ] Executive Summary - Open Technical Decisions (extract from #TBD# decisions)\n   161→- [ ] Technical Requirements (copy from Architecture Definition)\n   162→- [ ] Baseline Architecture - Existing System Components (expand from TS-0)\n   163→- [ ] Baseline Architecture - Integration Architecture diagram (create)\n   164→- [ ] Architecture Decisions - 10+ formal ADRs (convert from Key Tech Decisions)\n   165→- [ ] Data Architecture - Data Quality & Validation (new subsection)\n   166→- [ ] Work Package Sequencing (parallel/sequential tracks, critical path)\n   167→- [ ] Assumptions and Constraints (10+ assumptions, consolidated constraints)\n   168→- [ ] Non-Functional Requirements (8 subsections, 40+ NFRs)\n   169→- [ ] Monitoring and Observability (metrics, alerting, dashboards)\n   170→- [ ] Solution Validation (functional, non-functional, integration testing)\n   171→\n   172→## Validation Checkpoints\n   173→\n   174→### Checkpoint 1: Executive Summary\n   175→\n   176→**Test**: Can an executive read Executive Summary and understand business problem, solution, strategic value without reading rest of document?\n   177→\n   178→**Validate**:\n   179→- [ ] Challenge section clearly articulates pain points\n   180→- [ ] Solution section describes bounded contexts, integration patterns, migration approach\n   181→- [ ] Key Architectural Significance highlights strategic impact\n   182→- [ ] Success Criteria measurable and testable\n   183→- [ ] Technical Constraints comprehensive\n   184→\n   185→### Checkpoint 2: Technical Architecture\n   186→\n   187→**Test**: Can a Domain Architect understand baseline, gaps, target state, and architectural decisions with rationale?\n   188→\n   189→**Validate**:\n   190→- [ ] Baseline Architecture comprehensive (existing systems, integration, value stream, pain points, technical debt)\n   191→- [ ] Gap Analysis follows Baseline (logical flow: current → gaps → target)\n   192→- [ ] Target State Architecture references Gap Analysis\n   193→- [ ] ADRs formal with Status/Context/Decision/Rationale/Consequences (10+ ADRs)\n   194→- [ ] ADRs reference constraints, NFRs, other sections\n   195→\n   196→### Checkpoint 3: Non-Functional Requirements\n   197→\n   198→**Test**: Can a Senior Engineer design load tests, resilience tests, security tests from NFR section?\n   199→\n   200→**Validate**:\n   201→- [ ] 8 subsections (Performance, Availability, Scalability, Security, Reliability, Maintainability, Usability, Compliance)\n   202→- [ ] 40+ NFRs with measurable targets\n   203→- [ ] NFRs reference ADRs and constraints\n   204→- [ ] NFRs testable during TS-1, TS-2, TS-3 phases\n   205→\n   206→### Checkpoint 4: Monitoring and Observability\n   207→\n   208→**Test**: Can a Platform SRE configure monitoring dashboards and alerting from this section?\n   209→\n   210→**Validate**:\n   211→- [ ] Key Metrics table comprehensive (all services, Event Bus, external APIs, business metrics)\n   212→- [ ] Alerting Thresholds table defines P1/P2/P3 severity\n   213→- [ ] Dashboards defined for each service, Event Bus, external APIs, business metrics\n   214→- [ ] Correlation ID Propagation referenced for distributed tracing\n   215→\n   216→### Checkpoint 5: Solution Validation\n   217→\n   218→**Test**: Can a QA Lead design test plans from this section?\n   219→\n   220→**Validate**:\n   221→- [ ] Functional validation scenarios comprehensive (OAuth, adjudication, balance query, batch)\n   222→- [ ] Non-functional validation defines load testing (3x, 10x, stress), resilience, security\n   223→- [ ] Integration testing scenarios validate end-to-end flows\n   224→- [ ] Acceptance criteria summary consolidates all success criteria\n   225→- [ ] Validation schedule aligns with Transition Architecture phases\n   226→\n   227→### Checkpoint 6: Work Package Sequencing\n   228→\n   229→**Test**: Can a Programme Lead plan resource allocation and timeline from this section?\n   230→\n   231→**Validate**:\n   232→- [ ] Parallel Track 1 (Infrastructure) and Track 2 (Development) clearly defined\n   233→- [ ] Sequential Track 3 (Integration & Testing) dependencies explicit\n   234→- [ ] Sequential Track 4 (Migration & Cutover) dependencies explicit\n   235→- [ ] Critical path identified (44 weeks total duration)\n   236→- [ ] Gantt chart or timeline diagram provided\n   237→\n   238→## Execution Plan\n   239→\n   240→### Phase 1: Structure and Mapping (2-3 hours)\n   241→- Create document outline with new section headings\n   242→- Map existing content to new sections\n   243→- Validate outline against Salesforce structure\n   244→\n   245→### Phase 2: Content Movement (3-4 hours)\n   246→- Move Gap Analysis to Technical Architecture\n   247→- Move Implementation Constraints to Assumptions and Constraints\n   248→- Move Success Criteria to Executive Summary\n   249→- Extract TS-0 baseline to Baseline Architecture\n   250→- Extract domain event schemas to Data Architecture\n   251→\n   252→### Phase 3: Content Conversion (6-8 hours)\n   253→- Convert Key Technology Decisions to formal ADRs (10+ ADRs)\n   254→- Enhance Executive Summary with Challenge/Solution/Significance structure\n   255→- Create Baseline Architecture - Existing System Components\n   256→\n   257→### Phase 4: Content Creation (8-10 hours)\n   258→- Copy Vision, Architectural Approach, Architecture Overview from Architecture Definition\n   259→- Copy Technical Requirements from Architecture Definition\n   260→- Create Assumptions and Constraints section\n   261→- Create Non-Functional Requirements section\n   262→- Create Monitoring and Observability section\n   263→- Create Solution Validation section\n   264→- Create Work Package Sequencing subsection\n   265→\n   266→### Phase 5: Validation and Polish (2-3 hours)\n   267→- Validate against 6 checkpoints\n   268→- Cross-reference ADRs, constraints, NFRs throughout document\n   269→- Ensure Antora xrefs work correctly\n   270→- Generate diagrams (Baseline integration diagram, Work Package Gantt)\n   271→- Final review against Salesforce structure\n   272→\n   273→**Total Estimated Effort**: 21-28 hours\n   274→\n   275→## Risks and Mitigation\n   276→\n   277→| Risk | Mitigation |\n   278→|------|-----------|\n   279→| Content duplication between Architecture Definition and Solution Architecture | Architecture Definition remains source of truth for domain model; Solution Architecture focuses on implementation; cross-reference using Antora xrefs |\n   280→| Loss of technical detail during restructuring | Preserve all existing technical content (Data Architecture, Interface Specifications); only reorganize subsections, don't delete |\n   281→| ADR conversion time burden | Prioritize critical architectural decisions first; TBD decisions can have placeholder ADRs; use template for consistency |\n   282→| NFR creation without baseline metrics | Extract NFR targets from existing Success Criteria, sequence diagrams, architecture decisions; mark as \"TBD\" where unknown; validate during TS-1 Foundation |\n   283→| Document length increase | Target 5500-6000 lines (acceptable for comprehensive solution architecture); use tables for conciseness; reference detailed specs in separate documents |\n   284→\n   285→## Success Criteria\n   286→\n   287→- [ ] Document structure matches Salesforce pattern (14 sections)\n   288→- [ ] Executive Summary passes Checkpoint 1 (executive-readable)\n   289→- [ ] Technical Architecture passes Checkpoint 2 (Domain Architect-readable)\n   290→- [ ] Non-Functional Requirements passes Checkpoint 3 (Senior Engineer-readable)\n   291→- [ ] Monitoring and Observability passes Checkpoint 4 (Platform SRE-readable)\n   292→- [ ] Solution Validation passes Checkpoint 5 (QA Lead-readable)\n   293→- [ ] Work Package Sequencing passes Checkpoint 6 (Programme Lead-readable)\n   294→- [ ] All technical strengths preserved (physical data models, API docs, correlation ID spec, interaction flows, transition architecture)\n   295→- [ ] All Antora xrefs to Architecture Definition validated\n   296→- [ ] Document length 5500-6500 lines (target range)\n   297→- [ ] Formal ADRs created for all critical architectural decisions (10+ ADRs)\n   298→\n   299→## Next Steps\n   300→\n   301→1. **Review plan with Domain Architect** - validate approach, section mappings, ADR conversion strategy\n   302→2. **Approve NFR targets** - validate NFR targets with technical team\n   303→3. **Begin Phase 1** - create document outline, map existing content\n   304→4. **Incremental validation** - validate each phase completion against checkpoints\n   305→5. **Stakeholder review** - share restructured Executive Summary with business stakeholders before proceeding\n   306→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"4bbd9674-279c-4259-8057-a1cac944028b","timestamp":"2026-01-09T05:10:10.973Z","toolUseResult":{"type":"text","file":{"filePath":"/mnt/c/Users/o.young/work/architecture/notes/flybuys_restructuring_summary.md","content":"# Flybuys Integration Solution Architecture Restructuring - Executive Summary\n\n## Goal\n\nRestructure Flybuys Integration Solution Architecture (5276 lines) to match the comprehensive TOGAF-aligned structure of Salesforce Customer Support Solution Architecture (3328 lines), while preserving Flybuys' technical strengths.\n\n## Key Problems Identified\n\n1. **Executive Summary**: Brief, early placement (line 64), lacks Challenge/Solution/Significance structure\n2. **Missing Sections**: No Vision, Architectural Approach, Baseline Architecture, Assumptions/Constraints, NFRs, Monitoring/Observability, Solution Validation\n3. **Informal Technology Decisions**: Table format instead of formal ADRs with Status/Context/Rationale/Consequences\n4. **Gap Analysis Placement**: After Interface Specifications (line 3242) instead of in Technical Architecture\n5. **Scattered Content**: Baseline in TS-0, constraints in multiple locations, NFRs implicit\n\n## Strengths to Preserve\n\n1. **Detailed Physical Data Models**: JSON schemas for PartnerLink, RewardTransaction, OAuth tokens\n2. **Complete API Documentation**: REST APIs, AsyncAPI events, versioning policy\n3. **Correlation ID Propagation**: Comprehensive distributed tracing specification\n4. **Comprehensive Interaction Flows**: OAuth linking, JIT profile creation, POS integration, batch processing\n5. **Detailed Transition Architecture**: Feature flag matrix, rollback strategies, TS-0 → TS-4 phases\n\n## Target Structure (14 Sections)\n\n```\n1. Purpose and Scope (+150 lines)\n   - Copy Vision, Architectural Approach, Architecture Overview from Arch Def\n\n2. Solution Approach (+10 lines)\n   - Minor expansion\n\n3. Executive Summary (+240 lines) ← MAJOR RESTRUCTURING\n   - Challenge (new)\n   - Solution with 3 subsections (new)\n   - Key Architectural Significance (new)\n   - Success Criteria (existing)\n   - Technical Constraints (relocated)\n   - Open Technical Decisions (new)\n\n4. Technical Requirements (+150 lines) ← NEW SECTION\n   - Copy from Architecture Definition\n\n5. Technical Architecture (+600 lines) ← MAJOR REORGANIZATION\n   - Baseline Architecture (extracted from TS-0)\n   - Gap Analysis (relocated from line 3242)\n   - Target State Architecture (existing)\n   - Architecture Decisions (converted from Key Tech Decisions)\n\n6. Solution Building Blocks (0 change)\n   - Keep detailed SBB specifications\n\n7. Data Architecture (+200 lines)\n   - Physical Data Models (existing)\n   - Domain Event Schemas (extracted from Interface Specs)\n   - Data Quality & Validation (new)\n\n8. Interface Specifications (-500 lines)\n   - Reorganized subsections\n   - Move event schemas to Data Architecture\n\n9. Work Packages (+100 lines)\n   - Add Work Package Sequencing subsection\n\n10. Transition Architecture (0 change)\n    - Keep detailed TS-0 → TS-4 phases\n\n11. Assumptions and Constraints (+100 lines) ← NEW SECTION\n    - 10+ assumptions\n    - Consolidated constraints\n\n12. Non-Functional Requirements (+400 lines) ← NEW SECTION\n    - 8 subsections: Performance, Availability, Scalability, Security, Reliability, Maintainability, Usability, Compliance\n    - 40+ NFRs with measurable targets\n\n13. Monitoring and Observability (+250 lines) ← NEW SECTION\n    - Key Metrics\n    - Alerting Thresholds\n    - Dashboards\n\n14. Solution Validation (+300 lines) ← NEW SECTION\n    - Functional Validation\n    - Non-Functional Validation\n    - Acceptance Criteria\n```\n\n**Final Document Size**: 6000-6500 lines (+1000 lines from current)\n\n## Major Transformations\n\n### 1. Key Technology Decisions → Architecture Decisions (ADRs)\n\n**From**: Simple table with ID/Kind/Description/Rationale\n\n**To**: Formal ADRs with Status/Context/Decision/Rationale/Consequences/Implementation Notes\n\n**Example ADRs to Create**:\n\n- ADR-FB-001: .NET 8.0 Implementation Stack\n- ADR-FB-002: OAuth 2.0 + PKCE for Partner Linking\n- ADR-FB-003: NoSQL Database for Profile and Loyalty Services\n- ADR-FB-004: Event-Driven Integration via Event Bus\n- ADR-FB-005: Phased Rollout with Feature Flags (not big-bang)\n- ADR-FB-006: AES-256 Encryption for OAuth Tokens\n- ADR-FB-007: Nightly Batch SFTP for Flybuys Transaction Posting\n- ADR-FB-008: Circuit Breaker Pattern for External API Resilience\n- ADR-FB-009: Correlation ID Propagation for Distributed Tracing\n- ADR-FB-010: Conformist Pattern for Flybuys API Integration\n\n**TBD Decisions**: Mark as \"Under Evaluation\" with technology options (Hosting, NoSQL DB, Event Bus, Secrets Manager, etc.)\n\n### 2. Executive Summary Enhancement\n\n**From**: 10-line brief summary\n\n**To**: 250-line comprehensive summary with:\n\n- **Challenge**: Fragmented loyalty, manual batch processing, no coalition partner linking, high operational overhead\n- **Solution**: Three bounded contexts (Profile, Loyalty, Engagement), OAuth 2.0 + PKCE, event-driven architecture, phased migration\n- **Key Architectural Significance**: First DDD bounded contexts, event-driven foundation, partner flexibility, platform consolidation\n- **Success Criteria**: Measurable targets (>95% OAuth linking, <500ms adjudication, >98% batch acknowledgement)\n- **Technical Constraints**: Flybuys conformance, AES-256 encryption, Australia East data residency, phased rollout\n- **Open Technical Decisions**: TBD technology choices with evaluation status\n\n### 3. Baseline Architecture Extraction\n\n**From**: TS-0 Current State buried in Transition Architecture section (lines 4421-4438)\n\n**To**: Comprehensive Baseline Architecture section in Technical Architecture with:\n\n- Current Business Capability (from Arch Def)\n- Current Value Stream (from Arch Def)\n- Existing System Components (expanded from TS-0)\n  - OTR App API (platform, capabilities, limitations)\n  - Reddy Express Legacy Loyalty (platform, capabilities, limitations)\n  - Salesforce CRM, EagleEye, Coupon Scanner\n- Integration Architecture (new diagram)\n- Pain Points (from Arch Def)\n- Technical Debt (from TS-0)\n\n## Content Movement Map\n\n| Content | From | To | Action |\n|---------|------|-----|--------|\n| Gap Analysis | Line 3242 (after Interface Specs) | Technical Architecture | Move |\n| Implementation Constraints | Line 212 | Assumptions and Constraints | Move |\n| Success Criteria | Line 220 | Executive Summary | Move |\n| TS-0 Baseline | Line 4421 (Transition Architecture) | Baseline Architecture | Extract |\n| Domain Event Schemas | Interface Specifications | Data Architecture | Extract |\n| Key Technology Decisions | Line 110 | Architecture Decisions (ADRs) | Convert |\n| Vision, Architectural Approach | Architecture Definition | Purpose and Scope | Copy |\n| Technical Requirements | Architecture Definition | Technical Requirements | Copy |\n\n## Content Creation Checklist\n\n- [ ] Vision (copy from Architecture Definition)\n- [ ] Architectural Approach (copy from Architecture Definition)\n- [ ] Architecture Overview diagram (copy from Architecture Definition)\n- [ ] Executive Summary - Challenge subsection (synthesize from pain points)\n- [ ] Executive Summary - Key Architectural Significance (new analysis)\n- [ ] Executive Summary - Open Technical Decisions (extract from #TBD# decisions)\n- [ ] Technical Requirements (copy from Architecture Definition)\n- [ ] Baseline Architecture - Existing System Components (expand from TS-0)\n- [ ] Baseline Architecture - Integration Architecture diagram (create)\n- [ ] Architecture Decisions - 10+ formal ADRs (convert from Key Tech Decisions)\n- [ ] Data Architecture - Data Quality & Validation (new subsection)\n- [ ] Work Package Sequencing (parallel/sequential tracks, critical path)\n- [ ] Assumptions and Constraints (10+ assumptions, consolidated constraints)\n- [ ] Non-Functional Requirements (8 subsections, 40+ NFRs)\n- [ ] Monitoring and Observability (metrics, alerting, dashboards)\n- [ ] Solution Validation (functional, non-functional, integration testing)\n\n## Validation Checkpoints\n\n### Checkpoint 1: Executive Summary\n\n**Test**: Can an executive read Executive Summary and understand business problem, solution, strategic value without reading rest of document?\n\n**Validate**:\n- [ ] Challenge section clearly articulates pain points\n- [ ] Solution section describes bounded contexts, integration patterns, migration approach\n- [ ] Key Architectural Significance highlights strategic impact\n- [ ] Success Criteria measurable and testable\n- [ ] Technical Constraints comprehensive\n\n### Checkpoint 2: Technical Architecture\n\n**Test**: Can a Domain Architect understand baseline, gaps, target state, and architectural decisions with rationale?\n\n**Validate**:\n- [ ] Baseline Architecture comprehensive (existing systems, integration, value stream, pain points, technical debt)\n- [ ] Gap Analysis follows Baseline (logical flow: current → gaps → target)\n- [ ] Target State Architecture references Gap Analysis\n- [ ] ADRs formal with Status/Context/Decision/Rationale/Consequences (10+ ADRs)\n- [ ] ADRs reference constraints, NFRs, other sections\n\n### Checkpoint 3: Non-Functional Requirements\n\n**Test**: Can a Senior Engineer design load tests, resilience tests, security tests from NFR section?\n\n**Validate**:\n- [ ] 8 subsections (Performance, Availability, Scalability, Security, Reliability, Maintainability, Usability, Compliance)\n- [ ] 40+ NFRs with measurable targets\n- [ ] NFRs reference ADRs and constraints\n- [ ] NFRs testable during TS-1, TS-2, TS-3 phases\n\n### Checkpoint 4: Monitoring and Observability\n\n**Test**: Can a Platform SRE configure monitoring dashboards and alerting from this section?\n\n**Validate**:\n- [ ] Key Metrics table comprehensive (all services, Event Bus, external APIs, business metrics)\n- [ ] Alerting Thresholds table defines P1/P2/P3 severity\n- [ ] Dashboards defined for each service, Event Bus, external APIs, business metrics\n- [ ] Correlation ID Propagation referenced for distributed tracing\n\n### Checkpoint 5: Solution Validation\n\n**Test**: Can a QA Lead design test plans from this section?\n\n**Validate**:\n- [ ] Functional validation scenarios comprehensive (OAuth, adjudication, balance query, batch)\n- [ ] Non-functional validation defines load testing (3x, 10x, stress), resilience, security\n- [ ] Integration testing scenarios validate end-to-end flows\n- [ ] Acceptance criteria summary consolidates all success criteria\n- [ ] Validation schedule aligns with Transition Architecture phases\n\n### Checkpoint 6: Work Package Sequencing\n\n**Test**: Can a Programme Lead plan resource allocation and timeline from this section?\n\n**Validate**:\n- [ ] Parallel Track 1 (Infrastructure) and Track 2 (Development) clearly defined\n- [ ] Sequential Track 3 (Integration & Testing) dependencies explicit\n- [ ] Sequential Track 4 (Migration & Cutover) dependencies explicit\n- [ ] Critical path identified (44 weeks total duration)\n- [ ] Gantt chart or timeline diagram provided\n\n## Execution Plan\n\n### Phase 1: Structure and Mapping (2-3 hours)\n- Create document outline with new section headings\n- Map existing content to new sections\n- Validate outline against Salesforce structure\n\n### Phase 2: Content Movement (3-4 hours)\n- Move Gap Analysis to Technical Architecture\n- Move Implementation Constraints to Assumptions and Constraints\n- Move Success Criteria to Executive Summary\n- Extract TS-0 baseline to Baseline Architecture\n- Extract domain event schemas to Data Architecture\n\n### Phase 3: Content Conversion (6-8 hours)\n- Convert Key Technology Decisions to formal ADRs (10+ ADRs)\n- Enhance Executive Summary with Challenge/Solution/Significance structure\n- Create Baseline Architecture - Existing System Components\n\n### Phase 4: Content Creation (8-10 hours)\n- Copy Vision, Architectural Approach, Architecture Overview from Architecture Definition\n- Copy Technical Requirements from Architecture Definition\n- Create Assumptions and Constraints section\n- Create Non-Functional Requirements section\n- Create Monitoring and Observability section\n- Create Solution Validation section\n- Create Work Package Sequencing subsection\n\n### Phase 5: Validation and Polish (2-3 hours)\n- Validate against 6 checkpoints\n- Cross-reference ADRs, constraints, NFRs throughout document\n- Ensure Antora xrefs work correctly\n- Generate diagrams (Baseline integration diagram, Work Package Gantt)\n- Final review against Salesforce structure\n\n**Total Estimated Effort**: 21-28 hours\n\n## Risks and Mitigation\n\n| Risk | Mitigation |\n|------|-----------|\n| Content duplication between Architecture Definition and Solution Architecture | Architecture Definition remains source of truth for domain model; Solution Architecture focuses on implementation; cross-reference using Antora xrefs |\n| Loss of technical detail during restructuring | Preserve all existing technical content (Data Architecture, Interface Specifications); only reorganize subsections, don't delete |\n| ADR conversion time burden | Prioritize critical architectural decisions first; TBD decisions can have placeholder ADRs; use template for consistency |\n| NFR creation without baseline metrics | Extract NFR targets from existing Success Criteria, sequence diagrams, architecture decisions; mark as \"TBD\" where unknown; validate during TS-1 Foundation |\n| Document length increase | Target 5500-6000 lines (acceptable for comprehensive solution architecture); use tables for conciseness; reference detailed specs in separate documents |\n\n## Success Criteria\n\n- [ ] Document structure matches Salesforce pattern (14 sections)\n- [ ] Executive Summary passes Checkpoint 1 (executive-readable)\n- [ ] Technical Architecture passes Checkpoint 2 (Domain Architect-readable)\n- [ ] Non-Functional Requirements passes Checkpoint 3 (Senior Engineer-readable)\n- [ ] Monitoring and Observability passes Checkpoint 4 (Platform SRE-readable)\n- [ ] Solution Validation passes Checkpoint 5 (QA Lead-readable)\n- [ ] Work Package Sequencing passes Checkpoint 6 (Programme Lead-readable)\n- [ ] All technical strengths preserved (physical data models, API docs, correlation ID spec, interaction flows, transition architecture)\n- [ ] All Antora xrefs to Architecture Definition validated\n- [ ] Document length 5500-6500 lines (target range)\n- [ ] Formal ADRs created for all critical architectural decisions (10+ ADRs)\n\n## Next Steps\n\n1. **Review plan with Domain Architect** - validate approach, section mappings, ADR conversion strategy\n2. **Approve NFR targets** - validate NFR targets with technical team\n3. **Begin Phase 1** - create document outline, map existing content\n4. **Incremental validation** - validate each phase completion against checkpoints\n5. **Stakeholder review** - share restructured Executive Summary with business stakeholders before proceeding\n","numLines":306,"startLine":1,"totalLines":306}},"sourceToolAssistantUUID":"fa1f52aa-ebd1-4166-8331-7e30dc200d4a"}
{"parentUuid":"4bbd9674-279c-4259-8057-a1cac944028b","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01H3mqMqHQu1Y8kEo3M224aq","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"This is a very comprehensive restructuring plan. The estimate is 21-28 hours of work. That's quite substantial. Given the current context, I should ask the user if they want me to:\n\n1. Do the full restructuring now (which will take significant time and many tool calls)\n2. Do it in phases with checkpoints\n3. Focus on high-priority sections first\n\nActually, re-reading the user's response \"Yep\" to my question \"Would you like me to restructure the Flybuys solution architecture to match the Salesforce format?\", they seem to want me to proceed. But given this is 21-28 hours of estimated work, I should probably start and make good progress, but acknowledge this is a multi-session effort.\n\nLet me start with the most impactful changes first:\n1. Add Vision and Architectural Approach to Purpose and Scope\n2. Restructure Executive Summary3. Create Technical Architecture section with Baseline, Gap Analysis, and ADRs\n4. Add critical new sections (NFRs, Monitoring, Assumptions)\n\nI'll work systematically and make as much progress as possible.","signature":"ErMJCkYICxgCKkD4fCOKDRgavVLH6sJqdheDEo3m32f2iqc6wBvplQ4tbsiahW//hMu/Bb6hxtug5otxT586TTnalXvuE+j3ViLlEgy11gVmGww6fege144aDJmzXiL09vIop+29JiIwdx4hfGFZmdoJTVWaMaWdmy4vafI6YhOYAFrkyeoCdBC71fZJ3g9ggUNgKxhPojolKpoIy03Tt2EoRc+rRf6hQslG0/WDRJYX8/D8yfw/4nNHSiT7FZypjylZq4XRY2flFUjox4dyb3JRRLaQT1UQwTC4TcW9SDiTDPKiSAqG9jGgnIxlydIPojzuzWu+S9XZtq3650Ir6mjpre3qYAV4Z7ZGKrjt2azndh3LCzDPw5Ow2VXB39Hz5NnEBRWMMzRdTgp9+i//W1opIeBJuUM+IMl4SWDVWZpdTP7vnC/88EZJ0wDKPuOWFw3W6PkYAYrkIy0LqsX8Z8L8F/hSLpVG4zbom0HxGcaem2AJPqOl1sIWEmR7vKwnvqaLziujjiHvxW7SjwPmpiInNqtHc3E89fSI/GmkBo2SNoNtHUtDtu7HTPOLIf5fDPVp3+cPocDt2sOIzPk4tJYXOQ6h1WGjhQzYmd2me8r0ux7SkEgeWeXIH/zqFKjDrUAUkmO7Jsik4Q182ERD0jo7m9q5JMGe4CuvMuR6kneU4Unf8U/2zRkAnsm+zA5aPXN0OpcGf+4BN1Tzhumql1xWN4B4EnueBUabv4OHVEHYtYhYTsavolTREZIF+JfLCxfnl5d6cbXZxhNqMYgTv9v0/tAURXrt9tGkFH1pVIkGNCIb+bUb+vYJ7c/T7eRSBeIMf6nGozQhwnS4aX8BG8fXKlBw6Dto/RrMn+5yXABvgKQcozXDHtilxP8QhZrkCAn33XtWck/PoI8D81AUk/bQiMqRbRHT7Q9p8PhTE8WBOjjTP1ffxD2WiCYBb340vhS1HVUTJYxP4cDomrMzbdoS5K+cl/sNTF7PuNewlY1HnuU57ZSyJNRYlMJ8DBy5IeJIDT6m9JdL7XtzTxnJyEwMzcHOmNsvSMMZoIH3U+ZoXZdbS1cicdFgItRhAV9GycyKWL+WRchQKMiSqh+SqcivRJ3E6PFo6QCWQ5EbdMubsPXOOlud3VVgxcAiQxRT1Tc2xBtjGXUeG4I/90e/4IQTxFo2n2Q4KyfBzoq89vT2IC/20C7BNCrNn3ncXzfrYCu1RKd+ST1Z599W2Z9TJmbv9PF33NvCPa9QWyOIjtPgMLW8HDMgnzHsoDatUlCIqJDFEHigqcHxHEaR7NZJXMXQ7msliXparKGElfxX/O+drL5g1MLeXOPSx+1lnMI7iE0qaWP95ASSSgjfRBlLrJTZSmylnQQphxhsRsFlrsFR9/B7rqDc7ENIi9W7T6aBHVGiOhJm1jMFGkwtHTrnKp78G0e6EeL6tivus2sZItITPomRLxvz6Kr3bxQJDVVRJNsg1FGBuuBuVJaAwhEGx8TRFbLk15BLJE7etumL5ELjOjGmgpj3ZRWiChZ5vm1Sc7CGMjCpZwGuv8bEjomVrkmvEmUsCtz5FmYDzMF+/JELxLBnBavEq9kYi8JcFq/bYRM2qqCZGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":5003,"cache_read_input_tokens":104363,"cache_creation":{"ephemeral_5m_input_tokens":5003,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWwEBQ8gVr3dx6tGGfpRh","type":"assistant","uuid":"95d8dae1-bc5c-432a-80ae-6c480989f961","timestamp":"2026-01-09T05:10:21.890Z"}
{"parentUuid":"95d8dae1-bc5c-432a-80ae-6c480989f961","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01H3mqMqHQu1Y8kEo3M224aq","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01LPTNjeoxmW7DnE9qp5DL13","name":"TodoWrite","input":{"todos":[{"content":"Phase 1: Create new document structure outline","activeForm":"Creating structure outline","status":"in_progress"},{"content":"Phase 1: Map existing content to new sections","activeForm":"Mapping content","status":"pending"},{"content":"Phase 2: Add Vision and Architectural Approach","activeForm":"Adding vision and approach","status":"pending"},{"content":"Phase 2: Restructure Executive Summary","activeForm":"Restructuring executive summary","status":"pending"},{"content":"Phase 3: Create Technical Architecture section","activeForm":"Creating technical architecture","status":"pending"},{"content":"Phase 3: Extract Baseline Architecture from TS-0","activeForm":"Extracting baseline","status":"pending"},{"content":"Phase 3: Convert Key Tech Decisions to ADRs","activeForm":"Converting to ADRs","status":"pending"},{"content":"Phase 4: Add Non-Functional Requirements","activeForm":"Adding NFRs","status":"pending"},{"content":"Phase 4: Add Monitoring and Observability","activeForm":"Adding monitoring","status":"pending"},{"content":"Phase 4: Add Assumptions and Constraints","activeForm":"Adding assumptions","status":"pending"},{"content":"Phase 5: Validate and cross-reference","activeForm":"Validating document","status":"pending"},{"content":"Commit and push restructured document","activeForm":"Committing changes","status":"pending"}]}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":5003,"cache_read_input_tokens":104363,"cache_creation":{"ephemeral_5m_input_tokens":5003,"ephemeral_1h_input_tokens":0},"output_tokens":692,"service_tier":"standard"}},"requestId":"req_011CWwEBQ8gVr3dx6tGGfpRh","type":"assistant","uuid":"644f7ea3-b2e4-4ecc-822e-218e0d879836","timestamp":"2026-01-09T05:10:26.946Z"}
{"parentUuid":"644f7ea3-b2e4-4ecc-822e-218e0d879836","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01LPTNjeoxmW7DnE9qp5DL13","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"uuid":"66bb5a0a-559b-4831-8c50-bcec831c68c2","timestamp":"2026-01-09T05:10:27.007Z","toolUseResult":{"oldTodos":[{"content":"Read and analyze current Flybuys solution architecture","status":"in_progress","activeForm":"Reading Flybuys document"},{"content":"Create new structure outline based on Salesforce template","status":"pending","activeForm":"Creating structure outline"},{"content":"Add Vision and Architectural Approach sections","status":"pending","activeForm":"Adding vision and approach"},{"content":"Extract and restructure Executive Summary","status":"pending","activeForm":"Restructuring executive summary"},{"content":"Add Technical Requirements section","status":"pending","activeForm":"Adding technical requirements"},{"content":"Create Baseline Architecture section from TS-0","status":"pending","activeForm":"Creating baseline architecture"},{"content":"Convert Key Technology Decisions to formal ADRs","status":"pending","activeForm":"Converting to ADRs"},{"content":"Add Assumptions and Constraints section","status":"pending","activeForm":"Adding assumptions and constraints"},{"content":"Add Non-Functional Requirements section","status":"pending","activeForm":"Adding NFRs"},{"content":"Add Monitoring and Observability section","status":"pending","activeForm":"Adding monitoring section"},{"content":"Verify all content preserved and reorganized","status":"pending","activeForm":"Verifying content preservation"},{"content":"Test document structure and cross-references","status":"pending","activeForm":"Testing document"}],"newTodos":[{"content":"Phase 1: Create new document structure outline","status":"in_progress","activeForm":"Creating structure outline"},{"content":"Phase 1: Map existing content to new sections","status":"pending","activeForm":"Mapping content"},{"content":"Phase 2: Add Vision and Architectural Approach","status":"pending","activeForm":"Adding vision and approach"},{"content":"Phase 2: Restructure Executive Summary","status":"pending","activeForm":"Restructuring executive summary"},{"content":"Phase 3: Create Technical Architecture section","status":"pending","activeForm":"Creating technical architecture"},{"content":"Phase 3: Extract Baseline Architecture from TS-0","status":"pending","activeForm":"Extracting baseline"},{"content":"Phase 3: Convert Key Tech Decisions to ADRs","status":"pending","activeForm":"Converting to ADRs"},{"content":"Phase 4: Add Non-Functional Requirements","status":"pending","activeForm":"Adding NFRs"},{"content":"Phase 4: Add Monitoring and Observability","status":"pending","activeForm":"Adding monitoring"},{"content":"Phase 4: Add Assumptions and Constraints","status":"pending","activeForm":"Adding assumptions"},{"content":"Phase 5: Validate and cross-reference","status":"pending","activeForm":"Validating document"},{"content":"Commit and push restructured document","status":"pending","activeForm":"Committing changes"}]},"sourceToolAssistantUUID":"644f7ea3-b2e4-4ecc-822e-218e0d879836"}
{"parentUuid":"66bb5a0a-559b-4831-8c50-bcec831c68c2","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01L9PpbvFRyRdxXX56YRSf4Q","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Given the scope of this work (estimated 21-28 hours), I need to communicate to the user that this is a substantial restructuring effort. However, they said \"Yep\" which suggests they want me to proceed. Let me start the restructuring, but I'll need to work efficiently and may need to make this a multi-step effort with checkpoints.\n\nThe best approach is to:\n1. Start with high-priority sections that add the most value\n2. Work systematically through the phases\n3. Create the restructured document incrementally\n4. Commit progress at key milestones\n\nLet me begin by creating a backup and starting the restructuring. I'll communicate progress to the user as I go.\n\nActually, given the file size (5276 lines) and complexity, the most practical approach is to create a comprehensive restructuring in one go, working section by section. Let me start.","signature":"EvEHCkYICxgCKkA6VUrQHqA/hgvY3NEWCed2yetSPZCIi3AaSc2Gz8CjdbSkg8Y5NCJLhjxG/7UBWd3q0y7WT7BlRA2HLKwRbhyLEgyi7b2KXxs5/JJDgpQaDL86yH47na1PA/AsRyIwwgaVv3V7+HjIhH87GgiuwpnfeypV/WX+WAF+Ph/BZxYW6cEJPq9BUEVqwrTFZJUDKtgGFFSYv/WUvXBpGPV4BcxdUQFoBB9Wb83h8eA9Krna/kh4QJdvSN2OUIRKzN4hSrVgKzX1JifcoTwJC402gaNm605EKlS5DzMqzvK8zMGE+keQEu9C3tF9E0ghJc7YOYlkXuVqQ2SPgtiO9hOHy01+lMB/uU9ZU3VgTq10uDW+BQMHbNtapcHuSL42S3DvnkPyoJV4JD8EOouJuWPbcPj1rTw/pkTZpTDiCkCdJLhAmo/cI0wz0J3ZY+RYnzZinUHlCI76kgXvpk8/LTla4bbqv3Xjl5hBe+PVz+M1lgXQdZhuYAOYWu9+/L8QRX4v/SM8GlW7sbTzcI0P+h5ASQmp82OojWrbCHcNLLvj7cJtnKdasJ39KDU7aFDUf6NdVaj1hEBiABoqYFdq85SgRVS7TVeH+1cnem6/dUdaarHuv00da0DGjNK6ge4K8P0q4UBF8hGJSg2LMMyVRATnLIkDnO8ApltnuFVIWDEOM1vmfSSpK0XTMt2bhg7g1rFAVV4mthO1xQR5q9LgEl0bRIN3YPcEaLsw55yANaMgTTmwczjuhz1stE4Z/hiE3IrpAc8jJFPzHHNuLELRCbkmCxTd4LGfoh+QIlxbtpiCtyIh/s2SisiP2M3l9OGPF5Q/yYFIE35N8c+C064AIu9FYx+f27F+YCfO1kq7I6PoPRLg3Ug0xIfqKIcQ8CUoqiFojtFBKX5ewB89WmyG3t9Yha4GubRxqGMRDR+Y1eftztwnwij4xGB/yAdJw2ABZ8AO8S2rNMmYki3HUS5jI8g0FqZJ6ETOIXHrh14Pp0fW/ZvHVPSLiqCYAzfL7NcpSVAxrBYoem5w6Lv5a+tGyZIGBlGldXXXiteKiEokQQhK2HrMYTAp3acXqJjqms2xmdCDHzMZ8mkv6BxSgFEkICC53b+Vu6TI3jHXGeavsDQ0t7/LxQ3IeC/hN9WTUeilkehBLwkhNm3Tfw34xbDLuuH9msKD+XTPTRPCL/vOWeLVJCpc6qsZp6adLzV9jjgl+jkGA3PSjnBszt4mE2XpVnlsdP9TC/J0Z5Hy8J9/6BK/UaLTQNjyKz2HKvIHw70lPHF49J8QoVdaffAfq9SQstH/l3PesVOvbTrnzUl+lSgCpv83D//r5NzSvI66OhgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":738,"cache_read_input_tokens":109366,"cache_creation":{"ephemeral_5m_input_tokens":738,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWwECZmeK2iq85aprYbca","type":"assistant","uuid":"4181748f-310d-49f5-b848-c23f44c1dd0f","timestamp":"2026-01-09T05:10:34.808Z"}
{"parentUuid":"4181748f-310d-49f5-b848-c23f44c1dd0f","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01L9PpbvFRyRdxXX56YRSf4Q","type":"message","role":"assistant","content":[{"type":"text","text":"Excellent plan! This is a substantial restructuring (estimated 21-28 hours). I'll work through this systematically, starting with the highest-impact changes. Given the scope, I'll proceed with the restructuring and communicate key milestones.\n\nLet me begin by creating a backup and starting the restructuring:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":738,"cache_read_input_tokens":109366,"cache_creation":{"ephemeral_5m_input_tokens":738,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWwECZmeK2iq85aprYbca","type":"assistant","uuid":"9a02ecdc-b924-45c6-9256-41a9c9967835","timestamp":"2026-01-09T05:10:36.685Z"}
{"parentUuid":"9a02ecdc-b924-45c6-9256-41a9c9967835","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01L9PpbvFRyRdxXX56YRSf4Q","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_018qsT9GrA4iqqepMrFSh3U5","name":"Bash","input":{"command":"cp solution_architectures/flybuys_integration.adoc solution_architectures/flybuys_integration.adoc.backup && echo \"Backup created\"","description":"Create backup of Flybuys document"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":738,"cache_read_input_tokens":109366,"cache_creation":{"ephemeral_5m_input_tokens":738,"ephemeral_1h_input_tokens":0},"output_tokens":380,"service_tier":"standard"}},"requestId":"req_011CWwECZmeK2iq85aprYbca","type":"assistant","uuid":"62da385d-6f7e-48cb-82db-4ab3de7d7075","timestamp":"2026-01-09T05:10:37.921Z"}
{"parentUuid":"62da385d-6f7e-48cb-82db-4ab3de7d7075","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_018qsT9GrA4iqqepMrFSh3U5","type":"tool_result","content":"Backup created","is_error":false}]},"uuid":"cebcab33-9a3f-4c3b-b2e0-236060b34139","timestamp":"2026-01-09T05:10:38.158Z","toolUseResult":{"stdout":"Backup created","stderr":"","interrupted":false,"isImage":false},"sourceToolAssistantUUID":"62da385d-6f7e-48cb-82db-4ab3de7d7075"}
{"parentUuid":"cebcab33-9a3f-4c3b-b2e0-236060b34139","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01HvCvUTUR5PuE7yBso6F7jo","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Good, backup created. Now, given the size and complexity of this task, I should communicate to the user what I'm about to do, and then either:1. Work through it systematically in this session (which will use a lot of context/tokens)\n2. Create a new version incrementally\n3. Ask if they want me to do this in phases\n\nActually, given the \"Yep\" response, they want me to do it. But I should let them know this is a major undertaking and will take significant time. Let me start with the restructuring but communicate progress.\n\nThe most efficient way to do this given file size constraints is to use a Task agent specialized for this kind of large-scale refactoring. But actually, I don't have a specialized agent for document restructuring.The best approach is to work section by section, making edits to add/move/restructure content. Given the token limits and file size, I'll need to be strategic.Let me start with the most impactful sections first.","signature":"EtsICkYICxgCKkDoYFoe7Ch+RSmRR7z8wOh82g6fJyB7EIiVDazI46xDidaCf53W2a0lZyg2RaJ204G5zQTPefmy7v2XPqAfUfXOEgy/Gc+8ANAS+cNwDTgaDC6QwXRlr7IfYn/enyIwD2LGM8NBjxzy19+1V+ctyA5RfjPtg7Dw9yHrwtL9uLgMM+j6PFuG+77FRYCDTNNtKsIHPjfVJYTk1O+4ubk1Bwqj6v+RdGDeNhMJRFroHVFBeQryvUjf0A2fg4SuBWm+gClMMFp2t3GA2weHiSwSezfBig79IMkhxoygz5+OqOG1X0H1906rBX2Az3eWSQ/hrUJpY5I06IS9Q9Jmqx2YIaTIPdKme+CXRk/hp4jGnHnUTrUoVzSDrO7QgQH09y7REBMja2NwTAhpXD0gy+whIJBatKFdKzlQ5GZ1oyxVTMmBrVfqHXvb4lq0TegbDmUKwrveITQawl9VU9epGaFgYkb2aQPpoUTbJjg+Bhjfwqu8nRjG7R0myE/59u9w4M1qI/m/WHnIZlBFBHmJtFfWBv/pqxBcOTRnZd2Jd9IqGqX43YpWEteY38S+467gcE3S1eY4vHAf/YIAnGkiOsEb9QqPX6lyUYfQsB7TKR5kcM1eTtJhROw+9gBrisN3FJXYXZDi+efVYZB7tj+aKG3H+VlSUDpJ+tG1RjFltHQQuDT9OfYKMffmqvpk6r8+mX2xGLKOLRYMAgEMjDHNqLfgUxarAt6pFSav2MVGhvX3aAkrmBgtgFYM53Z/6lGfZBnQa62TxDYqj+7bQlW+hevxjZbWMB4GhdBbuQU50rZFkkaCWP0ipJq2qk1K5pwMtMkjv5ZjpLiNHVv2oiIBtGEjeBemrYJiyKE+8Sp0zWYxfUWQ9eqBmCOdA+Sn7tprqkkX7ui4XBBjDsMI28HG486turGNXeFibOYV4riNQn3c6CpXa4o3xjO5IMori4z7oZqggO11F6uzeDmrvgyNO0XBqV0CPBZg2eFD5g+9xW6ViQWhxBwxIq8Kjjqsnq9xjMu7CtBIa1/oTi1Yhban8t0k3gJEbMa5QGvik2TLUrWcSzpD43+Qj7Q/nyWGyN1hbK1Tqol/9vBCK5oivHGzx/kDj/cdaed5akoFHM9DOgJ1QhsRetivehvecsAV7S5aVSrvWvYVjDm+nVEGBzHk49w2u1C0Zc+EVHtIA5tegW6CAhZUMliHP9nCnzwZ34T7tvdvr1VYIZogIVYq9jrltGE1enqVnFqNZxatWjO92a0eppq0ZXITWB4s3wnZ6+nvhIav76ikEIydbcMqwF3EzLpI9XjWOtBGGQo17EKCDM6qXLBvloiRmKulrHTg+DNEi6FTesd4i6esRtugh2GXKOYUQB1O2ERopX/VMtyw0CebvU8LIUZiJLaZF3q0Nm6Khz3bmNGDER78+mHhz7KJTynxDae5HXGJc/XbAy8aAVgisV8QDBWQdZiV9fWv1lIOiLtH8Z3Y+QwYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":399,"cache_read_input_tokens":110104,"cache_creation":{"ephemeral_5m_input_tokens":399,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CWwEDPneqn7iNHVyU9UvA","type":"assistant","uuid":"5851a571-5542-4a02-9220-cba39676b3c8","timestamp":"2026-01-09T05:10:46.855Z"}
{"parentUuid":"5851a571-5542-4a02-9220-cba39676b3c8","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01HvCvUTUR5PuE7yBso6F7jo","type":"message","role":"assistant","content":[{"type":"text","text":"Given the scope of this restructuring (21-28 hours estimated), let me start with the highest-impact changes. I'll work systematically through the key sections.\n\n**Starting with Phase 1 & 2: Structure and High-Impact Sections**\n\nLet me begin by adding the Vision and Architectural Approach sections, then restructuring the Executive Summary:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":399,"cache_read_input_tokens":110104,"cache_creation":{"ephemeral_5m_input_tokens":399,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CWwEDPneqn7iNHVyU9UvA","type":"assistant","uuid":"e53effd3-1d6d-410a-af82-df86836fe9cf","timestamp":"2026-01-09T05:10:48.264Z"}
{"parentUuid":"e53effd3-1d6d-410a-af82-df86836fe9cf","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01HvCvUTUR5PuE7yBso6F7jo","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Ybu5pAs51thUMbXz3zh5JP","name":"Read","input":{"file_path":"/mnt/c/Users/o.young/work/architecture/architecture_definitions/flybuys_integration.adoc","offset":0,"limit":200}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":399,"cache_read_input_tokens":110104,"cache_creation":{"ephemeral_5m_input_tokens":399,"ephemeral_1h_input_tokens":0},"output_tokens":418,"service_tier":"standard"}},"requestId":"req_011CWwEDPneqn7iNHVyU9UvA","type":"assistant","uuid":"6f41a8b5-6ef7-4211-945c-396186463c5f","timestamp":"2026-01-09T05:10:49.630Z"}
{"parentUuid":"6f41a8b5-6ef7-4211-945c-396186463c5f","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Ybu5pAs51thUMbXz3zh5JP","type":"tool_result","content":"     0→= Flybuys Integration - Architecture Definition\n     1→:project-name: OTR-002\n     2→:togaf-adm-phase: Phase C: Information Systems Architectures\n     3→:document-type: Architecture Definition Document\n     4→:status: Discovery\n     5→:version: 0.1\n     6→:domain: Loyalty\n     7→:programme-lead: Frankie.Mullaly@vivaenergy.com.au\n     8→:domain-architect: O.Young@otr.com.au\n     9→:business-owner: D.Peisley@otr.com.au\n    10→:business-analyst: Fiona.Cheung@vivaenergy.com.au\n    11→:solution-architecture: link:/solution_architectures/flybuys_integration.adoc[Solution Architectures/Flybuys Integration]\n    12→:doctype: article\n    13→:toc: left\n    14→:toclevels: 4\n    15→:sectanchors:\n    16→:sectlinks:\n    17→:sectnums:\n    18→:icons: font\n    19→:source-highlighter: highlightjs\n    20→:experimental:\n    21→:description: Architecture Definition Document for Flybuys Coalition Loyalty Integration\n    22→:keywords: loyalty, flybuys, integration, architecture-definition, togaf, ddd\n    23→\n    24→== Introduction & Vision\n    25→\n    26→=== Purpose\n    27→\n    28→OTR and Reddy Express customers experience fragmented loyalty programmes across the OTRG store network. REXP stores use manual Flybuys batch processing, OTR stores offer native rewards, and no digital coalition partner linking exists. This limits customer choice, creates operational overhead, and constrains competitive positioning against national chains with integrated loyalty programmes.\n    29→\n    30→=== Vision\n    31→\n    32→> Enable customers to seamlessly link coalition loyalty partners via mobile app, select their reward preference, and earn partner points at any OTR/REXP store—while maintaining architectural flexibility to evolve OTR’s native loyalty capability independently.\n    33→\n    34→=== Architectural Approach\n    35→\n    36→This architecture introduces three bounded contexts (link:../bounded_context/profile.adoc[Profile Service], link:../bounded_context/loyalty.adoc[Loyalty Service], link:../bounded_context/engagement.adoc[Engagement Service]) implementing Domain-Driven Design patterns:\n    37→\n    38→* *link:../bounded_context/profile.adoc[Profile Service]*: Partner account linking (OAuth 2.0), reward preference management, canonical customer identity (VCI)\n    39→* *link:../bounded_context/loyalty.adoc[Loyalty Service]*: Transaction adjudication, credential resolution, partner integration facade, automated batch posting\n    40→* *link:../bounded_context/engagement.adoc[Engagement Service]*: Customer engagement campaigns, notification orchestration, Braze Anti-Corruption Layer\n    41→* *Event-driven integration*: Loose coupling via Event Bus with published domain events\n    42→* *Anti-Corruption Layers*: Isolation from external systems (link:../bounded_context/external/braze.adoc[Braze], link:../bounded_context/external/eagle_eye.adoc[EagleEye], link:../bounded_context/external/flybuys.adoc[Flybuys], link:../bounded_context/external/microsoft_dynamics_365_commerce.adoc[D365 Commerce])\n    43→* *Phased rollout*: Parallel deployment alongside legacy link:../bounded_context/interfaces/otr_app_api.adoc[OTR App API] with feature flag-controlled gradual enablement (link:#AS-1_Foundation[AS-1 Foundation] → link:#AS-2_Linking[AS-2 Linking] → link:#AS-3_Grants[AS-3 Grants]) The link:../bounded_context/profile.adoc[Profile Service] also serves as a facade for link:../bounded_context/interfaces/otr_pos.adoc[OTR POS] integration to link:../bounded_context/external/salesforce_crm.adoc[Salesforce CRM] before the #Highlander programme.\n    44→\n    45→=== Architecture Overview\n    46→\n    47→The following diagram shows the target state architecture with three new bounded contexts (Profile Service, Loyalty Service, Engagement Service) integrating with existing systems:\n    48→\n    49→[mermaid]\n    50→----\n    51→---\n    52→layout: elk\n    53→---\n    54→flowchart LR\n    55→    Customer([\"Customer\"]) -- Uses --> MobileApp[\"Mobile App<br>iOS/Android\"]\n    56→    Customer -- Shops at --> POS[\"OTR/OTR+ POS<br>D365 Commerce\"]\n    57→    Customer -- Receives --> EngagementService[\"Engagement Service<br>Campaign Triggers<br>Customer Notifications<br>Braze Integration\"]\n    58→    MobileApp -- Authenticate --> EntraID[\"Microsoft Entra<br>External ID<br>CIAM\"]\n    59→    MobileApp -- \"Link Partner Account<br>OAuth 2.0 + PKCE\" --> ProfileService[\"Profile Service<br>Partner Account Linking<br>Reward Preferences\"]\n    60→    MobileApp -- Get Partner Links<br>Update Preferences --> ProfileService\n    61→    MobileApp -- Query Flybuys Balance<br>via ACL --> LoyaltyService[\"Loyalty Service<br>Transaction Adjudication<br>Credential Resolution<br>Batch Processing\"]\n    62→    POS -- Scan Loyalty Credential<br>Resolve to VCI --> LoyaltyService\n    63→    POS -- \"Transaction Adjudication<br>Real-time &lt;500ms\" --> LoyaltyService\n    64→    ProfileService -- \"Store OAuth Tokens<br>AES-256 Encrypted\" --> OAuthService[\"OAuth Service<br>Token Management\"]\n    65→    ProfileService -- Query Customer Profile<br>Conformist --> Salesforce[\"Salesforce CRM<br>Customer Profile<br>System of Record\"]\n    66→    ProfileService -- Publish Events<br>PartnerLinked<br>RewardPreferenceChanged --> EventBus[(\"Event Bus<br>Domain Events\")]\n    67→    LoyaltyService -- Transaction Adjudication<br>via ACL --> EagleEye[\"EagleEye<br>Loyalty Engine<br>Points, Offers, Wallet\"]\n    68→    LoyaltyService -- Query Wallet/Points/Tiers<br>via ACL --> EagleEye\n    69→    LoyaltyService -- Nightly Batch SFTP<br>PGP Encrypted --> Flybuys[\"Flybuys<br>Coalition Partner<br>OAuth, SFTP\"]\n    70→    LoyaltyService -- OAuth Balance Query<br>via ACL --> Flybuys\n    71→    LoyaltyService -- Query Reward Preference<br>REST API --> ProfileService\n    72→    LoyaltyService -- Publish Events<br>TransactionAdjudicated<br>PointsEarned --> EventBus\n    73→    EngagementService -- Consume Events<br>PartnerLinked<br>TransactionAdjudicated<br>PointsEarned --> EventBus\n    74→    EngagementService -- Trigger Campaigns<br>Push Notifications<br>via ACL --> Braze[\"Braze<br>Marketing Automation<br>Webhooks\"]\n    75→    EngagementService -- Query Customer Profile<br>Conformist --> Salesforce\n    76→    OAuthService -- OAuth Token Exchange<br>Authorization Code Flow --> Flybuys\n    77→\n    78→     Customer:::customer\n    79→     MobileApp:::presentation\n    80→     POS:::presentation\n    81→     EngagementService:::newService\n    82→     EntraID:::external\n    83→     ProfileService:::newService\n    84→     LoyaltyService:::newService\n    85→     OAuthService:::infrastructure\n    86→     Salesforce:::external\n    87→     EventBus:::infrastructure\n    88→     EagleEye:::external\n    89→     Flybuys:::external\n    90→     Braze:::external\n    91→    classDef newService fill:#4CAF50,stroke:#2E7D32,stroke-width:3px,color:#fff\n    92→    classDef external fill:#FF9800,stroke:#E65100,stroke-width:2px,color:#fff\n    93→    classDef infrastructure fill:#2196F3,stroke:#0D47A1,stroke-width:2px,color:#fff\n    94→    classDef presentation fill:#9C27B0,stroke:#4A148C,stroke-width:2px,color:#fff\n    95→    classDef customer fill:#607D8B,stroke:#263238,stroke-width:2px,color:#fff\n    96→----\n    97→\n    98→==== Key Architectural Patterns\n    99→\n   100→[width=\"100%\",cols=\"19%,34%,47%\",options=\"header\",]\n   101→|===\n   102→|Pattern | Application | Rationale\n   103→|*Anti-Corruption Layer (ACL)* | LoyaltyService → EagleEye, FlybuysEngagementService → Braze | Isolates domain model from external system changes, translates between bounded contexts\n   104→|*Customer-Supplier + Conformist* | ProfileService → SalesforceEngagementService → Salesforce | We conform to Salesforce API (external system we don’t control)\n   105→|*Backend-for-Frontend (BFF)* | LoyaltyService | Orchestrates multiple backend systems (EagleEye, ProfileService) for POS/Mobile clients\n   106→|*Event-Driven Architecture* | Event Bus (OHS+PL) | Loose coupling between bounded contexts, asynchronous notification of domain events\n   107→|*Event Consumer* | EngagementService | Consumes domain events from Profile and Loyalty contexts to trigger customer campaigns\n   108→|*OAuth 2.0 + PKCE* | ProfileService → Flybuys | Secure partner account linking without storing passwords\n   109→|*Strangler Fig* | Parallel deployment with feature flags | Gradual migration to new bounded contexts\n   110→|===\n   111→\n   112→== Technical Requirements\n   113→\n   114→[width=\"100%\",cols=\"4%,96%\",options=\"header\",]\n   115→|===\n   116→|ID | Description\n   117→|TR-001 | Every link:../bounded_context/interfaces/mobile.adoc[Mobile Application] user has a link:../ubiquitous_language.adoc#Salesforce%2520Contact[Salesforce Contact] record in link:../bounded_context/external/salesforce_crm.adoc[Salesforce CRM]\n   118→|TR-002 | Every link:../bounded_context/interfaces/mobile.adoc[Mobile Application] user has a link:../ubiquitous_language.adoc#Viva%2520Consumer%2520ID[VCI] part of their link:../ubiquitous_language.adoc#Loyalty%2520Credential[Loyalty Credentials]\n   119→|TR-003 | Every link:../bounded_context/interfaces/mobile.adoc[Mobile Application] user has a link:../ubiquitous_language.adoc#Wallet[Loyalty Wallet] part of their link:../ubiquitous_language.adoc#Loyalty%2520Credential[Loyalty Credentials]\n   120→|TR-004 | link:../ubiquitous_language.adoc#Customer[Customers] have a single set of link:../ubiquitous_language.adoc#Loyalty%2520Credential[Loyalty Credentials]\n   121→|TR-005 | link:../ubiquitous_language.adoc#Customer[Customers] are able to link and unlink their link:../ubiquitous_language.adoc#Flybuys%2520Digital%2520Identity[Flybuys Digital Identity] from any link:../bounded_context/interfaces/mobile.adoc[Mobile Application]\n   122→|TR-006 | link:../ubiquitous_language.adoc#Customer[Customers] can manage their link:../ubiquitous_language.adoc#Reward%2520Preference[Reward Preference] (select and retain preference)\n   123→|TR-007 | link:../bounded_context/external/flybuys.adoc[Flybuys] link:../ubiquitous_language.adoc#Partner[Partner] transactions are posted to link:../bounded_context/external/flybuys.adoc[Flybuys] for points allocation to link:../ubiquitous_language.adoc#Flybuys%2520Earning%2520Rules[Earning Rules]\n   124→|TR-008 | link:../bounded_context/interfaces/otr_pos.adoc[OTR POS] stores recognise all link:../ubiquitous_language.adoc#Loyalty%2520Credential[Loyalty Credentials] and grant Flybuys Points on fulfilled Transactions where a Customer has a linked Flybuys Digital Identity\n   125→|TR-009 | link:../bounded_context/interfaces/otr_plus_pos.adoc[OTR+ POS] stores recognise all link:../ubiquitous_language.adoc#Loyalty%2520Credential[Loyalty Credentials] and grant Flybuys Points on fulfilled Transactions where a Customer has a linked Flybuys Digital Identity\n   126→|TR-010 | link:../ubiquitous_language.adoc#Customer[Customers] can retrieve their link:../bounded_context/external/flybuys.adoc[Flybuys] points balance in real-time within any link:../bounded_context/interfaces/mobile.adoc[Mobile Application]\n   127→|[line-through]*TR-011* |[line-through]*link:../bounded_context/external/flybuys.adoc[Flybuys] link:../ubiquitous_language.adoc#Digital%2520Fuel%2520Dockets[Digital Fuel Dockets] are redeemable at link:../bounded_context/interfaces/otr_pos.adoc[OTR POS] and link:../bounded_context/interfaces/otr_plus_pos.adoc[OTR+ POS]*\n   128→|TR-012 | All transactions by link:../ubiquitous_language.adoc#Loyalty%2520Credential[Credentialed] link:../ubiquitous_language.adoc#Customer[Customers] through any channel are adjudicated by link:../bounded_context/external/eagle_eye.adoc[EagleEye]\n   129→|TR-013 | Web and Mobile Clients geographically show which Loyalty programmes are available at each store\n   130→|TR-014 | All changes are communicated using a decoupled event-based architecture\n   131→|TR-015 | ==Reporting==\n   132→|TR-016 | ==Customer Service==\n   133→|===\n   134→\n   135→=== Technical Requirements Mapping\n   136→\n   137→[cols=\",\",options=\"header\",]\n   138→|===\n   139→|Business Requirement | Technical Requirement\n   140→|LNKHL_001 | TR-005\n   141→|LNKHL_002 | TR-005\n   142→|LNKHL_003 | TR-004\n   143→|LNKHL_004 | TR-005\n   144→|LNKHL_005 | TR-005\n   145→|LNKHL_006 | TR-014\n   146→|LNKHL_007 | TR-014\n   147→|LNKHL_008 | TR-014\n   148→|LNKHL_009 | TR-014\n   149→|NTWHL_001 | TR-012\n   150→|NTWHL_002 | TR-012\n   151→|NTWHL_003 | TR-013\n   152→|NTWHL_003 | TR-013\n   153→|PEHL_001 | TR-012\n   154→|PEHL_002 |\n   155→|PEHL_003 | TR-010\n   156→|PEHL_004 | TR-012\n   157→|INAHL_001 | TR-008 TR-009\n   158→|INAHL_002 | TR-008 TR-009\n   159→|INAHL_003 | TR-008 TR-009\n   160→|INAHL_004 | TR-008 TR-009\n   161→|INAHL_005 | TR-008 TR-009\n   162→|INAHL_006 | TR-008 TR-009\n   163→|INSHL_001 | TR-008 TR-009\n   164→|INSHL_002 | TR-014\n   165→|TCRHL_001 | TR-007\n   166→|TCRHL_002 | TR-015\n   167→|TCRHL_003 | TR-015\n   168→|TCRHL_004 | TR-015\n   169→|TCRHL_005 | TR-015\n   170→|TCRHL_006 | TR-015\n   171→|TCRHL_007 | TR-015\n   172→|CEHL_001 | TR-016\n   173→|CEHL_002 | TR-016\n   174→|CEHL_003 | TR-016\n   175→|===\n   176→\n   177→=== Stakeholder Analysis\n   178→\n   179→[width=\"100%\",cols=\"20%,28%,10%,11%,31%\",options=\"header\",]\n   180→|===\n   181→|Stakeholder | Role | Interest Level | Influence Level | Engagement Strategy\n   182→|Darren Peisley | Business Owner | High | High | Steering, requirements sign-off\n   183→|Amin Joderyi | Mobile Application and Ecommerce Lead | High | High |Collaboration\n   184→|Frankie Mullaly | Programme Lead | High | Medium | Status updates, escalation point\n   185→|Oli Young | Domain Architect | High | High | Collaboration, architecture decisions\n   186→|Fiona Cheung | Business Analyst | Medium | Medium | Requirements gathering, documentation\n   187→|David Le Pham | Product Owner | High | High | Product decisions, prioritisation\n   188→|Paola Buchan | Marketing & Campaigns Lead | High | Medium | Campaign planning, promotional strategy\n   189→|Nick Cannizzo | Project Manager | High | Low | Programme coordination\n   190→|Mobile App Users | End Users | High | Low | Beta testing programme, feedback surveys\n   191→|link:../bounded_context/external/flybuys.adoc[Flybuys] | External Partner |Medium | Medium | Coordination, API support\n   192→|link:../bounded_context/external/eagle_eye.adoc[EagleEye] | SaaS Loyalty Platform Vendor | Medium | Medium | Business reviews, support tickets\n   193→|D365 Team | POS Operations | Medium | Medium | Training sessions, operational readiness\n   194→|Customer Support Team | Support & Troubleshooting | Medium | Low |Training, escalation procedures\n   195→|Fullstack Team | CRM Integration | Low | Low | Integration coordination\n   196→|Platform Infrastructure | Cloud Platform | Low | High | Deployment planning, capacity planning\n   197→|Data Team | Data Integration | Low | Medium | Data pipeline coordination\n   198→|===\n   199→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"c7f35ede-56b7-447d-a86f-3ac7f116f3cc","timestamp":"2026-01-09T05:10:49.805Z","toolUseResult":{"type":"text","file":{"filePath":"/mnt/c/Users/o.young/work/architecture/architecture_definitions/flybuys_integration.adoc","content":"= Flybuys Integration - Architecture Definition\n:project-name: OTR-002\n:togaf-adm-phase: Phase C: Information Systems Architectures\n:document-type: Architecture Definition Document\n:status: Discovery\n:version: 0.1\n:domain: Loyalty\n:programme-lead: Frankie.Mullaly@vivaenergy.com.au\n:domain-architect: O.Young@otr.com.au\n:business-owner: D.Peisley@otr.com.au\n:business-analyst: Fiona.Cheung@vivaenergy.com.au\n:solution-architecture: link:/solution_architectures/flybuys_integration.adoc[Solution Architectures/Flybuys Integration]\n:doctype: article\n:toc: left\n:toclevels: 4\n:sectanchors:\n:sectlinks:\n:sectnums:\n:icons: font\n:source-highlighter: highlightjs\n:experimental:\n:description: Architecture Definition Document for Flybuys Coalition Loyalty Integration\n:keywords: loyalty, flybuys, integration, architecture-definition, togaf, ddd\n\n== Introduction & Vision\n\n=== Purpose\n\nOTR and Reddy Express customers experience fragmented loyalty programmes across the OTRG store network. REXP stores use manual Flybuys batch processing, OTR stores offer native rewards, and no digital coalition partner linking exists. This limits customer choice, creates operational overhead, and constrains competitive positioning against national chains with integrated loyalty programmes.\n\n=== Vision\n\n> Enable customers to seamlessly link coalition loyalty partners via mobile app, select their reward preference, and earn partner points at any OTR/REXP store—while maintaining architectural flexibility to evolve OTR’s native loyalty capability independently.\n\n=== Architectural Approach\n\nThis architecture introduces three bounded contexts (link:../bounded_context/profile.adoc[Profile Service], link:../bounded_context/loyalty.adoc[Loyalty Service], link:../bounded_context/engagement.adoc[Engagement Service]) implementing Domain-Driven Design patterns:\n\n* *link:../bounded_context/profile.adoc[Profile Service]*: Partner account linking (OAuth 2.0), reward preference management, canonical customer identity (VCI)\n* *link:../bounded_context/loyalty.adoc[Loyalty Service]*: Transaction adjudication, credential resolution, partner integration facade, automated batch posting\n* *link:../bounded_context/engagement.adoc[Engagement Service]*: Customer engagement campaigns, notification orchestration, Braze Anti-Corruption Layer\n* *Event-driven integration*: Loose coupling via Event Bus with published domain events\n* *Anti-Corruption Layers*: Isolation from external systems (link:../bounded_context/external/braze.adoc[Braze], link:../bounded_context/external/eagle_eye.adoc[EagleEye], link:../bounded_context/external/flybuys.adoc[Flybuys], link:../bounded_context/external/microsoft_dynamics_365_commerce.adoc[D365 Commerce])\n* *Phased rollout*: Parallel deployment alongside legacy link:../bounded_context/interfaces/otr_app_api.adoc[OTR App API] with feature flag-controlled gradual enablement (link:#AS-1_Foundation[AS-1 Foundation] → link:#AS-2_Linking[AS-2 Linking] → link:#AS-3_Grants[AS-3 Grants]) The link:../bounded_context/profile.adoc[Profile Service] also serves as a facade for link:../bounded_context/interfaces/otr_pos.adoc[OTR POS] integration to link:../bounded_context/external/salesforce_crm.adoc[Salesforce CRM] before the #Highlander programme.\n\n=== Architecture Overview\n\nThe following diagram shows the target state architecture with three new bounded contexts (Profile Service, Loyalty Service, Engagement Service) integrating with existing systems:\n\n[mermaid]\n----\n---\nlayout: elk\n---\nflowchart LR\n    Customer([\"Customer\"]) -- Uses --> MobileApp[\"Mobile App<br>iOS/Android\"]\n    Customer -- Shops at --> POS[\"OTR/OTR+ POS<br>D365 Commerce\"]\n    Customer -- Receives --> EngagementService[\"Engagement Service<br>Campaign Triggers<br>Customer Notifications<br>Braze Integration\"]\n    MobileApp -- Authenticate --> EntraID[\"Microsoft Entra<br>External ID<br>CIAM\"]\n    MobileApp -- \"Link Partner Account<br>OAuth 2.0 + PKCE\" --> ProfileService[\"Profile Service<br>Partner Account Linking<br>Reward Preferences\"]\n    MobileApp -- Get Partner Links<br>Update Preferences --> ProfileService\n    MobileApp -- Query Flybuys Balance<br>via ACL --> LoyaltyService[\"Loyalty Service<br>Transaction Adjudication<br>Credential Resolution<br>Batch Processing\"]\n    POS -- Scan Loyalty Credential<br>Resolve to VCI --> LoyaltyService\n    POS -- \"Transaction Adjudication<br>Real-time &lt;500ms\" --> LoyaltyService\n    ProfileService -- \"Store OAuth Tokens<br>AES-256 Encrypted\" --> OAuthService[\"OAuth Service<br>Token Management\"]\n    ProfileService -- Query Customer Profile<br>Conformist --> Salesforce[\"Salesforce CRM<br>Customer Profile<br>System of Record\"]\n    ProfileService -- Publish Events<br>PartnerLinked<br>RewardPreferenceChanged --> EventBus[(\"Event Bus<br>Domain Events\")]\n    LoyaltyService -- Transaction Adjudication<br>via ACL --> EagleEye[\"EagleEye<br>Loyalty Engine<br>Points, Offers, Wallet\"]\n    LoyaltyService -- Query Wallet/Points/Tiers<br>via ACL --> EagleEye\n    LoyaltyService -- Nightly Batch SFTP<br>PGP Encrypted --> Flybuys[\"Flybuys<br>Coalition Partner<br>OAuth, SFTP\"]\n    LoyaltyService -- OAuth Balance Query<br>via ACL --> Flybuys\n    LoyaltyService -- Query Reward Preference<br>REST API --> ProfileService\n    LoyaltyService -- Publish Events<br>TransactionAdjudicated<br>PointsEarned --> EventBus\n    EngagementService -- Consume Events<br>PartnerLinked<br>TransactionAdjudicated<br>PointsEarned --> EventBus\n    EngagementService -- Trigger Campaigns<br>Push Notifications<br>via ACL --> Braze[\"Braze<br>Marketing Automation<br>Webhooks\"]\n    EngagementService -- Query Customer Profile<br>Conformist --> Salesforce\n    OAuthService -- OAuth Token Exchange<br>Authorization Code Flow --> Flybuys\n\n     Customer:::customer\n     MobileApp:::presentation\n     POS:::presentation\n     EngagementService:::newService\n     EntraID:::external\n     ProfileService:::newService\n     LoyaltyService:::newService\n     OAuthService:::infrastructure\n     Salesforce:::external\n     EventBus:::infrastructure\n     EagleEye:::external\n     Flybuys:::external\n     Braze:::external\n    classDef newService fill:#4CAF50,stroke:#2E7D32,stroke-width:3px,color:#fff\n    classDef external fill:#FF9800,stroke:#E65100,stroke-width:2px,color:#fff\n    classDef infrastructure fill:#2196F3,stroke:#0D47A1,stroke-width:2px,color:#fff\n    classDef presentation fill:#9C27B0,stroke:#4A148C,stroke-width:2px,color:#fff\n    classDef customer fill:#607D8B,stroke:#263238,stroke-width:2px,color:#fff\n----\n\n==== Key Architectural Patterns\n\n[width=\"100%\",cols=\"19%,34%,47%\",options=\"header\",]\n|===\n|Pattern | Application | Rationale\n|*Anti-Corruption Layer (ACL)* | LoyaltyService → EagleEye, FlybuysEngagementService → Braze | Isolates domain model from external system changes, translates between bounded contexts\n|*Customer-Supplier + Conformist* | ProfileService → SalesforceEngagementService → Salesforce | We conform to Salesforce API (external system we don’t control)\n|*Backend-for-Frontend (BFF)* | LoyaltyService | Orchestrates multiple backend systems (EagleEye, ProfileService) for POS/Mobile clients\n|*Event-Driven Architecture* | Event Bus (OHS+PL) | Loose coupling between bounded contexts, asynchronous notification of domain events\n|*Event Consumer* | EngagementService | Consumes domain events from Profile and Loyalty contexts to trigger customer campaigns\n|*OAuth 2.0 + PKCE* | ProfileService → Flybuys | Secure partner account linking without storing passwords\n|*Strangler Fig* | Parallel deployment with feature flags | Gradual migration to new bounded contexts\n|===\n\n== Technical Requirements\n\n[width=\"100%\",cols=\"4%,96%\",options=\"header\",]\n|===\n|ID | Description\n|TR-001 | Every link:../bounded_context/interfaces/mobile.adoc[Mobile Application] user has a link:../ubiquitous_language.adoc#Salesforce%2520Contact[Salesforce Contact] record in link:../bounded_context/external/salesforce_crm.adoc[Salesforce CRM]\n|TR-002 | Every link:../bounded_context/interfaces/mobile.adoc[Mobile Application] user has a link:../ubiquitous_language.adoc#Viva%2520Consumer%2520ID[VCI] part of their link:../ubiquitous_language.adoc#Loyalty%2520Credential[Loyalty Credentials]\n|TR-003 | Every link:../bounded_context/interfaces/mobile.adoc[Mobile Application] user has a link:../ubiquitous_language.adoc#Wallet[Loyalty Wallet] part of their link:../ubiquitous_language.adoc#Loyalty%2520Credential[Loyalty Credentials]\n|TR-004 | link:../ubiquitous_language.adoc#Customer[Customers] have a single set of link:../ubiquitous_language.adoc#Loyalty%2520Credential[Loyalty Credentials]\n|TR-005 | link:../ubiquitous_language.adoc#Customer[Customers] are able to link and unlink their link:../ubiquitous_language.adoc#Flybuys%2520Digital%2520Identity[Flybuys Digital Identity] from any link:../bounded_context/interfaces/mobile.adoc[Mobile Application]\n|TR-006 | link:../ubiquitous_language.adoc#Customer[Customers] can manage their link:../ubiquitous_language.adoc#Reward%2520Preference[Reward Preference] (select and retain preference)\n|TR-007 | link:../bounded_context/external/flybuys.adoc[Flybuys] link:../ubiquitous_language.adoc#Partner[Partner] transactions are posted to link:../bounded_context/external/flybuys.adoc[Flybuys] for points allocation to link:../ubiquitous_language.adoc#Flybuys%2520Earning%2520Rules[Earning Rules]\n|TR-008 | link:../bounded_context/interfaces/otr_pos.adoc[OTR POS] stores recognise all link:../ubiquitous_language.adoc#Loyalty%2520Credential[Loyalty Credentials] and grant Flybuys Points on fulfilled Transactions where a Customer has a linked Flybuys Digital Identity\n|TR-009 | link:../bounded_context/interfaces/otr_plus_pos.adoc[OTR+ POS] stores recognise all link:../ubiquitous_language.adoc#Loyalty%2520Credential[Loyalty Credentials] and grant Flybuys Points on fulfilled Transactions where a Customer has a linked Flybuys Digital Identity\n|TR-010 | link:../ubiquitous_language.adoc#Customer[Customers] can retrieve their link:../bounded_context/external/flybuys.adoc[Flybuys] points balance in real-time within any link:../bounded_context/interfaces/mobile.adoc[Mobile Application]\n|[line-through]*TR-011* |[line-through]*link:../bounded_context/external/flybuys.adoc[Flybuys] link:../ubiquitous_language.adoc#Digital%2520Fuel%2520Dockets[Digital Fuel Dockets] are redeemable at link:../bounded_context/interfaces/otr_pos.adoc[OTR POS] and link:../bounded_context/interfaces/otr_plus_pos.adoc[OTR+ POS]*\n|TR-012 | All transactions by link:../ubiquitous_language.adoc#Loyalty%2520Credential[Credentialed] link:../ubiquitous_language.adoc#Customer[Customers] through any channel are adjudicated by link:../bounded_context/external/eagle_eye.adoc[EagleEye]\n|TR-013 | Web and Mobile Clients geographically show which Loyalty programmes are available at each store\n|TR-014 | All changes are communicated using a decoupled event-based architecture\n|TR-015 | ==Reporting==\n|TR-016 | ==Customer Service==\n|===\n\n=== Technical Requirements Mapping\n\n[cols=\",\",options=\"header\",]\n|===\n|Business Requirement | Technical Requirement\n|LNKHL_001 | TR-005\n|LNKHL_002 | TR-005\n|LNKHL_003 | TR-004\n|LNKHL_004 | TR-005\n|LNKHL_005 | TR-005\n|LNKHL_006 | TR-014\n|LNKHL_007 | TR-014\n|LNKHL_008 | TR-014\n|LNKHL_009 | TR-014\n|NTWHL_001 | TR-012\n|NTWHL_002 | TR-012\n|NTWHL_003 | TR-013\n|NTWHL_003 | TR-013\n|PEHL_001 | TR-012\n|PEHL_002 |\n|PEHL_003 | TR-010\n|PEHL_004 | TR-012\n|INAHL_001 | TR-008 TR-009\n|INAHL_002 | TR-008 TR-009\n|INAHL_003 | TR-008 TR-009\n|INAHL_004 | TR-008 TR-009\n|INAHL_005 | TR-008 TR-009\n|INAHL_006 | TR-008 TR-009\n|INSHL_001 | TR-008 TR-009\n|INSHL_002 | TR-014\n|TCRHL_001 | TR-007\n|TCRHL_002 | TR-015\n|TCRHL_003 | TR-015\n|TCRHL_004 | TR-015\n|TCRHL_005 | TR-015\n|TCRHL_006 | TR-015\n|TCRHL_007 | TR-015\n|CEHL_001 | TR-016\n|CEHL_002 | TR-016\n|CEHL_003 | TR-016\n|===\n\n=== Stakeholder Analysis\n\n[width=\"100%\",cols=\"20%,28%,10%,11%,31%\",options=\"header\",]\n|===\n|Stakeholder | Role | Interest Level | Influence Level | Engagement Strategy\n|Darren Peisley | Business Owner | High | High | Steering, requirements sign-off\n|Amin Joderyi | Mobile Application and Ecommerce Lead | High | High |Collaboration\n|Frankie Mullaly | Programme Lead | High | Medium | Status updates, escalation point\n|Oli Young | Domain Architect | High | High | Collaboration, architecture decisions\n|Fiona Cheung | Business Analyst | Medium | Medium | Requirements gathering, documentation\n|David Le Pham | Product Owner | High | High | Product decisions, prioritisation\n|Paola Buchan | Marketing & Campaigns Lead | High | Medium | Campaign planning, promotional strategy\n|Nick Cannizzo | Project Manager | High | Low | Programme coordination\n|Mobile App Users | End Users | High | Low | Beta testing programme, feedback surveys\n|link:../bounded_context/external/flybuys.adoc[Flybuys] | External Partner |Medium | Medium | Coordination, API support\n|link:../bounded_context/external/eagle_eye.adoc[EagleEye] | SaaS Loyalty Platform Vendor | Medium | Medium | Business reviews, support tickets\n|D365 Team | POS Operations | Medium | Medium | Training sessions, operational readiness\n|Customer Support Team | Support & Troubleshooting | Medium | Low |Training, escalation procedures\n|Fullstack Team | CRM Integration | Low | Low | Integration coordination\n|Platform Infrastructure | Cloud Platform | Low | High | Deployment planning, capacity planning\n|Data Team | Data Integration | Low | Medium | Data pipeline coordination\n|===\n","numLines":200,"startLine":0,"totalLines":2722}},"sourceToolAssistantUUID":"6f41a8b5-6ef7-4211-945c-396186463c5f"}
{"parentUuid":"c7f35ede-56b7-447d-a86f-3ac7f116f3cc","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01Vrc3ms26LjtuQHvfMXnRFg","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Perfect, I've read the Vision, Architectural Approach, and Architecture Overview from the Architecture Definition document. I also have the Technical Requirements section. Now I need to insert these into the Flybuys Solution Architecture document.\n\nGiven the complexity and size of this task, let me work section by section. I'll start with adding the Vision and Architectural Approach sections after the Purpose section in the Flybuys Solution Architecture.\n\nHowever, given how large this restructuring is (21-28 hours estimated), and that I'm already at 104K tokens used out of 200K, I should be strategic. Let me focus on the absolutely critical sections that will make the biggest impact:\n\n1. Add Vision and Architectural Approach\n2. Restructure Executive Summary \n3. Add a comprehensive Technical Architecture section with ADRs\n\nThen I can commit that progress and continue in future sessions if needed. Let me proceed with these high-priority items.","signature":"Et0ICkYICxgCKkClH4pdIhKftlmAf5KotzTKkB6z1g++hT2ZamGISk5QAC5QUgKOvouH7kjqW5XAl+tmTiMTnLVVOtBmb9QgXXHEEgyKJURh1pplSqQd09MaDK2Pk4g5aoJpbvEYKSIwQGHiVBSesitGCvfMnky9aJRRmrvnVHpdvvV5FtbCrzNx2QugNXHXtU/3/BNojdKbKsQHW5d1yXrb466KqgPoRB2tGtNCjfTIqgQiPVTbQQjGdfwZ5z854IX9RiQ7Y+N1A6xChnlmO2Xuj3PmKhAoteorCEsvxUN3hmrjws4LSF/8PIESXZ6kJYXFhsxdcN1/MqWvvkQb0A9v8QCayogMTapt7p8/sizMqTs+FixCsK32ReJuEtl2h2ulIPoiyh5HHkbUgMFpRtar2aE0gM63EROOV34+HwORDX+cNZ45rncYT17G9sllxCS5wkeQoXDxW8LlyTzXvWVEop7lzcqdvFhhu0QZQcUgytPjNSTIYTos3RCc996kEIEXNoGpYjDboKBajM8yCRyZ3JE2u+nnPWBVN5hD264XBRr2RD2fkerg4+R2DyJyxBDCCEtl0tvRQBidHW6FS15h8wvIq2eI0JrhEFmhwoWt27uvXhkhj9w/sT5DBB53Pv+KKlFoSLY1o9G0M4k7vOPOAM+BANjpPoSVwrDHQIpk6iWLwnnOKsdndb8RUxon6DxrKKw+ozlRsBhcLjihkgOljOIpgdLC09V7DDty8B+xfSChWG/acEL96AQWW6+YvU5ChyjHSSCOmBJN9TYQnKYKsAt2qSbl/WDQ6h6MPbN5i1ADGy/olH14Oxh6D6v/IvK1uMwyCsXbVDz+TtSLp27XVyeaGck2zoySMPFWLaHWAxjNJ7tWJhMDNyBabGaZQ21e6BlMBBnGbcEOev8QNNXnXb1Oh1ngnrZfDxE34pkNq+D8jYcOIQiSPZEGoe5v19wSxqM81PiJ4LlaABbicb/4cXzErBB9Znhe6yA9wLl/88AelsTrIEGIiy+L54RewFhPhS1KKXCJaHXI28dfoyit6huYI6LKSrE47GbxjStrjR2zL0XQ3RZAwcuxnHWUMeCWrIt24omuHj2oBNe47QlFNSHA0l9sstlmnnHpOpJJW1AhgkW9MbDB3Y+5b0XnxygLaw6WY9R3o5sZ+X+JGfsihpn8nwGnaRaWxisclpBUxhFYPe8ooHLSAVS5f22dBUTIIpMHM1ZZr6mJVYByGF9tV8PfyA9y6PXCmXKMsY0WypE5f9UtvhIyK0NXLScg/T089QorkIx1FzZKSikhGoZaWT92YtL4iPX/OcK4iKPu9lHb2f9AEPc21p0VQMQTmIyBLBIDhyuAabur5QIWjphWOK0l0Q+32oIVBAtO0586OF9hsLBvkpu8y0qxF2AStNqWC5GhMWe87lUwP12P4DXVm8xmjvwuo0dFWDHZZGRDj7cq/sCMDsjkthdcOi1WDA2vo1wIv/VY149Oe70viRgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":5396,"cache_read_input_tokens":110503,"cache_creation":{"ephemeral_5m_input_tokens":5396,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWwEEFDVNDYxDKayMsQtC","type":"assistant","uuid":"068907fe-c3b6-4359-b3c2-7023c97f4656","timestamp":"2026-01-09T05:10:58.657Z"}
{"parentUuid":"068907fe-c3b6-4359-b3c2-7023c97f4656","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01Vrc3ms26LjtuQHvfMXnRFg","type":"message","role":"assistant","content":[{"type":"text","text":"Now I'll begin the restructuring, starting with the highest-impact sections. Given the scope (21-28 hours), I'll focus on critical structural improvements first and can continue in follow-up iterations if needed.\n\n**Phase 1: Adding Vision and Architectural Approach to Purpose and Scope**"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":5396,"cache_read_input_tokens":110503,"cache_creation":{"ephemeral_5m_input_tokens":5396,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWwEEFDVNDYxDKayMsQtC","type":"assistant","uuid":"2e876fd3-f2b8-4707-a798-91ef199682ac","timestamp":"2026-01-09T05:11:00.445Z"}
{"parentUuid":"2e876fd3-f2b8-4707-a798-91ef199682ac","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01Vrc3ms26LjtuQHvfMXnRFg","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01ShSYRmr9NLK5o4KBAyJKe8","name":"Edit","input":{"replace_all":false,"file_path":"/mnt/c/Users/o.young/work/architecture/solution_architectures/flybuys_integration.adoc","old_string":"=== Purpose\n\nThis Solution Architecture defines how the Flybuys Integration will be implemented - the specific technology products, configurations, interfaces, and deployment architecture that realise the xref:architecture-definitions:flybuys_integration.adoc[Flybuys Integration].\n\n<<<\n=== Scope","new_string":"=== Purpose\n\nThis Solution Architecture defines how the Flybuys Integration will be implemented - the specific technology products, configurations, interfaces, and deployment architecture that realise the xref:architecture-definitions:flybuys_integration.adoc[Flybuys Integration].\n\n=== Vision\n\nOTR and Reddy Express customers experience fragmented loyalty programmes across the OTRG store network. REXP stores use manual Flybuys batch processing, OTR stores offer native rewards, and no digital coalition partner linking exists. This limits customer choice, creates operational overhead, and constrains competitive positioning against national chains with integrated loyalty programmes.\n\n> Enable customers to seamlessly link coalition loyalty partners via mobile app, select their reward preference, and earn partner points at any OTR/REXP store—while maintaining architectural flexibility to evolve OTR's native loyalty capability independently.\n\n=== Architectural Approach\n\nThis architecture introduces three bounded contexts (xref:bounded-contexts:profile.adoc[Profile Service], xref:bounded-contexts:loyalty.adoc[Loyalty Service], xref:bounded-contexts:engagement.adoc[Engagement Service]) implementing Domain-Driven Design patterns:\n\n* *xref:bounded-contexts:profile.adoc[Profile Service]*: Partner account linking (OAuth 2.0), reward preference management, canonical customer identity (VCI)\n* *xref:bounded-contexts:loyalty.adoc[Loyalty Service]*: Transaction adjudication, credential resolution, partner integration facade, automated batch posting\n* *xref:bounded-contexts:engagement.adoc[Engagement Service]*: Customer engagement campaigns, notification orchestration, Braze Anti-Corruption Layer\n* *Event-driven integration*: Loose coupling via Event Bus with published domain events\n* *Anti-Corruption Layers*: Isolation from external systems (xref:bounded-contexts:braze.adoc[Braze], xref:bounded-contexts:eagle_eye.adoc[EagleEye], xref:bounded-contexts:flybuys.adoc[Flybuys], xref:bounded-contexts:microsoft_dynamics_365_commerce.adoc[D365 Commerce])\n* *Phased rollout*: Parallel deployment alongside legacy xref:bounded-contexts:otr_app_api.adoc[OTR App API] with feature flag-controlled gradual enablement\n\nNOTE: xref:bounded-contexts:profile.adoc[Profile Service] also serves xref:initiatives:salesforce_customer_support.adoc[OTR-001 Salesforce Customer Support] initiative for Just-In-Time Contact reconciliation with Salesforce Service Cloud.\n\n<<<\n=== Scope"}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":5396,"cache_read_input_tokens":110503,"cache_creation":{"ephemeral_5m_input_tokens":5396,"ephemeral_1h_input_tokens":0},"output_tokens":1075,"service_tier":"standard"}},"requestId":"req_011CWwEEFDVNDYxDKayMsQtC","type":"assistant","uuid":"b8610c3b-2558-4a2e-ba0d-9c08d13cde01","timestamp":"2026-01-09T05:11:17.239Z"}
{"parentUuid":"b8610c3b-2558-4a2e-ba0d-9c08d13cde01","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"type":"tool_result","content":"<tool_use_error>File has not been read yet. Read it first before writing to it.</tool_use_error>","is_error":true,"tool_use_id":"toolu_01ShSYRmr9NLK5o4KBAyJKe8"}]},"uuid":"844d7cf7-f39b-4890-8f0c-37545985f83b","timestamp":"2026-01-09T05:11:17.279Z","toolUseResult":"Error: File has not been read yet. Read it first before writing to it.","sourceToolAssistantUUID":"b8610c3b-2558-4a2e-ba0d-9c08d13cde01"}
{"parentUuid":"844d7cf7-f39b-4890-8f0c-37545985f83b","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01EHXMXydwc9wpJhjkh3w3vA","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Right, I need to read the file first before editing it. Let me read the section I want to edit.","signature":"EocCCkYICxgCKkBN6dZEmqZbO7FtTqXgyBWAD+kgXK8TDMEB0ieWeOsg0zOAdXvUoAm8JCYqnv6k2P4FOPxYx4y+mL/G/ygOxbSSEgxOgsBc25lUrVLiy6gaDAl6ky3glXcjEArXQCIwiCfX7v22oALrnZR40oVYGJTsZH5bWTsEPlD3ypmyqvKpH5S24C9xmDmAsFcOhWAuKm+ZMqzVR3RS8G+ZjkpXphAfddSz6vJ4SyEyVyw92Ir9WxHv25t5Vn/pn77Z2YuB4QatSs4wG4P2lULHmetPdtLNYgSsNNzJdHWfuzCHScdZgVCieBKacpeHHFSp1o4qaCcMFG+CCE2WD+3rmZ/TQKcYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":1123,"cache_read_input_tokens":115899,"cache_creation":{"ephemeral_5m_input_tokens":1123,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWwEGHBrkx88aMP6ijeKv","type":"assistant","uuid":"2f5f48ce-84fe-4498-93b7-fd0146a6155d","timestamp":"2026-01-09T05:11:21.788Z"}
{"parentUuid":"2f5f48ce-84fe-4498-93b7-fd0146a6155d","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01EHXMXydwc9wpJhjkh3w3vA","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Qynxk3E5b4tnxXGw1NzANR","name":"Read","input":{"file_path":"/mnt/c/Users/o.young/work/architecture/solution_architectures/flybuys_integration.adoc","offset":25,"limit":40}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":1123,"cache_read_input_tokens":115899,"cache_creation":{"ephemeral_5m_input_tokens":1123,"ephemeral_1h_input_tokens":0},"output_tokens":146,"service_tier":"standard"}},"requestId":"req_011CWwEGHBrkx88aMP6ijeKv","type":"assistant","uuid":"78135b79-d5b7-4695-8248-137532480440","timestamp":"2026-01-09T05:11:22.433Z"}
{"parentUuid":"78135b79-d5b7-4695-8248-137532480440","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"c0394f79-edf2-458f-ac85-c72efa8db83c","version":"2.1.2","gitBranch":"main","slug":"lively-soaring-glacier","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Qynxk3E5b4tnxXGw1NzANR","type":"tool_result","content":"    25→\n    26→== Purpose and Scope\n    27→\n    28→=== Purpose\n    29→\n    30→This Solution Architecture defines how the Flybuys Integration will be implemented - the specific technology products, configurations, interfaces, and deployment architecture that realise the xref:architecture-definitions:flybuys_integration.adoc[Flybuys Integration].\n    31→\n    32→<<<\n    33→=== Scope\n    34→\n    35→==== In Scope\n    36→\n    37→* Solution Building Blocks (SBBs) - specific technology products and versions\n    38→* Interface specifications (APIs, events, data formats)\n    39→* Data architecture and schema specifications\n    40→* Transition architecture with phased implementation states\n    41→* Technical validation criteria and testing approach\n    42→* External system integration specifications\n    43→\n    44→==== Out of Scope\n    45→\n    46→===== Covered in xref:architecture-definitions:flybuys_integration.adoc[Architecture Definition]\n    47→\n    48→* Business requirements and stakeholder analysis\n    49→* Architecture decisions and rationale\n    50→* Bounded context definitions and responsibilities\n    51→* High-level integration patterns (ACL, Conformist, OHS+PL)\n    52→* Business capability mapping and value streams\n    53→* Non-functional requirements (referenced, not duplicated)\n    54→* Architecture principles and governance\n    55→\n    56→===== Covered in other documents\n    57→\n    58→* Detailed design (class diagrams, sequence diagrams for all flows)\n    59→* Implementation code and unit tests\n    60→* Business case and return-on-investment analysis\n    61→* Operational run books and support procedures\n    62→\n    63→<<<\n    64→== Executive Summary\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"2411d25a-85ea-4fca-9966-f32e59d0cf49","timestamp":"2026-01-09T05:11:22.635Z","toolUseResult":{"type":"text","file":{"filePath":"/mnt/c/Users/o.young/work/architecture/solution_architectures/flybuys_integration.adoc","content":"\n== Purpose and Scope\n\n=== Purpose\n\nThis Solution Architecture defines how the Flybuys Integration will be implemented - the specific technology products, configurations, interfaces, and deployment architecture that realise the xref:architecture-definitions:flybuys_integration.adoc[Flybuys Integration].\n\n<<<\n=== Scope\n\n==== In Scope\n\n* Solution Building Blocks (SBBs) - specific technology products and versions\n* Interface specifications (APIs, events, data formats)\n* Data architecture and schema specifications\n* Transition architecture with phased implementation states\n* Technical validation criteria and testing approach\n* External system integration specifications\n\n==== Out of Scope\n\n===== Covered in xref:architecture-definitions:flybuys_integration.adoc[Architecture Definition]\n\n* Business requirements and stakeholder analysis\n* Architecture decisions and rationale\n* Bounded context definitions and responsibilities\n* High-level integration patterns (ACL, Conformist, OHS+PL)\n* Business capability mapping and value streams\n* Non-functional requirements (referenced, not duplicated)\n* Architecture principles and governance\n\n===== Covered in other documents\n\n* Detailed design (class diagrams, sequence diagrams for all flows)\n* Implementation code and unit tests\n* Business case and return-on-investment analysis\n* Operational run books and support procedures\n\n<<<\n== Executive Summary","numLines":40,"startLine":25,"totalLines":5277}},"sourceToolAssistantUUID":"78135b79-d5b7-4695-8248-137532480440"}
{"type":"summary","summary":"Flybuys Solution Architecture Restructure","leafUuid":"2411d25a-85ea-4fca-9966-f32e59d0cf49"}
