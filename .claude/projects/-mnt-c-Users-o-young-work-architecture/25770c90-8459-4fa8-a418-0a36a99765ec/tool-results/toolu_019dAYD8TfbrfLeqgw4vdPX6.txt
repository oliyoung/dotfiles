     1→import "../../domains/transaction.cml"
     2→
     3→/*
     4→ * Microsoft Dynamics 365 Commerce - External System
     5→ * ==================================================
     6→ *
     7→ * Unified commerce platform serving as the transaction system of record for all
     8→ * VER retail channels (OTR, Reddy Express, Smokemart & GiftBox).
     9→ *
    10→ * Deployment Models:
    11→ * ------------------
    12→ * 1. **Commerce Scale Unit (CSU)** - In-store/forecourt POS terminals
    13→ *    - Deployed across 1000+ retail locations
    14→ *    - Handles fuel pump integration and in-store transactions
    15→ *    - Synchronizes with D365 Commerce HQ
    16→ *
    17→ * 2. **Cloud Commerce** - Web e-commerce platform
    18→ *    - Hosted cloud APIs for web applications
    19→ *    - Product catalog, cart, and checkout services
    20→ *
    21→ * 3. **Transaction Repository** - Mobile backend integration
    22→ *    - Mobile backend services write transactions to D365 Commerce
    23→ *    - Ensures single source of truth across all channels
    24→ *
    25→ * Domain Coverage (All Channels):
    26→ * --------------------------------
    27→ * - Transaction processing and basket management
    28→ * - Product catalog and inventory management
    29→ * - Payment processing and reconciliation
    30→ * - Receipt generation and storage
    31→ * - Order management and fulfilment
    32→ * - Promotions and discounts
    33→ * - Customer order history
    34→ *
    35→ * Integration Points:
    36→ * -------------------
    37→ * - Publishes TransactionCompleted, TransactionRefunded, TransactionVoided events
    38→ * - Events published to Event Bus topic: "transaction-events"
    39→ * - Consumed by: LoyaltyService (reward adjudication), EngagementService (campaigns),
    40→ *   RecommendationService (purchase history), EDP (analytics)
    41→ * - Same event schema across all channels (POS, web, mobile)
    42→ * - TransactionSource attribute distinguishes channel: POS | MOBILE_APP | WEB
    43→ *
    44→ * System Architecture:
    45→ * --------------------
    46→ * - Authoritative source for all transaction data across channels
    47→ * - Event publishing to Event Bus for downstream consumption
    48→ * - Integration with DataMesh payment gateway and fuel dispensers
    49→ * - Synchronization between CSU (edge) and HQ (cloud)
    50→ */
    51→
    52→BoundedContext D365Commerce implements TransactionDomain {
    53→
    54→    type = SYSTEM
    55→    domainVisionStatement = "Unified commerce platform managing transactions, products, and orders across all retail channels (POS, web, mobile)"
    56→
    57→    responsibilities = "Transaction processing (all channels)",
    58→                      "Product catalog management",
    59→                      "Basket and order management",
    60→                      "Payment coordination",
    61→                      "Receipt generation",
    62→                      "Inventory tracking",
    63→                      "Promotions and discounts",
    64→                      "Customer order history"
    65→
    66→    implementationTechnology = "Microsoft Dynamics 365 Commerce (CSU + Cloud), Event Bus (event publishing)"
    67→
    68→    // ========================================================================
    69→    // DOMAIN EVENTS PUBLISHED
    70→    // ========================================================================
    71→    // D365 Commerce publishes events to Event Bus for consumption by
    72→    // other bounded contexts. These events follow OTR's Published Language
    73→    // and are channel-agnostic (same schema for POS, web, mobile).
    74→    // ========================================================================
    75→
    76→    DomainEvent TransactionCompleted {
    77→        - TransactionId transactionId
    78→        - String VivaConsumerId               // Salesforce guest identifier - optional for in-store walk-in purchases, ALWAYS present for app/web transactions
    79→        - StoreId storeId
    80→        - DateTime transactionDate
    81→        - Money totalAmount
    82→        - Money fuelAmount                    // Subset of total - fuel only
    83→        - Money merchandiseAmount             // Subset of total - in-store only
    84→        - List<LineItem> items
    85→        - TransactionSource source            // POS | MOBILE_APP | WEB
    86→        - PaymentMethod paymentMethod
    87→        - String receiptNumber
    88→    }
    89→
    90→    DomainEvent TransactionRefunded {
    91→        - TransactionId originalTransactionId
    92→        - TransactionId refundTransactionId
    93→        - String VivaConsumerId               // Salesforce guest identifier from original transaction
    94→        - StoreId storeId
    95→        - DateTime refundedAt
    96→        - Money refundAmount
    97→        - String reason
    98→    }
    99→
   100→    DomainEvent TransactionVoided {
   101→        - TransactionId transactionId
   102→        - StoreId storeId
   103→        - DateTime voidedAt
   104→        - String reason
   105→        - String performedBy
   106→    }
   107→
   108→    // ========================================================================
   109→    // VALUE OBJECTS
   110→    // ========================================================================
   111→
   112→    ValueObject TransactionId {
   113→        - String id
   114→    }
   115→
   116→    ValueObject StoreId {
   117→        - String id
   118→    }
   119→
   120→    ValueObject LineItem {
   121→        - String productCode
   122→        - String productName
   123→        - ProductCategory category           // FUEL | FOOD | BEVERAGE | TOBACCO | etc.
   124→        - Decimal unitPrice
   125→        - int quantity
   126→        - Money lineTotal
   127→        - boolean isEligibleForRewards      // Some products excluded from loyalty
   128→    }
   129→
   130→    ValueObject Money {
   131→        - Decimal amount
   132→        - String currency                    // AUD
   133→    }
   134→
   135→    ValueObject TransactionSource {
   136→        - String source                      // POS | MOBILE_APP | WEB
   137→    }
   138→
   139→    ValueObject PaymentMethod {
   140→        - String type                        // CARD | CASH | MOBILE_WALLET | FLEET_CARD
   141→        - String lastFourDigits              // If card payment
   142→    }
   143→
   144→    ValueObject ProductCategory {
   145→        - String code
   146→        - String name
   147→        - boolean isAgeRestricted           // Tobacco, alcohol, etc.
   148→        - boolean isEligibleForRewards
   149→    }
   150→}
   151→
   152→// ============================================================================
   153→// INTEGRATION NOTES
   154→// ============================================================================
   155→//
   156→// Event Publishing:
   157→// - D365 Commerce publishes events to Event Bus topic: "transaction-events"
   158→// - Consumer groups: loyalty-service, engagement-service, recommendation-service, edp-analytics
   159→// - Event schema follows OTR Published Language (not D365 internal model)
   160→// - At-least-once delivery guarantee
   161→//
   162→// Multi-Channel Architecture:
   163→// - **POS (CSU)**: In-store terminals create transactions directly in D365 Commerce → publish events
   164→// - **Web**: E-commerce uses D365 Commerce cloud APIs → creates transactions → publishes events
   165→// - **Mobile**: Mobile backend services → write transactions to D365 Commerce → publishes events
   166→// - All channels use same TransactionCompleted event schema
   167→// - TransactionSource attribute distinguishes channel origin
   168→//
   169→// Transaction Scope:
   170→// - D365 Commerce is the authoritative source for ALL transaction data
   171→// - Full basket details (line items, quantities, prices) stored in D365 Commerce
   172→// - LoyaltyService stores summary only (itemCount, itemSummary) for display
   173→// - Full transaction details queried from D365 Commerce via sourceTransactionId
   174→//
   175→// Guest Identification:
   176→// - "Guest" refers to customers in OTR's ubiquitous language
   177→// - VivaConsumerId (Salesforce identifier) is ALWAYS present for app/web transactions
   178→// - VivaConsumerId is optional only for in-store walk-in purchases without loyalty card scan
   179→// - Guest identified via: loyalty card scan, phone number lookup, or app login
   180→// - LoyaltyService handles reward adjudication only for identified guests
   181→//
   182→// Channel-Specific Details:
   183→// - **POS CSU**: Fuel pump integration, age-restricted product verification
   184→// - **Web Cloud**: Shopping cart, checkout flow, shipping/delivery
   185→// - **Mobile**: Mobile backend orchestration before writing to D365 Commerce
   186→//
   187→// ============================================================================
   188→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
