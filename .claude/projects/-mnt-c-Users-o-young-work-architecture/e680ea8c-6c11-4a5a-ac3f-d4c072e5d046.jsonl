{"type":"file-history-snapshot","messageId":"32b6e823-e28b-4310-8a6f-6960738268f9","snapshot":{"messageId":"32b6e823-e28b-4310-8a6f-6960738268f9","trackedFileBackups":{},"timestamp":"2026-01-08T05:18:55.402Z"},"isSnapshotUpdate":false}
{"parentUuid":null,"isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","type":"user","message":{"role":"user","content":"lets make the way we talk about phases consistent, we talk about AS-1 and AS-4 in one solution doc and TS-1 to TS-4 in another "},"uuid":"32b6e823-e28b-4310-8a6f-6960738268f9","timestamp":"2026-01-08T05:18:55.375Z","thinkingMetadata":{"level":"high","disabled":false,"triggers":[]},"todos":[]}
{"parentUuid":"32b6e823-e28b-4310-8a6f-6960738268f9","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01NAoCNLo6tM2eKkYpX9eFU6","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"The user is pointing out an inconsistency in how phases are being referred to across solution architecture documents. They mention:\n- One document uses \"AS-1\" and \"AS-4\" \n- Another document uses \"TS-1\" to \"TS-4\"\n\nThis is about standardizing the naming convention for phases across solution documentation.\n\nLet me first check what files have been modified according to the git status:\n- solution_architectures/flybuys_integration.adoc\n- solution_architectures/salesforce_customer_support.adoc\n\nI should read both of these files to see what phase naming conventions they're using, then work with the user to make them consistent.\n\nThis is a straightforward task - reading two files and making consistent edits. I don't need to use EnterPlanMode for this as it's a simple consistency fix. I also don't need to use TodoWrite since it's a simple task.\n\nLet me read both files to understand the current state.","signature":"EqYICkYICxgCKkDm9J8lLiM/ozzGUW2+rBxhCQJCKIhRgf7/v0+0UnW/KJL2JkyT7ZQB+QX4Du+EwEVsOAFimYCAQJptIz/c2JKyEgwrlYqnhQQX3T+udawaDEzePbop1tTIMTuj9iIwgYW+236EaHRQO5GQuCzWOXKT3OVtPV52WqL7Kg3kjfgAgsWMOwBzQzJHCcY3g+wNKo0HsYjxKn6AzV5/QjkPM0bGDI4uALM453ITE3d115MvQEhLyLD6nU/VaYPfRf8+m3fPH+aLXWSDERJUNs0bHZJjCM3pMFceMXq03d1e5UEqKbMVXJXOhCbmSNg7LvZl/G5vWRmpFcq86CayO9qEmUDMoNFdWvFSR3Mj78LG5oGxA9FEv++W/HxMSsoY8D0uo8Npfhiq73jf4gMuI5j/RWI+rA0dU+ciydvH0O/CZVZctLIoou9oFb/W3O9z8P8aA0jjnOnWlTxY7bTjBfxwxWcXz63G2OvU/KgSNDtpCX3Gospu44+FrmOeAgoT/id9tPuC1t6ag+VR5HXnUPYoLvqRmr7/9BW7quDeoPuaTEQR0UL4PXzG+rsPvIywTCAZPI4SFJ7rcyVXu+7aeCLLCNeRcINr7w4CQnUuOF6IyHR6xgrxn9Gc1lUAdR/UEg1I36a3LgiORK3UxKuHIsCBl798s8LeTYGI0rk6qjzrmjQBbSKM4Tywq+m1hcNzKJSeAx53h+ZVZtP8iWCjRBKck4DZiMqzOstkEEd3xbhAn00wlSCzS8FxoqfiIyuJQS/Xk2zU6T6m93X5jx+QoeyE495VeFic2kpKB/YxKaxMn8f11HC5gQdOnN0BS2USCpB76Yc66Vhw8a9ZD7CTd/XH+nbhg0tt2g8CgUzvkA7ulu6YSnZ1Wot3JnvuxmhWmwp9chf6FLRLgkc9tjM7PKMkAJCRyCmuE4uJCD/dYIMGtjq8zOjjApd2WvN84FaA+61YQbVSKFERnfBxg7+FKa9HOI7nqPWcR8Z6KzxDz4IccFNl4qaAO3eRdc5dcSWcuw2lJzq1Utlkwl9/pm6aG6SxcMx06ouCcTL9mSqmZShg+guVD7IPO6yNzxsaaS10Z5Cj+EFdS0bQKb09VeMw/XnjnMHKtU5lAq/SBAo+zjxSaBC7QnWHRkhvfmciongR3UthZ6lLOl3Os04TaFwAJX9uYI/J6TvUAm2SmTALbj+Gb4uhi1aaPVgyWIP6uMhm3QmTdr5OM/Ksw2BjLjpnt8uLH06mkqKNjdFCCqHKBHVPA0vD4iY/gbXazBQ2rntFwWbiZm/MmmGdWYDHRCP/VO1kDuuokRbRvvJUQPbHkgN8gnWEW5+c3bs2KChjuRsawt6dyWOn8NPS+FL73CxSF2BW3s1sjFd+njhMv/YvvwDbwfEECmJm2bWprPl8iS2WyFLrGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":24121,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":24121,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CWuM37wBh3q4656Kv3isr","type":"assistant","uuid":"bd7f4ce8-92fb-49a0-b603-a4d4c065ff5d","timestamp":"2026-01-08T05:19:04.047Z"}
{"parentUuid":"bd7f4ce8-92fb-49a0-b603-a4d4c065ff5d","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01NAoCNLo6tM2eKkYpX9eFU6","type":"message","role":"assistant","content":[{"type":"text","text":"I'll help standardize the phase naming convention across the solution architecture documents. Let me read the two modified files to see the current phase naming."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":24121,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":24121,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CWuM37wBh3q4656Kv3isr","type":"assistant","uuid":"7ef9e0fc-83c4-48aa-b928-038292bef50b","timestamp":"2026-01-08T05:19:04.665Z"}
{"parentUuid":"7ef9e0fc-83c4-48aa-b928-038292bef50b","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01NAoCNLo6tM2eKkYpX9eFU6","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_016J58NeFzvSD1VwVeikmnqD","name":"Read","input":{"file_path":"/mnt/c/Users/o.young/work/architecture/solution_architectures/flybuys_integration.adoc"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":24121,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":24121,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CWuM37wBh3q4656Kv3isr","type":"assistant","uuid":"cd1373f4-4290-4f60-87d0-ec5dfa47ee36","timestamp":"2026-01-08T05:19:05.605Z"}
{"parentUuid":"cd1373f4-4290-4f60-87d0-ec5dfa47ee36","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01NAoCNLo6tM2eKkYpX9eFU6","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01MwtyEypZCbr8UNwdGgxWjj","name":"Read","input":{"file_path":"/mnt/c/Users/o.young/work/architecture/solution_architectures/salesforce_customer_support.adoc"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":24121,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":24121,"ephemeral_1h_input_tokens":0},"output_tokens":399,"service_tier":"standard"}},"requestId":"req_011CWuM37wBh3q4656Kv3isr","type":"assistant","uuid":"fd00e317-0b14-436e-8f05-72204471c256","timestamp":"2026-01-08T05:19:06.086Z"}
{"parentUuid":"cd1373f4-4290-4f60-87d0-ec5dfa47ee36","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","type":"user","message":{"role":"user","content":[{"type":"tool_result","content":"File content (41600 tokens) exceeds maximum allowed tokens (25000). Please use offset and limit parameters to read specific portions of the file, or use the GrepTool to search for specific content.","is_error":true,"tool_use_id":"toolu_016J58NeFzvSD1VwVeikmnqD"}]},"uuid":"161242ef-7564-429c-b216-306376248220","timestamp":"2026-01-08T05:19:06.655Z","toolUseResult":"Error: File content (41600 tokens) exceeds maximum allowed tokens (25000). Please use offset and limit parameters to read specific portions of the file, or use the GrepTool to search for specific content.","sourceToolAssistantUUID":"cd1373f4-4290-4f60-87d0-ec5dfa47ee36"}
{"parentUuid":"fd00e317-0b14-436e-8f05-72204471c256","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","type":"user","message":{"role":"user","content":[{"type":"tool_result","content":"File content (27995 tokens) exceeds maximum allowed tokens (25000). Please use offset and limit parameters to read specific portions of the file, or use the GrepTool to search for specific content.","is_error":true,"tool_use_id":"toolu_01MwtyEypZCbr8UNwdGgxWjj"}]},"uuid":"cc3e2e16-1df2-4d6f-bb85-82539c823f1d","timestamp":"2026-01-08T05:19:06.693Z","toolUseResult":"Error: File content (27995 tokens) exceeds maximum allowed tokens (25000). Please use offset and limit parameters to read specific portions of the file, or use the GrepTool to search for specific content.","sourceToolAssistantUUID":"fd00e317-0b14-436e-8f05-72204471c256"}
{"parentUuid":"cc3e2e16-1df2-4d6f-bb85-82539c823f1d","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01Cci55KHpzG59BTBDQZ3Faz","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Both files are too large to read in one go. Let me use Grep to search for the phase naming patterns in both files to understand what's being used.","signature":"ErsCCkYICxgCKkB2FNtFtUvODC8Gm6WEkU1+WG7ixof2rGfVFA1GGXeBnsakVieNhiDlGGaqPF/bp06iafOm3tVlDENkuGcphYo2EgyiHY3zH2QcsK4HAy0aDL+0iHnlu6f/ZEZ3WyIwjQ1CPl3QiGHR5N+gVWm5tTjN+9igGbBStoLne9GOJyb1aXVVYC2usHTu9CWAgGbeKqIBpTdsjL6rLwhLn8lOQahRuCdcnrMN2G8+HE9N5BKlomm5SiQZTVu8IrF5HSjaw6a63AdbikYIRmv3AiOzbC+HBNPlyMdRmbOFiYVtOI2SNfQ4ZwpSKYon0KrlWXNstza0dJQWpcUtn48aX7yw2IOEdQOMpf7dqWdoLW3o7t22TUaLiPumknYKphcSFMoZ9QXieP2iKN1b6Bc0oycIbv4mv6SyGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":14,"cache_creation_input_tokens":539,"cache_read_input_tokens":24121,"cache_creation":{"ephemeral_5m_input_tokens":539,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWuM3xAqdRHKc34Hnci2F","type":"assistant","uuid":"1f063a00-bd72-47d3-9458-5d1b93dbaba3","timestamp":"2026-01-08T05:19:09.918Z"}
{"parentUuid":"1f063a00-bd72-47d3-9458-5d1b93dbaba3","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01Cci55KHpzG59BTBDQZ3Faz","type":"message","role":"assistant","content":[{"type":"text","text":"Let me search for the phase naming patterns in both files."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":14,"cache_creation_input_tokens":539,"cache_read_input_tokens":24121,"cache_creation":{"ephemeral_5m_input_tokens":539,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWuM3xAqdRHKc34Hnci2F","type":"assistant","uuid":"98e75b77-ea9a-4d2b-b96f-39c0d6f9cd05","timestamp":"2026-01-08T05:19:10.226Z"}
{"parentUuid":"98e75b77-ea9a-4d2b-b96f-39c0d6f9cd05","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01Cci55KHpzG59BTBDQZ3Faz","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01UasdVFEQ8Xgsu7xHXfzifo","name":"Grep","input":{"pattern":"(AS-[0-9]|TS-[0-9])","path":"/mnt/c/Users/o.young/work/architecture/solution_architectures","output_mode":"content","-n":true}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":14,"cache_creation_input_tokens":539,"cache_read_input_tokens":24121,"cache_creation":{"ephemeral_5m_input_tokens":539,"ephemeral_1h_input_tokens":0},"output_tokens":195,"service_tier":"standard"}},"requestId":"req_011CWuM3xAqdRHKc34Hnci2F","type":"assistant","uuid":"25665cb2-6790-4c5a-9781-f35dbc3c1f60","timestamp":"2026-01-08T05:19:11.561Z"}
{"parentUuid":"25665cb2-6790-4c5a-9781-f35dbc3c1f60","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01UasdVFEQ8Xgsu7xHXfzifo","type":"tool_result","content":"solution_architectures/flybuys_integration.adoc:80:* Phased roll-out (AS-1 → AS-4)\r\nsolution_architectures/flybuys_integration.adoc:2139:*Purpose*: Creates a new customer profile, retrieves VCI from Salesforce, and provisions an EagleEye wallet. Used by the xref:../ubiquitous_language.adoc#just-in-time-integration[Just-In-Time Integration] during customer login (AS-1 Foundation).\r\nsolution_architectures/flybuys_integration.adoc:2714:==== OAuth linking Flow (AS-2 linking)\r\nsolution_architectures/flybuys_integration.adoc:2794:==== Just-In-Time Profile Creation Flow (AS-1 Foundation)\r\nsolution_architectures/flybuys_integration.adoc:2892:==== POS Integration Flow (AS-3 Grants)\r\nsolution_architectures/flybuys_integration.adoc:2987:==== POS Transaction Adjudication Flow (AS-3 Grants)\r\nsolution_architectures/flybuys_integration.adoc:3101:==== Batch File Processing Flow (AS-3 Grants)\r\nsolution_architectures/flybuys_integration.adoc:3249:. *Data Coexistence*: Dual-write to legacy and new systems during AS-1 Foundation phase (30 days)\r\nsolution_architectures/flybuys_integration.adoc:3254:Progressive rollout of feature flags across architecture states (AS-0 → AS-1 → AS-2 → AS-3 → AS-4).\r\nsolution_architectures/flybuys_integration.adoc:3260:| Flag Name | AS-0 Current | AS-1 Foundation | AS-2 linking | AS-3 Grants | AS-4 Target\r\nsolution_architectures/flybuys_integration.adoc:3315:==== AS-1 Foundation Rollback\r\nsolution_architectures/flybuys_integration.adoc:3327:==== AS-2 linking Rollback\r\nsolution_architectures/flybuys_integration.adoc:3339:==== AS-3 Grants Rollback\r\nsolution_architectures/flybuys_integration.adoc:3364:=== AS-0 Current State\r\nsolution_architectures/flybuys_integration.adoc:3383:=== AS-1 Foundation\r\nsolution_architectures/flybuys_integration.adoc:3555:=== AS-2 linking\r\nsolution_architectures/flybuys_integration.adoc:3741:=== AS-3 Grants\r\nsolution_architectures/flybuys_integration.adoc:3764:. Pre-linking Requirement: Customers must link Flybuys account via mobile app OAuth flow (AS-2)\r\nsolution_architectures/flybuys_integration.adoc:3800:=== AS-4 Target State\r\nsolution_architectures/flybuys_integration.adoc:3804:==== Success Criteria (Entry to AS-4)\r\nsolution_architectures/flybuys_integration.adoc:3808:* AS-3 Grants operational for minimum 6 months\r\nsolution_architectures/flybuys_integration.adoc:3817:* All flags remain ON (no changes from AS-3)\r\nsolution_architectures/flybuys_integration.adoc:3832:    A[AS-1: Foundation] --> B[AS-2: linking Enabled]\r\nsolution_architectures/flybuys_integration.adoc:3833:    B --> C[AS-3: Grants Operational]\r\nsolution_architectures/flybuys_integration.adoc:3834:    C --> D[AS-4: Target State]\r\nsolution_architectures/flybuys_integration.adoc:3857:| Dual-write during AS-1 (30 days), legacy remains authoritative\r\nsolution_architectures/salesforce_customer_support.adoc:164:* Big bang cutover (TS-1 → TS-4)\r\nsolution_architectures/salesforce_customer_support.adoc:1308:* Flybuys integration uses phased rollout (AS-1, AS-2, AS-3 architecture states)\r\nsolution_architectures/salesforce_customer_support.adoc:1324:* ✅ Simpler deployment (single cutover, no AS-1/AS-2/AS-3 states)\r\nsolution_architectures/salesforce_customer_support.adoc:1551:==== TS-0: Baseline State (Current)\r\nsolution_architectures/salesforce_customer_support.adoc:1565:==== TS-1: Build & Test\r\nsolution_architectures/salesforce_customer_support.adoc:1593:==== TS-2: Contact Migration\r\nsolution_architectures/salesforce_customer_support.adoc:1616:==== TS-3: Cutover (Go-Live)\r\nsolution_architectures/salesforce_customer_support.adoc:1646:==== TS-4: Target State (Stable Production)"}]},"uuid":"24e21c0b-0195-4858-8641-c4aa78283b67","timestamp":"2026-01-08T05:19:12.979Z","toolUseResult":{"mode":"content","numFiles":0,"filenames":[],"content":"solution_architectures/flybuys_integration.adoc:80:* Phased roll-out (AS-1 → AS-4)\r\nsolution_architectures/flybuys_integration.adoc:2139:*Purpose*: Creates a new customer profile, retrieves VCI from Salesforce, and provisions an EagleEye wallet. Used by the xref:../ubiquitous_language.adoc#just-in-time-integration[Just-In-Time Integration] during customer login (AS-1 Foundation).\r\nsolution_architectures/flybuys_integration.adoc:2714:==== OAuth linking Flow (AS-2 linking)\r\nsolution_architectures/flybuys_integration.adoc:2794:==== Just-In-Time Profile Creation Flow (AS-1 Foundation)\r\nsolution_architectures/flybuys_integration.adoc:2892:==== POS Integration Flow (AS-3 Grants)\r\nsolution_architectures/flybuys_integration.adoc:2987:==== POS Transaction Adjudication Flow (AS-3 Grants)\r\nsolution_architectures/flybuys_integration.adoc:3101:==== Batch File Processing Flow (AS-3 Grants)\r\nsolution_architectures/flybuys_integration.adoc:3249:. *Data Coexistence*: Dual-write to legacy and new systems during AS-1 Foundation phase (30 days)\r\nsolution_architectures/flybuys_integration.adoc:3254:Progressive rollout of feature flags across architecture states (AS-0 → AS-1 → AS-2 → AS-3 → AS-4).\r\nsolution_architectures/flybuys_integration.adoc:3260:| Flag Name | AS-0 Current | AS-1 Foundation | AS-2 linking | AS-3 Grants | AS-4 Target\r\nsolution_architectures/flybuys_integration.adoc:3315:==== AS-1 Foundation Rollback\r\nsolution_architectures/flybuys_integration.adoc:3327:==== AS-2 linking Rollback\r\nsolution_architectures/flybuys_integration.adoc:3339:==== AS-3 Grants Rollback\r\nsolution_architectures/flybuys_integration.adoc:3364:=== AS-0 Current State\r\nsolution_architectures/flybuys_integration.adoc:3383:=== AS-1 Foundation\r\nsolution_architectures/flybuys_integration.adoc:3555:=== AS-2 linking\r\nsolution_architectures/flybuys_integration.adoc:3741:=== AS-3 Grants\r\nsolution_architectures/flybuys_integration.adoc:3764:. Pre-linking Requirement: Customers must link Flybuys account via mobile app OAuth flow (AS-2)\r\nsolution_architectures/flybuys_integration.adoc:3800:=== AS-4 Target State\r\nsolution_architectures/flybuys_integration.adoc:3804:==== Success Criteria (Entry to AS-4)\r\nsolution_architectures/flybuys_integration.adoc:3808:* AS-3 Grants operational for minimum 6 months\r\nsolution_architectures/flybuys_integration.adoc:3817:* All flags remain ON (no changes from AS-3)\r\nsolution_architectures/flybuys_integration.adoc:3832:    A[AS-1: Foundation] --> B[AS-2: linking Enabled]\r\nsolution_architectures/flybuys_integration.adoc:3833:    B --> C[AS-3: Grants Operational]\r\nsolution_architectures/flybuys_integration.adoc:3834:    C --> D[AS-4: Target State]\r\nsolution_architectures/flybuys_integration.adoc:3857:| Dual-write during AS-1 (30 days), legacy remains authoritative\r\nsolution_architectures/salesforce_customer_support.adoc:164:* Big bang cutover (TS-1 → TS-4)\r\nsolution_architectures/salesforce_customer_support.adoc:1308:* Flybuys integration uses phased rollout (AS-1, AS-2, AS-3 architecture states)\r\nsolution_architectures/salesforce_customer_support.adoc:1324:* ✅ Simpler deployment (single cutover, no AS-1/AS-2/AS-3 states)\r\nsolution_architectures/salesforce_customer_support.adoc:1551:==== TS-0: Baseline State (Current)\r\nsolution_architectures/salesforce_customer_support.adoc:1565:==== TS-1: Build & Test\r\nsolution_architectures/salesforce_customer_support.adoc:1593:==== TS-2: Contact Migration\r\nsolution_architectures/salesforce_customer_support.adoc:1616:==== TS-3: Cutover (Go-Live)\r\nsolution_architectures/salesforce_customer_support.adoc:1646:==== TS-4: Target State (Stable Production)","numLines":34},"sourceToolAssistantUUID":"25665cb2-6790-4c5a-9781-f35dbc3c1f60"}
{"parentUuid":"24e21c0b-0195-4858-8641-c4aa78283b67","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01R9oJvU8m5ay8uk7Apyx7ns","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"I can see the inconsistency:\n\n- `flybuys_integration.adoc` uses \"AS-0\", \"AS-1\", \"AS-2\", \"AS-3\", \"AS-4\" (Architecture State)\n- `salesforce_customer_support.adoc` uses \"TS-0\", \"TS-1\", \"TS-2\", \"TS-3\", \"TS-4\" (Transition State or Timeline State)\n\nThe flybuys document also mentions \"AS-1, AS-2, AS-3 architecture states\" explicitly.\n\nI should ask the user which naming convention they prefer to standardize on. It seems like:\n- \"AS\" might stand for \"Architecture State\" \n- \"TS\" might stand for \"Transition State\" or \"Timeline State\"\n\nGiven that this is an architecture repository and the flybuys document is more detailed with its phasing, I should ask which convention they prefer, but I might suggest sticking with one consistent approach.\n\nLet me ask the user what they'd like to standardize on.","signature":"ErsHCkYICxgCKkA9yRYKTpbdXYhCvUmMQvD6rkMeOAqiIDxk3ZnSLiNlq1efNs17v7W18jGI5iTskq+fZfgLgANum6zk+lIOfM0qEgxOD8dFuT8SgYMBCu8aDKWzuJInIjVFb+Qg3iIw75eQYDD2YGiOpy3Ol1t/FwOWpegtsP8JnnsQC/chK2flHJEx03VcXLXvM/2SqMvoKqIGIe5+raPAGvqN88GsgYf7cfKm68eebM/3XQnCKuI347wT37I5zcroRZnB1c49uLUXBJg8g4L0P6XqD27Vn6LiS39VuZhSn72Kp8dWcD38OZPPGjppv/+rscB/svjGu4IIZRaYexp16VkXydhV01JgR/HTFQT2ldCOdXJ646ZYBQ7ronHS9Yvkzim6Eelx7WgJ+ocSrlrrMgOo8NGi+zNN36voekG/skrvtWkSH3fhOWhod1ObOheR1wZEwoU6cCqv3vsn+4MNrhaST2EaN1TUxLa1VhZFOYregrjDzmhwvYYSy3BVGu40++VU8SJsyjpieaGSdDnTH7mIb+Xf4HLBd6B2ixrm/7eRG2Pue09fH2AUsINgguTnodk14gNkpAAGrUt/kUIbiYsnTxBN3L4VBsjjF6kDeMprgO+/iamfncP+tS+SFJl0fzT9ZB9qqvDwEBIemPYCBwJG1/YbNtZIbujVfbQPwpd4/4CD5hgKoCn7dwcr/lxbE5pQt5JCNyNzG4cgiS1MtRAPNImKz36KR6W/Jro4SJlqWWaf+GF6+/7cHjgQBSMEwpoPwEKTFKJ6pHm8eYZXHnrETD53UkqEU7adg1I/WKHTgoUpGY2hq506YHlINQ+BcWBMqKM4CgcBaGOL5IY6+IQX0djmhZRAiHADL2Szl2VIX3IR81Fg8G9QrP6404io03qirFAMy5oVsSeYCIebF4tu5yRIBY8bD9yo3fvEduzOoGqE7cODGpBPEngk1hFIJHlii0B7uhhxaWyj8HXRWrZZhM9JeLffEg72lzVf2+QBST396dc//jKKfBPB5y8WNT6fbVZG0xbd7RZCjdQrmKJvVfI2p6bybXEwR4rh49I3zhfkKy022XRkrl3M0naYdCyrs6Thr5hzX7QJS1a9mjhcg0zn/bk6XSCtj1paSH1PVCGncSjZ3xWFtSwm5tYiao5Qki5SxxSlSunLxGTy9Qcqakp1DJFP6xFNhwSQmjOWaETmY6r6ZTPzBQoEZ+AatJMm7QADYEOxDjeM04MPtXSGEs1A8ZdqdnSnSzd2Vdh3Dm14XkGeqOmyvhgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":1427,"cache_read_input_tokens":24660,"cache_creation":{"ephemeral_5m_input_tokens":1427,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWuM4R4MjXuDpNLG2YVSs","type":"assistant","uuid":"92638814-a3a3-4e73-811b-39199bf21fa1","timestamp":"2026-01-08T05:19:20.046Z"}
{"parentUuid":"92638814-a3a3-4e73-811b-39199bf21fa1","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01R9oJvU8m5ay8uk7Apyx7ns","type":"message","role":"assistant","content":[{"type":"text","text":"I can see the inconsistency. The two documents use different phase naming:\n\n**flybuys_integration.adoc**: Uses `AS-0`, `AS-1`, `AS-2`, `AS-3`, `AS-4` (Architecture State)\n- AS-0: Current State\n- AS-1: Foundation\n- AS-2: Linking\n- AS-3: Grants\n- AS-4: Target State\n\n**salesforce_customer_support.adoc**: Uses `TS-0`, `TS-1`, `TS-2`, `TS-3`, `TS-4` (Transition State)\n- TS-0: Baseline State (Current)\n- TS-1: Build & Test\n- TS-2: Contact Migration\n- TS-3: Cutover (Go-Live)\n- TS-4: Target State (Stable Production)\n\nWhich naming convention would you like to standardize on across all solution architecture documents?\n\n1. **AS (Architecture State)** - emphasizes architectural evolution\n2. **TS (Transition State)** - emphasizes timeline and deployment phases\n3. **Something else** - different prefix or naming scheme"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":1427,"cache_read_input_tokens":24660,"cache_creation":{"ephemeral_5m_input_tokens":1427,"ephemeral_1h_input_tokens":0},"output_tokens":516,"service_tier":"standard"}},"requestId":"req_011CWuM4R4MjXuDpNLG2YVSs","type":"assistant","uuid":"e340f7af-077e-474f-a9ee-99087e455697","timestamp":"2026-01-08T05:19:23.311Z"}
{"type":"file-history-snapshot","messageId":"95474cc9-ed2e-4172-b9d0-131e08de4e69","snapshot":{"messageId":"95474cc9-ed2e-4172-b9d0-131e08de4e69","trackedFileBackups":{},"timestamp":"2026-01-08T05:23:10.863Z"},"isSnapshotUpdate":false}
{"parentUuid":"e340f7af-077e-474f-a9ee-99087e455697","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","type":"user","message":{"role":"user","content":"I think I like TS better"},"uuid":"95474cc9-ed2e-4172-b9d0-131e08de4e69","timestamp":"2026-01-08T05:23:10.832Z","thinkingMetadata":{"level":"high","disabled":false,"triggers":[]},"todos":[]}
{"parentUuid":"95474cc9-ed2e-4172-b9d0-131e08de4e69","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_014sfFfxHbcsMRMZgzJg3ZDz","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"The user wants to standardize on TS (Transition State) naming instead of AS (Architecture State). So I need to update the flybuys_integration.adoc file to change all instances of:\n- AS-0 → TS-0\n- AS-1 → TS-1\n- AS-2 → TS-2\n- AS-3 → TS-3\n- AS-4 → TS-4\n\nThis is a straightforward find-and-replace task across the file. Let me do this systematically by reading sections and replacing them.\n\nSince the file is too large to read in one go, I'll need to use the Edit tool with replace_all=true to change all instances of each AS-X to TS-X.\n\nLet me do this carefully:\n1. Replace AS-0 with TS-0\n2. Replace AS-1 with TS-1\n3. Replace AS-2 with TS-2\n4. Replace AS-3 with TS-3\n5. Replace AS-4 with TS-4\n\nI should use replace_all for each of these to ensure consistency across the entire file.","signature":"ErIHCkYICxgCKkBUTF9VVanNgEqgjnRcTX+wfGxwGcCAUJrc4DFcVWCP4b9J7gaKxrze8ImjY3gHPlXS4BAWRUiVujIIm3MJWBSqEgylGRR931a+w+R0IgAaDHWeUf6d1Wkzpska7yIwhQwM4WqDM+oQBJVtE3clddXgHZCl262InBgElGbz1JNlyIKZEDjpNpSjqkFThfeeKpkGYF97TmkclPE5ubTMSOXaCYYw5DV8SuXBWA2aua8uxJeMx8gQhyGQ1DQ+sKsd6x03d+BVm/EJeX4yQ3Hayi0BbSwGmqizIaNIU55XeSSkmNNVN8psOt+TUfS4npJhf01iuYIKzDPlFTtBSL23kqBjvPqLW4N3snIrZsHAuihjKeWPSfYjfGwexyQyxuXVSu1InLZ0SX/KP6vyKzN6oGJuhmyo7Y0Xy7yvsLPIsBlvu1Eq9tJ6PZmMb8cH4b44d3SOxb5LLXvbGNQzfitvuMIfSpbAGdghMtnnQQbbau4p+iAow9MONut8ssw94RvuEY6P7hKC0dIJc+oHv9YyAkUc9aqtxTvrSQDu5tlt8gafJ23JCx0cuUMxgL6wSXpOqhFHMJ6e+81sbasbTLNIRJp2rm6CTgRqxWAilhGgx+FvzxBd0KbIudTFIRhr84p+XNYt3Sh68YxQNlUGi7f6VOVXwJvuHlQz/W0RRG3KH5LLusQQRhg90PE4oaHiVrKLEtR0qLahJPQhanVAGBLLWhmoCftVsJX4ppCrRwsOngzRxM3QH6Qlu9wXI90fXct52EfzevkjoG6LRSHSKuCAyKKur0MYCe9zjQk/4HiOk9Q1G5i7eKwx6875QWq8NsG9g7Q+bCIjW70koqSG6SJyMNOuRYP9zTgCNZbeSZPfTkUSP/U5DVsXyEUPgcNjgX2AwcaXZxH/Xc/SD441Yb39XBeW5vKgDNEpvti3E97EOM1NN0N46BCua6vDKPf5ltCRygLRuK3y6nxXDalwCtZ9lzcgF/WSYWJ0lUv4vCNInlp2s6GwxLbpIXGiHxUL+mQ3KMycdLPweeLUtGJwSwu2Il/92QqR9xA8KlaREHxCnFeA/mpvSQxj4tQiYUZLLn7tR2QMG2DaWrr4avp79nsytWha4YKgqnI7BpE2d8/E+znFs+wxGoL/eDg9QUmo2fFCzji0RDy8NNvhTJw73Gg2geu+GuNUeV7z3RhNqF+ssTXZkuIHQEDdN4rl95HxSnQ4RlcCJ3H3GaD22b8IoMpe/3awTy0C+ASMqDe3OhgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":1980,"cache_read_input_tokens":24121,"cache_creation":{"ephemeral_5m_input_tokens":1980,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CWuMMwygm8GzLbABNwLwi","type":"assistant","uuid":"54475eb0-3eae-4f93-813c-771ad4a9a1c3","timestamp":"2026-01-08T05:23:18.178Z"}
{"parentUuid":"54475eb0-3eae-4f93-813c-771ad4a9a1c3","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_014sfFfxHbcsMRMZgzJg3ZDz","type":"message","role":"assistant","content":[{"type":"text","text":"I'll update the flybuys_integration.adoc file to use TS (Transition State) naming instead of AS (Architecture State) to match the salesforce_customer_support.adoc convention."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":1980,"cache_read_input_tokens":24121,"cache_creation":{"ephemeral_5m_input_tokens":1980,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CWuMMwygm8GzLbABNwLwi","type":"assistant","uuid":"ef978d49-64c2-49da-a19e-50c22cdea61f","timestamp":"2026-01-08T05:23:18.912Z"}
{"parentUuid":"ef978d49-64c2-49da-a19e-50c22cdea61f","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_014sfFfxHbcsMRMZgzJg3ZDz","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01712tuvXziMezL9xGVRA9hH","name":"Edit","input":{"replace_all":true,"file_path":"/mnt/c/Users/o.young/work/architecture/solution_architectures/flybuys_integration.adoc","old_string":"AS-0","new_string":"TS-0"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":1980,"cache_read_input_tokens":24121,"cache_creation":{"ephemeral_5m_input_tokens":1980,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CWuMMwygm8GzLbABNwLwi","type":"assistant","uuid":"fb38fe0c-849a-4c5b-b8d7-9bb64995b437","timestamp":"2026-01-08T05:23:20.635Z"}
{"parentUuid":"fb38fe0c-849a-4c5b-b8d7-9bb64995b437","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_014sfFfxHbcsMRMZgzJg3ZDz","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01NewdvruZnrUGoAgy1USkmA","name":"Edit","input":{"replace_all":true,"file_path":"/mnt/c/Users/o.young/work/architecture/solution_architectures/flybuys_integration.adoc","old_string":"AS-1","new_string":"TS-1"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":1980,"cache_read_input_tokens":24121,"cache_creation":{"ephemeral_5m_input_tokens":1980,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CWuMMwygm8GzLbABNwLwi","type":"assistant","uuid":"e87b84d6-1a21-4c90-8318-636996f7193e","timestamp":"2026-01-08T05:23:21.579Z"}
{"parentUuid":"e87b84d6-1a21-4c90-8318-636996f7193e","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_014sfFfxHbcsMRMZgzJg3ZDz","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Rr4La54TW3h6uKRxgT4oAY","name":"Edit","input":{"replace_all":true,"file_path":"/mnt/c/Users/o.young/work/architecture/solution_architectures/flybuys_integration.adoc","old_string":"AS-2","new_string":"TS-2"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":1980,"cache_read_input_tokens":24121,"cache_creation":{"ephemeral_5m_input_tokens":1980,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CWuMMwygm8GzLbABNwLwi","type":"assistant","uuid":"ecf624a5-cd2b-4f51-a640-e9bb59685213","timestamp":"2026-01-08T05:23:22.682Z"}
{"parentUuid":"ecf624a5-cd2b-4f51-a640-e9bb59685213","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_014sfFfxHbcsMRMZgzJg3ZDz","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_012igoxmufPPrPmYYHXSJ45j","name":"Edit","input":{"replace_all":true,"file_path":"/mnt/c/Users/o.young/work/architecture/solution_architectures/flybuys_integration.adoc","old_string":"AS-3","new_string":"TS-3"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":1980,"cache_read_input_tokens":24121,"cache_creation":{"ephemeral_5m_input_tokens":1980,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CWuMMwygm8GzLbABNwLwi","type":"assistant","uuid":"8d36316f-eab2-44d3-a69f-3f39e6d0a02b","timestamp":"2026-01-08T05:23:23.523Z"}
{"parentUuid":"8d36316f-eab2-44d3-a69f-3f39e6d0a02b","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_014sfFfxHbcsMRMZgzJg3ZDz","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_017jKoBP5QgfeLL436X4tZ4m","name":"Edit","input":{"replace_all":true,"file_path":"/mnt/c/Users/o.young/work/architecture/solution_architectures/flybuys_integration.adoc","old_string":"AS-4","new_string":"TS-4"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":1980,"cache_read_input_tokens":24121,"cache_creation":{"ephemeral_5m_input_tokens":1980,"ephemeral_1h_input_tokens":0},"output_tokens":960,"service_tier":"standard"}},"requestId":"req_011CWuMMwygm8GzLbABNwLwi","type":"assistant","uuid":"69d5989b-7455-47e6-b1ca-40dd1cd9eb8f","timestamp":"2026-01-08T05:23:24.186Z"}
{"parentUuid":"fb38fe0c-849a-4c5b-b8d7-9bb64995b437","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","type":"user","message":{"role":"user","content":[{"type":"tool_result","content":"<tool_use_error>File has not been read yet. Read it first before writing to it.</tool_use_error>","is_error":true,"tool_use_id":"toolu_01712tuvXziMezL9xGVRA9hH"}]},"uuid":"8a81218a-8889-4328-9c1c-681ca5a92cdd","timestamp":"2026-01-08T05:23:24.289Z","toolUseResult":"Error: File has not been read yet. Read it first before writing to it.","sourceToolAssistantUUID":"fb38fe0c-849a-4c5b-b8d7-9bb64995b437"}
{"parentUuid":"e87b84d6-1a21-4c90-8318-636996f7193e","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","type":"user","message":{"role":"user","content":[{"type":"tool_result","content":"<tool_use_error>File has not been read yet. Read it first before writing to it.</tool_use_error>","is_error":true,"tool_use_id":"toolu_01NewdvruZnrUGoAgy1USkmA"}]},"uuid":"5bdc3f43-02d8-46d0-9429-47d33721d0fa","timestamp":"2026-01-08T05:23:24.331Z","toolUseResult":"Error: File has not been read yet. Read it first before writing to it.","sourceToolAssistantUUID":"e87b84d6-1a21-4c90-8318-636996f7193e"}
{"parentUuid":"ecf624a5-cd2b-4f51-a640-e9bb59685213","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","type":"user","message":{"role":"user","content":[{"type":"tool_result","content":"<tool_use_error>File has not been read yet. Read it first before writing to it.</tool_use_error>","is_error":true,"tool_use_id":"toolu_01Rr4La54TW3h6uKRxgT4oAY"}]},"uuid":"16d3a8ef-7318-41f2-9c9b-fd462ff1c8dc","timestamp":"2026-01-08T05:23:24.370Z","toolUseResult":"Error: File has not been read yet. Read it first before writing to it.","sourceToolAssistantUUID":"ecf624a5-cd2b-4f51-a640-e9bb59685213"}
{"parentUuid":"8d36316f-eab2-44d3-a69f-3f39e6d0a02b","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","type":"user","message":{"role":"user","content":[{"type":"tool_result","content":"<tool_use_error>File has not been read yet. Read it first before writing to it.</tool_use_error>","is_error":true,"tool_use_id":"toolu_012igoxmufPPrPmYYHXSJ45j"}]},"uuid":"376cd58c-5b75-4a37-ad23-70b6625f718a","timestamp":"2026-01-08T05:23:24.410Z","toolUseResult":"Error: File has not been read yet. Read it first before writing to it.","sourceToolAssistantUUID":"8d36316f-eab2-44d3-a69f-3f39e6d0a02b"}
{"parentUuid":"69d5989b-7455-47e6-b1ca-40dd1cd9eb8f","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","type":"user","message":{"role":"user","content":[{"type":"tool_result","content":"<tool_use_error>File has not been read yet. Read it first before writing to it.</tool_use_error>","is_error":true,"tool_use_id":"toolu_017jKoBP5QgfeLL436X4tZ4m"}]},"uuid":"b6bec45f-c5a7-4fcc-ab68-380828d73003","timestamp":"2026-01-08T05:23:24.464Z","toolUseResult":"Error: File has not been read yet. Read it first before writing to it.","sourceToolAssistantUUID":"69d5989b-7455-47e6-b1ca-40dd1cd9eb8f"}
{"parentUuid":"b6bec45f-c5a7-4fcc-ab68-380828d73003","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01XE9VgMHX28SvQJpjVuJRZo","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"I need to read the file first before editing it. Since it's too large to read in one go, let me read it in chunks or use a different approach. Actually, I can read just a small portion to satisfy the requirement, then do the replace_all operations.","signature":"EqEDCkYICxgCKkDKFSVUKWTvRpffpGc62og1VCGl1Osu849o8niz+vCZEiNXAn8d0bRA152f1IYl2HN0VwKQ61D8ItOH1vMwefFuEgxpN0lNhzikEYlD2+YaDI2vy3AKCa0cgSnGuSIwPgtHWzTUkNoqDLU2aW18IOnRH5XN42sF/BG3nixF8eEa5EJvpA5j4/kS9sdkW1I8KogCV9L1yG11EQMIkb6qClFTFRlIUYZl7lvMr+mQRNwWryJ1jz/GDlr8Vk2q+Hdo9I3UZLN2Uq5j5/fJwZShzqOpIuf3gFr3gxj/HTLbaAWgWe4QldbXo/djsrK5jp2bOKi0LL774aAjwQZ70WIoFQFevecbOTcxa1N9KU8hrHq86BO3BKTck42dO9hXMUt1U4NSfwFjoSx6gEjQEcyrAdJAL81WVhtekPMOAdPo+KOMUCdmW8SNdP2jX3QKax2gaTlFnhhlGcWvXI1vghLyLBT+dcyQ7GT5bX9EIY3KtRj9aOmqzxr2EQmrIlbCkoj5f4JVXFxB6LKtLTVPvGRywBvCSl67Q3Vqs7szGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":14,"cache_creation_input_tokens":1316,"cache_read_input_tokens":26101,"cache_creation":{"ephemeral_5m_input_tokens":1316,"ephemeral_1h_input_tokens":0},"output_tokens":8,"service_tier":"standard"}},"requestId":"req_011CWuMNxNHEMGMENTXEMJsF","type":"assistant","uuid":"a6ed1da7-686c-4b9f-9ed7-12418862741c","timestamp":"2026-01-08T05:23:29.127Z"}
{"parentUuid":"a6ed1da7-686c-4b9f-9ed7-12418862741c","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01XE9VgMHX28SvQJpjVuJRZo","type":"message","role":"assistant","content":[{"type":"text","text":"Let me read a portion of the file first, then perform the replacements."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":14,"cache_creation_input_tokens":1316,"cache_read_input_tokens":26101,"cache_creation":{"ephemeral_5m_input_tokens":1316,"ephemeral_1h_input_tokens":0},"output_tokens":8,"service_tier":"standard"}},"requestId":"req_011CWuMNxNHEMGMENTXEMJsF","type":"assistant","uuid":"1bdb8834-031d-4c09-b34d-d1aab781bd49","timestamp":"2026-01-08T05:23:29.567Z"}
{"parentUuid":"1bdb8834-031d-4c09-b34d-d1aab781bd49","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01XE9VgMHX28SvQJpjVuJRZo","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_014gab3x25zYe3T6Px6u7n2y","name":"Read","input":{"file_path":"/mnt/c/Users/o.young/work/architecture/solution_architectures/flybuys_integration.adoc","offset":1,"limit":10}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":14,"cache_creation_input_tokens":1316,"cache_read_input_tokens":26101,"cache_creation":{"ephemeral_5m_input_tokens":1316,"ephemeral_1h_input_tokens":0},"output_tokens":8,"service_tier":"standard"}},"requestId":"req_011CWuMNxNHEMGMENTXEMJsF","type":"assistant","uuid":"1a9cbe84-c361-43e7-8797-c3135048f6b7","timestamp":"2026-01-08T05:23:30.416Z"}
{"parentUuid":"1a9cbe84-c361-43e7-8797-c3135048f6b7","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_014gab3x25zYe3T6Px6u7n2y","type":"tool_result","content":"     1→= Flybuys Integration - Solution Architecture\n     2→\n     3→:project-name: Flybuys Integration\n     4→:togaf-adm-phase: Phase E: Opportunities & Solutions\n     5→:document-type: Solution Architecture Document\n     6→:status: Discovery\n     7→:version: 0.1\n     8→:domain: Loyalty\n     9→:programme-lead: Frankie.Mullaly@vivaenergy.com.au\n    10→:domain-architect: O.Young@otr.com.au\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"9988d100-332c-4cce-a7d0-c007887aabfe","timestamp":"2026-01-08T05:23:31.105Z","toolUseResult":{"type":"text","file":{"filePath":"/mnt/c/Users/o.young/work/architecture/solution_architectures/flybuys_integration.adoc","content":"= Flybuys Integration - Solution Architecture\n\n:project-name: Flybuys Integration\n:togaf-adm-phase: Phase E: Opportunities & Solutions\n:document-type: Solution Architecture Document\n:status: Discovery\n:version: 0.1\n:domain: Loyalty\n:programme-lead: Frankie.Mullaly@vivaenergy.com.au\n:domain-architect: O.Young@otr.com.au","numLines":10,"startLine":1,"totalLines":4220}},"sourceToolAssistantUUID":"1a9cbe84-c361-43e7-8797-c3135048f6b7"}
{"parentUuid":"9988d100-332c-4cce-a7d0-c007887aabfe","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01AJFp7nvT9dgg1ME8SdCH6v","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Good, now I can perform the replace_all operations since I've read the file.","signature":"EvQBCkYICxgCKkDAIEdogVGteePkJV4WpnCCexmpFzleMSW1X218nY3LLmWbUtt2c4vC8Nx80tAtHWUN7Mnc8ueNpIGzy9FhPK61EgxqiFi21dXrefFs0vYaDCLSXFeOHz8LkJwGuiIwTygz8CJZJBYlIiL2T5BLxBpE71OL9HBlOEpogFsbd19+ANmUEPVzJT3F9MOyK3xAKlxoO/l6Xu/VSg0LXoX+XqbfdwstYRmtGNNoWC0jYm8uYcgC19Gdtqffw+iRMbPqpMIH5kpQA1TZBkEt6Hzh3UPY/IUjn2zS6G8stL1U2Uw0chJQ/O7DizfOeJb9KRgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":430,"cache_read_input_tokens":27417,"cache_creation":{"ephemeral_5m_input_tokens":430,"ephemeral_1h_input_tokens":0},"output_tokens":6,"service_tier":"standard"}},"requestId":"req_011CWuMPT1DTwvqoipapo6kw","type":"assistant","uuid":"cb3ebcc7-8206-4806-9d0e-c4d49c1b0733","timestamp":"2026-01-08T05:23:37.409Z"}
{"parentUuid":"cb3ebcc7-8206-4806-9d0e-c4d49c1b0733","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01AJFp7nvT9dgg1ME8SdCH6v","type":"message","role":"assistant","content":[{"type":"text","text":"Now I'll perform the replacements to standardize on TS naming."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":430,"cache_read_input_tokens":27417,"cache_creation":{"ephemeral_5m_input_tokens":430,"ephemeral_1h_input_tokens":0},"output_tokens":6,"service_tier":"standard"}},"requestId":"req_011CWuMPT1DTwvqoipapo6kw","type":"assistant","uuid":"efd91118-d22c-48ae-81bd-00f3156e9467","timestamp":"2026-01-08T05:23:38.047Z"}
{"parentUuid":"efd91118-d22c-48ae-81bd-00f3156e9467","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01AJFp7nvT9dgg1ME8SdCH6v","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01QQV3w6J2vVnjHwDJxwg8uE","name":"Edit","input":{"replace_all":true,"file_path":"/mnt/c/Users/o.young/work/architecture/solution_architectures/flybuys_integration.adoc","old_string":"AS-0","new_string":"TS-0"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":430,"cache_read_input_tokens":27417,"cache_creation":{"ephemeral_5m_input_tokens":430,"ephemeral_1h_input_tokens":0},"output_tokens":6,"service_tier":"standard"}},"requestId":"req_011CWuMPT1DTwvqoipapo6kw","type":"assistant","uuid":"c4bbe004-9b3c-4176-81c5-e16d64b359f1","timestamp":"2026-01-08T05:23:38.986Z"}
{"parentUuid":"c4bbe004-9b3c-4176-81c5-e16d64b359f1","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01AJFp7nvT9dgg1ME8SdCH6v","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01GjPsE1L8MT4BhTsB1shCTw","name":"Edit","input":{"replace_all":true,"file_path":"/mnt/c/Users/o.young/work/architecture/solution_architectures/flybuys_integration.adoc","old_string":"AS-1","new_string":"TS-1"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":430,"cache_read_input_tokens":27417,"cache_creation":{"ephemeral_5m_input_tokens":430,"ephemeral_1h_input_tokens":0},"output_tokens":6,"service_tier":"standard"}},"requestId":"req_011CWuMPT1DTwvqoipapo6kw","type":"assistant","uuid":"b52e8339-4bb7-4aa3-b330-5cac806a4f2c","timestamp":"2026-01-08T05:23:39.980Z"}
{"parentUuid":"b52e8339-4bb7-4aa3-b330-5cac806a4f2c","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01AJFp7nvT9dgg1ME8SdCH6v","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01JE6raqjW1Q1o5EKQxcW5HA","name":"Edit","input":{"replace_all":true,"file_path":"/mnt/c/Users/o.young/work/architecture/solution_architectures/flybuys_integration.adoc","old_string":"AS-2","new_string":"TS-2"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":430,"cache_read_input_tokens":27417,"cache_creation":{"ephemeral_5m_input_tokens":430,"ephemeral_1h_input_tokens":0},"output_tokens":6,"service_tier":"standard"}},"requestId":"req_011CWuMPT1DTwvqoipapo6kw","type":"assistant","uuid":"0ba59fd1-0dcd-4e46-93e3-d3dc906424e2","timestamp":"2026-01-08T05:23:40.851Z"}
{"parentUuid":"0ba59fd1-0dcd-4e46-93e3-d3dc906424e2","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01AJFp7nvT9dgg1ME8SdCH6v","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01PgRTv1RgpbHhRL9UQRCAjr","name":"Edit","input":{"replace_all":true,"file_path":"/mnt/c/Users/o.young/work/architecture/solution_architectures/flybuys_integration.adoc","old_string":"AS-3","new_string":"TS-3"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":430,"cache_read_input_tokens":27417,"cache_creation":{"ephemeral_5m_input_tokens":430,"ephemeral_1h_input_tokens":0},"output_tokens":6,"service_tier":"standard"}},"requestId":"req_011CWuMPT1DTwvqoipapo6kw","type":"assistant","uuid":"31988165-a46b-42b2-9cc8-39eae1127ce9","timestamp":"2026-01-08T05:23:41.890Z"}
{"parentUuid":"31988165-a46b-42b2-9cc8-39eae1127ce9","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01AJFp7nvT9dgg1ME8SdCH6v","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Dxg81qB6gSsX2q76SFeAz4","name":"Edit","input":{"replace_all":true,"file_path":"/mnt/c/Users/o.young/work/architecture/solution_architectures/flybuys_integration.adoc","old_string":"AS-4","new_string":"TS-4"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":430,"cache_read_input_tokens":27417,"cache_creation":{"ephemeral_5m_input_tokens":430,"ephemeral_1h_input_tokens":0},"output_tokens":689,"service_tier":"standard"}},"requestId":"req_011CWuMPT1DTwvqoipapo6kw","type":"assistant","uuid":"875a09f8-9496-482a-8fdc-a81a45fa20b9","timestamp":"2026-01-08T05:23:43.329Z"}
{"parentUuid":"c4bbe004-9b3c-4176-81c5-e16d64b359f1","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","type":"user","message":{"role":"user","content":[{"type":"tool_result","content":"The user doesn't want to proceed with this tool use. The tool use was rejected (eg. if it was a file edit, the new_string was NOT written to the file). To tell you how to proceed, the user said:\nDoes TOGAF have a position on this?","is_error":true,"tool_use_id":"toolu_01QQV3w6J2vVnjHwDJxwg8uE"}]},"uuid":"690e0b40-9c66-4be4-a160-0f5b00c16468","timestamp":"2026-01-08T05:27:33.885Z","toolUseResult":"Error: The user doesn't want to proceed with this tool use. The tool use was rejected (eg. if it was a file edit, the new_string was NOT written to the file). To tell you how to proceed, the user said:\nDoes TOGAF have a position on this?","sourceToolAssistantUUID":"c4bbe004-9b3c-4176-81c5-e16d64b359f1"}
{"parentUuid":"b52e8339-4bb7-4aa3-b330-5cac806a4f2c","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","type":"user","message":{"role":"user","content":[{"type":"tool_result","content":"The user doesn't want to proceed with this tool use. The tool use was rejected (eg. if it was a file edit, the new_string was NOT written to the file). STOP what you are doing and wait for the user to tell you how to proceed.","is_error":true,"tool_use_id":"toolu_01GjPsE1L8MT4BhTsB1shCTw"}]},"uuid":"f96dcea5-b420-49ce-8b2d-bc0ad3cdf104","timestamp":"2026-01-08T05:27:40.258Z","toolUseResult":"Error: The user doesn't want to proceed with this tool use. The tool use was rejected (eg. if it was a file edit, the new_string was NOT written to the file). STOP what you are doing and wait for the user to tell you how to proceed.","sourceToolAssistantUUID":"b52e8339-4bb7-4aa3-b330-5cac806a4f2c"}
{"parentUuid":"0ba59fd1-0dcd-4e46-93e3-d3dc906424e2","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","type":"user","message":{"role":"user","content":[{"type":"tool_result","content":"The user doesn't want to take this action right now. STOP what you are doing and wait for the user to tell you how to proceed.","is_error":true,"tool_use_id":"toolu_01JE6raqjW1Q1o5EKQxcW5HA"}]},"uuid":"23894ffe-d512-45ea-bc37-e2741d9d8ddd","timestamp":"2026-01-08T05:27:40.260Z","toolUseResult":"The user doesn't want to take this action right now. STOP what you are doing and wait for the user to tell you how to proceed.","sourceToolAssistantUUID":"0ba59fd1-0dcd-4e46-93e3-d3dc906424e2"}
{"parentUuid":"31988165-a46b-42b2-9cc8-39eae1127ce9","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","type":"user","message":{"role":"user","content":[{"type":"tool_result","content":"The user doesn't want to take this action right now. STOP what you are doing and wait for the user to tell you how to proceed.","is_error":true,"tool_use_id":"toolu_01PgRTv1RgpbHhRL9UQRCAjr"}]},"uuid":"adb069d8-e0a0-45b3-acf6-6ace9db633e9","timestamp":"2026-01-08T05:27:40.261Z","toolUseResult":"The user doesn't want to take this action right now. STOP what you are doing and wait for the user to tell you how to proceed.","sourceToolAssistantUUID":"31988165-a46b-42b2-9cc8-39eae1127ce9"}
{"parentUuid":"875a09f8-9496-482a-8fdc-a81a45fa20b9","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","type":"user","message":{"role":"user","content":[{"type":"tool_result","content":"The user doesn't want to take this action right now. STOP what you are doing and wait for the user to tell you how to proceed.","is_error":true,"tool_use_id":"toolu_01Dxg81qB6gSsX2q76SFeAz4"}]},"uuid":"1839c8fd-9fa8-4987-87f5-a0a1c2b28564","timestamp":"2026-01-08T05:27:40.261Z","toolUseResult":"The user doesn't want to take this action right now. STOP what you are doing and wait for the user to tell you how to proceed.","sourceToolAssistantUUID":"875a09f8-9496-482a-8fdc-a81a45fa20b9"}
{"parentUuid":"1839c8fd-9fa8-4987-87f5-a0a1c2b28564","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","type":"user","message":{"role":"user","content":[{"type":"text","text":"[Request interrupted by user for tool use]"}]},"uuid":"0cd67e8b-70c9-4011-af81-8cd8281cdf01","timestamp":"2026-01-08T05:27:40.262Z"}
{"type":"file-history-snapshot","messageId":"c9adfe5c-49fd-4d85-ae5b-3a1f8da9baf1","snapshot":{"messageId":"c9adfe5c-49fd-4d85-ae5b-3a1f8da9baf1","trackedFileBackups":{},"timestamp":"2026-01-08T05:27:54.029Z"},"isSnapshotUpdate":false}
{"parentUuid":"0cd67e8b-70c9-4011-af81-8cd8281cdf01","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","type":"user","message":{"role":"user","content":"Does TOGAF have a suggestion on this?"},"uuid":"c9adfe5c-49fd-4d85-ae5b-3a1f8da9baf1","timestamp":"2026-01-08T05:27:54.004Z","thinkingMetadata":{"level":"high","disabled":false,"triggers":[]},"todos":[]}
{"parentUuid":"c9adfe5c-49fd-4d85-ae5b-3a1f8da9baf1","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01Fkz2ES476YraW2ZqoFY6wr","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"The user is asking whether TOGAF has a position or suggestion on phase naming conventions. Let me search for TOGAF guidance on this topic.","signature":"ErMCCkYICxgCKkAHE2n/MTc2s9YswzgGCS2sBMk6QErwrPl+wrzC0ao242LAFLk4X+taGQfvS6a3JcgnPR7KikAEFnQwA9HyGiDlEgxwMQ3HVeYxOQXAFt8aDJ5v1iy2qi0HtaS+NyIwpmMFIynyjK6a/S7Ya7yQAwAjT9lYnTnxK0w60tJzGouN/1djGw2Ax944imtvN7NnKpoBUcz185odEuMbxrgTqwvWBEg52gpvjzpbjxX+Mzjq8itqIoBElekn/Wy1YJExsYw5qlrVa9dmlXrHYFlMfT91cwFIDlUiLUnNbNW147cfe+0cApBJHG4LdALXVsqIwT1T2FsapJmcw6j9U8XsUCOPZYTFaWhkntHwLjeN0/OGH0YiJO+MBbIl/KfZ4XJ6mF+7CTMgNmUkCwvIThgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":2429,"cache_read_input_tokens":26101,"cache_creation":{"ephemeral_5m_input_tokens":2429,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CWuMipR6zvWsMedgjwStk","type":"assistant","uuid":"b1014bc8-1763-47ef-858f-e5bb4df479a7","timestamp":"2026-01-08T05:27:56.892Z"}
{"parentUuid":"b1014bc8-1763-47ef-858f-e5bb4df479a7","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01Fkz2ES476YraW2ZqoFY6wr","type":"message","role":"assistant","content":[{"type":"text","text":"Let me search for TOGAF's guidance on phase naming and transition architecture conventions."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":2429,"cache_read_input_tokens":26101,"cache_creation":{"ephemeral_5m_input_tokens":2429,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CWuMipR6zvWsMedgjwStk","type":"assistant","uuid":"30b1a21e-8ad4-4a4a-8a41-9373cfcaefc3","timestamp":"2026-01-08T05:27:57.416Z"}
{"parentUuid":"30b1a21e-8ad4-4a4a-8a41-9373cfcaefc3","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01Fkz2ES476YraW2ZqoFY6wr","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01GccxTWPhrKrWMj4NmKdLB9","name":"WebSearch","input":{"query":"TOGAF transition architecture state naming convention phases"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":2429,"cache_read_input_tokens":26101,"cache_creation":{"ephemeral_5m_input_tokens":2429,"ephemeral_1h_input_tokens":0},"output_tokens":116,"service_tier":"standard"}},"requestId":"req_011CWuMipR6zvWsMedgjwStk","type":"assistant","uuid":"8ff0514b-1627-4ddf-9c9f-2cba854c08cb","timestamp":"2026-01-08T05:27:57.925Z"}
{"parentUuid":"8ff0514b-1627-4ddf-9c9f-2cba854c08cb","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01GccxTWPhrKrWMj4NmKdLB9","type":"tool_result","content":"Web search results for query: \"TOGAF transition architecture state naming convention phases\"\n\nLinks: [{\"title\":\"Architecture States in TOGAF ADM: Strategic Transition from Baseline to Target | by Rashid Baghirov | Medium\",\"url\":\"https://medium.com/@rashidbaghirov/architecture-states-in-togaf-adm-strategic-transition-from-baseline-to-target-bfbfe984600c\"},{\"title\":\"Comprehensive Guide to TOGAF Transition Architectures - Visual Paradigm TOGAF\",\"url\":\"https://togaf.visual-paradigm.com/2025/02/18/comprehensive-guide-to-togaf-transition-architectures/\"},{\"title\":\"TOGAF 10 Deep Dive: Understanding Architecture States, Scopes, and Levels | by Pi | Medium\",\"url\":\"https://medium.com/@piyushraw12/togaf-10-deep-dive-understanding-architecture-states-scopes-and-levels-d1831b2a7cb7\"},{\"title\":\"13 Transition Architecture: Managing Complex Roadmaps\",\"url\":\"https://pubs.opengroup.org/togaf-standard/adm-practitioners/adm-practitioners_13.html\"},{\"title\":\"The TOGAF Standard, Version 9.2 - Migration Planning Techniques\",\"url\":\"https://pubs.opengroup.org/architecture/togaf9-doc/arch/chap24.html\"},{\"title\":\"The TOGAF Standard, Version 9.2 - Architecture Deliverables\",\"url\":\"https://pubs.opengroup.org/architecture/togaf9-doc/arch/chap32.html\"},{\"title\":\"What is a TOGAF Architecture Roadmap?\",\"url\":\"https://goodelearning.com/what-is-a-togaf-architecture-roadmap/\"},{\"title\":\"Understanding in-depth about 10 Phases of TOGAF v 9.2-vinsys\",\"url\":\"https://www.vinsys.com/blog/10-phases-of-togaf-9-2\"},{\"title\":\"Phase E: Opportunities & Solutions\",\"url\":\"https://pubs.opengroup.org/architecture/togaf91-doc/arch/chap13.html\"},{\"title\":\"The TOGAF Standard, Version 9.2 - Introduction to Part II\",\"url\":\"https://pubs.opengroup.org/architecture/togaf9-doc/arch/chap04.html\"}]\n\nBased on the search results, here's information about TOGAF transition architecture state naming conventions and phases:\n\n## Architecture States in TOGAF\n\nTOGAF defines three main architecture states: Baseline Architecture (the current architectural structure), Target Architecture (the desired future state that aligns with strategic goals), and Transition Architecture(s) (one or more intermediate stages between the baseline and target architectures).\n\n## Naming Conventions\n\nFor transition architectures, each distinct parent roadmap should be named and identified appropriately (for example, if there is a separate roadmap for European Union Operations and Australian Operations), and appropriate naming and versioning concepts should be employed for derived roadmaps created for what-if analysis.\n\nA version numbering convention is used within the ADM to illustrate the evolution of Baseline and Target Architecture Definitions, which is described in detail in specific documentation tables.\n\n## Phases Where Transition Architectures Are Developed\n\nTransition Architectures are identified in Phase E (Opportunities and Solutions), where opportunities and solutions are evaluated to bridge gaps between the Baseline and Target Architectures, and are finalized in Phase F (Migration Planning), where detailed migration plans are developed.\n\n## Planning Techniques\n\nTOGAF provides specific techniques including an Architecture Definition Increments table that allows architects to plan a series of Transition Architectures outlining the status of the Enterprise Architecture at specified times, and a Transition Architecture State Evolution table that shows the proposed state of architectures at various levels using the defined taxonomy.\n\n\nREMINDER: You MUST include the sources above in your response to the user using markdown hyperlinks."}]},"uuid":"94f88a44-e339-4a9a-b336-89b1051bf6df","timestamp":"2026-01-08T05:29:08.989Z","toolUseResult":{"query":"TOGAF transition architecture state naming convention phases","results":[{"tool_use_id":"srvtoolu_01PwTLdD8YYcWLEqL7sE8V6Z","content":[{"title":"Architecture States in TOGAF ADM: Strategic Transition from Baseline to Target | by Rashid Baghirov | Medium","url":"https://medium.com/@rashidbaghirov/architecture-states-in-togaf-adm-strategic-transition-from-baseline-to-target-bfbfe984600c"},{"title":"Comprehensive Guide to TOGAF Transition Architectures - Visual Paradigm TOGAF","url":"https://togaf.visual-paradigm.com/2025/02/18/comprehensive-guide-to-togaf-transition-architectures/"},{"title":"TOGAF 10 Deep Dive: Understanding Architecture States, Scopes, and Levels | by Pi | Medium","url":"https://medium.com/@piyushraw12/togaf-10-deep-dive-understanding-architecture-states-scopes-and-levels-d1831b2a7cb7"},{"title":"13 Transition Architecture: Managing Complex Roadmaps","url":"https://pubs.opengroup.org/togaf-standard/adm-practitioners/adm-practitioners_13.html"},{"title":"The TOGAF Standard, Version 9.2 - Migration Planning Techniques","url":"https://pubs.opengroup.org/architecture/togaf9-doc/arch/chap24.html"},{"title":"The TOGAF Standard, Version 9.2 - Architecture Deliverables","url":"https://pubs.opengroup.org/architecture/togaf9-doc/arch/chap32.html"},{"title":"What is a TOGAF Architecture Roadmap?","url":"https://goodelearning.com/what-is-a-togaf-architecture-roadmap/"},{"title":"Understanding in-depth about 10 Phases of TOGAF v 9.2-vinsys","url":"https://www.vinsys.com/blog/10-phases-of-togaf-9-2"},{"title":"Phase E: Opportunities & Solutions","url":"https://pubs.opengroup.org/architecture/togaf91-doc/arch/chap13.html"},{"title":"The TOGAF Standard, Version 9.2 - Introduction to Part II","url":"https://pubs.opengroup.org/architecture/togaf9-doc/arch/chap04.html"}]},"Based on the search results, here's information about TOGAF transition architecture state naming conventions and phases:\n\n## Architecture States in TOGAF\n\nTOGAF defines three main architecture states: Baseline Architecture (the current architectural structure), Target Architecture (the desired future state that aligns with strategic goals), and Transition Architecture(s) (one or more intermediate stages between the baseline and target architectures).\n\n## Naming Conventions\n\nFor transition architectures, each distinct parent roadmap should be named and identified appropriately (for example, if there is a separate roadmap for European Union Operations and Australian Operations), and appropriate naming and versioning concepts should be employed for derived roadmaps created for what-if analysis.\n\nA version numbering convention is used within the ADM to illustrate the evolution of Baseline and Target Architecture Definitions, which is described in detail in specific documentation tables.\n\n## Phases Where Transition Architectures Are Developed\n\nTransition Architectures are identified in Phase E (Opportunities and Solutions), where opportunities and solutions are evaluated to bridge gaps between the Baseline and Target Architectures, and are finalized in Phase F (Migration Planning), where detailed migration plans are developed.\n\n## Planning Techniques\n\nTOGAF provides specific techniques including an Architecture Definition Increments table that allows architects to plan a series of Transition Architectures outlining the status of the Enterprise Architecture at specified times, and a Transition Architecture State Evolution table that shows the proposed state of architectures at various levels using the defined taxonomy."],"durationSeconds":24.484896753000097},"sourceToolAssistantUUID":"8ff0514b-1627-4ddf-9c9f-2cba854c08cb"}
{"parentUuid":"94f88a44-e339-4a9a-b336-89b1051bf6df","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01CvQd6FfN1gvTYoddDJV4jD","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Good, I got some information about TOGAF's approach to transition architectures. Let me get more specific information about their naming conventions.","signature":"Er4CCkYICxgCKkBxsnzAmW/2MoAOVSQxCARunrocC3odubmqFu/yD7CD/QeyJ3deuR82KvJT9qyAmJXsEYjIQGL0WaJo18nsoFkQEgwiSitqp/SeXWn/90UaDEyEgA/5llDoF+fTyyIw31gIfrP5Hw/5ZAW+yIkXDfJ78MEzPHKC5nRbmRQov36qUX07ghBq+75/wndnorujKqUBplPGIu6H3uABb5bR9hCm5bukMcwrlClt3MrCM3DCcsjXjjIWWU7WWHhVz5QIQtfVuflwYLiYOLhNigHyvPM4StmEZxN/wR2rxj6OLHr9LsFiLzgs45xQ0Tsbf9DDQrEGoJg9nXJoaff1if04tR5ipAS4A2wEbWE5nppzew6vEfFJ51HCZ3KSYKPECeWvFzHRTy7vZsc9D6pXyrD+78G5ubh+OgkUGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":1146,"cache_read_input_tokens":28530,"cache_creation":{"ephemeral_5m_input_tokens":1146,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWuMpMKbs716UdfMLXVsB","type":"assistant","uuid":"0b8e8ccb-40c5-4973-9395-0bcc7125b1b2","timestamp":"2026-01-08T05:29:12.972Z"}
{"parentUuid":"0b8e8ccb-40c5-4973-9395-0bcc7125b1b2","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01CvQd6FfN1gvTYoddDJV4jD","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01LjCg2NDb7ya8s3uW2kV2YJ","name":"WebFetch","input":{"url":"https://pubs.opengroup.org/togaf-standard/adm-practitioners/adm-practitioners_13.html","prompt":"What naming conventions does TOGAF recommend for transition architectures? How should intermediate architecture states be numbered or labeled?"}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":1146,"cache_read_input_tokens":28530,"cache_creation":{"ephemeral_5m_input_tokens":1146,"ephemeral_1h_input_tokens":0},"output_tokens":155,"service_tier":"standard"}},"requestId":"req_011CWuMpMKbs716UdfMLXVsB","type":"assistant","uuid":"8e788768-d500-4eb7-b55f-6291b46a2d1a","timestamp":"2026-01-08T05:29:14.256Z"}
{"parentUuid":"8e788768-d500-4eb7-b55f-6291b46a2d1a","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01LjCg2NDb7ya8s3uW2kV2YJ","type":"tool_result","content":"REDIRECT DETECTED: The URL redirects to a different host.\n\nOriginal URL: https://pubs.opengroup.org/togaf-standard/adm-practitioners/adm-practitioners_13.html\nRedirect URL: https://identity.opengroup.org/oauth2/authorize?response_type=code&scope=openid&client_id=J1MVMsuCgZIuKgLLpn596BZ4Kf0a&state=j9kIhceuR60dNHDGOqqRCCP1jMw&redirect_uri=https%3A%2F%2Fpubs.opengroup.org%2Fsso_redirect_uri&nonce=vQN_6t2vGr-YiLVjrDC_eB0PH9FoKTgo712wVGDHBRA\nStatus: 302 Found\n\nTo complete your request, I need to fetch content from the redirected URL. Please use WebFetch again with these parameters:\n- url: \"https://identity.opengroup.org/oauth2/authorize?response_type=code&scope=openid&client_id=J1MVMsuCgZIuKgLLpn596BZ4Kf0a&state=j9kIhceuR60dNHDGOqqRCCP1jMw&redirect_uri=https%3A%2F%2Fpubs.opengroup.org%2Fsso_redirect_uri&nonce=vQN_6t2vGr-YiLVjrDC_eB0PH9FoKTgo712wVGDHBRA\"\n- prompt: \"What naming conventions does TOGAF recommend for transition architectures? How should intermediate architecture states be numbered or labeled?\""}]},"uuid":"814c3a05-a20f-4d29-bcbc-007190d8e7c0","timestamp":"2026-01-08T05:29:31.713Z","toolUseResult":{"bytes":1015,"code":302,"codeText":"Found","result":"REDIRECT DETECTED: The URL redirects to a different host.\n\nOriginal URL: https://pubs.opengroup.org/togaf-standard/adm-practitioners/adm-practitioners_13.html\nRedirect URL: https://identity.opengroup.org/oauth2/authorize?response_type=code&scope=openid&client_id=J1MVMsuCgZIuKgLLpn596BZ4Kf0a&state=j9kIhceuR60dNHDGOqqRCCP1jMw&redirect_uri=https%3A%2F%2Fpubs.opengroup.org%2Fsso_redirect_uri&nonce=vQN_6t2vGr-YiLVjrDC_eB0PH9FoKTgo712wVGDHBRA\nStatus: 302 Found\n\nTo complete your request, I need to fetch content from the redirected URL. Please use WebFetch again with these parameters:\n- url: \"https://identity.opengroup.org/oauth2/authorize?response_type=code&scope=openid&client_id=J1MVMsuCgZIuKgLLpn596BZ4Kf0a&state=j9kIhceuR60dNHDGOqqRCCP1jMw&redirect_uri=https%3A%2F%2Fpubs.opengroup.org%2Fsso_redirect_uri&nonce=vQN_6t2vGr-YiLVjrDC_eB0PH9FoKTgo712wVGDHBRA\"\n- prompt: \"What naming conventions does TOGAF recommend for transition architectures? How should intermediate architecture states be numbered or labeled?\"","durationMs":2221,"url":"https://pubs.opengroup.org/togaf-standard/adm-practitioners/adm-practitioners_13.html"},"sourceToolAssistantUUID":"8e788768-d500-4eb7-b55f-6291b46a2d1a"}
{"parentUuid":"814c3a05-a20f-4d29-bcbc-007190d8e7c0","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01Qt47rXBTxjHGURocrn8Fno","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"The TOGAF site requires authentication. Let me try the other links to get more specific information about naming conventions.","signature":"EqYCCkYICxgCKkADNlmC9uJkuBVJL1Xn775kLtVuXE95MsPktzDdZedqN1MeNHmKL42xrIoJ/hmE+nvcBZCrLQYdSnZY6NBDgM5/Egyl0cTzQu33TmVzq8oaDKUZB9S6kPXJLDxCRyIwEbD6jnsoWLsdPxbAGbIjHve0MLsUezgt2aWi4TPU40RKmQtJV2HNaO9KK4/NiWSQKo0BWzsRnjzPSTpJv3cfdEjZx+vQPtDJW0m2sHdzOR2jzYHDQH6h80BIsCEiCCS+GkJb8mnuMZGcOcdwECJV9Mtl9V4Mo5kiYzSSoVPXHWthEIAj2Y0k1pocInvtt9z0mYPxd+Z4gVXvv3BhH5CZ05WAcNvqYyla6cD74dSYMEQHoUjR07sva5EjSZhMYVpwGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":601,"cache_read_input_tokens":29676,"cache_creation":{"ephemeral_5m_input_tokens":601,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWuMr2ULZV4eMvmHNmBeP","type":"assistant","uuid":"19a6c3a9-cb8b-432b-a862-aeb3cceb3083","timestamp":"2026-01-08T05:29:35.107Z"}
{"parentUuid":"19a6c3a9-cb8b-432b-a862-aeb3cceb3083","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01Qt47rXBTxjHGURocrn8Fno","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01N7iZ1tAzdQ7qymTZaTGht6","name":"WebFetch","input":{"url":"https://medium.com/@rashidbaghirov/architecture-states-in-togaf-adm-strategic-transition-from-baseline-to-target-bfbfe984600c","prompt":"What naming conventions does TOGAF recommend for architecture states and transition architectures? How should they be numbered or labeled?"}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":601,"cache_read_input_tokens":29676,"cache_creation":{"ephemeral_5m_input_tokens":601,"ephemeral_1h_input_tokens":0},"output_tokens":167,"service_tier":"standard"}},"requestId":"req_011CWuMr2ULZV4eMvmHNmBeP","type":"assistant","uuid":"93efc326-9b10-449c-8c64-a159d032c67d","timestamp":"2026-01-08T05:29:37.504Z"}
{"parentUuid":"93efc326-9b10-449c-8c64-a159d032c67d","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","type":"user","message":{"role":"user","content":[{"type":"tool_result","content":"Request failed with status code 403","is_error":true,"tool_use_id":"toolu_01N7iZ1tAzdQ7qymTZaTGht6"}]},"uuid":"1c430c1c-e7dd-4309-81bb-746e9d93251a","timestamp":"2026-01-08T05:30:13.464Z","toolUseResult":"Error: Request failed with status code 403","sourceToolAssistantUUID":"93efc326-9b10-449c-8c64-a159d032c67d"}
{"parentUuid":"1c430c1c-e7dd-4309-81bb-746e9d93251a","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01UMuKUcV2JHBGGAppuYkY3q","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Let me try another source.","signature":"EsIBCkYICxgCKkDt2juDC/QXdmZkJlZrVXlLn+TSHcjEBOSwg+k2vjJL9goCezcGTBEELa756FoSx5TTBLZQhz5EvOZ8tkfLhOq/EgzVQEqI5jZzpCn9y9saDDQx+eCHrQ1jVJKT5iIwuw4Bsz0KHdtqtMGhpArwi6s1GFrEr16B8uPPwvgBSQJ/45ag03AmEbWOdRG1n6W7KiqES14nByqFenGi25qU159W4u+Xoek1yDETQaiFCFyDSuj9DXF8eZIeyfoYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":200,"cache_read_input_tokens":30277,"cache_creation":{"ephemeral_5m_input_tokens":200,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CWuMu6aE7QDoUEabpxC9h","type":"assistant","uuid":"cc7d1e02-d086-43a7-9c30-c8a57b1f78a9","timestamp":"2026-01-08T05:30:18.508Z"}
{"parentUuid":"cc7d1e02-d086-43a7-9c30-c8a57b1f78a9","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01UMuKUcV2JHBGGAppuYkY3q","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01W6n3XaCuz51ZKwTXNpNhgG","name":"WebFetch","input":{"url":"https://togaf.visual-paradigm.com/2025/02/18/comprehensive-guide-to-togaf-transition-architectures/","prompt":"What naming conventions does TOGAF recommend for transition architectures and architecture states? How should intermediate states be numbered or labeled?"}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":200,"cache_read_input_tokens":30277,"cache_creation":{"ephemeral_5m_input_tokens":200,"ephemeral_1h_input_tokens":0},"output_tokens":140,"service_tier":"standard"}},"requestId":"req_011CWuMu6aE7QDoUEabpxC9h","type":"assistant","uuid":"73a3e102-c4ff-4a78-a5fd-225d6b02e5d4","timestamp":"2026-01-08T05:30:20.039Z"}
{"parentUuid":"73a3e102-c4ff-4a78-a5fd-225d6b02e5d4","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01W6n3XaCuz51ZKwTXNpNhgG","type":"tool_result","content":"# TOGAF Transition Architecture Naming Conventions\n\nBased on the provided content, **TOGAF does not specify explicit naming conventions or numbering systems for transition architectures and intermediate states**.\n\nThe guide discusses transition architectures conceptually as:\n\n- **Intermediate stages** between Baseline and Target Architectures\n- **\"Plateaus\"** representing stable architecture states\n- States that progress through **\"incremental states\"** of change\n\nThe document mentions a **\"Transition Architecture State Evolution Table\"** that \"shows the proposed state of the architectures at various levels using the defined taxonomy,\" but it does not detail how to label or number these states.\n\nThe example provided illustrates conceptual progression—\"evolution of the data architecture from on-premises databases to cloud-based data lakes over several transition states\"—without prescribing specific naming formats.\n\n**Conclusion**: Organizations implementing TOGAF would need to establish their own internal naming conventions (such as T1, T2, or Phase 1, Phase 2) based on organizational standards, as the framework provided does not mandate a specific approach to labeling intermediate architectural states."}]},"uuid":"f00dc428-c745-4856-bc94-99cb26b20432","timestamp":"2026-01-08T05:30:27.533Z","toolUseResult":{"bytes":48370,"code":200,"codeText":"OK","result":"# TOGAF Transition Architecture Naming Conventions\n\nBased on the provided content, **TOGAF does not specify explicit naming conventions or numbering systems for transition architectures and intermediate states**.\n\nThe guide discusses transition architectures conceptually as:\n\n- **Intermediate stages** between Baseline and Target Architectures\n- **\"Plateaus\"** representing stable architecture states\n- States that progress through **\"incremental states\"** of change\n\nThe document mentions a **\"Transition Architecture State Evolution Table\"** that \"shows the proposed state of the architectures at various levels using the defined taxonomy,\" but it does not detail how to label or number these states.\n\nThe example provided illustrates conceptual progression—\"evolution of the data architecture from on-premises databases to cloud-based data lakes over several transition states\"—without prescribing specific naming formats.\n\n**Conclusion**: Organizations implementing TOGAF would need to establish their own internal naming conventions (such as T1, T2, or Phase 1, Phase 2) based on organizational standards, as the framework provided does not mandate a specific approach to labeling intermediate architectural states.","durationMs":5925,"url":"https://togaf.visual-paradigm.com/2025/02/18/comprehensive-guide-to-togaf-transition-architectures/"},"sourceToolAssistantUUID":"73a3e102-c4ff-4a78-a5fd-225d6b02e5d4"}
{"parentUuid":"f00dc428-c745-4856-bc94-99cb26b20432","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01PGYmk55RmHBiMQdcYAE4Y1","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Perfect! So TOGAF doesn't prescribe a specific naming convention - organizations can choose their own. This means we have flexibility to choose between AS, TS, or any other convention. The user prefers TS, so we should go with that.","signature":"EpEDCkYICxgCKkBqxMmTEaxpiX+3eG9VxHE6/ju/BYQOZK6LWVzW/QTAry/QeWQe0mRedgT7tOYGDxx21ZGilQ4TSCvuAhfh8mbEEgwbvccSC2VqLhIXCcwaDFRsRaJ6TE9asT73ViIwWHHkRIc+T3rYzxRrjuqGmzKAoaB2dQXtdDMpRclPif0bzw5BxNleTF4FQ97Ob2R3KvgBjY98G6bwlVYPlFhe0lpYC/a3FIp6+pwByF/7ZhPLs63QmpQHVnZGiQ0qDvIa3BeBMvb1Z4vdGemNrZcDJoHeP8fPbedkHRegtICFbqF8LGg2sjQeOsw1eh5X2qmihwFHlKE6fV0p2joAveCPdkWdy909/D3ZjucQmOtbemww8/su/kiyTTmYHCNrzADdadexcTMDukZE4QXyMoZi386yXmZ+yNrl2aqa9rrHC90DJqD3iDksGTwhe7dhxDQteQ4m9cDj+JPXOOp+D7XVZ097MNkLvTj0Aa3yDsC8jPr+Ny1jzPz9NX22axsntoYnmOzi69xoZqui2ukYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":11,"cache_creation_input_tokens":399,"cache_read_input_tokens":30477,"cache_creation":{"ephemeral_5m_input_tokens":399,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWuMv8rRZNRcauA3SjUNA","type":"assistant","uuid":"85522c91-3043-48a5-93e4-a20c40d6fa8a","timestamp":"2026-01-08T05:30:32.193Z"}
{"parentUuid":"85522c91-3043-48a5-93e4-a20c40d6fa8a","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01PGYmk55RmHBiMQdcYAE4Y1","type":"message","role":"assistant","content":[{"type":"text","text":"Based on my research, **TOGAF does not prescribe a specific naming convention for transition architecture states**. The framework defines the concepts of:\n\n- **Baseline Architecture** (current state)\n- **Target Architecture** (desired future state)  \n- **Transition Architecture(s)** (intermediate stages)\n\nHowever, TOGAF leaves the actual naming/numbering convention up to each organization. Common approaches include:\n\n- **Numbered transitions**: T1, T2, T3...\n- **Architecture States**: AS-1, AS-2...\n- **Transition States**: TS-1, TS-2...\n- **Phases**: Phase 1, Phase 2...\n\nSince TOGAF doesn't mandate a specific approach, **TS (Transition State)** is a perfectly valid choice and aligns well with TOGAF's terminology. It clearly indicates these are intermediate transition states between baseline and target.\n\nShould I proceed with standardizing on **TS-0, TS-1, TS-2, TS-3, TS-4** across both documents?\n\n**Sources:**\n- [Comprehensive Guide to TOGAF Transition Architectures - Visual Paradigm TOGAF](https://togaf.visual-paradigm.com/2025/02/18/comprehensive-guide-to-togaf-transition-architectures/)\n- [Transition Architecture: Managing Complex Roadmaps](https://pubs.opengroup.org/togaf-standard/adm-practitioners/adm-practitioners_13.html)\n- [Architecture States in TOGAF ADM: Strategic Transition from Baseline to Target](https://medium.com/@rashidbaghirov/architecture-states-in-togaf-adm-strategic-transition-from-baseline-to-target-bfbfe984600c)"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":11,"cache_creation_input_tokens":399,"cache_read_input_tokens":30477,"cache_creation":{"ephemeral_5m_input_tokens":399,"ephemeral_1h_input_tokens":0},"output_tokens":473,"service_tier":"standard"}},"requestId":"req_011CWuMv8rRZNRcauA3SjUNA","type":"assistant","uuid":"15373483-52b0-474d-b9a4-b09465985e46","timestamp":"2026-01-08T05:30:38.951Z"}
{"parentUuid":"15373483-52b0-474d-b9a4-b09465985e46","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","type":"system","subtype":"turn_duration","durationMs":67932,"timestamp":"2026-01-08T05:30:40.375Z","uuid":"25b398de-8824-49e9-ac6b-86a518e69b71","isMeta":false}
{"type":"file-history-snapshot","messageId":"4de10789-50db-4602-a076-a3626d67309a","snapshot":{"messageId":"4de10789-50db-4602-a076-a3626d67309a","trackedFileBackups":{},"timestamp":"2026-01-08T05:35:41.822Z"},"isSnapshotUpdate":false}
{"parentUuid":"25b398de-8824-49e9-ac6b-86a518e69b71","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","type":"user","message":{"role":"user","content":"Yeh, lets go with TS"},"uuid":"4de10789-50db-4602-a076-a3626d67309a","timestamp":"2026-01-08T05:35:41.799Z","thinkingMetadata":{"level":"high","disabled":false,"triggers":[]},"todos":[]}
{"parentUuid":"4de10789-50db-4602-a076-a3626d67309a","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01BickEzyuCttD2kAT4xxKVF","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"The user wants to proceed with standardizing on TS (Transition State) naming. I need to update the flybuys_integration.adoc file to replace all instances of AS-0, AS-1, AS-2, AS-3, AS-4 with TS-0, TS-1, TS-2, TS-3, TS-4.\n\nI already read a small portion of the file, so I can proceed with the edits using replace_all=true for each replacement.","signature":"Ev8DCkYICxgCKkAyChIiwQqX1uOHWIwL+qldIaQRoZwQk83w+SHgguUX8m8KN17bzLWEjT8r0P9oa/ZEEdLA62hiR/y7DVEzXv17EgxQjtPvHlWsxFSezEAaDAnkwKSppryverxXgiIwipr3BXJuWJIi2/aw77GsUOgZcfaPlb7lTj5Tj6XkUziOMWMnz9UtzRcxUKduCI79KuYCJw9wlCyTZwWP6Sll1vYXlXk9ZZTjognvH1GaRziql+FZHjDj5AxAXjGl6/Zr+rsKvqj/Kjwn/oEbYzFYaUQcJbUkIqOILIUyYNIzGSqufdb+5TpAEUJxumzSVpJJ2IAX+ZxDw8UC+Kh2YLO4rLvbD6RprfTS7wqTSbmG1ECxiNNAjU+saqiXSthwC7eVK8qzhd78knr49tCbdFFg1qdUjf1AHaxPZeIXprc3Xx5m6II+mtjRe6WhQEaYPXR8aP1OlH6GXjr8UEUcfoQej0xzlJ8quhvTMUeDlgAGNMm1EsM4L0hdmg0AXQ9ThfkhS8/ZsGZJQaMWGpcNbtjXVkbGPUCJA79r0eiN+plyZUgXYc//UGGSf1eLArBqYN4S0BLOuqjtaNLNHizfov+uEBsrV77+rOcgQiHNp5FC6a+4P13F69nwfwdufyt4aKDeTSFbjTejHmxf0hBfrsojL+Cq79EZFKuzjBgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":31154,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":31154,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CWuNKJMZrosATnrnjP6aT","type":"assistant","uuid":"f4dfd82d-1828-4de6-a3f0-04b8dc217aa3","timestamp":"2026-01-08T05:35:46.497Z"}
{"parentUuid":"f4dfd82d-1828-4de6-a3f0-04b8dc217aa3","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01BickEzyuCttD2kAT4xxKVF","type":"message","role":"assistant","content":[{"type":"text","text":"I'll standardize the flybuys_integration.adoc file to use TS (Transition State) naming."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":31154,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":31154,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CWuNKJMZrosATnrnjP6aT","type":"assistant","uuid":"6420883f-a01b-4bd6-8b40-9c8c1c3c3437","timestamp":"2026-01-08T05:35:46.789Z"}
{"parentUuid":"6420883f-a01b-4bd6-8b40-9c8c1c3c3437","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01BickEzyuCttD2kAT4xxKVF","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01PpS9NmDVfNf2jTpfJ9A6J2","name":"Edit","input":{"replace_all":true,"file_path":"/mnt/c/Users/o.young/work/architecture/solution_architectures/flybuys_integration.adoc","old_string":"AS-0","new_string":"TS-0"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":31154,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":31154,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CWuNKJMZrosATnrnjP6aT","type":"assistant","uuid":"0b75b486-b8fd-4ae9-9e05-68d0b1bca84a","timestamp":"2026-01-08T05:35:48.490Z"}
{"parentUuid":"0b75b486-b8fd-4ae9-9e05-68d0b1bca84a","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01BickEzyuCttD2kAT4xxKVF","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01KnoQfNNaVUvD62pYLH6e3M","name":"Edit","input":{"replace_all":true,"file_path":"/mnt/c/Users/o.young/work/architecture/solution_architectures/flybuys_integration.adoc","old_string":"AS-1","new_string":"TS-1"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":31154,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":31154,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CWuNKJMZrosATnrnjP6aT","type":"assistant","uuid":"55ea05c1-8873-4c9b-9e4e-02fabceac374","timestamp":"2026-01-08T05:35:49.359Z"}
{"parentUuid":"55ea05c1-8873-4c9b-9e4e-02fabceac374","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01BickEzyuCttD2kAT4xxKVF","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01HkzdBYuKn2mKut3YkHWpxd","name":"Edit","input":{"replace_all":true,"file_path":"/mnt/c/Users/o.young/work/architecture/solution_architectures/flybuys_integration.adoc","old_string":"AS-2","new_string":"TS-2"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":31154,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":31154,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CWuNKJMZrosATnrnjP6aT","type":"assistant","uuid":"6eaebc4c-357f-4dbb-8d84-deeb1bc6d067","timestamp":"2026-01-08T05:35:50.402Z"}
{"parentUuid":"6eaebc4c-357f-4dbb-8d84-deeb1bc6d067","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01BickEzyuCttD2kAT4xxKVF","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01XhUrW7sMsauKYoR3ooyK5d","name":"Edit","input":{"replace_all":true,"file_path":"/mnt/c/Users/o.young/work/architecture/solution_architectures/flybuys_integration.adoc","old_string":"AS-3","new_string":"TS-3"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":31154,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":31154,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CWuNKJMZrosATnrnjP6aT","type":"assistant","uuid":"1aeed9d0-5301-4117-a120-5c8dda65c610","timestamp":"2026-01-08T05:35:51.215Z"}
{"parentUuid":"1aeed9d0-5301-4117-a120-5c8dda65c610","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01BickEzyuCttD2kAT4xxKVF","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01WpUMWdmNRCpC3gMje9E1GC","name":"Edit","input":{"replace_all":true,"file_path":"/mnt/c/Users/o.young/work/architecture/solution_architectures/flybuys_integration.adoc","old_string":"AS-4","new_string":"TS-4"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":31154,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":31154,"ephemeral_1h_input_tokens":0},"output_tokens":793,"service_tier":"standard"}},"requestId":"req_011CWuNKJMZrosATnrnjP6aT","type":"assistant","uuid":"e7b44afe-e313-46b3-8eb2-58e93e46c491","timestamp":"2026-01-08T05:35:52.187Z"}
{"type":"file-history-snapshot","messageId":"0b75b486-b8fd-4ae9-9e05-68d0b1bca84a","snapshot":{"messageId":"4de10789-50db-4602-a076-a3626d67309a","trackedFileBackups":{"solution_architectures/flybuys_integration.adoc":{"backupFileName":"63d414abe912008a@v1","version":1,"backupTime":"2026-01-08T05:38:49.943Z"}},"timestamp":"2026-01-08T05:35:41.822Z"},"isSnapshotUpdate":true}
{"parentUuid":"0b75b486-b8fd-4ae9-9e05-68d0b1bca84a","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01PpS9NmDVfNf2jTpfJ9A6J2","type":"tool_result","content":"The file /mnt/c/Users/o.young/work/architecture/solution_architectures/flybuys_integration.adoc has been updated. All occurrences of 'AS-0' were successfully replaced with 'TS-0'."}]},"uuid":"7cae2c3d-4003-4b38-85c8-b6c913458ec1","timestamp":"2026-01-08T05:38:49.925Z","toolUseResult":{"filePath":"/mnt/c/Users/o.young/work/architecture/solution_architectures/flybuys_integration.adoc","oldString":"AS-0","newString":"TS-0","originalFile":"= Flybuys Integration - Solution Architecture\n\n:project-name: Flybuys Integration\n:togaf-adm-phase: Phase E: Opportunities & Solutions\n:document-type: Solution Architecture Document\n:status: Discovery\n:version: 0.1\n:domain: Loyalty\n:programme-lead: Frankie.Mullaly@vivaenergy.com.au\n:domain-architect: O.Young@otr.com.au\n:business-owner: D.Peisley@otr.com.au\n:business-analyst: Fiona.Cheung@vivaenergy.com.au\n:architecture-definition: xref:../architecture_definitions/flybuys_integration.adoc[Architecture Definitions/Flybuys Integration]\n:doctype: article\n:toc: left\n:toclevels: 4\n:sectanchors:\n:sectxrefs:\n:sectnums:\n:icons: font\n:source-highlighter: highlightjs\n:experimental:\n:description: Solution Architecture Document for Flybuys Coalition Loyalty Integration\n:keywords: loyalty, flybuys, integration, solution-architecture, togaf\n\n== Purpose and Scope\n\n=== Purpose\n\nThis Solution Architecture defines how the Flybuys Integration will be implemented - the specific technology products, configurations, interfaces, and deployment architecture that realise the xref:../architecture_definitions/flybuys_integration.adoc[Flybuys Integration].\n\n<<<\n=== Scope\n\n==== In Scope\n\n* Solution Building Blocks (SBBs) - specific technology products and versions\n* Interface specifications (APIs, events, data formats)\n* Data architecture and schema specifications\n* Transition architecture with phased implementation states\n* Technical validation criteria and testing approach\n* External system integration specifications\n\n==== Out of Scope\n\n===== Covered in xref:../architecture_definitions/flybuys_integration.adoc[Architecture Definition]\n\n* Business requirements and stakeholder analysis\n* Architecture decisions and rationale\n* Bounded context definitions and responsibilities\n* High-level integration patterns (ACL, Conformist, OHS+PL)\n* Business capability mapping and value streams\n* Non-functional requirements (referenced, not duplicated)\n* Architecture principles and governance\n\n===== Covered in other documents\n\n* Detailed design (class diagrams, sequence diagrams for all flows)\n* Implementation code and unit tests\n* Business case and return-on-investment analysis\n* Operational run books and support procedures\n\n<<<\n== Executive Summary\n\nIntegrate xref:../bounded_context/external/flybuys.adoc[Flybuys] Coalition Loyalty across all OTRG Digital and In-Person channels without tightly coupling to external partner systems.\n\nEnable xref:../ubiquitous_language.adoc#customer[Customers] to link their xref:../ubiquitous_language.adoc#flybuys-digital-identity[Flybuys Digital Identity] with their xref:../ubiquitous_language.adoc#otr-app[Mobile Application] user profile, and present unified xref:../ubiquitous_language.adoc#loyalty-credential[Loyalty Credentials] at all xref:../bounded_context/interfaces/otr_pos.adoc[OTR POS] and xref:../bounded_context/interfaces/otr_plus_pos.adoc[OTR+ POS] stores.\n\nThe solution establishes the xref:../ubiquitous_language.adoc#viva-consumer-id-vci[Viva Consumer ID (VCI)] as *the canonical customer identifier* across all integrated systems, ensuring consistent customer reference throughout the loyalty platform and eliminating identity fragmentation.\n\n<<<\n== Solution Approach\n\n* Deploy xref:../bounded_context/profile.adoc[Profile Service] and xref:../bounded_context/loyalty.adoc[Loyalty Service] as bounded context microservices\n* Use NoSQL local document storage with partition key optimisation for caching.\n* Implement **Anti-Corruption Layers** (ACLs) for xref:../bounded_context/external/braze.adoc[Braze], xref:../bounded_context/external/flybuys.adoc[Flybuys] and xref:../bounded_context/external/eagle_eye.adoc[EagleEye] integration\n* Deploy xref:../bounded_context/interfaces/oauth.adoc[OAuth Service] with Key Vault token encryption\n* Establish event-driven architecture as the foundational integration pattern for the platform.\n* Phased roll-out (AS-1 → AS-4)\n\n=== Related Documentation\n\nThis solution architecture references detailed technical specifications:\n\n==== API Specifications\n\n* xref:../specifications/REST/profile-service-v1.yaml.md[Profile Service REST API (OpenAPI 3.0)] - Partner linking, preference management (4 endpoints)\n* xref:../specifications/AsyncAPI/otr-event-bus-v1.yaml.md[Event Bus (AsyncAPI 2.6.0)] - Domain events, CloudEvents 1.0 format\n\n==== Sequence Diagrams\n\n* Flybuys Integration Flows[Flybuys Integration Flows] - Comprehensive diagrams with happy path + error scenarios:\n** Transaction Adjudication (POS real-time, 4 scenarios)\n** OAuth Partner linking (mobile app, 4 scenarios)\n** Batch File Processing (nightly, 3 scenarios)\n** Circuit Breaker State Transitions\n** Event Propagation Timeline\n** OAuth Token Refresh (proactive + errors, 3 scenarios)\n\n==== JSON Schemas\n\n* xref:../specifications/JSON%2520Schemas/.md[JSON Schemas Directory] - Domain event schemas, request/response models\n\n==== Executive Summary\n\n* xref:../executive_summaries/flybuys_integration.adoc[Executive Summary] - 1-page overview for business stakeholders\n\n<<<\n== Key Technology Decisions\n\n[cols=\"1,2,4,3\"]\n|===\n| ID | Kind | Description | Rationale\n\n| DEC-001\n| Implementation\n| .NET 8.0\n| Aligns with OTR platform standards, team expertise in C#\n\n| DEC-002\n| Hosting\n| #TBD#\n| Autoscaling, managed infrastructure, Docker support\n\n| DEC-003\n| NoSQL Database\n| #TBD#\n| Partition key performance, global distribution, TTL support\n\n| DEC-004\n| Event Bus\n| #TBD#\n| CloudEvents 1.0 standard, built-in retry, dead letter queue\n\n| DEC-005\n| Key Storage\n| #TBD#\n| SaaS OAuth provider, Flybuys IDP integration, reduces custom implementation risk\n\n| DEC-006\n| Data Processing\n| #TBD#\n| SFTP connector, PGP encryption, scheduling\n\n| DEC-007\n| Monitoring\n| #TBD#\n| Native Azure integration, distributed tracing, correlation IDs\n\n| DEC-008\n| API Gateway\n| #TBD#\n| OAuth validation, rate limiting, request transformation\n\n| DEC-009\n| Caching Layer\n| #TBD#\n| Reduces Flybuys API load, low-latency access\n\n| DEC-010\n| Mobile App\n| #TBD#\n| Shared business logic, reduces duplicate code for iOS/Android\n\n| DEC-011\n| Authentication\n| xref:../bounded_context/external/microsoft_entra_external_id.adoc[Microsoft Entra External ID]\n| Standardised auth, secure token handling, integrates with mobile app\n\n| DEC-013\n| Resilience\n| #TBD#\n| Circuit breaker, retry policies for external API calls\n\n| DEC-014\n| Configuration / Feature Flags\n| #TBD#\n| Dynamic feature toggling, reduces deployment risk\n\n| DEC-015\n| Transport\n| REST over HTTPS\n|\n\n| DEC-016\n| Observability\n| #TBD#\n|\n\n| DEC-017\n| Deployment\n| #TBD#\n| Docker container + Azure Container Registry\n\n| DEC-018\n| Encryption (At Rest)\n| AES-256\n|\n\n| DEC-019\n| Encryption (In Flight)\n| TLS 1.3\n|\n\n| DEC-020\n| Schema Registry\n| #TBD#\n|\n|===\n\n=== Implementation Constraints\n\n* Must conform to Flybuys API specifications - cannot modify (xref:../architecture_definitions/flybuys_integration.adoc#constraints[CON-002])\n* Flybuys partnership potentially term 2-3 years - architecture must support partner flexibility (xref:../architecture_definitions/flybuys_integration.adoc#constraints[CON-006])\n* OAuth tokens must be `AES-256` encrypted at rest (<<key-technology-decisions,DEC-018>>), `TLS 1.3` in transit (DEC-018 xref:../architecture_definitions/flybuys_integration.adoc#constraints[CON-003])\n* Customer data must reside in Australia East region (xref:../architecture_definitions/flybuys_integration.adoc#constraints[CON-011])\n* Phased rollout required, no big-bang deployment (xref:../architecture_definitions/flybuys_integration.adoc#constraints[CON-004])\n\n=== Success Criteria\n\n* xref:../bounded_context/profile.adoc[Profile Service] / xref:../bounded_context/loyalty.adoc[Loyalty Service] APIs operational with <`500ms` `p95` latency (NFR-001, NFR-002)\n* OAuth linking success rate >95% over 30-day pilot period (7.5 Validation Exit Criteria)\n* Flybuys batch acknowledgement rate >98% for 60 days (NFR-016)\n\n<<<\n== Solution Building Blocks\n\nThis section maps the conceptual *Architecture Building Blocks* (ABBs) defined in the xref:../architecture_definitions/flybuys_integration.adoc[Architecture Definition] to specific *Solution Building Blocks* (SBBs).\n\n=== Technology Portfolio Catalogue\n\nThis catalogue lists all technology components required to implement the Flybuys Integration solution, mapped to the xref:../architecture_definitions/flybuys_integration.adoc#Technology%2520Capability%2520Requirements[Technology Capability Requirements] defined in the Architecture Definition.\n\n[cols=\"1,1,3,1,2,1\"]\n|===\n| Component | Category | Technology Stack | Lifecycle Stage | Rationale | Standards/Patterns\n\n| Event Bus\n| Integration\n| #TBD#\n| Planned\n| Event-driven architecture, loose coupling between services\n| OHS + Published Language\n\n| OAuth Service\n| Infrastructure\n| #TBD#\n| Planned\n| Secure token management, PCI compliance\n| OAuth 2.0, PKCE\n\n| Circuit Breaker\n| Resilience\n| #TBD#\n| Planned\n| Flybuys API failure handling\n| Circuit Breaker Pattern\n\n| Feature Flags\n| Deployment\n| #TBD#\n| Planned\n| Gradual rollout, kill switch for rollback\n| Feature Toggle Pattern\n\n| API Gateway\n| Infrastructure\n| #TBD#\n| Active\n| Single entry point, rate limiting, auth\n| RESTful API, OpenAPI\n\n| NoSQL Database\n| Data Storage\n| #TBD#\n| Active\n| Database per bounded context, high throughput\n| Database per Service\n\n| Key Vault\n| Security\n| #TBD#\n| Active\n| OAuth token storage, encryption keys\n| AES-256, Customer-Managed Keys\n\n| Redis Cache\n| Caching\n| #TBD#\n| Active\n| Flybuys balance caching (5-min TTL), circuit breaker fallback\n| In-Memory Cache, TTL Pattern\n\n| Monitoring Stack\n| Observability\n| #TBD#\n| Active\n| Distributed tracing, metrics, logging\n| OpenTelemetry, Structured Logging\n\n| Identity Provider\n| Authentication\n| xref:../bounded_context/external/microsoft_entra_external_id.adoc[Microsoft Entra External ID]\n| Active\n| Customer authentication, CIAM\n| OAuth 2.0, OIDC\n\n| SFTP Service\n| Integration\n| xref:../bounded_context/external/azure_data_factory.adoc[Azure Data Factory]\n| Active\n| Flybuys batch file transmission\n| SFTP Protocol, Batch File Transfer\n\n| Batch Scheduler\n| Infrastructure\n| xref:../bounded_context/external/azure_data_factory.adoc[Azure Data Factory]\n| Active\n| Nightly batch file generation\n| Cron-based Scheduling\n|===\n\n*Note*: Components marked #TBD# are deferred to implementation phase as engineering choices. See <<key-technology-decisions,Technology Decisions>> for evaluation criteria.\n\n<<<\n\n=== Solution Building Block Mapping\n\n[cols=\"1,3,2,3,4\"]\n|===\n| ABB ID | ABB Name | SBB ID | SBB Name | Technology Product/Component\n\n| ABB-001\n| xref:../bounded_context/profile.adoc[Profile Service] Bounded Context\n| <<sbb-001-profile-service-api,SBB-001>>\n| xref:../bounded_context/profile.adoc[Profile Service] API\n| <<key-technology-decisions,DEC-001 Implementation>>\n\n| ABB-001\n| xref:../bounded_context/profile.adoc[Profile Service] Data Store\n| <<sbb-002-profile-service-database,SBB-002>>\n| xref:../bounded_context/profile.adoc[Profile Service] Database\n| <<key-technology-decisions,DEC-003 NoSQL>>\n\n| ABB-002\n| xref:../bounded_context/loyalty.adoc[Loyalty Service] Bounded Context\n| <<sbb-003-loyalty-service-api,SBB-003>>\n| xref:../bounded_context/loyalty.adoc[Loyalty Service] API\n| <<key-technology-decisions,DEC-001 Implementation>>\n\n| ABB-002\n| xref:../bounded_context/loyalty.adoc[Loyalty Service] Data Store\n| <<sbb-004-loyalty-service-database,SBB-004>>\n| xref:../bounded_context/loyalty.adoc[Loyalty Service] Database\n| <<key-technology-decisions,DEC-003 NoSQL>>\n\n| ABB-006\n| xref:../bounded_context/interfaces/oauth.adoc[OAuth Service]\n| <<sbb-005-oauth-token-manager,SBB-005>>\n| OAuth Token Manager\n| <<key-technology-decisions,DEC-005 Key Storage>>\n\n| ABB-005\n| Event Bus[Event Bus]\n| <<sbb-006-domain-event-bus,SBB-006>>\n| Domain Event Bus\n| <<key-technology-decisions,DEC-004 Event Bus>>\n\n| ABB-004\n| xref:../bounded_context/engagement.adoc[Engagement Service] Bounded Context\n| <<sbb-007-engagement-service-api,SBB-007>>\n| xref:../bounded_context/engagement.adoc[Engagement Service] API\n| <<key-technology-decisions,DEC-001 Implementation>>\n\n| ABB-004\n| xref:../bounded_context/engagement.adoc[Engagement Service] Data Store\n| <<sbb-008-engagement-service-database,SBB-008>>\n| xref:../bounded_context/engagement.adoc[Engagement Service] Datastore\n| <<key-technology-decisions,DEC-003 NoSQL>>\n\n| ABB-012\n| Braze ACL\n| <<sbb-009-braze-integration-adaptor,SBB-009>>\n| xref:../bounded_context/external/braze.adoc[Braze Integration Adaptor]\n| <<key-technology-decisions,DEC-001 Implementation>>\n\n| ABB-013\n| Flybuys ACL\n| <<sbb-010-flybuys-integration-adaptor,SBB-010>>\n| xref:../bounded_context/external/flybuys.adoc[Flybuys Integration Adaptor]\n| <<key-technology-decisions,DEC-001 Implementation>> + <<key-technology-decisions,DEC-006 Data Processing>>\n\n| ABB-014\n| EagleEye ACL\n| <<sbb-011-eagleeye-integration-adaptor,SBB-011>>\n| xref:../bounded_context/external/eagle_eye.adoc[EagleEye Integration Adaptor]\n| <<key-technology-decisions,DEC-001 Implementation>>\n\n| ABB-009\n| Monitoring & Observability\n| <<sbb-012-application-monitoring,SBB-012>>\n| Application Monitoring\n| <<key-technology-decisions,DEC-007 Monitoring>>\n\n| ABB-007\n| API Gateway\n| <<sbb-013-api-gateway,SBB-013>>\n| xref:../bounded_context/interfaces/api_gateway.adoc[API Gateway]\n| <<key-technology-decisions,DEC-008 API Gateway>>\n\n| ABB-010\n| xref:../bounded_context/interfaces/mobile.adoc[Mobile Application]\n| <<sbb-014-otr-mobile-app,SBB-014>>\n| OTR Mobile App\n| <<key-technology-decisions,DEC-010 Mobile Application>>\n\n| ABB-015\n| Points File Management\n| <<sbb-015-batch-file-pipeline,SBB-015>>\n| Batch File Pipeline\n| <<key-technology-decisions,DEC-006 Data Processing>>\n\n| ABB-011\n| Caching Layer\n| <<sbb-016-distributed-cache,SBB-016>>\n| Distributed Cache\n| <<key-technology-decisions,DEC-009 Caching Layer>>\n\n| ABB-008\n| App Config / Feature Flags\n| <<sbb-017-feature-flag-service,SBB-017>>\n| Feature Flags\n|\n\n| ABB-003\n| xref:../bounded_context/location.adoc[Location Service] Bounded Context\n| <<sbb-018-location,SBB-018>>\n| xref:../bounded_context/location.adoc[Location Service] API\n| <<key-technology-decisions,DEC-001 Implementation>>\n\n| ABB-003\n| xref:../bounded_context/location.adoc[Location Service] Data Store\n| <<SBB-019,SBB-019>>\n| xref:../bounded_context/location.adoc[Location Service] Data Store\n|\n|===\n\n<<<\n=== SBB-001: Profile Service API\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| Description\n| Provides APIs for managing customer xref:../ubiquitous_language.adoc#partner-xref[PartnerLink]s with Flybuys, storing reward preferences, and retrieving linked profile data.\n\n| ABB Reference\n| xref:../bounded_context/profile.adoc[Profile Service] Bounded Context (see xref:../architecture_definitions/flybuys_integration.adoc#service-catalogues[Architecture Definition §3.2.1])\n\n| Component Type\n| Microservice (Domain Service)\n\n| Technology Stack\n| <<key-technology-decisions,DEC-001 Implementation>>\n\n| Hosting Platform\n| <<key-technology-decisions,DEC-002 Hosting>>\n\n| API Contract\n| <<key-technology-decisions,DEC-005 Transport>> - See xref:/specifications/rest/profile-service-v1.yaml[OpenAPI 3.0 Specification]\n\n| Authentication\n| <<key-technology-decisions,DEC-011 Authentication>>\n\n| Observability\n| <<key-technology-decisions,DEC-016 Observability>>\n\n| Configuration\n| <<key-technology-decisions,DEC-014 Configuration>>\n\n| Health Checks\n| `/health` HTTPS endpoint\n\n| Deployment Unit\n| <<key-technology-decisions,DEC-017 Deployment>>\n|===\n\n==== Dependencies\n\n[cols=\"2,2,4\"]\n|===\n| SBB ID | Dependency | Reason\n\n| <<sbb-002-profile-service-database,SBB-002>>\n| xref:../bounded_context/profile.adoc[Profile Service] Database\n| xref:../ubiquitous_language.adoc#partner-xref[PartnerLink] aggregate persistence\n\n| <<sbb-005-oauth-token-manager,SBB-005>>\n| OAuth Token Manager\n| xref:../bounded_context/external/flybuys.adoc[Flybuys] OAuth token storage/retrieval\n\n| <<sbb-006-domain-event-bus,SBB-006>>\n| Domain Event Bus\n| Publishing Partnerlinked event schema[Partnerlinked], xref:/specifications/json_schemas/RewardPreferenceChanged.event.schema.json[RewardPreferenceChanged], xref:/specifications/json_schemas/CustomerProfileCreated.event.schema.json[CustomerProfileCreated] events (see AsyncAPI Spec[AsyncAPI Spec])\n\n| <<sbb-010-flybuys-integration-adaptor,SBB-010>>\n| API Gateway\n| Ingress routing, rate limiting, OAuth validation\n\n| Salesforce\n| xref:../bounded_context/external/salesforce.adoc[Salesforce CRM]\n| Upsert Contact record during profile creation (`POST /api/v1/profile/customers`)\n|===\n\n\n<<<\n=== SBB-002: Profile Service Database\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| ABB Reference\n| xref:../bounded_context/profile.adoc[Profile Service] Data Store\n\n| Database Type\n| NoSQL Document Database\n\n| Product\n| <<key-technology-decisions,DEC-003>>\n\n| Consistency\n| Session consistency (default), Strong consistency for PartnerLink operations\n\n| Partition Strategy\n| Partition key: `/vivaConsumerId` (enables single-partition queries, ~10KB documents)\n\n| Throughput\n| Autoscale: 1000-10000 RU/s (scales based on load, avg 4000 RU/s expected)\n\n| Geo-Replication\n| xref:../architecture_definitions/flybuys_integration.adoc#Constraints[CON-011]\n\n| Backup\n| Continuous backup (7-day point-in-time recovery, hourly snapshots)\n\n| Indexes\n| Default indexing + composite index on `[/partner ASC, /status ASC]`\n\n| Containers\n| `partner-links` (main), `customer-profiles` (read model for Salesforce sync)\n\n| Data Residency\n| xref:../architecture_definitions/flybuys_integration.adoc#Constraints[CON-011]\n|===\n\n\n<<<\n=== SBB-003: Loyalty Service API\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| ABB Reference\n| xref:../bounded_context/loyalty.adoc[Loyalty Service] Bounded Context (see xref:../architecture_definitions/flybuys_integration.adoc#service-catalogues[Architecture Definition §3.2.1])\n\n| Component Type\n| Microservice (Domain Service)\n\n| Technology Stack\n| <<key-technology-decisions,DEC-001 Implementation>>\n\n| Hosting Platform\n| <<key-technology-decisions,DEC-002 Hosting>>\n\n| API Contract\n| <<key-technology-decisions,DEC-005 Transport>> - See xref:../specifications/REST/loyalty-service-v1.yaml[OpenAPI 3.0 Specification]\n\n| Batch Processing\n| <<key-technology-decisions,DEC-012 Batch Processing>>\n\n| Authentication\n| <<key-technology-decisions,DEC-011 Authentication>>\n\n| Observability\n| <<key-technology-decisions,DEC-016 Observability>>\n\n| Configuration\n| <<key-technology-decisions,DEC-014 Configuration>>\n\n| Health Checks\n| `/health` HTTPS endpoint\n\n| Deployment Unit\n| <<key-technology-decisions,DEC-017 Deployment>>\n|===\n\n==== Capabilities\n\n===== Loyalty Credential Resolution\n\n* Resolves EAN-13 barcodes from xref:../bounded_context/interfaces/otr_pos.adoc[OTR POS] and xref:../bounded_context/interfaces/otr_plus_pos.adoc[OTR+ POS] scanners to xref:../ubiquitous_language.adoc#viva-consumer-id-vci[Viva Consumer Id (VCI)]\n* Supports all xref:../ubiquitous_language.adoc#loyalty-credential[Loyalty Credential] types:\n** Barcode from xref:../bounded_context/interfaces/mobile.adoc[OTR Mobile],\n** Barcode from xref:../bounded_context/interfaces/mobile.adoc[SPS Mobile],\n** xref:../bounded_context/interfaces/mobile.adoc[Apple/Google Wallet passes],\n** Physical Flybuys cards,\n** Flybuys Mobile barcodes\n* Resolved Loyalty Credentials to\n** Direct resolution for OTR credentials (barcode → VCI)\n** Indirect resolution for Flybuys credentials (barcode → PartnerLink → VCI)\n* Returns customer context (VCI, reward preference, wallet ID) to POS within 500ms p95 (xref:../architecture_definitions/flybuys_integration.adoc#non-functional-requirements[NFR-002])\n\n==== Dependencies\n\n[cols=\"2,3,5\"]\n|===\n| SBB ID | Dependency | Reason\n\n| <<SBB-004 Loyalty Service Database,SBB-004>>\n| xref:../bounded_context/loyalty.adoc[Loyalty Service] Database\n| xref:../ubiquitous_language.adoc#reward-transaction[RewardTransaction] aggregate persistence\n\n| <<SBB-001 Profile Service API,SBB-001>>\n| xref:../bounded_context/profile.adoc[Profile Service] API\n| PartnerLink lookup for Flybuys credential resolution\n\n| <<SBB-006 Domain Event Bus,SBB-006>>\n| Domain Event Bus\n| Consuming xref:../specifications/JSON%2520Schemas/Partnerlinked.event.schema.json[Partnerlinked] events, publishing xref:../specifications/JSON%2520Schemas/TransactionAdjudicated.event.schema.json[TransactionAdjudicated] events (see xref:../specifications/AsyncAPI/otr-event-bus-v1.yaml[AsyncAPI Spec])\n\n| <<SBB-007 Flybuys Integration Adapter,SBB-007>>\n| xref:../bounded_context/external/flybuys.adoc[Flybuys Integration Adapter]\n| Balance queries, batch file transmission\n\n| <<SBB-008 EagleEye Integration Adapter,SBB-008>>\n| xref:../bounded_context/external/eagle_eye.adoc[EagleEye Integration Adapter]\n| Transaction Adjudication, wallet queries\n\n| <<SBB-010 API Gateway,SBB-010>>\n| xref:../bounded_context/interfaces/api_gateway.adoc[API Gateway]\n| Ingress routing for mobile app and POS systems\n\n| <<SBB-013 Distributed Cache,SBB-013>>\n| Distributed Cache\n| Caching Flybuys balance queries\n|===\n\n\n<<<\n=== SBB-004: Loyalty Service Database\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| ABB Reference\n| xref:../bounded_context/loyalty.adoc[Loyalty Service] Data Store\n\n| Database Type\n| NoSQL Document Database\n\n| Product\n| <<key-technology-decisions,DEC-003>>\n\n| Consistency\n| Session consistency (eventual consistency acceptable for audit trail)\n\n| Partition Strategy\n| Partition key: `/vivaConsumerId` (enables single-partition transaction queries)\n\n| Throughput\n| Autoscale: 1000-20000 RU/s (higher peak for POS transaction volume)\n\n| Geo-Replication\n| xref:../architecture_definitions/flybuys_integration.adoc#Constraints[CON-011]\n\n| Backup\n| Continuous backup (7-day point-in-time recovery)\n\n| TTL\n| 2592000 seconds (30 days) - automatic deletion for RewardTransaction documents\n\n| Indexes\n| Default indexing + range index on `/transactionDate DESC` for recent queries\n\n| Containers\n| `reward-transactions` (audit trail with 30-day TTL)\n\n| Data Residency\n| xref:../architecture_definitions/flybuys_integration.adoc#Constraints[CON-011]\n|===\n\n\n<<<\n=== SBB-005: OAuth Token Manager\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| ABB Reference\n| OAuth Service (Infrastructure)\n\n| Component Type\n| Infrastructure Service (OAuth provider + secure token storage)\n\n| Token Storage\n| <<key-technology-decisions,DEC-005>>\n\n| Token Format\n| https://www.oauth.com/oauth2-servers/access-tokens/\n\n| Secret Naming\n| `\\{partner}-token-{vivaConsumerId}` (e.g., `flybuys-token-vci_xyz789abc`)\n\n| Refresh Logic\n| Azure Function (Timer trigger every 50 minutes, before 60-minute expiry)\n\n| Encryption\n|\n|===\n\n==== OAuth Token Refresh Flow\n\nSee detailed sequence diagrams in #oauth-token-refresh-flow[Sequence Diagrams] for error scenarios including token expiry and API unavailability.\n\n[mermaid]\n----\nsequenceDiagram\n    autonumber\n    participant Timer as Azure Function<br/>(Timer Trigger)\n    participant TokenManager as OAuth Token Manager\n    participant KeyVault as Azure Key Vault\n    participant FlybuysOAuth as Flybuys OAuth Server\n    participant DB as Profile Database\n    participant Monitor as Monitoring\n\n    Note over Timer,Monitor: Timer trigger: Every 50 minutes\n\n    Timer->>TokenManager: Trigger token refresh job\n\n    activate TokenManager\n    TokenManager->>DB: Query PartnerLinks<br/>WHERE partner=\"FLYBUYS\" AND status=\"linked\"\n    activate DB\n    DB-->>TokenManager: 10,000 active PartnerLinks\n    deactivate DB\n\n    loop For each PartnerLink (batch of 100)\n        TokenManager->>KeyVault: Get token<br/>SecretName: flybuys-token-{vci}\n        activate KeyVault\n        KeyVault-->>TokenManager: {access_token, refresh_token, expiresAt}\n        deactivate KeyVault\n\n        TokenManager->>TokenManager: Check: expiresAt - now < 10 minutes?\n\n        alt Token expiring soon\n            TokenManager->>FlybuysOAuth: POST /token<br/>{grant_type: \"refresh_token\", refresh_token}\n            activate FlybuysOAuth\n            FlybuysOAuth->>FlybuysOAuth: Validate refresh_token\n            FlybuysOAuth-->>TokenManager: {access_token (new), refresh_token (new), expires_in: 3600}\n            deactivate FlybuysOAuth\n\n            TokenManager->>KeyVault: Update secret<br/>flybuys-token-{vci}\n            activate KeyVault\n            KeyVault-->>TokenManager: Secret updated\n            deactivate KeyVault\n\n            TokenManager->>Monitor: Metric: token_refresh_success\n        else Token still valid\n            TokenManager->>Monitor: Metric: token_refresh_skipped\n        end\n    end\n\n    TokenManager-->>Timer: Job complete<br/>Refreshed: 8,500 tokens<br/>Skipped: 1,500 tokens\n    deactivate TokenManager\n\n    Timer->>Monitor: Log job duration: 45 seconds\n----\n\n==== Dependencies\n\n[cols=\"2,2,4\"]\n|===\n| SBB ID | Dependency | Reason\n\n| <<SBB-001 Profile Service API,SBB-001>>\n| xref:../bounded_context/profile.adoc[Profile Service]\n| Initiates OAuth flow, stores `oauthTokenReference` in PartnerLink\n\n| External\n| OAuth Provider\n| Flybuys OAuth API integration\n|===\n\n\n<<<\n=== SBB-006: Domain Event Bus\n\n==== Event Specifications\n\nSee xref:../specifications/AsyncAPI/otr-event-bus-v1.yaml[AsyncAPI 2.6.0 Specification] for complete event definitions, schemas, and examples. Individual event schemas available in xref:../specifications/JSON%2520Schemas[JSON Schemas directory].\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| ABB Reference\n| Domain Event Bus\n\n| Platform\n| <<key-technology-decisions,DEC-004>>\n\n| Retention\n| 7 days (with dead letter queue for failed deliveries)\n\n| Schema Registry\n| <<key-technology-decisions,DEC-020>>\n\n| Delivery Guarantee\n| At-least-once delivery with retry (max 30 attempts, exponential backoff)\n\n| Monitoring\n| <<key-technology-decisions,DEC-007>>\n|===\n\n===== Topics\n\n*Profile Events* (`profile.events` topic)\n\n[cols=\"2,3,1\"]\n|===\n| Event Name | Description | Schema\n\n| `PartnerLinked`\n| Partner account linked to customer profile\n| PartnerLinked event schema[Schema]\n\n| `PartnerUnlinked`\n| Partner account unlinked from customer\n| xref:../specifications/JSON%2520Schemas/PartnerUnlinked.event.schema.json[Schema]\n\n| `RewardPreferenceChanged`\n| Customer changed reward preference selection\n| xref:../specifications/JSON%2520Schemas/RewardPreferenceChanged.event.schema.json[Schema]\n|===\n\n*Loyalty Events* (`loyalty.events` topic)\n\n[cols=\"2,3,1\"]\n|===\n| Event Name | Description | Schema\n\n| `CustomerProfileCreated`\n| Customer profile created during Just-In-Time Integration\n| xref:../specifications/JSON%2520Schemas/CustomerProfileCreated.event.schema.json[Schema]\n\n| `TransactionAdjudicated`\n| Transaction Adjudication completed\n| xref:../specifications/JSON%2520Schemas/TransactionAdjudicated.event.schema.json[Schema]\n\n| `PointsEarned`\n| Points earned in loyalty programme\n| xref:../specifications/JSON%2520Schemas/PointsEarned.event.schema.json[Schema]\n\n| `FuelDiscountApplied`\n| Fuel discount applied to transaction\n| xref:../specifications/JSON%2520Schemas/FuelDiscountApplied.event.schema.json[Schema]\n\n| `RewardTransactionFailed`\n| Transaction adjudication failed\n| xref:../specifications/JSON%2520Schemas/RewardTransactionFailed.event.schema.json[Schema]\n\n| `PointsRedeemed`\n| Points redeemed in loyalty programme\n| _Planned_\n\n| `PointsExpired`\n| Points expired\n| _Planned_\n\n| `GrantIssued`\n| Loyalty grant issued\n| _Planned_\n\n| `GrantRedeemed`\n| Loyalty grant redeemed\n| _Planned_\n\n| `FlybuysPointsEarned`\n| Points earned in Flybuys programme\n| _Planned_\n\n| `FlybuysBalanceUpdated`\n| Flybuys points balance changed\n| _Planned_\n\n| `PartnerAccountlinked`\n| Flybuys member linked (OAuth complete)\n| _Planned_\n\n| `PartnerAccountUnlinked`\n| Flybuys member unlinked\n| _Planned_\n\n| `DailyPointsFileGenerated`\n| Daily partner points file generated\n| _Planned_\n\n| `DailyPointsFileTransmitted`\n| Daily points file sent to partner\n| _Planned_\n\n| `DailyPointsFileAcknowledged`\n| Partner acknowledged file receipt\n| _Planned_\n|===\n\n==== Event Documentation\n\nSee xref:../specifications/AsyncAPI/otr-event-bus-v1.yaml[AsyncAPI Specification] for complete event definitions with examples, or xref:../bounded_context/loyalty.cml[Bounded Context/loyalty.cml] for CML domain model. CloudEvents 1.0 specification used for all domain events.\n\n==== Event Propagation Timeline\n\nSee detailed sequence diagrams in #event-propagation-timeline[Sequence Diagrams] for out-of-order event handling and version-based conflict resolution.\n\n[mermaid]\n----\nsequenceDiagram\n    autonumber\n    participant Mobile as Mobile App\n    participant Profile as Profile Service\n    participant EventBus as Event Bus\n    participant Loyalty as Loyalty Service\n    participant Engagement as Engagement Service\n\n    Note over Mobile,Engagement: T=0: OAuth linking completes\n\n    Mobile->>Profile: POST /partners\n    activate Profile\n    Profile->>Profile: Store PartnerLink (status: linked)\n    Profile->>Profile: Commit database transaction\n\n    Note over Profile: T+50ms: Transaction committed\n\n    Profile->>EventBus: Publish Partnerlinked event<br/>{vivaConsumerId, partner, externalMemberId}\n    activate EventBus\n    EventBus->>EventBus: Persist event (durability guarantee)\n    EventBus-->>Profile: Event ID: evt-123456\n    deactivate EventBus\n\n    Profile-->>Mobile: 201 Created {PartnerLinkId}\n    deactivate Profile\n\n    Note over EventBus: T+100ms: Event persisted\n\n    par Parallel Event Delivery\n        EventBus->>Loyalty: Deliver Partnerlinked event\n        activate Loyalty\n        Loyalty->>Loyalty: Update reward preference cache<br/>(vivaConsumerId → FLYBUYS_POINTS)\n        Loyalty-->>EventBus: ACK\n        deactivate Loyalty\n\n        Note over Loyalty: T+200ms: Cache updated\n    and\n        EventBus->>Engagement: Deliver Partnerlinked event\n        activate Engagement\n        Engagement->>Engagement: Trigger welcome campaign<br/>\"Earn Flybuys points at OTR\"\n        Engagement-->>EventBus: ACK\n        deactivate Engagement\n\n        Note over Engagement: T+500ms: Campaign triggered\n    end\n\n    Note over Mobile,Engagement: Eventual consistency achieved within 500ms\n----\n\n==== Event Flow\n\n[cols=\"2,3\"]\n|===\n| From | To\n\n| xref:../bounded_context/profile.adoc[Profile Service]\n| xref:../bounded_context/loyalty.adoc[Loyalty Service]\n\n| xref:../bounded_context/profile.adoc[Profile Service]\n| xref:../bounded_context/engagement.adoc[Engagement Service]\n\n| xref:../bounded_context/profile.adoc[Profile Service]\n| xref:../bounded_context/recommendation.adoc[Recommendation Service]\n\n| xref:../bounded_context/loyalty.adoc[Loyalty Service]\n| xref:../bounded_context/engagement.adoc[Engagement Service]\n\n| xref:../bounded_context/loyalty.adoc[Loyalty Service]\n| xref:../bounded_context/recommendation.adoc[Recommendation Service]\n|===\n\n\n<<<\n=== SBB-007: Engagement Service API\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| ABB Reference\n| Engagement Service (Bounded Context)\n\n| Component Type\n| Microservice (Event Consumer + Anti-Corruption Layer)\n\n| Implementation\n| <<key-technology-decisions,DEC-001>>\n\n| Hosting\n| <<key-technology-decisions,DEC-002>>\n\n| Database\n| <<sbb-008-engagement-service-database,SBB-008>>\n\n| Event Subscriptions\n| `profile.events.*`, `loyalty.events.*` (all Profile and Loyalty domain events)\n\n| External Integration\n| xref:../bounded_context/external/braze.adoc[Braze] (via ACL)\n|===\n\n==== Responsibilities\n\n* *Event Relay*: Relay domain events to xref:../bounded_context/external/braze.adoc[Braze] webhooks to enable transactional Customer communications\n** *Event-Driven Campaign Triggers*: Consumes domain events from Profile Service and Loyalty Service\n** *Braze Anti-Corruption Layer*: Translates OTRG domain events into xref:../bounded_context/external/braze.adoc[Braze] webhook payloads\n** *Customer Notification Orchestration*: Triggers push notifications, emails, in-app messages\n* *Campaign State Management*: Tracks campaign eligibility and notification delivery status\n\n==== Key Events Consumed\n\n[cols=\"1,2,3\"]\n|===\n| Event Source | Event Name | Campaign Trigger\n\n| Profile Service\n| `Partnerlinked`\n| Welcome campaign: \"_You're earning Flybuys points now!_\"\n\n| Profile Service\n| `RewardPreferenceChanged`\n| Confirmation: \"_Reward preference updated_\"\n\n| Loyalty Service\n| `TransactionAdjudicated`\n| Transaction confirmation: \"_You earned 150 Flybuys pts_\"\n\n| Loyalty Service\n| `PointsEarned`\n| Points milestone: \"_You've earned 1000 points this week_\"\n\n| Loyalty Service\n| `RewardTransactionFailed`\n| Error notification: \"_Transaction processing delayed_\"\n|===\n\n\n<<<\n=== SBB-008: Engagement Service Database\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| ABB Reference\n| Engagement Service Data Store\n\n| Platform\n| <<key-technology-decisions,DEC-003>>\n\n| Purpose\n| Campaign state tracking, notification delivery history\n\n| Data Residency\n| Australia East (primary), Australia Southeast (failover)\n\n| Retention\n| 90 days (notification history), indefinite (campaign state)\n|===\n\n\n<<<\n=== SBB-009: Braze Integration Adaptor\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| ABB Reference\n| Braze ACL\n\n| Component Type\n| Data Egress Anti-Corruption Layer (ACL) - Conformist pattern\n\n| Implementation\n| Referenced by xref:../bounded_context/engagement.adoc[Engagement Service]\n\n| External APIs\n| Braze REST API v3 (User Tracking API)\n\n| Webhook URL\n| `\\https://rest.iad-06.braze.com/`\n\n| Endpoint\n| xref:https://www.braze.com/docs/api/endpoints/user_data/post_user_track/[`/users/track`]\n\n| Circuit Breaker\n| 5 consecutive failures → open circuit, 30s timeout\n\n| Retry Policy\n| Exponential backoff: 3 retries (2s, 4s, 8s delays) for transient failures (5xx errors)\n\n| API Key Management\n| API key stored in Azure Key Vault\n\n| Rate Limits\n| 250 requests/minute per API key (Braze SLA)\n\n| Event Processing Latency\n| <500ms p95 (from Event Bus delivery to Braze webhook trigger)\n\n| Braze Webhook Timeout\n| 5 seconds (with retry logic)\n\n| Event Throughput\n| 1000 events/minute sustained\n|===\n\n==== Dependencies\n\n[cols=\"2,2,3\"]\n|===\n| SBB ID | Dependency | Reason\n\n| <<sbb-006-domain-event-bus,SBB-006 Domain Event Bus>>\n| Event subscriptions\n| Consumes Partnerlinked, TransactionAdjudicated events\n\n| xref:../bounded_context/profile.adoc[Profile Service]\n| Customer profile\n| Enriches event data with customer attributes (optional)\n|===\n\n\n<<<\n=== SBB-010: Flybuys Integration Adaptor\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| ABB Reference\n| Flybuys ACL\n\n| Component Type\n| Anti-Corruption Layer (ACL) - Conformist pattern (reference ADR-003 in ADD)\n\n| Implementation\n| #TBD# (referenced by xref:../bounded_context/loyalty.adoc[Loyalty Service], conforms to Flybuys API)\n\n| External APIs\n| Flybuys OAuth API, Balance API (`GET /v1/members/\\{id}/balance`), Docket API\n\n| Batch SFTP\n| #TBD# (Batch processing with SFTP connector, SSH key auth, PGP 2048-bit encryption)\n\n| Circuit Breaker\n| #TBD#\n\n| Caching\n| #TBD# (Distributed cache, 5-minute TTL for balance queries, reduces Flybuys API load)\n\n| Retry Policy\n| Exponential backoff: 3 retries (2s, 4s, 8s delays) for transient failures\n|===\n\n*Flybuys Implementation*: `FlybuysPointsServiceAdapter` (conforms to Flybuys CSV batch file spec v3.2)\n\n\n<<<\n=== SBB-011: EagleEye Integration Adaptor\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| ABB Reference\n| EagleEye ACL\n\n| Component Type\n| Anti-Corruption Layer (ACL)\n\n| Implementation\n| #TBD#(referenced by xref:../bounded_context/loyalty.adoc[Loyalty Service])\n\n| External APIs\n| EagleEye REST API v3 (wallet, campaigns, Transaction Adjudication)\n\n| Circuit Breaker\n| #TBD# (5 consecutive failures → open circuit, 30s timeout)\n\n| Retry Policy\n| Exponential backoff: 3 retries (2s, 4s, 8s delays)\n\n| API Key Management\n| API key stored in #TBD# (secure key vault service)\n\n| Rate Limits\n| 1000 requests/minute per API key (EagleEye SLA)\n|===\n\n\n<<<\n=== SBB-012: Application Monitoring\n\n[cols=\"1,3\"]\n|===\n| MAttribute | Specification\n\n| ABB Reference\n| Monitoring & Observability\n\n| Platform\n| xref:#Key_Technology_Decisions[DEC-007]\n\n| Application Insights\n| #TBD# (Workspace-based shared across xref:../bounded_context/profile.adoc[Profile Service], xref:../bounded_context/loyalty.adoc[Loyalty Service])\n\n| Instrumentation\n| #TBD# (SDK for distributed tracing, OpenTelemetry support)\n\n| Log Aggregation\n| Structured logging (Serilog) → #TBD# (centralized log aggregation with query language)\n\n| Metrics\n| Custom metrics: API latency (p50/p95/p99), OAuth success rate, batch file acknowledgement rate\n\n| Distributed Tracing\n| W3C Trace Context standard (see <<Correlation ID Propagation Specification,Correlation ID Specification>>)\n\n| Dashboards\n| #TBD# (Flybuys Integration Health, Customer Adoption Metrics dashboards)\n|===\n\n*Alerting*:\n\n* Critical: xref:../bounded_context/profile.adoc[Profile Service] API error rate > 5% → PagerDuty (on-call architect)\n* Critical: Batch file generation fails → Immediate alert to xref:../bounded_context/loyalty.adoc[Loyalty Service] team\n* Warning: Flybuys API latency > 3s p95 → Slack alert\n\n\n<<<\n=== SBB-013: API Gateway\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| ABB Reference\n| API Gateway\n\n| Platform\n| xref:#Key_Technology_Decisions[DEC-008]\n\n| Base URL\n| `\\https://api.otr.com.au`\n\n| Authentication\n| xref:#Key_Technology_Decisions[DEC-011]\n\n| Rate Limiting\n| 1000 requests/minute per user, 10000 requests/minute global\n\n| Policies\n| JWT validation, rate limiting, CORS, request/response transformation\n\n| TLS\n| xref:#Key_Technology_Decisions[DEC-019]\n|===\n\n\n<<<\n=== SBB-014: OTR Mobile App\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| ABB Reference\n| Mobile Application (Presentation Layer)\n\n| Platform\n| xref:#Key_Technology_Decisions[DEC-011]\n\n| Deployment\n| App Store (iOS), Google Play (Android)\n\n| Authentication\n| xref:#Key_Technology_Decisions[DEC-011]\n|===\n\n==== Integration\n\n[cols=\"2,3\"]\n|===\n| Integration | Description\n\n| <<SBB-001 Profile Service API,SBB-001 Profile Service API>>\n| Partner linking\n\n| <<SBB-003 Loyalty Service API,SBB-003 Loyalty Service API>>\n| Balance queries / Transaction history\n|===\n\n\n<<<\n=== SBB-015: Batch File Pipeline\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| ABB Reference\n| Batch Processing\n\n| Orchestration\n| #TBD# (Batch pipeline scheduled 01:00 UTC daily)\n\n| Generation Logic\n| #TBD# (Serverless functions for transaction aggregation)\n\n| SFTP Transfer\n| #TBD# (SFTP connector with SSH key authentication)\n\n| PGP Encryption\n| #TBD# (PGP encryption activity, Flybuys 2048-bit RSA public key)\n\n| File Format\n| CSV (UTF-8 with BOM, CRLF line endings, max 200MB / 100k transactions)\n\n| Acknowledgement\n| #TBD# (SFTP polling to read acknowledgement file from Flybuys)\n\n| Batch File Naming\n| `OTR_TRANSACTIONS_\\{YYYYMMDD}_{HHMMSS}.csv.pgp`\n|===\n\n==== Batch File Processing Flow\n\nSee detailed sequence diagrams in #batch-file-retry-flow[Sequence Diagrams] for happy path and error scenarios.\n\n[mermaid]\n----\nsequenceDiagram\n    autonumber\n    participant Scheduler as Azure Data Factory<br/>(Batch Scheduler)\n    participant Loyalty as Loyalty Service\n    participant DB as Loyalty Database\n    participant SFTP as Flybuys SFTP\n    participant Flybuys as Flybuys Processing\n    participant Monitor as Monitoring\n\n    Note over Scheduler,Monitor: Nightly batch window: 01:00-02:00 UTC\n\n    Scheduler->>Loyalty: Timer trigger: 01:00 UTC<br/>Start batch job\n\n    activate Loyalty\n    Loyalty->>DB: Query RewardTransactions<br/>WHERE status=\"PENDING\"<br/>AND transactionDate=yesterday\n    activate DB\n    DB-->>Loyalty: 10,000 transactions\n    deactivate DB\n\n    Note over Loyalty: Aggregate by externalMemberId\n\n    Loyalty->>Loyalty: Generate CSV<br/>Format: memberId,date,points,storeId\n    Loyalty->>Loyalty: PGP encrypt with Flybuys public key\n    Loyalty->>Loyalty: Generate filename<br/>OTR_TRANSACTIONS_20251212_010000.csv.pgp\n\n    Loyalty->>SFTP: Upload batch file<br/>(15 minutes, 2MB file)\n    activate SFTP\n    SFTP-->>Loyalty: Upload complete\n    deactivate SFTP\n\n    Loyalty->>DB: Update RewardTransactions<br/>SET batchFileId=\"OTR_TRANSACTIONS_20251212_010000.csv.pgp\"\n    activate DB\n    DB-->>Loyalty: 10,000 rows updated\n    deactivate DB\n\n    Loyalty-->>Scheduler: Job complete (duration: 60 min)\n    deactivate Loyalty\n\n    Scheduler->>Monitor: Log success metric<br/>batch_file_generation_duration_seconds\n\n    Note over Flybuys: Flybuys processes file (2-4 hours)\n\n    Flybuys->>SFTP: Upload acknowledgement file<br/>OTR_TRANSACTIONS_20251212_010000.ack\n\n    Note over Scheduler,Monitor: Acknowledgement polling (every 30 minutes)\n\n    Scheduler->>Loyalty: Poll for acknowledgement\n    activate Loyalty\n    Loyalty->>SFTP: Check for .ack file\n    activate SFTP\n    SFTP-->>Loyalty: Found: 9,800 accepted, 200 rejected\n    deactivate SFTP\n\n    Loyalty->>DB: Update status=\"COMPLETED\" (9,800 rows)<br/>SET status=\"FAILED\" (200 rows)\n    activate DB\n    DB-->>Loyalty: Updates complete\n    deactivate DB\n\n    Loyalty-->>Scheduler: Acknowledgement processed\n    deactivate Loyalty\n\n    Scheduler->>Monitor: Log metric<br/>batch_acknowledgement_rate=98%\n----\n\n\n<<<\n=== SBB-016: Distributed Cache\n\n*ABB Reference*: Caching Layer (for Flybuys balance queries)\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| Platform\n| #TBD# (In-memory distributed cache)\n\n| Purpose\n| Cache Flybuys balance queries (5-minute TTL, reduces external API load)\n\n| Eviction Policy\n| Volatile-ttl (evict keys with shortest TTL when memory full)\n\n| Persistence\n| Not enabled (cache can be regenerated from Flybuys API)\n\n| Cache Key Format\n| `flybuys:balance:\\{externalMemberId}` (e.g., `flybuys:balance:123456789012`)\n|===\n\n==== Circuit Breaker Pattern\n\nThe distributed cache works in conjunction with circuit breakers to provide graceful degradation when external APIs fail.\n\nSee detailed sequence diagrams in #circuit-breaker-state-transitions[Sequence Diagrams] for complete state transition flows.\n\n[mermaid]\n----\nstateDiagram-v2\n    [*] --> Closed: Initial state\n\n    Closed --> Open: 5 consecutive failures\n    Closed --> Closed: Success (reset failure count)\n\n    Open --> HalfOpen: 30 seconds elapsed\n\n    HalfOpen --> Closed: Success\n    HalfOpen --> Open: Failure\n\n    Open --> Open: All requests rejected\n\n    note right of Closed\n        Normal operation\n        Requests pass through\n        Track failure count\n    end note\n\n    note right of Open\n        Fail fast\n        Return cached response\n        No calls to external API\n    end note\n\n    note right of HalfOpen\n        Test recovery\n        Single request allowed\n        Decide: Closed or Open\n    end note\n----\n\n\n<<<\n=== SBB-017: Feature Flag Service\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| ABB Reference\n| Feature Toggle Management (see xref:../architecture_definitions/flybuys_integration.adoc#Technology%2520Capability%2520Requirements[Architecture Definition §3.2.2])\n\n| Component Type\n| Infrastructure Service\n\n| Technology Stack\n| <<key-technology-decisions,DEC-014 Configuration / Feature Flags>>\n\n| Purpose\n| Dynamic feature control without code deployment, progressive rollout, instant rollback\n\n| Flag Definitions\n| See xref:../architecture_definitions/flybuys_integration.adoc#Feature%2520Flag%2520Register[Feature Flag Register] for all flags\n\n| Deployment Schedule\n| See <<Transition Phase Matrix,Transition Phase Matrix>> for rollout by architecture state\n\n| Rollback Procedures\n| See <<Rollback Strategy,Rollback Strategy>> for flag-based rollback procedures\n|===\n\n*Operational Characteristics*:\n\n* *Evaluation Frequency*: Real-time flag evaluation on each request (no caching)\n* *Update Propagation*: Flag changes propagate within 5 seconds across all service instances\n* *Monitoring*: Flag state changes logged with correlation IDs, dashboards per flag showing usage metrics\n* *Access Control*: Flag management restricted to designated roles (Platform Team, Product Owner, Operations Team per flag)\n\n<<<\n=== SBB-018: Location\n\n<<<\n== Data Architecture\n\nThis section defines the logical and physical data models for Solution Building Blocks.\n\n=== Physical Data Models\n\n==== Profile Service - PartnerLink Document Schema\n\n===== JSON Schema\n\nSee xref:../specifications/JSON%2520Schemas/PartnerLink.schema.json[PartnerLink.schema.json] for complete schema specification including field definitions, type constraints, and validation rules.\n\n===== Database Configuration\n\n*Container*: `partner-links` +\n*Partition Key*: `/vivaConsumerId` +\n*Document Type*: JSON (NoSQL document database)\n\n===== Key Fields\n\n* `id`: Unique document identifier (GUID)\n* `PartnerLinkId`: Aggregate root identifier (GUID)\n* `vivaConsumerId`: Partition key, Salesforce VCI (e.g., vci_xyz789abc)\n* `partner`: Enum - FLYBUYS | SHELL_CARD | AFL | BUDGET_DIRECT\n* `status`: Enum - linking_IN_PROGRESS | linked | UNlinked | FAILED\n* `externalMemberId`: Partner member ID (e.g., Flybuys 12-digit number)\n* `rewardPreference`: Enum - FLYBUYS_POINTS | OTR_FUEL_DISCOUNT | SHELL_PRICE_SAVE\n* `linkedAt` / `unlinkedAt`: ISO8601 timestamps\n* `oauthTokenReference`: Key Vault secret identifier\n* `metadata`: Document metadata (createdAt, updatedAt, version)\n* `_etag`: Database concurrency token\n\n===== Example Document\n\n[source,json]\n----\n{\n  \"id\": \"pl_a1b2c3d4-e5f6-7890-abcd-ef1234567890\",\n  \"PartnerLinkId\": \"a1b2c3d4-e5f6-7890-abcd-ef1234567890\",\n  \"vivaConsumerId\": \"vci_xyz789abc\",\n  \"partner\": \"FLYBUYS\",\n  \"status\": \"linked\",\n  \"externalMemberId\": \"123456789012\",\n  \"rewardPreference\": \"FLYBUYS_POINTS\",\n  \"linkedAt\": \"2025-12-09T10:30:00Z\",\n  \"unlinkedAt\": null,\n  \"oauthTokenReference\": \"flybuys-token-vci_xyz789abc\",\n  \"metadata\": {\n    \"createdAt\": \"2025-12-09T10:30:00Z\",\n    \"updatedAt\": \"2025-12-09T10:30:00Z\",\n    \"version\": 1\n  },\n  \"_etag\": \"\\\"0x8DCDEF123456\\\"\"\n}\n----\n\n===== Indexes\n\n* Primary: `/id` (automatic)\n* Partition key: `/vivaConsumerId` (automatic)\n* Composite: `[/partner ASC, /status ASC]` (custom - query all Flybuys linked partners)\n\n===== Constraints\n\n* `vivaConsumerId`: Required, must match pattern `^vci_[a-zA-Z0-9]\\{10,}$`\n* `partner`: Required, must be valid enum value\n* `status`: Required, must be valid enum value\n* `externalMemberId`: Required if status = linked\n* `rewardPreference`: Required if status = linked\n* Uniqueness: One linked partner per (vivaConsumerId, partner) combination\n\n==== Loyalty Service - RewardTransaction Document Schema\n\n===== JSON Schema\n\nSee xref:../specifications/JSON%2520Schemas/RewardTransactionDocument.schema.json[RewardTransactionDocument.schema.json] for complete schema specification including field definitions, nested structures, type constraints, and validation rules.\n\n===== Database Configuration\n\n*Container*: `reward-transactions` +\n*Partition Key*: `/vivaConsumerId` +\n*TTL*: 2592000 seconds (30 days) +\n*Document Type*: JSON (NoSQL document database)\n\n===== Key Fields\n\n* `id`: Unique document identifier (GUID)\n* `transactionId`: Aggregate root identifier (GUID)\n* `vivaConsumerId`: Partition key\n* `externalTransactionId`: D365 Commerce transaction ID\n* `transactionDate`: ISO8601 timestamp\n* `storeId`: OTR store identifier\n* `rewardPreference`: Enum - FLYBUYS_POINTS | OTR_FUEL_DISCOUNT\n* `grants[]`: Array of reward grants (grantId, partner, grantType, amount, description)\n* `transaction`: Transaction details (totalAmount, paymentMethod)\n* `partnerPosting`: Partner posting status (Flybuys batch file details)\n* `status`: Enum - PENDING | COMPLETED | FAILED\n* `metadata`: Document metadata (createdAt, ttl)\n* `_etag`: Database concurrency token\n\n===== Example Document\n\n[source,json]\n----\n{\n  \"id\": \"rt_b2c3d4e5-f6a7-8901-bcde-f12345678901\",\n  \"transactionId\": \"b2c3d4e5-f6a7-8901-bcde-f12345678901\",\n  \"vivaConsumerId\": \"vci_xyz789abc\",\n  \"externalTransactionId\": \"D365_TXN_20251209_001234\",\n  \"transactionDate\": \"2025-12-09T14:30:00Z\",\n  \"storeId\": \"OTR001\",\n  \"rewardPreference\": \"FLYBUYS_POINTS\",\n  \"grants\": [\n    {\n      \"grantId\": \"grt_c3d4e5f6-a7b8-9012-cdef-123456789012\",\n      \"partner\": \"FLYBUYS\",\n      \"grantType\": \"POINTS\",\n      \"amount\": 150,\n      \"description\": \"Base points: 100, Bonus points: 50 (fuel purchase campaign)\"\n    }\n  ],\n  \"transaction\": {\n    \"totalAmount\": 75.50,\n    \"paymentMethod\": \"CREDIT_CARD\"\n  },\n  \"partnerPosting\": {\n    \"flybuys\": {\n      \"posted\": true,\n      \"batchFileId\": \"OTR_TRANSACTIONS_20251210_010000.csv.pgp\",\n      \"postedAt\": \"2025-12-10T01:15:00Z\",\n      \"retryCount\": 0\n    }\n  },\n  \"status\": \"COMPLETED\",\n  \"metadata\": {\n    \"createdAt\": \"2025-12-09T14:30:00Z\",\n    \"ttl\": 2592000\n  },\n  \"_etag\": \"\\\"0x8DCDEF789012\\\" - database concurrency token\"\n}\n----\n\n===== Indexes\n\n* Primary: `/id` (automatic)\n* Partition key: `/vivaConsumerId` (automatic)\n* Range: `/transactionDate DESC` (custom - query recent transactions)\n\n===== Constraints\n\n* `vivaConsumerId`: Required\n* `externalTransactionId`: Required, must be unique\n* `transactionDate`: Required, cannot be future-dated\n* `grants`: Array must contain at least one grant\n* TTL: Automatically deleted 30 days after creation (audit trail summary only)\n\n==== OAuth Token Storage Schema (Key Vault)\n\n===== JSON Schema\n\nSee xref:../specifications/JSON%2520Schemas/OAuthTokenStorageSchema.schema.json[OAuthTokenStorageSchema.schema.json] for complete schema specification including OAuth token structure, expiration rules, and metadata requirements.\n\n===== Key Vault Configuration\n\n*Service*: #TBD# (Secure key vault service) +\n*Secret Naming Convention*: `\\{partner}-token-{vivaConsumerId}`\n\n===== Secret Value (JSON) - Key Fields\n\n* `accessToken`: OAuth access token (JWT, ~2KB)\n* `refreshToken`: OAuth refresh token\n* `expiresAt`: ISO8601 timestamp (60 minutes from issuance)\n* `scope`: OAuth scopes granted (e.g., member:read member:balance)\n* `tokenType`: Bearer\n\n===== Example Secret\n\n*Name*: `flybuys-token-vci_xyz789abc`\n\n*Value*:\n\n[source,json]\n----\n{\n  \"accessToken\": \"eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...\",\n  \"refreshToken\": \"rt_abc123def456...\",\n  \"expiresAt\": \"2025-12-09T15:30:00Z\",\n  \"scope\": \"member:read member:balance member:dockets\",\n  \"tokenType\": \"Bearer\"\n}\n----\n\n===== Metadata\n\n* Content Type: `application/json`\n* Enabled: `true`\n* Activation Date: Token creation timestamp\n* Expiration Date: 90 days (refresh token expiry)\n* Tags: `{ \"partner\": \"FLYBUYS\", \"vivaConsumerId\": \"vci_xyz789abc\" }`\n\n===== Encryption\n\nAES-256 with customer-managed keys (compliance with CON-003)\n\n<<<\n== Interface Specifications\n\nThis section defines the contracts between Solution Building Blocks - REST APIs, domain events, and data formats.\n\n=== Complete API Documentation\n\nSee xref:../specifications/README.md[Specifications README] for comprehensive documentation on OpenAPI, AsyncAPI, JSON Schemas, tooling, versioning, and validation.\n\n=== REST API\n\n[cols=\"2,3,2\"]\n|===\n| Service | OpenAPI Spec | Endpoints\n\n| Profile Service\n| xref:../specifications/REST/profile-service-v1.yaml[profile-service-v1.yaml]\n| 6 endpoints (profile creation, profile retrieval, partner linking, preference management)\n\n| Loyalty Service\n| xref:../specifications/REST/loyalty-service-v1.yaml[loyalty-service-v1.yaml]\n| 5 endpoints (credential resolution, transaction adjudication, balance queries)\n|===\n\n=== Domain Events\n\n==== AsyncAPI Specification\n\nxref:../specifications/AsyncAPI/otr-event-bus-v1.yaml[otr-event-bus-v1.yaml] - Complete event bus specification with 9 domain events, CloudEvents 1.0 structure, message examples, and channel definitions.\n\n==== Event Schemas\n\nAll domain events use JSON Schema definitions in xref:../specifications/JSON%2520Schemas[JSON Schemas directory]. See <<sbb-006-domain-event-bus,SBB-006>> for event catalogue.\n\n==== API Versioning Policy\n\nAll REST APIs exposed by ProfileService and LoyaltyService follow this versioning policy to manage API evolution while maintaining backwards compatibility for consumers (Mobile Application, POS systems).\n\n===== Version Numbering\n\n*URI Versioning*: Major version included in URI path (`/api/v1/`, `/api/v2/`)\n\n*Format*: `/api/v{major}/\\{resource}`\n\n*Examples*:\n\n* `/api/v1/loyalty/credentials/resolve`\n* `/api/v2/profile/customers`\n\n*Version Components*:\n\n* *Major version* (v1, v2, v3): Breaking changes to API contract\n* *Minor version* (not in URI): Additive changes, backwards compatible\n* *Patch version* (not in URI): Bug fixes, no contract changes\n\n===== When to Version\n\n*Major Version Bump (v1 → v2)* - Breaking changes requiring new URI:\n\n[cols=\"2,3,1\"]\n|===\n| Change Type | Example | Requires v2?\n\n| Remove field from response\n| Delete `walletId` from credential resolution response\n| ✓ Yes\n\n| Rename field\n| `rewardPreference` → `preferredReward`\n| ✓ Yes\n\n| Change field type\n| `linkedAt` from string to DateTime object\n| ✓ Yes\n\n| Add required request field\n| Add required `storeType` parameter\n| ✓ Yes\n\n| Change HTTP method\n| `POST` → `PUT` for same resource\n| ✓ Yes\n\n| Change status codes\n| `404` → `422` for partner not linked\n| ✓ Yes\n\n| Remove endpoint\n| Delete `GET /api/v1/legacy-endpoint`\n| ✓ Yes\n|===\n\n*Minor Version (No URI change)* - Backwards compatible additions:\n\n[cols=\"2,3,1\"]\n|===\n| Change Type | Example | Requires v2?\n\n| Add optional request field\n| Add optional `includeBalance` query parameter\n| ✗ No\n\n| Add new response field\n| Add `partnerTier` to credential resolution response\n| ✗ No\n\n| Add new endpoint\n| Add `POST /api/v1/loyalty/batch/validate`\n| ✗ No\n\n| Add new HTTP header\n| Add `X-Request-Priority` header support\n| ✗ No\n\n| Expand enum values\n| `rewardPreference` adds `SHELL_PRICE_SAVE` option\n| ✗ No\n|===\n\n*Patch Version* - Internal only, not visible to API consumers:\n\n* Bug fixes that don't change contract\n* Performance improvements\n* Internal refactoring\n\n===== Parallel Version Support\n\n*Support Duration*: Both versions supported in parallel until deprecated version reaches sunset date\n\n*Versioning Lifecycle*:\n\n. Release new major version with breaking changes\n. Run both versions in parallel during deprecation period\n. Sunset deprecated version after migration window\n. Remove deprecated version after grace period\n\n*Infrastructure*:\n\n* Both versions deployed simultaneously (same service, route-based dispatch)\n* Shared business logic where possible (avoid duplicate implementations)\n* Feature flags: `ProfileService.API.v1.Enabled`, `ProfileService.API.v2.Enabled`\n\n===== Deprecation Notification\n\n*HTTP Headers* (included in deprecated version responses):\n\n[source,http]\n----\nHTTP/1.1 200 OK\nDeprecation: true\nSunset: <sunset-date>\nxref: </api/v2/profile/customers>; rel=\"successor-version\"\nContent-Type: application/json\n----\n\n*Header Definitions*:\n\n* `Deprecation: true` - API version is deprecated (RFC 8594)\n* `Sunset: \\{date}` - Date when API will be removed (RFC 8594)\n* `xref: \\{url}; rel=\"successor-version\"` - URL of replacement API\n\n*OpenAPI Specification*:\n\n[source,yaml]\n----\nopenapi: 3.0.0\ninfo:\n  title: Profile Service API\n  version: 1.0.0\n  x-api-deprecation:\n    deprecated: true\n    sunset: \"<sunset-date>\"\n    successorVersion: \"2.0.0\"\n    migrationGuide: \"https://docs.otr.com.au/api/migration/v1-to-v2\"\n----\n\n*Consumer Communication Sequence*:\n\n. Release notes published with breaking changes documented\n. Email notification to API consumers with migration guide\n. Deprecation headers added to deprecated version responses\n. Warning logs enabled for deprecated version usage\n. Final migration reminder before sunset\n. Sunset date reached (API returns `410 Gone`)\n. Hard removal after grace period\n\n===== Version Discovery\n\n*API Root Endpoint*: `GET /api/versions`\n\n[source,json]\n----\n{\n  \"versions\": [\n    {\n      \"version\": \"1.0\",\n      \"status\": \"deprecated\",\n      \"sunsetDate\": \"<sunset-date>\",\n      \"baseUrl\": \"/api/v1\",\n      \"documentation\": \"https://docs.otr.com.au/api/v1\"\n    },\n    {\n      \"version\": \"2.0\",\n      \"status\": \"current\",\n      \"sunsetDate\": null,\n      \"baseUrl\": \"/api/v2\",\n      \"documentation\": \"https://docs.otr.com.au/api/v2\"\n    }\n  ],\n  \"recommended\": \"2.0\"\n}\n----\n\n*Status Values*:\n\n* `current`: Recommended version, fully supported\n* `supported`: Older version, still functional, no new features\n* `deprecated`: Scheduled for removal, sunset date published\n* `sunset`: No longer accepting requests, returns `410 Gone`\n\n===== Consumer Compatibility\n\n*Mobile Application*:\n\n* iOS/Android apps pin to specific API version\n* App Store updates required for major version migrations\n* Migration coordinated with mobile app release cycles\n\n*POS Systems*:\n\n* Store rollout requires coordinated deployment\n* POS configuration updated via D365 Commerce central config\n* API version specified in POS tenant configuration\n* Gradual rollout strategy to minimize disruption\n\n*Backward Compatibility Guarantee*:\n\n* Deprecated version contract remains stable during parallel support period\n* No breaking changes to deprecated version during support window\n* Bug fixes backported to deprecated version during support period\n\n===== Error Response for Sunset APIs\n\n*After Sunset Date* (`410 Gone`):\n\n[source,json]\n----\n{\n  \"error\": {\n    \"code\": \"API_VERSION_SUNSET\",\n    \"message\": \"API v1 has been sunset. Please migrate to v2.\",\n    \"sunsetDate\": \"<sunset-date>\",\n    \"successorVersion\": \"2.0\",\n    \"migrationGuide\": \"https://docs.otr.com.au/api/migration/v1-to-v2\"\n  }\n}\n----\n\n*HTTP Status*: `410 Gone` (permanent redirect, cache-safe)\n\n===== Semantic Versioning Alignment\n\nWhile URI versioning uses major version only, OpenAPI specs follow semantic versioning:\n\n* *OpenAPI spec version*: `2.3.1` (semver)\n* *API URI version*: `/api/v2/` (major only)\n\n*Mapping*:\n\n* OpenAPI `2.0.0` → URI `/api/v2/`\n* OpenAPI `2.1.0` → URI `/api/v2/` (additive change, no URI change)\n* OpenAPI `2.1.5` → URI `/api/v2/` (bug fix, no URI change)\n* OpenAPI `3.0.0` → URI `/api/v3/` (breaking change, new URI)\n\n==== Loyalty Credential Resolution API\n\n*Endpoint*: `POST /api/v1/loyalty/credentials/resolve`\n\n*Purpose*: Resolves EAN-13 barcodes scanned at xref:../bounded_context/interfaces/otr_pos.adoc[OTR POS] and xref:../bounded_context/interfaces/otr_plus_pos.adoc[OTR+ POS] to customer identity and context for Transaction Adjudication.\n\n*Request*:\n\n[source,json]\n----\n{\n  \"barcode\": \"1234567890123\",\n  \"storeId\": \"OTR001\",\n  \"transactionId\": \"TXN_20251211_001234\"\n}\n----\n\n*Request Schema*:\n\n[cols=\"1,1,1,3\"]\n|===\n| Field | Type | Required | Validation\n\n| `barcode`\n| string\n| Yes\n| Must match pattern `^\\d\\{13}$` (EAN-13)\n\n| `storeId`\n| string\n| Yes\n| Must be registered OTR store (OTR001-OTR999)\n\n| `transactionId`\n| string\n| Yes\n| Unique transaction identifier from POS\n|===\n\n*Response* (200 OK):\n\n[source,json]\n----\n{\n  \"vivaConsumerId\": \"vci_xyz789abc\",\n  \"rewardPreference\": \"FLYBUYS_POINTS\",\n  \"walletId\": \"wallet_123456\",\n  \"linkedPartners\": [\"FLYBUYS\"],\n  \"credentialType\": \"FLYBUYS_CARD\"\n}\n----\n\n*Response Schema*:\n\n[cols=\"1,1,4\"]\n|===\n| Field | Type | Description\n\n| `vivaConsumerId`\n| string\n| Viva Consumer ID from Salesforce Contact (customer identity)\n\n| `rewardPreference`\n| string\n| Enum: `FLYBUYS_POINTS` \\| `OTR_FUEL_DISCOUNT` \\| `SHELL_PRICE_SAVE`\n\n| `walletId`\n| string\n| EagleEye wallet identifier\n\n| `linkedPartners`\n| string[]\n| List of linked partner codes (e.g., `[\"FLYBUYS\", \"SHELL\"]`)\n\n| `credentialType`\n| string\n| Enum: `OTR_MOBILE` \\| `SPS_MOBILE` \\| `WALLET_PASS` \\| `FLYBUYS_CARD` \\| `FLYBUYS_MOBILE`\n|===\n\n*Error Responses*:\n\n[cols=\"1,2,3\"]\n|===\n| Status | Error Code | Description\n\n| 400\n| `INVALID_BARCODE`\n| Barcode format invalid (not 13 digits)\n\n| 404\n| `CREDENTIAL_NOT_FOUND`\n| Barcode not recognized or customer not enrolled\n\n| 422\n| `PARTNER_NOT_linked`\n| Flybuys credential presented but not linked to OTR profile\n\n| 500\n| `RESOLUTION_FAILED`\n| Internal error during resolution\n|===\n\n*Resolution Logic*:\n\n. *OTR credentials* (OTR Mobile, SPS Mobile, Apple/Google Wallet):\n** Barcode encodes OTR member ID\n** Direct lookup: OTR member ID → VCI\n** Query xref:../bounded_context/profile.adoc[Profile Service]: `GET /api/v1/profile/customers?memberId=\\{otrMemberId}`\n. *Flybuys credentials* (Physical card, Flybuys Mobile):\n** Barcode encodes Flybuys 12-digit member number\n** Extract member number from EAN-13 barcode\n** Query xref:../bounded_context/profile.adoc[Profile Service]: `GET /api/v1/profile/partner-links?partner=FLYBUYS&externalMemberId=\\{flybuysNumber}`\n** Retrieve VCI from PartnerLink aggregate\n** If no PartnerLink found → return `422 PARTNER_NOT_linked`\n\n*Performance Requirements*:\n\n* *Latency*: p95 < 500ms (xref:../architecture_definitions/flybuys_integration.adoc#Non-Functional%2520Requirements[NFR-002])\n* *Throughput*: 500 concurrent requests/sec (peak POS load across 500+ stores)\n* *Availability*: 99.9% uptime (max 4.3 hours downtime/month)\n\n==== Customer Profile Creation API\n\n*Endpoint*: `POST /api/v1/profile/customers`\n\n*Purpose*: Creates a new customer profile, retrieves VCI from Salesforce, and provisions an EagleEye wallet. Used by the xref:../ubiquitous_language.adoc#just-in-time-integration[Just-In-Time Integration] during customer login (AS-1 Foundation).\n\n*Request*:\n\n[source,json]\n----\n{\n  \"email\": \"customer@example.com\",\n  \"firstName\": \"John\",\n  \"lastName\": \"Smith\",\n  \"phone\": \"+61412345678\",\n  \"rewardPreference\": \"OTR_FUEL_DISCOUNT\"\n}\n----\n\n*Request Schema*:\n\n[cols=\"1,1,1,3\"]\n|===\n| Field | Type | Required | Validation\n\n| `email`\n| string\n| Yes\n| Valid email format (used for Salesforce Contact upsert as external key)\n\n| `firstName`\n| string\n| No\n| Customer first name\n\n| `lastName`\n| string\n| No\n| Customer last name\n\n| `phone`\n| string\n| No\n| Customer phone number\n\n| `rewardPreference`\n| string\n| No\n| Enum: `OTR_FUEL_DISCOUNT` \\| `FLYBUYS_POINTS` \\| `SHELL_PRICE_SAVE` (defaults to `OTR_FUEL_DISCOUNT`)\n|===\n\n*Response* (201 Created):\n\n[source,json]\n----\n{\n  \"vivaConsumerId\": \"vci_xyz789abc\",\n  \"salesforceContactId\": \"003Dn000001234ABC\",\n  \"rewardPreference\": \"OTR_FUEL_DISCOUNT\",\n  \"createdAt\": \"2025-12-09T10:30:00Z\",\n  \"status\": \"ACTIVE\"\n}\n----\n\n*Response Schema*:\n\n[cols=\"1,1,4\"]\n|===\n| Field | Type | Description\n\n| `vivaConsumerId`\n| string\n| Viva Consumer ID from Salesforce Contact (customer identity)\n\n| `salesforceContactId`\n| string\n| Salesforce Contact record ID\n\n| `rewardPreference`\n| string\n| Default reward preference\n\n| `createdAt`\n| string (ISO 8601)\n| Profile creation timestamp\n\n| `status`\n| string\n| Enum: `ACTIVE` \\| `SUSPENDED` \\| `CLOSED`\n|===\n\n*Error Responses*:\n\n[cols=\"1,2,3\"]\n|===\n| Status | Error Code | Description\n\n| 409\n| `PROFILE_ALREADY_EXISTS`\n| Customer profile already exists for this email (idempotent)\n\n| 503\n| `EAGLEEYE_UNAVAILABLE`\n| EagleEye wallet creation failed\n\n| 503\n| `SALESFORCE_UNAVAILABLE`\n| Salesforce Contact upsert failed\n|===\n\n*Business Rules*:\n\n* Retrieves Viva Consumer ID (VCI) from Salesforce Contact upsert response\n* Uses email address as external key for Salesforce Contact upsert\n* Upserts Salesforce Contact record using email (creates if doesn't exist, updates if exists)\n* Publishes `CustomerProfileCreated` domain event (consumed by LoyaltyService for wallet creation)\n* Returns `409 Conflict` if profile already exists for this email (idempotent operation)\n* Transaction is atomic - if Salesforce upsert fails, entire transaction is rolled back\n* *Clean DDD*: ProfileService does NOT create EagleEye wallet (LoyaltyService owns loyalty enrollment)\n\n*Event-Driven Integration*:\n\n* *LoyaltyService* subscribes to `CustomerProfileCreated` event\n* *LoyaltyService* creates EagleEye wallet asynchronously\n* *LoyaltyService* publishes `CustomerEnrolledInLoyalty` event with walletId\n* *Mobile App* can poll `GET /api/v1/profile/customers/{vivaConsumerId}` or subscribe to enrollment completion\n\n*Performance Requirements*:\n\n* *Latency*: p95 < 300ms (Salesforce Contact upsert only - wallet creation is asynchronous)\n* *Used during login flow* - fast profile creation, loyalty enrollment completes in background\n* *Availability*: 99.9% uptime (critical for customer onboarding)\n\n*Orchestration Flow (ProfileService)*:\n\n. Check if profile already exists for this email address\n. Upsert Salesforce Contact record using email as external key (create if new, update if exists)\n. Retrieve Viva Consumer ID (VCI) from Salesforce Contact upsert response\n. Create Customer aggregate in ProfileService database (VCI, email, Salesforce link)\n. Publish `CustomerProfileCreated` domain event to Event Bus\n. Return profile details with VCI (without walletId - comes later from LoyaltyService)\n\n==== Customer Profile Retrieval API\n\n*Endpoint*: `GET /api/v1/profile/customers/{vivaConsumerId}`\n\n*Purpose*: Retrieves customer profile details by Viva Consumer ID. Used by LoyaltyService during transaction adjudication to get reward preferences and wallet information.\n\n*Request Parameters*:\n\n[cols=\"1,1,1,3\"]\n|===\n| Parameter | Type | Required | Validation\n\n| `vivaConsumerId`\n| string (path)\n| Yes\n| Must be valid VCI identifier (format: vci_*)\n|===\n\n*Response* (200 OK):\n\n[source,json]\n----\n{\n  \"vivaConsumerId\": \"vci_xyz789abc\",\n  \"salesforceContactId\": \"003Dn000001234ABC\",\n  \"walletId\": \"wallet_123456\",\n  \"rewardPreference\": \"FLYBUYS_POINTS\",\n  \"createdAt\": \"2025-12-09T10:30:00Z\",\n  \"status\": \"ACTIVE\"\n}\n----\n\n*Response Schema*:\n\n[cols=\"1,1,4\"]\n|===\n| Field | Type | Description\n\n| `vivaConsumerId`\n| string\n| Viva Consumer ID from Salesforce Contact (customer identity)\n\n| `salesforceContactId`\n| string\n| Salesforce Contact record ID\n\n| `walletId`\n| string\n| EagleEye wallet identifier\n\n| `rewardPreference`\n| string\n| Customer's current reward preference\n\n| `createdAt`\n| string (ISO 8601)\n| Profile creation timestamp\n\n| `status`\n| string\n| Enum: `ACTIVE` \\| `SUSPENDED` \\| `CLOSED`\n|===\n\n*Error Responses*:\n\n[cols=\"1,2,3\"]\n|===\n| Status | Error Code | Description\n\n| 401\n| `UNAUTHORIZED`\n| Authentication failed\n\n| 404\n| `CUSTOMER_NOT_FOUND`\n| Customer profile does not exist for this VCI\n|===\n\n*Performance Requirements*:\n\n* *Latency*: p95 < 200ms\n* *Availability*: 99.9% uptime\n* *Cache Strategy*: Response can be cached for 5 minutes\n\n*Usage Examples*:\n\n* Transaction adjudication: `GET /api/v1/profile/customers/{vivaConsumerId}/reward-preference`\n* Customer lookup: `GET /api/v1/profile/customers?memberId={otrMemberId}`\n* Profile details retrieval: `GET /api/v1/profile/customers/{vivaConsumerId}`\n\n=== Domain Events\n\n*AsyncAPI Specification*: `Specifications/AsyncAPI/otr-event-bus-v1.yaml`\n\n*Event Standard*: CloudEvents 1.0 (https://cloudevents.io/)\n\n*Architecture Pattern*: Open Host Service + Published Language\n\nAll domain events follow the CloudEvents 1.0 specification and are defined with JSON Schema validation. Event schemas are maintained as separate JSON Schema files to ensure consistency and enable tooling integration (validation, code generation, documentation).\n\n==== Event Catalogue\n\n[cols=\"1,1,1,1,3\"]\n|===\n| Event | Channel | Source | JSON Schema | Description\n\n| `Partnerlinked`\n| `profile.events`\n| `/profile-service`\n| xref:../specifications/JSON%2520Schemas/Partnerlinked.event.schema.json[Partnerlinked.event.schema.json]\n| Customer successfully linked coalition partner account (Flybuys, Shell Card)\n\n| `PartnerUnlinked`\n| `profile.events`\n| `/profile-service`\n| xref:../specifications/JSON%2520Schemas/PartnerUnlinked.event.schema.json[PartnerUnlinked.event.schema.json]\n| Customer unlinked coalition partner account\n\n| `PartnerLinkFailed`\n| `profile.events`\n| `/profile-service`\n| xref:../specifications/JSON%2520Schemas/PartnerLinkFailed.event.schema.json[PartnerLinkFailed.event.schema.json]\n| Partner linking attempt failed (OAuth error, invalid credentials)\n\n| `RewardPreferenceChanged`\n| `profile.events`\n| `/profile-service`\n| xref:../specifications/JSON%2520Schemas/RewardPreferenceChanged.event.schema.json[RewardPreferenceChanged.event.schema.json]\n| Customer changed reward preference (Flybuys points ↔ OTR fuel discount)\n\n| `CustomerProfileCreated`\n| `profile.events`\n| `/profile-service`\n| xref:../specifications/JSON%2520Schemas/CustomerProfileCreated.event.schema.json[CustomerProfileCreated.event.schema.json]\n| Customer profile created during Just-In-Time Integration (VCI from Salesforce). Triggers loyalty enrollment.\n\n| `CustomerEnrolledInLoyalty`\n| `loyalty.events`\n| `/loyalty-service`\n| xref:../specifications/JSON%2520Schemas/CustomerEnrolledInLoyalty.event.schema.json[CustomerEnrolledInLoyalty.event.schema.json]\n| Customer enrolled in loyalty program (EagleEye wallet created). Published in response to CustomerProfileCreated.\n\n| `TransactionAdjudicated`\n| `loyalty.events`\n| `/loyalty-service`\n| xref:../specifications/JSON%2520Schemas/TransactionAdjudicated.event.schema.json[TransactionAdjudicated.event.schema.json]\n| Transaction adjudicated, rewards calculated and granted\n\n| `PointsEarned`\n| `loyalty.events`\n| `/loyalty-service`\n| xref:../specifications/JSON%2520Schemas/PointsEarned.event.schema.json[PointsEarned.event.schema.json]\n| Customer earned Flybuys points on transaction\n\n| `FuelDiscountApplied`\n| `loyalty.events`\n| `/loyalty-service`\n| xref:../specifications/JSON%2520Schemas/FuelDiscountApplied.event.schema.json[FuelDiscountApplied.event.schema.json]\n| Customer received OTR fuel discount on transaction\n\n| `RewardTransactionFailed`\n| `loyalty.events`\n| `/loyalty-service`\n| xref:../specifications/JSON%2520Schemas/RewardTransactionFailed.event.schema.json[RewardTransactionFailed.event.schema.json]\n| Transaction adjudication failed (system error, API timeout)\n|===\n\n==== Event Consumers\n\n[cols=\"1,2,3\"]\n|===\n| Bounded Context | Subscribed Events | Responsibility\n\n| *Loyalty Service*\n| `Partnerlinked`, `RewardPreferenceChanged`\n| Updates adjudication rules based on partner linking and preference changes\n\n| *Engagement Service*\n| `Partnerlinked`, `PartnerLinkFailed`, `RewardPreferenceChanged`, `CustomerProfileCreated`, `TransactionAdjudicated`, `PointsEarned`, `FuelDiscountApplied`\n| Sends customer notifications (linking confirmation, points earned, welcome messages)\n\n| *Recommendation Service*\n| `Partnerlinked`, `RewardPreferenceChanged`, `CustomerProfileCreated`\n| Updates personalization engine based on customer loyalty profile changes\n\n| *Analytics Service*\n| `TransactionAdjudicated`, `PointsEarned`, `FuelDiscountApplied`\n| Tracks reward transactions for business intelligence and reporting\n|===\n\n==== Event Delivery Guarantees\n\n*Delivery Semantics*: At-least-once delivery (Event Bus guarantees)\n\n*Retry Policy*:\n\n* Initial retry: Immediate\n* Subsequent retries: Exponential backoff (2s, 4s, 8s, 16s, 32s)\n* Maximum retries: 5 attempts\n* Dead Letter Queue: After 5 failed attempts, events routed to DLQ for manual investigation\n\n*Idempotency*: All event consumers must implement idempotent processing (use `id` field for deduplication)\n\n*Ordering*: Events within the same `vivaConsumerId` partition maintain order; cross-partition ordering not guaranteed\n\n=== Correlation ID Propagation Specification\n\nAll service-to-service communication and domain events must propagate correlation IDs to enable distributed tracing and request correlation across the Flybuys Integration architecture.\n\n==== Standard\n\n*W3C Trace Context* (https://www.w3.org/TR/trace-context/)\n\n==== HTTP Propagation\n\n*Headers*:\n\n* `traceparent`: Required trace context (format: `\\{version}-{trace-id}-{parent-id}-{trace-flags}`)\n* `tracestate`: Optional vendor-specific trace data\n\n*Generation Point*: API Gateway (or Mobile Application if request originates outside API Gateway)\n\n*Example*:\n\n[source,http]\n----\nPOST /api/v1/loyalty/credentials/resolve HTTP/1.1\nHost: api.otr.com.au\ntraceparent: 00-4bf92f3577b34da6a3ce929d0e0e4736-00f067aa0ba902b7-01\ntracestate: otr=t61rcWkgMzE\nContent-Type: application/json\n----\n\n*Trace ID Format*:\n\n* `version`: `00` (current W3C version)\n* `trace-id`: 32 hex characters (128-bit globally unique identifier)\n* `parent-id`: 16 hex characters (64-bit span identifier)\n* `trace-flags`: 2 hex characters (sampling decision: `01` = sampled, `00` = not sampled)\n\n*Propagation Rules*:\n\n. *API Gateway → Service*: Generate `traceparent` if not present, forward if present\n. *Service → Service*: Preserve `trace-id`, generate new `parent-id` for span\n. *Service → External API*: Propagate `traceparent` header (Flybuys, EagleEye, Salesforce)\n\n==== Event Propagation\n\n*CloudEvents Extension*: All domain events MUST include `traceparent` as CloudEvents extension attribute\n\n*Example*:\n\n[source,json]\n----\n{\n  \"specversion\": \"1.0\",\n  \"type\": \"com.otr.profile.Partnerlinked\",\n  \"source\": \"/profile-service\",\n  \"id\": \"a1b2c3d4-e5f6-7890-abcd-ef1234567890\",\n  \"time\": \"2025-12-09T14:30:00Z\",\n  \"traceparent\": \"00-4bf92f3577b34da6a3ce929d0e0e4736-00f067aa0ba902b7-01\",\n  \"datacontenttype\": \"application/json\",\n  \"data\": {\n    \"vivaConsumerId\": \"vci_xyz789abc\",\n    \"partner\": \"FLYBUYS\"\n  }\n}\n----\n\n*Event Consumer Propagation*: Consumers MUST extract `traceparent` from event and propagate to downstream calls\n\n*Example Flow*:\n\n. POS calls `POST /api/v1/loyalty/credentials/resolve` with `traceparent: 00-\\{trace-id}-{span-1}-01`\n. LoyaltyService calls ProfileService `GET /api/v1/profile/partner-links` with `traceparent: 00-\\{trace-id}-{span-2}-01`\n. ProfileService publishes `Partnerlinked` event with `traceparent: 00-\\{trace-id}-{span-3}-01`\n. All requests share same `trace-id` (`4bf92f3577b34da6a3ce929d0e0e4736`)\n\n==== Structured Logging\n\nAll log entries MUST include correlation context:\n\n*Log Format* (JSON structured logging via Serilog):\n\n[source,json]\n----\n{\n  \"timestamp\": \"2025-12-09T14:30:00.123Z\",\n  \"level\": \"Information\",\n  \"message\": \"Credential resolution completed\",\n  \"traceId\": \"4bf92f3577b34da6a3ce929d0e0e4736\",\n  \"spanId\": \"00f067aa0ba902b7\",\n  \"service\": \"loyalty-service\",\n  \"vivaConsumerId\": \"vci_xyz789abc\",\n  \"operation\": \"ResolveCredential\"\n}\n----\n\n*Required Fields*:\n\n* `traceId`: W3C trace-id (32 hex characters)\n* `spanId`: W3C parent-id (16 hex characters)\n* `service`: Service name (profile-service, loyalty-service, etc.)\n\n*Query Example*: Find all logs for a specific request\n\n----\ntraceId = \"4bf92f3577b34da6a3ce929d0e0e4736\"\n----\n\n==== Trace Visualization\n\n*Tool*: <<SBB-009 Application Monitoring,Application Monitoring>> platform (DEC-007) must support W3C Trace Context\n\n*Expected Trace View*:\n\n----\nPOS Transaction (trace-id: 4bf92f3577b34da6a3ce929d0e0e4736)\n├─ API Gateway [50ms]\n├─ LoyaltyService.ResolveCredential [280ms]\n│  ├─ ProfileService.GetPartnerLink [120ms]\n│  │  └─ Cosmos DB Query [80ms]\n│  └─ Redis Cache Lookup [15ms]\n└─ API Gateway Response [20ms]\nTotal: 350ms\n----\n\n==== Implementation Notes\n\n*Libraries*:\n\n* .NET: `System.Diagnostics.Activity` (built-in W3C Trace Context support)\n* OpenTelemetry SDK: Auto-instrumentation for HTTP and event propagation\n\n*Sampling Strategy*:\n\n* Production: 10% sampling (`trace-flags: 01` for 1 in 10 requests)\n* UAT: 100% sampling (all requests traced)\n* Error traces: Always sampled (override sampling decision on errors)\n\n*Privacy*: `traceparent` contains no PII - safe to log and transmit\n\n=== Data Formats\n\n==== Flybuys Batch File Format (CSV)\n\nFlybuys Transaction File Format v3.2 (January 2025) - external specification\n\n===== Format\n\n[source,csv]\n----\nMEMBER_ID,TRANSACTION_DATE,TRANSACTION_TIME,STORE_CODE,TRANSACTION_ID,BASE_POINTS,BONUS_POINTS,TOTAL_AMOUNT,FUEL_LITRES\n123456789012,2025-12-09,14:30:00,OTR001,TXN123456,100,50,75.50,45.2\n123456789012,2025-12-09,15:45:00,OTR002,TXN123457,200,0,120.00,0\n----\n\n===== Field Specifications\n\n[cols=\"1,1,1,1,3\"]\n|===\n| Field | Type | Length | Format | Validation\n\n| MEMBER_ID\n| String\n| 12\n| Numeric\n| Must match Flybuys member pattern (12 digits)\n\n| TRANSACTION_DATE\n| Date\n| 10\n| YYYY-MM-DD\n| Not future-dated\n\n| TRANSACTION_TIME\n| Time\n| 8\n| HH:MM:SS\n| 24-hour format\n\n| STORE_CODE\n| String\n| 10\n| Alphanumeric\n| Must be registered OTR store (OTR001-OTR999)\n\n| TRANSACTION_ID\n| String\n| 50\n| Alphanumeric\n| Unique per file (D365 Commerce transaction ID)\n\n| BASE_POINTS\n| Integer\n| 10\n| Numeric\n| Non-negative\n\n| BONUS_POINTS\n| Integer\n| 10\n| Numeric\n| Non-negative\n\n| TOTAL_AMOUNT\n| Decimal\n| 10,2\n| 99999999.99\n| Non-negative (AUD)\n\n| FUEL_LITRES\n| Decimal\n| 10,2\n| 99999999.99\n| Optional (0 for non-fuel transactions)\n|===\n\n===== File Requirements\n\n* Encoding: UTF-8 with BOM\n* Line ending: CRLF (`\\r\\n`)\n* Header row: Required (field names as shown above)\n* Max file size: 200MB (approx. 100,000 transactions)\n* Submission deadline: 02:00 UTC daily (Flybuys SLA)\n\n===== PGP Encryption Specifications\n\n* Algorithm: RSA 2048-bit + AES-256\n* Flybuys public key ID: `0xABCD1234` (expires 2026-12-31)\n* Compression: ZIP (level 6)\n* ASCII armor: Yes (`.pgp` extension)\n\n=== Interaction Flows\n\nThis section provides sequence diagrams for critical multi-service interactions across the Flybuys Integration architecture.\n\n==== OAuth linking Flow (AS-2 linking)\n\nCustomer links their Flybuys account via OAuth 2.0 Authorization Code Flow with PKCE from the Mobile Application.\n\n[mermaid]\n----\nsequenceDiagram\n    actor Customer\n    participant Mobile as Mobile App\n    participant Gateway as API Gateway\n    participant Profile as ProfileService\n    participant OAuth as OAuth Service\n    participant Flybuys as Flybuys OAuth\n    participant EventBus as Event Bus\n    participant Loyalty as LoyaltyService\n\n    Customer->>Mobile: Tap \"link Flybuys Account\"\n    Mobile->>Mobile: Generate PKCE code_verifier & code_challenge\n    Mobile->>Gateway: GET /api/v1/profile/oauth/authorize?partner=FLYBUYS\n    Gateway->>Profile: Forward request\n    Profile->>OAuth: InitiateOAuthFlow(partner=FLYBUYS, code_challenge)\n    OAuth->>OAuth: Store code_challenge + state\n    OAuth-->>Profile: OAuth URL + state\n    Profile-->>Gateway: Redirect URL\n    Gateway-->>Mobile: 302 Redirect to Flybuys OAuth\n\n    Mobile->>Flybuys: OAuth Authorization Request\n    Flybuys->>Customer: Login & Consent Screen\n    Customer->>Flybuys: Approve consent\n    Flybuys-->>Mobile: 302 Redirect with auth_code\n\n    Mobile->>Gateway: POST /api/v1/profile/oauth/callback<br/>(auth_code, code_verifier)\n    Gateway->>Profile: Forward callback\n    Profile->>OAuth: ValidateCallback(auth_code, code_verifier)\n    OAuth->>OAuth: Verify code_challenge == hash(code_verifier)\n    OAuth->>Flybuys: POST /oauth/token<br/>(auth_code, code_verifier)\n    Flybuys-->>OAuth: access_token + refresh_token\n    OAuth->>OAuth: Encrypt tokens (AES-256)\n    OAuth->>OAuth: Store in Key Vault\n    OAuth-->>Profile: Token reference + member_id\n\n    Profile->>Profile: Create PartnerLink aggregate<br/>(vivaConsumerId, partner=FLYBUYS, externalMemberId)\n    Profile->>Profile: Set rewardPreference = FLYBUYS_POINTS\n    Profile->>EventBus: Publish Partnerlinked event\n    Profile-->>Gateway: 200 OK (linking success)\n    Gateway-->>Mobile: linking confirmation\n    Mobile->>Customer: \"Flybuys account linked!\"\n\n    EventBus->>Loyalty: Consume Partnerlinked event\n    Loyalty->>Loyalty: Update adjudication rules for customer\n\n    Note over Customer,Loyalty: Error Scenarios\n\n    alt OAuth Authorization Denied\n        Customer->>Flybuys: Deny consent\n        Flybuys-->>Mobile: 302 Redirect with error=access_denied\n        Mobile->>Gateway: POST /api/v1/profile/oauth/callback?error=access_denied\n        Gateway->>Profile: Forward error\n        Profile-->>Gateway: 400 Bad Request (user cancelled)\n        Gateway-->>Mobile: linking cancelled\n        Mobile->>Customer: \"linking cancelled\"\n    end\n\n    alt Flybuys API Failure\n        OAuth->>Flybuys: POST /oauth/token\n        Flybuys-->>OAuth: 500 Internal Server Error\n        OAuth-->>Profile: OAuth token exchange failed\n        Profile-->>Gateway: 502 Bad Gateway\n        Gateway-->>Mobile: Partner temporarily unavailable\n        Mobile->>Customer: \"Flybuys unavailable, try again later\"\n    end\n----\n\n*Key Points*:\n\n* *PKCE*: Code verifier/challenge prevents authorization code interception\n* *Token Storage*: OAuth tokens encrypted in Key Vault, ProfileService stores only reference\n* *Event Publishing*: Partnerlinked event triggers LoyaltyService adjudication rule updates\n* *Error Handling*: User cancellation vs. API failure handled differently\n\n==== Just-In-Time Profile Creation Flow (AS-1 Foundation)\n\nThis flow shows how customer profiles are created on-demand during first login using the xref:../ubiquitous_language.adoc#just-in-time-integration[Just-In-Time Integration] pattern. ProfileService creates the profile and publishes an event. LoyaltyService subscribes to this event and provisions the EagleEye wallet asynchronously (clean DDD bounded context separation).\n\n[mermaid]\n----\nsequenceDiagram\n    actor Customer\n    participant Mobile as Mobile App\n    participant Gateway as API Gateway\n    participant Profile as ProfileService\n    participant ProfileDB as Profile DB\n    participant Salesforce as Salesforce\n    participant EventBus as Event Bus\n    participant Loyalty as LoyaltyService\n    participant EagleEye as EagleEye ACL\n\n    Customer->>Mobile: Login (first time)\n    Mobile->>Gateway: Authenticate with CIAM\n    Gateway-->>Mobile: JWT token (contains email, name, etc.)\n\n    Note over Mobile: Check if profile exists\n\n    Mobile->>Gateway: POST /api/v1/profile/customers<br/>{email, firstName, lastName, phone, preference}\n    Gateway->>Profile: Forward request\n    activate Profile\n\n    Profile->>ProfileDB: Check if profile exists for email\n    ProfileDB-->>Profile: Not found\n\n    Profile->>Salesforce: UPSERT Contact using email as key<br/>{email, firstName, lastName, phone}\n    Salesforce-->>Profile: Contact upserted (contactId, vivaConsumerId)\n\n    Profile->>ProfileDB: Create Customer aggregate<br/>(VCI, email, Salesforce link)\n    ProfileDB-->>Profile: Customer created\n\n    Profile->>EventBus: Publish CustomerProfileCreated event<br/>{vivaConsumerId, salesforceContactId, email, preference}\n    EventBus-->>Profile: Event published\n\n    Profile-->>Gateway: 201 Created<br/>{vivaConsumerId, salesforceContactId, status}\n    deactivate Profile\n    Gateway-->>Mobile: Profile created successfully\n\n    Note over EventBus,Loyalty: Asynchronous Enrollment (Clean DDD)\n\n    EventBus->>Loyalty: CustomerProfileCreated event\n    activate Loyalty\n\n    Loyalty->>EagleEye: POST /wallets<br/>{vivaConsumerId}\n    EagleEye-->>Loyalty: {walletId}\n\n    Loyalty->>EventBus: Publish CustomerEnrolledInLoyalty event<br/>{vivaConsumerId, walletId}\n    EventBus-->>Loyalty: Event published\n    deactivate Loyalty\n\n    Note over Mobile,Customer: Optional: Mobile polls or subscribes for enrollment\n\n    Mobile->>Customer: Login complete - loyalty enrollment in progress\n\n    Note over Customer,EagleEye: Error Scenarios\n\n    alt Profile Already Exists for Email\n        Profile->>ProfileDB: Check if profile exists for email\n        ProfileDB-->>Profile: Profile found\n        Profile-->>Gateway: 409 Conflict (profile already exists)\n        Gateway-->>Mobile: Profile exists - use existing\n        Mobile->>Mobile: Proceed with existing profile\n    end\n\n    alt Salesforce Upsert Failed\n        Profile->>Salesforce: UPSERT Contact\n        Salesforce-->>Profile: 500 Internal Server Error\n        Profile->>Profile: Rollback transaction\n        Profile-->>Gateway: 503 Salesforce unavailable\n        Gateway-->>Mobile: Contact upsert failed\n        Mobile->>Customer: \"Unable to create profile, try again\"\n    end\n\n    alt EagleEye Wallet Creation Failed (Handled by LoyaltyService)\n        Loyalty->>EagleEye: POST /wallets\n        EagleEye-->>Loyalty: 500 Internal Server Error\n        Loyalty->>Loyalty: Retry with exponential backoff\n        Note over Loyalty: Profile exists, wallet creation will retry\n    end\n----\n\n*Key Points*:\n\n* *Just-In-Time Integration*: Profile created on first login, not during registration\n* *Clean DDD Separation*: ProfileService owns identity, LoyaltyService owns loyalty enrollment (wallet creation)\n* *Event-Driven Architecture*: `CustomerProfileCreated` event triggers asynchronous wallet creation by LoyaltyService\n* *Salesforce Upsert*: Creates Salesforce Contact if it doesn't exist, updates if it does (idempotent)\n* *ProfileService Transaction*: Profile creation and Salesforce upsert are atomic (wallet creation is decoupled)\n* *Idempotent Operation*: Returns `409 Conflict` if profile already exists (safe to retry)\n* *Eventual Consistency*: Wallet creation happens asynchronously - mobile app can poll or subscribe for completion\n* *Resilience*: LoyaltyService handles EagleEye failures independently with retry logic (doesn't block profile creation)\n* *Performance Target*: ProfileService p95 < 300ms (faster - no EagleEye dependency)\n\n==== POS Integration Flow (AS-3 Grants)\n\nxref:../bounded_context/interfaces/otr_pos.adoc[OTR POS] scans Loyalty Credential barcode to resolve customer identity before transaction.\n\n[mermaid]\n----\nsequenceDiagram\n    actor Customer\n    participant POS as D365 Commerce POS\n    participant POSACL as POS ACL Adapter<br/>(D365 → Loyalty Domain)\n    participant LoyaltyACL as Loyalty ACL Adapter\n    participant Profile as ProfileService\n    participant ProfileDB as Profile DB\n\n    Customer->>POS: Present barcode\n    POS->>POS: Scan barcode (D365 format)\n\n    Note over POS,ProfileDB: D365 → Loyalty Domain Translation\n\n    POS->>POSACL: GetLoyaltyCardData(barcode, storeId)\n    POSACL->>POSACL: Translate D365 concepts:<br/>LoyaltyCard → VivaConsumerId<br/>StoreCode → siteId<br/>TransactionId → sourceTransactionId\n    POSACL->>Loyalty: POST /api/v1/loyalty/credentials/resolve<br/>{barcode, siteId, sourceTransactionId}\n\n    alt OTR Credential (direct resolution)\n        Loyalty->>Loyalty: Parse OTR member ID from barcode\n        Loyalty->>Profile: GET /customers?memberId={otrMemberId}\n        Profile->>ProfileDB: Query by memberId\n        ProfileDB-->>Profile: Customer (VCI, rewardPreference)\n        Profile-->>Loyalty: Customer context\n    else Flybuys Credential (indirect via PartnerLink)\n        Loyalty->>Loyalty: Parse Flybuys member# from barcode\n        Loyalty->>Profile: GET /partner-links?partner=FLYBUYS&externalMemberId={flybuysNumber}\n        Profile->>ProfileDB: Query PartnerLink aggregate\n        ProfileDB-->>Profile: PartnerLink (VCI, rewardPreference)\n        Profile-->>Loyalty: Customer context\n    end\n\n    Loyalty-->>LoyaltyACL: 200 OK {vivaConsumerId, rewardPreference, walletId}\n\n    Note over POSACL,ProfileDB: Loyalty Domain → D365 Translation\n\n    LoyaltyACL->>LoyaltyACL: Translate Loyalty domain:<br/>vivaConsumerId → LoyaltyCardNumber<br/>rewardPreference → LoyaltyProgramId<br/>walletId → AccountId\n    LoyaltyACL-->>POSACL: LoyaltyResponse {CardNumber, ProgramId, AccountId}\n    POSACL-->>POS: D365 LoyaltyCardData object\n    POS->>Customer: Display: \"Welcome back, Sarah!\"\n\n    Note over Customer,ProfileDB: Error Scenarios\n\n    alt ProfileService Unavailable\n        Loyalty->>Profile: GET /customers (timeout)\n        Profile-->>Loyalty: 503 Service Unavailable\n        Loyalty-->>LoyaltyACL: 503 Service Unavailable\n        LoyaltyACL->>LoyaltyACL: Map to D365 error:<br/>503 → LoyaltyErrorCode.ServiceTemporarilyUnavailable\n        LoyaltyACL-->>POSACL: LoyaltyResponse {ErrorCode, Message}\n        POSACL-->>POS: D365 error object\n        POS->>Customer: \"Loyalty temporarily unavailable, proceed without points\"\n    end\n\n    alt Invalid Barcode Format\n        Loyalty->>Loyalty: Parse barcode (validation fails)\n        Loyalty-->>LoyaltyACL: 400 Bad Request (invalid barcode format)\n        LoyaltyACL->>LoyaltyACL: Map to D365 error:<br/>400 → LoyaltyErrorCode.InvalidCardNumber\n        LoyaltyACL-->>POSACL: LoyaltyResponse {ErrorCode}\n        POSACL-->>POS: D365 error object\n        POS->>Customer: \"Barcode not recognized\"\n    end\n\n    alt Credential Not Found\n        Loyalty->>Profile: GET /partner-links (no match)\n        Profile-->>Loyalty: 404 Not Found\n        Loyalty-->>LoyaltyACL: 404 Not Found (credential not linked)\n        LoyaltyACL->>LoyaltyACL: Map to D365 error:<br/>404 → LoyaltyErrorCode.CardNotFound\n        LoyaltyACL-->>POSACL: LoyaltyResponse {ErrorCode}\n        POSACL-->>POS: D365 error object\n        POS->>Customer: \"Card not registered, visit counter\"\n    end\n\n    alt Partner Not linked\n        Loyalty->>Profile: GET /partner-links?partner=FLYBUYS\n        Profile-->>Loyalty: 200 OK {linked: false}\n        Loyalty-->>LoyaltyACL: 200 OK {requireslinking: true}\n        LoyaltyACL->>LoyaltyACL: Map to D365 business rule:<br/>requireslinking → Prompt for enrollment\n        LoyaltyACL-->>POSACL: LoyaltyResponse {RequiresEnrollment}\n        POSACL-->>POS: D365 enrollment prompt\n        POS->>Customer: \"link Flybuys in app for points\"\n    end\n----\n\n*Key Points*:\n\n* *Bidirectional ACL*: POS ACL Adapter translates D365 Commerce → Loyalty domain; Loyalty ACL Adapter translates Loyalty domain → D365 Commerce\n* *Two Credential Types*: OTR (direct via memberId) vs Flybuys (indirect via PartnerLink aggregate)\n* *Domain Isolation*: D365 POS never sees Loyalty domain concepts (VivaConsumerId, PartnerLink, RewardPreference)\n* *Error Mapping*: Loyalty HTTP status codes and error types mapped to D365 LoyaltyErrorCode enum\n\n==== POS Transaction Adjudication Flow (AS-3 Grants)\n\nCustomer presents Loyalty Credential at POS for transaction adjudication and reward determination.\n\n[mermaid]\n----\nsequenceDiagram\n    actor Customer\n    participant POS as OTR POS\n    participant Gateway as API Gateway\n    participant Loyalty as LoyaltyService\n    participant Profile as ProfileService\n    participant ProfileDB as Profile DB\n    participant EagleEye as EagleEye ACL\n    participant EagleEyeAPI as EagleEye API\n    participant EventBus as Event Bus\n\n    Customer->>POS: Present barcode (EAN-13)\n    POS->>POS: Scan barcode: \"1234567890123\"\n\n    Note over POS,Gateway: Credential Resolution Phase\n    POS->>Gateway: POST /api/v1/loyalty/credentials/resolve<br/>{barcode, storeId, transactionId}<br/>traceparent: 00-{trace-id}-{span-1}-01\n    Gateway->>Loyalty: Forward (add correlation ID)\n    Loyalty->>Loyalty: Parse EAN-13 barcode\n\n    alt OTR Credential (barcode encodes OTR member ID)\n        Loyalty->>Profile: GET /api/v1/profile/customers?memberId={otrMemberId}\n        Profile->>ProfileDB: Query by memberId\n        ProfileDB-->>Profile: Customer record (VCI, rewardPreference)\n        Profile-->>Loyalty: Customer context\n    else Flybuys Credential (barcode encodes Flybuys member number)\n        Loyalty->>Loyalty: Extract Flybuys member# from barcode\n        Loyalty->>Profile: GET /api/v1/profile/partner-links?<br/>partner=FLYBUYS&externalMemberId={flybuysNumber}\n        Profile->>ProfileDB: Query PartnerLink aggregate\n        ProfileDB-->>Profile: PartnerLink (VCI, rewardPreference)\n        Profile-->>Loyalty: Customer context\n    end\n\n    Loyalty-->>Gateway: 200 OK {vivaConsumerId, rewardPreference, walletId}\n    Gateway-->>POS: Credential resolved (280ms p95)\n    POS->>Customer: Display name: \"Welcome back, Sarah!\"\n\n    Note over Customer,EventBus: Transaction Adjudication Phase\n    Customer->>POS: Complete purchase ($75.50)\n    POS->>Gateway: POST /api/v1/loyalty/transactions/adjudicate<br/>{vivaConsumerId, transactionId, items[], total}\n    Gateway->>Loyalty: Forward request\n\n    Loyalty->>Profile: GET /api/v1/profile/customers/{vivaConsumerId}/reward-preference\n    Profile-->>Loyalty: rewardPreference = FLYBUYS_POINTS\n\n    alt Reward Preference = FLYBUYS_POINTS\n        Loyalty->>EagleEye: POST /transactions/validate<br/>(transaction details, walletId)\n        EagleEye->>EagleEyeAPI: Forward to EagleEye AIR\n        EagleEyeAPI-->>EagleEye: Provisional rewards (150 points)\n        EagleEye-->>Loyalty: Validation response\n        Loyalty->>Loyalty: Create RewardTransaction aggregate<br/>(vivaConsumerId, flybuysPoints=150, status=PENDING)\n        Loyalty-->>Gateway: 200 OK {provisionalRewards: 150 points}\n        Gateway-->>POS: Adjudication complete\n        POS->>Customer: \"You'll earn 150 Flybuys points\"\n    else Reward Preference = OTR_FUEL_DISCOUNT\n        Loyalty->>EagleEye: POST /transactions/validate<br/>(fuel discount campaign)\n        EagleEye->>EagleEyeAPI: Check fuel discount grants\n        EagleEyeAPI-->>EagleEye: 8c/L discount available\n        EagleEye-->>Loyalty: Validation response\n        Loyalty-->>Gateway: 200 OK {fuelDiscount: 8cpl}\n        Gateway-->>POS: Adjudication complete\n        POS->>Customer: \"8c/L fuel discount applied\"\n    end\n\n    Note over POS,EventBus: Post-Payment Finalization\n    POS->>POS: Payment captured\n    POS->>Gateway: POST /api/v1/loyalty/transactions/{txnId}/redeem\n    Gateway->>Loyalty: Finalize transaction\n    Loyalty->>EagleEye: POST /transactions/redeem<br/>(confirm rewards)\n    EagleEye->>EagleEyeAPI: Finalize in EagleEye\n    EagleEyeAPI-->>EagleEye: Confirmed\n    EagleEye-->>Loyalty: Redemption complete\n\n    Loyalty->>Loyalty: Update RewardTransaction<br/>(status=CONFIRMED, finalPoints=150)\n    Loyalty->>EventBus: Publish TransactionAdjudicated event\n    Loyalty-->>Gateway: 200 OK\n    Gateway-->>POS: Transaction finalized\n\n    Note over Customer,EventBus: Error Scenarios\n\n    alt ProfileService Unavailable\n        Loyalty->>Profile: GET /api/v1/profile/partner-links\n        Profile-->>Loyalty: 503 Service Unavailable\n        Loyalty->>Loyalty: Circuit breaker OPEN\n        Loyalty-->>Gateway: 503 Service Unavailable<br/>{fallback: \"proceed without points\"}\n        Gateway-->>POS: Degraded mode\n        POS->>Customer: \"Points temporarily unavailable\"\n        POS->>POS: Complete transaction without points\n    end\n\n    alt EagleEye API Timeout\n        Loyalty->>EagleEye: POST /transactions/validate\n        EagleEye->>EagleEyeAPI: Forward request\n        Note over EagleEyeAPI: Timeout after 3s\n        EagleEye-->>Loyalty: 504 Gateway Timeout\n        Loyalty->>Loyalty: Return cached default reward\n        Loyalty-->>Gateway: 200 OK {provisionalRewards: 100 points (default)}\n        Gateway-->>POS: Adjudication complete (degraded)\n        POS->>Customer: \"You'll earn ~100 points (estimate)\"\n    end\n----\n\n*Key Points*:\n\n* *Two-phase adjudication*: Validation (pre-payment) → Redemption (post-payment)\n* *Latency budget*: 500ms p95 for credential resolution (NFR-002)\n* *Graceful degradation*: Circuit breaker returns default rewards if EagleEye slow\n* *Trace propagation*: W3C traceparent header flows through all services\n\n==== Batch File Processing Flow (AS-3 Grants)\n\nNightly batch job aggregates transactions and transmits to Flybuys via SFTP.\n\n[mermaid]\n----\nsequenceDiagram\n    participant Scheduler as Batch Scheduler<br/>(Azure Data Factory)\n    participant Loyalty as LoyaltyService<br/>(Batch Job)\n    participant LoyaltyDB as Loyalty DB\n    participant D365 as D365 Commerce<br/>(POS Transactions)\n    participant FileGen as CSV Generator\n    participant PGP as PGP Encryption\n    participant SFTP as SFTP Client\n    participant Flybuys as Flybuys SFTP Server\n    participant Monitor as Monitoring\n\n    Note over Scheduler,Monitor: Daily Batch Window: 01:00 - 02:00 UTC\n\n    Scheduler->>Scheduler: Timer trigger: 01:00 UTC\n    Scheduler->>Loyalty: Start batch job<br/>(jobId, runDate=yesterday)\n\n    Note over Loyalty,D365: Phase 1: Transaction Aggregation (01:00 - 01:20)\n    Loyalty->>LoyaltyDB: Query RewardTransactions<br/>(status=CONFIRMED, date=yesterday)\n    LoyaltyDB-->>Loyalty: 50,000 transactions\n\n    Loyalty->>D365: Query transactions for reconciliation<br/>(transactionIds[])\n    D365-->>Loyalty: Transaction details\n\n    Loyalty->>Loyalty: Aggregate by Flybuys member<br/>(group by externalMemberId)\n    Loyalty->>Loyalty: Calculate BASE_POINTS + BONUS_POINTS\n    Loyalty->>Monitor: Log progress: \"Aggregated 50k transactions\"\n\n    Note over FileGen,PGP: Phase 2: File Generation (01:20 - 01:35)\n    Loyalty->>FileGen: Generate CSV file<br/>(transactions[], filename=OTR_TRANSACTIONS_20251209_010000.csv)\n    FileGen->>FileGen: Write header row\n    FileGen->>FileGen: Write 50,000 transaction rows\n    FileGen->>FileGen: Validate file format (UTF-8 BOM, CRLF)\n    FileGen-->>Loyalty: CSV file (25MB)\n\n    Loyalty->>PGP: Encrypt file<br/>(publicKey=Flybuys_RSA_2048, compression=ZIP)\n    PGP->>PGP: Compress CSV (ZIP level 6): 25MB → 8MB\n    PGP->>PGP: Encrypt with RSA+AES-256\n    PGP->>PGP: ASCII armor (.pgp extension)\n    PGP-->>Loyalty: Encrypted file (9MB)\n    Loyalty->>Monitor: Log progress: \"File generated, size=9MB\"\n\n    Note over SFTP,Flybuys: Phase 3: SFTP Transmission (01:35 - 01:50)\n    Loyalty->>SFTP: Transmit file<br/>(OTR_TRANSACTIONS_20251209_010000.csv.pgp)\n    SFTP->>Flybuys: SSH connect + authenticate\n    Flybuys-->>SFTP: Connection established\n    SFTP->>Flybuys: PUT file (9MB, ~5 min upload)\n    Flybuys-->>SFTP: Transfer complete\n    SFTP->>Flybuys: Verify checksum (MD5)\n    Flybuys-->>SFTP: Checksum OK\n    SFTP-->>Loyalty: Upload successful\n\n    Loyalty->>LoyaltyDB: Update RewardTransactions<br/>(status=POSTED_TO_FLYBUYS, postedAt=01:45 UTC)\n    Loyalty->>Monitor: Log success: \"Batch file transmitted, size=9MB, records=50k\"\n\n    Note over Flybuys,Monitor: Phase 4: Acknowledgement (01:50 - 02:00)\n    Loyalty->>Loyalty: Wait 5 minutes for ACK file\n    Loyalty->>SFTP: Poll for acknowledgement file<br/>(OTR_TRANSACTIONS_20251209_010000.ack)\n    SFTP->>Flybuys: LIST /outbound/*.ack\n\n    alt Acknowledgement File Present\n        Flybuys-->>SFTP: ACK file found\n        SFTP->>Flybuys: GET acknowledgement file\n        Flybuys-->>SFTP: ACK file content<br/>(status=SUCCESS, records=50000)\n        SFTP-->>Loyalty: ACK file downloaded\n        Loyalty->>Loyalty: Parse ACK file\n        Loyalty->>LoyaltyDB: Update batch job status=ACKNOWLEDGED\n        Loyalty->>Monitor: Log success: \"Batch acknowledged by Flybuys\"\n        Loyalty-->>Scheduler: Job complete (duration=60 min)\n    else No Acknowledgement File\n        SFTP-->>Loyalty: ACK file not found\n        Loyalty->>Loyalty: Wait 2 minutes, retry poll\n        Loyalty->>SFTP: Poll again\n\n        alt ACK Found on Retry\n            SFTP-->>Loyalty: ACK file found (retry successful)\n            Loyalty->>Monitor: Log warning: \"ACK delayed but received\"\n            Loyalty-->>Scheduler: Job complete (duration=62 min)\n        else ACK Still Missing\n            Loyalty->>Monitor: Alert CRITICAL: \"Batch ACK missing after 10 min\"\n            Loyalty->>LoyaltyDB: Update batch job status=ACK_PENDING\n            Loyalty-->>Scheduler: Job partial success (manual follow-up required)\n        end\n    end\n\n    Note over Scheduler,Monitor: Error Scenarios\n\n    alt SFTP Upload Failure\n        SFTP->>Flybuys: PUT file\n        Flybuys-->>SFTP: 500 Internal Server Error\n        SFTP-->>Loyalty: Upload failed\n        Loyalty->>Loyalty: Exponential backoff retry (2min, 4min, 8min)\n        Loyalty->>SFTP: Retry upload (attempt 2/3)\n\n        alt Retry Successful\n            SFTP->>Flybuys: PUT file (retry)\n            Flybuys-->>SFTP: Transfer complete\n            SFTP-->>Loyalty: Upload successful\n            Loyalty->>Monitor: Log warning: \"Upload succeeded on retry 2\"\n            Loyalty-->>Scheduler: Job complete\n        else All Retries Failed\n            Loyalty->>Monitor: Alert CRITICAL: \"Batch upload failed after 3 attempts\"\n            Loyalty->>LoyaltyDB: Update batch job status=FAILED\n            Loyalty-->>Scheduler: Job failed (manual intervention required)\n        end\n    end\n\n    alt Batch Window Deadline Exceeded\n        Note over Loyalty: Current time: 01:58 UTC\n        Loyalty->>Loyalty: Check time remaining: 2 minutes\n        Loyalty->>Monitor: Alert WARNING: \"Approaching 02:00 UTC deadline\"\n        Loyalty->>SFTP: Attempt final upload (priority)\n\n        alt Upload Completes Before 02:00\n            SFTP-->>Loyalty: Upload complete 01:59 UTC\n            Loyalty->>Monitor: Log warning: \"Deadline met with 1 min margin\"\n            Loyalty-->>Scheduler: Job complete (late but within SLA)\n        else Upload Exceeds 02:00 UTC\n            Note over Loyalty: Current time: 02:02 UTC\n            SFTP-->>Loyalty: Upload complete 02:02 UTC\n            Loyalty->>Monitor: Alert CRITICAL: \"SLA breach - uploaded after 02:00 UTC deadline\"\n            Loyalty->>LoyaltyDB: Update batch job status=LATE\n            Loyalty-->>Scheduler: Job complete (SLA breach, escalate to Flybuys)\n        end\n    end\n----\n\n*Key Points*:\n\n* *Batch window*: 01:00-02:00 UTC (1-hour window for 50k-100k transactions)\n* *Four phases*: Aggregation (20 min) → Generation (15 min) → Upload (15 min) → ACK (10 min)\n* *Retry strategy*: Exponential backoff for SFTP failures (2min, 4min, 8min)\n* *SLA deadline*: 02:00 UTC submission deadline enforced by Flybuys\n* *Monitoring*: Critical alerts for ACK missing, upload failures, deadline breaches\n\n<<<\n== Transition Architecture\n\nThis section defines the phased approach to migrate from current state to target architecture, showing intermediate architecture states and technical dependencies.\n\n. *No Big-Bang Migration*: Incremental rollout using Strangler Fig pattern (reference ADR-005 in Architecture Definition)\n. *Zero Downtime*: New bounded contexts operate in parallel with legacy OTR App API during transition\n. *Feature Flag Control*: All new capabilities behind feature flags (see xref:../architecture_definitions/flybuys_integration.adoc#Feature%2520Flag%2520Register[Feature Flag Register] in Architecture Definition)\n. *Data Coexistence*: Dual-write to legacy and new systems during AS-1 Foundation phase (30 days)\n. *Rollback Capability*: Each phase independently reversible without data loss\n\n=== Transition Phase Matrix\n\nProgressive rollout of feature flags across architecture states (AS-0 → AS-1 → AS-2 → AS-3 → AS-4).\n\n*Flag Definitions*: See xref:../architecture_definitions/flybuys_integration.adoc#Feature%2520Flag%2520Register[Feature Flag Register] in Architecture Definition for complete flag purposes, ownership, and strategic rationale.\n\n[cols=\"3,1,1,1,1,1\"]\n|===\n| Flag Name | AS-0 Current | AS-1 Foundation | AS-2 linking | AS-3 Grants | AS-4 Target\n\n| +OTR.Loyalty.Enabled+\n| OFF\n| ON\n| ON\n| ON\n| ON\n\n| +OTR.Loyalty.PartnerLink.Flybuys+\n| OFF\n| OFF\n| ON\n| ON\n| ON\n\n| +OTR.Loyalty.RewardPreferenceSelection+\n| OFF\n| OFF\n| ON\n| ON\n| ON\n\n| +OTR.Loyalty.TransactionAdjudication+\n| OFF\n| OFF\n| OFF\n| ON\n| ON\n\n| +OTR.Loyalty.PointsEarn.Flybuys+\n| OFF\n| OFF\n| OFF\n| ON\n| ON\n\n| +OTR.Loyalty.FlybuysBatchPosting+\n| OFF\n| OFF\n| OFF\n| ON\n| ON\n|===\n\n*Dependencies*:\n\n* +OTR.Loyalty.PartnerLink.Flybuys+ requires +OTR.Loyalty.Enabled+ = ON\n* +OTR.Loyalty.TransactionAdjudication+ requires +OTR.Loyalty.Enabled+ = ON\n* +OTR.Loyalty.PointsEarn.Flybuys+ requires +OTR.Loyalty.TransactionAdjudication+ = ON\n\n=== Rollback Strategy\n\nFeature flags enable rapid rollback without code deployment. Each architecture state can be rolled back by disabling the corresponding flags:\n\n==== AS-1 Foundation Rollback\n\n*Trigger*: VCI migration failures, EagleEye wallet creation issues, or infrastructure instability\n\n*Actions*:\n\n. Set +OTR.Loyalty.Enabled+ = OFF (disables all loyalty features)\n. Delete customer VCI records created during pilot (data cleanup)\n. Validate legacy OTR App API is functioning normally\n\n*Impact*: Mobile app reverts to legacy loyalty features (no EagleEye integration)\n\n==== AS-2 linking Rollback\n\n*Trigger*: OAuth flow failures (>5% failure rate), Flybuys API unavailability, or customer support tickets >50/day\n\n*Actions*:\n\n. Set +OTR.Loyalty.PartnerLink.Flybuys+ = OFF (disables Flybuys linking UI)\n. Set +OTR.Loyalty.RewardPreferenceSelection+ = OFF (hides reward preference selection)\n. Communicate to pilot users via push notification and email\n\n*Impact*: Customers cannot link Flybuys accounts, balance queries disabled\n\n==== AS-3 Grants Rollback\n\n*Trigger*: POS integration failures, batch file acknowledgement rate <98%, or transaction adjudication errors\n\n*Actions*:\n\n. Set +OTR.Loyalty.TransactionAdjudication+ = OFF (reverts to legacy POS integration)\n. Set +OTR.Loyalty.PointsEarn.Flybuys+ = OFF (stops points earning)\n. Set +OTR.Loyalty.FlybuysBatchPosting+ = OFF (stops daily batch transmission)\n. Re-enable Reddy Express legacy Flybuys integration (barcode pattern matching)\n\n*Impact*: POS reverts to legacy Flybuys integration, transactions in-flight may need manual reconciliation\n\n==== Partial Rollback (Batch Posting Issues Only)\n\n*Trigger*: Flybuys batch file acknowledgement failures, SFTP transmission errors\n\n*Actions*:\n\n. Set +OTR.Loyalty.FlybuysBatchPosting+ = OFF (stops batch transmission)\n. Investigate SFTP connectivity, PGP encryption, and acknowledgement file parsing\n. Keep +OTR.Loyalty.TransactionAdjudication+ = ON (POS integration continues)\n\n*Impact*: Points not posted to Flybuys immediately, requires manual batch file regeneration and transmission\n\n=== AS-0 Current State\n\nPre-initiative architecture (reference Architecture Definition §2 Current State)\n\n==== Active Components\n\n* OTR App API (AWS Lambda, DynamoDB)\n* Reddy Express legacy loyalty (SQL Server, POS barcode matching) - Flybuys-only\n* No unified customer identity (OTR users and Reddy Express customers separate)\n* No partner integrations beyond basic xref:../ubiquitous_language.adoc#flybuys-cardholder-number[Flybuys Card] scanning\n\n==== Technical Debt\n\n* Fragmented customer identity (OTR vs Reddy Express silos)\n* No event-driven architecture (synchronous-only integrations)\n* Tight POS coupling (direct Flybuys barcode pattern matching at OTR+ stores)\n* No OAuth infrastructure (no secure third-party account linking)\n\n\n=== AS-1 Foundation\n\nEstablish xref:../bounded_context/profile.adoc[Profile Service], xref:../bounded_context/loyalty.adoc[Loyalty Service], xref:../bounded_context/interfaces/otr_app_api.adoc[Event Bus] without customer-facing features\n\n==== New SBBS\n\n[cols=\"1,3\"]\n|===\n| SBB | Description\n\n| <<sbb-001-profile-service-api,SBB-001>>\n| xref:../bounded_context/profile.adoc[Profile Service] API\n\n| <<sbb-002-profile-service-database,SBB-002>>\n| xref:../bounded_context/profile.adoc[Profile Service] Database\n\n| <<sbb-003-loyalty-service-api,SBB-003>>\n| xref:../bounded_context/loyalty.adoc[Loyalty Service] API\n\n| <<sbb-004-loyalty-service-database,SBB-004>>\n| xref:../bounded_context/loyalty.adoc[Loyalty Service] Database\n\n| <<sbb-006-domain-event-bus,SBB-006>>\n| Domain xref:../bounded_context/interfaces/otr_app_api.adoc[Event Bus] (Event Grid)\n\n| SBB-008\n| Eagle Eye[Eagle Eye] Integration Adaptor\n\n| <<sbb-012-application-monitoring,SBB-012>>\n| Application Monitoring (App Insights)\n\n| <<sbb-013-api-gateway,SBB-013>>\n| API Gateway (APIM)\n|===\n\n==== Implementation Approach\n\nEnable xref:../ubiquitous_language.adoc#customer[Customer] uplift with a xref:../ubiquitous_language.adoc#dark-launch[Dark Launch] rollout strategy. New integration runs in parallel with existing system, validating technical implementation without customer impact\n\n[cols=\"2,5\"]\n|===\n| Activity | Description\n\n| Customer Profile Creation\n| xref:../ubiquitous_language.adoc#just-in-time-integration[Just-In-Time Integration] via `POST /api/v1/profile/customers` endpoint - xref:../ubiquitous_language.adoc#otr-app[Mobile Application] calls this during login if xref:../ubiquitous_language.adoc#customer[Customer] has no xref:../ubiquitous_language.adoc#viva-consumer-id-vci[VCI], creating profile and linking to Salesforce\n\n| Wallet Provisioning\n| Orchestrated by profile creation endpoint - `POST /api/v1/profile/customers` calls EagleEye ACL to provision xref:../ubiquitous_language.adoc#wallet[EagleEye Wallet] atomically with profile creation\n\n| Dual-Write Pattern\n| xref:../ubiquitous_language.adoc#otr-app[Mobile Application] sends requests to both legacy OTR App API and new xref:../bounded_context/profile.adoc[Profile Service] / xref:../bounded_context/loyalty.adoc[Loyalty Service], while legacy remains authoritative until Loyalty Value Chain[Loyalty Value Chain]\n|===\n\n===== Architecture Diagram\n\n[mermaid]\n----\ngraph TD\n    MobileApp[Mobile App]\n    LegacyAPI[Legacy API<br/>Primary]\n    Services[Profile Service<br/>Loyalty Service<br/>pilot only, dual-write]\n    EventBus[Event Bus]\n\n    MobileApp --> LegacyAPI\n    MobileApp --> Services\n    Services --> EventBus\n----\n\n===== Rollout Strategy\n\n*Note*: See xref:../architecture_definitions/flybuys_integration.adoc#Feature%2520Flag%2520Register[Feature Flag Register] in Architecture Definition for complete feature catalogue, and <<transition-phase-matrix,Transition Phase Matrix>> above for rollout schedule.\n\n[cols=\"3,1\"]\n|===\n| Flag | Status\n\n| +OTR.Loyalty.Enabled+\n| On\n\n| +OTR.Loyalty.TransactionAdjudication+\n| Off\n\n| +OTR.Loyalty.RewardPreferenceSelection+\n| Off\n\n| +OTR.Loyalty.PartnerLink.Flybuys+\n| Off\n\n| +OTR.Loyalty.PointsEarn.Flybuys+\n| Off\n|===\n\n===== Events\n\n[cols=\"2,1\"]\n|===\n| Event | Emitted\n\n| +PointsEarned+\n| No\n\n| +FlybuysPointsRedeemed+\n| No\n\n| +TransactionAdjudicated+\n| No\n\n| +PointsEarned+\n| No\n\n| +PointsRedeemed+\n| No\n\n| +PointsExpired+\n| No\n\n| +PointsAdjusted+\n| No\n\n| +CustomerProfileCreated+\n| Yes\n\n| +MemberUnenrolled+\n| No\n\n| +GrantIssued+\n| No\n\n| +GrantRedeemed+\n| No\n|===\n\n===== Success Criteria\n\n* 100% of xref:../ubiquitous_language.adoc#otr-app[Mobile Application] xref:../ubiquitous_language.adoc#customer[Customers] have xref:../ubiquitous_language.adoc#viva-consumer-id-vci[Viva Consumer ID (VCI)] allocated in xref:../bounded_context/external/salesforce_crm.adoc[Salesforce CRM]\n* 100% of xref:../ubiquitous_language.adoc#otr-app[Mobile Application] xref:../ubiquitous_language.adoc#customer[Customers] have xref:../ubiquitous_language.adoc#wallet[Wallets] allocated in xref:../bounded_context/external/eagle_eye.adoc[EagleEye]\n* No xref:../ubiquitous_language.adoc#otr-app[Mobile Application] xref:../ubiquitous_language.adoc#customer[Customers] have a linked xref:../ubiquitous_language.adoc#flybuys-digital-identity[Flybuys Digital Identity]\n* Zero production impact\n* Zero xref:../ubiquitous_language.adoc#otr-app[Mobile Application] impacts\n\n===== Dependencies\n\n* EagleEye API credentials and rate limits confirmed (external dependency - EagleEye, 1000 req/min guaranteed)\n* Infrastructure provisioning complete (internal dependency - Platform team)\n\n==== Rollback Approach\n\n* Delete xref:../ubiquitous_language.adoc#customer[Customers] uplifted xref:../bounded_context/external/salesforce_crm.adoc[Salesforce CRM] profiles\n\n===== Feature Flags\n\n[cols=\"3,1\"]\n|===\n| Flag | Status\n\n| +OTR.Loyalty.Enabled+\n| Off\n\n| +OTR.Loyalty.TransactionAdjudication+\n| Off\n\n| +OTR.Loyalty.RewardPreferenceSelection+\n| Off\n\n| +OTR.Loyalty.PartnerLink.Flybuys+\n| Off\n\n| +OTR.Loyalty.PointsEarn.Flybuys+\n| Off\n|===\n\n\n=== AS-2 linking\n\nEnable customer-facing xref:../ubiquitous_language.adoc#partner-xref[Partner Link] and xref:../ubiquitous_language.adoc#reward-preference[Reward Preference] selection in xref:../ubiquitous_language.adoc#otr-app[Mobile Applications]\n\n==== New SBB\n\n[cols=\"1,2\"]\n|===\n| SBB | Description\n\n| SBB-005\n| OAuth Token Service\n\n| SBB-007\n| Flybuys Integration Adaptor\n\n| SBB-011\n| Mobile Application Updates\n\n| SBB-013\n| Distributed Cache\n|===\n\n==== New Capabilities\n\n* xref:../ubiquitous_language.adoc#otr-app[Mobile Application] xref:../ubiquitous_language.adoc#partner-xref[Partner link] flow (xref:../ubiquitous_language.adoc#pkce[OAuth 2.0 Authorisation Code Flow with PKCE])\n* xref:../ubiquitous_language.adoc#reward-preference[Reward preference selection UI] (Flybuys points vs OTR fuel discount)\n* Real-time Flybuys balance display in mobile app wallet screen\n\n==== Implementation Approach\n\nEnable linking for xref:../ubiquitous_language.adoc#customer[Customers] using a xref:../ubiquitous_language.adoc#ring-deployments[Ring Deployments] progressive exposure strategy\n\n===== Monitoring\n\nTrack OAuth success rate, balance query latency, customer support tickets (30-day observation period)\n\n===== Cutover\n\nAfter 30 days successful pilot (>95% OAuth success rate), enable for all xref:../ubiquitous_language.adoc#customer[Customers]\n\n===== Architecture Diagram\n\n[mermaid]\n----\ngraph TD\n    A[Mobile App] --> B[API Gateway]\n    B --> C[Profile Service]\n    B --> D[Loyalty Service]\n    C --> E[Event Bus]\n    C --> F[OAuth Service + Key Vault]\n    C --> G[Flybuys API]\n    D --> E\n    D --> F\n    D --> G\n----\n\n===== Rollout\n\n====== Ring 0 (Internal Validation)\n\nStaff accounts (50 users), 7 days\n\n* Validation: Users are in xref:../bounded_context/external/salesforce_crm.adoc[Salesforce CRM] and Braze\n* Go criteria: 100% success rate, zero P1/P2 incidents\n\n====== Ring 1 (Pilot Users)\n\nCustomers who regularly use the xref:../ubiquitous_language.adoc#otr-app[Mobile Applications], 14 days\n\n* Validation: OAuth success rate >90%, customer support tickets <10/day\n* Go criteria: Meet validation targets for 7 consecutive days\n\n====== Ring 2 (General availability)\n\nAll xref:../ubiquitous_language.adoc#otr-app[Mobile Application] Customers\n\n* Deployment: Gradual rollout using percentage targeting (10% → 50% → 100% over 14 days)\n* Monitoring: Track OAuth success rate, balance query latency, customer support tickets (30-day observation period)\n\n[cols=\"3,1\"]\n|===\n| Flag | Status\n\n| +OTR.Loyalty.Enabled+\n| On\n\n| +OTR.Loyalty.TransactionAdjudication+\n| Off\n\n| +OTR.Loyalty.RewardPreferenceSelection+\n| Off\n\n| +OTR.Loyalty.PartnerLink.Flybuys+\n| On\n\n| +OTR.Loyalty.PointsEarn.Flybuys+\n| Off\n|===\n\n===== Events\n\n[cols=\"2,1\"]\n|===\n| Event | Emitted\n\n| +Partnerlinked+\n| Yes\n\n| +PartnerUnlinked+\n| Yes\n\n| +PointsEarned+\n| No\n\n| +FlybuysPointsRedeemed+\n| No\n\n| +TransactionAdjudicated+\n| No\n\n| +PointsEarned+\n| No\n\n| +PointsRedeemed+\n| No\n\n| +PointsExpired+\n| No\n\n| +PointsAdjusted+\n| No\n\n| +CustomerProfileCreated+\n| Yes\n\n| +MemberUnenrolled+\n| No\n\n| +GrantIssued+\n| No\n\n| +GrantRedeemed+\n| No\n|===\n\n===== Dependencies\n\n* Flybuys OAuth API production credentials (external - Flybuys, confirmed Nov 2025)\n* OAuth Service provisioned with Flybuys IDP connection (internal - Platform team, Dec 2025)\n* Mobile app release with linking UI\n\n===== Success Criteria\n\n* 95% of xref:../ubiquitous_language.adoc#customer[Customers] attempting xref:../ubiquitous_language.adoc#partner-xref[Partner link] are successful\n* OAuth success rate >95% over 30-day pilot period (validation exit criterion)\n* Balance query latency < 2s p95 (NFR-003)\n* Customer support tickets < 50 related to linking issues (< 0.5% of pilot users)\n\n==== Rollback Approach\n\n* Delete xref:../ubiquitous_language.adoc#partner-xref[Partner link] from pilot xref:../ubiquitous_language.adoc#customer[Customers] (customer communication required via email/push notification)\n\n===== Feature Flags\n\n[cols=\"3,1\"]\n|===\n| Flag | Status\n\n| +OTR.Loyalty.Enabled+\n| On\n\n| +OTR.Loyalty.TransactionAdjudication+\n| Off\n\n| +OTR.Loyalty.RewardPreferenceSelection+\n| On\n\n| +OTR.Loyalty.PartnerLink.Flybuys+\n| Off\n\n| +OTR.Loyalty.PointsEarn.Flybuys+\n| Off\n|===\n\n\n=== AS-3 Grants\n\n* Enable in-store xref:../bounded_context/interfaces/otr_pos.adoc[OTR POS] and xref:../bounded_context/interfaces/otr_plus_pos.adoc[OTR+ POS] xref:../ubiquitous_language.adoc#loyalty-credential[Loyalty Credential] recognition\n* Transaction posting to Flybuys (batch files)\n* xref:../ubiquitous_language.adoc#digital-fuel-dockets[Digital Fuel Docket] redemption\n\n==== New SBB\n\n[cols=\"1,3\"]\n|===\n| SBB | Description\n\n| SBB-012\n| Batch File Pipeline (serverless functions for daily aggregation, SFTP transmission)\n|===\n\n==== Implementation Approach\n\n*POS Barcode Integration*:\n\n. Deploy +POST /api/v1/loyalty/credentials/resolve+ endpoint\n. Update POS to call Loyalty Service API on barcode scan\n. Barcode Format: EAN-13 (13-digit European Article Number standard)\n. Pre-linking Requirement: Customers must link Flybuys account via mobile app OAuth flow (AS-2)\n. Error Handling: POS displays \"Please link Flybuys in mobile app\" if unlinked Flybuys credential scanned (422 error)\n\n*Rollout Strategy*:\n\n* POS Rollout: Enable barcode scanning at pilot stores (10 OTR stores), then gradual rollout\n* Batch Processing: Daily batch file generation starts (nightly 01:00 UTC job)\n\n===== Feature Flags\n\n[cols=\"3,1\"]\n|===\n| Flag | Status\n\n| +OTR.Loyalty.Enabled+\n| On\n\n| +OTR.Loyalty.TransactionAdjudication+\n| On\n\n| +OTR.Loyalty.RewardPreferenceSelection+\n| On\n\n| +OTR.Loyalty.PartnerLink.Flybuys+\n| On\n\n| +OTR.Loyalty.PointsEarn.Flybuys+\n| On\n|===\n\n*Success Criteria*:\n\n* 100% of customer transactions post to Flybuys (batch acknowledgement rate >98%, NFR-016)\n* POS barcode resolution latency < 500ms p95 (NFR-002)\n* Digital docket redemption operational at all 500+ stores\n\n=== AS-4 Target State\n\nFinal steady-state architecture after all Flybuys Integration capabilities are deployed and stabilised.\n\n==== Success Criteria (Entry to AS-4)\n\n*Prerequisites*:\n\n* AS-3 Grants operational for minimum 6 months\n* Zero critical incidents (P1/P2) in last 90 days\n* All NFRs validated and meeting targets\n* Legacy Reddy Express Flybuys integration fully decommissioned\n\n==== Characteristics of Target State\n\n===== Feature Flags\n\n* All flags remain ON (no changes from AS-3)\n* Feature flag infrastructure retained for emergency rollback capability\n\n===== Architecture\n\n* Bounded contexts operating independently\n* Event-driven integration fully operational\n* Anti-Corruption Layers protecting domain boundaries\n* Zero coupling to legacy OTR App API\n\n=== Technical Dependency Graph\n\n[mermaid]\n----\ngraph TD\n    A[AS-1: Foundation] --> B[AS-2: linking Enabled]\n    B --> C[AS-3: Grants Operational]\n    C --> D[AS-4: Target State]\n\n    A -->|Prerequisite| E[VCI Migration Complete]\n    A -->|Prerequisite| F[EagleEye Wallets Created]\n\n    B -->|Prerequisite| G[OAuth Service Ready<br/>Flybuys IDP configured]\n    B -->|Prerequisite| H[Flybuys OAuth Credentials<br/>Production API keys]\n\n    C -->|Prerequisite| I[Flybuys SFTP Access<br/>SSH keys, PGP encryption]\n    C -->|Prerequisite| J[D365 POS Integration<br/>Barcode API ready]\n\n    D -->|Prerequisite| K[6 Months Stability<br/>No critical incidents]\n    D -->|Prerequisite| L[Legacy Data Archived<br/>7-year retention]\n----\n\n=== Transition Risks\n\n[cols=\"1,3,3,2\"]\n|===\n| Risk ID | Risk Description | Mitigation | Contingency\n\n| TR-001\n| VCI migration fails (customers lose profile data)\n| Dual-write during AS-1 (30 days), legacy remains authoritative\n| Rollback to legacy OTR App API only\n\n| TR-002\n| Flybuys OAuth service outage during rollout\n| Circuit breaker pattern, cached balance data as fallback (5-min TTL)\n| Disable linking, revert to read-only balance\n\n| TR-003\n| Batch file transmission failures (points not posted)\n| Retry logic with exponential backoff (3 attempts), manual SFTP fallback\n| Manual CSV generation and upload by data team\n\n| TR-004\n| POS barcode scanning latency unacceptable (>1s)\n| Redis caching for barcode resolution (5-min TTL), load testing in UAT\n| Revert to legacy Reddy Express POS integration\n\n| TR-005\n| Event Bus delivery failures (eventual consistency)\n| Dead letter queue monitoring (alert if >100 events), replay capability\n| Synchronous API calls as fallback (temporary)\n\n| TR-006\n| Cosmos DB autoscale insufficient (RU/s throttling)\n| Monitor 429 errors, increase max RU/s (10k → 20k), partition optimization\n| Temporarily disable non-critical features\n|===\n\n<<<\n== Solution Validation\n\nThis section defines how the solution will be validated against requirements defined in the Architecture Definition.\n\n=== Functional Validation\n\n*Business Requirements*: See xref:../architecture_definitions/flybuys_integration.adoc#Business%2520Requirements[Business Requirements] in Architecture Definition for complete requirement definitions (BR-001 through BR-012).\n\n*Validation Approach*: All business requirements validated through combination of:\n\n* UAT testing with pilot users (500 mobile app users, 100 OAuth linking attempts)\n* Production pilot at 10 stores (10k transactions monitored)\n* Automated API tests (ProfileService, LoyaltyService, EagleEye integration)\n* Manual verification of batch file generation and Flybuys acknowledgement\n\n*Key Validation Checkpoints*:\n\n* *Customer Identity (BR-001, BR-002)*: 100% users have VCI allocated in Salesforce\n* *Partner linking (BR-004)*: OAuth flow completes in <30s p95\n* *Reward Preferences (BR-005, BR-006)*: Preference changes reflected within 5s\n* *Transaction Posting (BR-007)*: Transactions appear in daily batch file with correct points\n* *Balance Display (BR-010)*: Flybuys balance query returns within 2s p95\n* *Transaction Adjudication (BR-012)*: 100% credentialed transactions route to EagleEye\n\n=== Non-Functional Validation\n\n[cols=\"1,3,3,2\"]\n|===\n| NFR ID | Validation Test | Acceptance Criteria | Tool/Method\n\n| NFR-001\n| Profile Service API latency under load\n| p95 < 200ms with 100 concurrent users\n| JMeter load test (UAT, 10k requests)\n\n| NFR-002\n| Loyalty Service API latency under load\n| p95 < 500ms with 500 concurrent POS transactions/sec\n| JMeter load test (UAT, 50k requests)\n\n| NFR-003\n| Flybuys balance query latency\n| p95 < 2s including Flybuys API call + Redis cache\n| Application Insights (PROD, 30-day avg)\n\n| NFR-004\n| Batch file generation window\n| Job starts 01:00 UTC, completes by 02:00 UTC (1-hour max)\n| Batch pipeline monitoring (PROD, 30-day avg)\n\n| NFR-006\n| Profile Service uptime\n| 99.9% measured over 30 days (max 4.3 hours downtime)\n| Azure Monitor (PROD, 30-day SLA)\n\n| NFR-016\n| Batch file acknowledgement rate\n| >98% transactions acknowledged by Flybuys within 24 hours\n| PROD monitoring (60-day avg)\n|===\n\n=== Integration Validation\n\n[cols=\"2,3,3,2\"]\n|===\n| Integration Point | Validation Test | Acceptance Criteria | Method\n\n| Flybuys OAuth API\n| OAuth flow completes with valid access token\n| Token retrieved and stored in Key Vault\n| Pact contract test (UAT)\n\n| Flybuys Balance API\n| Balance query returns valid response\n| Response matches Flybuys API spec v2.1, < 1.5s latency\n| Integration test harness (UAT)\n\n| Flybuys SFTP\n| Batch file uploads successfully\n| File appears in Flybuys /inbound/otr/ directory, PGP encrypted\n| SFTP integration test (UAT)\n\n| EagleEye Adjudication\n| Transaction adjudication returns grants\n| Response matches EagleEye API spec v3, grants correct\n| Pact contract test (UAT)\n\n| Event Grid\n| Domain events published and consumed\n| Partnerlinked event delivered to Loyalty Service < 5s\n| Event Bus integration test (UAT)\n|===\n\n=== Security Validation\n\n*Validation Method*: Penetration testing (external vendor) + Security audit (internal InfoSec team)\n\n[cols=\"2,3,3,2\"]\n|===\n| Security Control | Validation Test | Acceptance Criteria | Auditor\n\n| OAuth PKCE\n| Authorization code flow uses PKCE\n| Code challenge/verifier validated (S256 method)\n| External pentest (UAT, Q1 2026)\n\n| Token encryption\n| Tokens encrypted at rest (Key Vault)\n| AES-256 encryption, customer-managed keys\n| Internal security audit (PROD)\n\n| API authentication\n| Unauthenticated requests blocked\n| 401 Unauthorized for missing/invalid tokens\n| Automated security scan (UAT)\n\n| Data residency\n| Customer data stored in Australia East region\n| Cosmos DB, Key Vault in AU region only\n| Compliance audit (PROD)\n|===\n\n=== SBB Dependency Flowchart\n\nThis flowchart visualizes the dependency relationships between Solution Building Blocks (SBBs) in the Flybuys Integration architecture.\n\n==== Dependency Chain Diagram\n\n[mermaid]\n----\ngraph TD\n    %% External Systems\n    FlybuysOAuth[External: Flybuys OAuth]\n    FlybuysAPI[External: Flybuys API]\n    EagleEyeAPI[External: EagleEye API]\n    BrazeAPI[External: Braze API]\n\n    %% Mobile & Presentation Layer\n    SBB014[SBB-014: OTR Mobile App]\n\n    %% API Gateway\n    SBB013[SBB-013: API Gateway]\n\n    %% Profile Service\n    SBB001[SBB-001: Profile Service API]\n    SBB002[SBB-002: Profile Service Database]\n\n    %% Loyalty Service\n    SBB003[SBB-003: Loyalty Service API]\n    SBB004[SBB-004: Loyalty Service Database]\n\n    %% Engagement Service\n    SBB007[SBB-007: Engagement Service API]\n    SBB008[SBB-008: Engagement Service Database]\n\n    %% Infrastructure Services\n    SBB005[SBB-005: OAuth Token Manager]\n    SBB006[SBB-006: Domain Event Bus]\n    SBB009[SBB-009: Braze Integration Adaptor]\n    SBB010[SBB-010: Flybuys Integration Adaptor]\n    SBB011[SBB-011: EagleEye Integration Adaptor]\n    SBB012[SBB-012: Application Monitoring]\n    SBB015[SBB-015: Batch File Pipeline]\n    SBB016[SBB-016: Distributed Cache]\n    SBB017[SBB-017: Feature Flag Service]\n\n    %% Mobile App Dependencies\n    SBB014 -->|Partner linking| SBB001\n    SBB014 -->|Balance queries| SBB003\n    SBB014 -->|Ingress routing| SBB013\n\n    %% API Gateway Dependencies\n    SBB013 -->|Routes to| SBB001\n    SBB013 -->|Routes to| SBB003\n    SBB013 -->|Routes to| SBB007\n\n    %% Profile Service Dependencies\n    SBB001 -->|Persists PartnerLink| SBB002\n    SBB001 -->|Token storage/retrieval| SBB005\n    SBB001 -->|Publishes events| SBB006\n    SBB001 -->|Monitored by| SBB012\n\n    %% Loyalty Service Dependencies\n    SBB003 -->|Persists transactions| SBB004\n    SBB003 -->|PartnerLink lookup| SBB001\n    SBB003 -->|Publishes/Consumes events| SBB006\n    SBB003 -->|Balance queries| SBB010\n    SBB003 -->|Transaction adjudication| SBB011\n    SBB003 -->|Caches Flybuys balance| SBB016\n    SBB003 -->|Monitored by| SBB012\n    SBB003 -->|Feature toggles| SBB017\n\n    %% OAuth Token Manager Dependencies\n    SBB005 -->|Initiates OAuth| SBB001\n    SBB005 -->|OAuth tokens| FlybuysOAuth\n\n    %% Engagement Service Dependencies\n    SBB007 -->|Persists campaign state| SBB008\n    SBB007 -->|Consumes events| SBB006\n    SBB007 -->|Triggers campaigns| SBB009\n    SBB007 -->|Monitored by| SBB012\n\n    %% Braze Integration Adaptor Dependencies\n    SBB009 -->|Consumes events| SBB006\n    SBB009 -->|Optional enrichment| SBB001\n    SBB009 -->|Webhook calls| BrazeAPI\n\n    %% Flybuys Integration Adaptor Dependencies\n    SBB010 -->|Balance API| FlybuysAPI\n    SBB010 -->|Batch file upload| SBB015\n    SBB010 -->|Cached responses| SBB016\n\n    %% EagleEye Integration Adaptor Dependencies\n    SBB011 -->|Wallet & adjudication| EagleEyeAPI\n\n    %% Batch File Pipeline Dependencies\n    SBB015 -->|Reads transactions| SBB003\n    SBB015 -->|SFTP upload| FlybuysAPI\n\n    %% Event Bus Subscribers\n    SBB006 -.->|Partnerlinked event| SBB003\n    SBB006 -.->|Partnerlinked event| SBB007\n    SBB006 -.->|TransactionAdjudicated event| SBB007\n\n    %% Styling\n    classDef external fill:#f9f,stroke:#333,stroke-width:2px\n    classDef mobile fill:#bbf,stroke:#333,stroke-width:2px\n    classDef gateway fill:#bfb,stroke:#333,stroke-width:2px\n    classDef service fill:#fbb,stroke:#333,stroke-width:2px\n    classDef database fill:#ffb,stroke:#333,stroke-width:2px\n    classDef infrastructure fill:#bff,stroke:#333,stroke-width:2px\n    classDef integration fill:#fbf,stroke:#333,stroke-width:2px\n\n    class FlybuysOAuth,FlybuysAPI,EagleEyeAPI,BrazeAPI external\n    class SBB014 mobile\n    class SBB013 gateway\n    class SBB001,SBB003,SBB007 service\n    class SBB002,SBB004,SBB008 database\n    class SBB005,SBB006,SBB012,SBB015,SBB016,SBB017 infrastructure\n    class SBB009,SBB010,SBB011 integration\n----\n\n==== Dependency Layers\n\n===== Layer 1: External Systems\n\n* Flybuys OAuth Server\n* Flybuys API (Balance, Batch File SFTP)\n* EagleEye API\n* Braze API\n\n===== Layer 2: Presentation & Gateway\n\n* *SBB-014*: OTR Mobile App\n* *SBB-013*: API Gateway (ingress routing, OAuth validation, rate limiting)\n\n===== Layer 3: Domain Services\n\n* *SBB-001*: Profile Service API (partner linking, reward preferences)\n* *SBB-003*: Loyalty Service API (credential resolution, transaction adjudication)\n* *SBB-007*: Engagement Service API (campaign orchestration)\n\n===== Layer 4: Data Stores\n\n* *SBB-002*: Profile Service Database (PartnerLink aggregates)\n* *SBB-004*: Loyalty Service Database (RewardTransaction audit trail)\n* *SBB-008*: Engagement Service Database (campaign state tracking)\n\n===== Layer 5: Infrastructure Services\n\n* *SBB-005*: OAuth Token Manager (Flybuys token storage/refresh)\n* *SBB-006*: Domain Event Bus (event-driven integration)\n* *SBB-012*: Application Monitoring (observability)\n* *SBB-016*: Distributed Cache (Flybuys balance caching)\n* *SBB-017*: Feature Flag Service (progressive rollout)\n\n===== Layer 6: Integration Adaptors (Anti-Corruption Layers)\n\n* *SBB-009*: Braze Integration Adaptor (marketing automation)\n* *SBB-010*: Flybuys Integration Adaptor (conformist pattern)\n* *SBB-011*: EagleEye Integration Adaptor (loyalty engine)\n\n===== Layer 7: Batch Processing\n\n* *SBB-015*: Batch File Pipeline (nightly transaction aggregation, SFTP transmission)\n\n==== Critical Dependency Paths\n\n===== Partner linking Flow\n\n----\nMobile App (SBB-014)\n  → API Gateway (SBB-013)\n  → Profile Service (SBB-001)\n  → OAuth Token Manager (SBB-005)\n  → Flybuys OAuth\n----\n\n===== Transaction Adjudication Flow\n\n----\nPOS System\n  → API Gateway (SBB-013)\n  → Loyalty Service (SBB-003)\n  → Profile Service (SBB-001) [PartnerLink lookup]\n  → EagleEye Adaptor (SBB-011)\n  → EagleEye API\n----\n\n===== Flybuys Balance Query Flow\n\n----\nLoyalty Service (SBB-003)\n  → Distributed Cache (SBB-016) [cache miss]\n  → Flybuys Adaptor (SBB-010)\n  → Flybuys API\n----\n\n===== Event-Driven Engagement Flow\n\n----\nProfile Service (SBB-001) [publishes Partnerlinked]\n  → Event Bus (SBB-006)\n  → Engagement Service (SBB-007)\n  → Braze Adaptor (SBB-009)\n  → Braze API\n----\n\n==== Notes\n\n* *Solid arrows (→)* indicate synchronous dependencies (REST API calls, database queries)\n* *Dotted arrows (-.->)* indicate asynchronous dependencies (event subscriptions)\n* Some SBB references in the document contain numbering errors\n","structuredPatch":[{"oldStart":3251,"oldLines":13,"newStart":3251,"newLines":13,"lines":[" "," === Transition Phase Matrix"," ","-Progressive rollout of feature flags across architecture states (AS-0 → AS-1 → AS-2 → AS-3 → AS-4).","+Progressive rollout of feature flags across architecture states (TS-0 → AS-1 → AS-2 → AS-3 → AS-4)."," "," *Flag Definitions*: See xref:../architecture_definitions/flybuys_integration.adoc#Feature%2520Flag%2520Register[Feature Flag Register] in Architecture Definition for complete flag purposes, ownership, and strategic rationale."," "," [cols=\"3,1,1,1,1,1\"]"," |===","-| Flag Name | AS-0 Current | AS-1 Foundation | AS-2 linking | AS-3 Grants | AS-4 Target","+| Flag Name | TS-0 Current | AS-1 Foundation | AS-2 linking | AS-3 Grants | AS-4 Target"," "," | +OTR.Loyalty.Enabled+"," | OFF"]},{"oldStart":3361,"oldLines":7,"newStart":3361,"newLines":7,"lines":[" "," *Impact*: Points not posted to Flybuys immediately, requires manual batch file regeneration and transmission"," ","-=== AS-0 Current State","+=== TS-0 Current State"," "," Pre-initiative architecture (reference Architecture Definition §2 Current State)"," "]}],"userModified":false,"replaceAll":true},"sourceToolAssistantUUID":"0b75b486-b8fd-4ae9-9e05-68d0b1bca84a"}
{"parentUuid":"55ea05c1-8873-4c9b-9e4e-02fabceac374","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01KnoQfNNaVUvD62pYLH6e3M","type":"tool_result","content":"The file /mnt/c/Users/o.young/work/architecture/solution_architectures/flybuys_integration.adoc has been updated. All occurrences of 'AS-1' were successfully replaced with 'TS-1'."}]},"uuid":"66c75ace-d5c0-4dee-ae55-58c828e933c4","timestamp":"2026-01-08T05:38:51.120Z","toolUseResult":{"filePath":"/mnt/c/Users/o.young/work/architecture/solution_architectures/flybuys_integration.adoc","oldString":"AS-1","newString":"TS-1","originalFile":"= Flybuys Integration - Solution Architecture\n\n:project-name: Flybuys Integration\n:togaf-adm-phase: Phase E: Opportunities & Solutions\n:document-type: Solution Architecture Document\n:status: Discovery\n:version: 0.1\n:domain: Loyalty\n:programme-lead: Frankie.Mullaly@vivaenergy.com.au\n:domain-architect: O.Young@otr.com.au\n:business-owner: D.Peisley@otr.com.au\n:business-analyst: Fiona.Cheung@vivaenergy.com.au\n:architecture-definition: xref:../architecture_definitions/flybuys_integration.adoc[Architecture Definitions/Flybuys Integration]\n:doctype: article\n:toc: left\n:toclevels: 4\n:sectanchors:\n:sectxrefs:\n:sectnums:\n:icons: font\n:source-highlighter: highlightjs\n:experimental:\n:description: Solution Architecture Document for Flybuys Coalition Loyalty Integration\n:keywords: loyalty, flybuys, integration, solution-architecture, togaf\n\n== Purpose and Scope\n\n=== Purpose\n\nThis Solution Architecture defines how the Flybuys Integration will be implemented - the specific technology products, configurations, interfaces, and deployment architecture that realise the xref:../architecture_definitions/flybuys_integration.adoc[Flybuys Integration].\n\n<<<\n=== Scope\n\n==== In Scope\n\n* Solution Building Blocks (SBBs) - specific technology products and versions\n* Interface specifications (APIs, events, data formats)\n* Data architecture and schema specifications\n* Transition architecture with phased implementation states\n* Technical validation criteria and testing approach\n* External system integration specifications\n\n==== Out of Scope\n\n===== Covered in xref:../architecture_definitions/flybuys_integration.adoc[Architecture Definition]\n\n* Business requirements and stakeholder analysis\n* Architecture decisions and rationale\n* Bounded context definitions and responsibilities\n* High-level integration patterns (ACL, Conformist, OHS+PL)\n* Business capability mapping and value streams\n* Non-functional requirements (referenced, not duplicated)\n* Architecture principles and governance\n\n===== Covered in other documents\n\n* Detailed design (class diagrams, sequence diagrams for all flows)\n* Implementation code and unit tests\n* Business case and return-on-investment analysis\n* Operational run books and support procedures\n\n<<<\n== Executive Summary\n\nIntegrate xref:../bounded_context/external/flybuys.adoc[Flybuys] Coalition Loyalty across all OTRG Digital and In-Person channels without tightly coupling to external partner systems.\n\nEnable xref:../ubiquitous_language.adoc#customer[Customers] to link their xref:../ubiquitous_language.adoc#flybuys-digital-identity[Flybuys Digital Identity] with their xref:../ubiquitous_language.adoc#otr-app[Mobile Application] user profile, and present unified xref:../ubiquitous_language.adoc#loyalty-credential[Loyalty Credentials] at all xref:../bounded_context/interfaces/otr_pos.adoc[OTR POS] and xref:../bounded_context/interfaces/otr_plus_pos.adoc[OTR+ POS] stores.\n\nThe solution establishes the xref:../ubiquitous_language.adoc#viva-consumer-id-vci[Viva Consumer ID (VCI)] as *the canonical customer identifier* across all integrated systems, ensuring consistent customer reference throughout the loyalty platform and eliminating identity fragmentation.\n\n<<<\n== Solution Approach\n\n* Deploy xref:../bounded_context/profile.adoc[Profile Service] and xref:../bounded_context/loyalty.adoc[Loyalty Service] as bounded context microservices\n* Use NoSQL local document storage with partition key optimisation for caching.\n* Implement **Anti-Corruption Layers** (ACLs) for xref:../bounded_context/external/braze.adoc[Braze], xref:../bounded_context/external/flybuys.adoc[Flybuys] and xref:../bounded_context/external/eagle_eye.adoc[EagleEye] integration\n* Deploy xref:../bounded_context/interfaces/oauth.adoc[OAuth Service] with Key Vault token encryption\n* Establish event-driven architecture as the foundational integration pattern for the platform.\n* Phased roll-out (AS-1 → AS-4)\n\n=== Related Documentation\n\nThis solution architecture references detailed technical specifications:\n\n==== API Specifications\n\n* xref:../specifications/REST/profile-service-v1.yaml.md[Profile Service REST API (OpenAPI 3.0)] - Partner linking, preference management (4 endpoints)\n* xref:../specifications/AsyncAPI/otr-event-bus-v1.yaml.md[Event Bus (AsyncAPI 2.6.0)] - Domain events, CloudEvents 1.0 format\n\n==== Sequence Diagrams\n\n* Flybuys Integration Flows[Flybuys Integration Flows] - Comprehensive diagrams with happy path + error scenarios:\n** Transaction Adjudication (POS real-time, 4 scenarios)\n** OAuth Partner linking (mobile app, 4 scenarios)\n** Batch File Processing (nightly, 3 scenarios)\n** Circuit Breaker State Transitions\n** Event Propagation Timeline\n** OAuth Token Refresh (proactive + errors, 3 scenarios)\n\n==== JSON Schemas\n\n* xref:../specifications/JSON%2520Schemas/.md[JSON Schemas Directory] - Domain event schemas, request/response models\n\n==== Executive Summary\n\n* xref:../executive_summaries/flybuys_integration.adoc[Executive Summary] - 1-page overview for business stakeholders\n\n<<<\n== Key Technology Decisions\n\n[cols=\"1,2,4,3\"]\n|===\n| ID | Kind | Description | Rationale\n\n| DEC-001\n| Implementation\n| .NET 8.0\n| Aligns with OTR platform standards, team expertise in C#\n\n| DEC-002\n| Hosting\n| #TBD#\n| Autoscaling, managed infrastructure, Docker support\n\n| DEC-003\n| NoSQL Database\n| #TBD#\n| Partition key performance, global distribution, TTL support\n\n| DEC-004\n| Event Bus\n| #TBD#\n| CloudEvents 1.0 standard, built-in retry, dead letter queue\n\n| DEC-005\n| Key Storage\n| #TBD#\n| SaaS OAuth provider, Flybuys IDP integration, reduces custom implementation risk\n\n| DEC-006\n| Data Processing\n| #TBD#\n| SFTP connector, PGP encryption, scheduling\n\n| DEC-007\n| Monitoring\n| #TBD#\n| Native Azure integration, distributed tracing, correlation IDs\n\n| DEC-008\n| API Gateway\n| #TBD#\n| OAuth validation, rate limiting, request transformation\n\n| DEC-009\n| Caching Layer\n| #TBD#\n| Reduces Flybuys API load, low-latency access\n\n| DEC-010\n| Mobile App\n| #TBD#\n| Shared business logic, reduces duplicate code for iOS/Android\n\n| DEC-011\n| Authentication\n| xref:../bounded_context/external/microsoft_entra_external_id.adoc[Microsoft Entra External ID]\n| Standardised auth, secure token handling, integrates with mobile app\n\n| DEC-013\n| Resilience\n| #TBD#\n| Circuit breaker, retry policies for external API calls\n\n| DEC-014\n| Configuration / Feature Flags\n| #TBD#\n| Dynamic feature toggling, reduces deployment risk\n\n| DEC-015\n| Transport\n| REST over HTTPS\n|\n\n| DEC-016\n| Observability\n| #TBD#\n|\n\n| DEC-017\n| Deployment\n| #TBD#\n| Docker container + Azure Container Registry\n\n| DEC-018\n| Encryption (At Rest)\n| AES-256\n|\n\n| DEC-019\n| Encryption (In Flight)\n| TLS 1.3\n|\n\n| DEC-020\n| Schema Registry\n| #TBD#\n|\n|===\n\n=== Implementation Constraints\n\n* Must conform to Flybuys API specifications - cannot modify (xref:../architecture_definitions/flybuys_integration.adoc#constraints[CON-002])\n* Flybuys partnership potentially term 2-3 years - architecture must support partner flexibility (xref:../architecture_definitions/flybuys_integration.adoc#constraints[CON-006])\n* OAuth tokens must be `AES-256` encrypted at rest (<<key-technology-decisions,DEC-018>>), `TLS 1.3` in transit (DEC-018 xref:../architecture_definitions/flybuys_integration.adoc#constraints[CON-003])\n* Customer data must reside in Australia East region (xref:../architecture_definitions/flybuys_integration.adoc#constraints[CON-011])\n* Phased rollout required, no big-bang deployment (xref:../architecture_definitions/flybuys_integration.adoc#constraints[CON-004])\n\n=== Success Criteria\n\n* xref:../bounded_context/profile.adoc[Profile Service] / xref:../bounded_context/loyalty.adoc[Loyalty Service] APIs operational with <`500ms` `p95` latency (NFR-001, NFR-002)\n* OAuth linking success rate >95% over 30-day pilot period (7.5 Validation Exit Criteria)\n* Flybuys batch acknowledgement rate >98% for 60 days (NFR-016)\n\n<<<\n== Solution Building Blocks\n\nThis section maps the conceptual *Architecture Building Blocks* (ABBs) defined in the xref:../architecture_definitions/flybuys_integration.adoc[Architecture Definition] to specific *Solution Building Blocks* (SBBs).\n\n=== Technology Portfolio Catalogue\n\nThis catalogue lists all technology components required to implement the Flybuys Integration solution, mapped to the xref:../architecture_definitions/flybuys_integration.adoc#Technology%2520Capability%2520Requirements[Technology Capability Requirements] defined in the Architecture Definition.\n\n[cols=\"1,1,3,1,2,1\"]\n|===\n| Component | Category | Technology Stack | Lifecycle Stage | Rationale | Standards/Patterns\n\n| Event Bus\n| Integration\n| #TBD#\n| Planned\n| Event-driven architecture, loose coupling between services\n| OHS + Published Language\n\n| OAuth Service\n| Infrastructure\n| #TBD#\n| Planned\n| Secure token management, PCI compliance\n| OAuth 2.0, PKCE\n\n| Circuit Breaker\n| Resilience\n| #TBD#\n| Planned\n| Flybuys API failure handling\n| Circuit Breaker Pattern\n\n| Feature Flags\n| Deployment\n| #TBD#\n| Planned\n| Gradual rollout, kill switch for rollback\n| Feature Toggle Pattern\n\n| API Gateway\n| Infrastructure\n| #TBD#\n| Active\n| Single entry point, rate limiting, auth\n| RESTful API, OpenAPI\n\n| NoSQL Database\n| Data Storage\n| #TBD#\n| Active\n| Database per bounded context, high throughput\n| Database per Service\n\n| Key Vault\n| Security\n| #TBD#\n| Active\n| OAuth token storage, encryption keys\n| AES-256, Customer-Managed Keys\n\n| Redis Cache\n| Caching\n| #TBD#\n| Active\n| Flybuys balance caching (5-min TTL), circuit breaker fallback\n| In-Memory Cache, TTL Pattern\n\n| Monitoring Stack\n| Observability\n| #TBD#\n| Active\n| Distributed tracing, metrics, logging\n| OpenTelemetry, Structured Logging\n\n| Identity Provider\n| Authentication\n| xref:../bounded_context/external/microsoft_entra_external_id.adoc[Microsoft Entra External ID]\n| Active\n| Customer authentication, CIAM\n| OAuth 2.0, OIDC\n\n| SFTP Service\n| Integration\n| xref:../bounded_context/external/azure_data_factory.adoc[Azure Data Factory]\n| Active\n| Flybuys batch file transmission\n| SFTP Protocol, Batch File Transfer\n\n| Batch Scheduler\n| Infrastructure\n| xref:../bounded_context/external/azure_data_factory.adoc[Azure Data Factory]\n| Active\n| Nightly batch file generation\n| Cron-based Scheduling\n|===\n\n*Note*: Components marked #TBD# are deferred to implementation phase as engineering choices. See <<key-technology-decisions,Technology Decisions>> for evaluation criteria.\n\n<<<\n\n=== Solution Building Block Mapping\n\n[cols=\"1,3,2,3,4\"]\n|===\n| ABB ID | ABB Name | SBB ID | SBB Name | Technology Product/Component\n\n| ABB-001\n| xref:../bounded_context/profile.adoc[Profile Service] Bounded Context\n| <<sbb-001-profile-service-api,SBB-001>>\n| xref:../bounded_context/profile.adoc[Profile Service] API\n| <<key-technology-decisions,DEC-001 Implementation>>\n\n| ABB-001\n| xref:../bounded_context/profile.adoc[Profile Service] Data Store\n| <<sbb-002-profile-service-database,SBB-002>>\n| xref:../bounded_context/profile.adoc[Profile Service] Database\n| <<key-technology-decisions,DEC-003 NoSQL>>\n\n| ABB-002\n| xref:../bounded_context/loyalty.adoc[Loyalty Service] Bounded Context\n| <<sbb-003-loyalty-service-api,SBB-003>>\n| xref:../bounded_context/loyalty.adoc[Loyalty Service] API\n| <<key-technology-decisions,DEC-001 Implementation>>\n\n| ABB-002\n| xref:../bounded_context/loyalty.adoc[Loyalty Service] Data Store\n| <<sbb-004-loyalty-service-database,SBB-004>>\n| xref:../bounded_context/loyalty.adoc[Loyalty Service] Database\n| <<key-technology-decisions,DEC-003 NoSQL>>\n\n| ABB-006\n| xref:../bounded_context/interfaces/oauth.adoc[OAuth Service]\n| <<sbb-005-oauth-token-manager,SBB-005>>\n| OAuth Token Manager\n| <<key-technology-decisions,DEC-005 Key Storage>>\n\n| ABB-005\n| Event Bus[Event Bus]\n| <<sbb-006-domain-event-bus,SBB-006>>\n| Domain Event Bus\n| <<key-technology-decisions,DEC-004 Event Bus>>\n\n| ABB-004\n| xref:../bounded_context/engagement.adoc[Engagement Service] Bounded Context\n| <<sbb-007-engagement-service-api,SBB-007>>\n| xref:../bounded_context/engagement.adoc[Engagement Service] API\n| <<key-technology-decisions,DEC-001 Implementation>>\n\n| ABB-004\n| xref:../bounded_context/engagement.adoc[Engagement Service] Data Store\n| <<sbb-008-engagement-service-database,SBB-008>>\n| xref:../bounded_context/engagement.adoc[Engagement Service] Datastore\n| <<key-technology-decisions,DEC-003 NoSQL>>\n\n| ABB-012\n| Braze ACL\n| <<sbb-009-braze-integration-adaptor,SBB-009>>\n| xref:../bounded_context/external/braze.adoc[Braze Integration Adaptor]\n| <<key-technology-decisions,DEC-001 Implementation>>\n\n| ABB-013\n| Flybuys ACL\n| <<sbb-010-flybuys-integration-adaptor,SBB-010>>\n| xref:../bounded_context/external/flybuys.adoc[Flybuys Integration Adaptor]\n| <<key-technology-decisions,DEC-001 Implementation>> + <<key-technology-decisions,DEC-006 Data Processing>>\n\n| ABB-014\n| EagleEye ACL\n| <<sbb-011-eagleeye-integration-adaptor,SBB-011>>\n| xref:../bounded_context/external/eagle_eye.adoc[EagleEye Integration Adaptor]\n| <<key-technology-decisions,DEC-001 Implementation>>\n\n| ABB-009\n| Monitoring & Observability\n| <<sbb-012-application-monitoring,SBB-012>>\n| Application Monitoring\n| <<key-technology-decisions,DEC-007 Monitoring>>\n\n| ABB-007\n| API Gateway\n| <<sbb-013-api-gateway,SBB-013>>\n| xref:../bounded_context/interfaces/api_gateway.adoc[API Gateway]\n| <<key-technology-decisions,DEC-008 API Gateway>>\n\n| ABB-010\n| xref:../bounded_context/interfaces/mobile.adoc[Mobile Application]\n| <<sbb-014-otr-mobile-app,SBB-014>>\n| OTR Mobile App\n| <<key-technology-decisions,DEC-010 Mobile Application>>\n\n| ABB-015\n| Points File Management\n| <<sbb-015-batch-file-pipeline,SBB-015>>\n| Batch File Pipeline\n| <<key-technology-decisions,DEC-006 Data Processing>>\n\n| ABB-011\n| Caching Layer\n| <<sbb-016-distributed-cache,SBB-016>>\n| Distributed Cache\n| <<key-technology-decisions,DEC-009 Caching Layer>>\n\n| ABB-008\n| App Config / Feature Flags\n| <<sbb-017-feature-flag-service,SBB-017>>\n| Feature Flags\n|\n\n| ABB-003\n| xref:../bounded_context/location.adoc[Location Service] Bounded Context\n| <<sbb-018-location,SBB-018>>\n| xref:../bounded_context/location.adoc[Location Service] API\n| <<key-technology-decisions,DEC-001 Implementation>>\n\n| ABB-003\n| xref:../bounded_context/location.adoc[Location Service] Data Store\n| <<SBB-019,SBB-019>>\n| xref:../bounded_context/location.adoc[Location Service] Data Store\n|\n|===\n\n<<<\n=== SBB-001: Profile Service API\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| Description\n| Provides APIs for managing customer xref:../ubiquitous_language.adoc#partner-xref[PartnerLink]s with Flybuys, storing reward preferences, and retrieving linked profile data.\n\n| ABB Reference\n| xref:../bounded_context/profile.adoc[Profile Service] Bounded Context (see xref:../architecture_definitions/flybuys_integration.adoc#service-catalogues[Architecture Definition §3.2.1])\n\n| Component Type\n| Microservice (Domain Service)\n\n| Technology Stack\n| <<key-technology-decisions,DEC-001 Implementation>>\n\n| Hosting Platform\n| <<key-technology-decisions,DEC-002 Hosting>>\n\n| API Contract\n| <<key-technology-decisions,DEC-005 Transport>> - See xref:/specifications/rest/profile-service-v1.yaml[OpenAPI 3.0 Specification]\n\n| Authentication\n| <<key-technology-decisions,DEC-011 Authentication>>\n\n| Observability\n| <<key-technology-decisions,DEC-016 Observability>>\n\n| Configuration\n| <<key-technology-decisions,DEC-014 Configuration>>\n\n| Health Checks\n| `/health` HTTPS endpoint\n\n| Deployment Unit\n| <<key-technology-decisions,DEC-017 Deployment>>\n|===\n\n==== Dependencies\n\n[cols=\"2,2,4\"]\n|===\n| SBB ID | Dependency | Reason\n\n| <<sbb-002-profile-service-database,SBB-002>>\n| xref:../bounded_context/profile.adoc[Profile Service] Database\n| xref:../ubiquitous_language.adoc#partner-xref[PartnerLink] aggregate persistence\n\n| <<sbb-005-oauth-token-manager,SBB-005>>\n| OAuth Token Manager\n| xref:../bounded_context/external/flybuys.adoc[Flybuys] OAuth token storage/retrieval\n\n| <<sbb-006-domain-event-bus,SBB-006>>\n| Domain Event Bus\n| Publishing Partnerlinked event schema[Partnerlinked], xref:/specifications/json_schemas/RewardPreferenceChanged.event.schema.json[RewardPreferenceChanged], xref:/specifications/json_schemas/CustomerProfileCreated.event.schema.json[CustomerProfileCreated] events (see AsyncAPI Spec[AsyncAPI Spec])\n\n| <<sbb-010-flybuys-integration-adaptor,SBB-010>>\n| API Gateway\n| Ingress routing, rate limiting, OAuth validation\n\n| Salesforce\n| xref:../bounded_context/external/salesforce.adoc[Salesforce CRM]\n| Upsert Contact record during profile creation (`POST /api/v1/profile/customers`)\n|===\n\n\n<<<\n=== SBB-002: Profile Service Database\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| ABB Reference\n| xref:../bounded_context/profile.adoc[Profile Service] Data Store\n\n| Database Type\n| NoSQL Document Database\n\n| Product\n| <<key-technology-decisions,DEC-003>>\n\n| Consistency\n| Session consistency (default), Strong consistency for PartnerLink operations\n\n| Partition Strategy\n| Partition key: `/vivaConsumerId` (enables single-partition queries, ~10KB documents)\n\n| Throughput\n| Autoscale: 1000-10000 RU/s (scales based on load, avg 4000 RU/s expected)\n\n| Geo-Replication\n| xref:../architecture_definitions/flybuys_integration.adoc#Constraints[CON-011]\n\n| Backup\n| Continuous backup (7-day point-in-time recovery, hourly snapshots)\n\n| Indexes\n| Default indexing + composite index on `[/partner ASC, /status ASC]`\n\n| Containers\n| `partner-links` (main), `customer-profiles` (read model for Salesforce sync)\n\n| Data Residency\n| xref:../architecture_definitions/flybuys_integration.adoc#Constraints[CON-011]\n|===\n\n\n<<<\n=== SBB-003: Loyalty Service API\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| ABB Reference\n| xref:../bounded_context/loyalty.adoc[Loyalty Service] Bounded Context (see xref:../architecture_definitions/flybuys_integration.adoc#service-catalogues[Architecture Definition §3.2.1])\n\n| Component Type\n| Microservice (Domain Service)\n\n| Technology Stack\n| <<key-technology-decisions,DEC-001 Implementation>>\n\n| Hosting Platform\n| <<key-technology-decisions,DEC-002 Hosting>>\n\n| API Contract\n| <<key-technology-decisions,DEC-005 Transport>> - See xref:../specifications/REST/loyalty-service-v1.yaml[OpenAPI 3.0 Specification]\n\n| Batch Processing\n| <<key-technology-decisions,DEC-012 Batch Processing>>\n\n| Authentication\n| <<key-technology-decisions,DEC-011 Authentication>>\n\n| Observability\n| <<key-technology-decisions,DEC-016 Observability>>\n\n| Configuration\n| <<key-technology-decisions,DEC-014 Configuration>>\n\n| Health Checks\n| `/health` HTTPS endpoint\n\n| Deployment Unit\n| <<key-technology-decisions,DEC-017 Deployment>>\n|===\n\n==== Capabilities\n\n===== Loyalty Credential Resolution\n\n* Resolves EAN-13 barcodes from xref:../bounded_context/interfaces/otr_pos.adoc[OTR POS] and xref:../bounded_context/interfaces/otr_plus_pos.adoc[OTR+ POS] scanners to xref:../ubiquitous_language.adoc#viva-consumer-id-vci[Viva Consumer Id (VCI)]\n* Supports all xref:../ubiquitous_language.adoc#loyalty-credential[Loyalty Credential] types:\n** Barcode from xref:../bounded_context/interfaces/mobile.adoc[OTR Mobile],\n** Barcode from xref:../bounded_context/interfaces/mobile.adoc[SPS Mobile],\n** xref:../bounded_context/interfaces/mobile.adoc[Apple/Google Wallet passes],\n** Physical Flybuys cards,\n** Flybuys Mobile barcodes\n* Resolved Loyalty Credentials to\n** Direct resolution for OTR credentials (barcode → VCI)\n** Indirect resolution for Flybuys credentials (barcode → PartnerLink → VCI)\n* Returns customer context (VCI, reward preference, wallet ID) to POS within 500ms p95 (xref:../architecture_definitions/flybuys_integration.adoc#non-functional-requirements[NFR-002])\n\n==== Dependencies\n\n[cols=\"2,3,5\"]\n|===\n| SBB ID | Dependency | Reason\n\n| <<SBB-004 Loyalty Service Database,SBB-004>>\n| xref:../bounded_context/loyalty.adoc[Loyalty Service] Database\n| xref:../ubiquitous_language.adoc#reward-transaction[RewardTransaction] aggregate persistence\n\n| <<SBB-001 Profile Service API,SBB-001>>\n| xref:../bounded_context/profile.adoc[Profile Service] API\n| PartnerLink lookup for Flybuys credential resolution\n\n| <<SBB-006 Domain Event Bus,SBB-006>>\n| Domain Event Bus\n| Consuming xref:../specifications/JSON%2520Schemas/Partnerlinked.event.schema.json[Partnerlinked] events, publishing xref:../specifications/JSON%2520Schemas/TransactionAdjudicated.event.schema.json[TransactionAdjudicated] events (see xref:../specifications/AsyncAPI/otr-event-bus-v1.yaml[AsyncAPI Spec])\n\n| <<SBB-007 Flybuys Integration Adapter,SBB-007>>\n| xref:../bounded_context/external/flybuys.adoc[Flybuys Integration Adapter]\n| Balance queries, batch file transmission\n\n| <<SBB-008 EagleEye Integration Adapter,SBB-008>>\n| xref:../bounded_context/external/eagle_eye.adoc[EagleEye Integration Adapter]\n| Transaction Adjudication, wallet queries\n\n| <<SBB-010 API Gateway,SBB-010>>\n| xref:../bounded_context/interfaces/api_gateway.adoc[API Gateway]\n| Ingress routing for mobile app and POS systems\n\n| <<SBB-013 Distributed Cache,SBB-013>>\n| Distributed Cache\n| Caching Flybuys balance queries\n|===\n\n\n<<<\n=== SBB-004: Loyalty Service Database\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| ABB Reference\n| xref:../bounded_context/loyalty.adoc[Loyalty Service] Data Store\n\n| Database Type\n| NoSQL Document Database\n\n| Product\n| <<key-technology-decisions,DEC-003>>\n\n| Consistency\n| Session consistency (eventual consistency acceptable for audit trail)\n\n| Partition Strategy\n| Partition key: `/vivaConsumerId` (enables single-partition transaction queries)\n\n| Throughput\n| Autoscale: 1000-20000 RU/s (higher peak for POS transaction volume)\n\n| Geo-Replication\n| xref:../architecture_definitions/flybuys_integration.adoc#Constraints[CON-011]\n\n| Backup\n| Continuous backup (7-day point-in-time recovery)\n\n| TTL\n| 2592000 seconds (30 days) - automatic deletion for RewardTransaction documents\n\n| Indexes\n| Default indexing + range index on `/transactionDate DESC` for recent queries\n\n| Containers\n| `reward-transactions` (audit trail with 30-day TTL)\n\n| Data Residency\n| xref:../architecture_definitions/flybuys_integration.adoc#Constraints[CON-011]\n|===\n\n\n<<<\n=== SBB-005: OAuth Token Manager\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| ABB Reference\n| OAuth Service (Infrastructure)\n\n| Component Type\n| Infrastructure Service (OAuth provider + secure token storage)\n\n| Token Storage\n| <<key-technology-decisions,DEC-005>>\n\n| Token Format\n| https://www.oauth.com/oauth2-servers/access-tokens/\n\n| Secret Naming\n| `\\{partner}-token-{vivaConsumerId}` (e.g., `flybuys-token-vci_xyz789abc`)\n\n| Refresh Logic\n| Azure Function (Timer trigger every 50 minutes, before 60-minute expiry)\n\n| Encryption\n|\n|===\n\n==== OAuth Token Refresh Flow\n\nSee detailed sequence diagrams in #oauth-token-refresh-flow[Sequence Diagrams] for error scenarios including token expiry and API unavailability.\n\n[mermaid]\n----\nsequenceDiagram\n    autonumber\n    participant Timer as Azure Function<br/>(Timer Trigger)\n    participant TokenManager as OAuth Token Manager\n    participant KeyVault as Azure Key Vault\n    participant FlybuysOAuth as Flybuys OAuth Server\n    participant DB as Profile Database\n    participant Monitor as Monitoring\n\n    Note over Timer,Monitor: Timer trigger: Every 50 minutes\n\n    Timer->>TokenManager: Trigger token refresh job\n\n    activate TokenManager\n    TokenManager->>DB: Query PartnerLinks<br/>WHERE partner=\"FLYBUYS\" AND status=\"linked\"\n    activate DB\n    DB-->>TokenManager: 10,000 active PartnerLinks\n    deactivate DB\n\n    loop For each PartnerLink (batch of 100)\n        TokenManager->>KeyVault: Get token<br/>SecretName: flybuys-token-{vci}\n        activate KeyVault\n        KeyVault-->>TokenManager: {access_token, refresh_token, expiresAt}\n        deactivate KeyVault\n\n        TokenManager->>TokenManager: Check: expiresAt - now < 10 minutes?\n\n        alt Token expiring soon\n            TokenManager->>FlybuysOAuth: POST /token<br/>{grant_type: \"refresh_token\", refresh_token}\n            activate FlybuysOAuth\n            FlybuysOAuth->>FlybuysOAuth: Validate refresh_token\n            FlybuysOAuth-->>TokenManager: {access_token (new), refresh_token (new), expires_in: 3600}\n            deactivate FlybuysOAuth\n\n            TokenManager->>KeyVault: Update secret<br/>flybuys-token-{vci}\n            activate KeyVault\n            KeyVault-->>TokenManager: Secret updated\n            deactivate KeyVault\n\n            TokenManager->>Monitor: Metric: token_refresh_success\n        else Token still valid\n            TokenManager->>Monitor: Metric: token_refresh_skipped\n        end\n    end\n\n    TokenManager-->>Timer: Job complete<br/>Refreshed: 8,500 tokens<br/>Skipped: 1,500 tokens\n    deactivate TokenManager\n\n    Timer->>Monitor: Log job duration: 45 seconds\n----\n\n==== Dependencies\n\n[cols=\"2,2,4\"]\n|===\n| SBB ID | Dependency | Reason\n\n| <<SBB-001 Profile Service API,SBB-001>>\n| xref:../bounded_context/profile.adoc[Profile Service]\n| Initiates OAuth flow, stores `oauthTokenReference` in PartnerLink\n\n| External\n| OAuth Provider\n| Flybuys OAuth API integration\n|===\n\n\n<<<\n=== SBB-006: Domain Event Bus\n\n==== Event Specifications\n\nSee xref:../specifications/AsyncAPI/otr-event-bus-v1.yaml[AsyncAPI 2.6.0 Specification] for complete event definitions, schemas, and examples. Individual event schemas available in xref:../specifications/JSON%2520Schemas[JSON Schemas directory].\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| ABB Reference\n| Domain Event Bus\n\n| Platform\n| <<key-technology-decisions,DEC-004>>\n\n| Retention\n| 7 days (with dead letter queue for failed deliveries)\n\n| Schema Registry\n| <<key-technology-decisions,DEC-020>>\n\n| Delivery Guarantee\n| At-least-once delivery with retry (max 30 attempts, exponential backoff)\n\n| Monitoring\n| <<key-technology-decisions,DEC-007>>\n|===\n\n===== Topics\n\n*Profile Events* (`profile.events` topic)\n\n[cols=\"2,3,1\"]\n|===\n| Event Name | Description | Schema\n\n| `PartnerLinked`\n| Partner account linked to customer profile\n| PartnerLinked event schema[Schema]\n\n| `PartnerUnlinked`\n| Partner account unlinked from customer\n| xref:../specifications/JSON%2520Schemas/PartnerUnlinked.event.schema.json[Schema]\n\n| `RewardPreferenceChanged`\n| Customer changed reward preference selection\n| xref:../specifications/JSON%2520Schemas/RewardPreferenceChanged.event.schema.json[Schema]\n|===\n\n*Loyalty Events* (`loyalty.events` topic)\n\n[cols=\"2,3,1\"]\n|===\n| Event Name | Description | Schema\n\n| `CustomerProfileCreated`\n| Customer profile created during Just-In-Time Integration\n| xref:../specifications/JSON%2520Schemas/CustomerProfileCreated.event.schema.json[Schema]\n\n| `TransactionAdjudicated`\n| Transaction Adjudication completed\n| xref:../specifications/JSON%2520Schemas/TransactionAdjudicated.event.schema.json[Schema]\n\n| `PointsEarned`\n| Points earned in loyalty programme\n| xref:../specifications/JSON%2520Schemas/PointsEarned.event.schema.json[Schema]\n\n| `FuelDiscountApplied`\n| Fuel discount applied to transaction\n| xref:../specifications/JSON%2520Schemas/FuelDiscountApplied.event.schema.json[Schema]\n\n| `RewardTransactionFailed`\n| Transaction adjudication failed\n| xref:../specifications/JSON%2520Schemas/RewardTransactionFailed.event.schema.json[Schema]\n\n| `PointsRedeemed`\n| Points redeemed in loyalty programme\n| _Planned_\n\n| `PointsExpired`\n| Points expired\n| _Planned_\n\n| `GrantIssued`\n| Loyalty grant issued\n| _Planned_\n\n| `GrantRedeemed`\n| Loyalty grant redeemed\n| _Planned_\n\n| `FlybuysPointsEarned`\n| Points earned in Flybuys programme\n| _Planned_\n\n| `FlybuysBalanceUpdated`\n| Flybuys points balance changed\n| _Planned_\n\n| `PartnerAccountlinked`\n| Flybuys member linked (OAuth complete)\n| _Planned_\n\n| `PartnerAccountUnlinked`\n| Flybuys member unlinked\n| _Planned_\n\n| `DailyPointsFileGenerated`\n| Daily partner points file generated\n| _Planned_\n\n| `DailyPointsFileTransmitted`\n| Daily points file sent to partner\n| _Planned_\n\n| `DailyPointsFileAcknowledged`\n| Partner acknowledged file receipt\n| _Planned_\n|===\n\n==== Event Documentation\n\nSee xref:../specifications/AsyncAPI/otr-event-bus-v1.yaml[AsyncAPI Specification] for complete event definitions with examples, or xref:../bounded_context/loyalty.cml[Bounded Context/loyalty.cml] for CML domain model. CloudEvents 1.0 specification used for all domain events.\n\n==== Event Propagation Timeline\n\nSee detailed sequence diagrams in #event-propagation-timeline[Sequence Diagrams] for out-of-order event handling and version-based conflict resolution.\n\n[mermaid]\n----\nsequenceDiagram\n    autonumber\n    participant Mobile as Mobile App\n    participant Profile as Profile Service\n    participant EventBus as Event Bus\n    participant Loyalty as Loyalty Service\n    participant Engagement as Engagement Service\n\n    Note over Mobile,Engagement: T=0: OAuth linking completes\n\n    Mobile->>Profile: POST /partners\n    activate Profile\n    Profile->>Profile: Store PartnerLink (status: linked)\n    Profile->>Profile: Commit database transaction\n\n    Note over Profile: T+50ms: Transaction committed\n\n    Profile->>EventBus: Publish Partnerlinked event<br/>{vivaConsumerId, partner, externalMemberId}\n    activate EventBus\n    EventBus->>EventBus: Persist event (durability guarantee)\n    EventBus-->>Profile: Event ID: evt-123456\n    deactivate EventBus\n\n    Profile-->>Mobile: 201 Created {PartnerLinkId}\n    deactivate Profile\n\n    Note over EventBus: T+100ms: Event persisted\n\n    par Parallel Event Delivery\n        EventBus->>Loyalty: Deliver Partnerlinked event\n        activate Loyalty\n        Loyalty->>Loyalty: Update reward preference cache<br/>(vivaConsumerId → FLYBUYS_POINTS)\n        Loyalty-->>EventBus: ACK\n        deactivate Loyalty\n\n        Note over Loyalty: T+200ms: Cache updated\n    and\n        EventBus->>Engagement: Deliver Partnerlinked event\n        activate Engagement\n        Engagement->>Engagement: Trigger welcome campaign<br/>\"Earn Flybuys points at OTR\"\n        Engagement-->>EventBus: ACK\n        deactivate Engagement\n\n        Note over Engagement: T+500ms: Campaign triggered\n    end\n\n    Note over Mobile,Engagement: Eventual consistency achieved within 500ms\n----\n\n==== Event Flow\n\n[cols=\"2,3\"]\n|===\n| From | To\n\n| xref:../bounded_context/profile.adoc[Profile Service]\n| xref:../bounded_context/loyalty.adoc[Loyalty Service]\n\n| xref:../bounded_context/profile.adoc[Profile Service]\n| xref:../bounded_context/engagement.adoc[Engagement Service]\n\n| xref:../bounded_context/profile.adoc[Profile Service]\n| xref:../bounded_context/recommendation.adoc[Recommendation Service]\n\n| xref:../bounded_context/loyalty.adoc[Loyalty Service]\n| xref:../bounded_context/engagement.adoc[Engagement Service]\n\n| xref:../bounded_context/loyalty.adoc[Loyalty Service]\n| xref:../bounded_context/recommendation.adoc[Recommendation Service]\n|===\n\n\n<<<\n=== SBB-007: Engagement Service API\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| ABB Reference\n| Engagement Service (Bounded Context)\n\n| Component Type\n| Microservice (Event Consumer + Anti-Corruption Layer)\n\n| Implementation\n| <<key-technology-decisions,DEC-001>>\n\n| Hosting\n| <<key-technology-decisions,DEC-002>>\n\n| Database\n| <<sbb-008-engagement-service-database,SBB-008>>\n\n| Event Subscriptions\n| `profile.events.*`, `loyalty.events.*` (all Profile and Loyalty domain events)\n\n| External Integration\n| xref:../bounded_context/external/braze.adoc[Braze] (via ACL)\n|===\n\n==== Responsibilities\n\n* *Event Relay*: Relay domain events to xref:../bounded_context/external/braze.adoc[Braze] webhooks to enable transactional Customer communications\n** *Event-Driven Campaign Triggers*: Consumes domain events from Profile Service and Loyalty Service\n** *Braze Anti-Corruption Layer*: Translates OTRG domain events into xref:../bounded_context/external/braze.adoc[Braze] webhook payloads\n** *Customer Notification Orchestration*: Triggers push notifications, emails, in-app messages\n* *Campaign State Management*: Tracks campaign eligibility and notification delivery status\n\n==== Key Events Consumed\n\n[cols=\"1,2,3\"]\n|===\n| Event Source | Event Name | Campaign Trigger\n\n| Profile Service\n| `Partnerlinked`\n| Welcome campaign: \"_You're earning Flybuys points now!_\"\n\n| Profile Service\n| `RewardPreferenceChanged`\n| Confirmation: \"_Reward preference updated_\"\n\n| Loyalty Service\n| `TransactionAdjudicated`\n| Transaction confirmation: \"_You earned 150 Flybuys pts_\"\n\n| Loyalty Service\n| `PointsEarned`\n| Points milestone: \"_You've earned 1000 points this week_\"\n\n| Loyalty Service\n| `RewardTransactionFailed`\n| Error notification: \"_Transaction processing delayed_\"\n|===\n\n\n<<<\n=== SBB-008: Engagement Service Database\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| ABB Reference\n| Engagement Service Data Store\n\n| Platform\n| <<key-technology-decisions,DEC-003>>\n\n| Purpose\n| Campaign state tracking, notification delivery history\n\n| Data Residency\n| Australia East (primary), Australia Southeast (failover)\n\n| Retention\n| 90 days (notification history), indefinite (campaign state)\n|===\n\n\n<<<\n=== SBB-009: Braze Integration Adaptor\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| ABB Reference\n| Braze ACL\n\n| Component Type\n| Data Egress Anti-Corruption Layer (ACL) - Conformist pattern\n\n| Implementation\n| Referenced by xref:../bounded_context/engagement.adoc[Engagement Service]\n\n| External APIs\n| Braze REST API v3 (User Tracking API)\n\n| Webhook URL\n| `\\https://rest.iad-06.braze.com/`\n\n| Endpoint\n| xref:https://www.braze.com/docs/api/endpoints/user_data/post_user_track/[`/users/track`]\n\n| Circuit Breaker\n| 5 consecutive failures → open circuit, 30s timeout\n\n| Retry Policy\n| Exponential backoff: 3 retries (2s, 4s, 8s delays) for transient failures (5xx errors)\n\n| API Key Management\n| API key stored in Azure Key Vault\n\n| Rate Limits\n| 250 requests/minute per API key (Braze SLA)\n\n| Event Processing Latency\n| <500ms p95 (from Event Bus delivery to Braze webhook trigger)\n\n| Braze Webhook Timeout\n| 5 seconds (with retry logic)\n\n| Event Throughput\n| 1000 events/minute sustained\n|===\n\n==== Dependencies\n\n[cols=\"2,2,3\"]\n|===\n| SBB ID | Dependency | Reason\n\n| <<sbb-006-domain-event-bus,SBB-006 Domain Event Bus>>\n| Event subscriptions\n| Consumes Partnerlinked, TransactionAdjudicated events\n\n| xref:../bounded_context/profile.adoc[Profile Service]\n| Customer profile\n| Enriches event data with customer attributes (optional)\n|===\n\n\n<<<\n=== SBB-010: Flybuys Integration Adaptor\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| ABB Reference\n| Flybuys ACL\n\n| Component Type\n| Anti-Corruption Layer (ACL) - Conformist pattern (reference ADR-003 in ADD)\n\n| Implementation\n| #TBD# (referenced by xref:../bounded_context/loyalty.adoc[Loyalty Service], conforms to Flybuys API)\n\n| External APIs\n| Flybuys OAuth API, Balance API (`GET /v1/members/\\{id}/balance`), Docket API\n\n| Batch SFTP\n| #TBD# (Batch processing with SFTP connector, SSH key auth, PGP 2048-bit encryption)\n\n| Circuit Breaker\n| #TBD#\n\n| Caching\n| #TBD# (Distributed cache, 5-minute TTL for balance queries, reduces Flybuys API load)\n\n| Retry Policy\n| Exponential backoff: 3 retries (2s, 4s, 8s delays) for transient failures\n|===\n\n*Flybuys Implementation*: `FlybuysPointsServiceAdapter` (conforms to Flybuys CSV batch file spec v3.2)\n\n\n<<<\n=== SBB-011: EagleEye Integration Adaptor\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| ABB Reference\n| EagleEye ACL\n\n| Component Type\n| Anti-Corruption Layer (ACL)\n\n| Implementation\n| #TBD#(referenced by xref:../bounded_context/loyalty.adoc[Loyalty Service])\n\n| External APIs\n| EagleEye REST API v3 (wallet, campaigns, Transaction Adjudication)\n\n| Circuit Breaker\n| #TBD# (5 consecutive failures → open circuit, 30s timeout)\n\n| Retry Policy\n| Exponential backoff: 3 retries (2s, 4s, 8s delays)\n\n| API Key Management\n| API key stored in #TBD# (secure key vault service)\n\n| Rate Limits\n| 1000 requests/minute per API key (EagleEye SLA)\n|===\n\n\n<<<\n=== SBB-012: Application Monitoring\n\n[cols=\"1,3\"]\n|===\n| MAttribute | Specification\n\n| ABB Reference\n| Monitoring & Observability\n\n| Platform\n| xref:#Key_Technology_Decisions[DEC-007]\n\n| Application Insights\n| #TBD# (Workspace-based shared across xref:../bounded_context/profile.adoc[Profile Service], xref:../bounded_context/loyalty.adoc[Loyalty Service])\n\n| Instrumentation\n| #TBD# (SDK for distributed tracing, OpenTelemetry support)\n\n| Log Aggregation\n| Structured logging (Serilog) → #TBD# (centralized log aggregation with query language)\n\n| Metrics\n| Custom metrics: API latency (p50/p95/p99), OAuth success rate, batch file acknowledgement rate\n\n| Distributed Tracing\n| W3C Trace Context standard (see <<Correlation ID Propagation Specification,Correlation ID Specification>>)\n\n| Dashboards\n| #TBD# (Flybuys Integration Health, Customer Adoption Metrics dashboards)\n|===\n\n*Alerting*:\n\n* Critical: xref:../bounded_context/profile.adoc[Profile Service] API error rate > 5% → PagerDuty (on-call architect)\n* Critical: Batch file generation fails → Immediate alert to xref:../bounded_context/loyalty.adoc[Loyalty Service] team\n* Warning: Flybuys API latency > 3s p95 → Slack alert\n\n\n<<<\n=== SBB-013: API Gateway\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| ABB Reference\n| API Gateway\n\n| Platform\n| xref:#Key_Technology_Decisions[DEC-008]\n\n| Base URL\n| `\\https://api.otr.com.au`\n\n| Authentication\n| xref:#Key_Technology_Decisions[DEC-011]\n\n| Rate Limiting\n| 1000 requests/minute per user, 10000 requests/minute global\n\n| Policies\n| JWT validation, rate limiting, CORS, request/response transformation\n\n| TLS\n| xref:#Key_Technology_Decisions[DEC-019]\n|===\n\n\n<<<\n=== SBB-014: OTR Mobile App\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| ABB Reference\n| Mobile Application (Presentation Layer)\n\n| Platform\n| xref:#Key_Technology_Decisions[DEC-011]\n\n| Deployment\n| App Store (iOS), Google Play (Android)\n\n| Authentication\n| xref:#Key_Technology_Decisions[DEC-011]\n|===\n\n==== Integration\n\n[cols=\"2,3\"]\n|===\n| Integration | Description\n\n| <<SBB-001 Profile Service API,SBB-001 Profile Service API>>\n| Partner linking\n\n| <<SBB-003 Loyalty Service API,SBB-003 Loyalty Service API>>\n| Balance queries / Transaction history\n|===\n\n\n<<<\n=== SBB-015: Batch File Pipeline\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| ABB Reference\n| Batch Processing\n\n| Orchestration\n| #TBD# (Batch pipeline scheduled 01:00 UTC daily)\n\n| Generation Logic\n| #TBD# (Serverless functions for transaction aggregation)\n\n| SFTP Transfer\n| #TBD# (SFTP connector with SSH key authentication)\n\n| PGP Encryption\n| #TBD# (PGP encryption activity, Flybuys 2048-bit RSA public key)\n\n| File Format\n| CSV (UTF-8 with BOM, CRLF line endings, max 200MB / 100k transactions)\n\n| Acknowledgement\n| #TBD# (SFTP polling to read acknowledgement file from Flybuys)\n\n| Batch File Naming\n| `OTR_TRANSACTIONS_\\{YYYYMMDD}_{HHMMSS}.csv.pgp`\n|===\n\n==== Batch File Processing Flow\n\nSee detailed sequence diagrams in #batch-file-retry-flow[Sequence Diagrams] for happy path and error scenarios.\n\n[mermaid]\n----\nsequenceDiagram\n    autonumber\n    participant Scheduler as Azure Data Factory<br/>(Batch Scheduler)\n    participant Loyalty as Loyalty Service\n    participant DB as Loyalty Database\n    participant SFTP as Flybuys SFTP\n    participant Flybuys as Flybuys Processing\n    participant Monitor as Monitoring\n\n    Note over Scheduler,Monitor: Nightly batch window: 01:00-02:00 UTC\n\n    Scheduler->>Loyalty: Timer trigger: 01:00 UTC<br/>Start batch job\n\n    activate Loyalty\n    Loyalty->>DB: Query RewardTransactions<br/>WHERE status=\"PENDING\"<br/>AND transactionDate=yesterday\n    activate DB\n    DB-->>Loyalty: 10,000 transactions\n    deactivate DB\n\n    Note over Loyalty: Aggregate by externalMemberId\n\n    Loyalty->>Loyalty: Generate CSV<br/>Format: memberId,date,points,storeId\n    Loyalty->>Loyalty: PGP encrypt with Flybuys public key\n    Loyalty->>Loyalty: Generate filename<br/>OTR_TRANSACTIONS_20251212_010000.csv.pgp\n\n    Loyalty->>SFTP: Upload batch file<br/>(15 minutes, 2MB file)\n    activate SFTP\n    SFTP-->>Loyalty: Upload complete\n    deactivate SFTP\n\n    Loyalty->>DB: Update RewardTransactions<br/>SET batchFileId=\"OTR_TRANSACTIONS_20251212_010000.csv.pgp\"\n    activate DB\n    DB-->>Loyalty: 10,000 rows updated\n    deactivate DB\n\n    Loyalty-->>Scheduler: Job complete (duration: 60 min)\n    deactivate Loyalty\n\n    Scheduler->>Monitor: Log success metric<br/>batch_file_generation_duration_seconds\n\n    Note over Flybuys: Flybuys processes file (2-4 hours)\n\n    Flybuys->>SFTP: Upload acknowledgement file<br/>OTR_TRANSACTIONS_20251212_010000.ack\n\n    Note over Scheduler,Monitor: Acknowledgement polling (every 30 minutes)\n\n    Scheduler->>Loyalty: Poll for acknowledgement\n    activate Loyalty\n    Loyalty->>SFTP: Check for .ack file\n    activate SFTP\n    SFTP-->>Loyalty: Found: 9,800 accepted, 200 rejected\n    deactivate SFTP\n\n    Loyalty->>DB: Update status=\"COMPLETED\" (9,800 rows)<br/>SET status=\"FAILED\" (200 rows)\n    activate DB\n    DB-->>Loyalty: Updates complete\n    deactivate DB\n\n    Loyalty-->>Scheduler: Acknowledgement processed\n    deactivate Loyalty\n\n    Scheduler->>Monitor: Log metric<br/>batch_acknowledgement_rate=98%\n----\n\n\n<<<\n=== SBB-016: Distributed Cache\n\n*ABB Reference*: Caching Layer (for Flybuys balance queries)\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| Platform\n| #TBD# (In-memory distributed cache)\n\n| Purpose\n| Cache Flybuys balance queries (5-minute TTL, reduces external API load)\n\n| Eviction Policy\n| Volatile-ttl (evict keys with shortest TTL when memory full)\n\n| Persistence\n| Not enabled (cache can be regenerated from Flybuys API)\n\n| Cache Key Format\n| `flybuys:balance:\\{externalMemberId}` (e.g., `flybuys:balance:123456789012`)\n|===\n\n==== Circuit Breaker Pattern\n\nThe distributed cache works in conjunction with circuit breakers to provide graceful degradation when external APIs fail.\n\nSee detailed sequence diagrams in #circuit-breaker-state-transitions[Sequence Diagrams] for complete state transition flows.\n\n[mermaid]\n----\nstateDiagram-v2\n    [*] --> Closed: Initial state\n\n    Closed --> Open: 5 consecutive failures\n    Closed --> Closed: Success (reset failure count)\n\n    Open --> HalfOpen: 30 seconds elapsed\n\n    HalfOpen --> Closed: Success\n    HalfOpen --> Open: Failure\n\n    Open --> Open: All requests rejected\n\n    note right of Closed\n        Normal operation\n        Requests pass through\n        Track failure count\n    end note\n\n    note right of Open\n        Fail fast\n        Return cached response\n        No calls to external API\n    end note\n\n    note right of HalfOpen\n        Test recovery\n        Single request allowed\n        Decide: Closed or Open\n    end note\n----\n\n\n<<<\n=== SBB-017: Feature Flag Service\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| ABB Reference\n| Feature Toggle Management (see xref:../architecture_definitions/flybuys_integration.adoc#Technology%2520Capability%2520Requirements[Architecture Definition §3.2.2])\n\n| Component Type\n| Infrastructure Service\n\n| Technology Stack\n| <<key-technology-decisions,DEC-014 Configuration / Feature Flags>>\n\n| Purpose\n| Dynamic feature control without code deployment, progressive rollout, instant rollback\n\n| Flag Definitions\n| See xref:../architecture_definitions/flybuys_integration.adoc#Feature%2520Flag%2520Register[Feature Flag Register] for all flags\n\n| Deployment Schedule\n| See <<Transition Phase Matrix,Transition Phase Matrix>> for rollout by architecture state\n\n| Rollback Procedures\n| See <<Rollback Strategy,Rollback Strategy>> for flag-based rollback procedures\n|===\n\n*Operational Characteristics*:\n\n* *Evaluation Frequency*: Real-time flag evaluation on each request (no caching)\n* *Update Propagation*: Flag changes propagate within 5 seconds across all service instances\n* *Monitoring*: Flag state changes logged with correlation IDs, dashboards per flag showing usage metrics\n* *Access Control*: Flag management restricted to designated roles (Platform Team, Product Owner, Operations Team per flag)\n\n<<<\n=== SBB-018: Location\n\n<<<\n== Data Architecture\n\nThis section defines the logical and physical data models for Solution Building Blocks.\n\n=== Physical Data Models\n\n==== Profile Service - PartnerLink Document Schema\n\n===== JSON Schema\n\nSee xref:../specifications/JSON%2520Schemas/PartnerLink.schema.json[PartnerLink.schema.json] for complete schema specification including field definitions, type constraints, and validation rules.\n\n===== Database Configuration\n\n*Container*: `partner-links` +\n*Partition Key*: `/vivaConsumerId` +\n*Document Type*: JSON (NoSQL document database)\n\n===== Key Fields\n\n* `id`: Unique document identifier (GUID)\n* `PartnerLinkId`: Aggregate root identifier (GUID)\n* `vivaConsumerId`: Partition key, Salesforce VCI (e.g., vci_xyz789abc)\n* `partner`: Enum - FLYBUYS | SHELL_CARD | AFL | BUDGET_DIRECT\n* `status`: Enum - linking_IN_PROGRESS | linked | UNlinked | FAILED\n* `externalMemberId`: Partner member ID (e.g., Flybuys 12-digit number)\n* `rewardPreference`: Enum - FLYBUYS_POINTS | OTR_FUEL_DISCOUNT | SHELL_PRICE_SAVE\n* `linkedAt` / `unlinkedAt`: ISO8601 timestamps\n* `oauthTokenReference`: Key Vault secret identifier\n* `metadata`: Document metadata (createdAt, updatedAt, version)\n* `_etag`: Database concurrency token\n\n===== Example Document\n\n[source,json]\n----\n{\n  \"id\": \"pl_a1b2c3d4-e5f6-7890-abcd-ef1234567890\",\n  \"PartnerLinkId\": \"a1b2c3d4-e5f6-7890-abcd-ef1234567890\",\n  \"vivaConsumerId\": \"vci_xyz789abc\",\n  \"partner\": \"FLYBUYS\",\n  \"status\": \"linked\",\n  \"externalMemberId\": \"123456789012\",\n  \"rewardPreference\": \"FLYBUYS_POINTS\",\n  \"linkedAt\": \"2025-12-09T10:30:00Z\",\n  \"unlinkedAt\": null,\n  \"oauthTokenReference\": \"flybuys-token-vci_xyz789abc\",\n  \"metadata\": {\n    \"createdAt\": \"2025-12-09T10:30:00Z\",\n    \"updatedAt\": \"2025-12-09T10:30:00Z\",\n    \"version\": 1\n  },\n  \"_etag\": \"\\\"0x8DCDEF123456\\\"\"\n}\n----\n\n===== Indexes\n\n* Primary: `/id` (automatic)\n* Partition key: `/vivaConsumerId` (automatic)\n* Composite: `[/partner ASC, /status ASC]` (custom - query all Flybuys linked partners)\n\n===== Constraints\n\n* `vivaConsumerId`: Required, must match pattern `^vci_[a-zA-Z0-9]\\{10,}$`\n* `partner`: Required, must be valid enum value\n* `status`: Required, must be valid enum value\n* `externalMemberId`: Required if status = linked\n* `rewardPreference`: Required if status = linked\n* Uniqueness: One linked partner per (vivaConsumerId, partner) combination\n\n==== Loyalty Service - RewardTransaction Document Schema\n\n===== JSON Schema\n\nSee xref:../specifications/JSON%2520Schemas/RewardTransactionDocument.schema.json[RewardTransactionDocument.schema.json] for complete schema specification including field definitions, nested structures, type constraints, and validation rules.\n\n===== Database Configuration\n\n*Container*: `reward-transactions` +\n*Partition Key*: `/vivaConsumerId` +\n*TTL*: 2592000 seconds (30 days) +\n*Document Type*: JSON (NoSQL document database)\n\n===== Key Fields\n\n* `id`: Unique document identifier (GUID)\n* `transactionId`: Aggregate root identifier (GUID)\n* `vivaConsumerId`: Partition key\n* `externalTransactionId`: D365 Commerce transaction ID\n* `transactionDate`: ISO8601 timestamp\n* `storeId`: OTR store identifier\n* `rewardPreference`: Enum - FLYBUYS_POINTS | OTR_FUEL_DISCOUNT\n* `grants[]`: Array of reward grants (grantId, partner, grantType, amount, description)\n* `transaction`: Transaction details (totalAmount, paymentMethod)\n* `partnerPosting`: Partner posting status (Flybuys batch file details)\n* `status`: Enum - PENDING | COMPLETED | FAILED\n* `metadata`: Document metadata (createdAt, ttl)\n* `_etag`: Database concurrency token\n\n===== Example Document\n\n[source,json]\n----\n{\n  \"id\": \"rt_b2c3d4e5-f6a7-8901-bcde-f12345678901\",\n  \"transactionId\": \"b2c3d4e5-f6a7-8901-bcde-f12345678901\",\n  \"vivaConsumerId\": \"vci_xyz789abc\",\n  \"externalTransactionId\": \"D365_TXN_20251209_001234\",\n  \"transactionDate\": \"2025-12-09T14:30:00Z\",\n  \"storeId\": \"OTR001\",\n  \"rewardPreference\": \"FLYBUYS_POINTS\",\n  \"grants\": [\n    {\n      \"grantId\": \"grt_c3d4e5f6-a7b8-9012-cdef-123456789012\",\n      \"partner\": \"FLYBUYS\",\n      \"grantType\": \"POINTS\",\n      \"amount\": 150,\n      \"description\": \"Base points: 100, Bonus points: 50 (fuel purchase campaign)\"\n    }\n  ],\n  \"transaction\": {\n    \"totalAmount\": 75.50,\n    \"paymentMethod\": \"CREDIT_CARD\"\n  },\n  \"partnerPosting\": {\n    \"flybuys\": {\n      \"posted\": true,\n      \"batchFileId\": \"OTR_TRANSACTIONS_20251210_010000.csv.pgp\",\n      \"postedAt\": \"2025-12-10T01:15:00Z\",\n      \"retryCount\": 0\n    }\n  },\n  \"status\": \"COMPLETED\",\n  \"metadata\": {\n    \"createdAt\": \"2025-12-09T14:30:00Z\",\n    \"ttl\": 2592000\n  },\n  \"_etag\": \"\\\"0x8DCDEF789012\\\" - database concurrency token\"\n}\n----\n\n===== Indexes\n\n* Primary: `/id` (automatic)\n* Partition key: `/vivaConsumerId` (automatic)\n* Range: `/transactionDate DESC` (custom - query recent transactions)\n\n===== Constraints\n\n* `vivaConsumerId`: Required\n* `externalTransactionId`: Required, must be unique\n* `transactionDate`: Required, cannot be future-dated\n* `grants`: Array must contain at least one grant\n* TTL: Automatically deleted 30 days after creation (audit trail summary only)\n\n==== OAuth Token Storage Schema (Key Vault)\n\n===== JSON Schema\n\nSee xref:../specifications/JSON%2520Schemas/OAuthTokenStorageSchema.schema.json[OAuthTokenStorageSchema.schema.json] for complete schema specification including OAuth token structure, expiration rules, and metadata requirements.\n\n===== Key Vault Configuration\n\n*Service*: #TBD# (Secure key vault service) +\n*Secret Naming Convention*: `\\{partner}-token-{vivaConsumerId}`\n\n===== Secret Value (JSON) - Key Fields\n\n* `accessToken`: OAuth access token (JWT, ~2KB)\n* `refreshToken`: OAuth refresh token\n* `expiresAt`: ISO8601 timestamp (60 minutes from issuance)\n* `scope`: OAuth scopes granted (e.g., member:read member:balance)\n* `tokenType`: Bearer\n\n===== Example Secret\n\n*Name*: `flybuys-token-vci_xyz789abc`\n\n*Value*:\n\n[source,json]\n----\n{\n  \"accessToken\": \"eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...\",\n  \"refreshToken\": \"rt_abc123def456...\",\n  \"expiresAt\": \"2025-12-09T15:30:00Z\",\n  \"scope\": \"member:read member:balance member:dockets\",\n  \"tokenType\": \"Bearer\"\n}\n----\n\n===== Metadata\n\n* Content Type: `application/json`\n* Enabled: `true`\n* Activation Date: Token creation timestamp\n* Expiration Date: 90 days (refresh token expiry)\n* Tags: `{ \"partner\": \"FLYBUYS\", \"vivaConsumerId\": \"vci_xyz789abc\" }`\n\n===== Encryption\n\nAES-256 with customer-managed keys (compliance with CON-003)\n\n<<<\n== Interface Specifications\n\nThis section defines the contracts between Solution Building Blocks - REST APIs, domain events, and data formats.\n\n=== Complete API Documentation\n\nSee xref:../specifications/README.md[Specifications README] for comprehensive documentation on OpenAPI, AsyncAPI, JSON Schemas, tooling, versioning, and validation.\n\n=== REST API\n\n[cols=\"2,3,2\"]\n|===\n| Service | OpenAPI Spec | Endpoints\n\n| Profile Service\n| xref:../specifications/REST/profile-service-v1.yaml[profile-service-v1.yaml]\n| 6 endpoints (profile creation, profile retrieval, partner linking, preference management)\n\n| Loyalty Service\n| xref:../specifications/REST/loyalty-service-v1.yaml[loyalty-service-v1.yaml]\n| 5 endpoints (credential resolution, transaction adjudication, balance queries)\n|===\n\n=== Domain Events\n\n==== AsyncAPI Specification\n\nxref:../specifications/AsyncAPI/otr-event-bus-v1.yaml[otr-event-bus-v1.yaml] - Complete event bus specification with 9 domain events, CloudEvents 1.0 structure, message examples, and channel definitions.\n\n==== Event Schemas\n\nAll domain events use JSON Schema definitions in xref:../specifications/JSON%2520Schemas[JSON Schemas directory]. See <<sbb-006-domain-event-bus,SBB-006>> for event catalogue.\n\n==== API Versioning Policy\n\nAll REST APIs exposed by ProfileService and LoyaltyService follow this versioning policy to manage API evolution while maintaining backwards compatibility for consumers (Mobile Application, POS systems).\n\n===== Version Numbering\n\n*URI Versioning*: Major version included in URI path (`/api/v1/`, `/api/v2/`)\n\n*Format*: `/api/v{major}/\\{resource}`\n\n*Examples*:\n\n* `/api/v1/loyalty/credentials/resolve`\n* `/api/v2/profile/customers`\n\n*Version Components*:\n\n* *Major version* (v1, v2, v3): Breaking changes to API contract\n* *Minor version* (not in URI): Additive changes, backwards compatible\n* *Patch version* (not in URI): Bug fixes, no contract changes\n\n===== When to Version\n\n*Major Version Bump (v1 → v2)* - Breaking changes requiring new URI:\n\n[cols=\"2,3,1\"]\n|===\n| Change Type | Example | Requires v2?\n\n| Remove field from response\n| Delete `walletId` from credential resolution response\n| ✓ Yes\n\n| Rename field\n| `rewardPreference` → `preferredReward`\n| ✓ Yes\n\n| Change field type\n| `linkedAt` from string to DateTime object\n| ✓ Yes\n\n| Add required request field\n| Add required `storeType` parameter\n| ✓ Yes\n\n| Change HTTP method\n| `POST` → `PUT` for same resource\n| ✓ Yes\n\n| Change status codes\n| `404` → `422` for partner not linked\n| ✓ Yes\n\n| Remove endpoint\n| Delete `GET /api/v1/legacy-endpoint`\n| ✓ Yes\n|===\n\n*Minor Version (No URI change)* - Backwards compatible additions:\n\n[cols=\"2,3,1\"]\n|===\n| Change Type | Example | Requires v2?\n\n| Add optional request field\n| Add optional `includeBalance` query parameter\n| ✗ No\n\n| Add new response field\n| Add `partnerTier` to credential resolution response\n| ✗ No\n\n| Add new endpoint\n| Add `POST /api/v1/loyalty/batch/validate`\n| ✗ No\n\n| Add new HTTP header\n| Add `X-Request-Priority` header support\n| ✗ No\n\n| Expand enum values\n| `rewardPreference` adds `SHELL_PRICE_SAVE` option\n| ✗ No\n|===\n\n*Patch Version* - Internal only, not visible to API consumers:\n\n* Bug fixes that don't change contract\n* Performance improvements\n* Internal refactoring\n\n===== Parallel Version Support\n\n*Support Duration*: Both versions supported in parallel until deprecated version reaches sunset date\n\n*Versioning Lifecycle*:\n\n. Release new major version with breaking changes\n. Run both versions in parallel during deprecation period\n. Sunset deprecated version after migration window\n. Remove deprecated version after grace period\n\n*Infrastructure*:\n\n* Both versions deployed simultaneously (same service, route-based dispatch)\n* Shared business logic where possible (avoid duplicate implementations)\n* Feature flags: `ProfileService.API.v1.Enabled`, `ProfileService.API.v2.Enabled`\n\n===== Deprecation Notification\n\n*HTTP Headers* (included in deprecated version responses):\n\n[source,http]\n----\nHTTP/1.1 200 OK\nDeprecation: true\nSunset: <sunset-date>\nxref: </api/v2/profile/customers>; rel=\"successor-version\"\nContent-Type: application/json\n----\n\n*Header Definitions*:\n\n* `Deprecation: true` - API version is deprecated (RFC 8594)\n* `Sunset: \\{date}` - Date when API will be removed (RFC 8594)\n* `xref: \\{url}; rel=\"successor-version\"` - URL of replacement API\n\n*OpenAPI Specification*:\n\n[source,yaml]\n----\nopenapi: 3.0.0\ninfo:\n  title: Profile Service API\n  version: 1.0.0\n  x-api-deprecation:\n    deprecated: true\n    sunset: \"<sunset-date>\"\n    successorVersion: \"2.0.0\"\n    migrationGuide: \"https://docs.otr.com.au/api/migration/v1-to-v2\"\n----\n\n*Consumer Communication Sequence*:\n\n. Release notes published with breaking changes documented\n. Email notification to API consumers with migration guide\n. Deprecation headers added to deprecated version responses\n. Warning logs enabled for deprecated version usage\n. Final migration reminder before sunset\n. Sunset date reached (API returns `410 Gone`)\n. Hard removal after grace period\n\n===== Version Discovery\n\n*API Root Endpoint*: `GET /api/versions`\n\n[source,json]\n----\n{\n  \"versions\": [\n    {\n      \"version\": \"1.0\",\n      \"status\": \"deprecated\",\n      \"sunsetDate\": \"<sunset-date>\",\n      \"baseUrl\": \"/api/v1\",\n      \"documentation\": \"https://docs.otr.com.au/api/v1\"\n    },\n    {\n      \"version\": \"2.0\",\n      \"status\": \"current\",\n      \"sunsetDate\": null,\n      \"baseUrl\": \"/api/v2\",\n      \"documentation\": \"https://docs.otr.com.au/api/v2\"\n    }\n  ],\n  \"recommended\": \"2.0\"\n}\n----\n\n*Status Values*:\n\n* `current`: Recommended version, fully supported\n* `supported`: Older version, still functional, no new features\n* `deprecated`: Scheduled for removal, sunset date published\n* `sunset`: No longer accepting requests, returns `410 Gone`\n\n===== Consumer Compatibility\n\n*Mobile Application*:\n\n* iOS/Android apps pin to specific API version\n* App Store updates required for major version migrations\n* Migration coordinated with mobile app release cycles\n\n*POS Systems*:\n\n* Store rollout requires coordinated deployment\n* POS configuration updated via D365 Commerce central config\n* API version specified in POS tenant configuration\n* Gradual rollout strategy to minimize disruption\n\n*Backward Compatibility Guarantee*:\n\n* Deprecated version contract remains stable during parallel support period\n* No breaking changes to deprecated version during support window\n* Bug fixes backported to deprecated version during support period\n\n===== Error Response for Sunset APIs\n\n*After Sunset Date* (`410 Gone`):\n\n[source,json]\n----\n{\n  \"error\": {\n    \"code\": \"API_VERSION_SUNSET\",\n    \"message\": \"API v1 has been sunset. Please migrate to v2.\",\n    \"sunsetDate\": \"<sunset-date>\",\n    \"successorVersion\": \"2.0\",\n    \"migrationGuide\": \"https://docs.otr.com.au/api/migration/v1-to-v2\"\n  }\n}\n----\n\n*HTTP Status*: `410 Gone` (permanent redirect, cache-safe)\n\n===== Semantic Versioning Alignment\n\nWhile URI versioning uses major version only, OpenAPI specs follow semantic versioning:\n\n* *OpenAPI spec version*: `2.3.1` (semver)\n* *API URI version*: `/api/v2/` (major only)\n\n*Mapping*:\n\n* OpenAPI `2.0.0` → URI `/api/v2/`\n* OpenAPI `2.1.0` → URI `/api/v2/` (additive change, no URI change)\n* OpenAPI `2.1.5` → URI `/api/v2/` (bug fix, no URI change)\n* OpenAPI `3.0.0` → URI `/api/v3/` (breaking change, new URI)\n\n==== Loyalty Credential Resolution API\n\n*Endpoint*: `POST /api/v1/loyalty/credentials/resolve`\n\n*Purpose*: Resolves EAN-13 barcodes scanned at xref:../bounded_context/interfaces/otr_pos.adoc[OTR POS] and xref:../bounded_context/interfaces/otr_plus_pos.adoc[OTR+ POS] to customer identity and context for Transaction Adjudication.\n\n*Request*:\n\n[source,json]\n----\n{\n  \"barcode\": \"1234567890123\",\n  \"storeId\": \"OTR001\",\n  \"transactionId\": \"TXN_20251211_001234\"\n}\n----\n\n*Request Schema*:\n\n[cols=\"1,1,1,3\"]\n|===\n| Field | Type | Required | Validation\n\n| `barcode`\n| string\n| Yes\n| Must match pattern `^\\d\\{13}$` (EAN-13)\n\n| `storeId`\n| string\n| Yes\n| Must be registered OTR store (OTR001-OTR999)\n\n| `transactionId`\n| string\n| Yes\n| Unique transaction identifier from POS\n|===\n\n*Response* (200 OK):\n\n[source,json]\n----\n{\n  \"vivaConsumerId\": \"vci_xyz789abc\",\n  \"rewardPreference\": \"FLYBUYS_POINTS\",\n  \"walletId\": \"wallet_123456\",\n  \"linkedPartners\": [\"FLYBUYS\"],\n  \"credentialType\": \"FLYBUYS_CARD\"\n}\n----\n\n*Response Schema*:\n\n[cols=\"1,1,4\"]\n|===\n| Field | Type | Description\n\n| `vivaConsumerId`\n| string\n| Viva Consumer ID from Salesforce Contact (customer identity)\n\n| `rewardPreference`\n| string\n| Enum: `FLYBUYS_POINTS` \\| `OTR_FUEL_DISCOUNT` \\| `SHELL_PRICE_SAVE`\n\n| `walletId`\n| string\n| EagleEye wallet identifier\n\n| `linkedPartners`\n| string[]\n| List of linked partner codes (e.g., `[\"FLYBUYS\", \"SHELL\"]`)\n\n| `credentialType`\n| string\n| Enum: `OTR_MOBILE` \\| `SPS_MOBILE` \\| `WALLET_PASS` \\| `FLYBUYS_CARD` \\| `FLYBUYS_MOBILE`\n|===\n\n*Error Responses*:\n\n[cols=\"1,2,3\"]\n|===\n| Status | Error Code | Description\n\n| 400\n| `INVALID_BARCODE`\n| Barcode format invalid (not 13 digits)\n\n| 404\n| `CREDENTIAL_NOT_FOUND`\n| Barcode not recognized or customer not enrolled\n\n| 422\n| `PARTNER_NOT_linked`\n| Flybuys credential presented but not linked to OTR profile\n\n| 500\n| `RESOLUTION_FAILED`\n| Internal error during resolution\n|===\n\n*Resolution Logic*:\n\n. *OTR credentials* (OTR Mobile, SPS Mobile, Apple/Google Wallet):\n** Barcode encodes OTR member ID\n** Direct lookup: OTR member ID → VCI\n** Query xref:../bounded_context/profile.adoc[Profile Service]: `GET /api/v1/profile/customers?memberId=\\{otrMemberId}`\n. *Flybuys credentials* (Physical card, Flybuys Mobile):\n** Barcode encodes Flybuys 12-digit member number\n** Extract member number from EAN-13 barcode\n** Query xref:../bounded_context/profile.adoc[Profile Service]: `GET /api/v1/profile/partner-links?partner=FLYBUYS&externalMemberId=\\{flybuysNumber}`\n** Retrieve VCI from PartnerLink aggregate\n** If no PartnerLink found → return `422 PARTNER_NOT_linked`\n\n*Performance Requirements*:\n\n* *Latency*: p95 < 500ms (xref:../architecture_definitions/flybuys_integration.adoc#Non-Functional%2520Requirements[NFR-002])\n* *Throughput*: 500 concurrent requests/sec (peak POS load across 500+ stores)\n* *Availability*: 99.9% uptime (max 4.3 hours downtime/month)\n\n==== Customer Profile Creation API\n\n*Endpoint*: `POST /api/v1/profile/customers`\n\n*Purpose*: Creates a new customer profile, retrieves VCI from Salesforce, and provisions an EagleEye wallet. Used by the xref:../ubiquitous_language.adoc#just-in-time-integration[Just-In-Time Integration] during customer login (AS-1 Foundation).\n\n*Request*:\n\n[source,json]\n----\n{\n  \"email\": \"customer@example.com\",\n  \"firstName\": \"John\",\n  \"lastName\": \"Smith\",\n  \"phone\": \"+61412345678\",\n  \"rewardPreference\": \"OTR_FUEL_DISCOUNT\"\n}\n----\n\n*Request Schema*:\n\n[cols=\"1,1,1,3\"]\n|===\n| Field | Type | Required | Validation\n\n| `email`\n| string\n| Yes\n| Valid email format (used for Salesforce Contact upsert as external key)\n\n| `firstName`\n| string\n| No\n| Customer first name\n\n| `lastName`\n| string\n| No\n| Customer last name\n\n| `phone`\n| string\n| No\n| Customer phone number\n\n| `rewardPreference`\n| string\n| No\n| Enum: `OTR_FUEL_DISCOUNT` \\| `FLYBUYS_POINTS` \\| `SHELL_PRICE_SAVE` (defaults to `OTR_FUEL_DISCOUNT`)\n|===\n\n*Response* (201 Created):\n\n[source,json]\n----\n{\n  \"vivaConsumerId\": \"vci_xyz789abc\",\n  \"salesforceContactId\": \"003Dn000001234ABC\",\n  \"rewardPreference\": \"OTR_FUEL_DISCOUNT\",\n  \"createdAt\": \"2025-12-09T10:30:00Z\",\n  \"status\": \"ACTIVE\"\n}\n----\n\n*Response Schema*:\n\n[cols=\"1,1,4\"]\n|===\n| Field | Type | Description\n\n| `vivaConsumerId`\n| string\n| Viva Consumer ID from Salesforce Contact (customer identity)\n\n| `salesforceContactId`\n| string\n| Salesforce Contact record ID\n\n| `rewardPreference`\n| string\n| Default reward preference\n\n| `createdAt`\n| string (ISO 8601)\n| Profile creation timestamp\n\n| `status`\n| string\n| Enum: `ACTIVE` \\| `SUSPENDED` \\| `CLOSED`\n|===\n\n*Error Responses*:\n\n[cols=\"1,2,3\"]\n|===\n| Status | Error Code | Description\n\n| 409\n| `PROFILE_ALREADY_EXISTS`\n| Customer profile already exists for this email (idempotent)\n\n| 503\n| `EAGLEEYE_UNAVAILABLE`\n| EagleEye wallet creation failed\n\n| 503\n| `SALESFORCE_UNAVAILABLE`\n| Salesforce Contact upsert failed\n|===\n\n*Business Rules*:\n\n* Retrieves Viva Consumer ID (VCI) from Salesforce Contact upsert response\n* Uses email address as external key for Salesforce Contact upsert\n* Upserts Salesforce Contact record using email (creates if doesn't exist, updates if exists)\n* Publishes `CustomerProfileCreated` domain event (consumed by LoyaltyService for wallet creation)\n* Returns `409 Conflict` if profile already exists for this email (idempotent operation)\n* Transaction is atomic - if Salesforce upsert fails, entire transaction is rolled back\n* *Clean DDD*: ProfileService does NOT create EagleEye wallet (LoyaltyService owns loyalty enrollment)\n\n*Event-Driven Integration*:\n\n* *LoyaltyService* subscribes to `CustomerProfileCreated` event\n* *LoyaltyService* creates EagleEye wallet asynchronously\n* *LoyaltyService* publishes `CustomerEnrolledInLoyalty` event with walletId\n* *Mobile App* can poll `GET /api/v1/profile/customers/{vivaConsumerId}` or subscribe to enrollment completion\n\n*Performance Requirements*:\n\n* *Latency*: p95 < 300ms (Salesforce Contact upsert only - wallet creation is asynchronous)\n* *Used during login flow* - fast profile creation, loyalty enrollment completes in background\n* *Availability*: 99.9% uptime (critical for customer onboarding)\n\n*Orchestration Flow (ProfileService)*:\n\n. Check if profile already exists for this email address\n. Upsert Salesforce Contact record using email as external key (create if new, update if exists)\n. Retrieve Viva Consumer ID (VCI) from Salesforce Contact upsert response\n. Create Customer aggregate in ProfileService database (VCI, email, Salesforce link)\n. Publish `CustomerProfileCreated` domain event to Event Bus\n. Return profile details with VCI (without walletId - comes later from LoyaltyService)\n\n==== Customer Profile Retrieval API\n\n*Endpoint*: `GET /api/v1/profile/customers/{vivaConsumerId}`\n\n*Purpose*: Retrieves customer profile details by Viva Consumer ID. Used by LoyaltyService during transaction adjudication to get reward preferences and wallet information.\n\n*Request Parameters*:\n\n[cols=\"1,1,1,3\"]\n|===\n| Parameter | Type | Required | Validation\n\n| `vivaConsumerId`\n| string (path)\n| Yes\n| Must be valid VCI identifier (format: vci_*)\n|===\n\n*Response* (200 OK):\n\n[source,json]\n----\n{\n  \"vivaConsumerId\": \"vci_xyz789abc\",\n  \"salesforceContactId\": \"003Dn000001234ABC\",\n  \"walletId\": \"wallet_123456\",\n  \"rewardPreference\": \"FLYBUYS_POINTS\",\n  \"createdAt\": \"2025-12-09T10:30:00Z\",\n  \"status\": \"ACTIVE\"\n}\n----\n\n*Response Schema*:\n\n[cols=\"1,1,4\"]\n|===\n| Field | Type | Description\n\n| `vivaConsumerId`\n| string\n| Viva Consumer ID from Salesforce Contact (customer identity)\n\n| `salesforceContactId`\n| string\n| Salesforce Contact record ID\n\n| `walletId`\n| string\n| EagleEye wallet identifier\n\n| `rewardPreference`\n| string\n| Customer's current reward preference\n\n| `createdAt`\n| string (ISO 8601)\n| Profile creation timestamp\n\n| `status`\n| string\n| Enum: `ACTIVE` \\| `SUSPENDED` \\| `CLOSED`\n|===\n\n*Error Responses*:\n\n[cols=\"1,2,3\"]\n|===\n| Status | Error Code | Description\n\n| 401\n| `UNAUTHORIZED`\n| Authentication failed\n\n| 404\n| `CUSTOMER_NOT_FOUND`\n| Customer profile does not exist for this VCI\n|===\n\n*Performance Requirements*:\n\n* *Latency*: p95 < 200ms\n* *Availability*: 99.9% uptime\n* *Cache Strategy*: Response can be cached for 5 minutes\n\n*Usage Examples*:\n\n* Transaction adjudication: `GET /api/v1/profile/customers/{vivaConsumerId}/reward-preference`\n* Customer lookup: `GET /api/v1/profile/customers?memberId={otrMemberId}`\n* Profile details retrieval: `GET /api/v1/profile/customers/{vivaConsumerId}`\n\n=== Domain Events\n\n*AsyncAPI Specification*: `Specifications/AsyncAPI/otr-event-bus-v1.yaml`\n\n*Event Standard*: CloudEvents 1.0 (https://cloudevents.io/)\n\n*Architecture Pattern*: Open Host Service + Published Language\n\nAll domain events follow the CloudEvents 1.0 specification and are defined with JSON Schema validation. Event schemas are maintained as separate JSON Schema files to ensure consistency and enable tooling integration (validation, code generation, documentation).\n\n==== Event Catalogue\n\n[cols=\"1,1,1,1,3\"]\n|===\n| Event | Channel | Source | JSON Schema | Description\n\n| `Partnerlinked`\n| `profile.events`\n| `/profile-service`\n| xref:../specifications/JSON%2520Schemas/Partnerlinked.event.schema.json[Partnerlinked.event.schema.json]\n| Customer successfully linked coalition partner account (Flybuys, Shell Card)\n\n| `PartnerUnlinked`\n| `profile.events`\n| `/profile-service`\n| xref:../specifications/JSON%2520Schemas/PartnerUnlinked.event.schema.json[PartnerUnlinked.event.schema.json]\n| Customer unlinked coalition partner account\n\n| `PartnerLinkFailed`\n| `profile.events`\n| `/profile-service`\n| xref:../specifications/JSON%2520Schemas/PartnerLinkFailed.event.schema.json[PartnerLinkFailed.event.schema.json]\n| Partner linking attempt failed (OAuth error, invalid credentials)\n\n| `RewardPreferenceChanged`\n| `profile.events`\n| `/profile-service`\n| xref:../specifications/JSON%2520Schemas/RewardPreferenceChanged.event.schema.json[RewardPreferenceChanged.event.schema.json]\n| Customer changed reward preference (Flybuys points ↔ OTR fuel discount)\n\n| `CustomerProfileCreated`\n| `profile.events`\n| `/profile-service`\n| xref:../specifications/JSON%2520Schemas/CustomerProfileCreated.event.schema.json[CustomerProfileCreated.event.schema.json]\n| Customer profile created during Just-In-Time Integration (VCI from Salesforce). Triggers loyalty enrollment.\n\n| `CustomerEnrolledInLoyalty`\n| `loyalty.events`\n| `/loyalty-service`\n| xref:../specifications/JSON%2520Schemas/CustomerEnrolledInLoyalty.event.schema.json[CustomerEnrolledInLoyalty.event.schema.json]\n| Customer enrolled in loyalty program (EagleEye wallet created). Published in response to CustomerProfileCreated.\n\n| `TransactionAdjudicated`\n| `loyalty.events`\n| `/loyalty-service`\n| xref:../specifications/JSON%2520Schemas/TransactionAdjudicated.event.schema.json[TransactionAdjudicated.event.schema.json]\n| Transaction adjudicated, rewards calculated and granted\n\n| `PointsEarned`\n| `loyalty.events`\n| `/loyalty-service`\n| xref:../specifications/JSON%2520Schemas/PointsEarned.event.schema.json[PointsEarned.event.schema.json]\n| Customer earned Flybuys points on transaction\n\n| `FuelDiscountApplied`\n| `loyalty.events`\n| `/loyalty-service`\n| xref:../specifications/JSON%2520Schemas/FuelDiscountApplied.event.schema.json[FuelDiscountApplied.event.schema.json]\n| Customer received OTR fuel discount on transaction\n\n| `RewardTransactionFailed`\n| `loyalty.events`\n| `/loyalty-service`\n| xref:../specifications/JSON%2520Schemas/RewardTransactionFailed.event.schema.json[RewardTransactionFailed.event.schema.json]\n| Transaction adjudication failed (system error, API timeout)\n|===\n\n==== Event Consumers\n\n[cols=\"1,2,3\"]\n|===\n| Bounded Context | Subscribed Events | Responsibility\n\n| *Loyalty Service*\n| `Partnerlinked`, `RewardPreferenceChanged`\n| Updates adjudication rules based on partner linking and preference changes\n\n| *Engagement Service*\n| `Partnerlinked`, `PartnerLinkFailed`, `RewardPreferenceChanged`, `CustomerProfileCreated`, `TransactionAdjudicated`, `PointsEarned`, `FuelDiscountApplied`\n| Sends customer notifications (linking confirmation, points earned, welcome messages)\n\n| *Recommendation Service*\n| `Partnerlinked`, `RewardPreferenceChanged`, `CustomerProfileCreated`\n| Updates personalization engine based on customer loyalty profile changes\n\n| *Analytics Service*\n| `TransactionAdjudicated`, `PointsEarned`, `FuelDiscountApplied`\n| Tracks reward transactions for business intelligence and reporting\n|===\n\n==== Event Delivery Guarantees\n\n*Delivery Semantics*: At-least-once delivery (Event Bus guarantees)\n\n*Retry Policy*:\n\n* Initial retry: Immediate\n* Subsequent retries: Exponential backoff (2s, 4s, 8s, 16s, 32s)\n* Maximum retries: 5 attempts\n* Dead Letter Queue: After 5 failed attempts, events routed to DLQ for manual investigation\n\n*Idempotency*: All event consumers must implement idempotent processing (use `id` field for deduplication)\n\n*Ordering*: Events within the same `vivaConsumerId` partition maintain order; cross-partition ordering not guaranteed\n\n=== Correlation ID Propagation Specification\n\nAll service-to-service communication and domain events must propagate correlation IDs to enable distributed tracing and request correlation across the Flybuys Integration architecture.\n\n==== Standard\n\n*W3C Trace Context* (https://www.w3.org/TR/trace-context/)\n\n==== HTTP Propagation\n\n*Headers*:\n\n* `traceparent`: Required trace context (format: `\\{version}-{trace-id}-{parent-id}-{trace-flags}`)\n* `tracestate`: Optional vendor-specific trace data\n\n*Generation Point*: API Gateway (or Mobile Application if request originates outside API Gateway)\n\n*Example*:\n\n[source,http]\n----\nPOST /api/v1/loyalty/credentials/resolve HTTP/1.1\nHost: api.otr.com.au\ntraceparent: 00-4bf92f3577b34da6a3ce929d0e0e4736-00f067aa0ba902b7-01\ntracestate: otr=t61rcWkgMzE\nContent-Type: application/json\n----\n\n*Trace ID Format*:\n\n* `version`: `00` (current W3C version)\n* `trace-id`: 32 hex characters (128-bit globally unique identifier)\n* `parent-id`: 16 hex characters (64-bit span identifier)\n* `trace-flags`: 2 hex characters (sampling decision: `01` = sampled, `00` = not sampled)\n\n*Propagation Rules*:\n\n. *API Gateway → Service*: Generate `traceparent` if not present, forward if present\n. *Service → Service*: Preserve `trace-id`, generate new `parent-id` for span\n. *Service → External API*: Propagate `traceparent` header (Flybuys, EagleEye, Salesforce)\n\n==== Event Propagation\n\n*CloudEvents Extension*: All domain events MUST include `traceparent` as CloudEvents extension attribute\n\n*Example*:\n\n[source,json]\n----\n{\n  \"specversion\": \"1.0\",\n  \"type\": \"com.otr.profile.Partnerlinked\",\n  \"source\": \"/profile-service\",\n  \"id\": \"a1b2c3d4-e5f6-7890-abcd-ef1234567890\",\n  \"time\": \"2025-12-09T14:30:00Z\",\n  \"traceparent\": \"00-4bf92f3577b34da6a3ce929d0e0e4736-00f067aa0ba902b7-01\",\n  \"datacontenttype\": \"application/json\",\n  \"data\": {\n    \"vivaConsumerId\": \"vci_xyz789abc\",\n    \"partner\": \"FLYBUYS\"\n  }\n}\n----\n\n*Event Consumer Propagation*: Consumers MUST extract `traceparent` from event and propagate to downstream calls\n\n*Example Flow*:\n\n. POS calls `POST /api/v1/loyalty/credentials/resolve` with `traceparent: 00-\\{trace-id}-{span-1}-01`\n. LoyaltyService calls ProfileService `GET /api/v1/profile/partner-links` with `traceparent: 00-\\{trace-id}-{span-2}-01`\n. ProfileService publishes `Partnerlinked` event with `traceparent: 00-\\{trace-id}-{span-3}-01`\n. All requests share same `trace-id` (`4bf92f3577b34da6a3ce929d0e0e4736`)\n\n==== Structured Logging\n\nAll log entries MUST include correlation context:\n\n*Log Format* (JSON structured logging via Serilog):\n\n[source,json]\n----\n{\n  \"timestamp\": \"2025-12-09T14:30:00.123Z\",\n  \"level\": \"Information\",\n  \"message\": \"Credential resolution completed\",\n  \"traceId\": \"4bf92f3577b34da6a3ce929d0e0e4736\",\n  \"spanId\": \"00f067aa0ba902b7\",\n  \"service\": \"loyalty-service\",\n  \"vivaConsumerId\": \"vci_xyz789abc\",\n  \"operation\": \"ResolveCredential\"\n}\n----\n\n*Required Fields*:\n\n* `traceId`: W3C trace-id (32 hex characters)\n* `spanId`: W3C parent-id (16 hex characters)\n* `service`: Service name (profile-service, loyalty-service, etc.)\n\n*Query Example*: Find all logs for a specific request\n\n----\ntraceId = \"4bf92f3577b34da6a3ce929d0e0e4736\"\n----\n\n==== Trace Visualization\n\n*Tool*: <<SBB-009 Application Monitoring,Application Monitoring>> platform (DEC-007) must support W3C Trace Context\n\n*Expected Trace View*:\n\n----\nPOS Transaction (trace-id: 4bf92f3577b34da6a3ce929d0e0e4736)\n├─ API Gateway [50ms]\n├─ LoyaltyService.ResolveCredential [280ms]\n│  ├─ ProfileService.GetPartnerLink [120ms]\n│  │  └─ Cosmos DB Query [80ms]\n│  └─ Redis Cache Lookup [15ms]\n└─ API Gateway Response [20ms]\nTotal: 350ms\n----\n\n==== Implementation Notes\n\n*Libraries*:\n\n* .NET: `System.Diagnostics.Activity` (built-in W3C Trace Context support)\n* OpenTelemetry SDK: Auto-instrumentation for HTTP and event propagation\n\n*Sampling Strategy*:\n\n* Production: 10% sampling (`trace-flags: 01` for 1 in 10 requests)\n* UAT: 100% sampling (all requests traced)\n* Error traces: Always sampled (override sampling decision on errors)\n\n*Privacy*: `traceparent` contains no PII - safe to log and transmit\n\n=== Data Formats\n\n==== Flybuys Batch File Format (CSV)\n\nFlybuys Transaction File Format v3.2 (January 2025) - external specification\n\n===== Format\n\n[source,csv]\n----\nMEMBER_ID,TRANSACTION_DATE,TRANSACTION_TIME,STORE_CODE,TRANSACTION_ID,BASE_POINTS,BONUS_POINTS,TOTAL_AMOUNT,FUEL_LITRES\n123456789012,2025-12-09,14:30:00,OTR001,TXN123456,100,50,75.50,45.2\n123456789012,2025-12-09,15:45:00,OTR002,TXN123457,200,0,120.00,0\n----\n\n===== Field Specifications\n\n[cols=\"1,1,1,1,3\"]\n|===\n| Field | Type | Length | Format | Validation\n\n| MEMBER_ID\n| String\n| 12\n| Numeric\n| Must match Flybuys member pattern (12 digits)\n\n| TRANSACTION_DATE\n| Date\n| 10\n| YYYY-MM-DD\n| Not future-dated\n\n| TRANSACTION_TIME\n| Time\n| 8\n| HH:MM:SS\n| 24-hour format\n\n| STORE_CODE\n| String\n| 10\n| Alphanumeric\n| Must be registered OTR store (OTR001-OTR999)\n\n| TRANSACTION_ID\n| String\n| 50\n| Alphanumeric\n| Unique per file (D365 Commerce transaction ID)\n\n| BASE_POINTS\n| Integer\n| 10\n| Numeric\n| Non-negative\n\n| BONUS_POINTS\n| Integer\n| 10\n| Numeric\n| Non-negative\n\n| TOTAL_AMOUNT\n| Decimal\n| 10,2\n| 99999999.99\n| Non-negative (AUD)\n\n| FUEL_LITRES\n| Decimal\n| 10,2\n| 99999999.99\n| Optional (0 for non-fuel transactions)\n|===\n\n===== File Requirements\n\n* Encoding: UTF-8 with BOM\n* Line ending: CRLF (`\\r\\n`)\n* Header row: Required (field names as shown above)\n* Max file size: 200MB (approx. 100,000 transactions)\n* Submission deadline: 02:00 UTC daily (Flybuys SLA)\n\n===== PGP Encryption Specifications\n\n* Algorithm: RSA 2048-bit + AES-256\n* Flybuys public key ID: `0xABCD1234` (expires 2026-12-31)\n* Compression: ZIP (level 6)\n* ASCII armor: Yes (`.pgp` extension)\n\n=== Interaction Flows\n\nThis section provides sequence diagrams for critical multi-service interactions across the Flybuys Integration architecture.\n\n==== OAuth linking Flow (AS-2 linking)\n\nCustomer links their Flybuys account via OAuth 2.0 Authorization Code Flow with PKCE from the Mobile Application.\n\n[mermaid]\n----\nsequenceDiagram\n    actor Customer\n    participant Mobile as Mobile App\n    participant Gateway as API Gateway\n    participant Profile as ProfileService\n    participant OAuth as OAuth Service\n    participant Flybuys as Flybuys OAuth\n    participant EventBus as Event Bus\n    participant Loyalty as LoyaltyService\n\n    Customer->>Mobile: Tap \"link Flybuys Account\"\n    Mobile->>Mobile: Generate PKCE code_verifier & code_challenge\n    Mobile->>Gateway: GET /api/v1/profile/oauth/authorize?partner=FLYBUYS\n    Gateway->>Profile: Forward request\n    Profile->>OAuth: InitiateOAuthFlow(partner=FLYBUYS, code_challenge)\n    OAuth->>OAuth: Store code_challenge + state\n    OAuth-->>Profile: OAuth URL + state\n    Profile-->>Gateway: Redirect URL\n    Gateway-->>Mobile: 302 Redirect to Flybuys OAuth\n\n    Mobile->>Flybuys: OAuth Authorization Request\n    Flybuys->>Customer: Login & Consent Screen\n    Customer->>Flybuys: Approve consent\n    Flybuys-->>Mobile: 302 Redirect with auth_code\n\n    Mobile->>Gateway: POST /api/v1/profile/oauth/callback<br/>(auth_code, code_verifier)\n    Gateway->>Profile: Forward callback\n    Profile->>OAuth: ValidateCallback(auth_code, code_verifier)\n    OAuth->>OAuth: Verify code_challenge == hash(code_verifier)\n    OAuth->>Flybuys: POST /oauth/token<br/>(auth_code, code_verifier)\n    Flybuys-->>OAuth: access_token + refresh_token\n    OAuth->>OAuth: Encrypt tokens (AES-256)\n    OAuth->>OAuth: Store in Key Vault\n    OAuth-->>Profile: Token reference + member_id\n\n    Profile->>Profile: Create PartnerLink aggregate<br/>(vivaConsumerId, partner=FLYBUYS, externalMemberId)\n    Profile->>Profile: Set rewardPreference = FLYBUYS_POINTS\n    Profile->>EventBus: Publish Partnerlinked event\n    Profile-->>Gateway: 200 OK (linking success)\n    Gateway-->>Mobile: linking confirmation\n    Mobile->>Customer: \"Flybuys account linked!\"\n\n    EventBus->>Loyalty: Consume Partnerlinked event\n    Loyalty->>Loyalty: Update adjudication rules for customer\n\n    Note over Customer,Loyalty: Error Scenarios\n\n    alt OAuth Authorization Denied\n        Customer->>Flybuys: Deny consent\n        Flybuys-->>Mobile: 302 Redirect with error=access_denied\n        Mobile->>Gateway: POST /api/v1/profile/oauth/callback?error=access_denied\n        Gateway->>Profile: Forward error\n        Profile-->>Gateway: 400 Bad Request (user cancelled)\n        Gateway-->>Mobile: linking cancelled\n        Mobile->>Customer: \"linking cancelled\"\n    end\n\n    alt Flybuys API Failure\n        OAuth->>Flybuys: POST /oauth/token\n        Flybuys-->>OAuth: 500 Internal Server Error\n        OAuth-->>Profile: OAuth token exchange failed\n        Profile-->>Gateway: 502 Bad Gateway\n        Gateway-->>Mobile: Partner temporarily unavailable\n        Mobile->>Customer: \"Flybuys unavailable, try again later\"\n    end\n----\n\n*Key Points*:\n\n* *PKCE*: Code verifier/challenge prevents authorization code interception\n* *Token Storage*: OAuth tokens encrypted in Key Vault, ProfileService stores only reference\n* *Event Publishing*: Partnerlinked event triggers LoyaltyService adjudication rule updates\n* *Error Handling*: User cancellation vs. API failure handled differently\n\n==== Just-In-Time Profile Creation Flow (AS-1 Foundation)\n\nThis flow shows how customer profiles are created on-demand during first login using the xref:../ubiquitous_language.adoc#just-in-time-integration[Just-In-Time Integration] pattern. ProfileService creates the profile and publishes an event. LoyaltyService subscribes to this event and provisions the EagleEye wallet asynchronously (clean DDD bounded context separation).\n\n[mermaid]\n----\nsequenceDiagram\n    actor Customer\n    participant Mobile as Mobile App\n    participant Gateway as API Gateway\n    participant Profile as ProfileService\n    participant ProfileDB as Profile DB\n    participant Salesforce as Salesforce\n    participant EventBus as Event Bus\n    participant Loyalty as LoyaltyService\n    participant EagleEye as EagleEye ACL\n\n    Customer->>Mobile: Login (first time)\n    Mobile->>Gateway: Authenticate with CIAM\n    Gateway-->>Mobile: JWT token (contains email, name, etc.)\n\n    Note over Mobile: Check if profile exists\n\n    Mobile->>Gateway: POST /api/v1/profile/customers<br/>{email, firstName, lastName, phone, preference}\n    Gateway->>Profile: Forward request\n    activate Profile\n\n    Profile->>ProfileDB: Check if profile exists for email\n    ProfileDB-->>Profile: Not found\n\n    Profile->>Salesforce: UPSERT Contact using email as key<br/>{email, firstName, lastName, phone}\n    Salesforce-->>Profile: Contact upserted (contactId, vivaConsumerId)\n\n    Profile->>ProfileDB: Create Customer aggregate<br/>(VCI, email, Salesforce link)\n    ProfileDB-->>Profile: Customer created\n\n    Profile->>EventBus: Publish CustomerProfileCreated event<br/>{vivaConsumerId, salesforceContactId, email, preference}\n    EventBus-->>Profile: Event published\n\n    Profile-->>Gateway: 201 Created<br/>{vivaConsumerId, salesforceContactId, status}\n    deactivate Profile\n    Gateway-->>Mobile: Profile created successfully\n\n    Note over EventBus,Loyalty: Asynchronous Enrollment (Clean DDD)\n\n    EventBus->>Loyalty: CustomerProfileCreated event\n    activate Loyalty\n\n    Loyalty->>EagleEye: POST /wallets<br/>{vivaConsumerId}\n    EagleEye-->>Loyalty: {walletId}\n\n    Loyalty->>EventBus: Publish CustomerEnrolledInLoyalty event<br/>{vivaConsumerId, walletId}\n    EventBus-->>Loyalty: Event published\n    deactivate Loyalty\n\n    Note over Mobile,Customer: Optional: Mobile polls or subscribes for enrollment\n\n    Mobile->>Customer: Login complete - loyalty enrollment in progress\n\n    Note over Customer,EagleEye: Error Scenarios\n\n    alt Profile Already Exists for Email\n        Profile->>ProfileDB: Check if profile exists for email\n        ProfileDB-->>Profile: Profile found\n        Profile-->>Gateway: 409 Conflict (profile already exists)\n        Gateway-->>Mobile: Profile exists - use existing\n        Mobile->>Mobile: Proceed with existing profile\n    end\n\n    alt Salesforce Upsert Failed\n        Profile->>Salesforce: UPSERT Contact\n        Salesforce-->>Profile: 500 Internal Server Error\n        Profile->>Profile: Rollback transaction\n        Profile-->>Gateway: 503 Salesforce unavailable\n        Gateway-->>Mobile: Contact upsert failed\n        Mobile->>Customer: \"Unable to create profile, try again\"\n    end\n\n    alt EagleEye Wallet Creation Failed (Handled by LoyaltyService)\n        Loyalty->>EagleEye: POST /wallets\n        EagleEye-->>Loyalty: 500 Internal Server Error\n        Loyalty->>Loyalty: Retry with exponential backoff\n        Note over Loyalty: Profile exists, wallet creation will retry\n    end\n----\n\n*Key Points*:\n\n* *Just-In-Time Integration*: Profile created on first login, not during registration\n* *Clean DDD Separation*: ProfileService owns identity, LoyaltyService owns loyalty enrollment (wallet creation)\n* *Event-Driven Architecture*: `CustomerProfileCreated` event triggers asynchronous wallet creation by LoyaltyService\n* *Salesforce Upsert*: Creates Salesforce Contact if it doesn't exist, updates if it does (idempotent)\n* *ProfileService Transaction*: Profile creation and Salesforce upsert are atomic (wallet creation is decoupled)\n* *Idempotent Operation*: Returns `409 Conflict` if profile already exists (safe to retry)\n* *Eventual Consistency*: Wallet creation happens asynchronously - mobile app can poll or subscribe for completion\n* *Resilience*: LoyaltyService handles EagleEye failures independently with retry logic (doesn't block profile creation)\n* *Performance Target*: ProfileService p95 < 300ms (faster - no EagleEye dependency)\n\n==== POS Integration Flow (AS-3 Grants)\n\nxref:../bounded_context/interfaces/otr_pos.adoc[OTR POS] scans Loyalty Credential barcode to resolve customer identity before transaction.\n\n[mermaid]\n----\nsequenceDiagram\n    actor Customer\n    participant POS as D365 Commerce POS\n    participant POSACL as POS ACL Adapter<br/>(D365 → Loyalty Domain)\n    participant LoyaltyACL as Loyalty ACL Adapter\n    participant Profile as ProfileService\n    participant ProfileDB as Profile DB\n\n    Customer->>POS: Present barcode\n    POS->>POS: Scan barcode (D365 format)\n\n    Note over POS,ProfileDB: D365 → Loyalty Domain Translation\n\n    POS->>POSACL: GetLoyaltyCardData(barcode, storeId)\n    POSACL->>POSACL: Translate D365 concepts:<br/>LoyaltyCard → VivaConsumerId<br/>StoreCode → siteId<br/>TransactionId → sourceTransactionId\n    POSACL->>Loyalty: POST /api/v1/loyalty/credentials/resolve<br/>{barcode, siteId, sourceTransactionId}\n\n    alt OTR Credential (direct resolution)\n        Loyalty->>Loyalty: Parse OTR member ID from barcode\n        Loyalty->>Profile: GET /customers?memberId={otrMemberId}\n        Profile->>ProfileDB: Query by memberId\n        ProfileDB-->>Profile: Customer (VCI, rewardPreference)\n        Profile-->>Loyalty: Customer context\n    else Flybuys Credential (indirect via PartnerLink)\n        Loyalty->>Loyalty: Parse Flybuys member# from barcode\n        Loyalty->>Profile: GET /partner-links?partner=FLYBUYS&externalMemberId={flybuysNumber}\n        Profile->>ProfileDB: Query PartnerLink aggregate\n        ProfileDB-->>Profile: PartnerLink (VCI, rewardPreference)\n        Profile-->>Loyalty: Customer context\n    end\n\n    Loyalty-->>LoyaltyACL: 200 OK {vivaConsumerId, rewardPreference, walletId}\n\n    Note over POSACL,ProfileDB: Loyalty Domain → D365 Translation\n\n    LoyaltyACL->>LoyaltyACL: Translate Loyalty domain:<br/>vivaConsumerId → LoyaltyCardNumber<br/>rewardPreference → LoyaltyProgramId<br/>walletId → AccountId\n    LoyaltyACL-->>POSACL: LoyaltyResponse {CardNumber, ProgramId, AccountId}\n    POSACL-->>POS: D365 LoyaltyCardData object\n    POS->>Customer: Display: \"Welcome back, Sarah!\"\n\n    Note over Customer,ProfileDB: Error Scenarios\n\n    alt ProfileService Unavailable\n        Loyalty->>Profile: GET /customers (timeout)\n        Profile-->>Loyalty: 503 Service Unavailable\n        Loyalty-->>LoyaltyACL: 503 Service Unavailable\n        LoyaltyACL->>LoyaltyACL: Map to D365 error:<br/>503 → LoyaltyErrorCode.ServiceTemporarilyUnavailable\n        LoyaltyACL-->>POSACL: LoyaltyResponse {ErrorCode, Message}\n        POSACL-->>POS: D365 error object\n        POS->>Customer: \"Loyalty temporarily unavailable, proceed without points\"\n    end\n\n    alt Invalid Barcode Format\n        Loyalty->>Loyalty: Parse barcode (validation fails)\n        Loyalty-->>LoyaltyACL: 400 Bad Request (invalid barcode format)\n        LoyaltyACL->>LoyaltyACL: Map to D365 error:<br/>400 → LoyaltyErrorCode.InvalidCardNumber\n        LoyaltyACL-->>POSACL: LoyaltyResponse {ErrorCode}\n        POSACL-->>POS: D365 error object\n        POS->>Customer: \"Barcode not recognized\"\n    end\n\n    alt Credential Not Found\n        Loyalty->>Profile: GET /partner-links (no match)\n        Profile-->>Loyalty: 404 Not Found\n        Loyalty-->>LoyaltyACL: 404 Not Found (credential not linked)\n        LoyaltyACL->>LoyaltyACL: Map to D365 error:<br/>404 → LoyaltyErrorCode.CardNotFound\n        LoyaltyACL-->>POSACL: LoyaltyResponse {ErrorCode}\n        POSACL-->>POS: D365 error object\n        POS->>Customer: \"Card not registered, visit counter\"\n    end\n\n    alt Partner Not linked\n        Loyalty->>Profile: GET /partner-links?partner=FLYBUYS\n        Profile-->>Loyalty: 200 OK {linked: false}\n        Loyalty-->>LoyaltyACL: 200 OK {requireslinking: true}\n        LoyaltyACL->>LoyaltyACL: Map to D365 business rule:<br/>requireslinking → Prompt for enrollment\n        LoyaltyACL-->>POSACL: LoyaltyResponse {RequiresEnrollment}\n        POSACL-->>POS: D365 enrollment prompt\n        POS->>Customer: \"link Flybuys in app for points\"\n    end\n----\n\n*Key Points*:\n\n* *Bidirectional ACL*: POS ACL Adapter translates D365 Commerce → Loyalty domain; Loyalty ACL Adapter translates Loyalty domain → D365 Commerce\n* *Two Credential Types*: OTR (direct via memberId) vs Flybuys (indirect via PartnerLink aggregate)\n* *Domain Isolation*: D365 POS never sees Loyalty domain concepts (VivaConsumerId, PartnerLink, RewardPreference)\n* *Error Mapping*: Loyalty HTTP status codes and error types mapped to D365 LoyaltyErrorCode enum\n\n==== POS Transaction Adjudication Flow (AS-3 Grants)\n\nCustomer presents Loyalty Credential at POS for transaction adjudication and reward determination.\n\n[mermaid]\n----\nsequenceDiagram\n    actor Customer\n    participant POS as OTR POS\n    participant Gateway as API Gateway\n    participant Loyalty as LoyaltyService\n    participant Profile as ProfileService\n    participant ProfileDB as Profile DB\n    participant EagleEye as EagleEye ACL\n    participant EagleEyeAPI as EagleEye API\n    participant EventBus as Event Bus\n\n    Customer->>POS: Present barcode (EAN-13)\n    POS->>POS: Scan barcode: \"1234567890123\"\n\n    Note over POS,Gateway: Credential Resolution Phase\n    POS->>Gateway: POST /api/v1/loyalty/credentials/resolve<br/>{barcode, storeId, transactionId}<br/>traceparent: 00-{trace-id}-{span-1}-01\n    Gateway->>Loyalty: Forward (add correlation ID)\n    Loyalty->>Loyalty: Parse EAN-13 barcode\n\n    alt OTR Credential (barcode encodes OTR member ID)\n        Loyalty->>Profile: GET /api/v1/profile/customers?memberId={otrMemberId}\n        Profile->>ProfileDB: Query by memberId\n        ProfileDB-->>Profile: Customer record (VCI, rewardPreference)\n        Profile-->>Loyalty: Customer context\n    else Flybuys Credential (barcode encodes Flybuys member number)\n        Loyalty->>Loyalty: Extract Flybuys member# from barcode\n        Loyalty->>Profile: GET /api/v1/profile/partner-links?<br/>partner=FLYBUYS&externalMemberId={flybuysNumber}\n        Profile->>ProfileDB: Query PartnerLink aggregate\n        ProfileDB-->>Profile: PartnerLink (VCI, rewardPreference)\n        Profile-->>Loyalty: Customer context\n    end\n\n    Loyalty-->>Gateway: 200 OK {vivaConsumerId, rewardPreference, walletId}\n    Gateway-->>POS: Credential resolved (280ms p95)\n    POS->>Customer: Display name: \"Welcome back, Sarah!\"\n\n    Note over Customer,EventBus: Transaction Adjudication Phase\n    Customer->>POS: Complete purchase ($75.50)\n    POS->>Gateway: POST /api/v1/loyalty/transactions/adjudicate<br/>{vivaConsumerId, transactionId, items[], total}\n    Gateway->>Loyalty: Forward request\n\n    Loyalty->>Profile: GET /api/v1/profile/customers/{vivaConsumerId}/reward-preference\n    Profile-->>Loyalty: rewardPreference = FLYBUYS_POINTS\n\n    alt Reward Preference = FLYBUYS_POINTS\n        Loyalty->>EagleEye: POST /transactions/validate<br/>(transaction details, walletId)\n        EagleEye->>EagleEyeAPI: Forward to EagleEye AIR\n        EagleEyeAPI-->>EagleEye: Provisional rewards (150 points)\n        EagleEye-->>Loyalty: Validation response\n        Loyalty->>Loyalty: Create RewardTransaction aggregate<br/>(vivaConsumerId, flybuysPoints=150, status=PENDING)\n        Loyalty-->>Gateway: 200 OK {provisionalRewards: 150 points}\n        Gateway-->>POS: Adjudication complete\n        POS->>Customer: \"You'll earn 150 Flybuys points\"\n    else Reward Preference = OTR_FUEL_DISCOUNT\n        Loyalty->>EagleEye: POST /transactions/validate<br/>(fuel discount campaign)\n        EagleEye->>EagleEyeAPI: Check fuel discount grants\n        EagleEyeAPI-->>EagleEye: 8c/L discount available\n        EagleEye-->>Loyalty: Validation response\n        Loyalty-->>Gateway: 200 OK {fuelDiscount: 8cpl}\n        Gateway-->>POS: Adjudication complete\n        POS->>Customer: \"8c/L fuel discount applied\"\n    end\n\n    Note over POS,EventBus: Post-Payment Finalization\n    POS->>POS: Payment captured\n    POS->>Gateway: POST /api/v1/loyalty/transactions/{txnId}/redeem\n    Gateway->>Loyalty: Finalize transaction\n    Loyalty->>EagleEye: POST /transactions/redeem<br/>(confirm rewards)\n    EagleEye->>EagleEyeAPI: Finalize in EagleEye\n    EagleEyeAPI-->>EagleEye: Confirmed\n    EagleEye-->>Loyalty: Redemption complete\n\n    Loyalty->>Loyalty: Update RewardTransaction<br/>(status=CONFIRMED, finalPoints=150)\n    Loyalty->>EventBus: Publish TransactionAdjudicated event\n    Loyalty-->>Gateway: 200 OK\n    Gateway-->>POS: Transaction finalized\n\n    Note over Customer,EventBus: Error Scenarios\n\n    alt ProfileService Unavailable\n        Loyalty->>Profile: GET /api/v1/profile/partner-links\n        Profile-->>Loyalty: 503 Service Unavailable\n        Loyalty->>Loyalty: Circuit breaker OPEN\n        Loyalty-->>Gateway: 503 Service Unavailable<br/>{fallback: \"proceed without points\"}\n        Gateway-->>POS: Degraded mode\n        POS->>Customer: \"Points temporarily unavailable\"\n        POS->>POS: Complete transaction without points\n    end\n\n    alt EagleEye API Timeout\n        Loyalty->>EagleEye: POST /transactions/validate\n        EagleEye->>EagleEyeAPI: Forward request\n        Note over EagleEyeAPI: Timeout after 3s\n        EagleEye-->>Loyalty: 504 Gateway Timeout\n        Loyalty->>Loyalty: Return cached default reward\n        Loyalty-->>Gateway: 200 OK {provisionalRewards: 100 points (default)}\n        Gateway-->>POS: Adjudication complete (degraded)\n        POS->>Customer: \"You'll earn ~100 points (estimate)\"\n    end\n----\n\n*Key Points*:\n\n* *Two-phase adjudication*: Validation (pre-payment) → Redemption (post-payment)\n* *Latency budget*: 500ms p95 for credential resolution (NFR-002)\n* *Graceful degradation*: Circuit breaker returns default rewards if EagleEye slow\n* *Trace propagation*: W3C traceparent header flows through all services\n\n==== Batch File Processing Flow (AS-3 Grants)\n\nNightly batch job aggregates transactions and transmits to Flybuys via SFTP.\n\n[mermaid]\n----\nsequenceDiagram\n    participant Scheduler as Batch Scheduler<br/>(Azure Data Factory)\n    participant Loyalty as LoyaltyService<br/>(Batch Job)\n    participant LoyaltyDB as Loyalty DB\n    participant D365 as D365 Commerce<br/>(POS Transactions)\n    participant FileGen as CSV Generator\n    participant PGP as PGP Encryption\n    participant SFTP as SFTP Client\n    participant Flybuys as Flybuys SFTP Server\n    participant Monitor as Monitoring\n\n    Note over Scheduler,Monitor: Daily Batch Window: 01:00 - 02:00 UTC\n\n    Scheduler->>Scheduler: Timer trigger: 01:00 UTC\n    Scheduler->>Loyalty: Start batch job<br/>(jobId, runDate=yesterday)\n\n    Note over Loyalty,D365: Phase 1: Transaction Aggregation (01:00 - 01:20)\n    Loyalty->>LoyaltyDB: Query RewardTransactions<br/>(status=CONFIRMED, date=yesterday)\n    LoyaltyDB-->>Loyalty: 50,000 transactions\n\n    Loyalty->>D365: Query transactions for reconciliation<br/>(transactionIds[])\n    D365-->>Loyalty: Transaction details\n\n    Loyalty->>Loyalty: Aggregate by Flybuys member<br/>(group by externalMemberId)\n    Loyalty->>Loyalty: Calculate BASE_POINTS + BONUS_POINTS\n    Loyalty->>Monitor: Log progress: \"Aggregated 50k transactions\"\n\n    Note over FileGen,PGP: Phase 2: File Generation (01:20 - 01:35)\n    Loyalty->>FileGen: Generate CSV file<br/>(transactions[], filename=OTR_TRANSACTIONS_20251209_010000.csv)\n    FileGen->>FileGen: Write header row\n    FileGen->>FileGen: Write 50,000 transaction rows\n    FileGen->>FileGen: Validate file format (UTF-8 BOM, CRLF)\n    FileGen-->>Loyalty: CSV file (25MB)\n\n    Loyalty->>PGP: Encrypt file<br/>(publicKey=Flybuys_RSA_2048, compression=ZIP)\n    PGP->>PGP: Compress CSV (ZIP level 6): 25MB → 8MB\n    PGP->>PGP: Encrypt with RSA+AES-256\n    PGP->>PGP: ASCII armor (.pgp extension)\n    PGP-->>Loyalty: Encrypted file (9MB)\n    Loyalty->>Monitor: Log progress: \"File generated, size=9MB\"\n\n    Note over SFTP,Flybuys: Phase 3: SFTP Transmission (01:35 - 01:50)\n    Loyalty->>SFTP: Transmit file<br/>(OTR_TRANSACTIONS_20251209_010000.csv.pgp)\n    SFTP->>Flybuys: SSH connect + authenticate\n    Flybuys-->>SFTP: Connection established\n    SFTP->>Flybuys: PUT file (9MB, ~5 min upload)\n    Flybuys-->>SFTP: Transfer complete\n    SFTP->>Flybuys: Verify checksum (MD5)\n    Flybuys-->>SFTP: Checksum OK\n    SFTP-->>Loyalty: Upload successful\n\n    Loyalty->>LoyaltyDB: Update RewardTransactions<br/>(status=POSTED_TO_FLYBUYS, postedAt=01:45 UTC)\n    Loyalty->>Monitor: Log success: \"Batch file transmitted, size=9MB, records=50k\"\n\n    Note over Flybuys,Monitor: Phase 4: Acknowledgement (01:50 - 02:00)\n    Loyalty->>Loyalty: Wait 5 minutes for ACK file\n    Loyalty->>SFTP: Poll for acknowledgement file<br/>(OTR_TRANSACTIONS_20251209_010000.ack)\n    SFTP->>Flybuys: LIST /outbound/*.ack\n\n    alt Acknowledgement File Present\n        Flybuys-->>SFTP: ACK file found\n        SFTP->>Flybuys: GET acknowledgement file\n        Flybuys-->>SFTP: ACK file content<br/>(status=SUCCESS, records=50000)\n        SFTP-->>Loyalty: ACK file downloaded\n        Loyalty->>Loyalty: Parse ACK file\n        Loyalty->>LoyaltyDB: Update batch job status=ACKNOWLEDGED\n        Loyalty->>Monitor: Log success: \"Batch acknowledged by Flybuys\"\n        Loyalty-->>Scheduler: Job complete (duration=60 min)\n    else No Acknowledgement File\n        SFTP-->>Loyalty: ACK file not found\n        Loyalty->>Loyalty: Wait 2 minutes, retry poll\n        Loyalty->>SFTP: Poll again\n\n        alt ACK Found on Retry\n            SFTP-->>Loyalty: ACK file found (retry successful)\n            Loyalty->>Monitor: Log warning: \"ACK delayed but received\"\n            Loyalty-->>Scheduler: Job complete (duration=62 min)\n        else ACK Still Missing\n            Loyalty->>Monitor: Alert CRITICAL: \"Batch ACK missing after 10 min\"\n            Loyalty->>LoyaltyDB: Update batch job status=ACK_PENDING\n            Loyalty-->>Scheduler: Job partial success (manual follow-up required)\n        end\n    end\n\n    Note over Scheduler,Monitor: Error Scenarios\n\n    alt SFTP Upload Failure\n        SFTP->>Flybuys: PUT file\n        Flybuys-->>SFTP: 500 Internal Server Error\n        SFTP-->>Loyalty: Upload failed\n        Loyalty->>Loyalty: Exponential backoff retry (2min, 4min, 8min)\n        Loyalty->>SFTP: Retry upload (attempt 2/3)\n\n        alt Retry Successful\n            SFTP->>Flybuys: PUT file (retry)\n            Flybuys-->>SFTP: Transfer complete\n            SFTP-->>Loyalty: Upload successful\n            Loyalty->>Monitor: Log warning: \"Upload succeeded on retry 2\"\n            Loyalty-->>Scheduler: Job complete\n        else All Retries Failed\n            Loyalty->>Monitor: Alert CRITICAL: \"Batch upload failed after 3 attempts\"\n            Loyalty->>LoyaltyDB: Update batch job status=FAILED\n            Loyalty-->>Scheduler: Job failed (manual intervention required)\n        end\n    end\n\n    alt Batch Window Deadline Exceeded\n        Note over Loyalty: Current time: 01:58 UTC\n        Loyalty->>Loyalty: Check time remaining: 2 minutes\n        Loyalty->>Monitor: Alert WARNING: \"Approaching 02:00 UTC deadline\"\n        Loyalty->>SFTP: Attempt final upload (priority)\n\n        alt Upload Completes Before 02:00\n            SFTP-->>Loyalty: Upload complete 01:59 UTC\n            Loyalty->>Monitor: Log warning: \"Deadline met with 1 min margin\"\n            Loyalty-->>Scheduler: Job complete (late but within SLA)\n        else Upload Exceeds 02:00 UTC\n            Note over Loyalty: Current time: 02:02 UTC\n            SFTP-->>Loyalty: Upload complete 02:02 UTC\n            Loyalty->>Monitor: Alert CRITICAL: \"SLA breach - uploaded after 02:00 UTC deadline\"\n            Loyalty->>LoyaltyDB: Update batch job status=LATE\n            Loyalty-->>Scheduler: Job complete (SLA breach, escalate to Flybuys)\n        end\n    end\n----\n\n*Key Points*:\n\n* *Batch window*: 01:00-02:00 UTC (1-hour window for 50k-100k transactions)\n* *Four phases*: Aggregation (20 min) → Generation (15 min) → Upload (15 min) → ACK (10 min)\n* *Retry strategy*: Exponential backoff for SFTP failures (2min, 4min, 8min)\n* *SLA deadline*: 02:00 UTC submission deadline enforced by Flybuys\n* *Monitoring*: Critical alerts for ACK missing, upload failures, deadline breaches\n\n<<<\n== Transition Architecture\n\nThis section defines the phased approach to migrate from current state to target architecture, showing intermediate architecture states and technical dependencies.\n\n. *No Big-Bang Migration*: Incremental rollout using Strangler Fig pattern (reference ADR-005 in Architecture Definition)\n. *Zero Downtime*: New bounded contexts operate in parallel with legacy OTR App API during transition\n. *Feature Flag Control*: All new capabilities behind feature flags (see xref:../architecture_definitions/flybuys_integration.adoc#Feature%2520Flag%2520Register[Feature Flag Register] in Architecture Definition)\n. *Data Coexistence*: Dual-write to legacy and new systems during AS-1 Foundation phase (30 days)\n. *Rollback Capability*: Each phase independently reversible without data loss\n\n=== Transition Phase Matrix\n\nProgressive rollout of feature flags across architecture states (TS-0 → AS-1 → AS-2 → AS-3 → AS-4).\n\n*Flag Definitions*: See xref:../architecture_definitions/flybuys_integration.adoc#Feature%2520Flag%2520Register[Feature Flag Register] in Architecture Definition for complete flag purposes, ownership, and strategic rationale.\n\n[cols=\"3,1,1,1,1,1\"]\n|===\n| Flag Name | TS-0 Current | AS-1 Foundation | AS-2 linking | AS-3 Grants | AS-4 Target\n\n| +OTR.Loyalty.Enabled+\n| OFF\n| ON\n| ON\n| ON\n| ON\n\n| +OTR.Loyalty.PartnerLink.Flybuys+\n| OFF\n| OFF\n| ON\n| ON\n| ON\n\n| +OTR.Loyalty.RewardPreferenceSelection+\n| OFF\n| OFF\n| ON\n| ON\n| ON\n\n| +OTR.Loyalty.TransactionAdjudication+\n| OFF\n| OFF\n| OFF\n| ON\n| ON\n\n| +OTR.Loyalty.PointsEarn.Flybuys+\n| OFF\n| OFF\n| OFF\n| ON\n| ON\n\n| +OTR.Loyalty.FlybuysBatchPosting+\n| OFF\n| OFF\n| OFF\n| ON\n| ON\n|===\n\n*Dependencies*:\n\n* +OTR.Loyalty.PartnerLink.Flybuys+ requires +OTR.Loyalty.Enabled+ = ON\n* +OTR.Loyalty.TransactionAdjudication+ requires +OTR.Loyalty.Enabled+ = ON\n* +OTR.Loyalty.PointsEarn.Flybuys+ requires +OTR.Loyalty.TransactionAdjudication+ = ON\n\n=== Rollback Strategy\n\nFeature flags enable rapid rollback without code deployment. Each architecture state can be rolled back by disabling the corresponding flags:\n\n==== AS-1 Foundation Rollback\n\n*Trigger*: VCI migration failures, EagleEye wallet creation issues, or infrastructure instability\n\n*Actions*:\n\n. Set +OTR.Loyalty.Enabled+ = OFF (disables all loyalty features)\n. Delete customer VCI records created during pilot (data cleanup)\n. Validate legacy OTR App API is functioning normally\n\n*Impact*: Mobile app reverts to legacy loyalty features (no EagleEye integration)\n\n==== AS-2 linking Rollback\n\n*Trigger*: OAuth flow failures (>5% failure rate), Flybuys API unavailability, or customer support tickets >50/day\n\n*Actions*:\n\n. Set +OTR.Loyalty.PartnerLink.Flybuys+ = OFF (disables Flybuys linking UI)\n. Set +OTR.Loyalty.RewardPreferenceSelection+ = OFF (hides reward preference selection)\n. Communicate to pilot users via push notification and email\n\n*Impact*: Customers cannot link Flybuys accounts, balance queries disabled\n\n==== AS-3 Grants Rollback\n\n*Trigger*: POS integration failures, batch file acknowledgement rate <98%, or transaction adjudication errors\n\n*Actions*:\n\n. Set +OTR.Loyalty.TransactionAdjudication+ = OFF (reverts to legacy POS integration)\n. Set +OTR.Loyalty.PointsEarn.Flybuys+ = OFF (stops points earning)\n. Set +OTR.Loyalty.FlybuysBatchPosting+ = OFF (stops daily batch transmission)\n. Re-enable Reddy Express legacy Flybuys integration (barcode pattern matching)\n\n*Impact*: POS reverts to legacy Flybuys integration, transactions in-flight may need manual reconciliation\n\n==== Partial Rollback (Batch Posting Issues Only)\n\n*Trigger*: Flybuys batch file acknowledgement failures, SFTP transmission errors\n\n*Actions*:\n\n. Set +OTR.Loyalty.FlybuysBatchPosting+ = OFF (stops batch transmission)\n. Investigate SFTP connectivity, PGP encryption, and acknowledgement file parsing\n. Keep +OTR.Loyalty.TransactionAdjudication+ = ON (POS integration continues)\n\n*Impact*: Points not posted to Flybuys immediately, requires manual batch file regeneration and transmission\n\n=== TS-0 Current State\n\nPre-initiative architecture (reference Architecture Definition §2 Current State)\n\n==== Active Components\n\n* OTR App API (AWS Lambda, DynamoDB)\n* Reddy Express legacy loyalty (SQL Server, POS barcode matching) - Flybuys-only\n* No unified customer identity (OTR users and Reddy Express customers separate)\n* No partner integrations beyond basic xref:../ubiquitous_language.adoc#flybuys-cardholder-number[Flybuys Card] scanning\n\n==== Technical Debt\n\n* Fragmented customer identity (OTR vs Reddy Express silos)\n* No event-driven architecture (synchronous-only integrations)\n* Tight POS coupling (direct Flybuys barcode pattern matching at OTR+ stores)\n* No OAuth infrastructure (no secure third-party account linking)\n\n\n=== AS-1 Foundation\n\nEstablish xref:../bounded_context/profile.adoc[Profile Service], xref:../bounded_context/loyalty.adoc[Loyalty Service], xref:../bounded_context/interfaces/otr_app_api.adoc[Event Bus] without customer-facing features\n\n==== New SBBS\n\n[cols=\"1,3\"]\n|===\n| SBB | Description\n\n| <<sbb-001-profile-service-api,SBB-001>>\n| xref:../bounded_context/profile.adoc[Profile Service] API\n\n| <<sbb-002-profile-service-database,SBB-002>>\n| xref:../bounded_context/profile.adoc[Profile Service] Database\n\n| <<sbb-003-loyalty-service-api,SBB-003>>\n| xref:../bounded_context/loyalty.adoc[Loyalty Service] API\n\n| <<sbb-004-loyalty-service-database,SBB-004>>\n| xref:../bounded_context/loyalty.adoc[Loyalty Service] Database\n\n| <<sbb-006-domain-event-bus,SBB-006>>\n| Domain xref:../bounded_context/interfaces/otr_app_api.adoc[Event Bus] (Event Grid)\n\n| SBB-008\n| Eagle Eye[Eagle Eye] Integration Adaptor\n\n| <<sbb-012-application-monitoring,SBB-012>>\n| Application Monitoring (App Insights)\n\n| <<sbb-013-api-gateway,SBB-013>>\n| API Gateway (APIM)\n|===\n\n==== Implementation Approach\n\nEnable xref:../ubiquitous_language.adoc#customer[Customer] uplift with a xref:../ubiquitous_language.adoc#dark-launch[Dark Launch] rollout strategy. New integration runs in parallel with existing system, validating technical implementation without customer impact\n\n[cols=\"2,5\"]\n|===\n| Activity | Description\n\n| Customer Profile Creation\n| xref:../ubiquitous_language.adoc#just-in-time-integration[Just-In-Time Integration] via `POST /api/v1/profile/customers` endpoint - xref:../ubiquitous_language.adoc#otr-app[Mobile Application] calls this during login if xref:../ubiquitous_language.adoc#customer[Customer] has no xref:../ubiquitous_language.adoc#viva-consumer-id-vci[VCI], creating profile and linking to Salesforce\n\n| Wallet Provisioning\n| Orchestrated by profile creation endpoint - `POST /api/v1/profile/customers` calls EagleEye ACL to provision xref:../ubiquitous_language.adoc#wallet[EagleEye Wallet] atomically with profile creation\n\n| Dual-Write Pattern\n| xref:../ubiquitous_language.adoc#otr-app[Mobile Application] sends requests to both legacy OTR App API and new xref:../bounded_context/profile.adoc[Profile Service] / xref:../bounded_context/loyalty.adoc[Loyalty Service], while legacy remains authoritative until Loyalty Value Chain[Loyalty Value Chain]\n|===\n\n===== Architecture Diagram\n\n[mermaid]\n----\ngraph TD\n    MobileApp[Mobile App]\n    LegacyAPI[Legacy API<br/>Primary]\n    Services[Profile Service<br/>Loyalty Service<br/>pilot only, dual-write]\n    EventBus[Event Bus]\n\n    MobileApp --> LegacyAPI\n    MobileApp --> Services\n    Services --> EventBus\n----\n\n===== Rollout Strategy\n\n*Note*: See xref:../architecture_definitions/flybuys_integration.adoc#Feature%2520Flag%2520Register[Feature Flag Register] in Architecture Definition for complete feature catalogue, and <<transition-phase-matrix,Transition Phase Matrix>> above for rollout schedule.\n\n[cols=\"3,1\"]\n|===\n| Flag | Status\n\n| +OTR.Loyalty.Enabled+\n| On\n\n| +OTR.Loyalty.TransactionAdjudication+\n| Off\n\n| +OTR.Loyalty.RewardPreferenceSelection+\n| Off\n\n| +OTR.Loyalty.PartnerLink.Flybuys+\n| Off\n\n| +OTR.Loyalty.PointsEarn.Flybuys+\n| Off\n|===\n\n===== Events\n\n[cols=\"2,1\"]\n|===\n| Event | Emitted\n\n| +PointsEarned+\n| No\n\n| +FlybuysPointsRedeemed+\n| No\n\n| +TransactionAdjudicated+\n| No\n\n| +PointsEarned+\n| No\n\n| +PointsRedeemed+\n| No\n\n| +PointsExpired+\n| No\n\n| +PointsAdjusted+\n| No\n\n| +CustomerProfileCreated+\n| Yes\n\n| +MemberUnenrolled+\n| No\n\n| +GrantIssued+\n| No\n\n| +GrantRedeemed+\n| No\n|===\n\n===== Success Criteria\n\n* 100% of xref:../ubiquitous_language.adoc#otr-app[Mobile Application] xref:../ubiquitous_language.adoc#customer[Customers] have xref:../ubiquitous_language.adoc#viva-consumer-id-vci[Viva Consumer ID (VCI)] allocated in xref:../bounded_context/external/salesforce_crm.adoc[Salesforce CRM]\n* 100% of xref:../ubiquitous_language.adoc#otr-app[Mobile Application] xref:../ubiquitous_language.adoc#customer[Customers] have xref:../ubiquitous_language.adoc#wallet[Wallets] allocated in xref:../bounded_context/external/eagle_eye.adoc[EagleEye]\n* No xref:../ubiquitous_language.adoc#otr-app[Mobile Application] xref:../ubiquitous_language.adoc#customer[Customers] have a linked xref:../ubiquitous_language.adoc#flybuys-digital-identity[Flybuys Digital Identity]\n* Zero production impact\n* Zero xref:../ubiquitous_language.adoc#otr-app[Mobile Application] impacts\n\n===== Dependencies\n\n* EagleEye API credentials and rate limits confirmed (external dependency - EagleEye, 1000 req/min guaranteed)\n* Infrastructure provisioning complete (internal dependency - Platform team)\n\n==== Rollback Approach\n\n* Delete xref:../ubiquitous_language.adoc#customer[Customers] uplifted xref:../bounded_context/external/salesforce_crm.adoc[Salesforce CRM] profiles\n\n===== Feature Flags\n\n[cols=\"3,1\"]\n|===\n| Flag | Status\n\n| +OTR.Loyalty.Enabled+\n| Off\n\n| +OTR.Loyalty.TransactionAdjudication+\n| Off\n\n| +OTR.Loyalty.RewardPreferenceSelection+\n| Off\n\n| +OTR.Loyalty.PartnerLink.Flybuys+\n| Off\n\n| +OTR.Loyalty.PointsEarn.Flybuys+\n| Off\n|===\n\n\n=== AS-2 linking\n\nEnable customer-facing xref:../ubiquitous_language.adoc#partner-xref[Partner Link] and xref:../ubiquitous_language.adoc#reward-preference[Reward Preference] selection in xref:../ubiquitous_language.adoc#otr-app[Mobile Applications]\n\n==== New SBB\n\n[cols=\"1,2\"]\n|===\n| SBB | Description\n\n| SBB-005\n| OAuth Token Service\n\n| SBB-007\n| Flybuys Integration Adaptor\n\n| SBB-011\n| Mobile Application Updates\n\n| SBB-013\n| Distributed Cache\n|===\n\n==== New Capabilities\n\n* xref:../ubiquitous_language.adoc#otr-app[Mobile Application] xref:../ubiquitous_language.adoc#partner-xref[Partner link] flow (xref:../ubiquitous_language.adoc#pkce[OAuth 2.0 Authorisation Code Flow with PKCE])\n* xref:../ubiquitous_language.adoc#reward-preference[Reward preference selection UI] (Flybuys points vs OTR fuel discount)\n* Real-time Flybuys balance display in mobile app wallet screen\n\n==== Implementation Approach\n\nEnable linking for xref:../ubiquitous_language.adoc#customer[Customers] using a xref:../ubiquitous_language.adoc#ring-deployments[Ring Deployments] progressive exposure strategy\n\n===== Monitoring\n\nTrack OAuth success rate, balance query latency, customer support tickets (30-day observation period)\n\n===== Cutover\n\nAfter 30 days successful pilot (>95% OAuth success rate), enable for all xref:../ubiquitous_language.adoc#customer[Customers]\n\n===== Architecture Diagram\n\n[mermaid]\n----\ngraph TD\n    A[Mobile App] --> B[API Gateway]\n    B --> C[Profile Service]\n    B --> D[Loyalty Service]\n    C --> E[Event Bus]\n    C --> F[OAuth Service + Key Vault]\n    C --> G[Flybuys API]\n    D --> E\n    D --> F\n    D --> G\n----\n\n===== Rollout\n\n====== Ring 0 (Internal Validation)\n\nStaff accounts (50 users), 7 days\n\n* Validation: Users are in xref:../bounded_context/external/salesforce_crm.adoc[Salesforce CRM] and Braze\n* Go criteria: 100% success rate, zero P1/P2 incidents\n\n====== Ring 1 (Pilot Users)\n\nCustomers who regularly use the xref:../ubiquitous_language.adoc#otr-app[Mobile Applications], 14 days\n\n* Validation: OAuth success rate >90%, customer support tickets <10/day\n* Go criteria: Meet validation targets for 7 consecutive days\n\n====== Ring 2 (General availability)\n\nAll xref:../ubiquitous_language.adoc#otr-app[Mobile Application] Customers\n\n* Deployment: Gradual rollout using percentage targeting (10% → 50% → 100% over 14 days)\n* Monitoring: Track OAuth success rate, balance query latency, customer support tickets (30-day observation period)\n\n[cols=\"3,1\"]\n|===\n| Flag | Status\n\n| +OTR.Loyalty.Enabled+\n| On\n\n| +OTR.Loyalty.TransactionAdjudication+\n| Off\n\n| +OTR.Loyalty.RewardPreferenceSelection+\n| Off\n\n| +OTR.Loyalty.PartnerLink.Flybuys+\n| On\n\n| +OTR.Loyalty.PointsEarn.Flybuys+\n| Off\n|===\n\n===== Events\n\n[cols=\"2,1\"]\n|===\n| Event | Emitted\n\n| +Partnerlinked+\n| Yes\n\n| +PartnerUnlinked+\n| Yes\n\n| +PointsEarned+\n| No\n\n| +FlybuysPointsRedeemed+\n| No\n\n| +TransactionAdjudicated+\n| No\n\n| +PointsEarned+\n| No\n\n| +PointsRedeemed+\n| No\n\n| +PointsExpired+\n| No\n\n| +PointsAdjusted+\n| No\n\n| +CustomerProfileCreated+\n| Yes\n\n| +MemberUnenrolled+\n| No\n\n| +GrantIssued+\n| No\n\n| +GrantRedeemed+\n| No\n|===\n\n===== Dependencies\n\n* Flybuys OAuth API production credentials (external - Flybuys, confirmed Nov 2025)\n* OAuth Service provisioned with Flybuys IDP connection (internal - Platform team, Dec 2025)\n* Mobile app release with linking UI\n\n===== Success Criteria\n\n* 95% of xref:../ubiquitous_language.adoc#customer[Customers] attempting xref:../ubiquitous_language.adoc#partner-xref[Partner link] are successful\n* OAuth success rate >95% over 30-day pilot period (validation exit criterion)\n* Balance query latency < 2s p95 (NFR-003)\n* Customer support tickets < 50 related to linking issues (< 0.5% of pilot users)\n\n==== Rollback Approach\n\n* Delete xref:../ubiquitous_language.adoc#partner-xref[Partner link] from pilot xref:../ubiquitous_language.adoc#customer[Customers] (customer communication required via email/push notification)\n\n===== Feature Flags\n\n[cols=\"3,1\"]\n|===\n| Flag | Status\n\n| +OTR.Loyalty.Enabled+\n| On\n\n| +OTR.Loyalty.TransactionAdjudication+\n| Off\n\n| +OTR.Loyalty.RewardPreferenceSelection+\n| On\n\n| +OTR.Loyalty.PartnerLink.Flybuys+\n| Off\n\n| +OTR.Loyalty.PointsEarn.Flybuys+\n| Off\n|===\n\n\n=== AS-3 Grants\n\n* Enable in-store xref:../bounded_context/interfaces/otr_pos.adoc[OTR POS] and xref:../bounded_context/interfaces/otr_plus_pos.adoc[OTR+ POS] xref:../ubiquitous_language.adoc#loyalty-credential[Loyalty Credential] recognition\n* Transaction posting to Flybuys (batch files)\n* xref:../ubiquitous_language.adoc#digital-fuel-dockets[Digital Fuel Docket] redemption\n\n==== New SBB\n\n[cols=\"1,3\"]\n|===\n| SBB | Description\n\n| SBB-012\n| Batch File Pipeline (serverless functions for daily aggregation, SFTP transmission)\n|===\n\n==== Implementation Approach\n\n*POS Barcode Integration*:\n\n. Deploy +POST /api/v1/loyalty/credentials/resolve+ endpoint\n. Update POS to call Loyalty Service API on barcode scan\n. Barcode Format: EAN-13 (13-digit European Article Number standard)\n. Pre-linking Requirement: Customers must link Flybuys account via mobile app OAuth flow (AS-2)\n. Error Handling: POS displays \"Please link Flybuys in mobile app\" if unlinked Flybuys credential scanned (422 error)\n\n*Rollout Strategy*:\n\n* POS Rollout: Enable barcode scanning at pilot stores (10 OTR stores), then gradual rollout\n* Batch Processing: Daily batch file generation starts (nightly 01:00 UTC job)\n\n===== Feature Flags\n\n[cols=\"3,1\"]\n|===\n| Flag | Status\n\n| +OTR.Loyalty.Enabled+\n| On\n\n| +OTR.Loyalty.TransactionAdjudication+\n| On\n\n| +OTR.Loyalty.RewardPreferenceSelection+\n| On\n\n| +OTR.Loyalty.PartnerLink.Flybuys+\n| On\n\n| +OTR.Loyalty.PointsEarn.Flybuys+\n| On\n|===\n\n*Success Criteria*:\n\n* 100% of customer transactions post to Flybuys (batch acknowledgement rate >98%, NFR-016)\n* POS barcode resolution latency < 500ms p95 (NFR-002)\n* Digital docket redemption operational at all 500+ stores\n\n=== AS-4 Target State\n\nFinal steady-state architecture after all Flybuys Integration capabilities are deployed and stabilised.\n\n==== Success Criteria (Entry to AS-4)\n\n*Prerequisites*:\n\n* AS-3 Grants operational for minimum 6 months\n* Zero critical incidents (P1/P2) in last 90 days\n* All NFRs validated and meeting targets\n* Legacy Reddy Express Flybuys integration fully decommissioned\n\n==== Characteristics of Target State\n\n===== Feature Flags\n\n* All flags remain ON (no changes from AS-3)\n* Feature flag infrastructure retained for emergency rollback capability\n\n===== Architecture\n\n* Bounded contexts operating independently\n* Event-driven integration fully operational\n* Anti-Corruption Layers protecting domain boundaries\n* Zero coupling to legacy OTR App API\n\n=== Technical Dependency Graph\n\n[mermaid]\n----\ngraph TD\n    A[AS-1: Foundation] --> B[AS-2: linking Enabled]\n    B --> C[AS-3: Grants Operational]\n    C --> D[AS-4: Target State]\n\n    A -->|Prerequisite| E[VCI Migration Complete]\n    A -->|Prerequisite| F[EagleEye Wallets Created]\n\n    B -->|Prerequisite| G[OAuth Service Ready<br/>Flybuys IDP configured]\n    B -->|Prerequisite| H[Flybuys OAuth Credentials<br/>Production API keys]\n\n    C -->|Prerequisite| I[Flybuys SFTP Access<br/>SSH keys, PGP encryption]\n    C -->|Prerequisite| J[D365 POS Integration<br/>Barcode API ready]\n\n    D -->|Prerequisite| K[6 Months Stability<br/>No critical incidents]\n    D -->|Prerequisite| L[Legacy Data Archived<br/>7-year retention]\n----\n\n=== Transition Risks\n\n[cols=\"1,3,3,2\"]\n|===\n| Risk ID | Risk Description | Mitigation | Contingency\n\n| TR-001\n| VCI migration fails (customers lose profile data)\n| Dual-write during AS-1 (30 days), legacy remains authoritative\n| Rollback to legacy OTR App API only\n\n| TR-002\n| Flybuys OAuth service outage during rollout\n| Circuit breaker pattern, cached balance data as fallback (5-min TTL)\n| Disable linking, revert to read-only balance\n\n| TR-003\n| Batch file transmission failures (points not posted)\n| Retry logic with exponential backoff (3 attempts), manual SFTP fallback\n| Manual CSV generation and upload by data team\n\n| TR-004\n| POS barcode scanning latency unacceptable (>1s)\n| Redis caching for barcode resolution (5-min TTL), load testing in UAT\n| Revert to legacy Reddy Express POS integration\n\n| TR-005\n| Event Bus delivery failures (eventual consistency)\n| Dead letter queue monitoring (alert if >100 events), replay capability\n| Synchronous API calls as fallback (temporary)\n\n| TR-006\n| Cosmos DB autoscale insufficient (RU/s throttling)\n| Monitor 429 errors, increase max RU/s (10k → 20k), partition optimization\n| Temporarily disable non-critical features\n|===\n\n<<<\n== Solution Validation\n\nThis section defines how the solution will be validated against requirements defined in the Architecture Definition.\n\n=== Functional Validation\n\n*Business Requirements*: See xref:../architecture_definitions/flybuys_integration.adoc#Business%2520Requirements[Business Requirements] in Architecture Definition for complete requirement definitions (BR-001 through BR-012).\n\n*Validation Approach*: All business requirements validated through combination of:\n\n* UAT testing with pilot users (500 mobile app users, 100 OAuth linking attempts)\n* Production pilot at 10 stores (10k transactions monitored)\n* Automated API tests (ProfileService, LoyaltyService, EagleEye integration)\n* Manual verification of batch file generation and Flybuys acknowledgement\n\n*Key Validation Checkpoints*:\n\n* *Customer Identity (BR-001, BR-002)*: 100% users have VCI allocated in Salesforce\n* *Partner linking (BR-004)*: OAuth flow completes in <30s p95\n* *Reward Preferences (BR-005, BR-006)*: Preference changes reflected within 5s\n* *Transaction Posting (BR-007)*: Transactions appear in daily batch file with correct points\n* *Balance Display (BR-010)*: Flybuys balance query returns within 2s p95\n* *Transaction Adjudication (BR-012)*: 100% credentialed transactions route to EagleEye\n\n=== Non-Functional Validation\n\n[cols=\"1,3,3,2\"]\n|===\n| NFR ID | Validation Test | Acceptance Criteria | Tool/Method\n\n| NFR-001\n| Profile Service API latency under load\n| p95 < 200ms with 100 concurrent users\n| JMeter load test (UAT, 10k requests)\n\n| NFR-002\n| Loyalty Service API latency under load\n| p95 < 500ms with 500 concurrent POS transactions/sec\n| JMeter load test (UAT, 50k requests)\n\n| NFR-003\n| Flybuys balance query latency\n| p95 < 2s including Flybuys API call + Redis cache\n| Application Insights (PROD, 30-day avg)\n\n| NFR-004\n| Batch file generation window\n| Job starts 01:00 UTC, completes by 02:00 UTC (1-hour max)\n| Batch pipeline monitoring (PROD, 30-day avg)\n\n| NFR-006\n| Profile Service uptime\n| 99.9% measured over 30 days (max 4.3 hours downtime)\n| Azure Monitor (PROD, 30-day SLA)\n\n| NFR-016\n| Batch file acknowledgement rate\n| >98% transactions acknowledged by Flybuys within 24 hours\n| PROD monitoring (60-day avg)\n|===\n\n=== Integration Validation\n\n[cols=\"2,3,3,2\"]\n|===\n| Integration Point | Validation Test | Acceptance Criteria | Method\n\n| Flybuys OAuth API\n| OAuth flow completes with valid access token\n| Token retrieved and stored in Key Vault\n| Pact contract test (UAT)\n\n| Flybuys Balance API\n| Balance query returns valid response\n| Response matches Flybuys API spec v2.1, < 1.5s latency\n| Integration test harness (UAT)\n\n| Flybuys SFTP\n| Batch file uploads successfully\n| File appears in Flybuys /inbound/otr/ directory, PGP encrypted\n| SFTP integration test (UAT)\n\n| EagleEye Adjudication\n| Transaction adjudication returns grants\n| Response matches EagleEye API spec v3, grants correct\n| Pact contract test (UAT)\n\n| Event Grid\n| Domain events published and consumed\n| Partnerlinked event delivered to Loyalty Service < 5s\n| Event Bus integration test (UAT)\n|===\n\n=== Security Validation\n\n*Validation Method*: Penetration testing (external vendor) + Security audit (internal InfoSec team)\n\n[cols=\"2,3,3,2\"]\n|===\n| Security Control | Validation Test | Acceptance Criteria | Auditor\n\n| OAuth PKCE\n| Authorization code flow uses PKCE\n| Code challenge/verifier validated (S256 method)\n| External pentest (UAT, Q1 2026)\n\n| Token encryption\n| Tokens encrypted at rest (Key Vault)\n| AES-256 encryption, customer-managed keys\n| Internal security audit (PROD)\n\n| API authentication\n| Unauthenticated requests blocked\n| 401 Unauthorized for missing/invalid tokens\n| Automated security scan (UAT)\n\n| Data residency\n| Customer data stored in Australia East region\n| Cosmos DB, Key Vault in AU region only\n| Compliance audit (PROD)\n|===\n\n=== SBB Dependency Flowchart\n\nThis flowchart visualizes the dependency relationships between Solution Building Blocks (SBBs) in the Flybuys Integration architecture.\n\n==== Dependency Chain Diagram\n\n[mermaid]\n----\ngraph TD\n    %% External Systems\n    FlybuysOAuth[External: Flybuys OAuth]\n    FlybuysAPI[External: Flybuys API]\n    EagleEyeAPI[External: EagleEye API]\n    BrazeAPI[External: Braze API]\n\n    %% Mobile & Presentation Layer\n    SBB014[SBB-014: OTR Mobile App]\n\n    %% API Gateway\n    SBB013[SBB-013: API Gateway]\n\n    %% Profile Service\n    SBB001[SBB-001: Profile Service API]\n    SBB002[SBB-002: Profile Service Database]\n\n    %% Loyalty Service\n    SBB003[SBB-003: Loyalty Service API]\n    SBB004[SBB-004: Loyalty Service Database]\n\n    %% Engagement Service\n    SBB007[SBB-007: Engagement Service API]\n    SBB008[SBB-008: Engagement Service Database]\n\n    %% Infrastructure Services\n    SBB005[SBB-005: OAuth Token Manager]\n    SBB006[SBB-006: Domain Event Bus]\n    SBB009[SBB-009: Braze Integration Adaptor]\n    SBB010[SBB-010: Flybuys Integration Adaptor]\n    SBB011[SBB-011: EagleEye Integration Adaptor]\n    SBB012[SBB-012: Application Monitoring]\n    SBB015[SBB-015: Batch File Pipeline]\n    SBB016[SBB-016: Distributed Cache]\n    SBB017[SBB-017: Feature Flag Service]\n\n    %% Mobile App Dependencies\n    SBB014 -->|Partner linking| SBB001\n    SBB014 -->|Balance queries| SBB003\n    SBB014 -->|Ingress routing| SBB013\n\n    %% API Gateway Dependencies\n    SBB013 -->|Routes to| SBB001\n    SBB013 -->|Routes to| SBB003\n    SBB013 -->|Routes to| SBB007\n\n    %% Profile Service Dependencies\n    SBB001 -->|Persists PartnerLink| SBB002\n    SBB001 -->|Token storage/retrieval| SBB005\n    SBB001 -->|Publishes events| SBB006\n    SBB001 -->|Monitored by| SBB012\n\n    %% Loyalty Service Dependencies\n    SBB003 -->|Persists transactions| SBB004\n    SBB003 -->|PartnerLink lookup| SBB001\n    SBB003 -->|Publishes/Consumes events| SBB006\n    SBB003 -->|Balance queries| SBB010\n    SBB003 -->|Transaction adjudication| SBB011\n    SBB003 -->|Caches Flybuys balance| SBB016\n    SBB003 -->|Monitored by| SBB012\n    SBB003 -->|Feature toggles| SBB017\n\n    %% OAuth Token Manager Dependencies\n    SBB005 -->|Initiates OAuth| SBB001\n    SBB005 -->|OAuth tokens| FlybuysOAuth\n\n    %% Engagement Service Dependencies\n    SBB007 -->|Persists campaign state| SBB008\n    SBB007 -->|Consumes events| SBB006\n    SBB007 -->|Triggers campaigns| SBB009\n    SBB007 -->|Monitored by| SBB012\n\n    %% Braze Integration Adaptor Dependencies\n    SBB009 -->|Consumes events| SBB006\n    SBB009 -->|Optional enrichment| SBB001\n    SBB009 -->|Webhook calls| BrazeAPI\n\n    %% Flybuys Integration Adaptor Dependencies\n    SBB010 -->|Balance API| FlybuysAPI\n    SBB010 -->|Batch file upload| SBB015\n    SBB010 -->|Cached responses| SBB016\n\n    %% EagleEye Integration Adaptor Dependencies\n    SBB011 -->|Wallet & adjudication| EagleEyeAPI\n\n    %% Batch File Pipeline Dependencies\n    SBB015 -->|Reads transactions| SBB003\n    SBB015 -->|SFTP upload| FlybuysAPI\n\n    %% Event Bus Subscribers\n    SBB006 -.->|Partnerlinked event| SBB003\n    SBB006 -.->|Partnerlinked event| SBB007\n    SBB006 -.->|TransactionAdjudicated event| SBB007\n\n    %% Styling\n    classDef external fill:#f9f,stroke:#333,stroke-width:2px\n    classDef mobile fill:#bbf,stroke:#333,stroke-width:2px\n    classDef gateway fill:#bfb,stroke:#333,stroke-width:2px\n    classDef service fill:#fbb,stroke:#333,stroke-width:2px\n    classDef database fill:#ffb,stroke:#333,stroke-width:2px\n    classDef infrastructure fill:#bff,stroke:#333,stroke-width:2px\n    classDef integration fill:#fbf,stroke:#333,stroke-width:2px\n\n    class FlybuysOAuth,FlybuysAPI,EagleEyeAPI,BrazeAPI external\n    class SBB014 mobile\n    class SBB013 gateway\n    class SBB001,SBB003,SBB007 service\n    class SBB002,SBB004,SBB008 database\n    class SBB005,SBB006,SBB012,SBB015,SBB016,SBB017 infrastructure\n    class SBB009,SBB010,SBB011 integration\n----\n\n==== Dependency Layers\n\n===== Layer 1: External Systems\n\n* Flybuys OAuth Server\n* Flybuys API (Balance, Batch File SFTP)\n* EagleEye API\n* Braze API\n\n===== Layer 2: Presentation & Gateway\n\n* *SBB-014*: OTR Mobile App\n* *SBB-013*: API Gateway (ingress routing, OAuth validation, rate limiting)\n\n===== Layer 3: Domain Services\n\n* *SBB-001*: Profile Service API (partner linking, reward preferences)\n* *SBB-003*: Loyalty Service API (credential resolution, transaction adjudication)\n* *SBB-007*: Engagement Service API (campaign orchestration)\n\n===== Layer 4: Data Stores\n\n* *SBB-002*: Profile Service Database (PartnerLink aggregates)\n* *SBB-004*: Loyalty Service Database (RewardTransaction audit trail)\n* *SBB-008*: Engagement Service Database (campaign state tracking)\n\n===== Layer 5: Infrastructure Services\n\n* *SBB-005*: OAuth Token Manager (Flybuys token storage/refresh)\n* *SBB-006*: Domain Event Bus (event-driven integration)\n* *SBB-012*: Application Monitoring (observability)\n* *SBB-016*: Distributed Cache (Flybuys balance caching)\n* *SBB-017*: Feature Flag Service (progressive rollout)\n\n===== Layer 6: Integration Adaptors (Anti-Corruption Layers)\n\n* *SBB-009*: Braze Integration Adaptor (marketing automation)\n* *SBB-010*: Flybuys Integration Adaptor (conformist pattern)\n* *SBB-011*: EagleEye Integration Adaptor (loyalty engine)\n\n===== Layer 7: Batch Processing\n\n* *SBB-015*: Batch File Pipeline (nightly transaction aggregation, SFTP transmission)\n\n==== Critical Dependency Paths\n\n===== Partner linking Flow\n\n----\nMobile App (SBB-014)\n  → API Gateway (SBB-013)\n  → Profile Service (SBB-001)\n  → OAuth Token Manager (SBB-005)\n  → Flybuys OAuth\n----\n\n===== Transaction Adjudication Flow\n\n----\nPOS System\n  → API Gateway (SBB-013)\n  → Loyalty Service (SBB-003)\n  → Profile Service (SBB-001) [PartnerLink lookup]\n  → EagleEye Adaptor (SBB-011)\n  → EagleEye API\n----\n\n===== Flybuys Balance Query Flow\n\n----\nLoyalty Service (SBB-003)\n  → Distributed Cache (SBB-016) [cache miss]\n  → Flybuys Adaptor (SBB-010)\n  → Flybuys API\n----\n\n===== Event-Driven Engagement Flow\n\n----\nProfile Service (SBB-001) [publishes Partnerlinked]\n  → Event Bus (SBB-006)\n  → Engagement Service (SBB-007)\n  → Braze Adaptor (SBB-009)\n  → Braze API\n----\n\n==== Notes\n\n* *Solid arrows (→)* indicate synchronous dependencies (REST API calls, database queries)\n* *Dotted arrows (-.->)* indicate asynchronous dependencies (event subscriptions)\n* Some SBB references in the document contain numbering errors\n","structuredPatch":[{"oldStart":77,"oldLines":7,"newStart":77,"newLines":7,"lines":[" * Implement **Anti-Corruption Layers** (ACLs) for xref:../bounded_context/external/braze.adoc[Braze], xref:../bounded_context/external/flybuys.adoc[Flybuys] and xref:../bounded_context/external/eagle_eye.adoc[EagleEye] integration"," * Deploy xref:../bounded_context/interfaces/oauth.adoc[OAuth Service] with Key Vault token encryption"," * Establish event-driven architecture as the foundational integration pattern for the platform.","-* Phased roll-out (AS-1 → AS-4)","+* Phased roll-out (TS-1 → AS-4)"," "," === Related Documentation"," "]},{"oldStart":2136,"oldLines":7,"newStart":2136,"newLines":7,"lines":[" "," *Endpoint*: `POST /api/v1/profile/customers`"," ","-*Purpose*: Creates a new customer profile, retrieves VCI from Salesforce, and provisions an EagleEye wallet. Used by the xref:../ubiquitous_language.adoc#just-in-time-integration[Just-In-Time Integration] during customer login (AS-1 Foundation).","+*Purpose*: Creates a new customer profile, retrieves VCI from Salesforce, and provisions an EagleEye wallet. Used by the xref:../ubiquitous_language.adoc#just-in-time-integration[Just-In-Time Integration] during customer login (TS-1 Foundation)."," "," *Request*:"," "]},{"oldStart":2791,"oldLines":7,"newStart":2791,"newLines":7,"lines":[" * *Event Publishing*: Partnerlinked event triggers LoyaltyService adjudication rule updates"," * *Error Handling*: User cancellation vs. API failure handled differently"," ","-==== Just-In-Time Profile Creation Flow (AS-1 Foundation)","+==== Just-In-Time Profile Creation Flow (TS-1 Foundation)"," "," This flow shows how customer profiles are created on-demand during first login using the xref:../ubiquitous_language.adoc#just-in-time-integration[Just-In-Time Integration] pattern. ProfileService creates the profile and publishes an event. LoyaltyService subscribes to this event and provisions the EagleEye wallet asynchronously (clean DDD bounded context separation)."," "]},{"oldStart":3246,"oldLines":18,"newStart":3246,"newLines":18,"lines":[" . *No Big-Bang Migration*: Incremental rollout using Strangler Fig pattern (reference ADR-005 in Architecture Definition)"," . *Zero Downtime*: New bounded contexts operate in parallel with legacy OTR App API during transition"," . *Feature Flag Control*: All new capabilities behind feature flags (see xref:../architecture_definitions/flybuys_integration.adoc#Feature%2520Flag%2520Register[Feature Flag Register] in Architecture Definition)","-. *Data Coexistence*: Dual-write to legacy and new systems during AS-1 Foundation phase (30 days)","+. *Data Coexistence*: Dual-write to legacy and new systems during TS-1 Foundation phase (30 days)"," . *Rollback Capability*: Each phase independently reversible without data loss"," "," === Transition Phase Matrix"," ","-Progressive rollout of feature flags across architecture states (TS-0 → AS-1 → AS-2 → AS-3 → AS-4).","+Progressive rollout of feature flags across architecture states (TS-0 → TS-1 → AS-2 → AS-3 → AS-4)."," "," *Flag Definitions*: See xref:../architecture_definitions/flybuys_integration.adoc#Feature%2520Flag%2520Register[Feature Flag Register] in Architecture Definition for complete flag purposes, ownership, and strategic rationale."," "," [cols=\"3,1,1,1,1,1\"]"," |===","-| Flag Name | TS-0 Current | AS-1 Foundation | AS-2 linking | AS-3 Grants | AS-4 Target","+| Flag Name | TS-0 Current | TS-1 Foundation | AS-2 linking | AS-3 Grants | AS-4 Target"," "," | +OTR.Loyalty.Enabled+"," | OFF"]},{"oldStart":3312,"oldLines":7,"newStart":3312,"newLines":7,"lines":[" "," Feature flags enable rapid rollback without code deployment. Each architecture state can be rolled back by disabling the corresponding flags:"," ","-==== AS-1 Foundation Rollback","+==== TS-1 Foundation Rollback"," "," *Trigger*: VCI migration failures, EagleEye wallet creation issues, or infrastructure instability"," "]},{"oldStart":3380,"oldLines":7,"newStart":3380,"newLines":7,"lines":[" * No OAuth infrastructure (no secure third-party account linking)"," "," ","-=== AS-1 Foundation","+=== TS-1 Foundation"," "," Establish xref:../bounded_context/profile.adoc[Profile Service], xref:../bounded_context/loyalty.adoc[Loyalty Service], xref:../bounded_context/interfaces/otr_app_api.adoc[Event Bus] without customer-facing features"," "]},{"oldStart":3829,"oldLines":7,"newStart":3829,"newLines":7,"lines":[" [mermaid]"," ----"," graph TD","-    A[AS-1: Foundation] --> B[AS-2: linking Enabled]","+    A[TS-1: Foundation] --> B[AS-2: linking Enabled]","     B --> C[AS-3: Grants Operational]","     C --> D[AS-4: Target State]"," "]},{"oldStart":3854,"oldLines":7,"newStart":3854,"newLines":7,"lines":[" "," | TR-001"," | VCI migration fails (customers lose profile data)","-| Dual-write during AS-1 (30 days), legacy remains authoritative","+| Dual-write during TS-1 (30 days), legacy remains authoritative"," | Rollback to legacy OTR App API only"," "," | TR-002"]}],"userModified":false,"replaceAll":true},"sourceToolAssistantUUID":"55ea05c1-8873-4c9b-9e4e-02fabceac374"}
{"parentUuid":"6eaebc4c-357f-4dbb-8d84-deeb1bc6d067","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01HkzdBYuKn2mKut3YkHWpxd","type":"tool_result","content":"The file /mnt/c/Users/o.young/work/architecture/solution_architectures/flybuys_integration.adoc has been updated. All occurrences of 'AS-2' were successfully replaced with 'TS-2'."}]},"uuid":"a3ac47ba-9f98-4889-9675-43aff9a913c3","timestamp":"2026-01-08T05:38:52.515Z","toolUseResult":{"filePath":"/mnt/c/Users/o.young/work/architecture/solution_architectures/flybuys_integration.adoc","oldString":"AS-2","newString":"TS-2","originalFile":"= Flybuys Integration - Solution Architecture\n\n:project-name: Flybuys Integration\n:togaf-adm-phase: Phase E: Opportunities & Solutions\n:document-type: Solution Architecture Document\n:status: Discovery\n:version: 0.1\n:domain: Loyalty\n:programme-lead: Frankie.Mullaly@vivaenergy.com.au\n:domain-architect: O.Young@otr.com.au\n:business-owner: D.Peisley@otr.com.au\n:business-analyst: Fiona.Cheung@vivaenergy.com.au\n:architecture-definition: xref:../architecture_definitions/flybuys_integration.adoc[Architecture Definitions/Flybuys Integration]\n:doctype: article\n:toc: left\n:toclevels: 4\n:sectanchors:\n:sectxrefs:\n:sectnums:\n:icons: font\n:source-highlighter: highlightjs\n:experimental:\n:description: Solution Architecture Document for Flybuys Coalition Loyalty Integration\n:keywords: loyalty, flybuys, integration, solution-architecture, togaf\n\n== Purpose and Scope\n\n=== Purpose\n\nThis Solution Architecture defines how the Flybuys Integration will be implemented - the specific technology products, configurations, interfaces, and deployment architecture that realise the xref:../architecture_definitions/flybuys_integration.adoc[Flybuys Integration].\n\n<<<\n=== Scope\n\n==== In Scope\n\n* Solution Building Blocks (SBBs) - specific technology products and versions\n* Interface specifications (APIs, events, data formats)\n* Data architecture and schema specifications\n* Transition architecture with phased implementation states\n* Technical validation criteria and testing approach\n* External system integration specifications\n\n==== Out of Scope\n\n===== Covered in xref:../architecture_definitions/flybuys_integration.adoc[Architecture Definition]\n\n* Business requirements and stakeholder analysis\n* Architecture decisions and rationale\n* Bounded context definitions and responsibilities\n* High-level integration patterns (ACL, Conformist, OHS+PL)\n* Business capability mapping and value streams\n* Non-functional requirements (referenced, not duplicated)\n* Architecture principles and governance\n\n===== Covered in other documents\n\n* Detailed design (class diagrams, sequence diagrams for all flows)\n* Implementation code and unit tests\n* Business case and return-on-investment analysis\n* Operational run books and support procedures\n\n<<<\n== Executive Summary\n\nIntegrate xref:../bounded_context/external/flybuys.adoc[Flybuys] Coalition Loyalty across all OTRG Digital and In-Person channels without tightly coupling to external partner systems.\n\nEnable xref:../ubiquitous_language.adoc#customer[Customers] to link their xref:../ubiquitous_language.adoc#flybuys-digital-identity[Flybuys Digital Identity] with their xref:../ubiquitous_language.adoc#otr-app[Mobile Application] user profile, and present unified xref:../ubiquitous_language.adoc#loyalty-credential[Loyalty Credentials] at all xref:../bounded_context/interfaces/otr_pos.adoc[OTR POS] and xref:../bounded_context/interfaces/otr_plus_pos.adoc[OTR+ POS] stores.\n\nThe solution establishes the xref:../ubiquitous_language.adoc#viva-consumer-id-vci[Viva Consumer ID (VCI)] as *the canonical customer identifier* across all integrated systems, ensuring consistent customer reference throughout the loyalty platform and eliminating identity fragmentation.\n\n<<<\n== Solution Approach\n\n* Deploy xref:../bounded_context/profile.adoc[Profile Service] and xref:../bounded_context/loyalty.adoc[Loyalty Service] as bounded context microservices\n* Use NoSQL local document storage with partition key optimisation for caching.\n* Implement **Anti-Corruption Layers** (ACLs) for xref:../bounded_context/external/braze.adoc[Braze], xref:../bounded_context/external/flybuys.adoc[Flybuys] and xref:../bounded_context/external/eagle_eye.adoc[EagleEye] integration\n* Deploy xref:../bounded_context/interfaces/oauth.adoc[OAuth Service] with Key Vault token encryption\n* Establish event-driven architecture as the foundational integration pattern for the platform.\n* Phased roll-out (TS-1 → AS-4)\n\n=== Related Documentation\n\nThis solution architecture references detailed technical specifications:\n\n==== API Specifications\n\n* xref:../specifications/REST/profile-service-v1.yaml.md[Profile Service REST API (OpenAPI 3.0)] - Partner linking, preference management (4 endpoints)\n* xref:../specifications/AsyncAPI/otr-event-bus-v1.yaml.md[Event Bus (AsyncAPI 2.6.0)] - Domain events, CloudEvents 1.0 format\n\n==== Sequence Diagrams\n\n* Flybuys Integration Flows[Flybuys Integration Flows] - Comprehensive diagrams with happy path + error scenarios:\n** Transaction Adjudication (POS real-time, 4 scenarios)\n** OAuth Partner linking (mobile app, 4 scenarios)\n** Batch File Processing (nightly, 3 scenarios)\n** Circuit Breaker State Transitions\n** Event Propagation Timeline\n** OAuth Token Refresh (proactive + errors, 3 scenarios)\n\n==== JSON Schemas\n\n* xref:../specifications/JSON%2520Schemas/.md[JSON Schemas Directory] - Domain event schemas, request/response models\n\n==== Executive Summary\n\n* xref:../executive_summaries/flybuys_integration.adoc[Executive Summary] - 1-page overview for business stakeholders\n\n<<<\n== Key Technology Decisions\n\n[cols=\"1,2,4,3\"]\n|===\n| ID | Kind | Description | Rationale\n\n| DEC-001\n| Implementation\n| .NET 8.0\n| Aligns with OTR platform standards, team expertise in C#\n\n| DEC-002\n| Hosting\n| #TBD#\n| Autoscaling, managed infrastructure, Docker support\n\n| DEC-003\n| NoSQL Database\n| #TBD#\n| Partition key performance, global distribution, TTL support\n\n| DEC-004\n| Event Bus\n| #TBD#\n| CloudEvents 1.0 standard, built-in retry, dead letter queue\n\n| DEC-005\n| Key Storage\n| #TBD#\n| SaaS OAuth provider, Flybuys IDP integration, reduces custom implementation risk\n\n| DEC-006\n| Data Processing\n| #TBD#\n| SFTP connector, PGP encryption, scheduling\n\n| DEC-007\n| Monitoring\n| #TBD#\n| Native Azure integration, distributed tracing, correlation IDs\n\n| DEC-008\n| API Gateway\n| #TBD#\n| OAuth validation, rate limiting, request transformation\n\n| DEC-009\n| Caching Layer\n| #TBD#\n| Reduces Flybuys API load, low-latency access\n\n| DEC-010\n| Mobile App\n| #TBD#\n| Shared business logic, reduces duplicate code for iOS/Android\n\n| DEC-011\n| Authentication\n| xref:../bounded_context/external/microsoft_entra_external_id.adoc[Microsoft Entra External ID]\n| Standardised auth, secure token handling, integrates with mobile app\n\n| DEC-013\n| Resilience\n| #TBD#\n| Circuit breaker, retry policies for external API calls\n\n| DEC-014\n| Configuration / Feature Flags\n| #TBD#\n| Dynamic feature toggling, reduces deployment risk\n\n| DEC-015\n| Transport\n| REST over HTTPS\n|\n\n| DEC-016\n| Observability\n| #TBD#\n|\n\n| DEC-017\n| Deployment\n| #TBD#\n| Docker container + Azure Container Registry\n\n| DEC-018\n| Encryption (At Rest)\n| AES-256\n|\n\n| DEC-019\n| Encryption (In Flight)\n| TLS 1.3\n|\n\n| DEC-020\n| Schema Registry\n| #TBD#\n|\n|===\n\n=== Implementation Constraints\n\n* Must conform to Flybuys API specifications - cannot modify (xref:../architecture_definitions/flybuys_integration.adoc#constraints[CON-002])\n* Flybuys partnership potentially term 2-3 years - architecture must support partner flexibility (xref:../architecture_definitions/flybuys_integration.adoc#constraints[CON-006])\n* OAuth tokens must be `AES-256` encrypted at rest (<<key-technology-decisions,DEC-018>>), `TLS 1.3` in transit (DEC-018 xref:../architecture_definitions/flybuys_integration.adoc#constraints[CON-003])\n* Customer data must reside in Australia East region (xref:../architecture_definitions/flybuys_integration.adoc#constraints[CON-011])\n* Phased rollout required, no big-bang deployment (xref:../architecture_definitions/flybuys_integration.adoc#constraints[CON-004])\n\n=== Success Criteria\n\n* xref:../bounded_context/profile.adoc[Profile Service] / xref:../bounded_context/loyalty.adoc[Loyalty Service] APIs operational with <`500ms` `p95` latency (NFR-001, NFR-002)\n* OAuth linking success rate >95% over 30-day pilot period (7.5 Validation Exit Criteria)\n* Flybuys batch acknowledgement rate >98% for 60 days (NFR-016)\n\n<<<\n== Solution Building Blocks\n\nThis section maps the conceptual *Architecture Building Blocks* (ABBs) defined in the xref:../architecture_definitions/flybuys_integration.adoc[Architecture Definition] to specific *Solution Building Blocks* (SBBs).\n\n=== Technology Portfolio Catalogue\n\nThis catalogue lists all technology components required to implement the Flybuys Integration solution, mapped to the xref:../architecture_definitions/flybuys_integration.adoc#Technology%2520Capability%2520Requirements[Technology Capability Requirements] defined in the Architecture Definition.\n\n[cols=\"1,1,3,1,2,1\"]\n|===\n| Component | Category | Technology Stack | Lifecycle Stage | Rationale | Standards/Patterns\n\n| Event Bus\n| Integration\n| #TBD#\n| Planned\n| Event-driven architecture, loose coupling between services\n| OHS + Published Language\n\n| OAuth Service\n| Infrastructure\n| #TBD#\n| Planned\n| Secure token management, PCI compliance\n| OAuth 2.0, PKCE\n\n| Circuit Breaker\n| Resilience\n| #TBD#\n| Planned\n| Flybuys API failure handling\n| Circuit Breaker Pattern\n\n| Feature Flags\n| Deployment\n| #TBD#\n| Planned\n| Gradual rollout, kill switch for rollback\n| Feature Toggle Pattern\n\n| API Gateway\n| Infrastructure\n| #TBD#\n| Active\n| Single entry point, rate limiting, auth\n| RESTful API, OpenAPI\n\n| NoSQL Database\n| Data Storage\n| #TBD#\n| Active\n| Database per bounded context, high throughput\n| Database per Service\n\n| Key Vault\n| Security\n| #TBD#\n| Active\n| OAuth token storage, encryption keys\n| AES-256, Customer-Managed Keys\n\n| Redis Cache\n| Caching\n| #TBD#\n| Active\n| Flybuys balance caching (5-min TTL), circuit breaker fallback\n| In-Memory Cache, TTL Pattern\n\n| Monitoring Stack\n| Observability\n| #TBD#\n| Active\n| Distributed tracing, metrics, logging\n| OpenTelemetry, Structured Logging\n\n| Identity Provider\n| Authentication\n| xref:../bounded_context/external/microsoft_entra_external_id.adoc[Microsoft Entra External ID]\n| Active\n| Customer authentication, CIAM\n| OAuth 2.0, OIDC\n\n| SFTP Service\n| Integration\n| xref:../bounded_context/external/azure_data_factory.adoc[Azure Data Factory]\n| Active\n| Flybuys batch file transmission\n| SFTP Protocol, Batch File Transfer\n\n| Batch Scheduler\n| Infrastructure\n| xref:../bounded_context/external/azure_data_factory.adoc[Azure Data Factory]\n| Active\n| Nightly batch file generation\n| Cron-based Scheduling\n|===\n\n*Note*: Components marked #TBD# are deferred to implementation phase as engineering choices. See <<key-technology-decisions,Technology Decisions>> for evaluation criteria.\n\n<<<\n\n=== Solution Building Block Mapping\n\n[cols=\"1,3,2,3,4\"]\n|===\n| ABB ID | ABB Name | SBB ID | SBB Name | Technology Product/Component\n\n| ABB-001\n| xref:../bounded_context/profile.adoc[Profile Service] Bounded Context\n| <<sbb-001-profile-service-api,SBB-001>>\n| xref:../bounded_context/profile.adoc[Profile Service] API\n| <<key-technology-decisions,DEC-001 Implementation>>\n\n| ABB-001\n| xref:../bounded_context/profile.adoc[Profile Service] Data Store\n| <<sbb-002-profile-service-database,SBB-002>>\n| xref:../bounded_context/profile.adoc[Profile Service] Database\n| <<key-technology-decisions,DEC-003 NoSQL>>\n\n| ABB-002\n| xref:../bounded_context/loyalty.adoc[Loyalty Service] Bounded Context\n| <<sbb-003-loyalty-service-api,SBB-003>>\n| xref:../bounded_context/loyalty.adoc[Loyalty Service] API\n| <<key-technology-decisions,DEC-001 Implementation>>\n\n| ABB-002\n| xref:../bounded_context/loyalty.adoc[Loyalty Service] Data Store\n| <<sbb-004-loyalty-service-database,SBB-004>>\n| xref:../bounded_context/loyalty.adoc[Loyalty Service] Database\n| <<key-technology-decisions,DEC-003 NoSQL>>\n\n| ABB-006\n| xref:../bounded_context/interfaces/oauth.adoc[OAuth Service]\n| <<sbb-005-oauth-token-manager,SBB-005>>\n| OAuth Token Manager\n| <<key-technology-decisions,DEC-005 Key Storage>>\n\n| ABB-005\n| Event Bus[Event Bus]\n| <<sbb-006-domain-event-bus,SBB-006>>\n| Domain Event Bus\n| <<key-technology-decisions,DEC-004 Event Bus>>\n\n| ABB-004\n| xref:../bounded_context/engagement.adoc[Engagement Service] Bounded Context\n| <<sbb-007-engagement-service-api,SBB-007>>\n| xref:../bounded_context/engagement.adoc[Engagement Service] API\n| <<key-technology-decisions,DEC-001 Implementation>>\n\n| ABB-004\n| xref:../bounded_context/engagement.adoc[Engagement Service] Data Store\n| <<sbb-008-engagement-service-database,SBB-008>>\n| xref:../bounded_context/engagement.adoc[Engagement Service] Datastore\n| <<key-technology-decisions,DEC-003 NoSQL>>\n\n| ABB-012\n| Braze ACL\n| <<sbb-009-braze-integration-adaptor,SBB-009>>\n| xref:../bounded_context/external/braze.adoc[Braze Integration Adaptor]\n| <<key-technology-decisions,DEC-001 Implementation>>\n\n| ABB-013\n| Flybuys ACL\n| <<sbb-010-flybuys-integration-adaptor,SBB-010>>\n| xref:../bounded_context/external/flybuys.adoc[Flybuys Integration Adaptor]\n| <<key-technology-decisions,DEC-001 Implementation>> + <<key-technology-decisions,DEC-006 Data Processing>>\n\n| ABB-014\n| EagleEye ACL\n| <<sbb-011-eagleeye-integration-adaptor,SBB-011>>\n| xref:../bounded_context/external/eagle_eye.adoc[EagleEye Integration Adaptor]\n| <<key-technology-decisions,DEC-001 Implementation>>\n\n| ABB-009\n| Monitoring & Observability\n| <<sbb-012-application-monitoring,SBB-012>>\n| Application Monitoring\n| <<key-technology-decisions,DEC-007 Monitoring>>\n\n| ABB-007\n| API Gateway\n| <<sbb-013-api-gateway,SBB-013>>\n| xref:../bounded_context/interfaces/api_gateway.adoc[API Gateway]\n| <<key-technology-decisions,DEC-008 API Gateway>>\n\n| ABB-010\n| xref:../bounded_context/interfaces/mobile.adoc[Mobile Application]\n| <<sbb-014-otr-mobile-app,SBB-014>>\n| OTR Mobile App\n| <<key-technology-decisions,DEC-010 Mobile Application>>\n\n| ABB-015\n| Points File Management\n| <<sbb-015-batch-file-pipeline,SBB-015>>\n| Batch File Pipeline\n| <<key-technology-decisions,DEC-006 Data Processing>>\n\n| ABB-011\n| Caching Layer\n| <<sbb-016-distributed-cache,SBB-016>>\n| Distributed Cache\n| <<key-technology-decisions,DEC-009 Caching Layer>>\n\n| ABB-008\n| App Config / Feature Flags\n| <<sbb-017-feature-flag-service,SBB-017>>\n| Feature Flags\n|\n\n| ABB-003\n| xref:../bounded_context/location.adoc[Location Service] Bounded Context\n| <<sbb-018-location,SBB-018>>\n| xref:../bounded_context/location.adoc[Location Service] API\n| <<key-technology-decisions,DEC-001 Implementation>>\n\n| ABB-003\n| xref:../bounded_context/location.adoc[Location Service] Data Store\n| <<SBB-019,SBB-019>>\n| xref:../bounded_context/location.adoc[Location Service] Data Store\n|\n|===\n\n<<<\n=== SBB-001: Profile Service API\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| Description\n| Provides APIs for managing customer xref:../ubiquitous_language.adoc#partner-xref[PartnerLink]s with Flybuys, storing reward preferences, and retrieving linked profile data.\n\n| ABB Reference\n| xref:../bounded_context/profile.adoc[Profile Service] Bounded Context (see xref:../architecture_definitions/flybuys_integration.adoc#service-catalogues[Architecture Definition §3.2.1])\n\n| Component Type\n| Microservice (Domain Service)\n\n| Technology Stack\n| <<key-technology-decisions,DEC-001 Implementation>>\n\n| Hosting Platform\n| <<key-technology-decisions,DEC-002 Hosting>>\n\n| API Contract\n| <<key-technology-decisions,DEC-005 Transport>> - See xref:/specifications/rest/profile-service-v1.yaml[OpenAPI 3.0 Specification]\n\n| Authentication\n| <<key-technology-decisions,DEC-011 Authentication>>\n\n| Observability\n| <<key-technology-decisions,DEC-016 Observability>>\n\n| Configuration\n| <<key-technology-decisions,DEC-014 Configuration>>\n\n| Health Checks\n| `/health` HTTPS endpoint\n\n| Deployment Unit\n| <<key-technology-decisions,DEC-017 Deployment>>\n|===\n\n==== Dependencies\n\n[cols=\"2,2,4\"]\n|===\n| SBB ID | Dependency | Reason\n\n| <<sbb-002-profile-service-database,SBB-002>>\n| xref:../bounded_context/profile.adoc[Profile Service] Database\n| xref:../ubiquitous_language.adoc#partner-xref[PartnerLink] aggregate persistence\n\n| <<sbb-005-oauth-token-manager,SBB-005>>\n| OAuth Token Manager\n| xref:../bounded_context/external/flybuys.adoc[Flybuys] OAuth token storage/retrieval\n\n| <<sbb-006-domain-event-bus,SBB-006>>\n| Domain Event Bus\n| Publishing Partnerlinked event schema[Partnerlinked], xref:/specifications/json_schemas/RewardPreferenceChanged.event.schema.json[RewardPreferenceChanged], xref:/specifications/json_schemas/CustomerProfileCreated.event.schema.json[CustomerProfileCreated] events (see AsyncAPI Spec[AsyncAPI Spec])\n\n| <<sbb-010-flybuys-integration-adaptor,SBB-010>>\n| API Gateway\n| Ingress routing, rate limiting, OAuth validation\n\n| Salesforce\n| xref:../bounded_context/external/salesforce.adoc[Salesforce CRM]\n| Upsert Contact record during profile creation (`POST /api/v1/profile/customers`)\n|===\n\n\n<<<\n=== SBB-002: Profile Service Database\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| ABB Reference\n| xref:../bounded_context/profile.adoc[Profile Service] Data Store\n\n| Database Type\n| NoSQL Document Database\n\n| Product\n| <<key-technology-decisions,DEC-003>>\n\n| Consistency\n| Session consistency (default), Strong consistency for PartnerLink operations\n\n| Partition Strategy\n| Partition key: `/vivaConsumerId` (enables single-partition queries, ~10KB documents)\n\n| Throughput\n| Autoscale: 1000-10000 RU/s (scales based on load, avg 4000 RU/s expected)\n\n| Geo-Replication\n| xref:../architecture_definitions/flybuys_integration.adoc#Constraints[CON-011]\n\n| Backup\n| Continuous backup (7-day point-in-time recovery, hourly snapshots)\n\n| Indexes\n| Default indexing + composite index on `[/partner ASC, /status ASC]`\n\n| Containers\n| `partner-links` (main), `customer-profiles` (read model for Salesforce sync)\n\n| Data Residency\n| xref:../architecture_definitions/flybuys_integration.adoc#Constraints[CON-011]\n|===\n\n\n<<<\n=== SBB-003: Loyalty Service API\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| ABB Reference\n| xref:../bounded_context/loyalty.adoc[Loyalty Service] Bounded Context (see xref:../architecture_definitions/flybuys_integration.adoc#service-catalogues[Architecture Definition §3.2.1])\n\n| Component Type\n| Microservice (Domain Service)\n\n| Technology Stack\n| <<key-technology-decisions,DEC-001 Implementation>>\n\n| Hosting Platform\n| <<key-technology-decisions,DEC-002 Hosting>>\n\n| API Contract\n| <<key-technology-decisions,DEC-005 Transport>> - See xref:../specifications/REST/loyalty-service-v1.yaml[OpenAPI 3.0 Specification]\n\n| Batch Processing\n| <<key-technology-decisions,DEC-012 Batch Processing>>\n\n| Authentication\n| <<key-technology-decisions,DEC-011 Authentication>>\n\n| Observability\n| <<key-technology-decisions,DEC-016 Observability>>\n\n| Configuration\n| <<key-technology-decisions,DEC-014 Configuration>>\n\n| Health Checks\n| `/health` HTTPS endpoint\n\n| Deployment Unit\n| <<key-technology-decisions,DEC-017 Deployment>>\n|===\n\n==== Capabilities\n\n===== Loyalty Credential Resolution\n\n* Resolves EAN-13 barcodes from xref:../bounded_context/interfaces/otr_pos.adoc[OTR POS] and xref:../bounded_context/interfaces/otr_plus_pos.adoc[OTR+ POS] scanners to xref:../ubiquitous_language.adoc#viva-consumer-id-vci[Viva Consumer Id (VCI)]\n* Supports all xref:../ubiquitous_language.adoc#loyalty-credential[Loyalty Credential] types:\n** Barcode from xref:../bounded_context/interfaces/mobile.adoc[OTR Mobile],\n** Barcode from xref:../bounded_context/interfaces/mobile.adoc[SPS Mobile],\n** xref:../bounded_context/interfaces/mobile.adoc[Apple/Google Wallet passes],\n** Physical Flybuys cards,\n** Flybuys Mobile barcodes\n* Resolved Loyalty Credentials to\n** Direct resolution for OTR credentials (barcode → VCI)\n** Indirect resolution for Flybuys credentials (barcode → PartnerLink → VCI)\n* Returns customer context (VCI, reward preference, wallet ID) to POS within 500ms p95 (xref:../architecture_definitions/flybuys_integration.adoc#non-functional-requirements[NFR-002])\n\n==== Dependencies\n\n[cols=\"2,3,5\"]\n|===\n| SBB ID | Dependency | Reason\n\n| <<SBB-004 Loyalty Service Database,SBB-004>>\n| xref:../bounded_context/loyalty.adoc[Loyalty Service] Database\n| xref:../ubiquitous_language.adoc#reward-transaction[RewardTransaction] aggregate persistence\n\n| <<SBB-001 Profile Service API,SBB-001>>\n| xref:../bounded_context/profile.adoc[Profile Service] API\n| PartnerLink lookup for Flybuys credential resolution\n\n| <<SBB-006 Domain Event Bus,SBB-006>>\n| Domain Event Bus\n| Consuming xref:../specifications/JSON%2520Schemas/Partnerlinked.event.schema.json[Partnerlinked] events, publishing xref:../specifications/JSON%2520Schemas/TransactionAdjudicated.event.schema.json[TransactionAdjudicated] events (see xref:../specifications/AsyncAPI/otr-event-bus-v1.yaml[AsyncAPI Spec])\n\n| <<SBB-007 Flybuys Integration Adapter,SBB-007>>\n| xref:../bounded_context/external/flybuys.adoc[Flybuys Integration Adapter]\n| Balance queries, batch file transmission\n\n| <<SBB-008 EagleEye Integration Adapter,SBB-008>>\n| xref:../bounded_context/external/eagle_eye.adoc[EagleEye Integration Adapter]\n| Transaction Adjudication, wallet queries\n\n| <<SBB-010 API Gateway,SBB-010>>\n| xref:../bounded_context/interfaces/api_gateway.adoc[API Gateway]\n| Ingress routing for mobile app and POS systems\n\n| <<SBB-013 Distributed Cache,SBB-013>>\n| Distributed Cache\n| Caching Flybuys balance queries\n|===\n\n\n<<<\n=== SBB-004: Loyalty Service Database\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| ABB Reference\n| xref:../bounded_context/loyalty.adoc[Loyalty Service] Data Store\n\n| Database Type\n| NoSQL Document Database\n\n| Product\n| <<key-technology-decisions,DEC-003>>\n\n| Consistency\n| Session consistency (eventual consistency acceptable for audit trail)\n\n| Partition Strategy\n| Partition key: `/vivaConsumerId` (enables single-partition transaction queries)\n\n| Throughput\n| Autoscale: 1000-20000 RU/s (higher peak for POS transaction volume)\n\n| Geo-Replication\n| xref:../architecture_definitions/flybuys_integration.adoc#Constraints[CON-011]\n\n| Backup\n| Continuous backup (7-day point-in-time recovery)\n\n| TTL\n| 2592000 seconds (30 days) - automatic deletion for RewardTransaction documents\n\n| Indexes\n| Default indexing + range index on `/transactionDate DESC` for recent queries\n\n| Containers\n| `reward-transactions` (audit trail with 30-day TTL)\n\n| Data Residency\n| xref:../architecture_definitions/flybuys_integration.adoc#Constraints[CON-011]\n|===\n\n\n<<<\n=== SBB-005: OAuth Token Manager\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| ABB Reference\n| OAuth Service (Infrastructure)\n\n| Component Type\n| Infrastructure Service (OAuth provider + secure token storage)\n\n| Token Storage\n| <<key-technology-decisions,DEC-005>>\n\n| Token Format\n| https://www.oauth.com/oauth2-servers/access-tokens/\n\n| Secret Naming\n| `\\{partner}-token-{vivaConsumerId}` (e.g., `flybuys-token-vci_xyz789abc`)\n\n| Refresh Logic\n| Azure Function (Timer trigger every 50 minutes, before 60-minute expiry)\n\n| Encryption\n|\n|===\n\n==== OAuth Token Refresh Flow\n\nSee detailed sequence diagrams in #oauth-token-refresh-flow[Sequence Diagrams] for error scenarios including token expiry and API unavailability.\n\n[mermaid]\n----\nsequenceDiagram\n    autonumber\n    participant Timer as Azure Function<br/>(Timer Trigger)\n    participant TokenManager as OAuth Token Manager\n    participant KeyVault as Azure Key Vault\n    participant FlybuysOAuth as Flybuys OAuth Server\n    participant DB as Profile Database\n    participant Monitor as Monitoring\n\n    Note over Timer,Monitor: Timer trigger: Every 50 minutes\n\n    Timer->>TokenManager: Trigger token refresh job\n\n    activate TokenManager\n    TokenManager->>DB: Query PartnerLinks<br/>WHERE partner=\"FLYBUYS\" AND status=\"linked\"\n    activate DB\n    DB-->>TokenManager: 10,000 active PartnerLinks\n    deactivate DB\n\n    loop For each PartnerLink (batch of 100)\n        TokenManager->>KeyVault: Get token<br/>SecretName: flybuys-token-{vci}\n        activate KeyVault\n        KeyVault-->>TokenManager: {access_token, refresh_token, expiresAt}\n        deactivate KeyVault\n\n        TokenManager->>TokenManager: Check: expiresAt - now < 10 minutes?\n\n        alt Token expiring soon\n            TokenManager->>FlybuysOAuth: POST /token<br/>{grant_type: \"refresh_token\", refresh_token}\n            activate FlybuysOAuth\n            FlybuysOAuth->>FlybuysOAuth: Validate refresh_token\n            FlybuysOAuth-->>TokenManager: {access_token (new), refresh_token (new), expires_in: 3600}\n            deactivate FlybuysOAuth\n\n            TokenManager->>KeyVault: Update secret<br/>flybuys-token-{vci}\n            activate KeyVault\n            KeyVault-->>TokenManager: Secret updated\n            deactivate KeyVault\n\n            TokenManager->>Monitor: Metric: token_refresh_success\n        else Token still valid\n            TokenManager->>Monitor: Metric: token_refresh_skipped\n        end\n    end\n\n    TokenManager-->>Timer: Job complete<br/>Refreshed: 8,500 tokens<br/>Skipped: 1,500 tokens\n    deactivate TokenManager\n\n    Timer->>Monitor: Log job duration: 45 seconds\n----\n\n==== Dependencies\n\n[cols=\"2,2,4\"]\n|===\n| SBB ID | Dependency | Reason\n\n| <<SBB-001 Profile Service API,SBB-001>>\n| xref:../bounded_context/profile.adoc[Profile Service]\n| Initiates OAuth flow, stores `oauthTokenReference` in PartnerLink\n\n| External\n| OAuth Provider\n| Flybuys OAuth API integration\n|===\n\n\n<<<\n=== SBB-006: Domain Event Bus\n\n==== Event Specifications\n\nSee xref:../specifications/AsyncAPI/otr-event-bus-v1.yaml[AsyncAPI 2.6.0 Specification] for complete event definitions, schemas, and examples. Individual event schemas available in xref:../specifications/JSON%2520Schemas[JSON Schemas directory].\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| ABB Reference\n| Domain Event Bus\n\n| Platform\n| <<key-technology-decisions,DEC-004>>\n\n| Retention\n| 7 days (with dead letter queue for failed deliveries)\n\n| Schema Registry\n| <<key-technology-decisions,DEC-020>>\n\n| Delivery Guarantee\n| At-least-once delivery with retry (max 30 attempts, exponential backoff)\n\n| Monitoring\n| <<key-technology-decisions,DEC-007>>\n|===\n\n===== Topics\n\n*Profile Events* (`profile.events` topic)\n\n[cols=\"2,3,1\"]\n|===\n| Event Name | Description | Schema\n\n| `PartnerLinked`\n| Partner account linked to customer profile\n| PartnerLinked event schema[Schema]\n\n| `PartnerUnlinked`\n| Partner account unlinked from customer\n| xref:../specifications/JSON%2520Schemas/PartnerUnlinked.event.schema.json[Schema]\n\n| `RewardPreferenceChanged`\n| Customer changed reward preference selection\n| xref:../specifications/JSON%2520Schemas/RewardPreferenceChanged.event.schema.json[Schema]\n|===\n\n*Loyalty Events* (`loyalty.events` topic)\n\n[cols=\"2,3,1\"]\n|===\n| Event Name | Description | Schema\n\n| `CustomerProfileCreated`\n| Customer profile created during Just-In-Time Integration\n| xref:../specifications/JSON%2520Schemas/CustomerProfileCreated.event.schema.json[Schema]\n\n| `TransactionAdjudicated`\n| Transaction Adjudication completed\n| xref:../specifications/JSON%2520Schemas/TransactionAdjudicated.event.schema.json[Schema]\n\n| `PointsEarned`\n| Points earned in loyalty programme\n| xref:../specifications/JSON%2520Schemas/PointsEarned.event.schema.json[Schema]\n\n| `FuelDiscountApplied`\n| Fuel discount applied to transaction\n| xref:../specifications/JSON%2520Schemas/FuelDiscountApplied.event.schema.json[Schema]\n\n| `RewardTransactionFailed`\n| Transaction adjudication failed\n| xref:../specifications/JSON%2520Schemas/RewardTransactionFailed.event.schema.json[Schema]\n\n| `PointsRedeemed`\n| Points redeemed in loyalty programme\n| _Planned_\n\n| `PointsExpired`\n| Points expired\n| _Planned_\n\n| `GrantIssued`\n| Loyalty grant issued\n| _Planned_\n\n| `GrantRedeemed`\n| Loyalty grant redeemed\n| _Planned_\n\n| `FlybuysPointsEarned`\n| Points earned in Flybuys programme\n| _Planned_\n\n| `FlybuysBalanceUpdated`\n| Flybuys points balance changed\n| _Planned_\n\n| `PartnerAccountlinked`\n| Flybuys member linked (OAuth complete)\n| _Planned_\n\n| `PartnerAccountUnlinked`\n| Flybuys member unlinked\n| _Planned_\n\n| `DailyPointsFileGenerated`\n| Daily partner points file generated\n| _Planned_\n\n| `DailyPointsFileTransmitted`\n| Daily points file sent to partner\n| _Planned_\n\n| `DailyPointsFileAcknowledged`\n| Partner acknowledged file receipt\n| _Planned_\n|===\n\n==== Event Documentation\n\nSee xref:../specifications/AsyncAPI/otr-event-bus-v1.yaml[AsyncAPI Specification] for complete event definitions with examples, or xref:../bounded_context/loyalty.cml[Bounded Context/loyalty.cml] for CML domain model. CloudEvents 1.0 specification used for all domain events.\n\n==== Event Propagation Timeline\n\nSee detailed sequence diagrams in #event-propagation-timeline[Sequence Diagrams] for out-of-order event handling and version-based conflict resolution.\n\n[mermaid]\n----\nsequenceDiagram\n    autonumber\n    participant Mobile as Mobile App\n    participant Profile as Profile Service\n    participant EventBus as Event Bus\n    participant Loyalty as Loyalty Service\n    participant Engagement as Engagement Service\n\n    Note over Mobile,Engagement: T=0: OAuth linking completes\n\n    Mobile->>Profile: POST /partners\n    activate Profile\n    Profile->>Profile: Store PartnerLink (status: linked)\n    Profile->>Profile: Commit database transaction\n\n    Note over Profile: T+50ms: Transaction committed\n\n    Profile->>EventBus: Publish Partnerlinked event<br/>{vivaConsumerId, partner, externalMemberId}\n    activate EventBus\n    EventBus->>EventBus: Persist event (durability guarantee)\n    EventBus-->>Profile: Event ID: evt-123456\n    deactivate EventBus\n\n    Profile-->>Mobile: 201 Created {PartnerLinkId}\n    deactivate Profile\n\n    Note over EventBus: T+100ms: Event persisted\n\n    par Parallel Event Delivery\n        EventBus->>Loyalty: Deliver Partnerlinked event\n        activate Loyalty\n        Loyalty->>Loyalty: Update reward preference cache<br/>(vivaConsumerId → FLYBUYS_POINTS)\n        Loyalty-->>EventBus: ACK\n        deactivate Loyalty\n\n        Note over Loyalty: T+200ms: Cache updated\n    and\n        EventBus->>Engagement: Deliver Partnerlinked event\n        activate Engagement\n        Engagement->>Engagement: Trigger welcome campaign<br/>\"Earn Flybuys points at OTR\"\n        Engagement-->>EventBus: ACK\n        deactivate Engagement\n\n        Note over Engagement: T+500ms: Campaign triggered\n    end\n\n    Note over Mobile,Engagement: Eventual consistency achieved within 500ms\n----\n\n==== Event Flow\n\n[cols=\"2,3\"]\n|===\n| From | To\n\n| xref:../bounded_context/profile.adoc[Profile Service]\n| xref:../bounded_context/loyalty.adoc[Loyalty Service]\n\n| xref:../bounded_context/profile.adoc[Profile Service]\n| xref:../bounded_context/engagement.adoc[Engagement Service]\n\n| xref:../bounded_context/profile.adoc[Profile Service]\n| xref:../bounded_context/recommendation.adoc[Recommendation Service]\n\n| xref:../bounded_context/loyalty.adoc[Loyalty Service]\n| xref:../bounded_context/engagement.adoc[Engagement Service]\n\n| xref:../bounded_context/loyalty.adoc[Loyalty Service]\n| xref:../bounded_context/recommendation.adoc[Recommendation Service]\n|===\n\n\n<<<\n=== SBB-007: Engagement Service API\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| ABB Reference\n| Engagement Service (Bounded Context)\n\n| Component Type\n| Microservice (Event Consumer + Anti-Corruption Layer)\n\n| Implementation\n| <<key-technology-decisions,DEC-001>>\n\n| Hosting\n| <<key-technology-decisions,DEC-002>>\n\n| Database\n| <<sbb-008-engagement-service-database,SBB-008>>\n\n| Event Subscriptions\n| `profile.events.*`, `loyalty.events.*` (all Profile and Loyalty domain events)\n\n| External Integration\n| xref:../bounded_context/external/braze.adoc[Braze] (via ACL)\n|===\n\n==== Responsibilities\n\n* *Event Relay*: Relay domain events to xref:../bounded_context/external/braze.adoc[Braze] webhooks to enable transactional Customer communications\n** *Event-Driven Campaign Triggers*: Consumes domain events from Profile Service and Loyalty Service\n** *Braze Anti-Corruption Layer*: Translates OTRG domain events into xref:../bounded_context/external/braze.adoc[Braze] webhook payloads\n** *Customer Notification Orchestration*: Triggers push notifications, emails, in-app messages\n* *Campaign State Management*: Tracks campaign eligibility and notification delivery status\n\n==== Key Events Consumed\n\n[cols=\"1,2,3\"]\n|===\n| Event Source | Event Name | Campaign Trigger\n\n| Profile Service\n| `Partnerlinked`\n| Welcome campaign: \"_You're earning Flybuys points now!_\"\n\n| Profile Service\n| `RewardPreferenceChanged`\n| Confirmation: \"_Reward preference updated_\"\n\n| Loyalty Service\n| `TransactionAdjudicated`\n| Transaction confirmation: \"_You earned 150 Flybuys pts_\"\n\n| Loyalty Service\n| `PointsEarned`\n| Points milestone: \"_You've earned 1000 points this week_\"\n\n| Loyalty Service\n| `RewardTransactionFailed`\n| Error notification: \"_Transaction processing delayed_\"\n|===\n\n\n<<<\n=== SBB-008: Engagement Service Database\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| ABB Reference\n| Engagement Service Data Store\n\n| Platform\n| <<key-technology-decisions,DEC-003>>\n\n| Purpose\n| Campaign state tracking, notification delivery history\n\n| Data Residency\n| Australia East (primary), Australia Southeast (failover)\n\n| Retention\n| 90 days (notification history), indefinite (campaign state)\n|===\n\n\n<<<\n=== SBB-009: Braze Integration Adaptor\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| ABB Reference\n| Braze ACL\n\n| Component Type\n| Data Egress Anti-Corruption Layer (ACL) - Conformist pattern\n\n| Implementation\n| Referenced by xref:../bounded_context/engagement.adoc[Engagement Service]\n\n| External APIs\n| Braze REST API v3 (User Tracking API)\n\n| Webhook URL\n| `\\https://rest.iad-06.braze.com/`\n\n| Endpoint\n| xref:https://www.braze.com/docs/api/endpoints/user_data/post_user_track/[`/users/track`]\n\n| Circuit Breaker\n| 5 consecutive failures → open circuit, 30s timeout\n\n| Retry Policy\n| Exponential backoff: 3 retries (2s, 4s, 8s delays) for transient failures (5xx errors)\n\n| API Key Management\n| API key stored in Azure Key Vault\n\n| Rate Limits\n| 250 requests/minute per API key (Braze SLA)\n\n| Event Processing Latency\n| <500ms p95 (from Event Bus delivery to Braze webhook trigger)\n\n| Braze Webhook Timeout\n| 5 seconds (with retry logic)\n\n| Event Throughput\n| 1000 events/minute sustained\n|===\n\n==== Dependencies\n\n[cols=\"2,2,3\"]\n|===\n| SBB ID | Dependency | Reason\n\n| <<sbb-006-domain-event-bus,SBB-006 Domain Event Bus>>\n| Event subscriptions\n| Consumes Partnerlinked, TransactionAdjudicated events\n\n| xref:../bounded_context/profile.adoc[Profile Service]\n| Customer profile\n| Enriches event data with customer attributes (optional)\n|===\n\n\n<<<\n=== SBB-010: Flybuys Integration Adaptor\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| ABB Reference\n| Flybuys ACL\n\n| Component Type\n| Anti-Corruption Layer (ACL) - Conformist pattern (reference ADR-003 in ADD)\n\n| Implementation\n| #TBD# (referenced by xref:../bounded_context/loyalty.adoc[Loyalty Service], conforms to Flybuys API)\n\n| External APIs\n| Flybuys OAuth API, Balance API (`GET /v1/members/\\{id}/balance`), Docket API\n\n| Batch SFTP\n| #TBD# (Batch processing with SFTP connector, SSH key auth, PGP 2048-bit encryption)\n\n| Circuit Breaker\n| #TBD#\n\n| Caching\n| #TBD# (Distributed cache, 5-minute TTL for balance queries, reduces Flybuys API load)\n\n| Retry Policy\n| Exponential backoff: 3 retries (2s, 4s, 8s delays) for transient failures\n|===\n\n*Flybuys Implementation*: `FlybuysPointsServiceAdapter` (conforms to Flybuys CSV batch file spec v3.2)\n\n\n<<<\n=== SBB-011: EagleEye Integration Adaptor\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| ABB Reference\n| EagleEye ACL\n\n| Component Type\n| Anti-Corruption Layer (ACL)\n\n| Implementation\n| #TBD#(referenced by xref:../bounded_context/loyalty.adoc[Loyalty Service])\n\n| External APIs\n| EagleEye REST API v3 (wallet, campaigns, Transaction Adjudication)\n\n| Circuit Breaker\n| #TBD# (5 consecutive failures → open circuit, 30s timeout)\n\n| Retry Policy\n| Exponential backoff: 3 retries (2s, 4s, 8s delays)\n\n| API Key Management\n| API key stored in #TBD# (secure key vault service)\n\n| Rate Limits\n| 1000 requests/minute per API key (EagleEye SLA)\n|===\n\n\n<<<\n=== SBB-012: Application Monitoring\n\n[cols=\"1,3\"]\n|===\n| MAttribute | Specification\n\n| ABB Reference\n| Monitoring & Observability\n\n| Platform\n| xref:#Key_Technology_Decisions[DEC-007]\n\n| Application Insights\n| #TBD# (Workspace-based shared across xref:../bounded_context/profile.adoc[Profile Service], xref:../bounded_context/loyalty.adoc[Loyalty Service])\n\n| Instrumentation\n| #TBD# (SDK for distributed tracing, OpenTelemetry support)\n\n| Log Aggregation\n| Structured logging (Serilog) → #TBD# (centralized log aggregation with query language)\n\n| Metrics\n| Custom metrics: API latency (p50/p95/p99), OAuth success rate, batch file acknowledgement rate\n\n| Distributed Tracing\n| W3C Trace Context standard (see <<Correlation ID Propagation Specification,Correlation ID Specification>>)\n\n| Dashboards\n| #TBD# (Flybuys Integration Health, Customer Adoption Metrics dashboards)\n|===\n\n*Alerting*:\n\n* Critical: xref:../bounded_context/profile.adoc[Profile Service] API error rate > 5% → PagerDuty (on-call architect)\n* Critical: Batch file generation fails → Immediate alert to xref:../bounded_context/loyalty.adoc[Loyalty Service] team\n* Warning: Flybuys API latency > 3s p95 → Slack alert\n\n\n<<<\n=== SBB-013: API Gateway\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| ABB Reference\n| API Gateway\n\n| Platform\n| xref:#Key_Technology_Decisions[DEC-008]\n\n| Base URL\n| `\\https://api.otr.com.au`\n\n| Authentication\n| xref:#Key_Technology_Decisions[DEC-011]\n\n| Rate Limiting\n| 1000 requests/minute per user, 10000 requests/minute global\n\n| Policies\n| JWT validation, rate limiting, CORS, request/response transformation\n\n| TLS\n| xref:#Key_Technology_Decisions[DEC-019]\n|===\n\n\n<<<\n=== SBB-014: OTR Mobile App\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| ABB Reference\n| Mobile Application (Presentation Layer)\n\n| Platform\n| xref:#Key_Technology_Decisions[DEC-011]\n\n| Deployment\n| App Store (iOS), Google Play (Android)\n\n| Authentication\n| xref:#Key_Technology_Decisions[DEC-011]\n|===\n\n==== Integration\n\n[cols=\"2,3\"]\n|===\n| Integration | Description\n\n| <<SBB-001 Profile Service API,SBB-001 Profile Service API>>\n| Partner linking\n\n| <<SBB-003 Loyalty Service API,SBB-003 Loyalty Service API>>\n| Balance queries / Transaction history\n|===\n\n\n<<<\n=== SBB-015: Batch File Pipeline\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| ABB Reference\n| Batch Processing\n\n| Orchestration\n| #TBD# (Batch pipeline scheduled 01:00 UTC daily)\n\n| Generation Logic\n| #TBD# (Serverless functions for transaction aggregation)\n\n| SFTP Transfer\n| #TBD# (SFTP connector with SSH key authentication)\n\n| PGP Encryption\n| #TBD# (PGP encryption activity, Flybuys 2048-bit RSA public key)\n\n| File Format\n| CSV (UTF-8 with BOM, CRLF line endings, max 200MB / 100k transactions)\n\n| Acknowledgement\n| #TBD# (SFTP polling to read acknowledgement file from Flybuys)\n\n| Batch File Naming\n| `OTR_TRANSACTIONS_\\{YYYYMMDD}_{HHMMSS}.csv.pgp`\n|===\n\n==== Batch File Processing Flow\n\nSee detailed sequence diagrams in #batch-file-retry-flow[Sequence Diagrams] for happy path and error scenarios.\n\n[mermaid]\n----\nsequenceDiagram\n    autonumber\n    participant Scheduler as Azure Data Factory<br/>(Batch Scheduler)\n    participant Loyalty as Loyalty Service\n    participant DB as Loyalty Database\n    participant SFTP as Flybuys SFTP\n    participant Flybuys as Flybuys Processing\n    participant Monitor as Monitoring\n\n    Note over Scheduler,Monitor: Nightly batch window: 01:00-02:00 UTC\n\n    Scheduler->>Loyalty: Timer trigger: 01:00 UTC<br/>Start batch job\n\n    activate Loyalty\n    Loyalty->>DB: Query RewardTransactions<br/>WHERE status=\"PENDING\"<br/>AND transactionDate=yesterday\n    activate DB\n    DB-->>Loyalty: 10,000 transactions\n    deactivate DB\n\n    Note over Loyalty: Aggregate by externalMemberId\n\n    Loyalty->>Loyalty: Generate CSV<br/>Format: memberId,date,points,storeId\n    Loyalty->>Loyalty: PGP encrypt with Flybuys public key\n    Loyalty->>Loyalty: Generate filename<br/>OTR_TRANSACTIONS_20251212_010000.csv.pgp\n\n    Loyalty->>SFTP: Upload batch file<br/>(15 minutes, 2MB file)\n    activate SFTP\n    SFTP-->>Loyalty: Upload complete\n    deactivate SFTP\n\n    Loyalty->>DB: Update RewardTransactions<br/>SET batchFileId=\"OTR_TRANSACTIONS_20251212_010000.csv.pgp\"\n    activate DB\n    DB-->>Loyalty: 10,000 rows updated\n    deactivate DB\n\n    Loyalty-->>Scheduler: Job complete (duration: 60 min)\n    deactivate Loyalty\n\n    Scheduler->>Monitor: Log success metric<br/>batch_file_generation_duration_seconds\n\n    Note over Flybuys: Flybuys processes file (2-4 hours)\n\n    Flybuys->>SFTP: Upload acknowledgement file<br/>OTR_TRANSACTIONS_20251212_010000.ack\n\n    Note over Scheduler,Monitor: Acknowledgement polling (every 30 minutes)\n\n    Scheduler->>Loyalty: Poll for acknowledgement\n    activate Loyalty\n    Loyalty->>SFTP: Check for .ack file\n    activate SFTP\n    SFTP-->>Loyalty: Found: 9,800 accepted, 200 rejected\n    deactivate SFTP\n\n    Loyalty->>DB: Update status=\"COMPLETED\" (9,800 rows)<br/>SET status=\"FAILED\" (200 rows)\n    activate DB\n    DB-->>Loyalty: Updates complete\n    deactivate DB\n\n    Loyalty-->>Scheduler: Acknowledgement processed\n    deactivate Loyalty\n\n    Scheduler->>Monitor: Log metric<br/>batch_acknowledgement_rate=98%\n----\n\n\n<<<\n=== SBB-016: Distributed Cache\n\n*ABB Reference*: Caching Layer (for Flybuys balance queries)\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| Platform\n| #TBD# (In-memory distributed cache)\n\n| Purpose\n| Cache Flybuys balance queries (5-minute TTL, reduces external API load)\n\n| Eviction Policy\n| Volatile-ttl (evict keys with shortest TTL when memory full)\n\n| Persistence\n| Not enabled (cache can be regenerated from Flybuys API)\n\n| Cache Key Format\n| `flybuys:balance:\\{externalMemberId}` (e.g., `flybuys:balance:123456789012`)\n|===\n\n==== Circuit Breaker Pattern\n\nThe distributed cache works in conjunction with circuit breakers to provide graceful degradation when external APIs fail.\n\nSee detailed sequence diagrams in #circuit-breaker-state-transitions[Sequence Diagrams] for complete state transition flows.\n\n[mermaid]\n----\nstateDiagram-v2\n    [*] --> Closed: Initial state\n\n    Closed --> Open: 5 consecutive failures\n    Closed --> Closed: Success (reset failure count)\n\n    Open --> HalfOpen: 30 seconds elapsed\n\n    HalfOpen --> Closed: Success\n    HalfOpen --> Open: Failure\n\n    Open --> Open: All requests rejected\n\n    note right of Closed\n        Normal operation\n        Requests pass through\n        Track failure count\n    end note\n\n    note right of Open\n        Fail fast\n        Return cached response\n        No calls to external API\n    end note\n\n    note right of HalfOpen\n        Test recovery\n        Single request allowed\n        Decide: Closed or Open\n    end note\n----\n\n\n<<<\n=== SBB-017: Feature Flag Service\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| ABB Reference\n| Feature Toggle Management (see xref:../architecture_definitions/flybuys_integration.adoc#Technology%2520Capability%2520Requirements[Architecture Definition §3.2.2])\n\n| Component Type\n| Infrastructure Service\n\n| Technology Stack\n| <<key-technology-decisions,DEC-014 Configuration / Feature Flags>>\n\n| Purpose\n| Dynamic feature control without code deployment, progressive rollout, instant rollback\n\n| Flag Definitions\n| See xref:../architecture_definitions/flybuys_integration.adoc#Feature%2520Flag%2520Register[Feature Flag Register] for all flags\n\n| Deployment Schedule\n| See <<Transition Phase Matrix,Transition Phase Matrix>> for rollout by architecture state\n\n| Rollback Procedures\n| See <<Rollback Strategy,Rollback Strategy>> for flag-based rollback procedures\n|===\n\n*Operational Characteristics*:\n\n* *Evaluation Frequency*: Real-time flag evaluation on each request (no caching)\n* *Update Propagation*: Flag changes propagate within 5 seconds across all service instances\n* *Monitoring*: Flag state changes logged with correlation IDs, dashboards per flag showing usage metrics\n* *Access Control*: Flag management restricted to designated roles (Platform Team, Product Owner, Operations Team per flag)\n\n<<<\n=== SBB-018: Location\n\n<<<\n== Data Architecture\n\nThis section defines the logical and physical data models for Solution Building Blocks.\n\n=== Physical Data Models\n\n==== Profile Service - PartnerLink Document Schema\n\n===== JSON Schema\n\nSee xref:../specifications/JSON%2520Schemas/PartnerLink.schema.json[PartnerLink.schema.json] for complete schema specification including field definitions, type constraints, and validation rules.\n\n===== Database Configuration\n\n*Container*: `partner-links` +\n*Partition Key*: `/vivaConsumerId` +\n*Document Type*: JSON (NoSQL document database)\n\n===== Key Fields\n\n* `id`: Unique document identifier (GUID)\n* `PartnerLinkId`: Aggregate root identifier (GUID)\n* `vivaConsumerId`: Partition key, Salesforce VCI (e.g., vci_xyz789abc)\n* `partner`: Enum - FLYBUYS | SHELL_CARD | AFL | BUDGET_DIRECT\n* `status`: Enum - linking_IN_PROGRESS | linked | UNlinked | FAILED\n* `externalMemberId`: Partner member ID (e.g., Flybuys 12-digit number)\n* `rewardPreference`: Enum - FLYBUYS_POINTS | OTR_FUEL_DISCOUNT | SHELL_PRICE_SAVE\n* `linkedAt` / `unlinkedAt`: ISO8601 timestamps\n* `oauthTokenReference`: Key Vault secret identifier\n* `metadata`: Document metadata (createdAt, updatedAt, version)\n* `_etag`: Database concurrency token\n\n===== Example Document\n\n[source,json]\n----\n{\n  \"id\": \"pl_a1b2c3d4-e5f6-7890-abcd-ef1234567890\",\n  \"PartnerLinkId\": \"a1b2c3d4-e5f6-7890-abcd-ef1234567890\",\n  \"vivaConsumerId\": \"vci_xyz789abc\",\n  \"partner\": \"FLYBUYS\",\n  \"status\": \"linked\",\n  \"externalMemberId\": \"123456789012\",\n  \"rewardPreference\": \"FLYBUYS_POINTS\",\n  \"linkedAt\": \"2025-12-09T10:30:00Z\",\n  \"unlinkedAt\": null,\n  \"oauthTokenReference\": \"flybuys-token-vci_xyz789abc\",\n  \"metadata\": {\n    \"createdAt\": \"2025-12-09T10:30:00Z\",\n    \"updatedAt\": \"2025-12-09T10:30:00Z\",\n    \"version\": 1\n  },\n  \"_etag\": \"\\\"0x8DCDEF123456\\\"\"\n}\n----\n\n===== Indexes\n\n* Primary: `/id` (automatic)\n* Partition key: `/vivaConsumerId` (automatic)\n* Composite: `[/partner ASC, /status ASC]` (custom - query all Flybuys linked partners)\n\n===== Constraints\n\n* `vivaConsumerId`: Required, must match pattern `^vci_[a-zA-Z0-9]\\{10,}$`\n* `partner`: Required, must be valid enum value\n* `status`: Required, must be valid enum value\n* `externalMemberId`: Required if status = linked\n* `rewardPreference`: Required if status = linked\n* Uniqueness: One linked partner per (vivaConsumerId, partner) combination\n\n==== Loyalty Service - RewardTransaction Document Schema\n\n===== JSON Schema\n\nSee xref:../specifications/JSON%2520Schemas/RewardTransactionDocument.schema.json[RewardTransactionDocument.schema.json] for complete schema specification including field definitions, nested structures, type constraints, and validation rules.\n\n===== Database Configuration\n\n*Container*: `reward-transactions` +\n*Partition Key*: `/vivaConsumerId` +\n*TTL*: 2592000 seconds (30 days) +\n*Document Type*: JSON (NoSQL document database)\n\n===== Key Fields\n\n* `id`: Unique document identifier (GUID)\n* `transactionId`: Aggregate root identifier (GUID)\n* `vivaConsumerId`: Partition key\n* `externalTransactionId`: D365 Commerce transaction ID\n* `transactionDate`: ISO8601 timestamp\n* `storeId`: OTR store identifier\n* `rewardPreference`: Enum - FLYBUYS_POINTS | OTR_FUEL_DISCOUNT\n* `grants[]`: Array of reward grants (grantId, partner, grantType, amount, description)\n* `transaction`: Transaction details (totalAmount, paymentMethod)\n* `partnerPosting`: Partner posting status (Flybuys batch file details)\n* `status`: Enum - PENDING | COMPLETED | FAILED\n* `metadata`: Document metadata (createdAt, ttl)\n* `_etag`: Database concurrency token\n\n===== Example Document\n\n[source,json]\n----\n{\n  \"id\": \"rt_b2c3d4e5-f6a7-8901-bcde-f12345678901\",\n  \"transactionId\": \"b2c3d4e5-f6a7-8901-bcde-f12345678901\",\n  \"vivaConsumerId\": \"vci_xyz789abc\",\n  \"externalTransactionId\": \"D365_TXN_20251209_001234\",\n  \"transactionDate\": \"2025-12-09T14:30:00Z\",\n  \"storeId\": \"OTR001\",\n  \"rewardPreference\": \"FLYBUYS_POINTS\",\n  \"grants\": [\n    {\n      \"grantId\": \"grt_c3d4e5f6-a7b8-9012-cdef-123456789012\",\n      \"partner\": \"FLYBUYS\",\n      \"grantType\": \"POINTS\",\n      \"amount\": 150,\n      \"description\": \"Base points: 100, Bonus points: 50 (fuel purchase campaign)\"\n    }\n  ],\n  \"transaction\": {\n    \"totalAmount\": 75.50,\n    \"paymentMethod\": \"CREDIT_CARD\"\n  },\n  \"partnerPosting\": {\n    \"flybuys\": {\n      \"posted\": true,\n      \"batchFileId\": \"OTR_TRANSACTIONS_20251210_010000.csv.pgp\",\n      \"postedAt\": \"2025-12-10T01:15:00Z\",\n      \"retryCount\": 0\n    }\n  },\n  \"status\": \"COMPLETED\",\n  \"metadata\": {\n    \"createdAt\": \"2025-12-09T14:30:00Z\",\n    \"ttl\": 2592000\n  },\n  \"_etag\": \"\\\"0x8DCDEF789012\\\" - database concurrency token\"\n}\n----\n\n===== Indexes\n\n* Primary: `/id` (automatic)\n* Partition key: `/vivaConsumerId` (automatic)\n* Range: `/transactionDate DESC` (custom - query recent transactions)\n\n===== Constraints\n\n* `vivaConsumerId`: Required\n* `externalTransactionId`: Required, must be unique\n* `transactionDate`: Required, cannot be future-dated\n* `grants`: Array must contain at least one grant\n* TTL: Automatically deleted 30 days after creation (audit trail summary only)\n\n==== OAuth Token Storage Schema (Key Vault)\n\n===== JSON Schema\n\nSee xref:../specifications/JSON%2520Schemas/OAuthTokenStorageSchema.schema.json[OAuthTokenStorageSchema.schema.json] for complete schema specification including OAuth token structure, expiration rules, and metadata requirements.\n\n===== Key Vault Configuration\n\n*Service*: #TBD# (Secure key vault service) +\n*Secret Naming Convention*: `\\{partner}-token-{vivaConsumerId}`\n\n===== Secret Value (JSON) - Key Fields\n\n* `accessToken`: OAuth access token (JWT, ~2KB)\n* `refreshToken`: OAuth refresh token\n* `expiresAt`: ISO8601 timestamp (60 minutes from issuance)\n* `scope`: OAuth scopes granted (e.g., member:read member:balance)\n* `tokenType`: Bearer\n\n===== Example Secret\n\n*Name*: `flybuys-token-vci_xyz789abc`\n\n*Value*:\n\n[source,json]\n----\n{\n  \"accessToken\": \"eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...\",\n  \"refreshToken\": \"rt_abc123def456...\",\n  \"expiresAt\": \"2025-12-09T15:30:00Z\",\n  \"scope\": \"member:read member:balance member:dockets\",\n  \"tokenType\": \"Bearer\"\n}\n----\n\n===== Metadata\n\n* Content Type: `application/json`\n* Enabled: `true`\n* Activation Date: Token creation timestamp\n* Expiration Date: 90 days (refresh token expiry)\n* Tags: `{ \"partner\": \"FLYBUYS\", \"vivaConsumerId\": \"vci_xyz789abc\" }`\n\n===== Encryption\n\nAES-256 with customer-managed keys (compliance with CON-003)\n\n<<<\n== Interface Specifications\n\nThis section defines the contracts between Solution Building Blocks - REST APIs, domain events, and data formats.\n\n=== Complete API Documentation\n\nSee xref:../specifications/README.md[Specifications README] for comprehensive documentation on OpenAPI, AsyncAPI, JSON Schemas, tooling, versioning, and validation.\n\n=== REST API\n\n[cols=\"2,3,2\"]\n|===\n| Service | OpenAPI Spec | Endpoints\n\n| Profile Service\n| xref:../specifications/REST/profile-service-v1.yaml[profile-service-v1.yaml]\n| 6 endpoints (profile creation, profile retrieval, partner linking, preference management)\n\n| Loyalty Service\n| xref:../specifications/REST/loyalty-service-v1.yaml[loyalty-service-v1.yaml]\n| 5 endpoints (credential resolution, transaction adjudication, balance queries)\n|===\n\n=== Domain Events\n\n==== AsyncAPI Specification\n\nxref:../specifications/AsyncAPI/otr-event-bus-v1.yaml[otr-event-bus-v1.yaml] - Complete event bus specification with 9 domain events, CloudEvents 1.0 structure, message examples, and channel definitions.\n\n==== Event Schemas\n\nAll domain events use JSON Schema definitions in xref:../specifications/JSON%2520Schemas[JSON Schemas directory]. See <<sbb-006-domain-event-bus,SBB-006>> for event catalogue.\n\n==== API Versioning Policy\n\nAll REST APIs exposed by ProfileService and LoyaltyService follow this versioning policy to manage API evolution while maintaining backwards compatibility for consumers (Mobile Application, POS systems).\n\n===== Version Numbering\n\n*URI Versioning*: Major version included in URI path (`/api/v1/`, `/api/v2/`)\n\n*Format*: `/api/v{major}/\\{resource}`\n\n*Examples*:\n\n* `/api/v1/loyalty/credentials/resolve`\n* `/api/v2/profile/customers`\n\n*Version Components*:\n\n* *Major version* (v1, v2, v3): Breaking changes to API contract\n* *Minor version* (not in URI): Additive changes, backwards compatible\n* *Patch version* (not in URI): Bug fixes, no contract changes\n\n===== When to Version\n\n*Major Version Bump (v1 → v2)* - Breaking changes requiring new URI:\n\n[cols=\"2,3,1\"]\n|===\n| Change Type | Example | Requires v2?\n\n| Remove field from response\n| Delete `walletId` from credential resolution response\n| ✓ Yes\n\n| Rename field\n| `rewardPreference` → `preferredReward`\n| ✓ Yes\n\n| Change field type\n| `linkedAt` from string to DateTime object\n| ✓ Yes\n\n| Add required request field\n| Add required `storeType` parameter\n| ✓ Yes\n\n| Change HTTP method\n| `POST` → `PUT` for same resource\n| ✓ Yes\n\n| Change status codes\n| `404` → `422` for partner not linked\n| ✓ Yes\n\n| Remove endpoint\n| Delete `GET /api/v1/legacy-endpoint`\n| ✓ Yes\n|===\n\n*Minor Version (No URI change)* - Backwards compatible additions:\n\n[cols=\"2,3,1\"]\n|===\n| Change Type | Example | Requires v2?\n\n| Add optional request field\n| Add optional `includeBalance` query parameter\n| ✗ No\n\n| Add new response field\n| Add `partnerTier` to credential resolution response\n| ✗ No\n\n| Add new endpoint\n| Add `POST /api/v1/loyalty/batch/validate`\n| ✗ No\n\n| Add new HTTP header\n| Add `X-Request-Priority` header support\n| ✗ No\n\n| Expand enum values\n| `rewardPreference` adds `SHELL_PRICE_SAVE` option\n| ✗ No\n|===\n\n*Patch Version* - Internal only, not visible to API consumers:\n\n* Bug fixes that don't change contract\n* Performance improvements\n* Internal refactoring\n\n===== Parallel Version Support\n\n*Support Duration*: Both versions supported in parallel until deprecated version reaches sunset date\n\n*Versioning Lifecycle*:\n\n. Release new major version with breaking changes\n. Run both versions in parallel during deprecation period\n. Sunset deprecated version after migration window\n. Remove deprecated version after grace period\n\n*Infrastructure*:\n\n* Both versions deployed simultaneously (same service, route-based dispatch)\n* Shared business logic where possible (avoid duplicate implementations)\n* Feature flags: `ProfileService.API.v1.Enabled`, `ProfileService.API.v2.Enabled`\n\n===== Deprecation Notification\n\n*HTTP Headers* (included in deprecated version responses):\n\n[source,http]\n----\nHTTP/1.1 200 OK\nDeprecation: true\nSunset: <sunset-date>\nxref: </api/v2/profile/customers>; rel=\"successor-version\"\nContent-Type: application/json\n----\n\n*Header Definitions*:\n\n* `Deprecation: true` - API version is deprecated (RFC 8594)\n* `Sunset: \\{date}` - Date when API will be removed (RFC 8594)\n* `xref: \\{url}; rel=\"successor-version\"` - URL of replacement API\n\n*OpenAPI Specification*:\n\n[source,yaml]\n----\nopenapi: 3.0.0\ninfo:\n  title: Profile Service API\n  version: 1.0.0\n  x-api-deprecation:\n    deprecated: true\n    sunset: \"<sunset-date>\"\n    successorVersion: \"2.0.0\"\n    migrationGuide: \"https://docs.otr.com.au/api/migration/v1-to-v2\"\n----\n\n*Consumer Communication Sequence*:\n\n. Release notes published with breaking changes documented\n. Email notification to API consumers with migration guide\n. Deprecation headers added to deprecated version responses\n. Warning logs enabled for deprecated version usage\n. Final migration reminder before sunset\n. Sunset date reached (API returns `410 Gone`)\n. Hard removal after grace period\n\n===== Version Discovery\n\n*API Root Endpoint*: `GET /api/versions`\n\n[source,json]\n----\n{\n  \"versions\": [\n    {\n      \"version\": \"1.0\",\n      \"status\": \"deprecated\",\n      \"sunsetDate\": \"<sunset-date>\",\n      \"baseUrl\": \"/api/v1\",\n      \"documentation\": \"https://docs.otr.com.au/api/v1\"\n    },\n    {\n      \"version\": \"2.0\",\n      \"status\": \"current\",\n      \"sunsetDate\": null,\n      \"baseUrl\": \"/api/v2\",\n      \"documentation\": \"https://docs.otr.com.au/api/v2\"\n    }\n  ],\n  \"recommended\": \"2.0\"\n}\n----\n\n*Status Values*:\n\n* `current`: Recommended version, fully supported\n* `supported`: Older version, still functional, no new features\n* `deprecated`: Scheduled for removal, sunset date published\n* `sunset`: No longer accepting requests, returns `410 Gone`\n\n===== Consumer Compatibility\n\n*Mobile Application*:\n\n* iOS/Android apps pin to specific API version\n* App Store updates required for major version migrations\n* Migration coordinated with mobile app release cycles\n\n*POS Systems*:\n\n* Store rollout requires coordinated deployment\n* POS configuration updated via D365 Commerce central config\n* API version specified in POS tenant configuration\n* Gradual rollout strategy to minimize disruption\n\n*Backward Compatibility Guarantee*:\n\n* Deprecated version contract remains stable during parallel support period\n* No breaking changes to deprecated version during support window\n* Bug fixes backported to deprecated version during support period\n\n===== Error Response for Sunset APIs\n\n*After Sunset Date* (`410 Gone`):\n\n[source,json]\n----\n{\n  \"error\": {\n    \"code\": \"API_VERSION_SUNSET\",\n    \"message\": \"API v1 has been sunset. Please migrate to v2.\",\n    \"sunsetDate\": \"<sunset-date>\",\n    \"successorVersion\": \"2.0\",\n    \"migrationGuide\": \"https://docs.otr.com.au/api/migration/v1-to-v2\"\n  }\n}\n----\n\n*HTTP Status*: `410 Gone` (permanent redirect, cache-safe)\n\n===== Semantic Versioning Alignment\n\nWhile URI versioning uses major version only, OpenAPI specs follow semantic versioning:\n\n* *OpenAPI spec version*: `2.3.1` (semver)\n* *API URI version*: `/api/v2/` (major only)\n\n*Mapping*:\n\n* OpenAPI `2.0.0` → URI `/api/v2/`\n* OpenAPI `2.1.0` → URI `/api/v2/` (additive change, no URI change)\n* OpenAPI `2.1.5` → URI `/api/v2/` (bug fix, no URI change)\n* OpenAPI `3.0.0` → URI `/api/v3/` (breaking change, new URI)\n\n==== Loyalty Credential Resolution API\n\n*Endpoint*: `POST /api/v1/loyalty/credentials/resolve`\n\n*Purpose*: Resolves EAN-13 barcodes scanned at xref:../bounded_context/interfaces/otr_pos.adoc[OTR POS] and xref:../bounded_context/interfaces/otr_plus_pos.adoc[OTR+ POS] to customer identity and context for Transaction Adjudication.\n\n*Request*:\n\n[source,json]\n----\n{\n  \"barcode\": \"1234567890123\",\n  \"storeId\": \"OTR001\",\n  \"transactionId\": \"TXN_20251211_001234\"\n}\n----\n\n*Request Schema*:\n\n[cols=\"1,1,1,3\"]\n|===\n| Field | Type | Required | Validation\n\n| `barcode`\n| string\n| Yes\n| Must match pattern `^\\d\\{13}$` (EAN-13)\n\n| `storeId`\n| string\n| Yes\n| Must be registered OTR store (OTR001-OTR999)\n\n| `transactionId`\n| string\n| Yes\n| Unique transaction identifier from POS\n|===\n\n*Response* (200 OK):\n\n[source,json]\n----\n{\n  \"vivaConsumerId\": \"vci_xyz789abc\",\n  \"rewardPreference\": \"FLYBUYS_POINTS\",\n  \"walletId\": \"wallet_123456\",\n  \"linkedPartners\": [\"FLYBUYS\"],\n  \"credentialType\": \"FLYBUYS_CARD\"\n}\n----\n\n*Response Schema*:\n\n[cols=\"1,1,4\"]\n|===\n| Field | Type | Description\n\n| `vivaConsumerId`\n| string\n| Viva Consumer ID from Salesforce Contact (customer identity)\n\n| `rewardPreference`\n| string\n| Enum: `FLYBUYS_POINTS` \\| `OTR_FUEL_DISCOUNT` \\| `SHELL_PRICE_SAVE`\n\n| `walletId`\n| string\n| EagleEye wallet identifier\n\n| `linkedPartners`\n| string[]\n| List of linked partner codes (e.g., `[\"FLYBUYS\", \"SHELL\"]`)\n\n| `credentialType`\n| string\n| Enum: `OTR_MOBILE` \\| `SPS_MOBILE` \\| `WALLET_PASS` \\| `FLYBUYS_CARD` \\| `FLYBUYS_MOBILE`\n|===\n\n*Error Responses*:\n\n[cols=\"1,2,3\"]\n|===\n| Status | Error Code | Description\n\n| 400\n| `INVALID_BARCODE`\n| Barcode format invalid (not 13 digits)\n\n| 404\n| `CREDENTIAL_NOT_FOUND`\n| Barcode not recognized or customer not enrolled\n\n| 422\n| `PARTNER_NOT_linked`\n| Flybuys credential presented but not linked to OTR profile\n\n| 500\n| `RESOLUTION_FAILED`\n| Internal error during resolution\n|===\n\n*Resolution Logic*:\n\n. *OTR credentials* (OTR Mobile, SPS Mobile, Apple/Google Wallet):\n** Barcode encodes OTR member ID\n** Direct lookup: OTR member ID → VCI\n** Query xref:../bounded_context/profile.adoc[Profile Service]: `GET /api/v1/profile/customers?memberId=\\{otrMemberId}`\n. *Flybuys credentials* (Physical card, Flybuys Mobile):\n** Barcode encodes Flybuys 12-digit member number\n** Extract member number from EAN-13 barcode\n** Query xref:../bounded_context/profile.adoc[Profile Service]: `GET /api/v1/profile/partner-links?partner=FLYBUYS&externalMemberId=\\{flybuysNumber}`\n** Retrieve VCI from PartnerLink aggregate\n** If no PartnerLink found → return `422 PARTNER_NOT_linked`\n\n*Performance Requirements*:\n\n* *Latency*: p95 < 500ms (xref:../architecture_definitions/flybuys_integration.adoc#Non-Functional%2520Requirements[NFR-002])\n* *Throughput*: 500 concurrent requests/sec (peak POS load across 500+ stores)\n* *Availability*: 99.9% uptime (max 4.3 hours downtime/month)\n\n==== Customer Profile Creation API\n\n*Endpoint*: `POST /api/v1/profile/customers`\n\n*Purpose*: Creates a new customer profile, retrieves VCI from Salesforce, and provisions an EagleEye wallet. Used by the xref:../ubiquitous_language.adoc#just-in-time-integration[Just-In-Time Integration] during customer login (TS-1 Foundation).\n\n*Request*:\n\n[source,json]\n----\n{\n  \"email\": \"customer@example.com\",\n  \"firstName\": \"John\",\n  \"lastName\": \"Smith\",\n  \"phone\": \"+61412345678\",\n  \"rewardPreference\": \"OTR_FUEL_DISCOUNT\"\n}\n----\n\n*Request Schema*:\n\n[cols=\"1,1,1,3\"]\n|===\n| Field | Type | Required | Validation\n\n| `email`\n| string\n| Yes\n| Valid email format (used for Salesforce Contact upsert as external key)\n\n| `firstName`\n| string\n| No\n| Customer first name\n\n| `lastName`\n| string\n| No\n| Customer last name\n\n| `phone`\n| string\n| No\n| Customer phone number\n\n| `rewardPreference`\n| string\n| No\n| Enum: `OTR_FUEL_DISCOUNT` \\| `FLYBUYS_POINTS` \\| `SHELL_PRICE_SAVE` (defaults to `OTR_FUEL_DISCOUNT`)\n|===\n\n*Response* (201 Created):\n\n[source,json]\n----\n{\n  \"vivaConsumerId\": \"vci_xyz789abc\",\n  \"salesforceContactId\": \"003Dn000001234ABC\",\n  \"rewardPreference\": \"OTR_FUEL_DISCOUNT\",\n  \"createdAt\": \"2025-12-09T10:30:00Z\",\n  \"status\": \"ACTIVE\"\n}\n----\n\n*Response Schema*:\n\n[cols=\"1,1,4\"]\n|===\n| Field | Type | Description\n\n| `vivaConsumerId`\n| string\n| Viva Consumer ID from Salesforce Contact (customer identity)\n\n| `salesforceContactId`\n| string\n| Salesforce Contact record ID\n\n| `rewardPreference`\n| string\n| Default reward preference\n\n| `createdAt`\n| string (ISO 8601)\n| Profile creation timestamp\n\n| `status`\n| string\n| Enum: `ACTIVE` \\| `SUSPENDED` \\| `CLOSED`\n|===\n\n*Error Responses*:\n\n[cols=\"1,2,3\"]\n|===\n| Status | Error Code | Description\n\n| 409\n| `PROFILE_ALREADY_EXISTS`\n| Customer profile already exists for this email (idempotent)\n\n| 503\n| `EAGLEEYE_UNAVAILABLE`\n| EagleEye wallet creation failed\n\n| 503\n| `SALESFORCE_UNAVAILABLE`\n| Salesforce Contact upsert failed\n|===\n\n*Business Rules*:\n\n* Retrieves Viva Consumer ID (VCI) from Salesforce Contact upsert response\n* Uses email address as external key for Salesforce Contact upsert\n* Upserts Salesforce Contact record using email (creates if doesn't exist, updates if exists)\n* Publishes `CustomerProfileCreated` domain event (consumed by LoyaltyService for wallet creation)\n* Returns `409 Conflict` if profile already exists for this email (idempotent operation)\n* Transaction is atomic - if Salesforce upsert fails, entire transaction is rolled back\n* *Clean DDD*: ProfileService does NOT create EagleEye wallet (LoyaltyService owns loyalty enrollment)\n\n*Event-Driven Integration*:\n\n* *LoyaltyService* subscribes to `CustomerProfileCreated` event\n* *LoyaltyService* creates EagleEye wallet asynchronously\n* *LoyaltyService* publishes `CustomerEnrolledInLoyalty` event with walletId\n* *Mobile App* can poll `GET /api/v1/profile/customers/{vivaConsumerId}` or subscribe to enrollment completion\n\n*Performance Requirements*:\n\n* *Latency*: p95 < 300ms (Salesforce Contact upsert only - wallet creation is asynchronous)\n* *Used during login flow* - fast profile creation, loyalty enrollment completes in background\n* *Availability*: 99.9% uptime (critical for customer onboarding)\n\n*Orchestration Flow (ProfileService)*:\n\n. Check if profile already exists for this email address\n. Upsert Salesforce Contact record using email as external key (create if new, update if exists)\n. Retrieve Viva Consumer ID (VCI) from Salesforce Contact upsert response\n. Create Customer aggregate in ProfileService database (VCI, email, Salesforce link)\n. Publish `CustomerProfileCreated` domain event to Event Bus\n. Return profile details with VCI (without walletId - comes later from LoyaltyService)\n\n==== Customer Profile Retrieval API\n\n*Endpoint*: `GET /api/v1/profile/customers/{vivaConsumerId}`\n\n*Purpose*: Retrieves customer profile details by Viva Consumer ID. Used by LoyaltyService during transaction adjudication to get reward preferences and wallet information.\n\n*Request Parameters*:\n\n[cols=\"1,1,1,3\"]\n|===\n| Parameter | Type | Required | Validation\n\n| `vivaConsumerId`\n| string (path)\n| Yes\n| Must be valid VCI identifier (format: vci_*)\n|===\n\n*Response* (200 OK):\n\n[source,json]\n----\n{\n  \"vivaConsumerId\": \"vci_xyz789abc\",\n  \"salesforceContactId\": \"003Dn000001234ABC\",\n  \"walletId\": \"wallet_123456\",\n  \"rewardPreference\": \"FLYBUYS_POINTS\",\n  \"createdAt\": \"2025-12-09T10:30:00Z\",\n  \"status\": \"ACTIVE\"\n}\n----\n\n*Response Schema*:\n\n[cols=\"1,1,4\"]\n|===\n| Field | Type | Description\n\n| `vivaConsumerId`\n| string\n| Viva Consumer ID from Salesforce Contact (customer identity)\n\n| `salesforceContactId`\n| string\n| Salesforce Contact record ID\n\n| `walletId`\n| string\n| EagleEye wallet identifier\n\n| `rewardPreference`\n| string\n| Customer's current reward preference\n\n| `createdAt`\n| string (ISO 8601)\n| Profile creation timestamp\n\n| `status`\n| string\n| Enum: `ACTIVE` \\| `SUSPENDED` \\| `CLOSED`\n|===\n\n*Error Responses*:\n\n[cols=\"1,2,3\"]\n|===\n| Status | Error Code | Description\n\n| 401\n| `UNAUTHORIZED`\n| Authentication failed\n\n| 404\n| `CUSTOMER_NOT_FOUND`\n| Customer profile does not exist for this VCI\n|===\n\n*Performance Requirements*:\n\n* *Latency*: p95 < 200ms\n* *Availability*: 99.9% uptime\n* *Cache Strategy*: Response can be cached for 5 minutes\n\n*Usage Examples*:\n\n* Transaction adjudication: `GET /api/v1/profile/customers/{vivaConsumerId}/reward-preference`\n* Customer lookup: `GET /api/v1/profile/customers?memberId={otrMemberId}`\n* Profile details retrieval: `GET /api/v1/profile/customers/{vivaConsumerId}`\n\n=== Domain Events\n\n*AsyncAPI Specification*: `Specifications/AsyncAPI/otr-event-bus-v1.yaml`\n\n*Event Standard*: CloudEvents 1.0 (https://cloudevents.io/)\n\n*Architecture Pattern*: Open Host Service + Published Language\n\nAll domain events follow the CloudEvents 1.0 specification and are defined with JSON Schema validation. Event schemas are maintained as separate JSON Schema files to ensure consistency and enable tooling integration (validation, code generation, documentation).\n\n==== Event Catalogue\n\n[cols=\"1,1,1,1,3\"]\n|===\n| Event | Channel | Source | JSON Schema | Description\n\n| `Partnerlinked`\n| `profile.events`\n| `/profile-service`\n| xref:../specifications/JSON%2520Schemas/Partnerlinked.event.schema.json[Partnerlinked.event.schema.json]\n| Customer successfully linked coalition partner account (Flybuys, Shell Card)\n\n| `PartnerUnlinked`\n| `profile.events`\n| `/profile-service`\n| xref:../specifications/JSON%2520Schemas/PartnerUnlinked.event.schema.json[PartnerUnlinked.event.schema.json]\n| Customer unlinked coalition partner account\n\n| `PartnerLinkFailed`\n| `profile.events`\n| `/profile-service`\n| xref:../specifications/JSON%2520Schemas/PartnerLinkFailed.event.schema.json[PartnerLinkFailed.event.schema.json]\n| Partner linking attempt failed (OAuth error, invalid credentials)\n\n| `RewardPreferenceChanged`\n| `profile.events`\n| `/profile-service`\n| xref:../specifications/JSON%2520Schemas/RewardPreferenceChanged.event.schema.json[RewardPreferenceChanged.event.schema.json]\n| Customer changed reward preference (Flybuys points ↔ OTR fuel discount)\n\n| `CustomerProfileCreated`\n| `profile.events`\n| `/profile-service`\n| xref:../specifications/JSON%2520Schemas/CustomerProfileCreated.event.schema.json[CustomerProfileCreated.event.schema.json]\n| Customer profile created during Just-In-Time Integration (VCI from Salesforce). Triggers loyalty enrollment.\n\n| `CustomerEnrolledInLoyalty`\n| `loyalty.events`\n| `/loyalty-service`\n| xref:../specifications/JSON%2520Schemas/CustomerEnrolledInLoyalty.event.schema.json[CustomerEnrolledInLoyalty.event.schema.json]\n| Customer enrolled in loyalty program (EagleEye wallet created). Published in response to CustomerProfileCreated.\n\n| `TransactionAdjudicated`\n| `loyalty.events`\n| `/loyalty-service`\n| xref:../specifications/JSON%2520Schemas/TransactionAdjudicated.event.schema.json[TransactionAdjudicated.event.schema.json]\n| Transaction adjudicated, rewards calculated and granted\n\n| `PointsEarned`\n| `loyalty.events`\n| `/loyalty-service`\n| xref:../specifications/JSON%2520Schemas/PointsEarned.event.schema.json[PointsEarned.event.schema.json]\n| Customer earned Flybuys points on transaction\n\n| `FuelDiscountApplied`\n| `loyalty.events`\n| `/loyalty-service`\n| xref:../specifications/JSON%2520Schemas/FuelDiscountApplied.event.schema.json[FuelDiscountApplied.event.schema.json]\n| Customer received OTR fuel discount on transaction\n\n| `RewardTransactionFailed`\n| `loyalty.events`\n| `/loyalty-service`\n| xref:../specifications/JSON%2520Schemas/RewardTransactionFailed.event.schema.json[RewardTransactionFailed.event.schema.json]\n| Transaction adjudication failed (system error, API timeout)\n|===\n\n==== Event Consumers\n\n[cols=\"1,2,3\"]\n|===\n| Bounded Context | Subscribed Events | Responsibility\n\n| *Loyalty Service*\n| `Partnerlinked`, `RewardPreferenceChanged`\n| Updates adjudication rules based on partner linking and preference changes\n\n| *Engagement Service*\n| `Partnerlinked`, `PartnerLinkFailed`, `RewardPreferenceChanged`, `CustomerProfileCreated`, `TransactionAdjudicated`, `PointsEarned`, `FuelDiscountApplied`\n| Sends customer notifications (linking confirmation, points earned, welcome messages)\n\n| *Recommendation Service*\n| `Partnerlinked`, `RewardPreferenceChanged`, `CustomerProfileCreated`\n| Updates personalization engine based on customer loyalty profile changes\n\n| *Analytics Service*\n| `TransactionAdjudicated`, `PointsEarned`, `FuelDiscountApplied`\n| Tracks reward transactions for business intelligence and reporting\n|===\n\n==== Event Delivery Guarantees\n\n*Delivery Semantics*: At-least-once delivery (Event Bus guarantees)\n\n*Retry Policy*:\n\n* Initial retry: Immediate\n* Subsequent retries: Exponential backoff (2s, 4s, 8s, 16s, 32s)\n* Maximum retries: 5 attempts\n* Dead Letter Queue: After 5 failed attempts, events routed to DLQ for manual investigation\n\n*Idempotency*: All event consumers must implement idempotent processing (use `id` field for deduplication)\n\n*Ordering*: Events within the same `vivaConsumerId` partition maintain order; cross-partition ordering not guaranteed\n\n=== Correlation ID Propagation Specification\n\nAll service-to-service communication and domain events must propagate correlation IDs to enable distributed tracing and request correlation across the Flybuys Integration architecture.\n\n==== Standard\n\n*W3C Trace Context* (https://www.w3.org/TR/trace-context/)\n\n==== HTTP Propagation\n\n*Headers*:\n\n* `traceparent`: Required trace context (format: `\\{version}-{trace-id}-{parent-id}-{trace-flags}`)\n* `tracestate`: Optional vendor-specific trace data\n\n*Generation Point*: API Gateway (or Mobile Application if request originates outside API Gateway)\n\n*Example*:\n\n[source,http]\n----\nPOST /api/v1/loyalty/credentials/resolve HTTP/1.1\nHost: api.otr.com.au\ntraceparent: 00-4bf92f3577b34da6a3ce929d0e0e4736-00f067aa0ba902b7-01\ntracestate: otr=t61rcWkgMzE\nContent-Type: application/json\n----\n\n*Trace ID Format*:\n\n* `version`: `00` (current W3C version)\n* `trace-id`: 32 hex characters (128-bit globally unique identifier)\n* `parent-id`: 16 hex characters (64-bit span identifier)\n* `trace-flags`: 2 hex characters (sampling decision: `01` = sampled, `00` = not sampled)\n\n*Propagation Rules*:\n\n. *API Gateway → Service*: Generate `traceparent` if not present, forward if present\n. *Service → Service*: Preserve `trace-id`, generate new `parent-id` for span\n. *Service → External API*: Propagate `traceparent` header (Flybuys, EagleEye, Salesforce)\n\n==== Event Propagation\n\n*CloudEvents Extension*: All domain events MUST include `traceparent` as CloudEvents extension attribute\n\n*Example*:\n\n[source,json]\n----\n{\n  \"specversion\": \"1.0\",\n  \"type\": \"com.otr.profile.Partnerlinked\",\n  \"source\": \"/profile-service\",\n  \"id\": \"a1b2c3d4-e5f6-7890-abcd-ef1234567890\",\n  \"time\": \"2025-12-09T14:30:00Z\",\n  \"traceparent\": \"00-4bf92f3577b34da6a3ce929d0e0e4736-00f067aa0ba902b7-01\",\n  \"datacontenttype\": \"application/json\",\n  \"data\": {\n    \"vivaConsumerId\": \"vci_xyz789abc\",\n    \"partner\": \"FLYBUYS\"\n  }\n}\n----\n\n*Event Consumer Propagation*: Consumers MUST extract `traceparent` from event and propagate to downstream calls\n\n*Example Flow*:\n\n. POS calls `POST /api/v1/loyalty/credentials/resolve` with `traceparent: 00-\\{trace-id}-{span-1}-01`\n. LoyaltyService calls ProfileService `GET /api/v1/profile/partner-links` with `traceparent: 00-\\{trace-id}-{span-2}-01`\n. ProfileService publishes `Partnerlinked` event with `traceparent: 00-\\{trace-id}-{span-3}-01`\n. All requests share same `trace-id` (`4bf92f3577b34da6a3ce929d0e0e4736`)\n\n==== Structured Logging\n\nAll log entries MUST include correlation context:\n\n*Log Format* (JSON structured logging via Serilog):\n\n[source,json]\n----\n{\n  \"timestamp\": \"2025-12-09T14:30:00.123Z\",\n  \"level\": \"Information\",\n  \"message\": \"Credential resolution completed\",\n  \"traceId\": \"4bf92f3577b34da6a3ce929d0e0e4736\",\n  \"spanId\": \"00f067aa0ba902b7\",\n  \"service\": \"loyalty-service\",\n  \"vivaConsumerId\": \"vci_xyz789abc\",\n  \"operation\": \"ResolveCredential\"\n}\n----\n\n*Required Fields*:\n\n* `traceId`: W3C trace-id (32 hex characters)\n* `spanId`: W3C parent-id (16 hex characters)\n* `service`: Service name (profile-service, loyalty-service, etc.)\n\n*Query Example*: Find all logs for a specific request\n\n----\ntraceId = \"4bf92f3577b34da6a3ce929d0e0e4736\"\n----\n\n==== Trace Visualization\n\n*Tool*: <<SBB-009 Application Monitoring,Application Monitoring>> platform (DEC-007) must support W3C Trace Context\n\n*Expected Trace View*:\n\n----\nPOS Transaction (trace-id: 4bf92f3577b34da6a3ce929d0e0e4736)\n├─ API Gateway [50ms]\n├─ LoyaltyService.ResolveCredential [280ms]\n│  ├─ ProfileService.GetPartnerLink [120ms]\n│  │  └─ Cosmos DB Query [80ms]\n│  └─ Redis Cache Lookup [15ms]\n└─ API Gateway Response [20ms]\nTotal: 350ms\n----\n\n==== Implementation Notes\n\n*Libraries*:\n\n* .NET: `System.Diagnostics.Activity` (built-in W3C Trace Context support)\n* OpenTelemetry SDK: Auto-instrumentation for HTTP and event propagation\n\n*Sampling Strategy*:\n\n* Production: 10% sampling (`trace-flags: 01` for 1 in 10 requests)\n* UAT: 100% sampling (all requests traced)\n* Error traces: Always sampled (override sampling decision on errors)\n\n*Privacy*: `traceparent` contains no PII - safe to log and transmit\n\n=== Data Formats\n\n==== Flybuys Batch File Format (CSV)\n\nFlybuys Transaction File Format v3.2 (January 2025) - external specification\n\n===== Format\n\n[source,csv]\n----\nMEMBER_ID,TRANSACTION_DATE,TRANSACTION_TIME,STORE_CODE,TRANSACTION_ID,BASE_POINTS,BONUS_POINTS,TOTAL_AMOUNT,FUEL_LITRES\n123456789012,2025-12-09,14:30:00,OTR001,TXN123456,100,50,75.50,45.2\n123456789012,2025-12-09,15:45:00,OTR002,TXN123457,200,0,120.00,0\n----\n\n===== Field Specifications\n\n[cols=\"1,1,1,1,3\"]\n|===\n| Field | Type | Length | Format | Validation\n\n| MEMBER_ID\n| String\n| 12\n| Numeric\n| Must match Flybuys member pattern (12 digits)\n\n| TRANSACTION_DATE\n| Date\n| 10\n| YYYY-MM-DD\n| Not future-dated\n\n| TRANSACTION_TIME\n| Time\n| 8\n| HH:MM:SS\n| 24-hour format\n\n| STORE_CODE\n| String\n| 10\n| Alphanumeric\n| Must be registered OTR store (OTR001-OTR999)\n\n| TRANSACTION_ID\n| String\n| 50\n| Alphanumeric\n| Unique per file (D365 Commerce transaction ID)\n\n| BASE_POINTS\n| Integer\n| 10\n| Numeric\n| Non-negative\n\n| BONUS_POINTS\n| Integer\n| 10\n| Numeric\n| Non-negative\n\n| TOTAL_AMOUNT\n| Decimal\n| 10,2\n| 99999999.99\n| Non-negative (AUD)\n\n| FUEL_LITRES\n| Decimal\n| 10,2\n| 99999999.99\n| Optional (0 for non-fuel transactions)\n|===\n\n===== File Requirements\n\n* Encoding: UTF-8 with BOM\n* Line ending: CRLF (`\\r\\n`)\n* Header row: Required (field names as shown above)\n* Max file size: 200MB (approx. 100,000 transactions)\n* Submission deadline: 02:00 UTC daily (Flybuys SLA)\n\n===== PGP Encryption Specifications\n\n* Algorithm: RSA 2048-bit + AES-256\n* Flybuys public key ID: `0xABCD1234` (expires 2026-12-31)\n* Compression: ZIP (level 6)\n* ASCII armor: Yes (`.pgp` extension)\n\n=== Interaction Flows\n\nThis section provides sequence diagrams for critical multi-service interactions across the Flybuys Integration architecture.\n\n==== OAuth linking Flow (AS-2 linking)\n\nCustomer links their Flybuys account via OAuth 2.0 Authorization Code Flow with PKCE from the Mobile Application.\n\n[mermaid]\n----\nsequenceDiagram\n    actor Customer\n    participant Mobile as Mobile App\n    participant Gateway as API Gateway\n    participant Profile as ProfileService\n    participant OAuth as OAuth Service\n    participant Flybuys as Flybuys OAuth\n    participant EventBus as Event Bus\n    participant Loyalty as LoyaltyService\n\n    Customer->>Mobile: Tap \"link Flybuys Account\"\n    Mobile->>Mobile: Generate PKCE code_verifier & code_challenge\n    Mobile->>Gateway: GET /api/v1/profile/oauth/authorize?partner=FLYBUYS\n    Gateway->>Profile: Forward request\n    Profile->>OAuth: InitiateOAuthFlow(partner=FLYBUYS, code_challenge)\n    OAuth->>OAuth: Store code_challenge + state\n    OAuth-->>Profile: OAuth URL + state\n    Profile-->>Gateway: Redirect URL\n    Gateway-->>Mobile: 302 Redirect to Flybuys OAuth\n\n    Mobile->>Flybuys: OAuth Authorization Request\n    Flybuys->>Customer: Login & Consent Screen\n    Customer->>Flybuys: Approve consent\n    Flybuys-->>Mobile: 302 Redirect with auth_code\n\n    Mobile->>Gateway: POST /api/v1/profile/oauth/callback<br/>(auth_code, code_verifier)\n    Gateway->>Profile: Forward callback\n    Profile->>OAuth: ValidateCallback(auth_code, code_verifier)\n    OAuth->>OAuth: Verify code_challenge == hash(code_verifier)\n    OAuth->>Flybuys: POST /oauth/token<br/>(auth_code, code_verifier)\n    Flybuys-->>OAuth: access_token + refresh_token\n    OAuth->>OAuth: Encrypt tokens (AES-256)\n    OAuth->>OAuth: Store in Key Vault\n    OAuth-->>Profile: Token reference + member_id\n\n    Profile->>Profile: Create PartnerLink aggregate<br/>(vivaConsumerId, partner=FLYBUYS, externalMemberId)\n    Profile->>Profile: Set rewardPreference = FLYBUYS_POINTS\n    Profile->>EventBus: Publish Partnerlinked event\n    Profile-->>Gateway: 200 OK (linking success)\n    Gateway-->>Mobile: linking confirmation\n    Mobile->>Customer: \"Flybuys account linked!\"\n\n    EventBus->>Loyalty: Consume Partnerlinked event\n    Loyalty->>Loyalty: Update adjudication rules for customer\n\n    Note over Customer,Loyalty: Error Scenarios\n\n    alt OAuth Authorization Denied\n        Customer->>Flybuys: Deny consent\n        Flybuys-->>Mobile: 302 Redirect with error=access_denied\n        Mobile->>Gateway: POST /api/v1/profile/oauth/callback?error=access_denied\n        Gateway->>Profile: Forward error\n        Profile-->>Gateway: 400 Bad Request (user cancelled)\n        Gateway-->>Mobile: linking cancelled\n        Mobile->>Customer: \"linking cancelled\"\n    end\n\n    alt Flybuys API Failure\n        OAuth->>Flybuys: POST /oauth/token\n        Flybuys-->>OAuth: 500 Internal Server Error\n        OAuth-->>Profile: OAuth token exchange failed\n        Profile-->>Gateway: 502 Bad Gateway\n        Gateway-->>Mobile: Partner temporarily unavailable\n        Mobile->>Customer: \"Flybuys unavailable, try again later\"\n    end\n----\n\n*Key Points*:\n\n* *PKCE*: Code verifier/challenge prevents authorization code interception\n* *Token Storage*: OAuth tokens encrypted in Key Vault, ProfileService stores only reference\n* *Event Publishing*: Partnerlinked event triggers LoyaltyService adjudication rule updates\n* *Error Handling*: User cancellation vs. API failure handled differently\n\n==== Just-In-Time Profile Creation Flow (TS-1 Foundation)\n\nThis flow shows how customer profiles are created on-demand during first login using the xref:../ubiquitous_language.adoc#just-in-time-integration[Just-In-Time Integration] pattern. ProfileService creates the profile and publishes an event. LoyaltyService subscribes to this event and provisions the EagleEye wallet asynchronously (clean DDD bounded context separation).\n\n[mermaid]\n----\nsequenceDiagram\n    actor Customer\n    participant Mobile as Mobile App\n    participant Gateway as API Gateway\n    participant Profile as ProfileService\n    participant ProfileDB as Profile DB\n    participant Salesforce as Salesforce\n    participant EventBus as Event Bus\n    participant Loyalty as LoyaltyService\n    participant EagleEye as EagleEye ACL\n\n    Customer->>Mobile: Login (first time)\n    Mobile->>Gateway: Authenticate with CIAM\n    Gateway-->>Mobile: JWT token (contains email, name, etc.)\n\n    Note over Mobile: Check if profile exists\n\n    Mobile->>Gateway: POST /api/v1/profile/customers<br/>{email, firstName, lastName, phone, preference}\n    Gateway->>Profile: Forward request\n    activate Profile\n\n    Profile->>ProfileDB: Check if profile exists for email\n    ProfileDB-->>Profile: Not found\n\n    Profile->>Salesforce: UPSERT Contact using email as key<br/>{email, firstName, lastName, phone}\n    Salesforce-->>Profile: Contact upserted (contactId, vivaConsumerId)\n\n    Profile->>ProfileDB: Create Customer aggregate<br/>(VCI, email, Salesforce link)\n    ProfileDB-->>Profile: Customer created\n\n    Profile->>EventBus: Publish CustomerProfileCreated event<br/>{vivaConsumerId, salesforceContactId, email, preference}\n    EventBus-->>Profile: Event published\n\n    Profile-->>Gateway: 201 Created<br/>{vivaConsumerId, salesforceContactId, status}\n    deactivate Profile\n    Gateway-->>Mobile: Profile created successfully\n\n    Note over EventBus,Loyalty: Asynchronous Enrollment (Clean DDD)\n\n    EventBus->>Loyalty: CustomerProfileCreated event\n    activate Loyalty\n\n    Loyalty->>EagleEye: POST /wallets<br/>{vivaConsumerId}\n    EagleEye-->>Loyalty: {walletId}\n\n    Loyalty->>EventBus: Publish CustomerEnrolledInLoyalty event<br/>{vivaConsumerId, walletId}\n    EventBus-->>Loyalty: Event published\n    deactivate Loyalty\n\n    Note over Mobile,Customer: Optional: Mobile polls or subscribes for enrollment\n\n    Mobile->>Customer: Login complete - loyalty enrollment in progress\n\n    Note over Customer,EagleEye: Error Scenarios\n\n    alt Profile Already Exists for Email\n        Profile->>ProfileDB: Check if profile exists for email\n        ProfileDB-->>Profile: Profile found\n        Profile-->>Gateway: 409 Conflict (profile already exists)\n        Gateway-->>Mobile: Profile exists - use existing\n        Mobile->>Mobile: Proceed with existing profile\n    end\n\n    alt Salesforce Upsert Failed\n        Profile->>Salesforce: UPSERT Contact\n        Salesforce-->>Profile: 500 Internal Server Error\n        Profile->>Profile: Rollback transaction\n        Profile-->>Gateway: 503 Salesforce unavailable\n        Gateway-->>Mobile: Contact upsert failed\n        Mobile->>Customer: \"Unable to create profile, try again\"\n    end\n\n    alt EagleEye Wallet Creation Failed (Handled by LoyaltyService)\n        Loyalty->>EagleEye: POST /wallets\n        EagleEye-->>Loyalty: 500 Internal Server Error\n        Loyalty->>Loyalty: Retry with exponential backoff\n        Note over Loyalty: Profile exists, wallet creation will retry\n    end\n----\n\n*Key Points*:\n\n* *Just-In-Time Integration*: Profile created on first login, not during registration\n* *Clean DDD Separation*: ProfileService owns identity, LoyaltyService owns loyalty enrollment (wallet creation)\n* *Event-Driven Architecture*: `CustomerProfileCreated` event triggers asynchronous wallet creation by LoyaltyService\n* *Salesforce Upsert*: Creates Salesforce Contact if it doesn't exist, updates if it does (idempotent)\n* *ProfileService Transaction*: Profile creation and Salesforce upsert are atomic (wallet creation is decoupled)\n* *Idempotent Operation*: Returns `409 Conflict` if profile already exists (safe to retry)\n* *Eventual Consistency*: Wallet creation happens asynchronously - mobile app can poll or subscribe for completion\n* *Resilience*: LoyaltyService handles EagleEye failures independently with retry logic (doesn't block profile creation)\n* *Performance Target*: ProfileService p95 < 300ms (faster - no EagleEye dependency)\n\n==== POS Integration Flow (AS-3 Grants)\n\nxref:../bounded_context/interfaces/otr_pos.adoc[OTR POS] scans Loyalty Credential barcode to resolve customer identity before transaction.\n\n[mermaid]\n----\nsequenceDiagram\n    actor Customer\n    participant POS as D365 Commerce POS\n    participant POSACL as POS ACL Adapter<br/>(D365 → Loyalty Domain)\n    participant LoyaltyACL as Loyalty ACL Adapter\n    participant Profile as ProfileService\n    participant ProfileDB as Profile DB\n\n    Customer->>POS: Present barcode\n    POS->>POS: Scan barcode (D365 format)\n\n    Note over POS,ProfileDB: D365 → Loyalty Domain Translation\n\n    POS->>POSACL: GetLoyaltyCardData(barcode, storeId)\n    POSACL->>POSACL: Translate D365 concepts:<br/>LoyaltyCard → VivaConsumerId<br/>StoreCode → siteId<br/>TransactionId → sourceTransactionId\n    POSACL->>Loyalty: POST /api/v1/loyalty/credentials/resolve<br/>{barcode, siteId, sourceTransactionId}\n\n    alt OTR Credential (direct resolution)\n        Loyalty->>Loyalty: Parse OTR member ID from barcode\n        Loyalty->>Profile: GET /customers?memberId={otrMemberId}\n        Profile->>ProfileDB: Query by memberId\n        ProfileDB-->>Profile: Customer (VCI, rewardPreference)\n        Profile-->>Loyalty: Customer context\n    else Flybuys Credential (indirect via PartnerLink)\n        Loyalty->>Loyalty: Parse Flybuys member# from barcode\n        Loyalty->>Profile: GET /partner-links?partner=FLYBUYS&externalMemberId={flybuysNumber}\n        Profile->>ProfileDB: Query PartnerLink aggregate\n        ProfileDB-->>Profile: PartnerLink (VCI, rewardPreference)\n        Profile-->>Loyalty: Customer context\n    end\n\n    Loyalty-->>LoyaltyACL: 200 OK {vivaConsumerId, rewardPreference, walletId}\n\n    Note over POSACL,ProfileDB: Loyalty Domain → D365 Translation\n\n    LoyaltyACL->>LoyaltyACL: Translate Loyalty domain:<br/>vivaConsumerId → LoyaltyCardNumber<br/>rewardPreference → LoyaltyProgramId<br/>walletId → AccountId\n    LoyaltyACL-->>POSACL: LoyaltyResponse {CardNumber, ProgramId, AccountId}\n    POSACL-->>POS: D365 LoyaltyCardData object\n    POS->>Customer: Display: \"Welcome back, Sarah!\"\n\n    Note over Customer,ProfileDB: Error Scenarios\n\n    alt ProfileService Unavailable\n        Loyalty->>Profile: GET /customers (timeout)\n        Profile-->>Loyalty: 503 Service Unavailable\n        Loyalty-->>LoyaltyACL: 503 Service Unavailable\n        LoyaltyACL->>LoyaltyACL: Map to D365 error:<br/>503 → LoyaltyErrorCode.ServiceTemporarilyUnavailable\n        LoyaltyACL-->>POSACL: LoyaltyResponse {ErrorCode, Message}\n        POSACL-->>POS: D365 error object\n        POS->>Customer: \"Loyalty temporarily unavailable, proceed without points\"\n    end\n\n    alt Invalid Barcode Format\n        Loyalty->>Loyalty: Parse barcode (validation fails)\n        Loyalty-->>LoyaltyACL: 400 Bad Request (invalid barcode format)\n        LoyaltyACL->>LoyaltyACL: Map to D365 error:<br/>400 → LoyaltyErrorCode.InvalidCardNumber\n        LoyaltyACL-->>POSACL: LoyaltyResponse {ErrorCode}\n        POSACL-->>POS: D365 error object\n        POS->>Customer: \"Barcode not recognized\"\n    end\n\n    alt Credential Not Found\n        Loyalty->>Profile: GET /partner-links (no match)\n        Profile-->>Loyalty: 404 Not Found\n        Loyalty-->>LoyaltyACL: 404 Not Found (credential not linked)\n        LoyaltyACL->>LoyaltyACL: Map to D365 error:<br/>404 → LoyaltyErrorCode.CardNotFound\n        LoyaltyACL-->>POSACL: LoyaltyResponse {ErrorCode}\n        POSACL-->>POS: D365 error object\n        POS->>Customer: \"Card not registered, visit counter\"\n    end\n\n    alt Partner Not linked\n        Loyalty->>Profile: GET /partner-links?partner=FLYBUYS\n        Profile-->>Loyalty: 200 OK {linked: false}\n        Loyalty-->>LoyaltyACL: 200 OK {requireslinking: true}\n        LoyaltyACL->>LoyaltyACL: Map to D365 business rule:<br/>requireslinking → Prompt for enrollment\n        LoyaltyACL-->>POSACL: LoyaltyResponse {RequiresEnrollment}\n        POSACL-->>POS: D365 enrollment prompt\n        POS->>Customer: \"link Flybuys in app for points\"\n    end\n----\n\n*Key Points*:\n\n* *Bidirectional ACL*: POS ACL Adapter translates D365 Commerce → Loyalty domain; Loyalty ACL Adapter translates Loyalty domain → D365 Commerce\n* *Two Credential Types*: OTR (direct via memberId) vs Flybuys (indirect via PartnerLink aggregate)\n* *Domain Isolation*: D365 POS never sees Loyalty domain concepts (VivaConsumerId, PartnerLink, RewardPreference)\n* *Error Mapping*: Loyalty HTTP status codes and error types mapped to D365 LoyaltyErrorCode enum\n\n==== POS Transaction Adjudication Flow (AS-3 Grants)\n\nCustomer presents Loyalty Credential at POS for transaction adjudication and reward determination.\n\n[mermaid]\n----\nsequenceDiagram\n    actor Customer\n    participant POS as OTR POS\n    participant Gateway as API Gateway\n    participant Loyalty as LoyaltyService\n    participant Profile as ProfileService\n    participant ProfileDB as Profile DB\n    participant EagleEye as EagleEye ACL\n    participant EagleEyeAPI as EagleEye API\n    participant EventBus as Event Bus\n\n    Customer->>POS: Present barcode (EAN-13)\n    POS->>POS: Scan barcode: \"1234567890123\"\n\n    Note over POS,Gateway: Credential Resolution Phase\n    POS->>Gateway: POST /api/v1/loyalty/credentials/resolve<br/>{barcode, storeId, transactionId}<br/>traceparent: 00-{trace-id}-{span-1}-01\n    Gateway->>Loyalty: Forward (add correlation ID)\n    Loyalty->>Loyalty: Parse EAN-13 barcode\n\n    alt OTR Credential (barcode encodes OTR member ID)\n        Loyalty->>Profile: GET /api/v1/profile/customers?memberId={otrMemberId}\n        Profile->>ProfileDB: Query by memberId\n        ProfileDB-->>Profile: Customer record (VCI, rewardPreference)\n        Profile-->>Loyalty: Customer context\n    else Flybuys Credential (barcode encodes Flybuys member number)\n        Loyalty->>Loyalty: Extract Flybuys member# from barcode\n        Loyalty->>Profile: GET /api/v1/profile/partner-links?<br/>partner=FLYBUYS&externalMemberId={flybuysNumber}\n        Profile->>ProfileDB: Query PartnerLink aggregate\n        ProfileDB-->>Profile: PartnerLink (VCI, rewardPreference)\n        Profile-->>Loyalty: Customer context\n    end\n\n    Loyalty-->>Gateway: 200 OK {vivaConsumerId, rewardPreference, walletId}\n    Gateway-->>POS: Credential resolved (280ms p95)\n    POS->>Customer: Display name: \"Welcome back, Sarah!\"\n\n    Note over Customer,EventBus: Transaction Adjudication Phase\n    Customer->>POS: Complete purchase ($75.50)\n    POS->>Gateway: POST /api/v1/loyalty/transactions/adjudicate<br/>{vivaConsumerId, transactionId, items[], total}\n    Gateway->>Loyalty: Forward request\n\n    Loyalty->>Profile: GET /api/v1/profile/customers/{vivaConsumerId}/reward-preference\n    Profile-->>Loyalty: rewardPreference = FLYBUYS_POINTS\n\n    alt Reward Preference = FLYBUYS_POINTS\n        Loyalty->>EagleEye: POST /transactions/validate<br/>(transaction details, walletId)\n        EagleEye->>EagleEyeAPI: Forward to EagleEye AIR\n        EagleEyeAPI-->>EagleEye: Provisional rewards (150 points)\n        EagleEye-->>Loyalty: Validation response\n        Loyalty->>Loyalty: Create RewardTransaction aggregate<br/>(vivaConsumerId, flybuysPoints=150, status=PENDING)\n        Loyalty-->>Gateway: 200 OK {provisionalRewards: 150 points}\n        Gateway-->>POS: Adjudication complete\n        POS->>Customer: \"You'll earn 150 Flybuys points\"\n    else Reward Preference = OTR_FUEL_DISCOUNT\n        Loyalty->>EagleEye: POST /transactions/validate<br/>(fuel discount campaign)\n        EagleEye->>EagleEyeAPI: Check fuel discount grants\n        EagleEyeAPI-->>EagleEye: 8c/L discount available\n        EagleEye-->>Loyalty: Validation response\n        Loyalty-->>Gateway: 200 OK {fuelDiscount: 8cpl}\n        Gateway-->>POS: Adjudication complete\n        POS->>Customer: \"8c/L fuel discount applied\"\n    end\n\n    Note over POS,EventBus: Post-Payment Finalization\n    POS->>POS: Payment captured\n    POS->>Gateway: POST /api/v1/loyalty/transactions/{txnId}/redeem\n    Gateway->>Loyalty: Finalize transaction\n    Loyalty->>EagleEye: POST /transactions/redeem<br/>(confirm rewards)\n    EagleEye->>EagleEyeAPI: Finalize in EagleEye\n    EagleEyeAPI-->>EagleEye: Confirmed\n    EagleEye-->>Loyalty: Redemption complete\n\n    Loyalty->>Loyalty: Update RewardTransaction<br/>(status=CONFIRMED, finalPoints=150)\n    Loyalty->>EventBus: Publish TransactionAdjudicated event\n    Loyalty-->>Gateway: 200 OK\n    Gateway-->>POS: Transaction finalized\n\n    Note over Customer,EventBus: Error Scenarios\n\n    alt ProfileService Unavailable\n        Loyalty->>Profile: GET /api/v1/profile/partner-links\n        Profile-->>Loyalty: 503 Service Unavailable\n        Loyalty->>Loyalty: Circuit breaker OPEN\n        Loyalty-->>Gateway: 503 Service Unavailable<br/>{fallback: \"proceed without points\"}\n        Gateway-->>POS: Degraded mode\n        POS->>Customer: \"Points temporarily unavailable\"\n        POS->>POS: Complete transaction without points\n    end\n\n    alt EagleEye API Timeout\n        Loyalty->>EagleEye: POST /transactions/validate\n        EagleEye->>EagleEyeAPI: Forward request\n        Note over EagleEyeAPI: Timeout after 3s\n        EagleEye-->>Loyalty: 504 Gateway Timeout\n        Loyalty->>Loyalty: Return cached default reward\n        Loyalty-->>Gateway: 200 OK {provisionalRewards: 100 points (default)}\n        Gateway-->>POS: Adjudication complete (degraded)\n        POS->>Customer: \"You'll earn ~100 points (estimate)\"\n    end\n----\n\n*Key Points*:\n\n* *Two-phase adjudication*: Validation (pre-payment) → Redemption (post-payment)\n* *Latency budget*: 500ms p95 for credential resolution (NFR-002)\n* *Graceful degradation*: Circuit breaker returns default rewards if EagleEye slow\n* *Trace propagation*: W3C traceparent header flows through all services\n\n==== Batch File Processing Flow (AS-3 Grants)\n\nNightly batch job aggregates transactions and transmits to Flybuys via SFTP.\n\n[mermaid]\n----\nsequenceDiagram\n    participant Scheduler as Batch Scheduler<br/>(Azure Data Factory)\n    participant Loyalty as LoyaltyService<br/>(Batch Job)\n    participant LoyaltyDB as Loyalty DB\n    participant D365 as D365 Commerce<br/>(POS Transactions)\n    participant FileGen as CSV Generator\n    participant PGP as PGP Encryption\n    participant SFTP as SFTP Client\n    participant Flybuys as Flybuys SFTP Server\n    participant Monitor as Monitoring\n\n    Note over Scheduler,Monitor: Daily Batch Window: 01:00 - 02:00 UTC\n\n    Scheduler->>Scheduler: Timer trigger: 01:00 UTC\n    Scheduler->>Loyalty: Start batch job<br/>(jobId, runDate=yesterday)\n\n    Note over Loyalty,D365: Phase 1: Transaction Aggregation (01:00 - 01:20)\n    Loyalty->>LoyaltyDB: Query RewardTransactions<br/>(status=CONFIRMED, date=yesterday)\n    LoyaltyDB-->>Loyalty: 50,000 transactions\n\n    Loyalty->>D365: Query transactions for reconciliation<br/>(transactionIds[])\n    D365-->>Loyalty: Transaction details\n\n    Loyalty->>Loyalty: Aggregate by Flybuys member<br/>(group by externalMemberId)\n    Loyalty->>Loyalty: Calculate BASE_POINTS + BONUS_POINTS\n    Loyalty->>Monitor: Log progress: \"Aggregated 50k transactions\"\n\n    Note over FileGen,PGP: Phase 2: File Generation (01:20 - 01:35)\n    Loyalty->>FileGen: Generate CSV file<br/>(transactions[], filename=OTR_TRANSACTIONS_20251209_010000.csv)\n    FileGen->>FileGen: Write header row\n    FileGen->>FileGen: Write 50,000 transaction rows\n    FileGen->>FileGen: Validate file format (UTF-8 BOM, CRLF)\n    FileGen-->>Loyalty: CSV file (25MB)\n\n    Loyalty->>PGP: Encrypt file<br/>(publicKey=Flybuys_RSA_2048, compression=ZIP)\n    PGP->>PGP: Compress CSV (ZIP level 6): 25MB → 8MB\n    PGP->>PGP: Encrypt with RSA+AES-256\n    PGP->>PGP: ASCII armor (.pgp extension)\n    PGP-->>Loyalty: Encrypted file (9MB)\n    Loyalty->>Monitor: Log progress: \"File generated, size=9MB\"\n\n    Note over SFTP,Flybuys: Phase 3: SFTP Transmission (01:35 - 01:50)\n    Loyalty->>SFTP: Transmit file<br/>(OTR_TRANSACTIONS_20251209_010000.csv.pgp)\n    SFTP->>Flybuys: SSH connect + authenticate\n    Flybuys-->>SFTP: Connection established\n    SFTP->>Flybuys: PUT file (9MB, ~5 min upload)\n    Flybuys-->>SFTP: Transfer complete\n    SFTP->>Flybuys: Verify checksum (MD5)\n    Flybuys-->>SFTP: Checksum OK\n    SFTP-->>Loyalty: Upload successful\n\n    Loyalty->>LoyaltyDB: Update RewardTransactions<br/>(status=POSTED_TO_FLYBUYS, postedAt=01:45 UTC)\n    Loyalty->>Monitor: Log success: \"Batch file transmitted, size=9MB, records=50k\"\n\n    Note over Flybuys,Monitor: Phase 4: Acknowledgement (01:50 - 02:00)\n    Loyalty->>Loyalty: Wait 5 minutes for ACK file\n    Loyalty->>SFTP: Poll for acknowledgement file<br/>(OTR_TRANSACTIONS_20251209_010000.ack)\n    SFTP->>Flybuys: LIST /outbound/*.ack\n\n    alt Acknowledgement File Present\n        Flybuys-->>SFTP: ACK file found\n        SFTP->>Flybuys: GET acknowledgement file\n        Flybuys-->>SFTP: ACK file content<br/>(status=SUCCESS, records=50000)\n        SFTP-->>Loyalty: ACK file downloaded\n        Loyalty->>Loyalty: Parse ACK file\n        Loyalty->>LoyaltyDB: Update batch job status=ACKNOWLEDGED\n        Loyalty->>Monitor: Log success: \"Batch acknowledged by Flybuys\"\n        Loyalty-->>Scheduler: Job complete (duration=60 min)\n    else No Acknowledgement File\n        SFTP-->>Loyalty: ACK file not found\n        Loyalty->>Loyalty: Wait 2 minutes, retry poll\n        Loyalty->>SFTP: Poll again\n\n        alt ACK Found on Retry\n            SFTP-->>Loyalty: ACK file found (retry successful)\n            Loyalty->>Monitor: Log warning: \"ACK delayed but received\"\n            Loyalty-->>Scheduler: Job complete (duration=62 min)\n        else ACK Still Missing\n            Loyalty->>Monitor: Alert CRITICAL: \"Batch ACK missing after 10 min\"\n            Loyalty->>LoyaltyDB: Update batch job status=ACK_PENDING\n            Loyalty-->>Scheduler: Job partial success (manual follow-up required)\n        end\n    end\n\n    Note over Scheduler,Monitor: Error Scenarios\n\n    alt SFTP Upload Failure\n        SFTP->>Flybuys: PUT file\n        Flybuys-->>SFTP: 500 Internal Server Error\n        SFTP-->>Loyalty: Upload failed\n        Loyalty->>Loyalty: Exponential backoff retry (2min, 4min, 8min)\n        Loyalty->>SFTP: Retry upload (attempt 2/3)\n\n        alt Retry Successful\n            SFTP->>Flybuys: PUT file (retry)\n            Flybuys-->>SFTP: Transfer complete\n            SFTP-->>Loyalty: Upload successful\n            Loyalty->>Monitor: Log warning: \"Upload succeeded on retry 2\"\n            Loyalty-->>Scheduler: Job complete\n        else All Retries Failed\n            Loyalty->>Monitor: Alert CRITICAL: \"Batch upload failed after 3 attempts\"\n            Loyalty->>LoyaltyDB: Update batch job status=FAILED\n            Loyalty-->>Scheduler: Job failed (manual intervention required)\n        end\n    end\n\n    alt Batch Window Deadline Exceeded\n        Note over Loyalty: Current time: 01:58 UTC\n        Loyalty->>Loyalty: Check time remaining: 2 minutes\n        Loyalty->>Monitor: Alert WARNING: \"Approaching 02:00 UTC deadline\"\n        Loyalty->>SFTP: Attempt final upload (priority)\n\n        alt Upload Completes Before 02:00\n            SFTP-->>Loyalty: Upload complete 01:59 UTC\n            Loyalty->>Monitor: Log warning: \"Deadline met with 1 min margin\"\n            Loyalty-->>Scheduler: Job complete (late but within SLA)\n        else Upload Exceeds 02:00 UTC\n            Note over Loyalty: Current time: 02:02 UTC\n            SFTP-->>Loyalty: Upload complete 02:02 UTC\n            Loyalty->>Monitor: Alert CRITICAL: \"SLA breach - uploaded after 02:00 UTC deadline\"\n            Loyalty->>LoyaltyDB: Update batch job status=LATE\n            Loyalty-->>Scheduler: Job complete (SLA breach, escalate to Flybuys)\n        end\n    end\n----\n\n*Key Points*:\n\n* *Batch window*: 01:00-02:00 UTC (1-hour window for 50k-100k transactions)\n* *Four phases*: Aggregation (20 min) → Generation (15 min) → Upload (15 min) → ACK (10 min)\n* *Retry strategy*: Exponential backoff for SFTP failures (2min, 4min, 8min)\n* *SLA deadline*: 02:00 UTC submission deadline enforced by Flybuys\n* *Monitoring*: Critical alerts for ACK missing, upload failures, deadline breaches\n\n<<<\n== Transition Architecture\n\nThis section defines the phased approach to migrate from current state to target architecture, showing intermediate architecture states and technical dependencies.\n\n. *No Big-Bang Migration*: Incremental rollout using Strangler Fig pattern (reference ADR-005 in Architecture Definition)\n. *Zero Downtime*: New bounded contexts operate in parallel with legacy OTR App API during transition\n. *Feature Flag Control*: All new capabilities behind feature flags (see xref:../architecture_definitions/flybuys_integration.adoc#Feature%2520Flag%2520Register[Feature Flag Register] in Architecture Definition)\n. *Data Coexistence*: Dual-write to legacy and new systems during TS-1 Foundation phase (30 days)\n. *Rollback Capability*: Each phase independently reversible without data loss\n\n=== Transition Phase Matrix\n\nProgressive rollout of feature flags across architecture states (TS-0 → TS-1 → AS-2 → AS-3 → AS-4).\n\n*Flag Definitions*: See xref:../architecture_definitions/flybuys_integration.adoc#Feature%2520Flag%2520Register[Feature Flag Register] in Architecture Definition for complete flag purposes, ownership, and strategic rationale.\n\n[cols=\"3,1,1,1,1,1\"]\n|===\n| Flag Name | TS-0 Current | TS-1 Foundation | AS-2 linking | AS-3 Grants | AS-4 Target\n\n| +OTR.Loyalty.Enabled+\n| OFF\n| ON\n| ON\n| ON\n| ON\n\n| +OTR.Loyalty.PartnerLink.Flybuys+\n| OFF\n| OFF\n| ON\n| ON\n| ON\n\n| +OTR.Loyalty.RewardPreferenceSelection+\n| OFF\n| OFF\n| ON\n| ON\n| ON\n\n| +OTR.Loyalty.TransactionAdjudication+\n| OFF\n| OFF\n| OFF\n| ON\n| ON\n\n| +OTR.Loyalty.PointsEarn.Flybuys+\n| OFF\n| OFF\n| OFF\n| ON\n| ON\n\n| +OTR.Loyalty.FlybuysBatchPosting+\n| OFF\n| OFF\n| OFF\n| ON\n| ON\n|===\n\n*Dependencies*:\n\n* +OTR.Loyalty.PartnerLink.Flybuys+ requires +OTR.Loyalty.Enabled+ = ON\n* +OTR.Loyalty.TransactionAdjudication+ requires +OTR.Loyalty.Enabled+ = ON\n* +OTR.Loyalty.PointsEarn.Flybuys+ requires +OTR.Loyalty.TransactionAdjudication+ = ON\n\n=== Rollback Strategy\n\nFeature flags enable rapid rollback without code deployment. Each architecture state can be rolled back by disabling the corresponding flags:\n\n==== TS-1 Foundation Rollback\n\n*Trigger*: VCI migration failures, EagleEye wallet creation issues, or infrastructure instability\n\n*Actions*:\n\n. Set +OTR.Loyalty.Enabled+ = OFF (disables all loyalty features)\n. Delete customer VCI records created during pilot (data cleanup)\n. Validate legacy OTR App API is functioning normally\n\n*Impact*: Mobile app reverts to legacy loyalty features (no EagleEye integration)\n\n==== AS-2 linking Rollback\n\n*Trigger*: OAuth flow failures (>5% failure rate), Flybuys API unavailability, or customer support tickets >50/day\n\n*Actions*:\n\n. Set +OTR.Loyalty.PartnerLink.Flybuys+ = OFF (disables Flybuys linking UI)\n. Set +OTR.Loyalty.RewardPreferenceSelection+ = OFF (hides reward preference selection)\n. Communicate to pilot users via push notification and email\n\n*Impact*: Customers cannot link Flybuys accounts, balance queries disabled\n\n==== AS-3 Grants Rollback\n\n*Trigger*: POS integration failures, batch file acknowledgement rate <98%, or transaction adjudication errors\n\n*Actions*:\n\n. Set +OTR.Loyalty.TransactionAdjudication+ = OFF (reverts to legacy POS integration)\n. Set +OTR.Loyalty.PointsEarn.Flybuys+ = OFF (stops points earning)\n. Set +OTR.Loyalty.FlybuysBatchPosting+ = OFF (stops daily batch transmission)\n. Re-enable Reddy Express legacy Flybuys integration (barcode pattern matching)\n\n*Impact*: POS reverts to legacy Flybuys integration, transactions in-flight may need manual reconciliation\n\n==== Partial Rollback (Batch Posting Issues Only)\n\n*Trigger*: Flybuys batch file acknowledgement failures, SFTP transmission errors\n\n*Actions*:\n\n. Set +OTR.Loyalty.FlybuysBatchPosting+ = OFF (stops batch transmission)\n. Investigate SFTP connectivity, PGP encryption, and acknowledgement file parsing\n. Keep +OTR.Loyalty.TransactionAdjudication+ = ON (POS integration continues)\n\n*Impact*: Points not posted to Flybuys immediately, requires manual batch file regeneration and transmission\n\n=== TS-0 Current State\n\nPre-initiative architecture (reference Architecture Definition §2 Current State)\n\n==== Active Components\n\n* OTR App API (AWS Lambda, DynamoDB)\n* Reddy Express legacy loyalty (SQL Server, POS barcode matching) - Flybuys-only\n* No unified customer identity (OTR users and Reddy Express customers separate)\n* No partner integrations beyond basic xref:../ubiquitous_language.adoc#flybuys-cardholder-number[Flybuys Card] scanning\n\n==== Technical Debt\n\n* Fragmented customer identity (OTR vs Reddy Express silos)\n* No event-driven architecture (synchronous-only integrations)\n* Tight POS coupling (direct Flybuys barcode pattern matching at OTR+ stores)\n* No OAuth infrastructure (no secure third-party account linking)\n\n\n=== TS-1 Foundation\n\nEstablish xref:../bounded_context/profile.adoc[Profile Service], xref:../bounded_context/loyalty.adoc[Loyalty Service], xref:../bounded_context/interfaces/otr_app_api.adoc[Event Bus] without customer-facing features\n\n==== New SBBS\n\n[cols=\"1,3\"]\n|===\n| SBB | Description\n\n| <<sbb-001-profile-service-api,SBB-001>>\n| xref:../bounded_context/profile.adoc[Profile Service] API\n\n| <<sbb-002-profile-service-database,SBB-002>>\n| xref:../bounded_context/profile.adoc[Profile Service] Database\n\n| <<sbb-003-loyalty-service-api,SBB-003>>\n| xref:../bounded_context/loyalty.adoc[Loyalty Service] API\n\n| <<sbb-004-loyalty-service-database,SBB-004>>\n| xref:../bounded_context/loyalty.adoc[Loyalty Service] Database\n\n| <<sbb-006-domain-event-bus,SBB-006>>\n| Domain xref:../bounded_context/interfaces/otr_app_api.adoc[Event Bus] (Event Grid)\n\n| SBB-008\n| Eagle Eye[Eagle Eye] Integration Adaptor\n\n| <<sbb-012-application-monitoring,SBB-012>>\n| Application Monitoring (App Insights)\n\n| <<sbb-013-api-gateway,SBB-013>>\n| API Gateway (APIM)\n|===\n\n==== Implementation Approach\n\nEnable xref:../ubiquitous_language.adoc#customer[Customer] uplift with a xref:../ubiquitous_language.adoc#dark-launch[Dark Launch] rollout strategy. New integration runs in parallel with existing system, validating technical implementation without customer impact\n\n[cols=\"2,5\"]\n|===\n| Activity | Description\n\n| Customer Profile Creation\n| xref:../ubiquitous_language.adoc#just-in-time-integration[Just-In-Time Integration] via `POST /api/v1/profile/customers` endpoint - xref:../ubiquitous_language.adoc#otr-app[Mobile Application] calls this during login if xref:../ubiquitous_language.adoc#customer[Customer] has no xref:../ubiquitous_language.adoc#viva-consumer-id-vci[VCI], creating profile and linking to Salesforce\n\n| Wallet Provisioning\n| Orchestrated by profile creation endpoint - `POST /api/v1/profile/customers` calls EagleEye ACL to provision xref:../ubiquitous_language.adoc#wallet[EagleEye Wallet] atomically with profile creation\n\n| Dual-Write Pattern\n| xref:../ubiquitous_language.adoc#otr-app[Mobile Application] sends requests to both legacy OTR App API and new xref:../bounded_context/profile.adoc[Profile Service] / xref:../bounded_context/loyalty.adoc[Loyalty Service], while legacy remains authoritative until Loyalty Value Chain[Loyalty Value Chain]\n|===\n\n===== Architecture Diagram\n\n[mermaid]\n----\ngraph TD\n    MobileApp[Mobile App]\n    LegacyAPI[Legacy API<br/>Primary]\n    Services[Profile Service<br/>Loyalty Service<br/>pilot only, dual-write]\n    EventBus[Event Bus]\n\n    MobileApp --> LegacyAPI\n    MobileApp --> Services\n    Services --> EventBus\n----\n\n===== Rollout Strategy\n\n*Note*: See xref:../architecture_definitions/flybuys_integration.adoc#Feature%2520Flag%2520Register[Feature Flag Register] in Architecture Definition for complete feature catalogue, and <<transition-phase-matrix,Transition Phase Matrix>> above for rollout schedule.\n\n[cols=\"3,1\"]\n|===\n| Flag | Status\n\n| +OTR.Loyalty.Enabled+\n| On\n\n| +OTR.Loyalty.TransactionAdjudication+\n| Off\n\n| +OTR.Loyalty.RewardPreferenceSelection+\n| Off\n\n| +OTR.Loyalty.PartnerLink.Flybuys+\n| Off\n\n| +OTR.Loyalty.PointsEarn.Flybuys+\n| Off\n|===\n\n===== Events\n\n[cols=\"2,1\"]\n|===\n| Event | Emitted\n\n| +PointsEarned+\n| No\n\n| +FlybuysPointsRedeemed+\n| No\n\n| +TransactionAdjudicated+\n| No\n\n| +PointsEarned+\n| No\n\n| +PointsRedeemed+\n| No\n\n| +PointsExpired+\n| No\n\n| +PointsAdjusted+\n| No\n\n| +CustomerProfileCreated+\n| Yes\n\n| +MemberUnenrolled+\n| No\n\n| +GrantIssued+\n| No\n\n| +GrantRedeemed+\n| No\n|===\n\n===== Success Criteria\n\n* 100% of xref:../ubiquitous_language.adoc#otr-app[Mobile Application] xref:../ubiquitous_language.adoc#customer[Customers] have xref:../ubiquitous_language.adoc#viva-consumer-id-vci[Viva Consumer ID (VCI)] allocated in xref:../bounded_context/external/salesforce_crm.adoc[Salesforce CRM]\n* 100% of xref:../ubiquitous_language.adoc#otr-app[Mobile Application] xref:../ubiquitous_language.adoc#customer[Customers] have xref:../ubiquitous_language.adoc#wallet[Wallets] allocated in xref:../bounded_context/external/eagle_eye.adoc[EagleEye]\n* No xref:../ubiquitous_language.adoc#otr-app[Mobile Application] xref:../ubiquitous_language.adoc#customer[Customers] have a linked xref:../ubiquitous_language.adoc#flybuys-digital-identity[Flybuys Digital Identity]\n* Zero production impact\n* Zero xref:../ubiquitous_language.adoc#otr-app[Mobile Application] impacts\n\n===== Dependencies\n\n* EagleEye API credentials and rate limits confirmed (external dependency - EagleEye, 1000 req/min guaranteed)\n* Infrastructure provisioning complete (internal dependency - Platform team)\n\n==== Rollback Approach\n\n* Delete xref:../ubiquitous_language.adoc#customer[Customers] uplifted xref:../bounded_context/external/salesforce_crm.adoc[Salesforce CRM] profiles\n\n===== Feature Flags\n\n[cols=\"3,1\"]\n|===\n| Flag | Status\n\n| +OTR.Loyalty.Enabled+\n| Off\n\n| +OTR.Loyalty.TransactionAdjudication+\n| Off\n\n| +OTR.Loyalty.RewardPreferenceSelection+\n| Off\n\n| +OTR.Loyalty.PartnerLink.Flybuys+\n| Off\n\n| +OTR.Loyalty.PointsEarn.Flybuys+\n| Off\n|===\n\n\n=== AS-2 linking\n\nEnable customer-facing xref:../ubiquitous_language.adoc#partner-xref[Partner Link] and xref:../ubiquitous_language.adoc#reward-preference[Reward Preference] selection in xref:../ubiquitous_language.adoc#otr-app[Mobile Applications]\n\n==== New SBB\n\n[cols=\"1,2\"]\n|===\n| SBB | Description\n\n| SBB-005\n| OAuth Token Service\n\n| SBB-007\n| Flybuys Integration Adaptor\n\n| SBB-011\n| Mobile Application Updates\n\n| SBB-013\n| Distributed Cache\n|===\n\n==== New Capabilities\n\n* xref:../ubiquitous_language.adoc#otr-app[Mobile Application] xref:../ubiquitous_language.adoc#partner-xref[Partner link] flow (xref:../ubiquitous_language.adoc#pkce[OAuth 2.0 Authorisation Code Flow with PKCE])\n* xref:../ubiquitous_language.adoc#reward-preference[Reward preference selection UI] (Flybuys points vs OTR fuel discount)\n* Real-time Flybuys balance display in mobile app wallet screen\n\n==== Implementation Approach\n\nEnable linking for xref:../ubiquitous_language.adoc#customer[Customers] using a xref:../ubiquitous_language.adoc#ring-deployments[Ring Deployments] progressive exposure strategy\n\n===== Monitoring\n\nTrack OAuth success rate, balance query latency, customer support tickets (30-day observation period)\n\n===== Cutover\n\nAfter 30 days successful pilot (>95% OAuth success rate), enable for all xref:../ubiquitous_language.adoc#customer[Customers]\n\n===== Architecture Diagram\n\n[mermaid]\n----\ngraph TD\n    A[Mobile App] --> B[API Gateway]\n    B --> C[Profile Service]\n    B --> D[Loyalty Service]\n    C --> E[Event Bus]\n    C --> F[OAuth Service + Key Vault]\n    C --> G[Flybuys API]\n    D --> E\n    D --> F\n    D --> G\n----\n\n===== Rollout\n\n====== Ring 0 (Internal Validation)\n\nStaff accounts (50 users), 7 days\n\n* Validation: Users are in xref:../bounded_context/external/salesforce_crm.adoc[Salesforce CRM] and Braze\n* Go criteria: 100% success rate, zero P1/P2 incidents\n\n====== Ring 1 (Pilot Users)\n\nCustomers who regularly use the xref:../ubiquitous_language.adoc#otr-app[Mobile Applications], 14 days\n\n* Validation: OAuth success rate >90%, customer support tickets <10/day\n* Go criteria: Meet validation targets for 7 consecutive days\n\n====== Ring 2 (General availability)\n\nAll xref:../ubiquitous_language.adoc#otr-app[Mobile Application] Customers\n\n* Deployment: Gradual rollout using percentage targeting (10% → 50% → 100% over 14 days)\n* Monitoring: Track OAuth success rate, balance query latency, customer support tickets (30-day observation period)\n\n[cols=\"3,1\"]\n|===\n| Flag | Status\n\n| +OTR.Loyalty.Enabled+\n| On\n\n| +OTR.Loyalty.TransactionAdjudication+\n| Off\n\n| +OTR.Loyalty.RewardPreferenceSelection+\n| Off\n\n| +OTR.Loyalty.PartnerLink.Flybuys+\n| On\n\n| +OTR.Loyalty.PointsEarn.Flybuys+\n| Off\n|===\n\n===== Events\n\n[cols=\"2,1\"]\n|===\n| Event | Emitted\n\n| +Partnerlinked+\n| Yes\n\n| +PartnerUnlinked+\n| Yes\n\n| +PointsEarned+\n| No\n\n| +FlybuysPointsRedeemed+\n| No\n\n| +TransactionAdjudicated+\n| No\n\n| +PointsEarned+\n| No\n\n| +PointsRedeemed+\n| No\n\n| +PointsExpired+\n| No\n\n| +PointsAdjusted+\n| No\n\n| +CustomerProfileCreated+\n| Yes\n\n| +MemberUnenrolled+\n| No\n\n| +GrantIssued+\n| No\n\n| +GrantRedeemed+\n| No\n|===\n\n===== Dependencies\n\n* Flybuys OAuth API production credentials (external - Flybuys, confirmed Nov 2025)\n* OAuth Service provisioned with Flybuys IDP connection (internal - Platform team, Dec 2025)\n* Mobile app release with linking UI\n\n===== Success Criteria\n\n* 95% of xref:../ubiquitous_language.adoc#customer[Customers] attempting xref:../ubiquitous_language.adoc#partner-xref[Partner link] are successful\n* OAuth success rate >95% over 30-day pilot period (validation exit criterion)\n* Balance query latency < 2s p95 (NFR-003)\n* Customer support tickets < 50 related to linking issues (< 0.5% of pilot users)\n\n==== Rollback Approach\n\n* Delete xref:../ubiquitous_language.adoc#partner-xref[Partner link] from pilot xref:../ubiquitous_language.adoc#customer[Customers] (customer communication required via email/push notification)\n\n===== Feature Flags\n\n[cols=\"3,1\"]\n|===\n| Flag | Status\n\n| +OTR.Loyalty.Enabled+\n| On\n\n| +OTR.Loyalty.TransactionAdjudication+\n| Off\n\n| +OTR.Loyalty.RewardPreferenceSelection+\n| On\n\n| +OTR.Loyalty.PartnerLink.Flybuys+\n| Off\n\n| +OTR.Loyalty.PointsEarn.Flybuys+\n| Off\n|===\n\n\n=== AS-3 Grants\n\n* Enable in-store xref:../bounded_context/interfaces/otr_pos.adoc[OTR POS] and xref:../bounded_context/interfaces/otr_plus_pos.adoc[OTR+ POS] xref:../ubiquitous_language.adoc#loyalty-credential[Loyalty Credential] recognition\n* Transaction posting to Flybuys (batch files)\n* xref:../ubiquitous_language.adoc#digital-fuel-dockets[Digital Fuel Docket] redemption\n\n==== New SBB\n\n[cols=\"1,3\"]\n|===\n| SBB | Description\n\n| SBB-012\n| Batch File Pipeline (serverless functions for daily aggregation, SFTP transmission)\n|===\n\n==== Implementation Approach\n\n*POS Barcode Integration*:\n\n. Deploy +POST /api/v1/loyalty/credentials/resolve+ endpoint\n. Update POS to call Loyalty Service API on barcode scan\n. Barcode Format: EAN-13 (13-digit European Article Number standard)\n. Pre-linking Requirement: Customers must link Flybuys account via mobile app OAuth flow (AS-2)\n. Error Handling: POS displays \"Please link Flybuys in mobile app\" if unlinked Flybuys credential scanned (422 error)\n\n*Rollout Strategy*:\n\n* POS Rollout: Enable barcode scanning at pilot stores (10 OTR stores), then gradual rollout\n* Batch Processing: Daily batch file generation starts (nightly 01:00 UTC job)\n\n===== Feature Flags\n\n[cols=\"3,1\"]\n|===\n| Flag | Status\n\n| +OTR.Loyalty.Enabled+\n| On\n\n| +OTR.Loyalty.TransactionAdjudication+\n| On\n\n| +OTR.Loyalty.RewardPreferenceSelection+\n| On\n\n| +OTR.Loyalty.PartnerLink.Flybuys+\n| On\n\n| +OTR.Loyalty.PointsEarn.Flybuys+\n| On\n|===\n\n*Success Criteria*:\n\n* 100% of customer transactions post to Flybuys (batch acknowledgement rate >98%, NFR-016)\n* POS barcode resolution latency < 500ms p95 (NFR-002)\n* Digital docket redemption operational at all 500+ stores\n\n=== AS-4 Target State\n\nFinal steady-state architecture after all Flybuys Integration capabilities are deployed and stabilised.\n\n==== Success Criteria (Entry to AS-4)\n\n*Prerequisites*:\n\n* AS-3 Grants operational for minimum 6 months\n* Zero critical incidents (P1/P2) in last 90 days\n* All NFRs validated and meeting targets\n* Legacy Reddy Express Flybuys integration fully decommissioned\n\n==== Characteristics of Target State\n\n===== Feature Flags\n\n* All flags remain ON (no changes from AS-3)\n* Feature flag infrastructure retained for emergency rollback capability\n\n===== Architecture\n\n* Bounded contexts operating independently\n* Event-driven integration fully operational\n* Anti-Corruption Layers protecting domain boundaries\n* Zero coupling to legacy OTR App API\n\n=== Technical Dependency Graph\n\n[mermaid]\n----\ngraph TD\n    A[TS-1: Foundation] --> B[AS-2: linking Enabled]\n    B --> C[AS-3: Grants Operational]\n    C --> D[AS-4: Target State]\n\n    A -->|Prerequisite| E[VCI Migration Complete]\n    A -->|Prerequisite| F[EagleEye Wallets Created]\n\n    B -->|Prerequisite| G[OAuth Service Ready<br/>Flybuys IDP configured]\n    B -->|Prerequisite| H[Flybuys OAuth Credentials<br/>Production API keys]\n\n    C -->|Prerequisite| I[Flybuys SFTP Access<br/>SSH keys, PGP encryption]\n    C -->|Prerequisite| J[D365 POS Integration<br/>Barcode API ready]\n\n    D -->|Prerequisite| K[6 Months Stability<br/>No critical incidents]\n    D -->|Prerequisite| L[Legacy Data Archived<br/>7-year retention]\n----\n\n=== Transition Risks\n\n[cols=\"1,3,3,2\"]\n|===\n| Risk ID | Risk Description | Mitigation | Contingency\n\n| TR-001\n| VCI migration fails (customers lose profile data)\n| Dual-write during TS-1 (30 days), legacy remains authoritative\n| Rollback to legacy OTR App API only\n\n| TR-002\n| Flybuys OAuth service outage during rollout\n| Circuit breaker pattern, cached balance data as fallback (5-min TTL)\n| Disable linking, revert to read-only balance\n\n| TR-003\n| Batch file transmission failures (points not posted)\n| Retry logic with exponential backoff (3 attempts), manual SFTP fallback\n| Manual CSV generation and upload by data team\n\n| TR-004\n| POS barcode scanning latency unacceptable (>1s)\n| Redis caching for barcode resolution (5-min TTL), load testing in UAT\n| Revert to legacy Reddy Express POS integration\n\n| TR-005\n| Event Bus delivery failures (eventual consistency)\n| Dead letter queue monitoring (alert if >100 events), replay capability\n| Synchronous API calls as fallback (temporary)\n\n| TR-006\n| Cosmos DB autoscale insufficient (RU/s throttling)\n| Monitor 429 errors, increase max RU/s (10k → 20k), partition optimization\n| Temporarily disable non-critical features\n|===\n\n<<<\n== Solution Validation\n\nThis section defines how the solution will be validated against requirements defined in the Architecture Definition.\n\n=== Functional Validation\n\n*Business Requirements*: See xref:../architecture_definitions/flybuys_integration.adoc#Business%2520Requirements[Business Requirements] in Architecture Definition for complete requirement definitions (BR-001 through BR-012).\n\n*Validation Approach*: All business requirements validated through combination of:\n\n* UAT testing with pilot users (500 mobile app users, 100 OAuth linking attempts)\n* Production pilot at 10 stores (10k transactions monitored)\n* Automated API tests (ProfileService, LoyaltyService, EagleEye integration)\n* Manual verification of batch file generation and Flybuys acknowledgement\n\n*Key Validation Checkpoints*:\n\n* *Customer Identity (BR-001, BR-002)*: 100% users have VCI allocated in Salesforce\n* *Partner linking (BR-004)*: OAuth flow completes in <30s p95\n* *Reward Preferences (BR-005, BR-006)*: Preference changes reflected within 5s\n* *Transaction Posting (BR-007)*: Transactions appear in daily batch file with correct points\n* *Balance Display (BR-010)*: Flybuys balance query returns within 2s p95\n* *Transaction Adjudication (BR-012)*: 100% credentialed transactions route to EagleEye\n\n=== Non-Functional Validation\n\n[cols=\"1,3,3,2\"]\n|===\n| NFR ID | Validation Test | Acceptance Criteria | Tool/Method\n\n| NFR-001\n| Profile Service API latency under load\n| p95 < 200ms with 100 concurrent users\n| JMeter load test (UAT, 10k requests)\n\n| NFR-002\n| Loyalty Service API latency under load\n| p95 < 500ms with 500 concurrent POS transactions/sec\n| JMeter load test (UAT, 50k requests)\n\n| NFR-003\n| Flybuys balance query latency\n| p95 < 2s including Flybuys API call + Redis cache\n| Application Insights (PROD, 30-day avg)\n\n| NFR-004\n| Batch file generation window\n| Job starts 01:00 UTC, completes by 02:00 UTC (1-hour max)\n| Batch pipeline monitoring (PROD, 30-day avg)\n\n| NFR-006\n| Profile Service uptime\n| 99.9% measured over 30 days (max 4.3 hours downtime)\n| Azure Monitor (PROD, 30-day SLA)\n\n| NFR-016\n| Batch file acknowledgement rate\n| >98% transactions acknowledged by Flybuys within 24 hours\n| PROD monitoring (60-day avg)\n|===\n\n=== Integration Validation\n\n[cols=\"2,3,3,2\"]\n|===\n| Integration Point | Validation Test | Acceptance Criteria | Method\n\n| Flybuys OAuth API\n| OAuth flow completes with valid access token\n| Token retrieved and stored in Key Vault\n| Pact contract test (UAT)\n\n| Flybuys Balance API\n| Balance query returns valid response\n| Response matches Flybuys API spec v2.1, < 1.5s latency\n| Integration test harness (UAT)\n\n| Flybuys SFTP\n| Batch file uploads successfully\n| File appears in Flybuys /inbound/otr/ directory, PGP encrypted\n| SFTP integration test (UAT)\n\n| EagleEye Adjudication\n| Transaction adjudication returns grants\n| Response matches EagleEye API spec v3, grants correct\n| Pact contract test (UAT)\n\n| Event Grid\n| Domain events published and consumed\n| Partnerlinked event delivered to Loyalty Service < 5s\n| Event Bus integration test (UAT)\n|===\n\n=== Security Validation\n\n*Validation Method*: Penetration testing (external vendor) + Security audit (internal InfoSec team)\n\n[cols=\"2,3,3,2\"]\n|===\n| Security Control | Validation Test | Acceptance Criteria | Auditor\n\n| OAuth PKCE\n| Authorization code flow uses PKCE\n| Code challenge/verifier validated (S256 method)\n| External pentest (UAT, Q1 2026)\n\n| Token encryption\n| Tokens encrypted at rest (Key Vault)\n| AES-256 encryption, customer-managed keys\n| Internal security audit (PROD)\n\n| API authentication\n| Unauthenticated requests blocked\n| 401 Unauthorized for missing/invalid tokens\n| Automated security scan (UAT)\n\n| Data residency\n| Customer data stored in Australia East region\n| Cosmos DB, Key Vault in AU region only\n| Compliance audit (PROD)\n|===\n\n=== SBB Dependency Flowchart\n\nThis flowchart visualizes the dependency relationships between Solution Building Blocks (SBBs) in the Flybuys Integration architecture.\n\n==== Dependency Chain Diagram\n\n[mermaid]\n----\ngraph TD\n    %% External Systems\n    FlybuysOAuth[External: Flybuys OAuth]\n    FlybuysAPI[External: Flybuys API]\n    EagleEyeAPI[External: EagleEye API]\n    BrazeAPI[External: Braze API]\n\n    %% Mobile & Presentation Layer\n    SBB014[SBB-014: OTR Mobile App]\n\n    %% API Gateway\n    SBB013[SBB-013: API Gateway]\n\n    %% Profile Service\n    SBB001[SBB-001: Profile Service API]\n    SBB002[SBB-002: Profile Service Database]\n\n    %% Loyalty Service\n    SBB003[SBB-003: Loyalty Service API]\n    SBB004[SBB-004: Loyalty Service Database]\n\n    %% Engagement Service\n    SBB007[SBB-007: Engagement Service API]\n    SBB008[SBB-008: Engagement Service Database]\n\n    %% Infrastructure Services\n    SBB005[SBB-005: OAuth Token Manager]\n    SBB006[SBB-006: Domain Event Bus]\n    SBB009[SBB-009: Braze Integration Adaptor]\n    SBB010[SBB-010: Flybuys Integration Adaptor]\n    SBB011[SBB-011: EagleEye Integration Adaptor]\n    SBB012[SBB-012: Application Monitoring]\n    SBB015[SBB-015: Batch File Pipeline]\n    SBB016[SBB-016: Distributed Cache]\n    SBB017[SBB-017: Feature Flag Service]\n\n    %% Mobile App Dependencies\n    SBB014 -->|Partner linking| SBB001\n    SBB014 -->|Balance queries| SBB003\n    SBB014 -->|Ingress routing| SBB013\n\n    %% API Gateway Dependencies\n    SBB013 -->|Routes to| SBB001\n    SBB013 -->|Routes to| SBB003\n    SBB013 -->|Routes to| SBB007\n\n    %% Profile Service Dependencies\n    SBB001 -->|Persists PartnerLink| SBB002\n    SBB001 -->|Token storage/retrieval| SBB005\n    SBB001 -->|Publishes events| SBB006\n    SBB001 -->|Monitored by| SBB012\n\n    %% Loyalty Service Dependencies\n    SBB003 -->|Persists transactions| SBB004\n    SBB003 -->|PartnerLink lookup| SBB001\n    SBB003 -->|Publishes/Consumes events| SBB006\n    SBB003 -->|Balance queries| SBB010\n    SBB003 -->|Transaction adjudication| SBB011\n    SBB003 -->|Caches Flybuys balance| SBB016\n    SBB003 -->|Monitored by| SBB012\n    SBB003 -->|Feature toggles| SBB017\n\n    %% OAuth Token Manager Dependencies\n    SBB005 -->|Initiates OAuth| SBB001\n    SBB005 -->|OAuth tokens| FlybuysOAuth\n\n    %% Engagement Service Dependencies\n    SBB007 -->|Persists campaign state| SBB008\n    SBB007 -->|Consumes events| SBB006\n    SBB007 -->|Triggers campaigns| SBB009\n    SBB007 -->|Monitored by| SBB012\n\n    %% Braze Integration Adaptor Dependencies\n    SBB009 -->|Consumes events| SBB006\n    SBB009 -->|Optional enrichment| SBB001\n    SBB009 -->|Webhook calls| BrazeAPI\n\n    %% Flybuys Integration Adaptor Dependencies\n    SBB010 -->|Balance API| FlybuysAPI\n    SBB010 -->|Batch file upload| SBB015\n    SBB010 -->|Cached responses| SBB016\n\n    %% EagleEye Integration Adaptor Dependencies\n    SBB011 -->|Wallet & adjudication| EagleEyeAPI\n\n    %% Batch File Pipeline Dependencies\n    SBB015 -->|Reads transactions| SBB003\n    SBB015 -->|SFTP upload| FlybuysAPI\n\n    %% Event Bus Subscribers\n    SBB006 -.->|Partnerlinked event| SBB003\n    SBB006 -.->|Partnerlinked event| SBB007\n    SBB006 -.->|TransactionAdjudicated event| SBB007\n\n    %% Styling\n    classDef external fill:#f9f,stroke:#333,stroke-width:2px\n    classDef mobile fill:#bbf,stroke:#333,stroke-width:2px\n    classDef gateway fill:#bfb,stroke:#333,stroke-width:2px\n    classDef service fill:#fbb,stroke:#333,stroke-width:2px\n    classDef database fill:#ffb,stroke:#333,stroke-width:2px\n    classDef infrastructure fill:#bff,stroke:#333,stroke-width:2px\n    classDef integration fill:#fbf,stroke:#333,stroke-width:2px\n\n    class FlybuysOAuth,FlybuysAPI,EagleEyeAPI,BrazeAPI external\n    class SBB014 mobile\n    class SBB013 gateway\n    class SBB001,SBB003,SBB007 service\n    class SBB002,SBB004,SBB008 database\n    class SBB005,SBB006,SBB012,SBB015,SBB016,SBB017 infrastructure\n    class SBB009,SBB010,SBB011 integration\n----\n\n==== Dependency Layers\n\n===== Layer 1: External Systems\n\n* Flybuys OAuth Server\n* Flybuys API (Balance, Batch File SFTP)\n* EagleEye API\n* Braze API\n\n===== Layer 2: Presentation & Gateway\n\n* *SBB-014*: OTR Mobile App\n* *SBB-013*: API Gateway (ingress routing, OAuth validation, rate limiting)\n\n===== Layer 3: Domain Services\n\n* *SBB-001*: Profile Service API (partner linking, reward preferences)\n* *SBB-003*: Loyalty Service API (credential resolution, transaction adjudication)\n* *SBB-007*: Engagement Service API (campaign orchestration)\n\n===== Layer 4: Data Stores\n\n* *SBB-002*: Profile Service Database (PartnerLink aggregates)\n* *SBB-004*: Loyalty Service Database (RewardTransaction audit trail)\n* *SBB-008*: Engagement Service Database (campaign state tracking)\n\n===== Layer 5: Infrastructure Services\n\n* *SBB-005*: OAuth Token Manager (Flybuys token storage/refresh)\n* *SBB-006*: Domain Event Bus (event-driven integration)\n* *SBB-012*: Application Monitoring (observability)\n* *SBB-016*: Distributed Cache (Flybuys balance caching)\n* *SBB-017*: Feature Flag Service (progressive rollout)\n\n===== Layer 6: Integration Adaptors (Anti-Corruption Layers)\n\n* *SBB-009*: Braze Integration Adaptor (marketing automation)\n* *SBB-010*: Flybuys Integration Adaptor (conformist pattern)\n* *SBB-011*: EagleEye Integration Adaptor (loyalty engine)\n\n===== Layer 7: Batch Processing\n\n* *SBB-015*: Batch File Pipeline (nightly transaction aggregation, SFTP transmission)\n\n==== Critical Dependency Paths\n\n===== Partner linking Flow\n\n----\nMobile App (SBB-014)\n  → API Gateway (SBB-013)\n  → Profile Service (SBB-001)\n  → OAuth Token Manager (SBB-005)\n  → Flybuys OAuth\n----\n\n===== Transaction Adjudication Flow\n\n----\nPOS System\n  → API Gateway (SBB-013)\n  → Loyalty Service (SBB-003)\n  → Profile Service (SBB-001) [PartnerLink lookup]\n  → EagleEye Adaptor (SBB-011)\n  → EagleEye API\n----\n\n===== Flybuys Balance Query Flow\n\n----\nLoyalty Service (SBB-003)\n  → Distributed Cache (SBB-016) [cache miss]\n  → Flybuys Adaptor (SBB-010)\n  → Flybuys API\n----\n\n===== Event-Driven Engagement Flow\n\n----\nProfile Service (SBB-001) [publishes Partnerlinked]\n  → Event Bus (SBB-006)\n  → Engagement Service (SBB-007)\n  → Braze Adaptor (SBB-009)\n  → Braze API\n----\n\n==== Notes\n\n* *Solid arrows (→)* indicate synchronous dependencies (REST API calls, database queries)\n* *Dotted arrows (-.->)* indicate asynchronous dependencies (event subscriptions)\n* Some SBB references in the document contain numbering errors\n","structuredPatch":[{"oldStart":2711,"oldLines":7,"newStart":2711,"newLines":7,"lines":[" "," This section provides sequence diagrams for critical multi-service interactions across the Flybuys Integration architecture."," ","-==== OAuth linking Flow (AS-2 linking)","+==== OAuth linking Flow (TS-2 linking)"," "," Customer links their Flybuys account via OAuth 2.0 Authorization Code Flow with PKCE from the Mobile Application."," "]},{"oldStart":3251,"oldLines":13,"newStart":3251,"newLines":13,"lines":[" "," === Transition Phase Matrix"," ","-Progressive rollout of feature flags across architecture states (TS-0 → TS-1 → AS-2 → AS-3 → AS-4).","+Progressive rollout of feature flags across architecture states (TS-0 → TS-1 → TS-2 → AS-3 → AS-4)."," "," *Flag Definitions*: See xref:../architecture_definitions/flybuys_integration.adoc#Feature%2520Flag%2520Register[Feature Flag Register] in Architecture Definition for complete flag purposes, ownership, and strategic rationale."," "," [cols=\"3,1,1,1,1,1\"]"," |===","-| Flag Name | TS-0 Current | TS-1 Foundation | AS-2 linking | AS-3 Grants | AS-4 Target","+| Flag Name | TS-0 Current | TS-1 Foundation | TS-2 linking | AS-3 Grants | AS-4 Target"," "," | +OTR.Loyalty.Enabled+"," | OFF"]},{"oldStart":3324,"oldLines":7,"newStart":3324,"newLines":7,"lines":[" "," *Impact*: Mobile app reverts to legacy loyalty features (no EagleEye integration)"," ","-==== AS-2 linking Rollback","+==== TS-2 linking Rollback"," "," *Trigger*: OAuth flow failures (>5% failure rate), Flybuys API unavailability, or customer support tickets >50/day"," "]},{"oldStart":3552,"oldLines":7,"newStart":3552,"newLines":7,"lines":[" |==="," "," ","-=== AS-2 linking","+=== TS-2 linking"," "," Enable customer-facing xref:../ubiquitous_language.adoc#partner-xref[Partner Link] and xref:../ubiquitous_language.adoc#reward-preference[Reward Preference] selection in xref:../ubiquitous_language.adoc#otr-app[Mobile Applications]"," "]},{"oldStart":3761,"oldLines":7,"newStart":3761,"newLines":7,"lines":[" . Deploy +POST /api/v1/loyalty/credentials/resolve+ endpoint"," . Update POS to call Loyalty Service API on barcode scan"," . Barcode Format: EAN-13 (13-digit European Article Number standard)","-. Pre-linking Requirement: Customers must link Flybuys account via mobile app OAuth flow (AS-2)","+. Pre-linking Requirement: Customers must link Flybuys account via mobile app OAuth flow (TS-2)"," . Error Handling: POS displays \"Please link Flybuys in mobile app\" if unlinked Flybuys credential scanned (422 error)"," "," *Rollout Strategy*:"]},{"oldStart":3829,"oldLines":7,"newStart":3829,"newLines":7,"lines":[" [mermaid]"," ----"," graph TD","-    A[TS-1: Foundation] --> B[AS-2: linking Enabled]","+    A[TS-1: Foundation] --> B[TS-2: linking Enabled]","     B --> C[AS-3: Grants Operational]","     C --> D[AS-4: Target State]"," "]}],"userModified":false,"replaceAll":true},"sourceToolAssistantUUID":"6eaebc4c-357f-4dbb-8d84-deeb1bc6d067"}
{"parentUuid":"1aeed9d0-5301-4117-a120-5c8dda65c610","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01XhUrW7sMsauKYoR3ooyK5d","type":"tool_result","content":"The file /mnt/c/Users/o.young/work/architecture/solution_architectures/flybuys_integration.adoc has been updated. All occurrences of 'AS-3' were successfully replaced with 'TS-3'."}]},"uuid":"2d050a37-c194-44df-896c-a398161bfbe2","timestamp":"2026-01-08T05:38:53.574Z","toolUseResult":{"filePath":"/mnt/c/Users/o.young/work/architecture/solution_architectures/flybuys_integration.adoc","oldString":"AS-3","newString":"TS-3","originalFile":"= Flybuys Integration - Solution Architecture\n\n:project-name: Flybuys Integration\n:togaf-adm-phase: Phase E: Opportunities & Solutions\n:document-type: Solution Architecture Document\n:status: Discovery\n:version: 0.1\n:domain: Loyalty\n:programme-lead: Frankie.Mullaly@vivaenergy.com.au\n:domain-architect: O.Young@otr.com.au\n:business-owner: D.Peisley@otr.com.au\n:business-analyst: Fiona.Cheung@vivaenergy.com.au\n:architecture-definition: xref:../architecture_definitions/flybuys_integration.adoc[Architecture Definitions/Flybuys Integration]\n:doctype: article\n:toc: left\n:toclevels: 4\n:sectanchors:\n:sectxrefs:\n:sectnums:\n:icons: font\n:source-highlighter: highlightjs\n:experimental:\n:description: Solution Architecture Document for Flybuys Coalition Loyalty Integration\n:keywords: loyalty, flybuys, integration, solution-architecture, togaf\n\n== Purpose and Scope\n\n=== Purpose\n\nThis Solution Architecture defines how the Flybuys Integration will be implemented - the specific technology products, configurations, interfaces, and deployment architecture that realise the xref:../architecture_definitions/flybuys_integration.adoc[Flybuys Integration].\n\n<<<\n=== Scope\n\n==== In Scope\n\n* Solution Building Blocks (SBBs) - specific technology products and versions\n* Interface specifications (APIs, events, data formats)\n* Data architecture and schema specifications\n* Transition architecture with phased implementation states\n* Technical validation criteria and testing approach\n* External system integration specifications\n\n==== Out of Scope\n\n===== Covered in xref:../architecture_definitions/flybuys_integration.adoc[Architecture Definition]\n\n* Business requirements and stakeholder analysis\n* Architecture decisions and rationale\n* Bounded context definitions and responsibilities\n* High-level integration patterns (ACL, Conformist, OHS+PL)\n* Business capability mapping and value streams\n* Non-functional requirements (referenced, not duplicated)\n* Architecture principles and governance\n\n===== Covered in other documents\n\n* Detailed design (class diagrams, sequence diagrams for all flows)\n* Implementation code and unit tests\n* Business case and return-on-investment analysis\n* Operational run books and support procedures\n\n<<<\n== Executive Summary\n\nIntegrate xref:../bounded_context/external/flybuys.adoc[Flybuys] Coalition Loyalty across all OTRG Digital and In-Person channels without tightly coupling to external partner systems.\n\nEnable xref:../ubiquitous_language.adoc#customer[Customers] to link their xref:../ubiquitous_language.adoc#flybuys-digital-identity[Flybuys Digital Identity] with their xref:../ubiquitous_language.adoc#otr-app[Mobile Application] user profile, and present unified xref:../ubiquitous_language.adoc#loyalty-credential[Loyalty Credentials] at all xref:../bounded_context/interfaces/otr_pos.adoc[OTR POS] and xref:../bounded_context/interfaces/otr_plus_pos.adoc[OTR+ POS] stores.\n\nThe solution establishes the xref:../ubiquitous_language.adoc#viva-consumer-id-vci[Viva Consumer ID (VCI)] as *the canonical customer identifier* across all integrated systems, ensuring consistent customer reference throughout the loyalty platform and eliminating identity fragmentation.\n\n<<<\n== Solution Approach\n\n* Deploy xref:../bounded_context/profile.adoc[Profile Service] and xref:../bounded_context/loyalty.adoc[Loyalty Service] as bounded context microservices\n* Use NoSQL local document storage with partition key optimisation for caching.\n* Implement **Anti-Corruption Layers** (ACLs) for xref:../bounded_context/external/braze.adoc[Braze], xref:../bounded_context/external/flybuys.adoc[Flybuys] and xref:../bounded_context/external/eagle_eye.adoc[EagleEye] integration\n* Deploy xref:../bounded_context/interfaces/oauth.adoc[OAuth Service] with Key Vault token encryption\n* Establish event-driven architecture as the foundational integration pattern for the platform.\n* Phased roll-out (TS-1 → AS-4)\n\n=== Related Documentation\n\nThis solution architecture references detailed technical specifications:\n\n==== API Specifications\n\n* xref:../specifications/REST/profile-service-v1.yaml.md[Profile Service REST API (OpenAPI 3.0)] - Partner linking, preference management (4 endpoints)\n* xref:../specifications/AsyncAPI/otr-event-bus-v1.yaml.md[Event Bus (AsyncAPI 2.6.0)] - Domain events, CloudEvents 1.0 format\n\n==== Sequence Diagrams\n\n* Flybuys Integration Flows[Flybuys Integration Flows] - Comprehensive diagrams with happy path + error scenarios:\n** Transaction Adjudication (POS real-time, 4 scenarios)\n** OAuth Partner linking (mobile app, 4 scenarios)\n** Batch File Processing (nightly, 3 scenarios)\n** Circuit Breaker State Transitions\n** Event Propagation Timeline\n** OAuth Token Refresh (proactive + errors, 3 scenarios)\n\n==== JSON Schemas\n\n* xref:../specifications/JSON%2520Schemas/.md[JSON Schemas Directory] - Domain event schemas, request/response models\n\n==== Executive Summary\n\n* xref:../executive_summaries/flybuys_integration.adoc[Executive Summary] - 1-page overview for business stakeholders\n\n<<<\n== Key Technology Decisions\n\n[cols=\"1,2,4,3\"]\n|===\n| ID | Kind | Description | Rationale\n\n| DEC-001\n| Implementation\n| .NET 8.0\n| Aligns with OTR platform standards, team expertise in C#\n\n| DEC-002\n| Hosting\n| #TBD#\n| Autoscaling, managed infrastructure, Docker support\n\n| DEC-003\n| NoSQL Database\n| #TBD#\n| Partition key performance, global distribution, TTL support\n\n| DEC-004\n| Event Bus\n| #TBD#\n| CloudEvents 1.0 standard, built-in retry, dead letter queue\n\n| DEC-005\n| Key Storage\n| #TBD#\n| SaaS OAuth provider, Flybuys IDP integration, reduces custom implementation risk\n\n| DEC-006\n| Data Processing\n| #TBD#\n| SFTP connector, PGP encryption, scheduling\n\n| DEC-007\n| Monitoring\n| #TBD#\n| Native Azure integration, distributed tracing, correlation IDs\n\n| DEC-008\n| API Gateway\n| #TBD#\n| OAuth validation, rate limiting, request transformation\n\n| DEC-009\n| Caching Layer\n| #TBD#\n| Reduces Flybuys API load, low-latency access\n\n| DEC-010\n| Mobile App\n| #TBD#\n| Shared business logic, reduces duplicate code for iOS/Android\n\n| DEC-011\n| Authentication\n| xref:../bounded_context/external/microsoft_entra_external_id.adoc[Microsoft Entra External ID]\n| Standardised auth, secure token handling, integrates with mobile app\n\n| DEC-013\n| Resilience\n| #TBD#\n| Circuit breaker, retry policies for external API calls\n\n| DEC-014\n| Configuration / Feature Flags\n| #TBD#\n| Dynamic feature toggling, reduces deployment risk\n\n| DEC-015\n| Transport\n| REST over HTTPS\n|\n\n| DEC-016\n| Observability\n| #TBD#\n|\n\n| DEC-017\n| Deployment\n| #TBD#\n| Docker container + Azure Container Registry\n\n| DEC-018\n| Encryption (At Rest)\n| AES-256\n|\n\n| DEC-019\n| Encryption (In Flight)\n| TLS 1.3\n|\n\n| DEC-020\n| Schema Registry\n| #TBD#\n|\n|===\n\n=== Implementation Constraints\n\n* Must conform to Flybuys API specifications - cannot modify (xref:../architecture_definitions/flybuys_integration.adoc#constraints[CON-002])\n* Flybuys partnership potentially term 2-3 years - architecture must support partner flexibility (xref:../architecture_definitions/flybuys_integration.adoc#constraints[CON-006])\n* OAuth tokens must be `AES-256` encrypted at rest (<<key-technology-decisions,DEC-018>>), `TLS 1.3` in transit (DEC-018 xref:../architecture_definitions/flybuys_integration.adoc#constraints[CON-003])\n* Customer data must reside in Australia East region (xref:../architecture_definitions/flybuys_integration.adoc#constraints[CON-011])\n* Phased rollout required, no big-bang deployment (xref:../architecture_definitions/flybuys_integration.adoc#constraints[CON-004])\n\n=== Success Criteria\n\n* xref:../bounded_context/profile.adoc[Profile Service] / xref:../bounded_context/loyalty.adoc[Loyalty Service] APIs operational with <`500ms` `p95` latency (NFR-001, NFR-002)\n* OAuth linking success rate >95% over 30-day pilot period (7.5 Validation Exit Criteria)\n* Flybuys batch acknowledgement rate >98% for 60 days (NFR-016)\n\n<<<\n== Solution Building Blocks\n\nThis section maps the conceptual *Architecture Building Blocks* (ABBs) defined in the xref:../architecture_definitions/flybuys_integration.adoc[Architecture Definition] to specific *Solution Building Blocks* (SBBs).\n\n=== Technology Portfolio Catalogue\n\nThis catalogue lists all technology components required to implement the Flybuys Integration solution, mapped to the xref:../architecture_definitions/flybuys_integration.adoc#Technology%2520Capability%2520Requirements[Technology Capability Requirements] defined in the Architecture Definition.\n\n[cols=\"1,1,3,1,2,1\"]\n|===\n| Component | Category | Technology Stack | Lifecycle Stage | Rationale | Standards/Patterns\n\n| Event Bus\n| Integration\n| #TBD#\n| Planned\n| Event-driven architecture, loose coupling between services\n| OHS + Published Language\n\n| OAuth Service\n| Infrastructure\n| #TBD#\n| Planned\n| Secure token management, PCI compliance\n| OAuth 2.0, PKCE\n\n| Circuit Breaker\n| Resilience\n| #TBD#\n| Planned\n| Flybuys API failure handling\n| Circuit Breaker Pattern\n\n| Feature Flags\n| Deployment\n| #TBD#\n| Planned\n| Gradual rollout, kill switch for rollback\n| Feature Toggle Pattern\n\n| API Gateway\n| Infrastructure\n| #TBD#\n| Active\n| Single entry point, rate limiting, auth\n| RESTful API, OpenAPI\n\n| NoSQL Database\n| Data Storage\n| #TBD#\n| Active\n| Database per bounded context, high throughput\n| Database per Service\n\n| Key Vault\n| Security\n| #TBD#\n| Active\n| OAuth token storage, encryption keys\n| AES-256, Customer-Managed Keys\n\n| Redis Cache\n| Caching\n| #TBD#\n| Active\n| Flybuys balance caching (5-min TTL), circuit breaker fallback\n| In-Memory Cache, TTL Pattern\n\n| Monitoring Stack\n| Observability\n| #TBD#\n| Active\n| Distributed tracing, metrics, logging\n| OpenTelemetry, Structured Logging\n\n| Identity Provider\n| Authentication\n| xref:../bounded_context/external/microsoft_entra_external_id.adoc[Microsoft Entra External ID]\n| Active\n| Customer authentication, CIAM\n| OAuth 2.0, OIDC\n\n| SFTP Service\n| Integration\n| xref:../bounded_context/external/azure_data_factory.adoc[Azure Data Factory]\n| Active\n| Flybuys batch file transmission\n| SFTP Protocol, Batch File Transfer\n\n| Batch Scheduler\n| Infrastructure\n| xref:../bounded_context/external/azure_data_factory.adoc[Azure Data Factory]\n| Active\n| Nightly batch file generation\n| Cron-based Scheduling\n|===\n\n*Note*: Components marked #TBD# are deferred to implementation phase as engineering choices. See <<key-technology-decisions,Technology Decisions>> for evaluation criteria.\n\n<<<\n\n=== Solution Building Block Mapping\n\n[cols=\"1,3,2,3,4\"]\n|===\n| ABB ID | ABB Name | SBB ID | SBB Name | Technology Product/Component\n\n| ABB-001\n| xref:../bounded_context/profile.adoc[Profile Service] Bounded Context\n| <<sbb-001-profile-service-api,SBB-001>>\n| xref:../bounded_context/profile.adoc[Profile Service] API\n| <<key-technology-decisions,DEC-001 Implementation>>\n\n| ABB-001\n| xref:../bounded_context/profile.adoc[Profile Service] Data Store\n| <<sbb-002-profile-service-database,SBB-002>>\n| xref:../bounded_context/profile.adoc[Profile Service] Database\n| <<key-technology-decisions,DEC-003 NoSQL>>\n\n| ABB-002\n| xref:../bounded_context/loyalty.adoc[Loyalty Service] Bounded Context\n| <<sbb-003-loyalty-service-api,SBB-003>>\n| xref:../bounded_context/loyalty.adoc[Loyalty Service] API\n| <<key-technology-decisions,DEC-001 Implementation>>\n\n| ABB-002\n| xref:../bounded_context/loyalty.adoc[Loyalty Service] Data Store\n| <<sbb-004-loyalty-service-database,SBB-004>>\n| xref:../bounded_context/loyalty.adoc[Loyalty Service] Database\n| <<key-technology-decisions,DEC-003 NoSQL>>\n\n| ABB-006\n| xref:../bounded_context/interfaces/oauth.adoc[OAuth Service]\n| <<sbb-005-oauth-token-manager,SBB-005>>\n| OAuth Token Manager\n| <<key-technology-decisions,DEC-005 Key Storage>>\n\n| ABB-005\n| Event Bus[Event Bus]\n| <<sbb-006-domain-event-bus,SBB-006>>\n| Domain Event Bus\n| <<key-technology-decisions,DEC-004 Event Bus>>\n\n| ABB-004\n| xref:../bounded_context/engagement.adoc[Engagement Service] Bounded Context\n| <<sbb-007-engagement-service-api,SBB-007>>\n| xref:../bounded_context/engagement.adoc[Engagement Service] API\n| <<key-technology-decisions,DEC-001 Implementation>>\n\n| ABB-004\n| xref:../bounded_context/engagement.adoc[Engagement Service] Data Store\n| <<sbb-008-engagement-service-database,SBB-008>>\n| xref:../bounded_context/engagement.adoc[Engagement Service] Datastore\n| <<key-technology-decisions,DEC-003 NoSQL>>\n\n| ABB-012\n| Braze ACL\n| <<sbb-009-braze-integration-adaptor,SBB-009>>\n| xref:../bounded_context/external/braze.adoc[Braze Integration Adaptor]\n| <<key-technology-decisions,DEC-001 Implementation>>\n\n| ABB-013\n| Flybuys ACL\n| <<sbb-010-flybuys-integration-adaptor,SBB-010>>\n| xref:../bounded_context/external/flybuys.adoc[Flybuys Integration Adaptor]\n| <<key-technology-decisions,DEC-001 Implementation>> + <<key-technology-decisions,DEC-006 Data Processing>>\n\n| ABB-014\n| EagleEye ACL\n| <<sbb-011-eagleeye-integration-adaptor,SBB-011>>\n| xref:../bounded_context/external/eagle_eye.adoc[EagleEye Integration Adaptor]\n| <<key-technology-decisions,DEC-001 Implementation>>\n\n| ABB-009\n| Monitoring & Observability\n| <<sbb-012-application-monitoring,SBB-012>>\n| Application Monitoring\n| <<key-technology-decisions,DEC-007 Monitoring>>\n\n| ABB-007\n| API Gateway\n| <<sbb-013-api-gateway,SBB-013>>\n| xref:../bounded_context/interfaces/api_gateway.adoc[API Gateway]\n| <<key-technology-decisions,DEC-008 API Gateway>>\n\n| ABB-010\n| xref:../bounded_context/interfaces/mobile.adoc[Mobile Application]\n| <<sbb-014-otr-mobile-app,SBB-014>>\n| OTR Mobile App\n| <<key-technology-decisions,DEC-010 Mobile Application>>\n\n| ABB-015\n| Points File Management\n| <<sbb-015-batch-file-pipeline,SBB-015>>\n| Batch File Pipeline\n| <<key-technology-decisions,DEC-006 Data Processing>>\n\n| ABB-011\n| Caching Layer\n| <<sbb-016-distributed-cache,SBB-016>>\n| Distributed Cache\n| <<key-technology-decisions,DEC-009 Caching Layer>>\n\n| ABB-008\n| App Config / Feature Flags\n| <<sbb-017-feature-flag-service,SBB-017>>\n| Feature Flags\n|\n\n| ABB-003\n| xref:../bounded_context/location.adoc[Location Service] Bounded Context\n| <<sbb-018-location,SBB-018>>\n| xref:../bounded_context/location.adoc[Location Service] API\n| <<key-technology-decisions,DEC-001 Implementation>>\n\n| ABB-003\n| xref:../bounded_context/location.adoc[Location Service] Data Store\n| <<SBB-019,SBB-019>>\n| xref:../bounded_context/location.adoc[Location Service] Data Store\n|\n|===\n\n<<<\n=== SBB-001: Profile Service API\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| Description\n| Provides APIs for managing customer xref:../ubiquitous_language.adoc#partner-xref[PartnerLink]s with Flybuys, storing reward preferences, and retrieving linked profile data.\n\n| ABB Reference\n| xref:../bounded_context/profile.adoc[Profile Service] Bounded Context (see xref:../architecture_definitions/flybuys_integration.adoc#service-catalogues[Architecture Definition §3.2.1])\n\n| Component Type\n| Microservice (Domain Service)\n\n| Technology Stack\n| <<key-technology-decisions,DEC-001 Implementation>>\n\n| Hosting Platform\n| <<key-technology-decisions,DEC-002 Hosting>>\n\n| API Contract\n| <<key-technology-decisions,DEC-005 Transport>> - See xref:/specifications/rest/profile-service-v1.yaml[OpenAPI 3.0 Specification]\n\n| Authentication\n| <<key-technology-decisions,DEC-011 Authentication>>\n\n| Observability\n| <<key-technology-decisions,DEC-016 Observability>>\n\n| Configuration\n| <<key-technology-decisions,DEC-014 Configuration>>\n\n| Health Checks\n| `/health` HTTPS endpoint\n\n| Deployment Unit\n| <<key-technology-decisions,DEC-017 Deployment>>\n|===\n\n==== Dependencies\n\n[cols=\"2,2,4\"]\n|===\n| SBB ID | Dependency | Reason\n\n| <<sbb-002-profile-service-database,SBB-002>>\n| xref:../bounded_context/profile.adoc[Profile Service] Database\n| xref:../ubiquitous_language.adoc#partner-xref[PartnerLink] aggregate persistence\n\n| <<sbb-005-oauth-token-manager,SBB-005>>\n| OAuth Token Manager\n| xref:../bounded_context/external/flybuys.adoc[Flybuys] OAuth token storage/retrieval\n\n| <<sbb-006-domain-event-bus,SBB-006>>\n| Domain Event Bus\n| Publishing Partnerlinked event schema[Partnerlinked], xref:/specifications/json_schemas/RewardPreferenceChanged.event.schema.json[RewardPreferenceChanged], xref:/specifications/json_schemas/CustomerProfileCreated.event.schema.json[CustomerProfileCreated] events (see AsyncAPI Spec[AsyncAPI Spec])\n\n| <<sbb-010-flybuys-integration-adaptor,SBB-010>>\n| API Gateway\n| Ingress routing, rate limiting, OAuth validation\n\n| Salesforce\n| xref:../bounded_context/external/salesforce.adoc[Salesforce CRM]\n| Upsert Contact record during profile creation (`POST /api/v1/profile/customers`)\n|===\n\n\n<<<\n=== SBB-002: Profile Service Database\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| ABB Reference\n| xref:../bounded_context/profile.adoc[Profile Service] Data Store\n\n| Database Type\n| NoSQL Document Database\n\n| Product\n| <<key-technology-decisions,DEC-003>>\n\n| Consistency\n| Session consistency (default), Strong consistency for PartnerLink operations\n\n| Partition Strategy\n| Partition key: `/vivaConsumerId` (enables single-partition queries, ~10KB documents)\n\n| Throughput\n| Autoscale: 1000-10000 RU/s (scales based on load, avg 4000 RU/s expected)\n\n| Geo-Replication\n| xref:../architecture_definitions/flybuys_integration.adoc#Constraints[CON-011]\n\n| Backup\n| Continuous backup (7-day point-in-time recovery, hourly snapshots)\n\n| Indexes\n| Default indexing + composite index on `[/partner ASC, /status ASC]`\n\n| Containers\n| `partner-links` (main), `customer-profiles` (read model for Salesforce sync)\n\n| Data Residency\n| xref:../architecture_definitions/flybuys_integration.adoc#Constraints[CON-011]\n|===\n\n\n<<<\n=== SBB-003: Loyalty Service API\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| ABB Reference\n| xref:../bounded_context/loyalty.adoc[Loyalty Service] Bounded Context (see xref:../architecture_definitions/flybuys_integration.adoc#service-catalogues[Architecture Definition §3.2.1])\n\n| Component Type\n| Microservice (Domain Service)\n\n| Technology Stack\n| <<key-technology-decisions,DEC-001 Implementation>>\n\n| Hosting Platform\n| <<key-technology-decisions,DEC-002 Hosting>>\n\n| API Contract\n| <<key-technology-decisions,DEC-005 Transport>> - See xref:../specifications/REST/loyalty-service-v1.yaml[OpenAPI 3.0 Specification]\n\n| Batch Processing\n| <<key-technology-decisions,DEC-012 Batch Processing>>\n\n| Authentication\n| <<key-technology-decisions,DEC-011 Authentication>>\n\n| Observability\n| <<key-technology-decisions,DEC-016 Observability>>\n\n| Configuration\n| <<key-technology-decisions,DEC-014 Configuration>>\n\n| Health Checks\n| `/health` HTTPS endpoint\n\n| Deployment Unit\n| <<key-technology-decisions,DEC-017 Deployment>>\n|===\n\n==== Capabilities\n\n===== Loyalty Credential Resolution\n\n* Resolves EAN-13 barcodes from xref:../bounded_context/interfaces/otr_pos.adoc[OTR POS] and xref:../bounded_context/interfaces/otr_plus_pos.adoc[OTR+ POS] scanners to xref:../ubiquitous_language.adoc#viva-consumer-id-vci[Viva Consumer Id (VCI)]\n* Supports all xref:../ubiquitous_language.adoc#loyalty-credential[Loyalty Credential] types:\n** Barcode from xref:../bounded_context/interfaces/mobile.adoc[OTR Mobile],\n** Barcode from xref:../bounded_context/interfaces/mobile.adoc[SPS Mobile],\n** xref:../bounded_context/interfaces/mobile.adoc[Apple/Google Wallet passes],\n** Physical Flybuys cards,\n** Flybuys Mobile barcodes\n* Resolved Loyalty Credentials to\n** Direct resolution for OTR credentials (barcode → VCI)\n** Indirect resolution for Flybuys credentials (barcode → PartnerLink → VCI)\n* Returns customer context (VCI, reward preference, wallet ID) to POS within 500ms p95 (xref:../architecture_definitions/flybuys_integration.adoc#non-functional-requirements[NFR-002])\n\n==== Dependencies\n\n[cols=\"2,3,5\"]\n|===\n| SBB ID | Dependency | Reason\n\n| <<SBB-004 Loyalty Service Database,SBB-004>>\n| xref:../bounded_context/loyalty.adoc[Loyalty Service] Database\n| xref:../ubiquitous_language.adoc#reward-transaction[RewardTransaction] aggregate persistence\n\n| <<SBB-001 Profile Service API,SBB-001>>\n| xref:../bounded_context/profile.adoc[Profile Service] API\n| PartnerLink lookup for Flybuys credential resolution\n\n| <<SBB-006 Domain Event Bus,SBB-006>>\n| Domain Event Bus\n| Consuming xref:../specifications/JSON%2520Schemas/Partnerlinked.event.schema.json[Partnerlinked] events, publishing xref:../specifications/JSON%2520Schemas/TransactionAdjudicated.event.schema.json[TransactionAdjudicated] events (see xref:../specifications/AsyncAPI/otr-event-bus-v1.yaml[AsyncAPI Spec])\n\n| <<SBB-007 Flybuys Integration Adapter,SBB-007>>\n| xref:../bounded_context/external/flybuys.adoc[Flybuys Integration Adapter]\n| Balance queries, batch file transmission\n\n| <<SBB-008 EagleEye Integration Adapter,SBB-008>>\n| xref:../bounded_context/external/eagle_eye.adoc[EagleEye Integration Adapter]\n| Transaction Adjudication, wallet queries\n\n| <<SBB-010 API Gateway,SBB-010>>\n| xref:../bounded_context/interfaces/api_gateway.adoc[API Gateway]\n| Ingress routing for mobile app and POS systems\n\n| <<SBB-013 Distributed Cache,SBB-013>>\n| Distributed Cache\n| Caching Flybuys balance queries\n|===\n\n\n<<<\n=== SBB-004: Loyalty Service Database\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| ABB Reference\n| xref:../bounded_context/loyalty.adoc[Loyalty Service] Data Store\n\n| Database Type\n| NoSQL Document Database\n\n| Product\n| <<key-technology-decisions,DEC-003>>\n\n| Consistency\n| Session consistency (eventual consistency acceptable for audit trail)\n\n| Partition Strategy\n| Partition key: `/vivaConsumerId` (enables single-partition transaction queries)\n\n| Throughput\n| Autoscale: 1000-20000 RU/s (higher peak for POS transaction volume)\n\n| Geo-Replication\n| xref:../architecture_definitions/flybuys_integration.adoc#Constraints[CON-011]\n\n| Backup\n| Continuous backup (7-day point-in-time recovery)\n\n| TTL\n| 2592000 seconds (30 days) - automatic deletion for RewardTransaction documents\n\n| Indexes\n| Default indexing + range index on `/transactionDate DESC` for recent queries\n\n| Containers\n| `reward-transactions` (audit trail with 30-day TTL)\n\n| Data Residency\n| xref:../architecture_definitions/flybuys_integration.adoc#Constraints[CON-011]\n|===\n\n\n<<<\n=== SBB-005: OAuth Token Manager\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| ABB Reference\n| OAuth Service (Infrastructure)\n\n| Component Type\n| Infrastructure Service (OAuth provider + secure token storage)\n\n| Token Storage\n| <<key-technology-decisions,DEC-005>>\n\n| Token Format\n| https://www.oauth.com/oauth2-servers/access-tokens/\n\n| Secret Naming\n| `\\{partner}-token-{vivaConsumerId}` (e.g., `flybuys-token-vci_xyz789abc`)\n\n| Refresh Logic\n| Azure Function (Timer trigger every 50 minutes, before 60-minute expiry)\n\n| Encryption\n|\n|===\n\n==== OAuth Token Refresh Flow\n\nSee detailed sequence diagrams in #oauth-token-refresh-flow[Sequence Diagrams] for error scenarios including token expiry and API unavailability.\n\n[mermaid]\n----\nsequenceDiagram\n    autonumber\n    participant Timer as Azure Function<br/>(Timer Trigger)\n    participant TokenManager as OAuth Token Manager\n    participant KeyVault as Azure Key Vault\n    participant FlybuysOAuth as Flybuys OAuth Server\n    participant DB as Profile Database\n    participant Monitor as Monitoring\n\n    Note over Timer,Monitor: Timer trigger: Every 50 minutes\n\n    Timer->>TokenManager: Trigger token refresh job\n\n    activate TokenManager\n    TokenManager->>DB: Query PartnerLinks<br/>WHERE partner=\"FLYBUYS\" AND status=\"linked\"\n    activate DB\n    DB-->>TokenManager: 10,000 active PartnerLinks\n    deactivate DB\n\n    loop For each PartnerLink (batch of 100)\n        TokenManager->>KeyVault: Get token<br/>SecretName: flybuys-token-{vci}\n        activate KeyVault\n        KeyVault-->>TokenManager: {access_token, refresh_token, expiresAt}\n        deactivate KeyVault\n\n        TokenManager->>TokenManager: Check: expiresAt - now < 10 minutes?\n\n        alt Token expiring soon\n            TokenManager->>FlybuysOAuth: POST /token<br/>{grant_type: \"refresh_token\", refresh_token}\n            activate FlybuysOAuth\n            FlybuysOAuth->>FlybuysOAuth: Validate refresh_token\n            FlybuysOAuth-->>TokenManager: {access_token (new), refresh_token (new), expires_in: 3600}\n            deactivate FlybuysOAuth\n\n            TokenManager->>KeyVault: Update secret<br/>flybuys-token-{vci}\n            activate KeyVault\n            KeyVault-->>TokenManager: Secret updated\n            deactivate KeyVault\n\n            TokenManager->>Monitor: Metric: token_refresh_success\n        else Token still valid\n            TokenManager->>Monitor: Metric: token_refresh_skipped\n        end\n    end\n\n    TokenManager-->>Timer: Job complete<br/>Refreshed: 8,500 tokens<br/>Skipped: 1,500 tokens\n    deactivate TokenManager\n\n    Timer->>Monitor: Log job duration: 45 seconds\n----\n\n==== Dependencies\n\n[cols=\"2,2,4\"]\n|===\n| SBB ID | Dependency | Reason\n\n| <<SBB-001 Profile Service API,SBB-001>>\n| xref:../bounded_context/profile.adoc[Profile Service]\n| Initiates OAuth flow, stores `oauthTokenReference` in PartnerLink\n\n| External\n| OAuth Provider\n| Flybuys OAuth API integration\n|===\n\n\n<<<\n=== SBB-006: Domain Event Bus\n\n==== Event Specifications\n\nSee xref:../specifications/AsyncAPI/otr-event-bus-v1.yaml[AsyncAPI 2.6.0 Specification] for complete event definitions, schemas, and examples. Individual event schemas available in xref:../specifications/JSON%2520Schemas[JSON Schemas directory].\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| ABB Reference\n| Domain Event Bus\n\n| Platform\n| <<key-technology-decisions,DEC-004>>\n\n| Retention\n| 7 days (with dead letter queue for failed deliveries)\n\n| Schema Registry\n| <<key-technology-decisions,DEC-020>>\n\n| Delivery Guarantee\n| At-least-once delivery with retry (max 30 attempts, exponential backoff)\n\n| Monitoring\n| <<key-technology-decisions,DEC-007>>\n|===\n\n===== Topics\n\n*Profile Events* (`profile.events` topic)\n\n[cols=\"2,3,1\"]\n|===\n| Event Name | Description | Schema\n\n| `PartnerLinked`\n| Partner account linked to customer profile\n| PartnerLinked event schema[Schema]\n\n| `PartnerUnlinked`\n| Partner account unlinked from customer\n| xref:../specifications/JSON%2520Schemas/PartnerUnlinked.event.schema.json[Schema]\n\n| `RewardPreferenceChanged`\n| Customer changed reward preference selection\n| xref:../specifications/JSON%2520Schemas/RewardPreferenceChanged.event.schema.json[Schema]\n|===\n\n*Loyalty Events* (`loyalty.events` topic)\n\n[cols=\"2,3,1\"]\n|===\n| Event Name | Description | Schema\n\n| `CustomerProfileCreated`\n| Customer profile created during Just-In-Time Integration\n| xref:../specifications/JSON%2520Schemas/CustomerProfileCreated.event.schema.json[Schema]\n\n| `TransactionAdjudicated`\n| Transaction Adjudication completed\n| xref:../specifications/JSON%2520Schemas/TransactionAdjudicated.event.schema.json[Schema]\n\n| `PointsEarned`\n| Points earned in loyalty programme\n| xref:../specifications/JSON%2520Schemas/PointsEarned.event.schema.json[Schema]\n\n| `FuelDiscountApplied`\n| Fuel discount applied to transaction\n| xref:../specifications/JSON%2520Schemas/FuelDiscountApplied.event.schema.json[Schema]\n\n| `RewardTransactionFailed`\n| Transaction adjudication failed\n| xref:../specifications/JSON%2520Schemas/RewardTransactionFailed.event.schema.json[Schema]\n\n| `PointsRedeemed`\n| Points redeemed in loyalty programme\n| _Planned_\n\n| `PointsExpired`\n| Points expired\n| _Planned_\n\n| `GrantIssued`\n| Loyalty grant issued\n| _Planned_\n\n| `GrantRedeemed`\n| Loyalty grant redeemed\n| _Planned_\n\n| `FlybuysPointsEarned`\n| Points earned in Flybuys programme\n| _Planned_\n\n| `FlybuysBalanceUpdated`\n| Flybuys points balance changed\n| _Planned_\n\n| `PartnerAccountlinked`\n| Flybuys member linked (OAuth complete)\n| _Planned_\n\n| `PartnerAccountUnlinked`\n| Flybuys member unlinked\n| _Planned_\n\n| `DailyPointsFileGenerated`\n| Daily partner points file generated\n| _Planned_\n\n| `DailyPointsFileTransmitted`\n| Daily points file sent to partner\n| _Planned_\n\n| `DailyPointsFileAcknowledged`\n| Partner acknowledged file receipt\n| _Planned_\n|===\n\n==== Event Documentation\n\nSee xref:../specifications/AsyncAPI/otr-event-bus-v1.yaml[AsyncAPI Specification] for complete event definitions with examples, or xref:../bounded_context/loyalty.cml[Bounded Context/loyalty.cml] for CML domain model. CloudEvents 1.0 specification used for all domain events.\n\n==== Event Propagation Timeline\n\nSee detailed sequence diagrams in #event-propagation-timeline[Sequence Diagrams] for out-of-order event handling and version-based conflict resolution.\n\n[mermaid]\n----\nsequenceDiagram\n    autonumber\n    participant Mobile as Mobile App\n    participant Profile as Profile Service\n    participant EventBus as Event Bus\n    participant Loyalty as Loyalty Service\n    participant Engagement as Engagement Service\n\n    Note over Mobile,Engagement: T=0: OAuth linking completes\n\n    Mobile->>Profile: POST /partners\n    activate Profile\n    Profile->>Profile: Store PartnerLink (status: linked)\n    Profile->>Profile: Commit database transaction\n\n    Note over Profile: T+50ms: Transaction committed\n\n    Profile->>EventBus: Publish Partnerlinked event<br/>{vivaConsumerId, partner, externalMemberId}\n    activate EventBus\n    EventBus->>EventBus: Persist event (durability guarantee)\n    EventBus-->>Profile: Event ID: evt-123456\n    deactivate EventBus\n\n    Profile-->>Mobile: 201 Created {PartnerLinkId}\n    deactivate Profile\n\n    Note over EventBus: T+100ms: Event persisted\n\n    par Parallel Event Delivery\n        EventBus->>Loyalty: Deliver Partnerlinked event\n        activate Loyalty\n        Loyalty->>Loyalty: Update reward preference cache<br/>(vivaConsumerId → FLYBUYS_POINTS)\n        Loyalty-->>EventBus: ACK\n        deactivate Loyalty\n\n        Note over Loyalty: T+200ms: Cache updated\n    and\n        EventBus->>Engagement: Deliver Partnerlinked event\n        activate Engagement\n        Engagement->>Engagement: Trigger welcome campaign<br/>\"Earn Flybuys points at OTR\"\n        Engagement-->>EventBus: ACK\n        deactivate Engagement\n\n        Note over Engagement: T+500ms: Campaign triggered\n    end\n\n    Note over Mobile,Engagement: Eventual consistency achieved within 500ms\n----\n\n==== Event Flow\n\n[cols=\"2,3\"]\n|===\n| From | To\n\n| xref:../bounded_context/profile.adoc[Profile Service]\n| xref:../bounded_context/loyalty.adoc[Loyalty Service]\n\n| xref:../bounded_context/profile.adoc[Profile Service]\n| xref:../bounded_context/engagement.adoc[Engagement Service]\n\n| xref:../bounded_context/profile.adoc[Profile Service]\n| xref:../bounded_context/recommendation.adoc[Recommendation Service]\n\n| xref:../bounded_context/loyalty.adoc[Loyalty Service]\n| xref:../bounded_context/engagement.adoc[Engagement Service]\n\n| xref:../bounded_context/loyalty.adoc[Loyalty Service]\n| xref:../bounded_context/recommendation.adoc[Recommendation Service]\n|===\n\n\n<<<\n=== SBB-007: Engagement Service API\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| ABB Reference\n| Engagement Service (Bounded Context)\n\n| Component Type\n| Microservice (Event Consumer + Anti-Corruption Layer)\n\n| Implementation\n| <<key-technology-decisions,DEC-001>>\n\n| Hosting\n| <<key-technology-decisions,DEC-002>>\n\n| Database\n| <<sbb-008-engagement-service-database,SBB-008>>\n\n| Event Subscriptions\n| `profile.events.*`, `loyalty.events.*` (all Profile and Loyalty domain events)\n\n| External Integration\n| xref:../bounded_context/external/braze.adoc[Braze] (via ACL)\n|===\n\n==== Responsibilities\n\n* *Event Relay*: Relay domain events to xref:../bounded_context/external/braze.adoc[Braze] webhooks to enable transactional Customer communications\n** *Event-Driven Campaign Triggers*: Consumes domain events from Profile Service and Loyalty Service\n** *Braze Anti-Corruption Layer*: Translates OTRG domain events into xref:../bounded_context/external/braze.adoc[Braze] webhook payloads\n** *Customer Notification Orchestration*: Triggers push notifications, emails, in-app messages\n* *Campaign State Management*: Tracks campaign eligibility and notification delivery status\n\n==== Key Events Consumed\n\n[cols=\"1,2,3\"]\n|===\n| Event Source | Event Name | Campaign Trigger\n\n| Profile Service\n| `Partnerlinked`\n| Welcome campaign: \"_You're earning Flybuys points now!_\"\n\n| Profile Service\n| `RewardPreferenceChanged`\n| Confirmation: \"_Reward preference updated_\"\n\n| Loyalty Service\n| `TransactionAdjudicated`\n| Transaction confirmation: \"_You earned 150 Flybuys pts_\"\n\n| Loyalty Service\n| `PointsEarned`\n| Points milestone: \"_You've earned 1000 points this week_\"\n\n| Loyalty Service\n| `RewardTransactionFailed`\n| Error notification: \"_Transaction processing delayed_\"\n|===\n\n\n<<<\n=== SBB-008: Engagement Service Database\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| ABB Reference\n| Engagement Service Data Store\n\n| Platform\n| <<key-technology-decisions,DEC-003>>\n\n| Purpose\n| Campaign state tracking, notification delivery history\n\n| Data Residency\n| Australia East (primary), Australia Southeast (failover)\n\n| Retention\n| 90 days (notification history), indefinite (campaign state)\n|===\n\n\n<<<\n=== SBB-009: Braze Integration Adaptor\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| ABB Reference\n| Braze ACL\n\n| Component Type\n| Data Egress Anti-Corruption Layer (ACL) - Conformist pattern\n\n| Implementation\n| Referenced by xref:../bounded_context/engagement.adoc[Engagement Service]\n\n| External APIs\n| Braze REST API v3 (User Tracking API)\n\n| Webhook URL\n| `\\https://rest.iad-06.braze.com/`\n\n| Endpoint\n| xref:https://www.braze.com/docs/api/endpoints/user_data/post_user_track/[`/users/track`]\n\n| Circuit Breaker\n| 5 consecutive failures → open circuit, 30s timeout\n\n| Retry Policy\n| Exponential backoff: 3 retries (2s, 4s, 8s delays) for transient failures (5xx errors)\n\n| API Key Management\n| API key stored in Azure Key Vault\n\n| Rate Limits\n| 250 requests/minute per API key (Braze SLA)\n\n| Event Processing Latency\n| <500ms p95 (from Event Bus delivery to Braze webhook trigger)\n\n| Braze Webhook Timeout\n| 5 seconds (with retry logic)\n\n| Event Throughput\n| 1000 events/minute sustained\n|===\n\n==== Dependencies\n\n[cols=\"2,2,3\"]\n|===\n| SBB ID | Dependency | Reason\n\n| <<sbb-006-domain-event-bus,SBB-006 Domain Event Bus>>\n| Event subscriptions\n| Consumes Partnerlinked, TransactionAdjudicated events\n\n| xref:../bounded_context/profile.adoc[Profile Service]\n| Customer profile\n| Enriches event data with customer attributes (optional)\n|===\n\n\n<<<\n=== SBB-010: Flybuys Integration Adaptor\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| ABB Reference\n| Flybuys ACL\n\n| Component Type\n| Anti-Corruption Layer (ACL) - Conformist pattern (reference ADR-003 in ADD)\n\n| Implementation\n| #TBD# (referenced by xref:../bounded_context/loyalty.adoc[Loyalty Service], conforms to Flybuys API)\n\n| External APIs\n| Flybuys OAuth API, Balance API (`GET /v1/members/\\{id}/balance`), Docket API\n\n| Batch SFTP\n| #TBD# (Batch processing with SFTP connector, SSH key auth, PGP 2048-bit encryption)\n\n| Circuit Breaker\n| #TBD#\n\n| Caching\n| #TBD# (Distributed cache, 5-minute TTL for balance queries, reduces Flybuys API load)\n\n| Retry Policy\n| Exponential backoff: 3 retries (2s, 4s, 8s delays) for transient failures\n|===\n\n*Flybuys Implementation*: `FlybuysPointsServiceAdapter` (conforms to Flybuys CSV batch file spec v3.2)\n\n\n<<<\n=== SBB-011: EagleEye Integration Adaptor\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| ABB Reference\n| EagleEye ACL\n\n| Component Type\n| Anti-Corruption Layer (ACL)\n\n| Implementation\n| #TBD#(referenced by xref:../bounded_context/loyalty.adoc[Loyalty Service])\n\n| External APIs\n| EagleEye REST API v3 (wallet, campaigns, Transaction Adjudication)\n\n| Circuit Breaker\n| #TBD# (5 consecutive failures → open circuit, 30s timeout)\n\n| Retry Policy\n| Exponential backoff: 3 retries (2s, 4s, 8s delays)\n\n| API Key Management\n| API key stored in #TBD# (secure key vault service)\n\n| Rate Limits\n| 1000 requests/minute per API key (EagleEye SLA)\n|===\n\n\n<<<\n=== SBB-012: Application Monitoring\n\n[cols=\"1,3\"]\n|===\n| MAttribute | Specification\n\n| ABB Reference\n| Monitoring & Observability\n\n| Platform\n| xref:#Key_Technology_Decisions[DEC-007]\n\n| Application Insights\n| #TBD# (Workspace-based shared across xref:../bounded_context/profile.adoc[Profile Service], xref:../bounded_context/loyalty.adoc[Loyalty Service])\n\n| Instrumentation\n| #TBD# (SDK for distributed tracing, OpenTelemetry support)\n\n| Log Aggregation\n| Structured logging (Serilog) → #TBD# (centralized log aggregation with query language)\n\n| Metrics\n| Custom metrics: API latency (p50/p95/p99), OAuth success rate, batch file acknowledgement rate\n\n| Distributed Tracing\n| W3C Trace Context standard (see <<Correlation ID Propagation Specification,Correlation ID Specification>>)\n\n| Dashboards\n| #TBD# (Flybuys Integration Health, Customer Adoption Metrics dashboards)\n|===\n\n*Alerting*:\n\n* Critical: xref:../bounded_context/profile.adoc[Profile Service] API error rate > 5% → PagerDuty (on-call architect)\n* Critical: Batch file generation fails → Immediate alert to xref:../bounded_context/loyalty.adoc[Loyalty Service] team\n* Warning: Flybuys API latency > 3s p95 → Slack alert\n\n\n<<<\n=== SBB-013: API Gateway\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| ABB Reference\n| API Gateway\n\n| Platform\n| xref:#Key_Technology_Decisions[DEC-008]\n\n| Base URL\n| `\\https://api.otr.com.au`\n\n| Authentication\n| xref:#Key_Technology_Decisions[DEC-011]\n\n| Rate Limiting\n| 1000 requests/minute per user, 10000 requests/minute global\n\n| Policies\n| JWT validation, rate limiting, CORS, request/response transformation\n\n| TLS\n| xref:#Key_Technology_Decisions[DEC-019]\n|===\n\n\n<<<\n=== SBB-014: OTR Mobile App\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| ABB Reference\n| Mobile Application (Presentation Layer)\n\n| Platform\n| xref:#Key_Technology_Decisions[DEC-011]\n\n| Deployment\n| App Store (iOS), Google Play (Android)\n\n| Authentication\n| xref:#Key_Technology_Decisions[DEC-011]\n|===\n\n==== Integration\n\n[cols=\"2,3\"]\n|===\n| Integration | Description\n\n| <<SBB-001 Profile Service API,SBB-001 Profile Service API>>\n| Partner linking\n\n| <<SBB-003 Loyalty Service API,SBB-003 Loyalty Service API>>\n| Balance queries / Transaction history\n|===\n\n\n<<<\n=== SBB-015: Batch File Pipeline\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| ABB Reference\n| Batch Processing\n\n| Orchestration\n| #TBD# (Batch pipeline scheduled 01:00 UTC daily)\n\n| Generation Logic\n| #TBD# (Serverless functions for transaction aggregation)\n\n| SFTP Transfer\n| #TBD# (SFTP connector with SSH key authentication)\n\n| PGP Encryption\n| #TBD# (PGP encryption activity, Flybuys 2048-bit RSA public key)\n\n| File Format\n| CSV (UTF-8 with BOM, CRLF line endings, max 200MB / 100k transactions)\n\n| Acknowledgement\n| #TBD# (SFTP polling to read acknowledgement file from Flybuys)\n\n| Batch File Naming\n| `OTR_TRANSACTIONS_\\{YYYYMMDD}_{HHMMSS}.csv.pgp`\n|===\n\n==== Batch File Processing Flow\n\nSee detailed sequence diagrams in #batch-file-retry-flow[Sequence Diagrams] for happy path and error scenarios.\n\n[mermaid]\n----\nsequenceDiagram\n    autonumber\n    participant Scheduler as Azure Data Factory<br/>(Batch Scheduler)\n    participant Loyalty as Loyalty Service\n    participant DB as Loyalty Database\n    participant SFTP as Flybuys SFTP\n    participant Flybuys as Flybuys Processing\n    participant Monitor as Monitoring\n\n    Note over Scheduler,Monitor: Nightly batch window: 01:00-02:00 UTC\n\n    Scheduler->>Loyalty: Timer trigger: 01:00 UTC<br/>Start batch job\n\n    activate Loyalty\n    Loyalty->>DB: Query RewardTransactions<br/>WHERE status=\"PENDING\"<br/>AND transactionDate=yesterday\n    activate DB\n    DB-->>Loyalty: 10,000 transactions\n    deactivate DB\n\n    Note over Loyalty: Aggregate by externalMemberId\n\n    Loyalty->>Loyalty: Generate CSV<br/>Format: memberId,date,points,storeId\n    Loyalty->>Loyalty: PGP encrypt with Flybuys public key\n    Loyalty->>Loyalty: Generate filename<br/>OTR_TRANSACTIONS_20251212_010000.csv.pgp\n\n    Loyalty->>SFTP: Upload batch file<br/>(15 minutes, 2MB file)\n    activate SFTP\n    SFTP-->>Loyalty: Upload complete\n    deactivate SFTP\n\n    Loyalty->>DB: Update RewardTransactions<br/>SET batchFileId=\"OTR_TRANSACTIONS_20251212_010000.csv.pgp\"\n    activate DB\n    DB-->>Loyalty: 10,000 rows updated\n    deactivate DB\n\n    Loyalty-->>Scheduler: Job complete (duration: 60 min)\n    deactivate Loyalty\n\n    Scheduler->>Monitor: Log success metric<br/>batch_file_generation_duration_seconds\n\n    Note over Flybuys: Flybuys processes file (2-4 hours)\n\n    Flybuys->>SFTP: Upload acknowledgement file<br/>OTR_TRANSACTIONS_20251212_010000.ack\n\n    Note over Scheduler,Monitor: Acknowledgement polling (every 30 minutes)\n\n    Scheduler->>Loyalty: Poll for acknowledgement\n    activate Loyalty\n    Loyalty->>SFTP: Check for .ack file\n    activate SFTP\n    SFTP-->>Loyalty: Found: 9,800 accepted, 200 rejected\n    deactivate SFTP\n\n    Loyalty->>DB: Update status=\"COMPLETED\" (9,800 rows)<br/>SET status=\"FAILED\" (200 rows)\n    activate DB\n    DB-->>Loyalty: Updates complete\n    deactivate DB\n\n    Loyalty-->>Scheduler: Acknowledgement processed\n    deactivate Loyalty\n\n    Scheduler->>Monitor: Log metric<br/>batch_acknowledgement_rate=98%\n----\n\n\n<<<\n=== SBB-016: Distributed Cache\n\n*ABB Reference*: Caching Layer (for Flybuys balance queries)\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| Platform\n| #TBD# (In-memory distributed cache)\n\n| Purpose\n| Cache Flybuys balance queries (5-minute TTL, reduces external API load)\n\n| Eviction Policy\n| Volatile-ttl (evict keys with shortest TTL when memory full)\n\n| Persistence\n| Not enabled (cache can be regenerated from Flybuys API)\n\n| Cache Key Format\n| `flybuys:balance:\\{externalMemberId}` (e.g., `flybuys:balance:123456789012`)\n|===\n\n==== Circuit Breaker Pattern\n\nThe distributed cache works in conjunction with circuit breakers to provide graceful degradation when external APIs fail.\n\nSee detailed sequence diagrams in #circuit-breaker-state-transitions[Sequence Diagrams] for complete state transition flows.\n\n[mermaid]\n----\nstateDiagram-v2\n    [*] --> Closed: Initial state\n\n    Closed --> Open: 5 consecutive failures\n    Closed --> Closed: Success (reset failure count)\n\n    Open --> HalfOpen: 30 seconds elapsed\n\n    HalfOpen --> Closed: Success\n    HalfOpen --> Open: Failure\n\n    Open --> Open: All requests rejected\n\n    note right of Closed\n        Normal operation\n        Requests pass through\n        Track failure count\n    end note\n\n    note right of Open\n        Fail fast\n        Return cached response\n        No calls to external API\n    end note\n\n    note right of HalfOpen\n        Test recovery\n        Single request allowed\n        Decide: Closed or Open\n    end note\n----\n\n\n<<<\n=== SBB-017: Feature Flag Service\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| ABB Reference\n| Feature Toggle Management (see xref:../architecture_definitions/flybuys_integration.adoc#Technology%2520Capability%2520Requirements[Architecture Definition §3.2.2])\n\n| Component Type\n| Infrastructure Service\n\n| Technology Stack\n| <<key-technology-decisions,DEC-014 Configuration / Feature Flags>>\n\n| Purpose\n| Dynamic feature control without code deployment, progressive rollout, instant rollback\n\n| Flag Definitions\n| See xref:../architecture_definitions/flybuys_integration.adoc#Feature%2520Flag%2520Register[Feature Flag Register] for all flags\n\n| Deployment Schedule\n| See <<Transition Phase Matrix,Transition Phase Matrix>> for rollout by architecture state\n\n| Rollback Procedures\n| See <<Rollback Strategy,Rollback Strategy>> for flag-based rollback procedures\n|===\n\n*Operational Characteristics*:\n\n* *Evaluation Frequency*: Real-time flag evaluation on each request (no caching)\n* *Update Propagation*: Flag changes propagate within 5 seconds across all service instances\n* *Monitoring*: Flag state changes logged with correlation IDs, dashboards per flag showing usage metrics\n* *Access Control*: Flag management restricted to designated roles (Platform Team, Product Owner, Operations Team per flag)\n\n<<<\n=== SBB-018: Location\n\n<<<\n== Data Architecture\n\nThis section defines the logical and physical data models for Solution Building Blocks.\n\n=== Physical Data Models\n\n==== Profile Service - PartnerLink Document Schema\n\n===== JSON Schema\n\nSee xref:../specifications/JSON%2520Schemas/PartnerLink.schema.json[PartnerLink.schema.json] for complete schema specification including field definitions, type constraints, and validation rules.\n\n===== Database Configuration\n\n*Container*: `partner-links` +\n*Partition Key*: `/vivaConsumerId` +\n*Document Type*: JSON (NoSQL document database)\n\n===== Key Fields\n\n* `id`: Unique document identifier (GUID)\n* `PartnerLinkId`: Aggregate root identifier (GUID)\n* `vivaConsumerId`: Partition key, Salesforce VCI (e.g., vci_xyz789abc)\n* `partner`: Enum - FLYBUYS | SHELL_CARD | AFL | BUDGET_DIRECT\n* `status`: Enum - linking_IN_PROGRESS | linked | UNlinked | FAILED\n* `externalMemberId`: Partner member ID (e.g., Flybuys 12-digit number)\n* `rewardPreference`: Enum - FLYBUYS_POINTS | OTR_FUEL_DISCOUNT | SHELL_PRICE_SAVE\n* `linkedAt` / `unlinkedAt`: ISO8601 timestamps\n* `oauthTokenReference`: Key Vault secret identifier\n* `metadata`: Document metadata (createdAt, updatedAt, version)\n* `_etag`: Database concurrency token\n\n===== Example Document\n\n[source,json]\n----\n{\n  \"id\": \"pl_a1b2c3d4-e5f6-7890-abcd-ef1234567890\",\n  \"PartnerLinkId\": \"a1b2c3d4-e5f6-7890-abcd-ef1234567890\",\n  \"vivaConsumerId\": \"vci_xyz789abc\",\n  \"partner\": \"FLYBUYS\",\n  \"status\": \"linked\",\n  \"externalMemberId\": \"123456789012\",\n  \"rewardPreference\": \"FLYBUYS_POINTS\",\n  \"linkedAt\": \"2025-12-09T10:30:00Z\",\n  \"unlinkedAt\": null,\n  \"oauthTokenReference\": \"flybuys-token-vci_xyz789abc\",\n  \"metadata\": {\n    \"createdAt\": \"2025-12-09T10:30:00Z\",\n    \"updatedAt\": \"2025-12-09T10:30:00Z\",\n    \"version\": 1\n  },\n  \"_etag\": \"\\\"0x8DCDEF123456\\\"\"\n}\n----\n\n===== Indexes\n\n* Primary: `/id` (automatic)\n* Partition key: `/vivaConsumerId` (automatic)\n* Composite: `[/partner ASC, /status ASC]` (custom - query all Flybuys linked partners)\n\n===== Constraints\n\n* `vivaConsumerId`: Required, must match pattern `^vci_[a-zA-Z0-9]\\{10,}$`\n* `partner`: Required, must be valid enum value\n* `status`: Required, must be valid enum value\n* `externalMemberId`: Required if status = linked\n* `rewardPreference`: Required if status = linked\n* Uniqueness: One linked partner per (vivaConsumerId, partner) combination\n\n==== Loyalty Service - RewardTransaction Document Schema\n\n===== JSON Schema\n\nSee xref:../specifications/JSON%2520Schemas/RewardTransactionDocument.schema.json[RewardTransactionDocument.schema.json] for complete schema specification including field definitions, nested structures, type constraints, and validation rules.\n\n===== Database Configuration\n\n*Container*: `reward-transactions` +\n*Partition Key*: `/vivaConsumerId` +\n*TTL*: 2592000 seconds (30 days) +\n*Document Type*: JSON (NoSQL document database)\n\n===== Key Fields\n\n* `id`: Unique document identifier (GUID)\n* `transactionId`: Aggregate root identifier (GUID)\n* `vivaConsumerId`: Partition key\n* `externalTransactionId`: D365 Commerce transaction ID\n* `transactionDate`: ISO8601 timestamp\n* `storeId`: OTR store identifier\n* `rewardPreference`: Enum - FLYBUYS_POINTS | OTR_FUEL_DISCOUNT\n* `grants[]`: Array of reward grants (grantId, partner, grantType, amount, description)\n* `transaction`: Transaction details (totalAmount, paymentMethod)\n* `partnerPosting`: Partner posting status (Flybuys batch file details)\n* `status`: Enum - PENDING | COMPLETED | FAILED\n* `metadata`: Document metadata (createdAt, ttl)\n* `_etag`: Database concurrency token\n\n===== Example Document\n\n[source,json]\n----\n{\n  \"id\": \"rt_b2c3d4e5-f6a7-8901-bcde-f12345678901\",\n  \"transactionId\": \"b2c3d4e5-f6a7-8901-bcde-f12345678901\",\n  \"vivaConsumerId\": \"vci_xyz789abc\",\n  \"externalTransactionId\": \"D365_TXN_20251209_001234\",\n  \"transactionDate\": \"2025-12-09T14:30:00Z\",\n  \"storeId\": \"OTR001\",\n  \"rewardPreference\": \"FLYBUYS_POINTS\",\n  \"grants\": [\n    {\n      \"grantId\": \"grt_c3d4e5f6-a7b8-9012-cdef-123456789012\",\n      \"partner\": \"FLYBUYS\",\n      \"grantType\": \"POINTS\",\n      \"amount\": 150,\n      \"description\": \"Base points: 100, Bonus points: 50 (fuel purchase campaign)\"\n    }\n  ],\n  \"transaction\": {\n    \"totalAmount\": 75.50,\n    \"paymentMethod\": \"CREDIT_CARD\"\n  },\n  \"partnerPosting\": {\n    \"flybuys\": {\n      \"posted\": true,\n      \"batchFileId\": \"OTR_TRANSACTIONS_20251210_010000.csv.pgp\",\n      \"postedAt\": \"2025-12-10T01:15:00Z\",\n      \"retryCount\": 0\n    }\n  },\n  \"status\": \"COMPLETED\",\n  \"metadata\": {\n    \"createdAt\": \"2025-12-09T14:30:00Z\",\n    \"ttl\": 2592000\n  },\n  \"_etag\": \"\\\"0x8DCDEF789012\\\" - database concurrency token\"\n}\n----\n\n===== Indexes\n\n* Primary: `/id` (automatic)\n* Partition key: `/vivaConsumerId` (automatic)\n* Range: `/transactionDate DESC` (custom - query recent transactions)\n\n===== Constraints\n\n* `vivaConsumerId`: Required\n* `externalTransactionId`: Required, must be unique\n* `transactionDate`: Required, cannot be future-dated\n* `grants`: Array must contain at least one grant\n* TTL: Automatically deleted 30 days after creation (audit trail summary only)\n\n==== OAuth Token Storage Schema (Key Vault)\n\n===== JSON Schema\n\nSee xref:../specifications/JSON%2520Schemas/OAuthTokenStorageSchema.schema.json[OAuthTokenStorageSchema.schema.json] for complete schema specification including OAuth token structure, expiration rules, and metadata requirements.\n\n===== Key Vault Configuration\n\n*Service*: #TBD# (Secure key vault service) +\n*Secret Naming Convention*: `\\{partner}-token-{vivaConsumerId}`\n\n===== Secret Value (JSON) - Key Fields\n\n* `accessToken`: OAuth access token (JWT, ~2KB)\n* `refreshToken`: OAuth refresh token\n* `expiresAt`: ISO8601 timestamp (60 minutes from issuance)\n* `scope`: OAuth scopes granted (e.g., member:read member:balance)\n* `tokenType`: Bearer\n\n===== Example Secret\n\n*Name*: `flybuys-token-vci_xyz789abc`\n\n*Value*:\n\n[source,json]\n----\n{\n  \"accessToken\": \"eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...\",\n  \"refreshToken\": \"rt_abc123def456...\",\n  \"expiresAt\": \"2025-12-09T15:30:00Z\",\n  \"scope\": \"member:read member:balance member:dockets\",\n  \"tokenType\": \"Bearer\"\n}\n----\n\n===== Metadata\n\n* Content Type: `application/json`\n* Enabled: `true`\n* Activation Date: Token creation timestamp\n* Expiration Date: 90 days (refresh token expiry)\n* Tags: `{ \"partner\": \"FLYBUYS\", \"vivaConsumerId\": \"vci_xyz789abc\" }`\n\n===== Encryption\n\nAES-256 with customer-managed keys (compliance with CON-003)\n\n<<<\n== Interface Specifications\n\nThis section defines the contracts between Solution Building Blocks - REST APIs, domain events, and data formats.\n\n=== Complete API Documentation\n\nSee xref:../specifications/README.md[Specifications README] for comprehensive documentation on OpenAPI, AsyncAPI, JSON Schemas, tooling, versioning, and validation.\n\n=== REST API\n\n[cols=\"2,3,2\"]\n|===\n| Service | OpenAPI Spec | Endpoints\n\n| Profile Service\n| xref:../specifications/REST/profile-service-v1.yaml[profile-service-v1.yaml]\n| 6 endpoints (profile creation, profile retrieval, partner linking, preference management)\n\n| Loyalty Service\n| xref:../specifications/REST/loyalty-service-v1.yaml[loyalty-service-v1.yaml]\n| 5 endpoints (credential resolution, transaction adjudication, balance queries)\n|===\n\n=== Domain Events\n\n==== AsyncAPI Specification\n\nxref:../specifications/AsyncAPI/otr-event-bus-v1.yaml[otr-event-bus-v1.yaml] - Complete event bus specification with 9 domain events, CloudEvents 1.0 structure, message examples, and channel definitions.\n\n==== Event Schemas\n\nAll domain events use JSON Schema definitions in xref:../specifications/JSON%2520Schemas[JSON Schemas directory]. See <<sbb-006-domain-event-bus,SBB-006>> for event catalogue.\n\n==== API Versioning Policy\n\nAll REST APIs exposed by ProfileService and LoyaltyService follow this versioning policy to manage API evolution while maintaining backwards compatibility for consumers (Mobile Application, POS systems).\n\n===== Version Numbering\n\n*URI Versioning*: Major version included in URI path (`/api/v1/`, `/api/v2/`)\n\n*Format*: `/api/v{major}/\\{resource}`\n\n*Examples*:\n\n* `/api/v1/loyalty/credentials/resolve`\n* `/api/v2/profile/customers`\n\n*Version Components*:\n\n* *Major version* (v1, v2, v3): Breaking changes to API contract\n* *Minor version* (not in URI): Additive changes, backwards compatible\n* *Patch version* (not in URI): Bug fixes, no contract changes\n\n===== When to Version\n\n*Major Version Bump (v1 → v2)* - Breaking changes requiring new URI:\n\n[cols=\"2,3,1\"]\n|===\n| Change Type | Example | Requires v2?\n\n| Remove field from response\n| Delete `walletId` from credential resolution response\n| ✓ Yes\n\n| Rename field\n| `rewardPreference` → `preferredReward`\n| ✓ Yes\n\n| Change field type\n| `linkedAt` from string to DateTime object\n| ✓ Yes\n\n| Add required request field\n| Add required `storeType` parameter\n| ✓ Yes\n\n| Change HTTP method\n| `POST` → `PUT` for same resource\n| ✓ Yes\n\n| Change status codes\n| `404` → `422` for partner not linked\n| ✓ Yes\n\n| Remove endpoint\n| Delete `GET /api/v1/legacy-endpoint`\n| ✓ Yes\n|===\n\n*Minor Version (No URI change)* - Backwards compatible additions:\n\n[cols=\"2,3,1\"]\n|===\n| Change Type | Example | Requires v2?\n\n| Add optional request field\n| Add optional `includeBalance` query parameter\n| ✗ No\n\n| Add new response field\n| Add `partnerTier` to credential resolution response\n| ✗ No\n\n| Add new endpoint\n| Add `POST /api/v1/loyalty/batch/validate`\n| ✗ No\n\n| Add new HTTP header\n| Add `X-Request-Priority` header support\n| ✗ No\n\n| Expand enum values\n| `rewardPreference` adds `SHELL_PRICE_SAVE` option\n| ✗ No\n|===\n\n*Patch Version* - Internal only, not visible to API consumers:\n\n* Bug fixes that don't change contract\n* Performance improvements\n* Internal refactoring\n\n===== Parallel Version Support\n\n*Support Duration*: Both versions supported in parallel until deprecated version reaches sunset date\n\n*Versioning Lifecycle*:\n\n. Release new major version with breaking changes\n. Run both versions in parallel during deprecation period\n. Sunset deprecated version after migration window\n. Remove deprecated version after grace period\n\n*Infrastructure*:\n\n* Both versions deployed simultaneously (same service, route-based dispatch)\n* Shared business logic where possible (avoid duplicate implementations)\n* Feature flags: `ProfileService.API.v1.Enabled`, `ProfileService.API.v2.Enabled`\n\n===== Deprecation Notification\n\n*HTTP Headers* (included in deprecated version responses):\n\n[source,http]\n----\nHTTP/1.1 200 OK\nDeprecation: true\nSunset: <sunset-date>\nxref: </api/v2/profile/customers>; rel=\"successor-version\"\nContent-Type: application/json\n----\n\n*Header Definitions*:\n\n* `Deprecation: true` - API version is deprecated (RFC 8594)\n* `Sunset: \\{date}` - Date when API will be removed (RFC 8594)\n* `xref: \\{url}; rel=\"successor-version\"` - URL of replacement API\n\n*OpenAPI Specification*:\n\n[source,yaml]\n----\nopenapi: 3.0.0\ninfo:\n  title: Profile Service API\n  version: 1.0.0\n  x-api-deprecation:\n    deprecated: true\n    sunset: \"<sunset-date>\"\n    successorVersion: \"2.0.0\"\n    migrationGuide: \"https://docs.otr.com.au/api/migration/v1-to-v2\"\n----\n\n*Consumer Communication Sequence*:\n\n. Release notes published with breaking changes documented\n. Email notification to API consumers with migration guide\n. Deprecation headers added to deprecated version responses\n. Warning logs enabled for deprecated version usage\n. Final migration reminder before sunset\n. Sunset date reached (API returns `410 Gone`)\n. Hard removal after grace period\n\n===== Version Discovery\n\n*API Root Endpoint*: `GET /api/versions`\n\n[source,json]\n----\n{\n  \"versions\": [\n    {\n      \"version\": \"1.0\",\n      \"status\": \"deprecated\",\n      \"sunsetDate\": \"<sunset-date>\",\n      \"baseUrl\": \"/api/v1\",\n      \"documentation\": \"https://docs.otr.com.au/api/v1\"\n    },\n    {\n      \"version\": \"2.0\",\n      \"status\": \"current\",\n      \"sunsetDate\": null,\n      \"baseUrl\": \"/api/v2\",\n      \"documentation\": \"https://docs.otr.com.au/api/v2\"\n    }\n  ],\n  \"recommended\": \"2.0\"\n}\n----\n\n*Status Values*:\n\n* `current`: Recommended version, fully supported\n* `supported`: Older version, still functional, no new features\n* `deprecated`: Scheduled for removal, sunset date published\n* `sunset`: No longer accepting requests, returns `410 Gone`\n\n===== Consumer Compatibility\n\n*Mobile Application*:\n\n* iOS/Android apps pin to specific API version\n* App Store updates required for major version migrations\n* Migration coordinated with mobile app release cycles\n\n*POS Systems*:\n\n* Store rollout requires coordinated deployment\n* POS configuration updated via D365 Commerce central config\n* API version specified in POS tenant configuration\n* Gradual rollout strategy to minimize disruption\n\n*Backward Compatibility Guarantee*:\n\n* Deprecated version contract remains stable during parallel support period\n* No breaking changes to deprecated version during support window\n* Bug fixes backported to deprecated version during support period\n\n===== Error Response for Sunset APIs\n\n*After Sunset Date* (`410 Gone`):\n\n[source,json]\n----\n{\n  \"error\": {\n    \"code\": \"API_VERSION_SUNSET\",\n    \"message\": \"API v1 has been sunset. Please migrate to v2.\",\n    \"sunsetDate\": \"<sunset-date>\",\n    \"successorVersion\": \"2.0\",\n    \"migrationGuide\": \"https://docs.otr.com.au/api/migration/v1-to-v2\"\n  }\n}\n----\n\n*HTTP Status*: `410 Gone` (permanent redirect, cache-safe)\n\n===== Semantic Versioning Alignment\n\nWhile URI versioning uses major version only, OpenAPI specs follow semantic versioning:\n\n* *OpenAPI spec version*: `2.3.1` (semver)\n* *API URI version*: `/api/v2/` (major only)\n\n*Mapping*:\n\n* OpenAPI `2.0.0` → URI `/api/v2/`\n* OpenAPI `2.1.0` → URI `/api/v2/` (additive change, no URI change)\n* OpenAPI `2.1.5` → URI `/api/v2/` (bug fix, no URI change)\n* OpenAPI `3.0.0` → URI `/api/v3/` (breaking change, new URI)\n\n==== Loyalty Credential Resolution API\n\n*Endpoint*: `POST /api/v1/loyalty/credentials/resolve`\n\n*Purpose*: Resolves EAN-13 barcodes scanned at xref:../bounded_context/interfaces/otr_pos.adoc[OTR POS] and xref:../bounded_context/interfaces/otr_plus_pos.adoc[OTR+ POS] to customer identity and context for Transaction Adjudication.\n\n*Request*:\n\n[source,json]\n----\n{\n  \"barcode\": \"1234567890123\",\n  \"storeId\": \"OTR001\",\n  \"transactionId\": \"TXN_20251211_001234\"\n}\n----\n\n*Request Schema*:\n\n[cols=\"1,1,1,3\"]\n|===\n| Field | Type | Required | Validation\n\n| `barcode`\n| string\n| Yes\n| Must match pattern `^\\d\\{13}$` (EAN-13)\n\n| `storeId`\n| string\n| Yes\n| Must be registered OTR store (OTR001-OTR999)\n\n| `transactionId`\n| string\n| Yes\n| Unique transaction identifier from POS\n|===\n\n*Response* (200 OK):\n\n[source,json]\n----\n{\n  \"vivaConsumerId\": \"vci_xyz789abc\",\n  \"rewardPreference\": \"FLYBUYS_POINTS\",\n  \"walletId\": \"wallet_123456\",\n  \"linkedPartners\": [\"FLYBUYS\"],\n  \"credentialType\": \"FLYBUYS_CARD\"\n}\n----\n\n*Response Schema*:\n\n[cols=\"1,1,4\"]\n|===\n| Field | Type | Description\n\n| `vivaConsumerId`\n| string\n| Viva Consumer ID from Salesforce Contact (customer identity)\n\n| `rewardPreference`\n| string\n| Enum: `FLYBUYS_POINTS` \\| `OTR_FUEL_DISCOUNT` \\| `SHELL_PRICE_SAVE`\n\n| `walletId`\n| string\n| EagleEye wallet identifier\n\n| `linkedPartners`\n| string[]\n| List of linked partner codes (e.g., `[\"FLYBUYS\", \"SHELL\"]`)\n\n| `credentialType`\n| string\n| Enum: `OTR_MOBILE` \\| `SPS_MOBILE` \\| `WALLET_PASS` \\| `FLYBUYS_CARD` \\| `FLYBUYS_MOBILE`\n|===\n\n*Error Responses*:\n\n[cols=\"1,2,3\"]\n|===\n| Status | Error Code | Description\n\n| 400\n| `INVALID_BARCODE`\n| Barcode format invalid (not 13 digits)\n\n| 404\n| `CREDENTIAL_NOT_FOUND`\n| Barcode not recognized or customer not enrolled\n\n| 422\n| `PARTNER_NOT_linked`\n| Flybuys credential presented but not linked to OTR profile\n\n| 500\n| `RESOLUTION_FAILED`\n| Internal error during resolution\n|===\n\n*Resolution Logic*:\n\n. *OTR credentials* (OTR Mobile, SPS Mobile, Apple/Google Wallet):\n** Barcode encodes OTR member ID\n** Direct lookup: OTR member ID → VCI\n** Query xref:../bounded_context/profile.adoc[Profile Service]: `GET /api/v1/profile/customers?memberId=\\{otrMemberId}`\n. *Flybuys credentials* (Physical card, Flybuys Mobile):\n** Barcode encodes Flybuys 12-digit member number\n** Extract member number from EAN-13 barcode\n** Query xref:../bounded_context/profile.adoc[Profile Service]: `GET /api/v1/profile/partner-links?partner=FLYBUYS&externalMemberId=\\{flybuysNumber}`\n** Retrieve VCI from PartnerLink aggregate\n** If no PartnerLink found → return `422 PARTNER_NOT_linked`\n\n*Performance Requirements*:\n\n* *Latency*: p95 < 500ms (xref:../architecture_definitions/flybuys_integration.adoc#Non-Functional%2520Requirements[NFR-002])\n* *Throughput*: 500 concurrent requests/sec (peak POS load across 500+ stores)\n* *Availability*: 99.9% uptime (max 4.3 hours downtime/month)\n\n==== Customer Profile Creation API\n\n*Endpoint*: `POST /api/v1/profile/customers`\n\n*Purpose*: Creates a new customer profile, retrieves VCI from Salesforce, and provisions an EagleEye wallet. Used by the xref:../ubiquitous_language.adoc#just-in-time-integration[Just-In-Time Integration] during customer login (TS-1 Foundation).\n\n*Request*:\n\n[source,json]\n----\n{\n  \"email\": \"customer@example.com\",\n  \"firstName\": \"John\",\n  \"lastName\": \"Smith\",\n  \"phone\": \"+61412345678\",\n  \"rewardPreference\": \"OTR_FUEL_DISCOUNT\"\n}\n----\n\n*Request Schema*:\n\n[cols=\"1,1,1,3\"]\n|===\n| Field | Type | Required | Validation\n\n| `email`\n| string\n| Yes\n| Valid email format (used for Salesforce Contact upsert as external key)\n\n| `firstName`\n| string\n| No\n| Customer first name\n\n| `lastName`\n| string\n| No\n| Customer last name\n\n| `phone`\n| string\n| No\n| Customer phone number\n\n| `rewardPreference`\n| string\n| No\n| Enum: `OTR_FUEL_DISCOUNT` \\| `FLYBUYS_POINTS` \\| `SHELL_PRICE_SAVE` (defaults to `OTR_FUEL_DISCOUNT`)\n|===\n\n*Response* (201 Created):\n\n[source,json]\n----\n{\n  \"vivaConsumerId\": \"vci_xyz789abc\",\n  \"salesforceContactId\": \"003Dn000001234ABC\",\n  \"rewardPreference\": \"OTR_FUEL_DISCOUNT\",\n  \"createdAt\": \"2025-12-09T10:30:00Z\",\n  \"status\": \"ACTIVE\"\n}\n----\n\n*Response Schema*:\n\n[cols=\"1,1,4\"]\n|===\n| Field | Type | Description\n\n| `vivaConsumerId`\n| string\n| Viva Consumer ID from Salesforce Contact (customer identity)\n\n| `salesforceContactId`\n| string\n| Salesforce Contact record ID\n\n| `rewardPreference`\n| string\n| Default reward preference\n\n| `createdAt`\n| string (ISO 8601)\n| Profile creation timestamp\n\n| `status`\n| string\n| Enum: `ACTIVE` \\| `SUSPENDED` \\| `CLOSED`\n|===\n\n*Error Responses*:\n\n[cols=\"1,2,3\"]\n|===\n| Status | Error Code | Description\n\n| 409\n| `PROFILE_ALREADY_EXISTS`\n| Customer profile already exists for this email (idempotent)\n\n| 503\n| `EAGLEEYE_UNAVAILABLE`\n| EagleEye wallet creation failed\n\n| 503\n| `SALESFORCE_UNAVAILABLE`\n| Salesforce Contact upsert failed\n|===\n\n*Business Rules*:\n\n* Retrieves Viva Consumer ID (VCI) from Salesforce Contact upsert response\n* Uses email address as external key for Salesforce Contact upsert\n* Upserts Salesforce Contact record using email (creates if doesn't exist, updates if exists)\n* Publishes `CustomerProfileCreated` domain event (consumed by LoyaltyService for wallet creation)\n* Returns `409 Conflict` if profile already exists for this email (idempotent operation)\n* Transaction is atomic - if Salesforce upsert fails, entire transaction is rolled back\n* *Clean DDD*: ProfileService does NOT create EagleEye wallet (LoyaltyService owns loyalty enrollment)\n\n*Event-Driven Integration*:\n\n* *LoyaltyService* subscribes to `CustomerProfileCreated` event\n* *LoyaltyService* creates EagleEye wallet asynchronously\n* *LoyaltyService* publishes `CustomerEnrolledInLoyalty` event with walletId\n* *Mobile App* can poll `GET /api/v1/profile/customers/{vivaConsumerId}` or subscribe to enrollment completion\n\n*Performance Requirements*:\n\n* *Latency*: p95 < 300ms (Salesforce Contact upsert only - wallet creation is asynchronous)\n* *Used during login flow* - fast profile creation, loyalty enrollment completes in background\n* *Availability*: 99.9% uptime (critical for customer onboarding)\n\n*Orchestration Flow (ProfileService)*:\n\n. Check if profile already exists for this email address\n. Upsert Salesforce Contact record using email as external key (create if new, update if exists)\n. Retrieve Viva Consumer ID (VCI) from Salesforce Contact upsert response\n. Create Customer aggregate in ProfileService database (VCI, email, Salesforce link)\n. Publish `CustomerProfileCreated` domain event to Event Bus\n. Return profile details with VCI (without walletId - comes later from LoyaltyService)\n\n==== Customer Profile Retrieval API\n\n*Endpoint*: `GET /api/v1/profile/customers/{vivaConsumerId}`\n\n*Purpose*: Retrieves customer profile details by Viva Consumer ID. Used by LoyaltyService during transaction adjudication to get reward preferences and wallet information.\n\n*Request Parameters*:\n\n[cols=\"1,1,1,3\"]\n|===\n| Parameter | Type | Required | Validation\n\n| `vivaConsumerId`\n| string (path)\n| Yes\n| Must be valid VCI identifier (format: vci_*)\n|===\n\n*Response* (200 OK):\n\n[source,json]\n----\n{\n  \"vivaConsumerId\": \"vci_xyz789abc\",\n  \"salesforceContactId\": \"003Dn000001234ABC\",\n  \"walletId\": \"wallet_123456\",\n  \"rewardPreference\": \"FLYBUYS_POINTS\",\n  \"createdAt\": \"2025-12-09T10:30:00Z\",\n  \"status\": \"ACTIVE\"\n}\n----\n\n*Response Schema*:\n\n[cols=\"1,1,4\"]\n|===\n| Field | Type | Description\n\n| `vivaConsumerId`\n| string\n| Viva Consumer ID from Salesforce Contact (customer identity)\n\n| `salesforceContactId`\n| string\n| Salesforce Contact record ID\n\n| `walletId`\n| string\n| EagleEye wallet identifier\n\n| `rewardPreference`\n| string\n| Customer's current reward preference\n\n| `createdAt`\n| string (ISO 8601)\n| Profile creation timestamp\n\n| `status`\n| string\n| Enum: `ACTIVE` \\| `SUSPENDED` \\| `CLOSED`\n|===\n\n*Error Responses*:\n\n[cols=\"1,2,3\"]\n|===\n| Status | Error Code | Description\n\n| 401\n| `UNAUTHORIZED`\n| Authentication failed\n\n| 404\n| `CUSTOMER_NOT_FOUND`\n| Customer profile does not exist for this VCI\n|===\n\n*Performance Requirements*:\n\n* *Latency*: p95 < 200ms\n* *Availability*: 99.9% uptime\n* *Cache Strategy*: Response can be cached for 5 minutes\n\n*Usage Examples*:\n\n* Transaction adjudication: `GET /api/v1/profile/customers/{vivaConsumerId}/reward-preference`\n* Customer lookup: `GET /api/v1/profile/customers?memberId={otrMemberId}`\n* Profile details retrieval: `GET /api/v1/profile/customers/{vivaConsumerId}`\n\n=== Domain Events\n\n*AsyncAPI Specification*: `Specifications/AsyncAPI/otr-event-bus-v1.yaml`\n\n*Event Standard*: CloudEvents 1.0 (https://cloudevents.io/)\n\n*Architecture Pattern*: Open Host Service + Published Language\n\nAll domain events follow the CloudEvents 1.0 specification and are defined with JSON Schema validation. Event schemas are maintained as separate JSON Schema files to ensure consistency and enable tooling integration (validation, code generation, documentation).\n\n==== Event Catalogue\n\n[cols=\"1,1,1,1,3\"]\n|===\n| Event | Channel | Source | JSON Schema | Description\n\n| `Partnerlinked`\n| `profile.events`\n| `/profile-service`\n| xref:../specifications/JSON%2520Schemas/Partnerlinked.event.schema.json[Partnerlinked.event.schema.json]\n| Customer successfully linked coalition partner account (Flybuys, Shell Card)\n\n| `PartnerUnlinked`\n| `profile.events`\n| `/profile-service`\n| xref:../specifications/JSON%2520Schemas/PartnerUnlinked.event.schema.json[PartnerUnlinked.event.schema.json]\n| Customer unlinked coalition partner account\n\n| `PartnerLinkFailed`\n| `profile.events`\n| `/profile-service`\n| xref:../specifications/JSON%2520Schemas/PartnerLinkFailed.event.schema.json[PartnerLinkFailed.event.schema.json]\n| Partner linking attempt failed (OAuth error, invalid credentials)\n\n| `RewardPreferenceChanged`\n| `profile.events`\n| `/profile-service`\n| xref:../specifications/JSON%2520Schemas/RewardPreferenceChanged.event.schema.json[RewardPreferenceChanged.event.schema.json]\n| Customer changed reward preference (Flybuys points ↔ OTR fuel discount)\n\n| `CustomerProfileCreated`\n| `profile.events`\n| `/profile-service`\n| xref:../specifications/JSON%2520Schemas/CustomerProfileCreated.event.schema.json[CustomerProfileCreated.event.schema.json]\n| Customer profile created during Just-In-Time Integration (VCI from Salesforce). Triggers loyalty enrollment.\n\n| `CustomerEnrolledInLoyalty`\n| `loyalty.events`\n| `/loyalty-service`\n| xref:../specifications/JSON%2520Schemas/CustomerEnrolledInLoyalty.event.schema.json[CustomerEnrolledInLoyalty.event.schema.json]\n| Customer enrolled in loyalty program (EagleEye wallet created). Published in response to CustomerProfileCreated.\n\n| `TransactionAdjudicated`\n| `loyalty.events`\n| `/loyalty-service`\n| xref:../specifications/JSON%2520Schemas/TransactionAdjudicated.event.schema.json[TransactionAdjudicated.event.schema.json]\n| Transaction adjudicated, rewards calculated and granted\n\n| `PointsEarned`\n| `loyalty.events`\n| `/loyalty-service`\n| xref:../specifications/JSON%2520Schemas/PointsEarned.event.schema.json[PointsEarned.event.schema.json]\n| Customer earned Flybuys points on transaction\n\n| `FuelDiscountApplied`\n| `loyalty.events`\n| `/loyalty-service`\n| xref:../specifications/JSON%2520Schemas/FuelDiscountApplied.event.schema.json[FuelDiscountApplied.event.schema.json]\n| Customer received OTR fuel discount on transaction\n\n| `RewardTransactionFailed`\n| `loyalty.events`\n| `/loyalty-service`\n| xref:../specifications/JSON%2520Schemas/RewardTransactionFailed.event.schema.json[RewardTransactionFailed.event.schema.json]\n| Transaction adjudication failed (system error, API timeout)\n|===\n\n==== Event Consumers\n\n[cols=\"1,2,3\"]\n|===\n| Bounded Context | Subscribed Events | Responsibility\n\n| *Loyalty Service*\n| `Partnerlinked`, `RewardPreferenceChanged`\n| Updates adjudication rules based on partner linking and preference changes\n\n| *Engagement Service*\n| `Partnerlinked`, `PartnerLinkFailed`, `RewardPreferenceChanged`, `CustomerProfileCreated`, `TransactionAdjudicated`, `PointsEarned`, `FuelDiscountApplied`\n| Sends customer notifications (linking confirmation, points earned, welcome messages)\n\n| *Recommendation Service*\n| `Partnerlinked`, `RewardPreferenceChanged`, `CustomerProfileCreated`\n| Updates personalization engine based on customer loyalty profile changes\n\n| *Analytics Service*\n| `TransactionAdjudicated`, `PointsEarned`, `FuelDiscountApplied`\n| Tracks reward transactions for business intelligence and reporting\n|===\n\n==== Event Delivery Guarantees\n\n*Delivery Semantics*: At-least-once delivery (Event Bus guarantees)\n\n*Retry Policy*:\n\n* Initial retry: Immediate\n* Subsequent retries: Exponential backoff (2s, 4s, 8s, 16s, 32s)\n* Maximum retries: 5 attempts\n* Dead Letter Queue: After 5 failed attempts, events routed to DLQ for manual investigation\n\n*Idempotency*: All event consumers must implement idempotent processing (use `id` field for deduplication)\n\n*Ordering*: Events within the same `vivaConsumerId` partition maintain order; cross-partition ordering not guaranteed\n\n=== Correlation ID Propagation Specification\n\nAll service-to-service communication and domain events must propagate correlation IDs to enable distributed tracing and request correlation across the Flybuys Integration architecture.\n\n==== Standard\n\n*W3C Trace Context* (https://www.w3.org/TR/trace-context/)\n\n==== HTTP Propagation\n\n*Headers*:\n\n* `traceparent`: Required trace context (format: `\\{version}-{trace-id}-{parent-id}-{trace-flags}`)\n* `tracestate`: Optional vendor-specific trace data\n\n*Generation Point*: API Gateway (or Mobile Application if request originates outside API Gateway)\n\n*Example*:\n\n[source,http]\n----\nPOST /api/v1/loyalty/credentials/resolve HTTP/1.1\nHost: api.otr.com.au\ntraceparent: 00-4bf92f3577b34da6a3ce929d0e0e4736-00f067aa0ba902b7-01\ntracestate: otr=t61rcWkgMzE\nContent-Type: application/json\n----\n\n*Trace ID Format*:\n\n* `version`: `00` (current W3C version)\n* `trace-id`: 32 hex characters (128-bit globally unique identifier)\n* `parent-id`: 16 hex characters (64-bit span identifier)\n* `trace-flags`: 2 hex characters (sampling decision: `01` = sampled, `00` = not sampled)\n\n*Propagation Rules*:\n\n. *API Gateway → Service*: Generate `traceparent` if not present, forward if present\n. *Service → Service*: Preserve `trace-id`, generate new `parent-id` for span\n. *Service → External API*: Propagate `traceparent` header (Flybuys, EagleEye, Salesforce)\n\n==== Event Propagation\n\n*CloudEvents Extension*: All domain events MUST include `traceparent` as CloudEvents extension attribute\n\n*Example*:\n\n[source,json]\n----\n{\n  \"specversion\": \"1.0\",\n  \"type\": \"com.otr.profile.Partnerlinked\",\n  \"source\": \"/profile-service\",\n  \"id\": \"a1b2c3d4-e5f6-7890-abcd-ef1234567890\",\n  \"time\": \"2025-12-09T14:30:00Z\",\n  \"traceparent\": \"00-4bf92f3577b34da6a3ce929d0e0e4736-00f067aa0ba902b7-01\",\n  \"datacontenttype\": \"application/json\",\n  \"data\": {\n    \"vivaConsumerId\": \"vci_xyz789abc\",\n    \"partner\": \"FLYBUYS\"\n  }\n}\n----\n\n*Event Consumer Propagation*: Consumers MUST extract `traceparent` from event and propagate to downstream calls\n\n*Example Flow*:\n\n. POS calls `POST /api/v1/loyalty/credentials/resolve` with `traceparent: 00-\\{trace-id}-{span-1}-01`\n. LoyaltyService calls ProfileService `GET /api/v1/profile/partner-links` with `traceparent: 00-\\{trace-id}-{span-2}-01`\n. ProfileService publishes `Partnerlinked` event with `traceparent: 00-\\{trace-id}-{span-3}-01`\n. All requests share same `trace-id` (`4bf92f3577b34da6a3ce929d0e0e4736`)\n\n==== Structured Logging\n\nAll log entries MUST include correlation context:\n\n*Log Format* (JSON structured logging via Serilog):\n\n[source,json]\n----\n{\n  \"timestamp\": \"2025-12-09T14:30:00.123Z\",\n  \"level\": \"Information\",\n  \"message\": \"Credential resolution completed\",\n  \"traceId\": \"4bf92f3577b34da6a3ce929d0e0e4736\",\n  \"spanId\": \"00f067aa0ba902b7\",\n  \"service\": \"loyalty-service\",\n  \"vivaConsumerId\": \"vci_xyz789abc\",\n  \"operation\": \"ResolveCredential\"\n}\n----\n\n*Required Fields*:\n\n* `traceId`: W3C trace-id (32 hex characters)\n* `spanId`: W3C parent-id (16 hex characters)\n* `service`: Service name (profile-service, loyalty-service, etc.)\n\n*Query Example*: Find all logs for a specific request\n\n----\ntraceId = \"4bf92f3577b34da6a3ce929d0e0e4736\"\n----\n\n==== Trace Visualization\n\n*Tool*: <<SBB-009 Application Monitoring,Application Monitoring>> platform (DEC-007) must support W3C Trace Context\n\n*Expected Trace View*:\n\n----\nPOS Transaction (trace-id: 4bf92f3577b34da6a3ce929d0e0e4736)\n├─ API Gateway [50ms]\n├─ LoyaltyService.ResolveCredential [280ms]\n│  ├─ ProfileService.GetPartnerLink [120ms]\n│  │  └─ Cosmos DB Query [80ms]\n│  └─ Redis Cache Lookup [15ms]\n└─ API Gateway Response [20ms]\nTotal: 350ms\n----\n\n==== Implementation Notes\n\n*Libraries*:\n\n* .NET: `System.Diagnostics.Activity` (built-in W3C Trace Context support)\n* OpenTelemetry SDK: Auto-instrumentation for HTTP and event propagation\n\n*Sampling Strategy*:\n\n* Production: 10% sampling (`trace-flags: 01` for 1 in 10 requests)\n* UAT: 100% sampling (all requests traced)\n* Error traces: Always sampled (override sampling decision on errors)\n\n*Privacy*: `traceparent` contains no PII - safe to log and transmit\n\n=== Data Formats\n\n==== Flybuys Batch File Format (CSV)\n\nFlybuys Transaction File Format v3.2 (January 2025) - external specification\n\n===== Format\n\n[source,csv]\n----\nMEMBER_ID,TRANSACTION_DATE,TRANSACTION_TIME,STORE_CODE,TRANSACTION_ID,BASE_POINTS,BONUS_POINTS,TOTAL_AMOUNT,FUEL_LITRES\n123456789012,2025-12-09,14:30:00,OTR001,TXN123456,100,50,75.50,45.2\n123456789012,2025-12-09,15:45:00,OTR002,TXN123457,200,0,120.00,0\n----\n\n===== Field Specifications\n\n[cols=\"1,1,1,1,3\"]\n|===\n| Field | Type | Length | Format | Validation\n\n| MEMBER_ID\n| String\n| 12\n| Numeric\n| Must match Flybuys member pattern (12 digits)\n\n| TRANSACTION_DATE\n| Date\n| 10\n| YYYY-MM-DD\n| Not future-dated\n\n| TRANSACTION_TIME\n| Time\n| 8\n| HH:MM:SS\n| 24-hour format\n\n| STORE_CODE\n| String\n| 10\n| Alphanumeric\n| Must be registered OTR store (OTR001-OTR999)\n\n| TRANSACTION_ID\n| String\n| 50\n| Alphanumeric\n| Unique per file (D365 Commerce transaction ID)\n\n| BASE_POINTS\n| Integer\n| 10\n| Numeric\n| Non-negative\n\n| BONUS_POINTS\n| Integer\n| 10\n| Numeric\n| Non-negative\n\n| TOTAL_AMOUNT\n| Decimal\n| 10,2\n| 99999999.99\n| Non-negative (AUD)\n\n| FUEL_LITRES\n| Decimal\n| 10,2\n| 99999999.99\n| Optional (0 for non-fuel transactions)\n|===\n\n===== File Requirements\n\n* Encoding: UTF-8 with BOM\n* Line ending: CRLF (`\\r\\n`)\n* Header row: Required (field names as shown above)\n* Max file size: 200MB (approx. 100,000 transactions)\n* Submission deadline: 02:00 UTC daily (Flybuys SLA)\n\n===== PGP Encryption Specifications\n\n* Algorithm: RSA 2048-bit + AES-256\n* Flybuys public key ID: `0xABCD1234` (expires 2026-12-31)\n* Compression: ZIP (level 6)\n* ASCII armor: Yes (`.pgp` extension)\n\n=== Interaction Flows\n\nThis section provides sequence diagrams for critical multi-service interactions across the Flybuys Integration architecture.\n\n==== OAuth linking Flow (TS-2 linking)\n\nCustomer links their Flybuys account via OAuth 2.0 Authorization Code Flow with PKCE from the Mobile Application.\n\n[mermaid]\n----\nsequenceDiagram\n    actor Customer\n    participant Mobile as Mobile App\n    participant Gateway as API Gateway\n    participant Profile as ProfileService\n    participant OAuth as OAuth Service\n    participant Flybuys as Flybuys OAuth\n    participant EventBus as Event Bus\n    participant Loyalty as LoyaltyService\n\n    Customer->>Mobile: Tap \"link Flybuys Account\"\n    Mobile->>Mobile: Generate PKCE code_verifier & code_challenge\n    Mobile->>Gateway: GET /api/v1/profile/oauth/authorize?partner=FLYBUYS\n    Gateway->>Profile: Forward request\n    Profile->>OAuth: InitiateOAuthFlow(partner=FLYBUYS, code_challenge)\n    OAuth->>OAuth: Store code_challenge + state\n    OAuth-->>Profile: OAuth URL + state\n    Profile-->>Gateway: Redirect URL\n    Gateway-->>Mobile: 302 Redirect to Flybuys OAuth\n\n    Mobile->>Flybuys: OAuth Authorization Request\n    Flybuys->>Customer: Login & Consent Screen\n    Customer->>Flybuys: Approve consent\n    Flybuys-->>Mobile: 302 Redirect with auth_code\n\n    Mobile->>Gateway: POST /api/v1/profile/oauth/callback<br/>(auth_code, code_verifier)\n    Gateway->>Profile: Forward callback\n    Profile->>OAuth: ValidateCallback(auth_code, code_verifier)\n    OAuth->>OAuth: Verify code_challenge == hash(code_verifier)\n    OAuth->>Flybuys: POST /oauth/token<br/>(auth_code, code_verifier)\n    Flybuys-->>OAuth: access_token + refresh_token\n    OAuth->>OAuth: Encrypt tokens (AES-256)\n    OAuth->>OAuth: Store in Key Vault\n    OAuth-->>Profile: Token reference + member_id\n\n    Profile->>Profile: Create PartnerLink aggregate<br/>(vivaConsumerId, partner=FLYBUYS, externalMemberId)\n    Profile->>Profile: Set rewardPreference = FLYBUYS_POINTS\n    Profile->>EventBus: Publish Partnerlinked event\n    Profile-->>Gateway: 200 OK (linking success)\n    Gateway-->>Mobile: linking confirmation\n    Mobile->>Customer: \"Flybuys account linked!\"\n\n    EventBus->>Loyalty: Consume Partnerlinked event\n    Loyalty->>Loyalty: Update adjudication rules for customer\n\n    Note over Customer,Loyalty: Error Scenarios\n\n    alt OAuth Authorization Denied\n        Customer->>Flybuys: Deny consent\n        Flybuys-->>Mobile: 302 Redirect with error=access_denied\n        Mobile->>Gateway: POST /api/v1/profile/oauth/callback?error=access_denied\n        Gateway->>Profile: Forward error\n        Profile-->>Gateway: 400 Bad Request (user cancelled)\n        Gateway-->>Mobile: linking cancelled\n        Mobile->>Customer: \"linking cancelled\"\n    end\n\n    alt Flybuys API Failure\n        OAuth->>Flybuys: POST /oauth/token\n        Flybuys-->>OAuth: 500 Internal Server Error\n        OAuth-->>Profile: OAuth token exchange failed\n        Profile-->>Gateway: 502 Bad Gateway\n        Gateway-->>Mobile: Partner temporarily unavailable\n        Mobile->>Customer: \"Flybuys unavailable, try again later\"\n    end\n----\n\n*Key Points*:\n\n* *PKCE*: Code verifier/challenge prevents authorization code interception\n* *Token Storage*: OAuth tokens encrypted in Key Vault, ProfileService stores only reference\n* *Event Publishing*: Partnerlinked event triggers LoyaltyService adjudication rule updates\n* *Error Handling*: User cancellation vs. API failure handled differently\n\n==== Just-In-Time Profile Creation Flow (TS-1 Foundation)\n\nThis flow shows how customer profiles are created on-demand during first login using the xref:../ubiquitous_language.adoc#just-in-time-integration[Just-In-Time Integration] pattern. ProfileService creates the profile and publishes an event. LoyaltyService subscribes to this event and provisions the EagleEye wallet asynchronously (clean DDD bounded context separation).\n\n[mermaid]\n----\nsequenceDiagram\n    actor Customer\n    participant Mobile as Mobile App\n    participant Gateway as API Gateway\n    participant Profile as ProfileService\n    participant ProfileDB as Profile DB\n    participant Salesforce as Salesforce\n    participant EventBus as Event Bus\n    participant Loyalty as LoyaltyService\n    participant EagleEye as EagleEye ACL\n\n    Customer->>Mobile: Login (first time)\n    Mobile->>Gateway: Authenticate with CIAM\n    Gateway-->>Mobile: JWT token (contains email, name, etc.)\n\n    Note over Mobile: Check if profile exists\n\n    Mobile->>Gateway: POST /api/v1/profile/customers<br/>{email, firstName, lastName, phone, preference}\n    Gateway->>Profile: Forward request\n    activate Profile\n\n    Profile->>ProfileDB: Check if profile exists for email\n    ProfileDB-->>Profile: Not found\n\n    Profile->>Salesforce: UPSERT Contact using email as key<br/>{email, firstName, lastName, phone}\n    Salesforce-->>Profile: Contact upserted (contactId, vivaConsumerId)\n\n    Profile->>ProfileDB: Create Customer aggregate<br/>(VCI, email, Salesforce link)\n    ProfileDB-->>Profile: Customer created\n\n    Profile->>EventBus: Publish CustomerProfileCreated event<br/>{vivaConsumerId, salesforceContactId, email, preference}\n    EventBus-->>Profile: Event published\n\n    Profile-->>Gateway: 201 Created<br/>{vivaConsumerId, salesforceContactId, status}\n    deactivate Profile\n    Gateway-->>Mobile: Profile created successfully\n\n    Note over EventBus,Loyalty: Asynchronous Enrollment (Clean DDD)\n\n    EventBus->>Loyalty: CustomerProfileCreated event\n    activate Loyalty\n\n    Loyalty->>EagleEye: POST /wallets<br/>{vivaConsumerId}\n    EagleEye-->>Loyalty: {walletId}\n\n    Loyalty->>EventBus: Publish CustomerEnrolledInLoyalty event<br/>{vivaConsumerId, walletId}\n    EventBus-->>Loyalty: Event published\n    deactivate Loyalty\n\n    Note over Mobile,Customer: Optional: Mobile polls or subscribes for enrollment\n\n    Mobile->>Customer: Login complete - loyalty enrollment in progress\n\n    Note over Customer,EagleEye: Error Scenarios\n\n    alt Profile Already Exists for Email\n        Profile->>ProfileDB: Check if profile exists for email\n        ProfileDB-->>Profile: Profile found\n        Profile-->>Gateway: 409 Conflict (profile already exists)\n        Gateway-->>Mobile: Profile exists - use existing\n        Mobile->>Mobile: Proceed with existing profile\n    end\n\n    alt Salesforce Upsert Failed\n        Profile->>Salesforce: UPSERT Contact\n        Salesforce-->>Profile: 500 Internal Server Error\n        Profile->>Profile: Rollback transaction\n        Profile-->>Gateway: 503 Salesforce unavailable\n        Gateway-->>Mobile: Contact upsert failed\n        Mobile->>Customer: \"Unable to create profile, try again\"\n    end\n\n    alt EagleEye Wallet Creation Failed (Handled by LoyaltyService)\n        Loyalty->>EagleEye: POST /wallets\n        EagleEye-->>Loyalty: 500 Internal Server Error\n        Loyalty->>Loyalty: Retry with exponential backoff\n        Note over Loyalty: Profile exists, wallet creation will retry\n    end\n----\n\n*Key Points*:\n\n* *Just-In-Time Integration*: Profile created on first login, not during registration\n* *Clean DDD Separation*: ProfileService owns identity, LoyaltyService owns loyalty enrollment (wallet creation)\n* *Event-Driven Architecture*: `CustomerProfileCreated` event triggers asynchronous wallet creation by LoyaltyService\n* *Salesforce Upsert*: Creates Salesforce Contact if it doesn't exist, updates if it does (idempotent)\n* *ProfileService Transaction*: Profile creation and Salesforce upsert are atomic (wallet creation is decoupled)\n* *Idempotent Operation*: Returns `409 Conflict` if profile already exists (safe to retry)\n* *Eventual Consistency*: Wallet creation happens asynchronously - mobile app can poll or subscribe for completion\n* *Resilience*: LoyaltyService handles EagleEye failures independently with retry logic (doesn't block profile creation)\n* *Performance Target*: ProfileService p95 < 300ms (faster - no EagleEye dependency)\n\n==== POS Integration Flow (AS-3 Grants)\n\nxref:../bounded_context/interfaces/otr_pos.adoc[OTR POS] scans Loyalty Credential barcode to resolve customer identity before transaction.\n\n[mermaid]\n----\nsequenceDiagram\n    actor Customer\n    participant POS as D365 Commerce POS\n    participant POSACL as POS ACL Adapter<br/>(D365 → Loyalty Domain)\n    participant LoyaltyACL as Loyalty ACL Adapter\n    participant Profile as ProfileService\n    participant ProfileDB as Profile DB\n\n    Customer->>POS: Present barcode\n    POS->>POS: Scan barcode (D365 format)\n\n    Note over POS,ProfileDB: D365 → Loyalty Domain Translation\n\n    POS->>POSACL: GetLoyaltyCardData(barcode, storeId)\n    POSACL->>POSACL: Translate D365 concepts:<br/>LoyaltyCard → VivaConsumerId<br/>StoreCode → siteId<br/>TransactionId → sourceTransactionId\n    POSACL->>Loyalty: POST /api/v1/loyalty/credentials/resolve<br/>{barcode, siteId, sourceTransactionId}\n\n    alt OTR Credential (direct resolution)\n        Loyalty->>Loyalty: Parse OTR member ID from barcode\n        Loyalty->>Profile: GET /customers?memberId={otrMemberId}\n        Profile->>ProfileDB: Query by memberId\n        ProfileDB-->>Profile: Customer (VCI, rewardPreference)\n        Profile-->>Loyalty: Customer context\n    else Flybuys Credential (indirect via PartnerLink)\n        Loyalty->>Loyalty: Parse Flybuys member# from barcode\n        Loyalty->>Profile: GET /partner-links?partner=FLYBUYS&externalMemberId={flybuysNumber}\n        Profile->>ProfileDB: Query PartnerLink aggregate\n        ProfileDB-->>Profile: PartnerLink (VCI, rewardPreference)\n        Profile-->>Loyalty: Customer context\n    end\n\n    Loyalty-->>LoyaltyACL: 200 OK {vivaConsumerId, rewardPreference, walletId}\n\n    Note over POSACL,ProfileDB: Loyalty Domain → D365 Translation\n\n    LoyaltyACL->>LoyaltyACL: Translate Loyalty domain:<br/>vivaConsumerId → LoyaltyCardNumber<br/>rewardPreference → LoyaltyProgramId<br/>walletId → AccountId\n    LoyaltyACL-->>POSACL: LoyaltyResponse {CardNumber, ProgramId, AccountId}\n    POSACL-->>POS: D365 LoyaltyCardData object\n    POS->>Customer: Display: \"Welcome back, Sarah!\"\n\n    Note over Customer,ProfileDB: Error Scenarios\n\n    alt ProfileService Unavailable\n        Loyalty->>Profile: GET /customers (timeout)\n        Profile-->>Loyalty: 503 Service Unavailable\n        Loyalty-->>LoyaltyACL: 503 Service Unavailable\n        LoyaltyACL->>LoyaltyACL: Map to D365 error:<br/>503 → LoyaltyErrorCode.ServiceTemporarilyUnavailable\n        LoyaltyACL-->>POSACL: LoyaltyResponse {ErrorCode, Message}\n        POSACL-->>POS: D365 error object\n        POS->>Customer: \"Loyalty temporarily unavailable, proceed without points\"\n    end\n\n    alt Invalid Barcode Format\n        Loyalty->>Loyalty: Parse barcode (validation fails)\n        Loyalty-->>LoyaltyACL: 400 Bad Request (invalid barcode format)\n        LoyaltyACL->>LoyaltyACL: Map to D365 error:<br/>400 → LoyaltyErrorCode.InvalidCardNumber\n        LoyaltyACL-->>POSACL: LoyaltyResponse {ErrorCode}\n        POSACL-->>POS: D365 error object\n        POS->>Customer: \"Barcode not recognized\"\n    end\n\n    alt Credential Not Found\n        Loyalty->>Profile: GET /partner-links (no match)\n        Profile-->>Loyalty: 404 Not Found\n        Loyalty-->>LoyaltyACL: 404 Not Found (credential not linked)\n        LoyaltyACL->>LoyaltyACL: Map to D365 error:<br/>404 → LoyaltyErrorCode.CardNotFound\n        LoyaltyACL-->>POSACL: LoyaltyResponse {ErrorCode}\n        POSACL-->>POS: D365 error object\n        POS->>Customer: \"Card not registered, visit counter\"\n    end\n\n    alt Partner Not linked\n        Loyalty->>Profile: GET /partner-links?partner=FLYBUYS\n        Profile-->>Loyalty: 200 OK {linked: false}\n        Loyalty-->>LoyaltyACL: 200 OK {requireslinking: true}\n        LoyaltyACL->>LoyaltyACL: Map to D365 business rule:<br/>requireslinking → Prompt for enrollment\n        LoyaltyACL-->>POSACL: LoyaltyResponse {RequiresEnrollment}\n        POSACL-->>POS: D365 enrollment prompt\n        POS->>Customer: \"link Flybuys in app for points\"\n    end\n----\n\n*Key Points*:\n\n* *Bidirectional ACL*: POS ACL Adapter translates D365 Commerce → Loyalty domain; Loyalty ACL Adapter translates Loyalty domain → D365 Commerce\n* *Two Credential Types*: OTR (direct via memberId) vs Flybuys (indirect via PartnerLink aggregate)\n* *Domain Isolation*: D365 POS never sees Loyalty domain concepts (VivaConsumerId, PartnerLink, RewardPreference)\n* *Error Mapping*: Loyalty HTTP status codes and error types mapped to D365 LoyaltyErrorCode enum\n\n==== POS Transaction Adjudication Flow (AS-3 Grants)\n\nCustomer presents Loyalty Credential at POS for transaction adjudication and reward determination.\n\n[mermaid]\n----\nsequenceDiagram\n    actor Customer\n    participant POS as OTR POS\n    participant Gateway as API Gateway\n    participant Loyalty as LoyaltyService\n    participant Profile as ProfileService\n    participant ProfileDB as Profile DB\n    participant EagleEye as EagleEye ACL\n    participant EagleEyeAPI as EagleEye API\n    participant EventBus as Event Bus\n\n    Customer->>POS: Present barcode (EAN-13)\n    POS->>POS: Scan barcode: \"1234567890123\"\n\n    Note over POS,Gateway: Credential Resolution Phase\n    POS->>Gateway: POST /api/v1/loyalty/credentials/resolve<br/>{barcode, storeId, transactionId}<br/>traceparent: 00-{trace-id}-{span-1}-01\n    Gateway->>Loyalty: Forward (add correlation ID)\n    Loyalty->>Loyalty: Parse EAN-13 barcode\n\n    alt OTR Credential (barcode encodes OTR member ID)\n        Loyalty->>Profile: GET /api/v1/profile/customers?memberId={otrMemberId}\n        Profile->>ProfileDB: Query by memberId\n        ProfileDB-->>Profile: Customer record (VCI, rewardPreference)\n        Profile-->>Loyalty: Customer context\n    else Flybuys Credential (barcode encodes Flybuys member number)\n        Loyalty->>Loyalty: Extract Flybuys member# from barcode\n        Loyalty->>Profile: GET /api/v1/profile/partner-links?<br/>partner=FLYBUYS&externalMemberId={flybuysNumber}\n        Profile->>ProfileDB: Query PartnerLink aggregate\n        ProfileDB-->>Profile: PartnerLink (VCI, rewardPreference)\n        Profile-->>Loyalty: Customer context\n    end\n\n    Loyalty-->>Gateway: 200 OK {vivaConsumerId, rewardPreference, walletId}\n    Gateway-->>POS: Credential resolved (280ms p95)\n    POS->>Customer: Display name: \"Welcome back, Sarah!\"\n\n    Note over Customer,EventBus: Transaction Adjudication Phase\n    Customer->>POS: Complete purchase ($75.50)\n    POS->>Gateway: POST /api/v1/loyalty/transactions/adjudicate<br/>{vivaConsumerId, transactionId, items[], total}\n    Gateway->>Loyalty: Forward request\n\n    Loyalty->>Profile: GET /api/v1/profile/customers/{vivaConsumerId}/reward-preference\n    Profile-->>Loyalty: rewardPreference = FLYBUYS_POINTS\n\n    alt Reward Preference = FLYBUYS_POINTS\n        Loyalty->>EagleEye: POST /transactions/validate<br/>(transaction details, walletId)\n        EagleEye->>EagleEyeAPI: Forward to EagleEye AIR\n        EagleEyeAPI-->>EagleEye: Provisional rewards (150 points)\n        EagleEye-->>Loyalty: Validation response\n        Loyalty->>Loyalty: Create RewardTransaction aggregate<br/>(vivaConsumerId, flybuysPoints=150, status=PENDING)\n        Loyalty-->>Gateway: 200 OK {provisionalRewards: 150 points}\n        Gateway-->>POS: Adjudication complete\n        POS->>Customer: \"You'll earn 150 Flybuys points\"\n    else Reward Preference = OTR_FUEL_DISCOUNT\n        Loyalty->>EagleEye: POST /transactions/validate<br/>(fuel discount campaign)\n        EagleEye->>EagleEyeAPI: Check fuel discount grants\n        EagleEyeAPI-->>EagleEye: 8c/L discount available\n        EagleEye-->>Loyalty: Validation response\n        Loyalty-->>Gateway: 200 OK {fuelDiscount: 8cpl}\n        Gateway-->>POS: Adjudication complete\n        POS->>Customer: \"8c/L fuel discount applied\"\n    end\n\n    Note over POS,EventBus: Post-Payment Finalization\n    POS->>POS: Payment captured\n    POS->>Gateway: POST /api/v1/loyalty/transactions/{txnId}/redeem\n    Gateway->>Loyalty: Finalize transaction\n    Loyalty->>EagleEye: POST /transactions/redeem<br/>(confirm rewards)\n    EagleEye->>EagleEyeAPI: Finalize in EagleEye\n    EagleEyeAPI-->>EagleEye: Confirmed\n    EagleEye-->>Loyalty: Redemption complete\n\n    Loyalty->>Loyalty: Update RewardTransaction<br/>(status=CONFIRMED, finalPoints=150)\n    Loyalty->>EventBus: Publish TransactionAdjudicated event\n    Loyalty-->>Gateway: 200 OK\n    Gateway-->>POS: Transaction finalized\n\n    Note over Customer,EventBus: Error Scenarios\n\n    alt ProfileService Unavailable\n        Loyalty->>Profile: GET /api/v1/profile/partner-links\n        Profile-->>Loyalty: 503 Service Unavailable\n        Loyalty->>Loyalty: Circuit breaker OPEN\n        Loyalty-->>Gateway: 503 Service Unavailable<br/>{fallback: \"proceed without points\"}\n        Gateway-->>POS: Degraded mode\n        POS->>Customer: \"Points temporarily unavailable\"\n        POS->>POS: Complete transaction without points\n    end\n\n    alt EagleEye API Timeout\n        Loyalty->>EagleEye: POST /transactions/validate\n        EagleEye->>EagleEyeAPI: Forward request\n        Note over EagleEyeAPI: Timeout after 3s\n        EagleEye-->>Loyalty: 504 Gateway Timeout\n        Loyalty->>Loyalty: Return cached default reward\n        Loyalty-->>Gateway: 200 OK {provisionalRewards: 100 points (default)}\n        Gateway-->>POS: Adjudication complete (degraded)\n        POS->>Customer: \"You'll earn ~100 points (estimate)\"\n    end\n----\n\n*Key Points*:\n\n* *Two-phase adjudication*: Validation (pre-payment) → Redemption (post-payment)\n* *Latency budget*: 500ms p95 for credential resolution (NFR-002)\n* *Graceful degradation*: Circuit breaker returns default rewards if EagleEye slow\n* *Trace propagation*: W3C traceparent header flows through all services\n\n==== Batch File Processing Flow (AS-3 Grants)\n\nNightly batch job aggregates transactions and transmits to Flybuys via SFTP.\n\n[mermaid]\n----\nsequenceDiagram\n    participant Scheduler as Batch Scheduler<br/>(Azure Data Factory)\n    participant Loyalty as LoyaltyService<br/>(Batch Job)\n    participant LoyaltyDB as Loyalty DB\n    participant D365 as D365 Commerce<br/>(POS Transactions)\n    participant FileGen as CSV Generator\n    participant PGP as PGP Encryption\n    participant SFTP as SFTP Client\n    participant Flybuys as Flybuys SFTP Server\n    participant Monitor as Monitoring\n\n    Note over Scheduler,Monitor: Daily Batch Window: 01:00 - 02:00 UTC\n\n    Scheduler->>Scheduler: Timer trigger: 01:00 UTC\n    Scheduler->>Loyalty: Start batch job<br/>(jobId, runDate=yesterday)\n\n    Note over Loyalty,D365: Phase 1: Transaction Aggregation (01:00 - 01:20)\n    Loyalty->>LoyaltyDB: Query RewardTransactions<br/>(status=CONFIRMED, date=yesterday)\n    LoyaltyDB-->>Loyalty: 50,000 transactions\n\n    Loyalty->>D365: Query transactions for reconciliation<br/>(transactionIds[])\n    D365-->>Loyalty: Transaction details\n\n    Loyalty->>Loyalty: Aggregate by Flybuys member<br/>(group by externalMemberId)\n    Loyalty->>Loyalty: Calculate BASE_POINTS + BONUS_POINTS\n    Loyalty->>Monitor: Log progress: \"Aggregated 50k transactions\"\n\n    Note over FileGen,PGP: Phase 2: File Generation (01:20 - 01:35)\n    Loyalty->>FileGen: Generate CSV file<br/>(transactions[], filename=OTR_TRANSACTIONS_20251209_010000.csv)\n    FileGen->>FileGen: Write header row\n    FileGen->>FileGen: Write 50,000 transaction rows\n    FileGen->>FileGen: Validate file format (UTF-8 BOM, CRLF)\n    FileGen-->>Loyalty: CSV file (25MB)\n\n    Loyalty->>PGP: Encrypt file<br/>(publicKey=Flybuys_RSA_2048, compression=ZIP)\n    PGP->>PGP: Compress CSV (ZIP level 6): 25MB → 8MB\n    PGP->>PGP: Encrypt with RSA+AES-256\n    PGP->>PGP: ASCII armor (.pgp extension)\n    PGP-->>Loyalty: Encrypted file (9MB)\n    Loyalty->>Monitor: Log progress: \"File generated, size=9MB\"\n\n    Note over SFTP,Flybuys: Phase 3: SFTP Transmission (01:35 - 01:50)\n    Loyalty->>SFTP: Transmit file<br/>(OTR_TRANSACTIONS_20251209_010000.csv.pgp)\n    SFTP->>Flybuys: SSH connect + authenticate\n    Flybuys-->>SFTP: Connection established\n    SFTP->>Flybuys: PUT file (9MB, ~5 min upload)\n    Flybuys-->>SFTP: Transfer complete\n    SFTP->>Flybuys: Verify checksum (MD5)\n    Flybuys-->>SFTP: Checksum OK\n    SFTP-->>Loyalty: Upload successful\n\n    Loyalty->>LoyaltyDB: Update RewardTransactions<br/>(status=POSTED_TO_FLYBUYS, postedAt=01:45 UTC)\n    Loyalty->>Monitor: Log success: \"Batch file transmitted, size=9MB, records=50k\"\n\n    Note over Flybuys,Monitor: Phase 4: Acknowledgement (01:50 - 02:00)\n    Loyalty->>Loyalty: Wait 5 minutes for ACK file\n    Loyalty->>SFTP: Poll for acknowledgement file<br/>(OTR_TRANSACTIONS_20251209_010000.ack)\n    SFTP->>Flybuys: LIST /outbound/*.ack\n\n    alt Acknowledgement File Present\n        Flybuys-->>SFTP: ACK file found\n        SFTP->>Flybuys: GET acknowledgement file\n        Flybuys-->>SFTP: ACK file content<br/>(status=SUCCESS, records=50000)\n        SFTP-->>Loyalty: ACK file downloaded\n        Loyalty->>Loyalty: Parse ACK file\n        Loyalty->>LoyaltyDB: Update batch job status=ACKNOWLEDGED\n        Loyalty->>Monitor: Log success: \"Batch acknowledged by Flybuys\"\n        Loyalty-->>Scheduler: Job complete (duration=60 min)\n    else No Acknowledgement File\n        SFTP-->>Loyalty: ACK file not found\n        Loyalty->>Loyalty: Wait 2 minutes, retry poll\n        Loyalty->>SFTP: Poll again\n\n        alt ACK Found on Retry\n            SFTP-->>Loyalty: ACK file found (retry successful)\n            Loyalty->>Monitor: Log warning: \"ACK delayed but received\"\n            Loyalty-->>Scheduler: Job complete (duration=62 min)\n        else ACK Still Missing\n            Loyalty->>Monitor: Alert CRITICAL: \"Batch ACK missing after 10 min\"\n            Loyalty->>LoyaltyDB: Update batch job status=ACK_PENDING\n            Loyalty-->>Scheduler: Job partial success (manual follow-up required)\n        end\n    end\n\n    Note over Scheduler,Monitor: Error Scenarios\n\n    alt SFTP Upload Failure\n        SFTP->>Flybuys: PUT file\n        Flybuys-->>SFTP: 500 Internal Server Error\n        SFTP-->>Loyalty: Upload failed\n        Loyalty->>Loyalty: Exponential backoff retry (2min, 4min, 8min)\n        Loyalty->>SFTP: Retry upload (attempt 2/3)\n\n        alt Retry Successful\n            SFTP->>Flybuys: PUT file (retry)\n            Flybuys-->>SFTP: Transfer complete\n            SFTP-->>Loyalty: Upload successful\n            Loyalty->>Monitor: Log warning: \"Upload succeeded on retry 2\"\n            Loyalty-->>Scheduler: Job complete\n        else All Retries Failed\n            Loyalty->>Monitor: Alert CRITICAL: \"Batch upload failed after 3 attempts\"\n            Loyalty->>LoyaltyDB: Update batch job status=FAILED\n            Loyalty-->>Scheduler: Job failed (manual intervention required)\n        end\n    end\n\n    alt Batch Window Deadline Exceeded\n        Note over Loyalty: Current time: 01:58 UTC\n        Loyalty->>Loyalty: Check time remaining: 2 minutes\n        Loyalty->>Monitor: Alert WARNING: \"Approaching 02:00 UTC deadline\"\n        Loyalty->>SFTP: Attempt final upload (priority)\n\n        alt Upload Completes Before 02:00\n            SFTP-->>Loyalty: Upload complete 01:59 UTC\n            Loyalty->>Monitor: Log warning: \"Deadline met with 1 min margin\"\n            Loyalty-->>Scheduler: Job complete (late but within SLA)\n        else Upload Exceeds 02:00 UTC\n            Note over Loyalty: Current time: 02:02 UTC\n            SFTP-->>Loyalty: Upload complete 02:02 UTC\n            Loyalty->>Monitor: Alert CRITICAL: \"SLA breach - uploaded after 02:00 UTC deadline\"\n            Loyalty->>LoyaltyDB: Update batch job status=LATE\n            Loyalty-->>Scheduler: Job complete (SLA breach, escalate to Flybuys)\n        end\n    end\n----\n\n*Key Points*:\n\n* *Batch window*: 01:00-02:00 UTC (1-hour window for 50k-100k transactions)\n* *Four phases*: Aggregation (20 min) → Generation (15 min) → Upload (15 min) → ACK (10 min)\n* *Retry strategy*: Exponential backoff for SFTP failures (2min, 4min, 8min)\n* *SLA deadline*: 02:00 UTC submission deadline enforced by Flybuys\n* *Monitoring*: Critical alerts for ACK missing, upload failures, deadline breaches\n\n<<<\n== Transition Architecture\n\nThis section defines the phased approach to migrate from current state to target architecture, showing intermediate architecture states and technical dependencies.\n\n. *No Big-Bang Migration*: Incremental rollout using Strangler Fig pattern (reference ADR-005 in Architecture Definition)\n. *Zero Downtime*: New bounded contexts operate in parallel with legacy OTR App API during transition\n. *Feature Flag Control*: All new capabilities behind feature flags (see xref:../architecture_definitions/flybuys_integration.adoc#Feature%2520Flag%2520Register[Feature Flag Register] in Architecture Definition)\n. *Data Coexistence*: Dual-write to legacy and new systems during TS-1 Foundation phase (30 days)\n. *Rollback Capability*: Each phase independently reversible without data loss\n\n=== Transition Phase Matrix\n\nProgressive rollout of feature flags across architecture states (TS-0 → TS-1 → TS-2 → AS-3 → AS-4).\n\n*Flag Definitions*: See xref:../architecture_definitions/flybuys_integration.adoc#Feature%2520Flag%2520Register[Feature Flag Register] in Architecture Definition for complete flag purposes, ownership, and strategic rationale.\n\n[cols=\"3,1,1,1,1,1\"]\n|===\n| Flag Name | TS-0 Current | TS-1 Foundation | TS-2 linking | AS-3 Grants | AS-4 Target\n\n| +OTR.Loyalty.Enabled+\n| OFF\n| ON\n| ON\n| ON\n| ON\n\n| +OTR.Loyalty.PartnerLink.Flybuys+\n| OFF\n| OFF\n| ON\n| ON\n| ON\n\n| +OTR.Loyalty.RewardPreferenceSelection+\n| OFF\n| OFF\n| ON\n| ON\n| ON\n\n| +OTR.Loyalty.TransactionAdjudication+\n| OFF\n| OFF\n| OFF\n| ON\n| ON\n\n| +OTR.Loyalty.PointsEarn.Flybuys+\n| OFF\n| OFF\n| OFF\n| ON\n| ON\n\n| +OTR.Loyalty.FlybuysBatchPosting+\n| OFF\n| OFF\n| OFF\n| ON\n| ON\n|===\n\n*Dependencies*:\n\n* +OTR.Loyalty.PartnerLink.Flybuys+ requires +OTR.Loyalty.Enabled+ = ON\n* +OTR.Loyalty.TransactionAdjudication+ requires +OTR.Loyalty.Enabled+ = ON\n* +OTR.Loyalty.PointsEarn.Flybuys+ requires +OTR.Loyalty.TransactionAdjudication+ = ON\n\n=== Rollback Strategy\n\nFeature flags enable rapid rollback without code deployment. Each architecture state can be rolled back by disabling the corresponding flags:\n\n==== TS-1 Foundation Rollback\n\n*Trigger*: VCI migration failures, EagleEye wallet creation issues, or infrastructure instability\n\n*Actions*:\n\n. Set +OTR.Loyalty.Enabled+ = OFF (disables all loyalty features)\n. Delete customer VCI records created during pilot (data cleanup)\n. Validate legacy OTR App API is functioning normally\n\n*Impact*: Mobile app reverts to legacy loyalty features (no EagleEye integration)\n\n==== TS-2 linking Rollback\n\n*Trigger*: OAuth flow failures (>5% failure rate), Flybuys API unavailability, or customer support tickets >50/day\n\n*Actions*:\n\n. Set +OTR.Loyalty.PartnerLink.Flybuys+ = OFF (disables Flybuys linking UI)\n. Set +OTR.Loyalty.RewardPreferenceSelection+ = OFF (hides reward preference selection)\n. Communicate to pilot users via push notification and email\n\n*Impact*: Customers cannot link Flybuys accounts, balance queries disabled\n\n==== AS-3 Grants Rollback\n\n*Trigger*: POS integration failures, batch file acknowledgement rate <98%, or transaction adjudication errors\n\n*Actions*:\n\n. Set +OTR.Loyalty.TransactionAdjudication+ = OFF (reverts to legacy POS integration)\n. Set +OTR.Loyalty.PointsEarn.Flybuys+ = OFF (stops points earning)\n. Set +OTR.Loyalty.FlybuysBatchPosting+ = OFF (stops daily batch transmission)\n. Re-enable Reddy Express legacy Flybuys integration (barcode pattern matching)\n\n*Impact*: POS reverts to legacy Flybuys integration, transactions in-flight may need manual reconciliation\n\n==== Partial Rollback (Batch Posting Issues Only)\n\n*Trigger*: Flybuys batch file acknowledgement failures, SFTP transmission errors\n\n*Actions*:\n\n. Set +OTR.Loyalty.FlybuysBatchPosting+ = OFF (stops batch transmission)\n. Investigate SFTP connectivity, PGP encryption, and acknowledgement file parsing\n. Keep +OTR.Loyalty.TransactionAdjudication+ = ON (POS integration continues)\n\n*Impact*: Points not posted to Flybuys immediately, requires manual batch file regeneration and transmission\n\n=== TS-0 Current State\n\nPre-initiative architecture (reference Architecture Definition §2 Current State)\n\n==== Active Components\n\n* OTR App API (AWS Lambda, DynamoDB)\n* Reddy Express legacy loyalty (SQL Server, POS barcode matching) - Flybuys-only\n* No unified customer identity (OTR users and Reddy Express customers separate)\n* No partner integrations beyond basic xref:../ubiquitous_language.adoc#flybuys-cardholder-number[Flybuys Card] scanning\n\n==== Technical Debt\n\n* Fragmented customer identity (OTR vs Reddy Express silos)\n* No event-driven architecture (synchronous-only integrations)\n* Tight POS coupling (direct Flybuys barcode pattern matching at OTR+ stores)\n* No OAuth infrastructure (no secure third-party account linking)\n\n\n=== TS-1 Foundation\n\nEstablish xref:../bounded_context/profile.adoc[Profile Service], xref:../bounded_context/loyalty.adoc[Loyalty Service], xref:../bounded_context/interfaces/otr_app_api.adoc[Event Bus] without customer-facing features\n\n==== New SBBS\n\n[cols=\"1,3\"]\n|===\n| SBB | Description\n\n| <<sbb-001-profile-service-api,SBB-001>>\n| xref:../bounded_context/profile.adoc[Profile Service] API\n\n| <<sbb-002-profile-service-database,SBB-002>>\n| xref:../bounded_context/profile.adoc[Profile Service] Database\n\n| <<sbb-003-loyalty-service-api,SBB-003>>\n| xref:../bounded_context/loyalty.adoc[Loyalty Service] API\n\n| <<sbb-004-loyalty-service-database,SBB-004>>\n| xref:../bounded_context/loyalty.adoc[Loyalty Service] Database\n\n| <<sbb-006-domain-event-bus,SBB-006>>\n| Domain xref:../bounded_context/interfaces/otr_app_api.adoc[Event Bus] (Event Grid)\n\n| SBB-008\n| Eagle Eye[Eagle Eye] Integration Adaptor\n\n| <<sbb-012-application-monitoring,SBB-012>>\n| Application Monitoring (App Insights)\n\n| <<sbb-013-api-gateway,SBB-013>>\n| API Gateway (APIM)\n|===\n\n==== Implementation Approach\n\nEnable xref:../ubiquitous_language.adoc#customer[Customer] uplift with a xref:../ubiquitous_language.adoc#dark-launch[Dark Launch] rollout strategy. New integration runs in parallel with existing system, validating technical implementation without customer impact\n\n[cols=\"2,5\"]\n|===\n| Activity | Description\n\n| Customer Profile Creation\n| xref:../ubiquitous_language.adoc#just-in-time-integration[Just-In-Time Integration] via `POST /api/v1/profile/customers` endpoint - xref:../ubiquitous_language.adoc#otr-app[Mobile Application] calls this during login if xref:../ubiquitous_language.adoc#customer[Customer] has no xref:../ubiquitous_language.adoc#viva-consumer-id-vci[VCI], creating profile and linking to Salesforce\n\n| Wallet Provisioning\n| Orchestrated by profile creation endpoint - `POST /api/v1/profile/customers` calls EagleEye ACL to provision xref:../ubiquitous_language.adoc#wallet[EagleEye Wallet] atomically with profile creation\n\n| Dual-Write Pattern\n| xref:../ubiquitous_language.adoc#otr-app[Mobile Application] sends requests to both legacy OTR App API and new xref:../bounded_context/profile.adoc[Profile Service] / xref:../bounded_context/loyalty.adoc[Loyalty Service], while legacy remains authoritative until Loyalty Value Chain[Loyalty Value Chain]\n|===\n\n===== Architecture Diagram\n\n[mermaid]\n----\ngraph TD\n    MobileApp[Mobile App]\n    LegacyAPI[Legacy API<br/>Primary]\n    Services[Profile Service<br/>Loyalty Service<br/>pilot only, dual-write]\n    EventBus[Event Bus]\n\n    MobileApp --> LegacyAPI\n    MobileApp --> Services\n    Services --> EventBus\n----\n\n===== Rollout Strategy\n\n*Note*: See xref:../architecture_definitions/flybuys_integration.adoc#Feature%2520Flag%2520Register[Feature Flag Register] in Architecture Definition for complete feature catalogue, and <<transition-phase-matrix,Transition Phase Matrix>> above for rollout schedule.\n\n[cols=\"3,1\"]\n|===\n| Flag | Status\n\n| +OTR.Loyalty.Enabled+\n| On\n\n| +OTR.Loyalty.TransactionAdjudication+\n| Off\n\n| +OTR.Loyalty.RewardPreferenceSelection+\n| Off\n\n| +OTR.Loyalty.PartnerLink.Flybuys+\n| Off\n\n| +OTR.Loyalty.PointsEarn.Flybuys+\n| Off\n|===\n\n===== Events\n\n[cols=\"2,1\"]\n|===\n| Event | Emitted\n\n| +PointsEarned+\n| No\n\n| +FlybuysPointsRedeemed+\n| No\n\n| +TransactionAdjudicated+\n| No\n\n| +PointsEarned+\n| No\n\n| +PointsRedeemed+\n| No\n\n| +PointsExpired+\n| No\n\n| +PointsAdjusted+\n| No\n\n| +CustomerProfileCreated+\n| Yes\n\n| +MemberUnenrolled+\n| No\n\n| +GrantIssued+\n| No\n\n| +GrantRedeemed+\n| No\n|===\n\n===== Success Criteria\n\n* 100% of xref:../ubiquitous_language.adoc#otr-app[Mobile Application] xref:../ubiquitous_language.adoc#customer[Customers] have xref:../ubiquitous_language.adoc#viva-consumer-id-vci[Viva Consumer ID (VCI)] allocated in xref:../bounded_context/external/salesforce_crm.adoc[Salesforce CRM]\n* 100% of xref:../ubiquitous_language.adoc#otr-app[Mobile Application] xref:../ubiquitous_language.adoc#customer[Customers] have xref:../ubiquitous_language.adoc#wallet[Wallets] allocated in xref:../bounded_context/external/eagle_eye.adoc[EagleEye]\n* No xref:../ubiquitous_language.adoc#otr-app[Mobile Application] xref:../ubiquitous_language.adoc#customer[Customers] have a linked xref:../ubiquitous_language.adoc#flybuys-digital-identity[Flybuys Digital Identity]\n* Zero production impact\n* Zero xref:../ubiquitous_language.adoc#otr-app[Mobile Application] impacts\n\n===== Dependencies\n\n* EagleEye API credentials and rate limits confirmed (external dependency - EagleEye, 1000 req/min guaranteed)\n* Infrastructure provisioning complete (internal dependency - Platform team)\n\n==== Rollback Approach\n\n* Delete xref:../ubiquitous_language.adoc#customer[Customers] uplifted xref:../bounded_context/external/salesforce_crm.adoc[Salesforce CRM] profiles\n\n===== Feature Flags\n\n[cols=\"3,1\"]\n|===\n| Flag | Status\n\n| +OTR.Loyalty.Enabled+\n| Off\n\n| +OTR.Loyalty.TransactionAdjudication+\n| Off\n\n| +OTR.Loyalty.RewardPreferenceSelection+\n| Off\n\n| +OTR.Loyalty.PartnerLink.Flybuys+\n| Off\n\n| +OTR.Loyalty.PointsEarn.Flybuys+\n| Off\n|===\n\n\n=== TS-2 linking\n\nEnable customer-facing xref:../ubiquitous_language.adoc#partner-xref[Partner Link] and xref:../ubiquitous_language.adoc#reward-preference[Reward Preference] selection in xref:../ubiquitous_language.adoc#otr-app[Mobile Applications]\n\n==== New SBB\n\n[cols=\"1,2\"]\n|===\n| SBB | Description\n\n| SBB-005\n| OAuth Token Service\n\n| SBB-007\n| Flybuys Integration Adaptor\n\n| SBB-011\n| Mobile Application Updates\n\n| SBB-013\n| Distributed Cache\n|===\n\n==== New Capabilities\n\n* xref:../ubiquitous_language.adoc#otr-app[Mobile Application] xref:../ubiquitous_language.adoc#partner-xref[Partner link] flow (xref:../ubiquitous_language.adoc#pkce[OAuth 2.0 Authorisation Code Flow with PKCE])\n* xref:../ubiquitous_language.adoc#reward-preference[Reward preference selection UI] (Flybuys points vs OTR fuel discount)\n* Real-time Flybuys balance display in mobile app wallet screen\n\n==== Implementation Approach\n\nEnable linking for xref:../ubiquitous_language.adoc#customer[Customers] using a xref:../ubiquitous_language.adoc#ring-deployments[Ring Deployments] progressive exposure strategy\n\n===== Monitoring\n\nTrack OAuth success rate, balance query latency, customer support tickets (30-day observation period)\n\n===== Cutover\n\nAfter 30 days successful pilot (>95% OAuth success rate), enable for all xref:../ubiquitous_language.adoc#customer[Customers]\n\n===== Architecture Diagram\n\n[mermaid]\n----\ngraph TD\n    A[Mobile App] --> B[API Gateway]\n    B --> C[Profile Service]\n    B --> D[Loyalty Service]\n    C --> E[Event Bus]\n    C --> F[OAuth Service + Key Vault]\n    C --> G[Flybuys API]\n    D --> E\n    D --> F\n    D --> G\n----\n\n===== Rollout\n\n====== Ring 0 (Internal Validation)\n\nStaff accounts (50 users), 7 days\n\n* Validation: Users are in xref:../bounded_context/external/salesforce_crm.adoc[Salesforce CRM] and Braze\n* Go criteria: 100% success rate, zero P1/P2 incidents\n\n====== Ring 1 (Pilot Users)\n\nCustomers who regularly use the xref:../ubiquitous_language.adoc#otr-app[Mobile Applications], 14 days\n\n* Validation: OAuth success rate >90%, customer support tickets <10/day\n* Go criteria: Meet validation targets for 7 consecutive days\n\n====== Ring 2 (General availability)\n\nAll xref:../ubiquitous_language.adoc#otr-app[Mobile Application] Customers\n\n* Deployment: Gradual rollout using percentage targeting (10% → 50% → 100% over 14 days)\n* Monitoring: Track OAuth success rate, balance query latency, customer support tickets (30-day observation period)\n\n[cols=\"3,1\"]\n|===\n| Flag | Status\n\n| +OTR.Loyalty.Enabled+\n| On\n\n| +OTR.Loyalty.TransactionAdjudication+\n| Off\n\n| +OTR.Loyalty.RewardPreferenceSelection+\n| Off\n\n| +OTR.Loyalty.PartnerLink.Flybuys+\n| On\n\n| +OTR.Loyalty.PointsEarn.Flybuys+\n| Off\n|===\n\n===== Events\n\n[cols=\"2,1\"]\n|===\n| Event | Emitted\n\n| +Partnerlinked+\n| Yes\n\n| +PartnerUnlinked+\n| Yes\n\n| +PointsEarned+\n| No\n\n| +FlybuysPointsRedeemed+\n| No\n\n| +TransactionAdjudicated+\n| No\n\n| +PointsEarned+\n| No\n\n| +PointsRedeemed+\n| No\n\n| +PointsExpired+\n| No\n\n| +PointsAdjusted+\n| No\n\n| +CustomerProfileCreated+\n| Yes\n\n| +MemberUnenrolled+\n| No\n\n| +GrantIssued+\n| No\n\n| +GrantRedeemed+\n| No\n|===\n\n===== Dependencies\n\n* Flybuys OAuth API production credentials (external - Flybuys, confirmed Nov 2025)\n* OAuth Service provisioned with Flybuys IDP connection (internal - Platform team, Dec 2025)\n* Mobile app release with linking UI\n\n===== Success Criteria\n\n* 95% of xref:../ubiquitous_language.adoc#customer[Customers] attempting xref:../ubiquitous_language.adoc#partner-xref[Partner link] are successful\n* OAuth success rate >95% over 30-day pilot period (validation exit criterion)\n* Balance query latency < 2s p95 (NFR-003)\n* Customer support tickets < 50 related to linking issues (< 0.5% of pilot users)\n\n==== Rollback Approach\n\n* Delete xref:../ubiquitous_language.adoc#partner-xref[Partner link] from pilot xref:../ubiquitous_language.adoc#customer[Customers] (customer communication required via email/push notification)\n\n===== Feature Flags\n\n[cols=\"3,1\"]\n|===\n| Flag | Status\n\n| +OTR.Loyalty.Enabled+\n| On\n\n| +OTR.Loyalty.TransactionAdjudication+\n| Off\n\n| +OTR.Loyalty.RewardPreferenceSelection+\n| On\n\n| +OTR.Loyalty.PartnerLink.Flybuys+\n| Off\n\n| +OTR.Loyalty.PointsEarn.Flybuys+\n| Off\n|===\n\n\n=== AS-3 Grants\n\n* Enable in-store xref:../bounded_context/interfaces/otr_pos.adoc[OTR POS] and xref:../bounded_context/interfaces/otr_plus_pos.adoc[OTR+ POS] xref:../ubiquitous_language.adoc#loyalty-credential[Loyalty Credential] recognition\n* Transaction posting to Flybuys (batch files)\n* xref:../ubiquitous_language.adoc#digital-fuel-dockets[Digital Fuel Docket] redemption\n\n==== New SBB\n\n[cols=\"1,3\"]\n|===\n| SBB | Description\n\n| SBB-012\n| Batch File Pipeline (serverless functions for daily aggregation, SFTP transmission)\n|===\n\n==== Implementation Approach\n\n*POS Barcode Integration*:\n\n. Deploy +POST /api/v1/loyalty/credentials/resolve+ endpoint\n. Update POS to call Loyalty Service API on barcode scan\n. Barcode Format: EAN-13 (13-digit European Article Number standard)\n. Pre-linking Requirement: Customers must link Flybuys account via mobile app OAuth flow (TS-2)\n. Error Handling: POS displays \"Please link Flybuys in mobile app\" if unlinked Flybuys credential scanned (422 error)\n\n*Rollout Strategy*:\n\n* POS Rollout: Enable barcode scanning at pilot stores (10 OTR stores), then gradual rollout\n* Batch Processing: Daily batch file generation starts (nightly 01:00 UTC job)\n\n===== Feature Flags\n\n[cols=\"3,1\"]\n|===\n| Flag | Status\n\n| +OTR.Loyalty.Enabled+\n| On\n\n| +OTR.Loyalty.TransactionAdjudication+\n| On\n\n| +OTR.Loyalty.RewardPreferenceSelection+\n| On\n\n| +OTR.Loyalty.PartnerLink.Flybuys+\n| On\n\n| +OTR.Loyalty.PointsEarn.Flybuys+\n| On\n|===\n\n*Success Criteria*:\n\n* 100% of customer transactions post to Flybuys (batch acknowledgement rate >98%, NFR-016)\n* POS barcode resolution latency < 500ms p95 (NFR-002)\n* Digital docket redemption operational at all 500+ stores\n\n=== AS-4 Target State\n\nFinal steady-state architecture after all Flybuys Integration capabilities are deployed and stabilised.\n\n==== Success Criteria (Entry to AS-4)\n\n*Prerequisites*:\n\n* AS-3 Grants operational for minimum 6 months\n* Zero critical incidents (P1/P2) in last 90 days\n* All NFRs validated and meeting targets\n* Legacy Reddy Express Flybuys integration fully decommissioned\n\n==== Characteristics of Target State\n\n===== Feature Flags\n\n* All flags remain ON (no changes from AS-3)\n* Feature flag infrastructure retained for emergency rollback capability\n\n===== Architecture\n\n* Bounded contexts operating independently\n* Event-driven integration fully operational\n* Anti-Corruption Layers protecting domain boundaries\n* Zero coupling to legacy OTR App API\n\n=== Technical Dependency Graph\n\n[mermaid]\n----\ngraph TD\n    A[TS-1: Foundation] --> B[TS-2: linking Enabled]\n    B --> C[AS-3: Grants Operational]\n    C --> D[AS-4: Target State]\n\n    A -->|Prerequisite| E[VCI Migration Complete]\n    A -->|Prerequisite| F[EagleEye Wallets Created]\n\n    B -->|Prerequisite| G[OAuth Service Ready<br/>Flybuys IDP configured]\n    B -->|Prerequisite| H[Flybuys OAuth Credentials<br/>Production API keys]\n\n    C -->|Prerequisite| I[Flybuys SFTP Access<br/>SSH keys, PGP encryption]\n    C -->|Prerequisite| J[D365 POS Integration<br/>Barcode API ready]\n\n    D -->|Prerequisite| K[6 Months Stability<br/>No critical incidents]\n    D -->|Prerequisite| L[Legacy Data Archived<br/>7-year retention]\n----\n\n=== Transition Risks\n\n[cols=\"1,3,3,2\"]\n|===\n| Risk ID | Risk Description | Mitigation | Contingency\n\n| TR-001\n| VCI migration fails (customers lose profile data)\n| Dual-write during TS-1 (30 days), legacy remains authoritative\n| Rollback to legacy OTR App API only\n\n| TR-002\n| Flybuys OAuth service outage during rollout\n| Circuit breaker pattern, cached balance data as fallback (5-min TTL)\n| Disable linking, revert to read-only balance\n\n| TR-003\n| Batch file transmission failures (points not posted)\n| Retry logic with exponential backoff (3 attempts), manual SFTP fallback\n| Manual CSV generation and upload by data team\n\n| TR-004\n| POS barcode scanning latency unacceptable (>1s)\n| Redis caching for barcode resolution (5-min TTL), load testing in UAT\n| Revert to legacy Reddy Express POS integration\n\n| TR-005\n| Event Bus delivery failures (eventual consistency)\n| Dead letter queue monitoring (alert if >100 events), replay capability\n| Synchronous API calls as fallback (temporary)\n\n| TR-006\n| Cosmos DB autoscale insufficient (RU/s throttling)\n| Monitor 429 errors, increase max RU/s (10k → 20k), partition optimization\n| Temporarily disable non-critical features\n|===\n\n<<<\n== Solution Validation\n\nThis section defines how the solution will be validated against requirements defined in the Architecture Definition.\n\n=== Functional Validation\n\n*Business Requirements*: See xref:../architecture_definitions/flybuys_integration.adoc#Business%2520Requirements[Business Requirements] in Architecture Definition for complete requirement definitions (BR-001 through BR-012).\n\n*Validation Approach*: All business requirements validated through combination of:\n\n* UAT testing with pilot users (500 mobile app users, 100 OAuth linking attempts)\n* Production pilot at 10 stores (10k transactions monitored)\n* Automated API tests (ProfileService, LoyaltyService, EagleEye integration)\n* Manual verification of batch file generation and Flybuys acknowledgement\n\n*Key Validation Checkpoints*:\n\n* *Customer Identity (BR-001, BR-002)*: 100% users have VCI allocated in Salesforce\n* *Partner linking (BR-004)*: OAuth flow completes in <30s p95\n* *Reward Preferences (BR-005, BR-006)*: Preference changes reflected within 5s\n* *Transaction Posting (BR-007)*: Transactions appear in daily batch file with correct points\n* *Balance Display (BR-010)*: Flybuys balance query returns within 2s p95\n* *Transaction Adjudication (BR-012)*: 100% credentialed transactions route to EagleEye\n\n=== Non-Functional Validation\n\n[cols=\"1,3,3,2\"]\n|===\n| NFR ID | Validation Test | Acceptance Criteria | Tool/Method\n\n| NFR-001\n| Profile Service API latency under load\n| p95 < 200ms with 100 concurrent users\n| JMeter load test (UAT, 10k requests)\n\n| NFR-002\n| Loyalty Service API latency under load\n| p95 < 500ms with 500 concurrent POS transactions/sec\n| JMeter load test (UAT, 50k requests)\n\n| NFR-003\n| Flybuys balance query latency\n| p95 < 2s including Flybuys API call + Redis cache\n| Application Insights (PROD, 30-day avg)\n\n| NFR-004\n| Batch file generation window\n| Job starts 01:00 UTC, completes by 02:00 UTC (1-hour max)\n| Batch pipeline monitoring (PROD, 30-day avg)\n\n| NFR-006\n| Profile Service uptime\n| 99.9% measured over 30 days (max 4.3 hours downtime)\n| Azure Monitor (PROD, 30-day SLA)\n\n| NFR-016\n| Batch file acknowledgement rate\n| >98% transactions acknowledged by Flybuys within 24 hours\n| PROD monitoring (60-day avg)\n|===\n\n=== Integration Validation\n\n[cols=\"2,3,3,2\"]\n|===\n| Integration Point | Validation Test | Acceptance Criteria | Method\n\n| Flybuys OAuth API\n| OAuth flow completes with valid access token\n| Token retrieved and stored in Key Vault\n| Pact contract test (UAT)\n\n| Flybuys Balance API\n| Balance query returns valid response\n| Response matches Flybuys API spec v2.1, < 1.5s latency\n| Integration test harness (UAT)\n\n| Flybuys SFTP\n| Batch file uploads successfully\n| File appears in Flybuys /inbound/otr/ directory, PGP encrypted\n| SFTP integration test (UAT)\n\n| EagleEye Adjudication\n| Transaction adjudication returns grants\n| Response matches EagleEye API spec v3, grants correct\n| Pact contract test (UAT)\n\n| Event Grid\n| Domain events published and consumed\n| Partnerlinked event delivered to Loyalty Service < 5s\n| Event Bus integration test (UAT)\n|===\n\n=== Security Validation\n\n*Validation Method*: Penetration testing (external vendor) + Security audit (internal InfoSec team)\n\n[cols=\"2,3,3,2\"]\n|===\n| Security Control | Validation Test | Acceptance Criteria | Auditor\n\n| OAuth PKCE\n| Authorization code flow uses PKCE\n| Code challenge/verifier validated (S256 method)\n| External pentest (UAT, Q1 2026)\n\n| Token encryption\n| Tokens encrypted at rest (Key Vault)\n| AES-256 encryption, customer-managed keys\n| Internal security audit (PROD)\n\n| API authentication\n| Unauthenticated requests blocked\n| 401 Unauthorized for missing/invalid tokens\n| Automated security scan (UAT)\n\n| Data residency\n| Customer data stored in Australia East region\n| Cosmos DB, Key Vault in AU region only\n| Compliance audit (PROD)\n|===\n\n=== SBB Dependency Flowchart\n\nThis flowchart visualizes the dependency relationships between Solution Building Blocks (SBBs) in the Flybuys Integration architecture.\n\n==== Dependency Chain Diagram\n\n[mermaid]\n----\ngraph TD\n    %% External Systems\n    FlybuysOAuth[External: Flybuys OAuth]\n    FlybuysAPI[External: Flybuys API]\n    EagleEyeAPI[External: EagleEye API]\n    BrazeAPI[External: Braze API]\n\n    %% Mobile & Presentation Layer\n    SBB014[SBB-014: OTR Mobile App]\n\n    %% API Gateway\n    SBB013[SBB-013: API Gateway]\n\n    %% Profile Service\n    SBB001[SBB-001: Profile Service API]\n    SBB002[SBB-002: Profile Service Database]\n\n    %% Loyalty Service\n    SBB003[SBB-003: Loyalty Service API]\n    SBB004[SBB-004: Loyalty Service Database]\n\n    %% Engagement Service\n    SBB007[SBB-007: Engagement Service API]\n    SBB008[SBB-008: Engagement Service Database]\n\n    %% Infrastructure Services\n    SBB005[SBB-005: OAuth Token Manager]\n    SBB006[SBB-006: Domain Event Bus]\n    SBB009[SBB-009: Braze Integration Adaptor]\n    SBB010[SBB-010: Flybuys Integration Adaptor]\n    SBB011[SBB-011: EagleEye Integration Adaptor]\n    SBB012[SBB-012: Application Monitoring]\n    SBB015[SBB-015: Batch File Pipeline]\n    SBB016[SBB-016: Distributed Cache]\n    SBB017[SBB-017: Feature Flag Service]\n\n    %% Mobile App Dependencies\n    SBB014 -->|Partner linking| SBB001\n    SBB014 -->|Balance queries| SBB003\n    SBB014 -->|Ingress routing| SBB013\n\n    %% API Gateway Dependencies\n    SBB013 -->|Routes to| SBB001\n    SBB013 -->|Routes to| SBB003\n    SBB013 -->|Routes to| SBB007\n\n    %% Profile Service Dependencies\n    SBB001 -->|Persists PartnerLink| SBB002\n    SBB001 -->|Token storage/retrieval| SBB005\n    SBB001 -->|Publishes events| SBB006\n    SBB001 -->|Monitored by| SBB012\n\n    %% Loyalty Service Dependencies\n    SBB003 -->|Persists transactions| SBB004\n    SBB003 -->|PartnerLink lookup| SBB001\n    SBB003 -->|Publishes/Consumes events| SBB006\n    SBB003 -->|Balance queries| SBB010\n    SBB003 -->|Transaction adjudication| SBB011\n    SBB003 -->|Caches Flybuys balance| SBB016\n    SBB003 -->|Monitored by| SBB012\n    SBB003 -->|Feature toggles| SBB017\n\n    %% OAuth Token Manager Dependencies\n    SBB005 -->|Initiates OAuth| SBB001\n    SBB005 -->|OAuth tokens| FlybuysOAuth\n\n    %% Engagement Service Dependencies\n    SBB007 -->|Persists campaign state| SBB008\n    SBB007 -->|Consumes events| SBB006\n    SBB007 -->|Triggers campaigns| SBB009\n    SBB007 -->|Monitored by| SBB012\n\n    %% Braze Integration Adaptor Dependencies\n    SBB009 -->|Consumes events| SBB006\n    SBB009 -->|Optional enrichment| SBB001\n    SBB009 -->|Webhook calls| BrazeAPI\n\n    %% Flybuys Integration Adaptor Dependencies\n    SBB010 -->|Balance API| FlybuysAPI\n    SBB010 -->|Batch file upload| SBB015\n    SBB010 -->|Cached responses| SBB016\n\n    %% EagleEye Integration Adaptor Dependencies\n    SBB011 -->|Wallet & adjudication| EagleEyeAPI\n\n    %% Batch File Pipeline Dependencies\n    SBB015 -->|Reads transactions| SBB003\n    SBB015 -->|SFTP upload| FlybuysAPI\n\n    %% Event Bus Subscribers\n    SBB006 -.->|Partnerlinked event| SBB003\n    SBB006 -.->|Partnerlinked event| SBB007\n    SBB006 -.->|TransactionAdjudicated event| SBB007\n\n    %% Styling\n    classDef external fill:#f9f,stroke:#333,stroke-width:2px\n    classDef mobile fill:#bbf,stroke:#333,stroke-width:2px\n    classDef gateway fill:#bfb,stroke:#333,stroke-width:2px\n    classDef service fill:#fbb,stroke:#333,stroke-width:2px\n    classDef database fill:#ffb,stroke:#333,stroke-width:2px\n    classDef infrastructure fill:#bff,stroke:#333,stroke-width:2px\n    classDef integration fill:#fbf,stroke:#333,stroke-width:2px\n\n    class FlybuysOAuth,FlybuysAPI,EagleEyeAPI,BrazeAPI external\n    class SBB014 mobile\n    class SBB013 gateway\n    class SBB001,SBB003,SBB007 service\n    class SBB002,SBB004,SBB008 database\n    class SBB005,SBB006,SBB012,SBB015,SBB016,SBB017 infrastructure\n    class SBB009,SBB010,SBB011 integration\n----\n\n==== Dependency Layers\n\n===== Layer 1: External Systems\n\n* Flybuys OAuth Server\n* Flybuys API (Balance, Batch File SFTP)\n* EagleEye API\n* Braze API\n\n===== Layer 2: Presentation & Gateway\n\n* *SBB-014*: OTR Mobile App\n* *SBB-013*: API Gateway (ingress routing, OAuth validation, rate limiting)\n\n===== Layer 3: Domain Services\n\n* *SBB-001*: Profile Service API (partner linking, reward preferences)\n* *SBB-003*: Loyalty Service API (credential resolution, transaction adjudication)\n* *SBB-007*: Engagement Service API (campaign orchestration)\n\n===== Layer 4: Data Stores\n\n* *SBB-002*: Profile Service Database (PartnerLink aggregates)\n* *SBB-004*: Loyalty Service Database (RewardTransaction audit trail)\n* *SBB-008*: Engagement Service Database (campaign state tracking)\n\n===== Layer 5: Infrastructure Services\n\n* *SBB-005*: OAuth Token Manager (Flybuys token storage/refresh)\n* *SBB-006*: Domain Event Bus (event-driven integration)\n* *SBB-012*: Application Monitoring (observability)\n* *SBB-016*: Distributed Cache (Flybuys balance caching)\n* *SBB-017*: Feature Flag Service (progressive rollout)\n\n===== Layer 6: Integration Adaptors (Anti-Corruption Layers)\n\n* *SBB-009*: Braze Integration Adaptor (marketing automation)\n* *SBB-010*: Flybuys Integration Adaptor (conformist pattern)\n* *SBB-011*: EagleEye Integration Adaptor (loyalty engine)\n\n===== Layer 7: Batch Processing\n\n* *SBB-015*: Batch File Pipeline (nightly transaction aggregation, SFTP transmission)\n\n==== Critical Dependency Paths\n\n===== Partner linking Flow\n\n----\nMobile App (SBB-014)\n  → API Gateway (SBB-013)\n  → Profile Service (SBB-001)\n  → OAuth Token Manager (SBB-005)\n  → Flybuys OAuth\n----\n\n===== Transaction Adjudication Flow\n\n----\nPOS System\n  → API Gateway (SBB-013)\n  → Loyalty Service (SBB-003)\n  → Profile Service (SBB-001) [PartnerLink lookup]\n  → EagleEye Adaptor (SBB-011)\n  → EagleEye API\n----\n\n===== Flybuys Balance Query Flow\n\n----\nLoyalty Service (SBB-003)\n  → Distributed Cache (SBB-016) [cache miss]\n  → Flybuys Adaptor (SBB-010)\n  → Flybuys API\n----\n\n===== Event-Driven Engagement Flow\n\n----\nProfile Service (SBB-001) [publishes Partnerlinked]\n  → Event Bus (SBB-006)\n  → Engagement Service (SBB-007)\n  → Braze Adaptor (SBB-009)\n  → Braze API\n----\n\n==== Notes\n\n* *Solid arrows (→)* indicate synchronous dependencies (REST API calls, database queries)\n* *Dotted arrows (-.->)* indicate asynchronous dependencies (event subscriptions)\n* Some SBB references in the document contain numbering errors\n","structuredPatch":[{"oldStart":2889,"oldLines":7,"newStart":2889,"newLines":7,"lines":[" * *Resilience*: LoyaltyService handles EagleEye failures independently with retry logic (doesn't block profile creation)"," * *Performance Target*: ProfileService p95 < 300ms (faster - no EagleEye dependency)"," ","-==== POS Integration Flow (AS-3 Grants)","+==== POS Integration Flow (TS-3 Grants)"," "," xref:../bounded_context/interfaces/otr_pos.adoc[OTR POS] scans Loyalty Credential barcode to resolve customer identity before transaction."," "]},{"oldStart":2984,"oldLines":7,"newStart":2984,"newLines":7,"lines":[" * *Domain Isolation*: D365 POS never sees Loyalty domain concepts (VivaConsumerId, PartnerLink, RewardPreference)"," * *Error Mapping*: Loyalty HTTP status codes and error types mapped to D365 LoyaltyErrorCode enum"," ","-==== POS Transaction Adjudication Flow (AS-3 Grants)","+==== POS Transaction Adjudication Flow (TS-3 Grants)"," "," Customer presents Loyalty Credential at POS for transaction adjudication and reward determination."," "]},{"oldStart":3098,"oldLines":7,"newStart":3098,"newLines":7,"lines":[" * *Graceful degradation*: Circuit breaker returns default rewards if EagleEye slow"," * *Trace propagation*: W3C traceparent header flows through all services"," ","-==== Batch File Processing Flow (AS-3 Grants)","+==== Batch File Processing Flow (TS-3 Grants)"," "," Nightly batch job aggregates transactions and transmits to Flybuys via SFTP."," "]},{"oldStart":3251,"oldLines":13,"newStart":3251,"newLines":13,"lines":[" "," === Transition Phase Matrix"," ","-Progressive rollout of feature flags across architecture states (TS-0 → TS-1 → TS-2 → AS-3 → AS-4).","+Progressive rollout of feature flags across architecture states (TS-0 → TS-1 → TS-2 → TS-3 → AS-4)."," "," *Flag Definitions*: See xref:../architecture_definitions/flybuys_integration.adoc#Feature%2520Flag%2520Register[Feature Flag Register] in Architecture Definition for complete flag purposes, ownership, and strategic rationale."," "," [cols=\"3,1,1,1,1,1\"]"," |===","-| Flag Name | TS-0 Current | TS-1 Foundation | TS-2 linking | AS-3 Grants | AS-4 Target","+| Flag Name | TS-0 Current | TS-1 Foundation | TS-2 linking | TS-3 Grants | AS-4 Target"," "," | +OTR.Loyalty.Enabled+"," | OFF"]},{"oldStart":3336,"oldLines":7,"newStart":3336,"newLines":7,"lines":[" "," *Impact*: Customers cannot link Flybuys accounts, balance queries disabled"," ","-==== AS-3 Grants Rollback","+==== TS-3 Grants Rollback"," "," *Trigger*: POS integration failures, batch file acknowledgement rate <98%, or transaction adjudication errors"," "]},{"oldStart":3738,"oldLines":7,"newStart":3738,"newLines":7,"lines":[" |==="," "," ","-=== AS-3 Grants","+=== TS-3 Grants"," "," * Enable in-store xref:../bounded_context/interfaces/otr_pos.adoc[OTR POS] and xref:../bounded_context/interfaces/otr_plus_pos.adoc[OTR+ POS] xref:../ubiquitous_language.adoc#loyalty-credential[Loyalty Credential] recognition"," * Transaction posting to Flybuys (batch files)"]},{"oldStart":3805,"oldLines":7,"newStart":3805,"newLines":7,"lines":[" "," *Prerequisites*:"," ","-* AS-3 Grants operational for minimum 6 months","+* TS-3 Grants operational for minimum 6 months"," * Zero critical incidents (P1/P2) in last 90 days"," * All NFRs validated and meeting targets"," * Legacy Reddy Express Flybuys integration fully decommissioned"]},{"oldStart":3814,"oldLines":7,"newStart":3814,"newLines":7,"lines":[" "," ===== Feature Flags"," ","-* All flags remain ON (no changes from AS-3)","+* All flags remain ON (no changes from TS-3)"," * Feature flag infrastructure retained for emergency rollback capability"," "," ===== Architecture"]},{"oldStart":3830,"oldLines":7,"newStart":3830,"newLines":7,"lines":[" ----"," graph TD","     A[TS-1: Foundation] --> B[TS-2: linking Enabled]","-    B --> C[AS-3: Grants Operational]","+    B --> C[TS-3: Grants Operational]","     C --> D[AS-4: Target State]"," ","     A -->|Prerequisite| E[VCI Migration Complete]"]}],"userModified":false,"replaceAll":true},"sourceToolAssistantUUID":"1aeed9d0-5301-4117-a120-5c8dda65c610"}
{"parentUuid":"e7b44afe-e313-46b3-8eb2-58e93e46c491","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01WpUMWdmNRCpC3gMje9E1GC","type":"tool_result","content":"The file /mnt/c/Users/o.young/work/architecture/solution_architectures/flybuys_integration.adoc has been updated. All occurrences of 'AS-4' were successfully replaced with 'TS-4'."}]},"uuid":"390d4831-ec88-4c1c-b8b1-fadb52d03b14","timestamp":"2026-01-08T05:38:54.997Z","toolUseResult":{"filePath":"/mnt/c/Users/o.young/work/architecture/solution_architectures/flybuys_integration.adoc","oldString":"AS-4","newString":"TS-4","originalFile":"= Flybuys Integration - Solution Architecture\n\n:project-name: Flybuys Integration\n:togaf-adm-phase: Phase E: Opportunities & Solutions\n:document-type: Solution Architecture Document\n:status: Discovery\n:version: 0.1\n:domain: Loyalty\n:programme-lead: Frankie.Mullaly@vivaenergy.com.au\n:domain-architect: O.Young@otr.com.au\n:business-owner: D.Peisley@otr.com.au\n:business-analyst: Fiona.Cheung@vivaenergy.com.au\n:architecture-definition: xref:../architecture_definitions/flybuys_integration.adoc[Architecture Definitions/Flybuys Integration]\n:doctype: article\n:toc: left\n:toclevels: 4\n:sectanchors:\n:sectxrefs:\n:sectnums:\n:icons: font\n:source-highlighter: highlightjs\n:experimental:\n:description: Solution Architecture Document for Flybuys Coalition Loyalty Integration\n:keywords: loyalty, flybuys, integration, solution-architecture, togaf\n\n== Purpose and Scope\n\n=== Purpose\n\nThis Solution Architecture defines how the Flybuys Integration will be implemented - the specific technology products, configurations, interfaces, and deployment architecture that realise the xref:../architecture_definitions/flybuys_integration.adoc[Flybuys Integration].\n\n<<<\n=== Scope\n\n==== In Scope\n\n* Solution Building Blocks (SBBs) - specific technology products and versions\n* Interface specifications (APIs, events, data formats)\n* Data architecture and schema specifications\n* Transition architecture with phased implementation states\n* Technical validation criteria and testing approach\n* External system integration specifications\n\n==== Out of Scope\n\n===== Covered in xref:../architecture_definitions/flybuys_integration.adoc[Architecture Definition]\n\n* Business requirements and stakeholder analysis\n* Architecture decisions and rationale\n* Bounded context definitions and responsibilities\n* High-level integration patterns (ACL, Conformist, OHS+PL)\n* Business capability mapping and value streams\n* Non-functional requirements (referenced, not duplicated)\n* Architecture principles and governance\n\n===== Covered in other documents\n\n* Detailed design (class diagrams, sequence diagrams for all flows)\n* Implementation code and unit tests\n* Business case and return-on-investment analysis\n* Operational run books and support procedures\n\n<<<\n== Executive Summary\n\nIntegrate xref:../bounded_context/external/flybuys.adoc[Flybuys] Coalition Loyalty across all OTRG Digital and In-Person channels without tightly coupling to external partner systems.\n\nEnable xref:../ubiquitous_language.adoc#customer[Customers] to link their xref:../ubiquitous_language.adoc#flybuys-digital-identity[Flybuys Digital Identity] with their xref:../ubiquitous_language.adoc#otr-app[Mobile Application] user profile, and present unified xref:../ubiquitous_language.adoc#loyalty-credential[Loyalty Credentials] at all xref:../bounded_context/interfaces/otr_pos.adoc[OTR POS] and xref:../bounded_context/interfaces/otr_plus_pos.adoc[OTR+ POS] stores.\n\nThe solution establishes the xref:../ubiquitous_language.adoc#viva-consumer-id-vci[Viva Consumer ID (VCI)] as *the canonical customer identifier* across all integrated systems, ensuring consistent customer reference throughout the loyalty platform and eliminating identity fragmentation.\n\n<<<\n== Solution Approach\n\n* Deploy xref:../bounded_context/profile.adoc[Profile Service] and xref:../bounded_context/loyalty.adoc[Loyalty Service] as bounded context microservices\n* Use NoSQL local document storage with partition key optimisation for caching.\n* Implement **Anti-Corruption Layers** (ACLs) for xref:../bounded_context/external/braze.adoc[Braze], xref:../bounded_context/external/flybuys.adoc[Flybuys] and xref:../bounded_context/external/eagle_eye.adoc[EagleEye] integration\n* Deploy xref:../bounded_context/interfaces/oauth.adoc[OAuth Service] with Key Vault token encryption\n* Establish event-driven architecture as the foundational integration pattern for the platform.\n* Phased roll-out (TS-1 → AS-4)\n\n=== Related Documentation\n\nThis solution architecture references detailed technical specifications:\n\n==== API Specifications\n\n* xref:../specifications/REST/profile-service-v1.yaml.md[Profile Service REST API (OpenAPI 3.0)] - Partner linking, preference management (4 endpoints)\n* xref:../specifications/AsyncAPI/otr-event-bus-v1.yaml.md[Event Bus (AsyncAPI 2.6.0)] - Domain events, CloudEvents 1.0 format\n\n==== Sequence Diagrams\n\n* Flybuys Integration Flows[Flybuys Integration Flows] - Comprehensive diagrams with happy path + error scenarios:\n** Transaction Adjudication (POS real-time, 4 scenarios)\n** OAuth Partner linking (mobile app, 4 scenarios)\n** Batch File Processing (nightly, 3 scenarios)\n** Circuit Breaker State Transitions\n** Event Propagation Timeline\n** OAuth Token Refresh (proactive + errors, 3 scenarios)\n\n==== JSON Schemas\n\n* xref:../specifications/JSON%2520Schemas/.md[JSON Schemas Directory] - Domain event schemas, request/response models\n\n==== Executive Summary\n\n* xref:../executive_summaries/flybuys_integration.adoc[Executive Summary] - 1-page overview for business stakeholders\n\n<<<\n== Key Technology Decisions\n\n[cols=\"1,2,4,3\"]\n|===\n| ID | Kind | Description | Rationale\n\n| DEC-001\n| Implementation\n| .NET 8.0\n| Aligns with OTR platform standards, team expertise in C#\n\n| DEC-002\n| Hosting\n| #TBD#\n| Autoscaling, managed infrastructure, Docker support\n\n| DEC-003\n| NoSQL Database\n| #TBD#\n| Partition key performance, global distribution, TTL support\n\n| DEC-004\n| Event Bus\n| #TBD#\n| CloudEvents 1.0 standard, built-in retry, dead letter queue\n\n| DEC-005\n| Key Storage\n| #TBD#\n| SaaS OAuth provider, Flybuys IDP integration, reduces custom implementation risk\n\n| DEC-006\n| Data Processing\n| #TBD#\n| SFTP connector, PGP encryption, scheduling\n\n| DEC-007\n| Monitoring\n| #TBD#\n| Native Azure integration, distributed tracing, correlation IDs\n\n| DEC-008\n| API Gateway\n| #TBD#\n| OAuth validation, rate limiting, request transformation\n\n| DEC-009\n| Caching Layer\n| #TBD#\n| Reduces Flybuys API load, low-latency access\n\n| DEC-010\n| Mobile App\n| #TBD#\n| Shared business logic, reduces duplicate code for iOS/Android\n\n| DEC-011\n| Authentication\n| xref:../bounded_context/external/microsoft_entra_external_id.adoc[Microsoft Entra External ID]\n| Standardised auth, secure token handling, integrates with mobile app\n\n| DEC-013\n| Resilience\n| #TBD#\n| Circuit breaker, retry policies for external API calls\n\n| DEC-014\n| Configuration / Feature Flags\n| #TBD#\n| Dynamic feature toggling, reduces deployment risk\n\n| DEC-015\n| Transport\n| REST over HTTPS\n|\n\n| DEC-016\n| Observability\n| #TBD#\n|\n\n| DEC-017\n| Deployment\n| #TBD#\n| Docker container + Azure Container Registry\n\n| DEC-018\n| Encryption (At Rest)\n| AES-256\n|\n\n| DEC-019\n| Encryption (In Flight)\n| TLS 1.3\n|\n\n| DEC-020\n| Schema Registry\n| #TBD#\n|\n|===\n\n=== Implementation Constraints\n\n* Must conform to Flybuys API specifications - cannot modify (xref:../architecture_definitions/flybuys_integration.adoc#constraints[CON-002])\n* Flybuys partnership potentially term 2-3 years - architecture must support partner flexibility (xref:../architecture_definitions/flybuys_integration.adoc#constraints[CON-006])\n* OAuth tokens must be `AES-256` encrypted at rest (<<key-technology-decisions,DEC-018>>), `TLS 1.3` in transit (DEC-018 xref:../architecture_definitions/flybuys_integration.adoc#constraints[CON-003])\n* Customer data must reside in Australia East region (xref:../architecture_definitions/flybuys_integration.adoc#constraints[CON-011])\n* Phased rollout required, no big-bang deployment (xref:../architecture_definitions/flybuys_integration.adoc#constraints[CON-004])\n\n=== Success Criteria\n\n* xref:../bounded_context/profile.adoc[Profile Service] / xref:../bounded_context/loyalty.adoc[Loyalty Service] APIs operational with <`500ms` `p95` latency (NFR-001, NFR-002)\n* OAuth linking success rate >95% over 30-day pilot period (7.5 Validation Exit Criteria)\n* Flybuys batch acknowledgement rate >98% for 60 days (NFR-016)\n\n<<<\n== Solution Building Blocks\n\nThis section maps the conceptual *Architecture Building Blocks* (ABBs) defined in the xref:../architecture_definitions/flybuys_integration.adoc[Architecture Definition] to specific *Solution Building Blocks* (SBBs).\n\n=== Technology Portfolio Catalogue\n\nThis catalogue lists all technology components required to implement the Flybuys Integration solution, mapped to the xref:../architecture_definitions/flybuys_integration.adoc#Technology%2520Capability%2520Requirements[Technology Capability Requirements] defined in the Architecture Definition.\n\n[cols=\"1,1,3,1,2,1\"]\n|===\n| Component | Category | Technology Stack | Lifecycle Stage | Rationale | Standards/Patterns\n\n| Event Bus\n| Integration\n| #TBD#\n| Planned\n| Event-driven architecture, loose coupling between services\n| OHS + Published Language\n\n| OAuth Service\n| Infrastructure\n| #TBD#\n| Planned\n| Secure token management, PCI compliance\n| OAuth 2.0, PKCE\n\n| Circuit Breaker\n| Resilience\n| #TBD#\n| Planned\n| Flybuys API failure handling\n| Circuit Breaker Pattern\n\n| Feature Flags\n| Deployment\n| #TBD#\n| Planned\n| Gradual rollout, kill switch for rollback\n| Feature Toggle Pattern\n\n| API Gateway\n| Infrastructure\n| #TBD#\n| Active\n| Single entry point, rate limiting, auth\n| RESTful API, OpenAPI\n\n| NoSQL Database\n| Data Storage\n| #TBD#\n| Active\n| Database per bounded context, high throughput\n| Database per Service\n\n| Key Vault\n| Security\n| #TBD#\n| Active\n| OAuth token storage, encryption keys\n| AES-256, Customer-Managed Keys\n\n| Redis Cache\n| Caching\n| #TBD#\n| Active\n| Flybuys balance caching (5-min TTL), circuit breaker fallback\n| In-Memory Cache, TTL Pattern\n\n| Monitoring Stack\n| Observability\n| #TBD#\n| Active\n| Distributed tracing, metrics, logging\n| OpenTelemetry, Structured Logging\n\n| Identity Provider\n| Authentication\n| xref:../bounded_context/external/microsoft_entra_external_id.adoc[Microsoft Entra External ID]\n| Active\n| Customer authentication, CIAM\n| OAuth 2.0, OIDC\n\n| SFTP Service\n| Integration\n| xref:../bounded_context/external/azure_data_factory.adoc[Azure Data Factory]\n| Active\n| Flybuys batch file transmission\n| SFTP Protocol, Batch File Transfer\n\n| Batch Scheduler\n| Infrastructure\n| xref:../bounded_context/external/azure_data_factory.adoc[Azure Data Factory]\n| Active\n| Nightly batch file generation\n| Cron-based Scheduling\n|===\n\n*Note*: Components marked #TBD# are deferred to implementation phase as engineering choices. See <<key-technology-decisions,Technology Decisions>> for evaluation criteria.\n\n<<<\n\n=== Solution Building Block Mapping\n\n[cols=\"1,3,2,3,4\"]\n|===\n| ABB ID | ABB Name | SBB ID | SBB Name | Technology Product/Component\n\n| ABB-001\n| xref:../bounded_context/profile.adoc[Profile Service] Bounded Context\n| <<sbb-001-profile-service-api,SBB-001>>\n| xref:../bounded_context/profile.adoc[Profile Service] API\n| <<key-technology-decisions,DEC-001 Implementation>>\n\n| ABB-001\n| xref:../bounded_context/profile.adoc[Profile Service] Data Store\n| <<sbb-002-profile-service-database,SBB-002>>\n| xref:../bounded_context/profile.adoc[Profile Service] Database\n| <<key-technology-decisions,DEC-003 NoSQL>>\n\n| ABB-002\n| xref:../bounded_context/loyalty.adoc[Loyalty Service] Bounded Context\n| <<sbb-003-loyalty-service-api,SBB-003>>\n| xref:../bounded_context/loyalty.adoc[Loyalty Service] API\n| <<key-technology-decisions,DEC-001 Implementation>>\n\n| ABB-002\n| xref:../bounded_context/loyalty.adoc[Loyalty Service] Data Store\n| <<sbb-004-loyalty-service-database,SBB-004>>\n| xref:../bounded_context/loyalty.adoc[Loyalty Service] Database\n| <<key-technology-decisions,DEC-003 NoSQL>>\n\n| ABB-006\n| xref:../bounded_context/interfaces/oauth.adoc[OAuth Service]\n| <<sbb-005-oauth-token-manager,SBB-005>>\n| OAuth Token Manager\n| <<key-technology-decisions,DEC-005 Key Storage>>\n\n| ABB-005\n| Event Bus[Event Bus]\n| <<sbb-006-domain-event-bus,SBB-006>>\n| Domain Event Bus\n| <<key-technology-decisions,DEC-004 Event Bus>>\n\n| ABB-004\n| xref:../bounded_context/engagement.adoc[Engagement Service] Bounded Context\n| <<sbb-007-engagement-service-api,SBB-007>>\n| xref:../bounded_context/engagement.adoc[Engagement Service] API\n| <<key-technology-decisions,DEC-001 Implementation>>\n\n| ABB-004\n| xref:../bounded_context/engagement.adoc[Engagement Service] Data Store\n| <<sbb-008-engagement-service-database,SBB-008>>\n| xref:../bounded_context/engagement.adoc[Engagement Service] Datastore\n| <<key-technology-decisions,DEC-003 NoSQL>>\n\n| ABB-012\n| Braze ACL\n| <<sbb-009-braze-integration-adaptor,SBB-009>>\n| xref:../bounded_context/external/braze.adoc[Braze Integration Adaptor]\n| <<key-technology-decisions,DEC-001 Implementation>>\n\n| ABB-013\n| Flybuys ACL\n| <<sbb-010-flybuys-integration-adaptor,SBB-010>>\n| xref:../bounded_context/external/flybuys.adoc[Flybuys Integration Adaptor]\n| <<key-technology-decisions,DEC-001 Implementation>> + <<key-technology-decisions,DEC-006 Data Processing>>\n\n| ABB-014\n| EagleEye ACL\n| <<sbb-011-eagleeye-integration-adaptor,SBB-011>>\n| xref:../bounded_context/external/eagle_eye.adoc[EagleEye Integration Adaptor]\n| <<key-technology-decisions,DEC-001 Implementation>>\n\n| ABB-009\n| Monitoring & Observability\n| <<sbb-012-application-monitoring,SBB-012>>\n| Application Monitoring\n| <<key-technology-decisions,DEC-007 Monitoring>>\n\n| ABB-007\n| API Gateway\n| <<sbb-013-api-gateway,SBB-013>>\n| xref:../bounded_context/interfaces/api_gateway.adoc[API Gateway]\n| <<key-technology-decisions,DEC-008 API Gateway>>\n\n| ABB-010\n| xref:../bounded_context/interfaces/mobile.adoc[Mobile Application]\n| <<sbb-014-otr-mobile-app,SBB-014>>\n| OTR Mobile App\n| <<key-technology-decisions,DEC-010 Mobile Application>>\n\n| ABB-015\n| Points File Management\n| <<sbb-015-batch-file-pipeline,SBB-015>>\n| Batch File Pipeline\n| <<key-technology-decisions,DEC-006 Data Processing>>\n\n| ABB-011\n| Caching Layer\n| <<sbb-016-distributed-cache,SBB-016>>\n| Distributed Cache\n| <<key-technology-decisions,DEC-009 Caching Layer>>\n\n| ABB-008\n| App Config / Feature Flags\n| <<sbb-017-feature-flag-service,SBB-017>>\n| Feature Flags\n|\n\n| ABB-003\n| xref:../bounded_context/location.adoc[Location Service] Bounded Context\n| <<sbb-018-location,SBB-018>>\n| xref:../bounded_context/location.adoc[Location Service] API\n| <<key-technology-decisions,DEC-001 Implementation>>\n\n| ABB-003\n| xref:../bounded_context/location.adoc[Location Service] Data Store\n| <<SBB-019,SBB-019>>\n| xref:../bounded_context/location.adoc[Location Service] Data Store\n|\n|===\n\n<<<\n=== SBB-001: Profile Service API\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| Description\n| Provides APIs for managing customer xref:../ubiquitous_language.adoc#partner-xref[PartnerLink]s with Flybuys, storing reward preferences, and retrieving linked profile data.\n\n| ABB Reference\n| xref:../bounded_context/profile.adoc[Profile Service] Bounded Context (see xref:../architecture_definitions/flybuys_integration.adoc#service-catalogues[Architecture Definition §3.2.1])\n\n| Component Type\n| Microservice (Domain Service)\n\n| Technology Stack\n| <<key-technology-decisions,DEC-001 Implementation>>\n\n| Hosting Platform\n| <<key-technology-decisions,DEC-002 Hosting>>\n\n| API Contract\n| <<key-technology-decisions,DEC-005 Transport>> - See xref:/specifications/rest/profile-service-v1.yaml[OpenAPI 3.0 Specification]\n\n| Authentication\n| <<key-technology-decisions,DEC-011 Authentication>>\n\n| Observability\n| <<key-technology-decisions,DEC-016 Observability>>\n\n| Configuration\n| <<key-technology-decisions,DEC-014 Configuration>>\n\n| Health Checks\n| `/health` HTTPS endpoint\n\n| Deployment Unit\n| <<key-technology-decisions,DEC-017 Deployment>>\n|===\n\n==== Dependencies\n\n[cols=\"2,2,4\"]\n|===\n| SBB ID | Dependency | Reason\n\n| <<sbb-002-profile-service-database,SBB-002>>\n| xref:../bounded_context/profile.adoc[Profile Service] Database\n| xref:../ubiquitous_language.adoc#partner-xref[PartnerLink] aggregate persistence\n\n| <<sbb-005-oauth-token-manager,SBB-005>>\n| OAuth Token Manager\n| xref:../bounded_context/external/flybuys.adoc[Flybuys] OAuth token storage/retrieval\n\n| <<sbb-006-domain-event-bus,SBB-006>>\n| Domain Event Bus\n| Publishing Partnerlinked event schema[Partnerlinked], xref:/specifications/json_schemas/RewardPreferenceChanged.event.schema.json[RewardPreferenceChanged], xref:/specifications/json_schemas/CustomerProfileCreated.event.schema.json[CustomerProfileCreated] events (see AsyncAPI Spec[AsyncAPI Spec])\n\n| <<sbb-010-flybuys-integration-adaptor,SBB-010>>\n| API Gateway\n| Ingress routing, rate limiting, OAuth validation\n\n| Salesforce\n| xref:../bounded_context/external/salesforce.adoc[Salesforce CRM]\n| Upsert Contact record during profile creation (`POST /api/v1/profile/customers`)\n|===\n\n\n<<<\n=== SBB-002: Profile Service Database\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| ABB Reference\n| xref:../bounded_context/profile.adoc[Profile Service] Data Store\n\n| Database Type\n| NoSQL Document Database\n\n| Product\n| <<key-technology-decisions,DEC-003>>\n\n| Consistency\n| Session consistency (default), Strong consistency for PartnerLink operations\n\n| Partition Strategy\n| Partition key: `/vivaConsumerId` (enables single-partition queries, ~10KB documents)\n\n| Throughput\n| Autoscale: 1000-10000 RU/s (scales based on load, avg 4000 RU/s expected)\n\n| Geo-Replication\n| xref:../architecture_definitions/flybuys_integration.adoc#Constraints[CON-011]\n\n| Backup\n| Continuous backup (7-day point-in-time recovery, hourly snapshots)\n\n| Indexes\n| Default indexing + composite index on `[/partner ASC, /status ASC]`\n\n| Containers\n| `partner-links` (main), `customer-profiles` (read model for Salesforce sync)\n\n| Data Residency\n| xref:../architecture_definitions/flybuys_integration.adoc#Constraints[CON-011]\n|===\n\n\n<<<\n=== SBB-003: Loyalty Service API\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| ABB Reference\n| xref:../bounded_context/loyalty.adoc[Loyalty Service] Bounded Context (see xref:../architecture_definitions/flybuys_integration.adoc#service-catalogues[Architecture Definition §3.2.1])\n\n| Component Type\n| Microservice (Domain Service)\n\n| Technology Stack\n| <<key-technology-decisions,DEC-001 Implementation>>\n\n| Hosting Platform\n| <<key-technology-decisions,DEC-002 Hosting>>\n\n| API Contract\n| <<key-technology-decisions,DEC-005 Transport>> - See xref:../specifications/REST/loyalty-service-v1.yaml[OpenAPI 3.0 Specification]\n\n| Batch Processing\n| <<key-technology-decisions,DEC-012 Batch Processing>>\n\n| Authentication\n| <<key-technology-decisions,DEC-011 Authentication>>\n\n| Observability\n| <<key-technology-decisions,DEC-016 Observability>>\n\n| Configuration\n| <<key-technology-decisions,DEC-014 Configuration>>\n\n| Health Checks\n| `/health` HTTPS endpoint\n\n| Deployment Unit\n| <<key-technology-decisions,DEC-017 Deployment>>\n|===\n\n==== Capabilities\n\n===== Loyalty Credential Resolution\n\n* Resolves EAN-13 barcodes from xref:../bounded_context/interfaces/otr_pos.adoc[OTR POS] and xref:../bounded_context/interfaces/otr_plus_pos.adoc[OTR+ POS] scanners to xref:../ubiquitous_language.adoc#viva-consumer-id-vci[Viva Consumer Id (VCI)]\n* Supports all xref:../ubiquitous_language.adoc#loyalty-credential[Loyalty Credential] types:\n** Barcode from xref:../bounded_context/interfaces/mobile.adoc[OTR Mobile],\n** Barcode from xref:../bounded_context/interfaces/mobile.adoc[SPS Mobile],\n** xref:../bounded_context/interfaces/mobile.adoc[Apple/Google Wallet passes],\n** Physical Flybuys cards,\n** Flybuys Mobile barcodes\n* Resolved Loyalty Credentials to\n** Direct resolution for OTR credentials (barcode → VCI)\n** Indirect resolution for Flybuys credentials (barcode → PartnerLink → VCI)\n* Returns customer context (VCI, reward preference, wallet ID) to POS within 500ms p95 (xref:../architecture_definitions/flybuys_integration.adoc#non-functional-requirements[NFR-002])\n\n==== Dependencies\n\n[cols=\"2,3,5\"]\n|===\n| SBB ID | Dependency | Reason\n\n| <<SBB-004 Loyalty Service Database,SBB-004>>\n| xref:../bounded_context/loyalty.adoc[Loyalty Service] Database\n| xref:../ubiquitous_language.adoc#reward-transaction[RewardTransaction] aggregate persistence\n\n| <<SBB-001 Profile Service API,SBB-001>>\n| xref:../bounded_context/profile.adoc[Profile Service] API\n| PartnerLink lookup for Flybuys credential resolution\n\n| <<SBB-006 Domain Event Bus,SBB-006>>\n| Domain Event Bus\n| Consuming xref:../specifications/JSON%2520Schemas/Partnerlinked.event.schema.json[Partnerlinked] events, publishing xref:../specifications/JSON%2520Schemas/TransactionAdjudicated.event.schema.json[TransactionAdjudicated] events (see xref:../specifications/AsyncAPI/otr-event-bus-v1.yaml[AsyncAPI Spec])\n\n| <<SBB-007 Flybuys Integration Adapter,SBB-007>>\n| xref:../bounded_context/external/flybuys.adoc[Flybuys Integration Adapter]\n| Balance queries, batch file transmission\n\n| <<SBB-008 EagleEye Integration Adapter,SBB-008>>\n| xref:../bounded_context/external/eagle_eye.adoc[EagleEye Integration Adapter]\n| Transaction Adjudication, wallet queries\n\n| <<SBB-010 API Gateway,SBB-010>>\n| xref:../bounded_context/interfaces/api_gateway.adoc[API Gateway]\n| Ingress routing for mobile app and POS systems\n\n| <<SBB-013 Distributed Cache,SBB-013>>\n| Distributed Cache\n| Caching Flybuys balance queries\n|===\n\n\n<<<\n=== SBB-004: Loyalty Service Database\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| ABB Reference\n| xref:../bounded_context/loyalty.adoc[Loyalty Service] Data Store\n\n| Database Type\n| NoSQL Document Database\n\n| Product\n| <<key-technology-decisions,DEC-003>>\n\n| Consistency\n| Session consistency (eventual consistency acceptable for audit trail)\n\n| Partition Strategy\n| Partition key: `/vivaConsumerId` (enables single-partition transaction queries)\n\n| Throughput\n| Autoscale: 1000-20000 RU/s (higher peak for POS transaction volume)\n\n| Geo-Replication\n| xref:../architecture_definitions/flybuys_integration.adoc#Constraints[CON-011]\n\n| Backup\n| Continuous backup (7-day point-in-time recovery)\n\n| TTL\n| 2592000 seconds (30 days) - automatic deletion for RewardTransaction documents\n\n| Indexes\n| Default indexing + range index on `/transactionDate DESC` for recent queries\n\n| Containers\n| `reward-transactions` (audit trail with 30-day TTL)\n\n| Data Residency\n| xref:../architecture_definitions/flybuys_integration.adoc#Constraints[CON-011]\n|===\n\n\n<<<\n=== SBB-005: OAuth Token Manager\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| ABB Reference\n| OAuth Service (Infrastructure)\n\n| Component Type\n| Infrastructure Service (OAuth provider + secure token storage)\n\n| Token Storage\n| <<key-technology-decisions,DEC-005>>\n\n| Token Format\n| https://www.oauth.com/oauth2-servers/access-tokens/\n\n| Secret Naming\n| `\\{partner}-token-{vivaConsumerId}` (e.g., `flybuys-token-vci_xyz789abc`)\n\n| Refresh Logic\n| Azure Function (Timer trigger every 50 minutes, before 60-minute expiry)\n\n| Encryption\n|\n|===\n\n==== OAuth Token Refresh Flow\n\nSee detailed sequence diagrams in #oauth-token-refresh-flow[Sequence Diagrams] for error scenarios including token expiry and API unavailability.\n\n[mermaid]\n----\nsequenceDiagram\n    autonumber\n    participant Timer as Azure Function<br/>(Timer Trigger)\n    participant TokenManager as OAuth Token Manager\n    participant KeyVault as Azure Key Vault\n    participant FlybuysOAuth as Flybuys OAuth Server\n    participant DB as Profile Database\n    participant Monitor as Monitoring\n\n    Note over Timer,Monitor: Timer trigger: Every 50 minutes\n\n    Timer->>TokenManager: Trigger token refresh job\n\n    activate TokenManager\n    TokenManager->>DB: Query PartnerLinks<br/>WHERE partner=\"FLYBUYS\" AND status=\"linked\"\n    activate DB\n    DB-->>TokenManager: 10,000 active PartnerLinks\n    deactivate DB\n\n    loop For each PartnerLink (batch of 100)\n        TokenManager->>KeyVault: Get token<br/>SecretName: flybuys-token-{vci}\n        activate KeyVault\n        KeyVault-->>TokenManager: {access_token, refresh_token, expiresAt}\n        deactivate KeyVault\n\n        TokenManager->>TokenManager: Check: expiresAt - now < 10 minutes?\n\n        alt Token expiring soon\n            TokenManager->>FlybuysOAuth: POST /token<br/>{grant_type: \"refresh_token\", refresh_token}\n            activate FlybuysOAuth\n            FlybuysOAuth->>FlybuysOAuth: Validate refresh_token\n            FlybuysOAuth-->>TokenManager: {access_token (new), refresh_token (new), expires_in: 3600}\n            deactivate FlybuysOAuth\n\n            TokenManager->>KeyVault: Update secret<br/>flybuys-token-{vci}\n            activate KeyVault\n            KeyVault-->>TokenManager: Secret updated\n            deactivate KeyVault\n\n            TokenManager->>Monitor: Metric: token_refresh_success\n        else Token still valid\n            TokenManager->>Monitor: Metric: token_refresh_skipped\n        end\n    end\n\n    TokenManager-->>Timer: Job complete<br/>Refreshed: 8,500 tokens<br/>Skipped: 1,500 tokens\n    deactivate TokenManager\n\n    Timer->>Monitor: Log job duration: 45 seconds\n----\n\n==== Dependencies\n\n[cols=\"2,2,4\"]\n|===\n| SBB ID | Dependency | Reason\n\n| <<SBB-001 Profile Service API,SBB-001>>\n| xref:../bounded_context/profile.adoc[Profile Service]\n| Initiates OAuth flow, stores `oauthTokenReference` in PartnerLink\n\n| External\n| OAuth Provider\n| Flybuys OAuth API integration\n|===\n\n\n<<<\n=== SBB-006: Domain Event Bus\n\n==== Event Specifications\n\nSee xref:../specifications/AsyncAPI/otr-event-bus-v1.yaml[AsyncAPI 2.6.0 Specification] for complete event definitions, schemas, and examples. Individual event schemas available in xref:../specifications/JSON%2520Schemas[JSON Schemas directory].\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| ABB Reference\n| Domain Event Bus\n\n| Platform\n| <<key-technology-decisions,DEC-004>>\n\n| Retention\n| 7 days (with dead letter queue for failed deliveries)\n\n| Schema Registry\n| <<key-technology-decisions,DEC-020>>\n\n| Delivery Guarantee\n| At-least-once delivery with retry (max 30 attempts, exponential backoff)\n\n| Monitoring\n| <<key-technology-decisions,DEC-007>>\n|===\n\n===== Topics\n\n*Profile Events* (`profile.events` topic)\n\n[cols=\"2,3,1\"]\n|===\n| Event Name | Description | Schema\n\n| `PartnerLinked`\n| Partner account linked to customer profile\n| PartnerLinked event schema[Schema]\n\n| `PartnerUnlinked`\n| Partner account unlinked from customer\n| xref:../specifications/JSON%2520Schemas/PartnerUnlinked.event.schema.json[Schema]\n\n| `RewardPreferenceChanged`\n| Customer changed reward preference selection\n| xref:../specifications/JSON%2520Schemas/RewardPreferenceChanged.event.schema.json[Schema]\n|===\n\n*Loyalty Events* (`loyalty.events` topic)\n\n[cols=\"2,3,1\"]\n|===\n| Event Name | Description | Schema\n\n| `CustomerProfileCreated`\n| Customer profile created during Just-In-Time Integration\n| xref:../specifications/JSON%2520Schemas/CustomerProfileCreated.event.schema.json[Schema]\n\n| `TransactionAdjudicated`\n| Transaction Adjudication completed\n| xref:../specifications/JSON%2520Schemas/TransactionAdjudicated.event.schema.json[Schema]\n\n| `PointsEarned`\n| Points earned in loyalty programme\n| xref:../specifications/JSON%2520Schemas/PointsEarned.event.schema.json[Schema]\n\n| `FuelDiscountApplied`\n| Fuel discount applied to transaction\n| xref:../specifications/JSON%2520Schemas/FuelDiscountApplied.event.schema.json[Schema]\n\n| `RewardTransactionFailed`\n| Transaction adjudication failed\n| xref:../specifications/JSON%2520Schemas/RewardTransactionFailed.event.schema.json[Schema]\n\n| `PointsRedeemed`\n| Points redeemed in loyalty programme\n| _Planned_\n\n| `PointsExpired`\n| Points expired\n| _Planned_\n\n| `GrantIssued`\n| Loyalty grant issued\n| _Planned_\n\n| `GrantRedeemed`\n| Loyalty grant redeemed\n| _Planned_\n\n| `FlybuysPointsEarned`\n| Points earned in Flybuys programme\n| _Planned_\n\n| `FlybuysBalanceUpdated`\n| Flybuys points balance changed\n| _Planned_\n\n| `PartnerAccountlinked`\n| Flybuys member linked (OAuth complete)\n| _Planned_\n\n| `PartnerAccountUnlinked`\n| Flybuys member unlinked\n| _Planned_\n\n| `DailyPointsFileGenerated`\n| Daily partner points file generated\n| _Planned_\n\n| `DailyPointsFileTransmitted`\n| Daily points file sent to partner\n| _Planned_\n\n| `DailyPointsFileAcknowledged`\n| Partner acknowledged file receipt\n| _Planned_\n|===\n\n==== Event Documentation\n\nSee xref:../specifications/AsyncAPI/otr-event-bus-v1.yaml[AsyncAPI Specification] for complete event definitions with examples, or xref:../bounded_context/loyalty.cml[Bounded Context/loyalty.cml] for CML domain model. CloudEvents 1.0 specification used for all domain events.\n\n==== Event Propagation Timeline\n\nSee detailed sequence diagrams in #event-propagation-timeline[Sequence Diagrams] for out-of-order event handling and version-based conflict resolution.\n\n[mermaid]\n----\nsequenceDiagram\n    autonumber\n    participant Mobile as Mobile App\n    participant Profile as Profile Service\n    participant EventBus as Event Bus\n    participant Loyalty as Loyalty Service\n    participant Engagement as Engagement Service\n\n    Note over Mobile,Engagement: T=0: OAuth linking completes\n\n    Mobile->>Profile: POST /partners\n    activate Profile\n    Profile->>Profile: Store PartnerLink (status: linked)\n    Profile->>Profile: Commit database transaction\n\n    Note over Profile: T+50ms: Transaction committed\n\n    Profile->>EventBus: Publish Partnerlinked event<br/>{vivaConsumerId, partner, externalMemberId}\n    activate EventBus\n    EventBus->>EventBus: Persist event (durability guarantee)\n    EventBus-->>Profile: Event ID: evt-123456\n    deactivate EventBus\n\n    Profile-->>Mobile: 201 Created {PartnerLinkId}\n    deactivate Profile\n\n    Note over EventBus: T+100ms: Event persisted\n\n    par Parallel Event Delivery\n        EventBus->>Loyalty: Deliver Partnerlinked event\n        activate Loyalty\n        Loyalty->>Loyalty: Update reward preference cache<br/>(vivaConsumerId → FLYBUYS_POINTS)\n        Loyalty-->>EventBus: ACK\n        deactivate Loyalty\n\n        Note over Loyalty: T+200ms: Cache updated\n    and\n        EventBus->>Engagement: Deliver Partnerlinked event\n        activate Engagement\n        Engagement->>Engagement: Trigger welcome campaign<br/>\"Earn Flybuys points at OTR\"\n        Engagement-->>EventBus: ACK\n        deactivate Engagement\n\n        Note over Engagement: T+500ms: Campaign triggered\n    end\n\n    Note over Mobile,Engagement: Eventual consistency achieved within 500ms\n----\n\n==== Event Flow\n\n[cols=\"2,3\"]\n|===\n| From | To\n\n| xref:../bounded_context/profile.adoc[Profile Service]\n| xref:../bounded_context/loyalty.adoc[Loyalty Service]\n\n| xref:../bounded_context/profile.adoc[Profile Service]\n| xref:../bounded_context/engagement.adoc[Engagement Service]\n\n| xref:../bounded_context/profile.adoc[Profile Service]\n| xref:../bounded_context/recommendation.adoc[Recommendation Service]\n\n| xref:../bounded_context/loyalty.adoc[Loyalty Service]\n| xref:../bounded_context/engagement.adoc[Engagement Service]\n\n| xref:../bounded_context/loyalty.adoc[Loyalty Service]\n| xref:../bounded_context/recommendation.adoc[Recommendation Service]\n|===\n\n\n<<<\n=== SBB-007: Engagement Service API\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| ABB Reference\n| Engagement Service (Bounded Context)\n\n| Component Type\n| Microservice (Event Consumer + Anti-Corruption Layer)\n\n| Implementation\n| <<key-technology-decisions,DEC-001>>\n\n| Hosting\n| <<key-technology-decisions,DEC-002>>\n\n| Database\n| <<sbb-008-engagement-service-database,SBB-008>>\n\n| Event Subscriptions\n| `profile.events.*`, `loyalty.events.*` (all Profile and Loyalty domain events)\n\n| External Integration\n| xref:../bounded_context/external/braze.adoc[Braze] (via ACL)\n|===\n\n==== Responsibilities\n\n* *Event Relay*: Relay domain events to xref:../bounded_context/external/braze.adoc[Braze] webhooks to enable transactional Customer communications\n** *Event-Driven Campaign Triggers*: Consumes domain events from Profile Service and Loyalty Service\n** *Braze Anti-Corruption Layer*: Translates OTRG domain events into xref:../bounded_context/external/braze.adoc[Braze] webhook payloads\n** *Customer Notification Orchestration*: Triggers push notifications, emails, in-app messages\n* *Campaign State Management*: Tracks campaign eligibility and notification delivery status\n\n==== Key Events Consumed\n\n[cols=\"1,2,3\"]\n|===\n| Event Source | Event Name | Campaign Trigger\n\n| Profile Service\n| `Partnerlinked`\n| Welcome campaign: \"_You're earning Flybuys points now!_\"\n\n| Profile Service\n| `RewardPreferenceChanged`\n| Confirmation: \"_Reward preference updated_\"\n\n| Loyalty Service\n| `TransactionAdjudicated`\n| Transaction confirmation: \"_You earned 150 Flybuys pts_\"\n\n| Loyalty Service\n| `PointsEarned`\n| Points milestone: \"_You've earned 1000 points this week_\"\n\n| Loyalty Service\n| `RewardTransactionFailed`\n| Error notification: \"_Transaction processing delayed_\"\n|===\n\n\n<<<\n=== SBB-008: Engagement Service Database\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| ABB Reference\n| Engagement Service Data Store\n\n| Platform\n| <<key-technology-decisions,DEC-003>>\n\n| Purpose\n| Campaign state tracking, notification delivery history\n\n| Data Residency\n| Australia East (primary), Australia Southeast (failover)\n\n| Retention\n| 90 days (notification history), indefinite (campaign state)\n|===\n\n\n<<<\n=== SBB-009: Braze Integration Adaptor\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| ABB Reference\n| Braze ACL\n\n| Component Type\n| Data Egress Anti-Corruption Layer (ACL) - Conformist pattern\n\n| Implementation\n| Referenced by xref:../bounded_context/engagement.adoc[Engagement Service]\n\n| External APIs\n| Braze REST API v3 (User Tracking API)\n\n| Webhook URL\n| `\\https://rest.iad-06.braze.com/`\n\n| Endpoint\n| xref:https://www.braze.com/docs/api/endpoints/user_data/post_user_track/[`/users/track`]\n\n| Circuit Breaker\n| 5 consecutive failures → open circuit, 30s timeout\n\n| Retry Policy\n| Exponential backoff: 3 retries (2s, 4s, 8s delays) for transient failures (5xx errors)\n\n| API Key Management\n| API key stored in Azure Key Vault\n\n| Rate Limits\n| 250 requests/minute per API key (Braze SLA)\n\n| Event Processing Latency\n| <500ms p95 (from Event Bus delivery to Braze webhook trigger)\n\n| Braze Webhook Timeout\n| 5 seconds (with retry logic)\n\n| Event Throughput\n| 1000 events/minute sustained\n|===\n\n==== Dependencies\n\n[cols=\"2,2,3\"]\n|===\n| SBB ID | Dependency | Reason\n\n| <<sbb-006-domain-event-bus,SBB-006 Domain Event Bus>>\n| Event subscriptions\n| Consumes Partnerlinked, TransactionAdjudicated events\n\n| xref:../bounded_context/profile.adoc[Profile Service]\n| Customer profile\n| Enriches event data with customer attributes (optional)\n|===\n\n\n<<<\n=== SBB-010: Flybuys Integration Adaptor\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| ABB Reference\n| Flybuys ACL\n\n| Component Type\n| Anti-Corruption Layer (ACL) - Conformist pattern (reference ADR-003 in ADD)\n\n| Implementation\n| #TBD# (referenced by xref:../bounded_context/loyalty.adoc[Loyalty Service], conforms to Flybuys API)\n\n| External APIs\n| Flybuys OAuth API, Balance API (`GET /v1/members/\\{id}/balance`), Docket API\n\n| Batch SFTP\n| #TBD# (Batch processing with SFTP connector, SSH key auth, PGP 2048-bit encryption)\n\n| Circuit Breaker\n| #TBD#\n\n| Caching\n| #TBD# (Distributed cache, 5-minute TTL for balance queries, reduces Flybuys API load)\n\n| Retry Policy\n| Exponential backoff: 3 retries (2s, 4s, 8s delays) for transient failures\n|===\n\n*Flybuys Implementation*: `FlybuysPointsServiceAdapter` (conforms to Flybuys CSV batch file spec v3.2)\n\n\n<<<\n=== SBB-011: EagleEye Integration Adaptor\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| ABB Reference\n| EagleEye ACL\n\n| Component Type\n| Anti-Corruption Layer (ACL)\n\n| Implementation\n| #TBD#(referenced by xref:../bounded_context/loyalty.adoc[Loyalty Service])\n\n| External APIs\n| EagleEye REST API v3 (wallet, campaigns, Transaction Adjudication)\n\n| Circuit Breaker\n| #TBD# (5 consecutive failures → open circuit, 30s timeout)\n\n| Retry Policy\n| Exponential backoff: 3 retries (2s, 4s, 8s delays)\n\n| API Key Management\n| API key stored in #TBD# (secure key vault service)\n\n| Rate Limits\n| 1000 requests/minute per API key (EagleEye SLA)\n|===\n\n\n<<<\n=== SBB-012: Application Monitoring\n\n[cols=\"1,3\"]\n|===\n| MAttribute | Specification\n\n| ABB Reference\n| Monitoring & Observability\n\n| Platform\n| xref:#Key_Technology_Decisions[DEC-007]\n\n| Application Insights\n| #TBD# (Workspace-based shared across xref:../bounded_context/profile.adoc[Profile Service], xref:../bounded_context/loyalty.adoc[Loyalty Service])\n\n| Instrumentation\n| #TBD# (SDK for distributed tracing, OpenTelemetry support)\n\n| Log Aggregation\n| Structured logging (Serilog) → #TBD# (centralized log aggregation with query language)\n\n| Metrics\n| Custom metrics: API latency (p50/p95/p99), OAuth success rate, batch file acknowledgement rate\n\n| Distributed Tracing\n| W3C Trace Context standard (see <<Correlation ID Propagation Specification,Correlation ID Specification>>)\n\n| Dashboards\n| #TBD# (Flybuys Integration Health, Customer Adoption Metrics dashboards)\n|===\n\n*Alerting*:\n\n* Critical: xref:../bounded_context/profile.adoc[Profile Service] API error rate > 5% → PagerDuty (on-call architect)\n* Critical: Batch file generation fails → Immediate alert to xref:../bounded_context/loyalty.adoc[Loyalty Service] team\n* Warning: Flybuys API latency > 3s p95 → Slack alert\n\n\n<<<\n=== SBB-013: API Gateway\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| ABB Reference\n| API Gateway\n\n| Platform\n| xref:#Key_Technology_Decisions[DEC-008]\n\n| Base URL\n| `\\https://api.otr.com.au`\n\n| Authentication\n| xref:#Key_Technology_Decisions[DEC-011]\n\n| Rate Limiting\n| 1000 requests/minute per user, 10000 requests/minute global\n\n| Policies\n| JWT validation, rate limiting, CORS, request/response transformation\n\n| TLS\n| xref:#Key_Technology_Decisions[DEC-019]\n|===\n\n\n<<<\n=== SBB-014: OTR Mobile App\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| ABB Reference\n| Mobile Application (Presentation Layer)\n\n| Platform\n| xref:#Key_Technology_Decisions[DEC-011]\n\n| Deployment\n| App Store (iOS), Google Play (Android)\n\n| Authentication\n| xref:#Key_Technology_Decisions[DEC-011]\n|===\n\n==== Integration\n\n[cols=\"2,3\"]\n|===\n| Integration | Description\n\n| <<SBB-001 Profile Service API,SBB-001 Profile Service API>>\n| Partner linking\n\n| <<SBB-003 Loyalty Service API,SBB-003 Loyalty Service API>>\n| Balance queries / Transaction history\n|===\n\n\n<<<\n=== SBB-015: Batch File Pipeline\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| ABB Reference\n| Batch Processing\n\n| Orchestration\n| #TBD# (Batch pipeline scheduled 01:00 UTC daily)\n\n| Generation Logic\n| #TBD# (Serverless functions for transaction aggregation)\n\n| SFTP Transfer\n| #TBD# (SFTP connector with SSH key authentication)\n\n| PGP Encryption\n| #TBD# (PGP encryption activity, Flybuys 2048-bit RSA public key)\n\n| File Format\n| CSV (UTF-8 with BOM, CRLF line endings, max 200MB / 100k transactions)\n\n| Acknowledgement\n| #TBD# (SFTP polling to read acknowledgement file from Flybuys)\n\n| Batch File Naming\n| `OTR_TRANSACTIONS_\\{YYYYMMDD}_{HHMMSS}.csv.pgp`\n|===\n\n==== Batch File Processing Flow\n\nSee detailed sequence diagrams in #batch-file-retry-flow[Sequence Diagrams] for happy path and error scenarios.\n\n[mermaid]\n----\nsequenceDiagram\n    autonumber\n    participant Scheduler as Azure Data Factory<br/>(Batch Scheduler)\n    participant Loyalty as Loyalty Service\n    participant DB as Loyalty Database\n    participant SFTP as Flybuys SFTP\n    participant Flybuys as Flybuys Processing\n    participant Monitor as Monitoring\n\n    Note over Scheduler,Monitor: Nightly batch window: 01:00-02:00 UTC\n\n    Scheduler->>Loyalty: Timer trigger: 01:00 UTC<br/>Start batch job\n\n    activate Loyalty\n    Loyalty->>DB: Query RewardTransactions<br/>WHERE status=\"PENDING\"<br/>AND transactionDate=yesterday\n    activate DB\n    DB-->>Loyalty: 10,000 transactions\n    deactivate DB\n\n    Note over Loyalty: Aggregate by externalMemberId\n\n    Loyalty->>Loyalty: Generate CSV<br/>Format: memberId,date,points,storeId\n    Loyalty->>Loyalty: PGP encrypt with Flybuys public key\n    Loyalty->>Loyalty: Generate filename<br/>OTR_TRANSACTIONS_20251212_010000.csv.pgp\n\n    Loyalty->>SFTP: Upload batch file<br/>(15 minutes, 2MB file)\n    activate SFTP\n    SFTP-->>Loyalty: Upload complete\n    deactivate SFTP\n\n    Loyalty->>DB: Update RewardTransactions<br/>SET batchFileId=\"OTR_TRANSACTIONS_20251212_010000.csv.pgp\"\n    activate DB\n    DB-->>Loyalty: 10,000 rows updated\n    deactivate DB\n\n    Loyalty-->>Scheduler: Job complete (duration: 60 min)\n    deactivate Loyalty\n\n    Scheduler->>Monitor: Log success metric<br/>batch_file_generation_duration_seconds\n\n    Note over Flybuys: Flybuys processes file (2-4 hours)\n\n    Flybuys->>SFTP: Upload acknowledgement file<br/>OTR_TRANSACTIONS_20251212_010000.ack\n\n    Note over Scheduler,Monitor: Acknowledgement polling (every 30 minutes)\n\n    Scheduler->>Loyalty: Poll for acknowledgement\n    activate Loyalty\n    Loyalty->>SFTP: Check for .ack file\n    activate SFTP\n    SFTP-->>Loyalty: Found: 9,800 accepted, 200 rejected\n    deactivate SFTP\n\n    Loyalty->>DB: Update status=\"COMPLETED\" (9,800 rows)<br/>SET status=\"FAILED\" (200 rows)\n    activate DB\n    DB-->>Loyalty: Updates complete\n    deactivate DB\n\n    Loyalty-->>Scheduler: Acknowledgement processed\n    deactivate Loyalty\n\n    Scheduler->>Monitor: Log metric<br/>batch_acknowledgement_rate=98%\n----\n\n\n<<<\n=== SBB-016: Distributed Cache\n\n*ABB Reference*: Caching Layer (for Flybuys balance queries)\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| Platform\n| #TBD# (In-memory distributed cache)\n\n| Purpose\n| Cache Flybuys balance queries (5-minute TTL, reduces external API load)\n\n| Eviction Policy\n| Volatile-ttl (evict keys with shortest TTL when memory full)\n\n| Persistence\n| Not enabled (cache can be regenerated from Flybuys API)\n\n| Cache Key Format\n| `flybuys:balance:\\{externalMemberId}` (e.g., `flybuys:balance:123456789012`)\n|===\n\n==== Circuit Breaker Pattern\n\nThe distributed cache works in conjunction with circuit breakers to provide graceful degradation when external APIs fail.\n\nSee detailed sequence diagrams in #circuit-breaker-state-transitions[Sequence Diagrams] for complete state transition flows.\n\n[mermaid]\n----\nstateDiagram-v2\n    [*] --> Closed: Initial state\n\n    Closed --> Open: 5 consecutive failures\n    Closed --> Closed: Success (reset failure count)\n\n    Open --> HalfOpen: 30 seconds elapsed\n\n    HalfOpen --> Closed: Success\n    HalfOpen --> Open: Failure\n\n    Open --> Open: All requests rejected\n\n    note right of Closed\n        Normal operation\n        Requests pass through\n        Track failure count\n    end note\n\n    note right of Open\n        Fail fast\n        Return cached response\n        No calls to external API\n    end note\n\n    note right of HalfOpen\n        Test recovery\n        Single request allowed\n        Decide: Closed or Open\n    end note\n----\n\n\n<<<\n=== SBB-017: Feature Flag Service\n\n[cols=\"1,3\"]\n|===\n| Attribute | Specification\n\n| ABB Reference\n| Feature Toggle Management (see xref:../architecture_definitions/flybuys_integration.adoc#Technology%2520Capability%2520Requirements[Architecture Definition §3.2.2])\n\n| Component Type\n| Infrastructure Service\n\n| Technology Stack\n| <<key-technology-decisions,DEC-014 Configuration / Feature Flags>>\n\n| Purpose\n| Dynamic feature control without code deployment, progressive rollout, instant rollback\n\n| Flag Definitions\n| See xref:../architecture_definitions/flybuys_integration.adoc#Feature%2520Flag%2520Register[Feature Flag Register] for all flags\n\n| Deployment Schedule\n| See <<Transition Phase Matrix,Transition Phase Matrix>> for rollout by architecture state\n\n| Rollback Procedures\n| See <<Rollback Strategy,Rollback Strategy>> for flag-based rollback procedures\n|===\n\n*Operational Characteristics*:\n\n* *Evaluation Frequency*: Real-time flag evaluation on each request (no caching)\n* *Update Propagation*: Flag changes propagate within 5 seconds across all service instances\n* *Monitoring*: Flag state changes logged with correlation IDs, dashboards per flag showing usage metrics\n* *Access Control*: Flag management restricted to designated roles (Platform Team, Product Owner, Operations Team per flag)\n\n<<<\n=== SBB-018: Location\n\n<<<\n== Data Architecture\n\nThis section defines the logical and physical data models for Solution Building Blocks.\n\n=== Physical Data Models\n\n==== Profile Service - PartnerLink Document Schema\n\n===== JSON Schema\n\nSee xref:../specifications/JSON%2520Schemas/PartnerLink.schema.json[PartnerLink.schema.json] for complete schema specification including field definitions, type constraints, and validation rules.\n\n===== Database Configuration\n\n*Container*: `partner-links` +\n*Partition Key*: `/vivaConsumerId` +\n*Document Type*: JSON (NoSQL document database)\n\n===== Key Fields\n\n* `id`: Unique document identifier (GUID)\n* `PartnerLinkId`: Aggregate root identifier (GUID)\n* `vivaConsumerId`: Partition key, Salesforce VCI (e.g., vci_xyz789abc)\n* `partner`: Enum - FLYBUYS | SHELL_CARD | AFL | BUDGET_DIRECT\n* `status`: Enum - linking_IN_PROGRESS | linked | UNlinked | FAILED\n* `externalMemberId`: Partner member ID (e.g., Flybuys 12-digit number)\n* `rewardPreference`: Enum - FLYBUYS_POINTS | OTR_FUEL_DISCOUNT | SHELL_PRICE_SAVE\n* `linkedAt` / `unlinkedAt`: ISO8601 timestamps\n* `oauthTokenReference`: Key Vault secret identifier\n* `metadata`: Document metadata (createdAt, updatedAt, version)\n* `_etag`: Database concurrency token\n\n===== Example Document\n\n[source,json]\n----\n{\n  \"id\": \"pl_a1b2c3d4-e5f6-7890-abcd-ef1234567890\",\n  \"PartnerLinkId\": \"a1b2c3d4-e5f6-7890-abcd-ef1234567890\",\n  \"vivaConsumerId\": \"vci_xyz789abc\",\n  \"partner\": \"FLYBUYS\",\n  \"status\": \"linked\",\n  \"externalMemberId\": \"123456789012\",\n  \"rewardPreference\": \"FLYBUYS_POINTS\",\n  \"linkedAt\": \"2025-12-09T10:30:00Z\",\n  \"unlinkedAt\": null,\n  \"oauthTokenReference\": \"flybuys-token-vci_xyz789abc\",\n  \"metadata\": {\n    \"createdAt\": \"2025-12-09T10:30:00Z\",\n    \"updatedAt\": \"2025-12-09T10:30:00Z\",\n    \"version\": 1\n  },\n  \"_etag\": \"\\\"0x8DCDEF123456\\\"\"\n}\n----\n\n===== Indexes\n\n* Primary: `/id` (automatic)\n* Partition key: `/vivaConsumerId` (automatic)\n* Composite: `[/partner ASC, /status ASC]` (custom - query all Flybuys linked partners)\n\n===== Constraints\n\n* `vivaConsumerId`: Required, must match pattern `^vci_[a-zA-Z0-9]\\{10,}$`\n* `partner`: Required, must be valid enum value\n* `status`: Required, must be valid enum value\n* `externalMemberId`: Required if status = linked\n* `rewardPreference`: Required if status = linked\n* Uniqueness: One linked partner per (vivaConsumerId, partner) combination\n\n==== Loyalty Service - RewardTransaction Document Schema\n\n===== JSON Schema\n\nSee xref:../specifications/JSON%2520Schemas/RewardTransactionDocument.schema.json[RewardTransactionDocument.schema.json] for complete schema specification including field definitions, nested structures, type constraints, and validation rules.\n\n===== Database Configuration\n\n*Container*: `reward-transactions` +\n*Partition Key*: `/vivaConsumerId` +\n*TTL*: 2592000 seconds (30 days) +\n*Document Type*: JSON (NoSQL document database)\n\n===== Key Fields\n\n* `id`: Unique document identifier (GUID)\n* `transactionId`: Aggregate root identifier (GUID)\n* `vivaConsumerId`: Partition key\n* `externalTransactionId`: D365 Commerce transaction ID\n* `transactionDate`: ISO8601 timestamp\n* `storeId`: OTR store identifier\n* `rewardPreference`: Enum - FLYBUYS_POINTS | OTR_FUEL_DISCOUNT\n* `grants[]`: Array of reward grants (grantId, partner, grantType, amount, description)\n* `transaction`: Transaction details (totalAmount, paymentMethod)\n* `partnerPosting`: Partner posting status (Flybuys batch file details)\n* `status`: Enum - PENDING | COMPLETED | FAILED\n* `metadata`: Document metadata (createdAt, ttl)\n* `_etag`: Database concurrency token\n\n===== Example Document\n\n[source,json]\n----\n{\n  \"id\": \"rt_b2c3d4e5-f6a7-8901-bcde-f12345678901\",\n  \"transactionId\": \"b2c3d4e5-f6a7-8901-bcde-f12345678901\",\n  \"vivaConsumerId\": \"vci_xyz789abc\",\n  \"externalTransactionId\": \"D365_TXN_20251209_001234\",\n  \"transactionDate\": \"2025-12-09T14:30:00Z\",\n  \"storeId\": \"OTR001\",\n  \"rewardPreference\": \"FLYBUYS_POINTS\",\n  \"grants\": [\n    {\n      \"grantId\": \"grt_c3d4e5f6-a7b8-9012-cdef-123456789012\",\n      \"partner\": \"FLYBUYS\",\n      \"grantType\": \"POINTS\",\n      \"amount\": 150,\n      \"description\": \"Base points: 100, Bonus points: 50 (fuel purchase campaign)\"\n    }\n  ],\n  \"transaction\": {\n    \"totalAmount\": 75.50,\n    \"paymentMethod\": \"CREDIT_CARD\"\n  },\n  \"partnerPosting\": {\n    \"flybuys\": {\n      \"posted\": true,\n      \"batchFileId\": \"OTR_TRANSACTIONS_20251210_010000.csv.pgp\",\n      \"postedAt\": \"2025-12-10T01:15:00Z\",\n      \"retryCount\": 0\n    }\n  },\n  \"status\": \"COMPLETED\",\n  \"metadata\": {\n    \"createdAt\": \"2025-12-09T14:30:00Z\",\n    \"ttl\": 2592000\n  },\n  \"_etag\": \"\\\"0x8DCDEF789012\\\" - database concurrency token\"\n}\n----\n\n===== Indexes\n\n* Primary: `/id` (automatic)\n* Partition key: `/vivaConsumerId` (automatic)\n* Range: `/transactionDate DESC` (custom - query recent transactions)\n\n===== Constraints\n\n* `vivaConsumerId`: Required\n* `externalTransactionId`: Required, must be unique\n* `transactionDate`: Required, cannot be future-dated\n* `grants`: Array must contain at least one grant\n* TTL: Automatically deleted 30 days after creation (audit trail summary only)\n\n==== OAuth Token Storage Schema (Key Vault)\n\n===== JSON Schema\n\nSee xref:../specifications/JSON%2520Schemas/OAuthTokenStorageSchema.schema.json[OAuthTokenStorageSchema.schema.json] for complete schema specification including OAuth token structure, expiration rules, and metadata requirements.\n\n===== Key Vault Configuration\n\n*Service*: #TBD# (Secure key vault service) +\n*Secret Naming Convention*: `\\{partner}-token-{vivaConsumerId}`\n\n===== Secret Value (JSON) - Key Fields\n\n* `accessToken`: OAuth access token (JWT, ~2KB)\n* `refreshToken`: OAuth refresh token\n* `expiresAt`: ISO8601 timestamp (60 minutes from issuance)\n* `scope`: OAuth scopes granted (e.g., member:read member:balance)\n* `tokenType`: Bearer\n\n===== Example Secret\n\n*Name*: `flybuys-token-vci_xyz789abc`\n\n*Value*:\n\n[source,json]\n----\n{\n  \"accessToken\": \"eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...\",\n  \"refreshToken\": \"rt_abc123def456...\",\n  \"expiresAt\": \"2025-12-09T15:30:00Z\",\n  \"scope\": \"member:read member:balance member:dockets\",\n  \"tokenType\": \"Bearer\"\n}\n----\n\n===== Metadata\n\n* Content Type: `application/json`\n* Enabled: `true`\n* Activation Date: Token creation timestamp\n* Expiration Date: 90 days (refresh token expiry)\n* Tags: `{ \"partner\": \"FLYBUYS\", \"vivaConsumerId\": \"vci_xyz789abc\" }`\n\n===== Encryption\n\nAES-256 with customer-managed keys (compliance with CON-003)\n\n<<<\n== Interface Specifications\n\nThis section defines the contracts between Solution Building Blocks - REST APIs, domain events, and data formats.\n\n=== Complete API Documentation\n\nSee xref:../specifications/README.md[Specifications README] for comprehensive documentation on OpenAPI, AsyncAPI, JSON Schemas, tooling, versioning, and validation.\n\n=== REST API\n\n[cols=\"2,3,2\"]\n|===\n| Service | OpenAPI Spec | Endpoints\n\n| Profile Service\n| xref:../specifications/REST/profile-service-v1.yaml[profile-service-v1.yaml]\n| 6 endpoints (profile creation, profile retrieval, partner linking, preference management)\n\n| Loyalty Service\n| xref:../specifications/REST/loyalty-service-v1.yaml[loyalty-service-v1.yaml]\n| 5 endpoints (credential resolution, transaction adjudication, balance queries)\n|===\n\n=== Domain Events\n\n==== AsyncAPI Specification\n\nxref:../specifications/AsyncAPI/otr-event-bus-v1.yaml[otr-event-bus-v1.yaml] - Complete event bus specification with 9 domain events, CloudEvents 1.0 structure, message examples, and channel definitions.\n\n==== Event Schemas\n\nAll domain events use JSON Schema definitions in xref:../specifications/JSON%2520Schemas[JSON Schemas directory]. See <<sbb-006-domain-event-bus,SBB-006>> for event catalogue.\n\n==== API Versioning Policy\n\nAll REST APIs exposed by ProfileService and LoyaltyService follow this versioning policy to manage API evolution while maintaining backwards compatibility for consumers (Mobile Application, POS systems).\n\n===== Version Numbering\n\n*URI Versioning*: Major version included in URI path (`/api/v1/`, `/api/v2/`)\n\n*Format*: `/api/v{major}/\\{resource}`\n\n*Examples*:\n\n* `/api/v1/loyalty/credentials/resolve`\n* `/api/v2/profile/customers`\n\n*Version Components*:\n\n* *Major version* (v1, v2, v3): Breaking changes to API contract\n* *Minor version* (not in URI): Additive changes, backwards compatible\n* *Patch version* (not in URI): Bug fixes, no contract changes\n\n===== When to Version\n\n*Major Version Bump (v1 → v2)* - Breaking changes requiring new URI:\n\n[cols=\"2,3,1\"]\n|===\n| Change Type | Example | Requires v2?\n\n| Remove field from response\n| Delete `walletId` from credential resolution response\n| ✓ Yes\n\n| Rename field\n| `rewardPreference` → `preferredReward`\n| ✓ Yes\n\n| Change field type\n| `linkedAt` from string to DateTime object\n| ✓ Yes\n\n| Add required request field\n| Add required `storeType` parameter\n| ✓ Yes\n\n| Change HTTP method\n| `POST` → `PUT` for same resource\n| ✓ Yes\n\n| Change status codes\n| `404` → `422` for partner not linked\n| ✓ Yes\n\n| Remove endpoint\n| Delete `GET /api/v1/legacy-endpoint`\n| ✓ Yes\n|===\n\n*Minor Version (No URI change)* - Backwards compatible additions:\n\n[cols=\"2,3,1\"]\n|===\n| Change Type | Example | Requires v2?\n\n| Add optional request field\n| Add optional `includeBalance` query parameter\n| ✗ No\n\n| Add new response field\n| Add `partnerTier` to credential resolution response\n| ✗ No\n\n| Add new endpoint\n| Add `POST /api/v1/loyalty/batch/validate`\n| ✗ No\n\n| Add new HTTP header\n| Add `X-Request-Priority` header support\n| ✗ No\n\n| Expand enum values\n| `rewardPreference` adds `SHELL_PRICE_SAVE` option\n| ✗ No\n|===\n\n*Patch Version* - Internal only, not visible to API consumers:\n\n* Bug fixes that don't change contract\n* Performance improvements\n* Internal refactoring\n\n===== Parallel Version Support\n\n*Support Duration*: Both versions supported in parallel until deprecated version reaches sunset date\n\n*Versioning Lifecycle*:\n\n. Release new major version with breaking changes\n. Run both versions in parallel during deprecation period\n. Sunset deprecated version after migration window\n. Remove deprecated version after grace period\n\n*Infrastructure*:\n\n* Both versions deployed simultaneously (same service, route-based dispatch)\n* Shared business logic where possible (avoid duplicate implementations)\n* Feature flags: `ProfileService.API.v1.Enabled`, `ProfileService.API.v2.Enabled`\n\n===== Deprecation Notification\n\n*HTTP Headers* (included in deprecated version responses):\n\n[source,http]\n----\nHTTP/1.1 200 OK\nDeprecation: true\nSunset: <sunset-date>\nxref: </api/v2/profile/customers>; rel=\"successor-version\"\nContent-Type: application/json\n----\n\n*Header Definitions*:\n\n* `Deprecation: true` - API version is deprecated (RFC 8594)\n* `Sunset: \\{date}` - Date when API will be removed (RFC 8594)\n* `xref: \\{url}; rel=\"successor-version\"` - URL of replacement API\n\n*OpenAPI Specification*:\n\n[source,yaml]\n----\nopenapi: 3.0.0\ninfo:\n  title: Profile Service API\n  version: 1.0.0\n  x-api-deprecation:\n    deprecated: true\n    sunset: \"<sunset-date>\"\n    successorVersion: \"2.0.0\"\n    migrationGuide: \"https://docs.otr.com.au/api/migration/v1-to-v2\"\n----\n\n*Consumer Communication Sequence*:\n\n. Release notes published with breaking changes documented\n. Email notification to API consumers with migration guide\n. Deprecation headers added to deprecated version responses\n. Warning logs enabled for deprecated version usage\n. Final migration reminder before sunset\n. Sunset date reached (API returns `410 Gone`)\n. Hard removal after grace period\n\n===== Version Discovery\n\n*API Root Endpoint*: `GET /api/versions`\n\n[source,json]\n----\n{\n  \"versions\": [\n    {\n      \"version\": \"1.0\",\n      \"status\": \"deprecated\",\n      \"sunsetDate\": \"<sunset-date>\",\n      \"baseUrl\": \"/api/v1\",\n      \"documentation\": \"https://docs.otr.com.au/api/v1\"\n    },\n    {\n      \"version\": \"2.0\",\n      \"status\": \"current\",\n      \"sunsetDate\": null,\n      \"baseUrl\": \"/api/v2\",\n      \"documentation\": \"https://docs.otr.com.au/api/v2\"\n    }\n  ],\n  \"recommended\": \"2.0\"\n}\n----\n\n*Status Values*:\n\n* `current`: Recommended version, fully supported\n* `supported`: Older version, still functional, no new features\n* `deprecated`: Scheduled for removal, sunset date published\n* `sunset`: No longer accepting requests, returns `410 Gone`\n\n===== Consumer Compatibility\n\n*Mobile Application*:\n\n* iOS/Android apps pin to specific API version\n* App Store updates required for major version migrations\n* Migration coordinated with mobile app release cycles\n\n*POS Systems*:\n\n* Store rollout requires coordinated deployment\n* POS configuration updated via D365 Commerce central config\n* API version specified in POS tenant configuration\n* Gradual rollout strategy to minimize disruption\n\n*Backward Compatibility Guarantee*:\n\n* Deprecated version contract remains stable during parallel support period\n* No breaking changes to deprecated version during support window\n* Bug fixes backported to deprecated version during support period\n\n===== Error Response for Sunset APIs\n\n*After Sunset Date* (`410 Gone`):\n\n[source,json]\n----\n{\n  \"error\": {\n    \"code\": \"API_VERSION_SUNSET\",\n    \"message\": \"API v1 has been sunset. Please migrate to v2.\",\n    \"sunsetDate\": \"<sunset-date>\",\n    \"successorVersion\": \"2.0\",\n    \"migrationGuide\": \"https://docs.otr.com.au/api/migration/v1-to-v2\"\n  }\n}\n----\n\n*HTTP Status*: `410 Gone` (permanent redirect, cache-safe)\n\n===== Semantic Versioning Alignment\n\nWhile URI versioning uses major version only, OpenAPI specs follow semantic versioning:\n\n* *OpenAPI spec version*: `2.3.1` (semver)\n* *API URI version*: `/api/v2/` (major only)\n\n*Mapping*:\n\n* OpenAPI `2.0.0` → URI `/api/v2/`\n* OpenAPI `2.1.0` → URI `/api/v2/` (additive change, no URI change)\n* OpenAPI `2.1.5` → URI `/api/v2/` (bug fix, no URI change)\n* OpenAPI `3.0.0` → URI `/api/v3/` (breaking change, new URI)\n\n==== Loyalty Credential Resolution API\n\n*Endpoint*: `POST /api/v1/loyalty/credentials/resolve`\n\n*Purpose*: Resolves EAN-13 barcodes scanned at xref:../bounded_context/interfaces/otr_pos.adoc[OTR POS] and xref:../bounded_context/interfaces/otr_plus_pos.adoc[OTR+ POS] to customer identity and context for Transaction Adjudication.\n\n*Request*:\n\n[source,json]\n----\n{\n  \"barcode\": \"1234567890123\",\n  \"storeId\": \"OTR001\",\n  \"transactionId\": \"TXN_20251211_001234\"\n}\n----\n\n*Request Schema*:\n\n[cols=\"1,1,1,3\"]\n|===\n| Field | Type | Required | Validation\n\n| `barcode`\n| string\n| Yes\n| Must match pattern `^\\d\\{13}$` (EAN-13)\n\n| `storeId`\n| string\n| Yes\n| Must be registered OTR store (OTR001-OTR999)\n\n| `transactionId`\n| string\n| Yes\n| Unique transaction identifier from POS\n|===\n\n*Response* (200 OK):\n\n[source,json]\n----\n{\n  \"vivaConsumerId\": \"vci_xyz789abc\",\n  \"rewardPreference\": \"FLYBUYS_POINTS\",\n  \"walletId\": \"wallet_123456\",\n  \"linkedPartners\": [\"FLYBUYS\"],\n  \"credentialType\": \"FLYBUYS_CARD\"\n}\n----\n\n*Response Schema*:\n\n[cols=\"1,1,4\"]\n|===\n| Field | Type | Description\n\n| `vivaConsumerId`\n| string\n| Viva Consumer ID from Salesforce Contact (customer identity)\n\n| `rewardPreference`\n| string\n| Enum: `FLYBUYS_POINTS` \\| `OTR_FUEL_DISCOUNT` \\| `SHELL_PRICE_SAVE`\n\n| `walletId`\n| string\n| EagleEye wallet identifier\n\n| `linkedPartners`\n| string[]\n| List of linked partner codes (e.g., `[\"FLYBUYS\", \"SHELL\"]`)\n\n| `credentialType`\n| string\n| Enum: `OTR_MOBILE` \\| `SPS_MOBILE` \\| `WALLET_PASS` \\| `FLYBUYS_CARD` \\| `FLYBUYS_MOBILE`\n|===\n\n*Error Responses*:\n\n[cols=\"1,2,3\"]\n|===\n| Status | Error Code | Description\n\n| 400\n| `INVALID_BARCODE`\n| Barcode format invalid (not 13 digits)\n\n| 404\n| `CREDENTIAL_NOT_FOUND`\n| Barcode not recognized or customer not enrolled\n\n| 422\n| `PARTNER_NOT_linked`\n| Flybuys credential presented but not linked to OTR profile\n\n| 500\n| `RESOLUTION_FAILED`\n| Internal error during resolution\n|===\n\n*Resolution Logic*:\n\n. *OTR credentials* (OTR Mobile, SPS Mobile, Apple/Google Wallet):\n** Barcode encodes OTR member ID\n** Direct lookup: OTR member ID → VCI\n** Query xref:../bounded_context/profile.adoc[Profile Service]: `GET /api/v1/profile/customers?memberId=\\{otrMemberId}`\n. *Flybuys credentials* (Physical card, Flybuys Mobile):\n** Barcode encodes Flybuys 12-digit member number\n** Extract member number from EAN-13 barcode\n** Query xref:../bounded_context/profile.adoc[Profile Service]: `GET /api/v1/profile/partner-links?partner=FLYBUYS&externalMemberId=\\{flybuysNumber}`\n** Retrieve VCI from PartnerLink aggregate\n** If no PartnerLink found → return `422 PARTNER_NOT_linked`\n\n*Performance Requirements*:\n\n* *Latency*: p95 < 500ms (xref:../architecture_definitions/flybuys_integration.adoc#Non-Functional%2520Requirements[NFR-002])\n* *Throughput*: 500 concurrent requests/sec (peak POS load across 500+ stores)\n* *Availability*: 99.9% uptime (max 4.3 hours downtime/month)\n\n==== Customer Profile Creation API\n\n*Endpoint*: `POST /api/v1/profile/customers`\n\n*Purpose*: Creates a new customer profile, retrieves VCI from Salesforce, and provisions an EagleEye wallet. Used by the xref:../ubiquitous_language.adoc#just-in-time-integration[Just-In-Time Integration] during customer login (TS-1 Foundation).\n\n*Request*:\n\n[source,json]\n----\n{\n  \"email\": \"customer@example.com\",\n  \"firstName\": \"John\",\n  \"lastName\": \"Smith\",\n  \"phone\": \"+61412345678\",\n  \"rewardPreference\": \"OTR_FUEL_DISCOUNT\"\n}\n----\n\n*Request Schema*:\n\n[cols=\"1,1,1,3\"]\n|===\n| Field | Type | Required | Validation\n\n| `email`\n| string\n| Yes\n| Valid email format (used for Salesforce Contact upsert as external key)\n\n| `firstName`\n| string\n| No\n| Customer first name\n\n| `lastName`\n| string\n| No\n| Customer last name\n\n| `phone`\n| string\n| No\n| Customer phone number\n\n| `rewardPreference`\n| string\n| No\n| Enum: `OTR_FUEL_DISCOUNT` \\| `FLYBUYS_POINTS` \\| `SHELL_PRICE_SAVE` (defaults to `OTR_FUEL_DISCOUNT`)\n|===\n\n*Response* (201 Created):\n\n[source,json]\n----\n{\n  \"vivaConsumerId\": \"vci_xyz789abc\",\n  \"salesforceContactId\": \"003Dn000001234ABC\",\n  \"rewardPreference\": \"OTR_FUEL_DISCOUNT\",\n  \"createdAt\": \"2025-12-09T10:30:00Z\",\n  \"status\": \"ACTIVE\"\n}\n----\n\n*Response Schema*:\n\n[cols=\"1,1,4\"]\n|===\n| Field | Type | Description\n\n| `vivaConsumerId`\n| string\n| Viva Consumer ID from Salesforce Contact (customer identity)\n\n| `salesforceContactId`\n| string\n| Salesforce Contact record ID\n\n| `rewardPreference`\n| string\n| Default reward preference\n\n| `createdAt`\n| string (ISO 8601)\n| Profile creation timestamp\n\n| `status`\n| string\n| Enum: `ACTIVE` \\| `SUSPENDED` \\| `CLOSED`\n|===\n\n*Error Responses*:\n\n[cols=\"1,2,3\"]\n|===\n| Status | Error Code | Description\n\n| 409\n| `PROFILE_ALREADY_EXISTS`\n| Customer profile already exists for this email (idempotent)\n\n| 503\n| `EAGLEEYE_UNAVAILABLE`\n| EagleEye wallet creation failed\n\n| 503\n| `SALESFORCE_UNAVAILABLE`\n| Salesforce Contact upsert failed\n|===\n\n*Business Rules*:\n\n* Retrieves Viva Consumer ID (VCI) from Salesforce Contact upsert response\n* Uses email address as external key for Salesforce Contact upsert\n* Upserts Salesforce Contact record using email (creates if doesn't exist, updates if exists)\n* Publishes `CustomerProfileCreated` domain event (consumed by LoyaltyService for wallet creation)\n* Returns `409 Conflict` if profile already exists for this email (idempotent operation)\n* Transaction is atomic - if Salesforce upsert fails, entire transaction is rolled back\n* *Clean DDD*: ProfileService does NOT create EagleEye wallet (LoyaltyService owns loyalty enrollment)\n\n*Event-Driven Integration*:\n\n* *LoyaltyService* subscribes to `CustomerProfileCreated` event\n* *LoyaltyService* creates EagleEye wallet asynchronously\n* *LoyaltyService* publishes `CustomerEnrolledInLoyalty` event with walletId\n* *Mobile App* can poll `GET /api/v1/profile/customers/{vivaConsumerId}` or subscribe to enrollment completion\n\n*Performance Requirements*:\n\n* *Latency*: p95 < 300ms (Salesforce Contact upsert only - wallet creation is asynchronous)\n* *Used during login flow* - fast profile creation, loyalty enrollment completes in background\n* *Availability*: 99.9% uptime (critical for customer onboarding)\n\n*Orchestration Flow (ProfileService)*:\n\n. Check if profile already exists for this email address\n. Upsert Salesforce Contact record using email as external key (create if new, update if exists)\n. Retrieve Viva Consumer ID (VCI) from Salesforce Contact upsert response\n. Create Customer aggregate in ProfileService database (VCI, email, Salesforce link)\n. Publish `CustomerProfileCreated` domain event to Event Bus\n. Return profile details with VCI (without walletId - comes later from LoyaltyService)\n\n==== Customer Profile Retrieval API\n\n*Endpoint*: `GET /api/v1/profile/customers/{vivaConsumerId}`\n\n*Purpose*: Retrieves customer profile details by Viva Consumer ID. Used by LoyaltyService during transaction adjudication to get reward preferences and wallet information.\n\n*Request Parameters*:\n\n[cols=\"1,1,1,3\"]\n|===\n| Parameter | Type | Required | Validation\n\n| `vivaConsumerId`\n| string (path)\n| Yes\n| Must be valid VCI identifier (format: vci_*)\n|===\n\n*Response* (200 OK):\n\n[source,json]\n----\n{\n  \"vivaConsumerId\": \"vci_xyz789abc\",\n  \"salesforceContactId\": \"003Dn000001234ABC\",\n  \"walletId\": \"wallet_123456\",\n  \"rewardPreference\": \"FLYBUYS_POINTS\",\n  \"createdAt\": \"2025-12-09T10:30:00Z\",\n  \"status\": \"ACTIVE\"\n}\n----\n\n*Response Schema*:\n\n[cols=\"1,1,4\"]\n|===\n| Field | Type | Description\n\n| `vivaConsumerId`\n| string\n| Viva Consumer ID from Salesforce Contact (customer identity)\n\n| `salesforceContactId`\n| string\n| Salesforce Contact record ID\n\n| `walletId`\n| string\n| EagleEye wallet identifier\n\n| `rewardPreference`\n| string\n| Customer's current reward preference\n\n| `createdAt`\n| string (ISO 8601)\n| Profile creation timestamp\n\n| `status`\n| string\n| Enum: `ACTIVE` \\| `SUSPENDED` \\| `CLOSED`\n|===\n\n*Error Responses*:\n\n[cols=\"1,2,3\"]\n|===\n| Status | Error Code | Description\n\n| 401\n| `UNAUTHORIZED`\n| Authentication failed\n\n| 404\n| `CUSTOMER_NOT_FOUND`\n| Customer profile does not exist for this VCI\n|===\n\n*Performance Requirements*:\n\n* *Latency*: p95 < 200ms\n* *Availability*: 99.9% uptime\n* *Cache Strategy*: Response can be cached for 5 minutes\n\n*Usage Examples*:\n\n* Transaction adjudication: `GET /api/v1/profile/customers/{vivaConsumerId}/reward-preference`\n* Customer lookup: `GET /api/v1/profile/customers?memberId={otrMemberId}`\n* Profile details retrieval: `GET /api/v1/profile/customers/{vivaConsumerId}`\n\n=== Domain Events\n\n*AsyncAPI Specification*: `Specifications/AsyncAPI/otr-event-bus-v1.yaml`\n\n*Event Standard*: CloudEvents 1.0 (https://cloudevents.io/)\n\n*Architecture Pattern*: Open Host Service + Published Language\n\nAll domain events follow the CloudEvents 1.0 specification and are defined with JSON Schema validation. Event schemas are maintained as separate JSON Schema files to ensure consistency and enable tooling integration (validation, code generation, documentation).\n\n==== Event Catalogue\n\n[cols=\"1,1,1,1,3\"]\n|===\n| Event | Channel | Source | JSON Schema | Description\n\n| `Partnerlinked`\n| `profile.events`\n| `/profile-service`\n| xref:../specifications/JSON%2520Schemas/Partnerlinked.event.schema.json[Partnerlinked.event.schema.json]\n| Customer successfully linked coalition partner account (Flybuys, Shell Card)\n\n| `PartnerUnlinked`\n| `profile.events`\n| `/profile-service`\n| xref:../specifications/JSON%2520Schemas/PartnerUnlinked.event.schema.json[PartnerUnlinked.event.schema.json]\n| Customer unlinked coalition partner account\n\n| `PartnerLinkFailed`\n| `profile.events`\n| `/profile-service`\n| xref:../specifications/JSON%2520Schemas/PartnerLinkFailed.event.schema.json[PartnerLinkFailed.event.schema.json]\n| Partner linking attempt failed (OAuth error, invalid credentials)\n\n| `RewardPreferenceChanged`\n| `profile.events`\n| `/profile-service`\n| xref:../specifications/JSON%2520Schemas/RewardPreferenceChanged.event.schema.json[RewardPreferenceChanged.event.schema.json]\n| Customer changed reward preference (Flybuys points ↔ OTR fuel discount)\n\n| `CustomerProfileCreated`\n| `profile.events`\n| `/profile-service`\n| xref:../specifications/JSON%2520Schemas/CustomerProfileCreated.event.schema.json[CustomerProfileCreated.event.schema.json]\n| Customer profile created during Just-In-Time Integration (VCI from Salesforce). Triggers loyalty enrollment.\n\n| `CustomerEnrolledInLoyalty`\n| `loyalty.events`\n| `/loyalty-service`\n| xref:../specifications/JSON%2520Schemas/CustomerEnrolledInLoyalty.event.schema.json[CustomerEnrolledInLoyalty.event.schema.json]\n| Customer enrolled in loyalty program (EagleEye wallet created). Published in response to CustomerProfileCreated.\n\n| `TransactionAdjudicated`\n| `loyalty.events`\n| `/loyalty-service`\n| xref:../specifications/JSON%2520Schemas/TransactionAdjudicated.event.schema.json[TransactionAdjudicated.event.schema.json]\n| Transaction adjudicated, rewards calculated and granted\n\n| `PointsEarned`\n| `loyalty.events`\n| `/loyalty-service`\n| xref:../specifications/JSON%2520Schemas/PointsEarned.event.schema.json[PointsEarned.event.schema.json]\n| Customer earned Flybuys points on transaction\n\n| `FuelDiscountApplied`\n| `loyalty.events`\n| `/loyalty-service`\n| xref:../specifications/JSON%2520Schemas/FuelDiscountApplied.event.schema.json[FuelDiscountApplied.event.schema.json]\n| Customer received OTR fuel discount on transaction\n\n| `RewardTransactionFailed`\n| `loyalty.events`\n| `/loyalty-service`\n| xref:../specifications/JSON%2520Schemas/RewardTransactionFailed.event.schema.json[RewardTransactionFailed.event.schema.json]\n| Transaction adjudication failed (system error, API timeout)\n|===\n\n==== Event Consumers\n\n[cols=\"1,2,3\"]\n|===\n| Bounded Context | Subscribed Events | Responsibility\n\n| *Loyalty Service*\n| `Partnerlinked`, `RewardPreferenceChanged`\n| Updates adjudication rules based on partner linking and preference changes\n\n| *Engagement Service*\n| `Partnerlinked`, `PartnerLinkFailed`, `RewardPreferenceChanged`, `CustomerProfileCreated`, `TransactionAdjudicated`, `PointsEarned`, `FuelDiscountApplied`\n| Sends customer notifications (linking confirmation, points earned, welcome messages)\n\n| *Recommendation Service*\n| `Partnerlinked`, `RewardPreferenceChanged`, `CustomerProfileCreated`\n| Updates personalization engine based on customer loyalty profile changes\n\n| *Analytics Service*\n| `TransactionAdjudicated`, `PointsEarned`, `FuelDiscountApplied`\n| Tracks reward transactions for business intelligence and reporting\n|===\n\n==== Event Delivery Guarantees\n\n*Delivery Semantics*: At-least-once delivery (Event Bus guarantees)\n\n*Retry Policy*:\n\n* Initial retry: Immediate\n* Subsequent retries: Exponential backoff (2s, 4s, 8s, 16s, 32s)\n* Maximum retries: 5 attempts\n* Dead Letter Queue: After 5 failed attempts, events routed to DLQ for manual investigation\n\n*Idempotency*: All event consumers must implement idempotent processing (use `id` field for deduplication)\n\n*Ordering*: Events within the same `vivaConsumerId` partition maintain order; cross-partition ordering not guaranteed\n\n=== Correlation ID Propagation Specification\n\nAll service-to-service communication and domain events must propagate correlation IDs to enable distributed tracing and request correlation across the Flybuys Integration architecture.\n\n==== Standard\n\n*W3C Trace Context* (https://www.w3.org/TR/trace-context/)\n\n==== HTTP Propagation\n\n*Headers*:\n\n* `traceparent`: Required trace context (format: `\\{version}-{trace-id}-{parent-id}-{trace-flags}`)\n* `tracestate`: Optional vendor-specific trace data\n\n*Generation Point*: API Gateway (or Mobile Application if request originates outside API Gateway)\n\n*Example*:\n\n[source,http]\n----\nPOST /api/v1/loyalty/credentials/resolve HTTP/1.1\nHost: api.otr.com.au\ntraceparent: 00-4bf92f3577b34da6a3ce929d0e0e4736-00f067aa0ba902b7-01\ntracestate: otr=t61rcWkgMzE\nContent-Type: application/json\n----\n\n*Trace ID Format*:\n\n* `version`: `00` (current W3C version)\n* `trace-id`: 32 hex characters (128-bit globally unique identifier)\n* `parent-id`: 16 hex characters (64-bit span identifier)\n* `trace-flags`: 2 hex characters (sampling decision: `01` = sampled, `00` = not sampled)\n\n*Propagation Rules*:\n\n. *API Gateway → Service*: Generate `traceparent` if not present, forward if present\n. *Service → Service*: Preserve `trace-id`, generate new `parent-id` for span\n. *Service → External API*: Propagate `traceparent` header (Flybuys, EagleEye, Salesforce)\n\n==== Event Propagation\n\n*CloudEvents Extension*: All domain events MUST include `traceparent` as CloudEvents extension attribute\n\n*Example*:\n\n[source,json]\n----\n{\n  \"specversion\": \"1.0\",\n  \"type\": \"com.otr.profile.Partnerlinked\",\n  \"source\": \"/profile-service\",\n  \"id\": \"a1b2c3d4-e5f6-7890-abcd-ef1234567890\",\n  \"time\": \"2025-12-09T14:30:00Z\",\n  \"traceparent\": \"00-4bf92f3577b34da6a3ce929d0e0e4736-00f067aa0ba902b7-01\",\n  \"datacontenttype\": \"application/json\",\n  \"data\": {\n    \"vivaConsumerId\": \"vci_xyz789abc\",\n    \"partner\": \"FLYBUYS\"\n  }\n}\n----\n\n*Event Consumer Propagation*: Consumers MUST extract `traceparent` from event and propagate to downstream calls\n\n*Example Flow*:\n\n. POS calls `POST /api/v1/loyalty/credentials/resolve` with `traceparent: 00-\\{trace-id}-{span-1}-01`\n. LoyaltyService calls ProfileService `GET /api/v1/profile/partner-links` with `traceparent: 00-\\{trace-id}-{span-2}-01`\n. ProfileService publishes `Partnerlinked` event with `traceparent: 00-\\{trace-id}-{span-3}-01`\n. All requests share same `trace-id` (`4bf92f3577b34da6a3ce929d0e0e4736`)\n\n==== Structured Logging\n\nAll log entries MUST include correlation context:\n\n*Log Format* (JSON structured logging via Serilog):\n\n[source,json]\n----\n{\n  \"timestamp\": \"2025-12-09T14:30:00.123Z\",\n  \"level\": \"Information\",\n  \"message\": \"Credential resolution completed\",\n  \"traceId\": \"4bf92f3577b34da6a3ce929d0e0e4736\",\n  \"spanId\": \"00f067aa0ba902b7\",\n  \"service\": \"loyalty-service\",\n  \"vivaConsumerId\": \"vci_xyz789abc\",\n  \"operation\": \"ResolveCredential\"\n}\n----\n\n*Required Fields*:\n\n* `traceId`: W3C trace-id (32 hex characters)\n* `spanId`: W3C parent-id (16 hex characters)\n* `service`: Service name (profile-service, loyalty-service, etc.)\n\n*Query Example*: Find all logs for a specific request\n\n----\ntraceId = \"4bf92f3577b34da6a3ce929d0e0e4736\"\n----\n\n==== Trace Visualization\n\n*Tool*: <<SBB-009 Application Monitoring,Application Monitoring>> platform (DEC-007) must support W3C Trace Context\n\n*Expected Trace View*:\n\n----\nPOS Transaction (trace-id: 4bf92f3577b34da6a3ce929d0e0e4736)\n├─ API Gateway [50ms]\n├─ LoyaltyService.ResolveCredential [280ms]\n│  ├─ ProfileService.GetPartnerLink [120ms]\n│  │  └─ Cosmos DB Query [80ms]\n│  └─ Redis Cache Lookup [15ms]\n└─ API Gateway Response [20ms]\nTotal: 350ms\n----\n\n==== Implementation Notes\n\n*Libraries*:\n\n* .NET: `System.Diagnostics.Activity` (built-in W3C Trace Context support)\n* OpenTelemetry SDK: Auto-instrumentation for HTTP and event propagation\n\n*Sampling Strategy*:\n\n* Production: 10% sampling (`trace-flags: 01` for 1 in 10 requests)\n* UAT: 100% sampling (all requests traced)\n* Error traces: Always sampled (override sampling decision on errors)\n\n*Privacy*: `traceparent` contains no PII - safe to log and transmit\n\n=== Data Formats\n\n==== Flybuys Batch File Format (CSV)\n\nFlybuys Transaction File Format v3.2 (January 2025) - external specification\n\n===== Format\n\n[source,csv]\n----\nMEMBER_ID,TRANSACTION_DATE,TRANSACTION_TIME,STORE_CODE,TRANSACTION_ID,BASE_POINTS,BONUS_POINTS,TOTAL_AMOUNT,FUEL_LITRES\n123456789012,2025-12-09,14:30:00,OTR001,TXN123456,100,50,75.50,45.2\n123456789012,2025-12-09,15:45:00,OTR002,TXN123457,200,0,120.00,0\n----\n\n===== Field Specifications\n\n[cols=\"1,1,1,1,3\"]\n|===\n| Field | Type | Length | Format | Validation\n\n| MEMBER_ID\n| String\n| 12\n| Numeric\n| Must match Flybuys member pattern (12 digits)\n\n| TRANSACTION_DATE\n| Date\n| 10\n| YYYY-MM-DD\n| Not future-dated\n\n| TRANSACTION_TIME\n| Time\n| 8\n| HH:MM:SS\n| 24-hour format\n\n| STORE_CODE\n| String\n| 10\n| Alphanumeric\n| Must be registered OTR store (OTR001-OTR999)\n\n| TRANSACTION_ID\n| String\n| 50\n| Alphanumeric\n| Unique per file (D365 Commerce transaction ID)\n\n| BASE_POINTS\n| Integer\n| 10\n| Numeric\n| Non-negative\n\n| BONUS_POINTS\n| Integer\n| 10\n| Numeric\n| Non-negative\n\n| TOTAL_AMOUNT\n| Decimal\n| 10,2\n| 99999999.99\n| Non-negative (AUD)\n\n| FUEL_LITRES\n| Decimal\n| 10,2\n| 99999999.99\n| Optional (0 for non-fuel transactions)\n|===\n\n===== File Requirements\n\n* Encoding: UTF-8 with BOM\n* Line ending: CRLF (`\\r\\n`)\n* Header row: Required (field names as shown above)\n* Max file size: 200MB (approx. 100,000 transactions)\n* Submission deadline: 02:00 UTC daily (Flybuys SLA)\n\n===== PGP Encryption Specifications\n\n* Algorithm: RSA 2048-bit + AES-256\n* Flybuys public key ID: `0xABCD1234` (expires 2026-12-31)\n* Compression: ZIP (level 6)\n* ASCII armor: Yes (`.pgp` extension)\n\n=== Interaction Flows\n\nThis section provides sequence diagrams for critical multi-service interactions across the Flybuys Integration architecture.\n\n==== OAuth linking Flow (TS-2 linking)\n\nCustomer links their Flybuys account via OAuth 2.0 Authorization Code Flow with PKCE from the Mobile Application.\n\n[mermaid]\n----\nsequenceDiagram\n    actor Customer\n    participant Mobile as Mobile App\n    participant Gateway as API Gateway\n    participant Profile as ProfileService\n    participant OAuth as OAuth Service\n    participant Flybuys as Flybuys OAuth\n    participant EventBus as Event Bus\n    participant Loyalty as LoyaltyService\n\n    Customer->>Mobile: Tap \"link Flybuys Account\"\n    Mobile->>Mobile: Generate PKCE code_verifier & code_challenge\n    Mobile->>Gateway: GET /api/v1/profile/oauth/authorize?partner=FLYBUYS\n    Gateway->>Profile: Forward request\n    Profile->>OAuth: InitiateOAuthFlow(partner=FLYBUYS, code_challenge)\n    OAuth->>OAuth: Store code_challenge + state\n    OAuth-->>Profile: OAuth URL + state\n    Profile-->>Gateway: Redirect URL\n    Gateway-->>Mobile: 302 Redirect to Flybuys OAuth\n\n    Mobile->>Flybuys: OAuth Authorization Request\n    Flybuys->>Customer: Login & Consent Screen\n    Customer->>Flybuys: Approve consent\n    Flybuys-->>Mobile: 302 Redirect with auth_code\n\n    Mobile->>Gateway: POST /api/v1/profile/oauth/callback<br/>(auth_code, code_verifier)\n    Gateway->>Profile: Forward callback\n    Profile->>OAuth: ValidateCallback(auth_code, code_verifier)\n    OAuth->>OAuth: Verify code_challenge == hash(code_verifier)\n    OAuth->>Flybuys: POST /oauth/token<br/>(auth_code, code_verifier)\n    Flybuys-->>OAuth: access_token + refresh_token\n    OAuth->>OAuth: Encrypt tokens (AES-256)\n    OAuth->>OAuth: Store in Key Vault\n    OAuth-->>Profile: Token reference + member_id\n\n    Profile->>Profile: Create PartnerLink aggregate<br/>(vivaConsumerId, partner=FLYBUYS, externalMemberId)\n    Profile->>Profile: Set rewardPreference = FLYBUYS_POINTS\n    Profile->>EventBus: Publish Partnerlinked event\n    Profile-->>Gateway: 200 OK (linking success)\n    Gateway-->>Mobile: linking confirmation\n    Mobile->>Customer: \"Flybuys account linked!\"\n\n    EventBus->>Loyalty: Consume Partnerlinked event\n    Loyalty->>Loyalty: Update adjudication rules for customer\n\n    Note over Customer,Loyalty: Error Scenarios\n\n    alt OAuth Authorization Denied\n        Customer->>Flybuys: Deny consent\n        Flybuys-->>Mobile: 302 Redirect with error=access_denied\n        Mobile->>Gateway: POST /api/v1/profile/oauth/callback?error=access_denied\n        Gateway->>Profile: Forward error\n        Profile-->>Gateway: 400 Bad Request (user cancelled)\n        Gateway-->>Mobile: linking cancelled\n        Mobile->>Customer: \"linking cancelled\"\n    end\n\n    alt Flybuys API Failure\n        OAuth->>Flybuys: POST /oauth/token\n        Flybuys-->>OAuth: 500 Internal Server Error\n        OAuth-->>Profile: OAuth token exchange failed\n        Profile-->>Gateway: 502 Bad Gateway\n        Gateway-->>Mobile: Partner temporarily unavailable\n        Mobile->>Customer: \"Flybuys unavailable, try again later\"\n    end\n----\n\n*Key Points*:\n\n* *PKCE*: Code verifier/challenge prevents authorization code interception\n* *Token Storage*: OAuth tokens encrypted in Key Vault, ProfileService stores only reference\n* *Event Publishing*: Partnerlinked event triggers LoyaltyService adjudication rule updates\n* *Error Handling*: User cancellation vs. API failure handled differently\n\n==== Just-In-Time Profile Creation Flow (TS-1 Foundation)\n\nThis flow shows how customer profiles are created on-demand during first login using the xref:../ubiquitous_language.adoc#just-in-time-integration[Just-In-Time Integration] pattern. ProfileService creates the profile and publishes an event. LoyaltyService subscribes to this event and provisions the EagleEye wallet asynchronously (clean DDD bounded context separation).\n\n[mermaid]\n----\nsequenceDiagram\n    actor Customer\n    participant Mobile as Mobile App\n    participant Gateway as API Gateway\n    participant Profile as ProfileService\n    participant ProfileDB as Profile DB\n    participant Salesforce as Salesforce\n    participant EventBus as Event Bus\n    participant Loyalty as LoyaltyService\n    participant EagleEye as EagleEye ACL\n\n    Customer->>Mobile: Login (first time)\n    Mobile->>Gateway: Authenticate with CIAM\n    Gateway-->>Mobile: JWT token (contains email, name, etc.)\n\n    Note over Mobile: Check if profile exists\n\n    Mobile->>Gateway: POST /api/v1/profile/customers<br/>{email, firstName, lastName, phone, preference}\n    Gateway->>Profile: Forward request\n    activate Profile\n\n    Profile->>ProfileDB: Check if profile exists for email\n    ProfileDB-->>Profile: Not found\n\n    Profile->>Salesforce: UPSERT Contact using email as key<br/>{email, firstName, lastName, phone}\n    Salesforce-->>Profile: Contact upserted (contactId, vivaConsumerId)\n\n    Profile->>ProfileDB: Create Customer aggregate<br/>(VCI, email, Salesforce link)\n    ProfileDB-->>Profile: Customer created\n\n    Profile->>EventBus: Publish CustomerProfileCreated event<br/>{vivaConsumerId, salesforceContactId, email, preference}\n    EventBus-->>Profile: Event published\n\n    Profile-->>Gateway: 201 Created<br/>{vivaConsumerId, salesforceContactId, status}\n    deactivate Profile\n    Gateway-->>Mobile: Profile created successfully\n\n    Note over EventBus,Loyalty: Asynchronous Enrollment (Clean DDD)\n\n    EventBus->>Loyalty: CustomerProfileCreated event\n    activate Loyalty\n\n    Loyalty->>EagleEye: POST /wallets<br/>{vivaConsumerId}\n    EagleEye-->>Loyalty: {walletId}\n\n    Loyalty->>EventBus: Publish CustomerEnrolledInLoyalty event<br/>{vivaConsumerId, walletId}\n    EventBus-->>Loyalty: Event published\n    deactivate Loyalty\n\n    Note over Mobile,Customer: Optional: Mobile polls or subscribes for enrollment\n\n    Mobile->>Customer: Login complete - loyalty enrollment in progress\n\n    Note over Customer,EagleEye: Error Scenarios\n\n    alt Profile Already Exists for Email\n        Profile->>ProfileDB: Check if profile exists for email\n        ProfileDB-->>Profile: Profile found\n        Profile-->>Gateway: 409 Conflict (profile already exists)\n        Gateway-->>Mobile: Profile exists - use existing\n        Mobile->>Mobile: Proceed with existing profile\n    end\n\n    alt Salesforce Upsert Failed\n        Profile->>Salesforce: UPSERT Contact\n        Salesforce-->>Profile: 500 Internal Server Error\n        Profile->>Profile: Rollback transaction\n        Profile-->>Gateway: 503 Salesforce unavailable\n        Gateway-->>Mobile: Contact upsert failed\n        Mobile->>Customer: \"Unable to create profile, try again\"\n    end\n\n    alt EagleEye Wallet Creation Failed (Handled by LoyaltyService)\n        Loyalty->>EagleEye: POST /wallets\n        EagleEye-->>Loyalty: 500 Internal Server Error\n        Loyalty->>Loyalty: Retry with exponential backoff\n        Note over Loyalty: Profile exists, wallet creation will retry\n    end\n----\n\n*Key Points*:\n\n* *Just-In-Time Integration*: Profile created on first login, not during registration\n* *Clean DDD Separation*: ProfileService owns identity, LoyaltyService owns loyalty enrollment (wallet creation)\n* *Event-Driven Architecture*: `CustomerProfileCreated` event triggers asynchronous wallet creation by LoyaltyService\n* *Salesforce Upsert*: Creates Salesforce Contact if it doesn't exist, updates if it does (idempotent)\n* *ProfileService Transaction*: Profile creation and Salesforce upsert are atomic (wallet creation is decoupled)\n* *Idempotent Operation*: Returns `409 Conflict` if profile already exists (safe to retry)\n* *Eventual Consistency*: Wallet creation happens asynchronously - mobile app can poll or subscribe for completion\n* *Resilience*: LoyaltyService handles EagleEye failures independently with retry logic (doesn't block profile creation)\n* *Performance Target*: ProfileService p95 < 300ms (faster - no EagleEye dependency)\n\n==== POS Integration Flow (TS-3 Grants)\n\nxref:../bounded_context/interfaces/otr_pos.adoc[OTR POS] scans Loyalty Credential barcode to resolve customer identity before transaction.\n\n[mermaid]\n----\nsequenceDiagram\n    actor Customer\n    participant POS as D365 Commerce POS\n    participant POSACL as POS ACL Adapter<br/>(D365 → Loyalty Domain)\n    participant LoyaltyACL as Loyalty ACL Adapter\n    participant Profile as ProfileService\n    participant ProfileDB as Profile DB\n\n    Customer->>POS: Present barcode\n    POS->>POS: Scan barcode (D365 format)\n\n    Note over POS,ProfileDB: D365 → Loyalty Domain Translation\n\n    POS->>POSACL: GetLoyaltyCardData(barcode, storeId)\n    POSACL->>POSACL: Translate D365 concepts:<br/>LoyaltyCard → VivaConsumerId<br/>StoreCode → siteId<br/>TransactionId → sourceTransactionId\n    POSACL->>Loyalty: POST /api/v1/loyalty/credentials/resolve<br/>{barcode, siteId, sourceTransactionId}\n\n    alt OTR Credential (direct resolution)\n        Loyalty->>Loyalty: Parse OTR member ID from barcode\n        Loyalty->>Profile: GET /customers?memberId={otrMemberId}\n        Profile->>ProfileDB: Query by memberId\n        ProfileDB-->>Profile: Customer (VCI, rewardPreference)\n        Profile-->>Loyalty: Customer context\n    else Flybuys Credential (indirect via PartnerLink)\n        Loyalty->>Loyalty: Parse Flybuys member# from barcode\n        Loyalty->>Profile: GET /partner-links?partner=FLYBUYS&externalMemberId={flybuysNumber}\n        Profile->>ProfileDB: Query PartnerLink aggregate\n        ProfileDB-->>Profile: PartnerLink (VCI, rewardPreference)\n        Profile-->>Loyalty: Customer context\n    end\n\n    Loyalty-->>LoyaltyACL: 200 OK {vivaConsumerId, rewardPreference, walletId}\n\n    Note over POSACL,ProfileDB: Loyalty Domain → D365 Translation\n\n    LoyaltyACL->>LoyaltyACL: Translate Loyalty domain:<br/>vivaConsumerId → LoyaltyCardNumber<br/>rewardPreference → LoyaltyProgramId<br/>walletId → AccountId\n    LoyaltyACL-->>POSACL: LoyaltyResponse {CardNumber, ProgramId, AccountId}\n    POSACL-->>POS: D365 LoyaltyCardData object\n    POS->>Customer: Display: \"Welcome back, Sarah!\"\n\n    Note over Customer,ProfileDB: Error Scenarios\n\n    alt ProfileService Unavailable\n        Loyalty->>Profile: GET /customers (timeout)\n        Profile-->>Loyalty: 503 Service Unavailable\n        Loyalty-->>LoyaltyACL: 503 Service Unavailable\n        LoyaltyACL->>LoyaltyACL: Map to D365 error:<br/>503 → LoyaltyErrorCode.ServiceTemporarilyUnavailable\n        LoyaltyACL-->>POSACL: LoyaltyResponse {ErrorCode, Message}\n        POSACL-->>POS: D365 error object\n        POS->>Customer: \"Loyalty temporarily unavailable, proceed without points\"\n    end\n\n    alt Invalid Barcode Format\n        Loyalty->>Loyalty: Parse barcode (validation fails)\n        Loyalty-->>LoyaltyACL: 400 Bad Request (invalid barcode format)\n        LoyaltyACL->>LoyaltyACL: Map to D365 error:<br/>400 → LoyaltyErrorCode.InvalidCardNumber\n        LoyaltyACL-->>POSACL: LoyaltyResponse {ErrorCode}\n        POSACL-->>POS: D365 error object\n        POS->>Customer: \"Barcode not recognized\"\n    end\n\n    alt Credential Not Found\n        Loyalty->>Profile: GET /partner-links (no match)\n        Profile-->>Loyalty: 404 Not Found\n        Loyalty-->>LoyaltyACL: 404 Not Found (credential not linked)\n        LoyaltyACL->>LoyaltyACL: Map to D365 error:<br/>404 → LoyaltyErrorCode.CardNotFound\n        LoyaltyACL-->>POSACL: LoyaltyResponse {ErrorCode}\n        POSACL-->>POS: D365 error object\n        POS->>Customer: \"Card not registered, visit counter\"\n    end\n\n    alt Partner Not linked\n        Loyalty->>Profile: GET /partner-links?partner=FLYBUYS\n        Profile-->>Loyalty: 200 OK {linked: false}\n        Loyalty-->>LoyaltyACL: 200 OK {requireslinking: true}\n        LoyaltyACL->>LoyaltyACL: Map to D365 business rule:<br/>requireslinking → Prompt for enrollment\n        LoyaltyACL-->>POSACL: LoyaltyResponse {RequiresEnrollment}\n        POSACL-->>POS: D365 enrollment prompt\n        POS->>Customer: \"link Flybuys in app for points\"\n    end\n----\n\n*Key Points*:\n\n* *Bidirectional ACL*: POS ACL Adapter translates D365 Commerce → Loyalty domain; Loyalty ACL Adapter translates Loyalty domain → D365 Commerce\n* *Two Credential Types*: OTR (direct via memberId) vs Flybuys (indirect via PartnerLink aggregate)\n* *Domain Isolation*: D365 POS never sees Loyalty domain concepts (VivaConsumerId, PartnerLink, RewardPreference)\n* *Error Mapping*: Loyalty HTTP status codes and error types mapped to D365 LoyaltyErrorCode enum\n\n==== POS Transaction Adjudication Flow (TS-3 Grants)\n\nCustomer presents Loyalty Credential at POS for transaction adjudication and reward determination.\n\n[mermaid]\n----\nsequenceDiagram\n    actor Customer\n    participant POS as OTR POS\n    participant Gateway as API Gateway\n    participant Loyalty as LoyaltyService\n    participant Profile as ProfileService\n    participant ProfileDB as Profile DB\n    participant EagleEye as EagleEye ACL\n    participant EagleEyeAPI as EagleEye API\n    participant EventBus as Event Bus\n\n    Customer->>POS: Present barcode (EAN-13)\n    POS->>POS: Scan barcode: \"1234567890123\"\n\n    Note over POS,Gateway: Credential Resolution Phase\n    POS->>Gateway: POST /api/v1/loyalty/credentials/resolve<br/>{barcode, storeId, transactionId}<br/>traceparent: 00-{trace-id}-{span-1}-01\n    Gateway->>Loyalty: Forward (add correlation ID)\n    Loyalty->>Loyalty: Parse EAN-13 barcode\n\n    alt OTR Credential (barcode encodes OTR member ID)\n        Loyalty->>Profile: GET /api/v1/profile/customers?memberId={otrMemberId}\n        Profile->>ProfileDB: Query by memberId\n        ProfileDB-->>Profile: Customer record (VCI, rewardPreference)\n        Profile-->>Loyalty: Customer context\n    else Flybuys Credential (barcode encodes Flybuys member number)\n        Loyalty->>Loyalty: Extract Flybuys member# from barcode\n        Loyalty->>Profile: GET /api/v1/profile/partner-links?<br/>partner=FLYBUYS&externalMemberId={flybuysNumber}\n        Profile->>ProfileDB: Query PartnerLink aggregate\n        ProfileDB-->>Profile: PartnerLink (VCI, rewardPreference)\n        Profile-->>Loyalty: Customer context\n    end\n\n    Loyalty-->>Gateway: 200 OK {vivaConsumerId, rewardPreference, walletId}\n    Gateway-->>POS: Credential resolved (280ms p95)\n    POS->>Customer: Display name: \"Welcome back, Sarah!\"\n\n    Note over Customer,EventBus: Transaction Adjudication Phase\n    Customer->>POS: Complete purchase ($75.50)\n    POS->>Gateway: POST /api/v1/loyalty/transactions/adjudicate<br/>{vivaConsumerId, transactionId, items[], total}\n    Gateway->>Loyalty: Forward request\n\n    Loyalty->>Profile: GET /api/v1/profile/customers/{vivaConsumerId}/reward-preference\n    Profile-->>Loyalty: rewardPreference = FLYBUYS_POINTS\n\n    alt Reward Preference = FLYBUYS_POINTS\n        Loyalty->>EagleEye: POST /transactions/validate<br/>(transaction details, walletId)\n        EagleEye->>EagleEyeAPI: Forward to EagleEye AIR\n        EagleEyeAPI-->>EagleEye: Provisional rewards (150 points)\n        EagleEye-->>Loyalty: Validation response\n        Loyalty->>Loyalty: Create RewardTransaction aggregate<br/>(vivaConsumerId, flybuysPoints=150, status=PENDING)\n        Loyalty-->>Gateway: 200 OK {provisionalRewards: 150 points}\n        Gateway-->>POS: Adjudication complete\n        POS->>Customer: \"You'll earn 150 Flybuys points\"\n    else Reward Preference = OTR_FUEL_DISCOUNT\n        Loyalty->>EagleEye: POST /transactions/validate<br/>(fuel discount campaign)\n        EagleEye->>EagleEyeAPI: Check fuel discount grants\n        EagleEyeAPI-->>EagleEye: 8c/L discount available\n        EagleEye-->>Loyalty: Validation response\n        Loyalty-->>Gateway: 200 OK {fuelDiscount: 8cpl}\n        Gateway-->>POS: Adjudication complete\n        POS->>Customer: \"8c/L fuel discount applied\"\n    end\n\n    Note over POS,EventBus: Post-Payment Finalization\n    POS->>POS: Payment captured\n    POS->>Gateway: POST /api/v1/loyalty/transactions/{txnId}/redeem\n    Gateway->>Loyalty: Finalize transaction\n    Loyalty->>EagleEye: POST /transactions/redeem<br/>(confirm rewards)\n    EagleEye->>EagleEyeAPI: Finalize in EagleEye\n    EagleEyeAPI-->>EagleEye: Confirmed\n    EagleEye-->>Loyalty: Redemption complete\n\n    Loyalty->>Loyalty: Update RewardTransaction<br/>(status=CONFIRMED, finalPoints=150)\n    Loyalty->>EventBus: Publish TransactionAdjudicated event\n    Loyalty-->>Gateway: 200 OK\n    Gateway-->>POS: Transaction finalized\n\n    Note over Customer,EventBus: Error Scenarios\n\n    alt ProfileService Unavailable\n        Loyalty->>Profile: GET /api/v1/profile/partner-links\n        Profile-->>Loyalty: 503 Service Unavailable\n        Loyalty->>Loyalty: Circuit breaker OPEN\n        Loyalty-->>Gateway: 503 Service Unavailable<br/>{fallback: \"proceed without points\"}\n        Gateway-->>POS: Degraded mode\n        POS->>Customer: \"Points temporarily unavailable\"\n        POS->>POS: Complete transaction without points\n    end\n\n    alt EagleEye API Timeout\n        Loyalty->>EagleEye: POST /transactions/validate\n        EagleEye->>EagleEyeAPI: Forward request\n        Note over EagleEyeAPI: Timeout after 3s\n        EagleEye-->>Loyalty: 504 Gateway Timeout\n        Loyalty->>Loyalty: Return cached default reward\n        Loyalty-->>Gateway: 200 OK {provisionalRewards: 100 points (default)}\n        Gateway-->>POS: Adjudication complete (degraded)\n        POS->>Customer: \"You'll earn ~100 points (estimate)\"\n    end\n----\n\n*Key Points*:\n\n* *Two-phase adjudication*: Validation (pre-payment) → Redemption (post-payment)\n* *Latency budget*: 500ms p95 for credential resolution (NFR-002)\n* *Graceful degradation*: Circuit breaker returns default rewards if EagleEye slow\n* *Trace propagation*: W3C traceparent header flows through all services\n\n==== Batch File Processing Flow (TS-3 Grants)\n\nNightly batch job aggregates transactions and transmits to Flybuys via SFTP.\n\n[mermaid]\n----\nsequenceDiagram\n    participant Scheduler as Batch Scheduler<br/>(Azure Data Factory)\n    participant Loyalty as LoyaltyService<br/>(Batch Job)\n    participant LoyaltyDB as Loyalty DB\n    participant D365 as D365 Commerce<br/>(POS Transactions)\n    participant FileGen as CSV Generator\n    participant PGP as PGP Encryption\n    participant SFTP as SFTP Client\n    participant Flybuys as Flybuys SFTP Server\n    participant Monitor as Monitoring\n\n    Note over Scheduler,Monitor: Daily Batch Window: 01:00 - 02:00 UTC\n\n    Scheduler->>Scheduler: Timer trigger: 01:00 UTC\n    Scheduler->>Loyalty: Start batch job<br/>(jobId, runDate=yesterday)\n\n    Note over Loyalty,D365: Phase 1: Transaction Aggregation (01:00 - 01:20)\n    Loyalty->>LoyaltyDB: Query RewardTransactions<br/>(status=CONFIRMED, date=yesterday)\n    LoyaltyDB-->>Loyalty: 50,000 transactions\n\n    Loyalty->>D365: Query transactions for reconciliation<br/>(transactionIds[])\n    D365-->>Loyalty: Transaction details\n\n    Loyalty->>Loyalty: Aggregate by Flybuys member<br/>(group by externalMemberId)\n    Loyalty->>Loyalty: Calculate BASE_POINTS + BONUS_POINTS\n    Loyalty->>Monitor: Log progress: \"Aggregated 50k transactions\"\n\n    Note over FileGen,PGP: Phase 2: File Generation (01:20 - 01:35)\n    Loyalty->>FileGen: Generate CSV file<br/>(transactions[], filename=OTR_TRANSACTIONS_20251209_010000.csv)\n    FileGen->>FileGen: Write header row\n    FileGen->>FileGen: Write 50,000 transaction rows\n    FileGen->>FileGen: Validate file format (UTF-8 BOM, CRLF)\n    FileGen-->>Loyalty: CSV file (25MB)\n\n    Loyalty->>PGP: Encrypt file<br/>(publicKey=Flybuys_RSA_2048, compression=ZIP)\n    PGP->>PGP: Compress CSV (ZIP level 6): 25MB → 8MB\n    PGP->>PGP: Encrypt with RSA+AES-256\n    PGP->>PGP: ASCII armor (.pgp extension)\n    PGP-->>Loyalty: Encrypted file (9MB)\n    Loyalty->>Monitor: Log progress: \"File generated, size=9MB\"\n\n    Note over SFTP,Flybuys: Phase 3: SFTP Transmission (01:35 - 01:50)\n    Loyalty->>SFTP: Transmit file<br/>(OTR_TRANSACTIONS_20251209_010000.csv.pgp)\n    SFTP->>Flybuys: SSH connect + authenticate\n    Flybuys-->>SFTP: Connection established\n    SFTP->>Flybuys: PUT file (9MB, ~5 min upload)\n    Flybuys-->>SFTP: Transfer complete\n    SFTP->>Flybuys: Verify checksum (MD5)\n    Flybuys-->>SFTP: Checksum OK\n    SFTP-->>Loyalty: Upload successful\n\n    Loyalty->>LoyaltyDB: Update RewardTransactions<br/>(status=POSTED_TO_FLYBUYS, postedAt=01:45 UTC)\n    Loyalty->>Monitor: Log success: \"Batch file transmitted, size=9MB, records=50k\"\n\n    Note over Flybuys,Monitor: Phase 4: Acknowledgement (01:50 - 02:00)\n    Loyalty->>Loyalty: Wait 5 minutes for ACK file\n    Loyalty->>SFTP: Poll for acknowledgement file<br/>(OTR_TRANSACTIONS_20251209_010000.ack)\n    SFTP->>Flybuys: LIST /outbound/*.ack\n\n    alt Acknowledgement File Present\n        Flybuys-->>SFTP: ACK file found\n        SFTP->>Flybuys: GET acknowledgement file\n        Flybuys-->>SFTP: ACK file content<br/>(status=SUCCESS, records=50000)\n        SFTP-->>Loyalty: ACK file downloaded\n        Loyalty->>Loyalty: Parse ACK file\n        Loyalty->>LoyaltyDB: Update batch job status=ACKNOWLEDGED\n        Loyalty->>Monitor: Log success: \"Batch acknowledged by Flybuys\"\n        Loyalty-->>Scheduler: Job complete (duration=60 min)\n    else No Acknowledgement File\n        SFTP-->>Loyalty: ACK file not found\n        Loyalty->>Loyalty: Wait 2 minutes, retry poll\n        Loyalty->>SFTP: Poll again\n\n        alt ACK Found on Retry\n            SFTP-->>Loyalty: ACK file found (retry successful)\n            Loyalty->>Monitor: Log warning: \"ACK delayed but received\"\n            Loyalty-->>Scheduler: Job complete (duration=62 min)\n        else ACK Still Missing\n            Loyalty->>Monitor: Alert CRITICAL: \"Batch ACK missing after 10 min\"\n            Loyalty->>LoyaltyDB: Update batch job status=ACK_PENDING\n            Loyalty-->>Scheduler: Job partial success (manual follow-up required)\n        end\n    end\n\n    Note over Scheduler,Monitor: Error Scenarios\n\n    alt SFTP Upload Failure\n        SFTP->>Flybuys: PUT file\n        Flybuys-->>SFTP: 500 Internal Server Error\n        SFTP-->>Loyalty: Upload failed\n        Loyalty->>Loyalty: Exponential backoff retry (2min, 4min, 8min)\n        Loyalty->>SFTP: Retry upload (attempt 2/3)\n\n        alt Retry Successful\n            SFTP->>Flybuys: PUT file (retry)\n            Flybuys-->>SFTP: Transfer complete\n            SFTP-->>Loyalty: Upload successful\n            Loyalty->>Monitor: Log warning: \"Upload succeeded on retry 2\"\n            Loyalty-->>Scheduler: Job complete\n        else All Retries Failed\n            Loyalty->>Monitor: Alert CRITICAL: \"Batch upload failed after 3 attempts\"\n            Loyalty->>LoyaltyDB: Update batch job status=FAILED\n            Loyalty-->>Scheduler: Job failed (manual intervention required)\n        end\n    end\n\n    alt Batch Window Deadline Exceeded\n        Note over Loyalty: Current time: 01:58 UTC\n        Loyalty->>Loyalty: Check time remaining: 2 minutes\n        Loyalty->>Monitor: Alert WARNING: \"Approaching 02:00 UTC deadline\"\n        Loyalty->>SFTP: Attempt final upload (priority)\n\n        alt Upload Completes Before 02:00\n            SFTP-->>Loyalty: Upload complete 01:59 UTC\n            Loyalty->>Monitor: Log warning: \"Deadline met with 1 min margin\"\n            Loyalty-->>Scheduler: Job complete (late but within SLA)\n        else Upload Exceeds 02:00 UTC\n            Note over Loyalty: Current time: 02:02 UTC\n            SFTP-->>Loyalty: Upload complete 02:02 UTC\n            Loyalty->>Monitor: Alert CRITICAL: \"SLA breach - uploaded after 02:00 UTC deadline\"\n            Loyalty->>LoyaltyDB: Update batch job status=LATE\n            Loyalty-->>Scheduler: Job complete (SLA breach, escalate to Flybuys)\n        end\n    end\n----\n\n*Key Points*:\n\n* *Batch window*: 01:00-02:00 UTC (1-hour window for 50k-100k transactions)\n* *Four phases*: Aggregation (20 min) → Generation (15 min) → Upload (15 min) → ACK (10 min)\n* *Retry strategy*: Exponential backoff for SFTP failures (2min, 4min, 8min)\n* *SLA deadline*: 02:00 UTC submission deadline enforced by Flybuys\n* *Monitoring*: Critical alerts for ACK missing, upload failures, deadline breaches\n\n<<<\n== Transition Architecture\n\nThis section defines the phased approach to migrate from current state to target architecture, showing intermediate architecture states and technical dependencies.\n\n. *No Big-Bang Migration*: Incremental rollout using Strangler Fig pattern (reference ADR-005 in Architecture Definition)\n. *Zero Downtime*: New bounded contexts operate in parallel with legacy OTR App API during transition\n. *Feature Flag Control*: All new capabilities behind feature flags (see xref:../architecture_definitions/flybuys_integration.adoc#Feature%2520Flag%2520Register[Feature Flag Register] in Architecture Definition)\n. *Data Coexistence*: Dual-write to legacy and new systems during TS-1 Foundation phase (30 days)\n. *Rollback Capability*: Each phase independently reversible without data loss\n\n=== Transition Phase Matrix\n\nProgressive rollout of feature flags across architecture states (TS-0 → TS-1 → TS-2 → TS-3 → AS-4).\n\n*Flag Definitions*: See xref:../architecture_definitions/flybuys_integration.adoc#Feature%2520Flag%2520Register[Feature Flag Register] in Architecture Definition for complete flag purposes, ownership, and strategic rationale.\n\n[cols=\"3,1,1,1,1,1\"]\n|===\n| Flag Name | TS-0 Current | TS-1 Foundation | TS-2 linking | TS-3 Grants | AS-4 Target\n\n| +OTR.Loyalty.Enabled+\n| OFF\n| ON\n| ON\n| ON\n| ON\n\n| +OTR.Loyalty.PartnerLink.Flybuys+\n| OFF\n| OFF\n| ON\n| ON\n| ON\n\n| +OTR.Loyalty.RewardPreferenceSelection+\n| OFF\n| OFF\n| ON\n| ON\n| ON\n\n| +OTR.Loyalty.TransactionAdjudication+\n| OFF\n| OFF\n| OFF\n| ON\n| ON\n\n| +OTR.Loyalty.PointsEarn.Flybuys+\n| OFF\n| OFF\n| OFF\n| ON\n| ON\n\n| +OTR.Loyalty.FlybuysBatchPosting+\n| OFF\n| OFF\n| OFF\n| ON\n| ON\n|===\n\n*Dependencies*:\n\n* +OTR.Loyalty.PartnerLink.Flybuys+ requires +OTR.Loyalty.Enabled+ = ON\n* +OTR.Loyalty.TransactionAdjudication+ requires +OTR.Loyalty.Enabled+ = ON\n* +OTR.Loyalty.PointsEarn.Flybuys+ requires +OTR.Loyalty.TransactionAdjudication+ = ON\n\n=== Rollback Strategy\n\nFeature flags enable rapid rollback without code deployment. Each architecture state can be rolled back by disabling the corresponding flags:\n\n==== TS-1 Foundation Rollback\n\n*Trigger*: VCI migration failures, EagleEye wallet creation issues, or infrastructure instability\n\n*Actions*:\n\n. Set +OTR.Loyalty.Enabled+ = OFF (disables all loyalty features)\n. Delete customer VCI records created during pilot (data cleanup)\n. Validate legacy OTR App API is functioning normally\n\n*Impact*: Mobile app reverts to legacy loyalty features (no EagleEye integration)\n\n==== TS-2 linking Rollback\n\n*Trigger*: OAuth flow failures (>5% failure rate), Flybuys API unavailability, or customer support tickets >50/day\n\n*Actions*:\n\n. Set +OTR.Loyalty.PartnerLink.Flybuys+ = OFF (disables Flybuys linking UI)\n. Set +OTR.Loyalty.RewardPreferenceSelection+ = OFF (hides reward preference selection)\n. Communicate to pilot users via push notification and email\n\n*Impact*: Customers cannot link Flybuys accounts, balance queries disabled\n\n==== TS-3 Grants Rollback\n\n*Trigger*: POS integration failures, batch file acknowledgement rate <98%, or transaction adjudication errors\n\n*Actions*:\n\n. Set +OTR.Loyalty.TransactionAdjudication+ = OFF (reverts to legacy POS integration)\n. Set +OTR.Loyalty.PointsEarn.Flybuys+ = OFF (stops points earning)\n. Set +OTR.Loyalty.FlybuysBatchPosting+ = OFF (stops daily batch transmission)\n. Re-enable Reddy Express legacy Flybuys integration (barcode pattern matching)\n\n*Impact*: POS reverts to legacy Flybuys integration, transactions in-flight may need manual reconciliation\n\n==== Partial Rollback (Batch Posting Issues Only)\n\n*Trigger*: Flybuys batch file acknowledgement failures, SFTP transmission errors\n\n*Actions*:\n\n. Set +OTR.Loyalty.FlybuysBatchPosting+ = OFF (stops batch transmission)\n. Investigate SFTP connectivity, PGP encryption, and acknowledgement file parsing\n. Keep +OTR.Loyalty.TransactionAdjudication+ = ON (POS integration continues)\n\n*Impact*: Points not posted to Flybuys immediately, requires manual batch file regeneration and transmission\n\n=== TS-0 Current State\n\nPre-initiative architecture (reference Architecture Definition §2 Current State)\n\n==== Active Components\n\n* OTR App API (AWS Lambda, DynamoDB)\n* Reddy Express legacy loyalty (SQL Server, POS barcode matching) - Flybuys-only\n* No unified customer identity (OTR users and Reddy Express customers separate)\n* No partner integrations beyond basic xref:../ubiquitous_language.adoc#flybuys-cardholder-number[Flybuys Card] scanning\n\n==== Technical Debt\n\n* Fragmented customer identity (OTR vs Reddy Express silos)\n* No event-driven architecture (synchronous-only integrations)\n* Tight POS coupling (direct Flybuys barcode pattern matching at OTR+ stores)\n* No OAuth infrastructure (no secure third-party account linking)\n\n\n=== TS-1 Foundation\n\nEstablish xref:../bounded_context/profile.adoc[Profile Service], xref:../bounded_context/loyalty.adoc[Loyalty Service], xref:../bounded_context/interfaces/otr_app_api.adoc[Event Bus] without customer-facing features\n\n==== New SBBS\n\n[cols=\"1,3\"]\n|===\n| SBB | Description\n\n| <<sbb-001-profile-service-api,SBB-001>>\n| xref:../bounded_context/profile.adoc[Profile Service] API\n\n| <<sbb-002-profile-service-database,SBB-002>>\n| xref:../bounded_context/profile.adoc[Profile Service] Database\n\n| <<sbb-003-loyalty-service-api,SBB-003>>\n| xref:../bounded_context/loyalty.adoc[Loyalty Service] API\n\n| <<sbb-004-loyalty-service-database,SBB-004>>\n| xref:../bounded_context/loyalty.adoc[Loyalty Service] Database\n\n| <<sbb-006-domain-event-bus,SBB-006>>\n| Domain xref:../bounded_context/interfaces/otr_app_api.adoc[Event Bus] (Event Grid)\n\n| SBB-008\n| Eagle Eye[Eagle Eye] Integration Adaptor\n\n| <<sbb-012-application-monitoring,SBB-012>>\n| Application Monitoring (App Insights)\n\n| <<sbb-013-api-gateway,SBB-013>>\n| API Gateway (APIM)\n|===\n\n==== Implementation Approach\n\nEnable xref:../ubiquitous_language.adoc#customer[Customer] uplift with a xref:../ubiquitous_language.adoc#dark-launch[Dark Launch] rollout strategy. New integration runs in parallel with existing system, validating technical implementation without customer impact\n\n[cols=\"2,5\"]\n|===\n| Activity | Description\n\n| Customer Profile Creation\n| xref:../ubiquitous_language.adoc#just-in-time-integration[Just-In-Time Integration] via `POST /api/v1/profile/customers` endpoint - xref:../ubiquitous_language.adoc#otr-app[Mobile Application] calls this during login if xref:../ubiquitous_language.adoc#customer[Customer] has no xref:../ubiquitous_language.adoc#viva-consumer-id-vci[VCI], creating profile and linking to Salesforce\n\n| Wallet Provisioning\n| Orchestrated by profile creation endpoint - `POST /api/v1/profile/customers` calls EagleEye ACL to provision xref:../ubiquitous_language.adoc#wallet[EagleEye Wallet] atomically with profile creation\n\n| Dual-Write Pattern\n| xref:../ubiquitous_language.adoc#otr-app[Mobile Application] sends requests to both legacy OTR App API and new xref:../bounded_context/profile.adoc[Profile Service] / xref:../bounded_context/loyalty.adoc[Loyalty Service], while legacy remains authoritative until Loyalty Value Chain[Loyalty Value Chain]\n|===\n\n===== Architecture Diagram\n\n[mermaid]\n----\ngraph TD\n    MobileApp[Mobile App]\n    LegacyAPI[Legacy API<br/>Primary]\n    Services[Profile Service<br/>Loyalty Service<br/>pilot only, dual-write]\n    EventBus[Event Bus]\n\n    MobileApp --> LegacyAPI\n    MobileApp --> Services\n    Services --> EventBus\n----\n\n===== Rollout Strategy\n\n*Note*: See xref:../architecture_definitions/flybuys_integration.adoc#Feature%2520Flag%2520Register[Feature Flag Register] in Architecture Definition for complete feature catalogue, and <<transition-phase-matrix,Transition Phase Matrix>> above for rollout schedule.\n\n[cols=\"3,1\"]\n|===\n| Flag | Status\n\n| +OTR.Loyalty.Enabled+\n| On\n\n| +OTR.Loyalty.TransactionAdjudication+\n| Off\n\n| +OTR.Loyalty.RewardPreferenceSelection+\n| Off\n\n| +OTR.Loyalty.PartnerLink.Flybuys+\n| Off\n\n| +OTR.Loyalty.PointsEarn.Flybuys+\n| Off\n|===\n\n===== Events\n\n[cols=\"2,1\"]\n|===\n| Event | Emitted\n\n| +PointsEarned+\n| No\n\n| +FlybuysPointsRedeemed+\n| No\n\n| +TransactionAdjudicated+\n| No\n\n| +PointsEarned+\n| No\n\n| +PointsRedeemed+\n| No\n\n| +PointsExpired+\n| No\n\n| +PointsAdjusted+\n| No\n\n| +CustomerProfileCreated+\n| Yes\n\n| +MemberUnenrolled+\n| No\n\n| +GrantIssued+\n| No\n\n| +GrantRedeemed+\n| No\n|===\n\n===== Success Criteria\n\n* 100% of xref:../ubiquitous_language.adoc#otr-app[Mobile Application] xref:../ubiquitous_language.adoc#customer[Customers] have xref:../ubiquitous_language.adoc#viva-consumer-id-vci[Viva Consumer ID (VCI)] allocated in xref:../bounded_context/external/salesforce_crm.adoc[Salesforce CRM]\n* 100% of xref:../ubiquitous_language.adoc#otr-app[Mobile Application] xref:../ubiquitous_language.adoc#customer[Customers] have xref:../ubiquitous_language.adoc#wallet[Wallets] allocated in xref:../bounded_context/external/eagle_eye.adoc[EagleEye]\n* No xref:../ubiquitous_language.adoc#otr-app[Mobile Application] xref:../ubiquitous_language.adoc#customer[Customers] have a linked xref:../ubiquitous_language.adoc#flybuys-digital-identity[Flybuys Digital Identity]\n* Zero production impact\n* Zero xref:../ubiquitous_language.adoc#otr-app[Mobile Application] impacts\n\n===== Dependencies\n\n* EagleEye API credentials and rate limits confirmed (external dependency - EagleEye, 1000 req/min guaranteed)\n* Infrastructure provisioning complete (internal dependency - Platform team)\n\n==== Rollback Approach\n\n* Delete xref:../ubiquitous_language.adoc#customer[Customers] uplifted xref:../bounded_context/external/salesforce_crm.adoc[Salesforce CRM] profiles\n\n===== Feature Flags\n\n[cols=\"3,1\"]\n|===\n| Flag | Status\n\n| +OTR.Loyalty.Enabled+\n| Off\n\n| +OTR.Loyalty.TransactionAdjudication+\n| Off\n\n| +OTR.Loyalty.RewardPreferenceSelection+\n| Off\n\n| +OTR.Loyalty.PartnerLink.Flybuys+\n| Off\n\n| +OTR.Loyalty.PointsEarn.Flybuys+\n| Off\n|===\n\n\n=== TS-2 linking\n\nEnable customer-facing xref:../ubiquitous_language.adoc#partner-xref[Partner Link] and xref:../ubiquitous_language.adoc#reward-preference[Reward Preference] selection in xref:../ubiquitous_language.adoc#otr-app[Mobile Applications]\n\n==== New SBB\n\n[cols=\"1,2\"]\n|===\n| SBB | Description\n\n| SBB-005\n| OAuth Token Service\n\n| SBB-007\n| Flybuys Integration Adaptor\n\n| SBB-011\n| Mobile Application Updates\n\n| SBB-013\n| Distributed Cache\n|===\n\n==== New Capabilities\n\n* xref:../ubiquitous_language.adoc#otr-app[Mobile Application] xref:../ubiquitous_language.adoc#partner-xref[Partner link] flow (xref:../ubiquitous_language.adoc#pkce[OAuth 2.0 Authorisation Code Flow with PKCE])\n* xref:../ubiquitous_language.adoc#reward-preference[Reward preference selection UI] (Flybuys points vs OTR fuel discount)\n* Real-time Flybuys balance display in mobile app wallet screen\n\n==== Implementation Approach\n\nEnable linking for xref:../ubiquitous_language.adoc#customer[Customers] using a xref:../ubiquitous_language.adoc#ring-deployments[Ring Deployments] progressive exposure strategy\n\n===== Monitoring\n\nTrack OAuth success rate, balance query latency, customer support tickets (30-day observation period)\n\n===== Cutover\n\nAfter 30 days successful pilot (>95% OAuth success rate), enable for all xref:../ubiquitous_language.adoc#customer[Customers]\n\n===== Architecture Diagram\n\n[mermaid]\n----\ngraph TD\n    A[Mobile App] --> B[API Gateway]\n    B --> C[Profile Service]\n    B --> D[Loyalty Service]\n    C --> E[Event Bus]\n    C --> F[OAuth Service + Key Vault]\n    C --> G[Flybuys API]\n    D --> E\n    D --> F\n    D --> G\n----\n\n===== Rollout\n\n====== Ring 0 (Internal Validation)\n\nStaff accounts (50 users), 7 days\n\n* Validation: Users are in xref:../bounded_context/external/salesforce_crm.adoc[Salesforce CRM] and Braze\n* Go criteria: 100% success rate, zero P1/P2 incidents\n\n====== Ring 1 (Pilot Users)\n\nCustomers who regularly use the xref:../ubiquitous_language.adoc#otr-app[Mobile Applications], 14 days\n\n* Validation: OAuth success rate >90%, customer support tickets <10/day\n* Go criteria: Meet validation targets for 7 consecutive days\n\n====== Ring 2 (General availability)\n\nAll xref:../ubiquitous_language.adoc#otr-app[Mobile Application] Customers\n\n* Deployment: Gradual rollout using percentage targeting (10% → 50% → 100% over 14 days)\n* Monitoring: Track OAuth success rate, balance query latency, customer support tickets (30-day observation period)\n\n[cols=\"3,1\"]\n|===\n| Flag | Status\n\n| +OTR.Loyalty.Enabled+\n| On\n\n| +OTR.Loyalty.TransactionAdjudication+\n| Off\n\n| +OTR.Loyalty.RewardPreferenceSelection+\n| Off\n\n| +OTR.Loyalty.PartnerLink.Flybuys+\n| On\n\n| +OTR.Loyalty.PointsEarn.Flybuys+\n| Off\n|===\n\n===== Events\n\n[cols=\"2,1\"]\n|===\n| Event | Emitted\n\n| +Partnerlinked+\n| Yes\n\n| +PartnerUnlinked+\n| Yes\n\n| +PointsEarned+\n| No\n\n| +FlybuysPointsRedeemed+\n| No\n\n| +TransactionAdjudicated+\n| No\n\n| +PointsEarned+\n| No\n\n| +PointsRedeemed+\n| No\n\n| +PointsExpired+\n| No\n\n| +PointsAdjusted+\n| No\n\n| +CustomerProfileCreated+\n| Yes\n\n| +MemberUnenrolled+\n| No\n\n| +GrantIssued+\n| No\n\n| +GrantRedeemed+\n| No\n|===\n\n===== Dependencies\n\n* Flybuys OAuth API production credentials (external - Flybuys, confirmed Nov 2025)\n* OAuth Service provisioned with Flybuys IDP connection (internal - Platform team, Dec 2025)\n* Mobile app release with linking UI\n\n===== Success Criteria\n\n* 95% of xref:../ubiquitous_language.adoc#customer[Customers] attempting xref:../ubiquitous_language.adoc#partner-xref[Partner link] are successful\n* OAuth success rate >95% over 30-day pilot period (validation exit criterion)\n* Balance query latency < 2s p95 (NFR-003)\n* Customer support tickets < 50 related to linking issues (< 0.5% of pilot users)\n\n==== Rollback Approach\n\n* Delete xref:../ubiquitous_language.adoc#partner-xref[Partner link] from pilot xref:../ubiquitous_language.adoc#customer[Customers] (customer communication required via email/push notification)\n\n===== Feature Flags\n\n[cols=\"3,1\"]\n|===\n| Flag | Status\n\n| +OTR.Loyalty.Enabled+\n| On\n\n| +OTR.Loyalty.TransactionAdjudication+\n| Off\n\n| +OTR.Loyalty.RewardPreferenceSelection+\n| On\n\n| +OTR.Loyalty.PartnerLink.Flybuys+\n| Off\n\n| +OTR.Loyalty.PointsEarn.Flybuys+\n| Off\n|===\n\n\n=== TS-3 Grants\n\n* Enable in-store xref:../bounded_context/interfaces/otr_pos.adoc[OTR POS] and xref:../bounded_context/interfaces/otr_plus_pos.adoc[OTR+ POS] xref:../ubiquitous_language.adoc#loyalty-credential[Loyalty Credential] recognition\n* Transaction posting to Flybuys (batch files)\n* xref:../ubiquitous_language.adoc#digital-fuel-dockets[Digital Fuel Docket] redemption\n\n==== New SBB\n\n[cols=\"1,3\"]\n|===\n| SBB | Description\n\n| SBB-012\n| Batch File Pipeline (serverless functions for daily aggregation, SFTP transmission)\n|===\n\n==== Implementation Approach\n\n*POS Barcode Integration*:\n\n. Deploy +POST /api/v1/loyalty/credentials/resolve+ endpoint\n. Update POS to call Loyalty Service API on barcode scan\n. Barcode Format: EAN-13 (13-digit European Article Number standard)\n. Pre-linking Requirement: Customers must link Flybuys account via mobile app OAuth flow (TS-2)\n. Error Handling: POS displays \"Please link Flybuys in mobile app\" if unlinked Flybuys credential scanned (422 error)\n\n*Rollout Strategy*:\n\n* POS Rollout: Enable barcode scanning at pilot stores (10 OTR stores), then gradual rollout\n* Batch Processing: Daily batch file generation starts (nightly 01:00 UTC job)\n\n===== Feature Flags\n\n[cols=\"3,1\"]\n|===\n| Flag | Status\n\n| +OTR.Loyalty.Enabled+\n| On\n\n| +OTR.Loyalty.TransactionAdjudication+\n| On\n\n| +OTR.Loyalty.RewardPreferenceSelection+\n| On\n\n| +OTR.Loyalty.PartnerLink.Flybuys+\n| On\n\n| +OTR.Loyalty.PointsEarn.Flybuys+\n| On\n|===\n\n*Success Criteria*:\n\n* 100% of customer transactions post to Flybuys (batch acknowledgement rate >98%, NFR-016)\n* POS barcode resolution latency < 500ms p95 (NFR-002)\n* Digital docket redemption operational at all 500+ stores\n\n=== AS-4 Target State\n\nFinal steady-state architecture after all Flybuys Integration capabilities are deployed and stabilised.\n\n==== Success Criteria (Entry to AS-4)\n\n*Prerequisites*:\n\n* TS-3 Grants operational for minimum 6 months\n* Zero critical incidents (P1/P2) in last 90 days\n* All NFRs validated and meeting targets\n* Legacy Reddy Express Flybuys integration fully decommissioned\n\n==== Characteristics of Target State\n\n===== Feature Flags\n\n* All flags remain ON (no changes from TS-3)\n* Feature flag infrastructure retained for emergency rollback capability\n\n===== Architecture\n\n* Bounded contexts operating independently\n* Event-driven integration fully operational\n* Anti-Corruption Layers protecting domain boundaries\n* Zero coupling to legacy OTR App API\n\n=== Technical Dependency Graph\n\n[mermaid]\n----\ngraph TD\n    A[TS-1: Foundation] --> B[TS-2: linking Enabled]\n    B --> C[TS-3: Grants Operational]\n    C --> D[AS-4: Target State]\n\n    A -->|Prerequisite| E[VCI Migration Complete]\n    A -->|Prerequisite| F[EagleEye Wallets Created]\n\n    B -->|Prerequisite| G[OAuth Service Ready<br/>Flybuys IDP configured]\n    B -->|Prerequisite| H[Flybuys OAuth Credentials<br/>Production API keys]\n\n    C -->|Prerequisite| I[Flybuys SFTP Access<br/>SSH keys, PGP encryption]\n    C -->|Prerequisite| J[D365 POS Integration<br/>Barcode API ready]\n\n    D -->|Prerequisite| K[6 Months Stability<br/>No critical incidents]\n    D -->|Prerequisite| L[Legacy Data Archived<br/>7-year retention]\n----\n\n=== Transition Risks\n\n[cols=\"1,3,3,2\"]\n|===\n| Risk ID | Risk Description | Mitigation | Contingency\n\n| TR-001\n| VCI migration fails (customers lose profile data)\n| Dual-write during TS-1 (30 days), legacy remains authoritative\n| Rollback to legacy OTR App API only\n\n| TR-002\n| Flybuys OAuth service outage during rollout\n| Circuit breaker pattern, cached balance data as fallback (5-min TTL)\n| Disable linking, revert to read-only balance\n\n| TR-003\n| Batch file transmission failures (points not posted)\n| Retry logic with exponential backoff (3 attempts), manual SFTP fallback\n| Manual CSV generation and upload by data team\n\n| TR-004\n| POS barcode scanning latency unacceptable (>1s)\n| Redis caching for barcode resolution (5-min TTL), load testing in UAT\n| Revert to legacy Reddy Express POS integration\n\n| TR-005\n| Event Bus delivery failures (eventual consistency)\n| Dead letter queue monitoring (alert if >100 events), replay capability\n| Synchronous API calls as fallback (temporary)\n\n| TR-006\n| Cosmos DB autoscale insufficient (RU/s throttling)\n| Monitor 429 errors, increase max RU/s (10k → 20k), partition optimization\n| Temporarily disable non-critical features\n|===\n\n<<<\n== Solution Validation\n\nThis section defines how the solution will be validated against requirements defined in the Architecture Definition.\n\n=== Functional Validation\n\n*Business Requirements*: See xref:../architecture_definitions/flybuys_integration.adoc#Business%2520Requirements[Business Requirements] in Architecture Definition for complete requirement definitions (BR-001 through BR-012).\n\n*Validation Approach*: All business requirements validated through combination of:\n\n* UAT testing with pilot users (500 mobile app users, 100 OAuth linking attempts)\n* Production pilot at 10 stores (10k transactions monitored)\n* Automated API tests (ProfileService, LoyaltyService, EagleEye integration)\n* Manual verification of batch file generation and Flybuys acknowledgement\n\n*Key Validation Checkpoints*:\n\n* *Customer Identity (BR-001, BR-002)*: 100% users have VCI allocated in Salesforce\n* *Partner linking (BR-004)*: OAuth flow completes in <30s p95\n* *Reward Preferences (BR-005, BR-006)*: Preference changes reflected within 5s\n* *Transaction Posting (BR-007)*: Transactions appear in daily batch file with correct points\n* *Balance Display (BR-010)*: Flybuys balance query returns within 2s p95\n* *Transaction Adjudication (BR-012)*: 100% credentialed transactions route to EagleEye\n\n=== Non-Functional Validation\n\n[cols=\"1,3,3,2\"]\n|===\n| NFR ID | Validation Test | Acceptance Criteria | Tool/Method\n\n| NFR-001\n| Profile Service API latency under load\n| p95 < 200ms with 100 concurrent users\n| JMeter load test (UAT, 10k requests)\n\n| NFR-002\n| Loyalty Service API latency under load\n| p95 < 500ms with 500 concurrent POS transactions/sec\n| JMeter load test (UAT, 50k requests)\n\n| NFR-003\n| Flybuys balance query latency\n| p95 < 2s including Flybuys API call + Redis cache\n| Application Insights (PROD, 30-day avg)\n\n| NFR-004\n| Batch file generation window\n| Job starts 01:00 UTC, completes by 02:00 UTC (1-hour max)\n| Batch pipeline monitoring (PROD, 30-day avg)\n\n| NFR-006\n| Profile Service uptime\n| 99.9% measured over 30 days (max 4.3 hours downtime)\n| Azure Monitor (PROD, 30-day SLA)\n\n| NFR-016\n| Batch file acknowledgement rate\n| >98% transactions acknowledged by Flybuys within 24 hours\n| PROD monitoring (60-day avg)\n|===\n\n=== Integration Validation\n\n[cols=\"2,3,3,2\"]\n|===\n| Integration Point | Validation Test | Acceptance Criteria | Method\n\n| Flybuys OAuth API\n| OAuth flow completes with valid access token\n| Token retrieved and stored in Key Vault\n| Pact contract test (UAT)\n\n| Flybuys Balance API\n| Balance query returns valid response\n| Response matches Flybuys API spec v2.1, < 1.5s latency\n| Integration test harness (UAT)\n\n| Flybuys SFTP\n| Batch file uploads successfully\n| File appears in Flybuys /inbound/otr/ directory, PGP encrypted\n| SFTP integration test (UAT)\n\n| EagleEye Adjudication\n| Transaction adjudication returns grants\n| Response matches EagleEye API spec v3, grants correct\n| Pact contract test (UAT)\n\n| Event Grid\n| Domain events published and consumed\n| Partnerlinked event delivered to Loyalty Service < 5s\n| Event Bus integration test (UAT)\n|===\n\n=== Security Validation\n\n*Validation Method*: Penetration testing (external vendor) + Security audit (internal InfoSec team)\n\n[cols=\"2,3,3,2\"]\n|===\n| Security Control | Validation Test | Acceptance Criteria | Auditor\n\n| OAuth PKCE\n| Authorization code flow uses PKCE\n| Code challenge/verifier validated (S256 method)\n| External pentest (UAT, Q1 2026)\n\n| Token encryption\n| Tokens encrypted at rest (Key Vault)\n| AES-256 encryption, customer-managed keys\n| Internal security audit (PROD)\n\n| API authentication\n| Unauthenticated requests blocked\n| 401 Unauthorized for missing/invalid tokens\n| Automated security scan (UAT)\n\n| Data residency\n| Customer data stored in Australia East region\n| Cosmos DB, Key Vault in AU region only\n| Compliance audit (PROD)\n|===\n\n=== SBB Dependency Flowchart\n\nThis flowchart visualizes the dependency relationships between Solution Building Blocks (SBBs) in the Flybuys Integration architecture.\n\n==== Dependency Chain Diagram\n\n[mermaid]\n----\ngraph TD\n    %% External Systems\n    FlybuysOAuth[External: Flybuys OAuth]\n    FlybuysAPI[External: Flybuys API]\n    EagleEyeAPI[External: EagleEye API]\n    BrazeAPI[External: Braze API]\n\n    %% Mobile & Presentation Layer\n    SBB014[SBB-014: OTR Mobile App]\n\n    %% API Gateway\n    SBB013[SBB-013: API Gateway]\n\n    %% Profile Service\n    SBB001[SBB-001: Profile Service API]\n    SBB002[SBB-002: Profile Service Database]\n\n    %% Loyalty Service\n    SBB003[SBB-003: Loyalty Service API]\n    SBB004[SBB-004: Loyalty Service Database]\n\n    %% Engagement Service\n    SBB007[SBB-007: Engagement Service API]\n    SBB008[SBB-008: Engagement Service Database]\n\n    %% Infrastructure Services\n    SBB005[SBB-005: OAuth Token Manager]\n    SBB006[SBB-006: Domain Event Bus]\n    SBB009[SBB-009: Braze Integration Adaptor]\n    SBB010[SBB-010: Flybuys Integration Adaptor]\n    SBB011[SBB-011: EagleEye Integration Adaptor]\n    SBB012[SBB-012: Application Monitoring]\n    SBB015[SBB-015: Batch File Pipeline]\n    SBB016[SBB-016: Distributed Cache]\n    SBB017[SBB-017: Feature Flag Service]\n\n    %% Mobile App Dependencies\n    SBB014 -->|Partner linking| SBB001\n    SBB014 -->|Balance queries| SBB003\n    SBB014 -->|Ingress routing| SBB013\n\n    %% API Gateway Dependencies\n    SBB013 -->|Routes to| SBB001\n    SBB013 -->|Routes to| SBB003\n    SBB013 -->|Routes to| SBB007\n\n    %% Profile Service Dependencies\n    SBB001 -->|Persists PartnerLink| SBB002\n    SBB001 -->|Token storage/retrieval| SBB005\n    SBB001 -->|Publishes events| SBB006\n    SBB001 -->|Monitored by| SBB012\n\n    %% Loyalty Service Dependencies\n    SBB003 -->|Persists transactions| SBB004\n    SBB003 -->|PartnerLink lookup| SBB001\n    SBB003 -->|Publishes/Consumes events| SBB006\n    SBB003 -->|Balance queries| SBB010\n    SBB003 -->|Transaction adjudication| SBB011\n    SBB003 -->|Caches Flybuys balance| SBB016\n    SBB003 -->|Monitored by| SBB012\n    SBB003 -->|Feature toggles| SBB017\n\n    %% OAuth Token Manager Dependencies\n    SBB005 -->|Initiates OAuth| SBB001\n    SBB005 -->|OAuth tokens| FlybuysOAuth\n\n    %% Engagement Service Dependencies\n    SBB007 -->|Persists campaign state| SBB008\n    SBB007 -->|Consumes events| SBB006\n    SBB007 -->|Triggers campaigns| SBB009\n    SBB007 -->|Monitored by| SBB012\n\n    %% Braze Integration Adaptor Dependencies\n    SBB009 -->|Consumes events| SBB006\n    SBB009 -->|Optional enrichment| SBB001\n    SBB009 -->|Webhook calls| BrazeAPI\n\n    %% Flybuys Integration Adaptor Dependencies\n    SBB010 -->|Balance API| FlybuysAPI\n    SBB010 -->|Batch file upload| SBB015\n    SBB010 -->|Cached responses| SBB016\n\n    %% EagleEye Integration Adaptor Dependencies\n    SBB011 -->|Wallet & adjudication| EagleEyeAPI\n\n    %% Batch File Pipeline Dependencies\n    SBB015 -->|Reads transactions| SBB003\n    SBB015 -->|SFTP upload| FlybuysAPI\n\n    %% Event Bus Subscribers\n    SBB006 -.->|Partnerlinked event| SBB003\n    SBB006 -.->|Partnerlinked event| SBB007\n    SBB006 -.->|TransactionAdjudicated event| SBB007\n\n    %% Styling\n    classDef external fill:#f9f,stroke:#333,stroke-width:2px\n    classDef mobile fill:#bbf,stroke:#333,stroke-width:2px\n    classDef gateway fill:#bfb,stroke:#333,stroke-width:2px\n    classDef service fill:#fbb,stroke:#333,stroke-width:2px\n    classDef database fill:#ffb,stroke:#333,stroke-width:2px\n    classDef infrastructure fill:#bff,stroke:#333,stroke-width:2px\n    classDef integration fill:#fbf,stroke:#333,stroke-width:2px\n\n    class FlybuysOAuth,FlybuysAPI,EagleEyeAPI,BrazeAPI external\n    class SBB014 mobile\n    class SBB013 gateway\n    class SBB001,SBB003,SBB007 service\n    class SBB002,SBB004,SBB008 database\n    class SBB005,SBB006,SBB012,SBB015,SBB016,SBB017 infrastructure\n    class SBB009,SBB010,SBB011 integration\n----\n\n==== Dependency Layers\n\n===== Layer 1: External Systems\n\n* Flybuys OAuth Server\n* Flybuys API (Balance, Batch File SFTP)\n* EagleEye API\n* Braze API\n\n===== Layer 2: Presentation & Gateway\n\n* *SBB-014*: OTR Mobile App\n* *SBB-013*: API Gateway (ingress routing, OAuth validation, rate limiting)\n\n===== Layer 3: Domain Services\n\n* *SBB-001*: Profile Service API (partner linking, reward preferences)\n* *SBB-003*: Loyalty Service API (credential resolution, transaction adjudication)\n* *SBB-007*: Engagement Service API (campaign orchestration)\n\n===== Layer 4: Data Stores\n\n* *SBB-002*: Profile Service Database (PartnerLink aggregates)\n* *SBB-004*: Loyalty Service Database (RewardTransaction audit trail)\n* *SBB-008*: Engagement Service Database (campaign state tracking)\n\n===== Layer 5: Infrastructure Services\n\n* *SBB-005*: OAuth Token Manager (Flybuys token storage/refresh)\n* *SBB-006*: Domain Event Bus (event-driven integration)\n* *SBB-012*: Application Monitoring (observability)\n* *SBB-016*: Distributed Cache (Flybuys balance caching)\n* *SBB-017*: Feature Flag Service (progressive rollout)\n\n===== Layer 6: Integration Adaptors (Anti-Corruption Layers)\n\n* *SBB-009*: Braze Integration Adaptor (marketing automation)\n* *SBB-010*: Flybuys Integration Adaptor (conformist pattern)\n* *SBB-011*: EagleEye Integration Adaptor (loyalty engine)\n\n===== Layer 7: Batch Processing\n\n* *SBB-015*: Batch File Pipeline (nightly transaction aggregation, SFTP transmission)\n\n==== Critical Dependency Paths\n\n===== Partner linking Flow\n\n----\nMobile App (SBB-014)\n  → API Gateway (SBB-013)\n  → Profile Service (SBB-001)\n  → OAuth Token Manager (SBB-005)\n  → Flybuys OAuth\n----\n\n===== Transaction Adjudication Flow\n\n----\nPOS System\n  → API Gateway (SBB-013)\n  → Loyalty Service (SBB-003)\n  → Profile Service (SBB-001) [PartnerLink lookup]\n  → EagleEye Adaptor (SBB-011)\n  → EagleEye API\n----\n\n===== Flybuys Balance Query Flow\n\n----\nLoyalty Service (SBB-003)\n  → Distributed Cache (SBB-016) [cache miss]\n  → Flybuys Adaptor (SBB-010)\n  → Flybuys API\n----\n\n===== Event-Driven Engagement Flow\n\n----\nProfile Service (SBB-001) [publishes Partnerlinked]\n  → Event Bus (SBB-006)\n  → Engagement Service (SBB-007)\n  → Braze Adaptor (SBB-009)\n  → Braze API\n----\n\n==== Notes\n\n* *Solid arrows (→)* indicate synchronous dependencies (REST API calls, database queries)\n* *Dotted arrows (-.->)* indicate asynchronous dependencies (event subscriptions)\n* Some SBB references in the document contain numbering errors\n","structuredPatch":[{"oldStart":77,"oldLines":7,"newStart":77,"newLines":7,"lines":[" * Implement **Anti-Corruption Layers** (ACLs) for xref:../bounded_context/external/braze.adoc[Braze], xref:../bounded_context/external/flybuys.adoc[Flybuys] and xref:../bounded_context/external/eagle_eye.adoc[EagleEye] integration"," * Deploy xref:../bounded_context/interfaces/oauth.adoc[OAuth Service] with Key Vault token encryption"," * Establish event-driven architecture as the foundational integration pattern for the platform.","-* Phased roll-out (TS-1 → AS-4)","+* Phased roll-out (TS-1 → TS-4)"," "," === Related Documentation"," "]},{"oldStart":3251,"oldLines":13,"newStart":3251,"newLines":13,"lines":[" "," === Transition Phase Matrix"," ","-Progressive rollout of feature flags across architecture states (TS-0 → TS-1 → TS-2 → TS-3 → AS-4).","+Progressive rollout of feature flags across architecture states (TS-0 → TS-1 → TS-2 → TS-3 → TS-4)."," "," *Flag Definitions*: See xref:../architecture_definitions/flybuys_integration.adoc#Feature%2520Flag%2520Register[Feature Flag Register] in Architecture Definition for complete flag purposes, ownership, and strategic rationale."," "," [cols=\"3,1,1,1,1,1\"]"," |===","-| Flag Name | TS-0 Current | TS-1 Foundation | TS-2 linking | TS-3 Grants | AS-4 Target","+| Flag Name | TS-0 Current | TS-1 Foundation | TS-2 linking | TS-3 Grants | TS-4 Target"," "," | +OTR.Loyalty.Enabled+"," | OFF"]},{"oldStart":3797,"oldLines":11,"newStart":3797,"newLines":11,"lines":[" * POS barcode resolution latency < 500ms p95 (NFR-002)"," * Digital docket redemption operational at all 500+ stores"," ","-=== AS-4 Target State","+=== TS-4 Target State"," "," Final steady-state architecture after all Flybuys Integration capabilities are deployed and stabilised."," ","-==== Success Criteria (Entry to AS-4)","+==== Success Criteria (Entry to TS-4)"," "," *Prerequisites*:"," "]},{"oldStart":3831,"oldLines":7,"newStart":3831,"newLines":7,"lines":[" graph TD","     A[TS-1: Foundation] --> B[TS-2: linking Enabled]","     B --> C[TS-3: Grants Operational]","-    C --> D[AS-4: Target State]","+    C --> D[TS-4: Target State]"," ","     A -->|Prerequisite| E[VCI Migration Complete]","     A -->|Prerequisite| F[EagleEye Wallets Created]"]}],"userModified":false,"replaceAll":true},"sourceToolAssistantUUID":"e7b44afe-e313-46b3-8eb2-58e93e46c491"}
{"parentUuid":"390d4831-ec88-4c1c-b8b1-fadb52d03b14","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_018aSA6LzQ4ySc52KBpQi52R","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Great! All the replacements have been made successfully. Let me verify the changes by searching for the new TS naming in the file to confirm everything was updated correctly.","signature":"EtcCCkYICxgCKkDZN0X9Nyzi74wtmWI0B1XsH9cFG1/p7d3NNb2F76zOPIS+2MCY2FDqQm6yB8Z/TQ0tC8DUoo+bUNRlFfW2RtqmEgxcwWZ4sfUGDXjzoxAaDA5klbH+7PbV+c2GhSIwWe95isTt6mJyTpezEFm0uxvW0syqkETE3f2/vGn6JIOBYczmMhdXSqgO8efADSo5Kr4BbeZUpCs1N0ytd6zYk4ovb3LB1nOGanIEKEFXVVc8vrnPd5E3igkMkOLBhwQCoOWmgZnsyIAwNy9aV4CfakY/byXXsSabr4XhEo7e/enBS9o8SPC8KBeIlwjIHe/t7hWSyvJQtFzTXHvn4epBRY1QXvMqdqTiXPVd3sTFlRhHg2E9fzL+mPnOLulREDuUqSxhWALVuzSIrQha1F95il3LV1PkiFCEdGfy9Znf4poJgKRv7jyaOU0AHXLnvnEblBgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":14,"cache_creation_input_tokens":1312,"cache_read_input_tokens":31154,"cache_creation":{"ephemeral_5m_input_tokens":1312,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CWuNZbmDGjgQ4HACV5PZ1","type":"assistant","uuid":"3155995a-30b7-4114-aefa-b136cbc05c26","timestamp":"2026-01-08T05:38:58.709Z"}
{"parentUuid":"3155995a-30b7-4114-aefa-b136cbc05c26","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_018aSA6LzQ4ySc52KBpQi52R","type":"message","role":"assistant","content":[{"type":"text","text":"Perfect! I've successfully standardized the phase naming in flybuys_integration.adoc. All references have been updated from AS (Architecture State) to TS (Transition State):\n\n- AS-0 → TS-0 (Current State)\n- AS-1 → TS-1 (Foundation)\n- AS-2 → TS-2 (Linking)\n- AS-3 → TS-3 (Grants)\n- AS-4 → TS-4 (Target State)\n\nBoth solution architecture documents now use consistent TS naming for transition states, aligning with TOGAF's terminology while maintaining your preferred convention."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":14,"cache_creation_input_tokens":1312,"cache_read_input_tokens":31154,"cache_creation":{"ephemeral_5m_input_tokens":1312,"ephemeral_1h_input_tokens":0},"output_tokens":192,"service_tier":"standard"}},"requestId":"req_011CWuNZbmDGjgQ4HACV5PZ1","type":"assistant","uuid":"83aeb87f-e2f0-4c33-b9a4-f31fd7a63726","timestamp":"2026-01-08T05:39:01.460Z"}
{"type":"file-history-snapshot","messageId":"77d0e44f-5fa8-403e-97aa-173159bbacba","snapshot":{"messageId":"77d0e44f-5fa8-403e-97aa-173159bbacba","trackedFileBackups":{"solution_architectures/flybuys_integration.adoc":{"backupFileName":"63d414abe912008a@v2","version":2,"backupTime":"2026-01-08T05:44:49.416Z"}},"timestamp":"2026-01-08T05:44:49.355Z"},"isSnapshotUpdate":false}
{"parentUuid":"83aeb87f-e2f0-4c33-b9a4-f31fd7a63726","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","type":"user","message":{"role":"user","content":"Make architectural_approach.adoc more generic, and less specifically about the Salesforce project"},"uuid":"77d0e44f-5fa8-403e-97aa-173159bbacba","timestamp":"2026-01-08T05:44:49.323Z","thinkingMetadata":{"level":"high","disabled":false,"triggers":[]},"todos":[]}
{"parentUuid":"77d0e44f-5fa8-403e-97aa-173159bbacba","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01B7iL7SsY6FqitsxF2qQBVL","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"The user wants me to make the architectural_approach.adoc file more generic and less specific to the Salesforce project. Let me first read this file to see what's in it.","signature":"EtICCkYICxgCKkCkrrhwKCDOFVJejpvJFi6TilK3wXWkR37eWnMlOsc6EUnYt3U3xKXszmBvBi/HhzfwqWuRvM/21tua25/4ROejEgwBUqm77XT4qYUjwVMaDFp2hiTr7c82piEQNSIwF7pJRUESWtQrvNuRMcSV90vsWpDJA1uin2pnZ3SekKWtmJNHE5AxjGihyTBtxI1lKrkBpDCCyLlie/ksLMS413Jr8u0OImmEdUXTF8u/DkXA705JpH9X6RdNJlZZJuH2z2fpxL8NNSxi1K0do9R6Adjvcgr+h0NbdG4ErXgurBx424CvH8RB/+XGWrWroAYqx3NtKnTpstt8BUdso2fvQZmZ0DLnYyh9sZ5kW+44kXZF8QDHcuonQw2GqPUWMQrQo7a19d2yd+MQw3S11bDLpFddyPkaCPDU2oEDsR7M6MA3aTjiWBDzlu+UyuoYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":32515,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":32515,"ephemeral_1h_input_tokens":0},"output_tokens":8,"service_tier":"standard"}},"requestId":"req_011CWuP1iVzKZbKyJQbPhGaf","type":"assistant","uuid":"faa2657d-d105-4f98-908e-0e334eb8eba5","timestamp":"2026-01-08T05:44:54.621Z"}
{"parentUuid":"faa2657d-d105-4f98-908e-0e334eb8eba5","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01B7iL7SsY6FqitsxF2qQBVL","type":"message","role":"assistant","content":[{"type":"text","text":"Let me read the architectural_approach.adoc file to see what needs to be made more generic."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":32515,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":32515,"ephemeral_1h_input_tokens":0},"output_tokens":8,"service_tier":"standard"}},"requestId":"req_011CWuP1iVzKZbKyJQbPhGaf","type":"assistant","uuid":"eab38104-2472-4a63-99c2-ab5d0773591d","timestamp":"2026-01-08T05:44:55.286Z"}
{"parentUuid":"eab38104-2472-4a63-99c2-ab5d0773591d","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01B7iL7SsY6FqitsxF2qQBVL","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01EeBWapj3sy6uPDoFapp9K6","name":"Glob","input":{"pattern":"**/architectural_approach.adoc"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":32515,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":32515,"ephemeral_1h_input_tokens":0},"output_tokens":128,"service_tier":"standard"}},"requestId":"req_011CWuP1iVzKZbKyJQbPhGaf","type":"assistant","uuid":"2a97706e-3b36-4a3c-9b8a-917356b1e211","timestamp":"2026-01-08T05:44:55.751Z"}
{"parentUuid":"2a97706e-3b36-4a3c-9b8a-917356b1e211","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01EeBWapj3sy6uPDoFapp9K6","type":"tool_result","content":"/mnt/c/Users/o.young/work/architecture/architectural_approach.adoc"}]},"uuid":"5850a6bc-b83f-4dec-91c3-aefa019793f4","timestamp":"2026-01-08T05:44:58.860Z","toolUseResult":{"filenames":["/mnt/c/Users/o.young/work/architecture/architectural_approach.adoc"],"durationMs":2879,"numFiles":1,"truncated":false},"sourceToolAssistantUUID":"2a97706e-3b36-4a3c-9b8a-917356b1e211"}
{"parentUuid":"5850a6bc-b83f-4dec-91c3-aefa019793f4","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01BgReF4uV1Jd54ndjnMYJyB","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Found the file. Now let me read it.","signature":"EssBCkYICxgCKkDDBWWrc2ne63dccMrqVoR9uX71SuwJxt4fOz5U18njexdSgG55jkmpvuzd+eytPHBwVEPYRDGgbvJsjCklWLXfEgz0F6nOY827JZ3Bu3caDHnXUwMMq9f+neidkSIwsifTqboGWABmjeggTl/vfhj4JG0o+MUp0SrAqHOes6wN2hfnsx/DbYxZm5683absKjNRP4dZpq04BukyY0Zpf+jsdcadkNdZHFtu5vaj36f7Oqfg123/h+dAuK7OZqFG1bOCGsYYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":165,"cache_read_input_tokens":32515,"cache_creation":{"ephemeral_5m_input_tokens":165,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWuP2NxXhM87NAjTyk4ET","type":"assistant","uuid":"9aae2595-97d5-4434-ab55-aaf61db420f0","timestamp":"2026-01-08T05:45:02.587Z"}
{"parentUuid":"9aae2595-97d5-4434-ab55-aaf61db420f0","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01BgReF4uV1Jd54ndjnMYJyB","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01B2m2yuavrnJXAGkjP65RFP","name":"Read","input":{"file_path":"/mnt/c/Users/o.young/work/architecture/architectural_approach.adoc"}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":165,"cache_read_input_tokens":32515,"cache_creation":{"ephemeral_5m_input_tokens":165,"ephemeral_1h_input_tokens":0},"output_tokens":92,"service_tier":"standard"}},"requestId":"req_011CWuP2NxXhM87NAjTyk4ET","type":"assistant","uuid":"bfae291b-3fca-4a57-b557-290bc534297a","timestamp":"2026-01-08T05:45:02.990Z"}
{"parentUuid":"bfae291b-3fca-4a57-b557-290bc534297a","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01B2m2yuavrnJXAGkjP65RFP","type":"tool_result","content":"     1→==== Strategic Architectural Philosophy\n     2→\n     3→This solution architecture establishes the **foundational implementation** of OTR's target Domain-Driven Design (DDD) architecture. The design choices reflect three core principles:\n     4→\n     5→1. **Protect digital channels from external system coupling** - Use Anti-Corruption Layers (ACLs) to isolate OTR's domain model from external systems we don't control (Salesforce, Braze, EagleEye)\n     6→2. **Establish event-driven architecture as the integration standard** - Loose coupling between bounded contexts via domain events, enabling independent evolution\n     7→3. **Prioritise simplicity and time-to-value** - Make pragmatic trade-offs that reduce complexity while establishing architectural patterns for future work\n     8→\n     9→==== Why Domain-Driven Design with Bounded Contexts?\n    10→\n    11→The decision to implement **ProfileService** and **EngagementService** as separate bounded contexts rather than direct Mobile App → Salesforce integration reflects a strategic investment in architectural quality:\n    12→\n    13→*The Problem with Direct Integration*:\n    14→\n    15→* Mobile App tightly coupled to Salesforce API (any Salesforce change breaks Mobile App)\n    16→* Viva Energy controls the shared Salesforce instance - we conform to their governance and configuration\n    17→* Future integrations (Flybuys, LocationService, PaymentService) would duplicate Contact reconciliation logic\n    18→* No domain event publishing - other services can't react to customer feedback\n    19→\n    20→*The DDD Solution*:\n    21→\n    22→* **ProfileService** handles Contact reconciliation - reusable for Flybuys partner linking, future bounded contexts\n    23→* **EngagementService** acts as Anti-Corruption Layer - translates between OTR domain language (customer feedback categories: App, Service, Order, Rewards, Refund, Delete Account) and Salesforce (Case object with Viva Energy-specific configuration)\n    24→* **Event Bus** publishes domain events (`CustomerFeedbackSubmitted`, `SupportCaseCreated`) - other bounded contexts can react without coupling\n    25→* **Clear boundaries** - ProfileService handles identity, EngagementService handles support/feedback (different responsibilities, different change rates)\n    26→\n    27→*The Trade-Off*:\n    28→\n    29→We accept **increased initial complexity** (two new microservices, Event Bus infrastructure, team learning DDD patterns) in exchange for **architectural foundation** that protects digital channels from external system changes and enables reusable components for future work (Flybuys, subscriptions, recommendations).\n    30→\n    31→This is a **strategic investment** - we're not just solving customer support consolidation, we're establishing the architectural pattern for all future bounded contexts.\n    32→\n    33→==== Why Async Processing Instead of Synchronous API Calls?\n    34→\n    35→The decision to create Salesforce Cases **asynchronously via Event Bus** (ADR-CS-003) rather than synchronously in the API request path reflects a prioritisation of user experience and resilience over simplicity:\n    36→\n    37→*The Problem with Synchronous Integration*:\n    38→\n    39→* User waits for Salesforce API response (latency: Mobile App → EngagementService → Salesforce → EngagementService → Mobile App)\n    40→* If Salesforce is down or slow, customer feedback submission fails\n    41→* No automatic retry - customer must resubmit feedback\n    42→* API timeout must accommodate worst-case Salesforce latency\n    43→\n    44→*The Async Solution*:\n    45→\n    46→* **Immediate acknowledgment** - User gets \"Feedback submitted\" confirmation in <200ms (no Salesforce wait)\n    47→* **Resilience** - If Salesforce is down, feedback queued, Case created when Salesforce recovers\n    48→* **Automatic retry** - Exponential backoff handles transient Salesforce API failures\n    49→* **Operational visibility** - Dead letter queue alerts ops team to persistent failures\n    50→* **Scalability** - Queue buffering handles traffic spikes (expected 100-150 submissions/day, capacity for 10x)\n    51→\n    52→*The Trade-Off*:\n    53→\n    54→We accept **eventual consistency** (user receives push notification after Case created, not immediately) and **increased complexity** (Event Bus, background workers, retry logic, DLQ monitoring) in exchange for **better user experience** (no waiting) and **resilience** (Salesforce downtime doesn't block customer feedback).\n    55→\n    56→This trade-off is acceptable because customer support feedback is **not a real-time transaction** (unlike payment processing). A 30-second delay between feedback submission and Case creation is invisible to the customer, who receives a push notification when the Case is created.\n    57→\n    58→==== Why Conformist Pattern for Salesforce?\n    59→\n    60→The decision to **conform to Salesforce configuration** (ADR-CS-015) rather than heavily customise Salesforce or abstract away its API reflects a pragmatic acceptance of organisational reality:\n    61→\n    62→*The Organisational Context*:\n    63→\n    64→* **Shared Salesforce instance** - Viva Energy owns and operates the Salesforce Service Cloud instance\n    65→* **Multi-tenant governance** - OTR is one business unit among many (fuel wholesale, Shell Card, other retail channels)\n    66→* **Viva Energy controls roadmap** - We don't control Salesforce configuration, custom fields, or API evolution\n    67→* **Post-merger integration** - Strategic decision to standardize on Viva Energy platforms (not build parallel systems)\n    68→\n    69→*The Conformist Approach*:\n    70→\n    71→* **Accept their data model** - Use standard Contact and Case objects with Viva Energy-configured fields\n    72→* **Conform to their API** - Use Salesforce REST API as-is, minimal custom Apex code\n    73→* **Work within their governance** - Data isolation via Record Types/queues (TBD with Salesforce admin team)\n    74→* **Anti-Corruption Layer protects us** - EngagementService translates between OTR domain language and Salesforce, but doesn't fight Salesforce's model\n    75→\n    76→*Why Not Heavily Customise Salesforce?*:\n    77→\n    78→* **Governance constraints** - Viva Energy Salesforce team must approve all customisations (slow, requires business case)\n    79→* **Shared instance risk** - Custom Apex code or triggers could impact other business units (change control overhead)\n    80→* **Upgrade risk** - Heavy customisation increases Salesforce upgrade complexity\n    81→* **Not our system** - We don't control the platform, so we shouldn't over-invest in customisation we can't maintain\n    82→\n    83→*The Trade-Off*:\n    84→\n    85→We accept **less control over data model and platform evolution** in exchange for **faster time-to-value** (no custom development in Salesforce), **reduced operational overhead** (no custom code to maintain), and **organisational alignment** (consolidate onto shared Viva Energy platforms).\n    86→\n    87→The **Anti-Corruption Layer** (EngagementService) is the protection mechanism - it translates between OTR's domain language and Salesforce, so if Salesforce changes, we update the ACL, not the Mobile App.\n    88→\n    89→==== Why Big Bang Cutover Instead of Phased Rollout?\n    90→\n    91→The decision to use **big bang cutover** (ADR-CS-006) rather than phased rollout with feature flags (like the Flybuys integration uses) reflects a risk assessment based on criticality and complexity:\n    92→\n    93→*Why Flybuys Uses Phased Rollout (AS-1, AS-2, AS-3)*:\n    94→\n    95→* **High complexity** - Flybuys points accrual involves transaction adjudication, partner API integration, reconciliation\n    96→* **Mission-critical** - Points accrual errors directly impact customer value and partner agreements\n    97→* **Large user base** - All OTR loyalty members (gradual enablement reduces blast radius)\n    98→* **Reversibility challenge** - Once points awarded to Flybuys, reversal requires partner coordination\n    99→\n   100→*Why Customer Support Uses Big Bang*:\n   101→\n   102→* **Lower complexity** - Feedback submission is create-only operation (no complex state management)\n   103→* **Not mission-critical** - Support feedback failure doesn't prevent app usage or transactions\n   104→* **Manageable user base** - OTR digital customers smaller than total loyalty member base\n   105→* **Easy rollback** - Can revert to D365 CE if critical issues (no partner coordination required)\n   106→* **Faster D365 CE retirement** - No extended transition period maintaining two systems\n   107→\n   108→*The Trade-Off*:\n   109→\n   110→We accept **higher cutover risk** (all users switch at once) in exchange for **simplicity** (no feature flag management), **faster D365 CE retirement** (no parallel run period), and **reduced transition complexity** (no AS-1/AS-2/AS-3 architecture states).\n   111→\n   112→The risk is mitigated by:\n   113→\n   114→* **Comprehensive testing** - Load testing (3x-10x expected volume), integration testing, UAT\n   115→* **Rollback plan** - Can revert Mobile App to D365 CE if critical issues within 48 hours\n   116→* **Non-critical workload** - Support feedback failure doesn't block core app functionality\n   117→\n   118→This is a **pragmatic trade-off** - we use the simplest migration strategy that matches the risk profile of the workload.\n   119→\n   120→==== Why No Case Migration from D365 CE?\n   121→\n   122→The decision to **not migrate historical Cases** (ADR-CS-005) reflects a cost-benefit analysis that prioritises speed and simplicity over historical data preservation:\n   123→\n   124→*The Case for Migration*:\n   125→\n   126→* Support agents could see historical customer support Cases in Salesforce\n   127→* Continuity of support history for repeat issues\n   128→* Analytics and reporting on historical Case trends\n   129→\n   130→*The Case Against Migration*:\n   131→\n   132→* **Limited value** - Historical D365 CE Cases not critical for future support (new Cases moving forward)\n   133→* **Data quality concerns** - D365 CE Case data may be inconsistent, incomplete, or poorly categorised\n   134→* **Migration complexity** - Requires mapping D365 CE schema to Salesforce, data transformation, validation, testing\n   135→* **Delays cutover** - Case migration extends timeline (Contact migration only is faster)\n   136→* **Cost-benefit** - Migration effort (4-6 weeks) outweighs value of historical data\n   137→\n   138→*The Alternative*:\n   139→\n   140→If historical Cases are needed, D365 CE can remain accessible (read-only) temporarily for lookups, or Cases can be archived separately.\n   141→\n   142→*The Trade-Off*:\n   143→\n   144→We accept **loss of historical Case visibility in Salesforce** in exchange for **faster time-to-value** (Contact migration only), **simpler migration** (no Case schema mapping), and **clean start** (no legacy data quality issues).\n   145→\n   146→This is a **pragmatic simplification** - historical support Cases provide marginal value compared to the migration effort required.\n   147→\n   148→==== Why Email as Primary Matching Key (Not VCI)?\n   149→\n   150→The decision to use **email as the primary Contact matching key** (ADR-CS-004) rather than Viva Consumer ID (VCI) reflects a pragmatic choice based on current system capabilities:\n   151→\n   152→*Why Not VCI?*:\n   153→\n   154→* **Not in Salesforce today** - VCI is not currently stored as Salesforce External ID (requires Salesforce admin team to add field and configure upsert)\n   155→* **Adds coordination overhead** - Requires Viva Energy Salesforce team approval, field creation, indexing, testing\n   156→* **Delays cutover** - Email-based matching can start immediately, VCI matching requires Salesforce configuration work\n   157→\n   158→*Why Email Works*:\n   159→\n   160→* **Available now** - Salesforce Contact already has email field (standard, indexed)\n   161→* **Unique identifier** - Email is unique in both Salesforce and Mobile App authentication\n   162→* **Always available** - Authenticated users always have email from Entra ID JWT\n   163→* **Salesforce standard** - Email is standard Contact lookup field (no custom configuration)\n   164→\n   165→*The Edge Case*:\n   166→\n   167→* **Email change** - If customer changes email, creates duplicate Contact (rare, manual cleanup acceptable)\n   168→\n   169→*Future Enhancement*:\n   170→\n   171→* Add VCI as Salesforce External ID (more stable matching)\n   172→* Migrate to VCI-based matching once Salesforce configuration is complete\n   173→\n   174→*The Trade-Off*:\n   175→\n   176→We accept **rare duplicate Contact creation** (when customers change email) in exchange for **immediate implementation** (no Salesforce configuration required) and **simplicity** (single matching key).\n   177→\n   178→This is a **pragmatic starting point** - we can enhance to VCI-based matching later without breaking existing functionality.\n   179→\n   180→==== How the Decisions Reinforce Each Other\n   181→\n   182→The architectural decisions form a **coherent strategy** rather than isolated choices:\n   183→\n   184→1. **DDD Bounded Contexts** (ADR-CS-002) establish the foundation for **Event-Driven Architecture** (ADR-CS-003) - ProfileService and EngagementService publish domain events that other bounded contexts consume\n   185→2. **Async Processing** (ADR-CS-003) enables **Resilience to Salesforce Downtime** - the Event Bus buffers work when Salesforce is unavailable\n   186→3. **Conformist Pattern** (ADR-CS-015) is protected by **Anti-Corruption Layer** - EngagementService conforms to Salesforce but isolates the Mobile App from Salesforce API changes\n   187→4. **Big Bang Cutover** (ADR-CS-006) is feasible because **Customer Support is Non-Critical** - unlike payment processing or Flybuys points accrual, support feedback failure doesn't block core app functionality\n   188→5. **No Case Migration** (ADR-CS-005) simplifies the **Big Bang Cutover** - Contact migration only is faster and lower risk\n   189→6. **Email Matching** (ADR-CS-004) enables **Immediate Implementation** - no waiting for Salesforce admin team to configure VCI External ID\n   190→\n   191→The decisions are **mutually reinforcing** - each choice makes the others more valuable or feasible.\n   192→\n   193→==== What This Establishes for Future Work\n   194→\n   195→This implementation is the **architectural foundation** for OTR's target state:\n   196→\n   197→* **First bounded contexts** - ProfileService and EngagementService establish the pattern for LoyaltyService, PaymentService, LocationService, RecommendationService\n   198→* **First event-driven integration** - Event Bus pattern reused for all future bounded context integration (not direct API calls)\n   199→* **Reusable Contact reconciliation** - ProfileService Contact lookup reused for Flybuys partner linking, subscription billing, personalised recommendations\n   200→* **Anti-Corruption Layer pattern** - EngagementService ACL demonstrates how to protect OTR domain model from external systems (EagleEye, Braze, D365 Commerce)\n   201→* **Conformist pattern for shared systems** - Establishes approach for systems we don't control (Salesforce, Entra ID, Microsoft Fabric)\n   202→\n   203→Every design decision is made with **future bounded contexts in mind** - we're not just solving customer support, we're establishing the architectural standards for all future work.\n   204→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"67ad4b28-8efc-487f-92c5-0ae59b474114","timestamp":"2026-01-08T05:45:03.202Z","toolUseResult":{"type":"text","file":{"filePath":"/mnt/c/Users/o.young/work/architecture/architectural_approach.adoc","content":"==== Strategic Architectural Philosophy\n\nThis solution architecture establishes the **foundational implementation** of OTR's target Domain-Driven Design (DDD) architecture. The design choices reflect three core principles:\n\n1. **Protect digital channels from external system coupling** - Use Anti-Corruption Layers (ACLs) to isolate OTR's domain model from external systems we don't control (Salesforce, Braze, EagleEye)\n2. **Establish event-driven architecture as the integration standard** - Loose coupling between bounded contexts via domain events, enabling independent evolution\n3. **Prioritise simplicity and time-to-value** - Make pragmatic trade-offs that reduce complexity while establishing architectural patterns for future work\n\n==== Why Domain-Driven Design with Bounded Contexts?\n\nThe decision to implement **ProfileService** and **EngagementService** as separate bounded contexts rather than direct Mobile App → Salesforce integration reflects a strategic investment in architectural quality:\n\n*The Problem with Direct Integration*:\n\n* Mobile App tightly coupled to Salesforce API (any Salesforce change breaks Mobile App)\n* Viva Energy controls the shared Salesforce instance - we conform to their governance and configuration\n* Future integrations (Flybuys, LocationService, PaymentService) would duplicate Contact reconciliation logic\n* No domain event publishing - other services can't react to customer feedback\n\n*The DDD Solution*:\n\n* **ProfileService** handles Contact reconciliation - reusable for Flybuys partner linking, future bounded contexts\n* **EngagementService** acts as Anti-Corruption Layer - translates between OTR domain language (customer feedback categories: App, Service, Order, Rewards, Refund, Delete Account) and Salesforce (Case object with Viva Energy-specific configuration)\n* **Event Bus** publishes domain events (`CustomerFeedbackSubmitted`, `SupportCaseCreated`) - other bounded contexts can react without coupling\n* **Clear boundaries** - ProfileService handles identity, EngagementService handles support/feedback (different responsibilities, different change rates)\n\n*The Trade-Off*:\n\nWe accept **increased initial complexity** (two new microservices, Event Bus infrastructure, team learning DDD patterns) in exchange for **architectural foundation** that protects digital channels from external system changes and enables reusable components for future work (Flybuys, subscriptions, recommendations).\n\nThis is a **strategic investment** - we're not just solving customer support consolidation, we're establishing the architectural pattern for all future bounded contexts.\n\n==== Why Async Processing Instead of Synchronous API Calls?\n\nThe decision to create Salesforce Cases **asynchronously via Event Bus** (ADR-CS-003) rather than synchronously in the API request path reflects a prioritisation of user experience and resilience over simplicity:\n\n*The Problem with Synchronous Integration*:\n\n* User waits for Salesforce API response (latency: Mobile App → EngagementService → Salesforce → EngagementService → Mobile App)\n* If Salesforce is down or slow, customer feedback submission fails\n* No automatic retry - customer must resubmit feedback\n* API timeout must accommodate worst-case Salesforce latency\n\n*The Async Solution*:\n\n* **Immediate acknowledgment** - User gets \"Feedback submitted\" confirmation in <200ms (no Salesforce wait)\n* **Resilience** - If Salesforce is down, feedback queued, Case created when Salesforce recovers\n* **Automatic retry** - Exponential backoff handles transient Salesforce API failures\n* **Operational visibility** - Dead letter queue alerts ops team to persistent failures\n* **Scalability** - Queue buffering handles traffic spikes (expected 100-150 submissions/day, capacity for 10x)\n\n*The Trade-Off*:\n\nWe accept **eventual consistency** (user receives push notification after Case created, not immediately) and **increased complexity** (Event Bus, background workers, retry logic, DLQ monitoring) in exchange for **better user experience** (no waiting) and **resilience** (Salesforce downtime doesn't block customer feedback).\n\nThis trade-off is acceptable because customer support feedback is **not a real-time transaction** (unlike payment processing). A 30-second delay between feedback submission and Case creation is invisible to the customer, who receives a push notification when the Case is created.\n\n==== Why Conformist Pattern for Salesforce?\n\nThe decision to **conform to Salesforce configuration** (ADR-CS-015) rather than heavily customise Salesforce or abstract away its API reflects a pragmatic acceptance of organisational reality:\n\n*The Organisational Context*:\n\n* **Shared Salesforce instance** - Viva Energy owns and operates the Salesforce Service Cloud instance\n* **Multi-tenant governance** - OTR is one business unit among many (fuel wholesale, Shell Card, other retail channels)\n* **Viva Energy controls roadmap** - We don't control Salesforce configuration, custom fields, or API evolution\n* **Post-merger integration** - Strategic decision to standardize on Viva Energy platforms (not build parallel systems)\n\n*The Conformist Approach*:\n\n* **Accept their data model** - Use standard Contact and Case objects with Viva Energy-configured fields\n* **Conform to their API** - Use Salesforce REST API as-is, minimal custom Apex code\n* **Work within their governance** - Data isolation via Record Types/queues (TBD with Salesforce admin team)\n* **Anti-Corruption Layer protects us** - EngagementService translates between OTR domain language and Salesforce, but doesn't fight Salesforce's model\n\n*Why Not Heavily Customise Salesforce?*:\n\n* **Governance constraints** - Viva Energy Salesforce team must approve all customisations (slow, requires business case)\n* **Shared instance risk** - Custom Apex code or triggers could impact other business units (change control overhead)\n* **Upgrade risk** - Heavy customisation increases Salesforce upgrade complexity\n* **Not our system** - We don't control the platform, so we shouldn't over-invest in customisation we can't maintain\n\n*The Trade-Off*:\n\nWe accept **less control over data model and platform evolution** in exchange for **faster time-to-value** (no custom development in Salesforce), **reduced operational overhead** (no custom code to maintain), and **organisational alignment** (consolidate onto shared Viva Energy platforms).\n\nThe **Anti-Corruption Layer** (EngagementService) is the protection mechanism - it translates between OTR's domain language and Salesforce, so if Salesforce changes, we update the ACL, not the Mobile App.\n\n==== Why Big Bang Cutover Instead of Phased Rollout?\n\nThe decision to use **big bang cutover** (ADR-CS-006) rather than phased rollout with feature flags (like the Flybuys integration uses) reflects a risk assessment based on criticality and complexity:\n\n*Why Flybuys Uses Phased Rollout (AS-1, AS-2, AS-3)*:\n\n* **High complexity** - Flybuys points accrual involves transaction adjudication, partner API integration, reconciliation\n* **Mission-critical** - Points accrual errors directly impact customer value and partner agreements\n* **Large user base** - All OTR loyalty members (gradual enablement reduces blast radius)\n* **Reversibility challenge** - Once points awarded to Flybuys, reversal requires partner coordination\n\n*Why Customer Support Uses Big Bang*:\n\n* **Lower complexity** - Feedback submission is create-only operation (no complex state management)\n* **Not mission-critical** - Support feedback failure doesn't prevent app usage or transactions\n* **Manageable user base** - OTR digital customers smaller than total loyalty member base\n* **Easy rollback** - Can revert to D365 CE if critical issues (no partner coordination required)\n* **Faster D365 CE retirement** - No extended transition period maintaining two systems\n\n*The Trade-Off*:\n\nWe accept **higher cutover risk** (all users switch at once) in exchange for **simplicity** (no feature flag management), **faster D365 CE retirement** (no parallel run period), and **reduced transition complexity** (no AS-1/AS-2/AS-3 architecture states).\n\nThe risk is mitigated by:\n\n* **Comprehensive testing** - Load testing (3x-10x expected volume), integration testing, UAT\n* **Rollback plan** - Can revert Mobile App to D365 CE if critical issues within 48 hours\n* **Non-critical workload** - Support feedback failure doesn't block core app functionality\n\nThis is a **pragmatic trade-off** - we use the simplest migration strategy that matches the risk profile of the workload.\n\n==== Why No Case Migration from D365 CE?\n\nThe decision to **not migrate historical Cases** (ADR-CS-005) reflects a cost-benefit analysis that prioritises speed and simplicity over historical data preservation:\n\n*The Case for Migration*:\n\n* Support agents could see historical customer support Cases in Salesforce\n* Continuity of support history for repeat issues\n* Analytics and reporting on historical Case trends\n\n*The Case Against Migration*:\n\n* **Limited value** - Historical D365 CE Cases not critical for future support (new Cases moving forward)\n* **Data quality concerns** - D365 CE Case data may be inconsistent, incomplete, or poorly categorised\n* **Migration complexity** - Requires mapping D365 CE schema to Salesforce, data transformation, validation, testing\n* **Delays cutover** - Case migration extends timeline (Contact migration only is faster)\n* **Cost-benefit** - Migration effort (4-6 weeks) outweighs value of historical data\n\n*The Alternative*:\n\nIf historical Cases are needed, D365 CE can remain accessible (read-only) temporarily for lookups, or Cases can be archived separately.\n\n*The Trade-Off*:\n\nWe accept **loss of historical Case visibility in Salesforce** in exchange for **faster time-to-value** (Contact migration only), **simpler migration** (no Case schema mapping), and **clean start** (no legacy data quality issues).\n\nThis is a **pragmatic simplification** - historical support Cases provide marginal value compared to the migration effort required.\n\n==== Why Email as Primary Matching Key (Not VCI)?\n\nThe decision to use **email as the primary Contact matching key** (ADR-CS-004) rather than Viva Consumer ID (VCI) reflects a pragmatic choice based on current system capabilities:\n\n*Why Not VCI?*:\n\n* **Not in Salesforce today** - VCI is not currently stored as Salesforce External ID (requires Salesforce admin team to add field and configure upsert)\n* **Adds coordination overhead** - Requires Viva Energy Salesforce team approval, field creation, indexing, testing\n* **Delays cutover** - Email-based matching can start immediately, VCI matching requires Salesforce configuration work\n\n*Why Email Works*:\n\n* **Available now** - Salesforce Contact already has email field (standard, indexed)\n* **Unique identifier** - Email is unique in both Salesforce and Mobile App authentication\n* **Always available** - Authenticated users always have email from Entra ID JWT\n* **Salesforce standard** - Email is standard Contact lookup field (no custom configuration)\n\n*The Edge Case*:\n\n* **Email change** - If customer changes email, creates duplicate Contact (rare, manual cleanup acceptable)\n\n*Future Enhancement*:\n\n* Add VCI as Salesforce External ID (more stable matching)\n* Migrate to VCI-based matching once Salesforce configuration is complete\n\n*The Trade-Off*:\n\nWe accept **rare duplicate Contact creation** (when customers change email) in exchange for **immediate implementation** (no Salesforce configuration required) and **simplicity** (single matching key).\n\nThis is a **pragmatic starting point** - we can enhance to VCI-based matching later without breaking existing functionality.\n\n==== How the Decisions Reinforce Each Other\n\nThe architectural decisions form a **coherent strategy** rather than isolated choices:\n\n1. **DDD Bounded Contexts** (ADR-CS-002) establish the foundation for **Event-Driven Architecture** (ADR-CS-003) - ProfileService and EngagementService publish domain events that other bounded contexts consume\n2. **Async Processing** (ADR-CS-003) enables **Resilience to Salesforce Downtime** - the Event Bus buffers work when Salesforce is unavailable\n3. **Conformist Pattern** (ADR-CS-015) is protected by **Anti-Corruption Layer** - EngagementService conforms to Salesforce but isolates the Mobile App from Salesforce API changes\n4. **Big Bang Cutover** (ADR-CS-006) is feasible because **Customer Support is Non-Critical** - unlike payment processing or Flybuys points accrual, support feedback failure doesn't block core app functionality\n5. **No Case Migration** (ADR-CS-005) simplifies the **Big Bang Cutover** - Contact migration only is faster and lower risk\n6. **Email Matching** (ADR-CS-004) enables **Immediate Implementation** - no waiting for Salesforce admin team to configure VCI External ID\n\nThe decisions are **mutually reinforcing** - each choice makes the others more valuable or feasible.\n\n==== What This Establishes for Future Work\n\nThis implementation is the **architectural foundation** for OTR's target state:\n\n* **First bounded contexts** - ProfileService and EngagementService establish the pattern for LoyaltyService, PaymentService, LocationService, RecommendationService\n* **First event-driven integration** - Event Bus pattern reused for all future bounded context integration (not direct API calls)\n* **Reusable Contact reconciliation** - ProfileService Contact lookup reused for Flybuys partner linking, subscription billing, personalised recommendations\n* **Anti-Corruption Layer pattern** - EngagementService ACL demonstrates how to protect OTR domain model from external systems (EagleEye, Braze, D365 Commerce)\n* **Conformist pattern for shared systems** - Establishes approach for systems we don't control (Salesforce, Entra ID, Microsoft Fabric)\n\nEvery design decision is made with **future bounded contexts in mind** - we're not just solving customer support, we're establishing the architectural standards for all future work.\n","numLines":204,"startLine":1,"totalLines":204}},"sourceToolAssistantUUID":"bfae291b-3fca-4a57-b557-290bc534297a"}
{"parentUuid":"67ad4b28-8efc-487f-92c5-0ae59b474114","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01P2rR4PGQE1AU1nSZb26Uyw","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now I can see the file. It's heavily focused on the Salesforce Customer Support project with specific references to:\n- ProfileService and EngagementService as examples\n- Salesforce-specific decisions (conformist pattern, email matching, no case migration)\n- Customer support/feedback specific scenarios\n- D365 CE migration\n- Comparisons with Flybuys integration\n\nThe user wants this to be more generic and less Salesforce-specific. I should:\n\n1. Keep the general DDD/architectural principles\n2. Make examples more abstract or provide multiple examples\n3. Remove Salesforce-specific details or make them just one example among many\n4. Make the principles applicable to any solution architecture\n5. Focus on the strategic architectural philosophy that can apply to multiple projects\n\nLet me think about how to restructure this:\n\n**Section 1: Strategic Architectural Philosophy** - This is already fairly generic, but mentions specific systems. I can make it more abstract.\n\n**Section 2: Why DDD with Bounded Contexts?** - Very Salesforce/ProfileService/EngagementService specific. Need to generalize the principles.\n\n**Section 3: Why Async vs Sync?** - Salesforce Case creation specific. Can generalize to \"external system integration\"\n\n**Section 4: Why Conformist Pattern?** - Salesforce-specific. Can generalize to \"shared platforms we don't control\"\n\n**Section 5: Why Big Bang vs Phased?** - Compares Salesforce (big bang) to Flybuys (phased). Can make this more about when to choose each approach.\n\n**Section 6: Why No Data Migration?** - D365 CE Case migration specific. Can generalize to \"historical data migration decisions\"\n\n**Section 7: Why Email as Matching Key?** - Salesforce Contact matching specific. Can generalize to \"choosing identifier strategies\"\n\n**Section 8: How Decisions Reinforce Each Other** - References specific ADRs. Can make more generic.\n\n\n**Section 9: What This Establishes** - Mentions specific bounded contexts but is already somewhat generic.\n\nI'll transform this into a universal architectural guidance framework that demonstrates strategic design principles across multiple domains. The goal is to create a flexible template that can be adapted to various complex system integration scenarios, highlighting how architectural decisions interconnect and support overall system design. By presenting multiple industry examples, we can show how these principles transcend specific technology implementations and provide a robust approach to solving complex architectural challenges.","signature":"EpsSCkYICxgCKkAKVbfr0vFevOQIFD1k89FPnztvt97/KT5ZyBYb+hW3aVK591My0iak2ZQAgV9V6CupjtStMyNLqpODu28pZwxEEgxqQuq5qoSgKyni9TEaDPUTJn9aNyrwytOvwSIwtb9dXQUtKMDGgKO1d2ysZGAF9pHRqFAB0dMg/PrYbNXumMvSP5oxPwBIy8UGrqJvKoIR+a/uzCNcdG+QJIkxmNPz9vogcJb2mkdN8tEavFICRqNG0KW6yRPRY3+WjcJJtvTYbkLph95ixtgyrAvd4aYQ60nPsodxfEvkceGkJF9ri+kGWcQAj4NaAl8y61N3S+/Fn3jFtAnup41v5/0DpqA8oAIg4zCSFsnpu3j8tPWe91CHDTpLoXpyyy38hkKZn3x9Sg6019kuvntRqLlK/e/IbBDNW/acBunwO+t/Wdo4MIYzyzC3+vubupG5z5pQRED3e9c/VjTNVir31Fzhy2pVVO81Rkb0k7RHGMshD15hVKWs0h9TobvFYbDT1pPGsrDBKaG8iArXGQAA1mXViPQ6XuLt6rYf/Ak0sud5E0kYe9ooiWvDbj81HksEnCO3fzJj1xzgfRCVFm7NDaXxJ2xq+f3yYVbHat75qjxSsqMT9SaX0UBarU8VuVjtwwfbvK0+Dy9jr9M86lhVYy1fd8clmijn6meP6VdRY2mielkJ+7uQKmmSBxafvRCixgmFCA2a7CHB2l5y7KfLmBnj+6uyzozaVz9s3JH8qWvk4ewlkh+5UG1E5QhrfMKKEbw8OSuRHK23L7yUsIC0krUyQAQhF5mPJjPos74cEUFCL7hR+SI4DAW+J9iPPPuN3Jj+a7pvXbeVXJ+XC+Fn80GaIKH3bCS7truF//L96l5cNkYteRPuf3T1gLQkKCoGaqz57rBufAuu7DpMRsn3G/4/NaUaVUR8R2o6+cKBKhAknpW9E3b36tnS/io3gQ6yfIhzNA1PSL4HiuNfOVg08MqkZWdz4L6Xjrf24eiHhN5drda0lB4CZ8t7IAjsgZxCctTebbbgm1SorKiYPlCgtC1s/oEOX2uPR1W3JAm0Q/9/n1rNtlIDOMWuepYkXchdTrKPqd19YJCwUDMyXKwKFTMEPSrxfPC837gllKXUoFLwgBH1agtjav8BB+IWJcMV+GH0f4V6s+g+iKWfoEZ05wcY1aT9DpnIHba0Muq8TqiV/FsA3xoBSLXxmJdLRYKrc4TrnDN3Os0uRXTGaSYvxzVDvjQaMovf9qp+WgRKo7E56kPK+c2xrLqzcg8CKhgsBbyl2WDtLZwNXiU8M8LwD2uvcYQWFMBFo4Kyzwnr0A65X1DheGLme1Kki8bPshrUXv8wph+15p2VMxhpxbvw+cWdUyRMOChJ/byA1JtatByeCP3y7Ydcfsytsm3UpH2hk5wFc5r7vp/dmrjIiB9V331AfB3u3LKCdfOh6hCp+g7hH+N8oEvWyWKiKY+ydiZcKbjC6sC2ArYekok7RhtwGiOA2jy71s8WqvZcR0Rzh6oFAGqfEWZbKQ3jR/YsAIG+5uV5UT0NVpK9xcOZ8J+576fOsMT1EOeFEEflCgIoeDCEa1PmrbprWtFyZynCPsbQCYdXpuxkKtAQdiqJPJeHMDuiJ7Ad3jIbtpfGgjIVogDEolUKvkQNSl7BVnlTnODahor0cXiIfDsXfdL2wE2Ubsy+mDEkINGMmErhhFsivemadqjU3CVyd/wIzkMHywW6YAoTgewHDVynw2jwBdRdrrIjYW3LlHGsdluuGWFjAMBIUKZ5pSO2Mjxohn8V0L0m4qvsr2VaOX+UwKvxbUyT+ljDzCYy5T2vTat6NzG8dPahhiZgjoIYCI07CCcgmsgNZx8vtamGdnz/Gih+bbwzqB2htdzfjVND9Ri7+YwxXxZ0C13pKDhxiJlA3UCoxD7n0ytJmzuA5WEVc7glpZG1skbrv2plB4ZXoiOuE0FlHMy3HBi9rI6PM+PxLo+bik4CbVH+B+hyE80dcr6Uu7mFEm0w4ziBUAhW1NwrAK/autftI9lvmJeJbf9Y8lqN18DZGB0UtRcDVIh/pv5x+P5BzeKF4Yz4t2o7n87Kx6QtDShi4+9MEQwwal+oSTm/UAn22+RJVoGa87hP3Cb1nmjBpfdmmLbp15hCzhpea/cHeZrhYyHdUuxF7zVX/8rTaY3vqxjOvqhTb4q4qmvqPoG9fckJpEsy5yPku3ZsH4FGpSOMCSm7N2F5IpsThBkZ1bw0CKMVnCZE1L3+/LlIuhE53ASoAsBGqzY4/4zyZnZjJHpik77nWE/XzTQmYa1ur5cR3B9n+IeKZz4A7lXl17MBBBLlhBPPxkoklkhK2lluBWlmGDN582frbf5TA6OFlNXB1R+KkNwaik3ulH83fnhn5/jUdU55WeMcZ/7im2/2JGpmdIMwePHHWq/MdcFDNgEHTOTIINGAjpoUHWquUBQ7eOuo/xHy//v/bWLjQVIvAadfYeBOJrGNBkciyExch/6/+SjR2/u3IOJ+fYQy8PhscMVPcuwTLsnPu6R+7N5d89BEzrLAnAfJ4XY4M85oOB+Tnc9WfzeR9+FdFUZmxRyg5cZEXqgNgxin76A2Ebn+oY+V8SoVvTgxXzY0gQOjm9yjiFjGIg4USJgQEfHaUTYvYphWtdWMuj3riyDFCoMW8TFkge6tCbPZHJyrUYUU9Lo884F7JOv8JNWjUJuRkojRjhXE1498Drw+jCtVNjvZgMaplNYTsGvLQbuIJEgQNk0Pp9F5c7RYY1YIXgjtwgL7V18AoqP/xgSk7uVVuKDeEatDXpdAvxB4wpUqznT4Arsk5NCuH/mvEPWuIWWpdiQePskL64vdywvUvEbQxiQxrTfE5vxULmfHldpaXusyroAPQg40ibVDBkuruLDjtWaWzkph6Dy/q/JwcyKCZhdI3FOr53C2vGzi9Y6NHTRlLwk1H1xKj69M2M8F74ilQGe31RobYJLITAme4sn2oKOode1zK3DgA+LZWuNJntYSND4RO2J1AMqe5UF+VHcdLXe37D1uh6UQAVe+7N6HyTAulEMpKqwRvwAEFuoUVxpwa4E0CmgA5526g/IVt1VrmyVYD7Al5M/+HkYMGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":4178,"cache_read_input_tokens":32680,"cache_creation":{"ephemeral_5m_input_tokens":4178,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CWuP2gxW4tK6cszADu6Ca","type":"assistant","uuid":"a3fd4076-600b-419b-8a33-399977b322bd","timestamp":"2026-01-08T05:45:20.897Z"}
{"parentUuid":"a3fd4076-600b-419b-8a33-399977b322bd","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01P2rR4PGQE1AU1nSZb26Uyw","type":"message","role":"assistant","content":[{"type":"text","text":"I'll make the architectural_approach.adoc more generic so it can be used as a template for any solution architecture, rather than being specific to the Salesforce project."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":4178,"cache_read_input_tokens":32680,"cache_creation":{"ephemeral_5m_input_tokens":4178,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CWuP2gxW4tK6cszADu6Ca","type":"assistant","uuid":"9a1a655b-ff2d-485a-863d-ad67c670b05d","timestamp":"2026-01-08T05:45:20.956Z"}
{"parentUuid":"9a1a655b-ff2d-485a-863d-ad67c670b05d","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01P2rR4PGQE1AU1nSZb26Uyw","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Qav9fEmqKzubfdrawRs9ui","name":"Edit","input":{"replace_all":false,"file_path":"/mnt/c/Users/o.young/work/architecture/architectural_approach.adoc","old_string":"==== Strategic Architectural Philosophy\n\nThis solution architecture establishes the **foundational implementation** of OTR's target Domain-Driven Design (DDD) architecture. The design choices reflect three core principles:\n\n1. **Protect digital channels from external system coupling** - Use Anti-Corruption Layers (ACLs) to isolate OTR's domain model from external systems we don't control (Salesforce, Braze, EagleEye)\n2. **Establish event-driven architecture as the integration standard** - Loose coupling between bounded contexts via domain events, enabling independent evolution\n3. **Prioritise simplicity and time-to-value** - Make pragmatic trade-offs that reduce complexity while establishing architectural patterns for future work","new_string":"==== Strategic Architectural Philosophy\n\nThis solution architecture aligns with OTR's target Domain-Driven Design (DDD) architecture. The design choices reflect three core principles:\n\n1. **Protect digital channels from external system coupling** - Use Anti-Corruption Layers (ACLs) to isolate OTR's domain model from external systems we don't control\n2. **Establish event-driven architecture as the integration standard** - Loose coupling between bounded contexts via domain events, enabling independent evolution\n3. **Prioritise simplicity and time-to-value** - Make pragmatic trade-offs that reduce complexity while establishing architectural patterns for future work"}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":4178,"cache_read_input_tokens":32680,"cache_creation":{"ephemeral_5m_input_tokens":4178,"ephemeral_1h_input_tokens":0},"output_tokens":974,"service_tier":"standard"}},"requestId":"req_011CWuP2gxW4tK6cszADu6Ca","type":"assistant","uuid":"b6cc8710-476b-4507-bc0a-846e0c4a24d5","timestamp":"2026-01-08T05:45:23.966Z"}
{"type":"file-history-snapshot","messageId":"b6cc8710-476b-4507-bc0a-846e0c4a24d5","snapshot":{"messageId":"77d0e44f-5fa8-403e-97aa-173159bbacba","trackedFileBackups":{"solution_architectures/flybuys_integration.adoc":{"backupFileName":"63d414abe912008a@v2","version":2,"backupTime":"2026-01-08T05:44:49.416Z"},"architectural_approach.adoc":{"backupFileName":"06cdfdafe20b60d5@v1","version":1,"backupTime":"2026-01-08T05:45:24.202Z"}},"timestamp":"2026-01-08T05:44:49.355Z"},"isSnapshotUpdate":true}
{"parentUuid":"b6cc8710-476b-4507-bc0a-846e0c4a24d5","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Qav9fEmqKzubfdrawRs9ui","type":"tool_result","content":"The file /mnt/c/Users/o.young/work/architecture/architectural_approach.adoc has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n     1→==== Strategic Architectural Philosophy\n     2→\n     3→This solution architecture aligns with OTR's target Domain-Driven Design (DDD) architecture. The design choices reflect three core principles:\n     4→\n     5→1. **Protect digital channels from external system coupling** - Use Anti-Corruption Layers (ACLs) to isolate OTR's domain model from external systems we don't control\n     6→2. **Establish event-driven architecture as the integration standard** - Loose coupling between bounded contexts via domain events, enabling independent evolution\n     7→3. **Prioritise simplicity and time-to-value** - Make pragmatic trade-offs that reduce complexity while establishing architectural patterns for future work\n     8→\n     9→==== Why Domain-Driven Design with Bounded Contexts?\n    10→\n    11→The decision to implement **ProfileService** and **EngagementService** as separate bounded contexts rather than direct Mobile App → Salesforce integration reflects a strategic investment in architectural quality:"}]},"uuid":"7b1f2b7f-66d9-41c1-b285-ae9c5d31bbaf","timestamp":"2026-01-08T05:45:24.175Z","toolUseResult":{"filePath":"/mnt/c/Users/o.young/work/architecture/architectural_approach.adoc","oldString":"==== Strategic Architectural Philosophy\n\nThis solution architecture establishes the **foundational implementation** of OTR's target Domain-Driven Design (DDD) architecture. The design choices reflect three core principles:\n\n1. **Protect digital channels from external system coupling** - Use Anti-Corruption Layers (ACLs) to isolate OTR's domain model from external systems we don't control (Salesforce, Braze, EagleEye)\n2. **Establish event-driven architecture as the integration standard** - Loose coupling between bounded contexts via domain events, enabling independent evolution\n3. **Prioritise simplicity and time-to-value** - Make pragmatic trade-offs that reduce complexity while establishing architectural patterns for future work","newString":"==== Strategic Architectural Philosophy\n\nThis solution architecture aligns with OTR's target Domain-Driven Design (DDD) architecture. The design choices reflect three core principles:\n\n1. **Protect digital channels from external system coupling** - Use Anti-Corruption Layers (ACLs) to isolate OTR's domain model from external systems we don't control\n2. **Establish event-driven architecture as the integration standard** - Loose coupling between bounded contexts via domain events, enabling independent evolution\n3. **Prioritise simplicity and time-to-value** - Make pragmatic trade-offs that reduce complexity while establishing architectural patterns for future work","originalFile":"==== Strategic Architectural Philosophy\n\nThis solution architecture establishes the **foundational implementation** of OTR's target Domain-Driven Design (DDD) architecture. The design choices reflect three core principles:\n\n1. **Protect digital channels from external system coupling** - Use Anti-Corruption Layers (ACLs) to isolate OTR's domain model from external systems we don't control (Salesforce, Braze, EagleEye)\n2. **Establish event-driven architecture as the integration standard** - Loose coupling between bounded contexts via domain events, enabling independent evolution\n3. **Prioritise simplicity and time-to-value** - Make pragmatic trade-offs that reduce complexity while establishing architectural patterns for future work\n\n==== Why Domain-Driven Design with Bounded Contexts?\n\nThe decision to implement **ProfileService** and **EngagementService** as separate bounded contexts rather than direct Mobile App → Salesforce integration reflects a strategic investment in architectural quality:\n\n*The Problem with Direct Integration*:\n\n* Mobile App tightly coupled to Salesforce API (any Salesforce change breaks Mobile App)\n* Viva Energy controls the shared Salesforce instance - we conform to their governance and configuration\n* Future integrations (Flybuys, LocationService, PaymentService) would duplicate Contact reconciliation logic\n* No domain event publishing - other services can't react to customer feedback\n\n*The DDD Solution*:\n\n* **ProfileService** handles Contact reconciliation - reusable for Flybuys partner linking, future bounded contexts\n* **EngagementService** acts as Anti-Corruption Layer - translates between OTR domain language (customer feedback categories: App, Service, Order, Rewards, Refund, Delete Account) and Salesforce (Case object with Viva Energy-specific configuration)\n* **Event Bus** publishes domain events (`CustomerFeedbackSubmitted`, `SupportCaseCreated`) - other bounded contexts can react without coupling\n* **Clear boundaries** - ProfileService handles identity, EngagementService handles support/feedback (different responsibilities, different change rates)\n\n*The Trade-Off*:\n\nWe accept **increased initial complexity** (two new microservices, Event Bus infrastructure, team learning DDD patterns) in exchange for **architectural foundation** that protects digital channels from external system changes and enables reusable components for future work (Flybuys, subscriptions, recommendations).\n\nThis is a **strategic investment** - we're not just solving customer support consolidation, we're establishing the architectural pattern for all future bounded contexts.\n\n==== Why Async Processing Instead of Synchronous API Calls?\n\nThe decision to create Salesforce Cases **asynchronously via Event Bus** (ADR-CS-003) rather than synchronously in the API request path reflects a prioritisation of user experience and resilience over simplicity:\n\n*The Problem with Synchronous Integration*:\n\n* User waits for Salesforce API response (latency: Mobile App → EngagementService → Salesforce → EngagementService → Mobile App)\n* If Salesforce is down or slow, customer feedback submission fails\n* No automatic retry - customer must resubmit feedback\n* API timeout must accommodate worst-case Salesforce latency\n\n*The Async Solution*:\n\n* **Immediate acknowledgment** - User gets \"Feedback submitted\" confirmation in <200ms (no Salesforce wait)\n* **Resilience** - If Salesforce is down, feedback queued, Case created when Salesforce recovers\n* **Automatic retry** - Exponential backoff handles transient Salesforce API failures\n* **Operational visibility** - Dead letter queue alerts ops team to persistent failures\n* **Scalability** - Queue buffering handles traffic spikes (expected 100-150 submissions/day, capacity for 10x)\n\n*The Trade-Off*:\n\nWe accept **eventual consistency** (user receives push notification after Case created, not immediately) and **increased complexity** (Event Bus, background workers, retry logic, DLQ monitoring) in exchange for **better user experience** (no waiting) and **resilience** (Salesforce downtime doesn't block customer feedback).\n\nThis trade-off is acceptable because customer support feedback is **not a real-time transaction** (unlike payment processing). A 30-second delay between feedback submission and Case creation is invisible to the customer, who receives a push notification when the Case is created.\n\n==== Why Conformist Pattern for Salesforce?\n\nThe decision to **conform to Salesforce configuration** (ADR-CS-015) rather than heavily customise Salesforce or abstract away its API reflects a pragmatic acceptance of organisational reality:\n\n*The Organisational Context*:\n\n* **Shared Salesforce instance** - Viva Energy owns and operates the Salesforce Service Cloud instance\n* **Multi-tenant governance** - OTR is one business unit among many (fuel wholesale, Shell Card, other retail channels)\n* **Viva Energy controls roadmap** - We don't control Salesforce configuration, custom fields, or API evolution\n* **Post-merger integration** - Strategic decision to standardize on Viva Energy platforms (not build parallel systems)\n\n*The Conformist Approach*:\n\n* **Accept their data model** - Use standard Contact and Case objects with Viva Energy-configured fields\n* **Conform to their API** - Use Salesforce REST API as-is, minimal custom Apex code\n* **Work within their governance** - Data isolation via Record Types/queues (TBD with Salesforce admin team)\n* **Anti-Corruption Layer protects us** - EngagementService translates between OTR domain language and Salesforce, but doesn't fight Salesforce's model\n\n*Why Not Heavily Customise Salesforce?*:\n\n* **Governance constraints** - Viva Energy Salesforce team must approve all customisations (slow, requires business case)\n* **Shared instance risk** - Custom Apex code or triggers could impact other business units (change control overhead)\n* **Upgrade risk** - Heavy customisation increases Salesforce upgrade complexity\n* **Not our system** - We don't control the platform, so we shouldn't over-invest in customisation we can't maintain\n\n*The Trade-Off*:\n\nWe accept **less control over data model and platform evolution** in exchange for **faster time-to-value** (no custom development in Salesforce), **reduced operational overhead** (no custom code to maintain), and **organisational alignment** (consolidate onto shared Viva Energy platforms).\n\nThe **Anti-Corruption Layer** (EngagementService) is the protection mechanism - it translates between OTR's domain language and Salesforce, so if Salesforce changes, we update the ACL, not the Mobile App.\n\n==== Why Big Bang Cutover Instead of Phased Rollout?\n\nThe decision to use **big bang cutover** (ADR-CS-006) rather than phased rollout with feature flags (like the Flybuys integration uses) reflects a risk assessment based on criticality and complexity:\n\n*Why Flybuys Uses Phased Rollout (AS-1, AS-2, AS-3)*:\n\n* **High complexity** - Flybuys points accrual involves transaction adjudication, partner API integration, reconciliation\n* **Mission-critical** - Points accrual errors directly impact customer value and partner agreements\n* **Large user base** - All OTR loyalty members (gradual enablement reduces blast radius)\n* **Reversibility challenge** - Once points awarded to Flybuys, reversal requires partner coordination\n\n*Why Customer Support Uses Big Bang*:\n\n* **Lower complexity** - Feedback submission is create-only operation (no complex state management)\n* **Not mission-critical** - Support feedback failure doesn't prevent app usage or transactions\n* **Manageable user base** - OTR digital customers smaller than total loyalty member base\n* **Easy rollback** - Can revert to D365 CE if critical issues (no partner coordination required)\n* **Faster D365 CE retirement** - No extended transition period maintaining two systems\n\n*The Trade-Off*:\n\nWe accept **higher cutover risk** (all users switch at once) in exchange for **simplicity** (no feature flag management), **faster D365 CE retirement** (no parallel run period), and **reduced transition complexity** (no AS-1/AS-2/AS-3 architecture states).\n\nThe risk is mitigated by:\n\n* **Comprehensive testing** - Load testing (3x-10x expected volume), integration testing, UAT\n* **Rollback plan** - Can revert Mobile App to D365 CE if critical issues within 48 hours\n* **Non-critical workload** - Support feedback failure doesn't block core app functionality\n\nThis is a **pragmatic trade-off** - we use the simplest migration strategy that matches the risk profile of the workload.\n\n==== Why No Case Migration from D365 CE?\n\nThe decision to **not migrate historical Cases** (ADR-CS-005) reflects a cost-benefit analysis that prioritises speed and simplicity over historical data preservation:\n\n*The Case for Migration*:\n\n* Support agents could see historical customer support Cases in Salesforce\n* Continuity of support history for repeat issues\n* Analytics and reporting on historical Case trends\n\n*The Case Against Migration*:\n\n* **Limited value** - Historical D365 CE Cases not critical for future support (new Cases moving forward)\n* **Data quality concerns** - D365 CE Case data may be inconsistent, incomplete, or poorly categorised\n* **Migration complexity** - Requires mapping D365 CE schema to Salesforce, data transformation, validation, testing\n* **Delays cutover** - Case migration extends timeline (Contact migration only is faster)\n* **Cost-benefit** - Migration effort (4-6 weeks) outweighs value of historical data\n\n*The Alternative*:\n\nIf historical Cases are needed, D365 CE can remain accessible (read-only) temporarily for lookups, or Cases can be archived separately.\n\n*The Trade-Off*:\n\nWe accept **loss of historical Case visibility in Salesforce** in exchange for **faster time-to-value** (Contact migration only), **simpler migration** (no Case schema mapping), and **clean start** (no legacy data quality issues).\n\nThis is a **pragmatic simplification** - historical support Cases provide marginal value compared to the migration effort required.\n\n==== Why Email as Primary Matching Key (Not VCI)?\n\nThe decision to use **email as the primary Contact matching key** (ADR-CS-004) rather than Viva Consumer ID (VCI) reflects a pragmatic choice based on current system capabilities:\n\n*Why Not VCI?*:\n\n* **Not in Salesforce today** - VCI is not currently stored as Salesforce External ID (requires Salesforce admin team to add field and configure upsert)\n* **Adds coordination overhead** - Requires Viva Energy Salesforce team approval, field creation, indexing, testing\n* **Delays cutover** - Email-based matching can start immediately, VCI matching requires Salesforce configuration work\n\n*Why Email Works*:\n\n* **Available now** - Salesforce Contact already has email field (standard, indexed)\n* **Unique identifier** - Email is unique in both Salesforce and Mobile App authentication\n* **Always available** - Authenticated users always have email from Entra ID JWT\n* **Salesforce standard** - Email is standard Contact lookup field (no custom configuration)\n\n*The Edge Case*:\n\n* **Email change** - If customer changes email, creates duplicate Contact (rare, manual cleanup acceptable)\n\n*Future Enhancement*:\n\n* Add VCI as Salesforce External ID (more stable matching)\n* Migrate to VCI-based matching once Salesforce configuration is complete\n\n*The Trade-Off*:\n\nWe accept **rare duplicate Contact creation** (when customers change email) in exchange for **immediate implementation** (no Salesforce configuration required) and **simplicity** (single matching key).\n\nThis is a **pragmatic starting point** - we can enhance to VCI-based matching later without breaking existing functionality.\n\n==== How the Decisions Reinforce Each Other\n\nThe architectural decisions form a **coherent strategy** rather than isolated choices:\n\n1. **DDD Bounded Contexts** (ADR-CS-002) establish the foundation for **Event-Driven Architecture** (ADR-CS-003) - ProfileService and EngagementService publish domain events that other bounded contexts consume\n2. **Async Processing** (ADR-CS-003) enables **Resilience to Salesforce Downtime** - the Event Bus buffers work when Salesforce is unavailable\n3. **Conformist Pattern** (ADR-CS-015) is protected by **Anti-Corruption Layer** - EngagementService conforms to Salesforce but isolates the Mobile App from Salesforce API changes\n4. **Big Bang Cutover** (ADR-CS-006) is feasible because **Customer Support is Non-Critical** - unlike payment processing or Flybuys points accrual, support feedback failure doesn't block core app functionality\n5. **No Case Migration** (ADR-CS-005) simplifies the **Big Bang Cutover** - Contact migration only is faster and lower risk\n6. **Email Matching** (ADR-CS-004) enables **Immediate Implementation** - no waiting for Salesforce admin team to configure VCI External ID\n\nThe decisions are **mutually reinforcing** - each choice makes the others more valuable or feasible.\n\n==== What This Establishes for Future Work\n\nThis implementation is the **architectural foundation** for OTR's target state:\n\n* **First bounded contexts** - ProfileService and EngagementService establish the pattern for LoyaltyService, PaymentService, LocationService, RecommendationService\n* **First event-driven integration** - Event Bus pattern reused for all future bounded context integration (not direct API calls)\n* **Reusable Contact reconciliation** - ProfileService Contact lookup reused for Flybuys partner linking, subscription billing, personalised recommendations\n* **Anti-Corruption Layer pattern** - EngagementService ACL demonstrates how to protect OTR domain model from external systems (EagleEye, Braze, D365 Commerce)\n* **Conformist pattern for shared systems** - Establishes approach for systems we don't control (Salesforce, Entra ID, Microsoft Fabric)\n\nEvery design decision is made with **future bounded contexts in mind** - we're not just solving customer support, we're establishing the architectural standards for all future work.\n","structuredPatch":[{"oldStart":1,"oldLines":8,"newStart":1,"newLines":8,"lines":[" ==== Strategic Architectural Philosophy"," ","-This solution architecture establishes the **foundational implementation** of OTR's target Domain-Driven Design (DDD) architecture. The design choices reflect three core principles:","+This solution architecture aligns with OTR's target Domain-Driven Design (DDD) architecture. The design choices reflect three core principles:"," ","-1. **Protect digital channels from external system coupling** - Use Anti-Corruption Layers (ACLs) to isolate OTR's domain model from external systems we don't control (Salesforce, Braze, EagleEye)","+1. **Protect digital channels from external system coupling** - Use Anti-Corruption Layers (ACLs) to isolate OTR's domain model from external systems we don't control"," 2. **Establish event-driven architecture as the integration standard** - Loose coupling between bounded contexts via domain events, enabling independent evolution"," 3. **Prioritise simplicity and time-to-value** - Make pragmatic trade-offs that reduce complexity while establishing architectural patterns for future work"," "]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"b6cc8710-476b-4507-bc0a-846e0c4a24d5"}
{"parentUuid":"7b1f2b7f-66d9-41c1-b285-ae9c5d31bbaf","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_011wF2kEruas1WS162jC3RG2","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Good start. Now let me generalize the \"Why DDD with Bounded Contexts\" section. This should be about the general pattern, not specific to ProfileService/EngagementService/Salesforce.","signature":"Et4CCkYICxgCKkAoDNmDBksy6bVTzRsWyaqSXZxwdMCTI3pfeyXAEBAK6l64sgEqkFqHY8CAljVMOe5H4EnPa+EzgDnk8985tVYfEgwV7VJ9EH3779272yAaDHgHG6uUKC3Vp+r7AyIwFSgD3JC4yT1NMaqLbnp5TnIQlDb9ymCvvvc6N1TEEex7S8+GgzKpNtcUo7WPK/FOKsUBMQh2DASmwH35X9OEGTowctxp3qd1ebGL2C5qnkY1nph0ec0AAxAeRdcgrbObAlrQki7hlr1Sy06F99BUZOn6WW7Sx6gBGnJCufi58ByPrDdA7u35tg/THkktze3yPOnNfnlGlaqxNjvSoy0IlDWTVG/Zh/q5U4b+T9DjTvaTEWzwRpI7ymbpxVQYLBv6t2YNuWgXeV/vC/E239F1gFXT9RZIeWdFIrbRyNffEzs47dkiwzmzBYSd+eTxeDFr1UE5E+SAj+gYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":1282,"cache_read_input_tokens":36858,"cache_creation":{"ephemeral_5m_input_tokens":1282,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWuP4EhzFayjmxaV19gfy","type":"assistant","uuid":"5cede2b7-5b5e-47aa-9d25-706380cff6d2","timestamp":"2026-01-08T05:45:27.735Z"}
{"parentUuid":"5cede2b7-5b5e-47aa-9d25-706380cff6d2","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_011wF2kEruas1WS162jC3RG2","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_014dngaqNhH6yGEghGJJd18T","name":"Edit","input":{"replace_all":false,"file_path":"/mnt/c/Users/o.young/work/architecture/architectural_approach.adoc","old_string":"==== Why Domain-Driven Design with Bounded Contexts?\n\nThe decision to implement **ProfileService** and **EngagementService** as separate bounded contexts rather than direct Mobile App → Salesforce integration reflects a strategic investment in architectural quality:\n\n*The Problem with Direct Integration*:\n\n* Mobile App tightly coupled to Salesforce API (any Salesforce change breaks Mobile App)\n* Viva Energy controls the shared Salesforce instance - we conform to their governance and configuration\n* Future integrations (Flybuys, LocationService, PaymentService) would duplicate Contact reconciliation logic\n* No domain event publishing - other services can't react to customer feedback\n\n*The DDD Solution*:\n\n* **ProfileService** handles Contact reconciliation - reusable for Flybuys partner linking, future bounded contexts\n* **EngagementService** acts as Anti-Corruption Layer - translates between OTR domain language (customer feedback categories: App, Service, Order, Rewards, Refund, Delete Account) and Salesforce (Case object with Viva Energy-specific configuration)\n* **Event Bus** publishes domain events (`CustomerFeedbackSubmitted`, `SupportCaseCreated`) - other bounded contexts can react without coupling\n* **Clear boundaries** - ProfileService handles identity, EngagementService handles support/feedback (different responsibilities, different change rates)\n\n*The Trade-Off*:\n\nWe accept **increased initial complexity** (two new microservices, Event Bus infrastructure, team learning DDD patterns) in exchange for **architectural foundation** that protects digital channels from external system changes and enables reusable components for future work (Flybuys, subscriptions, recommendations).\n\nThis is a **strategic investment** - we're not just solving customer support consolidation, we're establishing the architectural pattern for all future bounded contexts.","new_string":"==== Why Domain-Driven Design with Bounded Contexts?\n\nThe decision to implement bounded contexts rather than direct integration to external systems reflects a strategic investment in architectural quality:\n\n*The Problem with Direct Integration*:\n\n* Digital channels (Mobile App, Web) tightly coupled to external system APIs (any external change breaks clients)\n* External systems controlled by vendors or other business units - we conform to their governance and configuration\n* Future integrations duplicate common logic (identity reconciliation, event translation, error handling)\n* No domain event publishing - other services can't react to business events\n* Business logic scattered across client applications instead of centralized in domain services\n\n*The DDD Solution*:\n\n* **Bounded contexts** isolate domain concerns with clear responsibility boundaries\n* **Anti-Corruption Layers (ACLs)** translate between OTR domain language and external system models\n* **Event Bus** publishes domain events - other bounded contexts can react without tight coupling\n* **Reusable components** - common logic (identity, authorization, event translation) centralized once, used by many\n* **Clear boundaries** - each context handles specific domain capabilities (different responsibilities, different change rates)\n\n*The Trade-Off*:\n\nWe accept **increased initial complexity** (additional services, Event Bus infrastructure, team learning DDD patterns) in exchange for **architectural foundation** that protects digital channels from external system changes and enables reusable components for future work.\n\nThis is a **strategic investment** - we're not just solving immediate integration needs, we're establishing the architectural pattern for all future bounded contexts."}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":12,"cache_creation_input_tokens":1282,"cache_read_input_tokens":36858,"cache_creation":{"ephemeral_5m_input_tokens":1282,"ephemeral_1h_input_tokens":0},"output_tokens":921,"service_tier":"standard"}},"requestId":"req_011CWuP4EhzFayjmxaV19gfy","type":"assistant","uuid":"89668037-3ef2-43d4-a184-46e9b1c893c7","timestamp":"2026-01-08T05:45:45.748Z"}
{"parentUuid":"89668037-3ef2-43d4-a184-46e9b1c893c7","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_014dngaqNhH6yGEghGJJd18T","type":"tool_result","content":"The file /mnt/c/Users/o.young/work/architecture/architectural_approach.adoc has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n     5→1. **Protect digital channels from external system coupling** - Use Anti-Corruption Layers (ACLs) to isolate OTR's domain model from external systems we don't control\n     6→2. **Establish event-driven architecture as the integration standard** - Loose coupling between bounded contexts via domain events, enabling independent evolution\n     7→3. **Prioritise simplicity and time-to-value** - Make pragmatic trade-offs that reduce complexity while establishing architectural patterns for future work\n     8→\n     9→==== Why Domain-Driven Design with Bounded Contexts?\n    10→\n    11→The decision to implement bounded contexts rather than direct integration to external systems reflects a strategic investment in architectural quality:\n    12→\n    13→*The Problem with Direct Integration*:\n    14→\n    15→* Digital channels (Mobile App, Web) tightly coupled to external system APIs (any external change breaks clients)\n    16→* External systems controlled by vendors or other business units - we conform to their governance and configuration\n    17→* Future integrations duplicate common logic (identity reconciliation, event translation, error handling)\n    18→* No domain event publishing - other services can't react to business events\n    19→* Business logic scattered across client applications instead of centralized in domain services\n    20→\n    21→*The DDD Solution*:\n    22→\n    23→* **Bounded contexts** isolate domain concerns with clear responsibility boundaries\n    24→* **Anti-Corruption Layers (ACLs)** translate between OTR domain language and external system models\n    25→* **Event Bus** publishes domain events - other bounded contexts can react without tight coupling\n    26→* **Reusable components** - common logic (identity, authorization, event translation) centralized once, used by many\n    27→* **Clear boundaries** - each context handles specific domain capabilities (different responsibilities, different change rates)\n    28→\n    29→*The Trade-Off*:\n    30→\n    31→We accept **increased initial complexity** (additional services, Event Bus infrastructure, team learning DDD patterns) in exchange for **architectural foundation** that protects digital channels from external system changes and enables reusable components for future work.\n    32→\n    33→This is a **strategic investment** - we're not just solving immediate integration needs, we're establishing the architectural pattern for all future bounded contexts.\n    34→\n    35→==== Why Async Processing Instead of Synchronous API Calls?\n    36→\n    37→The decision to create Salesforce Cases **asynchronously via Event Bus** (ADR-CS-003) rather than synchronously in the API request path reflects a prioritisation of user experience and resilience over simplicity:"}]},"uuid":"7fa74bf4-1af5-4de5-bbc5-f3f63e8320c2","timestamp":"2026-01-08T05:45:46.077Z","toolUseResult":{"filePath":"/mnt/c/Users/o.young/work/architecture/architectural_approach.adoc","oldString":"==== Why Domain-Driven Design with Bounded Contexts?\n\nThe decision to implement **ProfileService** and **EngagementService** as separate bounded contexts rather than direct Mobile App → Salesforce integration reflects a strategic investment in architectural quality:\n\n*The Problem with Direct Integration*:\n\n* Mobile App tightly coupled to Salesforce API (any Salesforce change breaks Mobile App)\n* Viva Energy controls the shared Salesforce instance - we conform to their governance and configuration\n* Future integrations (Flybuys, LocationService, PaymentService) would duplicate Contact reconciliation logic\n* No domain event publishing - other services can't react to customer feedback\n\n*The DDD Solution*:\n\n* **ProfileService** handles Contact reconciliation - reusable for Flybuys partner linking, future bounded contexts\n* **EngagementService** acts as Anti-Corruption Layer - translates between OTR domain language (customer feedback categories: App, Service, Order, Rewards, Refund, Delete Account) and Salesforce (Case object with Viva Energy-specific configuration)\n* **Event Bus** publishes domain events (`CustomerFeedbackSubmitted`, `SupportCaseCreated`) - other bounded contexts can react without coupling\n* **Clear boundaries** - ProfileService handles identity, EngagementService handles support/feedback (different responsibilities, different change rates)\n\n*The Trade-Off*:\n\nWe accept **increased initial complexity** (two new microservices, Event Bus infrastructure, team learning DDD patterns) in exchange for **architectural foundation** that protects digital channels from external system changes and enables reusable components for future work (Flybuys, subscriptions, recommendations).\n\nThis is a **strategic investment** - we're not just solving customer support consolidation, we're establishing the architectural pattern for all future bounded contexts.","newString":"==== Why Domain-Driven Design with Bounded Contexts?\n\nThe decision to implement bounded contexts rather than direct integration to external systems reflects a strategic investment in architectural quality:\n\n*The Problem with Direct Integration*:\n\n* Digital channels (Mobile App, Web) tightly coupled to external system APIs (any external change breaks clients)\n* External systems controlled by vendors or other business units - we conform to their governance and configuration\n* Future integrations duplicate common logic (identity reconciliation, event translation, error handling)\n* No domain event publishing - other services can't react to business events\n* Business logic scattered across client applications instead of centralized in domain services\n\n*The DDD Solution*:\n\n* **Bounded contexts** isolate domain concerns with clear responsibility boundaries\n* **Anti-Corruption Layers (ACLs)** translate between OTR domain language and external system models\n* **Event Bus** publishes domain events - other bounded contexts can react without tight coupling\n* **Reusable components** - common logic (identity, authorization, event translation) centralized once, used by many\n* **Clear boundaries** - each context handles specific domain capabilities (different responsibilities, different change rates)\n\n*The Trade-Off*:\n\nWe accept **increased initial complexity** (additional services, Event Bus infrastructure, team learning DDD patterns) in exchange for **architectural foundation** that protects digital channels from external system changes and enables reusable components for future work.\n\nThis is a **strategic investment** - we're not just solving immediate integration needs, we're establishing the architectural pattern for all future bounded contexts.","originalFile":"==== Strategic Architectural Philosophy\n\nThis solution architecture aligns with OTR's target Domain-Driven Design (DDD) architecture. The design choices reflect three core principles:\n\n1. **Protect digital channels from external system coupling** - Use Anti-Corruption Layers (ACLs) to isolate OTR's domain model from external systems we don't control\n2. **Establish event-driven architecture as the integration standard** - Loose coupling between bounded contexts via domain events, enabling independent evolution\n3. **Prioritise simplicity and time-to-value** - Make pragmatic trade-offs that reduce complexity while establishing architectural patterns for future work\n\n==== Why Domain-Driven Design with Bounded Contexts?\n\nThe decision to implement **ProfileService** and **EngagementService** as separate bounded contexts rather than direct Mobile App → Salesforce integration reflects a strategic investment in architectural quality:\n\n*The Problem with Direct Integration*:\n\n* Mobile App tightly coupled to Salesforce API (any Salesforce change breaks Mobile App)\n* Viva Energy controls the shared Salesforce instance - we conform to their governance and configuration\n* Future integrations (Flybuys, LocationService, PaymentService) would duplicate Contact reconciliation logic\n* No domain event publishing - other services can't react to customer feedback\n\n*The DDD Solution*:\n\n* **ProfileService** handles Contact reconciliation - reusable for Flybuys partner linking, future bounded contexts\n* **EngagementService** acts as Anti-Corruption Layer - translates between OTR domain language (customer feedback categories: App, Service, Order, Rewards, Refund, Delete Account) and Salesforce (Case object with Viva Energy-specific configuration)\n* **Event Bus** publishes domain events (`CustomerFeedbackSubmitted`, `SupportCaseCreated`) - other bounded contexts can react without coupling\n* **Clear boundaries** - ProfileService handles identity, EngagementService handles support/feedback (different responsibilities, different change rates)\n\n*The Trade-Off*:\n\nWe accept **increased initial complexity** (two new microservices, Event Bus infrastructure, team learning DDD patterns) in exchange for **architectural foundation** that protects digital channels from external system changes and enables reusable components for future work (Flybuys, subscriptions, recommendations).\n\nThis is a **strategic investment** - we're not just solving customer support consolidation, we're establishing the architectural pattern for all future bounded contexts.\n\n==== Why Async Processing Instead of Synchronous API Calls?\n\nThe decision to create Salesforce Cases **asynchronously via Event Bus** (ADR-CS-003) rather than synchronously in the API request path reflects a prioritisation of user experience and resilience over simplicity:\n\n*The Problem with Synchronous Integration*:\n\n* User waits for Salesforce API response (latency: Mobile App → EngagementService → Salesforce → EngagementService → Mobile App)\n* If Salesforce is down or slow, customer feedback submission fails\n* No automatic retry - customer must resubmit feedback\n* API timeout must accommodate worst-case Salesforce latency\n\n*The Async Solution*:\n\n* **Immediate acknowledgment** - User gets \"Feedback submitted\" confirmation in <200ms (no Salesforce wait)\n* **Resilience** - If Salesforce is down, feedback queued, Case created when Salesforce recovers\n* **Automatic retry** - Exponential backoff handles transient Salesforce API failures\n* **Operational visibility** - Dead letter queue alerts ops team to persistent failures\n* **Scalability** - Queue buffering handles traffic spikes (expected 100-150 submissions/day, capacity for 10x)\n\n*The Trade-Off*:\n\nWe accept **eventual consistency** (user receives push notification after Case created, not immediately) and **increased complexity** (Event Bus, background workers, retry logic, DLQ monitoring) in exchange for **better user experience** (no waiting) and **resilience** (Salesforce downtime doesn't block customer feedback).\n\nThis trade-off is acceptable because customer support feedback is **not a real-time transaction** (unlike payment processing). A 30-second delay between feedback submission and Case creation is invisible to the customer, who receives a push notification when the Case is created.\n\n==== Why Conformist Pattern for Salesforce?\n\nThe decision to **conform to Salesforce configuration** (ADR-CS-015) rather than heavily customise Salesforce or abstract away its API reflects a pragmatic acceptance of organisational reality:\n\n*The Organisational Context*:\n\n* **Shared Salesforce instance** - Viva Energy owns and operates the Salesforce Service Cloud instance\n* **Multi-tenant governance** - OTR is one business unit among many (fuel wholesale, Shell Card, other retail channels)\n* **Viva Energy controls roadmap** - We don't control Salesforce configuration, custom fields, or API evolution\n* **Post-merger integration** - Strategic decision to standardize on Viva Energy platforms (not build parallel systems)\n\n*The Conformist Approach*:\n\n* **Accept their data model** - Use standard Contact and Case objects with Viva Energy-configured fields\n* **Conform to their API** - Use Salesforce REST API as-is, minimal custom Apex code\n* **Work within their governance** - Data isolation via Record Types/queues (TBD with Salesforce admin team)\n* **Anti-Corruption Layer protects us** - EngagementService translates between OTR domain language and Salesforce, but doesn't fight Salesforce's model\n\n*Why Not Heavily Customise Salesforce?*:\n\n* **Governance constraints** - Viva Energy Salesforce team must approve all customisations (slow, requires business case)\n* **Shared instance risk** - Custom Apex code or triggers could impact other business units (change control overhead)\n* **Upgrade risk** - Heavy customisation increases Salesforce upgrade complexity\n* **Not our system** - We don't control the platform, so we shouldn't over-invest in customisation we can't maintain\n\n*The Trade-Off*:\n\nWe accept **less control over data model and platform evolution** in exchange for **faster time-to-value** (no custom development in Salesforce), **reduced operational overhead** (no custom code to maintain), and **organisational alignment** (consolidate onto shared Viva Energy platforms).\n\nThe **Anti-Corruption Layer** (EngagementService) is the protection mechanism - it translates between OTR's domain language and Salesforce, so if Salesforce changes, we update the ACL, not the Mobile App.\n\n==== Why Big Bang Cutover Instead of Phased Rollout?\n\nThe decision to use **big bang cutover** (ADR-CS-006) rather than phased rollout with feature flags (like the Flybuys integration uses) reflects a risk assessment based on criticality and complexity:\n\n*Why Flybuys Uses Phased Rollout (AS-1, AS-2, AS-3)*:\n\n* **High complexity** - Flybuys points accrual involves transaction adjudication, partner API integration, reconciliation\n* **Mission-critical** - Points accrual errors directly impact customer value and partner agreements\n* **Large user base** - All OTR loyalty members (gradual enablement reduces blast radius)\n* **Reversibility challenge** - Once points awarded to Flybuys, reversal requires partner coordination\n\n*Why Customer Support Uses Big Bang*:\n\n* **Lower complexity** - Feedback submission is create-only operation (no complex state management)\n* **Not mission-critical** - Support feedback failure doesn't prevent app usage or transactions\n* **Manageable user base** - OTR digital customers smaller than total loyalty member base\n* **Easy rollback** - Can revert to D365 CE if critical issues (no partner coordination required)\n* **Faster D365 CE retirement** - No extended transition period maintaining two systems\n\n*The Trade-Off*:\n\nWe accept **higher cutover risk** (all users switch at once) in exchange for **simplicity** (no feature flag management), **faster D365 CE retirement** (no parallel run period), and **reduced transition complexity** (no AS-1/AS-2/AS-3 architecture states).\n\nThe risk is mitigated by:\n\n* **Comprehensive testing** - Load testing (3x-10x expected volume), integration testing, UAT\n* **Rollback plan** - Can revert Mobile App to D365 CE if critical issues within 48 hours\n* **Non-critical workload** - Support feedback failure doesn't block core app functionality\n\nThis is a **pragmatic trade-off** - we use the simplest migration strategy that matches the risk profile of the workload.\n\n==== Why No Case Migration from D365 CE?\n\nThe decision to **not migrate historical Cases** (ADR-CS-005) reflects a cost-benefit analysis that prioritises speed and simplicity over historical data preservation:\n\n*The Case for Migration*:\n\n* Support agents could see historical customer support Cases in Salesforce\n* Continuity of support history for repeat issues\n* Analytics and reporting on historical Case trends\n\n*The Case Against Migration*:\n\n* **Limited value** - Historical D365 CE Cases not critical for future support (new Cases moving forward)\n* **Data quality concerns** - D365 CE Case data may be inconsistent, incomplete, or poorly categorised\n* **Migration complexity** - Requires mapping D365 CE schema to Salesforce, data transformation, validation, testing\n* **Delays cutover** - Case migration extends timeline (Contact migration only is faster)\n* **Cost-benefit** - Migration effort (4-6 weeks) outweighs value of historical data\n\n*The Alternative*:\n\nIf historical Cases are needed, D365 CE can remain accessible (read-only) temporarily for lookups, or Cases can be archived separately.\n\n*The Trade-Off*:\n\nWe accept **loss of historical Case visibility in Salesforce** in exchange for **faster time-to-value** (Contact migration only), **simpler migration** (no Case schema mapping), and **clean start** (no legacy data quality issues).\n\nThis is a **pragmatic simplification** - historical support Cases provide marginal value compared to the migration effort required.\n\n==== Why Email as Primary Matching Key (Not VCI)?\n\nThe decision to use **email as the primary Contact matching key** (ADR-CS-004) rather than Viva Consumer ID (VCI) reflects a pragmatic choice based on current system capabilities:\n\n*Why Not VCI?*:\n\n* **Not in Salesforce today** - VCI is not currently stored as Salesforce External ID (requires Salesforce admin team to add field and configure upsert)\n* **Adds coordination overhead** - Requires Viva Energy Salesforce team approval, field creation, indexing, testing\n* **Delays cutover** - Email-based matching can start immediately, VCI matching requires Salesforce configuration work\n\n*Why Email Works*:\n\n* **Available now** - Salesforce Contact already has email field (standard, indexed)\n* **Unique identifier** - Email is unique in both Salesforce and Mobile App authentication\n* **Always available** - Authenticated users always have email from Entra ID JWT\n* **Salesforce standard** - Email is standard Contact lookup field (no custom configuration)\n\n*The Edge Case*:\n\n* **Email change** - If customer changes email, creates duplicate Contact (rare, manual cleanup acceptable)\n\n*Future Enhancement*:\n\n* Add VCI as Salesforce External ID (more stable matching)\n* Migrate to VCI-based matching once Salesforce configuration is complete\n\n*The Trade-Off*:\n\nWe accept **rare duplicate Contact creation** (when customers change email) in exchange for **immediate implementation** (no Salesforce configuration required) and **simplicity** (single matching key).\n\nThis is a **pragmatic starting point** - we can enhance to VCI-based matching later without breaking existing functionality.\n\n==== How the Decisions Reinforce Each Other\n\nThe architectural decisions form a **coherent strategy** rather than isolated choices:\n\n1. **DDD Bounded Contexts** (ADR-CS-002) establish the foundation for **Event-Driven Architecture** (ADR-CS-003) - ProfileService and EngagementService publish domain events that other bounded contexts consume\n2. **Async Processing** (ADR-CS-003) enables **Resilience to Salesforce Downtime** - the Event Bus buffers work when Salesforce is unavailable\n3. **Conformist Pattern** (ADR-CS-015) is protected by **Anti-Corruption Layer** - EngagementService conforms to Salesforce but isolates the Mobile App from Salesforce API changes\n4. **Big Bang Cutover** (ADR-CS-006) is feasible because **Customer Support is Non-Critical** - unlike payment processing or Flybuys points accrual, support feedback failure doesn't block core app functionality\n5. **No Case Migration** (ADR-CS-005) simplifies the **Big Bang Cutover** - Contact migration only is faster and lower risk\n6. **Email Matching** (ADR-CS-004) enables **Immediate Implementation** - no waiting for Salesforce admin team to configure VCI External ID\n\nThe decisions are **mutually reinforcing** - each choice makes the others more valuable or feasible.\n\n==== What This Establishes for Future Work\n\nThis implementation is the **architectural foundation** for OTR's target state:\n\n* **First bounded contexts** - ProfileService and EngagementService establish the pattern for LoyaltyService, PaymentService, LocationService, RecommendationService\n* **First event-driven integration** - Event Bus pattern reused for all future bounded context integration (not direct API calls)\n* **Reusable Contact reconciliation** - ProfileService Contact lookup reused for Flybuys partner linking, subscription billing, personalised recommendations\n* **Anti-Corruption Layer pattern** - EngagementService ACL demonstrates how to protect OTR domain model from external systems (EagleEye, Braze, D365 Commerce)\n* **Conformist pattern for shared systems** - Establishes approach for systems we don't control (Salesforce, Entra ID, Microsoft Fabric)\n\nEvery design decision is made with **future bounded contexts in mind** - we're not just solving customer support, we're establishing the architectural standards for all future work.\n","structuredPatch":[{"oldStart":8,"oldLines":27,"newStart":8,"newLines":29,"lines":[" "," ==== Why Domain-Driven Design with Bounded Contexts?"," ","-The decision to implement **ProfileService** and **EngagementService** as separate bounded contexts rather than direct Mobile App → Salesforce integration reflects a strategic investment in architectural quality:","+The decision to implement bounded contexts rather than direct integration to external systems reflects a strategic investment in architectural quality:"," "," *The Problem with Direct Integration*:"," ","-* Mobile App tightly coupled to Salesforce API (any Salesforce change breaks Mobile App)","-* Viva Energy controls the shared Salesforce instance - we conform to their governance and configuration","-* Future integrations (Flybuys, LocationService, PaymentService) would duplicate Contact reconciliation logic","-* No domain event publishing - other services can't react to customer feedback","+* Digital channels (Mobile App, Web) tightly coupled to external system APIs (any external change breaks clients)","+* External systems controlled by vendors or other business units - we conform to their governance and configuration","+* Future integrations duplicate common logic (identity reconciliation, event translation, error handling)","+* No domain event publishing - other services can't react to business events","+* Business logic scattered across client applications instead of centralized in domain services"," "," *The DDD Solution*:"," ","-* **ProfileService** handles Contact reconciliation - reusable for Flybuys partner linking, future bounded contexts","-* **EngagementService** acts as Anti-Corruption Layer - translates between OTR domain language (customer feedback categories: App, Service, Order, Rewards, Refund, Delete Account) and Salesforce (Case object with Viva Energy-specific configuration)","-* **Event Bus** publishes domain events (`CustomerFeedbackSubmitted`, `SupportCaseCreated`) - other bounded contexts can react without coupling","-* **Clear boundaries** - ProfileService handles identity, EngagementService handles support/feedback (different responsibilities, different change rates)","+* **Bounded contexts** isolate domain concerns with clear responsibility boundaries","+* **Anti-Corruption Layers (ACLs)** translate between OTR domain language and external system models","+* **Event Bus** publishes domain events - other bounded contexts can react without tight coupling","+* **Reusable components** - common logic (identity, authorization, event translation) centralized once, used by many","+* **Clear boundaries** - each context handles specific domain capabilities (different responsibilities, different change rates)"," "," *The Trade-Off*:"," ","-We accept **increased initial complexity** (two new microservices, Event Bus infrastructure, team learning DDD patterns) in exchange for **architectural foundation** that protects digital channels from external system changes and enables reusable components for future work (Flybuys, subscriptions, recommendations).","+We accept **increased initial complexity** (additional services, Event Bus infrastructure, team learning DDD patterns) in exchange for **architectural foundation** that protects digital channels from external system changes and enables reusable components for future work."," ","-This is a **strategic investment** - we're not just solving customer support consolidation, we're establishing the architectural pattern for all future bounded contexts.","+This is a **strategic investment** - we're not just solving immediate integration needs, we're establishing the architectural pattern for all future bounded contexts."," "," ==== Why Async Processing Instead of Synchronous API Calls?"," "]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"89668037-3ef2-43d4-a184-46e9b1c893c7"}
{"parentUuid":"7fa74bf4-1af5-4de5-bbc5-f3f63e8320c2","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01HsDEDAfqKirtMj7a3dsnvH","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Good, now let me generalize the async processing section to not be Salesforce-specific.","signature":"Ev8BCkYICxgCKkCAfYhVm2LPgyin3JFMORucj3jgYzSRrRxGuuD2KjYaL1jLTn0gL93uulz7b5gwVQmcgsxV8d1THDSsH9n3MwshEgzV0NO2rqsZpGu3IdMaDJuK2mNxBv7Bq9EEcSIwBs3ch9JfyjKN3cP5NqJSs8LoNOFED+eBu2P3XDC5LNsb4GUaIOiHkViEsvLrfbGdKmcQsKvwCFjy/qXDA1vgBvEslJRPq2U4F9L3YE2jo6YziUlC9OsTC1aP10D1qxxoNlalyMxLY7zLM+OmQrL+FzAkuz+4DtzkuWAJTjTHQfP4BHB7hOQb3OzXT1H3ucRC2JiYaQwhA5JVGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":11,"cache_creation_input_tokens":1605,"cache_read_input_tokens":38140,"cache_creation":{"ephemeral_5m_input_tokens":1605,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWuP5s2Zqjx2igeSPiPQo","type":"assistant","uuid":"7ece541f-82b4-4bc3-b6c7-d6dac7d9188c","timestamp":"2026-01-08T05:45:49.796Z"}
{"parentUuid":"7ece541f-82b4-4bc3-b6c7-d6dac7d9188c","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01HsDEDAfqKirtMj7a3dsnvH","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01HtSPsft4vRKHh5YsPtuzfc","name":"Edit","input":{"replace_all":false,"file_path":"/mnt/c/Users/o.young/work/architecture/architectural_approach.adoc","old_string":"==== Why Async Processing Instead of Synchronous API Calls?\n\nThe decision to create Salesforce Cases **asynchronously via Event Bus** (ADR-CS-003) rather than synchronously in the API request path reflects a prioritisation of user experience and resilience over simplicity:\n\n*The Problem with Synchronous Integration*:\n\n* User waits for Salesforce API response (latency: Mobile App → EngagementService → Salesforce → EngagementService → Mobile App)\n* If Salesforce is down or slow, customer feedback submission fails\n* No automatic retry - customer must resubmit feedback\n* API timeout must accommodate worst-case Salesforce latency\n\n*The Async Solution*:\n\n* **Immediate acknowledgment** - User gets \"Feedback submitted\" confirmation in <200ms (no Salesforce wait)\n* **Resilience** - If Salesforce is down, feedback queued, Case created when Salesforce recovers\n* **Automatic retry** - Exponential backoff handles transient Salesforce API failures\n* **Operational visibility** - Dead letter queue alerts ops team to persistent failures\n* **Scalability** - Queue buffering handles traffic spikes (expected 100-150 submissions/day, capacity for 10x)\n\n*The Trade-Off*:\n\nWe accept **eventual consistency** (user receives push notification after Case created, not immediately) and **increased complexity** (Event Bus, background workers, retry logic, DLQ monitoring) in exchange for **better user experience** (no waiting) and **resilience** (Salesforce downtime doesn't block customer feedback).\n\nThis trade-off is acceptable because customer support feedback is **not a real-time transaction** (unlike payment processing). A 30-second delay between feedback submission and Case creation is invisible to the customer, who receives a push notification when the Case is created.","new_string":"==== Why Async Processing Instead of Synchronous API Calls?\n\nWhen integrating with external systems, the decision between asynchronous and synchronous processing reflects a prioritization of user experience, resilience, and system characteristics:\n\n*The Problem with Synchronous Integration*:\n\n* User waits for external system API response (latency across multiple system hops)\n* If external system is down or slow, user-facing operations fail\n* No automatic retry - users must manually retry operations\n* API timeout must accommodate worst-case external system latency\n* Tight coupling between user experience and external system performance\n\n*The Async Solution*:\n\n* **Immediate acknowledgment** - User gets confirmation quickly (no external system wait)\n* **Resilience** - If external system is down, work queued and processed when system recovers\n* **Automatic retry** - Exponential backoff handles transient API failures\n* **Operational visibility** - Dead letter queue alerts ops team to persistent failures\n* **Scalability** - Queue buffering handles traffic spikes without overwhelming external systems\n\n*The Trade-Off*:\n\nWe accept **eventual consistency** (notifications delivered after external processing completes) and **increased complexity** (Event Bus, background workers, retry logic, DLQ monitoring) in exchange for **better user experience** (no waiting) and **resilience** (external system downtime doesn't block user-facing operations).\n\nThis trade-off is acceptable when operations are **not real-time transactions** (unlike payment processing). When business processes can tolerate short delays (seconds to minutes), async processing improves both user experience and system resilience."}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":11,"cache_creation_input_tokens":1605,"cache_read_input_tokens":38140,"cache_creation":{"ephemeral_5m_input_tokens":1605,"ephemeral_1h_input_tokens":0},"output_tokens":925,"service_tier":"standard"}},"requestId":"req_011CWuP5s2Zqjx2igeSPiPQo","type":"assistant","uuid":"531b5797-a493-4c8e-ac25-6c8792ef7479","timestamp":"2026-01-08T05:46:06.138Z"}
{"parentUuid":"531b5797-a493-4c8e-ac25-6c8792ef7479","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01HtSPsft4vRKHh5YsPtuzfc","type":"tool_result","content":"The file /mnt/c/Users/o.young/work/architecture/architectural_approach.adoc has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n    31→We accept **increased initial complexity** (additional services, Event Bus infrastructure, team learning DDD patterns) in exchange for **architectural foundation** that protects digital channels from external system changes and enables reusable components for future work.\n    32→\n    33→This is a **strategic investment** - we're not just solving immediate integration needs, we're establishing the architectural pattern for all future bounded contexts.\n    34→\n    35→==== Why Async Processing Instead of Synchronous API Calls?\n    36→\n    37→When integrating with external systems, the decision between asynchronous and synchronous processing reflects a prioritization of user experience, resilience, and system characteristics:\n    38→\n    39→*The Problem with Synchronous Integration*:\n    40→\n    41→* User waits for external system API response (latency across multiple system hops)\n    42→* If external system is down or slow, user-facing operations fail\n    43→* No automatic retry - users must manually retry operations\n    44→* API timeout must accommodate worst-case external system latency\n    45→* Tight coupling between user experience and external system performance\n    46→\n    47→*The Async Solution*:\n    48→\n    49→* **Immediate acknowledgment** - User gets confirmation quickly (no external system wait)\n    50→* **Resilience** - If external system is down, work queued and processed when system recovers\n    51→* **Automatic retry** - Exponential backoff handles transient API failures\n    52→* **Operational visibility** - Dead letter queue alerts ops team to persistent failures\n    53→* **Scalability** - Queue buffering handles traffic spikes without overwhelming external systems\n    54→\n    55→*The Trade-Off*:\n    56→\n    57→We accept **eventual consistency** (notifications delivered after external processing completes) and **increased complexity** (Event Bus, background workers, retry logic, DLQ monitoring) in exchange for **better user experience** (no waiting) and **resilience** (external system downtime doesn't block user-facing operations).\n    58→\n    59→This trade-off is acceptable when operations are **not real-time transactions** (unlike payment processing). When business processes can tolerate short delays (seconds to minutes), async processing improves both user experience and system resilience.\n    60→\n    61→==== Why Conformist Pattern for Salesforce?\n    62→\n    63→The decision to **conform to Salesforce configuration** (ADR-CS-015) rather than heavily customise Salesforce or abstract away its API reflects a pragmatic acceptance of organisational reality:"}]},"uuid":"ddb385c5-f4bd-4850-b555-d4cd437fa297","timestamp":"2026-01-08T05:46:06.349Z","toolUseResult":{"filePath":"/mnt/c/Users/o.young/work/architecture/architectural_approach.adoc","oldString":"==== Why Async Processing Instead of Synchronous API Calls?\n\nThe decision to create Salesforce Cases **asynchronously via Event Bus** (ADR-CS-003) rather than synchronously in the API request path reflects a prioritisation of user experience and resilience over simplicity:\n\n*The Problem with Synchronous Integration*:\n\n* User waits for Salesforce API response (latency: Mobile App → EngagementService → Salesforce → EngagementService → Mobile App)\n* If Salesforce is down or slow, customer feedback submission fails\n* No automatic retry - customer must resubmit feedback\n* API timeout must accommodate worst-case Salesforce latency\n\n*The Async Solution*:\n\n* **Immediate acknowledgment** - User gets \"Feedback submitted\" confirmation in <200ms (no Salesforce wait)\n* **Resilience** - If Salesforce is down, feedback queued, Case created when Salesforce recovers\n* **Automatic retry** - Exponential backoff handles transient Salesforce API failures\n* **Operational visibility** - Dead letter queue alerts ops team to persistent failures\n* **Scalability** - Queue buffering handles traffic spikes (expected 100-150 submissions/day, capacity for 10x)\n\n*The Trade-Off*:\n\nWe accept **eventual consistency** (user receives push notification after Case created, not immediately) and **increased complexity** (Event Bus, background workers, retry logic, DLQ monitoring) in exchange for **better user experience** (no waiting) and **resilience** (Salesforce downtime doesn't block customer feedback).\n\nThis trade-off is acceptable because customer support feedback is **not a real-time transaction** (unlike payment processing). A 30-second delay between feedback submission and Case creation is invisible to the customer, who receives a push notification when the Case is created.","newString":"==== Why Async Processing Instead of Synchronous API Calls?\n\nWhen integrating with external systems, the decision between asynchronous and synchronous processing reflects a prioritization of user experience, resilience, and system characteristics:\n\n*The Problem with Synchronous Integration*:\n\n* User waits for external system API response (latency across multiple system hops)\n* If external system is down or slow, user-facing operations fail\n* No automatic retry - users must manually retry operations\n* API timeout must accommodate worst-case external system latency\n* Tight coupling between user experience and external system performance\n\n*The Async Solution*:\n\n* **Immediate acknowledgment** - User gets confirmation quickly (no external system wait)\n* **Resilience** - If external system is down, work queued and processed when system recovers\n* **Automatic retry** - Exponential backoff handles transient API failures\n* **Operational visibility** - Dead letter queue alerts ops team to persistent failures\n* **Scalability** - Queue buffering handles traffic spikes without overwhelming external systems\n\n*The Trade-Off*:\n\nWe accept **eventual consistency** (notifications delivered after external processing completes) and **increased complexity** (Event Bus, background workers, retry logic, DLQ monitoring) in exchange for **better user experience** (no waiting) and **resilience** (external system downtime doesn't block user-facing operations).\n\nThis trade-off is acceptable when operations are **not real-time transactions** (unlike payment processing). When business processes can tolerate short delays (seconds to minutes), async processing improves both user experience and system resilience.","originalFile":"==== Strategic Architectural Philosophy\n\nThis solution architecture aligns with OTR's target Domain-Driven Design (DDD) architecture. The design choices reflect three core principles:\n\n1. **Protect digital channels from external system coupling** - Use Anti-Corruption Layers (ACLs) to isolate OTR's domain model from external systems we don't control\n2. **Establish event-driven architecture as the integration standard** - Loose coupling between bounded contexts via domain events, enabling independent evolution\n3. **Prioritise simplicity and time-to-value** - Make pragmatic trade-offs that reduce complexity while establishing architectural patterns for future work\n\n==== Why Domain-Driven Design with Bounded Contexts?\n\nThe decision to implement bounded contexts rather than direct integration to external systems reflects a strategic investment in architectural quality:\n\n*The Problem with Direct Integration*:\n\n* Digital channels (Mobile App, Web) tightly coupled to external system APIs (any external change breaks clients)\n* External systems controlled by vendors or other business units - we conform to their governance and configuration\n* Future integrations duplicate common logic (identity reconciliation, event translation, error handling)\n* No domain event publishing - other services can't react to business events\n* Business logic scattered across client applications instead of centralized in domain services\n\n*The DDD Solution*:\n\n* **Bounded contexts** isolate domain concerns with clear responsibility boundaries\n* **Anti-Corruption Layers (ACLs)** translate between OTR domain language and external system models\n* **Event Bus** publishes domain events - other bounded contexts can react without tight coupling\n* **Reusable components** - common logic (identity, authorization, event translation) centralized once, used by many\n* **Clear boundaries** - each context handles specific domain capabilities (different responsibilities, different change rates)\n\n*The Trade-Off*:\n\nWe accept **increased initial complexity** (additional services, Event Bus infrastructure, team learning DDD patterns) in exchange for **architectural foundation** that protects digital channels from external system changes and enables reusable components for future work.\n\nThis is a **strategic investment** - we're not just solving immediate integration needs, we're establishing the architectural pattern for all future bounded contexts.\n\n==== Why Async Processing Instead of Synchronous API Calls?\n\nThe decision to create Salesforce Cases **asynchronously via Event Bus** (ADR-CS-003) rather than synchronously in the API request path reflects a prioritisation of user experience and resilience over simplicity:\n\n*The Problem with Synchronous Integration*:\n\n* User waits for Salesforce API response (latency: Mobile App → EngagementService → Salesforce → EngagementService → Mobile App)\n* If Salesforce is down or slow, customer feedback submission fails\n* No automatic retry - customer must resubmit feedback\n* API timeout must accommodate worst-case Salesforce latency\n\n*The Async Solution*:\n\n* **Immediate acknowledgment** - User gets \"Feedback submitted\" confirmation in <200ms (no Salesforce wait)\n* **Resilience** - If Salesforce is down, feedback queued, Case created when Salesforce recovers\n* **Automatic retry** - Exponential backoff handles transient Salesforce API failures\n* **Operational visibility** - Dead letter queue alerts ops team to persistent failures\n* **Scalability** - Queue buffering handles traffic spikes (expected 100-150 submissions/day, capacity for 10x)\n\n*The Trade-Off*:\n\nWe accept **eventual consistency** (user receives push notification after Case created, not immediately) and **increased complexity** (Event Bus, background workers, retry logic, DLQ monitoring) in exchange for **better user experience** (no waiting) and **resilience** (Salesforce downtime doesn't block customer feedback).\n\nThis trade-off is acceptable because customer support feedback is **not a real-time transaction** (unlike payment processing). A 30-second delay between feedback submission and Case creation is invisible to the customer, who receives a push notification when the Case is created.\n\n==== Why Conformist Pattern for Salesforce?\n\nThe decision to **conform to Salesforce configuration** (ADR-CS-015) rather than heavily customise Salesforce or abstract away its API reflects a pragmatic acceptance of organisational reality:\n\n*The Organisational Context*:\n\n* **Shared Salesforce instance** - Viva Energy owns and operates the Salesforce Service Cloud instance\n* **Multi-tenant governance** - OTR is one business unit among many (fuel wholesale, Shell Card, other retail channels)\n* **Viva Energy controls roadmap** - We don't control Salesforce configuration, custom fields, or API evolution\n* **Post-merger integration** - Strategic decision to standardize on Viva Energy platforms (not build parallel systems)\n\n*The Conformist Approach*:\n\n* **Accept their data model** - Use standard Contact and Case objects with Viva Energy-configured fields\n* **Conform to their API** - Use Salesforce REST API as-is, minimal custom Apex code\n* **Work within their governance** - Data isolation via Record Types/queues (TBD with Salesforce admin team)\n* **Anti-Corruption Layer protects us** - EngagementService translates between OTR domain language and Salesforce, but doesn't fight Salesforce's model\n\n*Why Not Heavily Customise Salesforce?*:\n\n* **Governance constraints** - Viva Energy Salesforce team must approve all customisations (slow, requires business case)\n* **Shared instance risk** - Custom Apex code or triggers could impact other business units (change control overhead)\n* **Upgrade risk** - Heavy customisation increases Salesforce upgrade complexity\n* **Not our system** - We don't control the platform, so we shouldn't over-invest in customisation we can't maintain\n\n*The Trade-Off*:\n\nWe accept **less control over data model and platform evolution** in exchange for **faster time-to-value** (no custom development in Salesforce), **reduced operational overhead** (no custom code to maintain), and **organisational alignment** (consolidate onto shared Viva Energy platforms).\n\nThe **Anti-Corruption Layer** (EngagementService) is the protection mechanism - it translates between OTR's domain language and Salesforce, so if Salesforce changes, we update the ACL, not the Mobile App.\n\n==== Why Big Bang Cutover Instead of Phased Rollout?\n\nThe decision to use **big bang cutover** (ADR-CS-006) rather than phased rollout with feature flags (like the Flybuys integration uses) reflects a risk assessment based on criticality and complexity:\n\n*Why Flybuys Uses Phased Rollout (AS-1, AS-2, AS-3)*:\n\n* **High complexity** - Flybuys points accrual involves transaction adjudication, partner API integration, reconciliation\n* **Mission-critical** - Points accrual errors directly impact customer value and partner agreements\n* **Large user base** - All OTR loyalty members (gradual enablement reduces blast radius)\n* **Reversibility challenge** - Once points awarded to Flybuys, reversal requires partner coordination\n\n*Why Customer Support Uses Big Bang*:\n\n* **Lower complexity** - Feedback submission is create-only operation (no complex state management)\n* **Not mission-critical** - Support feedback failure doesn't prevent app usage or transactions\n* **Manageable user base** - OTR digital customers smaller than total loyalty member base\n* **Easy rollback** - Can revert to D365 CE if critical issues (no partner coordination required)\n* **Faster D365 CE retirement** - No extended transition period maintaining two systems\n\n*The Trade-Off*:\n\nWe accept **higher cutover risk** (all users switch at once) in exchange for **simplicity** (no feature flag management), **faster D365 CE retirement** (no parallel run period), and **reduced transition complexity** (no AS-1/AS-2/AS-3 architecture states).\n\nThe risk is mitigated by:\n\n* **Comprehensive testing** - Load testing (3x-10x expected volume), integration testing, UAT\n* **Rollback plan** - Can revert Mobile App to D365 CE if critical issues within 48 hours\n* **Non-critical workload** - Support feedback failure doesn't block core app functionality\n\nThis is a **pragmatic trade-off** - we use the simplest migration strategy that matches the risk profile of the workload.\n\n==== Why No Case Migration from D365 CE?\n\nThe decision to **not migrate historical Cases** (ADR-CS-005) reflects a cost-benefit analysis that prioritises speed and simplicity over historical data preservation:\n\n*The Case for Migration*:\n\n* Support agents could see historical customer support Cases in Salesforce\n* Continuity of support history for repeat issues\n* Analytics and reporting on historical Case trends\n\n*The Case Against Migration*:\n\n* **Limited value** - Historical D365 CE Cases not critical for future support (new Cases moving forward)\n* **Data quality concerns** - D365 CE Case data may be inconsistent, incomplete, or poorly categorised\n* **Migration complexity** - Requires mapping D365 CE schema to Salesforce, data transformation, validation, testing\n* **Delays cutover** - Case migration extends timeline (Contact migration only is faster)\n* **Cost-benefit** - Migration effort (4-6 weeks) outweighs value of historical data\n\n*The Alternative*:\n\nIf historical Cases are needed, D365 CE can remain accessible (read-only) temporarily for lookups, or Cases can be archived separately.\n\n*The Trade-Off*:\n\nWe accept **loss of historical Case visibility in Salesforce** in exchange for **faster time-to-value** (Contact migration only), **simpler migration** (no Case schema mapping), and **clean start** (no legacy data quality issues).\n\nThis is a **pragmatic simplification** - historical support Cases provide marginal value compared to the migration effort required.\n\n==== Why Email as Primary Matching Key (Not VCI)?\n\nThe decision to use **email as the primary Contact matching key** (ADR-CS-004) rather than Viva Consumer ID (VCI) reflects a pragmatic choice based on current system capabilities:\n\n*Why Not VCI?*:\n\n* **Not in Salesforce today** - VCI is not currently stored as Salesforce External ID (requires Salesforce admin team to add field and configure upsert)\n* **Adds coordination overhead** - Requires Viva Energy Salesforce team approval, field creation, indexing, testing\n* **Delays cutover** - Email-based matching can start immediately, VCI matching requires Salesforce configuration work\n\n*Why Email Works*:\n\n* **Available now** - Salesforce Contact already has email field (standard, indexed)\n* **Unique identifier** - Email is unique in both Salesforce and Mobile App authentication\n* **Always available** - Authenticated users always have email from Entra ID JWT\n* **Salesforce standard** - Email is standard Contact lookup field (no custom configuration)\n\n*The Edge Case*:\n\n* **Email change** - If customer changes email, creates duplicate Contact (rare, manual cleanup acceptable)\n\n*Future Enhancement*:\n\n* Add VCI as Salesforce External ID (more stable matching)\n* Migrate to VCI-based matching once Salesforce configuration is complete\n\n*The Trade-Off*:\n\nWe accept **rare duplicate Contact creation** (when customers change email) in exchange for **immediate implementation** (no Salesforce configuration required) and **simplicity** (single matching key).\n\nThis is a **pragmatic starting point** - we can enhance to VCI-based matching later without breaking existing functionality.\n\n==== How the Decisions Reinforce Each Other\n\nThe architectural decisions form a **coherent strategy** rather than isolated choices:\n\n1. **DDD Bounded Contexts** (ADR-CS-002) establish the foundation for **Event-Driven Architecture** (ADR-CS-003) - ProfileService and EngagementService publish domain events that other bounded contexts consume\n2. **Async Processing** (ADR-CS-003) enables **Resilience to Salesforce Downtime** - the Event Bus buffers work when Salesforce is unavailable\n3. **Conformist Pattern** (ADR-CS-015) is protected by **Anti-Corruption Layer** - EngagementService conforms to Salesforce but isolates the Mobile App from Salesforce API changes\n4. **Big Bang Cutover** (ADR-CS-006) is feasible because **Customer Support is Non-Critical** - unlike payment processing or Flybuys points accrual, support feedback failure doesn't block core app functionality\n5. **No Case Migration** (ADR-CS-005) simplifies the **Big Bang Cutover** - Contact migration only is faster and lower risk\n6. **Email Matching** (ADR-CS-004) enables **Immediate Implementation** - no waiting for Salesforce admin team to configure VCI External ID\n\nThe decisions are **mutually reinforcing** - each choice makes the others more valuable or feasible.\n\n==== What This Establishes for Future Work\n\nThis implementation is the **architectural foundation** for OTR's target state:\n\n* **First bounded contexts** - ProfileService and EngagementService establish the pattern for LoyaltyService, PaymentService, LocationService, RecommendationService\n* **First event-driven integration** - Event Bus pattern reused for all future bounded context integration (not direct API calls)\n* **Reusable Contact reconciliation** - ProfileService Contact lookup reused for Flybuys partner linking, subscription billing, personalised recommendations\n* **Anti-Corruption Layer pattern** - EngagementService ACL demonstrates how to protect OTR domain model from external systems (EagleEye, Braze, D365 Commerce)\n* **Conformist pattern for shared systems** - Establishes approach for systems we don't control (Salesforce, Entra ID, Microsoft Fabric)\n\nEvery design decision is made with **future bounded contexts in mind** - we're not just solving customer support, we're establishing the architectural standards for all future work.\n","structuredPatch":[{"oldStart":34,"oldLines":28,"newStart":34,"newLines":29,"lines":[" "," ==== Why Async Processing Instead of Synchronous API Calls?"," ","-The decision to create Salesforce Cases **asynchronously via Event Bus** (ADR-CS-003) rather than synchronously in the API request path reflects a prioritisation of user experience and resilience over simplicity:","+When integrating with external systems, the decision between asynchronous and synchronous processing reflects a prioritization of user experience, resilience, and system characteristics:"," "," *The Problem with Synchronous Integration*:"," ","-* User waits for Salesforce API response (latency: Mobile App → EngagementService → Salesforce → EngagementService → Mobile App)","-* If Salesforce is down or slow, customer feedback submission fails","-* No automatic retry - customer must resubmit feedback","-* API timeout must accommodate worst-case Salesforce latency","+* User waits for external system API response (latency across multiple system hops)","+* If external system is down or slow, user-facing operations fail","+* No automatic retry - users must manually retry operations","+* API timeout must accommodate worst-case external system latency","+* Tight coupling between user experience and external system performance"," "," *The Async Solution*:"," ","-* **Immediate acknowledgment** - User gets \"Feedback submitted\" confirmation in <200ms (no Salesforce wait)","-* **Resilience** - If Salesforce is down, feedback queued, Case created when Salesforce recovers","-* **Automatic retry** - Exponential backoff handles transient Salesforce API failures","+* **Immediate acknowledgment** - User gets confirmation quickly (no external system wait)","+* **Resilience** - If external system is down, work queued and processed when system recovers","+* **Automatic retry** - Exponential backoff handles transient API failures"," * **Operational visibility** - Dead letter queue alerts ops team to persistent failures","-* **Scalability** - Queue buffering handles traffic spikes (expected 100-150 submissions/day, capacity for 10x)","+* **Scalability** - Queue buffering handles traffic spikes without overwhelming external systems"," "," *The Trade-Off*:"," ","-We accept **eventual consistency** (user receives push notification after Case created, not immediately) and **increased complexity** (Event Bus, background workers, retry logic, DLQ monitoring) in exchange for **better user experience** (no waiting) and **resilience** (Salesforce downtime doesn't block customer feedback).","+We accept **eventual consistency** (notifications delivered after external processing completes) and **increased complexity** (Event Bus, background workers, retry logic, DLQ monitoring) in exchange for **better user experience** (no waiting) and **resilience** (external system downtime doesn't block user-facing operations)."," ","-This trade-off is acceptable because customer support feedback is **not a real-time transaction** (unlike payment processing). A 30-second delay between feedback submission and Case creation is invisible to the customer, who receives a push notification when the Case is created.","+This trade-off is acceptable when operations are **not real-time transactions** (unlike payment processing). When business processes can tolerate short delays (seconds to minutes), async processing improves both user experience and system resilience."," "," ==== Why Conformist Pattern for Salesforce?"," "]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"531b5797-a493-4c8e-ac25-6c8792ef7479"}
{"parentUuid":"ddb385c5-f4bd-4850-b555-d4cd437fa297","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_015Z1hQYRpe24QhDZXPZUunc","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now let me generalize the Conformist Pattern section to not be Salesforce-specific.","signature":"EvsBCkYICxgCKkBmUD0EJzSvX9PnvpjoG7DF25jFZSnaqQ3nc64MWyD2FvIIKMrXwZcu2cg0Ju/oD0shV00wo34yfFfzduOxzZLIEgyDV21PwQIrj8nqs3oaDG96GNb+V0CE+YAKbiIwuhg6khyCOjBCEVAW04qo+jUc+aT1iCk3ZaX3C3TDdMA4MbnriORhFnPxKJvfvv0FKmOVqoOkXGtS23XAqvjqydK844YHRbsf6h3SHlGqYQEE9EIfZFYeEu3ok7/bEmA7d3Oor/iKY+i0PYHCXgobkKGMuyIh3guflxYINeE09RXrBOwLzgZDCHDNrufy2NvoJkDRht8YAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":1591,"cache_read_input_tokens":39745,"cache_creation":{"ephemeral_5m_input_tokens":1591,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWuP7MAmN6jrwsGeisqsG","type":"assistant","uuid":"1c2432c4-40e9-4ff7-bfc4-fe0da2dd74af","timestamp":"2026-01-08T05:46:09.974Z"}
{"parentUuid":"1c2432c4-40e9-4ff7-bfc4-fe0da2dd74af","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_015Z1hQYRpe24QhDZXPZUunc","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01PUiF2QMHPCLXAWgx7F8VjF","name":"Edit","input":{"replace_all":false,"file_path":"/mnt/c/Users/o.young/work/architecture/architectural_approach.adoc","old_string":"==== Why Conformist Pattern for Salesforce?\n\nThe decision to **conform to Salesforce configuration** (ADR-CS-015) rather than heavily customise Salesforce or abstract away its API reflects a pragmatic acceptance of organisational reality:\n\n*The Organisational Context*:\n\n* **Shared Salesforce instance** - Viva Energy owns and operates the Salesforce Service Cloud instance\n* **Multi-tenant governance** - OTR is one business unit among many (fuel wholesale, Shell Card, other retail channels)\n* **Viva Energy controls roadmap** - We don't control Salesforce configuration, custom fields, or API evolution\n* **Post-merger integration** - Strategic decision to standardize on Viva Energy platforms (not build parallel systems)\n\n*The Conformist Approach*:\n\n* **Accept their data model** - Use standard Contact and Case objects with Viva Energy-configured fields\n* **Conform to their API** - Use Salesforce REST API as-is, minimal custom Apex code\n* **Work within their governance** - Data isolation via Record Types/queues (TBD with Salesforce admin team)\n* **Anti-Corruption Layer protects us** - EngagementService translates between OTR domain language and Salesforce, but doesn't fight Salesforce's model\n\n*Why Not Heavily Customise Salesforce?*:\n\n* **Governance constraints** - Viva Energy Salesforce team must approve all customisations (slow, requires business case)\n* **Shared instance risk** - Custom Apex code or triggers could impact other business units (change control overhead)\n* **Upgrade risk** - Heavy customisation increases Salesforce upgrade complexity\n* **Not our system** - We don't control the platform, so we shouldn't over-invest in customisation we can't maintain\n\n*The Trade-Off*:\n\nWe accept **less control over data model and platform evolution** in exchange for **faster time-to-value** (no custom development in Salesforce), **reduced operational overhead** (no custom code to maintain), and **organisational alignment** (consolidate onto shared Viva Energy platforms).\n\nThe **Anti-Corruption Layer** (EngagementService) is the protection mechanism - it translates between OTR's domain language and Salesforce, so if Salesforce changes, we update the ACL, not the Mobile App.","new_string":"==== Why Conformist Pattern for Shared Platforms?\n\nWhen integrating with shared platforms controlled by other organisations or business units, the Conformist pattern reflects a pragmatic acceptance of organisational reality:\n\n*The Organisational Context*:\n\n* **Shared platform governance** - Another organisation or business unit owns and operates the platform\n* **Multi-tenant environment** - OTR is one user among many (competing priorities, shared governance)\n* **Limited control** - We don't control platform configuration, data models, or API evolution\n* **Strategic alignment** - Organisational decision to standardize on shared platforms (not build parallel systems)\n\n*The Conformist Approach*:\n\n* **Accept their data model** - Use platform-provided objects and fields with minimal customisation\n* **Conform to their API** - Use platform APIs as-is, avoid heavy customisation\n* **Work within their governance** - Data isolation via platform mechanisms (tenancy, record types, permissions)\n* **Anti-Corruption Layer protects us** - Bounded contexts translate between OTR domain language and platform models\n\n*Why Not Heavily Customise Shared Platforms?*:\n\n* **Governance constraints** - Platform owners must approve all customisations (slow, requires business case justification)\n* **Shared instance risk** - Custom code or triggers could impact other users (change control overhead)\n* **Upgrade risk** - Heavy customisation increases platform upgrade complexity and testing burden\n* **Limited control** - We don't control the platform, so we shouldn't over-invest in customisation we can't maintain\n* **Vendor lock-in** - Deep customisation makes platform migration more difficult if strategic direction changes\n\n*The Trade-Off*:\n\nWe accept **less control over data model and platform evolution** in exchange for **faster time-to-value** (minimal custom development), **reduced operational overhead** (less custom code to maintain), and **organisational alignment** (consolidate onto shared platforms).\n\nThe **Anti-Corruption Layer** is the protection mechanism - it translates between OTR's domain language and the platform, so platform changes are isolated to the ACL, not propagated to digital channels."}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":1591,"cache_read_input_tokens":39745,"cache_creation":{"ephemeral_5m_input_tokens":1591,"ephemeral_1h_input_tokens":0},"output_tokens":1167,"service_tier":"standard"}},"requestId":"req_011CWuP7MAmN6jrwsGeisqsG","type":"assistant","uuid":"d80c5372-51da-42fe-a245-ac9ab1626aa0","timestamp":"2026-01-08T05:46:32.348Z"}
{"parentUuid":"d80c5372-51da-42fe-a245-ac9ab1626aa0","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01PUiF2QMHPCLXAWgx7F8VjF","type":"tool_result","content":"The file /mnt/c/Users/o.young/work/architecture/architectural_approach.adoc has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n    57→We accept **eventual consistency** (notifications delivered after external processing completes) and **increased complexity** (Event Bus, background workers, retry logic, DLQ monitoring) in exchange for **better user experience** (no waiting) and **resilience** (external system downtime doesn't block user-facing operations).\n    58→\n    59→This trade-off is acceptable when operations are **not real-time transactions** (unlike payment processing). When business processes can tolerate short delays (seconds to minutes), async processing improves both user experience and system resilience.\n    60→\n    61→==== Why Conformist Pattern for Shared Platforms?\n    62→\n    63→When integrating with shared platforms controlled by other organisations or business units, the Conformist pattern reflects a pragmatic acceptance of organisational reality:\n    64→\n    65→*The Organisational Context*:\n    66→\n    67→* **Shared platform governance** - Another organisation or business unit owns and operates the platform\n    68→* **Multi-tenant environment** - OTR is one user among many (competing priorities, shared governance)\n    69→* **Limited control** - We don't control platform configuration, data models, or API evolution\n    70→* **Strategic alignment** - Organisational decision to standardize on shared platforms (not build parallel systems)\n    71→\n    72→*The Conformist Approach*:\n    73→\n    74→* **Accept their data model** - Use platform-provided objects and fields with minimal customisation\n    75→* **Conform to their API** - Use platform APIs as-is, avoid heavy customisation\n    76→* **Work within their governance** - Data isolation via platform mechanisms (tenancy, record types, permissions)\n    77→* **Anti-Corruption Layer protects us** - Bounded contexts translate between OTR domain language and platform models\n    78→\n    79→*Why Not Heavily Customise Shared Platforms?*:\n    80→\n    81→* **Governance constraints** - Platform owners must approve all customisations (slow, requires business case justification)\n    82→* **Shared instance risk** - Custom code or triggers could impact other users (change control overhead)\n    83→* **Upgrade risk** - Heavy customisation increases platform upgrade complexity and testing burden\n    84→* **Limited control** - We don't control the platform, so we shouldn't over-invest in customisation we can't maintain\n    85→* **Vendor lock-in** - Deep customisation makes platform migration more difficult if strategic direction changes\n    86→\n    87→*The Trade-Off*:\n    88→\n    89→We accept **less control over data model and platform evolution** in exchange for **faster time-to-value** (minimal custom development), **reduced operational overhead** (less custom code to maintain), and **organisational alignment** (consolidate onto shared platforms).\n    90→\n    91→The **Anti-Corruption Layer** is the protection mechanism - it translates between OTR's domain language and the platform, so platform changes are isolated to the ACL, not propagated to digital channels.\n    92→\n    93→==== Why Big Bang Cutover Instead of Phased Rollout?\n    94→\n    95→The decision to use **big bang cutover** (ADR-CS-006) rather than phased rollout with feature flags (like the Flybuys integration uses) reflects a risk assessment based on criticality and complexity:"}]},"uuid":"b0a278fa-110a-4a4b-ba96-7b66e9ce639c","timestamp":"2026-01-08T05:46:32.573Z","toolUseResult":{"filePath":"/mnt/c/Users/o.young/work/architecture/architectural_approach.adoc","oldString":"==== Why Conformist Pattern for Salesforce?\n\nThe decision to **conform to Salesforce configuration** (ADR-CS-015) rather than heavily customise Salesforce or abstract away its API reflects a pragmatic acceptance of organisational reality:\n\n*The Organisational Context*:\n\n* **Shared Salesforce instance** - Viva Energy owns and operates the Salesforce Service Cloud instance\n* **Multi-tenant governance** - OTR is one business unit among many (fuel wholesale, Shell Card, other retail channels)\n* **Viva Energy controls roadmap** - We don't control Salesforce configuration, custom fields, or API evolution\n* **Post-merger integration** - Strategic decision to standardize on Viva Energy platforms (not build parallel systems)\n\n*The Conformist Approach*:\n\n* **Accept their data model** - Use standard Contact and Case objects with Viva Energy-configured fields\n* **Conform to their API** - Use Salesforce REST API as-is, minimal custom Apex code\n* **Work within their governance** - Data isolation via Record Types/queues (TBD with Salesforce admin team)\n* **Anti-Corruption Layer protects us** - EngagementService translates between OTR domain language and Salesforce, but doesn't fight Salesforce's model\n\n*Why Not Heavily Customise Salesforce?*:\n\n* **Governance constraints** - Viva Energy Salesforce team must approve all customisations (slow, requires business case)\n* **Shared instance risk** - Custom Apex code or triggers could impact other business units (change control overhead)\n* **Upgrade risk** - Heavy customisation increases Salesforce upgrade complexity\n* **Not our system** - We don't control the platform, so we shouldn't over-invest in customisation we can't maintain\n\n*The Trade-Off*:\n\nWe accept **less control over data model and platform evolution** in exchange for **faster time-to-value** (no custom development in Salesforce), **reduced operational overhead** (no custom code to maintain), and **organisational alignment** (consolidate onto shared Viva Energy platforms).\n\nThe **Anti-Corruption Layer** (EngagementService) is the protection mechanism - it translates between OTR's domain language and Salesforce, so if Salesforce changes, we update the ACL, not the Mobile App.","newString":"==== Why Conformist Pattern for Shared Platforms?\n\nWhen integrating with shared platforms controlled by other organisations or business units, the Conformist pattern reflects a pragmatic acceptance of organisational reality:\n\n*The Organisational Context*:\n\n* **Shared platform governance** - Another organisation or business unit owns and operates the platform\n* **Multi-tenant environment** - OTR is one user among many (competing priorities, shared governance)\n* **Limited control** - We don't control platform configuration, data models, or API evolution\n* **Strategic alignment** - Organisational decision to standardize on shared platforms (not build parallel systems)\n\n*The Conformist Approach*:\n\n* **Accept their data model** - Use platform-provided objects and fields with minimal customisation\n* **Conform to their API** - Use platform APIs as-is, avoid heavy customisation\n* **Work within their governance** - Data isolation via platform mechanisms (tenancy, record types, permissions)\n* **Anti-Corruption Layer protects us** - Bounded contexts translate between OTR domain language and platform models\n\n*Why Not Heavily Customise Shared Platforms?*:\n\n* **Governance constraints** - Platform owners must approve all customisations (slow, requires business case justification)\n* **Shared instance risk** - Custom code or triggers could impact other users (change control overhead)\n* **Upgrade risk** - Heavy customisation increases platform upgrade complexity and testing burden\n* **Limited control** - We don't control the platform, so we shouldn't over-invest in customisation we can't maintain\n* **Vendor lock-in** - Deep customisation makes platform migration more difficult if strategic direction changes\n\n*The Trade-Off*:\n\nWe accept **less control over data model and platform evolution** in exchange for **faster time-to-value** (minimal custom development), **reduced operational overhead** (less custom code to maintain), and **organisational alignment** (consolidate onto shared platforms).\n\nThe **Anti-Corruption Layer** is the protection mechanism - it translates between OTR's domain language and the platform, so platform changes are isolated to the ACL, not propagated to digital channels.","originalFile":"==== Strategic Architectural Philosophy\n\nThis solution architecture aligns with OTR's target Domain-Driven Design (DDD) architecture. The design choices reflect three core principles:\n\n1. **Protect digital channels from external system coupling** - Use Anti-Corruption Layers (ACLs) to isolate OTR's domain model from external systems we don't control\n2. **Establish event-driven architecture as the integration standard** - Loose coupling between bounded contexts via domain events, enabling independent evolution\n3. **Prioritise simplicity and time-to-value** - Make pragmatic trade-offs that reduce complexity while establishing architectural patterns for future work\n\n==== Why Domain-Driven Design with Bounded Contexts?\n\nThe decision to implement bounded contexts rather than direct integration to external systems reflects a strategic investment in architectural quality:\n\n*The Problem with Direct Integration*:\n\n* Digital channels (Mobile App, Web) tightly coupled to external system APIs (any external change breaks clients)\n* External systems controlled by vendors or other business units - we conform to their governance and configuration\n* Future integrations duplicate common logic (identity reconciliation, event translation, error handling)\n* No domain event publishing - other services can't react to business events\n* Business logic scattered across client applications instead of centralized in domain services\n\n*The DDD Solution*:\n\n* **Bounded contexts** isolate domain concerns with clear responsibility boundaries\n* **Anti-Corruption Layers (ACLs)** translate between OTR domain language and external system models\n* **Event Bus** publishes domain events - other bounded contexts can react without tight coupling\n* **Reusable components** - common logic (identity, authorization, event translation) centralized once, used by many\n* **Clear boundaries** - each context handles specific domain capabilities (different responsibilities, different change rates)\n\n*The Trade-Off*:\n\nWe accept **increased initial complexity** (additional services, Event Bus infrastructure, team learning DDD patterns) in exchange for **architectural foundation** that protects digital channels from external system changes and enables reusable components for future work.\n\nThis is a **strategic investment** - we're not just solving immediate integration needs, we're establishing the architectural pattern for all future bounded contexts.\n\n==== Why Async Processing Instead of Synchronous API Calls?\n\nWhen integrating with external systems, the decision between asynchronous and synchronous processing reflects a prioritization of user experience, resilience, and system characteristics:\n\n*The Problem with Synchronous Integration*:\n\n* User waits for external system API response (latency across multiple system hops)\n* If external system is down or slow, user-facing operations fail\n* No automatic retry - users must manually retry operations\n* API timeout must accommodate worst-case external system latency\n* Tight coupling between user experience and external system performance\n\n*The Async Solution*:\n\n* **Immediate acknowledgment** - User gets confirmation quickly (no external system wait)\n* **Resilience** - If external system is down, work queued and processed when system recovers\n* **Automatic retry** - Exponential backoff handles transient API failures\n* **Operational visibility** - Dead letter queue alerts ops team to persistent failures\n* **Scalability** - Queue buffering handles traffic spikes without overwhelming external systems\n\n*The Trade-Off*:\n\nWe accept **eventual consistency** (notifications delivered after external processing completes) and **increased complexity** (Event Bus, background workers, retry logic, DLQ monitoring) in exchange for **better user experience** (no waiting) and **resilience** (external system downtime doesn't block user-facing operations).\n\nThis trade-off is acceptable when operations are **not real-time transactions** (unlike payment processing). When business processes can tolerate short delays (seconds to minutes), async processing improves both user experience and system resilience.\n\n==== Why Conformist Pattern for Salesforce?\n\nThe decision to **conform to Salesforce configuration** (ADR-CS-015) rather than heavily customise Salesforce or abstract away its API reflects a pragmatic acceptance of organisational reality:\n\n*The Organisational Context*:\n\n* **Shared Salesforce instance** - Viva Energy owns and operates the Salesforce Service Cloud instance\n* **Multi-tenant governance** - OTR is one business unit among many (fuel wholesale, Shell Card, other retail channels)\n* **Viva Energy controls roadmap** - We don't control Salesforce configuration, custom fields, or API evolution\n* **Post-merger integration** - Strategic decision to standardize on Viva Energy platforms (not build parallel systems)\n\n*The Conformist Approach*:\n\n* **Accept their data model** - Use standard Contact and Case objects with Viva Energy-configured fields\n* **Conform to their API** - Use Salesforce REST API as-is, minimal custom Apex code\n* **Work within their governance** - Data isolation via Record Types/queues (TBD with Salesforce admin team)\n* **Anti-Corruption Layer protects us** - EngagementService translates between OTR domain language and Salesforce, but doesn't fight Salesforce's model\n\n*Why Not Heavily Customise Salesforce?*:\n\n* **Governance constraints** - Viva Energy Salesforce team must approve all customisations (slow, requires business case)\n* **Shared instance risk** - Custom Apex code or triggers could impact other business units (change control overhead)\n* **Upgrade risk** - Heavy customisation increases Salesforce upgrade complexity\n* **Not our system** - We don't control the platform, so we shouldn't over-invest in customisation we can't maintain\n\n*The Trade-Off*:\n\nWe accept **less control over data model and platform evolution** in exchange for **faster time-to-value** (no custom development in Salesforce), **reduced operational overhead** (no custom code to maintain), and **organisational alignment** (consolidate onto shared Viva Energy platforms).\n\nThe **Anti-Corruption Layer** (EngagementService) is the protection mechanism - it translates between OTR's domain language and Salesforce, so if Salesforce changes, we update the ACL, not the Mobile App.\n\n==== Why Big Bang Cutover Instead of Phased Rollout?\n\nThe decision to use **big bang cutover** (ADR-CS-006) rather than phased rollout with feature flags (like the Flybuys integration uses) reflects a risk assessment based on criticality and complexity:\n\n*Why Flybuys Uses Phased Rollout (AS-1, AS-2, AS-3)*:\n\n* **High complexity** - Flybuys points accrual involves transaction adjudication, partner API integration, reconciliation\n* **Mission-critical** - Points accrual errors directly impact customer value and partner agreements\n* **Large user base** - All OTR loyalty members (gradual enablement reduces blast radius)\n* **Reversibility challenge** - Once points awarded to Flybuys, reversal requires partner coordination\n\n*Why Customer Support Uses Big Bang*:\n\n* **Lower complexity** - Feedback submission is create-only operation (no complex state management)\n* **Not mission-critical** - Support feedback failure doesn't prevent app usage or transactions\n* **Manageable user base** - OTR digital customers smaller than total loyalty member base\n* **Easy rollback** - Can revert to D365 CE if critical issues (no partner coordination required)\n* **Faster D365 CE retirement** - No extended transition period maintaining two systems\n\n*The Trade-Off*:\n\nWe accept **higher cutover risk** (all users switch at once) in exchange for **simplicity** (no feature flag management), **faster D365 CE retirement** (no parallel run period), and **reduced transition complexity** (no AS-1/AS-2/AS-3 architecture states).\n\nThe risk is mitigated by:\n\n* **Comprehensive testing** - Load testing (3x-10x expected volume), integration testing, UAT\n* **Rollback plan** - Can revert Mobile App to D365 CE if critical issues within 48 hours\n* **Non-critical workload** - Support feedback failure doesn't block core app functionality\n\nThis is a **pragmatic trade-off** - we use the simplest migration strategy that matches the risk profile of the workload.\n\n==== Why No Case Migration from D365 CE?\n\nThe decision to **not migrate historical Cases** (ADR-CS-005) reflects a cost-benefit analysis that prioritises speed and simplicity over historical data preservation:\n\n*The Case for Migration*:\n\n* Support agents could see historical customer support Cases in Salesforce\n* Continuity of support history for repeat issues\n* Analytics and reporting on historical Case trends\n\n*The Case Against Migration*:\n\n* **Limited value** - Historical D365 CE Cases not critical for future support (new Cases moving forward)\n* **Data quality concerns** - D365 CE Case data may be inconsistent, incomplete, or poorly categorised\n* **Migration complexity** - Requires mapping D365 CE schema to Salesforce, data transformation, validation, testing\n* **Delays cutover** - Case migration extends timeline (Contact migration only is faster)\n* **Cost-benefit** - Migration effort (4-6 weeks) outweighs value of historical data\n\n*The Alternative*:\n\nIf historical Cases are needed, D365 CE can remain accessible (read-only) temporarily for lookups, or Cases can be archived separately.\n\n*The Trade-Off*:\n\nWe accept **loss of historical Case visibility in Salesforce** in exchange for **faster time-to-value** (Contact migration only), **simpler migration** (no Case schema mapping), and **clean start** (no legacy data quality issues).\n\nThis is a **pragmatic simplification** - historical support Cases provide marginal value compared to the migration effort required.\n\n==== Why Email as Primary Matching Key (Not VCI)?\n\nThe decision to use **email as the primary Contact matching key** (ADR-CS-004) rather than Viva Consumer ID (VCI) reflects a pragmatic choice based on current system capabilities:\n\n*Why Not VCI?*:\n\n* **Not in Salesforce today** - VCI is not currently stored as Salesforce External ID (requires Salesforce admin team to add field and configure upsert)\n* **Adds coordination overhead** - Requires Viva Energy Salesforce team approval, field creation, indexing, testing\n* **Delays cutover** - Email-based matching can start immediately, VCI matching requires Salesforce configuration work\n\n*Why Email Works*:\n\n* **Available now** - Salesforce Contact already has email field (standard, indexed)\n* **Unique identifier** - Email is unique in both Salesforce and Mobile App authentication\n* **Always available** - Authenticated users always have email from Entra ID JWT\n* **Salesforce standard** - Email is standard Contact lookup field (no custom configuration)\n\n*The Edge Case*:\n\n* **Email change** - If customer changes email, creates duplicate Contact (rare, manual cleanup acceptable)\n\n*Future Enhancement*:\n\n* Add VCI as Salesforce External ID (more stable matching)\n* Migrate to VCI-based matching once Salesforce configuration is complete\n\n*The Trade-Off*:\n\nWe accept **rare duplicate Contact creation** (when customers change email) in exchange for **immediate implementation** (no Salesforce configuration required) and **simplicity** (single matching key).\n\nThis is a **pragmatic starting point** - we can enhance to VCI-based matching later without breaking existing functionality.\n\n==== How the Decisions Reinforce Each Other\n\nThe architectural decisions form a **coherent strategy** rather than isolated choices:\n\n1. **DDD Bounded Contexts** (ADR-CS-002) establish the foundation for **Event-Driven Architecture** (ADR-CS-003) - ProfileService and EngagementService publish domain events that other bounded contexts consume\n2. **Async Processing** (ADR-CS-003) enables **Resilience to Salesforce Downtime** - the Event Bus buffers work when Salesforce is unavailable\n3. **Conformist Pattern** (ADR-CS-015) is protected by **Anti-Corruption Layer** - EngagementService conforms to Salesforce but isolates the Mobile App from Salesforce API changes\n4. **Big Bang Cutover** (ADR-CS-006) is feasible because **Customer Support is Non-Critical** - unlike payment processing or Flybuys points accrual, support feedback failure doesn't block core app functionality\n5. **No Case Migration** (ADR-CS-005) simplifies the **Big Bang Cutover** - Contact migration only is faster and lower risk\n6. **Email Matching** (ADR-CS-004) enables **Immediate Implementation** - no waiting for Salesforce admin team to configure VCI External ID\n\nThe decisions are **mutually reinforcing** - each choice makes the others more valuable or feasible.\n\n==== What This Establishes for Future Work\n\nThis implementation is the **architectural foundation** for OTR's target state:\n\n* **First bounded contexts** - ProfileService and EngagementService establish the pattern for LoyaltyService, PaymentService, LocationService, RecommendationService\n* **First event-driven integration** - Event Bus pattern reused for all future bounded context integration (not direct API calls)\n* **Reusable Contact reconciliation** - ProfileService Contact lookup reused for Flybuys partner linking, subscription billing, personalised recommendations\n* **Anti-Corruption Layer pattern** - EngagementService ACL demonstrates how to protect OTR domain model from external systems (EagleEye, Braze, D365 Commerce)\n* **Conformist pattern for shared systems** - Establishes approach for systems we don't control (Salesforce, Entra ID, Microsoft Fabric)\n\nEvery design decision is made with **future bounded contexts in mind** - we're not just solving customer support, we're establishing the architectural standards for all future work.\n","structuredPatch":[{"oldStart":58,"oldLines":36,"newStart":58,"newLines":37,"lines":[" "," This trade-off is acceptable when operations are **not real-time transactions** (unlike payment processing). When business processes can tolerate short delays (seconds to minutes), async processing improves both user experience and system resilience."," ","-==== Why Conformist Pattern for Salesforce?","+==== Why Conformist Pattern for Shared Platforms?"," ","-The decision to **conform to Salesforce configuration** (ADR-CS-015) rather than heavily customise Salesforce or abstract away its API reflects a pragmatic acceptance of organisational reality:","+When integrating with shared platforms controlled by other organisations or business units, the Conformist pattern reflects a pragmatic acceptance of organisational reality:"," "," *The Organisational Context*:"," ","-* **Shared Salesforce instance** - Viva Energy owns and operates the Salesforce Service Cloud instance","-* **Multi-tenant governance** - OTR is one business unit among many (fuel wholesale, Shell Card, other retail channels)","-* **Viva Energy controls roadmap** - We don't control Salesforce configuration, custom fields, or API evolution","-* **Post-merger integration** - Strategic decision to standardize on Viva Energy platforms (not build parallel systems)","+* **Shared platform governance** - Another organisation or business unit owns and operates the platform","+* **Multi-tenant environment** - OTR is one user among many (competing priorities, shared governance)","+* **Limited control** - We don't control platform configuration, data models, or API evolution","+* **Strategic alignment** - Organisational decision to standardize on shared platforms (not build parallel systems)"," "," *The Conformist Approach*:"," ","-* **Accept their data model** - Use standard Contact and Case objects with Viva Energy-configured fields","-* **Conform to their API** - Use Salesforce REST API as-is, minimal custom Apex code","-* **Work within their governance** - Data isolation via Record Types/queues (TBD with Salesforce admin team)","-* **Anti-Corruption Layer protects us** - EngagementService translates between OTR domain language and Salesforce, but doesn't fight Salesforce's model","+* **Accept their data model** - Use platform-provided objects and fields with minimal customisation","+* **Conform to their API** - Use platform APIs as-is, avoid heavy customisation","+* **Work within their governance** - Data isolation via platform mechanisms (tenancy, record types, permissions)","+* **Anti-Corruption Layer protects us** - Bounded contexts translate between OTR domain language and platform models"," ","-*Why Not Heavily Customise Salesforce?*:","+*Why Not Heavily Customise Shared Platforms?*:"," ","-* **Governance constraints** - Viva Energy Salesforce team must approve all customisations (slow, requires business case)","-* **Shared instance risk** - Custom Apex code or triggers could impact other business units (change control overhead)","-* **Upgrade risk** - Heavy customisation increases Salesforce upgrade complexity","-* **Not our system** - We don't control the platform, so we shouldn't over-invest in customisation we can't maintain","+* **Governance constraints** - Platform owners must approve all customisations (slow, requires business case justification)","+* **Shared instance risk** - Custom code or triggers could impact other users (change control overhead)","+* **Upgrade risk** - Heavy customisation increases platform upgrade complexity and testing burden","+* **Limited control** - We don't control the platform, so we shouldn't over-invest in customisation we can't maintain","+* **Vendor lock-in** - Deep customisation makes platform migration more difficult if strategic direction changes"," "," *The Trade-Off*:"," ","-We accept **less control over data model and platform evolution** in exchange for **faster time-to-value** (no custom development in Salesforce), **reduced operational overhead** (no custom code to maintain), and **organisational alignment** (consolidate onto shared Viva Energy platforms).","+We accept **less control over data model and platform evolution** in exchange for **faster time-to-value** (minimal custom development), **reduced operational overhead** (less custom code to maintain), and **organisational alignment** (consolidate onto shared platforms)."," ","-The **Anti-Corruption Layer** (EngagementService) is the protection mechanism - it translates between OTR's domain language and Salesforce, so if Salesforce changes, we update the ACL, not the Mobile App.","+The **Anti-Corruption Layer** is the protection mechanism - it translates between OTR's domain language and the platform, so platform changes are isolated to the ACL, not propagated to digital channels."," "," ==== Why Big Bang Cutover Instead of Phased Rollout?"," "]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"d80c5372-51da-42fe-a245-ac9ab1626aa0"}
{"parentUuid":"b0a278fa-110a-4a4b-ba96-7b66e9ce639c","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01TeRanMnTm4MdjnNcBdXK5B","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now let me generalize the Big Bang vs Phased section to make it more about the decision criteria rather than comparing specific projects.","signature":"ErICCkYICxgCKkCoJkbPOZzSWMJrMm+3oUp/mXmZAs/hIj22iripZKcIMwsA+ZebujVw0g6RzmY13aoWwrZB9hqR7BfGBSRF0S05Egw268bhAzsT/2Xdp24aDIClXBk2pWEqNYkw0yIwN71Vt5xSGhG9bdjiXvHxdf0XYDiN8IKJQRx3WImEqLZJWaPO9CC2Uuy9M9j2jo3BKpkBKsFwo02gHNkspZP9iyLXSk+XluFJAGcc1UFTPOeoyzKai44FGkEW8vXyTNrjKrzNzopTxoCRDvpbyV0X8rdEhXMLSl1aYH1AI6URE2MX/M7sENPixhwLqHaXHDLhycQ4t6C2z0URYEex7wgkzqv74VyVxAg1cpIOJRc1oThoB5hIZQcZcOtdKf2xluWpukFo5HS/yQGGzbMSGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":9,"cache_creation_input_tokens":2021,"cache_read_input_tokens":41336,"cache_creation":{"ephemeral_5m_input_tokens":2021,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWuP9HS68mNvV7W8UbVKm","type":"assistant","uuid":"6d25e8f6-d7b7-4681-a6f6-f5f4dd5759fe","timestamp":"2026-01-08T05:46:36.874Z"}
{"parentUuid":"6d25e8f6-d7b7-4681-a6f6-f5f4dd5759fe","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01TeRanMnTm4MdjnNcBdXK5B","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01J7x1hbXsyoxrYYHc8hs4Xb","name":"Edit","input":{"replace_all":false,"file_path":"/mnt/c/Users/o.young/work/architecture/architectural_approach.adoc","old_string":"==== Why Big Bang Cutover Instead of Phased Rollout?\n\nThe decision to use **big bang cutover** (ADR-CS-006) rather than phased rollout with feature flags (like the Flybuys integration uses) reflects a risk assessment based on criticality and complexity:\n\n*Why Flybuys Uses Phased Rollout (AS-1, AS-2, AS-3)*:\n\n* **High complexity** - Flybuys points accrual involves transaction adjudication, partner API integration, reconciliation\n* **Mission-critical** - Points accrual errors directly impact customer value and partner agreements\n* **Large user base** - All OTR loyalty members (gradual enablement reduces blast radius)\n* **Reversibility challenge** - Once points awarded to Flybuys, reversal requires partner coordination\n\n*Why Customer Support Uses Big Bang*:\n\n* **Lower complexity** - Feedback submission is create-only operation (no complex state management)\n* **Not mission-critical** - Support feedback failure doesn't prevent app usage or transactions\n* **Manageable user base** - OTR digital customers smaller than total loyalty member base\n* **Easy rollback** - Can revert to D365 CE if critical issues (no partner coordination required)\n* **Faster D365 CE retirement** - No extended transition period maintaining two systems\n\n*The Trade-Off*:\n\nWe accept **higher cutover risk** (all users switch at once) in exchange for **simplicity** (no feature flag management), **faster D365 CE retirement** (no parallel run period), and **reduced transition complexity** (no AS-1/AS-2/AS-3 architecture states).\n\nThe risk is mitigated by:\n\n* **Comprehensive testing** - Load testing (3x-10x expected volume), integration testing, UAT\n* **Rollback plan** - Can revert Mobile App to D365 CE if critical issues within 48 hours\n* **Non-critical workload** - Support feedback failure doesn't block core app functionality\n\nThis is a **pragmatic trade-off** - we use the simplest migration strategy that matches the risk profile of the workload.","new_string":"==== When to Use Big Bang Cutover vs. Phased Rollout?\n\nThe choice between big bang cutover and phased rollout with feature flags reflects a risk assessment based on criticality, complexity, and reversibility:\n\n*When Phased Rollout is Appropriate*:\n\n* **High complexity** - Multiple system integrations, complex state management, transaction adjudication\n* **Mission-critical** - Errors directly impact customer value, revenue, or contractual obligations\n* **Large user base** - Gradual enablement reduces blast radius for defects\n* **Reversibility challenge** - Operations involve external parties or are difficult/impossible to reverse\n* **Data synchronization complexity** - Dual-write or data coexistence patterns required\n* **Regulatory requirements** - Compliance testing needed before full deployment\n\n*When Big Bang Cutover is Appropriate*:\n\n* **Lower complexity** - Simple CRUD operations, minimal state management\n* **Not mission-critical** - Failures don't prevent core business operations\n* **Manageable user base** - Impact contained to specific user segment\n* **Easy rollback** - Can revert to legacy system without data loss or partner coordination\n* **Faster legacy retirement** - No extended transition period maintaining two systems\n* **Simple feature** - Read-only operations or create-only workflows\n\n*The Trade-Off*:\n\nPhased rollout accepts **increased complexity** (feature flag management, transition architecture states, dual-write patterns) in exchange for **reduced risk** (gradual enablement, controlled blast radius, early defect detection).\n\nBig bang accepts **higher cutover risk** (all users switch at once) in exchange for **simplicity** (no feature flag management), **faster legacy system retirement** (no parallel run period), and **reduced transition complexity** (no intermediate architecture states).\n\n*Risk Mitigation for Big Bang*:\n\n* **Comprehensive testing** - Load testing at expected peak volume, integration testing, UAT\n* **Rollback plan** - Clear criteria and procedure to revert if critical issues emerge\n* **Non-blocking deployment** - Cutover doesn't prevent core operations if new system fails\n* **Limited blast radius** - Failure impacts specific capability, not entire platform\n\nChoose the migration strategy that matches the risk profile and business criticality of the capability being migrated."}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":9,"cache_creation_input_tokens":2021,"cache_read_input_tokens":41336,"cache_creation":{"ephemeral_5m_input_tokens":2021,"ephemeral_1h_input_tokens":0},"output_tokens":1157,"service_tier":"standard"}},"requestId":"req_011CWuP9HS68mNvV7W8UbVKm","type":"assistant","uuid":"6a483a47-f05c-4169-aa77-0331f860b42a","timestamp":"2026-01-08T05:46:59.639Z"}
{"parentUuid":"6a483a47-f05c-4169-aa77-0331f860b42a","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01J7x1hbXsyoxrYYHc8hs4Xb","type":"tool_result","content":"The file /mnt/c/Users/o.young/work/architecture/architectural_approach.adoc has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n    89→We accept **less control over data model and platform evolution** in exchange for **faster time-to-value** (minimal custom development), **reduced operational overhead** (less custom code to maintain), and **organisational alignment** (consolidate onto shared platforms).\n    90→\n    91→The **Anti-Corruption Layer** is the protection mechanism - it translates between OTR's domain language and the platform, so platform changes are isolated to the ACL, not propagated to digital channels.\n    92→\n    93→==== When to Use Big Bang Cutover vs. Phased Rollout?\n    94→\n    95→The choice between big bang cutover and phased rollout with feature flags reflects a risk assessment based on criticality, complexity, and reversibility:\n    96→\n    97→*When Phased Rollout is Appropriate*:\n    98→\n    99→* **High complexity** - Multiple system integrations, complex state management, transaction adjudication\n   100→* **Mission-critical** - Errors directly impact customer value, revenue, or contractual obligations\n   101→* **Large user base** - Gradual enablement reduces blast radius for defects\n   102→* **Reversibility challenge** - Operations involve external parties or are difficult/impossible to reverse\n   103→* **Data synchronization complexity** - Dual-write or data coexistence patterns required\n   104→* **Regulatory requirements** - Compliance testing needed before full deployment\n   105→\n   106→*When Big Bang Cutover is Appropriate*:\n   107→\n   108→* **Lower complexity** - Simple CRUD operations, minimal state management\n   109→* **Not mission-critical** - Failures don't prevent core business operations\n   110→* **Manageable user base** - Impact contained to specific user segment\n   111→* **Easy rollback** - Can revert to legacy system without data loss or partner coordination\n   112→* **Faster legacy retirement** - No extended transition period maintaining two systems\n   113→* **Simple feature** - Read-only operations or create-only workflows\n   114→\n   115→*The Trade-Off*:\n   116→\n   117→Phased rollout accepts **increased complexity** (feature flag management, transition architecture states, dual-write patterns) in exchange for **reduced risk** (gradual enablement, controlled blast radius, early defect detection).\n   118→\n   119→Big bang accepts **higher cutover risk** (all users switch at once) in exchange for **simplicity** (no feature flag management), **faster legacy system retirement** (no parallel run period), and **reduced transition complexity** (no intermediate architecture states).\n   120→\n   121→*Risk Mitigation for Big Bang*:\n   122→\n   123→* **Comprehensive testing** - Load testing at expected peak volume, integration testing, UAT\n   124→* **Rollback plan** - Clear criteria and procedure to revert if critical issues emerge\n   125→* **Non-blocking deployment** - Cutover doesn't prevent core operations if new system fails\n   126→* **Limited blast radius** - Failure impacts specific capability, not entire platform\n   127→\n   128→Choose the migration strategy that matches the risk profile and business criticality of the capability being migrated.\n   129→\n   130→==== Why No Case Migration from D365 CE?\n   131→\n   132→The decision to **not migrate historical Cases** (ADR-CS-005) reflects a cost-benefit analysis that prioritises speed and simplicity over historical data preservation:"}]},"uuid":"13f54183-9330-407d-9c15-1d4f60044c9a","timestamp":"2026-01-08T05:46:59.858Z","toolUseResult":{"filePath":"/mnt/c/Users/o.young/work/architecture/architectural_approach.adoc","oldString":"==== Why Big Bang Cutover Instead of Phased Rollout?\n\nThe decision to use **big bang cutover** (ADR-CS-006) rather than phased rollout with feature flags (like the Flybuys integration uses) reflects a risk assessment based on criticality and complexity:\n\n*Why Flybuys Uses Phased Rollout (AS-1, AS-2, AS-3)*:\n\n* **High complexity** - Flybuys points accrual involves transaction adjudication, partner API integration, reconciliation\n* **Mission-critical** - Points accrual errors directly impact customer value and partner agreements\n* **Large user base** - All OTR loyalty members (gradual enablement reduces blast radius)\n* **Reversibility challenge** - Once points awarded to Flybuys, reversal requires partner coordination\n\n*Why Customer Support Uses Big Bang*:\n\n* **Lower complexity** - Feedback submission is create-only operation (no complex state management)\n* **Not mission-critical** - Support feedback failure doesn't prevent app usage or transactions\n* **Manageable user base** - OTR digital customers smaller than total loyalty member base\n* **Easy rollback** - Can revert to D365 CE if critical issues (no partner coordination required)\n* **Faster D365 CE retirement** - No extended transition period maintaining two systems\n\n*The Trade-Off*:\n\nWe accept **higher cutover risk** (all users switch at once) in exchange for **simplicity** (no feature flag management), **faster D365 CE retirement** (no parallel run period), and **reduced transition complexity** (no AS-1/AS-2/AS-3 architecture states).\n\nThe risk is mitigated by:\n\n* **Comprehensive testing** - Load testing (3x-10x expected volume), integration testing, UAT\n* **Rollback plan** - Can revert Mobile App to D365 CE if critical issues within 48 hours\n* **Non-critical workload** - Support feedback failure doesn't block core app functionality\n\nThis is a **pragmatic trade-off** - we use the simplest migration strategy that matches the risk profile of the workload.","newString":"==== When to Use Big Bang Cutover vs. Phased Rollout?\n\nThe choice between big bang cutover and phased rollout with feature flags reflects a risk assessment based on criticality, complexity, and reversibility:\n\n*When Phased Rollout is Appropriate*:\n\n* **High complexity** - Multiple system integrations, complex state management, transaction adjudication\n* **Mission-critical** - Errors directly impact customer value, revenue, or contractual obligations\n* **Large user base** - Gradual enablement reduces blast radius for defects\n* **Reversibility challenge** - Operations involve external parties or are difficult/impossible to reverse\n* **Data synchronization complexity** - Dual-write or data coexistence patterns required\n* **Regulatory requirements** - Compliance testing needed before full deployment\n\n*When Big Bang Cutover is Appropriate*:\n\n* **Lower complexity** - Simple CRUD operations, minimal state management\n* **Not mission-critical** - Failures don't prevent core business operations\n* **Manageable user base** - Impact contained to specific user segment\n* **Easy rollback** - Can revert to legacy system without data loss or partner coordination\n* **Faster legacy retirement** - No extended transition period maintaining two systems\n* **Simple feature** - Read-only operations or create-only workflows\n\n*The Trade-Off*:\n\nPhased rollout accepts **increased complexity** (feature flag management, transition architecture states, dual-write patterns) in exchange for **reduced risk** (gradual enablement, controlled blast radius, early defect detection).\n\nBig bang accepts **higher cutover risk** (all users switch at once) in exchange for **simplicity** (no feature flag management), **faster legacy system retirement** (no parallel run period), and **reduced transition complexity** (no intermediate architecture states).\n\n*Risk Mitigation for Big Bang*:\n\n* **Comprehensive testing** - Load testing at expected peak volume, integration testing, UAT\n* **Rollback plan** - Clear criteria and procedure to revert if critical issues emerge\n* **Non-blocking deployment** - Cutover doesn't prevent core operations if new system fails\n* **Limited blast radius** - Failure impacts specific capability, not entire platform\n\nChoose the migration strategy that matches the risk profile and business criticality of the capability being migrated.","originalFile":"==== Strategic Architectural Philosophy\n\nThis solution architecture aligns with OTR's target Domain-Driven Design (DDD) architecture. The design choices reflect three core principles:\n\n1. **Protect digital channels from external system coupling** - Use Anti-Corruption Layers (ACLs) to isolate OTR's domain model from external systems we don't control\n2. **Establish event-driven architecture as the integration standard** - Loose coupling between bounded contexts via domain events, enabling independent evolution\n3. **Prioritise simplicity and time-to-value** - Make pragmatic trade-offs that reduce complexity while establishing architectural patterns for future work\n\n==== Why Domain-Driven Design with Bounded Contexts?\n\nThe decision to implement bounded contexts rather than direct integration to external systems reflects a strategic investment in architectural quality:\n\n*The Problem with Direct Integration*:\n\n* Digital channels (Mobile App, Web) tightly coupled to external system APIs (any external change breaks clients)\n* External systems controlled by vendors or other business units - we conform to their governance and configuration\n* Future integrations duplicate common logic (identity reconciliation, event translation, error handling)\n* No domain event publishing - other services can't react to business events\n* Business logic scattered across client applications instead of centralized in domain services\n\n*The DDD Solution*:\n\n* **Bounded contexts** isolate domain concerns with clear responsibility boundaries\n* **Anti-Corruption Layers (ACLs)** translate between OTR domain language and external system models\n* **Event Bus** publishes domain events - other bounded contexts can react without tight coupling\n* **Reusable components** - common logic (identity, authorization, event translation) centralized once, used by many\n* **Clear boundaries** - each context handles specific domain capabilities (different responsibilities, different change rates)\n\n*The Trade-Off*:\n\nWe accept **increased initial complexity** (additional services, Event Bus infrastructure, team learning DDD patterns) in exchange for **architectural foundation** that protects digital channels from external system changes and enables reusable components for future work.\n\nThis is a **strategic investment** - we're not just solving immediate integration needs, we're establishing the architectural pattern for all future bounded contexts.\n\n==== Why Async Processing Instead of Synchronous API Calls?\n\nWhen integrating with external systems, the decision between asynchronous and synchronous processing reflects a prioritization of user experience, resilience, and system characteristics:\n\n*The Problem with Synchronous Integration*:\n\n* User waits for external system API response (latency across multiple system hops)\n* If external system is down or slow, user-facing operations fail\n* No automatic retry - users must manually retry operations\n* API timeout must accommodate worst-case external system latency\n* Tight coupling between user experience and external system performance\n\n*The Async Solution*:\n\n* **Immediate acknowledgment** - User gets confirmation quickly (no external system wait)\n* **Resilience** - If external system is down, work queued and processed when system recovers\n* **Automatic retry** - Exponential backoff handles transient API failures\n* **Operational visibility** - Dead letter queue alerts ops team to persistent failures\n* **Scalability** - Queue buffering handles traffic spikes without overwhelming external systems\n\n*The Trade-Off*:\n\nWe accept **eventual consistency** (notifications delivered after external processing completes) and **increased complexity** (Event Bus, background workers, retry logic, DLQ monitoring) in exchange for **better user experience** (no waiting) and **resilience** (external system downtime doesn't block user-facing operations).\n\nThis trade-off is acceptable when operations are **not real-time transactions** (unlike payment processing). When business processes can tolerate short delays (seconds to minutes), async processing improves both user experience and system resilience.\n\n==== Why Conformist Pattern for Shared Platforms?\n\nWhen integrating with shared platforms controlled by other organisations or business units, the Conformist pattern reflects a pragmatic acceptance of organisational reality:\n\n*The Organisational Context*:\n\n* **Shared platform governance** - Another organisation or business unit owns and operates the platform\n* **Multi-tenant environment** - OTR is one user among many (competing priorities, shared governance)\n* **Limited control** - We don't control platform configuration, data models, or API evolution\n* **Strategic alignment** - Organisational decision to standardize on shared platforms (not build parallel systems)\n\n*The Conformist Approach*:\n\n* **Accept their data model** - Use platform-provided objects and fields with minimal customisation\n* **Conform to their API** - Use platform APIs as-is, avoid heavy customisation\n* **Work within their governance** - Data isolation via platform mechanisms (tenancy, record types, permissions)\n* **Anti-Corruption Layer protects us** - Bounded contexts translate between OTR domain language and platform models\n\n*Why Not Heavily Customise Shared Platforms?*:\n\n* **Governance constraints** - Platform owners must approve all customisations (slow, requires business case justification)\n* **Shared instance risk** - Custom code or triggers could impact other users (change control overhead)\n* **Upgrade risk** - Heavy customisation increases platform upgrade complexity and testing burden\n* **Limited control** - We don't control the platform, so we shouldn't over-invest in customisation we can't maintain\n* **Vendor lock-in** - Deep customisation makes platform migration more difficult if strategic direction changes\n\n*The Trade-Off*:\n\nWe accept **less control over data model and platform evolution** in exchange for **faster time-to-value** (minimal custom development), **reduced operational overhead** (less custom code to maintain), and **organisational alignment** (consolidate onto shared platforms).\n\nThe **Anti-Corruption Layer** is the protection mechanism - it translates between OTR's domain language and the platform, so platform changes are isolated to the ACL, not propagated to digital channels.\n\n==== Why Big Bang Cutover Instead of Phased Rollout?\n\nThe decision to use **big bang cutover** (ADR-CS-006) rather than phased rollout with feature flags (like the Flybuys integration uses) reflects a risk assessment based on criticality and complexity:\n\n*Why Flybuys Uses Phased Rollout (AS-1, AS-2, AS-3)*:\n\n* **High complexity** - Flybuys points accrual involves transaction adjudication, partner API integration, reconciliation\n* **Mission-critical** - Points accrual errors directly impact customer value and partner agreements\n* **Large user base** - All OTR loyalty members (gradual enablement reduces blast radius)\n* **Reversibility challenge** - Once points awarded to Flybuys, reversal requires partner coordination\n\n*Why Customer Support Uses Big Bang*:\n\n* **Lower complexity** - Feedback submission is create-only operation (no complex state management)\n* **Not mission-critical** - Support feedback failure doesn't prevent app usage or transactions\n* **Manageable user base** - OTR digital customers smaller than total loyalty member base\n* **Easy rollback** - Can revert to D365 CE if critical issues (no partner coordination required)\n* **Faster D365 CE retirement** - No extended transition period maintaining two systems\n\n*The Trade-Off*:\n\nWe accept **higher cutover risk** (all users switch at once) in exchange for **simplicity** (no feature flag management), **faster D365 CE retirement** (no parallel run period), and **reduced transition complexity** (no AS-1/AS-2/AS-3 architecture states).\n\nThe risk is mitigated by:\n\n* **Comprehensive testing** - Load testing (3x-10x expected volume), integration testing, UAT\n* **Rollback plan** - Can revert Mobile App to D365 CE if critical issues within 48 hours\n* **Non-critical workload** - Support feedback failure doesn't block core app functionality\n\nThis is a **pragmatic trade-off** - we use the simplest migration strategy that matches the risk profile of the workload.\n\n==== Why No Case Migration from D365 CE?\n\nThe decision to **not migrate historical Cases** (ADR-CS-005) reflects a cost-benefit analysis that prioritises speed and simplicity over historical data preservation:\n\n*The Case for Migration*:\n\n* Support agents could see historical customer support Cases in Salesforce\n* Continuity of support history for repeat issues\n* Analytics and reporting on historical Case trends\n\n*The Case Against Migration*:\n\n* **Limited value** - Historical D365 CE Cases not critical for future support (new Cases moving forward)\n* **Data quality concerns** - D365 CE Case data may be inconsistent, incomplete, or poorly categorised\n* **Migration complexity** - Requires mapping D365 CE schema to Salesforce, data transformation, validation, testing\n* **Delays cutover** - Case migration extends timeline (Contact migration only is faster)\n* **Cost-benefit** - Migration effort (4-6 weeks) outweighs value of historical data\n\n*The Alternative*:\n\nIf historical Cases are needed, D365 CE can remain accessible (read-only) temporarily for lookups, or Cases can be archived separately.\n\n*The Trade-Off*:\n\nWe accept **loss of historical Case visibility in Salesforce** in exchange for **faster time-to-value** (Contact migration only), **simpler migration** (no Case schema mapping), and **clean start** (no legacy data quality issues).\n\nThis is a **pragmatic simplification** - historical support Cases provide marginal value compared to the migration effort required.\n\n==== Why Email as Primary Matching Key (Not VCI)?\n\nThe decision to use **email as the primary Contact matching key** (ADR-CS-004) rather than Viva Consumer ID (VCI) reflects a pragmatic choice based on current system capabilities:\n\n*Why Not VCI?*:\n\n* **Not in Salesforce today** - VCI is not currently stored as Salesforce External ID (requires Salesforce admin team to add field and configure upsert)\n* **Adds coordination overhead** - Requires Viva Energy Salesforce team approval, field creation, indexing, testing\n* **Delays cutover** - Email-based matching can start immediately, VCI matching requires Salesforce configuration work\n\n*Why Email Works*:\n\n* **Available now** - Salesforce Contact already has email field (standard, indexed)\n* **Unique identifier** - Email is unique in both Salesforce and Mobile App authentication\n* **Always available** - Authenticated users always have email from Entra ID JWT\n* **Salesforce standard** - Email is standard Contact lookup field (no custom configuration)\n\n*The Edge Case*:\n\n* **Email change** - If customer changes email, creates duplicate Contact (rare, manual cleanup acceptable)\n\n*Future Enhancement*:\n\n* Add VCI as Salesforce External ID (more stable matching)\n* Migrate to VCI-based matching once Salesforce configuration is complete\n\n*The Trade-Off*:\n\nWe accept **rare duplicate Contact creation** (when customers change email) in exchange for **immediate implementation** (no Salesforce configuration required) and **simplicity** (single matching key).\n\nThis is a **pragmatic starting point** - we can enhance to VCI-based matching later without breaking existing functionality.\n\n==== How the Decisions Reinforce Each Other\n\nThe architectural decisions form a **coherent strategy** rather than isolated choices:\n\n1. **DDD Bounded Contexts** (ADR-CS-002) establish the foundation for **Event-Driven Architecture** (ADR-CS-003) - ProfileService and EngagementService publish domain events that other bounded contexts consume\n2. **Async Processing** (ADR-CS-003) enables **Resilience to Salesforce Downtime** - the Event Bus buffers work when Salesforce is unavailable\n3. **Conformist Pattern** (ADR-CS-015) is protected by **Anti-Corruption Layer** - EngagementService conforms to Salesforce but isolates the Mobile App from Salesforce API changes\n4. **Big Bang Cutover** (ADR-CS-006) is feasible because **Customer Support is Non-Critical** - unlike payment processing or Flybuys points accrual, support feedback failure doesn't block core app functionality\n5. **No Case Migration** (ADR-CS-005) simplifies the **Big Bang Cutover** - Contact migration only is faster and lower risk\n6. **Email Matching** (ADR-CS-004) enables **Immediate Implementation** - no waiting for Salesforce admin team to configure VCI External ID\n\nThe decisions are **mutually reinforcing** - each choice makes the others more valuable or feasible.\n\n==== What This Establishes for Future Work\n\nThis implementation is the **architectural foundation** for OTR's target state:\n\n* **First bounded contexts** - ProfileService and EngagementService establish the pattern for LoyaltyService, PaymentService, LocationService, RecommendationService\n* **First event-driven integration** - Event Bus pattern reused for all future bounded context integration (not direct API calls)\n* **Reusable Contact reconciliation** - ProfileService Contact lookup reused for Flybuys partner linking, subscription billing, personalised recommendations\n* **Anti-Corruption Layer pattern** - EngagementService ACL demonstrates how to protect OTR domain model from external systems (EagleEye, Braze, D365 Commerce)\n* **Conformist pattern for shared systems** - Establishes approach for systems we don't control (Salesforce, Entra ID, Microsoft Fabric)\n\nEvery design decision is made with **future bounded contexts in mind** - we're not just solving customer support, we're establishing the architectural standards for all future work.\n","structuredPatch":[{"oldStart":90,"oldLines":37,"newStart":90,"newLines":43,"lines":[" "," The **Anti-Corruption Layer** is the protection mechanism - it translates between OTR's domain language and the platform, so platform changes are isolated to the ACL, not propagated to digital channels."," ","-==== Why Big Bang Cutover Instead of Phased Rollout?","+==== When to Use Big Bang Cutover vs. Phased Rollout?"," ","-The decision to use **big bang cutover** (ADR-CS-006) rather than phased rollout with feature flags (like the Flybuys integration uses) reflects a risk assessment based on criticality and complexity:","+The choice between big bang cutover and phased rollout with feature flags reflects a risk assessment based on criticality, complexity, and reversibility:"," ","-*Why Flybuys Uses Phased Rollout (AS-1, AS-2, AS-3)*:","+*When Phased Rollout is Appropriate*:"," ","-* **High complexity** - Flybuys points accrual involves transaction adjudication, partner API integration, reconciliation","-* **Mission-critical** - Points accrual errors directly impact customer value and partner agreements","-* **Large user base** - All OTR loyalty members (gradual enablement reduces blast radius)","-* **Reversibility challenge** - Once points awarded to Flybuys, reversal requires partner coordination","+* **High complexity** - Multiple system integrations, complex state management, transaction adjudication","+* **Mission-critical** - Errors directly impact customer value, revenue, or contractual obligations","+* **Large user base** - Gradual enablement reduces blast radius for defects","+* **Reversibility challenge** - Operations involve external parties or are difficult/impossible to reverse","+* **Data synchronization complexity** - Dual-write or data coexistence patterns required","+* **Regulatory requirements** - Compliance testing needed before full deployment"," ","-*Why Customer Support Uses Big Bang*:","+*When Big Bang Cutover is Appropriate*:"," ","-* **Lower complexity** - Feedback submission is create-only operation (no complex state management)","-* **Not mission-critical** - Support feedback failure doesn't prevent app usage or transactions","-* **Manageable user base** - OTR digital customers smaller than total loyalty member base","-* **Easy rollback** - Can revert to D365 CE if critical issues (no partner coordination required)","-* **Faster D365 CE retirement** - No extended transition period maintaining two systems","+* **Lower complexity** - Simple CRUD operations, minimal state management","+* **Not mission-critical** - Failures don't prevent core business operations","+* **Manageable user base** - Impact contained to specific user segment","+* **Easy rollback** - Can revert to legacy system without data loss or partner coordination","+* **Faster legacy retirement** - No extended transition period maintaining two systems","+* **Simple feature** - Read-only operations or create-only workflows"," "," *The Trade-Off*:"," ","-We accept **higher cutover risk** (all users switch at once) in exchange for **simplicity** (no feature flag management), **faster D365 CE retirement** (no parallel run period), and **reduced transition complexity** (no AS-1/AS-2/AS-3 architecture states).","+Phased rollout accepts **increased complexity** (feature flag management, transition architecture states, dual-write patterns) in exchange for **reduced risk** (gradual enablement, controlled blast radius, early defect detection)."," ","-The risk is mitigated by:","+Big bang accepts **higher cutover risk** (all users switch at once) in exchange for **simplicity** (no feature flag management), **faster legacy system retirement** (no parallel run period), and **reduced transition complexity** (no intermediate architecture states)."," ","-* **Comprehensive testing** - Load testing (3x-10x expected volume), integration testing, UAT","-* **Rollback plan** - Can revert Mobile App to D365 CE if critical issues within 48 hours","-* **Non-critical workload** - Support feedback failure doesn't block core app functionality","+*Risk Mitigation for Big Bang*:"," ","-This is a **pragmatic trade-off** - we use the simplest migration strategy that matches the risk profile of the workload.","+* **Comprehensive testing** - Load testing at expected peak volume, integration testing, UAT","+* **Rollback plan** - Clear criteria and procedure to revert if critical issues emerge","+* **Non-blocking deployment** - Cutover doesn't prevent core operations if new system fails","+* **Limited blast radius** - Failure impacts specific capability, not entire platform"," ","+Choose the migration strategy that matches the risk profile and business criticality of the capability being migrated.","+"," ==== Why No Case Migration from D365 CE?"," "," The decision to **not migrate historical Cases** (ADR-CS-005) reflects a cost-benefit analysis that prioritises speed and simplicity over historical data preservation:"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"6a483a47-f05c-4169-aa77-0331f860b42a"}
{"parentUuid":"13f54183-9330-407d-9c15-1d4f60044c9a","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01SpnG3TM9tTnqw2wyL8zQDn","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now let me generalize the historical data migration section.","signature":"EuQBCkYICxgCKkAswSDir8S7f946xiIPJkdT62bQkLJAW4LlkwEXpQ7NfTFnzXM/Lcuc32Yf1tlwiNtLQhwGNwj1tqBaf658y1XeEgwsN/iHtHHE5t4lz3YaDBBFOV56fnZ8MLb35yIwnW3mx+7OnxqBBc6CwAg/K83RaASRewxp93Mcw2ANyVEiFsHRATf/X6/QLfFv2a/EKkzpp5w6JwealDanlCcv6ye8qBanmbnaNs6uU9/dv9J0+3ghd+/wcxBNTUbRIT5vnZ4j/dLUyn99X3p0fi4IckB+T+kuVaL/k+MTX7G1GAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":2134,"cache_read_input_tokens":43357,"cache_creation":{"ephemeral_5m_input_tokens":2134,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWuPBJ5LiPL3gaepZYcdo","type":"assistant","uuid":"e585ea64-dbed-4fb0-b441-8c9ebfc9f2de","timestamp":"2026-01-08T05:47:04.180Z"}
{"parentUuid":"e585ea64-dbed-4fb0-b441-8c9ebfc9f2de","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01SpnG3TM9tTnqw2wyL8zQDn","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01E5TTzDPau1VBposW5tbu15","name":"Edit","input":{"replace_all":false,"file_path":"/mnt/c/Users/o.young/work/architecture/architectural_approach.adoc","old_string":"==== Why No Case Migration from D365 CE?\n\nThe decision to **not migrate historical Cases** (ADR-CS-005) reflects a cost-benefit analysis that prioritises speed and simplicity over historical data preservation:\n\n*The Case for Migration*:\n\n* Support agents could see historical customer support Cases in Salesforce\n* Continuity of support history for repeat issues\n* Analytics and reporting on historical Case trends\n\n*The Case Against Migration*:\n\n* **Limited value** - Historical D365 CE Cases not critical for future support (new Cases moving forward)\n* **Data quality concerns** - D365 CE Case data may be inconsistent, incomplete, or poorly categorised\n* **Migration complexity** - Requires mapping D365 CE schema to Salesforce, data transformation, validation, testing\n* **Delays cutover** - Case migration extends timeline (Contact migration only is faster)\n* **Cost-benefit** - Migration effort (4-6 weeks) outweighs value of historical data\n\n*The Alternative*:\n\nIf historical Cases are needed, D365 CE can remain accessible (read-only) temporarily for lookups, or Cases can be archived separately.\n\n*The Trade-Off*:\n\nWe accept **loss of historical Case visibility in Salesforce** in exchange for **faster time-to-value** (Contact migration only), **simpler migration** (no Case schema mapping), and **clean start** (no legacy data quality issues).\n\nThis is a **pragmatic simplification** - historical support Cases provide marginal value compared to the migration effort required.","new_string":"==== When to Migrate Historical Data vs. Fresh Start?\n\nThe decision to migrate historical data from legacy systems reflects a cost-benefit analysis that balances historical continuity with migration complexity:\n\n*The Case for Historical Data Migration*:\n\n* Users can access complete historical records in the new system\n* Continuity of business context for ongoing processes (customer history, audit trails)\n* Analytics and reporting across full historical timeline\n* Regulatory or compliance requirements for data retention\n* Business processes that reference historical data\n\n*The Case Against Historical Data Migration*:\n\n* **Limited operational value** - Historical data not critical for future operations (new data moving forward)\n* **Data quality concerns** - Legacy data may be inconsistent, incomplete, or poorly categorised\n* **Migration complexity** - Requires schema mapping, data transformation, validation, testing, reconciliation\n* **Delays cutover** - Data migration extends timeline significantly\n* **Cost-benefit imbalance** - Migration effort outweighs practical value of historical data\n* **Reference data only** - Historical data rarely updated, mainly used for lookups\n\n*Alternative Approaches*:\n\n* Legacy system remains accessible (read-only) temporarily for historical lookups\n* Data archived separately (data warehouse, static reports, export files)\n* Selective migration - only recent or high-value historical records\n* On-demand migration - migrate historical data only when needed for specific use cases\n\n*The Trade-Off*:\n\nHistorical data migration accepts **increased migration complexity** (schema mapping, transformation, validation) and **extended timeline** in exchange for **complete data continuity** in the new system.\n\nFresh start accepts **loss of historical data in new system** in exchange for **faster time-to-value**, **simpler migration** (no historical schema mapping), and **clean start** (no legacy data quality issues).\n\nChoose the approach that matches the business value of historical data against the cost and timeline impact of migration."}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":2134,"cache_read_input_tokens":43357,"cache_creation":{"ephemeral_5m_input_tokens":2134,"ephemeral_1h_input_tokens":0},"output_tokens":902,"service_tier":"standard"}},"requestId":"req_011CWuPBJ5LiPL3gaepZYcdo","type":"assistant","uuid":"f0f1dd89-dea2-428b-9424-31511650786f","timestamp":"2026-01-08T05:47:22.557Z"}
{"parentUuid":"f0f1dd89-dea2-428b-9424-31511650786f","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01E5TTzDPau1VBposW5tbu15","type":"tool_result","content":"The file /mnt/c/Users/o.young/work/architecture/architectural_approach.adoc has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n   126→* **Limited blast radius** - Failure impacts specific capability, not entire platform\n   127→\n   128→Choose the migration strategy that matches the risk profile and business criticality of the capability being migrated.\n   129→\n   130→==== When to Migrate Historical Data vs. Fresh Start?\n   131→\n   132→The decision to migrate historical data from legacy systems reflects a cost-benefit analysis that balances historical continuity with migration complexity:\n   133→\n   134→*The Case for Historical Data Migration*:\n   135→\n   136→* Users can access complete historical records in the new system\n   137→* Continuity of business context for ongoing processes (customer history, audit trails)\n   138→* Analytics and reporting across full historical timeline\n   139→* Regulatory or compliance requirements for data retention\n   140→* Business processes that reference historical data\n   141→\n   142→*The Case Against Historical Data Migration*:\n   143→\n   144→* **Limited operational value** - Historical data not critical for future operations (new data moving forward)\n   145→* **Data quality concerns** - Legacy data may be inconsistent, incomplete, or poorly categorised\n   146→* **Migration complexity** - Requires schema mapping, data transformation, validation, testing, reconciliation\n   147→* **Delays cutover** - Data migration extends timeline significantly\n   148→* **Cost-benefit imbalance** - Migration effort outweighs practical value of historical data\n   149→* **Reference data only** - Historical data rarely updated, mainly used for lookups\n   150→\n   151→*Alternative Approaches*:\n   152→\n   153→* Legacy system remains accessible (read-only) temporarily for historical lookups\n   154→* Data archived separately (data warehouse, static reports, export files)\n   155→* Selective migration - only recent or high-value historical records\n   156→* On-demand migration - migrate historical data only when needed for specific use cases\n   157→\n   158→*The Trade-Off*:\n   159→\n   160→Historical data migration accepts **increased migration complexity** (schema mapping, transformation, validation) and **extended timeline** in exchange for **complete data continuity** in the new system.\n   161→\n   162→Fresh start accepts **loss of historical data in new system** in exchange for **faster time-to-value**, **simpler migration** (no historical schema mapping), and **clean start** (no legacy data quality issues).\n   163→\n   164→Choose the approach that matches the business value of historical data against the cost and timeline impact of migration.\n   165→\n   166→==== Why Email as Primary Matching Key (Not VCI)?\n   167→\n   168→The decision to use **email as the primary Contact matching key** (ADR-CS-004) rather than Viva Consumer ID (VCI) reflects a pragmatic choice based on current system capabilities:"}]},"uuid":"79960ceb-2a29-49a9-b2bc-2f2111948c5b","timestamp":"2026-01-08T05:47:22.831Z","toolUseResult":{"filePath":"/mnt/c/Users/o.young/work/architecture/architectural_approach.adoc","oldString":"==== Why No Case Migration from D365 CE?\n\nThe decision to **not migrate historical Cases** (ADR-CS-005) reflects a cost-benefit analysis that prioritises speed and simplicity over historical data preservation:\n\n*The Case for Migration*:\n\n* Support agents could see historical customer support Cases in Salesforce\n* Continuity of support history for repeat issues\n* Analytics and reporting on historical Case trends\n\n*The Case Against Migration*:\n\n* **Limited value** - Historical D365 CE Cases not critical for future support (new Cases moving forward)\n* **Data quality concerns** - D365 CE Case data may be inconsistent, incomplete, or poorly categorised\n* **Migration complexity** - Requires mapping D365 CE schema to Salesforce, data transformation, validation, testing\n* **Delays cutover** - Case migration extends timeline (Contact migration only is faster)\n* **Cost-benefit** - Migration effort (4-6 weeks) outweighs value of historical data\n\n*The Alternative*:\n\nIf historical Cases are needed, D365 CE can remain accessible (read-only) temporarily for lookups, or Cases can be archived separately.\n\n*The Trade-Off*:\n\nWe accept **loss of historical Case visibility in Salesforce** in exchange for **faster time-to-value** (Contact migration only), **simpler migration** (no Case schema mapping), and **clean start** (no legacy data quality issues).\n\nThis is a **pragmatic simplification** - historical support Cases provide marginal value compared to the migration effort required.","newString":"==== When to Migrate Historical Data vs. Fresh Start?\n\nThe decision to migrate historical data from legacy systems reflects a cost-benefit analysis that balances historical continuity with migration complexity:\n\n*The Case for Historical Data Migration*:\n\n* Users can access complete historical records in the new system\n* Continuity of business context for ongoing processes (customer history, audit trails)\n* Analytics and reporting across full historical timeline\n* Regulatory or compliance requirements for data retention\n* Business processes that reference historical data\n\n*The Case Against Historical Data Migration*:\n\n* **Limited operational value** - Historical data not critical for future operations (new data moving forward)\n* **Data quality concerns** - Legacy data may be inconsistent, incomplete, or poorly categorised\n* **Migration complexity** - Requires schema mapping, data transformation, validation, testing, reconciliation\n* **Delays cutover** - Data migration extends timeline significantly\n* **Cost-benefit imbalance** - Migration effort outweighs practical value of historical data\n* **Reference data only** - Historical data rarely updated, mainly used for lookups\n\n*Alternative Approaches*:\n\n* Legacy system remains accessible (read-only) temporarily for historical lookups\n* Data archived separately (data warehouse, static reports, export files)\n* Selective migration - only recent or high-value historical records\n* On-demand migration - migrate historical data only when needed for specific use cases\n\n*The Trade-Off*:\n\nHistorical data migration accepts **increased migration complexity** (schema mapping, transformation, validation) and **extended timeline** in exchange for **complete data continuity** in the new system.\n\nFresh start accepts **loss of historical data in new system** in exchange for **faster time-to-value**, **simpler migration** (no historical schema mapping), and **clean start** (no legacy data quality issues).\n\nChoose the approach that matches the business value of historical data against the cost and timeline impact of migration.","originalFile":"==== Strategic Architectural Philosophy\n\nThis solution architecture aligns with OTR's target Domain-Driven Design (DDD) architecture. The design choices reflect three core principles:\n\n1. **Protect digital channels from external system coupling** - Use Anti-Corruption Layers (ACLs) to isolate OTR's domain model from external systems we don't control\n2. **Establish event-driven architecture as the integration standard** - Loose coupling between bounded contexts via domain events, enabling independent evolution\n3. **Prioritise simplicity and time-to-value** - Make pragmatic trade-offs that reduce complexity while establishing architectural patterns for future work\n\n==== Why Domain-Driven Design with Bounded Contexts?\n\nThe decision to implement bounded contexts rather than direct integration to external systems reflects a strategic investment in architectural quality:\n\n*The Problem with Direct Integration*:\n\n* Digital channels (Mobile App, Web) tightly coupled to external system APIs (any external change breaks clients)\n* External systems controlled by vendors or other business units - we conform to their governance and configuration\n* Future integrations duplicate common logic (identity reconciliation, event translation, error handling)\n* No domain event publishing - other services can't react to business events\n* Business logic scattered across client applications instead of centralized in domain services\n\n*The DDD Solution*:\n\n* **Bounded contexts** isolate domain concerns with clear responsibility boundaries\n* **Anti-Corruption Layers (ACLs)** translate between OTR domain language and external system models\n* **Event Bus** publishes domain events - other bounded contexts can react without tight coupling\n* **Reusable components** - common logic (identity, authorization, event translation) centralized once, used by many\n* **Clear boundaries** - each context handles specific domain capabilities (different responsibilities, different change rates)\n\n*The Trade-Off*:\n\nWe accept **increased initial complexity** (additional services, Event Bus infrastructure, team learning DDD patterns) in exchange for **architectural foundation** that protects digital channels from external system changes and enables reusable components for future work.\n\nThis is a **strategic investment** - we're not just solving immediate integration needs, we're establishing the architectural pattern for all future bounded contexts.\n\n==== Why Async Processing Instead of Synchronous API Calls?\n\nWhen integrating with external systems, the decision between asynchronous and synchronous processing reflects a prioritization of user experience, resilience, and system characteristics:\n\n*The Problem with Synchronous Integration*:\n\n* User waits for external system API response (latency across multiple system hops)\n* If external system is down or slow, user-facing operations fail\n* No automatic retry - users must manually retry operations\n* API timeout must accommodate worst-case external system latency\n* Tight coupling between user experience and external system performance\n\n*The Async Solution*:\n\n* **Immediate acknowledgment** - User gets confirmation quickly (no external system wait)\n* **Resilience** - If external system is down, work queued and processed when system recovers\n* **Automatic retry** - Exponential backoff handles transient API failures\n* **Operational visibility** - Dead letter queue alerts ops team to persistent failures\n* **Scalability** - Queue buffering handles traffic spikes without overwhelming external systems\n\n*The Trade-Off*:\n\nWe accept **eventual consistency** (notifications delivered after external processing completes) and **increased complexity** (Event Bus, background workers, retry logic, DLQ monitoring) in exchange for **better user experience** (no waiting) and **resilience** (external system downtime doesn't block user-facing operations).\n\nThis trade-off is acceptable when operations are **not real-time transactions** (unlike payment processing). When business processes can tolerate short delays (seconds to minutes), async processing improves both user experience and system resilience.\n\n==== Why Conformist Pattern for Shared Platforms?\n\nWhen integrating with shared platforms controlled by other organisations or business units, the Conformist pattern reflects a pragmatic acceptance of organisational reality:\n\n*The Organisational Context*:\n\n* **Shared platform governance** - Another organisation or business unit owns and operates the platform\n* **Multi-tenant environment** - OTR is one user among many (competing priorities, shared governance)\n* **Limited control** - We don't control platform configuration, data models, or API evolution\n* **Strategic alignment** - Organisational decision to standardize on shared platforms (not build parallel systems)\n\n*The Conformist Approach*:\n\n* **Accept their data model** - Use platform-provided objects and fields with minimal customisation\n* **Conform to their API** - Use platform APIs as-is, avoid heavy customisation\n* **Work within their governance** - Data isolation via platform mechanisms (tenancy, record types, permissions)\n* **Anti-Corruption Layer protects us** - Bounded contexts translate between OTR domain language and platform models\n\n*Why Not Heavily Customise Shared Platforms?*:\n\n* **Governance constraints** - Platform owners must approve all customisations (slow, requires business case justification)\n* **Shared instance risk** - Custom code or triggers could impact other users (change control overhead)\n* **Upgrade risk** - Heavy customisation increases platform upgrade complexity and testing burden\n* **Limited control** - We don't control the platform, so we shouldn't over-invest in customisation we can't maintain\n* **Vendor lock-in** - Deep customisation makes platform migration more difficult if strategic direction changes\n\n*The Trade-Off*:\n\nWe accept **less control over data model and platform evolution** in exchange for **faster time-to-value** (minimal custom development), **reduced operational overhead** (less custom code to maintain), and **organisational alignment** (consolidate onto shared platforms).\n\nThe **Anti-Corruption Layer** is the protection mechanism - it translates between OTR's domain language and the platform, so platform changes are isolated to the ACL, not propagated to digital channels.\n\n==== When to Use Big Bang Cutover vs. Phased Rollout?\n\nThe choice between big bang cutover and phased rollout with feature flags reflects a risk assessment based on criticality, complexity, and reversibility:\n\n*When Phased Rollout is Appropriate*:\n\n* **High complexity** - Multiple system integrations, complex state management, transaction adjudication\n* **Mission-critical** - Errors directly impact customer value, revenue, or contractual obligations\n* **Large user base** - Gradual enablement reduces blast radius for defects\n* **Reversibility challenge** - Operations involve external parties or are difficult/impossible to reverse\n* **Data synchronization complexity** - Dual-write or data coexistence patterns required\n* **Regulatory requirements** - Compliance testing needed before full deployment\n\n*When Big Bang Cutover is Appropriate*:\n\n* **Lower complexity** - Simple CRUD operations, minimal state management\n* **Not mission-critical** - Failures don't prevent core business operations\n* **Manageable user base** - Impact contained to specific user segment\n* **Easy rollback** - Can revert to legacy system without data loss or partner coordination\n* **Faster legacy retirement** - No extended transition period maintaining two systems\n* **Simple feature** - Read-only operations or create-only workflows\n\n*The Trade-Off*:\n\nPhased rollout accepts **increased complexity** (feature flag management, transition architecture states, dual-write patterns) in exchange for **reduced risk** (gradual enablement, controlled blast radius, early defect detection).\n\nBig bang accepts **higher cutover risk** (all users switch at once) in exchange for **simplicity** (no feature flag management), **faster legacy system retirement** (no parallel run period), and **reduced transition complexity** (no intermediate architecture states).\n\n*Risk Mitigation for Big Bang*:\n\n* **Comprehensive testing** - Load testing at expected peak volume, integration testing, UAT\n* **Rollback plan** - Clear criteria and procedure to revert if critical issues emerge\n* **Non-blocking deployment** - Cutover doesn't prevent core operations if new system fails\n* **Limited blast radius** - Failure impacts specific capability, not entire platform\n\nChoose the migration strategy that matches the risk profile and business criticality of the capability being migrated.\n\n==== Why No Case Migration from D365 CE?\n\nThe decision to **not migrate historical Cases** (ADR-CS-005) reflects a cost-benefit analysis that prioritises speed and simplicity over historical data preservation:\n\n*The Case for Migration*:\n\n* Support agents could see historical customer support Cases in Salesforce\n* Continuity of support history for repeat issues\n* Analytics and reporting on historical Case trends\n\n*The Case Against Migration*:\n\n* **Limited value** - Historical D365 CE Cases not critical for future support (new Cases moving forward)\n* **Data quality concerns** - D365 CE Case data may be inconsistent, incomplete, or poorly categorised\n* **Migration complexity** - Requires mapping D365 CE schema to Salesforce, data transformation, validation, testing\n* **Delays cutover** - Case migration extends timeline (Contact migration only is faster)\n* **Cost-benefit** - Migration effort (4-6 weeks) outweighs value of historical data\n\n*The Alternative*:\n\nIf historical Cases are needed, D365 CE can remain accessible (read-only) temporarily for lookups, or Cases can be archived separately.\n\n*The Trade-Off*:\n\nWe accept **loss of historical Case visibility in Salesforce** in exchange for **faster time-to-value** (Contact migration only), **simpler migration** (no Case schema mapping), and **clean start** (no legacy data quality issues).\n\nThis is a **pragmatic simplification** - historical support Cases provide marginal value compared to the migration effort required.\n\n==== Why Email as Primary Matching Key (Not VCI)?\n\nThe decision to use **email as the primary Contact matching key** (ADR-CS-004) rather than Viva Consumer ID (VCI) reflects a pragmatic choice based on current system capabilities:\n\n*Why Not VCI?*:\n\n* **Not in Salesforce today** - VCI is not currently stored as Salesforce External ID (requires Salesforce admin team to add field and configure upsert)\n* **Adds coordination overhead** - Requires Viva Energy Salesforce team approval, field creation, indexing, testing\n* **Delays cutover** - Email-based matching can start immediately, VCI matching requires Salesforce configuration work\n\n*Why Email Works*:\n\n* **Available now** - Salesforce Contact already has email field (standard, indexed)\n* **Unique identifier** - Email is unique in both Salesforce and Mobile App authentication\n* **Always available** - Authenticated users always have email from Entra ID JWT\n* **Salesforce standard** - Email is standard Contact lookup field (no custom configuration)\n\n*The Edge Case*:\n\n* **Email change** - If customer changes email, creates duplicate Contact (rare, manual cleanup acceptable)\n\n*Future Enhancement*:\n\n* Add VCI as Salesforce External ID (more stable matching)\n* Migrate to VCI-based matching once Salesforce configuration is complete\n\n*The Trade-Off*:\n\nWe accept **rare duplicate Contact creation** (when customers change email) in exchange for **immediate implementation** (no Salesforce configuration required) and **simplicity** (single matching key).\n\nThis is a **pragmatic starting point** - we can enhance to VCI-based matching later without breaking existing functionality.\n\n==== How the Decisions Reinforce Each Other\n\nThe architectural decisions form a **coherent strategy** rather than isolated choices:\n\n1. **DDD Bounded Contexts** (ADR-CS-002) establish the foundation for **Event-Driven Architecture** (ADR-CS-003) - ProfileService and EngagementService publish domain events that other bounded contexts consume\n2. **Async Processing** (ADR-CS-003) enables **Resilience to Salesforce Downtime** - the Event Bus buffers work when Salesforce is unavailable\n3. **Conformist Pattern** (ADR-CS-015) is protected by **Anti-Corruption Layer** - EngagementService conforms to Salesforce but isolates the Mobile App from Salesforce API changes\n4. **Big Bang Cutover** (ADR-CS-006) is feasible because **Customer Support is Non-Critical** - unlike payment processing or Flybuys points accrual, support feedback failure doesn't block core app functionality\n5. **No Case Migration** (ADR-CS-005) simplifies the **Big Bang Cutover** - Contact migration only is faster and lower risk\n6. **Email Matching** (ADR-CS-004) enables **Immediate Implementation** - no waiting for Salesforce admin team to configure VCI External ID\n\nThe decisions are **mutually reinforcing** - each choice makes the others more valuable or feasible.\n\n==== What This Establishes for Future Work\n\nThis implementation is the **architectural foundation** for OTR's target state:\n\n* **First bounded contexts** - ProfileService and EngagementService establish the pattern for LoyaltyService, PaymentService, LocationService, RecommendationService\n* **First event-driven integration** - Event Bus pattern reused for all future bounded context integration (not direct API calls)\n* **Reusable Contact reconciliation** - ProfileService Contact lookup reused for Flybuys partner linking, subscription billing, personalised recommendations\n* **Anti-Corruption Layer pattern** - EngagementService ACL demonstrates how to protect OTR domain model from external systems (EagleEye, Braze, D365 Commerce)\n* **Conformist pattern for shared systems** - Establishes approach for systems we don't control (Salesforce, Entra ID, Microsoft Fabric)\n\nEvery design decision is made with **future bounded contexts in mind** - we're not just solving customer support, we're establishing the architectural standards for all future work.\n","structuredPatch":[{"oldStart":127,"oldLines":34,"newStart":127,"newLines":42,"lines":[" "," Choose the migration strategy that matches the risk profile and business criticality of the capability being migrated."," ","-==== Why No Case Migration from D365 CE?","+==== When to Migrate Historical Data vs. Fresh Start?"," ","-The decision to **not migrate historical Cases** (ADR-CS-005) reflects a cost-benefit analysis that prioritises speed and simplicity over historical data preservation:","+The decision to migrate historical data from legacy systems reflects a cost-benefit analysis that balances historical continuity with migration complexity:"," ","-*The Case for Migration*:","+*The Case for Historical Data Migration*:"," ","-* Support agents could see historical customer support Cases in Salesforce","-* Continuity of support history for repeat issues","-* Analytics and reporting on historical Case trends","+* Users can access complete historical records in the new system","+* Continuity of business context for ongoing processes (customer history, audit trails)","+* Analytics and reporting across full historical timeline","+* Regulatory or compliance requirements for data retention","+* Business processes that reference historical data"," ","-*The Case Against Migration*:","+*The Case Against Historical Data Migration*:"," ","-* **Limited value** - Historical D365 CE Cases not critical for future support (new Cases moving forward)","-* **Data quality concerns** - D365 CE Case data may be inconsistent, incomplete, or poorly categorised","-* **Migration complexity** - Requires mapping D365 CE schema to Salesforce, data transformation, validation, testing","-* **Delays cutover** - Case migration extends timeline (Contact migration only is faster)","-* **Cost-benefit** - Migration effort (4-6 weeks) outweighs value of historical data","+* **Limited operational value** - Historical data not critical for future operations (new data moving forward)","+* **Data quality concerns** - Legacy data may be inconsistent, incomplete, or poorly categorised","+* **Migration complexity** - Requires schema mapping, data transformation, validation, testing, reconciliation","+* **Delays cutover** - Data migration extends timeline significantly","+* **Cost-benefit imbalance** - Migration effort outweighs practical value of historical data","+* **Reference data only** - Historical data rarely updated, mainly used for lookups"," ","-*The Alternative*:","+*Alternative Approaches*:"," ","-If historical Cases are needed, D365 CE can remain accessible (read-only) temporarily for lookups, or Cases can be archived separately.","+* Legacy system remains accessible (read-only) temporarily for historical lookups","+* Data archived separately (data warehouse, static reports, export files)","+* Selective migration - only recent or high-value historical records","+* On-demand migration - migrate historical data only when needed for specific use cases"," "," *The Trade-Off*:"," ","-We accept **loss of historical Case visibility in Salesforce** in exchange for **faster time-to-value** (Contact migration only), **simpler migration** (no Case schema mapping), and **clean start** (no legacy data quality issues).","+Historical data migration accepts **increased migration complexity** (schema mapping, transformation, validation) and **extended timeline** in exchange for **complete data continuity** in the new system."," ","-This is a **pragmatic simplification** - historical support Cases provide marginal value compared to the migration effort required.","+Fresh start accepts **loss of historical data in new system** in exchange for **faster time-to-value**, **simpler migration** (no historical schema mapping), and **clean start** (no legacy data quality issues)."," ","+Choose the approach that matches the business value of historical data against the cost and timeline impact of migration.","+"," ==== Why Email as Primary Matching Key (Not VCI)?"," "," The decision to use **email as the primary Contact matching key** (ADR-CS-004) rather than Viva Consumer ID (VCI) reflects a pragmatic choice based on current system capabilities:"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"f0f1dd89-dea2-428b-9424-31511650786f"}
{"parentUuid":"79960ceb-2a29-49a9-b2bc-2f2111948c5b","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_013gmmSVng8Lgh7kgzVF13Za","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now let me generalize the identifier strategy section.","signature":"Et4BCkYICxgCKkDL91QAWVANGXNzybskp5ufRL56WHVaklJ1uaBpPzIxhPNBno6NthAFhfk9cdfkcHfNr0eACup+71Zz5BroyVsZEgx5FLPjc4aUwcTvuIQaDCNtJc3SWENTR3eKNyIwA4gzLHQjHWfkU5mLmeidNsZTZi8sm2lEMWJj+g8HRvwKRubfRilmW/GeYblgtwK5KkYZd59qFJMeuANqVnL8oDGqXHViLD5JA8siGfMz9AMMZ0eB1MntEtIhwZWbh5KqLLI+UIum+9+RH9OwOASDedropl3ORaHGGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":1625,"cache_read_input_tokens":45491,"cache_creation":{"ephemeral_5m_input_tokens":1625,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWuPCzQm2adFh2zsDi7bb","type":"assistant","uuid":"b2c95bff-8ad0-4679-9382-f03d93ee6a60","timestamp":"2026-01-08T05:47:25.879Z"}
{"parentUuid":"b2c95bff-8ad0-4679-9382-f03d93ee6a60","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_013gmmSVng8Lgh7kgzVF13Za","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01FJebRgbRVhAWCuAs1ZFiKo","name":"Edit","input":{"replace_all":false,"file_path":"/mnt/c/Users/o.young/work/architecture/architectural_approach.adoc","old_string":"==== Why Email as Primary Matching Key (Not VCI)?\n\nThe decision to use **email as the primary Contact matching key** (ADR-CS-004) rather than Viva Consumer ID (VCI) reflects a pragmatic choice based on current system capabilities:\n\n*Why Not VCI?*:\n\n* **Not in Salesforce today** - VCI is not currently stored as Salesforce External ID (requires Salesforce admin team to add field and configure upsert)\n* **Adds coordination overhead** - Requires Viva Energy Salesforce team approval, field creation, indexing, testing\n* **Delays cutover** - Email-based matching can start immediately, VCI matching requires Salesforce configuration work\n\n*Why Email Works*:\n\n* **Available now** - Salesforce Contact already has email field (standard, indexed)\n* **Unique identifier** - Email is unique in both Salesforce and Mobile App authentication\n* **Always available** - Authenticated users always have email from Entra ID JWT\n* **Salesforce standard** - Email is standard Contact lookup field (no custom configuration)\n\n*The Edge Case*:\n\n* **Email change** - If customer changes email, creates duplicate Contact (rare, manual cleanup acceptable)\n\n*Future Enhancement*:\n\n* Add VCI as Salesforce External ID (more stable matching)\n* Migrate to VCI-based matching once Salesforce configuration is complete\n\n*The Trade-Off*:\n\nWe accept **rare duplicate Contact creation** (when customers change email) in exchange for **immediate implementation** (no Salesforce configuration required) and **simplicity** (single matching key).\n\nThis is a **pragmatic starting point** - we can enhance to VCI-based matching later without breaking existing functionality.","new_string":"==== Choosing Identity Matching Strategies\n\nThe choice of identity matching key reflects a trade-off between ideal design (stable, globally unique identifiers) and pragmatic implementation (available now, minimal coordination):\n\n*Ideal Matching Strategy*:\n\n* **Stable, globally unique identifier** - Doesn't change when user attributes change (email, phone, address)\n* **Cross-system consistency** - Same identifier used across all systems (single source of truth)\n* **Already available in external system** - Configured as External ID for efficient upsert operations\n* **Semantic meaning** - Identifier represents business entity clearly\n\n*Pragmatic Matching Strategy*:\n\n* **Available immediately** - Uses fields already present and indexed in external system\n* **No coordination required** - Doesn't require external system configuration changes or approvals\n* **Unique enough** - Functionally unique for practical purposes (edge cases acceptable)\n* **Always available** - Present in authentication tokens or API requests\n* **Standard field** - Uses platform-provided fields (no custom configuration)\n\n*Common Edge Cases*:\n\n* **Attribute changes** - User changes email, phone, or other matching attributes (creates duplicates)\n* **Data quality** - Missing, malformed, or inconsistent values in matching fields\n* **Uniqueness violations** - Multiple records share the same matching value\n* **Temporal consistency** - Matching value differs across systems at same point in time\n\n*Migration Path*:\n\nStart with pragmatic matching strategy for immediate implementation, then enhance to ideal matching strategy when coordination with external system stakeholders is feasible:\n\n1. **Phase 1**: Use available field (email, phone, username) - minimal coordination, faster time-to-value\n2. **Phase 2**: Add ideal identifier (global customer ID) to external system - requires coordination with platform team\n3. **Phase 3**: Migrate to ideal identifier for matching - update integration logic, backfill existing records\n\n*The Trade-Off*:\n\nIdeal matching accepts **coordination overhead** (external system configuration, stakeholder approval) and **delayed implementation** in exchange for **stable matching** (no duplicates when attributes change).\n\nPragmatic matching accepts **rare edge cases** (duplicates, manual cleanup) in exchange for **immediate implementation** (no external system changes) and **simplicity** (single available field).\n\nChoose the matching strategy that balances implementation speed against long-term data quality requirements."}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":1625,"cache_read_input_tokens":45491,"cache_creation":{"ephemeral_5m_input_tokens":1625,"ephemeral_1h_input_tokens":0},"output_tokens":1064,"service_tier":"standard"}},"requestId":"req_011CWuPCzQm2adFh2zsDi7bb","type":"assistant","uuid":"c0ce17b7-effb-45ec-831c-d04550c4c3fa","timestamp":"2026-01-08T05:47:49.158Z"}
{"parentUuid":"c0ce17b7-effb-45ec-831c-d04550c4c3fa","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01FJebRgbRVhAWCuAs1ZFiKo","type":"tool_result","content":"The file /mnt/c/Users/o.young/work/architecture/architectural_approach.adoc has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n   162→Fresh start accepts **loss of historical data in new system** in exchange for **faster time-to-value**, **simpler migration** (no historical schema mapping), and **clean start** (no legacy data quality issues).\n   163→\n   164→Choose the approach that matches the business value of historical data against the cost and timeline impact of migration.\n   165→\n   166→==== Choosing Identity Matching Strategies\n   167→\n   168→The choice of identity matching key reflects a trade-off between ideal design (stable, globally unique identifiers) and pragmatic implementation (available now, minimal coordination):\n   169→\n   170→*Ideal Matching Strategy*:\n   171→\n   172→* **Stable, globally unique identifier** - Doesn't change when user attributes change (email, phone, address)\n   173→* **Cross-system consistency** - Same identifier used across all systems (single source of truth)\n   174→* **Already available in external system** - Configured as External ID for efficient upsert operations\n   175→* **Semantic meaning** - Identifier represents business entity clearly\n   176→\n   177→*Pragmatic Matching Strategy*:\n   178→\n   179→* **Available immediately** - Uses fields already present and indexed in external system\n   180→* **No coordination required** - Doesn't require external system configuration changes or approvals\n   181→* **Unique enough** - Functionally unique for practical purposes (edge cases acceptable)\n   182→* **Always available** - Present in authentication tokens or API requests\n   183→* **Standard field** - Uses platform-provided fields (no custom configuration)\n   184→\n   185→*Common Edge Cases*:\n   186→\n   187→* **Attribute changes** - User changes email, phone, or other matching attributes (creates duplicates)\n   188→* **Data quality** - Missing, malformed, or inconsistent values in matching fields\n   189→* **Uniqueness violations** - Multiple records share the same matching value\n   190→* **Temporal consistency** - Matching value differs across systems at same point in time\n   191→\n   192→*Migration Path*:\n   193→\n   194→Start with pragmatic matching strategy for immediate implementation, then enhance to ideal matching strategy when coordination with external system stakeholders is feasible:\n   195→\n   196→1. **Phase 1**: Use available field (email, phone, username) - minimal coordination, faster time-to-value\n   197→2. **Phase 2**: Add ideal identifier (global customer ID) to external system - requires coordination with platform team\n   198→3. **Phase 3**: Migrate to ideal identifier for matching - update integration logic, backfill existing records\n   199→\n   200→*The Trade-Off*:\n   201→\n   202→Ideal matching accepts **coordination overhead** (external system configuration, stakeholder approval) and **delayed implementation** in exchange for **stable matching** (no duplicates when attributes change).\n   203→\n   204→Pragmatic matching accepts **rare edge cases** (duplicates, manual cleanup) in exchange for **immediate implementation** (no external system changes) and **simplicity** (single available field).\n   205→\n   206→Choose the matching strategy that balances implementation speed against long-term data quality requirements.\n   207→\n   208→==== How the Decisions Reinforce Each Other\n   209→\n   210→The architectural decisions form a **coherent strategy** rather than isolated choices:"}]},"uuid":"3116a8ec-8a12-4615-b1e5-645a9a32fa19","timestamp":"2026-01-08T05:47:49.406Z","toolUseResult":{"filePath":"/mnt/c/Users/o.young/work/architecture/architectural_approach.adoc","oldString":"==== Why Email as Primary Matching Key (Not VCI)?\n\nThe decision to use **email as the primary Contact matching key** (ADR-CS-004) rather than Viva Consumer ID (VCI) reflects a pragmatic choice based on current system capabilities:\n\n*Why Not VCI?*:\n\n* **Not in Salesforce today** - VCI is not currently stored as Salesforce External ID (requires Salesforce admin team to add field and configure upsert)\n* **Adds coordination overhead** - Requires Viva Energy Salesforce team approval, field creation, indexing, testing\n* **Delays cutover** - Email-based matching can start immediately, VCI matching requires Salesforce configuration work\n\n*Why Email Works*:\n\n* **Available now** - Salesforce Contact already has email field (standard, indexed)\n* **Unique identifier** - Email is unique in both Salesforce and Mobile App authentication\n* **Always available** - Authenticated users always have email from Entra ID JWT\n* **Salesforce standard** - Email is standard Contact lookup field (no custom configuration)\n\n*The Edge Case*:\n\n* **Email change** - If customer changes email, creates duplicate Contact (rare, manual cleanup acceptable)\n\n*Future Enhancement*:\n\n* Add VCI as Salesforce External ID (more stable matching)\n* Migrate to VCI-based matching once Salesforce configuration is complete\n\n*The Trade-Off*:\n\nWe accept **rare duplicate Contact creation** (when customers change email) in exchange for **immediate implementation** (no Salesforce configuration required) and **simplicity** (single matching key).\n\nThis is a **pragmatic starting point** - we can enhance to VCI-based matching later without breaking existing functionality.","newString":"==== Choosing Identity Matching Strategies\n\nThe choice of identity matching key reflects a trade-off between ideal design (stable, globally unique identifiers) and pragmatic implementation (available now, minimal coordination):\n\n*Ideal Matching Strategy*:\n\n* **Stable, globally unique identifier** - Doesn't change when user attributes change (email, phone, address)\n* **Cross-system consistency** - Same identifier used across all systems (single source of truth)\n* **Already available in external system** - Configured as External ID for efficient upsert operations\n* **Semantic meaning** - Identifier represents business entity clearly\n\n*Pragmatic Matching Strategy*:\n\n* **Available immediately** - Uses fields already present and indexed in external system\n* **No coordination required** - Doesn't require external system configuration changes or approvals\n* **Unique enough** - Functionally unique for practical purposes (edge cases acceptable)\n* **Always available** - Present in authentication tokens or API requests\n* **Standard field** - Uses platform-provided fields (no custom configuration)\n\n*Common Edge Cases*:\n\n* **Attribute changes** - User changes email, phone, or other matching attributes (creates duplicates)\n* **Data quality** - Missing, malformed, or inconsistent values in matching fields\n* **Uniqueness violations** - Multiple records share the same matching value\n* **Temporal consistency** - Matching value differs across systems at same point in time\n\n*Migration Path*:\n\nStart with pragmatic matching strategy for immediate implementation, then enhance to ideal matching strategy when coordination with external system stakeholders is feasible:\n\n1. **Phase 1**: Use available field (email, phone, username) - minimal coordination, faster time-to-value\n2. **Phase 2**: Add ideal identifier (global customer ID) to external system - requires coordination with platform team\n3. **Phase 3**: Migrate to ideal identifier for matching - update integration logic, backfill existing records\n\n*The Trade-Off*:\n\nIdeal matching accepts **coordination overhead** (external system configuration, stakeholder approval) and **delayed implementation** in exchange for **stable matching** (no duplicates when attributes change).\n\nPragmatic matching accepts **rare edge cases** (duplicates, manual cleanup) in exchange for **immediate implementation** (no external system changes) and **simplicity** (single available field).\n\nChoose the matching strategy that balances implementation speed against long-term data quality requirements.","originalFile":"==== Strategic Architectural Philosophy\n\nThis solution architecture aligns with OTR's target Domain-Driven Design (DDD) architecture. The design choices reflect three core principles:\n\n1. **Protect digital channels from external system coupling** - Use Anti-Corruption Layers (ACLs) to isolate OTR's domain model from external systems we don't control\n2. **Establish event-driven architecture as the integration standard** - Loose coupling between bounded contexts via domain events, enabling independent evolution\n3. **Prioritise simplicity and time-to-value** - Make pragmatic trade-offs that reduce complexity while establishing architectural patterns for future work\n\n==== Why Domain-Driven Design with Bounded Contexts?\n\nThe decision to implement bounded contexts rather than direct integration to external systems reflects a strategic investment in architectural quality:\n\n*The Problem with Direct Integration*:\n\n* Digital channels (Mobile App, Web) tightly coupled to external system APIs (any external change breaks clients)\n* External systems controlled by vendors or other business units - we conform to their governance and configuration\n* Future integrations duplicate common logic (identity reconciliation, event translation, error handling)\n* No domain event publishing - other services can't react to business events\n* Business logic scattered across client applications instead of centralized in domain services\n\n*The DDD Solution*:\n\n* **Bounded contexts** isolate domain concerns with clear responsibility boundaries\n* **Anti-Corruption Layers (ACLs)** translate between OTR domain language and external system models\n* **Event Bus** publishes domain events - other bounded contexts can react without tight coupling\n* **Reusable components** - common logic (identity, authorization, event translation) centralized once, used by many\n* **Clear boundaries** - each context handles specific domain capabilities (different responsibilities, different change rates)\n\n*The Trade-Off*:\n\nWe accept **increased initial complexity** (additional services, Event Bus infrastructure, team learning DDD patterns) in exchange for **architectural foundation** that protects digital channels from external system changes and enables reusable components for future work.\n\nThis is a **strategic investment** - we're not just solving immediate integration needs, we're establishing the architectural pattern for all future bounded contexts.\n\n==== Why Async Processing Instead of Synchronous API Calls?\n\nWhen integrating with external systems, the decision between asynchronous and synchronous processing reflects a prioritization of user experience, resilience, and system characteristics:\n\n*The Problem with Synchronous Integration*:\n\n* User waits for external system API response (latency across multiple system hops)\n* If external system is down or slow, user-facing operations fail\n* No automatic retry - users must manually retry operations\n* API timeout must accommodate worst-case external system latency\n* Tight coupling between user experience and external system performance\n\n*The Async Solution*:\n\n* **Immediate acknowledgment** - User gets confirmation quickly (no external system wait)\n* **Resilience** - If external system is down, work queued and processed when system recovers\n* **Automatic retry** - Exponential backoff handles transient API failures\n* **Operational visibility** - Dead letter queue alerts ops team to persistent failures\n* **Scalability** - Queue buffering handles traffic spikes without overwhelming external systems\n\n*The Trade-Off*:\n\nWe accept **eventual consistency** (notifications delivered after external processing completes) and **increased complexity** (Event Bus, background workers, retry logic, DLQ monitoring) in exchange for **better user experience** (no waiting) and **resilience** (external system downtime doesn't block user-facing operations).\n\nThis trade-off is acceptable when operations are **not real-time transactions** (unlike payment processing). When business processes can tolerate short delays (seconds to minutes), async processing improves both user experience and system resilience.\n\n==== Why Conformist Pattern for Shared Platforms?\n\nWhen integrating with shared platforms controlled by other organisations or business units, the Conformist pattern reflects a pragmatic acceptance of organisational reality:\n\n*The Organisational Context*:\n\n* **Shared platform governance** - Another organisation or business unit owns and operates the platform\n* **Multi-tenant environment** - OTR is one user among many (competing priorities, shared governance)\n* **Limited control** - We don't control platform configuration, data models, or API evolution\n* **Strategic alignment** - Organisational decision to standardize on shared platforms (not build parallel systems)\n\n*The Conformist Approach*:\n\n* **Accept their data model** - Use platform-provided objects and fields with minimal customisation\n* **Conform to their API** - Use platform APIs as-is, avoid heavy customisation\n* **Work within their governance** - Data isolation via platform mechanisms (tenancy, record types, permissions)\n* **Anti-Corruption Layer protects us** - Bounded contexts translate between OTR domain language and platform models\n\n*Why Not Heavily Customise Shared Platforms?*:\n\n* **Governance constraints** - Platform owners must approve all customisations (slow, requires business case justification)\n* **Shared instance risk** - Custom code or triggers could impact other users (change control overhead)\n* **Upgrade risk** - Heavy customisation increases platform upgrade complexity and testing burden\n* **Limited control** - We don't control the platform, so we shouldn't over-invest in customisation we can't maintain\n* **Vendor lock-in** - Deep customisation makes platform migration more difficult if strategic direction changes\n\n*The Trade-Off*:\n\nWe accept **less control over data model and platform evolution** in exchange for **faster time-to-value** (minimal custom development), **reduced operational overhead** (less custom code to maintain), and **organisational alignment** (consolidate onto shared platforms).\n\nThe **Anti-Corruption Layer** is the protection mechanism - it translates between OTR's domain language and the platform, so platform changes are isolated to the ACL, not propagated to digital channels.\n\n==== When to Use Big Bang Cutover vs. Phased Rollout?\n\nThe choice between big bang cutover and phased rollout with feature flags reflects a risk assessment based on criticality, complexity, and reversibility:\n\n*When Phased Rollout is Appropriate*:\n\n* **High complexity** - Multiple system integrations, complex state management, transaction adjudication\n* **Mission-critical** - Errors directly impact customer value, revenue, or contractual obligations\n* **Large user base** - Gradual enablement reduces blast radius for defects\n* **Reversibility challenge** - Operations involve external parties or are difficult/impossible to reverse\n* **Data synchronization complexity** - Dual-write or data coexistence patterns required\n* **Regulatory requirements** - Compliance testing needed before full deployment\n\n*When Big Bang Cutover is Appropriate*:\n\n* **Lower complexity** - Simple CRUD operations, minimal state management\n* **Not mission-critical** - Failures don't prevent core business operations\n* **Manageable user base** - Impact contained to specific user segment\n* **Easy rollback** - Can revert to legacy system without data loss or partner coordination\n* **Faster legacy retirement** - No extended transition period maintaining two systems\n* **Simple feature** - Read-only operations or create-only workflows\n\n*The Trade-Off*:\n\nPhased rollout accepts **increased complexity** (feature flag management, transition architecture states, dual-write patterns) in exchange for **reduced risk** (gradual enablement, controlled blast radius, early defect detection).\n\nBig bang accepts **higher cutover risk** (all users switch at once) in exchange for **simplicity** (no feature flag management), **faster legacy system retirement** (no parallel run period), and **reduced transition complexity** (no intermediate architecture states).\n\n*Risk Mitigation for Big Bang*:\n\n* **Comprehensive testing** - Load testing at expected peak volume, integration testing, UAT\n* **Rollback plan** - Clear criteria and procedure to revert if critical issues emerge\n* **Non-blocking deployment** - Cutover doesn't prevent core operations if new system fails\n* **Limited blast radius** - Failure impacts specific capability, not entire platform\n\nChoose the migration strategy that matches the risk profile and business criticality of the capability being migrated.\n\n==== When to Migrate Historical Data vs. Fresh Start?\n\nThe decision to migrate historical data from legacy systems reflects a cost-benefit analysis that balances historical continuity with migration complexity:\n\n*The Case for Historical Data Migration*:\n\n* Users can access complete historical records in the new system\n* Continuity of business context for ongoing processes (customer history, audit trails)\n* Analytics and reporting across full historical timeline\n* Regulatory or compliance requirements for data retention\n* Business processes that reference historical data\n\n*The Case Against Historical Data Migration*:\n\n* **Limited operational value** - Historical data not critical for future operations (new data moving forward)\n* **Data quality concerns** - Legacy data may be inconsistent, incomplete, or poorly categorised\n* **Migration complexity** - Requires schema mapping, data transformation, validation, testing, reconciliation\n* **Delays cutover** - Data migration extends timeline significantly\n* **Cost-benefit imbalance** - Migration effort outweighs practical value of historical data\n* **Reference data only** - Historical data rarely updated, mainly used for lookups\n\n*Alternative Approaches*:\n\n* Legacy system remains accessible (read-only) temporarily for historical lookups\n* Data archived separately (data warehouse, static reports, export files)\n* Selective migration - only recent or high-value historical records\n* On-demand migration - migrate historical data only when needed for specific use cases\n\n*The Trade-Off*:\n\nHistorical data migration accepts **increased migration complexity** (schema mapping, transformation, validation) and **extended timeline** in exchange for **complete data continuity** in the new system.\n\nFresh start accepts **loss of historical data in new system** in exchange for **faster time-to-value**, **simpler migration** (no historical schema mapping), and **clean start** (no legacy data quality issues).\n\nChoose the approach that matches the business value of historical data against the cost and timeline impact of migration.\n\n==== Why Email as Primary Matching Key (Not VCI)?\n\nThe decision to use **email as the primary Contact matching key** (ADR-CS-004) rather than Viva Consumer ID (VCI) reflects a pragmatic choice based on current system capabilities:\n\n*Why Not VCI?*:\n\n* **Not in Salesforce today** - VCI is not currently stored as Salesforce External ID (requires Salesforce admin team to add field and configure upsert)\n* **Adds coordination overhead** - Requires Viva Energy Salesforce team approval, field creation, indexing, testing\n* **Delays cutover** - Email-based matching can start immediately, VCI matching requires Salesforce configuration work\n\n*Why Email Works*:\n\n* **Available now** - Salesforce Contact already has email field (standard, indexed)\n* **Unique identifier** - Email is unique in both Salesforce and Mobile App authentication\n* **Always available** - Authenticated users always have email from Entra ID JWT\n* **Salesforce standard** - Email is standard Contact lookup field (no custom configuration)\n\n*The Edge Case*:\n\n* **Email change** - If customer changes email, creates duplicate Contact (rare, manual cleanup acceptable)\n\n*Future Enhancement*:\n\n* Add VCI as Salesforce External ID (more stable matching)\n* Migrate to VCI-based matching once Salesforce configuration is complete\n\n*The Trade-Off*:\n\nWe accept **rare duplicate Contact creation** (when customers change email) in exchange for **immediate implementation** (no Salesforce configuration required) and **simplicity** (single matching key).\n\nThis is a **pragmatic starting point** - we can enhance to VCI-based matching later without breaking existing functionality.\n\n==== How the Decisions Reinforce Each Other\n\nThe architectural decisions form a **coherent strategy** rather than isolated choices:\n\n1. **DDD Bounded Contexts** (ADR-CS-002) establish the foundation for **Event-Driven Architecture** (ADR-CS-003) - ProfileService and EngagementService publish domain events that other bounded contexts consume\n2. **Async Processing** (ADR-CS-003) enables **Resilience to Salesforce Downtime** - the Event Bus buffers work when Salesforce is unavailable\n3. **Conformist Pattern** (ADR-CS-015) is protected by **Anti-Corruption Layer** - EngagementService conforms to Salesforce but isolates the Mobile App from Salesforce API changes\n4. **Big Bang Cutover** (ADR-CS-006) is feasible because **Customer Support is Non-Critical** - unlike payment processing or Flybuys points accrual, support feedback failure doesn't block core app functionality\n5. **No Case Migration** (ADR-CS-005) simplifies the **Big Bang Cutover** - Contact migration only is faster and lower risk\n6. **Email Matching** (ADR-CS-004) enables **Immediate Implementation** - no waiting for Salesforce admin team to configure VCI External ID\n\nThe decisions are **mutually reinforcing** - each choice makes the others more valuable or feasible.\n\n==== What This Establishes for Future Work\n\nThis implementation is the **architectural foundation** for OTR's target state:\n\n* **First bounded contexts** - ProfileService and EngagementService establish the pattern for LoyaltyService, PaymentService, LocationService, RecommendationService\n* **First event-driven integration** - Event Bus pattern reused for all future bounded context integration (not direct API calls)\n* **Reusable Contact reconciliation** - ProfileService Contact lookup reused for Flybuys partner linking, subscription billing, personalised recommendations\n* **Anti-Corruption Layer pattern** - EngagementService ACL demonstrates how to protect OTR domain model from external systems (EagleEye, Braze, D365 Commerce)\n* **Conformist pattern for shared systems** - Establishes approach for systems we don't control (Salesforce, Entra ID, Microsoft Fabric)\n\nEvery design decision is made with **future bounded contexts in mind** - we're not just solving customer support, we're establishing the architectural standards for all future work.\n","structuredPatch":[{"oldStart":163,"oldLines":38,"newStart":163,"newLines":48,"lines":[" "," Choose the approach that matches the business value of historical data against the cost and timeline impact of migration."," ","-==== Why Email as Primary Matching Key (Not VCI)?","+==== Choosing Identity Matching Strategies"," ","-The decision to use **email as the primary Contact matching key** (ADR-CS-004) rather than Viva Consumer ID (VCI) reflects a pragmatic choice based on current system capabilities:","+The choice of identity matching key reflects a trade-off between ideal design (stable, globally unique identifiers) and pragmatic implementation (available now, minimal coordination):"," ","-*Why Not VCI?*:","+*Ideal Matching Strategy*:"," ","-* **Not in Salesforce today** - VCI is not currently stored as Salesforce External ID (requires Salesforce admin team to add field and configure upsert)","-* **Adds coordination overhead** - Requires Viva Energy Salesforce team approval, field creation, indexing, testing","-* **Delays cutover** - Email-based matching can start immediately, VCI matching requires Salesforce configuration work","+* **Stable, globally unique identifier** - Doesn't change when user attributes change (email, phone, address)","+* **Cross-system consistency** - Same identifier used across all systems (single source of truth)","+* **Already available in external system** - Configured as External ID for efficient upsert operations","+* **Semantic meaning** - Identifier represents business entity clearly"," ","-*Why Email Works*:","+*Pragmatic Matching Strategy*:"," ","-* **Available now** - Salesforce Contact already has email field (standard, indexed)","-* **Unique identifier** - Email is unique in both Salesforce and Mobile App authentication","-* **Always available** - Authenticated users always have email from Entra ID JWT","-* **Salesforce standard** - Email is standard Contact lookup field (no custom configuration)","+* **Available immediately** - Uses fields already present and indexed in external system","+* **No coordination required** - Doesn't require external system configuration changes or approvals","+* **Unique enough** - Functionally unique for practical purposes (edge cases acceptable)","+* **Always available** - Present in authentication tokens or API requests","+* **Standard field** - Uses platform-provided fields (no custom configuration)"," ","-*The Edge Case*:","+*Common Edge Cases*:"," ","-* **Email change** - If customer changes email, creates duplicate Contact (rare, manual cleanup acceptable)","+* **Attribute changes** - User changes email, phone, or other matching attributes (creates duplicates)","+* **Data quality** - Missing, malformed, or inconsistent values in matching fields","+* **Uniqueness violations** - Multiple records share the same matching value","+* **Temporal consistency** - Matching value differs across systems at same point in time"," ","-*Future Enhancement*:","+*Migration Path*:"," ","-* Add VCI as Salesforce External ID (more stable matching)","-* Migrate to VCI-based matching once Salesforce configuration is complete","+Start with pragmatic matching strategy for immediate implementation, then enhance to ideal matching strategy when coordination with external system stakeholders is feasible:"," ","+1. **Phase 1**: Use available field (email, phone, username) - minimal coordination, faster time-to-value","+2. **Phase 2**: Add ideal identifier (global customer ID) to external system - requires coordination with platform team","+3. **Phase 3**: Migrate to ideal identifier for matching - update integration logic, backfill existing records","+"," *The Trade-Off*:"," ","-We accept **rare duplicate Contact creation** (when customers change email) in exchange for **immediate implementation** (no Salesforce configuration required) and **simplicity** (single matching key).","+Ideal matching accepts **coordination overhead** (external system configuration, stakeholder approval) and **delayed implementation** in exchange for **stable matching** (no duplicates when attributes change)."," ","-This is a **pragmatic starting point** - we can enhance to VCI-based matching later without breaking existing functionality.","+Pragmatic matching accepts **rare edge cases** (duplicates, manual cleanup) in exchange for **immediate implementation** (no external system changes) and **simplicity** (single available field)."," ","+Choose the matching strategy that balances implementation speed against long-term data quality requirements.","+"," ==== How the Decisions Reinforce Each Other"," "," The architectural decisions form a **coherent strategy** rather than isolated choices:"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"c0ce17b7-effb-45ec-831c-d04550c4c3fa"}
{"parentUuid":"3116a8ec-8a12-4615-b1e5-645a9a32fa19","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01Fe6R37e8ZB8Ng1oUThopGv","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now let me generalize the \"How Decisions Reinforce Each Other\" section to remove specific ADR references and make it more generic.","signature":"EqsCCkYICxgCKkAH0lp2abe+OIAE4LGXO5KpR+yOCTJV2Dvy/avbYRoTwP+YQDl1sF8c04hnchQ2TZRwBuHxEUnD8euYeYd81I6ZEgyfVgHlaMRkPqt5648aDEEJI2bORV0Pbqa1eyIwFjz5dmvcEA/dWCwuHCYdi7MK2Nv9MymMfHawLosgOKT2Ce++VPfIkhRC5lZAS3+oKpIBbgDWvrSxE5HBuEhQS9vqa1NOey44hDtq+dZX0dADVO7m/ZmAFHXxPbMGyGZydWUXhQfiiQMVLlbCGBNy9j8nXF9DhlAki95d4cZERyY463KnQB+CJuDvpc19C3Nb8XYQ5RWmdhsSrr+zNknobvnU0A2kmnC4pkUG6LATdyiGLGZIHLVtbtlEVKjnxyJEUeBBtM8YAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":6,"cache_creation_input_tokens":1923,"cache_read_input_tokens":47116,"cache_creation":{"ephemeral_5m_input_tokens":1923,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWuPExEbYmiGUYK6EHpKy","type":"assistant","uuid":"22283e18-810b-46e8-9162-356d148c922e","timestamp":"2026-01-08T05:47:53.558Z"}
{"parentUuid":"22283e18-810b-46e8-9162-356d148c922e","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01Fe6R37e8ZB8Ng1oUThopGv","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_011yKeHcqLhcgxjN74v26yKY","name":"Edit","input":{"replace_all":false,"file_path":"/mnt/c/Users/o.young/work/architecture/architectural_approach.adoc","old_string":"==== How the Decisions Reinforce Each Other\n\nThe architectural decisions form a **coherent strategy** rather than isolated choices:\n\n1. **DDD Bounded Contexts** (ADR-CS-002) establish the foundation for **Event-Driven Architecture** (ADR-CS-003) - ProfileService and EngagementService publish domain events that other bounded contexts consume\n2. **Async Processing** (ADR-CS-003) enables **Resilience to Salesforce Downtime** - the Event Bus buffers work when Salesforce is unavailable\n3. **Conformist Pattern** (ADR-CS-015) is protected by **Anti-Corruption Layer** - EngagementService conforms to Salesforce but isolates the Mobile App from Salesforce API changes\n4. **Big Bang Cutover** (ADR-CS-006) is feasible because **Customer Support is Non-Critical** - unlike payment processing or Flybuys points accrual, support feedback failure doesn't block core app functionality\n5. **No Case Migration** (ADR-CS-005) simplifies the **Big Bang Cutover** - Contact migration only is faster and lower risk\n6. **Email Matching** (ADR-CS-004) enables **Immediate Implementation** - no waiting for Salesforce admin team to configure VCI External ID\n\nThe decisions are **mutually reinforcing** - each choice makes the others more valuable or feasible.","new_string":"==== How Architectural Decisions Reinforce Each Other\n\nEffective solution architectures create **coherent strategies** where architectural decisions reinforce each other rather than existing as isolated choices:\n\n*Pattern: Bounded Contexts Enable Event-Driven Architecture*\n\n* **DDD bounded contexts** establish clear service boundaries with well-defined responsibilities\n* **Event Bus** enables bounded contexts to publish domain events to other contexts\n* **Loose coupling** - contexts integrate via events, not direct API calls or shared databases\n* **Independent evolution** - contexts can change internally without breaking consumers\n\n*Pattern: Async Processing Enables Resilience*\n\n* **Asynchronous integration** decouples user experience from external system performance\n* **Queue buffering** absorbs work when external systems are slow or unavailable\n* **Automatic retry** handles transient failures without user intervention\n* **Graceful degradation** - core operations continue even when external integrations fail\n\n*Pattern: Conformist with Anti-Corruption Layer*\n\n* **Conformist pattern** accepts external system data models to minimize customization\n* **ACL** translates between external models and internal domain language\n* **Protection** - external system changes isolated to ACL, not propagated to digital channels\n* **Organizational alignment** - use shared platforms while protecting domain model\n\n*Pattern: Migration Strategy Matches Risk Profile*\n\n* **Non-critical capabilities** can use simpler big bang cutover (faster legacy retirement)\n* **Mission-critical capabilities** require phased rollout (controlled blast radius)\n* **Fresh start** (no historical data migration) simplifies big bang cutover\n* **Comprehensive testing** mitigates big bang risk for non-critical workloads\n\n*Pattern: Pragmatic Shortcuts with Migration Path*\n\n* **Start with available identifiers** (email, username) for immediate implementation\n* **Plan enhancement path** to ideal identifiers (global customer ID) when feasible\n* **Accept edge cases** (rare duplicates) for faster time-to-value\n* **Non-breaking migration** - can add ideal identifier later without disrupting operations\n\n**Coherent architecture** emerges when each decision makes others more valuable or feasible, creating a reinforcing system of trade-offs aligned with business priorities."}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":6,"cache_creation_input_tokens":1923,"cache_read_input_tokens":47116,"cache_creation":{"ephemeral_5m_input_tokens":1923,"ephemeral_1h_input_tokens":0},"output_tokens":978,"service_tier":"standard"}},"requestId":"req_011CWuPExEbYmiGUYK6EHpKy","type":"assistant","uuid":"66e69f91-db20-44a8-845d-db21ce656ce0","timestamp":"2026-01-08T05:48:14.526Z"}
{"parentUuid":"66e69f91-db20-44a8-845d-db21ce656ce0","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_011yKeHcqLhcgxjN74v26yKY","type":"tool_result","content":"The file /mnt/c/Users/o.young/work/architecture/architectural_approach.adoc has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n   204→Pragmatic matching accepts **rare edge cases** (duplicates, manual cleanup) in exchange for **immediate implementation** (no external system changes) and **simplicity** (single available field).\n   205→\n   206→Choose the matching strategy that balances implementation speed against long-term data quality requirements.\n   207→\n   208→==== How Architectural Decisions Reinforce Each Other\n   209→\n   210→Effective solution architectures create **coherent strategies** where architectural decisions reinforce each other rather than existing as isolated choices:\n   211→\n   212→*Pattern: Bounded Contexts Enable Event-Driven Architecture*\n   213→\n   214→* **DDD bounded contexts** establish clear service boundaries with well-defined responsibilities\n   215→* **Event Bus** enables bounded contexts to publish domain events to other contexts\n   216→* **Loose coupling** - contexts integrate via events, not direct API calls or shared databases\n   217→* **Independent evolution** - contexts can change internally without breaking consumers\n   218→\n   219→*Pattern: Async Processing Enables Resilience*\n   220→\n   221→* **Asynchronous integration** decouples user experience from external system performance\n   222→* **Queue buffering** absorbs work when external systems are slow or unavailable\n   223→* **Automatic retry** handles transient failures without user intervention\n   224→* **Graceful degradation** - core operations continue even when external integrations fail\n   225→\n   226→*Pattern: Conformist with Anti-Corruption Layer*\n   227→\n   228→* **Conformist pattern** accepts external system data models to minimize customization\n   229→* **ACL** translates between external models and internal domain language\n   230→* **Protection** - external system changes isolated to ACL, not propagated to digital channels\n   231→* **Organizational alignment** - use shared platforms while protecting domain model\n   232→\n   233→*Pattern: Migration Strategy Matches Risk Profile*\n   234→\n   235→* **Non-critical capabilities** can use simpler big bang cutover (faster legacy retirement)\n   236→* **Mission-critical capabilities** require phased rollout (controlled blast radius)\n   237→* **Fresh start** (no historical data migration) simplifies big bang cutover\n   238→* **Comprehensive testing** mitigates big bang risk for non-critical workloads\n   239→\n   240→*Pattern: Pragmatic Shortcuts with Migration Path*\n   241→\n   242→* **Start with available identifiers** (email, username) for immediate implementation\n   243→* **Plan enhancement path** to ideal identifiers (global customer ID) when feasible\n   244→* **Accept edge cases** (rare duplicates) for faster time-to-value\n   245→* **Non-breaking migration** - can add ideal identifier later without disrupting operations\n   246→\n   247→**Coherent architecture** emerges when each decision makes others more valuable or feasible, creating a reinforcing system of trade-offs aligned with business priorities.\n   248→\n   249→==== What This Establishes for Future Work\n   250→\n   251→This implementation is the **architectural foundation** for OTR's target state:"}]},"uuid":"212eed1f-ef9f-484a-840a-0e3ea0b7ef8c","timestamp":"2026-01-08T05:48:15.025Z","toolUseResult":{"filePath":"/mnt/c/Users/o.young/work/architecture/architectural_approach.adoc","oldString":"==== How the Decisions Reinforce Each Other\n\nThe architectural decisions form a **coherent strategy** rather than isolated choices:\n\n1. **DDD Bounded Contexts** (ADR-CS-002) establish the foundation for **Event-Driven Architecture** (ADR-CS-003) - ProfileService and EngagementService publish domain events that other bounded contexts consume\n2. **Async Processing** (ADR-CS-003) enables **Resilience to Salesforce Downtime** - the Event Bus buffers work when Salesforce is unavailable\n3. **Conformist Pattern** (ADR-CS-015) is protected by **Anti-Corruption Layer** - EngagementService conforms to Salesforce but isolates the Mobile App from Salesforce API changes\n4. **Big Bang Cutover** (ADR-CS-006) is feasible because **Customer Support is Non-Critical** - unlike payment processing or Flybuys points accrual, support feedback failure doesn't block core app functionality\n5. **No Case Migration** (ADR-CS-005) simplifies the **Big Bang Cutover** - Contact migration only is faster and lower risk\n6. **Email Matching** (ADR-CS-004) enables **Immediate Implementation** - no waiting for Salesforce admin team to configure VCI External ID\n\nThe decisions are **mutually reinforcing** - each choice makes the others more valuable or feasible.","newString":"==== How Architectural Decisions Reinforce Each Other\n\nEffective solution architectures create **coherent strategies** where architectural decisions reinforce each other rather than existing as isolated choices:\n\n*Pattern: Bounded Contexts Enable Event-Driven Architecture*\n\n* **DDD bounded contexts** establish clear service boundaries with well-defined responsibilities\n* **Event Bus** enables bounded contexts to publish domain events to other contexts\n* **Loose coupling** - contexts integrate via events, not direct API calls or shared databases\n* **Independent evolution** - contexts can change internally without breaking consumers\n\n*Pattern: Async Processing Enables Resilience*\n\n* **Asynchronous integration** decouples user experience from external system performance\n* **Queue buffering** absorbs work when external systems are slow or unavailable\n* **Automatic retry** handles transient failures without user intervention\n* **Graceful degradation** - core operations continue even when external integrations fail\n\n*Pattern: Conformist with Anti-Corruption Layer*\n\n* **Conformist pattern** accepts external system data models to minimize customization\n* **ACL** translates between external models and internal domain language\n* **Protection** - external system changes isolated to ACL, not propagated to digital channels\n* **Organizational alignment** - use shared platforms while protecting domain model\n\n*Pattern: Migration Strategy Matches Risk Profile*\n\n* **Non-critical capabilities** can use simpler big bang cutover (faster legacy retirement)\n* **Mission-critical capabilities** require phased rollout (controlled blast radius)\n* **Fresh start** (no historical data migration) simplifies big bang cutover\n* **Comprehensive testing** mitigates big bang risk for non-critical workloads\n\n*Pattern: Pragmatic Shortcuts with Migration Path*\n\n* **Start with available identifiers** (email, username) for immediate implementation\n* **Plan enhancement path** to ideal identifiers (global customer ID) when feasible\n* **Accept edge cases** (rare duplicates) for faster time-to-value\n* **Non-breaking migration** - can add ideal identifier later without disrupting operations\n\n**Coherent architecture** emerges when each decision makes others more valuable or feasible, creating a reinforcing system of trade-offs aligned with business priorities.","originalFile":"==== Strategic Architectural Philosophy\n\nThis solution architecture aligns with OTR's target Domain-Driven Design (DDD) architecture. The design choices reflect three core principles:\n\n1. **Protect digital channels from external system coupling** - Use Anti-Corruption Layers (ACLs) to isolate OTR's domain model from external systems we don't control\n2. **Establish event-driven architecture as the integration standard** - Loose coupling between bounded contexts via domain events, enabling independent evolution\n3. **Prioritise simplicity and time-to-value** - Make pragmatic trade-offs that reduce complexity while establishing architectural patterns for future work\n\n==== Why Domain-Driven Design with Bounded Contexts?\n\nThe decision to implement bounded contexts rather than direct integration to external systems reflects a strategic investment in architectural quality:\n\n*The Problem with Direct Integration*:\n\n* Digital channels (Mobile App, Web) tightly coupled to external system APIs (any external change breaks clients)\n* External systems controlled by vendors or other business units - we conform to their governance and configuration\n* Future integrations duplicate common logic (identity reconciliation, event translation, error handling)\n* No domain event publishing - other services can't react to business events\n* Business logic scattered across client applications instead of centralized in domain services\n\n*The DDD Solution*:\n\n* **Bounded contexts** isolate domain concerns with clear responsibility boundaries\n* **Anti-Corruption Layers (ACLs)** translate between OTR domain language and external system models\n* **Event Bus** publishes domain events - other bounded contexts can react without tight coupling\n* **Reusable components** - common logic (identity, authorization, event translation) centralized once, used by many\n* **Clear boundaries** - each context handles specific domain capabilities (different responsibilities, different change rates)\n\n*The Trade-Off*:\n\nWe accept **increased initial complexity** (additional services, Event Bus infrastructure, team learning DDD patterns) in exchange for **architectural foundation** that protects digital channels from external system changes and enables reusable components for future work.\n\nThis is a **strategic investment** - we're not just solving immediate integration needs, we're establishing the architectural pattern for all future bounded contexts.\n\n==== Why Async Processing Instead of Synchronous API Calls?\n\nWhen integrating with external systems, the decision between asynchronous and synchronous processing reflects a prioritization of user experience, resilience, and system characteristics:\n\n*The Problem with Synchronous Integration*:\n\n* User waits for external system API response (latency across multiple system hops)\n* If external system is down or slow, user-facing operations fail\n* No automatic retry - users must manually retry operations\n* API timeout must accommodate worst-case external system latency\n* Tight coupling between user experience and external system performance\n\n*The Async Solution*:\n\n* **Immediate acknowledgment** - User gets confirmation quickly (no external system wait)\n* **Resilience** - If external system is down, work queued and processed when system recovers\n* **Automatic retry** - Exponential backoff handles transient API failures\n* **Operational visibility** - Dead letter queue alerts ops team to persistent failures\n* **Scalability** - Queue buffering handles traffic spikes without overwhelming external systems\n\n*The Trade-Off*:\n\nWe accept **eventual consistency** (notifications delivered after external processing completes) and **increased complexity** (Event Bus, background workers, retry logic, DLQ monitoring) in exchange for **better user experience** (no waiting) and **resilience** (external system downtime doesn't block user-facing operations).\n\nThis trade-off is acceptable when operations are **not real-time transactions** (unlike payment processing). When business processes can tolerate short delays (seconds to minutes), async processing improves both user experience and system resilience.\n\n==== Why Conformist Pattern for Shared Platforms?\n\nWhen integrating with shared platforms controlled by other organisations or business units, the Conformist pattern reflects a pragmatic acceptance of organisational reality:\n\n*The Organisational Context*:\n\n* **Shared platform governance** - Another organisation or business unit owns and operates the platform\n* **Multi-tenant environment** - OTR is one user among many (competing priorities, shared governance)\n* **Limited control** - We don't control platform configuration, data models, or API evolution\n* **Strategic alignment** - Organisational decision to standardize on shared platforms (not build parallel systems)\n\n*The Conformist Approach*:\n\n* **Accept their data model** - Use platform-provided objects and fields with minimal customisation\n* **Conform to their API** - Use platform APIs as-is, avoid heavy customisation\n* **Work within their governance** - Data isolation via platform mechanisms (tenancy, record types, permissions)\n* **Anti-Corruption Layer protects us** - Bounded contexts translate between OTR domain language and platform models\n\n*Why Not Heavily Customise Shared Platforms?*:\n\n* **Governance constraints** - Platform owners must approve all customisations (slow, requires business case justification)\n* **Shared instance risk** - Custom code or triggers could impact other users (change control overhead)\n* **Upgrade risk** - Heavy customisation increases platform upgrade complexity and testing burden\n* **Limited control** - We don't control the platform, so we shouldn't over-invest in customisation we can't maintain\n* **Vendor lock-in** - Deep customisation makes platform migration more difficult if strategic direction changes\n\n*The Trade-Off*:\n\nWe accept **less control over data model and platform evolution** in exchange for **faster time-to-value** (minimal custom development), **reduced operational overhead** (less custom code to maintain), and **organisational alignment** (consolidate onto shared platforms).\n\nThe **Anti-Corruption Layer** is the protection mechanism - it translates between OTR's domain language and the platform, so platform changes are isolated to the ACL, not propagated to digital channels.\n\n==== When to Use Big Bang Cutover vs. Phased Rollout?\n\nThe choice between big bang cutover and phased rollout with feature flags reflects a risk assessment based on criticality, complexity, and reversibility:\n\n*When Phased Rollout is Appropriate*:\n\n* **High complexity** - Multiple system integrations, complex state management, transaction adjudication\n* **Mission-critical** - Errors directly impact customer value, revenue, or contractual obligations\n* **Large user base** - Gradual enablement reduces blast radius for defects\n* **Reversibility challenge** - Operations involve external parties or are difficult/impossible to reverse\n* **Data synchronization complexity** - Dual-write or data coexistence patterns required\n* **Regulatory requirements** - Compliance testing needed before full deployment\n\n*When Big Bang Cutover is Appropriate*:\n\n* **Lower complexity** - Simple CRUD operations, minimal state management\n* **Not mission-critical** - Failures don't prevent core business operations\n* **Manageable user base** - Impact contained to specific user segment\n* **Easy rollback** - Can revert to legacy system without data loss or partner coordination\n* **Faster legacy retirement** - No extended transition period maintaining two systems\n* **Simple feature** - Read-only operations or create-only workflows\n\n*The Trade-Off*:\n\nPhased rollout accepts **increased complexity** (feature flag management, transition architecture states, dual-write patterns) in exchange for **reduced risk** (gradual enablement, controlled blast radius, early defect detection).\n\nBig bang accepts **higher cutover risk** (all users switch at once) in exchange for **simplicity** (no feature flag management), **faster legacy system retirement** (no parallel run period), and **reduced transition complexity** (no intermediate architecture states).\n\n*Risk Mitigation for Big Bang*:\n\n* **Comprehensive testing** - Load testing at expected peak volume, integration testing, UAT\n* **Rollback plan** - Clear criteria and procedure to revert if critical issues emerge\n* **Non-blocking deployment** - Cutover doesn't prevent core operations if new system fails\n* **Limited blast radius** - Failure impacts specific capability, not entire platform\n\nChoose the migration strategy that matches the risk profile and business criticality of the capability being migrated.\n\n==== When to Migrate Historical Data vs. Fresh Start?\n\nThe decision to migrate historical data from legacy systems reflects a cost-benefit analysis that balances historical continuity with migration complexity:\n\n*The Case for Historical Data Migration*:\n\n* Users can access complete historical records in the new system\n* Continuity of business context for ongoing processes (customer history, audit trails)\n* Analytics and reporting across full historical timeline\n* Regulatory or compliance requirements for data retention\n* Business processes that reference historical data\n\n*The Case Against Historical Data Migration*:\n\n* **Limited operational value** - Historical data not critical for future operations (new data moving forward)\n* **Data quality concerns** - Legacy data may be inconsistent, incomplete, or poorly categorised\n* **Migration complexity** - Requires schema mapping, data transformation, validation, testing, reconciliation\n* **Delays cutover** - Data migration extends timeline significantly\n* **Cost-benefit imbalance** - Migration effort outweighs practical value of historical data\n* **Reference data only** - Historical data rarely updated, mainly used for lookups\n\n*Alternative Approaches*:\n\n* Legacy system remains accessible (read-only) temporarily for historical lookups\n* Data archived separately (data warehouse, static reports, export files)\n* Selective migration - only recent or high-value historical records\n* On-demand migration - migrate historical data only when needed for specific use cases\n\n*The Trade-Off*:\n\nHistorical data migration accepts **increased migration complexity** (schema mapping, transformation, validation) and **extended timeline** in exchange for **complete data continuity** in the new system.\n\nFresh start accepts **loss of historical data in new system** in exchange for **faster time-to-value**, **simpler migration** (no historical schema mapping), and **clean start** (no legacy data quality issues).\n\nChoose the approach that matches the business value of historical data against the cost and timeline impact of migration.\n\n==== Choosing Identity Matching Strategies\n\nThe choice of identity matching key reflects a trade-off between ideal design (stable, globally unique identifiers) and pragmatic implementation (available now, minimal coordination):\n\n*Ideal Matching Strategy*:\n\n* **Stable, globally unique identifier** - Doesn't change when user attributes change (email, phone, address)\n* **Cross-system consistency** - Same identifier used across all systems (single source of truth)\n* **Already available in external system** - Configured as External ID for efficient upsert operations\n* **Semantic meaning** - Identifier represents business entity clearly\n\n*Pragmatic Matching Strategy*:\n\n* **Available immediately** - Uses fields already present and indexed in external system\n* **No coordination required** - Doesn't require external system configuration changes or approvals\n* **Unique enough** - Functionally unique for practical purposes (edge cases acceptable)\n* **Always available** - Present in authentication tokens or API requests\n* **Standard field** - Uses platform-provided fields (no custom configuration)\n\n*Common Edge Cases*:\n\n* **Attribute changes** - User changes email, phone, or other matching attributes (creates duplicates)\n* **Data quality** - Missing, malformed, or inconsistent values in matching fields\n* **Uniqueness violations** - Multiple records share the same matching value\n* **Temporal consistency** - Matching value differs across systems at same point in time\n\n*Migration Path*:\n\nStart with pragmatic matching strategy for immediate implementation, then enhance to ideal matching strategy when coordination with external system stakeholders is feasible:\n\n1. **Phase 1**: Use available field (email, phone, username) - minimal coordination, faster time-to-value\n2. **Phase 2**: Add ideal identifier (global customer ID) to external system - requires coordination with platform team\n3. **Phase 3**: Migrate to ideal identifier for matching - update integration logic, backfill existing records\n\n*The Trade-Off*:\n\nIdeal matching accepts **coordination overhead** (external system configuration, stakeholder approval) and **delayed implementation** in exchange for **stable matching** (no duplicates when attributes change).\n\nPragmatic matching accepts **rare edge cases** (duplicates, manual cleanup) in exchange for **immediate implementation** (no external system changes) and **simplicity** (single available field).\n\nChoose the matching strategy that balances implementation speed against long-term data quality requirements.\n\n==== How the Decisions Reinforce Each Other\n\nThe architectural decisions form a **coherent strategy** rather than isolated choices:\n\n1. **DDD Bounded Contexts** (ADR-CS-002) establish the foundation for **Event-Driven Architecture** (ADR-CS-003) - ProfileService and EngagementService publish domain events that other bounded contexts consume\n2. **Async Processing** (ADR-CS-003) enables **Resilience to Salesforce Downtime** - the Event Bus buffers work when Salesforce is unavailable\n3. **Conformist Pattern** (ADR-CS-015) is protected by **Anti-Corruption Layer** - EngagementService conforms to Salesforce but isolates the Mobile App from Salesforce API changes\n4. **Big Bang Cutover** (ADR-CS-006) is feasible because **Customer Support is Non-Critical** - unlike payment processing or Flybuys points accrual, support feedback failure doesn't block core app functionality\n5. **No Case Migration** (ADR-CS-005) simplifies the **Big Bang Cutover** - Contact migration only is faster and lower risk\n6. **Email Matching** (ADR-CS-004) enables **Immediate Implementation** - no waiting for Salesforce admin team to configure VCI External ID\n\nThe decisions are **mutually reinforcing** - each choice makes the others more valuable or feasible.\n\n==== What This Establishes for Future Work\n\nThis implementation is the **architectural foundation** for OTR's target state:\n\n* **First bounded contexts** - ProfileService and EngagementService establish the pattern for LoyaltyService, PaymentService, LocationService, RecommendationService\n* **First event-driven integration** - Event Bus pattern reused for all future bounded context integration (not direct API calls)\n* **Reusable Contact reconciliation** - ProfileService Contact lookup reused for Flybuys partner linking, subscription billing, personalised recommendations\n* **Anti-Corruption Layer pattern** - EngagementService ACL demonstrates how to protect OTR domain model from external systems (EagleEye, Braze, D365 Commerce)\n* **Conformist pattern for shared systems** - Establishes approach for systems we don't control (Salesforce, Entra ID, Microsoft Fabric)\n\nEvery design decision is made with **future bounded contexts in mind** - we're not just solving customer support, we're establishing the architectural standards for all future work.\n","structuredPatch":[{"oldStart":205,"oldLines":19,"newStart":205,"newLines":47,"lines":[" "," Choose the matching strategy that balances implementation speed against long-term data quality requirements."," ","-==== How the Decisions Reinforce Each Other","+==== How Architectural Decisions Reinforce Each Other"," ","-The architectural decisions form a **coherent strategy** rather than isolated choices:","+Effective solution architectures create **coherent strategies** where architectural decisions reinforce each other rather than existing as isolated choices:"," ","-1. **DDD Bounded Contexts** (ADR-CS-002) establish the foundation for **Event-Driven Architecture** (ADR-CS-003) - ProfileService and EngagementService publish domain events that other bounded contexts consume","-2. **Async Processing** (ADR-CS-003) enables **Resilience to Salesforce Downtime** - the Event Bus buffers work when Salesforce is unavailable","-3. **Conformist Pattern** (ADR-CS-015) is protected by **Anti-Corruption Layer** - EngagementService conforms to Salesforce but isolates the Mobile App from Salesforce API changes","-4. **Big Bang Cutover** (ADR-CS-006) is feasible because **Customer Support is Non-Critical** - unlike payment processing or Flybuys points accrual, support feedback failure doesn't block core app functionality","-5. **No Case Migration** (ADR-CS-005) simplifies the **Big Bang Cutover** - Contact migration only is faster and lower risk","-6. **Email Matching** (ADR-CS-004) enables **Immediate Implementation** - no waiting for Salesforce admin team to configure VCI External ID","+*Pattern: Bounded Contexts Enable Event-Driven Architecture*"," ","-The decisions are **mutually reinforcing** - each choice makes the others more valuable or feasible.","+* **DDD bounded contexts** establish clear service boundaries with well-defined responsibilities","+* **Event Bus** enables bounded contexts to publish domain events to other contexts","+* **Loose coupling** - contexts integrate via events, not direct API calls or shared databases","+* **Independent evolution** - contexts can change internally without breaking consumers"," ","+*Pattern: Async Processing Enables Resilience*","+","+* **Asynchronous integration** decouples user experience from external system performance","+* **Queue buffering** absorbs work when external systems are slow or unavailable","+* **Automatic retry** handles transient failures without user intervention","+* **Graceful degradation** - core operations continue even when external integrations fail","+","+*Pattern: Conformist with Anti-Corruption Layer*","+","+* **Conformist pattern** accepts external system data models to minimize customization","+* **ACL** translates between external models and internal domain language","+* **Protection** - external system changes isolated to ACL, not propagated to digital channels","+* **Organizational alignment** - use shared platforms while protecting domain model","+","+*Pattern: Migration Strategy Matches Risk Profile*","+","+* **Non-critical capabilities** can use simpler big bang cutover (faster legacy retirement)","+* **Mission-critical capabilities** require phased rollout (controlled blast radius)","+* **Fresh start** (no historical data migration) simplifies big bang cutover","+* **Comprehensive testing** mitigates big bang risk for non-critical workloads","+","+*Pattern: Pragmatic Shortcuts with Migration Path*","+","+* **Start with available identifiers** (email, username) for immediate implementation","+* **Plan enhancement path** to ideal identifiers (global customer ID) when feasible","+* **Accept edge cases** (rare duplicates) for faster time-to-value","+* **Non-breaking migration** - can add ideal identifier later without disrupting operations","+","+**Coherent architecture** emerges when each decision makes others more valuable or feasible, creating a reinforcing system of trade-offs aligned with business priorities.","+"," ==== What This Establishes for Future Work"," "," This implementation is the **architectural foundation** for OTR's target state:"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"66e69f91-db20-44a8-845d-db21ce656ce0"}
{"parentUuid":"212eed1f-ef9f-484a-840a-0e3ea0b7ef8c","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01PXX77PfPdpDnTk7WSwvp3p","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now let me generalize the final section \"What This Establishes for Future Work\" to be less specific about ProfileService, EngagementService, and Salesforce.","signature":"EsUCCkYICxgCKkAdtUd0YzJC9m5enPxBESkQhA2mAwykvS7AYb81Y95H0SSMYgthsjSH885iTR9R3g6c+mxSt+YvwlMdXgD0s5xKEgyfoATQwIELP+ZB0xIaDDL6QXhL3osGWUspESIwHNhBv87KcGTGX6WU5MPPE5/Z/HxZKrMgjJEufbCXlyWagkQFU/ddlnwmp+muahdyKqwB7FllxoZaf2MomEuYDFDUtzXvPS4NtSEoWi5ftsHD8a2ryXFQcDyyipzgrZ/WG9bp473tFa2WxoP4nFEnoT982WK72UgkQLIxp80xN6SqiNuAXl2LAQkbG3Sz718OxKZ4AvCSbWAOZfoKJ2sCYbjGXW/25tsB1VIp4d6FX9Z2dnaOHXfrcYLGn+tAcbAbUGFw0FPB5ISbRTJ9If/11BTyUkKWzl2QY6/nTFk6GxgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":1783,"cache_read_input_tokens":49039,"cache_creation":{"ephemeral_5m_input_tokens":1783,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CWuPGrvAzZ24XQ5jcpEu1","type":"assistant","uuid":"1d96f2bc-f2bd-4d39-9e46-8c7190827250","timestamp":"2026-01-08T05:48:20.898Z"}
{"parentUuid":"1d96f2bc-f2bd-4d39-9e46-8c7190827250","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01PXX77PfPdpDnTk7WSwvp3p","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_017gY2ixXzVeGEBxgrC7n1QS","name":"Edit","input":{"replace_all":false,"file_path":"/mnt/c/Users/o.young/work/architecture/architectural_approach.adoc","old_string":"==== What This Establishes for Future Work\n\nThis implementation is the **architectural foundation** for OTR's target state:\n\n* **First bounded contexts** - ProfileService and EngagementService establish the pattern for LoyaltyService, PaymentService, LocationService, RecommendationService\n* **First event-driven integration** - Event Bus pattern reused for all future bounded context integration (not direct API calls)\n* **Reusable Contact reconciliation** - ProfileService Contact lookup reused for Flybuys partner linking, subscription billing, personalised recommendations\n* **Anti-Corruption Layer pattern** - EngagementService ACL demonstrates how to protect OTR domain model from external systems (EagleEye, Braze, D365 Commerce)\n* **Conformist pattern for shared systems** - Establishes approach for systems we don't control (Salesforce, Entra ID, Microsoft Fabric)\n\nEvery design decision is made with **future bounded contexts in mind** - we're not just solving customer support, we're establishing the architectural standards for all future work.","new_string":"==== What This Establishes for Future Work\n\nEach solution architecture contributes to the **architectural foundation** for OTR's target state:\n\n* **Bounded context patterns** - Establishes DDD service boundaries with clear responsibilities for future domain services\n* **Event-driven integration** - Event Bus pattern becomes standard for bounded context integration (not direct API calls)\n* **Reusable components** - Common capabilities (identity reconciliation, authorization, event translation) centralized for reuse\n* **Anti-Corruption Layer pattern** - Demonstrates how to protect OTR domain model from external systems we don't control\n* **Conformist pattern for shared systems** - Establishes approach for platforms we don't own (shared enterprise platforms, SaaS vendors)\n* **Migration strategies** - Proves both phased rollout (feature flags, transition states) and big bang approaches for different risk profiles\n* **Pragmatic trade-offs** - Validates architectural decision framework balancing ideal design against time-to-value\n\nEvery design decision is made with **future bounded contexts in mind** - each solution doesn't just solve immediate business needs, it establishes architectural patterns and standards for all future work.\n\nSolution architectures are **learning investments** - the first implementation of a pattern is more expensive (team learning, infrastructure setup, standards definition), but subsequent implementations reuse the foundation at lower cost."}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":1783,"cache_read_input_tokens":49039,"cache_creation":{"ephemeral_5m_input_tokens":1783,"ephemeral_1h_input_tokens":0},"output_tokens":708,"service_tier":"standard"}},"requestId":"req_011CWuPGrvAzZ24XQ5jcpEu1","type":"assistant","uuid":"d7059d8e-6f9f-4d64-bddd-fb5eabd1eb74","timestamp":"2026-01-08T05:48:35.071Z"}
{"parentUuid":"d7059d8e-6f9f-4d64-bddd-fb5eabd1eb74","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_017gY2ixXzVeGEBxgrC7n1QS","type":"tool_result","content":"The file /mnt/c/Users/o.young/work/architecture/architectural_approach.adoc has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n   245→* **Non-breaking migration** - can add ideal identifier later without disrupting operations\n   246→\n   247→**Coherent architecture** emerges when each decision makes others more valuable or feasible, creating a reinforcing system of trade-offs aligned with business priorities.\n   248→\n   249→==== What This Establishes for Future Work\n   250→\n   251→Each solution architecture contributes to the **architectural foundation** for OTR's target state:\n   252→\n   253→* **Bounded context patterns** - Establishes DDD service boundaries with clear responsibilities for future domain services\n   254→* **Event-driven integration** - Event Bus pattern becomes standard for bounded context integration (not direct API calls)\n   255→* **Reusable components** - Common capabilities (identity reconciliation, authorization, event translation) centralized for reuse\n   256→* **Anti-Corruption Layer pattern** - Demonstrates how to protect OTR domain model from external systems we don't control\n   257→* **Conformist pattern for shared systems** - Establishes approach for platforms we don't own (shared enterprise platforms, SaaS vendors)\n   258→* **Migration strategies** - Proves both phased rollout (feature flags, transition states) and big bang approaches for different risk profiles\n   259→* **Pragmatic trade-offs** - Validates architectural decision framework balancing ideal design against time-to-value\n   260→\n   261→Every design decision is made with **future bounded contexts in mind** - each solution doesn't just solve immediate business needs, it establishes architectural patterns and standards for all future work.\n   262→\n   263→Solution architectures are **learning investments** - the first implementation of a pattern is more expensive (team learning, infrastructure setup, standards definition), but subsequent implementations reuse the foundation at lower cost.\n   264→"}]},"uuid":"51852557-847e-4fa9-8804-5ce8587570db","timestamp":"2026-01-08T05:48:35.277Z","toolUseResult":{"filePath":"/mnt/c/Users/o.young/work/architecture/architectural_approach.adoc","oldString":"==== What This Establishes for Future Work\n\nThis implementation is the **architectural foundation** for OTR's target state:\n\n* **First bounded contexts** - ProfileService and EngagementService establish the pattern for LoyaltyService, PaymentService, LocationService, RecommendationService\n* **First event-driven integration** - Event Bus pattern reused for all future bounded context integration (not direct API calls)\n* **Reusable Contact reconciliation** - ProfileService Contact lookup reused for Flybuys partner linking, subscription billing, personalised recommendations\n* **Anti-Corruption Layer pattern** - EngagementService ACL demonstrates how to protect OTR domain model from external systems (EagleEye, Braze, D365 Commerce)\n* **Conformist pattern for shared systems** - Establishes approach for systems we don't control (Salesforce, Entra ID, Microsoft Fabric)\n\nEvery design decision is made with **future bounded contexts in mind** - we're not just solving customer support, we're establishing the architectural standards for all future work.","newString":"==== What This Establishes for Future Work\n\nEach solution architecture contributes to the **architectural foundation** for OTR's target state:\n\n* **Bounded context patterns** - Establishes DDD service boundaries with clear responsibilities for future domain services\n* **Event-driven integration** - Event Bus pattern becomes standard for bounded context integration (not direct API calls)\n* **Reusable components** - Common capabilities (identity reconciliation, authorization, event translation) centralized for reuse\n* **Anti-Corruption Layer pattern** - Demonstrates how to protect OTR domain model from external systems we don't control\n* **Conformist pattern for shared systems** - Establishes approach for platforms we don't own (shared enterprise platforms, SaaS vendors)\n* **Migration strategies** - Proves both phased rollout (feature flags, transition states) and big bang approaches for different risk profiles\n* **Pragmatic trade-offs** - Validates architectural decision framework balancing ideal design against time-to-value\n\nEvery design decision is made with **future bounded contexts in mind** - each solution doesn't just solve immediate business needs, it establishes architectural patterns and standards for all future work.\n\nSolution architectures are **learning investments** - the first implementation of a pattern is more expensive (team learning, infrastructure setup, standards definition), but subsequent implementations reuse the foundation at lower cost.","originalFile":"==== Strategic Architectural Philosophy\n\nThis solution architecture aligns with OTR's target Domain-Driven Design (DDD) architecture. The design choices reflect three core principles:\n\n1. **Protect digital channels from external system coupling** - Use Anti-Corruption Layers (ACLs) to isolate OTR's domain model from external systems we don't control\n2. **Establish event-driven architecture as the integration standard** - Loose coupling between bounded contexts via domain events, enabling independent evolution\n3. **Prioritise simplicity and time-to-value** - Make pragmatic trade-offs that reduce complexity while establishing architectural patterns for future work\n\n==== Why Domain-Driven Design with Bounded Contexts?\n\nThe decision to implement bounded contexts rather than direct integration to external systems reflects a strategic investment in architectural quality:\n\n*The Problem with Direct Integration*:\n\n* Digital channels (Mobile App, Web) tightly coupled to external system APIs (any external change breaks clients)\n* External systems controlled by vendors or other business units - we conform to their governance and configuration\n* Future integrations duplicate common logic (identity reconciliation, event translation, error handling)\n* No domain event publishing - other services can't react to business events\n* Business logic scattered across client applications instead of centralized in domain services\n\n*The DDD Solution*:\n\n* **Bounded contexts** isolate domain concerns with clear responsibility boundaries\n* **Anti-Corruption Layers (ACLs)** translate between OTR domain language and external system models\n* **Event Bus** publishes domain events - other bounded contexts can react without tight coupling\n* **Reusable components** - common logic (identity, authorization, event translation) centralized once, used by many\n* **Clear boundaries** - each context handles specific domain capabilities (different responsibilities, different change rates)\n\n*The Trade-Off*:\n\nWe accept **increased initial complexity** (additional services, Event Bus infrastructure, team learning DDD patterns) in exchange for **architectural foundation** that protects digital channels from external system changes and enables reusable components for future work.\n\nThis is a **strategic investment** - we're not just solving immediate integration needs, we're establishing the architectural pattern for all future bounded contexts.\n\n==== Why Async Processing Instead of Synchronous API Calls?\n\nWhen integrating with external systems, the decision between asynchronous and synchronous processing reflects a prioritization of user experience, resilience, and system characteristics:\n\n*The Problem with Synchronous Integration*:\n\n* User waits for external system API response (latency across multiple system hops)\n* If external system is down or slow, user-facing operations fail\n* No automatic retry - users must manually retry operations\n* API timeout must accommodate worst-case external system latency\n* Tight coupling between user experience and external system performance\n\n*The Async Solution*:\n\n* **Immediate acknowledgment** - User gets confirmation quickly (no external system wait)\n* **Resilience** - If external system is down, work queued and processed when system recovers\n* **Automatic retry** - Exponential backoff handles transient API failures\n* **Operational visibility** - Dead letter queue alerts ops team to persistent failures\n* **Scalability** - Queue buffering handles traffic spikes without overwhelming external systems\n\n*The Trade-Off*:\n\nWe accept **eventual consistency** (notifications delivered after external processing completes) and **increased complexity** (Event Bus, background workers, retry logic, DLQ monitoring) in exchange for **better user experience** (no waiting) and **resilience** (external system downtime doesn't block user-facing operations).\n\nThis trade-off is acceptable when operations are **not real-time transactions** (unlike payment processing). When business processes can tolerate short delays (seconds to minutes), async processing improves both user experience and system resilience.\n\n==== Why Conformist Pattern for Shared Platforms?\n\nWhen integrating with shared platforms controlled by other organisations or business units, the Conformist pattern reflects a pragmatic acceptance of organisational reality:\n\n*The Organisational Context*:\n\n* **Shared platform governance** - Another organisation or business unit owns and operates the platform\n* **Multi-tenant environment** - OTR is one user among many (competing priorities, shared governance)\n* **Limited control** - We don't control platform configuration, data models, or API evolution\n* **Strategic alignment** - Organisational decision to standardize on shared platforms (not build parallel systems)\n\n*The Conformist Approach*:\n\n* **Accept their data model** - Use platform-provided objects and fields with minimal customisation\n* **Conform to their API** - Use platform APIs as-is, avoid heavy customisation\n* **Work within their governance** - Data isolation via platform mechanisms (tenancy, record types, permissions)\n* **Anti-Corruption Layer protects us** - Bounded contexts translate between OTR domain language and platform models\n\n*Why Not Heavily Customise Shared Platforms?*:\n\n* **Governance constraints** - Platform owners must approve all customisations (slow, requires business case justification)\n* **Shared instance risk** - Custom code or triggers could impact other users (change control overhead)\n* **Upgrade risk** - Heavy customisation increases platform upgrade complexity and testing burden\n* **Limited control** - We don't control the platform, so we shouldn't over-invest in customisation we can't maintain\n* **Vendor lock-in** - Deep customisation makes platform migration more difficult if strategic direction changes\n\n*The Trade-Off*:\n\nWe accept **less control over data model and platform evolution** in exchange for **faster time-to-value** (minimal custom development), **reduced operational overhead** (less custom code to maintain), and **organisational alignment** (consolidate onto shared platforms).\n\nThe **Anti-Corruption Layer** is the protection mechanism - it translates between OTR's domain language and the platform, so platform changes are isolated to the ACL, not propagated to digital channels.\n\n==== When to Use Big Bang Cutover vs. Phased Rollout?\n\nThe choice between big bang cutover and phased rollout with feature flags reflects a risk assessment based on criticality, complexity, and reversibility:\n\n*When Phased Rollout is Appropriate*:\n\n* **High complexity** - Multiple system integrations, complex state management, transaction adjudication\n* **Mission-critical** - Errors directly impact customer value, revenue, or contractual obligations\n* **Large user base** - Gradual enablement reduces blast radius for defects\n* **Reversibility challenge** - Operations involve external parties or are difficult/impossible to reverse\n* **Data synchronization complexity** - Dual-write or data coexistence patterns required\n* **Regulatory requirements** - Compliance testing needed before full deployment\n\n*When Big Bang Cutover is Appropriate*:\n\n* **Lower complexity** - Simple CRUD operations, minimal state management\n* **Not mission-critical** - Failures don't prevent core business operations\n* **Manageable user base** - Impact contained to specific user segment\n* **Easy rollback** - Can revert to legacy system without data loss or partner coordination\n* **Faster legacy retirement** - No extended transition period maintaining two systems\n* **Simple feature** - Read-only operations or create-only workflows\n\n*The Trade-Off*:\n\nPhased rollout accepts **increased complexity** (feature flag management, transition architecture states, dual-write patterns) in exchange for **reduced risk** (gradual enablement, controlled blast radius, early defect detection).\n\nBig bang accepts **higher cutover risk** (all users switch at once) in exchange for **simplicity** (no feature flag management), **faster legacy system retirement** (no parallel run period), and **reduced transition complexity** (no intermediate architecture states).\n\n*Risk Mitigation for Big Bang*:\n\n* **Comprehensive testing** - Load testing at expected peak volume, integration testing, UAT\n* **Rollback plan** - Clear criteria and procedure to revert if critical issues emerge\n* **Non-blocking deployment** - Cutover doesn't prevent core operations if new system fails\n* **Limited blast radius** - Failure impacts specific capability, not entire platform\n\nChoose the migration strategy that matches the risk profile and business criticality of the capability being migrated.\n\n==== When to Migrate Historical Data vs. Fresh Start?\n\nThe decision to migrate historical data from legacy systems reflects a cost-benefit analysis that balances historical continuity with migration complexity:\n\n*The Case for Historical Data Migration*:\n\n* Users can access complete historical records in the new system\n* Continuity of business context for ongoing processes (customer history, audit trails)\n* Analytics and reporting across full historical timeline\n* Regulatory or compliance requirements for data retention\n* Business processes that reference historical data\n\n*The Case Against Historical Data Migration*:\n\n* **Limited operational value** - Historical data not critical for future operations (new data moving forward)\n* **Data quality concerns** - Legacy data may be inconsistent, incomplete, or poorly categorised\n* **Migration complexity** - Requires schema mapping, data transformation, validation, testing, reconciliation\n* **Delays cutover** - Data migration extends timeline significantly\n* **Cost-benefit imbalance** - Migration effort outweighs practical value of historical data\n* **Reference data only** - Historical data rarely updated, mainly used for lookups\n\n*Alternative Approaches*:\n\n* Legacy system remains accessible (read-only) temporarily for historical lookups\n* Data archived separately (data warehouse, static reports, export files)\n* Selective migration - only recent or high-value historical records\n* On-demand migration - migrate historical data only when needed for specific use cases\n\n*The Trade-Off*:\n\nHistorical data migration accepts **increased migration complexity** (schema mapping, transformation, validation) and **extended timeline** in exchange for **complete data continuity** in the new system.\n\nFresh start accepts **loss of historical data in new system** in exchange for **faster time-to-value**, **simpler migration** (no historical schema mapping), and **clean start** (no legacy data quality issues).\n\nChoose the approach that matches the business value of historical data against the cost and timeline impact of migration.\n\n==== Choosing Identity Matching Strategies\n\nThe choice of identity matching key reflects a trade-off between ideal design (stable, globally unique identifiers) and pragmatic implementation (available now, minimal coordination):\n\n*Ideal Matching Strategy*:\n\n* **Stable, globally unique identifier** - Doesn't change when user attributes change (email, phone, address)\n* **Cross-system consistency** - Same identifier used across all systems (single source of truth)\n* **Already available in external system** - Configured as External ID for efficient upsert operations\n* **Semantic meaning** - Identifier represents business entity clearly\n\n*Pragmatic Matching Strategy*:\n\n* **Available immediately** - Uses fields already present and indexed in external system\n* **No coordination required** - Doesn't require external system configuration changes or approvals\n* **Unique enough** - Functionally unique for practical purposes (edge cases acceptable)\n* **Always available** - Present in authentication tokens or API requests\n* **Standard field** - Uses platform-provided fields (no custom configuration)\n\n*Common Edge Cases*:\n\n* **Attribute changes** - User changes email, phone, or other matching attributes (creates duplicates)\n* **Data quality** - Missing, malformed, or inconsistent values in matching fields\n* **Uniqueness violations** - Multiple records share the same matching value\n* **Temporal consistency** - Matching value differs across systems at same point in time\n\n*Migration Path*:\n\nStart with pragmatic matching strategy for immediate implementation, then enhance to ideal matching strategy when coordination with external system stakeholders is feasible:\n\n1. **Phase 1**: Use available field (email, phone, username) - minimal coordination, faster time-to-value\n2. **Phase 2**: Add ideal identifier (global customer ID) to external system - requires coordination with platform team\n3. **Phase 3**: Migrate to ideal identifier for matching - update integration logic, backfill existing records\n\n*The Trade-Off*:\n\nIdeal matching accepts **coordination overhead** (external system configuration, stakeholder approval) and **delayed implementation** in exchange for **stable matching** (no duplicates when attributes change).\n\nPragmatic matching accepts **rare edge cases** (duplicates, manual cleanup) in exchange for **immediate implementation** (no external system changes) and **simplicity** (single available field).\n\nChoose the matching strategy that balances implementation speed against long-term data quality requirements.\n\n==== How Architectural Decisions Reinforce Each Other\n\nEffective solution architectures create **coherent strategies** where architectural decisions reinforce each other rather than existing as isolated choices:\n\n*Pattern: Bounded Contexts Enable Event-Driven Architecture*\n\n* **DDD bounded contexts** establish clear service boundaries with well-defined responsibilities\n* **Event Bus** enables bounded contexts to publish domain events to other contexts\n* **Loose coupling** - contexts integrate via events, not direct API calls or shared databases\n* **Independent evolution** - contexts can change internally without breaking consumers\n\n*Pattern: Async Processing Enables Resilience*\n\n* **Asynchronous integration** decouples user experience from external system performance\n* **Queue buffering** absorbs work when external systems are slow or unavailable\n* **Automatic retry** handles transient failures without user intervention\n* **Graceful degradation** - core operations continue even when external integrations fail\n\n*Pattern: Conformist with Anti-Corruption Layer*\n\n* **Conformist pattern** accepts external system data models to minimize customization\n* **ACL** translates between external models and internal domain language\n* **Protection** - external system changes isolated to ACL, not propagated to digital channels\n* **Organizational alignment** - use shared platforms while protecting domain model\n\n*Pattern: Migration Strategy Matches Risk Profile*\n\n* **Non-critical capabilities** can use simpler big bang cutover (faster legacy retirement)\n* **Mission-critical capabilities** require phased rollout (controlled blast radius)\n* **Fresh start** (no historical data migration) simplifies big bang cutover\n* **Comprehensive testing** mitigates big bang risk for non-critical workloads\n\n*Pattern: Pragmatic Shortcuts with Migration Path*\n\n* **Start with available identifiers** (email, username) for immediate implementation\n* **Plan enhancement path** to ideal identifiers (global customer ID) when feasible\n* **Accept edge cases** (rare duplicates) for faster time-to-value\n* **Non-breaking migration** - can add ideal identifier later without disrupting operations\n\n**Coherent architecture** emerges when each decision makes others more valuable or feasible, creating a reinforcing system of trade-offs aligned with business priorities.\n\n==== What This Establishes for Future Work\n\nThis implementation is the **architectural foundation** for OTR's target state:\n\n* **First bounded contexts** - ProfileService and EngagementService establish the pattern for LoyaltyService, PaymentService, LocationService, RecommendationService\n* **First event-driven integration** - Event Bus pattern reused for all future bounded context integration (not direct API calls)\n* **Reusable Contact reconciliation** - ProfileService Contact lookup reused for Flybuys partner linking, subscription billing, personalised recommendations\n* **Anti-Corruption Layer pattern** - EngagementService ACL demonstrates how to protect OTR domain model from external systems (EagleEye, Braze, D365 Commerce)\n* **Conformist pattern for shared systems** - Establishes approach for systems we don't control (Salesforce, Entra ID, Microsoft Fabric)\n\nEvery design decision is made with **future bounded contexts in mind** - we're not just solving customer support, we're establishing the architectural standards for all future work.\n","structuredPatch":[{"oldStart":248,"oldLines":12,"newStart":248,"newLines":16,"lines":[" "," ==== What This Establishes for Future Work"," ","-This implementation is the **architectural foundation** for OTR's target state:","+Each solution architecture contributes to the **architectural foundation** for OTR's target state:"," ","-* **First bounded contexts** - ProfileService and EngagementService establish the pattern for LoyaltyService, PaymentService, LocationService, RecommendationService","-* **First event-driven integration** - Event Bus pattern reused for all future bounded context integration (not direct API calls)","-* **Reusable Contact reconciliation** - ProfileService Contact lookup reused for Flybuys partner linking, subscription billing, personalised recommendations","-* **Anti-Corruption Layer pattern** - EngagementService ACL demonstrates how to protect OTR domain model from external systems (EagleEye, Braze, D365 Commerce)","-* **Conformist pattern for shared systems** - Establishes approach for systems we don't control (Salesforce, Entra ID, Microsoft Fabric)","+* **Bounded context patterns** - Establishes DDD service boundaries with clear responsibilities for future domain services","+* **Event-driven integration** - Event Bus pattern becomes standard for bounded context integration (not direct API calls)","+* **Reusable components** - Common capabilities (identity reconciliation, authorization, event translation) centralized for reuse","+* **Anti-Corruption Layer pattern** - Demonstrates how to protect OTR domain model from external systems we don't control","+* **Conformist pattern for shared systems** - Establishes approach for platforms we don't own (shared enterprise platforms, SaaS vendors)","+* **Migration strategies** - Proves both phased rollout (feature flags, transition states) and big bang approaches for different risk profiles","+* **Pragmatic trade-offs** - Validates architectural decision framework balancing ideal design against time-to-value"," ","-Every design decision is made with **future bounded contexts in mind** - we're not just solving customer support, we're establishing the architectural standards for all future work.","+Every design decision is made with **future bounded contexts in mind** - each solution doesn't just solve immediate business needs, it establishes architectural patterns and standards for all future work.","+","+Solution architectures are **learning investments** - the first implementation of a pattern is more expensive (team learning, infrastructure setup, standards definition), but subsequent implementations reuse the foundation at lower cost."]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"d7059d8e-6f9f-4d64-bddd-fb5eabd1eb74"}
{"parentUuid":"51852557-847e-4fa9-8804-5ce8587570db","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_011bsNRPjPut7cvwrCivakZE","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Perfect! I've successfully generalized the architectural_approach.adoc file. Let me verify the changes by doing a quick grep to make sure I've removed the Salesforce-specific references.","signature":"EuMCCkYICxgCKkA+G69zYDHEVZ7VcCijPcO/cAlmRtZJTkXn+++eT9kq2Bg5Rn8MGOdqBm6Hu+hTnWCKpeKRZTmoRDqTywbUKozEEgzqNXJ48AmDoZV6qM4aDDaD6iO51zvV1B0Y8yIwZ9BAu8IMDO8YbOSYogDJxwhwNuVVk69B7baTXbx2lI84YTeEZlHZLDuN2bzPNQ9jKsoBWHcJrOrYuT4llPoyf2QM9NE9mjAlneYS+GUXHJgr4pHGJWERdvl1cDTfzRbOxkzcoLc9q6WEiJH0PYj+b3OuXNKBbMmnRKRYdXL88mILTU7gqjEofItI7SGB2QosDIZRlu2dCQnbsL0GqTrnMgishQ6KH+XinsR8ds880YklDBbu57IfVyX96NIGtGhFUTaK72vd163IH1btRAXc3PmfH+ane97mdPOjDdz1Xvv4jfaZRzBc19xk880p4+As/rdfKdUXEtPLxqtw/xgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":1190,"cache_read_input_tokens":50822,"cache_creation":{"ephemeral_5m_input_tokens":1190,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWuPJKnio2hwAvSMFpC7v","type":"assistant","uuid":"24ea7e8d-e367-47c9-8bc6-04598b8b8faa","timestamp":"2026-01-08T05:48:38.860Z"}
{"parentUuid":"24ea7e8d-e367-47c9-8bc6-04598b8b8faa","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_011bsNRPjPut7cvwrCivakZE","type":"message","role":"assistant","content":[{"type":"text","text":"Let me verify that the file is now more generic and less Salesforce-specific."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":1190,"cache_read_input_tokens":50822,"cache_creation":{"ephemeral_5m_input_tokens":1190,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWuPJKnio2hwAvSMFpC7v","type":"assistant","uuid":"3eb994ce-a9f7-4119-af97-0ba0db467322","timestamp":"2026-01-08T05:48:39.597Z"}
{"parentUuid":"3eb994ce-a9f7-4119-af97-0ba0db467322","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_011bsNRPjPut7cvwrCivakZE","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_015o9AjgBn14BJWW9iFordnB","name":"Grep","input":{"pattern":"(Salesforce|ProfileService|EngagementService|D365 CE|Case|Contact)","path":"/mnt/c/Users/o.young/work/architecture/architectural_approach.adoc","output_mode":"content","-n":true}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":1190,"cache_read_input_tokens":50822,"cache_creation":{"ephemeral_5m_input_tokens":1190,"ephemeral_1h_input_tokens":0},"output_tokens":215,"service_tier":"standard"}},"requestId":"req_011CWuPJKnio2hwAvSMFpC7v","type":"assistant","uuid":"3efc652a-489a-4a81-b796-f1c599b55519","timestamp":"2026-01-08T05:48:41.112Z"}
{"parentUuid":"3efc652a-489a-4a81-b796-f1c599b55519","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_015o9AjgBn14BJWW9iFordnB","type":"tool_result","content":"134:*The Case for Historical Data Migration*:\r\n142:*The Case Against Historical Data Migration*:\r\n185:*Common Edge Cases*:"}]},"uuid":"b4792d4e-fd09-46b8-87bb-046ff2962f70","timestamp":"2026-01-08T05:48:42.516Z","toolUseResult":{"mode":"content","numFiles":0,"filenames":[],"content":"134:*The Case for Historical Data Migration*:\r\n142:*The Case Against Historical Data Migration*:\r\n185:*Common Edge Cases*:","numLines":3},"sourceToolAssistantUUID":"3efc652a-489a-4a81-b796-f1c599b55519"}
{"parentUuid":"b4792d4e-fd09-46b8-87bb-046ff2962f70","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01Bsqt7S7BfVNRjHU3mVt9Tm","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Excellent! The only occurrences of \"Case\" are now in the generic context of \"The Case for...\" and \"The Case Against...\" (making an argument) and \"Common Edge Cases\" (technical edge cases), not referring to Salesforce Cases. All Salesforce-specific references have been removed.\n\nLet me also check if there are any other project-specific references I might have missed.","signature":"EpkECkYICxgCKkB8Tle4SYWk7cnYyiW7iewZpyedNiKSPwDpZfgNGo7iFprFNoFr/mb1avFqRHoRMO+aasAzIOKFrYj6VDAi0vDbEgxnr9YfNN9ag88yMCQaDI9thT0zSVmq2GLG3iIwHsVDq2kXdAeySC1bw2+rPnTyUcDLu3x98RtItF1tPIsdq0qF3k9ZZp5kTd3+mH2gKoADNl2OUXl8cNw+8p3qP52IQyzH+qx1fCO9dPBd2liuHu1ZyR2G/q/baNwaM1Y3pr43Ogk7hcXiqxeLM8R3QG086noipGfujrlqD5VybKeIDD+21Xp0VP8OmmWtwQDCNhYjsFJF5K1Vta46RlBgQBioU2o5cDldrQeSHADmL/eBalCz95iLpf3uVHkbUioCkBYB30aK5o/Q9B1+gFiwt8H9wneipct+FqiHk0awZzIm/OgMsxCJFZ4JwAtQZFjkeSL8otFetXj/S1F2k0IB7jWRbiZZ3ZQ038TKD6PrOrmsAdMLnvfG6qoopfREjJ/o9ilYSki94jxqSLNxqmg8OpWC1sWAOlyxsWMWBbi180C/XxNfN2HWTWrIO6kPO5X+buz8UVKue8WEWpUZRMfC4T5PMEhjAYxffPiGdBslOtDtbTw0+Ldf/A1Vc+ZY7Cz0GjVPTx/FIeX8B+t1YYmYMv0GCnuHTsjmsr4ba/DCi9iHE+BK3Bc3lQSgl9xDgBXSxQxXGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":4,"cache_creation_input_tokens":266,"cache_read_input_tokens":52012,"cache_creation":{"ephemeral_5m_input_tokens":266,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CWuPJrbdaqXHFKSZQYEyS","type":"assistant","uuid":"f1794843-fc55-4faf-ac35-30b51e338d34","timestamp":"2026-01-08T05:48:47.532Z"}
{"parentUuid":"f1794843-fc55-4faf-ac35-30b51e338d34","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01Bsqt7S7BfVNRjHU3mVt9Tm","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_019a61JF9MtpAuiuv5AceoXz","name":"Grep","input":{"pattern":"(Flybuys|customer support|customer feedback|VCI|Viva Consumer ID|Viva Energy)","path":"/mnt/c/Users/o.young/work/architecture/architectural_approach.adoc","output_mode":"content","-n":true}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":4,"cache_creation_input_tokens":266,"cache_read_input_tokens":52012,"cache_creation":{"ephemeral_5m_input_tokens":266,"ephemeral_1h_input_tokens":0},"output_tokens":243,"service_tier":"standard"}},"requestId":"req_011CWuPJrbdaqXHFKSZQYEyS","type":"assistant","uuid":"612f5779-706d-497d-8aad-810f055dda33","timestamp":"2026-01-08T05:48:49.296Z"}
{"parentUuid":"612f5779-706d-497d-8aad-810f055dda33","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_019a61JF9MtpAuiuv5AceoXz","type":"tool_result","content":"No matches found"}]},"uuid":"9a67c641-f97a-4b39-b129-5575368a3eb4","timestamp":"2026-01-08T05:48:51.176Z","toolUseResult":{"mode":"content","numFiles":0,"filenames":[],"content":"","numLines":0},"sourceToolAssistantUUID":"612f5779-706d-497d-8aad-810f055dda33"}
{"parentUuid":"9a67c641-f97a-4b39-b129-5575368a3eb4","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01MXyC58fjStk3Pt4kWHLE3T","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Perfect! All project-specific references have been removed. The file is now a generic template that explains architectural patterns and decision-making approaches that can be used across any solution architecture document.\n\nLet me create a summary of the changes for the user.","signature":"Er0DCkYICxgCKkB14PQ8HV3d4MON0uciltQPJdfKU+ZGfXuQKPZ9uhqtEabkAeRe8byJmY8EAiiLhS315IaEXESfMMSCs8LNlVPBEgwPmr+3i90gxih/LS0aDA2zDvjxR+SwFXOJPSIwLOIweMKXHuHspeR/mWvGZPgmkxUWwkfv1OZtwy/YWby2xzxrRHnxX7sUG8wzxUb1KqQCwApDmKjwAbZfpGeACSEh2zapgNLqlTxf65Q6mUhgEraHNGlxvBGU1zNdAcZ9ZUbbY5pWV4I2o43iklGpASCx/DRTBb5wc4T6fOSt5U5Yp3u8NCY1akUTQ+7qm/Yk/l8jogL3K8m6bBAS2cd8+zF+GEuZoYHkxJh6+xkQFbG98RzQID52GHmfpVIv0qOhZSDjX2gO2vmk31s9w55Xzy30VfJDrUdlx6Uoe8lTWejjqUJhhLG1o4li9m2VMnFL+QJfs2mmffT4WgI/ydfoSWPjCktE39kXwcIVBGVmdJoUq81DZH8iKiai3RVLA7Sgnz4YVjADhp3Z5QylhvtVGlIEi3cK6BmmYS26kUjMBYv7XxgLG/tUCTQGOD2m/Mruu0KDGVa1ZxgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":4,"cache_creation_input_tokens":265,"cache_read_input_tokens":52278,"cache_creation":{"ephemeral_5m_input_tokens":265,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWuPKVp1SfNiF7GZgEHZD","type":"assistant","uuid":"046fa741-38a5-49b2-8b9c-9121232273ef","timestamp":"2026-01-08T05:48:54.731Z"}
{"parentUuid":"046fa741-38a5-49b2-8b9c-9121232273ef","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01MXyC58fjStk3Pt4kWHLE3T","type":"message","role":"assistant","content":[{"type":"text","text":"Perfect! I've successfully generalized the architectural_approach.adoc file. Here's what changed:\n\n**Removed Specific Project References:**\n- Salesforce, ProfileService, EngagementService\n- D365 CE, Flybuys integration\n- VCI (Viva Consumer ID), Viva Energy\n- Customer support/feedback specific scenarios\n\n**Generalized to Reusable Patterns:**\n\n1. **Strategic Philosophy** - Now references \"external systems we don't control\" instead of specific vendors\n2. **DDD with Bounded Contexts** - Generic benefits of bounded contexts vs. direct integration\n3. **Async vs Sync** - General principles for choosing async processing with any external system\n4. **Conformist Pattern** - Now about \"shared platforms\" instead of just Salesforce\n5. **Migration Strategy** - Decision criteria for big bang vs. phased (not comparing specific projects)\n6. **Historical Data Migration** - General trade-offs instead of D365 CE Case migration\n7. **Identity Matching** - Generic strategies instead of email vs. VCI for Salesforce\n8. **Reinforcing Decisions** - Architectural patterns instead of specific ADR references\n9. **Future Foundation** - Generic contribution to target architecture\n\nThe file is now a **template** that can be included in any solution architecture document to explain the architectural philosophy and decision-making framework, with principles applicable across all OTR projects."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":4,"cache_creation_input_tokens":265,"cache_read_input_tokens":52278,"cache_creation":{"ephemeral_5m_input_tokens":265,"ephemeral_1h_input_tokens":0},"output_tokens":378,"service_tier":"standard"}},"requestId":"req_011CWuPKVp1SfNiF7GZgEHZD","type":"assistant","uuid":"aa4dc54c-032e-475d-98fd-62b04870f401","timestamp":"2026-01-08T05:49:01.931Z"}
{"parentUuid":"aa4dc54c-032e-475d-98fd-62b04870f401","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","type":"system","subtype":"turn_duration","durationMs":254014,"timestamp":"2026-01-08T05:49:03.384Z","uuid":"177ec798-0288-41c6-8bca-6532f835b241","isMeta":false}
{"type":"file-history-snapshot","messageId":"beb87897-e40e-417e-b43a-92d8c661ee9c","snapshot":{"messageId":"beb87897-e40e-417e-b43a-92d8c661ee9c","trackedFileBackups":{"solution_architectures/flybuys_integration.adoc":{"backupFileName":"63d414abe912008a@v2","version":2,"backupTime":"2026-01-08T05:44:49.416Z"},"architectural_approach.adoc":{"backupFileName":"06cdfdafe20b60d5@v2","version":2,"backupTime":"2026-01-08T05:49:55.086Z"}},"timestamp":"2026-01-08T05:49:55.070Z"},"isSnapshotUpdate":false}
{"parentUuid":"177ec798-0288-41c6-8bca-6532f835b241","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","type":"user","message":{"role":"user","content":"<local-command-caveat>Caveat: The messages below were generated by the user while running local commands. DO NOT respond to these messages or otherwise consider them in your response unless the user explicitly asks you to.</local-command-caveat>"},"isMeta":true,"uuid":"9b065ae6-54a9-4e39-a180-38f37087b7f1","timestamp":"2026-01-08T05:49:55.052Z"}
{"parentUuid":"9b065ae6-54a9-4e39-a180-38f37087b7f1","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","type":"user","message":{"role":"user","content":"<command-name>/exit</command-name>\n            <command-message>exit</command-message>\n            <command-args></command-args>"},"uuid":"beb87897-e40e-417e-b43a-92d8c661ee9c","timestamp":"2026-01-08T05:49:55.050Z"}
{"parentUuid":"beb87897-e40e-417e-b43a-92d8c661ee9c","isSidechain":false,"userType":"external","cwd":"/mnt/c/Users/o.young/work/architecture","sessionId":"e680ea8c-6c11-4a5a-ac3f-d4c072e5d046","version":"2.1.1","gitBranch":"main","slug":"quizzical-riding-ullman","type":"user","message":{"role":"user","content":"<local-command-stdout>See ya!</local-command-stdout>"},"uuid":"5b9e71cf-3cc3-4414-be24-3dd8411baecc","timestamp":"2026-01-08T05:49:55.050Z"}
{"type":"summary","summary":"Standardize phase naming convention to TS","leafUuid":"5b9e71cf-3cc3-4414-be24-3dd8411baecc"}
