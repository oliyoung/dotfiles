Introduction:
VIVA is set to send daily Flybuys member transaction data to Flybuys during the promotion period. This solution involves the transfer of two types of files:

Transaction File: Contains daily transaction details of Flybuys members.

Product Hierarchy File: Provides the structure and categorization of products involved in the transactions (this is limited to Viva products)

The solution is built using Azure Data Factory (ADF) and Azure Data Lake Storage (ADLS), ensuring a robust and scalable data transfer process. The key features of this solution include:

Daily Scheduled Transfers: Data files are transferred daily via Secure File Transfer Protocol (SFTP) to Flybuys.

Pause Capability: The Flybuys can request to pause the daily SFTP transfers if needed. This can be managed through a control mechanism in ADF, allowing for flexibility during the promotion period.

Technical Overview:

File Export:

Fabrics Pipelines: Pipelines are configured to extract data from RAW and prepare the transaction and product hierarchy files using outbound metadata framework.

Data Storage: Files are stored in ADLS before being transferred.

Data Transfer:

SFTP Integration: ADF pipelines are set up to securely transfer files to Flybuy's SFTP server.

Scheduling: Transfers are scheduled to run daily, with the ability to pause the schedule upon request.

Control Mechanism:

Pause/Resume Functionality: Implemented using ADF's control flow activities, allowing the reward management company to pause and resume the data transfer schedule as required.

Template for solution design cloned from 
DATA-SD-03-02-04 FlyBuys Points File
 

 

FlyBuys Transaction & Product File Build components:
FlyBuys Transaction file logic:

Following query generate daily transaction file data 



;WITH cte_main AS
(
SELECT
fb.flybuysbarcode,
r.transdate as transaction_date,
rst.itemid as sku_key, 
rst.linenum,
r.store as store_idnt,
rst.netamountincltax as total_sales_amount,
rst.taxamount as total_sales_gst_amount,
rst.discamount,
rst.qty as total_basket_quantity,
FORMAT(dateadd(s, r.transtime, r.transdate),'hh:mm') as concat_hour_minute_nbr,
--r.transactionid+'-'+rst.itemid as transaction_identifier
rt.information as return_reason_code,
ct.cardtypeid as tender_item_sub_type_code,
r.transactionid as transaction_identifier
FROM dbo.D365_retailtransactiontable r
LEFT JOIN D365_retailtransactionsalestrans rst ON r.transactionid=rst.transactionid and r.store=rst.store and r.terminal=rst.terminalid and r.dataareaid = rst.dataareaid
left join D365_inventtable I on I.itemid = rst.itemid and rst.dataareaid = I.dataareaid
left join D365_ecoresproducttranslation PT on I.product = PT.product  and PT.languageid= 'en-AU'
left join D365_verretailtransactiontable fb on fb.transactionid = r.transactionid and fb.store=r.store and fb.terminal=r.terminal and fb.dataareaid = r.dataareaid
left join D365_retailtransactioninfocodetrans rt on rt.transactionid = r.transactionid and rt.store=r.store and rt.terminal=r.terminal and rt.dataareaid = r.dataareaid
left join D365_retailtransactionpaymenttrans ct on ct.transactionid = r.transactionid and ct.store=r.store and ct.terminal=r.terminal and ct.dataareaid = r.dataareaid
WHERE r.entrystatus in (0,2) -- 0 is non, and 2= posted
  and rst.transactionstatus in (0,2)
  and r.type = 2 
  and fb.flybuysbarcode is not null
),
cte_join_member AS
(
SELECT
    xx.[FB_FULL_CARD_NUM] as group_loyalty_card_number,
    x.transaction_date,
    x.sku_key,
    x.discamount,
    convert(int,x.linenum) as linenum,
    x.store_idnt,    
    convert(decimal(10, 2),total_sales_gst_amount) as total_sales_gst_amount ,
    convert(decimal(10, 2),x.total_sales_amount) as total_sales_amount,
    x.total_basket_quantity,
    x.concat_hour_minute_nbr,
    substring(xx.[BARCODE_NUM],4,8) as group_loyalty_member_number,
    x.return_reason_code,
    x.tender_item_sub_type_code,
    x.transaction_identifier
FROM cte_main x left join [dbo].[Member] xx
    on x.flybuysbarcode=xx.[BARCODE_NUM]
),
cte_final AS
(
SELECT
transaction_identifier+'-'+convert(varchar(10),linenum) as TRANSACTION_IDENTIFIER,
transaction_identifier as TRANSACTION_NUMBER,
linenum as LINE_ITEM_NUMBER,
transaction_date, ---check
concat_hour_minute_nbr as DAY_HOUR_NUMBER,
'VE' as EDW_BUSINESS_BRAND_CODE,
store_idnt as STORE_INDT,    
sku_key as STORE_KEY, --check
sku_key ,
colece(group_loyalty_card_number,0,1) as GROUP_LOYALTY_CARD_INDICATOR,
return_reason_code as RETURN_REASON_CODE,
case when group_loyalty_card_number is null then 0 else 1 end as GIFT_CARD_INDICATOR,
total_sales_gst_amount as TOTAL_DISCOUNT_GST,
discamount as TOTAL_DISCOUNT_AMOUNT,
total_sales_amount as TOTAL_SALES_AMOUNT,
total_basket_quantity as TOTAL_BASKET_QUANTITY,
group_loyalty_member_number as GROUP_LOYALTY_MEMBER_NUMBER,
tender_item_sub_type_code as TENDER_ITEM_SUB_TYPE_CODE
FROM cte_join_member
)
select * from cte_final order by TRANSACTION_IDENTIFIER
FlyBuys Producy file logic:

Following query generate daily product hierarchy file data 



SELECT      
       [productnumber]      
      ,categoryhierarchyid
      ,[productname]      
         ,tt.CatNameL2 as category_level1_code
         ,tt.CatNameL2 as category_level1_name
         ,tt.CatNameL3 as category_level2_code
         ,tt.CatNameL3 as category_level2_name
         ,tt.CatNameL4 as category_level3_code
         ,tt.CatNameL4 as category_level3_name
         ,tt.CatNameL5 as category_level4_code
         ,tt.CatNameL5 as category_level4_name
  FROM [dbo].[ecoresproductv2entity] epe
    Left JOIN 
  (
  SELECT ec.categoryhierarchy as categoryhierarchyid
                ,ech.name as CatHierarchyName
                ,ec.recid as categoryid
                ,ec.code as CatcodeL1, ec.name as CatNameL1, ec.level as catlevel1, ec.parentcategory as parentcategoryid,  ec.isactive
                ,ec2.code as CatcodeL2,  ec2.name as CatNameL2,ec2.level as catlevel2
                ,ec3.code as CatcodeL3,  ec3.name as CatNameL3,ec3.level as catlevel3
                ,ec4.code as CatcodeL4,  ec4.name as CatNameL4,ec4.level as catlevel4
                ,ec5.code as CatcodeL5,  ec5.name as CatNameL5,ec5.level as catlevel5
FROM [dbo].[D365_ecorescategory] ec
left JOIN [dbo].[D365_ecorescategoryhierarchy] ech ON ec.categoryhierarchy=ech.recid
left JOIN [dbo].[D365_ecorescategory] ec2  ON ec.recid =  ec2.parentcategory
left JOIN [dbo].[D365_ecorescategory] ec3  ON ec2.recid = ec3.parentcategory
left JOIN [dbo].[D365_ecorescategory] ec4  ON ec3.recid = ec4.parentcategory
left JOIN [dbo].[D365_ecorescategory] ec5  ON ec4.recid = ec5.parentcategory
where ech.name='Retail Product Category'
  and ec.parentcategory = 0 ) tt
  on  epe.retailproductcategoryname=tt.CatNameL5
Appendix
Build Items
 

Item Type

Item Name

Workspace/Lakehouse

Developer

Notebook

NB_CM_Outbound_FB_Trans_Extract

PRP_LH_CM_Raw

Nilesh Gawade

Pipeline

PL_CM_process_FB_Trans_outbound_extract

PRP_LH_CM_Raw

Nilesh Gawade

Metadata Table

metadata_outbound

PRP_LH_CM_Log_Config

Nilesh Gawade

image-20241127-064536.png
PL_CM_process_FB_Trans_outbound_extract

This pipeline generates transaction and product hierarchy file weekly every Monday, ADF job watch for new files under both (Member_Transactions & Product_Hierarchy) location, encrypt and sftp to flybuys server

image-20241218-074551.png
File Location:

 

image-20241218-074856.png
 