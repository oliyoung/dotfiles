{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://otr.com.au/schemas/engagement-events.json",
  "title": "Engagement Service Domain Events",
  "description": "CloudEvents 1.0 compatible domain event schemas for customer engagement and support operations",
  "version": "1.0.0",
  "definitions": {
    "CloudEventsEnvelope": {
      "type": "object",
      "required": ["specversion", "type", "source", "id", "time", "data"],
      "properties": {
        "specversion": {
          "type": "string",
          "const": "1.0",
          "description": "CloudEvents specification version"
        },
        "type": {
          "type": "string",
          "description": "Event type identifier"
        },
        "source": {
          "type": "string",
          "format": "uri",
          "description": "Identifies the context in which an event happened"
        },
        "id": {
          "type": "string",
          "format": "uuid",
          "description": "Unique identifier for the event"
        },
        "time": {
          "type": "string",
          "format": "date-time",
          "description": "Timestamp when the event occurred (ISO 8601)"
        },
        "datacontenttype": {
          "type": "string",
          "default": "application/json",
          "description": "Content type of the data attribute"
        },
        "dataschema": {
          "type": "string",
          "format": "uri",
          "description": "URI of the schema that data adheres to"
        },
        "subject": {
          "type": "string",
          "description": "Subject of the event in the context of the event producer"
        },
        "data": {
          "type": "object",
          "description": "Event-specific payload"
        }
      }
    },
    "CustomerFeedbackSubmittedData": {
      "type": "object",
      "required": ["vivaConsumerId", "feedbackId", "submittedAt", "category", "message"],
      "properties": {
        "vivaConsumerId": {
          "type": "string",
          "description": "Universal customer identifier"
        },
        "feedbackId": {
          "type": "string",
          "format": "uuid",
          "description": "Unique identifier for the feedback submission"
        },
        "submittedAt": {
          "type": "string",
          "format": "date-time",
          "description": "When the customer submitted the feedback (ISO 8601)"
        },
        "category": {
          "type": "string",
          "enum": ["General Feedback", "Complaint", "Compliment", "Product Query", "Store Facilities", "Fuel Quality", "Staff Service", "Other"],
          "description": "Category of feedback selected by customer"
        },
        "storeName": {
          "type": "string",
          "description": "Name of the store the feedback relates to (optional)"
        },
        "timeOfVisit": {
          "type": "string",
          "format": "date-time",
          "description": "When the customer visited the store (ISO 8601, optional)"
        },
        "contactPhoneNumber": {
          "type": "string",
          "pattern": "^\\+?[1-9]\\d{1,14}$",
          "description": "Customer's preferred contact phone number (E.164 format, optional)"
        },
        "message": {
          "type": "string",
          "maxLength": 5000,
          "description": "Free-text feedback message from customer"
        },
        "contactPreference": {
          "type": "string",
          "enum": ["Email", "Phone", "None"],
          "default": "Email",
          "description": "How the customer prefers to be contacted about this feedback"
        }
      }
    },
    "SupportCaseCreatedData": {
      "type": "object",
      "required": ["vivaConsumerId", "feedbackId", "salesforceCaseId", "caseNumber", "status", "createdAt"],
      "properties": {
        "vivaConsumerId": {
          "type": "string",
          "description": "Universal customer identifier"
        },
        "feedbackId": {
          "type": "string",
          "format": "uuid",
          "description": "Original feedback submission ID that triggered this case"
        },
        "salesforceCaseId": {
          "type": "string",
          "pattern": "^[a-zA-Z0-9]{15,18}$",
          "description": "Salesforce Case ID (15 or 18 character)"
        },
        "caseNumber": {
          "type": "string",
          "description": "Human-readable case number from Salesforce"
        },
        "salesforceContactId": {
          "type": "string",
          "pattern": "^[a-zA-Z0-9]{15,18}$",
          "description": "Salesforce Contact ID linked to this case"
        },
        "status": {
          "type": "string",
          "enum": ["New", "In Progress", "Escalated", "Resolved", "Closed"],
          "description": "Current status of the support case"
        },
        "priority": {
          "type": "string",
          "enum": ["Low", "Medium", "High", "Critical"],
          "default": "Medium",
          "description": "Priority level assigned to the case"
        },
        "category": {
          "type": "string",
          "description": "Category of the support case"
        },
        "subject": {
          "type": "string",
          "description": "Brief subject line for the case"
        },
        "createdAt": {
          "type": "string",
          "format": "date-time",
          "description": "When the case was created in Salesforce (ISO 8601)"
        }
      }
    },
    "SupportCaseUpdatedData": {
      "type": "object",
      "required": ["vivaConsumerId", "salesforceCaseId", "caseNumber", "updatedAt", "updatedBy", "changes"],
      "properties": {
        "vivaConsumerId": {
          "type": "string",
          "description": "Universal customer identifier"
        },
        "salesforceCaseId": {
          "type": "string",
          "pattern": "^[a-zA-Z0-9]{15,18}$",
          "description": "Salesforce Case ID (15 or 18 character)"
        },
        "caseNumber": {
          "type": "string",
          "description": "Human-readable case number from Salesforce"
        },
        "updatedAt": {
          "type": "string",
          "format": "date-time",
          "description": "When the case was updated in Salesforce (ISO 8601)"
        },
        "updatedBy": {
          "type": "object",
          "required": ["salesforceUserId", "name"],
          "properties": {
            "salesforceUserId": {
              "type": "string",
              "pattern": "^[a-zA-Z0-9]{15,18}$",
              "description": "Salesforce User ID of the agent who made the update"
            },
            "name": {
              "type": "string",
              "description": "Name of the agent who made the update"
            }
          }
        },
        "changes": {
          "type": "object",
          "description": "Fields that were changed in this update",
          "properties": {
            "status": {
              "type": "object",
              "properties": {
                "from": {"type": "string"},
                "to": {"type": "string"}
              }
            },
            "priority": {
              "type": "object",
              "properties": {
                "from": {"type": "string"},
                "to": {"type": "string"}
              }
            },
            "assignedTo": {
              "type": "object",
              "properties": {
                "from": {"type": "string"},
                "to": {"type": "string"}
              }
            },
            "comment": {
              "type": "string",
              "description": "New comment added by the agent"
            }
          }
        },
        "currentStatus": {
          "type": "string",
          "enum": ["New", "In Progress", "Escalated", "Resolved", "Closed"],
          "description": "Current status after the update"
        }
      }
    },
    "SupportCaseResolvedData": {
      "type": "object",
      "required": ["vivaConsumerId", "salesforceCaseId", "caseNumber", "resolvedAt", "resolvedBy", "resolution"],
      "properties": {
        "vivaConsumerId": {
          "type": "string",
          "description": "Universal customer identifier"
        },
        "salesforceCaseId": {
          "type": "string",
          "pattern": "^[a-zA-Z0-9]{15,18}$",
          "description": "Salesforce Case ID (15 or 18 character)"
        },
        "caseNumber": {
          "type": "string",
          "description": "Human-readable case number from Salesforce"
        },
        "resolvedAt": {
          "type": "string",
          "format": "date-time",
          "description": "When the case was resolved in Salesforce (ISO 8601)"
        },
        "resolvedBy": {
          "type": "object",
          "required": ["salesforceUserId", "name"],
          "properties": {
            "salesforceUserId": {
              "type": "string",
              "pattern": "^[a-zA-Z0-9]{15,18}$",
              "description": "Salesforce User ID of the agent who resolved the case"
            },
            "name": {
              "type": "string",
              "description": "Name of the agent who resolved the case"
            }
          }
        },
        "resolution": {
          "type": "object",
          "required": ["status", "resolutionNotes"],
          "properties": {
            "status": {
              "type": "string",
              "enum": ["Resolved", "Closed"],
              "description": "Final status of the case"
            },
            "resolutionType": {
              "type": "string",
              "enum": ["Issue Resolved", "Question Answered", "Duplicate Case", "Customer No Response", "Cannot Reproduce", "Other"],
              "description": "Type of resolution"
            },
            "resolutionNotes": {
              "type": "string",
              "maxLength": 5000,
              "description": "Notes explaining how the case was resolved"
            }
          }
        },
        "customerNotified": {
          "type": "boolean",
          "description": "Whether the customer was notified of the resolution"
        },
        "satisfactionRating": {
          "type": "integer",
          "minimum": 1,
          "maximum": 5,
          "description": "Customer satisfaction rating (1-5 stars, optional)"
        }
      }
    }
  },
  "events": {
    "CustomerFeedbackSubmitted": {
      "description": "Published when a customer submits feedback via Mobile App (before async Case creation in Salesforce)",
      "allOf": [
        {"$ref": "#/definitions/CloudEventsEnvelope"},
        {
          "properties": {
            "type": {"const": "com.otr.engagement.customerfeedbacksubmitted.v1"},
            "source": {"const": "/engagementservice"},
            "data": {"$ref": "#/definitions/CustomerFeedbackSubmittedData"}
          }
        }
      ],
      "example": {
        "specversion": "1.0",
        "type": "com.otr.engagement.customerfeedbacksubmitted.v1",
        "source": "/engagementservice",
        "id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
        "time": "2026-01-07T14:23:45Z",
        "datacontenttype": "application/json",
        "dataschema": "https://otr.com.au/schemas/engagement-events.json#/definitions/CustomerFeedbackSubmittedData",
        "subject": "customer/VIVA-12345678/feedback/a1b2c3d4-e5f6-7890-abcd-ef1234567890",
        "data": {
          "vivaConsumerId": "VIVA-12345678",
          "feedbackId": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
          "submittedAt": "2026-01-07T14:23:45Z",
          "category": "Complaint",
          "storeName": "OTR Port Adelaide",
          "timeOfVisit": "2026-01-07T10:30:00Z",
          "contactPhoneNumber": "+61412345678",
          "message": "The fuel pump was not working properly and I had to wait 20 minutes for assistance.",
          "contactPreference": "Phone"
        }
      }
    },
    "SupportCaseCreated": {
      "description": "Published when EngagementService successfully creates a Case in Salesforce after async processing",
      "allOf": [
        {"$ref": "#/definitions/CloudEventsEnvelope"},
        {
          "properties": {
            "type": {"const": "com.otr.engagement.supportcasecreated.v1"},
            "source": {"const": "/engagementservice"},
            "data": {"$ref": "#/definitions/SupportCaseCreatedData"}
          }
        }
      ],
      "example": {
        "specversion": "1.0",
        "type": "com.otr.engagement.supportcasecreated.v1",
        "source": "/engagementservice",
        "id": "b2c3d4e5-f6a7-8901-bcde-f12345678901",
        "time": "2026-01-07T14:24:12Z",
        "datacontenttype": "application/json",
        "dataschema": "https://otr.com.au/schemas/engagement-events.json#/definitions/SupportCaseCreatedData",
        "subject": "customer/VIVA-12345678/case/5001234567890AB",
        "data": {
          "vivaConsumerId": "VIVA-12345678",
          "feedbackId": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
          "salesforceCaseId": "5001234567890AB",
          "caseNumber": "00001234",
          "salesforceContactId": "0031234567890AB",
          "status": "New",
          "priority": "High",
          "category": "Complaint",
          "subject": "Fuel pump malfunction - Port Adelaide",
          "createdAt": "2026-01-07T14:24:12Z"
        }
      }
    },
    "SupportCaseUpdated": {
      "description": "Published when a support agent updates a Case in Salesforce (status, priority, comment changes). Triggered by Salesforce Platform Event webhook.",
      "allOf": [
        {"$ref": "#/definitions/CloudEventsEnvelope"},
        {
          "properties": {
            "type": {"const": "com.otr.engagement.supportcaseupdated.v1"},
            "source": {"const": "/engagementservice/salesforce-webhook"},
            "data": {"$ref": "#/definitions/SupportCaseUpdatedData"}
          }
        }
      ],
      "example": {
        "specversion": "1.0",
        "type": "com.otr.engagement.supportcaseupdated.v1",
        "source": "/engagementservice/salesforce-webhook",
        "id": "c3d4e5f6-a7b8-9012-cdef-123456789012",
        "time": "2026-01-07T16:45:30Z",
        "datacontenttype": "application/json",
        "dataschema": "https://otr.com.au/schemas/engagement-events.json#/definitions/SupportCaseUpdatedData",
        "subject": "customer/VIVA-12345678/case/5001234567890AB",
        "data": {
          "vivaConsumerId": "VIVA-12345678",
          "salesforceCaseId": "5001234567890AB",
          "caseNumber": "00001234",
          "updatedAt": "2026-01-07T16:45:30Z",
          "updatedBy": {
            "salesforceUserId": "0051234567890AB",
            "name": "Sarah Thompson"
          },
          "changes": {
            "status": {
              "from": "New",
              "to": "In Progress"
            },
            "assignedTo": {
              "from": "Queue: Customer Support",
              "to": "Sarah Thompson"
            },
            "comment": "Contacted customer to arrange on-site technician visit. Scheduled for 10 Jan 2026."
          },
          "currentStatus": "In Progress"
        }
      }
    },
    "SupportCaseResolved": {
      "description": "Published when a support agent resolves/closes a Case in Salesforce. Triggered by Salesforce Platform Event webhook.",
      "allOf": [
        {"$ref": "#/definitions/CloudEventsEnvelope"},
        {
          "properties": {
            "type": {"const": "com.otr.engagement.supportcaseresolved.v1"},
            "source": {"const": "/engagementservice/salesforce-webhook"},
            "data": {"$ref": "#/definitions/SupportCaseResolvedData"}
          }
        }
      ],
      "example": {
        "specversion": "1.0",
        "type": "com.otr.engagement.supportcaseresolved.v1",
        "source": "/engagementservice/salesforce-webhook",
        "id": "d4e5f6a7-b8c9-0123-def0-123456789013",
        "time": "2026-01-10T11:20:15Z",
        "datacontenttype": "application/json",
        "dataschema": "https://otr.com.au/schemas/engagement-events.json#/definitions/SupportCaseResolvedData",
        "subject": "customer/VIVA-12345678/case/5001234567890AB",
        "data": {
          "vivaConsumerId": "VIVA-12345678",
          "salesforceCaseId": "5001234567890AB",
          "caseNumber": "00001234",
          "resolvedAt": "2026-01-10T11:20:15Z",
          "resolvedBy": {
            "salesforceUserId": "0051234567890AB",
            "name": "Sarah Thompson"
          },
          "resolution": {
            "status": "Resolved",
            "resolutionType": "Issue Resolved",
            "resolutionNotes": "Fuel pump repaired by technician. Customer confirmed pump is now working correctly. Offered $20 fuel voucher as goodwill gesture."
          },
          "customerNotified": true,
          "satisfactionRating": 5
        }
      }
    }
  }
}
