= Salesforce Customer Support
:project-name: Salesforce Customer Support
:togaf-adm-phase: Phase C: Information Systems Architectures
:last-updated: 2026-01-07
:document-type: Solution  Definition Document
:status: Discovery
:version: 0.1
:programme-lead:
:domain-architect: O.Young@otr.com.au
:doctype: article
:toc: left
:toclevels: 4
:sectanchors:
:sectlinks:
:sectnums:
:icons: font
:source-highlighter: highlightjs
:experimental:
:description:
:keywords:

<<<
== Introduction & Vision

=== Purpose

OTR digital customers currently submit feedback and support requests through D365 Customer Engagement, while Viva Energy's broader business units use Salesforce Service Cloud. This fragmentation prevents support agents from having a unified view of customer interactions and creates operational inefficiency.

This architecture definition documents the **first implementation of OTR's target Domain-Driven Design (DDD) architecture** by establishing two new bounded contexts (ProfileService and EngagementService), consolidating customer support onto Salesforce Service Cloud, and implementing event-driven integration patterns that will serve as the foundation for future bounded contexts (including Flybuys integration).

=== Vision

> Unify customer support across all Viva Energy channels by consolidating OTR digital customer feedback onto Salesforce Service Cloud, establishing the foundational DDD architecture with ProfileService and EngagementService bounded contexts that protect digital channels from external system changes while enabling support agents to deliver exceptional customer experiences with complete interaction history.

=== Architectural Approach

This architecture establishes OTR's **first bounded context implementation** using Domain-Driven Design strategic patterns:

* *link:../bounded_context/profile.adoc[ProfileService]* (NEW bounded context): Just-In-Time Contact reconciliation with Salesforce, upsert by email, returns Salesforce Contact ID to digital channels - foundation for future Flybuys partner linking
* *link:../bounded_context/engagement.adoc[EngagementService]* (NEW bounded context): Customer feedback submission facade, Anti-Corruption Layer for Salesforce Case creation, Braze integration for push notifications, async Case processing via Event Bus
* *Event-driven integration* (NEW pattern): Domain event publishing using existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis) - first implementation establishing pattern for future bounded contexts
* *Anti-Corruption Layer*: EngagementService isolates digital channels from Salesforce API changes, translates between OTR domain language and Salesforce Service Cloud API
* *Conformist Pattern*: ProfileService and EngagementService conform to existing Salesforce configuration (shared Viva Energy instance, multi-tenant governance)
* *Big bang cutover*: Single deployment after Contact migration, no phased rollout, D365 CE retirement post-cutover

=== Scope

==== In Scope

- Solution Building Blocks (SBBs) - specific technology products and versions
- Interface specifications (APIs, events, data formats)
- Data architecture and schema specifications
- Deployment architecture and infrastructure configuration
- Transition architecture with phased implementation states
- Technical validation criteria and testing approach
- External system integration specifications

=== Out Of Scope (covered in Architecture Definition):
- Business requirements and stakeholder analysis
- Architecture decisions and rationale (ADRs)
- Bounded context definitions and responsibilities
- High-level integration patterns (ACL, Conformist, OHS+PL)
- Business capability mapping and value streams
- Non-functional requirements (referenced, not duplicated)
- Architecture principles and governance

=== Architecture Overview

[mermaid]
----
---
config:
  layout: elk
---
flowchart TB
    Customer(["Customer"]) -- Uses --> MobileApp["Mobile App<br>iOS/Android"]
    Customer -- Shops at --> POS["OTR/OTR+ POS<br>D365 Commerce"]
    MobileApp -- Authenticate --> EntraID["Microsoft Entra"]
    MobileApp -- Identifies & Reconciles --> ProfileService["ProfileService"]
    ProfileService <-- Reconcile App User as Salesforce Contact --> Salesforce["Salesforce"]
    ProfileService -- On Create --> EventBus["EventBus"]
    EventBus -- Emits CreateUser Event --> LoyaltyService["LoyaltyService"] & EngagementService["EngagementService"]
    LoyaltyService -- Reconcile Wallet --> EagleEye["EagleEye"]
    EngagementService -- Reconcile Braze Profile --> Braze["Braze"]
    EngagementService --> Salesforce
    D365CE["D365CE"] -- Data Migration --> Salesforce
    MobileApp -- Submits Feedback --> EngagementService

    Customer:::customer
    MobileApp:::presentation
    POS:::presentation
    EntraID:::external
    ProfileService:::newService
    Salesforce:::external
    EventBus:::infrastructure
    LoyaltyService:::newService
    EngagementService:::newService
    EagleEye:::external
    Braze:::external
    D365CE:::external
    classDef newService fill:#4CAF50,stroke:#2E7D32,stroke-width:3px,color:#fff
    classDef external fill:#FF9800,stroke:#E65100,stroke-width:2px,color:#fff
    classDef infrastructure fill:#2196F3,stroke:#0D47A1,stroke-width:2px,color:#fff
    classDef presentation fill:#9C27B0,stroke:#4A148C,stroke-width:2px,color:#fff
    classDef customer fill:#607D8B,stroke:#263238,stroke-width:2px,color:#fff
----


==== Key Architectural Patterns

[width="100%",cols="25%,35%,40%",options="header",]
|===
|Pattern |Application |Rationale

|*Anti-Corruption Layer (ACL)*
|EngagementService → Salesforce Service Cloud
|Protects digital channels (Mobile App, Web) from Salesforce API changes, translates between OTR domain language and Salesforce Case/Contact model, enables independent evolution of internal domain model

|*Conformist*
|ProfileService → Salesforce, EngagementService → Salesforce
|Shared Viva Energy Salesforce instance - we conform to existing configuration, governance, and API contracts (external system we don't control)

|*Backend-for-Frontend (BFF)*
|EngagementService
|Aggregates customer feedback submission, Contact lookup, async Case creation, and Braze notification orchestration for digital channel clients

|*Event-Driven Architecture (OHS+PL)*
|Event Bus (SNS+SQS/EventBridge/Kinesis)
|Loose coupling between bounded contexts, async domain event publishing (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`), foundation for future bounded contexts

|*Just-In-Time (JIT) Integration*
|ProfileService → Salesforce Contact reconciliation
|Reconcile app users as Salesforce Contacts on-demand (upsert by email), no pre-sync required, ensures Salesforce has current Contact data

|*Async Processing*
|EngagementService Case creation via Event Bus
|Non-blocking user experience, resilience to Salesforce downtime, automatic retry with exponential backoff, dead letter queue for operations team intervention

|*Strangler Fig*
|Not applicable
|Big bang cutover (no gradual migration) - D365 CE fully replaced, not incrementally strangled

|===


<<<
== Executive Summary

=== Challenge

OTR digital customers (Mobile App, Web) currently submit feedback and support requests to D365 Customer Engagement, while Viva Energy's broader business units (fuel wholesale, Shell Card customers, other retail channels) use Salesforce Service Cloud. This creates:

* *Fragmented customer support platform*: Customer support data split across two systems, preventing support agents from having a unified view of customer interactions across all channels
* *Operational inefficiency*: Maintaining two separate customer support platforms increases operational overhead and costs
* *Poor support experience*: D365 CE is not working well for digital customer support, impacting customer satisfaction and case resolution times
* *Post-merger consolidation opportunity*: Following Viva Energy's acquisition of OTR, strategic alignment on Salesforce as the enterprise customer support platform

=== Solution

This architecture establishes the **foundational Domain-Driven Design (DDD) implementation** for OTR's target state architecture by introducing two new bounded contexts (link:../bounded_context/profile.adoc[ProfileService], link:../bounded_context/engagement.adoc[EngagementService]) and event-driven integration patterns:

==== New Bounded Contexts

* *link:../bounded_context/profile.adoc[ProfileService]* (NEW): Just-In-Time (JIT) Contact reconciliation with Salesforce, upsert by email, returns Salesforce Contact ID to Mobile App
* *link:../bounded_context/engagement.adoc[EngagementService]* (NEW): Customer feedback submission, Anti-Corruption Layer (ACL) for Salesforce Case creation, Braze integration for customer notifications, async Case processing via Event Bus
* *Event Bus* (NEW pattern): Domain event publishing using existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis) - first implementation of event-driven architecture pattern

==== Integration Architecture

* *Salesforce = System of Record*: Salesforce Service Cloud (shared Viva Energy instance) owns Contact and Case data
* *Conformist Pattern*: ProfileService and EngagementService conform to existing Salesforce configuration and API contracts
* *Anti-Corruption Layer*: EngagementService protects digital channels from Salesforce API changes, translates between OTR domain language and Salesforce
* *Async Case Creation*: Non-blocking user experience, resilience to Salesforce downtime, automatic retry with exponential backoff, dead letter queue for failed Cases
* *Event-Driven Notifications*: Salesforce webhook → EngagementService → Braze push notifications for Case status updates

==== Migration Approach

* *Contact Migration*: One-time migration from app-specific database → Salesforce (upsert with flexible matching by email/phone/VCI)
* *No Case Migration*: Historical D365 CE Cases not migrated (fresh start in Salesforce)
* *Big Bang Cutover*: Single deployment, no phased rollout or parallel run
* *D365 CE Retirement*: Complete decommissioning of D365 Customer Engagement post-cutover

=== Key Architectural Significance

This migration is **not just a system replacement** - it establishes the first implementation of OTR's target DDD architecture:

* First bounded contexts implemented (ProfileService, EngagementService)
* First event-driven domain event pattern (foundation for future bounded contexts)
* Foundation for Flybuys integration (ProfileService Contact reconciliation reused)
* Establishes integration patterns (Conformist, ACL, Event-Driven) for future services

=== Success Criteria

* All digital customer feedback routed to Salesforce Service Cloud within 30 days of launch
* Support agents have unified customer view across all Viva Energy channels (digital, wholesale, Shell Card, other retail)
* D365 Customer Engagement decommissioned within 90 days post-cutover
* Customer satisfaction score improves by 15% within 6 months
* Average case resolution time decreases by 20% within 6 months
* Zero data loss during Contact migration (100% validation pass rate)
* Mobile App feedback submission success rate > 99.5% (including async Case creation)

=== Technical Constraints

* Shared Salesforce instance (Viva Energy multi-tenant environment)
* Conform to existing Salesforce configuration and governance (data isolation strategy TBD with Salesforce admin team)
* Contact migration must complete before cutover (no parallel run)
* Async Case creation mandatory (non-blocking user experience)

=== Open Technical Decisions (TBD)

* Salesforce Case field mapping for digital feedback categories (App, Service, Order, Rewards, Refund, Delete Account)
* Salesforce data isolation strategy (Record Types, custom fields, queues)
* Salesforce REST API authentication method (OAuth 2.0, Connected App, JWT bearer flow)
* Salesforce webhook mechanism for Case updates (Outbound Messages, Platform Events, Process Builder)
* Retry policy configuration (attempts, backoff intervals)
* Expected feedback volume and Salesforce API rate limit strategy

== Technical Requirements

[width="100%",cols="8%,92%",options="header",]
|===
|ID |Description

|TR-CS-001
|Every Mobile App user must have a Salesforce Contact record in Salesforce Service Cloud (shared Viva Energy instance)

|TR-CS-002
|ProfileService must reconcile Mobile App users as Salesforce Contacts using Just-In-Time (JIT) upsert by email address

|TR-CS-003
|ProfileService must return Salesforce Contact ID to Mobile App for feedback submission

|TR-CS-004
|Mobile App must support customer feedback submission with fields: Category (App, Service, Order, Rewards, Refund, Delete Account), Store Name, Time of Visit, Contact Phone Number, Free Text Message

|TR-CS-005
|EngagementService must create Salesforce Cases asynchronously via Event Bus (non-blocking user experience)

|TR-CS-006
|EngagementService must acknowledge feedback submission immediately to Mobile App user ("Feedback submitted" confirmation)

|TR-CS-007
|EngagementService must send push notification to customer via Braze when Case is successfully created in Salesforce

|TR-CS-008
|EngagementService must retry failed Case creation with configurable exponential backoff and dead letter queue for operations team intervention

|TR-CS-009
|Salesforce must be the System of Record for Contact and Case data (no local persistence in ProfileService or EngagementService)

|TR-CS-010
|Contact migration from app-specific database to Salesforce must complete before Mobile App cutover (upsert with flexible matching by email/phone/VCI)

|TR-CS-011
|No Case migration from D365 Customer Engagement to Salesforce (fresh start, historical Cases not migrated)

|TR-CS-012
|EngagementService must publish domain events (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`) to Event Bus for consumption by other bounded contexts

|TR-CS-013
|EngagementService must receive Salesforce webhook notifications when Cases are updated/resolved by support agents

|TR-CS-014
|EngagementService must trigger Braze push notifications to customers when Cases are updated/resolved (via Salesforce webhook → EngagementService → Braze)

|TR-CS-015
|ProfileService and EngagementService must conform to existing Salesforce configuration and API contracts (Conformist pattern)

|TR-CS-016
|All changes must be communicated using event-driven architecture via Event Bus (using existing AWS infrastructure: SNS+SQS/EventBridge/Kinesis)

|TR-CS-017
|Mobile App feedback submission success rate must exceed 99.5% (including async Case creation completion)

|TR-CS-018
|Contact migration must achieve 100% validation pass rate (zero data loss)

|TR-CS-019
|D365 Customer Engagement must be fully decommissioned within 90 days post-cutover

|===

== Technical Architecture

=== Technical Capability Requirements

==== Requirements Traceability

=== Service Catalogues

==== Application Portfolio Catalogue

==== Technology Capability Requirements

==== Feature Flag Register

==== Data Entity Catalogue

=== Baseline Architecture

==== Existing System Components

[width="100%",cols="25%,35%,40%",options="header",]
|===
|Component |Current State |Status

|*D365 Customer Engagement*
|Customer support platform for OTR digital customers (Mobile App, Web), handles feedback submission and case management
|**DEPRECATED** - Being replaced by Salesforce Service Cloud

|*App-Specific Customer Database*
|Stores customer contact data for Mobile App users, separate from Viva Energy systems
|**MIGRATING** - One-time migration to Salesforce, then deprecated

|*Mobile App*
|iOS/Android native apps with feedback submission form including Category, Store Name, Time of Visit, Contact Phone Number, and Free Text Message fields
|**REQUIRES UPDATE** - Integrate with ProfileService and EngagementService APIs (feedback form UI already complete)

|*Salesforce Service Cloud*
|Shared Viva Energy instance handling customer support for fuel wholesale, Shell Card customers, other retail channels
|**EXPANDING** - Adding OTR digital customer support Cases and Contacts

|*Existing AWS Infrastructure*
|SNS+SQS / EventBridge / Kinesis available for event-driven architecture
|**REUSING** - Event Bus implementation leverages existing infrastructure

|===

==== Integration Architecture

*Current state:*

* Mobile App → D365 Customer Engagement (direct integration)
* App-specific customer database → standalone (no Salesforce integration)
* No event-driven architecture (synchronous, tightly coupled)
* No Anti-Corruption Layer protecting digital channels
* Viva Energy support teams use Salesforce, OTR digital support uses D365 CE (fragmented)

==== Technical Debt

*No longer relevant* - D365 CE being deprecated, not documenting technical debt of system being retired.

*New technical debt introduced by this migration:*

* Salesforce field mapping TBD (requires coordination with Viva Energy Salesforce admin team)
* Data isolation strategy TBD (Record Types, custom fields, queues - multi-tenant governance)
* Salesforce webhook mechanism TBD (Outbound Messages vs Platform Events vs Process Builder)
* Expected feedback volume unknown (gathering data for rate limit planning)

=== Gap Analysis

==== Missing Capabilities

[width="100%",cols="30%,70%",options="header",]
|===
|Missing Capability |Description

|*ProfileService bounded context*
|No existing service for Contact reconciliation with Salesforce - requires new microservice implementing JIT upsert by email, returning Salesforce Contact ID

|*EngagementService bounded context*
|No existing service for customer feedback facade - requires new microservice implementing Anti-Corruption Layer for Salesforce Case creation, Braze integration, async processing via Event Bus

|*Event Bus domain event pattern*
|No existing domain event publishing infrastructure - requires implementing event-driven architecture pattern using existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis)

|*Async Case creation workflow*
|Current D365 CE integration is synchronous - requires implementing async processing with retry logic, exponential backoff, dead letter queue

|*Salesforce webhook integration*
|No existing capability to receive Salesforce notifications - requires implementing webhook receiver in EngagementService for Case update notifications

|*Braze push notification orchestration*
|No existing integration for Case-related push notifications - requires implementing Braze campaign triggers from EngagementService

|*Contact migration tooling*
|No existing tooling for app database → Salesforce Contact migration with upsert logic (match by email/phone/VCI)

|*Feedback form enhancements*
|Mobile App feedback form lacks structured fields (Category, Store Name, Time of Visit, Contact Phone Number) - requires UI updates

|===

==== Missing Bounded Contexts

[width="100%",cols="30%,30%,40%",options="header",]
|===
|Bounded Context |Responsibilities |Implementation Status

|*link:../bounded_context/profile.adoc[ProfileService]*
|JIT Contact reconciliation with Salesforce (upsert by email), return Salesforce Contact ID to digital channels, foundation for future Flybuys partner linking
|**NEW** - First bounded context implementation

|*link:../bounded_context/engagement.adoc[EngagementService]*
|Customer feedback submission facade, Anti-Corruption Layer for Salesforce Case creation, Braze integration for push notifications, async Case processing, webhook receiver for Case updates
|**NEW** - First bounded context implementation

|===

==== Missing Integration Patterns

[width="100%",cols="30%,70%",options="header",]
|===
|Integration Pattern |Description

|*Anti-Corruption Layer (ACL)*
|EngagementService → Salesforce Service Cloud - protects digital channels from Salesforce API changes, translates between OTR domain language and Salesforce

|*Conformist*
|ProfileService/EngagementService → Salesforce - conform to existing Salesforce configuration and API contracts (shared Viva Energy instance)

|*Event-Driven Architecture (OHS+PL)*
|Event Bus publishing domain events (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`) for loose coupling between bounded contexts

|*Just-In-Time (JIT) Integration*
|ProfileService → Salesforce Contact reconciliation on-demand (no pre-sync)

|*Async Processing*
|EngagementService Case creation via Event Bus with retry, exponential backoff, dead letter queue

|===

=== Target State Architecture

==== Architectural Building Blocks (ABB)

[width="100%",cols="20%,25%,30%,25%",options="header",]
|===
|ABB ID |Bounded Context |Responsibilities |Technology (TBD in Solution Architecture)

|ABB-CS-001
|*link:../bounded_context/profile.adoc[ProfileService]*
|JIT Contact reconciliation with Salesforce (upsert by email), return Salesforce Contact ID, foundation for Flybuys partner linking
|Microservice (.NET/Node.js), REST API, Salesforce REST API client

|ABB-CS-002
|*link:../bounded_context/engagement.adoc[EngagementService]*
|Customer feedback submission facade, ACL for Salesforce Case creation, Braze integration, async processing, webhook receiver
|Microservice (.NET/Node.js), REST API, Event Bus publisher/subscriber, Salesforce webhook receiver

|ABB-CS-003
|*Event Bus*
|Domain event publishing infrastructure (`SupportCaseCreated`, `SupportCaseUpdated`, `CustomerFeedbackSubmitted`)
|AWS SNS+SQS / EventBridge / Kinesis

|ABB-CS-004
|*Salesforce Service Cloud*
|System of Record for Contact and Case data (shared Viva Energy instance)
|Salesforce Service Cloud (external SaaS)

|ABB-CS-005
|*Braze*
|Marketing automation platform for push notifications
|Braze (external SaaS) - existing integration

|ABB-CS-006
|*Mobile App*
|iOS/Android native apps with enhanced feedback form (Category, Store Name, Time of Visit, Contact Phone Number, Free Text Message)
|Kotlin Multiplatform, SwiftUI, Jetpack Compose

|ABB-CS-007
|*Contact Migration Tool*
|One-time migration app database → Salesforce with upsert logic (match by email/phone/VCI)
|Script/tool (.NET/Python/Node.js)

|===

==== Integration Architecture

===== Integration Flows

*Customer Feedback Submission (Async):*

1. *Mobile App* → ProfileService: Authenticate user, get Salesforce Contact ID (JIT reconciliation)
2. *Mobile App* → EngagementService: Submit feedback (POST /feedback with Contact ID, Category, Store Name, Time of Visit, Phone, Message)
3. *EngagementService* → Mobile App: Immediate acknowledgment ("Feedback submitted")
4. *EngagementService* → Event Bus: Publish work item for async Case creation
5. *Background Worker* (EngagementService) → Salesforce: Create Case via REST API
6. *Success*: EngagementService → Event Bus: Publish `SupportCaseCreated` event
7. *EngagementService* → Braze: Trigger push notification campaign ("Your feedback has been received, Case #12345")
8. *Failure*: Retry with exponential backoff → Dead Letter Queue → Ops team alert

*Case Update Notification (Bidirectional):*

1. *Support Agent* updates/resolves Case in Salesforce
2. *Salesforce* → EngagementService: Webhook notification (Case updated)
3. *EngagementService* → Event Bus: Publish `SupportCaseUpdated` or `SupportCaseResolved` event
4. *EngagementService* → Braze: Trigger push notification campaign ("Your case has been resolved")

*Contact Reconciliation (JIT):*

1. *Mobile App user* authenticates
2. *Mobile App* → ProfileService: GET /profile/contact-id
3. *ProfileService* → Salesforce: Query Contact by email
4. *Match found*: Return existing Salesforce Contact ID
5. *No match*: Create new Contact in Salesforce, return new Contact ID
6. *ProfileService* → Mobile App: Return Salesforce Contact ID (cached by Mobile App)

===== System of Record Boundaries

[width="100%",cols="30%,35%,35%",options="header",]
|===
|Data Entity |System of Record |Rationale

|*Contact*
|Salesforce Service Cloud
|Shared Viva Energy instance, unified customer profile across all channels (digital, wholesale, Shell Card, retail)

|*Case*
|Salesforce Service Cloud
|Support agents manage Cases in Salesforce, digital channels submit via EngagementService ACL

|*Feedback Submission (transient)*
|None (no persistence)
|EngagementService processes feedback and creates Case in Salesforce, no local storage

|*Domain Events*
|Event Bus (ephemeral)
|Events published to Event Bus, consumed by subscribers, not persisted long-term (event sourcing not in scope)

|===

==== Data Architecture Principles

===== Aggregate Persistence

*ProfileService:*

* **No local aggregate persistence** - ProfileService is stateless, queries Salesforce on-demand
* Salesforce Contact is the aggregate root (owned by Salesforce)
* ProfileService acts as facade/translator, not system of record

*EngagementService:*

* **No local aggregate persistence** - EngagementService is stateless, creates Cases in Salesforce via ACL
* Salesforce Case is the aggregate root (owned by Salesforce)
* EngagementService maintains no local Case state (Conformist pattern - trust Salesforce as source of truth)
* Async processing state managed via Event Bus (work items in queue, not database)

===== Event Store

* **Event Bus** (SNS+SQS/EventBridge/Kinesis) handles domain event publishing
* Events are **ephemeral** (consumed and discarded, not persisted for event sourcing)
* No Event Store implementation in this architecture (future enhancement if needed)
* Event schema versioning TBD in Solution Architecture

=== Architecture Decisions

==== ADR-CS-001: Consolidate onto Salesforce Service Cloud (not build custom solution)

*Status*: Accepted

*Context*:

* D365 Customer Engagement not working well for digital customer support
* Viva Energy already uses Salesforce Service Cloud for fuel wholesale, Shell Card, other retail channels
* Post-merger opportunity to consolidate onto single platform
* Alternative: Build custom support platform or use different SaaS

*Decision*:

Consolidate OTR digital customer support onto Salesforce Service Cloud (shared Viva Energy instance).

*Rationale*:

* **Unified customer view**: Support agents see all interactions across channels (digital, wholesale, Shell Card, retail)
* **Platform consolidation**: Single support platform reduces operational overhead and costs
* **Proven solution**: Salesforce Service Cloud is established, feature-rich, well-supported
* **Post-merger alignment**: Strategic decision to standardize on Viva Energy platforms
* **Avoid custom development**: Building custom support platform would be costly and high-risk

*Consequences*:

* ✅ Unified customer support across Viva Energy Group
* ✅ Reduced operational complexity (single platform vs two)
* ✅ Leverage Salesforce capabilities (case routing, knowledge base, AI, omnichannel)
* ⚠️ Conformist pattern required (shared instance, conform to existing configuration)
* ⚠️ Multi-tenant governance needed (data isolation, security, queues)
* ❌ Less control over platform evolution (SaaS vendor, shared instance)

==== ADR-CS-002: Implement ProfileService and EngagementService as first DDD bounded contexts

*Status*: Accepted

*Context*:

* OTR target architecture uses Domain-Driven Design with bounded contexts
* This migration is opportunity to establish first implementation
* Alternative: Direct Mobile App → Salesforce integration (no bounded contexts)
* Alternative: Single monolithic service for all customer-facing APIs

*Decision*:

Implement ProfileService and EngagementService as separate bounded contexts following DDD strategic patterns.

*Rationale*:

* **Foundation for target architecture**: First implementation of DDD pattern for future bounded contexts (Flybuys, LocationService, PaymentService)
* **Separation of concerns**: ProfileService handles identity/Contact reconciliation, EngagementService handles support/feedback (different responsibilities, different change rates)
* **Anti-Corruption Layer**: EngagementService protects digital channels from Salesforce API changes
* **Reusability**: ProfileService Contact reconciliation reused for Flybuys integration
* **Event-driven architecture**: Establishes pattern for loose coupling between bounded contexts

*Consequences*:

* ✅ Establishes DDD architecture foundation for OTR
* ✅ Reusable ProfileService for Flybuys and future integrations
* ✅ Digital channels protected from Salesforce API changes (ACL)
* ✅ Clear bounded context boundaries and responsibilities
* ⚠️ Increased initial complexity (two new microservices vs direct integration)
* ⚠️ Requires Event Bus infrastructure implementation
* ⚠️ Team must learn DDD patterns and bounded context design

==== ADR-CS-003: Async Case creation via Event Bus (not synchronous)

*Status*: Accepted

*Context*:

* Current D365 CE integration is synchronous (user waits for Case creation)
* Alternative: Keep synchronous integration (Mobile App → EngagementService → Salesforce synchronously)
* Salesforce API may experience downtime or latency

*Decision*:

Implement async Case creation via Event Bus with immediate user acknowledgment, retry logic, exponential backoff, and dead letter queue.

*Rationale*:

* **Non-blocking user experience**: User gets immediate "Feedback submitted" confirmation, not waiting for Salesforce API
* **Resilience**: If Salesforce is down, feedback still accepted, Case created when Salesforce recovers
* **Retry logic**: Automatic retry with exponential backoff handles transient failures
* **Operational visibility**: Dead letter queue alerts ops team to persistent failures
* **Scalability**: Queue buffering handles traffic spikes

*Consequences*:

* ✅ Better user experience (no waiting for Salesforce API)
* ✅ Resilient to Salesforce downtime (queue buffers work)
* ✅ Automatic retry reduces manual intervention
* ✅ Queue depth monitoring provides operational visibility
* ⚠️ Eventual consistency (user gets success notification after Case created, not immediately)
* ⚠️ Increased complexity (Event Bus, background workers, retry logic, DLQ)
* ⚠️ Requires monitoring and alerting for DLQ

==== ADR-CS-004: ProfileService uses email as primary matching key (not VCI)

*Status*: Accepted

*Context*:

* ProfileService needs to reconcile Mobile App users as Salesforce Contacts
* Alternative matching keys: VCI (Viva Consumer ID), email, phone, Salesforce External ID
* Email changes are rare but possible

*Decision*:

Use email address as primary matching key for Contact reconciliation (JIT upsert by email).

*Rationale*:

* **Availability**: Email always available for authenticated users
* **Uniqueness**: Email is unique identifier in Salesforce and Mobile App
* **Salesforce standard**: Salesforce Contact uses email as standard lookup field
* **Simplicity**: Single matching key simplifies upsert logic
* **Edge case acceptable**: Email changes are rare, manual cleanup acceptable

*Consequences*:

* ✅ Simple upsert logic (query by email, create if not found)
* ✅ Leverages Salesforce standard email field
* ✅ Email always available from authentication
* ⚠️ Email changes create duplicate Contacts (rare edge case, manual cleanup)
* ⚠️ Future enhancement: Add VCI as Salesforce External ID for stable matching

==== ADR-CS-005: No Case migration from D365 CE (fresh start)

*Status*: Accepted

*Context*:

* D365 CE contains historical customer support Cases
* Alternative: Migrate historical Cases to Salesforce (preserve support history)
* Alternative: Archive D365 CE Cases separately (read-only access)

*Decision*:

Do not migrate historical Cases from D365 CE to Salesforce. Start fresh in Salesforce.

*Rationale*:

* **Limited value**: Historical D365 CE Cases not critical for future support
* **Data quality**: D365 CE Case data may be inconsistent or incomplete
* **Complexity**: Case migration requires mapping D365 CE schema to Salesforce, data transformation, validation
* **Cost-benefit**: Migration effort outweighs value of historical data
* **Archive option**: D365 CE Cases can be archived separately if needed (read-only access for auditing)

*Consequences*:

* ✅ Simpler migration (Contacts only, no Case migration)
* ✅ Faster time to value (no Case migration delay)
* ✅ Clean start in Salesforce (no legacy data quality issues)
* ⚠️ Historical Cases not visible in Salesforce (support agents can't see old Cases)
* ⚠️ D365 CE must remain accessible temporarily for historical Case lookups (if needed)
* ❌ Loss of historical Case insights (reporting, analytics on old Cases)

==== ADR-CS-006: Big bang cutover (not phased rollout)

*Status*: Accepted

*Context*:

* Alternative: Phased rollout with feature flags (pilot users first, gradual enablement)
* Alternative: Parallel run (submit to both D365 CE and Salesforce temporarily)
* Flybuys integration uses phased rollout (AS-1, AS-2, AS-3 architecture states)

*Decision*:

Big bang cutover - migrate Contacts, deploy ProfileService and EngagementService, switch Mobile App, retire D365 CE.

*Rationale*:

* **Simplicity**: No parallel run complexity, no feature flag management
* **Faster D365 CE retirement**: No extended transition period maintaining two systems
* **Limited risk**: Customer support not mission-critical (not payment processing), rollback possible
* **User base manageable**: OTR digital customers smaller than Flybuys integration scope
* **Different use case**: Flybuys phased rollout manages points accrual complexity, support feedback is simpler

*Consequences*:

* ✅ Simpler deployment (single cutover, no AS-1/AS-2/AS-3 states)
* ✅ Faster D365 CE retirement (no extended parallel run)
* ✅ No feature flag complexity or pilot user management
* ⚠️ Higher cutover risk (all users switch at once)
* ⚠️ Requires comprehensive testing before cutover
* ⚠️ Rollback plan required (revert to D365 CE if critical issues)

==== ADR-CS-007: EngagementService receives Salesforce webhooks for Case updates

*Status*: Accepted

*Context*:

* Support agents update/resolve Cases in Salesforce
* Need to notify customers of Case status changes via push notifications
* Alternative: Poll Salesforce API for Case updates (inefficient)
* Alternative: No customer notifications (agents contact customers directly)

*Decision*:

Salesforce sends webhook notifications to EngagementService when Cases are updated/resolved. EngagementService triggers Braze push notifications.

*Rationale*:

* **Real-time notifications**: Customer notified immediately when agent resolves Case
* **Efficient**: Webhook push model (not polling)
* **Event-driven**: Aligns with event-driven architecture pattern
* **Better customer experience**: Proactive notification vs waiting for agent contact

*Consequences*:

* ✅ Real-time customer notifications for Case updates
* ✅ Efficient push model (no polling overhead)
* ✅ Bidirectional integration (Mobile App → Salesforce → Mobile App)
* ⚠️ Salesforce webhook mechanism TBD (Outbound Messages vs Platform Events vs Process Builder)
* ⚠️ Webhook authentication and security required
* ⚠️ EngagementService must handle webhook retries and failures

=== Migration Strategy

==== Migration Phases

*Phase 1: Build & Test (Weeks 1-8)*

* Build ProfileService microservice (JIT Contact reconciliation API)
* Build EngagementService microservice (feedback submission API, ACL for Salesforce Case creation, Braze integration, webhook receiver)
* Implement Event Bus infrastructure (SNS+SQS/EventBridge/Kinesis)
* Develop Contact migration tool (app database → Salesforce upsert by email/phone/VCI)
* Update Mobile App feedback form (add Category, Store Name, Time of Visit, Contact Phone Number fields)
* Integration testing (ProfileService ↔ Salesforce, EngagementService ↔ Salesforce, EngagementService ↔ Braze)
* UAT with test Salesforce sandbox environment

*Phase 2: Contact Migration (Week 9)*

* Execute Contact migration (app database → Salesforce production)
* Validation: 100% data integrity check (email/phone/VCI matching)
* Reconciliation report: New Contacts created vs existing Contacts updated
* Freeze app database Contact updates during migration window
* ProfileService smoke testing (verify Contact lookups work in Salesforce production)

*Phase 3: Cutover (Week 10)*

* Deploy ProfileService to production
* Deploy EngagementService to production
* Deploy Mobile App updates (new feedback form, ProfileService + EngagementService API integration)
* Configure Salesforce webhook (Case update notifications → EngagementService)
* Smoke testing: End-to-end feedback submission (Mobile App → EngagementService → Salesforce → Braze notification)
* Monitor Event Bus queue depth, dead letter queue, Salesforce API rate limits
* **Go/No-Go decision**: Validate success criteria before final cutover

*Phase 4: D365 CE Retirement (Weeks 11-22)*

* Monitor production for 30 days (validate success criteria: >99.5% feedback submission rate, no data loss)
* D365 CE read-only access (historical Case lookups if needed)
* Decommission D365 CE after 90 days (ADR-CS-006 big bang cutover timeline)
* Archive D365 CE data for compliance/auditing

==== Migration Dependencies

[width="100%",cols="40%,60%",options="header",]
|===
|Dependency |Owner/Status

|*Salesforce production access*
|Viva Energy Salesforce admin team - TBD

|*Salesforce Case field mapping*
|Viva Energy Salesforce admin team - TBD (map OTR feedback categories to Salesforce fields)

|*Salesforce data isolation strategy*
|Viva Energy Salesforce admin team - TBD (Record Types, queues, custom fields)

|*Salesforce webhook configuration*
|Viva Energy Salesforce admin team - TBD (Outbound Messages vs Platform Events)

|*Event Bus infrastructure*
|OTR Platform team - Existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis)

|*Braze integration*
|OTR Marketing team - Existing Braze account, EngagementService creates new campaigns

|*Mobile App release window*
|OTR Mobile team - Coordinate cutover timing with app release schedule

|*App database access*
|OTR Platform team - Read access for Contact migration

|===

==== Migration Validation Criteria

*Contact Migration Validation:*

* ✅ 100% of app database Contacts migrated to Salesforce (zero data loss)
* ✅ Email/phone/VCI matching accuracy > 95% (minimize duplicate Contacts)
* ✅ ProfileService JIT lookups return correct Salesforce Contact IDs (smoke test sample)
* ✅ Reconciliation report shows: X new Contacts created, Y existing Contacts updated

*Cutover Validation:*

* ✅ Mobile App feedback submission success rate > 99.5% (including async Case creation)
* ✅ End-to-end flow validated: Mobile App → ProfileService → EngagementService → Salesforce Case created
* ✅ Braze push notifications delivered for Case creation and Case resolution
* ✅ Event Bus queue depth within normal range (no backlog)
* ✅ Dead letter queue empty (no failed Case creations)
* ✅ Salesforce API rate limits not exceeded

*Production Monitoring (30 days):*

* ✅ Customer satisfaction score improves by 15% (compared to D365 CE baseline)
* ✅ Average case resolution time decreases by 20% (Salesforce vs D365 CE)
* ✅ Support agents confirm unified customer view across all channels
* ✅ Zero critical incidents (P1 outages, data loss)

==== Rollback Plan

*Rollback Trigger:*

* Feedback submission success rate < 95% (below acceptable threshold)
* Data loss or corruption detected in Salesforce
* Salesforce API rate limits exceeded (Cases not created within SLA)
* Critical bug blocking customer feedback submission

*Rollback Procedure:*

1. **Revert Mobile App** to previous version (remove ProfileService/EngagementService integration, restore D365 CE integration)
2. **Stop EngagementService** Case creation (prevent duplicate Cases in Salesforce)
3. **Re-enable D365 CE** for customer feedback submission
4. **Investigate root cause** (EngagementService logs, Salesforce API errors, Event Bus queue issues)
5. **Fix and re-test** in sandbox environment
6. **Retry cutover** when issues resolved

*Rollback Limitations:*

* Cases created in Salesforce during cutover period remain in Salesforce (no reverse migration)
* Contacts migrated to Salesforce remain (no rollback to app database)
* Rollback only affects Mobile App integration (not data migration)

=== Architectural Scope Boundaries

==== Capabilities Included

==== Capabilities Excluded

==== Architectural Dependencies on Future Initiatives

=== Technical Risks and Mitigation

[width="100%",cols="5%,20%,25%,25%,25%",options="header",]
|===
|ID |Risk |Impact |Likelihood |Mitigation

|RISK-CS-001
|*Salesforce API rate limits exceeded*: High feedback volume exceeds Salesforce API limits, Cases not created
|HIGH (customers don't receive Case confirmation, support tickets lost)
|MEDIUM (volume unknown, rate limits TBD)
|• Gather expected feedback volume data before cutover +
• Implement Event Bus queue throttling/rate limiting +
• Monitor queue depth and API usage +
• Scale background workers based on queue depth +
• Alert ops team when approaching rate limits

|RISK-CS-002
|*Salesforce downtime*: Salesforce Service Cloud outage prevents Case creation
|MEDIUM (Cases delayed but queued, customers wait for confirmation)
|LOW (Salesforce SLA 99.9% uptime)
|• Async Case creation with retry logic +
• Event Bus queues buffer work during outage +
• Customers get immediate "Feedback submitted" (not blocked) +
• Monitor Salesforce status page, alert ops team +
• Automatic retry when Salesforce recovers

|RISK-CS-003
|*Contact migration data quality issues*: App database Contact data incomplete or invalid
|HIGH (migration fails validation, cutover delayed)
|MEDIUM (legacy data quality unknown)
|• Pre-migration data quality assessment +
• Flexible upsert logic (match by email/phone/VCI) +
• Validation report identifies data issues before production migration +
• Manual cleanup for invalid records +
• Dry-run migration in sandbox environment

|RISK-CS-004
|*Duplicate Contacts created*: Email matching fails, ProfileService creates duplicate Contacts
|MEDIUM (support agents see multiple profiles for same customer)
|MEDIUM (email changes, data quality issues)
|• Salesforce duplicate detection rules (if available) +
• ProfileService logs Contact creation for audit trail +
• Manual duplicate cleanup process (support team) +
• Future enhancement: VCI as Salesforce External ID for stable matching

|RISK-CS-005
|*Dead letter queue accumulation*: Failed Case creations not processed, queue grows
|HIGH (customers don't receive Case confirmation, feedback lost)
|LOW (retry logic handles most failures)
|• Dead letter queue monitoring and alerting +
• Ops team dashboard showing DLQ depth +
• Manual intervention process (investigate and reprocess) +
• Automated alerts when DLQ depth exceeds threshold +
• Root cause analysis for recurring failures

|RISK-CS-006
|*Salesforce webhook failures*: Salesforce can't deliver Case update notifications to EngagementService
|MEDIUM (customers don't get push notifications for Case resolution)
|LOW (webhook mechanism reliable)
|• Webhook retry logic and exponential backoff +
• EngagementService logs webhook deliveries +
• Monitor webhook delivery success rate +
• Fallback: Poll Salesforce API for Case updates (if webhook fails persistently) +
• Alert ops team when webhook delivery rate drops

|RISK-CS-007
|*Multi-tenant data isolation breach*: OTR digital Cases visible to other Viva Energy support teams
|HIGH (privacy violation, compliance risk)
|LOW (Salesforce governance controls)
|• Work with Viva Energy Salesforce admin team on data isolation strategy +
• Test data visibility in Salesforce sandbox (UAT with different user roles) +
• Validate Record Types, queues, field-level security before production +
• Audit Salesforce user permissions and sharing rules

|RISK-CS-008
|*Mobile App release coordination*: App release delayed, cutover window missed
|MEDIUM (cutover delayed, D365 CE retirement delayed)
|MEDIUM (release schedule conflicts)
|• Coordinate cutover timing with Mobile team early +
• Buffer time in migration plan (2-week contingency) +
• Decouple backend deployment from Mobile App release (backend deployed first, app follows) +
• Feature flag for feedback submission (enable when ready)

|RISK-CS-009
|*Event Bus infrastructure issues*: SNS/SQS/EventBridge downtime or misconfiguration
|HIGH (Case creation blocked, domain events not published)
|LOW (AWS SLA 99.99% uptime)
|• Leverage existing AWS infrastructure (proven, reliable) +
• Infrastructure as Code (IaC) for Event Bus configuration +
• Integration testing in non-production environment +
• Monitor Event Bus metrics (queue depth, throughput, errors) +
• Alert ops team on Event Bus failures

|RISK-CS-010
|*Team DDD knowledge gap*: Team unfamiliar with DDD patterns, bounded contexts, event-driven architecture
|MEDIUM (implementation delays, architectural inconsistencies)
|HIGH (first DDD implementation)
|• DDD training for development team (workshops, documentation) +
• Architecture review sessions (validate bounded context design) +
• Pair programming with experienced DDD practitioners +
• Incremental implementation (start small, iterate) +
• Document architectural patterns in CLAUDE.md

|===

== Assumptions and Constraints

=== Assumptions

[width="100%",cols="8%,92%",options="header",]
|===
|ID |Assumption

|ASM-CS-001
|Viva Energy Salesforce admin team will provide Salesforce production access, sandbox environment, and support for Case field mapping and data isolation configuration

|ASM-CS-002
|App database Contact data is sufficiently complete for migration (email/phone/VCI available for matching)

|ASM-CS-003
|Expected customer feedback volume is within Salesforce API rate limits (to be validated with feedback volume data)

|ASM-CS-004
|Existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis) is sufficient for Event Bus implementation (no additional infrastructure provisioning required)

|ASM-CS-005
|Braze integration already exists and can be extended for Case-related push notifications (no new Braze account or major configuration changes)

|ASM-CS-006
|Mobile App users have email addresses associated with their accounts (required for ProfileService Contact reconciliation)

|ASM-CS-007
|D365 Customer Engagement historical Cases have limited business value and do not require migration to Salesforce

|ASM-CS-008
|Support agents are trained on Salesforce Service Cloud and require minimal additional training for OTR digital customer Cases

|ASM-CS-009
|Salesforce Service Cloud shared instance has capacity for OTR digital customer Contacts and Cases (no additional licensing or storage costs)

|ASM-CS-010
|Mobile App release schedule can accommodate cutover timing (Week 10 in migration plan)

|===

=== Constraints

[width="100%",cols="8%,92%",options="header",]
|===
|ID |Constraint

|CON-CS-001
|Must use shared Viva Energy Salesforce Service Cloud instance (cannot deploy separate OTR-specific instance)

|CON-CS-002
|Must conform to existing Salesforce configuration and governance (Record Types, custom fields, queues, data isolation strategy defined by Viva Energy admin team)

|CON-CS-003
|Contact migration must complete before Mobile App cutover (no parallel run of D365 CE and Salesforce)

|CON-CS-004
|Big bang cutover only (no phased rollout with feature flags or pilot users)

|CON-CS-005
|Salesforce API rate limits and authentication method constrained by Viva Energy Salesforce configuration (TBD)

|CON-CS-006
|Event Bus implementation must use existing AWS infrastructure (SNS+SQS/EventBridge/Kinesis - cannot introduce new infrastructure components)

|CON-CS-007
|Mobile App feedback form must include specific fields: Category, Store Name, Time of Visit, Contact Phone Number, Free Text Message (no attachments)

|CON-CS-008
|D365 Customer Engagement must be decommissioned within 90 days post-cutover (ADR-CS-006)

|CON-CS-009
|ProfileService and EngagementService must be stateless (no local aggregate persistence, Salesforce is System of Record)

|CON-CS-010
|First DDD bounded context implementation (team learning curve, architectural patterns must be documented for future bounded contexts)

|===

== Non-Functional Requirements

== Monitoring and Observability

=== Key Metrics

[width="100%",cols="25%,40%,35%",options="header",]
|===
|Metric Category |Metric |Target/Threshold

|*Feedback Submission*
|Feedback submission success rate (Mobile App → EngagementService)
|> 99.5%

|*Async Case Creation*
|Case creation success rate (EngagementService → Salesforce)
|> 99%

|*Async Case Creation*
|Case creation latency (time from feedback submission to Case created in Salesforce)
|p95 < 5 minutes

|*Event Bus*
|Event Bus queue depth (pending Case creations)
|< 100 messages

|*Event Bus*
|Dead letter queue depth (failed Case creations)
|= 0 (alert on any failures)

|*Salesforce API*
|Salesforce API error rate
|< 1%

|*Salesforce API*
|Salesforce API latency (Case creation)
|p95 < 2 seconds

|*Salesforce API*
|Salesforce API rate limit utilization
|< 80% of limit

|*ProfileService*
|Contact reconciliation success rate (JIT lookups)
|> 99.5%

|*ProfileService*
|Contact reconciliation latency
|p95 < 500ms

|*Braze Notifications*
|Push notification delivery rate (Case created/updated)
|> 95%

|*Salesforce Webhook*
|Webhook delivery success rate (Salesforce → EngagementService)
|> 99%

|*Customer Satisfaction*
|Customer satisfaction score (CSAT)
|> 4.0/5.0 (improve by 15% from D365 CE baseline)

|*Support Operations*
|Average case resolution time
|Decrease by 20% from D365 CE baseline

|===

=== Alerting Thresholds

[width="100%",cols="25%,50%,25%",options="header",]
|===
|Alert |Condition |Severity

|*Feedback submission failures*
|Feedback submission success rate < 95% over 5-minute window
|P1 - Critical

|*Dead letter queue accumulation*
|Dead letter queue depth > 0 (any failed Case creations)
|P2 - High

|*Event Bus queue backlog*
|Event Bus queue depth > 100 messages for > 15 minutes
|P2 - High

|*Salesforce API errors*
|Salesforce API error rate > 5% over 5-minute window
|P1 - Critical

|*Salesforce API rate limits*
|Salesforce API rate limit utilization > 90%
|P2 - High

|*Contact reconciliation failures*
|ProfileService Contact reconciliation failure rate > 5% over 5-minute window
|P2 - High

|*Braze notification failures*
|Braze push notification delivery rate < 80% over 15-minute window
|P3 - Medium

|*Salesforce webhook failures*
|Salesforce webhook delivery success rate < 90% over 15-minute window
|P2 - High

|*Case creation latency*
|Case creation latency p95 > 10 minutes
|P3 - Medium

|===

=== Dashboards

*ProfileService Dashboard:*

* Contact reconciliation success rate (JIT lookups)
* Contact reconciliation latency (p50, p95, p99)
* Contact creation vs update ratio (new Contacts created vs existing Contacts updated)
* Salesforce API error rate (Contact queries and creates)
* Request rate and throughput

*EngagementService Dashboard:*

* Feedback submission success rate
* Case creation success rate (async workflow)
* Case creation latency (p50, p95, p99)
* Event Bus queue depth (pending Case creations)
* Dead letter queue depth (failed Case creations)
* Salesforce API error rate (Case creation)
* Salesforce API latency
* Salesforce API rate limit utilization
* Braze push notification delivery rate
* Salesforce webhook delivery success rate

*Event Bus Dashboard:*

* Queue depth (pending messages)
* Throughput (messages published/consumed per minute)
* Dead letter queue depth (failed messages)
* Consumer lag (time between publish and consume)

*Customer Support Dashboard (Business Metrics):*

* Total feedback submissions per day/week/month
* Feedback category breakdown (App, Service, Order, Rewards, Refund, Delete Account)
* Customer satisfaction score (CSAT) trend
* Average case resolution time trend
* Case volume by support team/queue
* Unified customer view adoption (support agent feedback)