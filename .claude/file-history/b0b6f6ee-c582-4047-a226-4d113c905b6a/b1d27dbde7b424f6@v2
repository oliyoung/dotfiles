= OTR-2026-01 Flybuys Integration - Architecture Definition
:project-name:OTR-2026-01
:togaf-adm-phase: Phase C: Information Systems Architectures
:document-type: Architecture Definition Document
:status: Discovery
:version: 0.1
:domain: Loyalty
:programme-lead: Frankie.Mullaly@vivaenergy.com.au
:domain-architect: O.Young@otr.com.au
:business-owner: D.Peisley@otr.com.au
:business-analyst: Fiona.Cheung@vivaenergy.com.au
:solution-architecture: xref:solution-architectures:flybuys_integration.adoc[Solution Architectures/Flybuys Integration]
:doctype: article
:toc: left
:toclevels: 4
:sectanchors:
:sectlinks:
:sectnums:
:icons: font
:source-highlighter: highlightjs
:experimental:
:description: Architecture Definition Document for Flybuys Coalition Loyalty Integration
:keywords: loyalty, flybuys, integration, architecture-definition, togaf, ddd

== Introduction & Vision

=== Purpose

OTR and Reddy Express customers experience fragmented loyalty programmes across the OTRG store network. +

While REXP stores use manual xref:bounded-contexts:flybuys.adoc[Flybuys] batch processing based on legacy pre-TSA architectures and statically stored xref:bounded-contexts:flybuys.adoc[Flybuys] Account numbers, OTR stores offer a native rewards programme, with no digital coalition partner linking between OTRG and other potential coalition partners, including xref:bounded-contexts:flybuys.adoc[Flybuys].

This architectural deficiency prevents OTRG from utilising standardised patterns for linking user accounts with coalition partners, inhibiting future partnership opportunities and platform extensibility.

=== Vision

> Enable Customers to seamlessly link Coalition Loyalty partners to their OTR Profile via our mobile app, select their reward preference, and earn partner points while maintaining architectural flexibility to evolve OTRG's native loyalty capability independently.

=== Architectural Approach

This architecture introduces three xref:ROOT:ubiquitous_language.adoc#bounded-context[bounded contexts]

* xref:bounded-contexts:profile.adoc[Profile Service]: Partner account linking (OAuth 2.0), reward preference management, canonical customer identity
* xref:bounded-contexts:loyalty.adoc[Loyalty Service]: xref:ROOT:ubiquitous_language.adoc#transaction-adjudication[Transaction adjudication], xref:ROOT:ubiquitous_language.adoc#credential-resolution[Credential resolution], xref:ROOT:ubiquitous_language.adoc#partner-integration[Loyalty partner integration facade], automated batch posting
* xref:bounded-contexts:engagement.adoc[Engagement Service] : Customer Engagement campaigns, notification orchestration, Braze Anti-Corruption Layer

implementing Domain-Driven Design patterns:

* xref:patterns:backend_for_frontend.adoc[Backend-for-Frontend (BFF)]: Orchestrates multiple backend systems for Mobile and POS clients
* xref:patterns:event_bus.adoc[Event-driven integration]: Loose coupling via Event Bus with published domain events
* xref:patterns:anti_corruption_layer.adoc[Anti-Corruption Layers]: Isolation from external systems (xref:bounded-contexts:braze.adoc[Braze], xref:bounded-contexts:eagle_eye.adoc[EagleEye], xref:bounded-contexts:flybuys.adoc[Flybuys], xref:bounded-contexts:microsoft_dynamics_365_commerce.adoc[D365 Commerce])
* xref:patterns:strangler_fig.adoc[Strangler Fig]: Gradual safe
migration from legacy integration patterns to new bounded contexts
* *Phased rollout*: Parallel deployment alongside legacy xref:bounded-contexts:otr_app_api.adoc[OTR App API] with feature flag-controlled gradual enablement (link:#AS-1_Foundation[AS-1 Foundation] → link:#AS-2_Linking[AS-2 Linking] → link:#AS-3_Grants[AS-3 Grants]) The xref:bounded-contexts:profile.adoc[Profile Service] also serves as a facade for xref:bounded-contexts:otr_pos.adoc[OTR POS] integration to xref:bounded-contexts:salesforce_crm.adoc[Salesforce CRM]

=== Architecture Overview

The following diagram shows the target state architecture with three new bounded contexts (xref:bounded-contexts:profile.adoc[Profile Service], xref:bounded-contexts:loyalty.adoc[Loyalty Service], xref:bounded-contexts:engagement.adoc[Engagement Service]) integrating with existing systems:

[mermaid]
----
---
layout: elk
---
flowchart LR
    Customer(["Customer"]) -- Uses --> MobileApp["Mobile App<br>iOS/Android"]
    Customer -- Shops at --> POS["OTR/OTR+ POS<br>D365 Commerce"]
    Customer -- Receives --> EngagementService["Engagement Service<br>Campaign Triggers<br>Customer Notifications<br>Braze Integration"]
    MobileApp -- Authenticate --> EntraID["Microsoft Entra<br>External ID<br>CIAM"]
    MobileApp -- "Link Partner Account<br>OAuth 2.0 + PKCE" --> ProfileService["Profile Service<br>Partner Account Linking<br>Reward Preferences"]
    MobileApp -- Get Partner Links<br>Update Preferences --> ProfileService
    MobileApp -- Query Flybuys Balance<br>via ACL --> LoyaltyService["Loyalty Service<br>Transaction Adjudication<br>Credential Resolution<br>Batch Processing"]
    POS -- Scan Loyalty Credential<br>Resolve to VCI --> LoyaltyService
    POS -- "Transaction Adjudication<br>Real-time &lt;500ms" --> LoyaltyService
    ProfileService -- "Store OAuth Tokens<br>AES-256 Encrypted" --> OAuthService["OAuth Service<br>Token Management"]
    ProfileService -- Query Customer Profile<br>Conformist --> Salesforce["Salesforce CRM<br>Customer Profile<br>System of Record"]
    ProfileService -- Publish Events<br>PartnerLinked<br>RewardPreferenceChanged --> EventBus[("Event Bus<br>Domain Events")]
    LoyaltyService -- Transaction Adjudication<br>via ACL --> EagleEye["EagleEye<br>Loyalty Engine<br>Points, Offers, Wallet"]
    LoyaltyService -- Query Wallet/Points/Tiers<br>via ACL --> EagleEye
    LoyaltyService -- Nightly Batch SFTP<br>PGP Encrypted --> Flybuys["Flybuys<br>Coalition Partner<br>OAuth, SFTP"]
    LoyaltyService -- OAuth Balance Query<br>via ACL --> Flybuys
    LoyaltyService -- Query Reward Preference<br>REST API --> ProfileService
    LoyaltyService -- Publish Events<br>TransactionAdjudicated<br>PointsEarned --> EventBus
    EngagementService -- Consume Events<br>PartnerLinked<br>TransactionAdjudicated<br>PointsEarned --> EventBus
    EngagementService -- Trigger Campaigns<br>Push Notifications<br>via ACL --> Braze["Braze<br>Marketing Automation<br>Webhooks"]
    EngagementService -- Query Customer Profile<br>Conformist --> Salesforce
    OAuthService -- OAuth Token Exchange<br>Authorization Code Flow --> Flybuys

     Customer:::customer
     MobileApp:::presentation
     POS:::presentation
     EngagementService:::newService
     EntraID:::external
     ProfileService:::newService
     LoyaltyService:::newService
     OAuthService:::infrastructure
     Salesforce:::external
     EventBus:::infrastructure
     EagleEye:::external
     Flybuys:::external
     Braze:::external
    classDef newService fill:#4CAF50,stroke:#2E7D32,stroke-width:3px,color:#fff
    classDef external fill:#FF9800,stroke:#E65100,stroke-width:2px,color:#fff
    classDef infrastructure fill:#2196F3,stroke:#0D47A1,stroke-width:2px,color:#fff
    classDef presentation fill:#9C27B0,stroke:#4A148C,stroke-width:2px,color:#fff
    classDef customer fill:#607D8B,stroke:#263238,stroke-width:2px,color:#fff
----

==== Key Architectural Patterns

[width="100%",cols="19%,34%,47%",options="header",]
|===
|Pattern | Application | Rationale
| xref:patterns:anti_corruption_layer.adoc[Anti-Corruption Layer] | xref:bounded-contexts:loyalty.adoc[LoyaltyService] → xref:bounded-contexts:eagle_eye.adoc[EagleEye], xref:bounded-contexts:engagement.adoc[EngagementService] → xref:bounded-contexts:braze.adoc[Braze] | Isolates domain model from external system changes, translates between bounded contexts
|*Customer-Supplier + Conformist* | xref:bounded-contexts:profile.adoc[ProfileService] → SalesforceEngagementService → Salesforce | We conform to Salesforce API (external system we don’t control)
|*Backend-for-Frontend (BFF)* | xref:bounded-contexts:loyalty.adoc[LoyaltyService] | Orchestrates multiple backend systems (EagleEye, ProfileService) for POS/Mobile clients
|*Event-Driven Architecture* | xref:patterns:event_bus.adoc[Event Bus (OHS+PL)] | Loose coupling between bounded contexts, asynchronous notification of domain events
|*Event Consumer* | xref:bounded-contexts:engagement.adoc[EngagementService] | Consumes domain events from Profile and Loyalty contexts to trigger customer campaigns
|*OAuth 2.0 + PKCE* | xref:bounded-contexts:profile.adoc[ProfileService] → xref:bounded-contexts:flybuys.adoc[Flybuys] | Secure partner account linking without storing passwords
|*Strangler Fig* | Parallel deployment with feature flags | Gradual migration to new bounded contexts
|===

== Technical Requirements

[width="100%",cols="10%,90%",options="header",]
|===
|ID | Description
|TR-001 | Every xref:bounded-contexts:mobile.adoc[Mobile Application] user has a xref:ROOT:ubiquitous_language.adoc#Salesforce%2520Contact[Salesforce Contact] record in xref:bounded-contexts:salesforce_crm.adoc[Salesforce CRM]
|TR-002 | Every xref:bounded-contexts:mobile.adoc[Mobile Application] user has a xref:ROOT:ubiquitous_language.adoc#viva-consumer-id-vci[VCI] part of their xref:ROOT:ubiquitous_language.adoc#loyalty-credential[Loyalty Credentials]
|TR-003 | Every xref:bounded-contexts:mobile.adoc[Mobile Application] user has a xref:ROOT:ubiquitous_language.adoc#Wallet[Loyalty Wallet] part of their xref:ubiquitous_language#loyalty_credential[Loyalty Credentials]
|TR-004 | xref:ROOT:ubiquitous_language.adoc#Customer[Customers] have a single set of xref:ROOT:ubiquitous_language.adoc#loyalty-credential[Loyalty Credentials]
|TR-005 | xref:ROOT:ubiquitous_language.adoc#Customer[Customers] are able to link and unlink their xref:ROOT:ubiquitous_language.adoc#Flybuys%2520Digital%2520Identity[Flybuys Digital Identity] from any xref:bounded-contexts:mobile.adoc[Mobile Application]
|TR-006 | xref:ROOT:ubiquitous_language.adoc#Customer[Customers] can manage their xref:ROOT:ubiquitous_language.adoc#Reward%2520Preference[Reward Preference] (select and retain preference)
|TR-007 | xref:bounded-contexts:flybuys.adoc[Flybuys] xref:ROOT:ubiquitous_language.adoc#Partner[Partner] transactions are posted to xref:bounded-contexts:flybuys.adoc[Flybuys] for points allocation to xref:ROOT:ubiquitous_language.adoc#Flybuys%2520Earning%2520Rules[Earning Rules]
|TR-008 | xref:bounded-contexts:otr_pos.adoc[OTR POS] stores recognise all xref:ROOT:ubiquitous_language.adoc#loyalty-credential[Loyalty Credentials] and grant Flybuys Points on fulfilled Transactions where a Customer has a linked Flybuys Digital Identity
|TR-009 | xref:bounded-contexts:otr_plus_pos.adoc[OTR+ POS] stores recognise all xref:ROOT:ubiquitous_language.adoc#loyalty-credential[Loyalty Credentials] and grant Flybuys Points on fulfilled Transactions where a Customer has a linked Flybuys Digital Identity
|TR-010 | xref:ROOT:ubiquitous_language.adoc#Customer[Customers] can retrieve their xref:bounded-contexts:flybuys.adoc[Flybuys] points balance in real-time within any xref:bounded-contexts:mobile.adoc[Mobile Application]
|[line-through]*TR-011* |[line-through]*xref:bounded-contexts:flybuys.adoc[Flybuys] xref:ROOT:ubiquitous_language.adoc#Digital%2520Fuel%2520Dockets[Digital Fuel Dockets] are redeemable at xref:bounded-contexts:otr_pos.adoc[OTR POS] and xref:bounded-contexts:otr_plus_pos.adoc[OTR+ POS]*
|TR-012 | All transactions by xref:ROOT:ubiquitous_language.adoc#loyalty-credential[Credentialed] xref:ROOT:ubiquitous_language.adoc#Customer[Customers] through any channel are adjudicated by xref:bounded-contexts:eagle_eye.adoc[EagleEye]
|TR-013 | Web and Mobile Clients geographically show which Loyalty programmes are available at each store
|TR-014 | All changes are communicated using a decoupled event-based architecture
|TR-015 | ##Reporting##
|TR-016 | ##Customer Service##
|===

=== Technical Requirements Mapping

[cols=",",options="header",]
|===
|Business Requirement | Technical Requirement
|LNKHL_001 | TR-005
|LNKHL_002 | TR-005
|LNKHL_003 | TR-004
|LNKHL_004 | TR-005
|LNKHL_005 | TR-005
|LNKHL_006 | TR-014
|LNKHL_007 | TR-014
|LNKHL_008 | TR-014
|LNKHL_009 | TR-014
|NTWHL_001 | TR-012
|NTWHL_002 | TR-012
|NTWHL_003 | TR-013
|NTWHL_003 | TR-013
|PEHL_001 | TR-012
|PEHL_002 |
|PEHL_003 | TR-010
|PEHL_004 | TR-012
|INAHL_001 | TR-008 TR-009
|INAHL_002 | TR-008 TR-009
|INAHL_003 | TR-008 TR-009
|INAHL_004 | TR-008 TR-009
|INAHL_005 | TR-008 TR-009
|INAHL_006 | TR-008 TR-009
|INSHL_001 | TR-008 TR-009
|INSHL_002 | TR-014
|TCRHL_001 | TR-007
|TCRHL_002 | TR-015
|TCRHL_003 | TR-015
|TCRHL_004 | TR-015
|TCRHL_005 | TR-015
|TCRHL_006 | TR-015
|TCRHL_007 | TR-015
|CEHL_001 | TR-016
|CEHL_002 | TR-016
|CEHL_003 | TR-016
|===

=== Stakeholder Analysis

[width="100%",cols="20%,28%,10%,11%,31%",options="header",]
|===
|Stakeholder | Role | Interest Level | Influence Level | Engagement Strategy
|Darren Peisley | Business Owner | High | High | Steering, requirements sign-off
|Amin Joderyi | Mobile Application and Ecommerce Lead | High | High |Collaboration
|Frankie Mullaly | Programme Lead | High | Medium | Status updates, escalation point
|Oli Young | Domain Architect | High | High | Collaboration, architecture decisions
|Fiona Cheung | Business Analyst | Medium | Medium | Requirements gathering, documentation
|David Le Pham | Product Owner | High | High | Product decisions, prioritisation
|Paola Buchan | Marketing & Campaigns Lead | High | Medium | Campaign planning, promotional strategy
|Nick Cannizzo | Project Manager | High | Low | Programme coordination
|Mobile App Users | End Users | High | Low | Beta testing programme, feedback surveys
|xref:bounded-contexts:flybuys.adoc[Flybuys] | External Partner |Medium | Medium | Coordination, API support
|xref:bounded-contexts:eagle_eye.adoc[EagleEye] | SaaS Loyalty Platform Vendor | Medium | Medium | Business reviews, support tickets
|D365 Team | POS Operations | Medium | Medium | Training sessions, operational readiness
|Customer Support Team | Support & Troubleshooting | Medium | Low |Training, escalation procedures
|Fullstack Team | CRM Integration | Low | Low | Integration coordination
|Platform Infrastructure | Cloud Platform | Low | High | Deployment planning, capacity planning
|Data Team | Data Integration | Low | Medium | Data pipeline coordination
|===

=== Baseline Architecture

==== Current Business Capability

[width="100%",cols="19%,7%,9%,4%,57%,4%",options="header",]
|===
|L1 Domain | L2 Subdomain | L3 Capability | Owned By | Supporting Systems |Maturity Level
|xref:domains:loyalty.adoc[Loyalty Domain] | Preference Management |Reward Preference Management | Loyalty Team
|xref:bounded-contexts:salesforce_crm.adoc[Salesforce CRM] (manual updates via xref:bounded-contexts:flybuys.adoc[Flybuys]) | Initial
|xref:domains:loyalty.adoc[Loyalty Domain] | Transaction Processing |Transaction Adjudication | Loyalty Team |xref:bounded-contexts:otr_plus_pos.adoc[OTR+ POS], xref:bounded-contexts:coupon_scanner.adoc[Coupon Scanner], xref:bounded-contexts:eagle_eye.adoc[EagleEye] | Managed
|xref:domains:loyalty.adoc[Loyalty Domain] | Transaction Processing |Transaction Posting | Loyalty Team | CSV export, SFTP upload | Initial
|xref:domains:engagement.adoc[Engagement Domain] | Channel Recognition | Mobile Loyalty Credential | Mobile Team
|xref:bounded-contexts:mobile.adoc[Mobile Application], xref:bounded-contexts:otr_app_api.adoc[OTR App API] | Managed
|xref:domains:engagement.adoc[Engagement Domain] | Channel Recognition | POS Loyalty Credential | D365 Team |xref:bounded-contexts:otr_pos.adoc[OTR POS], xref:bounded-contexts:otr_plus_pos.adoc[OTR+ POS] | Managed
|xref:domains:engagement.adoc[Engagement Domain] | Personalised Offers | Digital Fuel Docket Redemption | Loyalty Team |xref:bounded-contexts:otr_plus_pos.adoc[OTR+ POS], xref:bounded-contexts:coupon_scanner.adoc[Coupon Scanner], xref:bounded-contexts:eagle_eye.adoc[EagleEye] | Managed
|Infrastructure | Partner Integration | Directly Coupled | Platform Team |Direct coupling to external systems | Managed
|===

==== Current Value Stream

===== Customer Redeems Flybuys Fuel Discount

[mermaid]
----
sequenceDiagram
    actor Customer
    participant Scanner as Coupon Scanner
    participant POS as OTR+ POS
    participant D365 as D365 Commerce
    participant DataTeam as Data Team
    participant SQL as SQL Database
    participant SFTP as SFTP Server
    participant Flybuys as Flybuys
    participant Support as Call Centre

    Customer->>Scanner: Present Flybuys card
    Scanner-->>Customer: Scan fuel docket barcode

    Customer->>POS: Make purchase (fuel/products)
    POS->>D365: Process transaction
    D365-->>POS: Transaction recorded
    POS-->>Customer: Receipt (no points confirmation)

    Note over Customer,Flybuys: Manual Batch Process (Next Day)

    DataTeam->>SQL: Run SQL query
    SQL-->>DataTeam: Transaction data
    DataTeam->>DataTeam: Generate CSV file manually
    DataTeam->>SFTP: Manual SFTP upload

    Note over SFTP,Flybuys: 24+ Hour Delay

    Flybuys->>SFTP: Retrieve batch file
    Flybuys->>Flybuys: Process transactions
    Flybuys->>Flybuys: Credit points to member account

    alt Customer checks points before batch processing
        Customer->>Support: Call support (missing points)
        Support->>Support: Manual investigation (10-15 min)
        Support->>SQL: Query transaction status
        Support-->>Customer: "Points will appear in 24-48 hours"
    end

    Note over Customer,Flybuys: Pain Points:<br/>- No real-time adjudication<br/>- Manual CSV export/upload<br/>- 24+ hour delay<br/>- No retry logic<br/>- High support burden
----

[width="100%",cols="21%,30%,15%,4%,13%,17%",options="header",]
|===
|Actor | Activity | System | Duration | Value Added | Pain Points / Waste
|xref:ubiquitous_language.adoc#Customer[Customer] | Present xref:ROOT:ubiquitous_language.adoc#Flybuys%2520Cardholder%2520Number[Flybuys Card] | xref:bounded-contexts:coupon_scanner.adoc[Coupon Scanner] | < 1 Sec | None | Significant delay, manual reconciliation
|xref:ubiquitous_language.adoc#Customer[Customer] | Makes purchase (fuel/products) | xref:bounded-contexts:otr_plus_pos.adoc[OTR+ POS] | < 1 Sec | Complete transaction | No real-time points confirmation at POS
|xref:bounded-contexts:otr_pos.adoc[OTR POS] | Process transaction
|xref:bounded-contexts:microsoft_dynamics_365_commerce.adoc[Microsoft Dynamics 365 Commerce] | < 1 sec | Record transaction | No immediate adjudication
|xref:bounded-contexts:flybuys.adoc[Flybuys] | Process batch file | xref:bounded-contexts:flybuys.adoc[Flybuys] | > 24 hours |Credit points to member account | Processing time outside OTR control
|Data Team | Export Flybuys transactions | Automated SQL query, CSV generation | Automated | Prepare Flybuys batch file |
|Data Team | Upload to Flybuys SFTP | AutomatedSFTP upload | Automated |Post transactions to Flybuys | Automated upload, no retry logic
|Customer | Call support if issue | Call centre | 10-15 min | Troubleshoot missing points | High support burden, manual investigation
|===

==== Pain Points

[width="100%",cols="16%,38%,46%",options="header",]
|===
|Category | Pain Point | Business Impact
|Customer Experience | No linking process | Low adoption, no communication permissions
|Customer Experience | No visibility of Flybuys balance in OTR app |Customer confusion, support calls
|Integration | Tight coupling to xref:bounded-contexts:eagle_eye.adoc[EagleEye] and xref:bounded-contexts:flybuys.adoc[Flybuys] APIs | Brittle integration, difficult to change partners
|Compliance | No just-in-time transaction adjudication | Loyalty is pushed to stores causing scaling and timing issues
|===

=== Target State Architecture

==== Business Capability

[width="100%",cols="12%,15%,41%,7%,25%",options="header",]
|===
|L1 Domain | L2 Subdomain | L3 Capability | Owned By | Supporting Systems
|xref:domains:loyalty.adoc[Loyalty Domain] | Partner Integration |Partner Account Linking | OTR Digital IT |xref:bounded-contexts:profile.adoc[Profile Service], xref:bounded-contexts:oauth.adoc[OAuth Service]
|xref:domains:loyalty.adoc[Loyalty Domain] | Points Ledger | Points Earning & Redemption | OTR Digital IT |xref:bounded-contexts:loyalty.adoc[Loyalty Service], xref:bounded-contexts:eagle_eye.adoc[EagleEye]
|xref:domains:loyalty.adoc[Loyalty Domain] | Partner Integration |Partner Points Reconciliation | OTR Digital IT |xref:bounded-contexts:loyalty.adoc[Loyalty Service], xref:bounded-contexts:flybuys.adoc[Flybuys]
|xref:domains:loyalty.adoc[Loyalty Domain] | Preference Management |Reward Preference Management | OTR Digital IT |xref:bounded-contexts:profile.adoc[Profile Service]
|xref:domains:loyalty.adoc[Loyalty Domain] | Transaction Processing |xref:ubiquitous_language.adoc#Transaction%2520Adjudication[Transaction Adjudication] | OTR Digital IT |xref:bounded-contexts:loyalty.adoc[Loyalty Service], xref:bounded-contexts:eagle_eye.adoc[EagleEye]
|xref:domains:loyalty.adoc[Loyalty Domain] | Transaction Processing |Transaction Posting | OTR Digital IT |xref:bounded-contexts:loyalty.adoc[Loyalty Service], xref:bounded-contexts:flybuys.adoc[Flybuys]
|xref:domains:loyalty.adoc[Loyalty Domain] | Partner Integration |Real-Time Balance Display | OTR Digital IT |xref:bounded-contexts:mobile.adoc[Mobile Application], xref:bounded-contexts:loyalty.adoc[Loyalty Service]
|xref:domains:profile.adoc[Profile Domain] | Customer Profile Management | Mobile Loyalty Credential | OTR Digital IT |xref:bounded-contexts:mobile.adoc[Mobile Application], xref:bounded-contexts:profile.adoc[Profile Service]
|xref:domains:profile.adoc[Profile Domain] | Customer Profile Management | POS Loyalty Credential | |xref:bounded-contexts:otr_pos.adoc[OTR POS], xref:bounded-contexts:otr_plus_pos.adoc[OTR+ POS], xref:bounded-contexts:loyalty.adoc[Loyalty Service]
|xref:domains:loyalty.adoc[Loyalty Domain] | Partner Integration |Digital Fuel Docket Redemption | |xref:bounded-contexts:otr_pos.adoc[OTR POS], xref:bounded-contexts:otr_plus_pos.adoc[OTR+ POS], xref:bounded-contexts:loyalty.adoc[Loyalty Service]
|Infrastructure | Integration | OAuth Token Management | |xref:bounded-contexts:oauth.adoc[OAuth Service]
|Infrastructure | Integration | Anti-Corruption Layer | |xref:bounded-contexts:loyalty.adoc[Loyalty Service], xref:bounded-contexts:profile.adoc[Profile Service]
|Infrastructure | Event Bus | Event Publishing |  | Event Bus
|===

==== Value Stream

===== Customer Links Flybuys Digital Identity and earns Flybuys Points

==== OAuth Partner Linking Flow

[source,mermaid]
----
sequenceDiagram
    autonumber
    actor Customer
    participant Mobile as Mobile App
    participant Profile as Profile Service
    participant FlybuysOAuth as Flybuys OAuth Server
    participant KeyVault as Azure Key Vault
    participant DB as Profile Database
    participant EventBus as Event Bus

    Note over Customer,EventBus: Customer initiates Flybuys account linking

    Customer->>Mobile: Tap "Link Flybuys Account"

    activate Mobile
    Mobile->>Mobile: Generate PKCE code verifier (128 bytes)
    Mobile->>Mobile: Hash verifier → code challenge (SHA256)
    Mobile->>FlybuysOAuth: Redirect to OAuth authorize endpoint<br/>?code_challenge=xxx&state=yyy
    deactivate Mobile

    activate FlybuysOAuth
    FlybuysOAuth-->>Customer: Show Flybuys login page
    deactivate FlybuysOAuth

    Customer->>FlybuysOAuth: Enter Flybuys credentials
    activate FlybuysOAuth
    FlybuysOAuth->>FlybuysOAuth: Authenticate user
    FlybuysOAuth-->>Customer: Show consent screen<br/>"OTR wants to access your account"
    deactivate FlybuysOAuth

    Customer->>FlybuysOAuth: Approve consent
    activate FlybuysOAuth
    FlybuysOAuth->>FlybuysOAuth: Generate authorization code
    FlybuysOAuth-->>Mobile: Redirect callback<br/>?code=AUTH_CODE&state=yyy
    deactivate FlybuysOAuth

    activate Mobile
    Mobile->>Mobile: Verify state parameter (CSRF protection)
    Mobile->>Profile: POST /partners<br/>{oauthCode, codeVerifier}
    deactivate Mobile

    activate Profile
    Profile->>FlybuysOAuth: POST /token<br/>{code, code_verifier, client_id}
    activate FlybuysOAuth
    FlybuysOAuth->>FlybuysOAuth: Verify code_verifier matches challenge
    FlybuysOAuth-->>Profile: {access_token, refresh_token, expires_in: 3600}
    deactivate FlybuysOAuth

    Profile->>FlybuysOAuth: GET /member/profile<br/>Authorization: Bearer {access_token}
    activate FlybuysOAuth
    FlybuysOAuth-->>Profile: {externalMemberId: "123456789012"}
    deactivate FlybuysOAuth

    Profile->>KeyVault: Store tokens<br/>SecretName: flybuys-token-{vci}
    activate KeyVault
    KeyVault->>KeyVault: Encrypt with AES-256
    KeyVault-->>Profile: {secretReference}
    deactivate KeyVault

    Profile->>DB: Create PartnerLink aggregate<br/>{status: "LINKED", oauthTokenRef}
    activate DB
    DB-->>Profile: PartnerLink persisted
    deactivate DB

    Profile->>EventBus: Publish PartnerLinked event<br/>{vivaConsumerId, partner: "FLYBUYS"}
    activate EventBus
    EventBus-->>Profile: Event published
    deactivate EventBus

    Profile-->>Mobile: 201 Created<br/>{partnerLinkId, status: "LINKED"}
    deactivate Profile

    activate Mobile
    Mobile-->>Customer: "Flybuys account linked successfully!"
    deactivate Mobile

    Note over Customer,EventBus: Total flow: 2-3 minutes (user interaction time)
----

==== Transaction Adjudication Flow

[source,mermaid]
----
sequenceDiagram
    autonumber
    actor Customer
    participant POS as POS Terminal<br/>(OTR/OTR+)
    participant Loyalty as Loyalty Service
    participant Profile as Profile Service
    participant EagleEye as EagleEye API
    participant DB as Loyalty Database
    participant EventBus as Event Bus

    Note over Customer,EventBus: Customer has Flybuys linked, preference = FLYBUYS_POINTS

    Customer->>POS: Scan Flybuys barcode
    POS->>Loyalty: POST /credentials/resolve<br/>{barcode: "EAN13"}

    activate Loyalty
    Note over Loyalty: Credential Resolution
    Loyalty->>Loyalty: Decode barcode → externalMemberId
    Loyalty->>Profile: GET /partners?externalMemberId=xxx
    activate Profile
    Profile->>Profile: Query PartnerLink by externalMemberId
    Profile-->>Loyalty: {vivaConsumerId, rewardPreference: "FLYBUYS_POINTS"}
    deactivate Profile
    Loyalty-->>POS: {vivaConsumerId, walletId, rewardPreference}
    deactivate Loyalty

    Note over Customer,EventBus: Resolution: <100ms p95

    Customer->>POS: Complete purchase ($75.50)
    POS->>Loyalty: POST /transactions/adjudicate<br/>{vivaConsumerId, transaction}

    activate Loyalty
    Note over Loyalty: Transaction Adjudication
    Loyalty->>EagleEye: POST /adjudication<br/>{walletId, transaction}
    activate EagleEye
    EagleEye->>EagleEye: Apply earning rules<br/>Base: 100 pts, Bonus: 50 pts
    EagleEye-->>Loyalty: {grants: [{partner: "FLYBUYS", points: 150}]}
    deactivate EagleEye

    Note over Loyalty: Total adjudication: <300ms p95

    Loyalty->>DB: Persist RewardTransaction<br/>{status: "PENDING"}
    activate DB
    DB-->>Loyalty: Transaction saved
    deactivate DB

    Loyalty->>EventBus: Publish TransactionAdjudicated event
    activate EventBus
    EventBus-->>Loyalty: Event published
    deactivate EventBus

    Loyalty-->>POS: {status: "SUCCESS", points: 150}
    deactivate Loyalty

    Note over Loyalty,POS: Total response: <500ms p95

    POS-->>Customer: Receipt: "150 Flybuys points pending"

    Note over Customer,EventBus: Points post to Flybuys within 24 hours via batch
----

===== Detailed Sequence Diagrams

The diagrams above show happy path flows for business stakeholder understanding. For comprehensive implementation details including error scenarios, see xref:solution-architectures:flybuys_integration.adoc[sequence_diagrams/Flybuys Integration Flows].

*Available detailed flows:*

* *Transaction Adjudication* - Happy path + 3 error scenarios (Profile Service timeout, EagleEye circuit breaker, duplicate transaction handling)
* *OAuth Partner Linking* - Happy path + 3 error scenarios (authorization denied, token exchange failure, partner already linked)
* *Batch File Processing* - Happy path + 2 error scenarios (SFTP timeout with retry logic, partial batch rejection)
* *Circuit Breaker* - State transitions (CLOSED → OPEN → HALF_OPEN) with recovery logicL
* *Event Propagation* - Timeline showing eventual consistency window and out-of-order event handling
* *OAuth Token Refresh* - Proactive refresh (50-minute timer) + error scenarios (token expiry, API unavailable)

[width="100%",cols="17%,31%,14%,3%,16%,19%",options="header",]
|===
|Actor | Activity | System | Duration | Value Added | Pain Points / Waste
|xref:ubiquitous_language.adoc#Customer[Customer] | Initiate
xref:ubiquitous_language.adoc#Flybuys%2520Digital%2520Identity[Flybuys
Digital Identity] linking
|xref:bounded-contexts:mobile.adoc[Mobile
Application] | 2 min | Enables coalition loyalty | OAuth redirect
confusing, trust concerns

|xref:ubiquitous_language.adoc#Customer[Customer] | Approve account
linking | xref:bounded-contexts:flybuys.adoc[Flybuys] OAuth | 30
sec | Authorise data sharing | External site navigation, security warnings

|xref:bounded-contexts:profile.adoc[Profile Service] | Store
xref:ubiquitous_language.adoc#Partner%2520Link[Partner Link]
|xref:bounded-contexts:profile.adoc[Profile Service],
xref:bounded-contexts:oauth.adoc[OAuth Service] | <
1 sec | Persist linking status | None

|xref:bounded-contexts:profile.adoc[Profile Service] | Publish
xref:bounded-contexts:profile.adoc#Events[PartnerLinked] event
|Event Bus | < 5 sec | Notify downstream systems | None

|xref:ubiquitous_language.adoc#Customer[Customer] | Make purchase
(fuel/products) | xref:bounded-contexts:otr_pos.adoc[OTR
POS] or xref:bounded-contexts:otr_plus_pos.adoc[OTR+ POS] | 5
min | Complete transaction | No real-time points confirmation at POS

|xref:bounded-contexts:otr_pos.adoc[OTR POS] or
xref:bounded-contexts:otr_plus_pos.adoc[OTR+ POS] | Send
transaction | xref:bounded-contexts:loyalty.adoc[Loyalty Service]
|< 500ms | Trigger reward adjudication | None

|xref:bounded-contexts:loyalty.adoc[Loyalty Service] | Query reward
preference | xref:bounded-contexts:profile.adoc[Profile Service] | <
100ms | Determine reward partner | None

|xref:bounded-contexts:loyalty.adoc[Loyalty Service] | Calculate
rewards | xref:bounded-contexts:eagle_eye.adoc[EagleEye] | < 300ms
|Apply earning rules | Complex rules visibility to customer

|xref:bounded-contexts:loyalty.adoc[Loyalty Service] | Persist
xref:bounded-contexts:loyalty.adoc#Aggregates[RewardTransaction]
|xref:bounded-contexts:loyalty.adoc[Loyalty Service] | < 50ms
|Create audit trail | None

|xref:bounded-contexts:loyalty.adoc[Loyalty Service] | Aggregate
transactions | xref:bounded-contexts:loyalty.adoc[Loyalty Service]
(batch job) | 45 min | Prepare daily batch file (CSV, PGP encryption)
|24-hour delay before points credited

|xref:bounded-contexts:loyalty.adoc[Loyalty Service] | Transmit
batch file via SFTP
|xref:bounded-contexts:flybuys.adoc[Flybuys] SFTP | 15 min | Post
transactions to Flybuys | Transmission failures require retry within
1-hour window

|xref:bounded-contexts:flybuys.adoc[Flybuys] | Process batch
file | xref:bounded-contexts:flybuys.adoc[Flybuys] | 2-4 hours
|Credit points to member account | Processing time outside OTR control

|xref:ubiquitous_language.adoc#Customer[Customer] | View points balance
|xref:bounded-contexts:mobile.adoc[Mobile
Application], xref:bounded-contexts:loyalty.adoc[Loyalty Service]
|< 2 sec | Confirm points earned | Cached balance may be stale (5-minute
TTL)

|xref:bounded-contexts:engagement.adoc[Engagement Service] | Send
confirmation notification
|xref:bounded-contexts:braze.adoc[Braze] | < 10 sec | Notify
customer of points earned | Notification delay if Event Bus has issues
|===

==== Gap Analysis

===== Business Capability Gaps

[width="100%",cols="17%,16%,35%,27%,3%,2%",options="header",]
|===
|Capability | AS-IS State | TO-BE State | Gap Description | Priority | Effort
|POS Loyalty Credential | Basic barcode | Omni-channel xref:ROOT:ubiquitous_language.adoc#loyalty-credential[Loyalty Credential] | Improve credential format, support multi-partner | Low | Low
|Reward Preference Management | Flybuys Dependency |xref:bounded-contexts:profile.adoc[Profile Service] API | Extract from Salesforce, implement xref:bounded-contexts:profile.adoc[Profile Service] | High | Medium
|Anti-Corruption Layer | Direct coupling to external systems | ACL in xref:bounded-contexts:loyalty.adoc[Loyalty Service]/xref:bounded-contexts:profile.adoc[Profile Service] |Implement translation layers for xref:bounded-contexts:eagle_eye.adoc[EagleEye], xref:bounded-contexts:flybuys.adoc[Flybuys] | Low | High
|Transaction Adjudication | Batch processing (nightly) | Real-time synchronous adjudication | Implement real-time xref:bounded-contexts:eagle_eye.adoc[EagleEye] integration |Medium | High
|Partner Account Linking |  | Self-service OAuth in mobile app | Implement xref:bounded-contexts:profile.adoc[Profile Service], OAuth integration | High | Medium
|Real-Time Balance Display |  | Real-time query via xref:bounded-contexts:loyalty.adoc[Loyalty Service] | Build xref:bounded-contexts:loyalty.adoc[Loyalty Service] facade, cache strategy | High | High
|OAuth Token Management |  | Centralised OAuth Service | Build generic OAuth infrastructure service | Medium | Medium
|Event Publishing |  | Event Bus with domain events | Implement Event Bus, define event schemas | Medium | Medium
|===

===== Technology Transformation Requirements

[width="100%",cols="12%,14%,30%,20%,24%",options="header",]
|===
|Technology Domain | AS-IS Technology | TO-BE Technology | Transformation Needed | Dependency / Risk
|Backend Services | Monolithic xref:bounded-contexts:otr_app_api.adoc[OTR App API] |Microservices (xref:bounded-contexts:profile.adoc[Profile Service], xref:bounded-contexts:loyalty.adoc[Loyalty Service])
|Extract bounded contexts from monolith | High risk: database separation, data migration
|Integration Layer | Point-to-point REST calls | Event Bus + Anti-Corruption Layers | Implement Event Bus, ACL adapters | Medium risk: new infrastructure, event schemas
|Data Storage | Relational DB (shared) | NoSQL (LoyaltyService), Relational (ProfileService) | Database per bounded context pattern | High risk: data consistency, migration
|Partner Integration | Manual SFTP uploads | Automated batch + real-time APIs | Build automated workflows, API clients | Low risk: partner API availability
|Monitoring | Limited logging | Distributed tracing, metrics | Implement observability stack | Low risk: tooling selection
|===

== Technical Architecture

=== Technical Capability Requirements

[width="100%",cols="10$,29%,67%",options="header",]
|===
|ID | Capability | Description
|TC-001 | Event-Driven Integration | Asynchronous domain event publishing for engagement, recommendation, and analytics consumption
|TC-002 | Third-Party Account Linking | OAuth 2.0 authorisation flow with secure token management and consent handling
|TC-003 | xref:ROOT:ubiquitous_language.adoc#Reward%2520Preference[Reward Preference] Management | Customer choice enforcement across loyalty operations
|TC-004 | xref:ROOT:ubiquitous_language.adoc#Partner[Partner] Transaction Posting | Daily batch file generation and SFTP transmission to xref:bounded-contexts:flybuys.adoc[Flybuys] for points crediting
|TC-005 | xref:ROOT:ubiquitous_language.adoc#loyalty-credential[Loyalty Credential] Recognition | xref:bounded-contexts:otr_pos.adoc[OTR POS] and xref:bounded-contexts:otr_plus_pos.adoc[OTR+ POS] EAN-13 barcode scanning → xref:bounded-contexts:loyalty.adoc[Loyalty Service] API resolution → xref:bounded-contexts:salesforce_crm.adoc[Salesforce CRM] Customer identity (xref:ubiquitous_language.adoc#viva-consumer-id-vci%2520%28VCI[VCI]))
|TC-006 | xref:ROOT:ubiquitous_language.adoc#Partner[Partner] Balance Display | Real-time xref:bounded-contexts:flybuys.adoc[Flybuys] points balance queries in xref:bounded-contexts:mobile.adoc[Mobile Application] with caching and circuit breaker
|TC-007 | xref:ROOT:ubiquitous_language.adoc#Digital%2520Fuel%2520Dockets[Digital Fuel Dockets] Integration | xref:bounded-contexts:otr_pos.adoc[OTR POS] and xref:bounded-contexts:otr_plus_pos.adoc[OTR+ POS] redemption of xref:bounded-contexts:flybuys.adoc[Flybuys] xref:ROOT:ubiquitous_language.adoc#Digital%2520Fuel%2520Dockets[Digital Fuel Dockets]
|TC-008 | xref:ROOT:ubiquitous_language.adoc#Transaction%2520Adjudication[Transaction Adjudication] Logic | Orchestration of payment data, customer preferences, and partner eligibility rules for rewards
|TC-009 | xref:bounded-contexts:otr_pos.adoc[OTR POS] System Integration with xref:bounded-contexts:loyalty.adoc[Loyalty Service] | xref:ROOT:ubiquitous_language.adoc#Anti-Corruption%2520Layer%2520%28ACL[Bidirectional ACL]) preventing payment/commerce domain coupling
|TC-010 | xref:bounded-contexts:otr_plus_pos.adoc[OTR+ POS] System Integration with xref:bounded-contexts:loyalty.adoc[Loyalty Service] | xref:ROOT:ubiquitous_language.adoc#Anti-Corruption%2520Layer%2520%28ACL[Bidirectional ACL]) preventing payment/commerce domain coupling
|TC-011 | xref:bounded-contexts:mobile.adoc[Mobile Application] integration with xref:bounded-contexts:eagle_eye.adoc[EagleEye] | Facade service for xref:ROOT:ubiquitous_language.adoc#Customer[Customer] loyalty wallet data
|TC-012 | xref:bounded-contexts:mobile.adoc[Mobile Application] integration with xref:bounded-contexts:salesforce_crm.adoc[Salesforce CRM] | Facade service for xref:ROOT:ubiquitous_language.adoc#Customer[Customer] profile data access prior to #Highlander migration
|===

==== Requirements Traceability

[width="100%",cols="15%,11%,41%,33%",options="header",]
|===
|Business Requirement | Technical Capability | Implementation | Location

|TR-001, TR-002, TR-003 | TC-011 TC-012 | xref:bounded-contexts:profile.adoc[Profile Service] bounded context | xref:bounded-contexts:profile.adoc[Profile Service] & xref:bounded-contexts:loyalty.adoc[Loyalty Service]

|TR-004 | TC-002 | OAuth 2.0 Account Linking | xref:bounded-contexts:auth0.adoc[Auth0] via xref:bounded-contexts:flybuys.adoc[Flybuys]

|TR-005, TR-006 | TC-003 | Reward Preference Selection | xref:bounded-contexts:profile.adoc[Profile Service] via xref:bounded-contexts:mobile.adoc[Mobile Application]

|TR-007 | TC-004 | Transaction Posting to Flybuys | xref:bounded-contexts:loyalty.adoc[Loyalty Service] via xref:bounded-contexts:edp.adoc[EDP]

|TR-008, TR-009 | TC-005 | xref:bounded-contexts:otr_pos.adoc[OTR POS] and xref:bounded-contexts:otr_plus_pos.adoc[OTR+ POS] barcode Integration | xref:bounded-contexts:microsoft_dynamics_365_commerce.adoc[Microsoft Dynamics 365 Commerce]

|TR-010 | TC-006 | Flybuys Points Balance Query (Real-Time) | xref:bounded-contexts:loyalty.adoc[Loyalty Service] via xref:bounded-contexts:mobile.adoc[Mobile Application]

|TR-011 | TC-007 | Digital Fuel Dockets Query and Redemption | xref:bounded-contexts:microsoft_dynamics_365_commerce.adoc[Microsoft Dynamics 365 Commerce] & xref:bounded-contexts:loyalty.adoc[Loyalty Service]

|TR-012 | TC-008 | Two-Step Validation & Redemption | xref:bounded-contexts:eagle_eye.adoc[EagleEye] via xref:bounded-contexts:loyalty.adoc[Loyalty Service]

|All | TC-009 | xref:ROOT:ubiquitous_language.adoc#Anti-Corruption%2520Layer%2520%28ACL[Bidirectional ACL] | xref:bounded-contexts:microsoft_dynamics_365_commerce.adoc[Microsoft Dynamics 365 Commerce] & xref:bounded-contexts:loyalty.adoc[Loyalty Service]
|===

=== Service Catalogues

==== Application Portfolio Catalogue

[width="99%",cols="16%,27%,7%,7%,7%,29%,7%",options="header",]
|===
|Application | Type | Lifecycle Status | Lifecycle Stage | Owned By
|Business Capabilities Supported | Technology Stack
|xref:bounded-contexts:profile.adoc[Profile Service]
|xref:ubiquitous_language.adoc#Bounded%2520Context[Bounded Context]
|TO-BE | Planned | OTR Digital IT | Partner Account Linking, Reward
Preference Management | ==TBD==

|xref:bounded-contexts:loyalty.adoc[Loyalty Service]
|xref:ubiquitous_language.adoc#Bounded%2520Context[Bounded Context]
|TO-BE | Planned | OTR Digital IT | Transaction Adjudication, Transaction
Posting, Points Ledger | ==TBD==

|xref:bounded-contexts:location.adoc[Location Service]
|xref:ubiquitous_language.adoc#Bounded%2520Context[Bounded Context]
|TO-BE | Planned | OTR Digital IT | Store Finder, Proximity Features
|==TBD==

|xref:bounded-contexts:oauth.adoc[OAuth Service]
|Infrastructure Service | TO-BE | Planned | OTR Digital IT | OAuth Token
Management (Generic) | ==TBD==

|Event Bus | Integration Platform | TO-BE | Planned | OTR Digital IT | Event
Publishing, Event Consumption | ==TBD==

|xref:bounded-contexts:otr_app_api.adoc[OTR App API]
|Monolithic API | AS-IS | Active | OTR Digital IT | All capabilities
(legacy) | .NET

|xref:bounded-contexts:mobile.adoc[Mobile
Application] | Mobile Application | AS-IS | Active | OTR Digital IT
|Customer Engagement, Loyalty Features, Account Linking | Kotlin MP,
Swift

|xref:bounded-contexts:eagle_eye.adoc[EagleEye] | External SaaS
|AS-IS | Active | External Partner | Wallet, Points Ledger, Campaigns,
Promotions | SaaS (REST API)

|xref:bounded-contexts:braze.adoc[Braze] | External Marketing
|AS-IS | Active | External Partner | Customer Engagement, Push
Notifications, Campaigns | SaaS (API)

|xref:bounded-contexts:flybuys.adoc[Flybuys] | External Partner
System | AS-IS | Active | External Partner | Points Balance, Digital
Dockets, OAuth Linking | SaaS (REST API)

|xref:bounded-contexts:salesforce_crm.adoc[Salesforce CRM]
|External CRM | AS-IS | Active | Salesforce Team | Customer Profile System
of Record (VCI) | Salesforce Cloud

|xref:bounded-contexts:otr_pos.adoc[OTR POS] | Point of Sale
System | AS-IS | Active | OTR D365 | Transaction Processing, Loyalty
Credential Recognition |

|xref:bounded-contexts:otr_plus_pos.adoc[OTR+ POS] | Point of
Sale System | AS-IS | Active | OTR D365 | Transaction Processing, Flybuys
Barcode Scanning |

|xref:bounded-contexts:coupon_scanner.adoc[Coupon Scanner]
|Integration Service | AS-IS | Sunset (TBD) | VER Fullstack | Flybuys
Barcode Recognition, EagleEye Integration | REST API
|===

==== Technology Capability Requirements

This section defines the technical capabilities required to support the
Flybuys Integration architecture. Specific technology products
implementing these capabilities are documented in the
xref:solution-architectures:flybuys_integration.adoc#Technology%2520Portfolio%2520Catalogue[Technology
Portfolio Catalogue] (Solution Architecture).

[width="99%",cols="18%,8%,41%,17%,16%",options="header",]
|===
|Capability | Category | Required Features | Architectural Pattern
|Standards/Compliance
|Event Messaging | Integration | At-least-once delivery, dead letter
queue, CloudEvents 1.0 support | OHS + Published Language | CloudEvents
1.0

|Secure Credential Storage | Infrastructure | AES-256 encryption,
customer-managed keys, PCI compliance | OAuth 2.0, PKCE | PCI DSS Level 1

|Resilience Management | Resilience | Circuit breaker, retry with
exponential backoff, fallback | Circuit Breaker Pattern | -

|Feature Toggle Management | Deployment | Dynamic flag evaluation, gradual
rollout, instant rollback | Feature Toggle Pattern | -

|API Gateway | Infrastructure | OAuth validation, rate limiting,
request/response transformation | RESTful API | OpenAPI 3.0

|NoSQL Data Storage | Data Storage | Partition key performance, global
distribution, TTL support | Database per Service | -

|Encryption Key Management | Security | Hardware security module (HSM),
key rotation, audit logging | Customer-Managed Keys | AES-256, FIPS 140-2

|Distributed Caching | Caching | In-memory performance, TTL expiry,
eviction policies | In-Memory Cache, TTL Pattern | -

|Observability Platform | Observability | Distributed tracing, structured
logging, metrics, correlation IDs | OpenTelemetry | OpenTelemetry standard

|Customer Identity Platform | Authentication | OAuth 2.0, OIDC, social
login, MFA, CIAM features | OAuth 2.0, OIDC | OAuth 2.0, OIDC, ISO 27001

|Batch File Transfer | Integration | SFTP protocol, PGP encryption, file
integrity verification | SFTP Protocol | SFTP (SSH File Transfer)

|Batch Job Scheduling | Infrastructure | Cron-based scheduling, dependency
management, retry/alerting | Cron-based Scheduling | -
|===

*Implementation Note*: See
xref:solution-architectures:flybuys_integration.adoc#Technology%2520Portfolio%2520Catalogue[Technology
Portfolio Catalogue] for actual technology product selections.

==== Feature Flag Register

Comprehensive catalogue of all feature flags used across the Flybuys
Integration initiative. These flags enable progressive rollout and
provide rapid rollback capability without code deployment. *Operational
Deployment*: See
xref:solution-architectures:flybuys_integration.adoc#Transition%2520Phase%2520Matrix[Transition
Phase Matrix] in Solution Architecture for:

* Rollout schedule by architecture state (AS-0 → AS-4)
* Flag dependencies and enablement order
* Rollback procedures and monitoring thresholds

===== Infrastructure Flags

[width="100%",cols="22%,58%,7%,13%",options="header",]
|===
|Flag Name | Purpose | Default | Managed By
|`OTR.Loyalty.Enabled` | Master switch for all loyalty features (bounded
contexts) | Off | Platform Team
|===

===== Profile Service Flags

[width="99%",cols="37%,46%,6%,11%",options="header",]
|===
|Flag Name | Purpose | Default | Managed By
|`OTR.Loyalty.PartnerLink.Flybuys` | Enable Flybuys OAuth linking flow in
mobile app | Off | Product Owner

|`OTR.Loyalty.RewardPreferenceSelection` | Enable reward preference
selection UI in mobile app | Off | Product Owner
|===

===== Loyalty Service Flags

[width="100%",cols="35%,49%,5%,11%",options="header",]
|===
|Flag Name | Purpose | Default | Managed By
|`OTR.Loyalty.TransactionAdjudication` | Enable real-time Transaction
Adjudication via LoyaltyService | Off | Product Owner

|`OTR.Loyalty.PointsEarn.Flybuys` | Enable Flybuys points earning on
transactions | Off | Product Owner

|`OTR.Loyalty.FlybuysBatchPosting` | Enable daily batch file posting to
Flybuys (SFTP transmission) | Off | Operations Team
|===

*Note*: Feature flags are managed via
link:#Technology_Capability_Requirements[Feature Toggle
Management] capability. See
xref:solution-architectures:flybuys_integration.adoc#Technology%2520Portfolio%2520Catalogue[Technology
Portfolio Catalogue] for implementation.

==== Data Entity Catalogue

[width="100%",cols="27%,14%,5%,22%,3%,29%",options="header",]
|===
|Entity | Owned By | Aggregate Type | Identifier | Lifecycle | Relationships
|xref:ubiquitous_language.adoc#Partner%2520Link[PartnerLink]
|xref:bounded-contexts:profile.adoc[Profile Service] | Aggregate
Root | xref:ROOT:ubiquitous_language.adoc#viva-consumer-id-vci[VCI] +
PartnerType | Persistent | References OAuth tokens (OAuth Service)

|xref:ubiquitous_language.adoc#Reward%2520Transaction[Reward
Transaction] | xref:bounded-contexts:loyalty.adoc[Loyalty Service]
|Aggregate Root | `TransactionId` | 30-day TTL | References
xref:ubiquitous_language.adoc#Partner%2520Link[PartnerLink] (via VCI)

|Store | xref:bounded-contexts:location.adoc[Location Service]
|Aggregate Root | `StoreId` | Persistent | None

|Customer | xref:bounded-contexts:profile.adoc[Profile Service]
|Conceptual
|xref:ubiquitous_language.adoc#viva-consumer-id-vci[VCI]
|Persistent | Has
xref:ubiquitous_language.adoc#Partner%2520Link[PartnerLinks]

|OAuthToken | xref:bounded-contexts:oauth.adoc[OAuth
Service] | Value Object | `TokenId` | 14-day max | Referenced by
xref:ubiquitous_language.adoc#Partner%2520Link[PartnerLink]

|FuelDocket | xref:bounded-contexts:flybuys.adoc[Flybuys]
|External | `DocketId` | External | Queried by
xref:bounded-contexts:loyalty.adoc[Loyalty Service]

|Wallet | xref:bounded-contexts:eagle_eye.adoc[EagleEye]
|External | `WalletId` | External | Queried by
xref:bounded-contexts:loyalty.adoc[Loyalty Service]

|Membership | xref:bounded-contexts:eagle_eye.adoc[EagleEye]
|External | `MembershipId` | External | Queried by
xref:bounded-contexts:loyalty.adoc[Loyalty Service]

|Campaign | xref:bounded-contexts:eagle_eye.adoc[EagleEye]
|External | `CampaignId` | External | Referenced by
xref:ubiquitous_language.adoc#Reward%2520Transaction[Reward
Transaction]

|Transaction
|xref:bounded-contexts:microsoft_dynamics_365_commerce.adoc[Microsoft
Dynamics 365 Commerce] | External | `TransactionId` | External | Queried by
xref:bounded-contexts:loyalty.adoc[Loyalty Service] (batch
aggregation)

|CustomerProfile
|xref:bounded-contexts:salesforce_crm.adoc[Salesforce CRM] &
xref:bounded-contexts:otr_app_api.adoc[OTR App API]
|External | xref:ROOT:ubiquitous_language.adoc#viva-consumer-id-vci[VCI]
|External | Synchronised to
xref:bounded-contexts:profile.adoc[Profile Service]
|===

=== Baseline Architecture

==== Existing System Components

===== xref:bounded-contexts:otr_pos.adoc[OTR POS]

====== Platform

On-premises SQL Server, POS integration at OTR Stores

===== xref:bounded-contexts:otr_plus_pos.adoc[OTR+ POS]

====== Platform

On-premises SQL Server, POS integration at REXP Stores and future OTR
conversions

====== Capabilities

* Flybuys barcode scanning (offline mode)
* Basic transaction logging

====== Limitations

* Customer transactions not linked to
xref:ubiquitous_language.adoc#loyalty-credential[Loyalty
Credentials] (barcode-only recognition)
* No integration with
xref:bounded-contexts:mobile.adoc[Mobile
Application]
* Manual reconciliation with Flybuys batch files
* No support for
xref:ubiquitous_language.adoc#Partner%2520Integration[Partner
Integration] or real-time balance queries
* No event-driven capabilities
* Highly coupled to xref:bounded-contexts:flybuys.adoc[Flybuys]

===== OTR App API

====== Platform

AWS Lambda (.NET Core), API Gateway, DynamoDB

====== Capabilities

* Customer authentication
* Loyalty balance queries
* Offer redemption

====== Limitations

* No external partner linking capability
* Tightly coupled to Microsoft Dynamics 365 Commerce
* Customer profile data only in OTR App database
* No event-driven architecture (synchronous REST calls only)
* No transaction adjudication logic (loyalty queries separate from
payment processing)
* No support for Flybuys integration patterns (OAuth, batch file
posting)
* Limited scalability (single Lambda function for all API operations)
* High technical debt (no bounded contexts, mixed domain logic)
* Difficult to maintain and extend (monolithic codebase)
* No support for digital voucher integration
* Limited monitoring and alerting capabilities
* No formalised Ubiquitous Language (UL) leading to inconsistent
terminology

===== xref:bounded-contexts:salesforce_crm.adoc[Salesforce CRM]

====== Platform

Salesforce Sales Cloud

====== Capabilities

* Customer profile system of record
(xref:ubiquitous_language.adoc#viva-consumer-id-vci[VCI])

===== xref:bounded-contexts:eagle_eye.adoc[EagleEye]

====== Platform

External SaaS (REST APIs, Webhooks)

====== Capabilities

* Wallet management (grants, offers)
* Points ledger
* Membership/tiers
* Campaigns

===== xref:bounded-contexts:coupon_scanner.adoc[Coupon Scanner]

===== Platform

VER API

===== Capabilities

* Recognition of
xref:ubiquitous_language.adoc#Flybuys%2520Cardholder%2520Number[Flybuys
Cardholder Number]
* Recognition of
xref:ubiquitous_language.adoc#%28Paper%20Shopper%20Docket[Shopper
Docket]

==== Integration Architecture

[width="100%",cols="15%,19%,26%,40%",options="header",]
|===
|Integration | To | Pattern | Description
|xref:bounded-contexts:mobile.adoc[Mobile
Application] | xref:bounded-contexts:otr_pos.adoc[OTR POS]
|Synchronous REST | Direct API calls for ordering, loyalty balance, offer
redemption

|xref:bounded-contexts:mobile.adoc[Mobile
Application]
|xref:bounded-contexts:microsoft_entra_external_id.adoc[Microsoft
Entra External ID] | OAuth 2.0 Authorization Code Flow with PKCE |

|xref:bounded-contexts:otr_plus_pos.adoc[OTR+ POS]
|xref:bounded-contexts:coupon_scanner.adoc[Coupon Scanner]
|Synchronous REST | Barcode scanning for static Flybuys card
identification

|xref:bounded-contexts:coupon_scanner.adoc[Coupon Scanner]
|xref:bounded-contexts:eagle_eye.adoc[EagleEye] | Synchronous
REST | Direct API calls for wallet

|xref:bounded-contexts:coupon_scanner.adoc[Coupon Scanner]
|xref:bounded-contexts:salesforce_crm.adoc[Salesforce CRM]
|Synchronous REST | Read-only queries for customer profile data
|===

==== Technical Debt

[width="100%",cols="37%,63%",options="header",]
|===
|Debt | Description
|No Anti-Corruption Layer for EagleEye
|xref:bounded-contexts:coupon_scanner.adoc[Coupon Scanner] is
tightly coupled to
xref:bounded-contexts:eagle_eye.adoc[EagleEye] API contracts

|xref:bounded-contexts:coupon_scanner.adoc[Coupon Scanner]
serves a single purpose
|xref:bounded-contexts:coupon_scanner.adoc[Coupon Scanner]
was delivered fit-for-purpose to scan static Flybuys cards to redeem
linked discounts

|Customer Profile Data Silos | Customer data stored in multiple places
(xref:bounded-contexts:otr_app_api.adoc[OTR App API],
xref:bounded-contexts:salesforce_crm.adoc[Salesforce CRM],
xref:bounded-contexts:braze.adoc[Braze])

|Tightly Coupled
xref:bounded-contexts:coupon_scanner.adoc[Coupon Scanner] &
xref:bounded-contexts:otr_plus_pos.adoc[OTR+ POS] Integration
|Direct POS-to-loyalty coupling; payment domain logic leaks into loyalty
queries

|No Event-Driven Architecture | All integrations are synchronous REST; no
event bus for domain events
|===

=== Gap Analysis

==== Missing Capabilities

[width="100%",cols="15%,29%,56%",options="header",]
|===
|Capability | Current State | Gap Description
|Canonical OTRG Customer Identifier
|xref:ubiquitous_language.adoc#Customer%2520ID[Customer ID] at
xref:bounded-contexts:otr_pos.adoc[OTR POS] &
xref:bounded-contexts:mobile.adoc[Mobile
Application] Flybuys Account at
xref:bounded-contexts:otr_plus_pos.adoc[OTR+ POS] | There is
no brand-agnostic group-wide canonical customer identifier. Implement
xref:ubiquitous_language.adoc#viva-consumer-id-vci[VCI] for all
xref:bounded-contexts:loyalty.adoc[Loyalty Service] (and
xref:bounded-contexts:engagement.adoc[Engagement Service])
transactions

|Event-Driven Integration | None | No event bus; changes require
synchronous API polling; no published language for domain events

|Integration of xref:bounded-contexts:otr_plus_pos.adoc[OTR+
POS] and xref:bounded-contexts:salesforce_crm.adoc[Salesforce
CRM] | None | Only xref:bounded-contexts:otr_plus_pos.adoc[OTR+
POS] connects to
xref:bounded-contexts:salesforce_crm.adoc[Salesforce CRM]
(via xref:bounded-contexts:coupon_scanner.adoc[Coupon
Scanner])

|Integration xref:bounded-contexts:otr_plus_pos.adoc[OTR+
POS] and xref:bounded-contexts:eagle_eye.adoc[EagleEye] | None
|Only xref:bounded-contexts:otr_plus_pos.adoc[OTR+ POS]
connects to xref:bounded-contexts:eagle_eye.adoc[EagleEye] (via
xref:bounded-contexts:coupon_scanner.adoc[Coupon Scanner]))

|Recognition of OTR App credentials at
xref:bounded-contexts:otr_plus_pos.adoc[OTR+ POS] | None | Only
xref:bounded-contexts:otr_pos.adoc[OTR POS] has barcode
recognition for legacy OTR App Loyalty

|Recognition of xref:bounded-contexts:flybuys.adoc[Flybuys]
credentials at xref:bounded-contexts:otr_pos.adoc[OTR POS]
|None | Only xref:bounded-contexts:otr_plus_pos.adoc[OTR+ POS]
recognises Flybuys barcodes

|Third-Party Account Linking | None | No OAuth infrastructure for partner
linking; xref:ROOT:ubiquitous_language.adoc#Customer[Customer]s cannot
connect coalition loyalty accounts

|Reward Preference Management | None
|xref:ubiquitous_language.adoc#Customer[Customers] with Flybuys
credentials have no
xref:ubiquitous_language.adoc#Reward%2520Preference[Reward Preference]
within xref:bounded-contexts:otr_pos.adoc[OTR POS] scope
and are dependent on
xref:bounded-contexts:flybuys.adoc[Flybuys] to change
preferences at xref:bounded-contexts:otr_plus_pos.adoc[OTR+
POS]

|Partner Transaction Posting | Partial
(xref:bounded-contexts:otr_plus_pos.adoc[OTR+ POS] manual
batch only) | xref:bounded-contexts:otr_plus_pos.adoc[OTR+
POS] has manual Flybuys batch files, and no
xref:bounded-contexts:flybuys.adoc[Flybuys]×xref:bounded-contexts:otr_pos.adoc[OTR
POS] integration or automated posting.
xref:bounded-contexts:flybuys.adoc[Flybuys] are changing their
data ingestion protocol.

|Partner Balance Display | None | No real-time partner API integration;
xref:ubiquitous_language.adoc#Customer[Customers] cannot view Flybuys
points in
xref:bounded-contexts:mobile.adoc[Mobile
Application]

|Digital Fuel Dockets Integration | None
|xref:bounded-contexts:flybuys.adoc[Flybuys]-issued dockets can
only be applied at
xref:bounded-contexts:otr_plus_pos.adoc[OTR+ POS], not at
xref:bounded-contexts:otr_pos.adoc[OTR POS]

|Transaction Adjudication Logic | Partial
(xref:bounded-contexts:otr_plus_pos.adoc[OTR+ POS] only)
|xref:bounded-contexts:eagle_eye.adoc[EagleEye] handles basic
adjudication; no payment method awareness or partner exclusion rules

|xref:bounded-contexts:otr_plus_pos.adoc[OTR+ POS] &
xref:bounded-contexts:coupon_scanner.adoc[Coupon Scanner]
Integration | Tightly coupled | Direct POS-to-loyalty coupling; payment
domain logic leaks into loyalty queries

|Integration between xref:bounded-contexts:otr_pos.adoc[OTR
POS] and xref:bounded-contexts:coupon_scanner.adoc[Coupon
Scanner] | None | There is no integration between
xref:bounded-contexts:otr_pos.adoc[OTR POS] and
xref:bounded-contexts:coupon_scanner.adoc[Coupon Scanner]

|Integration between
xref:bounded-contexts:otr_plus_pos.adoc[OTR+ POS] and
xref:bounded-contexts:mobile.adoc[Mobile
Application] | None | There is no integration between
xref:bounded-contexts:otr_plus_pos.adoc[OTR+ POS] and
xref:bounded-contexts:mobile.adoc[Mobile
Application]
|===

==== Missing Bounded Contexts

[width="100%",cols="21%,79%",options="header",]
|===
|Service | Description
|xref:bounded-contexts:profile.adoc[Profile Service] | Customer
profile management with partner account linking aggregate

|xref:bounded-contexts:loyalty.adoc[Loyalty Service] | Transaction
Adjudication orchestration and partner integration facade

|xref:bounded-contexts:location.adoc[Location Service] | Store
location data for proximity features and store-specific offer targeting
|===

==== Missing Integration Patterns

[width="100%",cols="23%,77%",options="header",]
|===
|Pattern | Description
|OAuth 2.0 Infrastructure | Secure token management, consent flow,
refresh token rotation

|Event Bus | Asynchronous domain event publishing and subscription

|Anti-Corruption Layer | Translation between external systems
(xref:bounded-contexts:eagle_eye.adoc[EagleEye],
xref:bounded-contexts:flybuys.adoc[Flybuys]) and OTR domain
model
|===

=== Target State Architecture

[width="100%",cols="23%,77%",options="header",]
|===
|Principle | Description
|Single Source of Truth | Each domain concept has one system of record
(prevents data conflicts)

|Clear Bounded Context Boundaries
|xref:bounded-contexts:profile.adoc[Profile Service] manages
identity/linking; xref:bounded-contexts:loyalty.adoc[Loyalty
Service] orchestrates loyalty operations

|Separation of Infrastructure from Domain | OAuth tokens isolated in
infrastructure service (PCI compliance, token refresh independence)

|Event-Driven Loose Coupling | Services communicate via domain events
(xref:bounded-contexts:profile.adoc[Profile Service] doesn’t call
xref:bounded-contexts:loyalty.adoc[Loyalty Service] directly)

|Conformist Integration
|xref:bounded-contexts:loyalty.adoc[Loyalty Service] orchestrates
Flybuys API calls but doesn’t own
xref:bounded-contexts:flybuys.adoc[Flybuys] data (respects
external system boundaries)

|Canonical Customer Profile | A single, definitive profile for a
xref:ubiquitous_language.adoc#Customer[Customer] across all Bounded
Contexts and integrated external systems
|===

==== Architectural Building Blocks (ABB)

[width="100%",cols="10%,68%,22%",options="header",]
|===
|ABB ID | ABB Name | Kind
|ABB-001 | link:#abb-001-profile-service[Profile Service] | Microservice

|ABB-002 | link:#abb-002-loyalty-service[Loyalty Service] | Microservice

|ABB-003 | link:#abb-003-location-service[Location Service] | Microservice

|ABB-004 | link:#abb-004-engagement-service[Engagement Service]
|Microservice

|ABB-005 | link:#abb-005-event-bus[Event Bus] | Infrastructure

|ABB-006 | link:#abb-006-oauth-service[OAuth Service] | Microservice

|ABB-007 | link:#abb-007-api-gateway[API Gateway] | Infrastructure

|ABB-008 | link:#abb-008-application-config[App Config / Feature Flags]
|Infrastructure

|ABB-009 | link:#abb-009-application-monitoring[Application Monitoring]
|Infrastructure

|ABB-010 | link:#abb-010-mobile-application[Mobile Application] | End User
Client

|ABB-011 | link:#abb-011-caching[Caching] | Infrastructure

|ABB-012 | link:#abb-012-braze-acl[Braze ACL] | Integration

|ABB-013 | link:#abb-013-flybuys-acl[Flybuys ACL] | Integration

|ABB-014 | link:#abb-014-eagleeye-acl[EagleEye ACL] | Integration

|ABB-015 | link:#abb-015-points-file-management[Points File Management]
|Application Service
|===

===== xref:bounded-contexts:profile.adoc[ABB-001 Profile Service]

====== Responsibility

xref:ubiquitous_language.adoc#Customer[Customer] profile management,
partner account linking, reward preference coordination

[width="100%",cols="12%,88%",options="header",]
|===
|Relationship | Responsibility
|Owns | `PartnerLink` aggregate (partner linking state, reward
preference, external member ID)

|Owns | Partner lifecycle operations (initiate linking, complete linking,
unlink, sync status tracking)

|Owns | Reward preference validation and updates (ensures FLYBUYS_POINTS
requires linked account)

|Does NOT Own | OAuth tokens (managed by OAuth Service infrastructure),
transaction history (xref:bounded-contexts:loyalty.adoc[Loyalty
Service])
|===

====== Aggregates

[width="100%",cols="11%,33%,10%,46%",options="header",]
|===
|Aggregate Name | Description | Identifier | Properties
|`PartnerLink` | Represents a linked third-party partner account
|`PartnerLinkId` | `Partner`, `ExternalMemberId`, `LinkingStatus`,
`RewardPreference`
|===

====== Invariants

* Customer can only have one active link per partner type
* Reward preference `FLYBUYS_POINTS` requires linked Flybuys account

====== Domain Events Published by Profile Service

[width="100%",cols="35%,65%",options="header",]
|===
|Event Name | Description
|`PartnerLinked` | Customer successfully linked a partner account

|`PartnerUnlinked` | Customer unlinked a partner account

|`PartnerLinkFailed` | Partner linking attempt failed (error details)

|`RewardPreferenceChanged` | Customer changed reward preference
(Flybuys/OTR)
|===

====== Domain Events Consumed by Profile Service

[width="100%",cols="22%,22%,56%",options="header",]
|===
|Event Name | Published By | Purpose
|`CustomerEnrolled` | xref:bounded-contexts:loyalty.adoc[Loyalty
Service] | Track which customers have active loyalty wallets
|===

====== Domain Services

[width="100%",cols="31%,69%",options="header",]
|===
|Service Name | Responsibility
|`IPartnerLinkingService` | OAuth authorisation flow orchestration, token
exchange

|`IRewardPreferenceService` | Validate preference changes against partner
linking status
|===

====== Feature Flags

See link:#Feature_Flag_Register[Feature Flag Register §3.2.3]
for complete catalogue.

[cols=",",options="header",]
|===
|Flag Name | Phase Introduced
|`OTR.Loyalty.PartnerLink.Flybuys` | AS-2 Linking
|`OTR.Loyalty.RewardPreferenceSelection` | AS-2 Linking
|===

====== External Dependencies

[width="100%",cols="14%,24%,5%,5%,52%",options="header",]
|===
|Dependency Name | Integration Pattern | Direction | Type | Purpose
|xref:bounded-contexts:oauth.adoc[OAuth Service]
|Infrastructure | Upstream | OAuth API | Partner account linking
(xref:bounded-contexts:flybuys.adoc[Flybuys] OAuth endpoints)

|xref:bounded-contexts:salesforce_crm.adoc[Salesforce CRM]
|Customer-Supplier / Conformist | Upstream | REST API | Customer profile
system of record
(xref:ubiquitous_language.adoc#viva-consumer-id-vci[VCI])

|Event Bus | Open Host Service + Published Language | Internal | Event Bus
|Publish partner linking and reward preference events
|===

===== xref:bounded-contexts:loyalty.adoc[ABB-002 Loyalty Service]

====== Responsibility

Loyalty transaction orchestration, partner integration facade,
Transaction Adjudication audit trail, *Loyalty Credential resolution*.

[width="100%",cols="7%,93%",options="header",]
|===
|Relationship | Responsibility
|Owns | `RewardTransaction` aggregate (Transaction Adjudication audit
trail with 30-day TTL)

|Owns | Transaction Posting logic (daily batch file generation, CSV
formatting, SFTP transmission to Flybuys)

|Owns | Partner Transaction Reconciliation
(xref:bounded-contexts:flybuys.adoc[Flybuys] acknowledgement
file processing, retry logic)

|Owns | *Loyalty Credential Resolution* (EAN-13 barcode → VCI resolution
for POS integration)

|Orchestrates | Partner API integration
(xref:bounded-contexts:flybuys.adoc[Flybuys] balance queries,
digital docket queries, OAuth flow initiation)

|Orchestrates | Transaction Adjudication (queries
xref:bounded-contexts:profile.adoc[Profile Service] for Reward
Preference, queries EagleEye for campaigns)

|Does NOT Own | Reward Preference
(xref:bounded-contexts:profile.adoc[Profile Service]), Partner
linking status (xref:bounded-contexts:profile.adoc[Profile
Service]), OAuth tokens
(xref:bounded-contexts:oauth.adoc[OAuth Service]),
transactions
(xref:bounded-contexts:microsoft_dynamics_365_commerce.adoc[Microsoft
Dynamics 365 Commerce])
|===

====== POS Integration Pattern: Bidirectional Anti-Corruption Layer

LoyaltyService uses a *Bidirectional ACL* to integrate with
xref:bounded-contexts:microsoft_dynamics_365_commerce.adoc[Microsoft
Dynamics 365 Commerce] POS systems
(xref:bounded-contexts:otr_pos.adoc[OTR POS],
xref:bounded-contexts:otr_plus_pos.adoc[OTR+ POS]) to prevent
tight coupling between Payment/Commerce and Loyalty domains (TC-009,
TC-010).

*Why Bidirectional*:

* *POS → LoyaltyService* (upstream): Translates D365 Commerce
transaction model to Loyalty domain model
* *LoyaltyService → POS* (downstream): Translates Loyalty domain
responses to POS-compatible format

*Domain Translations (POS → LoyaltyService)*:

[width="100%",cols="24%,29%,47%",options="header",]
|===
|D365 Commerce Concept | Loyalty Domain Concept | Translation Logic
|`SalesTransaction` | Basket (for adjudication) | Extract line items,
total amount, store ID

|`LoyaltyCardNumber` | Loyalty Credential barcode | EAN-13 barcode
resolution

|`CustomerId` | VCI (Viva Consumer ID) | ProfileService lookup

|`TenderLine` | Payment method | Map payment type codes to enum
|===

*Domain Translations (LoyaltyService → POS)*:

[width="100%",cols="25%,23%,52%",options="header",]
|===
|Loyalty Domain Concept | D365 Commerce Concept | Translation Logic
|`PointsEarned` | `LoyaltyRewardPoints` | Convert domain event to D365
loyalty transaction

|`GrantRedeemed` | `DiscountLine` | Create discount line item with grant
amount

|`AdjudicationResult` | `LoyaltyResponse` | Map grants to D365 loyalty
reward structure
|===

*Protection Against Coupling*:

* POS changes (e.g., new payment types) don’t affect Loyalty domain
model
* Loyalty domain evolution (e.g., new reward types) doesn’t require POS
changes
* ACL adapter isolates D365 Commerce terminology from Loyalty bounded
context
* Prevents leakage of transaction/payment concerns into loyalty logic

====== Loyalty Credential Resolution Specification

*Barcode Format*: EAN-13 (European Article Number, 13-digit standard
retail barcode) *Supported Credentials* (as defined in
xref:ubiquitous_language.adoc#loyalty-credential[Loyalty
Credential]):

[arabic]
. OTR Mobile Application barcode
. SPS Mobile Application barcode
. OTR Loyalty Pass (Apple Wallet / Google Wallet)
. Physical Flybuys Card (must be pre-linked to OTR profile via OAuth)
. Flybuys Mobile Application barcode (must be pre-linked to OTR profile
via OAuth)

*POS Integration Flow*:

[source,mermaid]
----
sequenceDiagram
    actor Customer
    participant POS as POS (OTR/OTR+)
    participant Loyalty as LoyaltyService
    participant Profile as ProfileService
    participant ProfileDB as Profile DB

    Customer->>POS: Present Loyalty Credential
    POS->>POS: Scan EAN-13 barcode (13 digits)

    Note over POS,ProfileDB: Credential Resolution

    POS->>Loyalty: POST /api/v1/loyalty/credentials/resolve<br/>{barcode: "1234567890123", storeId: "OTR001", transactionId: "TXN_20251211_001234"}

    alt OTR Credentials (1-3): Direct VCI Resolution
        Loyalty->>Loyalty: Extract OTR member ID from barcode
        Loyalty->>Profile: GET /api/v1/profile/customers?memberId={otrMemberId}
        Profile->>ProfileDB: Query by memberId
        ProfileDB-->>Profile: Customer record (VCI, rewardPreference)
        Profile-->>Loyalty: Customer context
    else Flybuys Credentials (4-5): Indirect via PartnerLink
        Loyalty->>Loyalty: Extract Flybuys 12-digit member number from barcode
        Loyalty->>Profile: GET /api/v1/profile/partner-links?<br/>partner=FLYBUYS&externalMemberId={flybuysNumber}
        Profile->>ProfileDB: Query PartnerLink aggregate
        ProfileDB-->>Profile: PartnerLink (VCI, rewardPreference)
        Profile-->>Loyalty: Customer context (VCI from PartnerLink)
    end

    Loyalty->>Profile: GET /api/v1/profile/customers/{vci}
    Profile->>ProfileDB: Query customer by VCI
    ProfileDB-->>Profile: Customer profile
    Profile-->>Loyalty: Customer details

    Loyalty-->>POS: 200 OK<br/>{vivaConsumerId: "vci_xyz789abc",<br/>rewardPreference: "FLYBUYS_POINTS",<br/>walletId: "wallet_123456",<br/>linkedPartners: ["FLYBUYS"]}

    POS->>Customer: Display customer name and eligibility
----

====== Resolution Logic

[width="100%",cols="53%,16%,31%",options="header",]
|===
|Credential Type | Barcode Encodes | Resolution Method
|xref:bounded-contexts:mobile.adoc[OTR Mobile /
SPS Mobile] | OTR member ID | Direct lookup (member ID → VCI)

|Apple/Google Wallet Pass | OTR member ID | Direct lookup (member ID →
VCI)

|xref:ubiquitous_language.adoc#Flybuys%2520Cardholder%2520Number[Physical
Flybuys Card] | Flybuys 12-digit number | PartnerLink lookup
(externalMemberId → VCI)

|xref:ubiquitous_language.adoc#Flybuys%2520Digital%2520Identity[Flybuys
Mobile barcode] | Flybuys 12-digit number | PartnerLink lookup
(externalMemberId → VCI)
|===

====== Constraints

* Pre-printed Flybuys cards (not linked to OTR profile) are *NOT*
supported at POS
* Customers must link Flybuys account via mobile app OAuth flow (AS-2
Linking phase) before scanning Flybuys credentials at POS
* LoyaltyService API must resolve barcode within *< 500ms p95* (NFR-002)
to avoid POS checkout delays

====== Aggregates

[width="100%",cols="29%,25%,6%,40%",options="header",]
|===
|Aggregate Name | Description | Identifier | Properties
|xref:ubiquitous_language.adoc#Reward%2520Transaction[Reward
Transaction] | Represents a customer transaction for reward adjudication
|`TransactionId` | `TransactionDate`, `StoreId`, `TotalAmount`,
`RewardType`, `PointsEarned`, `DiscountApplied`
|===

====== Invariants

* Transaction Adjudication results are immutable audit trail
* Points earned must match EagleEye calculation for given transaction

====== Domain Events

[width="100%",cols="29%,71%",options="header",]
|===
|Event Name | Description
|`CustomerEnrolled` | Customer enrolled in loyalty program (EagleEye
wallet created)

|`TransactionAdjudicated` | Transaction has been adjudicated and rewards
calculated

|`PointsEarned` | Customer earned Flybuys points on a transaction

|`FuelDiscountApplied` | Customer received OTR fuel discount on a
transaction

|`RewardTransactionFailed` | Transaction Adjudication failed
|===

====== Domain Services

[width="100%",cols="28%,72%",options="header",]
|===
|Service Name | Responsibility
|`ITransactionAdjudicationService` | Orchestrates Transaction
Adjudication (queries EagleEye, Profile, POS data)

|`IPartnerPointsService` | Generic interface for Partner Points Posting
(Flybuys implementation, future Shell Card)

|`IBatchFileGeneratorService` | Daily aggregation of Partner Transactions
for SFTP transmission
|===

====== Feature Flags

See link:#Feature_Flag_Register[Feature Flag Register §3.2.3]
for complete catalogue.

[cols=",",options="header",]
|===
|Flag Name | Phase Introduced
|`OTR.Loyalty.TransactionAdjudication` | AS-3 Grants
|`OTR.Loyalty.PointsEarn.Flybuys` | AS-3 Grants
|`OTR.Loyalty.FlybuysBatchPosting` | AS-3 Grants
|===

====== Dependencies

[width="100%",cols="20%,37%,5%,11%,27%",options="header",]
|===
|Dependency Name | Integration Pattern | Direction | Type | Purpose
|xref:bounded-contexts:profile.adoc[Profile Service] | Open Host
Service + Published Language | Downstream | Event Bus | Consume partner
linking and reward preference events

|xref:bounded-contexts:eagle_eye.adoc[EagleEye] | ACL | Upstream
|REST API | Wallet, points ledger, memberships, campaigns

|xref:bounded-contexts:flybuys.adoc[Flybuys] | Customer-Supplier
/ Conformist | Upstream | OAuth API, Batch File | Points balance API, batch
file ingestion

|xref:bounded-contexts:microsoft_dynamics_365_commerce.adoc[Microsoft
Dynamics 365 Commerce]
|xref:ubiquitous_language.adoc#Anti-Corruption%2520Layer%2520%28ACL[Bidirectional
ACL]) | POS | REST API | Transaction data

|xref:bounded-contexts:profile.adoc[Profile Service] | Open Host
Service | Internal | Event Bus | Customer reward preferences, partner
linking status
|===

===== xref:bounded-contexts:location.adoc[ABB-003 Location Service]

====== Responsibility

Store location data, proximity features, service area management.

[width="100%",cols="10%,90%",options="header",]
|===
|Relationship | Responsibility
|Owns | `Store` aggregate (store location, brand, capabilities, operating
hours)

|Does NOT Own | Product catalogue
(xref:bounded-contexts:microsoft_dynamics_365_commerce.adoc[Microsoft
Dynamics 365 Commerce]), store inventory
(xref:bounded-contexts:microsoft_dynamics_365_commerce.adoc[Microsoft
Dynamics 365 Commerce])
|===

====== Core Aggregates

[width="100%",cols="11%,25%,7%,57%",options="header",]
|===
|Aggregate Name | Description | Identifier | Properties
|`Store` | Represents a retail store location | `StoreId` | `StoreName`,
`Brand`, `Address`, `GeoLocation`, `ServiceArea`, `Capabilities`
|===

====== Dependencies

[width="100%",cols="38%,18%,8%,7%,29%",options="header",]
|===
|Dependency Name | Integration Pattern | Direction | Type | Purpose
|xref:bounded-contexts:microsoft_dynamics_365_commerce.adoc[Microsoft
Dynamics 365 Commerce] | Customer-Supplier | Upstream | REST API | Store
catalogue, location data
|===

===== xref:bounded-contexts:engagement.adoc[ABB-004 Engagement Service]

===== ABB-005 Event Bus

===== xref:bounded-contexts:oauth.adoc[ABB-006 OAuth Service]

===== ABB-007 API Gateway

===== ABB-008 Application Config

===== ABB-009 Application Monitoring

===== xref:bounded-contexts:mobile.adoc[ABB-010 Mobile Application]

===== ABB-011 Caching

===== ABB-012 Braze ACL

===== ABB-013 Flybuys ACL

===== ABB-014 EagleEye ACL

===== ABB-015 Points File Management

==== Integration Architecture

===== System of Record Boundaries

[width="100%",cols="21%,9%,70%",options="header",]
|===
|System Name | Type | System of Record For
|xref:bounded-contexts:oauth.adoc[OAuth Service]
|Infrastructure | OAuth access tokens, refresh tokens, token expiry
management, token rotation

|xref:bounded-contexts:flybuys.adoc[Flybuys] | External System
|Points ledger (source of truth for member balances), member profile,
digital docket inventory, docket redemption status

|xref:bounded-contexts:microsoft_dynamics_365_commerce.adoc[Microsoft
Dynamics 365 Commerce] | External System | Transactions, line items,
payment details, payment method types, transaction receipts

|xref:bounded-contexts:salesforce_crm.adoc[Salesforce CRM]
|CRM | Customer canonical profile (name, email, phone,
xref:ubiquitous_language.adoc#viva-consumer-id-vci[VCI] as primary
key)

|xref:bounded-contexts:eagle_eye.adoc[EagleEye] | Loyalty
Platform | Wallet (grants, offers), membership tiers,
campaigns/promotions, base points calculation rules
|===

===== Customer-Supplier with Conformist (Flybuys)

====== Context Relationship

`LoyaltyService [CONFORMIST] ← [SUPPLIER] Flybuys`

====== Rationale

* Flybuys is external system with established API contracts (OAuth 2.0,
batch file specification)
* OTR has no influence over Flybuys API design
* Time-bound partnership (2-3 years) makes ACL investment unjustified
* Conforming to Flybuys specification simplifies integration

====== Technology Stack

* OAuth 2.0: Authorisation Code Flow with
xref:ubiquitous_language.adoc#PKCE[PKCE]
* Batch File: Daily SFTP transmission (CSV format prescribed by Flybuys)
* Real-Time API: REST queries for points balance (5-minute cache)

====== Implementation Strategy

* Generic `IPartnerPointsService` interface in
xref:bounded-contexts:loyalty.adoc[Loyalty Service] domain
* `FlybuysPointsServiceAdapter` implementation in infrastructure layer
* Future partners (Shell Card) implement same interface

====== Key Events

[width="99%",cols="41%,25%,34%",options="header",]
|===
|Event Name | Published By | Consumed By
|`TransactionAdjudicated` | `LoyaltyService` | `EngagementService`
|`PointsEarned` | `LoyaltyService` | `EngagementService`
|`RewardTransactionFailed` | `LoyaltyService` | N/A (audit trail only)
|===

====== Security Considerations

* OAuth tokens stored in separate
xref:bounded-contexts:oauth.adoc[OAuth Service]
(not link:#PartnerLinked[PartnerLinked] aggregate)
* SFTP transmission via xref:bounded-contexts:azure_data_factory.adoc[ADF]
* Customer consent required before first points posting (Australian
Privacy Principles)

===== Event-Driven with Published Language (Internal Services)

====== Pattern

`[Profile Service](../bounded_context/profile.adoc) [OHS+PL] → [EVENT BUS] → [CONSUMER] LoyaltyService, EngagementService, RecommendationService`

====== Rationale

* Asynchronous integration reduces coupling between bounded contexts
* Published Language (consistent event schema) enables future consumers
without xref:bounded-contexts:profile.adoc[Profile Service]
changes
* Event Bus provides guaranteed delivery (at-least-once semantics)

====== Technology Stack

* Event Bus: AWS EventBridge or Azure Event Grid (TBD based on platform
strategy)
* Event Schema: JSON with versioning (`eventVersion: "1.0"`)
* Event Store: Kinesis Data Streams for event replay capability

====== Published Language

Complete event specifications available in AsyncAPI:
`/specifications/AsyncAPI/otr-event-bus-v1.yaml`

======= Profile Service Events

*PartnerLinked*

See JSON Schema:
`/specifications/JSON Schemas/PartnerLinked.event.schema.json`

Event published when a consumer successfully links a partner account
(e.g., Flybuys, Shell Card).

*PartnerUnlinked*

See JSON Schema:
`/specifications/JSON Schemas/PartnerUnlinked.event.schema.json`

Event published when a consumer unlinks a partner account from their
profile.

*PartnerLinkFailed*

See JSON Schema:
`/specifications/JSON Schemas/PartnerLinkFailed.event.schema.json`

Event published when a partner linking attempt fails (OAuth error,
invalid credentials, API timeout).

*RewardPreferenceChanged*

See JSON Schema:
`/specifications/JSON Schemas/RewardPreferenceChanged.event.schema.json`

Event published when a customer changes their reward preference (Flybuys
points ↔ OTR fuel discount).

======= Loyalty Service Events

*CustomerEnrolled*

See JSON Schema:
`/specifications/JSON Schemas/CustomerEnrolled.event.schema.json`

Event published when a customer is enrolled in the OTR loyalty program
(EagleEye wallet created).

*TransactionAdjudicated*

See JSON Schema:
`/specifications/JSON Schemas/TransactionAdjudicated.event.schema.json`

Event published after transaction adjudication, detailing the rewards
granted (Flybuys points or OTR fuel discount).

*PointsEarned*

See JSON Schema:
`/specifications/JSON Schemas/PointsEarned.event.schema.json`

Event published when a customer earns Flybuys points on a transaction.

*FuelDiscountApplied*

See JSON Schema:
`/specifications/JSON Schemas/FuelDiscountApplied.event.schema.json`

Event published when a customer receives an OTR fuel discount on a
transaction.

*RewardTransactionFailed*

See JSON Schema:
`/specifications/JSON Schemas/RewardTransactionFailed.event.schema.json`

Event published when transaction adjudication fails due to system errors
(EagleEye API timeout, invalid basket data).

====== Event Consumers

[width="100%",cols="21%,31%,48%",options="header",]
|===
|Service | Event | Responsibility
|xref:bounded-contexts:loyalty.adoc[Loyalty Service]
|`PartnerLinked`, `RewardPreferenceChanged` | Updates Transaction
Adjudication rules based on Reward Preference

|xref:bounded-contexts:engagement.adoc[Engagement Service]
|`PartnerLinked` | Sends linking confirmation notification via
xref:bounded-contexts:braze.adoc[Braze]

|xref:bounded-contexts:engagement.adoc[Engagement Service]
|`TransactionAdjudicated` | Sends points earned notification to customer
via xref:bounded-contexts:braze.adoc[Braze]

|xref:bounded-contexts:recommendation.adoc[Recommendation Service]
|`PartnerLinked`, `RewardPreferenceChanged` | Adjusts offer
recommendations based on Reward Preference
|===

===== Bidirectional Anti-Corruption Layer (POS Integration)

====== Pattern

`LoyaltyService [ACL] ↔ [ACL] D365 Commerce`

====== Rationale

* xref:bounded-contexts:microsoft_dynamics_365_commerce.adoc[Microsoft
Dynamics 365 Commerce] owns payment/transaction domain;
xref:bounded-contexts:loyalty.adoc[Loyalty Service] owns loyalty
domain
* Bidirectional
xref:ubiquitous_language.adoc#Anti-Corruption%2520Layer%2520%28ACL[Bidirectional
ACL]) prevents domain model leakage in both directions
* xref:bounded-contexts:otr_pos.adoc[OTR POS] &
xref:bounded-contexts:otr_plus_pos.adoc[OTR+ POS] calls
xref:bounded-contexts:loyalty.adoc[Loyalty Service] for barcode
validation (synchronous)
* xref:bounded-contexts:loyalty.adoc[Loyalty Service] queries D365
Commerce for transaction data (batch file generation)

====== Technology Stack

* Synchronous: REST API (< 500ms latency for POS barcode validation)
* Asynchronous: Scheduled batch query (nightly transaction aggregation)

====== ACL Translation

======= D365 Commerce → LoyaltyService

* `Transaction` (POS domain) → `RewardEligibilityRequest` (Loyalty
domain)
* Filter out payment details (card number, CVV) - not needed for loyalty
adjudication

======= LoyaltyService → D365 Commerce

* `BatchFileQuery` (Loyalty domain) → `TransactionHistoryRequest` (POS
domain)
* Query by date range and store ID only (no customer PII exposure)

==== Data Architecture Principles

===== Aggregate Persistence

====== xref:bounded-contexts:profile.adoc[Profile Service]

link:#partner[PartnerLink] Table:

See JSON Schema: `/specifications/JSON Schemas/PartnerLink.schema.json`

This aggregate represents a linked third-party partner account (Flybuys,
Shell Card, etc.) with OAuth token references and reward preferences.

======= Partitioning Strategy

By `vivaConsumerId` (all partner links for a customer in same partition
- single-partition transactions)

======= Indexes

* Partition key: `vivaConsumerId` (customer profile queries)
* Composite index: `(partner, externalMemberId)` (partner member lookup
for POS barcode scanning)

====== xref:bounded-contexts:loyalty.adoc[Loyalty Service]

RewardTransaction Table

See JSON Schema:
`/specifications/JSON Schemas/RewardTransactionDocument.schema.json`

This aggregate represents the transaction adjudication audit trail,
recording reward outcomes for customer transactions.

======= Partitioning Strategy

By xref:ROOT:ubiquitous_language.adoc#viva-consumer-id-vci[VCI]
(customer transaction history queries)

======= Time-to-Live

30 days (summary only - full transaction history in
xref:bounded-contexts:microsoft_dynamics_365_commerce.adoc[Microsoft
Dynamics 365 Commerce])

===== Event Store

====== Topics

[cols=",",options="header",]
|===
|Topic Name | Description
|`profile-events` | Partner linking and reward preference events
|`loyalty-events` | Loyalty Transaction Adjudication events
|===

======= Retention

7 days (event replay for failed consumers)

======= Partitioning

By xref:ROOT:ubiquitous_language.adoc#viva-consumer-id-vci[VCI]
(maintain event ordering per customer)

=== Architecture Decisions

[width="100%",cols="3%,4%,,15%,9%,23%,19%,27%",options="header",]
|===
|ADR | Decision | Status | Context | Decision | Rationale | Alternatives
Considered | Consequences
|ADR-001 | xref:ROOT:ubiquitous_language.adoc#Partner%2520Link[PartnerLink]
Aggregate Ownership | Accepted | Partner linking capability (OAuth flow,
linking status, external member ID) could belong to
xref:bounded-contexts:profile.adoc[Profile Service] or
xref:bounded-contexts:loyalty.adoc[Loyalty Service] bounded
contexts. | xref:bounded-contexts:profile.adoc[Profile Service]
owns xref:ROOT:ubiquitous_language.adoc#Partner%2520Link[PartnerLink]
aggregate. | - Partner linking is customer profile data (identity
federation), not loyalty transaction data- Customer can link partners
before any loyalty transaction occurs- Reward preference is profile
attribute that influences loyalty operations (not owned by loyalty)-
xref:bounded-contexts:profile.adoc[Profile Service] becomes
reusable for future partner integrations (Shell Card, AFL, Budget
Direct) | *xref:bounded-contexts:loyalty.adoc[Loyalty Service] owns
xref:ubiquitous_language.adoc#Partner%2520Link[PartnerLink]*: Rejected
because linking life cycle is independent of loyalty
transactions*Separate Partner Service*: Rejected due to excessive
bounded context fragmentation (single aggregate doesn’t justify new
service) | *Positive*: Clear separation of concerns (profile management
vs loyalty operations)*Positive*:
xref:ubiquitous_language.adoc#Reward%2520Preference[Reward Preference]
changes trigger events consumed by
xref:bounded-contexts:loyalty.adoc[Loyalty Service] (loose
coupling)*Negative*: xref:bounded-contexts:loyalty.adoc[Loyalty
Service] must subscribe to
xref:bounded-contexts:profile.adoc[Profile Service] events
(eventual consistency for reward preference)

|ADR-002 | OAuth Token Storage | Accepted | OAuth access tokens and refresh
tokens must be stored securely for
xref:bounded-contexts:flybuys.adoc[Flybuys] API calls.
*Question*: Should tokens be stored in
xref:ubiquitous_language.adoc#Partner%2520Link[PartnerLink] aggregate
or separate infrastructure service? | Separate OAuth Service manages
tokens; xref:ROOT:ubiquitous_language.adoc#Partner%2520Link[PartnerLink]
aggregate stores only reference (`oauthTokenReference`). | - OAuth tokens
are infrastructure concern (encryption, rotation, expiry) not domain
concern- PCI/security compliance requires token isolation (separate
encryption keys, access controls)- Token refresh logic (background job
every 50 minutes) is independent of domain operations- Generic OAuth
Service supports future partners (Shell Card, AFL, Budget Direct)
|*Store tokens in
xref:ubiquitous_language.adoc#Partner%2520Link[PartnerLink] aggregate*:
Rejected due to security/compliance concerns (domain aggregates
persisted in application database)*Store tokens in Key Vault only*:
Rejected due to retrieval latency | *Positive*: PCI/security compliance
isolated to OAuth Service*Positive*: Token refresh logic decoupled from
domain model*Negative*: Additional service dependency (OAuth Service
must be available for partner API calls)*Neutral*:
xref:ubiquitous_language.adoc#Partner%2520Link[PartnerLink] aggregate
references token by ID (no direct access to token value)

|ADR-003 | Real-Time Balance Queries vs Local Caching | Accepted
|xref:bounded-contexts:mobile.adoc[Mobile
Application] displays
xref:bounded-contexts:flybuys.adoc[Flybuys] points balance.
Question: Should xref:bounded-contexts:loyalty.adoc[Loyalty
Service] cache balance locally or query
xref:bounded-contexts:flybuys.adoc[Flybuys] API in real-time?
|Real-time queries to Flybuys API with 5-minute in-memory cache.
|*Simplicity*: Avoids synchronisation complexity
(xref:bounded-contexts:flybuys.adoc[Flybuys] points earned
outside OTR network)*Accuracy*: Customer sees actual
xref:bounded-contexts:flybuys.adoc[Flybuys] balance (no stale
data from local cache)*Partnership Terms*: Flybuys allows real-time
queries | *Local cache synchronised via Flybuys webhooks*: Rejected
because Flybuys doesn’t provide web hooks for balance changes*Daily
batch synchronisation*: Rejected due to architectural overhead. Points
display is not a requirement, and only informational. We are not obliged
to display Points. | *Positive*: No synchronization logic
complexity*Positive*: Always accurate balance (no reconciliation
issues)*Negative*: 2-second mobile app latency (Flybuys API p95 latency
= 1.5s + network overhead)*Negative*: Dependency on Flybuys API uptime
(requires circuit breaker pattern)*Mitigation*: 5-minute cache reduces
Flybuys API load, circuit breaker returns cached value on failures

|ADR-004 | Default Reward Preference for New Customers | Accepted | New OTR
customers must choose
xref:ubiquitous_language.adoc#Reward%2520Preference[Reward Preference]
(Flybuys points or OTR fuel discounts). *Question*: What’s the default
if customer doesn’t explicitly choose? | Default new customers to
`OTR_REWARDS` (not Flybuys). | *Encourage Native Loyalty*: OTR builds own
loyalty capability to reduce
xref:bounded-contexts:flybuys.adoc[Flybuys] dependency within
2-3 years*Explicit Opt-In*: Customers must explicitly link
xref:bounded-contexts:flybuys.adoc[Flybuys]account and choose
xref:bounded-contexts:flybuys.adoc[Flybuys] points (informed
consent)*Partnership Strategy*:
xref:bounded-contexts:flybuys.adoc[Flybuys] is acquisition
bridge, not long-term lock-in | *Default to Flybuys*: Rejected due to
strategic goal of building OTR loyalty capability*No default (force
choice)*: Rejected due to UX friction (mobile app on-boarding
abandonment risk) | *Positive*: Customers must actively choose
xref:bounded-contexts:flybuys.adoc[Flybuys] (informed
decision)*Positive*: Native OTR loyalty becomes primary engagement
mechanism*Negative*: Lower
xref:bounded-contexts:flybuys.adoc[Flybuys] adoption rate
(requires active linking step)*Mitigation*: Mobile app prompts for
xref:bounded-contexts:flybuys.adoc[Flybuys] linking during
on-boarding, in-store signage promoting Flybuys option

|ADR-005 | Bounded Context Extraction Strategy (Strangler Fig Pattern)
|Accepted | Current OTR App API is monolithic AWS Lambda. *Question*:
Big-bang migration to bounded contexts or incremental extraction
(xref:ubiquitous_language.adoc#Strangler%2520Fig[Strangler Fig])?
|Phased extraction using Strangler Fig pattern across multiple
architecture states. | *Risk Mitigation*: Incremental migration reduces
big-bang deployment risk*Coexistence*: New bounded contexts operate in
parallel with legacy OTR App API (feature flag controlled)*Rollback
Capability*: Each phase can be rolled back independently | *Big-bang
migration*: Rejected due to high risk (entire customer base impacted if
migration fails)*Permanent dual-write*: Rejected due to synchronisation
complexity and technical debt | *Positive*: Incremental risk (each
architecture state impacts subset of users)*Positive*: Learning from
each state informs subsequent states*Negative*: Temporary complexity
(dual systems during transition)*Negative*: Extended migration approach
compared to big-bang
|===

=== Migration Strategy

This section defines the phased migration approach from current state to
target architecture. Each phase corresponds to an Architecture State
(AS) documented in
xref:solution-architectures:flybuys_integration.adoc#Transition%2520Architecture[Transition
Architecture]. *Architecture State Mapping*:

* *AS-0*: Current State (pre-migration baseline)
* *AS-1*: Foundation (infrastructure establishment)
* *AS-2*: Linking (partner integration enabled)
* *AS-3*: Grants (transaction adjudication and batch processing)
* *AS-4*: Target State (legacy systems decommissioned) See
xref:solution-architectures:flybuys_integration.adoc#Transition%2520Phase%2520Matrix[Transition
Phase Matrix] for feature flag rollout schedule across architecture
states.

==== AS-1: Foundation

===== Objective

Establish xref:bounded-contexts:profile.adoc[Profile Service],
xref:bounded-contexts:loyalty.adoc[Loyalty Service] & Event Bus
without impacting production workloads.

===== Technical Deliverables

====== xref:bounded-contexts:profile.adoc[Profile Service]

* Provide endpoint to upsert OTR App User into
xref:bounded-contexts:salesforce_crm.adoc[Salesforce CRM],
returning xref:ROOT:ubiquitous_language.adoc#viva-consumer-id-vci[VCI]
* Deploy repository
(xref:ubiquitous_language.adoc#Partner%2520Link[Partner Link] table
with partitioning by
xref:ubiquitous_language.adoc#viva-consumer-id-vci[VCI])
* Implement (xref:ubiquitous_language.adoc#Partner%2520Link[Partner
Link] aggregate (linking status state machine, reward preference
validation)
* Expose xref:bounded-contexts:profile.adoc[Profile Service] REST
API
* Implement event publishing for
xref:bounded-contexts:profile.adoc[Profile Service] events

====== xref:bounded-contexts:loyalty.adoc[Loyalty Service]

* Provide endpoint to upsert OTR App User into
xref:bounded-contexts:eagle_eye.adoc[EagleEye] with
xref:ubiquitous_language.adoc#viva-consumer-id-vci[VCI]
* Implement
xref:ubiquitous_language.adoc#RewardTransaction[RewardTransaction]
aggregate and deploy repository with
xref:ubiquitous_language.adoc#RewardTransaction[RewardTransaction]
table (audit trail persistence)
* Deploy
xref:ubiquitous_language.adoc#Anti-Corruption%2520Layer%2520%28ACL[Bidirectional
ACL]) for xref:bounded-contexts:eagle_eye.adoc[EagleEye] to
translate xref:bounded-contexts:eagle_eye.adoc[EagleEye] API
responses to domain model
* Expose xref:bounded-contexts:loyalty.adoc[Loyalty Service] REST
API
* Implement event publishing for
xref:bounded-contexts:loyalty.adoc[Loyalty Service] events

====== xref:bounded-contexts:mobile.adoc[Mobile Application]

* Implement Feature Flag service to toggle new features and bounded
contexts
* Add Feature Flags
(xref:bounded-contexts:loyalty.adoc#Feature%2520Flags[OTR.Loyalty.PartnerLink.Flybuys]
&
xref:bounded-contexts:loyalty.adoc#Feature%2520Flags[OTR.Loyalty.PointsEarn.Flybuys])
* Pilot users (100 OTR employees) toggle feature flag to test new
services
* Dual-write: Mobile app sends requests to both legacy OTR App API and
new bounded contexts (compare responses)

===== Success Criteria

* Zero production impact
* xref:bounded-contexts:mobile.adoc[Mobile
Application] can remotely enable and disable features without code
changes
* All xref:ROOT:ubiquitous_language.adoc#Customer[Customers] are allocated a
xref:ubiquitous_language.adoc#viva-consumer-id-vci[VCI] and
xref:ubiquitous_language.adoc#Wallet[Loyalty Wallet]
* Event Bus is consuming
xref:bounded-contexts:profile.adoc[Profile Service] and
xref:bounded-contexts:loyalty.adoc[Loyalty Service] events

===== Rollback Strategy

* Disable feature flag

==== AS-2: Linking

===== Objective

Enable xref:bounded-contexts:mobile.adoc[Mobile
Application] xref:ROOT:ubiquitous_language.adoc#Customer[Customers] to link
their
xref:ubiquitous_language.adoc#Flybuys%2520Digital%2520Identity[Flybuys
Digital Identity] via OAuth 2.0 flow.

===== Technical Deliverables

====== OAuth

* Deploy OAuth token storage (Azure Key Vault or AWS Secrets Manager)
* Implement Authorisation Code Flow with
xref:ubiquitous_language.adoc#PKCE[PKCE]
* Implement token refresh background job

====== xref:bounded-contexts:flybuys.adoc[Flybuys]

* Integrate Flybuys OAuth API (authorisation, token exchange)
* Implement Flybuys member validation API (verify external member ID)
* Deploy circuit breaker for Flybuys API calls (fallback to cached data)

====== xref:bounded-contexts:profile.adoc[Profile Service]

* Implement OAuth linking operations (initiate linking, complete
linking, unlink)
* Implement reward preference change operation (validate against linking
status)
* Publish domain events (`PartnerLinked`, `PartnerUnlinked`,
`RewardPreferenceChanged`)

====== xref:bounded-contexts:mobile.adoc[Mobile Application]

* Account linking screen (OAuth redirect flow)
* Reward preference selection (Flybuys points vs fuel discounts)
* Linked status display (show Flybuys member ID, unlinking option)

===== Success Criteria

* xref:bounded-contexts:mobile.adoc[Mobile
Application] xref:ROOT:ubiquitous_language.adoc#Customer[Customers] can
link/unlink
xref:ubiquitous_language.adoc#Flybuys%2520Digital%2520Identity[Flybuys
Digital Identity]

===== Rollback Strategy

* Disable `OTR.Loyalty.PartnerLink.Flybuys` feature flag for pilot
stores (remove in-app linking UI)
* Preserve existing PartnerLink aggregates (no data deletion - customers
can relink after rollback)

==== AS-3: Grants

===== Objective

xref:bounded-contexts:mobile.adoc[Mobile
Application] xref:ROOT:ubiquitous_language.adoc#Customer[Customers] earn
xref:ubiquitous_language.adoc#Flybuys%2520Points[Flybuys Points] on
purchases; batch file transmission to Flybuys.

===== Technical Deliverables

====== Transaction Adjudication

* Implement
xref:bounded-contexts:loyalty.adoc#Services[TransactionAdjudication]
(orchestrate xref:bounded-contexts:eagle_eye.adoc[EagleEye],
Profile, POS queries)
* Implement payment method exclusion rules (Shell Card purchases don’t
earn Flybuys points)
* Persist
xref:bounded-contexts:loyalty.adoc#Aggregates[RewardTransaction]
aggregates (audit trail with 30-day TTL)

====== Batch File Processing

* Implement batch file generator (nightly scheduled job)
* Query
xref:bounded-contexts:microsoft_dynamics_365_commerce.adoc[Microsoft
Dynamics 365 Commerce] for previous day’s transactions
(xref:ubiquitous_language.adoc#Anti-Corruption%2520Layer%2520%28ACL[Bidirectional
ACL]))
* Generate CSV file (Flybuys specification: transaction ID, member ID,
amount, points)
* SFTP transmission to Flybuys (AWS Transfer Family endpoint)

====== xref:bounded-contexts:otr_pos.adoc[OTR POS] integration

* xref:bounded-contexts:otr_pos.adoc[OTR POS] calls
xref:bounded-contexts:loyalty.adoc[Loyalty Service] for
xref:ubiquitous_language.adoc#loyalty-credential[Loyalty
Credential] adjudication
* xref:bounded-contexts:otr_pos.adoc[OTR POS] displays
acknowledgement of xref:ROOT:ubiquitous_language.adoc#Flybuys[Flybuys]
* xref:bounded-contexts:loyalty.adoc[Loyalty Service] returns
customer eligibility (linked Flybuys account, reward preference)
* xref:ROOT:ubiquitous_language.adoc#Digital%2520Fuel%2520Dockets[Digital
Fuel Dockets] remain redeemable at
xref:bounded-contexts:otr_pos.adoc[OTR POS]

====== xref:bounded-contexts:otr_plus_pos.adoc[OTR+ POS] integration

* xref:bounded-contexts:otr_plus_pos.adoc[OTR+ POS] calls
xref:bounded-contexts:loyalty.adoc[Loyalty Service] for
xref:ubiquitous_language.adoc#loyalty-credential[Loyalty
Credential] adjudication
* xref:bounded-contexts:otr_plus_pos.adoc[OTR+ POS] displays
acknowledgement of xref:ROOT:ubiquitous_language.adoc#Flybuys[Flybuys]
* xref:bounded-contexts:loyalty.adoc[Loyalty Service] returns
customer eligibility (linked Flybuys account, reward preference)

====== xref:bounded-contexts:mobile.adoc[Mobile Application]

* Display xref:ROOT:ubiquitous_language.adoc#Flybuys%2520Points[Flybuys
Points] balance (real-time query with 5-minute cache)
* Show transaction history (
xref:bounded-contexts:loyalty.adoc#Aggregates[RewardTransaction]
aggregates from xref:bounded-contexts:loyalty.adoc[Loyalty
Service])
* xref:ROOT:ubiquitous_language.adoc#Digital%2520Fuel%2520Dockets[Digital
Fuel Dockets] become redeemable at
xref:bounded-contexts:otr_plus_pos.adoc[OTR+ POS]

===== Rollback Strategy

* Disable feature flag (stop batch file generation and transmission)
* Preserve RewardTransaction aggregates (retain audit trail)
* Manual batch file submission for previous day’s transactions
(reconciliation with Flybuys)

==== Coexistence Strategy

During migration, legacy OTR App API and new bounded contexts coexist
across architecture states:

[width="100%",cols="15%,85%",options="header",]
|===
|Architecture State | Description
|AS-1 Foundation | New services deployed but not used (feature flag
disabled)

|AS-2 Linking | xref:bounded-contexts:profile.adoc[Profile Service]
active for linking
operationsxref:bounded-contexts:loyalty.adoc[Loyalty Service]
passive (no Transaction Adjudication)

|AS-3 Grants | Full cutover (legacy OTR App API decommissioned after
30-day validation)

|AS-4 Target | All bounded contexts active
|===

*Data Synchronization*

* xref:bounded-contexts:profile.adoc[Profile Service] synchronises
customer data from
xref:bounded-contexts:salesforce_crm.adoc[Salesforce CRM]
(one-way read-only)
* xref:bounded-contexts:loyalty.adoc[Loyalty Service] publishes
events consumed by
xref:bounded-contexts:engagement.adoc[Engagement Service]
(eventual consistency acceptable)

*Feature Flag Management*

* Gradual rollout (10% → 25% → 50% → 100% of customers)
* Per-store enablement for pilot testing
* Kill switch for emergency rollback (disable all new services globally)

=== Architectural Scope Boundaries

==== Capabilities Included

This Architecture Definition Document covers the following technical
capabilities:

[width="100%",cols="47%,53%",options="header",]
|===
|Included Capability | Architectural Description
|Third-Party Partner Account Linking | OAuth 2.0 infrastructure for
secure external account linking

|xref:bounded-contexts:flybuys.adoc[Flybuys] Coalition Loyalty
Integration | Points earning, real-time balance queries, digital fuel
docket redemption

|xref:ubiquitous_language.adoc#Reward%2520Preference[Reward Preference]
Management | Customer choice enforcement between Flybuys points, Shell
fuel discounts, and OTR rewards

|xref:ubiquitous_language.adoc#Transaction%2520Adjudication[Transaction
Adjudication] with Partner Awareness | Payment method exclusion rules
(Shell Card grants), partner eligibility logic

|Event-Driven Integration Architecture | Asynchronous domain event
publishing between xref:bounded-contexts:profile.adoc[Profile
Service], xref:bounded-contexts:loyalty.adoc[Loyalty Service],
xref:bounded-contexts:engagement.adoc[Engagement Service]

|POS Integration for
xref:ubiquitous_language.adoc#loyalty-credential[Loyalty
Credentials]
|xref:ubiquitous_language.adoc#loyalty-credential[Loyalty
Credentials] are recognised at
xref:bounded-contexts:otr_pos.adoc[OTR POS] and
xref:bounded-contexts:otr_plus_pos.adoc[OTR+ POS]

|Batch Transaction Posting | Daily CSV file generation and SFTP
transmission to Flybuys with reconciliation
|===

==== Capabilities Excluded

The following capabilities are *out of scope* for this Architecture
Definition:

[width="100%",cols="22%,62%,16%",options="header",]
|===
|Excluded Capability | Architectural Rationale | Reference
|Shell Card account linking | Separate partner integration
|xref:architecture-definitions:flybuys_integration.adoc[Coalition
Loyalty] initiative

|Flybuys reward redemption | Inverse flow (redeem Flybuys points for OTR
products); requires Flybuys redemption API and inventory integration
|Future capability (post-AS-4)

|Additional Coalition partners (AFL, Budget Direct) | Generic partner
interfaces (`IPartnerPointsService`, `IPartnerDocketService`) designed
for extensibility; specific partner implementations deferred | Future
Architecture Definition Documents

|Dealer-specific POS terminal modifications | Dealer terminals use
standard D365Commerce integration without custom POS software
|xref:architecture-definitions:flybuys_integration.adoc[Dealer Loyalty]
programme scope

|Legacy REXP loyalty programme migration | Broader data migration and
system consolidation effort beyond Flybuys integration scope
|xref:architecture-definitions:flybuys_integration.adoc[Loyalty
Value Chain] initiative

|Flybuys Instant Rewards (in-store offers) | Requires real-time offer
activation during transaction; deferred pending Flybuys API availability
|Future capability (TBD)
|===

==== Architectural Dependencies on Future Initiatives

[width="99%",cols="14%,50%,36%",options="header",]
|===
|Dependency Initiative | Architectural Constraint | Impact if Not
Delivered
|xref:architecture-definitions:flybuys_integration.adoc[Loyalty
Value Chain] | Requires ProfileService `PartnerLink` aggregate design and
migration strategy from legacy REXP Flybuys database | Cannot migrate
REXP customers to unified ProfileService; Flybuys linking OTR-only

|OAuth Service (Infrastructure) | Requires generic OAuth 2.0 token
management service; ProfileService and LoyaltyService depend on secure
token storage | Cannot link Flybuys accounts; OAuth tokens stored
insecurely in application database
|===

=== Technical Risks and Mitigation

[width="100%",cols="3%,4%,12%,13%,41%,27%",options="header",]
|===
|Risk ID | Risk Name | Impact | Probability | Mitigation | Contingency
|RISK-001 | Flybuys API Availability | *High*: Customers cannot link
accounts if Flybuys API unavailable | *Medium*: Flybuys SLA 99.5% uptime
= 3.6 hours downtime/month | - Circuit breaker pattern (fallback to
cached balance after 3 consecutive API failures)- Batch file
transmission retry (exponential backoff, max 24-hour delay)- Customer
communication (mobile app banner: ``Flybuys integration temporarily
unavailable'') | - Partner unlinking (customer can unlink Flybuys and
revert to OTR fuel discounts)

|RISK-002 | OAuth Token Leakage | *High*: PCI/security compliance breach,
customer account hijacking | *Low*: OAuth Service isolated with
encryption at rest and in transit | - OAuth tokens stored in Key Vault
(separate from application database)- Token encryption (AES-256,
customer-managed keys)- Token expiry (60-minute access tokens, 14-day
refresh tokens)- Security audit (penetration testing before Phase 2
rollout) | - Emergency token revocation (invalidate all OAuth tokens,
force customers to relink)- Incident response (notify Flybuys within 24
hours, coordinate token rotation)

|RISK-003 | Batch File Processing Failures | *Medium*: 24-hour delay in
points crediting, customer dissatisfaction | *Medium*: File generation
errors, SFTP transmission failures, Flybuys rejection | - Batch file
validation (schema validation, reconciliation totals before
transmission)- SFTP retry logic (exponential backoff, max 3 retry
attempts)- Monitoring alerting (CloudWatch alarm on batch file
generation failures) | - Manual file generation (backup script queries
D365 Commerce, generates CSV)- Flybuys support escalation (coordinate
file resubmission within 48-hour grace period)

|RISK-004 | Event Bus Delivery Failures | *Low*: Eventual consistency
delay, customer notifications delayed by hours | *Low*: Event Bus SLA
99.9% delivery success with retry | - At-least-once delivery semantics
(Event Bus retries failed deliveries)- Dead letter queue (failed events
routed to DLQ after 24 hours)- Consumer idempotency (EngagementService
deduplicates events by eventId) | - Manual event replay (retrieve events
from Kinesis/Event Hub, reprocess via admin tool)
|===

== Assumptions and Constraints

=== Assumptions

[width="100%",cols="4%,43%,34%,19%",options="header",]
|===
|ID | Assumption | Impact if Invalid | Validation Approach
|ASM-01 | xref:bounded-contexts:flybuys.adoc[Flybuys] maintains 99.5% API uptime and adheres to published SLA | Customer-facing features (balance queries, digital dockets) degraded; circuit breaker fallback required | Monthly SLA reviews with Flybuys; API health monitoring
|ASM-02 | xref:bounded-contexts:oauth.adoc[OAuth Service] infrastructure service will be available by Q4 2025 | Cannot implement Phase 2 (partner linking); blocks Flybuys account linking capability | Platform team delivery roadmap; fortnightly status checks
|ASM-03 | xref:bounded-contexts:eagle_eye.adoc[EagleEye] supports xref:ROOT:ubiquitous_language.adoc#Transaction%2520Adjudication[Transaction Adjudication] API calls with <300ms p95 latency | POS transaction delays; customer friction at checkout; requires architectural redesign | Load testing in Phase 1; EagleEye performance benchmarks
|ASM-04 | xref:bounded-contexts:salesforce_crm.adoc[Salesforce CRM] will provide xref:ROOT:ubiquitous_language.adoc#viva-consumer-id-vci[VCI] as canonical customer identifier | xref:bounded-contexts:profile.adoc[Profile Service] cannot create unified customer profiles; PartnerLink aggregate lacks primary key | Salesforce CRM team confirmation; data model validation
|ASM-05 | Event Bus infrastructure (AWS EventBridge or Azure Event Grid) will support 10k events/day | Domain events (PartnerLinked, RewardPreferenceChanged) delayed or dropped; eventual consistency breaks | Platform team capacity planning; Event Bus load testing
|ASM-06 | xref:bounded-contexts:azure_data_factory.adoc[Azure Data Factory] supports SFTP connectivity to xref:bounded-contexts:flybuys.adoc[Flybuys] batch file endpoint | Cannot transmit daily transaction batch files; points posting fails; customer complaints | ADF SFTP integration testing; Flybuys endpoint validation
|ASM-07 | xref:bounded-contexts:flybuys.adoc[Flybuys] partnership contract extends for minimum 2-3 years | Short-term ROI invalidated; architecture investment wasted; premature partner churn | Legal/commercial team confirmation; contract review
|ASM-08 | xref:bounded-contexts:otr_pos.adoc[OTR POS] and xref:bounded-contexts:otr_plus_pos.adoc[OTR+ POS] can integrate via REST API | Cannot implement POS barcode scanning; dealer terminals inaccessible; blocks TR-008/TR-009 | D365 Commerce team confirmation; POS API documentation
|ASM-09 | xref:bounded-contexts:flybuys.adoc[Flybuys] OAuth 2.0 implementation supports Authorization Code Flow with PKCE | Cannot securely link customer accounts; mobile app security vulnerabilities; compliance risks | Flybuys API documentation review; OAuth flow testing
|ASM-10 | xref:bounded-contexts:microsoft_entra_external_id.adoc[Microsoft Entra External ID] supports customer authentication for 500k+ active users | Cannot scale customer base; authentication failures; requires alternative CIAM provider | Entra capacity planning; authentication load testing
|ASM-11 | xref:bounded-contexts:mobile.adoc[Mobile Application] can embed OAuth redirect flow without app store review delays | Phase 2 rollout delayed; customer linking unavailable; architectural workaround required | Mobile team feasibility review; app store policy check
|ASM-12 | NoSQL database supports 100k daily transactions with <50ms write latency | RewardTransaction aggregate persistence fails; audit trail gaps; performance degradation | Database benchmarking; Phase 1 load testing
|===

=== Constraints

[width="100%",cols="5%,6%,45%,44%",options="header",]
|===
|ID | Constraint Type | Description | Architectural Impact
|CON-001 | Regulatory | Must comply with Australian Privacy Principles (APP) for customer data collection and consent | OAuth flow requires explicit consent; customer can opt-out; audit logging mandatory
|CON-002 | Commercial | Cannot modify xref:bounded-contexts:flybuys.adoc[Flybuys] API contracts or data formats (conformist pattern required) | xref:bounded-contexts:loyalty.adoc[Loyalty Service] must conform to Flybuys batch file CSV specification and OAuth endpoints
|CON-003 | Security | OAuth tokens must be encrypted at rest (AES-256) and in transit (TLS 1.3) for PCI compliance | Tokens stored in separate OAuth Service; Key Vault with customer-managed keys
|CON-004 | Operational | Phased rollout required (no big-bang deployment); gradual customer migration via feature flags | Strangler Fig pattern; dual-write during transition; 6-month migration timeline (vs 2-month big-bang)
|CON-005 | Technical | Must use existing Azure/AWS infrastructure (no new cloud platform) | Technology selection constrained to Azure or AWS products.
|CON-006 | Commercial | xref:bounded-contexts:flybuys.adoc[Flybuys] partnership term is potentially 2-3 years, and not a guaranteed long-term strategic platform | Architecture must support partner swapping; generic IPartnerPointsService interface; ACL isolation
|CON-007 | Technical | Cannot access xref:bounded-contexts:otr_pos.adoc[OTR POS] or xref:bounded-contexts:otr_plus_pos.adoc[OTR+ POS] terminal code bases directly | Integration via D365 Commerce REST APIs only; no custom POS terminal software
|CON-008 | Operational | Legacy xref:bounded-contexts:otr_app_api.adoc[OTR App API] must remain operational | Dual-write pattern; coexistence strategy; feature flag management; 30-day validation before cutover
|CON-009 | Technical | xref:bounded-contexts:eagle_eye.adoc[EagleEye] is SaaS platform with fixed API contracts (limited customisation) | LoyaltyService must implement ACL for EagleEye API translation; cannot modify EagleEye data model
|CON-010 | Operational | xref:bounded-contexts:flybuys.adoc[Flybuys] batch file submission deadline is 02:00 UTC daily (non-negotiable) | Nightly batch job scheduled by 01:00 UTC; retry logic with exponential backoff; max 1-hour window
|CON-011 | Security | Customer PII must be stored in Australia region (data residency requirement) | Azure Australia East region for ProfileService and LoyaltyService databases
|CON-012 | Technical | xref:bounded-contexts:salesforce_crm.adoc[Salesforce CRM] is system of record for customer profiles | xref:bounded-contexts:profile.adoc[Profile Service] synchronises from Salesforce; cannot create/update customer profile data
|CON-013 | Operational | Backward compatibility required during migration (existing mobile app users unaffected) | Mobile app API versioning; gradual feature rollout; support for legacy OTR App API during transition
|CON-014 | Commercial | xref:bounded-contexts:flybuys.adoc[Flybuys] does not provide webhooks for balance changes or transaction notifications | Real-time balance queries only; 5-minute cache to reduce API load; no event-driven synchronization
|CON-015 | Technical | RewardTransaction audit trail limited to 30 days (cost optimization; full history in D365 Commerce) | DB TTL set to 2592000 seconds; summary data only; not system of record for transaction history
|===

== Non-Functional Requirements

[width="100%",cols="6%,8%,22%,64%",options="header",]
|===
|ID | Category | Requirement | Target
|NFR-001 | Performance | xref:bounded-contexts:profile.adoc[Profile
Service] API latency | < 200ms p95 (customer profile queries)

|NFR-002 | Performance | LoyaltyService API latency | < 500ms p95 (POS
barcode validation)

|NFR-003 | Performance | Flybuys balance query latency | < 2 seconds p95
(mobile app)

|NFR-004 | Performance | Batch file generation | Start 01:00 UTC, complete
by 02:00 UTC (1-hour window, Flybuys SLA non-negotiable)

|NFR-005 | Performance | Event publishing latency | < 5 seconds (event
appears in Event Bus)

|NFR-006 | Availability | xref:bounded-contexts:profile.adoc[Profile
Service] uptime | 99.9% (4.3 hours downtime/month)

|NFR-007 | Availability | xref:bounded-contexts:loyalty.adoc[Loyalty
Service] uptime | 99.5% (3.6 hours downtime/month - aligned with Flybuys
SLA)

|NFR-008 | Availability | xref:bounded-contexts:otr_app_api.adoc[Event Bus]
availability | 99.9% (guaranteed delivery with retry)

|NFR-009 | Security | OAuth tokens | AES-256 encryption at rest, TLS 1.3 in
transit

|NFR-010 | Security | PCI compliance | OAuth Service isolated (no PAN/CVV
storage)

|NFR-011 | Security | Customer consent | OAuth flow requires explicit
consent before first points posting (Australian Privacy Principles)

|NFR-012 | Security | Data residency | Customer data stored in Australia

|NFR-013 | Scalability | xref:bounded-contexts:profile.adoc[Profile
Service] | Support 500k active users (concurrent API requests: 100
req/sec)

|NFR-014 | Scalability | LoyaltyService | Support 100k daily transactions
(peak POS load: 500 txn/sec)

|NFR-015 | Scalability | Event Bus | Handle 10k events/day (PartnerLinked,
RewardPreferenceChanged, PointsEarned)

|NFR-016 | Reliability | Batch file transmission | 98%+ acknowledgment rate
(Flybuys acceptance)

|NFR-017 | Reliability | Transaction Adjudication accuracy | 99.9% (points
calculation matches EagleEye)

|NFR-018 | Reliability | Event delivery success | 99.9% (Event Bus with
retry)
|===

== Monitoring and Observability

=== Key Metrics

[width="100%",cols="28%,50%,22%",options="header",]
|===
|Service/Component | Metric | Unit/Description
|xref:bounded-contexts:profile.adoc[Profile Service] | API latency
|p50, p95, p99

|xref:bounded-contexts:profile.adoc[Profile Service] | API error
rate | 4xx, 5xx

|xref:bounded-contexts:profile.adoc[Profile Service] | PartnerLink
creation rate | links per day

|xref:bounded-contexts:profile.adoc[Profile Service] | Reward
preference change rate | changes per day

|xref:bounded-contexts:loyalty.adoc[Loyalty Service] | Transaction
Adjudication latency | p50, p95, p99

|xref:bounded-contexts:loyalty.adoc[Loyalty Service] | Batch file
generation duration | minutes

|xref:bounded-contexts:loyalty.adoc[Loyalty Service] | Batch file
transmission success rate | %

|xref:bounded-contexts:loyalty.adoc[Loyalty Service] | Flybuys API
error rate | 4xx, 5xx

|xref:bounded-contexts:loyalty.adoc[Loyalty Service] | Circuit
breaker trips | count per day

|Event Bus | Event publishing latency | seconds

|Event Bus | Event delivery success rate | %

|Event Bus | Dead letter queue depth | event count
|===

=== Alerting Thresholds

[width="100%",cols="9%,53%,38%",options="header",]
|===
|Severity | Alert Condition | Notification Channel
|Critical | xref:bounded-contexts:profile.adoc[Profile Service] API
error rate > 5% for 5 minutes | PagerDuty, on-call architect

|Critical | Batch file generation fails | immediate alert to OTR Digital
IT Team

|Warning | Flybuys API latency > 3 seconds p95 | immediate alert to OTR
Digital IT Team

|Warning | Event Bus dead letter queue depth > 100 events | immediate
alert to OTR Digital IT Team
|===

=== Dashboards

[width="100%",cols="31%,69%",options="header",]
|===
|Dashboard Name | Key Metrics Displayed
|xref:bounded-contexts:profile.adoc[Profile Service] Health | API
latency, error rate, throughput, PartnerLink creation rate

|xref:bounded-contexts:loyalty.adoc[Loyalty Service] Operations
|Transaction Adjudication rate, batch file status, Flybuys API health

|Event Bus Monitoring | Event publishing latency, delivery success rate,
DLQ depth

| |
|===
