= ProductCatalog Bounded Context
O.Young@otr.com.au
v0.1, 2025-01-13
:project-name: OTRG Apps & Ecommerce Architecture
:togaf-adm-phase: Phase C: Information Systems Architectures
:document-type: Bounded Context
:status: Draft
:version: 0.1
:domain: ProductCatalog
:bounded-context-type: APPLICATION
:domain-architect: O.Young@otr.com.au
:doctype: article
:toc: left
:toclevels: 4
:sectanchors:
:sectlinks:
:sectnums:
:icons: font
:source-highlighter: highlightjs
:experimental:
:description: Bounded Context for the ProductCatalog Domain - Product catalog and pricing facade
:keywords: product, catalog, pricing, bounded context, togaf, ddd, facade, acl

Product catalog and pricing facade service that translates D365 Commerce product and pricing data into AWS-native APIs for customer-facing applications and external integrations.

This service acts as an Anti-Corruption Layer (ACL) between back-office systems (Azure) and ecommerce domain (AWS), providing a stable, domain-aligned API contract for digital menu boards, mobile apps, and ecommerce platforms.

== Business Context

The `ProductCatalogService` is a facade and translation layer that bridges OTR's back-office product and pricing systems (D365 Commerce on Azure) with customer-facing digital experiences (AWS).

It enables external systems (Amped Digital DMB, OTR Mobile App, SMGB Online) to consume product catalog and pricing data through a standardised REST API without coupling to D365's domain model or Azure infrastructure.

Initial use case: Subway Digital Menu Board pricing integration with Amped Digital vendor.

== Architectural Pattern

The `ProductCatalogService` acts as a **Facade and Anti-Corruption Layer**, NOT a system of record.

It protects the ecommerce domain from D365 Commerce's data model and provides a stable API contract in OTR's ubiquitous language, enabling back-office systems to evolve independently.

=== Key Characteristics

* **Facade Layer:** Simplifies access to complex back-office pricing data
* **Anti-Corruption Layer:** Translates D365 terminology into domain language
* **Caching Layer:** Stores pricing data locally for fast query performance
* **Event Publisher:** Publishes domain events when pricing changes (future-proofing)

== Strategic Value

=== Vendor Independence

* ACL pattern protects ecommerce domain from D365 Commerce data model changes
* D365 can be replaced with alternative ERP/product systems without rewriting consumers
* Single translation layer shields digital experiences from back-office migrations

=== Platform Consistency

* All customer-facing pricing APIs hosted on AWS (ecommerce team's platform)
* Consistent with OTR Mobile App, SMGB Online, and digital experiences architecture
* Leverages existing AWS expertise, tooling, and operational processes

=== Operational Efficiency

* Single API serves multiple consumers (DMB, mobile, web, future integrations)
* Reduces point-to-point integrations between D365 and customer-facing systems
* Centralised caching reduces load on D365 Commerce API

=== Future Extensibility

* Event-driven integration enables reactive pricing updates across ecosystem
* Foundation for advanced features: price testing, dynamic pricing, promotional rules
* Scalable pattern for additional product catalog capabilities (inventory, categories)

== Long-Term Vision

The ProductCatalogService is a **Supporting Domain** microservice that forms part of OTRG's ecommerce platform:

* **Cross-cloud integration pattern:** Clean data contract between Azure (back-office) and AWS (ecommerce)
* **Multi-brand support:** Single service supports OTR, Subway, SMGB, and future brands
* **API-first design:** RESTful API with OpenAPI specification for external vendors
* **Event-driven future:** Enables real-time price change notifications to mobile apps, DMBs, and web platforms
* **2026 roadmap capabilities:** Dynamic pricing, A/B price testing, promotional pricing engine integration

== Future State Benefits

* **Vendor independence:** Swap D365 Commerce for alternative product/pricing systems without domain changes
* **Single pricing API** for all customer-facing channels (DMB, mobile, web, kiosks)
* **Advanced features:** Real-time price updates via events, promotional pricing integration, inventory visibility
* **Unified product catalog** across all OTR brands and channels
* **Scalable architecture:** Supporting 2026 Digital Roadmap growth and multi-brand expansion

== Aggregates

[width="100%",cols="15%,85%",options="header",]
|===
|Aggregate Name |Description

|`ProductPrice`
|Cached representation of product pricing from D365 Commerce. Contains product details (ID, name, category), price groups, regional pricing, and store assignments. Updated hourly via ETL pipeline. **Not** a system of record - D365 Commerce owns authoritative pricing data.

|===

=== Aggregate: ProductPrice

The `ProductPrice` aggregate represents a cached view of pricing data for external API consumption.

*Aggregate Root:* `Product`

*Entities:*

* `Product` - Product identifier, name, category (aggregate root)
* `Price` - Price amount, price group, effective dates
* `PriceGroup` - Price group identifier, region code, store assignments

*Invariants:*

* Price amount must be greater than zero
* Each product must have at least one price group
* Effective date ranges cannot overlap for the same product/price group combination
* Store IDs must exist in the store master data

*Lifecycle:*

. Created/updated via hourly ETL pipeline from D365 Commerce export
. Validated against data contract schema
. Stored in RDS PostgreSQL for fast query access
. Queried via REST API by external consumers
. Refreshed hourly - data is eventually consistent (max 1 hour lag)

== Services

[width="100%",cols="25%,75%",options="header",]
|===
|Service Name |Description

|`PricingQueryService`
|Query pricing data by product ID, store ID, or price group. Returns pricing in API response format for external consumers.

|`ProductCatalogETLService`
|ETL service that ingests D365 Commerce pricing exports from S3, validates data contract compliance, and loads into RDS PostgreSQL.

|`DataValidationService`
|Validates incoming pricing data against schema and business rules. Alerts on validation failures.

|`D365PricingTranslator`
|Anti-Corruption Layer that translates D365 Commerce terminology and data structures into ProductCatalog domain language.

|`CacheInvalidationService`
|Manages API Gateway cache invalidation when new pricing data is loaded (future enhancement: ElastiCache integration).

|===

=== NOT in this Context (Owned by Other Systems)

[width="100%",cols="25%,60%,15%",options="header",]
|===
|Action / Entity |Description |Relationship

|Product Master Data
|Authoritative product catalog owned by link:external/microsoft_dynamics_365_commerce.adoc[D365 Commerce]
|S3 data export

|Pricing Configuration
|Price rules, markups, discounts owned by link:external/microsoft_dynamics_365_commerce.adoc[D365 Commerce]
|S3 data export

|Store Master Data
|Store locations, IDs, regions owned by link:external/microsoft_dynamics_365_commerce.adoc[D365 Commerce]
|S3 data export

|Price Group Assignments
|Store-to-price-group mappings owned by link:external/microsoft_dynamics_365_commerce.adoc[D365 Commerce]
|S3 data export

|Promotional Pricing
|Campaign-based pricing owned by link:external/eagle_eye.adoc[EagleEye] (future integration)
|TBD

|Inventory Availability
|Real-time stock levels owned by link:external/microsoft_dynamics_365_commerce.adoc[D365 Commerce] (future integration)
|TBD

|===

== Events

=== Events Published by ProductCatalogService

*Note:* Event publishing is designed for future extensibility. Initial implementation (Subway DMB) does not require event consumers.

==== Product Pricing Events

[width="100%",cols="30%,50%,20%",options="header",]
|===
|Event Name |Description |Source

|`ProductPriceUpdated`
|Product pricing changed (price amount, effective dates, store assignments)
|ETL pipeline

|`ProductCatalogRefreshed`
|Hourly catalog refresh completed successfully
|ETL pipeline

|`PriceGroupAssignmentChanged`
|Store-to-price-group mapping changed
|ETL pipeline

|`ProductAdded`
|New product added to catalog
|ETL pipeline

|`ProductRemoved`
|Product removed from catalog (discontinued)
|ETL pipeline

|===

==== Data Quality Events

[width="100%",cols="30%,50%,20%",options="header",]
|===
|Event Name |Description |Source

|`DataValidationFailed`
|Pricing data failed schema or business rule validation
|Data validation service

|`ETLPipelineFailed`
|ETL job failed to process pricing export
|ETL pipeline

|`MissingPricingData`
|Expected pricing export file not found in S3
|ETL pipeline

|===

=== Future Event Consumers

Potential downstream consumers for pricing change events:

* **link:location.adoc[LocationService]:** Update store-specific pricing for store finder
* **link:interfaces/mobile.adoc[MobileApp]:** Invalidate cached prices, show "price updated" notifications
* **link:engagement.adoc[EngagementService]:** Trigger "price drop" campaigns for customer engagement
* **Data Platform:** Analytics and reporting on pricing changes

== Integration Patterns

=== Upstream: D365 Commerce → ProductCatalogService

**Pattern:** Customer-Supplier + Conformist

* **D365 Commerce (Supplier):** Exports pricing data to S3 on hourly schedule
* **ProductCatalogService (Customer):** Conforms to D365's data contract and schema
* **Integration Technology:** S3 bucket with cross-account IAM access (Azure → AWS)
* **Data Format:** Apache Parquet files with defined schema
* **Update Frequency:** Hourly batch export
* **Anti-Corruption Layer:** D365PricingTranslator translates D365 terminology into domain language

=== Downstream: ProductCatalogService → External Consumers

**Pattern:** Open Host Service + Published Language

* **ProductCatalogService (Open Host):** Publishes stable REST API contract
* **External Consumers (Amped Digital, future mobile/web):** Consume API without translation
* **Integration Technology:** REST API via API Gateway, OAuth 2.0 Client Credentials authentication
* **Data Format:** JSON with OpenAPI specification
* **Update Frequency:** Real-time queries (data eventually consistent, max 1 hour lag)
* **Published Language:** OTR domain terminology (product, price, store, price group)

=== Cross-Cloud Integration

**Pattern:** Domain Boundary via S3 Data Contract

* **Back-Office Domain (Azure):** D365 Commerce, Azure Data Lake, Microsoft Fabric
* **Ecommerce Domain (AWS):** S3, Glue/Lambda, RDS, API Gateway, ECS
* **Domain Interface:** S3 bucket with data contract (schema, SLA, quality rules)
* **Rationale:** Clean separation between domains; each uses native cloud services

== Infrastructure Abstractions

Following xref:patterns:clean_architecture.adoc[Clean Architecture] principles, ProductCatalogService depends on **abstractions** (ports), not concrete implementations.

=== Application Ports (Interfaces)

Domain and Application layers depend on these abstractions:

==== Data Access

[source,csharp]
----
// IProductPriceRepository - Persistence abstraction
public interface IProductPriceRepository
{
    Task<ProductPrice> FindById(ProductId id);
    Task<List<ProductPrice>> FindByStoreId(StoreId storeId);
    Task<List<ProductPrice>> FindByPriceGroup(PriceGroupId priceGroupId);
    Task Save(ProductPrice productPrice);
    Task SaveBatch(IEnumerable<ProductPrice> prices);
}

// IETLJobRepository - ETL tracking
public interface IETLJobRepository
{
    Task<ETLJob> GetLatestJob();
    Task RecordJobStart(ETLJobId jobId, string sourceFile);
    Task RecordJobSuccess(ETLJobId jobId, int recordsProcessed);
    Task RecordJobFailure(ETLJobId jobId, string errorMessage);
}
----

==== External Systems

[source,csharp]
----
// ID365CommercePort - D365 Commerce abstraction
public interface ID365CommercePort
{
    Task<PricingDataExport> FetchLatestPricingExport();
    Task AcknowledgeExport(string exportId);
}

// IDataValidationPort - Validation abstraction
public interface IDataValidationPort
{
    ValidationResult ValidateSchema(PricingDataExport export);
    ValidationResult ValidateBusinessRules(List<ProductPrice> prices);
}
----

==== Infrastructure Services

[source,csharp]
----
// ICachePort - Caching abstraction
public interface ICachePort
{
    Task<T> Get<T>(string key);
    Task Set<T>(string key, T value, TimeSpan ttl);
    Task Invalidate(string key);
}

// IEventBusPort - Event publishing
public interface IEventBusPort
{
    Task Publish<TEvent>(TEvent domainEvent) where TEvent : IDomainEvent;
}

// IObservabilityPort - Monitoring/logging
public interface IObservabilityPort
{
    void LogInformation(string message, params object[] args);
    void LogError(Exception ex, string message, params object[] args);
    void RecordMetric(string metricName, double value);
}

// ISecretsPort - Secrets management
public interface ISecretsPort
{
    Task<string> GetSecret(string secretName);
}
----

=== Concrete Implementations (Infrastructure Layer)

**Note**: Concrete implementations documented in deployment architecture, not domain architecture.

See: `infrastructure/product-catalog-infrastructure.adoc` for:

* Relational database implementation (PostgreSQL schema)
* ETL pipeline implementation (AWS Glue, Lambda)
* Cache implementation (API Gateway caching layer)
* API hosting (ECS Fargate, API Gateway)
* Monitoring (CloudWatch metrics and logs)
* Secrets management (AWS Secrets Manager)
* Security (WAF rules, OAuth 2.0 client credentials)

== Architecture Decisions

=== ADR-001: ProductCatalogService as Facade, Not System of Record

* **Context:** Need to expose D365 Commerce pricing to external systems
* **Decision:** ProductCatalogService is a facade/ACL, not authoritative source
* **Rationale:** D365 Commerce owns pricing rules and configuration; duplicating logic would create consistency issues
* **Consequences:** Service is eventually consistent (max 1 hour lag); D365 remains source of truth
* **Status:** Approved

=== ADR-002: Cross-Cloud Integration via S3 Data Contract

* **Context:** D365 Commerce on Azure, ProductCatalogService on AWS
* **Decision:** S3 bucket with data contract as domain boundary
* **Rationale:** Clean separation; each domain uses native cloud services; loose coupling
* **Consequences:** Cross-cloud data transfer required; need cross-account IAM setup
* **Status:** Approved

=== ADR-003: Hourly Batch ETL vs Real-Time Streaming

* **Context:** Pricing data needs to flow from D365 to ProductCatalogService
* **Decision:** Hourly batch export, not real-time CDC (Change Data Capture)
* **Rationale:** Prices change infrequently; batch simpler than CDC; 1-hour lag acceptable per requirements
* **Consequences:** Data eventually consistent; not suitable for high-frequency price changes
* **Status:** Approved

=== ADR-004: Relational Database vs NoSQL

* **Context:** Need queryable store for pricing data
* **Decision:** Relational database over NoSQL
* **Rationale:** Relational model fits pricing domain (products → prices → stores); referential integrity; complex queries; team expertise
* **Consequences:** Need to manage schema migrations; vertical scaling limitations
* **Status:** Approved
* **Implementation:** PostgreSQL on AWS RDS (see infrastructure documentation)

=== ADR-005: Event Publishing for Future Extensibility

* **Context:** Future consumers may need real-time pricing change notifications
* **Decision:** Design event schema now, publish events, even if no initial consumers
* **Rationale:** Enables future event-driven architecture without service redesign; low implementation cost
* **Consequences:** Need to maintain event schema stability; unused events initially
* **Status:** Approved

== API Contract

=== REST API Endpoints

**Base URL:** `https://api.otr.com.au/product-catalog/v1`

**Authentication:** OAuth 2.0 Client Credentials flow

==== GET /pricing

Returns pricing data for all products or filtered by query parameters.

**Query Parameters:**

* `product_id` (optional) - Filter by specific product
* `store_id` (optional) - Filter by specific store
* `price_group` (optional) - Filter by price group

**Response Format:**

[source,json]
----
{
  "generated_at": "2025-01-13T10:30:00Z",
  "products": [
    {
      "product_number": "398602",
      "product_name": "Italian BMT Footlong",
      "category": "Subway Sandwiches",
      "prices": [
        {
          "price_group": "POS-AU-NAT",
          "amount": 14.40,
          "effective_from": "2025-01-01",
          "effective_to": null,
          "stores": [19598, 20260, 20334]
        }
      ]
    }
  ],
  "metadata": {
    "total_products": 150,
    "last_updated": "2025-01-13T10:15:00Z"
  }
}
----

**Rate Limiting:** 100 requests per hour per client

== Monitoring & Operations

=== Key Metrics

* **API Latency:** p50, p95, p99 response times (target: < 500ms p95)
* **API Error Rate:** 4xx and 5xx errors (target: < 1%)
* **ETL Success Rate:** Percentage of successful ETL runs (target: > 99%)
* **Data Freshness:** Time since last successful ETL run (alert: > 90 minutes)
* **Cache Hit Rate:** API Gateway cache effectiveness
* **RDS Performance:** CPU, memory, connections, slow queries

=== Alerting

* **P1 Alerts:** ETL pipeline failure, API error rate > 1%, no data for 90+ minutes
* **P2 Alerts:** API latency > 1s, RDS CPU > 80%, ETL validation failures

=== Operational Runbooks

See xref:solution-architectures:digital_menu_board.adoc#_appendix_c_runbooks[Solution Architecture - Appendix C: Runbooks] for detailed operational procedures.

== Related Documentation

* **Architecture Definition:** xref:architecture-definitions:digital_menu_board.adoc[Digital Menu Board Architecture Definition]
* **Solution Architecture:** xref:solution-architectures:digital_menu_board.adoc[Digital Menu Board Solution Architecture]
* **Domain Definition:** xref:domains:product_catalog.adoc[ProductCatalog Domain]
* **Domain CML Definition:** `domains/product_catalog.cml`
* **Bounded Context CML Definition:** `bounded_context/product_catalog.cml`
* **External Systems:** link:external/microsoft_dynamics_365_commerce.adoc[D365 Commerce]

== Document Control

[cols="1,2,2,4"]
|===
|Version |Date |Author |Changes

|0.1
|2025-01-13
|O.Young (Domain Architect, Ecommerce)
|Initial draft - ProductCatalogService bounded context definition
|===
