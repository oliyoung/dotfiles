= Loyalty Infrastructure Implementation
:description: Infrastructure layer implementation details for LoyaltyService
:keywords: infrastructure, aws, dynamodb, implementation, deployment, acl

== Overview

This document describes the **Infrastructure Layer** implementation for LoyaltyService, following xref:patterns:clean_architecture.adoc[Clean Architecture] principles.

**Separation of Concerns**:

- xref:../bounded-contexts/loyalty.adoc[Loyalty Bounded Context]: Domain model, business rules, ports (interfaces)
- xref:../application-layer/loyalty/use-cases.adoc[Application Layer Use Cases]: Use cases, application services, orchestration
- **This Document**: Concrete implementations, deployment architecture, infrastructure choices

== Infrastructure Adapters

Following the **Ports & Adapters** pattern, infrastructure layer implements interfaces defined in Application layer.

=== Repository Implementations

==== DynamoDB Reward Transaction Repository

**Port**: `IRewardTransactionRepository` (defined in Application layer)

**Adapter**: `DynamoDbRewardTransactionRepository` (Infrastructure layer)

**Responsibilities**:

- Implement domain repository interface using DynamoDB as document store
- Map between DynamoDB items and domain aggregates
- Provide idempotent write operations (conditional writes)
- Support query patterns for customer reward history

**Access Patterns**:

|===
|Access Pattern |DynamoDB Operation |Use Case

|Save transaction
|PutItem with conditional expression (idempotency)
|Record adjudication result after transaction processing

|Find by transaction ID
|GetItem on primary key
|Retrieve specific transaction details

|Find by customer ID
|Query on CustomerIdIndex (GSI)
|Display customer's reward history in mobile app

|Find by date range
|Scan with filter expression
|Administrative reporting and analytics (infrequent)
|===

**Idempotency Strategy**:

- Write uses conditional expression: "transaction ID does not exist"
- Duplicate writes silently succeed (safe retry behaviour)
- Observability metrics record both new writes and duplicate detections

**Translation Strategy**:

The adapter translates between two models:

- **DynamoDB Model**: Flat document with string/number/string-set attributes
- **Domain Model**: RewardTransaction aggregate with value objects and enums

This separation protects domain model from NoSQL document structure changes.

=== Anti-Corruption Layer (ACL) Implementations

==== EagleEye Loyalty Platform Adapter

**Port**: `ILoyaltyPlatformPort` (defined in Application layer)

**Adapter**: `EagleEyeLoyaltyPlatformAdapter` (Infrastructure layer)

**Purpose**: Protects LoyaltyService domain from EagleEye AIR platform data model and API changes.

**Integration Flow (Transaction Adjudication)**:

[source,mermaid]
----
sequenceDiagram
    participant UC as Use Case
    participant ACL as EagleEye ACL
    participant EE as EagleEye API
    participant Domain as Domain Model

    UC->>ACL: AdjudicateTransaction(request)
    ACL->>ACL: Translate OTR domain → EagleEye contract
    Note over ACL: CustomerId → identity.accountId<br/>LineItems → basket.contents<br/>StoreId → location

    ACL->>EE: POST /transaction/adjudicate
    EE-->>ACL: Adjudication response (JSON)

    ACL->>ACL: Translate EagleEye response → OTR domain
    Note over ACL: PointsAwarded → PointsEarned<br/>SchemesProcessed → SchemesParticipated<br/>GrantsIssued → domain events

    ACL->>Domain: Return AdjudicationResult (domain model)
    Domain-->>UC: Ready for persistence
----

**Translation Responsibilities**:

|===
|EagleEye Term |OTR Domain Term |Translation Rule

|identity.accountId
|CustomerId
|Extract from domain value object

|location
|StoreId
|Convert to integer store identifier

|basket.contents.sku
|LineItem.ProductId
|Direct mapping

|basket.contents.itemUnitCost
|LineItem.UnitPrice
|Convert to decimal

|PointsAwarded
|PointsEarned
|Direct mapping (terminology translation)

|SchemesProcessed
|SchemesParticipated
|Map scheme names: "FLYBUYS" → LoyaltyScheme.FLYBUYS, "OTR_INTERNAL" → LoyaltyScheme.INTERNAL_OTR

|GrantsIssued
|GrantId list
|Extract grant IDs for domain events

|OffersRedeemed
|OfferId list
|Extract offer IDs for domain events
|===

**API Operations**:

|===
|Port Method |EagleEye Endpoint |Purpose

|AdjudicateTransaction
|POST /transaction/adjudicate
|Process transaction and award points/grants

|GetPointsBalance
|GET /accounts/{accountId}/balance?scheme={scheme}
|Query points balance for specific loyalty scheme

|GetWallet
|GET /wallet/{accountId}
|Retrieve wallet contents (grants, offers, stored value)

|GetActiveCampaigns
|GET /campaigns/active?accountId={accountId}
|Query eligible campaigns for customer
|===

**Configuration**:

- **Base URL**: Retrieved from AWS Secrets Manager
- **Authentication**: OAuth 2.0 Client Credentials (token cached in Redis)
- **Timeout**: 10 seconds (with exponential backoff retry via Polly policies)
- **Circuit Breaker**: Half-open after 3 failures, reset after 30 seconds
- **Retry Policy**: 3 attempts with exponential backoff (1s, 2s, 4s)

==== Flybuys Partner Platform Adapter

**Port**: `IPartnerPlatformPort` (defined in Application layer)

**Adapter**: `FlybuysPartnerPlatformAdapter` (Infrastructure layer - Conformist pattern)

**Purpose**: Interface with Flybuys coalition loyalty partner API following their API contract (we conform to their model).

**API Operations**:

|===
|Port Method |Flybuys Endpoint |Purpose

|GetMemberId
|GET /oauth/userinfo (with Bearer token)
|Retrieve Flybuys member ID after OAuth linking flow

|ActivateAccount
|POST /partners/otr/activate
|Activate Flybuys account for OTR partner earning

|GetBalance
|GET /members/{memberId}/balance
|Query Flybuys points balance (current and pending)
|===

**Conformist Pattern Notes**:

- We accept Flybuys API contract without translation (simpler integration)
- Flybuys owns the API shape - we adapt to their terminology
- Minimal ACL layer - just HTTP client wrapper with error handling
- Domain logic in use cases translates to/from domain model as needed

**Authentication**:

- OAuth 2.0 Authorization Code flow (user consent required)
- Bearer token included in Authorization header
- Token managed by OAuth Service (infrastructure concern)

==== ProfileService Client

**Port**: `IProfileServicePort` (defined in Application layer)

**Adapter**: `ProfileServiceHttpClient` (Infrastructure layer - inter-service communication)

**Purpose**: Query customer context (reward preferences, partner links) from ProfileService bounded context.

**API Operations**:

|===
|Port Method |ProfileService Endpoint |Purpose

|GetCustomerContext
|GET /api/internal/v1/customers/{customerId}/context
|Retrieve customer reward preference and partner link status for adjudication

|GetPartnerLinks
|GET /api/internal/v1/customers/{customerId}/partner-links
|Query all partner account linkages (Flybuys, Shell, etc.)
|===

**Inter-Service Communication Pattern**:

- **Protocol**: HTTP/REST (synchronous)
- **Service Discovery**: AWS Cloud Map (production), hardcoded URL (development)
- **Authentication**: Internal service-to-service JWT (AWS Secrets Manager)
- **Timeout**: 5 seconds (faster than external APIs)
- **Retry**: 2 attempts with 500ms delay (bounded context within same infrastructure)
- **Circuit Breaker**: Disabled (ProfileService is critical dependency - fail fast preferred)

=== Infrastructure Service Implementations

==== EventBridge Event Bus

**Port**: `IEventBusPort` (defined in Application layer)

**Adapter**: `EventBridgeEventBus` (Infrastructure layer)

**Purpose**: Publish domain events to EventBridge for asynchronous consumption by other bounded contexts.

**Event Publishing Strategy**:

|===
|Aspect |Implementation

|Event Serialization
|Serialize domain event to JSON with camelCase property naming

|Event Source
|"LoyaltyService" (identifies origin for event filtering)

|Event Type
|Domain event type name (e.g., "PointsEarned", "PartnerLinked")

|Timestamp
|UTC timestamp when event published

|Failure Handling
|Throw exception if publish fails (use case should retry or compensate)

|Observability
|Record metric and log for each published event
|===

**EventBridge Configuration**:

- **Event Bus**: LoyaltyServiceEventBus (custom event bus)
- **Event Archive**: 30-day replay capability
- **Dead Letter Queue**: SQS queue for failed event processing
- **Schema Registry**: Event schemas registered for versioning

==== Redis Cache Implementation

**Port**: `ICachePort` (defined in Application layer)

**Adapter**: `RedisCacheAdapter` (Infrastructure layer)

**Purpose**: Provide distributed caching for frequently queried data (points balances, customer context) to reduce external API calls.

**Cache Strategy**:

|===
|Operation |Behaviour |Observability

|Get
|Retrieve value from Redis; deserialize from JSON; return null on miss
|Record Cache.Hit or Cache.Miss metric

|Set
|Serialize value to JSON; store in Redis with time-to-live
|Record Cache.Set metric
|===

**Cache Use Cases**:

- **Points Balance Queries**: Cache for 5 minutes (balance changes infrequently)
- **EagleEye OAuth Tokens**: Cache until expiry minus 5 minutes (avoid refresh on every call)
- **Customer Context**: Cache for 10 minutes (reward preference changes rare)

**Redis Configuration**:

- **Service**: Amazon ElastiCache for Redis (Cluster Mode)
- **Node Type**: cache.r6g.large (2 vCPU, 13.07 GiB RAM)
- **Cluster**: 2 shards, 1 replica per shard (HA)
- **Encryption**: In-transit (TLS) and at-rest
- **Backup**: Daily snapshots, 7-day retention

==== CloudWatch Observability

**Port**: `IObservabilityPort` (defined in Application layer)

**Adapter**: `CloudWatchObservability` (Infrastructure layer)

**Purpose**: Provide structured logging and custom metrics for operational visibility.

**Logging Strategy**:

|===
|Log Level |Use Case |Destination

|Information
|Successful operations, transaction adjudication, partner linking events
|CloudWatch Logs (standard output)

|Warning
|External API timeouts, cache unavailability, retryable errors
|CloudWatch Logs (standard error)

|Error
|Transaction adjudication failures, unhandled exceptions, data consistency issues
|CloudWatch Logs (standard error) + CloudWatch Alarms
|===

**Metrics Strategy**:

- **Namespace**: `LoyaltyService` (custom namespace for service-specific metrics)
- **Dimensions**: Environment (dev/staging/prod), Region (ap-southeast-2)
- **Publishing**: Fire-and-forget (asynchronous, non-blocking)
- **Aggregation**: CloudWatch aggregates metrics per minute for dashboard display

== Database Schema (DynamoDB)

=== RewardTransactions Table

**Table Name**: `LoyaltyService-RewardTransactions`

**Primary Key**:

- **Partition Key**: `TransactionId` (String) - Unique transaction identifier
- **Sort Key**: None (single-item access pattern)

**Global Secondary Indexes**:

. **CustomerIdIndex**:
   - **Partition Key**: `CustomerId` (String)
   - **Sort Key**: `TransactionDate` (String, ISO 8601)
   - **Projection**: ALL
   - **Use Case**: Query customer's reward history

**Attributes**:

[source,json]
----
{
  "TransactionId": "string",          // PK: e.g., "TXN-2025-01-21-ABC123"
  "CustomerId": "string",             // GSI PK: Viva Consumer ID
  "TransactionDate": "string",        // GSI SK: ISO 8601 timestamp
  "PointsEarned": "number",           // Points awarded in this transaction
  "SchemesParticipated": ["string"],  // ["FLYBUYS", "INTERNAL_OTR"]
  "ItemCount": "number",              // Number of items in basket
  "ItemSummary": "string",            // Human-readable summary: "2 items - Fuel, Coffee"
  "SourceTransactionId": "string"     // Reference to POS transaction
}
----

**Capacity**:

- **Provisioned**: On-demand (auto-scaling)
- **Expected Load**: 100K transactions/day (avg 1.2 TPS, peak 10 TPS)
- **Item Size**: ~500 bytes per transaction
- **Storage**: ~1.5 GB/month growth

**Point-in-Time Recovery**: Enabled (35-day retention)

**TTL**: Not configured (retain all transaction history for audit)

== AWS Service Configuration

=== ECS Fargate Deployment

**Cluster**: `LoyaltyService-Production`

**Service**: `LoyaltyService`

**Task Definition**:

[source,yaml]
----
family: LoyaltyService
cpu: 1024              # 1 vCPU
memory: 2048           # 2 GB
networkMode: awsvpc
requiresCompatibilities: [FARGATE]

containerDefinitions:
  - name: loyalty-service
    image: 123456789012.dkr.ecr.ap-southeast-2.amazonaws.com/loyalty-service:latest
    essential: true
    portMappings:
      - containerPort: 8080
        protocol: tcp
    environment:
      - name: ASPNETCORE_ENVIRONMENT
        value: Production
      - name: AWS_REGION
        value: ap-southeast-2
    secrets:
      - name: EagleEye__ApiKey
        valueFrom: arn:aws:secretsmanager:ap-southeast-2:123456789012:secret:loyalty/eagleeye-api-key
      - name: Flybuys__ClientSecret
        valueFrom: arn:aws:secretsmanager:ap-southeast-2:123456789012:secret:loyalty/flybuys-client-secret
    healthCheck:
      command: ["CMD-SHELL", "curl -f http://localhost:8080/health || exit 1"]
      interval: 30
      timeout: 5
      retries: 3
      startPeriod: 60
    logConfiguration:
      logDriver: awslogs
      options:
        awslogs-group: /ecs/LoyaltyService
        awslogs-region: ap-southeast-2
        awslogs-stream-prefix: ecs
----

**Auto Scaling**:

- **Target Metric**: CPU Utilization
- **Target Value**: 70%
- **Min Tasks**: 2
- **Max Tasks**: 10
- **Scale-out Cooldown**: 60 seconds
- **Scale-in Cooldown**: 300 seconds

=== Application Load Balancer

**Type**: Application Load Balancer (ALB)

**Scheme**: Internet-facing

**Target Group**:

- **Protocol**: HTTP
- **Port**: 8080
- **Health Check**: `/health` endpoint
- **Deregistration Delay**: 30 seconds

**Listener Rules**:

. **HTTPS:443**: Forward to LoyaltyService target group
. **HTTP:80**: Redirect to HTTPS

**SSL Certificate**: AWS Certificate Manager (ACM) - `*.api.otr.com.au`

=== API Gateway

**Type**: HTTP API (lower cost, simpler than REST API)

**Integrations**:

- **Backend**: ALB (VPC Link)
- **Base Path**: `/loyalty/v1`

**Authorization**:

- **Type**: JWT Authorizer
- **Issuer**: Microsoft Entra External ID (CIAM)
- **Audience**: `api://loyalty-service`

**Rate Limiting**:

- **Throttle**: 1000 requests/second (burst: 2000)
- **Per-Client Quota**: 10,000 requests/day

**CORS Configuration**:

[source,yaml]
----
allowOrigins:
  - https://app.otr.com.au
  - https://app-staging.otr.com.au
allowMethods:
  - GET
  - POST
  - PUT
  - DELETE
allowHeaders:
  - Authorization
  - Content-Type
maxAge: 3600
----

=== AWS Secrets Manager

**Secrets**:

. **loyalty/eagleeye-api-key**: EagleEye API authentication
. **loyalty/flybuys-client-secret**: Flybuys OAuth client secret
. **loyalty/dynamodb-credentials**: DynamoDB access (if cross-account)
. **loyalty/redis-password**: ElastiCache Redis authentication

**Rotation**:

- **EagleEye API Key**: Manual rotation (vendor-managed)
- **Flybuys Client Secret**: 90-day automatic rotation (Lambda rotator)
- **Redis Password**: Manual rotation (rare)

== Observability

=== CloudWatch Metrics

**Custom Metrics** (Namespace: `LoyaltyService`):

. **Transaction Processing**:
   - `Transaction.Adjudicated` - Count of successful adjudications
   - `Transaction.Failed` - Count of failed adjudications
   - `Transaction.Latency` - P50, P95, P99 latency

. **Points Operations**:
   - `Points.Earned` - Total points earned (sum)
   - `Points.BalanceQuery` - Balance query count
   - `Points.QueryLatency` - Balance query latency

. **Partner Integration**:
   - `Flybuys.ApiCall` - Count of Flybuys API calls
   - `Flybuys.ApiError` - Count of Flybuys errors
   - `EagleEye.ApiCall` - Count of EagleEye API calls
   - `EagleEye.ApiError` - Count of EagleEye errors

. **Cache Performance**:
   - `Cache.Hit` - Cache hit count
   - `Cache.Miss` - Cache miss count
   - `Cache.HitRate` - Calculated hit rate percentage

. **Domain Events**:
   - `DomainEvent.Published` - Count of events published
   - `DomainEvent.Failed` - Count of failed event publishes

**CloudWatch Dashboards**:

. **Transaction Dashboard**: Real-time transaction adjudication metrics
. **Partner Integration Dashboard**: EagleEye and Flybuys API health
. **Cache Performance Dashboard**: Redis hit rates and latency

=== CloudWatch Logs

**Log Groups**:

. `/ecs/LoyaltyService` - Application logs
. `/aws/lambda/LoyaltyService-EventProcessor` - Event processing logs
. `/aws/apigateway/LoyaltyService` - API Gateway access logs

**Log Retention**: 90 days (compliance requirement)

**Log Insights Queries**:

. **Failed Transactions**:
+
[source,sql]
----
fields @timestamp, transactionId, errorMessage
| filter @message like /Transaction adjudication failed/
| sort @timestamp desc
| limit 100
----

. **Slow Queries**:
+
[source,sql]
----
fields @timestamp, operation, duration
| filter duration > 1000
| sort duration desc
| limit 50
----

=== X-Ray Distributed Tracing

**Enabled Services**:

- API Gateway
- ECS Fargate tasks
- DynamoDB
- Lambda functions (event processors)

**Trace Sampling**: 10% of requests (cost optimization)

**Service Map**: Visualizes dependencies between LoyaltyService, EagleEye, Flybuys, ProfileService

== Security

=== WAF (Web Application Firewall)

**Rules**:

. **Rate Limiting**: 100 requests/5 minutes per IP
. **Geographic Restriction**: Allow Australia and New Zealand only
. **Known Bad Inputs**: AWS Managed Rules - Core Rule Set
. **SQL Injection**: AWS Managed Rules - SQL database protection
. **Bot Control**: AWS Managed Rules - Bot Control

=== IAM Roles

**ECS Task Execution Role**:

- Pull Docker images from ECR
- Write logs to CloudWatch Logs
- Read secrets from Secrets Manager

**ECS Task Role**:

- Read/Write DynamoDB `RewardTransactions` table
- Publish events to EventBridge
- Read/Write ElastiCache Redis cluster
- Put metrics to CloudWatch

=== Network Security

**VPC Configuration**:

- **Private Subnets**: ECS Fargate tasks, ElastiCache
- **Public Subnets**: Application Load Balancer
- **NAT Gateway**: Outbound internet access from private subnets

**Security Groups**:

. **ALB Security Group**:
   - Inbound: HTTPS (443) from anywhere
   - Outbound: HTTP (8080) to ECS tasks

. **ECS Task Security Group**:
   - Inbound: HTTP (8080) from ALB
   - Outbound: HTTPS (443) to internet (EagleEye, Flybuys)
   - Outbound: 6379 to ElastiCache

. **ElastiCache Security Group**:
   - Inbound: 6379 from ECS tasks only

== Disaster Recovery

=== Backup Strategy

**DynamoDB**:

- **Point-in-Time Recovery**: Enabled (35-day retention)
- **On-Demand Backups**: Weekly full backup to S3 (90-day retention)
- **Cross-Region Replication**: Disabled (cost optimization, acceptable RPO)

**ElastiCache**:

- **Daily Snapshots**: 4:00 AM AEST
- **Retention**: 7 days
- **Cross-AZ Replication**: Enabled (automatic failover)

=== Recovery Objectives

**RTO (Recovery Time Objective)**: 4 hours

**RPO (Recovery Point Objective)**: 1 hour (acceptable data loss)

**Business Continuity**:

- LoyaltyService is NOT critical for in-store purchases (POS can operate offline)
- Critical for mobile app experience (degraded mode: show cached data)

=== Runbook: Restore from Backup

. **DynamoDB Table Restore**:
+
[source,bash]
----
aws dynamodb restore-table-from-backup \
  --target-table-name LoyaltyService-RewardTransactions \
  --backup-arn arn:aws:dynamodb:ap-southeast-2:123456789012:table/LoyaltyService-RewardTransactions/backup/01234567890123-abcdefgh
----

. **ElastiCache Cluster Restore**:
+
[source,bash]
----
aws elasticache create-cache-cluster \
  --cache-cluster-id loyalty-service-redis-restored \
  --snapshot-name loyalty-service-redis-snapshot-2025-01-21 \
  --cache-node-type cache.r6g.large \
  --engine redis
----

. **Update ECS Service** to point to restored resources (environment variables)

. **Verify Health**: Check `/health` endpoint and CloudWatch metrics

== Cost Optimization

=== Monthly Cost Estimate (Production)

[width="100%",cols="40%,30%,30%",options="header"]
|===
|Service |Configuration |Estimated Monthly Cost (AUD)

|**ECS Fargate**
|2-10 tasks @ 1 vCPU, 2 GB
|$100 - $500

|**DynamoDB**
|On-demand, 100K writes/day
|$50

|**ElastiCache Redis**
|2 shards, cache.r6g.large
|$400

|**Application Load Balancer**
|1 ALB, 100M requests/month
|$30

|**EventBridge**
|1M events/month
|$1

|**CloudWatch**
|Logs (10 GB/month), Metrics, Dashboards
|$50

|**Secrets Manager**
|4 secrets
|$4

|**Data Transfer**
|10 GB/month (EagleEye, Flybuys API calls)
|$10

|**Total**
|
|**$645 - $1,045/month**
|===

**Cost Optimization Strategies**:

. **ElastiCache Sizing**: Largest cost component - consider smaller instance type
. **DynamoDB On-Demand**: Suitable for variable workload (vs provisioned capacity)
. **CloudWatch Logs**: Use Log Insights queries sparingly (cost per GB scanned)
. **X-Ray Sampling**: 10% sampling reduces cost vs 100% tracing

== Deployment Pipeline

**CI/CD Tool**: GitHub Actions

**Pipeline Stages**:

. **Build**: Compile C# code, run unit tests
. **Security Scan**: Snyk vulnerability scanning
. **Docker Build**: Build Docker image, push to ECR
. **Deploy to Staging**: Update ECS service (staging environment)
. **Integration Tests**: Run E2E tests against staging
. **Deploy to Production**: Blue/green deployment via ECS
. **Smoke Tests**: Verify production health checks

**Blue/Green Deployment**:

- Deploy new task definition
- ALB routes 10% traffic to new version (canary)
- Monitor metrics for 15 minutes
- If healthy: route 100% traffic, terminate old tasks
- If unhealthy: rollback to old task definition

== Related Documentation

- **Bounded Context**: xref:../bounded-contexts/loyalty.adoc[Loyalty Bounded Context]
- **Application Layer**: xref:../application-layer/loyalty/use-cases.adoc[Loyalty Use Cases]
- **Domain Definition**: xref:../domains/loyalty.adoc[Loyalty Domain]
- **Clean Architecture**: xref:patterns:clean_architecture.adoc[Clean Architecture Pattern]
- **External Systems**:
  * xref:../bounded-contexts/external/eagle_eye.adoc[EagleEye]
  * xref:../bounded-contexts/external/flybuys.adoc[Flybuys]

== Document Control

[cols="1,2,2,4"]
|===
|Version |Date |Author |Changes

|0.1
|2025-01-21
|O.Young (Domain Architect, Ecommerce)
|Initial infrastructure documentation - DynamoDB schema, ECS deployment, ACL adapters
|===
