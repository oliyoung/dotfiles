= OTR-2026-04 Flybuys Strategic Data Integration
:domain: Loyalty
:domain-architect: O.Young@otr.com.au
:project: OTR-2026-04
:status: In Progress
:status-icon: icon:hourglass-half[role=yellow]
:target-delivery: 2026-Q2
:confluence-spec: https://vivaenergy.atlassian.net/wiki/spaces/VER/pages/10172891188/DATA-SD-03-02-05+FlyBuys+Loyalty+Transaction+File+-+As+Build+In+Progress
:doctype: article
:toc: left
:toclevels: 3
:sectanchors:
:sectlinks:
:sectnums:
:icons: font
:source-highlighter: highlightjs
:experimental:

include::partial$_initiative_metadata.adoc[]

<<<
== Problem Statement

=== Current State Pain Points

The existing production data integration operates on a weekly manual/semi-automated schedule (D+7), where xref:entities:reddy_express.adoc[Reddy Express] transaction data is manually ingested by the xref:bounded-contexts:flybuys.adoc[Flybuys] Data team for their analytics and promotional systems. This creates several operational and partnership issues:

* *Manual Ingestion Process:* xref:bounded-contexts:flybuys.adoc[Flybuys] Data team manually processes xref:entities:reddy_express.adoc[Reddy Express] transaction files weekly, creating operational dependency and fragility
* *Stale Analytics Data:* xref:bounded-contexts:flybuys.adoc[Flybuys] receives transaction data 7 days after purchase (D+7), limiting their ability to run timely promotional analytics
* *Limited Brand Coverage:* Current integration only covers xref:entities:reddy_express.adoc[Reddy Express] stores; xref:entities:otrg.adoc[OTR] convenience store transactions not shared with xref:bounded-contexts:flybuys.adoc[Flybuys]
* *SLA Risk:* Weekly schedule doesn't meet xref:bounded-contexts:flybuys.adoc[Flybuys] partnership requirements for daily (D+1) data freshness for analytics
* *Promotional Constraints:* xref:bounded-contexts:flybuys.adoc[Flybuys] cannot run time-sensitive category promotions effectively with week-old transaction data
* *Partnership Friction:* Manual process creates coordination overhead between OTRG and xref:bounded-contexts:flybuys.adoc[Flybuys] Data teams

=== Business Impact

* *Partnership Risk:* xref:bounded-contexts:flybuys.adoc[Flybuys] SLA requires D+1 data freshness for their analytics; weekly schedule creates contractual breach exposure
* *Limited Marketing Effectiveness:* xref:bounded-contexts:flybuys.adoc[Flybuys] promotional analytics limited by stale transaction data (D+7); time-sensitive promotions cannot target recent purchase behaviour, reducing promotional ROI for coalition partnership
* *Missed Revenue Opportunity:* xref:entities:otrg.adoc[OTR] convenience store transactions (1000+ locations) not shared with xref:bounded-contexts:flybuys.adoc[Flybuys], missing coalition loyalty value and promotional reach across largest store network
* *Operational Dependency:* Manual ingestion process creates dependency on xref:bounded-contexts:flybuys.adoc[Flybuys] Data team availability; brittle process requiring coordination between teams
* *Promotional Fragmentation:* xref:bounded-contexts:flybuys.adoc[Flybuys] cannot run unified cross-brand promotions (xref:entities:reddy_express.adoc[Reddy Express] + xref:entities:otrg.adoc[OTR]) without complete transaction data coverage

=== Root Cause Analysis

The current weekly batch process was designed for manual ingestion by xref:bounded-contexts:flybuys.adoc[Flybuys] (legacy architecture from pre-2020 TSA). xref:bounded-contexts:flybuys.adoc[Flybuys] has since automated their ingestion pipeline, enabling daily processing, but OTRG still operates on the original weekly schedule.

The underlying causes:

* Original integration designed for xref:bounded-contexts:flybuys.adoc[Flybuys] manual ingestion capability (weekly batch acceptable at inception)
* xref:bounded-contexts:flybuys.adoc[Flybuys] platform evolution enabled automated ingestion (D+1 now supported), but OTRG integration not updated
* No automated daily orchestration configured in xref:bounded-contexts:azure_data_factory.adoc[Azure Data Factory] (current pipeline runs weekly)
* xref:ROOT:ubiquitous_language.adoc#sftp[SFTP] target location requires migration to new automated ingestion endpoint (<<TS-2>> requirement)
* xref:entities:otrg.adoc[OTR] convenience stores not included in original scope; requires data structure alignment and production-similar data availability

The root cause is that the integration was designed for xref:bounded-contexts:flybuys.adoc[Flybuys]'s legacy manual ingestion capability and hasn't evolved to match xref:bounded-contexts:flybuys.adoc[Flybuys]'s platform modernisation, resulting in partnership SLA risk and limited promotional effectiveness.

=== Why Now?

* *Flybuys Platform Ready:* xref:bounded-contexts:flybuys.adoc[Flybuys] automated ingestion platform now supports daily file processing (D+1)
* *SLA Requirements:* xref:bounded-contexts:flybuys.adoc[Flybuys] partnership contract specifies D+1 data freshness for optimal promotional analytics
* *OTR Convenience Expansion:* xref:initiatives:flybuys_integration.adoc[Flybuys Integration initiative] brings coalition loyalty to xref:entities:otrg.adoc[OTR] convenience stores (1000+ locations), requiring transaction data sharing at scale for xref:bounded-contexts:flybuys.adoc[Flybuys] promotions
* *Promotional Effectiveness Priority:* Enabling xref:bounded-contexts:flybuys.adoc[Flybuys] to run time-sensitive promotions based on recent purchase behaviour significantly improves coalition partnership value and promotional ROI
* *Operational Efficiency:* Eliminating manual ingestion dependency with xref:bounded-contexts:flybuys.adoc[Flybuys] Data team reduces coordination overhead and process fragility

=== Alternatives Considered

[cols="1,2,2"]
|===
| Alternative | Pros | Cons / Why Not Selected

| *Maintain weekly schedule*
| No change required; existing process stable
| Doesn't solve promotional effectiveness issue; SLA breach risk continues; blocks OTR convenience expansion; doesn't leverage Flybuys platform improvements

| *Real-time transaction streaming*
| Immediate data availability for Flybuys analytics; no batch delay
| Significantly more complex than daily batch; Flybuys analytics don't require real-time; operational overhead not justified by business requirements

| *Build new custom integration for OTR*
| OTR-specific optimisation possible
| Duplicates effort; creates two parallel pipelines to maintain; misses reuse opportunity; operational complexity

| *Selected: Daily automated SFTP with metadata-driven pipeline*
| Meets Flybuys SLA (D+1); leverages existing Reddy Express pipeline with configuration changes; reusable pattern for OTR convenience stores; simpler than real-time while meeting business requirements
| Still has D+1 latency (acceptable per requirements); requires SFTP target migration (<<TS-2>>>); OTR expansion contingent on production-similar data availability
|===

<<<
== What We're Building

The existing production data integration sends xref:bounded-contexts:flybuys.adoc[Flybuys] transaction and product hierarchy data from xref:entities:reddy_express.adoc[Reddy Express] stores to xref:bounded-contexts:flybuys.adoc[Flybuys] via xref:ROOT:ubiquitous_language.adoc#sftp[SFTP]. It does not include xref:entities:otrg.adoc[OTR] convenience transaction or product data.

These data workloads are currently manually ingested weekly (D+7) into xref:bounded-contexts:flybuys.adoc[Flybuys] data model by the xref:bounded-contexts:flybuys.adoc[Flybuys] Data team. This initiative supports automating the ingestion process, increasing frequency to daily (D+1), and migrating historical Coles/Reddy Express data to the new data model.

Currently operating on a weekly schedule, this initiative documents the as-is state and planned changes:

* Migrating from manual to automated daily (D+1) transfers (<<TS-2>>)
* Transitioning to daily transfers for xref:entities:reddy_express.adoc[Reddy Express] transaction and product data with updated xref:ROOT:ubiquitous_language.adoc#sftp[SFTP] configuration (<<TS-2>>)
* Expanding to daily transfers for xref:entities:otrg.adoc[OTR store], xref:entities:quick_service_restaurant.adoc[QSR], and xref:bounded-context:mobile.adoc[mobile application] transaction and product data (<<TS-3>>)

[cols="1,3"]
|===
| Feature | Description

| Daily transaction file export
| Automated daily extraction of xref:bounded-contexts:flybuys.adoc[Flybuys] member transactions from xref:bounded-contexts:microsoft_dynamics_365_commerce.adoc[D365 Commerce] via xref:bounded-contexts:microsoft_fabric.adoc[Microsoft Fabric] pipelines to SFTP

| Product hierarchy file export
| Daily export of xref:entities:reddy_express.adoc[Reddy Express] and xref:entities:otrg.adoc[OTR] product categorisation structure (4-level hierarchy) to support xref:bounded-contexts:flybuys.adoc[Flybuys] promotional analytics

| xref:ROOT:ubiquitous_language.adoc#sftp[SFTP] secure transfer
| Encrypted file transfer to xref:bounded-contexts:flybuys.adoc[Flybuys] xref:ROOT:ubiquitous_language.adoc#sftp[SFTP] server with daily scheduled delivery

| Pause/resume capability
| Ability to pause daily transfers during promotional periods or operational maintenance windows

| Multi-brand expansion ready
| Foundation to extend transaction sharing from xref:entities:reddy_express.adoc[Reddy Express] stores to xref:entities:otrg.adoc[OTR] convenience stores

| Outbound metadata framework
| Reusable xref:bounded-contexts:microsoft_fabric.adoc[Microsoft Fabric] pipeline pattern for partner data exports using metadata-driven configuration
|===

=== What we're not building

This initiative does not

* Change the process xref:bounded-contexts:flybuys.adoc[Flybuys] Points are allocated to xref:entities:reddy_express.adoc[Reddy Express] or xref:entities:otrg.adoc[OTRG] customers, or the ingestion process for the Points file
* Change xref:bounded-contexts:flybuys.adoc[Flybuys] Member data ingestion into xref:entities:otrg.adoc[OTRG] systems from xref:bounded-contexts:flybuys.adoc[Flybuys]
* Define xref:bounded-contexts:flybuys.adoc[Flybuys] platform's handling of received data


<<<
== Architecture Approach

This is a **Customer-Supplier integration** where xref:entities:otrg.adoc[OTRG] acts as the supplier (data provider) and xref:bounded-contexts:flybuys.adoc[Flybuys] is the customer (data consumer).

The solution conforms to xref:bounded-contexts:flybuys.adoc[Flybuys]' data format requirements and xref:ROOT:ubiquitous_language.adoc#sftp[SFTP] delivery mechanism, as they are the upstream partner in the coalition loyalty relationship.

The current architecture provides a repeatable pattern for sharing transactional data with external loyalty partners while maintaining clear boundaries: OTRG owns the data extraction and delivery; xref:bounded-contexts:flybuys.adoc[Flybuys] owns the consumption and analytics.

=== Design Principles

==== Back-office Native Tooling

Uses Azure-based xref:bounded-contexts:microsoft_fabric.adoc[Microsoft Fabric] and xref:bounded-contexts:azure_data_factory.adoc[Azure Data Factory] for data extraction, as xref:bounded-contexts:microsoft_dynamics_365_commerce.adoc[D365 Commerce] and transaction data reside in the Azure back-office domain.

==== Conform to Partner Requirements

Flybuys specifies the file format, delivery mechanism (SFTP), and scheduling.

The solution adapts to their integration contract rather than negotiating changes.

==== Daily Batch

Promotional analytics don't require real-time data.

Daily overnight batch processing (planned for <<TS-2>>) meets business requirements with simpler implementation than real-time streaming.

==== Metadata-driven configuration

Uses xref:bounded-contexts:microsoft_fabric.adoc[Microsoft Fabric]'s outbound metadata framework to make the pipeline reusable for other partners without code changes.

==== Encrypted transfer

Applies xref:ROOT:ubiquitous_language.adoc#pgp[PGP] encryption for files in transit to meet data security requirements for member transaction data.

=== xref:bounded-contexts:microsoft_fabric.adoc[Microsoft Fabric] Data Pipeline

Transaction and product data extraction pipeline (currently operational)

- Extracts xref:bounded-contexts:flybuys.adoc[Flybuys] member transactions from xref:bounded-contexts:microsoft_dynamics_365_commerce.adoc[D365 Commerce] (RAW layer)
- Joins with member lookup table to enrich with full xref:bounded-contexts:flybuys.adoc[Flybuys] card numbers
- Applies product hierarchy categorisation (4-level xref:entities:reddy_express.adoc[Reddy Express] product taxonomy)
- Generates two files per run, Transaction File and Product Hierarchy File
- Stores files in xref:bounded-contexts:azure_data_lake.adoc[Azure Data Lake Store] before xref:ROOT:ubiquitous_language.adoc#sftp[SFTP] transfer
- Metadata-driven configuration (workspace: `PRP_LH_CM_Raw`, notebook: `NB_CM_Outbound_FB_Trans_Extract`)

=== Azure Data Factory xref:ROOT:ubiquitous_language.adoc#sftp[SFTP] Integration

Secure file transfer orchestration (currently operational)

- Monitors xref:bounded-contexts:azure_data_lake.adoc[Azure Data Lake Store] locations for new transaction and product hierarchy files
- Encrypts files using xref:ROOT:ubiquitous_language.adoc#pgp[PGP] before transfer
- Transfers files to xref:bounded-contexts:flybuys.adoc[Flybuys] xref:ROOT:ubiquitous_language.adoc#sftp[SFTP] server via secure connection
- Current schedule: weekly (<<TS-2>> changes to daily)
- Pause/resume control mechanism using ] control flow activities
- Pipeline: `PL_CM_process_FB_Trans_outbound_extract`

=== Transaction Data Scope

Flybuys member transactions only

- Filters for transactions with xref:bounded-contexts:flybuys.adoc[Flybuys] barcode present (`fb.flybuysbarcode is not null`)
- Includes posted transactions (`entrystatus in (0,2)`)
- Sales transactions only (`type = 2`)
- Enriched with member lookup to provide full xref:bounded-contexts:flybuys.adoc[Flybuys] card number
- Captures discounts, GST, returns, tender types, and basket quantities

=== Product Hierarchy Data

Reddy Express product categorisation structure

- 4-level category hierarchy from D365 EcoRes product taxonomy
- Maps xref:entities:reddy_express.adoc[Reddy Express] products to Retail Product Category hierarchy
- Provides category codes and names at each level
- Supports xref:bounded-contexts:flybuys.adoc[Flybuys] promotional analytics and category-based offers

=== Integration Points

[cols="1,3"]
|===
| Integration | Description

| xref:bounded-contexts:microsoft_dynamics_365_commerce.adoc[D365 Commerce]
| Source system for transaction data (POS channel) and product hierarchy

| xref:bounded-contexts:microsoft_fabric.adoc[Microsoft Fabric]
| Data extraction and transformation pipelines

| xref:bounded-contexts:azure_data_lake.adoc[Azure Data Lake Store]
| Staging location for transaction and product hierarchy files before xref:ROOT:ubiquitous_language.adoc#sftp[SFTP] transfer

| xref:bounded-contexts:azure_data_factory.adoc[Azure Data Factory]
| xref:ROOT:ubiquitous_language.adoc#sftp[SFTP] orchestration, file encryption, scheduling, and control flow management

| xref:bounded-contexts:flybuys.adoc[Flybuys] xref:ROOT:ubiquitous_language.adoc#sftp[SFTP] Server
| Destination for daily transaction and product hierarchy files (external partner system)

| Member Lookup Table
| OTRG member data joined to enrich xref:bounded-contexts:flybuys.adoc[Flybuys] barcode with full card number
|===

<<<
== Key Capabilities Delivered

[cols="1,2,2"]
|===
| Capability | How It Works | Business Value

| *Daily Transaction Sharing*
| Automated xref:bounded-contexts:microsoft_fabric.adoc[Microsoft Fabric] pipeline extracts xref:bounded-contexts:flybuys.adoc[Flybuys] member transactions from xref:bounded-contexts:microsoft_dynamics_365_commerce.adoc[D365 Commerce] and transfers to Flybuys via xref:ROOT:ubiquitous_language.adoc#sftp[SFTP]
| Enables xref:bounded-contexts:flybuys.adoc[Flybuys] to attribute xref:entities:reddy_express.adoc[Reddy Express] purchases to member accounts, powering coalition loyalty points accrual

| *Product Hierarchy Export*
| Daily export of xref:entities:reddy_express.adoc[Reddy Express] product categorisation (4-level hierarchy) to support category-based promotions
| Allows xref:bounded-contexts:flybuys.adoc[Flybuys] to run targeted category promotions (e.g., "Earn 5x points on Beverages") at xref:entities:reddy_express.adoc[Reddy Express] stores

| *Pause/Resume Control*
| xref:bounded-contexts:azure_data_factory.adoc[Azure Data Factory] control flow allows xref:bounded-contexts:flybuys.adoc[Flybuys] or OTRG operations to pause daily transfers during promotional windows
| Operational flexibility to halt data flow during system maintenance or promotional campaign transitions

| *Encrypted File Transfer*
| xref:ROOT:ubiquitous_language.adoc#pgp[PGP] encryption applied before xref:ROOT:ubiquitous_language.adoc#sftp[SFTP] transfer to xref:bounded-contexts:flybuys.adoc[Flybuys] server
| Protects member transaction data in transit, meeting data security and privacy requirements

| *Multi-Brand Foundation*
| Metadata-driven pipeline design allows reuse for xref:entities:otrg.adoc[OTR] convenience stores with configuration changes only
| <<TS-3>> expansion will leverage existing pipelines without rebuilding; pattern applicable to future partners

| *Transaction Data Enrichment*
| Joins xref:bounded-contexts:flybuys.adoc[Flybuys] barcode with member lookup table to provide full card numbers and member identifiers
| Ensures xref:bounded-contexts:flybuys.adoc[Flybuys] receives complete member identifiers for accurate points attribution

| *Audit Trail & Monitoring*
| xref:bounded-contexts:microsoft_fabric.adoc[Microsoft Fabric] metadata framework logs pipeline execution, file generation, and xref:ROOT:ubiquitous_language.adoc#sftp[SFTP] transfer status
| Operations team has visibility into data delivery success/failure for troubleshooting and SLA compliance
|===

<<<
== Customer Journey

=== Transaction Data Flow (As-Is: D+7; TS-2: D+1)

. Customer with xref:bounded-contexts:flybuys.adoc[Flybuys] card shops at xref:entities:reddy_express.adoc[Reddy Express] and scans xref:bounded-contexts:flybuys.adoc[Flybuys] barcode at POS
. Transaction recorded in xref:bounded-contexts:microsoft_dynamics_365_commerce.adoc[D365 Commerce] with xref:bounded-contexts:flybuys.adoc[Flybuys] barcode linked
. *xref:bounded-contexts:microsoft_fabric.adoc[Microsoft Fabric] pipeline extracts xref:bounded-contexts:flybuys.adoc[Flybuys] member transactions* (as-is: D+7 Monday; <<TS-2>>: D+1)
. Pipeline joins with member lookup table to enrich with full xref:bounded-contexts:flybuys.adoc[Flybuys] card number
. *Transaction file and Product Hierarchy file generated* and stored in xref:bounded-contexts:azure_data_lake.adoc[Azure Data Lake Store]
. xref:bounded-contexts:azure_data_factory.adoc[Azure Data Factory] monitors xref:bounded-contexts:azure_data_lake.adoc[Azure Data Lake Store] for new files
. xref:bounded-contexts:azure_data_factory.adoc[Azure Data Factory] encrypts files using xref:ROOT:ubiquitous_language.adoc#pgp[PGP]
. *Files transferred to xref:bounded-contexts:flybuys.adoc[Flybuys] xref:ROOT:ubiquitous_language.adoc#sftp[SFTP] server* (as-is: current location; <<TS-2>>: new xref:ROOT:ubiquitous_language.adoc#sftp[SFTP] target)
. xref:bounded-contexts:flybuys.adoc[Flybuys] ingests files and attributes transactions to member accounts
. *Flybuys member earns coalition loyalty points* for xref:entities:reddy_express.adoc[Reddy Express] purchases

[mermaid]
----
sequenceDiagram
    actor Customer as Flybuys Member
    participant POS as D365 Commerce<br/>POS Channel
    participant Fabric as Microsoft Fabric<br/>Pipeline
    participant ADLS as Azure Data Lake<br/>Storage
    participant ADF as Azure Data Factory<br/>SFTP Pipeline
    participant SFTP as Flybuys<br/>SFTP Server
    participant Flybuys as Flybuys<br/>Platform

    Note over Customer,Flybuys: Daily Transaction Data Flow

    Customer ->> POS: Scan Flybuys barcode at checkout
    POS ->> POS: Record transaction with Flybuys barcode

    Note over Fabric,Flybuys: Daily Scheduled Export (01:00 UTC)
    Fabric ->> POS: Extract Flybuys member transactions (SQL query)
    Fabric ->> Fabric: Join with member lookup table
    Fabric ->> Fabric: Generate Transaction File + Product Hierarchy File
    Fabric ->> ADLS: Store files (Member_Transactions/ & Product_Hierarchy/)

    ADLS ->> ADF: Trigger SFTP pipeline (file watch)
    ADF ->> ADF: PGP encrypt files
    ADF ->> SFTP: Transfer encrypted files via SFTP
    SFTP ->> Flybuys: Ingest transaction and product data
    Flybuys ->> Flybuys: Attribute transactions to member accounts
    Flybuys -->> Customer: Award coalition loyalty points
----

=== Pause/Resume Control Flow

. xref:bounded-contexts:flybuys.adoc[Flybuys] or OTRG operations team requests pause of daily transfers
. Operations team accesses xref:bounded-contexts:azure_data_factory.adoc[Azure Data Factory] control mechanism
. *Daily xref:ROOT:ubiquitous_language.adoc#sftp[SFTP] transfer schedule paused* via xref:bounded-contexts:azure_data_factory.adoc[Azure Data Factory] control flow activity
. No files transferred during pause period (previous day's data held in xref:bounded-contexts:azure_data_lake.adoc[Azure Data Lake Store])
. Operations team resumes transfers when ready
. *xref:bounded-contexts:azure_data_factory.adoc[Azure Data Factory] pipeline resumes daily schedule*
. Backlog of files transferred (if applicable)

[mermaid]
----
sequenceDiagram
    actor Ops as Operations Team
    participant ADF as Azure Data Factory<br/>Control Flow
    participant ADLS as Azure Data Lake<br/>Storage
    participant SFTP as Flybuys<br/>SFTP Server

    Note over Ops,SFTP: Pause Request Scenario
    Ops ->> ADF: Request pause of daily transfers
    ADF ->> ADF: Update control flag (pause=true)
    Note over ADF,SFTP: Daily schedule runs but skip SFTP transfer
    ADF ->> ADLS: Files continue to accumulate

    Note over Ops,SFTP: Resume Request Scenario
    Ops ->> ADF: Request resume of daily transfers
    ADF ->> ADF: Update control flag (pause=false)
    ADF ->> ADLS: Check for backlog files
    alt Backlog exists
        ADF ->> SFTP: Transfer backlog files (catch-up)
    end
    ADF ->> SFTP: Resume daily scheduled transfers
----

<<<
== Implementation Phases

=== TS-0

[sidebar]
Completed Prior to This Initiative

Foundation Tooling

==== Capability

* xref:bounded-contexts:microsoft_fabric.adoc[Microsoft Fabric] pipeline development
* xref:bounded-contexts:microsoft_dynamics_365_commerce.adoc[D365 Commerce] data extraction, member lookup integration
* xref:bounded-contexts:azure_data_lake.adoc[Azure Data Lake Store] storage, metadata framework

==== Success Criteria

* Transaction and product hierarchy SQL queries validated
* xref:bounded-contexts:microsoft_fabric.adoc[Microsoft Fabric] notebook operational
* xref:bounded-contexts:azure_data_lake.adoc[Azure Data Lake Store] file storage configured

=== TS-1

[sidebar]
Completed Prior to This Initiative

Reddy Express Production

==== Capability
Reddy Express stores sending xref:bounded-contexts:flybuys.adoc[Flybuys] transaction data weekly via SFTP

==== Success Criteria
Weekly file transfers successful, xref:bounded-contexts:flybuys.adoc[Flybuys] ingestion validated, coalition points attribution working

=== TS-2

Automate xref:entities:reddy_express.adoc[Reddy Express] Daily transaction and product data ingestion

==== Capability

* xref:bounded-contexts:flybuys.adoc[Flybuys] makes changes to upload location and cadence
* OTRG updates xref:ROOT:ubiquitous_language.adoc#sftp[SFTP] target location and change cadence from weekly (D-7) to daily (D-1)
* xref:bounded-contexts:flybuys.adoc[Flybuys] begins automated ingestion using existing xref:entities:reddy_express.adoc[Reddy Express] manual feed as baseline
* Interface Dependency Agreement (IDA) for xref:entities:reddy_express.adoc[Reddy Express] data currently ingested manually for xref:bounded-contexts:flybuys.adoc[Flybuys] approval

==== Success Criteria

* Interface Dependency Agreement (IDA) approval received from Flybuys
* xref:ROOT:ubiquitous_language.adoc#ssh[SSH] key pair established for new xref:ROOT:ubiquitous_language.adoc#sftp[SFTP] user (create xref:ROOT:ubiquitous_language.adoc#ssh[SSH] private key and share linked public key with Flybuys)
* New xref:ROOT:ubiquitous_language.adoc#sftp[SFTP] location validated
* Zero data loss during migration
* xref:bounded-contexts:flybuys.adoc[Flybuys] confirms automated ingestion working
* Work effort is confirmed and aligns with dependency timeline
* Daily transfers operational by March 31st

=== TS-3

NOTE: PLANNED - Target: Post xref:initiatives:flybuys_integration.adoc[Flybuys Integration]

OTR Store Integration

==== Capability

Extend transaction data sharing to xref:entities:otrg.adoc[OTR] convenience stores (1000+ locations)
xref:entities:otrg.adoc[OTR] files aligned to same structure/attributes as xref:entities:reddy_express.adoc[Reddy Express] for consistency
discovery initiated with sample file containing dummy data

==== Success Criteria

* Product hierarchy extended to include xref:entities:otrg.adoc[OTR] convenience products
* No disruption to xref:entities:reddy_express.adoc[Reddy Express] data flow
* xref:entities:otrg.adoc[OTR] confirms ability to control data shape and align to xref:entities:reddy_express.adoc[Reddy Express] structure/attributes
* Delivery contingent on xref:entities:otrg.adoc[OTR] sample file with production-similar data availability (expected post-March production dates)
* Final timeline dependent on xref:entities:otrg.adoc[OTR] readiness and data availability
* Discovery validated with dummy data sample file
* OTR transactions flowing to Flybuys

<<<
== Non-Functional Requirements (Current & Target)

[cols="1,2,2"]
|===
| Requirement | Target | How We Achieve It

| *Data Freshness*
| As-is: Weekly (D-7); <<TS-2>> target: Daily (D-1 data delivered by 02:00 UTC)
| As-is: Weekly Monday schedule; <<TS-2>>: xref:bounded-contexts:microsoft_fabric.adoc[Microsoft Fabric] pipeline scheduled at 01:00 UTC daily; xref:ROOT:ubiquitous_language.adoc#sftp[SFTP] transfer completes within 1 hour; typical end-to-end processing time 45 minutes

| *Data Completeness*
| 100% of xref:bounded-contexts:flybuys.adoc[Flybuys] member transactions captured (zero data loss)
| SQL query filters on posted transactions (`entrystatus in (0,2)`); xref:bounded-contexts:microsoft_fabric.adoc[Microsoft Fabric] pipeline retry logic on transient failures; daily reconciliation report comparing transaction count vs POS count

| *SFTP Transfer Success Rate*
| As-is: 100% weekly transfers; Target: >99% daily transfers (<<TS-2>>)
| Current: retry logic with exponential backoff (3 retries, 5-15-30 minute intervals); automated alerts on failure; manual intervention playbook exists

| *Data Security*
| Encrypted in transit, secure xref:ROOT:ubiquitous_language.adoc#sftp[SFTP] access, member data protected
| xref:ROOT:ubiquitous_language.adoc#pgp[PGP] encryption applied before xref:ROOT:ubiquitous_language.adoc#sftp[SFTP] transfer; xref:bounded-contexts:flybuys.adoc[Flybuys] xref:ROOT:ubiquitous_language.adoc#sftp[SFTP] server requires xref:ROOT:ubiquitous_language.adoc#ssh[SSH] key authentication; no member PII beyond xref:bounded-contexts:flybuys.adoc[Flybuys] card number and transaction details

| *Scalability*
| As-is: xref:entities:reddy_express.adoc[Reddy Express] stores only; <<TS-3>> target: 1000+ xref:entities:otrg.adoc[OTR] convenience stores, 50k+ daily transactions
| Current architecture: xref:bounded-contexts:microsoft_fabric.adoc[Microsoft Fabric] pipeline scales horizontally; xref:bounded-contexts:azure_data_lake.adoc[Azure Data Lake Store] virtually unlimited; xref:ROOT:ubiquitous_language.adoc#sftp[SFTP] bandwidth sufficient for 50MB daily files (current typical size 5-10MB)

| *Operational Flexibility*
| Pause/resume capability, manual re-run of failed transfers
| ] control flow activities enable pause/resume; xref:bounded-contexts:microsoft_fabric.adoc[Microsoft Fabric] notebook can be manually triggered for specific date ranges; xref:bounded-contexts:azure_data_lake.adoc[Azure Data Lake Store] retains files for 90 days for reprocessing

| *Monitoring & Alerting*
| Pipeline failure alerts within 15 minutes, daily success/failure dashboard
| xref:bounded-contexts:microsoft_fabric.adoc[Microsoft Fabric] metadata framework logs execution status; xref:bounded-contexts:azure_data_factory.adoc[Azure Data Factory] monitoring with CloudWatch-equivalent alerts; operations dashboard shows daily transfer status and file counts

| *Data Residency*
| Transaction data stored in Australia (`ap-southeast-2` equivalent Azure region)
| xref:bounded-contexts:azure_data_lake.adoc[Azure Data Lake Store] and xref:bounded-contexts:microsoft_fabric.adoc[Microsoft Fabric] workspaces in Azure Australia East region; xref:bounded-contexts:microsoft_dynamics_365_commerce.adoc[D365 Commerce] production in Australia region; xref:ROOT:ubiquitous_language.adoc#sftp[SFTP] transfer to xref:bounded-contexts:flybuys.adoc[Flybuys] (Australian partner)
|===

<<<
== Risks & Mitigation (Current & Planned)

[cols="1,1,2"]
|===
| Risk | Impact | Mitigation

| *Dependency on xref:bounded-contexts:flybuys.adoc[Flybuys] Integration Iniatiative*
| Delay in integration xref:bounded-contexts:flybuys.adoc[Flybuys] to xref:entities:otrg.adoc[OTR] App and xref:entities:otrg.adoc[OTR] POS systems delays overall <<TS-3>> rollout
| Close collaboration with xref:bounded-contexts:flybuys.adoc[Flybuys] technical team; regular status updates; contingency planning for phased rollout

| *D365 Commerce data quality issues*
| Incomplete or incorrect transaction data sent to Flybuys
| SQL query validation in development; daily reconciliation report comparing transaction count and total sales value vs POS reporting; automated alerts on data anomalies (e.g., zero transactions on non-holiday weekday)

| *xref:bounded-contexts:microsoft_fabric.adoc[Microsoft Fabric] pipeline failures*
| Transfer missed, xref:bounded-contexts:flybuys.adoc[Flybuys] members don't receive points timely
| Current mitigation: xref:bounded-contexts:microsoft_fabric.adoc[Microsoft Fabric] pipeline retry logic; automated alerts to operations team; manual re-run capability; SLA with xref:bounded-contexts:flybuys.adoc[Flybuys] allows D+2 delivery for failed D+1 transfers

| *SFTP connectivity issues*
| Files not delivered to xref:bounded-contexts:flybuys.adoc[Flybuys] server
| Current mitigation: xref:bounded-contexts:azure_data_factory.adoc[Azure Data Factory] retry logic with exponential backoff; automated alerts; xref:bounded-contexts:azure_data_lake.adoc[Azure Data Lake Store] retains files for 90 days for manual re-transfer; xref:bounded-contexts:flybuys.adoc[Flybuys] operations contact established for server-side issues

| *Member lookup table data lag*
| New xref:bounded-contexts:flybuys.adoc[Flybuys] members missing from enrichment join, incomplete card numbers
| Member lookup table refreshed daily before transaction pipeline runs; fallback to xref:bounded-contexts:flybuys.adoc[Flybuys] barcode if full card number unavailable (Flybuys can resolve during ingestion)

| *OTR product hierarchy mapping gaps (TS-3 risk)*
| xref:entities:otrg.adoc[OTR] convenience products not correctly categorised for xref:bounded-contexts:flybuys.adoc[Flybuys] promotions
| Planned mitigation: Pilot phase validation with 5-10 convenience stores; product hierarchy mapping review with xref:bounded-contexts:flybuys.adoc[Flybuys] before full rollout; fallback to generic "Convenience" category for unmapped products

| *OTR sample data availability delays (TS-3 risk)*
| Production-similar data for xref:entities:otrg.adoc[OTR] not available until post-, blocking <<TS-3>> timeline validation and discovery
| Planned mitigation: Two-phase approach - initial discovery with dummy data sample file provided by xref:entities:otrg.adoc[OTR] team; full validation and pilot contingent on production-similar data availability (expected April-May); xref:entities:otrg.adoc[OTR] confirms data structure/attributes can be aligned with xref:entities:reddy_express.adoc[Reddy Express] to reduce integration complexity; timeline flexibility built into <<TS-3>> planning to accommodate data readiness dependency

| *SFTP target migration failures (<<TS-2>> risk)*
| Data loss or duplication during xref:ROOT:ubiquitous_language.adoc#sftp[SFTP] location cutover; xref:ROOT:ubiquitous_language.adoc#ssh[SSH] key configuration issues preventing authentication
| Planned mitigation: Parallel run for 7 days (send to both old and new xref:ROOT:ubiquitous_language.adoc#sftp[SFTP] locations); xref:bounded-contexts:flybuys.adoc[Flybuys] confirms receipt at new location before disabling old location; rollback plan retains old xref:ROOT:ubiquitous_language.adoc#sftp[SFTP] configuration; xref:ROOT:ubiquitous_language.adoc#ssh[SSH] key pair generation and testing in non-production environment before production cutover; public key shared with xref:bounded-contexts:flybuys.adoc[Flybuys] for new xref:ROOT:ubiquitous_language.adoc#sftp[SFTP] user setup; Interface Dependency Agreement (IDA) for xref:entities:reddy_express.adoc[Reddy Express] data shared with xref:bounded-contexts:flybuys.adoc[Flybuys] for approval to ensure data contract alignment

| *Pause mechanism misconfiguration*
| Transfers paused unintentionally, or resume forgotten
| Current mitigation: xref:bounded-contexts:azure_data_factory.adoc[Azure Data Factory] control flow activity with explicit enable/disable flag; operations runbook with checklist; automated alert planned if pause duration exceeds 7 days (requires approval for extended pause)

| *Data volume growth exceeding xref:ROOT:ubiquitous_language.adoc#sftp[SFTP] limits*
| Large file sizes cause xref:ROOT:ubiquitous_language.adoc#sftp[SFTP] transfer timeouts or failures
| Monitor file size trends; compress files if size exceeds 100MB; negotiate with xref:bounded-contexts:flybuys.adoc[Flybuys] for alternative transfer mechanism (e.g., Azure Blob Storage) if xref:ROOT:ubiquitous_language.adoc#sftp[SFTP] proves insufficient
|===

<<<
== Key Decisions Made

[cols="1,2,2"]
|===
| Decision | Rationale | Trade-off Accepted

| *xref:bounded-contexts:microsoft_fabric.adoc[Microsoft Fabric] platform (not AWS)*
| xref:bounded-contexts:microsoft_dynamics_365_commerce.adoc[D365 Commerce] and transaction data reside in Azure back-office domain; xref:bounded-contexts:microsoft_fabric.adoc[Microsoft Fabric] native integration with D365 data
| Cross-cloud complexity if future AWS-based loyalty services need this data (<<TS-3>> may require Azure → AWS data pipeline)

| *xref:ROOT:ubiquitous_language.adoc#sftp[SFTP] delivery mechanism (not API)*
| xref:bounded-contexts:flybuys.adoc[Flybuys] specifies xref:ROOT:ubiquitous_language.adoc#sftp[SFTP] as integration method; conformist pattern applies (we adapt to their requirements)
| No real-time data availability; daily batch latency (D+1 data); xref:ROOT:ubiquitous_language.adoc#sftp[SFTP] operational overhead vs API simplicity

| *Daily batch (not real-time)*
| xref:bounded-contexts:flybuys.adoc[Flybuys] promotional analytics don't require real-time data; daily batch simpler to implement and operate
| xref:bounded-contexts:flybuys.adoc[Flybuys] members see coalition points D+1 Day (not immediately after purchase); acceptable for coalition loyalty use case

| *Metadata-driven pipeline (not hardcoded)*
| Reusable pattern for future partners; configuration changes only for new partners
| Additional complexity in metadata framework setup; justified by multi-partner expansion roadmap

| *xref:ROOT:ubiquitous_language.adoc#pgp[PGP] encryption (not TLS-only)*
| xref:bounded-contexts:flybuys.adoc[Flybuys] requires xref:ROOT:ubiquitous_language.adoc#pgp[PGP]-encrypted files for data security compliance
| Operational overhead of xref:ROOT:ubiquitous_language.adoc#pgp[PGP] key management; acceptable for member transaction data protection

| *Weekly schedule (as-is) → Daily (<<TS-2>> change)*
| Initial production deployment used weekly schedule for pilot validation; daily schedule required for xref:bounded-contexts:flybuys.adoc[Flybuys] SLA and improved member experience
| Weekly schedule provides delayed points attribution; daily schedule increases operational load but meets business requirements

| *Customer-Supplier with Conformist pattern*
| xref:bounded-contexts:flybuys.adoc[Flybuys] is upstream partner controlling data format and delivery mechanism; we conform to avoid integration negotiation complexity
| Less control over data format and delivery mechanism; acceptable for coalition loyalty partnership

| *No Anti-Corruption Layer*
| Transaction data is generic (sales transactions); no Reddy Express-specific domain model requiring protection
| Direct coupling to xref:bounded-contexts:flybuys.adoc[Flybuys] data format; future format changes require pipeline updates; acceptable given stable xref:bounded-contexts:flybuys.adoc[Flybuys] API contract

| *Leverage existing xref:entities:reddy_express.adoc[Reddy Express] manual feed for <<TS-2>>*
| xref:entities:reddy_express.adoc[Reddy Express] manual feed already in place; xref:bounded-contexts:flybuys.adoc[Flybuys] can use it as baseline for automated ingestion setup; accelerates March 31st target date
| Dependency on xref:bounded-contexts:flybuys.adoc[Flybuys] partner to configure automated ingestion on their side; Interface Dependency Agreement (IDA) sharing required (manual ingestion did not have IDA); acceptable given partner confirms small work effort and timeline alignment

| *OTR data structure alignment with xref:entities:reddy_express.adoc[Reddy Express] (TS-3)*
| xref:entities:otrg.adoc[OTR] confirms ability to control data shape and align transaction/product hierarchy files to same structure/attributes as xref:entities:reddy_express.adoc[Reddy Express]
| Reduces integration complexity and testing effort; promotes operational consistency; xref:entities:otrg.adoc[OTR] inherits xref:entities:reddy_express.adoc[Reddy Express] data contract; acceptable given single pipeline codebase supports both brands with minimal configuration changes
|===

<<<
== Future Capacity Delivered

[cols="1,3"]
|===
| Stream | Capacity

| *Multi-Partner Data Sharing Pattern*
| Metadata-driven xref:bounded-contexts:microsoft_fabric.adoc[Microsoft Fabric] pipeline pattern reusable, future coalition partners, and promotional partners (AFL, Budget Direct)

| *OTR Store Transaction Visibility*
| <<TS-3>> establishes xref:entities:otrg.adoc[OTR] convenience store transaction data flow to external partners, enabling future coalition loyalty and promotional partnerships

| *Cross-Brand Product Hierarchy*
| Extended product categorisation framework supports xref:entities:reddy_express.adoc[Reddy Express] and xref:entities:otrg.adoc[OTR] convenience products in unified taxonomy

| *Data Export Foundation*
| xref:bounded-contexts:azure_data_lake.adoc[Azure Data Lake Store] and xref:bounded-contexts:microsoft_fabric.adoc[Microsoft Fabric] pipeline infrastructure reusable for other back-office data exports

| *Partner Integration Playbook*
| Operational runbooks and technical patterns documented for onboarding future loyalty and promotional partners with xref:ROOT:ubiquitous_language.adoc#sftp[SFTP] or API-based integrations

| *Azure-AWS Cross-Cloud Pattern*
| Establishes precedent for back-office (Azure) to customer-facing (AWS) data pipelines; <<TS-3>> may require xref:bounded-contexts:loyalty_service.adoc[LoyaltyService] integration on AWS to consume xref:bounded-contexts:flybuys.adoc[Flybuys] transaction data

| *Coalition Loyalty Expansion*
| Proves viability of coalition loyalty partnerships beyond Flybuys; opens strategic options for multi-brand loyalty programs across xref:entities:otrg.adoc[OTR] Group portfolio

| *Other Brands Integration*
| Extension of transaction data sharing to other xref:entities:otrg.adoc[OTR] Group brands beyond xref:entities:reddy_express.adoc[Reddy Express] and xref:entities:otrg.adoc[OTR] convenience stores; attribute/structure consistency maintained with xref:entities:reddy_express.adoc[Reddy Express] and xref:entities:otrg.adoc[OTR] for operational simplicity; requires separate Statement of Work when ready for ingestion
|===
