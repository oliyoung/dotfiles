#!/bin/bash

# Build script for converting AsciiDoc files to PDF
# Maintains folder structure under pdf/ directory

set -e  # Exit on error

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Get the script directory (repository root)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

# Configuration
THEME_FILE="asciidoc/theme.yml"
FONTS_DIR="asciidoc/fonts"
OUTPUT_DIR="pdf"

echo "=========================================="
echo "AsciiDoc to PDF Build Script"
echo "=========================================="

# Check if asciidoctor-pdf is installed
if ! command -v asciidoctor-pdf &> /dev/null; then
    echo -e "${RED}Error: asciidoctor-pdf is not installed${NC}"
    echo "Install with: gem install asciidoctor-pdf"
    exit 1
fi

# Check if asciidoctor-diagram is installed
if ! gem list -i asciidoctor-diagram &> /dev/null; then
    echo -e "${YELLOW}Warning: asciidoctor-diagram is not installed${NC}"
    echo "Install with: gem install asciidoctor-diagram"
    echo "Continuing without diagram support..."
fi

# Check if theme file exists
if [ ! -f "$THEME_FILE" ]; then
    echo -e "${YELLOW}Warning: Theme file not found at $THEME_FILE${NC}"
    echo "Continuing without custom theme..."
    THEME_ARG=""
else
    THEME_ARG="--theme $THEME_FILE"
fi

# Check if fonts directory exists
if [ ! -d "$FONTS_DIR" ]; then
    echo -e "${YELLOW}Warning: Fonts directory not found at $FONTS_DIR${NC}"
    echo "Continuing without custom fonts..."
    FONTS_ARG=""
else
    FONTS_ARG="-a pdf-fontsdir=$FONTS_DIR"
fi

# Create output directory
mkdir -p "$OUTPUT_DIR"

# Find all .adoc files
echo ""
echo "Finding AsciiDoc files..."
ADOC_FILES=$(find . -name "*.adoc" -type f | grep -v "./pdf/" | sort)
TOTAL_FILES=$(echo "$ADOC_FILES" | wc -l)

if [ -z "$ADOC_FILES" ]; then
    echo -e "${YELLOW}No AsciiDoc files found${NC}"
    exit 0
fi

echo "Found $TOTAL_FILES AsciiDoc file(s)"
echo ""

# Process each file
SUCCESS_COUNT=0
FAILURE_COUNT=0
FAILED_FILES=()

while IFS= read -r adoc_file; do
    # Remove leading ./
    adoc_file="${adoc_file#./}"

    # Get the directory and filename
    file_dir=$(dirname "$adoc_file")
    file_name=$(basename "$adoc_file" .adoc)

    # Create output directory structure
    output_subdir="$OUTPUT_DIR/$file_dir"
    mkdir -p "$output_subdir"

    # Output PDF path
    output_pdf="$output_subdir/$file_name.pdf"

    # Build the command
    CMD="asciidoctor-pdf"
    [ -n "$THEME_ARG" ] && CMD="$CMD $THEME_ARG"
    [ -n "$FONTS_ARG" ] && CMD="$CMD $FONTS_ARG"
    CMD="$CMD -r asciidoctor-diagram -o \"$output_pdf\" \"$adoc_file\""

    echo -e "${YELLOW}Processing:${NC} $adoc_file"

    # Execute the command
    if eval $CMD 2>&1; then
        echo -e "${GREEN}✓ Success:${NC} $output_pdf"
        SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
    else
        echo -e "${RED}✗ Failed:${NC} $adoc_file"
        FAILED_FILES+=("$adoc_file")
        FAILURE_COUNT=$((FAILURE_COUNT + 1))
    fi
    echo ""
done <<< "$ADOC_FILES"

# Summary
echo "=========================================="
echo "Build Summary"
echo "=========================================="
echo -e "${GREEN}Successful: $SUCCESS_COUNT${NC}"
echo -e "${RED}Failed: $FAILURE_COUNT${NC}"
echo "Total: $TOTAL_FILES"

if [ $FAILURE_COUNT -gt 0 ]; then
    echo ""
    echo "Failed files:"
    for failed_file in "${FAILED_FILES[@]}"; do
        echo "  - $failed_file"
    done
    exit 1
fi

echo ""
echo -e "${GREEN}All files processed successfully!${NC}"
echo "PDFs generated in: $OUTPUT_DIR/"
