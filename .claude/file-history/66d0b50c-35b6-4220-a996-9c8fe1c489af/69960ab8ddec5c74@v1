= Flybuys Integration - Solution Architecture
:project: OTR-002
:togaf-adm-phase: Phase D & E: Technology Architecture & Opportunities/Solutions
:document-type: Solution Architecture
:status: Design
:version: 0.2
:domain: Loyalty
:solution-architect: O.Young@otr.com.au
:architecture-definition: xref:architecture-definitions:flybuys_integration.adoc[Architecture Definition]
:initiative: xref:initiatives:flybuys_integration.adoc[Initiative Document]
:doctype: article
:toc: left
:toclevels: 4
:sectanchors:
:sectlinks:
:sectnums:
:icons: font
:source-highlighter: highlightjs
:experimental:
:description: Solution Architecture for Flybuys Integration - Technology selections and implementation specifications
:keywords: solution-architecture, technology, azure, implementation, flybuys

== Executive Summary

This Solution Architecture document specifies technology product selections and implementation details for the Flybuys Coalition Loyalty Integration.

**Scope:** Technology platform selections, infrastructure architecture, deployment specifications, operational procedures

**Related Documents:**

* **Architecture Definition:** xref:architecture-definitions:flybuys_integration.adoc[System architecture patterns and bounded contexts]
* **Initiative Document:** xref:initiatives:flybuys_integration.adoc[Business case and phased delivery plan]

== Technology Portfolio Catalogue

=== Azure Platform Services

[width="100%",cols="20%,20%,35%,25%",options="header",]
|===
|Capability | Azure Service | Rationale | Estimated Monthly Cost (AUD)

|**Event Messaging**
|Azure Event Hubs (Standard tier)
|At-least-once delivery, CloudEvents 1.0 support, 1M events/day capacity, consumer groups for multiple subscribers
|$300

|**API Hosting**
|Azure Functions (Premium Plan)
|Serverless autoscaling, VNet integration for private endpoints, 1-min cold start elimination
|$800 (2x P1V2 instances)

|**Secure Credential Storage**
|Azure Key Vault (Standard tier)
|AES-256 encryption, PCI DSS Level 1 compliant, customer-managed keys, audit logging
|$50

|**NoSQL Data Storage (Loyalty)**
|Azure Cosmos DB (Serverless)
|Partition key performance (VivaConsumerId), global distribution, TTL support (30-day RewardTransaction expiry)
|$200 (estimated 50K RU/month)

|**Relational Data Storage (Profile)**
|Azure SQL Database (S3 tier)
|ACID transactions for PartnerLink aggregate, relational integrity, backup/restore
|$200

|**Distributed Caching**
|Azure Cache for Redis (Basic C1)
|In-memory performance for Flybuys balance cache (5-min TTL), partner link status cache (10-min TTL)
|$50

|**API Gateway**
|Azure API Management (Developer tier)
|OAuth token validation, rate limiting (10K requests/min), request transformation, API versioning
|$150

|**Identity Platform**
|Microsoft Entra External ID (MAU pricing)
|OAuth 2.0, OIDC, social login, MFA, CIAM features, 50K MAU estimated
|$500 (50K MAU × $0.01/MAU)

|**Observability**
|Azure Application Insights (Standard)
|Distributed tracing, structured logging, correlation IDs, custom metrics, alerting
|$200

|**Batch File Storage**
|Azure Blob Storage (Hot tier)
|Transient CSV file storage (7-day retention), PGP-encrypted Flybuys batch files
|$20

|**Encryption Key Management**
|Azure Key Vault (Premium tier)
|Hardware Security Module (HSM), FIPS 140-2 Level 2, key rotation, audit logging
|$100
|===

**Total Azure Monthly Cost:** ~$2,570 AUD

=== SaaS Platform Licensing

[width="100%",cols="20%,25%,30%,25%",options="header",]
|===
|Platform | Pricing Model | Integration Pattern | Estimated Monthly Cost (AUD)

|**EagleEye AIR**
|Enterprise license (annual contract)
|ACL via REST API, webhooks for events
|$10,000 (annual ÷ 12)

|**Braze**
|Per-user pricing (MAU-based)
|ACL via track events (outbound), webhooks (inbound)
|$3,000 (50K MAU)

|**Flybuys**
|No licensing cost (partnership agreement)
|Conformist via REST API, SFTP for batch
|$0

|**Salesforce CRM**
|Existing license (shared cost)
|Conformist via REST API
|$0 (allocated to CRM budget)
|===

**Total SaaS Monthly Cost:** ~$13,000 AUD

**Total Infrastructure + SaaS Cost:** ~$15,570 AUD/month (~$187K AUD/year)

== Infrastructure Architecture

=== Compute Architecture

==== Azure Functions Configuration

**ProfileService:**

* **Plan:** Premium P1V2 (dedicated instance, VNet integration)
* **Runtime:** .NET 8 (LTS)
* **Scaling:** Autoscale 1-5 instances based on CPU >70%
* **Functions:**
  - `PartnerLinkFunction`: OAuth callback handler (HTTP trigger)
  - `ProfileQueryFunction`: Profile API endpoints (HTTP trigger)
  - `PartnerSyncFunction`: Daily partner sync (Timer trigger: 02:00 UTC)

**LoyaltyService:**

* **Plan:** Premium P1V2 (dedicated instance, VNet integration)
* **Runtime:** .NET 8 (LTS)
* **Scaling:** Autoscale 1-10 instances based on Event Hub queue length >1000
* **Functions:**
  - `TransactionAdjudicationFunction`: POS transaction adjudication (HTTP trigger)
  - `CredentialResolutionFunction`: Barcode resolution (HTTP trigger)
  - `BatchFileGenerationFunction`: Daily Flybuys batch (Timer trigger: 01:00 UTC)
  - `EagleEyeWebhookFunction`: EagleEye event translation (HTTP trigger)

**EngagementService:**

* **Plan:** Premium P1V2 (dedicated instance, VNet integration)
* **Runtime:** .NET 8 (LTS)
* **Scaling:** Autoscale 1-5 instances based on Event Hub consumer lag
* **Functions:**
  - `BrazeEventRouterFunction`: Loyalty events → Braze (Event Hub trigger)
  - `SurveyWebhookFunction`: Survey platform webhook (HTTP trigger)

==== Autoscaling Configuration

[source,json]
----
{
  "scalingRules": [
    {
      "metricName": "CpuPercentage",
      "metricThreshold": 70,
      "scaleAction": "Increase",
      "instanceCount": 1,
      "cooldown": "PT5M"
    },
    {
      "metricName": "EventHubQueueLength",
      "metricThreshold": 1000,
      "scaleAction": "Increase",
      "instanceCount": 2,
      "cooldown": "PT3M"
    }
  ],
  "minInstances": 1,
  "maxInstances": 10
}
----

=== Storage Architecture

==== Cosmos DB Configuration (LoyaltyService)

**Database:** `loyalty-db`

**Container:** `reward-transactions`

* **Partition Key:** `/vivaConsumerId` (customer-level partitioning for query performance)
* **TTL:** 30 days (automatic expiry for RewardTransaction aggregate)
* **Indexing Policy:** Custom index on `transactionDate`, `storeId`, `schemesParticipated`
* **Consistency Level:** Session (balance between consistency and performance)

**Estimated Throughput:**

* **Peak TPS:** 1,000 transactions/sec (10,000 RU/sec provisioned)
* **Storage:** 10 GB (30-day retention × 50K transactions/day × 6 KB/transaction)

[source,json]
----
{
  "indexingPolicy": {
    "indexingMode": "consistent",
    "includedPaths": [
      {"path": "/vivaConsumerId/?"},
      {"path": "/transactionDate/?"},
      {"path": "/storeId/?"},
      {"path": "/schemesParticipated/*"}
    ],
    "excludedPaths": [
      {"path": "/itemSummary/?"}
    ]
  },
  "defaultTtl": 2592000
}
----

==== Azure SQL Database Configuration (ProfileService)

**Database:** `profile-db` (S3 tier: 100 DTUs)

**Tables:**

* `CustomerProfiles`: OTR-specific profile attributes (50K rows)
* `PartnerLinks`: Partner linking status (10K active links)
* `RiskAssessments`: Customer risk scores (50K rows, updated daily)

**Backup Strategy:**

* **Point-in-time restore:** 7-day retention
* **Long-term backup:** Monthly snapshots (12-month retention)

=== Networking Architecture

==== Virtual Network Topology

[source,mermaid]
----
graph TB
    Internet["Internet"]
    APIM["Azure API Management<br/>Public Endpoint"]
    VNet["VNet: otr-loyalty-vnet<br/>10.0.0.0/16"]

    subgraph "App Subnet: 10.0.1.0/24"
        ProfileFn["ProfileService<br/>Functions"]
        LoyaltyFn["LoyaltyService<br/>Functions"]
        EngagementFn["EngagementService<br/>Functions"]
    end

    subgraph "Data Subnet: 10.0.2.0/24"
        CosmosDB["Cosmos DB<br/>Private Endpoint"]
        AzureSQL["Azure SQL<br/>Private Endpoint"]
        Redis["Redis Cache<br/>Private Endpoint"]
    end

    subgraph "Integration Subnet: 10.0.3.0/24"
        EventHub["Event Hub<br/>Private Endpoint"]
        KeyVault["Key Vault<br/>Private Endpoint"]
    end

    Internet-->APIM
    APIM-->ProfileFn
    APIM-->LoyaltyFn
    ProfileFn-->CosmosDB
    ProfileFn-->AzureSQL
    LoyaltyFn-->CosmosDB
    LoyaltyFn-->EventHub
    LoyaltyFn-->KeyVault
    EngagementFn-->EventHub
    LoyaltyFn-->Redis
----

==== Network Security Groups (NSG)

**App Subnet NSG:**

* Inbound: Allow HTTPS (443) from API Management only
* Outbound: Allow HTTPS (443) to data subnet, Event Hub, external APIs (EagleEye, Flybuys)

**Data Subnet NSG:**

* Inbound: Allow port 1433 (SQL), 10255 (Cosmos), 6379 (Redis) from app subnet only
* Outbound: Deny all (data layer doesn't initiate outbound)

=== Security Architecture

==== OAuth Token Management

**Token Storage:**

* **Location:** Azure Key Vault (Premium tier with HSM)
* **Encryption:** AES-256-GCM
* **Access Policy:** Managed Identity for ProfileService (least privilege)
* **Secret Naming:** `flybuys-token-{vivaConsumerId}`

**Token Lifecycle:**

1. **Acquisition:** OAuth Authorization Code Flow with PKCE
2. **Storage:** ProfileService stores token reference (Key Vault secret ID), not raw token
3. **Refresh:** Proactive refresh at 50-minute mark (tokens expire at 60 minutes)
4. **Revocation:** Delete secret from Key Vault, publish `PartnerUnlinked` event

[source,csharp]
----
// Pseudocode: Token Storage
public async Task<string> StoreOAuthToken(string vivaConsumerId, OAuthToken token)
{
    var secretName = $"flybuys-token-{vivaConsumerId}";
    var secretValue = JsonSerializer.Serialize(token);

    // Store in Key Vault with automatic expiry
    var secret = await _keyVaultClient.SetSecretAsync(
        vaultUri: "https://otr-loyalty-kv.vault.azure.net/",
        secretName: secretName,
        value: secretValue,
        tags: new Dictionary<string, string> {
            { "partner", "FLYBUYS" },
            { "vivaConsumerId", vivaConsumerId }
        },
        contentType: "application/json"
    );

    return secret.Id; // Return Key Vault secret reference (not raw token)
}
----

==== Managed Identities

All Azure services use **System-Assigned Managed Identities** for service-to-service authentication (no stored credentials).

[width="100%",cols="25%,35%,40%",options="header",]
|===
|Service | Managed Identity | Access Granted To

|ProfileService Functions
|profile-svc-identity
|Key Vault (secrets/read), Azure SQL (db_datareader, db_datawriter), Event Hub (sender)

|LoyaltyService Functions
|loyalty-svc-identity
|Cosmos DB (read/write), Event Hub (sender), Redis Cache (read/write), Key Vault (secrets/read for Flybuys OAuth)

|EngagementService Functions
|engagement-svc-identity
|Event Hub (receiver/consumer group), Blob Storage (read for survey attachments)
|===

== Detailed Sequence Diagrams (Error Scenarios)

=== OAuth Partner Linking - Error Scenarios

==== Scenario 1: Authorization Denied by Customer

[source,mermaid]
----
sequenceDiagram
    autonumber
    actor Customer
    participant Mobile as Mobile App
    participant Profile as ProfileService
    participant Flybuys as Flybuys OAuth

    Customer->>Mobile: Tap "Link Flybuys"
    Mobile->>Mobile: Generate PKCE code verifier
    Mobile->>Flybuys: Redirect to OAuth authorize
    Flybuys-->>Customer: Show login page
    Customer->>Flybuys: Enter credentials
    Flybuys-->>Customer: Show consent screen

    Customer->>Flybuys: Tap "Deny" (user cancels)

    Flybuys->>Mobile: Redirect with error<br/>?error=access_denied&state=yyy
    Mobile->>Mobile: Parse error parameter
    Mobile-->>Customer: "You cancelled Flybuys linking.<br/>You can try again anytime."

    Note over Mobile: NO API call to ProfileService<br/>(user-initiated cancellation)
    Note over Mobile: Analytics event:<br/>OAuthLinkingCancelled
----

**Outcome:** User-friendly message, no error logged (expected user behavior).

==== Scenario 2: Token Exchange Failure (Invalid Code)

[source,mermaid]
----
sequenceDiagram
    autonumber
    actor Customer
    participant Mobile as Mobile App
    participant Profile as ProfileService
    participant Flybuys as Flybuys OAuth
    participant Logs as Application Insights

    Customer->>Flybuys: Approve consent
    Flybuys->>Mobile: Redirect with code<br/>?code=AUTH_CODE&state=yyy
    Mobile->>Profile: POST /partners<br/>{oauthCode, codeVerifier}

    Profile->>Flybuys: POST /token<br/>{code, code_verifier}
    Flybuys-->>Profile: 400 Bad Request<br/>{error: "invalid_grant"}

    Profile->>Logs: Log error with correlation ID
    Profile-->>Mobile: 400 Bad Request<br/>{error: "OAUTH_TOKEN_EXCHANGE_FAILED"}

    Mobile-->>Customer: "Flybuys linking failed.<br/>Please try again."

    Note over Mobile: Retry button available<br/>Max 3 retries before support contact
----

**Outcome:** Customer can retry. Operations team alerted if error rate >5%.

==== Scenario 3: Partner Already Linked (Duplicate Linking Attempt)

[source,mermaid]
----
sequenceDiagram
    autonumber
    participant Mobile as Mobile App
    participant Profile as ProfileService
    participant DB as Profile Database

    Mobile->>Profile: POST /partners<br/>{oauthCode, externalMemberId: "123"}

    Profile->>DB: Query PartnerLink<br/>WHERE vivaConsumerId = {vci}<br/>AND partner = FLYBUYS
    DB-->>Profile: PartnerLink found (status: LINKED)

    Profile->>Profile: Check invariant:<br/>"Only one active link per partner"
    Profile-->>Mobile: 409 Conflict<br/>{error: "PARTNER_ALREADY_LINKED"}

    Mobile-->>Customer: "Your Flybuys account is already linked.<br/>Unlink first to link a different account."
----

**Outcome:** Enforce business invariant. Clear user guidance.

=== Transaction Adjudication - Error Scenarios

==== Scenario 4: ProfileService Timeout (Partner Link Query)

[source,mermaid]
----
sequenceDiagram
    autonumber
    participant POS as POS Terminal
    participant Loyalty as LoyaltyService
    participant Profile as ProfileService
    participant CircuitBreaker as Circuit Breaker
    participant Logs as Application Insights

    POS->>Loyalty: POST /transactions/adjudicate

    Loyalty->>Profile: GET /partners?vci={vci}<br/>Timeout: 2 seconds

    Note over Profile: ProfileService overloaded<br/>Response time >2 seconds

    Profile--xLoyalty: Timeout (no response)

    Loyalty->>CircuitBreaker: Record failure
    CircuitBreaker->>CircuitBreaker: Increment error count (5/10 threshold)

    Loyalty->>Logs: Log timeout with correlation ID

    Loyalty->>Loyalty: Fallback: Default preference<br/>rewardPreference = OTR_REWARDS

    Loyalty-->>POS: {status: "SUCCESS_FALLBACK",<br/>rewardPreference: "OTR_REWARDS",<br/>message: "Flybuys unavailable, earned OTR points"}

    POS-->>Customer: Receipt: "Earned 100 OTR points<br/>(Flybuys temporarily unavailable)"
----

**Outcome:** Graceful degradation. Customer still earns rewards (OTR native). Alert sent to operations team.

==== Scenario 5: EagleEye Circuit Breaker Open

[source,mermaid]
----
sequenceDiagram
    autonumber
    participant POS as POS Terminal
    participant Loyalty as LoyaltyService
    participant CircuitBreaker as Circuit Breaker
    participant EagleEye as EagleEye API
    participant Logs as Application Insights

    Note over CircuitBreaker: Circuit breaker OPEN<br/>(EagleEye 10 consecutive failures)

    POS->>Loyalty: POST /transactions/adjudicate

    Loyalty->>CircuitBreaker: Check EagleEye circuit state
    CircuitBreaker-->>Loyalty: OPEN (do not call EagleEye)

    Loyalty->>Logs: Log circuit breaker open event

    Loyalty-->>POS: 503 Service Unavailable<br/>{error: "LOYALTY_ENGINE_UNAVAILABLE"}

    POS-->>Customer: "Loyalty rewards unavailable.<br/>Points will be credited later."

    Note over CircuitBreaker: After 30 seconds, attempt HALF_OPEN<br/>(test with single request)

    CircuitBreaker->>EagleEye: Test request
    EagleEye-->>CircuitBreaker: 200 OK
    CircuitBreaker->>CircuitBreaker: Transition to CLOSED<br/>(resume normal operations)
----

**Outcome:** Prevent cascading failure. Customer informed. Automatic recovery.

==== Scenario 6: Duplicate Transaction Detection

[source,mermaid]
----
sequenceDiagram
    autonumber
    participant POS as POS Terminal
    participant Loyalty as LoyaltyService
    participant Cache as Redis Cache
    participant Logs as Application Insights

    POS->>Loyalty: POST /transactions/adjudicate<br/>{transactionId: "TXN-12345"}

    Loyalty->>Cache: GET transaction:{TXN-12345}
    Cache-->>Loyalty: Cache HIT (transaction processed 30 sec ago)

    Loyalty->>Logs: Log duplicate transaction attempt

    Loyalty-->>POS: 409 Conflict<br/>{error: "DUPLICATE_TRANSACTION",<br/>originalResult: {points: 150}}

    POS-->>Customer: Receipt: "150 Flybuys points<br/>(duplicate request ignored)"

    Note over POS: POS handles idempotency<br/>(displays original result)
----

**Outcome:** Idempotency guarantee. Prevent double-crediting points.

=== Batch File Processing - Error Scenarios

==== Scenario 7: SFTP Timeout with Retry Logic

[source,mermaid]
----
sequenceDiagram
    autonumber
    participant BatchJob as Batch Job Function
    participant Blob as Azure Blob Storage
    participant SFTP as Flybuys SFTP
    participant Logs as Application Insights
    participant Alerts as PagerDuty

    Note over BatchJob: Daily job triggered: 01:00 UTC

    BatchJob->>BatchJob: Generate CSV file (10K transactions)
    BatchJob->>BatchJob: PGP encrypt with Flybuys public key
    BatchJob->>Blob: Store encrypted file (7-day retention)

    BatchJob->>SFTP: PUT /inbound/otr-20260119.csv.pgp<br/>Timeout: 5 minutes

    Note over SFTP: SFTP server timeout<br/>(network congestion)

    SFTP--xBatchJob: Timeout (no response)

    BatchJob->>Logs: Log SFTP timeout (attempt 1/12)

    Note over BatchJob: Wait 5 minutes (exponential backoff)

    BatchJob->>SFTP: PUT /inbound/otr-20260119.csv.pgp<br/>(retry attempt 2/12)
    SFTP-->>BatchJob: 200 OK (upload successful)

    BatchJob->>Logs: Log successful transmission (attempt 2)
    BatchJob->>Blob: Tag file as "TRANSMITTED"
----

**Outcome:** Automatic retry with exponential backoff. Successful transmission within retry window.

==== Scenario 8: Partial Batch Rejection by Flybuys

[source,mermaid]
----
sequenceDiagram
    autonumber
    participant BatchJob as Batch Job Function
    participant SFTP as Flybuys SFTP
    participant Flybuys as Flybuys Processing
    participant DB as Loyalty Database
    participant Alerts as PagerDuty

    BatchJob->>SFTP: PUT otr-20260119.csv.pgp (10K transactions)
    SFTP-->>BatchJob: 200 OK

    Note over Flybuys: Batch processing (2-4 hours)

    Flybuys->>Flybuys: Process transactions
    Flybuys->>Flybuys: Validate member IDs

    Note over Flybuys: 50 transactions rejected<br/>(invalid member IDs)

    Flybuys->>SFTP: PUT /outbound/otr-20260119-ACK.csv

    BatchJob->>SFTP: GET /outbound/otr-20260119-ACK.csv
    SFTP-->>BatchJob: ACK file:<br/>{successCount: 9950, rejectCount: 50}

    BatchJob->>DB: Update RewardTransaction status<br/>WHERE transactionId IN (rejected list)<br/>SET status = "BATCH_REJECTED"

    BatchJob->>Alerts: Alert operations team<br/>"50 transactions rejected by Flybuys"

    Note over Alerts: Operations team reviews rejected transactions<br/>Manual investigation required
----

**Outcome:** Failed transactions flagged. Operations team investigates root cause (invalid member IDs, partner unlinked).

== Deployment Architecture

=== Environment Strategy

[width="100%",cols="15%,20%,35%,30%",options="header",]
|===
|Environment | URL | Purpose | Data Characteristics

|**Development**
|dev.otr.com.au
|Active development, feature branches, integration testing
|Synthetic test data, anonymized production subset (GDPR-compliant)

|**UAT**
|uat.otr.com.au
|User acceptance testing, stakeholder demos, pre-production validation
|Production-like data (anonymized), Flybuys test accounts

|**Production**
|api.otr.com.au
|Live customer traffic
|Real customer data (PCI DSS, GDPR compliance required)
|===

=== CI/CD Pipeline

**Source Control:** GitHub (otr/loyalty-platform repository)

**Build Pipeline:** GitHub Actions

[source,yaml]
----
name: Build and Test
on:
  push:
    branches: [main, develop, feature/*]
  pull_request:
    branches: [main, develop]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Setup .NET 8
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'
      - name: Restore dependencies
        run: dotnet restore
      - name: Build
        run: dotnet build --no-restore --configuration Release
      - name: Run unit tests
        run: dotnet test --no-build --verbosity normal --configuration Release
      - name: Run integration tests
        run: dotnet test --filter Category=Integration
----

**Deployment Pipeline:** Azure DevOps Pipelines

1. **Build Artifacts:** Compile .NET functions, generate deployment packages
2. **Infrastructure Provisioning:** Terraform/Bicep templates for Azure resources
3. **Database Migrations:** Entity Framework migrations (ProfileService), Cosmos DB schema updates
4. **Feature Flag Configuration:** LaunchDarkly flag sync
5. **Function Deployment:** Blue-green deployment (zero downtime)
6. **Smoke Tests:** Post-deployment health checks
7. **Rollback Trigger:** Automated rollback if smoke tests fail

=== Feature Flag Deployment Matrix

See xref:initiatives:flybuys_integration.adoc[Initiative Document] for phased rollout details.

[width="100%",cols="30%,10%,10%,10%,10%,10%,20%",options="header",]
|===
|Flag Name | AS-1 | AS-2 | AS-3 | AS-4 | AS-5 | Rollout Strategy

|`OTR.Loyalty.Enabled`
|OFF
|**ON**
|ON
|ON
|ON
|Master switch, enabled in AS-2

|`OTR.Loyalty.PartnerLink.Flybuys`
|OFF
|**ON**
|ON
|ON
|ON
|Gradual: 1% → 10% → 50% → 100% over 2 weeks

|`OTR.Loyalty.RewardPreferenceSelection`
|OFF
|**ON**
|ON
|ON
|ON
|Enabled simultaneously with partner linking

|`OTR.Loyalty.TransactionAdjudication`
|OFF
|OFF
|**ON**
|ON
|ON
|Pilot: 10 stores → 100 stores → all stores (4 weeks)

|`OTR.Loyalty.PointsEarn.Flybuys`
|OFF
|OFF
|**ON**
|ON
|ON
|Enabled after successful adjudication pilot

|`OTR.Loyalty.FlybuysBatchPosting`
|OFF
|OFF
|OFF
|**ON**
|ON
|Parallel run with manual process (2 weeks validation)
|===

**Rollback Procedures:**

* **Instant Rollback:** Toggle flag OFF via LaunchDarkly dashboard (propagates in <30 seconds)
* **Monitoring Thresholds:** Automatic rollback if error rate >5% or latency >1000ms p95
* **Alert Channels:** PagerDuty → On-call engineer, Slack #incidents channel

== Operational Procedures

=== Monitoring & Alerting

==== Application Insights Configuration

**Distributed Tracing:**

* **Correlation IDs:** Generated at API Gateway, propagated through all services
* **Custom Dimensions:** `vivaConsumerId`, `transactionId`, `storeId`, `partner`
* **Dependencies Tracked:** EagleEye API, Flybuys API, ProfileService → LoyaltyService calls

**Custom Metrics:**

[source,csharp]
----
// Pseudocode: Custom Metrics
_telemetryClient.TrackMetric("TransactionAdjudicationLatency", latencyMs,
    new Dictionary<string, string> {
        { "storeId", storeId },
        { "rewardPreference", preference.ToString() }
    });

_telemetryClient.TrackMetric("FlybuysAPIAvailability", isSuccess ? 100 : 0,
    new Dictionary<string, string> {
        { "endpoint", "/members/balance" }
    });
----

==== Alert Rules

[width="100%",cols="35%,25%,20%,20%",options="header",]
|===
|Alert Name | Condition | Severity | Action

|**Transaction Adjudication Latency**
|p95 latency >500ms for 5 minutes
|**High**
|PagerDuty alert, auto-scale Functions

|**Flybuys API Availability**
|Error rate >5% for 2 minutes
|**Critical**
|PagerDuty alert, trigger circuit breaker

|**Batch File Transmission Failure**
|SFTP upload fails after 12 retries (1 hour)
|**Critical**
|PagerDuty alert, manual intervention required

|**OAuth Linking Failure Rate**
|Failure rate >10% for 10 minutes
|**Medium**
|Slack notification, investigate Flybuys OAuth

|**Cosmos DB RU Throttling**
|429 errors >10 requests/minute
|**Medium**
|Auto-scale RUs, alert if budget exceeded
|===

=== Incident Response

==== On-Call Rotation

* **Primary:** Domain Architect (O.Young)
* **Secondary:** Solution Architect (TBD)
* **Escalation:** CTO (if incident >2 hours unresolved)

==== Runbooks

**Runbook 1: Flybuys API Unavailable**

1. Check Application Insights for error details (correlation ID, error message)
2. Verify circuit breaker state (should be OPEN after 10 consecutive failures)
3. Check Flybuys status page: https://status.flybuys.com.au
4. If Flybuys outage confirmed:
   - Update status page: "Flybuys balance queries temporarily unavailable"
   - Monitor circuit breaker for automatic recovery (HALF_OPEN after 30 sec)
5. If Flybuys operational but errors persist:
   - Check network connectivity (Azure VNet, NSG rules)
   - Review Flybuys API credentials (Key Vault secret expiry)
6. Escalate to Flybuys support if unresolved after 30 minutes

**Runbook 2: Batch File Transmission Failure**

1. Check Blob Storage for encrypted CSV file (`/loyalty-batch/otr-YYYYMMDD.csv.pgp`)
2. Verify SFTP connection: `sftp -o StrictHostKeyChecking=no flybuys@sftp.flybuys.com.au`
3. If SFTP unreachable:
   - Check Azure NSG rules (outbound port 22 allowed)
   - Verify Flybuys SFTP server status (contact Flybuys support)
4. If file corrupted:
   - Re-generate batch file from Cosmos DB transactions (previous day)
   - Validate PGP encryption (Flybuys public key not expired)
5. Manual upload fallback:
   - Download file from Blob Storage
   - Upload via SFTP client (manual process)
   - Notify operations team of manual intervention

=== Batch Job Monitoring

==== Daily Batch Health Dashboard

**Metrics Tracked:**

* Batch file generation success rate (target: 100%)
* SFTP transmission success rate (target: 99.9%)
* Flybuys acknowledgement file processing (target: within 4 hours)
* Transaction count reconciliation (CSV vs Cosmos DB)

**Operations Team Access:** Power BI dashboard (refreshed hourly)

== Performance Specifications

=== Transaction Adjudication

[width="100%",cols="30%,35%,35%",options="header",]
|===
|Metric | Target | Measurement Method

|**Latency (p50)**
|<200ms
|Application Insights custom metric: `TransactionAdjudicationLatency`

|**Latency (p95)**
|<500ms
|Application Insights custom metric: `TransactionAdjudicationLatency` (95th percentile)

|**Latency (p99)**
|<1000ms
|Application Insights custom metric: `TransactionAdjudicationLatency` (99th percentile)

|**Throughput**
|1,000 TPS peak
|Azure Functions autoscaling (10 instances × 100 TPS/instance)

|**Error Rate**
|<1%
|Application Insights failures (HTTP 5xx, EagleEye timeout)

|**Availability**
|99.9% uptime
|Application Insights availability tests (synthetic monitoring)
|===

=== OAuth Linking Flow

[width="100%",cols="30%,35%,35%",options="header",]
|===
|Metric | Target | Measurement Method

|**End-to-End Completion**
|<3 minutes
|Mobile app analytics (Tap "Link Flybuys" → "Linked successfully")

|**Token Exchange Latency**
|<2 seconds
|Application Insights: ProfileService → Flybuys `/token` API call

|**Success Rate**
|>95%
|Application Insights: 2xx responses ÷ total linking attempts

|**Retry Success Rate**
|>80%
|Application Insights: Successful on retry ÷ failed first attempts
|===

=== Batch Processing

[width="100%",cols="30%,35%,35%",options="header",]
|===
|Metric | Target | Measurement Method

|**File Generation Duration**
|<45 minutes
|Application Insights: Batch job start → CSV file in Blob Storage

|**SFTP Transmission Duration**
|<15 minutes
|Application Insights: Blob upload → SFTP acknowledgement

|**Transmission Success Rate**
|99.9%
|Application Insights: Successful uploads ÷ total attempts

|**Acknowledgement Processing**
|<4 hours
|Application Insights: SFTP upload → Flybuys ACK file processed
|===

== Cost Model

=== Azure Services Monthly Estimate (Detailed Breakdown)

[width="100%",cols="25%,30%,20%,25%",options="header",]
|===
|Service | Configuration | Quantity | Monthly Cost (AUD)

|Azure Functions (Premium)
|P1V2 (3.5 GB RAM, 1 vCPU)
|2 instances × $200
|$400

|Azure Event Hubs
|Standard tier, 1 throughput unit
|1M events/day
|$300

|Azure Cosmos DB
|Serverless, NoSQL API
|50K RU/month
|$200

|Azure SQL Database
|S3 tier, 100 DTUs
|Single database
|$200

|Azure Cache for Redis
|Basic C1 (1 GB)
|Single instance
|$50

|Azure API Management
|Developer tier
|Single instance
|$150

|Microsoft Entra External ID
|MAU pricing
|50K MAU × $0.01
|$500

|Azure Application Insights
|Standard tier
|50 GB ingestion/month
|$200

|Azure Blob Storage
|Hot tier
|10 GB × $0.02/GB
|$20

|Azure Key Vault
|Premium tier (HSM)
|10K operations/month
|$100

|Bandwidth (Egress)
|Data transfer out
|100 GB × $0.10/GB
|$10

|**Total Azure Cost**
|
|
|**$2,130**
|===

=== SaaS Platform Licensing (Annual Contracts)

[width="100%",cols="25%,30%,20%,25%",options="header",]
|===
|Platform | Pricing Model | Quantity | Monthly Cost (AUD)

|EagleEye AIR
|Enterprise license (annual)
|1 platform
|$10,000

|Braze
|Per MAU
|50K MAU × $0.06
|$3,000

|Flybuys
|Partnership (no cost)
|N/A
|$0

|Salesforce CRM
|Allocated to CRM budget
|N/A
|$0

|**Total SaaS Cost**
|
|
|**$13,000**
|===

=== Total Cost of Ownership (3-Year Projection)

**Year 1:**

* Azure: $2,130/month × 12 = $25,560
* SaaS: $13,000/month × 12 = $156,000
* **Total Year 1:** $181,560

**Year 2-3:** (Assuming 10% annual growth in usage)

* Azure: $25,560 × 1.1 = $28,116
* SaaS: $156,000 × 1.1 = $171,600
* **Total Year 2:** $199,716
* **Total Year 3:** $219,688

**3-Year TCO:** $181,560 + $199,716 + $219,688 = **$600,964**

**Cost per Transaction:** $600,964 ÷ (50K transactions/day × 365 days × 3 years) = **$0.11 AUD/transaction**

---

== Appendix: Technology Decision Log

=== Decision: Azure vs AWS

**Decision:** Azure selected as cloud platform.

**Rationale:**

* Existing Azure footprint (OTR back office on Azure)
* Microsoft Entra External ID for CIAM (seamless Azure AD integration)
* Azure SQL Database for ProfileService (relational integrity required)
* Organizational familiarity (infrastructure team Azure-certified)

**Trade-offs:**

* **Pro:** Simplified identity management, single cloud vendor, volume discounts
* **Con:** AWS Lambda pricing slightly cheaper than Azure Functions for low volume

=== Decision: Cosmos DB vs Azure SQL for LoyaltyService

**Decision:** Cosmos DB (NoSQL) selected for LoyaltyService.

**Rationale:**

* RewardTransaction aggregate has no relational integrity requirements (single aggregate)
* VivaConsumerId partition key enables customer-level query performance
* TTL support for 30-day automatic expiry (regulatory retention compliance)
* Horizontal scaling for peak TPS (1,000 transactions/sec)

**Trade-offs:**

* **Pro:** Partition key performance, global distribution, TTL automation
* **Con:** Higher cost than Azure SQL at low volume (serverless pricing mitigates)

=== Decision: Conformist vs ACL for Flybuys

**Decision:** Conformist pattern (no ACL) for Flybuys integration.

**Rationale:**

* Flybuys API is stable, mature, well-documented (OAuth 2.0 industry standard)
* Partnership time-bound (2-3 years), ACL maintenance overhead not justified
* API changes unlikely (Flybuys platform serves 8M+ members, breaking changes rare)

**Contingency:**

* If Flybuys API becomes unstable, implement ACL adapter in LoyaltyService
* Pattern already established for EagleEye (ACL reference implementation)

---

== Appendix: Cross-References

* **Architecture Definition:** xref:architecture-definitions:flybuys_integration.adoc[Flybuys Integration Architecture]
* **Initiative Document:** xref:initiatives:flybuys_integration.adoc[Flybuys Integration Initiative]
* **Bounded Contexts:**
  - xref:bounded-contexts:profile.adoc[ProfileService]
  - xref:bounded-contexts:loyalty.adoc[LoyaltyService]
  - xref:bounded-contexts:engagement.adoc[EngagementService]
