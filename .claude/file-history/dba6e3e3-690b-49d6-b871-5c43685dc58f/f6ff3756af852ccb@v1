#!/usr/bin/env python3
"""Fix JSON schema xrefs in flybuys_integration.adoc"""

import re

file_path = "solution_architectures/flybuys_integration.adoc"

with open(file_path, "r", encoding="utf-8") as f:
    content = f.read()

# Replace JSON schema xrefs - pattern: xref:ROOT:EventName.event.schema.json[text]
# Replace with just the event name in backticks
def replace_schema_xref(match):
    full_match = match.group(0)
    event_name = match.group(1)
    link_text = match.group(2)

    # If link_text is "Schema", just return event name
    if link_text == "Schema":
        return f"{event_name} event"
    # If link_text is the filename, return it in backticks
    elif link_text == f"{event_name}.event.schema.json":
        return f"`specifications/json_schemas/{event_name}.event.schema.json`"
    # Otherwise, return the link text
    else:
        return link_text

# Pattern to match xref:ROOT:EventName.event.schema.json[text]
pattern = r'xref:ROOT:([A-Za-z]+)\.event\.schema\.json\[([^\]]+)\]'
content = re.sub(pattern, replace_schema_xref, content)

# Also fix the standalone schema references (PartnerLink, RewardTransactionDocument, OAuthTokenStorageSchema)
standalone_schemas = [
    ('PartnerLink.schema.json', 'PartnerLink'),
    ('RewardTransactionDocument.schema.json', 'RewardTransactionDocument'),
    ('OAuthTokenStorageSchema.schema.json', 'OAuthTokenStorageSchema'),
]

for schema_file, schema_name in standalone_schemas:
    pattern = f'xref:ROOT:{schema_file}\\[([^\\]]+)\\]'
    replacement = f'`specifications/json_schemas/{schema_file}`'
    content = re.sub(pattern, replacement, content)

# Fix the malformed xref:ROOT:.md
content = content.replace('xref:ROOT:.md', 'specifications')

# Fix xref:ROOT:profile-service-v1.yaml.md and xref:ROOT:otr-event-bus-v1.yaml.md
content = content.replace('xref:ROOT:profile-service-v1.yaml.md', '`specifications/rest/profile-service-v1.yaml`')
content = content.replace('xref:ROOT:otr-event-bus-v1.yaml.md', '`specifications/async_api/otr-event-bus-v1.yaml`')

with open(file_path, "w", encoding="utf-8") as f:
    f.write(content)

print("Fixed all schema xrefs in flybuys_integration.adoc")
