openapi: 3.0.3
info:
  title: ProfileService API
  description: |
    ProfileService manages customer profiles and partner account linking for the OTR digital platform.

    **Key Responsibilities**:
    - Customer profile creation with Viva Consumer ID (VCI) from Salesforce
    - Salesforce Contact upsert using email as external key
    - EagleEye wallet provisioning during profile creation
    - Partner account linking (Flybuys, Shell Card) via OAuth 2.0 + PKCE
    - Reward preference management
    - Partner link status tracking

    **Important Notes**:
    - VCI (Viva Consumer ID) is provided by Salesforce during Contact upsert, not by clients or ProfileService
    - Profile creation uses email as the primary identifier
    - Profile creation is atomic (Salesforce upsert + EagleEye wallet provisioning succeed or fail together)
  version: 1.0.0
  contact:
    name: OTR Domain Architecture Team
    email: O.Young@otr.com.au

security:
  - AzureADB2C: []
servers:
  - url: https://api.otr.com.au/profile/v1
    description: Production
  - url: https://api-staging.otr.com.au/profile/v1
    description: Staging
  - url: https://api-dev.otr.com.au/profile/v1
    description: Development

tags:
  - name: Customer Profile
    description: Customer profile creation and management
  - name: Partner Links
    description: Partner account linking and preference management
  - name: Salesforce Integration
    description: Salesforce Contact reconciliation for support case management

paths:
  /contact-id:
    get:
      tags:
        - Salesforce Integration
      summary: Get Salesforce Contact ID for authenticated user
      description: |
        Retrieve or create Salesforce Contact ID for authenticated user (Just-In-Time reconciliation).

        **Use Cases**:
        - Mobile App retrieves Contact ID before submitting feedback to EngagementService
        - Ensures every user has a Salesforce Contact record for Case management
        - Supports Salesforce Service Cloud integration

        **Business Flow**:
        1. Extract email from Microsoft Entra External ID JWT token (authenticated user)
        2. Query Salesforce for Contact by email (upsert with email as external key)
        3. If Contact exists, return cached Contact ID (15-minute cache TTL)
        4. If Contact doesn't exist, create new Contact in Salesforce with email, firstName, lastName, phone from JWT claims
        5. Return Salesforce Contact ID to Mobile App

        **Caching Strategy**:
        - Contact ID cached for 15 minutes per user (reduces Salesforce API calls)
        - `cached: true` in response indicates Contact ID was served from cache
        - `cached: false` indicates fresh lookup/creation in Salesforce

        **Important Notes**:
        - This endpoint is called BEFORE EngagementService POST /feedback
        - Contact reconciliation is Just-In-Time (JIT) - happens on-demand, not during profile creation
        - Salesforce Service Cloud is the system of record for Contact data
        - ProfileService conforms to Salesforce API contracts (Conformist pattern)

        **Performance SLA**: p95 < 300ms (uncached), p95 < 50ms (cached)
      operationId: getSalesforceContactId
      responses:
        "200":
          description: Contact ID retrieved or created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SalesforceContactIdResponse"
              example:
                contactId: "0034X00000ABCDEFG"
                email: "customer@example.com"
                firstName: "John"
                lastName: "Smith"
                phone: "+61412345678"
                cached: false
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          description: Salesforce API failure
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "SALESFORCE_UNAVAILABLE"
                message: "Salesforce Contact upsert failed. Please try again later."
                retryAfter: 60

  /customers:
    post:
      tags:
        - Customer Profile
      summary: Create customer profile
      description: |
        Creates a new customer profile and retrieves VCI from Salesforce.
        Used by Just-In-Time Integration during customer login (AS-1 Foundation).
        Publishes CustomerProfileCreated event for downstream services (LoyaltyService creates wallet asynchronously).

        **Business Rules**:
        - Retrieves Viva Consumer ID (VCI) from Salesforce Contact upsert response
        - Upserts Salesforce Contact record using email as external key (creates if doesn't exist, updates if exists)
        - Publishes `CustomerProfileCreated` domain event (consumed by LoyaltyService for wallet creation)
        - Returns `409 Conflict` if profile already exists for this email (idempotent operation)
        - Transaction is atomic - if Salesforce upsert fails, entire transaction is rolled back

        **Event-Driven Flow**:
        - LoyaltyService subscribes to `CustomerProfileCreated` event and creates EagleEye wallet asynchronously
        - Mobile app can poll or subscribe for enrollment completion

        **Performance SLA**: p95 < 300ms (Salesforce upsert only, wallet creation is asynchronous)
      operationId: createCustomerProfile
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateCustomerProfileRequest"
            example:
              email: "customer@example.com"
              firstName: "John"
              lastName: "Smith"
              phone: "+61412345678"
              rewardPreference: "OTR_FUEL_DISCOUNT"
      responses:
        "201":
          description: Profile created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CustomerProfile"
              example:
                vivaConsumerId: "vci_xyz789abc"
                salesforceContactId: "003Dn000001234ABC"
                rewardPreference: "OTR_FUEL_DISCOUNT"
                createdAt: "2025-12-09T10:30:00Z"
                status: "ACTIVE"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "409":
          description: Customer profile already exists
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "PROFILE_ALREADY_EXISTS"
                message: "Customer profile already exists for this email"
                email: "customer@example.com"
                vivaConsumerId: "vci_xyz789abc"
        "503":
          description: External service unavailable (EagleEye or Salesforce)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                eagleEyeUnavailable:
                  value:
                    error: "EAGLEEYE_UNAVAILABLE"
                    message: "EagleEye wallet creation failed"
                    retryAfter: 60
                salesforceUnavailable:
                  value:
                    error: "SALESFORCE_UNAVAILABLE"
                    message: "Salesforce Contact upsert failed"
                    retryAfter: 60

  /customers/{vivaConsumerId}:
    get:
      tags:
        - Customer Profile
      summary: Get customer profile by VCI
      description: |
        Retrieves customer profile details by Viva Consumer ID.

        **Use Cases**:
        - LoyaltyService queries customer profile during transaction adjudication
        - Mobile app retrieves customer profile details
        - Internal services lookup customer information

        **Performance SLA**: p95 < 200ms
      operationId: getCustomerProfile
      parameters:
        - name: vivaConsumerId
          in: path
          required: true
          description: Viva Consumer ID
          schema:
            type: string
            pattern: "^vci_[a-zA-Z0-9]+$"
          example: "vci_xyz789abc"
      responses:
        "200":
          description: Customer profile retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CustomerProfile"
              example:
                vivaConsumerId: "vci_xyz789abc"
                salesforceContactId: "003Dn000001234ABC"
                rewardPreference: "FLYBUYS_POINTS"
                createdAt: "2025-12-09T10:30:00Z"
                status: "ACTIVE"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: Customer profile not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "CUSTOMER_NOT_FOUND"
                message: "Customer profile does not exist for this VCI"
                vivaConsumerId: "vci_xyz789abc"

    put:
      tags:
        - Customer Profile
      summary: Update customer profile
      description: |
        Updates customer profile details (email, firstName, lastName, phone).

        **Business Rules**:
        - VCI cannot be changed (immutable, provided by Salesforce)
        - Email changes trigger Salesforce Contact update
        - Profile must be in ACTIVE status to be updated
        - Publishes `CustomerProfileUpdated` domain event on success

        **Performance SLA**: p95 < 300ms (includes Salesforce Contact update)
      operationId: updateCustomerProfile
      parameters:
        - name: vivaConsumerId
          in: path
          required: true
          description: Viva Consumer ID
          schema:
            type: string
            pattern: "^vci_[a-zA-Z0-9]+$"
          example: "vci_xyz789abc"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateCustomerProfileRequest"
            example:
              email: "newemail@example.com"
              firstName: "John"
              lastName: "Smith"
              phone: "+61412345678"
      responses:
        "200":
          description: Profile updated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CustomerProfile"
              example:
                vivaConsumerId: "vci_xyz789abc"
                salesforceContactId: "003Dn000001234ABC"
                rewardPreference: "FLYBUYS_POINTS"
                createdAt: "2025-12-09T10:30:00Z"
                updatedAt: "2025-12-10T14:30:00Z"
                status: "ACTIVE"
        "400":
          description: Invalid request or profile not in ACTIVE status
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "INVALID_PROFILE_UPDATE"
                message: "Cannot update profile with CLOSED status"
                vivaConsumerId: "vci_xyz789abc"
                status: "CLOSED"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "503":
          description: Salesforce Contact update failed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "SALESFORCE_UNAVAILABLE"
                message: "Salesforce Contact update failed"
                retryAfter: 60

  /customers/{vivaConsumerId}/partners:
    get:
      tags:
        - Partner Links
      summary: Get customer's partner links
      description: |
        Retrieves all partner links for a customer by VCI.

        **Performance SLA**: p95 < 200ms
      operationId: getPartnerLinks
      parameters:
        - name: vivaConsumerId
          in: path
          required: true
          description: Viva Consumer ID
          schema:
            type: string
            pattern: "^vci_[a-zA-Z0-9]+$"
          example: "vci_xyz789abc"
      responses:
        "200":
          description: Partner links retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PartnerLinksResponse"
              example:
                vivaConsumerId: "vci_xyz789abc"
                partnerLinks:
                  - partnerLinkId: "550e8400-e29b-41d4-a716-446655440000"
                    partner: "FLYBUYS"
                    status: "LINKED"
                    externalMemberId: "123456789012"
                    linkedAt: "2025-12-09T10:30:00Z"
                    rewardPreference: "FLYBUYS_POINTS"
                  - partnerLinkId: "550e8400-e29b-41d4-a716-446655440001"
                    partner: "SHELL_CARD"
                    status: "LINKED"
                    externalMemberId: "SC123456"
                    linkedAt: "2025-11-15T14:20:00Z"
                    rewardPreference: "OTR_FUEL_DISCOUNT"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: Customer not found or has no partner links
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "CUSTOMER_NOT_FOUND"
                message: "Customer profile does not exist for this VCI"
                vivaConsumerId: "vci_xyz789abc"

  /customers/{vivaConsumerId}/status:
    put:
      tags:
        - Customer Profile
      summary: Update customer profile status
      description: |
        Updates customer profile status (ACTIVE, SUSPENDED, CLOSED).

        **Business Rules**:
        - SUSPENDED: Temporary deactivation, can be reactivated to ACTIVE
        - CLOSED: Permanent closure (GDPR right to erasure), cannot be reactivated
        - CLOSED status triggers data retention policy (90-day soft delete before purge)
        - Publishes `CustomerProfileStatusChanged` domain event on success
        - When status changes to CLOSED, all partner links are automatically unlinked

        **Use Cases**:
        - Customer account closure (GDPR right to erasure)
        - Temporary suspension for fraud prevention
        - Customer requests account deactivation

        **Performance SLA**: p95 < 300ms
      operationId: updateCustomerStatus
      parameters:
        - name: vivaConsumerId
          in: path
          required: true
          description: Viva Consumer ID
          schema:
            type: string
            pattern: "^vci_[a-zA-Z0-9]+$"
          example: "vci_xyz789abc"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateStatusRequest"
            example:
              status: "CLOSED"
              reason: "CUSTOMER_REQUEST"
      responses:
        "200":
          description: Status updated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StatusUpdateResponse"
              example:
                vivaConsumerId: "vci_xyz789abc"
                status: "CLOSED"
                previousStatus: "ACTIVE"
                updatedAt: "2025-12-10T15:00:00Z"
                reason: "CUSTOMER_REQUEST"
        "400":
          description: Invalid status transition
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                invalidTransition:
                  value:
                    error: "INVALID_STATUS_TRANSITION"
                    message: "Cannot change status from CLOSED to ACTIVE"
                    vivaConsumerId: "vci_xyz789abc"
                    currentStatus: "CLOSED"
                    requestedStatus: "ACTIVE"
                invalidStatus:
                  value:
                    error: "INVALID_STATUS"
                    message: "Invalid status value. Must be ACTIVE, SUSPENDED, or CLOSED"
                    requestedStatus: "INVALID"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"

  /partners:
    post:
      tags:
        - Partner Links
      summary: Initiate partner account linking
      description: |
        Initiates OAuth-based partner account linking (Flybuys, Shell Card).

        **Flow**:
        1. Mobile app redirects user to partner OAuth authorization page
        2. User authorizes, partner redirects back with authorization code
        3. Mobile app calls this endpoint with code + PKCE verifier
        4. ProfileService exchanges code for access token (stored in Azure Key Vault)
        5. ProfileService retrieves external member ID and creates PartnerLink

        **Business Rules** (reference Architecture Definition ADR-005):
        - Customer can only have one active link per partner
        - OAuth tokens stored in Azure Key Vault with 90-day retention
        - Publishes `PartnerLinked` domain event on success

        **Performance SLA**: p95 < 200ms
      operationId: createPartnerLink
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreatePartnerLinkRequest"
            example:
              vivaConsumerId: "VCI-123456789"
              partner: "FLYBUYS"
              oauthAuthorizationCode: "AUTH_CODE_FROM_FLYBUYS"
              codeVerifier: "PKCE_CODE_VERIFIER_12345678901234567890"
      responses:
        "201":
          description: Partner link created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PartnerLink"
              example:
                partnerLinkId: "550e8400-e29b-41d4-a716-446655440000"
                vivaConsumerId: "VCI-123456789"
                partner: "FLYBUYS"
                status: "LINKED"
                externalMemberId: "123456789012"
                linkedAt: "2025-12-09T10:30:00Z"
                rewardPreference: "FLYBUYS_POINTS"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "409":
          description: Partner already linked for this customer
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "PARTNER_ALREADY_LINKED"
                message: "Customer already has an active Flybuys link"
                vivaConsumerId: "VCI-123456789"
                partner: "FLYBUYS"
        "503":
          description: Partner OAuth service unavailable
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "PARTNER_SERVICE_UNAVAILABLE"
                message: "Flybuys OAuth service is temporarily unavailable"
                retryAfter: 60

  /partners/{partnerLinkId}/preference:
    put:
      tags:
        - Partner Links
      summary: Update reward preference
      description: |
        Updates the customer's reward preference for a specific partner link.

        **Business Rules** (reference Architecture Definition ADR-005):
        - Partner link must be in LINKED status
        - Preference change publishes `RewardPreferenceChanged` domain event

        **Performance SLA**: p95 < 200ms
      operationId: updateRewardPreference
      parameters:
        - name: partnerLinkId
          in: path
          required: true
          description: Partner Link ID (GUID)
          schema:
            type: string
            format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdatePreferenceRequest"
            example:
              rewardPreference: "FLYBUYS_POINTS"
      responses:
        "200":
          description: Preference updated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PreferenceUpdateResponse"
              example:
                partnerLinkId: "550e8400-e29b-41d4-a716-446655440000"
                rewardPreference: "FLYBUYS_POINTS"
                updatedAt: "2025-12-09T11:00:00Z"
        "400":
          description: Invalid preference or partner link not in LINKED status
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "INVALID_PREFERENCE_CHANGE"
                message: "Cannot change preference for unlinked partner"
                partnerLinkId: "550e8400-e29b-41d4-a716-446655440000"
                status: "UNLINKED"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"

  /partners/{partnerLinkId}:
    delete:
      tags:
        - Partner Links
      summary: Unlink partner account
      description: |
        Unlinks a partner account from the customer's profile.

        **Business Rules**:
        - Sets partner link status to UNLINKED
        - OAuth tokens remain in Azure Key Vault (soft delete, 90-day retention)
        - Publishes `PartnerUnlinked` domain event

        **Performance SLA**: p95 < 200ms
      operationId: unlinkPartner
      parameters:
        - name: partnerLinkId
          in: path
          required: true
          description: Partner Link ID (GUID)
          schema:
            type: string
            format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
      responses:
        "204":
          description: Partner unlinked successfully
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"

components:
  securitySchemes:
    AzureADB2C:
      type: oauth2
      flows:
        authorizationCode:
          authorizationUrl: https://otrviva.b2clogin.com/otrviva.onmicrosoft.com/oauth2/v2.0/authorize?p=B2C_1A_SIGNUP_SIGNIN
          tokenUrl: https://otrviva.b2clogin.com/otrviva.onmicrosoft.com/oauth2/v2.0/token?p=B2C_1A_SIGNUP_SIGNIN
          scopes:
            https://otrviva.onmicrosoft.com/profile-api/profile.read: Read profile data
            https://otrviva.onmicrosoft.com/profile-api/profile.write: Write profile data

  schemas:
    SalesforceContactIdResponse:
      type: object
      properties:
        contactId:
          type: string
          pattern: "^[a-zA-Z0-9]{18}$"
          description: Salesforce Contact ID (18-character)
          example: "0034X00000ABCDEFG"
        email:
          type: string
          format: email
          description: Customer email address from JWT token
          example: "customer@example.com"
        firstName:
          type: string
          description: Customer first name from JWT claims or Salesforce Contact
          example: "John"
        lastName:
          type: string
          description: Customer last name from JWT claims or Salesforce Contact
          example: "Smith"
        phone:
          type: string
          description: Customer phone number from JWT claims or Salesforce Contact (E.164 format)
          example: "+61412345678"
        cached:
          type: boolean
          description: Whether the Contact ID was served from cache (true) or fresh Salesforce lookup/creation (false)
          example: false

    CreateCustomerProfileRequest:
      type: object
      required:
        - email
      properties:
        email:
          type: string
          format: email
          description: Customer email address (used as external key for Salesforce Contact upsert)
          example: "customer@example.com"
        firstName:
          type: string
          description: Customer first name (optional)
          example: "John"
        lastName:
          type: string
          description: Customer last name (optional)
          example: "Smith"
        phone:
          type: string
          description: Customer phone number (optional)
          example: "+61412345678"
        rewardPreference:
          type: string
          enum:
            - OTR_FUEL_DISCOUNT
            - FLYBUYS_POINTS
            - SHELL_PRICE_SAVE
          description: Default reward preference (optional, defaults to OTR_FUEL_DISCOUNT)
          default: "OTR_FUEL_DISCOUNT"
          example: "OTR_FUEL_DISCOUNT"

    CustomerProfile:
      type: object
      properties:
        vivaConsumerId:
          type: string
          description: Viva Consumer ID
          example: "vci_xyz789abc"
        salesforceContactId:
          type: string
          description: Salesforce Contact record ID
          example: "003Dn000001234ABC"
        rewardPreference:
          type: string
          enum:
            - OTR_FUEL_DISCOUNT
            - FLYBUYS_POINTS
            - SHELL_PRICE_SAVE
          description: Default reward preference
          example: "OTR_FUEL_DISCOUNT"
        createdAt:
          type: string
          format: date-time
          description: Profile creation timestamp
          example: "2025-12-09T10:30:00Z"
        updatedAt:
          type: string
          format: date-time
          description: Profile last update timestamp
          example: "2025-12-10T14:30:00Z"
        status:
          type: string
          enum:
            - ACTIVE
            - SUSPENDED
            - CLOSED
          description: Profile status
          example: "ACTIVE"

    UpdateCustomerProfileRequest:
      type: object
      properties:
        email:
          type: string
          format: email
          description: Updated customer email address (triggers Salesforce Contact update)
          example: "newemail@example.com"
        firstName:
          type: string
          description: Updated customer first name
          example: "John"
        lastName:
          type: string
          description: Updated customer last name
          example: "Smith"
        phone:
          type: string
          description: Updated customer phone number
          example: "+61412345678"

    UpdateStatusRequest:
      type: object
      required:
        - status
      properties:
        status:
          type: string
          enum:
            - ACTIVE
            - SUSPENDED
            - CLOSED
          description: New profile status
          example: "CLOSED"
        reason:
          type: string
          enum:
            - CUSTOMER_REQUEST
            - FRAUD_PREVENTION
            - GDPR_ERASURE
            - ADMIN_ACTION
          description: Reason for status change (required for SUSPENDED and CLOSED)
          example: "CUSTOMER_REQUEST"

    StatusUpdateResponse:
      type: object
      properties:
        vivaConsumerId:
          type: string
          description: Viva Consumer ID
          example: "vci_xyz789abc"
        status:
          type: string
          enum:
            - ACTIVE
            - SUSPENDED
            - CLOSED
          description: New profile status
          example: "CLOSED"
        previousStatus:
          type: string
          enum:
            - ACTIVE
            - SUSPENDED
            - CLOSED
          description: Previous profile status
          example: "ACTIVE"
        updatedAt:
          type: string
          format: date-time
          description: Status update timestamp
          example: "2025-12-10T15:00:00Z"
        reason:
          type: string
          description: Reason for status change
          example: "CUSTOMER_REQUEST"

    CreatePartnerLinkRequest:
      type: object
      required:
        - vivaConsumerId
        - partner
        - oauthAuthorizationCode
        - codeVerifier
      properties:
        vivaConsumerId:
          type: string
          description: Viva Consumer ID (GUID or VCI pattern)
          example: "VCI-123456789"
        partner:
          type: string
          enum:
            - FLYBUYS
            - SHELL_CARD
            - AFL
            - BUDGET_DIRECT
          description: Partner identifier
        oauthAuthorizationCode:
          type: string
          description: OAuth authorization code from partner OAuth callback
        codeVerifier:
          type: string
          description: PKCE code verifier (43-128 characters, URL-safe)
          minLength: 43
          maxLength: 128

    PartnerLink:
      type: object
      properties:
        partnerLinkId:
          type: string
          format: uuid
          description: Unique identifier for the partner link
        vivaConsumerId:
          type: string
          description: Viva Consumer ID
        partner:
          type: string
          enum:
            - FLYBUYS
            - SHELL_CARD
            - AFL
            - BUDGET_DIRECT
          description: Partner identifier
        status:
          type: string
          enum:
            - LINKING_IN_PROGRESS
            - LINKED
            - UNLINKED
            - FAILED
          description: Partner link status
        externalMemberId:
          type: string
          nullable: true
          description: External partner member ID (e.g., 12-digit Flybuys number)
        linkedAt:
          type: string
          format: date-time
          nullable: true
          description: Timestamp when partner was successfully linked
        rewardPreference:
          type: string
          enum:
            - FLYBUYS_POINTS
            - OTR_FUEL_DISCOUNT
            - SHELL_PRICE_SAVE
          nullable: true
          description: Customer's reward preference for this partner

    PartnerLinksResponse:
      type: object
      properties:
        vivaConsumerId:
          type: string
          description: Viva Consumer ID
        partnerLinks:
          type: array
          items:
            $ref: "#/components/schemas/PartnerLink"
          description: List of partner links for this customer

    UpdatePreferenceRequest:
      type: object
      required:
        - rewardPreference
      properties:
        rewardPreference:
          type: string
          enum:
            - FLYBUYS_POINTS
            - OTR_FUEL_DISCOUNT
          description: Updated reward preference

    PreferenceUpdateResponse:
      type: object
      properties:
        partnerLinkId:
          type: string
          format: uuid
        rewardPreference:
          type: string
          enum:
            - FLYBUYS_POINTS
            - OTR_FUEL_DISCOUNT
        updatedAt:
          type: string
          format: date-time

    ErrorResponse:
      type: object
      properties:
        error:
          type: string
          description: Machine-readable error code
        message:
          type: string
          description: Human-readable error message
        details:
          type: object
          additionalProperties: true
          description: Additional error context

  responses:
    BadRequest:
      description: Bad request - invalid input
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error: "INVALID_REQUEST"
            message: "Invalid OAuth authorization code"

    Unauthorized:
      description: Unauthorized - invalid or missing OAuth token
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error: "UNAUTHORIZED"
            message: "Invalid or expired OAuth 2.0 Bearer token"

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error: "NOT_FOUND"
            message: "Partner link not found"
