/*
 * LoyaltyService - Bounded Context Definition
 * ============================================
 *
 * Core BFF service for loyalty programme management across all VER brands.
 *
 * See loyalty.adoc for comprehensive architecture documentation, decision log, and patterns.
 */

import "../domains/loyalty.cml"
import "profile.cml"

BoundedContext LoyaltyService implements LoyaltyDomain {

    type = APPLICATION
    domainVisionStatement = "Manages loyalty programmes, reward calculations, and partner integrations across all VER brands (OTR, REXP, SMGB). Abstracts loyalty engine capabilities and handles transaction adjudication."

    responsibilities = "Transaction adjudication recording",
                      "Partner link status tracking",
                      "Orchestration of loyalty operations across EagleEye, CRM, and partner systems",
                      "Event translation from EagleEye webhooks to OTR domain events",
                      "Backend-for-Frontend (BFF) facade for mobile app loyalty features"

    implementationTechnology = "Azure Functions, .NET Core, Eagle Eye API, Azure Key Vault, Event Bus"

    // ========================================================================
    // SECTION 1: CORE AGGREGATES
    // ========================================================================
    // Aggregates represent transactional consistency boundaries.
    // Each aggregate root controls access to entities within its boundary.
    // ========================================================================

    // 1.1 RewardTransaction Aggregate
    // ---------------------------------
    // Records the result of transaction adjudication and rewards awarded.
    // Stores minimal transaction context for customer reward history display.
    // Full basket details are NOT stored (owned by POS/Transaction context).
    //
    // Two-Phase Adjudication:
    // - Created ONLY in Phase 2 (Redemption) after payment captured
    // - Phase 1 (Validation) returns provisional rewards but does NOT create aggregate
    // - Stores payment method used to enable audit trail and reconciliation
    //
    // Invariants:
    // - Must reference a source transaction ID
    // - Transaction amount must be positive
    // - Payment method must be present (required for validation)
    // - If eligible, must have a reward grant
    //
    // Bounded Context Note:
    // - Basket line items are passed to EagleEye but NOT persisted
    // - Only summary (itemCount, itemSummary) stored for guest history display
    // - Source transaction ID references POS system for full basket details
    // - Payment method stored for eligibility audit (e.g., grant exclusions, co-brand bonuses)
    Aggregate RewardTransaction {
        Entity RewardTransactionRecord {
            aggregateRoot

            - RewardTransactionId id
            - TransactionId sourceTransactionId  // Reference to POS transaction
            - String VivaConsumerId              // Salesforce guest identifier
            - Money transactionAmount
            - int itemCount                      // e.g., "2 items"
            - String itemSummary                 // e.g., "Fuel, Coffee" (for display)
            - DateTime transactionDate
            - StoreId storeId
            - PaymentMethod paymentMethod        // Payment method used (affects eligibility)
            - RewardPreference preferenceUsed
            - Set<LoyaltyScheme> schemesParticipated  // Schemes posted to (FLYBUYS, INTERNAL_OTR)
            - EligibilityStatus eligibility
            - RewardGrant grant
            - AdjudicationStatus status          // SUCCESS, NOT_ELIGIBLE, SERVICE_UNAVAILABLE
            - DateTime adjudicatedAt
        }

        ValueObject RewardPreference {
            - PreferenceType type  // FLYBUYS_POINTS, SPS_FUEL_DISCOUNT, OTR_REWARDS
        }

        ValueObject EligibilityStatus {
            - boolean isEligible
            - List<String> exclusionReasons
        }

        ValueObject RewardGrant {
            - ProfileService.PartnerType partner
            - Money amount
            - int points
            - GrantType type  // BASE, BONUS, PROMOTIONAL
        }

        ValueObject AdjudicationStatus {
            - StatusType status  // SUCCESS, NOT_ELIGIBLE, SERVICE_UNAVAILABLE, VALIDATION_FAILED
        }

        ValueObject PaymentMethod {
            // Payment method metadata affecting reward eligibility
            // Different payment methods have different earning rules:
            // - Promotional grants/discounts may exclude certain amounts from points
            // - Co-branded cards may have bonus earning rates
            // - BNPL/gift cards may have restricted eligibility

            - PaymentMethodType type           // Payment method category
            - boolean hasActiveGrants          // Active promotional grants (e.g., fuel discounts)
            - List<String> grantIdentifiers    // Grant IDs affecting eligibility (excludes amounts)
            - Map<String, String> metadata     // Payment-method-specific data (e.g., co-brand partner, issuer)
        }

        enum PaymentMethodType {
            SHELL_CARD,          // Shell fuel card (may have promotional grants)
            CO_BRANDED_CARD,     // Co-branded loyalty cards (e.g., Flybuys credit card)
            CREDIT_CARD,         // Standard credit card
            DEBIT_CARD,          // Standard debit card
            DIGITAL_WALLET,      // Apple Pay, Google Pay, Samsung Pay
            BNPL,                // Buy Now Pay Later (Afterpay, Zip, etc.)
            GIFT_CARD,           // Gift card or voucher
            CASH,                // Cash payment
            OTHER                // Other payment types
        }

        enum LoyaltyScheme {
            // Loyalty schemes configured in EagleEye for dual-track points accrual
            // All schemes updated atomically during transaction adjudication (all-or-nothing)

            FLYBUYS,             // Flybuys partner scheme (transmitted to Flybuys via batch)
            INTERNAL_OTR         // Internal OTR points scheme (dormant, not customer-visible)
        }
    }

    // 1.2 PartnerLink Aggregate - MOVED TO PROFILESERVICE
    // ----------------------------------------------------
    // This aggregate has been MOVED to ProfileService bounded context.
    //
    // Rationale:
    // - Partner linking is customer profile data, not loyalty transaction data
    // - ProfileService is natural home for customer relationships
    // - Reduces LoyaltyService complexity to single aggregate (RewardTransaction)
    //
    // Migration Impact:
    // - LoyaltyService queries ProfileService synchronously for partner link status
    // - Pattern: GET /profiles/{vci}/partner-links
    // - Similar to how LoyaltyService queries EagleEye (real-time orchestration)
    //
    // See: bounded-contexts/profile.cml for PartnerLink aggregate definition

    // NOTE: Multiple Aggregates REMOVED - Owned by Other Contexts
    // =============================================================
    //
    // Owned by EagleEye AIR platform (queried via ACL):
    // - Wallet: Grants, fuel discounts, product offers, entitlements
    // - PointsLedger: Points balance, transactions, expiry tracking
    // - Membership: Member enrollment, tier levels, tier progression
    // - Campaigns/Promotions: Promotional campaigns, eligibility rules, reward multipliers
    //
    // Owned by SubscriptionService bounded context:
    // - Subscription: Subscription plans, billing, payment coordination
    // - Integrates with payment gateway (Stripe/etc.) for recurring billing
    // - LoyaltyService subscribes to subscription life-cycle events
    //
    // See: EagleEye ACL (application-layer/eagleeye-acl.md) for query translations

    // ========================================================================
    // FINAL AGGREGATES IN LOYALTYSERVICE
    // ========================================================================
    // After bounded context analysis, LoyaltyService owns only:
    // 1. RewardTransaction - Audit trail of transaction adjudication results
    //
    // PartnerLink aggregate MOVED to ProfileService (customer profile data).
    // Everything else is owned by other bounded contexts or queried from EagleEye.
    // ========================================================================
    // ========================================================================
    // SECTION 2: DOMAIN EVENTS
    // ========================================================================
    // Events published to Event Bus for downstream consumption.
    // Follows Event-Carried State Transfer pattern with full context.
    //
    // Event Sources:
    // 1. LoyaltyService aggregates (RewardTransaction, PartnerLink)
    // 2. EagleEye webhooks → translated by ACL → published as domain events
    // 3. EagleEye API responses → translated by ACL → published as domain events
    //
    // Note: Even though EagleEye owns points, tiers, campaigns, and wallet,
    // LoyaltyService acts as the event publisher, translating EagleEye's
    // notifications into OTR's domain language for other bounded contexts.
    // ========================================================================

    // --- Transaction Events (Source: LoyaltyService aggregate) ---

    DomainEvent MemberEnrolled {
        - String VivaConsumerId           // Salesforce guest identifier
        - MemberId memberId
        - DateTime enrolledAt
        - String source  // MOBILE_APP, WEB_APP, IN_STORE
    }

    DomainEvent MembershipSuspended {
        - String VivaConsumerId           // Salesforce guest identifier
        - DateTime suspendedAt
        - String reason
    }

    DomainEvent MembershipReactivated {
        - String VivaConsumerId           // Salesforce guest identifier
        - DateTime reactivatedAt
    }

    // --- Transaction & Points Events ---

    DomainEvent TransactionAdjudicated {
        - RewardTransactionId rewardTransactionId
        - TransactionId sourceTransactionId
        - String VivaConsumerId           // Salesforce guest identifier
        - Money amount
        - int itemCount
        - String itemSummary
        - DateTime transactionDate
        - StoreId storeId
        - boolean isEligible
        - List<String> exclusionReasons
        - AdjudicationStatus status
    }

    // --- Points Events (Source: EagleEye webhook → ACL translation) ---

    DomainEvent PointsEarned {
        - String VivaConsumerId           // Salesforce guest identifier
        - int points
        - LoyaltyScheme scheme            // Scheme where points were earned (FLYBUYS, INTERNAL_OTR)
        - RewardTransactionId rewardTransactionId
        - TransactionId sourceTransactionId
        - String itemSummary  // For display: "Fuel, Coffee"
        - DateTime earnedAt
        - String earnType  // BASE, BONUS, PROMOTIONAL
        - int newBalance
    }

    DomainEvent PointsRedeemed {
        - String VivaConsumerId           // Salesforce guest identifier
        - int points
        - LoyaltyScheme scheme            // Scheme where points were redeemed
        - String redemptionType  // FUEL_DISCOUNT, PRODUCT_OFFER, PARTNER_TRANSFER
        - DateTime redeemedAt
        - String redemptionReference
        - int remainingBalance
    }

    DomainEvent PointsExpired {
        - String VivaConsumerId           // Salesforce guest identifier
        - int pointsExpired
        - LoyaltyScheme scheme            // Scheme where points expired
        - DateTime expiredAt
        - String expiryReason
        - int remainingBalance
    }

    DomainEvent PointsAdjusted {
        - String VivaConsumerId           // Salesforce guest identifier
        - int pointsAdjustment
        - LoyaltyScheme scheme            // Scheme where points were adjusted
        - DateTime adjustedAt
        - String reason
        - String performedBy
        - int newBalance
    }

    // --- Wallet Events (Source: EagleEye webhook → ACL translation) ---

    DomainEvent GrantIssued {
        - String VivaConsumerId           // Salesforce guest identifier
        - String grantId  // EagleEye grant ID
        - String grantType  // FUEL_DISCOUNT, PRODUCT_OFFER, POINTS
        - Money value
        - DateTime issuedAt
        - DateTime expiresAt
    }

    DomainEvent GrantRedeemed {
        - String VivaConsumerId           // Salesforce guest identifier
        - String grantId
        - DateTime redeemedAt
        - TransactionId sourceTransactionId
    }

    // --- Partner Events - MOVED TO PROFILESERVICE ---
    // These events are now published by ProfileService:
    // - PartnerLinked
    // - PartnerUnlinked
    // - PartnerLinkChanged
    // - RewardPreferenceChanged
    //
    // LoyaltyService may consume these events if needed for auditing/analytics,
    // but primarily queries ProfileService synchronously for partner link status.

    // --- Flybuys-Specific Events (Source: Flybuys webhook → ACL translation) ---
    // These events are specific to Flybuys integration and published in OTR domain language.

    DomainEvent FlybuysPointsEarned {
        - String VivaConsumerId           // Salesforce guest identifier
        - String flybuysMemberId          // Flybuys member number
        - int pointsEarned
        - int newBalance
        - TransactionId sourceTransactionId
        - DateTime earnedAt
        - String earnType  // TRANSACTION, BOOSTER, PROMOTIONAL
    }

    DomainEvent FlybuysBalanceUpdated {
        - String VivaConsumerId           // Salesforce guest identifier
        - String flybuysMemberId
        - int previousBalance
        - int newBalance
        - int pointsChange                // Delta (positive or negative)
        - DateTime updatedAt
        - String changeReason             // EARNED, REDEEMED, ADJUSTED, EXPIRED
    }

    DomainEvent PartnerAccountLinked {
        - String VivaConsumerId           // Salesforce guest identifier
        - String flybuysMemberId
        - DateTime linkedAt
        - String linkMethod               // OAUTH_MOBILE_APP, POS_CARD_SCAN
        - String brandContext             // OTR, SPS
    }

    DomainEvent PartnerAccountUnlinked {
        - String VivaConsumerId           // Salesforce guest identifier
        - String flybuysMemberId
        - DateTime unlinkedAt
        - String reason                   // USER_REQUEST, ACCOUNT_CLOSED, TOKEN_REVOKED
        - String brandContext             // OTR, SPS
    }

    DomainEvent FlybuysDealerTransactionPosted {
        - String flybuysMemberId
        - String dealerId                 // Shell dealer ID
        - Money transactionAmount
        - int pointsEarned
        - DateTime transactionDate
        - String terminalId
        - boolean isSuccessful
    }

    // --- Partner Batch Processing Events (Source: LoyaltyService batch job) ---
    // These events capture DOMAIN FACTS about partner transaction posting.
    // The business fact is: "Transactions were posted to partner on this date"
    //
    // NOTE: CSV file generation, SFTP transmission, scheduling (01:00 UTC) are
    // APPLICATION/INFRASTRUCTURE concerns documented in application layer.

    DomainEvent DailyPointsFileGenerated {
        // Published when daily partner points file has been generated
        // (Business fact: "We identified and classified these transactions for partner posting")

        - Date processingDate               // Business day being processed (e.g., 2026-01-14)
        - PartnerType partner               // FLYBUYS, future partners
        - int transactionCount              // Total transactions included
        - int basePointsTotal               // Total base points across all transactions
        - int bonusPointsTotal              // Total bonus points across all transactions
        - int totalPoints                   // basePointsTotal + bonusPointsTotal
        - String fileId                     // Unique identifier for reconciliation
        - DateTime generatedAt
    }

    DomainEvent DailyPointsFileTransmitted {
        // Published when file has been successfully transmitted to partner
        // (Business fact: "We posted these transactions to partner")

        - String fileId                     // Links to DailyPointsFileGenerated
        - Date processingDate
        - PartnerType partner
        - String transmissionId             // Partner's acknowledgment ID (if available)
        - TransmissionStatus status         // TRANSMITTED, FAILED, ACKNOWLEDGED
        - DateTime transmittedAt
    }

    DomainEvent DailyPointsFileAcknowledged {
        // Published when partner acknowledges file receipt and processing
        // (Business fact: "Partner confirmed processing with these results")

        - String fileId
        - Date processingDate
        - PartnerType partner
        - int successfulTransactions        // Accepted by partner
        - int failedTransactions            // Rejected by partner (retry required)
        - List<String> failureReasons       // Business reasons for rejection
        - DateTime acknowledgedAt
    }

    enum TransmissionStatus {
        TRANSMITTED,        // File uploaded successfully
        FAILED,            // Transmission failed (network, auth, etc.)
        ACKNOWLEDGED,      // Partner confirmed receipt
        REJECTED           // Partner rejected file (format, validation, etc.)
    }

    // ========================================================================
    // SECTION 3: ORCHESTRATION & QUERY SERVICES
    // ========================================================================
    // These services orchestrate calls to EagleEye and other external systems.
    // They do NOT manage local aggregates - they are facades/adapters for
    // querying and coordinating external loyalty platform operations.
    //
    // Pattern: Backend-for-Frontend (BFF) orchestration services
    // ========================================================================

    Service TransactionSummaryService {
        // Generate human-readable item summary from basket
        // (Domain logic - operates on transaction data, not external calls)
        generateItemSummary(@List<BasketItem> items) : String

        // Count total items in basket
        countItems(@List<BasketItem> items) : int
    }

    Service PointsQueryService {
        // Query upcoming expiry schedule from EagleEye
        // (Orchestration - calls EagleEye API, no local aggregate)
        getExpirySchedule(@String VivaConsumerId) : List<ExpirySchedule>

        // Query points balance from EagleEye for a specific scheme
        getPointsBalance(@String VivaConsumerId, @LoyaltyScheme scheme) : int

        // Query all scheme balances from EagleEye (for analytics, backoffice)
        getAllSchemeBalances(@String VivaConsumerId) : Map<LoyaltyScheme, int>

        // Query customer-visible balance (currently FLYBUYS only)
        getCustomerVisibleBalance(@String VivaConsumerId) : int

        // Query points ledger/history from EagleEye for a specific scheme
        getPointsHistory(@String VivaConsumerId, @LoyaltyScheme scheme) : List<PointsTransaction>
    }


    Service ProfileServiceIntegration {
        // Query ProfileService for partner link status during transaction adjudication
        // (Synchronous queries - similar pattern to EagleEye queries)

        // Query partner link status for customer
        getPartnerLinkStatus(@String VivaConsumerId) : PartnerLinkStatus

        // Query reward preference for customer
        getRewardPreference(@String VivaConsumerId) : ProfileService.RewardPreferenceType

        // Get all partner links for customer
        getPartnerLinks(@String VivaConsumerId) : List<PartnerLinkInfo>
    }

    ValueObject PartnerLinkStatus {
        - boolean isLinked
        - ProfileService.PartnerType partner
        - String externalMemberId
        - ProfileService.RewardPreferenceType rewardPreference
    }

    ValueObject PartnerLinkInfo {
        - ProfileService.PartnerType partner
        - String externalMemberId
        - ProfileService.LinkState linkState
        - ProfileService.RewardPreferenceType rewardPreference
    }

    Service TransactionClassifier {
        // DOMAIN SERVICE: Contains business rules for classifying transactions
        // for partner points posting (Flybuys batch file generation).
        //
        // This is DOMAIN logic because:
        // - Classification rules (base vs bonus points) are business rules
        // - Would exist even if Flybuys switched from batch files to real-time API
        // - Contains payment-method-specific eligibility logic
        //
        // Payment Method Rules:
        // - Promotional grants/discounts: Exclude grant amounts from point calculation
        // - Co-branded cards: Apply partner-specific bonus rates
        // - Restricted payment types: BNPL, gift cards may have limited eligibility
        // - Payment method metadata stored in RewardTransaction drives classification
        //
        // NOTE: Actual batch file generation (CSV format, SFTP transmission, scheduling)
        // is APPLICATION/INFRASTRUCTURE concern and documented separately.

        // Classify transaction for Flybuys points posting
        // Applies business rules: fuel 1pt/L, retail 1pt/$1, product exclusions, payment method rules
        classifyForFlybuys(@RewardTransactionRecord transaction, @PartnerLinkInfo link) : PointsClassification

        // Determine if transaction is eligible for partner points
        // Business rules: payment method eligibility, product exclusions, site type
        isEligibleForPartnerPoints(@RewardTransactionRecord transaction, @ProfileService.PartnerType partner) : boolean

        // Apply payment-method-specific exclusions
        // Examples: Shell Card grants, co-branded bonus rates, BNPL restrictions
        applyPaymentMethodRules(@RewardTransactionRecord transaction, @PaymentMethod paymentMethod) : Money

        // Calculate base points (standard earn rate)
        // Applies to net transaction amount after payment-method exclusions
        calculateBasePoints(@Money eligibleAmount, @TransactionType type) : int

        // Calculate bonus points (promotional multipliers, campaigns)
        calculateBonusPoints(@RewardTransactionRecord transaction, @List<Campaign> activeCampaigns) : int
    }

    Service CampaignQueryService {
        // Query campaign eligibility from EagleEye
        // (Orchestration - calls EagleEye API, no local aggregate)
        getCampaignEligibility(@String VivaConsumerId, @CampaignId campaignId) : boolean

        // Query all active campaigns for guest from EagleEye
        getActiveCampaigns(@String VivaConsumerId) : List<Campaign>

        // Query campaign details from EagleEye
        getCampaignDetails(@CampaignId campaignId) : Campaign
    }

    Service WalletQueryService {
        // Query wallet contents from EagleEye (grants, offers, discounts)
        // (Orchestration - calls EagleEye API, no local aggregate)
        getWallet(@String VivaConsumerId) : Wallet

        // Query active grants from EagleEye
        getActiveGrants(@String VivaConsumerId) : List<Grant>

        // Query stored value balance from EagleEye
        getStoredValueBalance(@String VivaConsumerId) : Money
    }

    // ========================================================================
    // PARTNER INTEGRATION ABSTRACTION
    // ========================================================================
    // Generic partner service interfaces enable partner flexibility without
    // imposing ACL translation overhead on partners with stable APIs.
    //
    // Pattern: Conformist implementations behind generic domain interfaces
    // ----------------------------------------------------------------------
    // - Domain defines generic IPartnerPointsService, IPartnerLinkingService
    // - Infrastructure provides partner-specific implementations:
    //   * FlybuysPointsService (Conformist - no translation, stable API)
    //   * ShellPointsService (future - TBD pattern based on Shell API stability)
    // - Domain code uses generic interfaces, stays partner-agnostic
    // - Each partner implementation chooses appropriate pattern:
    //   * Conformist if API stable (Flybuys, industry standards like OAuth)
    //   * ACL if API unstable or vendor-specific (protect domain from changes)
    //
    // Benefits:
    // - Domain stays partner-agnostic (can swap/add partners)
    // - No translation overhead for stable APIs (Conformist)
    // - Future partners can choose ACL if needed (API instability)
    // - Implementation pattern choice separated from domain design
    //
    // Flybuys Integration (Conformist Implementation):
    // - FlybuysPointsService directly uses Flybuys REST API contracts
    // - No ACL translation (Flybuys API is stable, well-documented, OAuth 2.0 standard)
    // - Maps generic method calls → Flybuys API endpoints
    // - Rationale: Flybuys partnership is time-bound (2-3 years), API mature,
    //   ACL overhead not justified for industry-standard OAuth + REST APIs
    // ========================================================================

    Service IPartnerPointsService {
        // Generic interface for partner points operations
        // Implementations: FlybuysPointsService (Conformist), ShellPointsService (future)

        // Get customer's points balance with partner
        getPointsBalance(@String externalMemberId, @ProfileService.PartnerType partner) : int

        // Get points expiry schedule from partner
        getExpirySchedule(@String externalMemberId, @ProfileService.PartnerType partner) : List<PointsExpiry>

        // Validate external member ID with partner system
        validateMembership(@String externalMemberId, @ProfileService.PartnerType partner) : boolean

        // Post transaction to partner for points accrual
        // (Real-time posting if partner supports, otherwise queued for batch)
        postTransaction(@PartnerTransaction transaction) : PartnerPostingResult
    }

    Service IPartnerLinkingService {
        // Generic interface for partner account linking operations
        // Implementations: FlybuysLinkingService (OAuth 2.0 via Auth0), future partners

        // Initiate OAuth linking flow (returns authorisation URL)
        initiateOAuthFlow(@String VivaConsumerId, @ProfileService.PartnerType partner) : OAuthauthorisationUrl

        // Complete OAuth linking (called after OAuth callback)
        completeOAuthFlow(@String authorisationCode, @String codeVerifier) : PartnerLinkResult

        // Revoke partner linking and tokens
        revokePartnerLink(@PartnerLinkId linkId) : boolean

        // Refresh expired access token
        refreshAccessToken(@String oauthProviderId) : OAuthToken
    }

    Service IPartnerDocketService {
        // Generic interface for partner digital docket/voucher operations
        // Implementations: FlybuysDocketService (fuel dockets from Coles), future partners

        // Get available digital dockets for customer
        getAvailableDockets(@String externalMemberId, @ProfileService.PartnerType partner) : List<DigitalDocket>

        // Redeem digital docket during transaction
        redeemDocket(@String docketId, @TransactionId transactionId) : DocketRedemptionResult

        // Validate docket eligibility (fuel amount, expiry, etc.)
        validateDocket(@String docketId, @Money transactionAmount) : boolean
    }

    // ========================================================================
    // BARCODE RESOLUTION SERVICE (Strangler Fig Pattern)
    // ========================================================================
    // This service strangles the legacy "Coupon Scanner" system used in REXP stores.
    //
    // Legacy (Current REXP):
    // - POS → Coupon Scanner (single-serving legacy solution)
    // - Limited barcode pattern matching
    // - No integration with OTR loyalty systems
    // - No guest identity resolution
    //
    // Target State (TO-BE):
    // - POS → D365 Commerce → LoyaltyService.BarcodeResolutionService
    // - Unified barcode handling across OTR and REXP stores
    // - Guest identity resolution (barcode → VivaConsumerId)
    // - Partner linking status (Flybuys, Shell, OTR)
    // - Reward preference lookup for transaction adjudication
    //
    // Pattern: Strangler Fig
    // - New functionality built in LoyaltyService
    // - Legacy Coupon Scanner gradually retired as REXP stores convert to OTR
    // - D365 Commerce POS calls LoyaltyService directly (no legacy dependency)
    // ========================================================================

    Service BarcodeResolutionService {
        // DOMAIN SERVICE: Resolve barcode to guest identity and partner linking status
        // Enables POS to determine customer, reward preference, and apply appropriate rewards
        //
        // Strangler Fig: Replaces legacy "Coupon Scanner" with proper domain service

        // Resolve barcode to guest identity and linking information
        // Handles multiple barcode types: OTR loyalty card, Flybuys card, Shell card
        resolveBarcode(@String barcode) : BarcodeResolution

        // Determine barcode type from pattern (12-digit Flybuys, 13-digit OTR, etc.)
        identifyBarcodeType(@String barcode) : BarcodeType

        // Validate barcode format and checksum
        validateBarcode(@String barcode) : boolean

        // Look up guest by OTR loyalty barcode
        resolveOTRBarcode(@String barcode) : String  // Returns VivaConsumerId

        // Look up guest by linked Flybuys barcode
        resolveFlybuysBarcode(@String flybuysMemberId) : String  // Returns VivaConsumerId (if linked)

        // Look up guest by linked Shell card barcode
        resolveShellBarcode(@String shellCardNumber) : String  // Returns VivaConsumerId (if linked)
    }

    // ========================================================================
    // SECTION 4: SHARED VALUE OBJECTS
    // ========================================================================
    // Reusable value objects used across multiple aggregates.
    // ========================================================================

    ValueObject Money {
        - Decimal amount
        - String currency  // AUD, USD
    }

    ValueObject StoreId {
        - String id
    }

    ValueObject ProductCategory {
        - String code
        - String name
        - boolean isEligibleForRewards
        - Decimal rewardMultiplier
    }

    ValueObject TransactionId {
        - String id  // POS transaction ID
    }

    ValueObject RewardTransactionId {
        - String id  // LoyaltyService reward transaction ID
    }

    ValueObject LedgerEntryId {
        - String id
    }

    ValueObject MemberId {
        - String id
    }

    ValueObject CampaignId {
        - String id
    }

    ValueObject SubscriptionId {
        - String id
    }

    ValueObject PointsTransactionId {
        - String id
    }

    ValueObject PaymentMethodId {
        - String id
    }

    ValueObject PartnerLinkId {
        - String id
    }

    ValueObject BarcodeResolution {
        // Result of barcode resolution service
        // Provides guest identity, partner linking status, and reward preference

        - String barcode                    // Scanned barcode value
        - BarcodeType barcodeType          // OTR_LOYALTY, FLYBUYS, SHELL_CARD, UNKNOWN
        - boolean isValid                   // Barcode format valid
        - String VivaConsumerId            // Guest identifier (null if not found)
        - boolean isLinked                  // Partner account linked to OTR customer
        - ProfileService.RewardPreferenceType rewardPreference  // Guest's reward preference (if found)
        - String externalMemberId          // Partner member number (for linked accounts)
        - ResolutionStatus status          // RESOLVED, NOT_LINKED, NOT_FOUND, INVALID_BARCODE
    }

    enum BarcodeType {
        OTR_LOYALTY,                       // OTR loyalty card barcode (13-digit)
        FLYBUYS,                           // Flybuys member barcode (12-digit)
        SHELL_CARD,                        // Shell fuel card barcode
        UNKNOWN                            // Unrecognised barcode pattern
    }

    enum ResolutionStatus {
        RESOLVED,                          // Guest found, can apply rewards
        NOT_LINKED,                        // Valid partner barcode but not linked to OTR account
        NOT_FOUND,                         // Valid barcode format but no guest found
        INVALID_BARCODE                    // Invalid barcode format or checksum
    }

    ValueObject PointsClassification {
        // DOMAIN VALUE OBJECT: Result of transaction classification for partner points posting
        // Contains business rules output: base points, bonus points, exclusions

        - int basePoints                    // Standard earn rate (fuel: 1pt/L, retail: 1pt/$1)
        - int bonusPoints                   // Promotional multipliers, campaign bonuses
        - int totalPoints                   // basePoints + bonusPoints
        - List<String> exclusionReasons     // Product exclusions (tobacco, gift cards, etc.)
        - boolean isEligible                // Overall eligibility for partner points
        - TransactionClassificationType classificationType  // BASE_ONLY, BASE_AND_BONUS, EXCLUDED
    }

    enum TransactionClassificationType {
        BASE_ONLY,              // Standard earn rate only (no active promotions)
        BASE_AND_BONUS,         // Base earn + promotional bonus points
        EXCLUDED                // Transaction not eligible (exclusions apply)
    }

    // ========================================================================
    // SECTION 5: REPOSITORIES (Persistence Abstractions)
    // ========================================================================
    // Repository interfaces define persistence operations for owned aggregates.
    // Implementation details handled by infrastructure layer.
    //
    // LoyaltyService owns ONLY 1 aggregate, therefore ONLY 1 repository:
    // - RewardTransactionRepository: Persists transaction adjudication audit trail
    //
    // NO repositories for:
    // - PartnerLink (moved to ProfileService)
    // - Member, Ledger, Subscription, Campaign (owned by EagleEye or other bounded contexts)
    // ========================================================================

    // Repository RewardTransactionRepository
}

// ============================================================================
// END OF BOUNDED CONTEXT
// ============================================================================
//
// Implementation Notes:
// - ONLY 1 aggregate: RewardTransaction (PartnerLink moved to ProfileService)
// - Persistence: Cosmos DB (partitioned by VivaConsumerId) for owned aggregates only
// - Events published to Event Bus topic: "loyalty-events"
// - Orchestration services implemented as Azure Functions calling EagleEye APIs
// - ACL implemented for EagleEye API integration (translates to OTR domain model)
// - Flybuys uses Conformist pattern (no ACL, conform to their API)
// - Points expiry, tier evaluation, campaign management: ALL handled by EagleEye
// - LoyaltyService queries EagleEye in real-time (no local caching/replication)
// - LoyaltyService queries ProfileService synchronously for partner link status
// - Partner linking, reward preferences: ProfileService owns, LoyaltyService queries
// ============================================================================