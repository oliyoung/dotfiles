/*
 * Handover Service - Bounded Context Definition
 * ==============================================
 *
 * Manages order handover for Click & Collect and Home Delivery via third-party
 * delivery provider integration (vendor-agnostic with ACL). Enables OTR to expand
 * digital retail footprint beyond physical stores.
 *
 * Business Context (CY26 Strategy):
 * ---------------------------------
 * Handover capability is Q1-Q2 CY26 priority for OTR brand only:
 * - White-label third-party delivery integration (maintains OTR branding)
 * - Initial vendor: DoorDash (but architecture supports vendor replacement)
 * - Click & Collect (order ahead, pickup in-store)
 * - Home Delivery (food & convenience products)
 * - Loyalty integration (points earning on delivery orders)
 * - Expands OTR digital retail footprint
 * - Improves customer convenience and retention
 *
 * Vendor Independence Strategy:
 * -----------------------------
 * - ACL pattern protects domain from delivery provider changes
 * - Can switch providers (DoorDash → Uber Eats → Deliveroo) without domain changes
 * - Driver and fleet management abstracted behind delivery provider interface
 * - White-label integration maintains OTR branding regardless of provider
 *
 * Domain Coverage:
 * ----------------
 * - Order management (creation, modification, cancellation)
 * - Delivery tracking and status updates
 * - Click & Collect pickup scheduling
 * - Third-party driver coordination (via ACL)
 * - Delivery fee calculation and estimation
 * - Order fulfilment coordination with stores
 *
 * Integration Points:
 * -------------------
 * - Upstream: Third-party Delivery Provider (driver dispatch, tracking), D365 Commerce (product catalog, inventory)
 * - Downstream: PaymentService (order payment), LoyaltyService (points earning)
 * - Events: OrderPlaced, OrderConfirmed, OrderPreparing, OrderReady, OrderHandedOver
 *
 * NOT in this context (owned by other systems):
 * - Product catalog → D365 Commerce
 * - Inventory management → D365 Commerce (store-level stock)
 * - Payment processing → PaymentService
 * - Loyalty points calculation → LoyaltyService
 * - Driver employment and onboarding → Third-party delivery provider
 * - Driver routing and optimization → Third-party delivery provider
 */

import "../domains/handover.cml"

BoundedContext HandoverService implements HandoverDomain {

    type = FEATURE

    // Strategic DDD Classification: CORE_DOMAIN | SUPPORTING_DOMAIN | GENERIC_DOMAIN
    // SUPPORTING_DOMAIN: Necessary for expanding digital retail footprint and customer convenience,
    // but delivery fulfillment is not a unique competitive differentiator in convenience retail
    strategicClassification = "SUPPORTING_DOMAIN"

    domainVisionStatement = "Manages Click & Collect and Home Delivery order handover via white-label third-party delivery provider for OTR brand. Vendor-agnostic architecture with ACL enables provider flexibility while expanding digital retail footprint."

    responsibilities = "Order creation and management",
                      "Click & Collect pickup scheduling",
                      "Home delivery coordination",
                      "Third-party driver dispatch coordination (via ACL)",
                      "Delivery tracking and real-time updates",
                      "Delivery fee calculation",
                      "Order status updates and notifications",
                      "Store fulfilment coordination",
                      "Delivery address validation and geocoding",
                      "Delivery provider abstraction and vendor independence"

    implementationTechnology = "Azure Functions, .NET Core, Third-party Delivery Provider API (ACL), Event Bus, Azure Cosmos DB"

    // ========================================================================
    // SECTION 1: CORE AGGREGATES
    // ========================================================================

    // 1.1 DeliveryOrder Aggregate
    // ----------------------------
    // Represents a customer order for delivery or pickup.
    // Manages order life-cycle from placement through completion.
    //
    // Invariants:
    // - Order must have at least one item
    // - Delivery address required for home delivery
    // - Pickup time required for Click & Collect
    // - Order cannot be modified after preparation starts
    // - Cancellation only allowed before driver assignment
    Aggregate DeliveryOrder {
        Entity Order {
            aggregateRoot

            - OrderId id
            - String VivaConsumerId              // Salesforce guest identifier
            - OrderType orderType                // HOME_DELIVERY, CLICK_AND_COLLECT
            - StoreId fulfilmentStoreId         // Store preparing the order
            - OrderStatus status
            - List<OrderItem> items
            - Money subtotal
            - Money deliveryFee
            - Money totalAmount
            - DateTime orderedAt
            - DateTime requestedDeliveryTime     // For home delivery
            - DateTime requestedPickupTime       // For Click & Collect
            - DeliveryAddress deliveryAddress    // For home delivery
            - PaymentMethodId paymentMethodId
            - String specialInstructions
            - FulfillmentDetails fulfilmentInfo
            - DeliveryTrackingInfo trackingInfo  // For home delivery via third-party provider
        }

        ValueObject OrderType {
            - TypeCode type  // HOME_DELIVERY, CLICK_AND_COLLECT
        }

        ValueObject OrderStatus {
            - StatusCode status  // PLACED, CONFIRMED, PREPARING, READY, OUT_FOR_DELIVERY, DELIVERED, CANCELLED
            - DateTime statusChangedAt
            - String statusMessage
        }

        ValueObject OrderItem {
            - String productId                   // D365 Commerce product ID
            - String productName
            - String productCategory
            - int quantity
            - Money unitPrice
            - Money totalPrice
            - String specialRequests
        }

        ValueObject DeliveryAddress {
            - String addressLine1
            - String addressLine2
            - String suburb
            - String state
            - String postcode
            - String country
            - GeoLocation coordinates
            - String deliveryInstructions
        }

        ValueObject GeoLocation {
            - Decimal latitude
            - Decimal longitude
        }

        ValueObject FulfillmentDetails {
            - DateTime confirmedAt               // Store confirmed order
            - DateTime preparationStartedAt
            - DateTime readyAt
            - DateTime completedAt
            - String preparedBy                  // Store staff member
            - String notes
        }

        ValueObject DeliveryTrackingInfo {
            - String externalDeliveryId          // Third-party provider delivery reference
            - String providerName                // DOORDASH, UBER_EATS, DELIVEROO, etc.
            - String driverId
            - String driverName
            - String driverPhone
            - DateTime estimatedDeliveryTime
            - DateTime actualDeliveryTime
            - GeoLocation driverLocation         // Real-time driver position
            - DeliveryStatus deliveryStatus
        }

        ValueObject DeliveryStatus {
            - StatusCode status  // DRIVER_ASSIGNED, EN_ROUTE_TO_STORE, PICKED_UP, EN_ROUTE_TO_CUSTOMER, DELIVERED
            - DateTime statusChangedAt
        }
    }

    // 1.2 DeliveryZone Aggregate
    // ---------------------------
    // Defines delivery coverage areas and fees per store.
    // Used for delivery feasibility checks and fee calculation.
    //
    // Invariants:
    // - Each store has defined delivery zones
    // - Zones cannot overlap for the same store
    // - Delivery fees must be non-negative
    Aggregate DeliveryZone {
        Entity Zone {
            aggregateRoot

            - ZoneId id
            - StoreId storeId
            - String zoneName
            - GeoFence geoBoundary               // Polygon defining delivery area
            - Money deliveryFee
            - int estimatedDeliveryMinutes
            - Money minimumOrderValue            // Min order for free delivery
            - boolean isActive
            - DateTime validFrom
            - DateTime validTo
        }

        ValueObject GeoFence {
            - List<GeoLocation> boundaryPoints   // Polygon coordinates
            - Decimal radiusKm                   // Alternative: radius from store
        }
    }

    // ========================================================================
    // SECTION 2: DOMAIN EVENTS
    // ========================================================================
    // Events published to Event Bus for downstream consumption.
    // ========================================================================

    // --- Order life-cycle Events ---

    DomainEvent OrderPlaced {
        - OrderId orderId
        - String VivaConsumerId
        - OrderType orderType                    // HOME_DELIVERY, CLICK_AND_COLLECT
        - StoreId fulfilmentStoreId
        - Money totalAmount
        - DateTime orderedAt
        - DateTime requestedDeliveryTime
    }

    DomainEvent OrderConfirmed {
        - OrderId orderId
        - String VivaConsumerId
        - StoreId fulfilmentStoreId
        - DateTime confirmedAt
        - DateTime estimatedReadyTime
    }

    DomainEvent OrderPreparing {
        - OrderId orderId
        - String VivaConsumerId
        - DateTime preparationStartedAt
        - DateTime estimatedReadyTime
    }

    DomainEvent OrderReady {
        - OrderId orderId
        - String VivaConsumerId
        - OrderType orderType
        - DateTime readyAt
        - String pickupCode                      // For Click & Collect verification
    }

    DomainEvent OrderHandedOver {
        - OrderId orderId
        - String VivaConsumerId
        - DateTime handedOverAt
        - String handoverMethod                  // DRIVER, PICKUP
        - String completedBy
    }

    DomainEvent OrderCancelled {
        - OrderId orderId
        - String VivaConsumerId
        - DateTime cancelledAt
        - String cancellationReason
        - String cancelledBy                     // CUSTOMER, STORE, SYSTEM
    }

    // --- Delivery Tracking Events ---

    DomainEvent DriverAssigned {
        - OrderId orderId
        - String VivaConsumerId
        - String driverId
        - String driverName
        - String driverPhone
        - DateTime assignedAt
        - DateTime estimatedDeliveryTime
    }

    DomainEvent DriverEnRoute {
        - OrderId orderId
        - String VivaConsumerId
        - String driverId
        - GeoLocation driverLocation
        - DateTime estimatedArrival
    }

    DomainEvent OrderPickedUpByDriver {
        - OrderId orderId
        - String VivaConsumerId
        - String driverId
        - DateTime pickedUpAt
        - DateTime estimatedDeliveryTime
    }

    DomainEvent DeliveryLocationUpdated {
        - OrderId orderId
        - String driverId
        - GeoLocation driverLocation
        - DateTime updatedAt
    }

    // ========================================================================
    // SECTION 3: DOMAIN SERVICES
    // ========================================================================

    Service OrderManagementService {
        // Create new delivery or pickup order
        createOrder(@String vivaConsumerId, @OrderType orderType, @List<OrderItem> items, @DeliveryAddress address) : OrderId

        // Modify order (before preparation starts)
        modifyOrder(@OrderId orderId, @List<OrderItem> items) : boolean

        // Cancel order
        cancelOrder(@OrderId orderId, @String reason) : boolean

        // Confirm order (store accepts)
        confirmOrder(@OrderId orderId, @DateTime estimatedReadyTime) : boolean

        // Mark order as ready for pickup/delivery
        markOrderReady(@OrderId orderId) : boolean
    }

    Service DeliveryFeeCalculator {
        // Calculate delivery fee based on address and store
        calculateDeliveryFee(@StoreId storeId, @DeliveryAddress address) : Money

        // Estimate delivery time
        estimateDeliveryTime(@StoreId storeId, @DeliveryAddress address) : int  // Minutes

        // Check if address is in delivery zone
        isDeliverable(@StoreId storeId, @DeliveryAddress address) : boolean

        // Find nearest store for delivery
        findNearestStore(@DeliveryAddress address) : StoreId
    }

    Service DeliveryProviderService {
        // Request driver for delivery from third-party provider (white-label)
        // ACL translates OTR domain model to provider-specific API
        requestDriver(@OrderId orderId, @StoreId pickupStoreId, @DeliveryAddress deliveryAddress) : String  // Returns provider delivery ID

        // Cancel driver request with provider
        cancelDriverRequest(@String externalDeliveryId) : boolean

        // Get real-time driver location from provider
        getDriverLocation(@String externalDeliveryId) : GeoLocation

        // Get delivery status from provider
        getDeliveryStatus(@String externalDeliveryId) : DeliveryStatus

        // Estimate delivery quote from provider
        getDeliveryQuote(@StoreId pickupStoreId, @DeliveryAddress deliveryAddress) : Money
    }

    Service AddressValidationService {
        // Validate and geocode delivery address
        validateAddress(@DeliveryAddress address) : DeliveryAddress  // Returns address with coordinates

        // Suggest address corrections
        suggestAddressCorrections(@String partialAddress) : List<DeliveryAddress>
    }

    // ========================================================================
    // SECTION 4: VALUE OBJECTS
    // ========================================================================

    ValueObject Money {
        - Decimal amount
        - String currency  // AUD
    }

    ValueObject OrderId {
        - String id
    }

    ValueObject StoreId {
        - String id
    }

    ValueObject ZoneId {
        - String id
    }

    ValueObject PaymentMethodId {
        - String id
    }
}

// ============================================================================
// END OF BOUNDED CONTEXT
// ============================================================================
//
// Implementation Notes:
// ---------------------
// - Third-party delivery provider integration via ACL (vendor-agnostic)
// - Initial provider: DoorDash Drive API (white-label, maintains OTR branding)
// - Provider can be switched (DoorDash → Uber Eats → Deliveroo) without domain changes
// - Azure Cosmos DB for order storage (partitioned by VivaConsumerId)
// - Real-time driver tracking via provider webhooks (translated by ACL)
// - Azure Notification Hubs for order status push notifications
// - D365 Commerce integration for product catalog and inventory
// - PaymentService integration for order payment processing
// - LoyaltyService integration for points earning on delivery orders
//
// Integration Patterns:
// ---------------------
// - Delivery Provider: Customer-Supplier with ACL
//   * ACL (DeliveryProviderAdapter) translates between OTR domain and provider API
//   * Supported providers: DoorDash, Uber Eats (Direct), Deliveroo, MenuLog
//   * White-label configuration maintains OTR branding
// - D365 Commerce: Customer-Supplier (product catalog, inventory queries)
// - PaymentService: Bidirectional (we request payment, they confirm)
// - LoyaltyService: Event-driven (publish OrderHandedOver → points awarded)
//
// ACL Responsibilities (DeliveryProviderAdapter):
// ------------------------------------------------
// - Translate OTR order model to provider delivery request format
// - Translate provider driver tracking webhooks to OTR domain events
// - Handle provider-specific authentication and rate limiting
// - Normalize delivery status codes across providers
// - Abstract provider-specific features behind common interface
// - Enable A/B testing of multiple providers
//
// Delivery Flow (Home Delivery):
// -------------------------------
// 1. Customer places order in OTR App
// 2. HandoverService validates address and calculates fee
// 3. Order sent to PaymentService for authorisation
// 4. Order confirmed and sent to store for preparation
// 5. Store marks order as preparing
// 6. Store marks order as ready
// 7. HandoverService.DeliveryProviderService.requestDriver() via ACL
// 8. Driver assigned → customer notified
// 9. Driver en route to store → real-time tracking
// 10. Driver picks up order from store
// 11. Driver en route to customer → real-time tracking
// 12. Order delivered → customer confirms
// 13. OrderHandedOver event → LoyaltyService awards points
//
// Click & Collect Flow:
// ---------------------
// 1. Customer places order in OTR App with pickup time
// 2. Order sent to PaymentService for authorisation
// 3. Order confirmed and sent to store for preparation
// 4. Store marks order as preparing
// 5. Store marks order as ready → customer notified
// 6. Customer arrives at store
// 7. Customer provides pickup code
// 8. Store staff verifies code and hands over order
// 9. OrderHandedOver event (pickup) → LoyaltyService awards points
//
// Vendor Independence Benefits:
// ------------------------------
// - Switch providers based on cost, service quality, coverage
// - A/B test multiple providers in same market
// - Negotiate better rates with leverage of multi-provider capability
// - Reduce single-vendor dependency risk
// - Support regional providers for specific markets
//
// Strategic Considerations:
// --------------------------
// - OTR brand only (not REXP/SPS initially)
// - White-label maintains OTR brand experience across all providers
// - Delivery expands revenue beyond physical store hours
// - Click & Collect reduces delivery costs while maintaining convenience
// - Loyalty integration drives delivery adoption
// - Future: Expand to pharmacy, groceries, alcohol
// - Provider flexibility enables market-specific optimization
// ============================================================================
