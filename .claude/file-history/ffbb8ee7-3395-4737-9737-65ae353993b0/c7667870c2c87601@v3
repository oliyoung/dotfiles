/*
 * Payment Service - Bounded Context Definition
 * =============================================
 *
 * Core payment processing service handling all payment operations across OTR and
 * Reddy Express brands, including mobile wallet integration (Apple Pay, Google Pay),
 * fuel pre-authorisation, and subscription billing.
 *
 * Business Context (CY26 Strategy):
 * ---------------------------------
 * Apple Pay & Google Pay integration is HIGHEST PRIORITY (Q1 CY26):
 * - Represents 40% of EMV payments in Australia
 * - #1 competitive gap vs. Ampol, BP, 7-Eleven
 * - Critical for pay-at-pump reliability and execution quality
 * - Required for unmanned 24/7 fuel capability
 * - Key differentiator: instant e-receipts, offline-tolerant flows
 *
 * Domain Coverage:
 * ----------------
 * - Payment processing (in-app purchases, pay-at-pump, in-store)
 * - Mobile wallet integration (Apple Pay, Google Pay, Samsung Pay)
 * - Pre-authorisation flows (fuel pumps with variable amounts)
 * - Payment tokenization and secure storage
 * - Refund and reversal processing
 * - Receipt generation and delivery
 * - Subscription billing
 * - Fraud detection
 *
 * Integration Points:
 * -------------------
 * - Upstream: Payment gateway (provider TBD), Apple Pay Platform, Google Pay Platform
 * - Downstream: LoyaltyService (reward redemption), D365 Commerce (transaction completion)
 * - Events: PaymentAuthorised, PaymentCaptured, PaymentFailed, RefundProcessed
 *
 * NOT in this context (owned by other systems):
 * - Transaction baskets → D365 Commerce
 * - Loyalty points redemption logic → LoyaltyService
 * - Customer payment preferences → Salesforce
 */

import "../domains/payment.cml"

BoundedContext PaymentService implements PaymentDomain {

    type = FEATURE

    // Strategic DDD Classification: CORE_DOMAIN | SUPPORTING_DOMAIN | GENERIC_DOMAIN
    // SUPPORTING_DOMAIN: Critical for business operation and execution quality matters (offline-tolerant
    // flows, instant e-receipts), but payment processing itself is commoditized via platform providers
    strategicClassification = "SUPPORTING_DOMAIN"

    domainVisionStatement = "Handles payment processing, mobile wallet integration (Apple Pay, Google Pay), fuel pre-authorisation, and subscription billing across all VER brands. Provides secure, reliable, offline-tolerant payment flows with instant receipt delivery."

    responsibilities = "Payment processing (in-app, pay-at-pump, in-store)",
                      "Mobile wallet integration (Apple Pay, Google Pay, Samsung Pay)",
                      "Fuel pre-authorisation with variable amounts",
                      "Payment tokenization and secure storage",
                      "Transaction management and reconciliation",
                      "Refund and reversal processing",
                      "Instant e-receipt generation and delivery",
                      "Payment gateway integration (provider TBD)",
                      "Fraud detection and prevention",
                      "Subscription billing and recurring payments"

    implementationTechnology = "Azure Functions, .NET Core, Payment Gateway API (provider TBD), Apple Pay SDK, Google Pay SDK, Azure Key Vault, Event Bus"

    // ========================================================================
    // SECTION 1: CORE AGGREGATES
    // ========================================================================

    // 1.1 PaymentTransaction Aggregate
    // ---------------------------------
    // Records payment transaction life-cycle including authorisations, captures, and refunds.
    // Supports multiple payment flows: standard purchase, fuel pre-authorisation, subscriptions.
    //
    // Invariants:
    // - Transaction must have valid payment method
    // - Capture amount cannot exceed authorised amount (pre-auth)
    // - Refund amount cannot exceed captured amount
    // - Each transaction must have unique idempotency key
    //
    // Pre-authorisation Flow (Fuel Pumps):
    // 1. authorised: Hold amount on customer's card (e.g., $150)
    // 2. FUEL_DISPENSED: Customer fills tank (e.g., $87.50)
    // 3. CAPTURED: Capture actual amount ($87.50)
    // 4. RELEASED: Release remaining hold ($62.50)
    Aggregate PaymentTransaction {
        Entity Transaction {
            aggregateRoot

            - TransactionId id
            - String VivaConsumerId                // Salesforce guest identifier
            - Money authorisedAmount               // Initial authorisation (pre-auth)
            - Money capturedAmount                 // Actual captured amount
            - PaymentMethodId paymentMethodId
            - TransactionType transactionType      // PURCHASE, PRE_AUTH_FUEL, SUBSCRIPTION
            - TransactionStatus status
            - DateTime transactionDate
            - StoreId storeId
            - String pumpId                        // For fuel transactions
            - String merchantId
            - String gatewayTransactionId          // Payment gateway transaction reference
            - String idempotencyKey                // For duplicate prevention
            - RefundDetails refundInfo
            - ReceiptInfo receiptInfo
            - PreAuthDetails preAuthDetails        // For fuel pre-authorisation
        }

        ValueObject TransactionType {
            - TypeCode type  // PURCHASE, PRE_AUTH_FUEL, SUBSCRIPTION, REFUND
        }

        ValueObject TransactionStatus {
            - StatusCode status  // PENDING, authorised, CAPTURED, COMPLETED, FAILED, REFUNDED, PARTIALLY_REFUNDED
            - String failureReason
            - DateTime statusChangedAt
        }

        ValueObject RefundDetails {
            - Money refundAmount
            - DateTime refundDate
            - String refundReason
            - String refundedBy                    // USER_REQUEST, SYSTEM, CUSTOMER_SERVICE
            - String refundTransactionId
        }

        ValueObject ReceiptInfo {
            - String receiptId
            - String receiptUrl                    // Azure Blob Storage URL
            - DateTime generatedAt
            - DateTime deliveredAt
            - String deliveryMethod                // EMAIL, PUSH_NOTIFICATION, SMS
            - boolean isDelivered
        }

        ValueObject PreAuthDetails {
            - Money authorisedAmount               // e.g., $150 hold
            - Money actualAmount                   // e.g., $87.50 fuel dispensed
            - Money releasedAmount                 // e.g., $62.50 released back
            - DateTime authorisedAt
            - DateTime capturedAt
            - DateTime releasedAt
            - int secondsToAutoRelease             // e.g., 7200 (2 hours)
        }
    }

    // 1.2 PaymentMethodProfile Aggregate
    // -----------------------------------
    // Stores customer payment methods with secure tokenization.
    // Supports mobile wallets (Apple Pay, Google Pay) and traditional cards.
    //
    // Invariants:
    // - Customer can only have one default payment method per brand
    // - Tokens must be encrypted at rest (Azure Key Vault)
    // - Expired payment methods must be removed or updated
    //
    // Mobile Wallet Integration:
    // - Apple Pay: Apple-provided device-specific token
    // - Google Pay: Google-provided pan token
    // - Tokens never expose actual card details
    Aggregate PaymentMethodProfile {
        Entity PaymentMethod {
            aggregateRoot

            - PaymentMethodId id
            - String VivaConsumerId                // Salesforce guest identifier
            - MethodType type                      // APPLE_PAY, GOOGLE_PAY, SAMSUNG_PAY, CREDIT_CARD, DEBIT_CARD
            - String token                         // Tokenized payment details (encrypted)
            - WalletProviderDetails walletDetails  // For mobile wallets
            - CardDetails cardDetails              // For traditional cards
            - Boolean isDefault
            - DateTime addedDate
            - DateTime lastUsedDate
            - DateTime expiryDate
            - String brandContext                  // OTR, SPS
        }

        ValueObject WalletProviderDetails {
            - WalletProvider provider              // APPLE_PAY, GOOGLE_PAY, SAMSUNG_PAY
            - String deviceId                      // Device-specific identifier
            - String walletToken                   // Provider-specific token
            - String last4Digits                   // Last 4 digits for display
            - String cardNetwork                   // VISA, MASTERCARD, AMEX
            - DateTime tokenExpiryDate
        }

        ValueObject CardDetails {
            - String last4Digits
            - String cardNetwork                   // VISA, MASTERCARD, AMEX
            - String cardBrand
            - String expiryMonth
            - String expiryYear
            - String cardholderName
            - String billingPostcode
        }

        ValueObject MethodType {
            - TypeCode type  // APPLE_PAY, GOOGLE_PAY, SAMSUNG_PAY, CREDIT_CARD, DEBIT_CARD
        }
    }

    // 1.3 SubscriptionPlan Aggregate
    // -------------------------------
    // Manages subscription-based loyalty programmes and recurring payments.
    // Integrates with payment methods for automatic billing.
    Aggregate SubscriptionPlan {
        Entity Subscription {
            aggregateRoot

            - SubscriptionId id
            - String VivaConsumerId                // Salesforce guest identifier
            - PaymentMethodId paymentMethodId
            - PlanType planType                    // MONTHLY, ANNUAL
            - Money recurringAmount
            - SubscriptionStatus status
            - DateTime startDate
            - DateTime nextBillingDate
            - Integer failedPaymentAttempts
            - BillingSchedule schedule
        }

        ValueObject SubscriptionStatus {
            - StatusType status  // ACTIVE, PAUSED, CANCELLED, PAST_DUE
            - String statusReason
            - DateTime statusChangedDate
        }

        ValueObject BillingSchedule {
            - BillingFrequency frequency           // MONTHLY, ANNUAL
            - Integer dayOfMonth
            - Integer retryAttempts
            - Integer daysBetweenRetries
        }
    }

    // ========================================================================
    // SECTION 2: DOMAIN EVENTS
    // ========================================================================
    // Events published to Event Bus for downstream consumption.
    // ========================================================================

    // --- Payment Transaction Events ---

    DomainEvent PaymentAuthorised {
        - TransactionId transactionId
        - String VivaConsumerId
        - Money authorisedAmount
        - PaymentMethodId paymentMethodId
        - String gatewayTransactionId
        - DateTime authorisedAt
        - TransactionType transactionType         // PURCHASE, PRE_AUTH_FUEL
        - String pumpId                           // For fuel pre-auth
    }

    DomainEvent PaymentCaptured {
        - TransactionId transactionId
        - String VivaConsumerId
        - Money capturedAmount
        - Money authorisedAmount                  // Original authorisation
        - DateTime capturedAt
        - String receiptUrl
    }

    DomainEvent PaymentFailed {
        - TransactionId transactionId
        - String VivaConsumerId
        - Money attemptedAmount
        - String failureReason
        - String failureCode
        - DateTime failedAt
        - boolean isRetryable
    }

    DomainEvent PreAuthReleased {
        - TransactionId transactionId
        - String VivaConsumerId
        - Money releasedAmount                    // Amount released back to customer
        - DateTime releasedAt
        - String pumpId
    }

    DomainEvent RefundProcessed {
        - TransactionId originalTransactionId
        - TransactionId refundTransactionId
        - String VivaConsumerId
        - Money refundAmount
        - String refundReason
        - DateTime processedAt
    }

    DomainEvent ReceiptDelivered {
        - TransactionId transactionId
        - String VivaConsumerId
        - String receiptUrl
        - String deliveryMethod                   // EMAIL, PUSH_NOTIFICATION, SMS
        - DateTime deliveredAt
    }

    // --- Payment Method Events ---

    DomainEvent PaymentMethodAdded {
        - PaymentMethodId paymentMethodId
        - String VivaConsumerId
        - MethodType methodType                   // APPLE_PAY, GOOGLE_PAY, CREDIT_CARD
        - String last4Digits
        - DateTime addedAt
        - boolean isDefault
        - String brandContext                     // OTR, SPS
    }

    DomainEvent PaymentMethodRemoved {
        - PaymentMethodId paymentMethodId
        - String VivaConsumerId
        - DateTime removedAt
        - String reason
    }

    DomainEvent PaymentMethodExpired {
        - PaymentMethodId paymentMethodId
        - String VivaConsumerId
        - DateTime expiredAt
    }

    // --- Subscription Events ---

    DomainEvent SubscriptionBilled {
        - SubscriptionId subscriptionId
        - String VivaConsumerId
        - Money billedAmount
        - DateTime billedAt
        - DateTime nextBillingDate
    }

    DomainEvent SubscriptionPaymentFailed {
        - SubscriptionId subscriptionId
        - String VivaConsumerId
        - Money attemptedAmount
        - String failureReason
        - int failedAttempts
        - DateTime nextRetryDate
    }

    // ========================================================================
    // SECTION 3: DOMAIN SERVICES
    // ========================================================================

    Service FuelPreAuthService {
        // Authorize fuel pre-auth (hold amount on card)
        authorizePreAuth(@String vivaConsumerId, @PaymentMethodId paymentMethodId, @Money authorisedAmount, @String pumpId) : TransactionId

        // Capture actual fuel amount and release remaining hold
        captureFuelAmount(@TransactionId transactionId, @Money actualAmount) : boolean

        // Release pre-auth hold (timeout or cancellation)
        releasePreAuth(@TransactionId transactionId) : boolean

        // Auto-release pre-auths older than timeout
        autoReleaseExpiredPreAuths() : List<TransactionId>
    }

    Service MobileWalletService {
        // Tokenize Apple Pay payment method
        tokenizeApplePayMethod(@String vivaConsumerId, @String applePayToken, @String deviceId) : PaymentMethodId

        // Tokenize Google Pay payment method
        tokenizeGooglePayMethod(@String vivaConsumerId, @String googlePayToken, @String deviceId) : PaymentMethodId

        // Validate mobile wallet token
        validateWalletToken(@PaymentMethodId paymentMethodId) : boolean

        // Refresh expired wallet token
        refreshWalletToken(@PaymentMethodId paymentMethodId) : boolean
    }

    Service ReceiptService {
        // Generate receipt for transaction
        generateReceipt(@TransactionId transactionId) : String  // Returns receipt URL

        // Deliver receipt via specified method
        deliverReceipt(@TransactionId transactionId, @String deliveryMethod) : boolean

        // Regenerate receipt (customer request)
        regenerateReceipt(@TransactionId transactionId) : String
    }

    Service PaymentGatewayService {
        // Process payment via payment gateway
        processPayment(@Transaction transaction) : boolean

        // Process refund via payment gateway
        processRefund(@TransactionId transactionId, @Money refundAmount, @String reason) : boolean

        // Check transaction status with gateway
        checkTransactionStatus(@String gatewayTransactionId) : TransactionStatus
    }

    // ========================================================================
    // SECTION 4: VALUE OBJECTS
    // ========================================================================

    ValueObject Money {
        - Decimal amount
        - String currency  // AUD
    }

    ValueObject TransactionId {
        - String id
    }

    ValueObject PaymentMethodId {
        - String id
    }

    ValueObject SubscriptionId {
        - String id
    }

    ValueObject StoreId {
        - String id
    }
}

// ============================================================================
// END OF BOUNDED CONTEXT
// ============================================================================
//
// Implementation Notes:
// ---------------------
// - Apple Pay integration via PassKit framework (iOS)
// - Google Pay integration via Google Pay API for Passes
// - Payment gateway handles actual payment processing (provider TBD)
// - Payment tokens encrypted with Azure Key Vault
// - Pre-auth timeout configured per site (default: 2 hours)
// - Instant receipt delivery via Azure Notification Hubs (push) or SendGrid (email)
// - Offline payment queue for network failures (sync when online)
//
// Security Considerations:
// ------------------------
// - PCI DSS compliance: Never store actual card details
// - Mobile wallet tokens are device-specific and encrypted
// - All payment data encrypted in transit (TLS 1.3)
// - All payment data encrypted at rest (Azure Key Vault)
// - Idempotency keys prevent duplicate charges
//
// Fuel Pre-authorisation Flow:
// -----------------------------
// 1. Customer selects pump and payment method in app
// 2. PaymentService authorizes pre-auth hold (e.g., $150)
// 3. Pump unlocked for fueling
// 4. Customer fills tank (e.g., $87.50)
// 5. Pump signals completion
// 6. PaymentService captures actual amount ($87.50)
// 7. PaymentService releases remaining hold ($62.50)
// 8. Receipt generated and delivered instantly
// 9. Transaction sent to D365 Commerce
// 10. LoyaltyService adjudicates rewards
// ============================================================================