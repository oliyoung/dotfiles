= Loyalty Bounded Context
O.Young@otr.com.au
v0.1, 2025-12-19
:project-name: OTRG Apps & Ecommerce Architecture
:togaf-adm-phase: Phase C: Information Systems Architectures
:document-type: Bounded Context
:status: Draft
:version: 0.1
:domain: Loyalty
:bounded-context-type: CORE_BOUNDED_CONTEXT
:domain-architect: O.Young@otr.com.au
:doctype: article
:toc: left
:toclevels: 4
:sectanchors:
:sectlinks:
:sectnums:
:icons: font
:source-highlighter: highlightjs
:experimental:
:description: Bounded Context for the Loyalty Domain
:keywords: loyalty, bounded context, togaf, ddd


Core service for loyalty programme management across all OTRG brands
(OTRG[OTRG], link:Reddy%2520Express%2520%28REXP[Reddy
Express (REXP)].md), Liberty[Liberty] and
Dealer Operated[Dealer Operated] sites). This
service orchestrates loyalty operations, integrates with external
loyalty platforms
(link:external/eagle_eye.adoc[EagleEye],
link:external/flybuys.adoc[Flybuys]), and publishes
domain events to downstream services.

== Aggregates

[width="100%",cols="11%,89%",options="header",]
|===
|Aggregate Name |Description
|`RewardTransaction` |Represents a loyalty reward transaction
(earn/redeem) associated with a
link:interfaces/otr_pos.adoc[OTR POS] or
link:interfaces/otr_plus_pos.adoc[OTR+ POS]
transaction. Contains summary details for display and reconciliation.
Tracks which loyalty schemes (FLYBUYS, INTERNAL_OTR) participated in the
transaction for audit purposes.
|===

== Services

[width="100%",cols="19%,81%",options="header",]
|===
|Service Name |Description
|`TransactionSummaryService` |Generate human-readable item summaries
from transaction, count items in basket

|`PointsQueryService` |Query points balances and history by scheme.
Provides `getCustomerVisibleBalance()` (Flybuys only) and
`getAllSchemeBalances()` (all schemes for analytics)

|`ProfileServiceIntegration` |Query ProfileService for partner link
status and reward preferences during transaction adjudication

|`TransactionClassifier` |Domain service containing business rules for
classifying transactions for partner points posting (Flybuys batch file
generation)

|`CampaignQueryService` |Query campaign eligibility and active campaigns
from EagleEye

|`WalletQueryService` |Query wallet contents from EagleEye (grants,
offers, discounts, stored value balance)

|`BarcodeResolutionService` |Resolves barcodes to customer identity and
partner linking status. Enables POS to determine customer, reward
preference, and apply appropriate rewards

|`IPartnerPointsService` |Generic interface for partner points
operations. Implementations: FlybuysPointsService (Conformist),
ShellPointsService (future)

|`IPartnerLinkingService` |Generic interface for partner account linking
operations. Implementations: FlybuysLinkingService (OAuth 2.0 via
Auth0), future partners

|`IPartnerDocketService` |Generic interface for partner digital
docket/voucher operations. Implementations: FlybuysDocketService (fuel
dockets from Coles), future partners
|===

=== NOT in this Context (Owned by Other Systems)

[width="100%",cols="22%,63%,15%",options="header",]
|===
|Action / Entity |Description |Relationship
|Campaigns/Promotions |Owned by
link:external/eagle_eye.adoc[EagleEye] |HTTPS API via
ACL

|Membership |Owned by
link:external/eagle_eye.adoc[EagleEye] |HTTPS API via
ACL

|OAuth Tokens |Managed by OAuth Service |Infrastructure

|Partner Linking Status |Owned by
link:profile.adoc[Profile Service] |HTTPS API

|Points Balance/Ledger |Owned by
link:external/eagle_eye.adoc[EagleEye] |HTTPS API via
ACL

|Reward Preferences |Owned by
link:profile.adoc[Profile Service] |HTTPS API

|Transaction Transactions |Full transaction details owned by
link:external/microsoft_dynamics_365_commerce.adoc[Microsoft
Dynamics 365 Commerce] |

|Wallet Grants/Offers |Owned by
link:external/eagle_eye.adoc[EagleEye] |HTTPS API via
ACL
|===

== Events

=== Events Published by LoyaltyService

==== Membership Events

[width="100%",cols="28%,47%,25%",options="header",]
|===
|Event Name |Description |Source
|`MemberEnrolled` |New member enrolled in loyalty programme |Aggregate +
EagleEye

|`MembershipSuspended` |Membership suspended (fraud, abuse, etc.)
|EagleEye webhook → ACL

|`MembershipReactivated` |Suspended membership reactivated |EagleEye
webhook → ACL
|===

==== Transaction & Points Events

[width="100%",cols="25%,54%,21%",options="header",]
|===
|Event Name |Description |Source
|`TransactionAdjudicated` |Transaction adjudication completed, rewards
determined |RewardTransaction agg.

|`PointsEarned` |Points earned in loyalty scheme (includes scheme
context: FLYBUYS or INTERNAL_OTR) |EagleEye webhook → ACL

|`PointsRedeemed` |Points redeemed in loyalty scheme (includes scheme
context) |EagleEye webhook → ACL

|`PointsExpired` |Points expired in loyalty scheme (includes scheme
context) |EagleEye webhook → ACL

|`PointsAdjusted` |Points manually adjusted in scheme (includes scheme
context) |EagleEye webhook → ACL
|===

*Note:* All points events include `scheme` field (FLYBUYS, INTERNAL_OTR)
enabling analytics and downstream services to differentiate between
schemes. Even though INTERNAL_OTR is dormant, events are published for
both schemes to enable data platform tracking.

==== Wallet & Grant Events

[width="100%",cols="20%,54%,26%",options="header",]
|===
|Event Name |Description |Source
|`GrantIssued` |Loyalty grant issued (fuel discount, product) |EagleEye
webhook → ACL

|`GrantRedeemed` |Loyalty grant redeemed |EagleEye webhook → ACL
|===

==== Flybuys Integration Events

[width="100%",cols="31%,50%,19%",options="header",]
|===
|Event Name |Description |Source
|`FlybuysPointsEarned` |Points earned in
link:external/flybuys.adoc[Flybuys] programme |Flybuys
API response

|`FlybuysBalanceUpdated`
|link:external/flybuys.adoc[Flybuys] points balance
changed |Flybuys API response

|`PartnerAccountLinked`
|link:external/flybuys.adoc[Flybuys] member linked to
OTR profile |Flybuys OAuth complete

|`PartnerAccountUnlinked`
|link:external/flybuys.adoc[Flybuys] member unlinked
from OTR profile |Flybuys API

|`FlybuysDealerTransactionPosted` |Transaction posted to dealer’s
link:external/flybuys.adoc[Flybuys] account (Shell)
|Batch file ACK

|`DailyPointsFileGenerated` |Daily partner points file generated for
transmission |Batch job

|`DailyPointsFileTransmitted` |Daily points file transmitted to partner
|Batch job

|`DailyPointsFileAcknowledged` |Partner acknowledged points file receipt
|Partner ACK file
|===

=== Events Consumed by LoyaltyService

[width="100%",cols="27%,24%,49%",options="header",]
|===
|Event Name |Published By |Purpose
|`PartnerLinked` |link:profile.adoc[Profile
Service] |Trigger eligibility check for partner rewards

|`PartnerUnlinked` |link:profile.adoc[Profile
Service] |Update reward eligibility, fallback to OTR

|`RewardPreferenceChanged`
|link:profile.adoc[Profile Service] |Update
transaction adjudication preference used
|===

== Feature Flags

[width="100%",cols="34%,66%",options="header",]
|===
|Flag |Description
|`OTR.Loyalty.Enabled` |Master switch for Loyalty Service functionality

|`OTR.Loyalty.TransactionAdjudication` |Enable
link:../ubiquitous_language.adoc#transaction-adjudication[Transaction
Adjudication]

|`OTR.Loyalty.RewardPreferenceSelection` |Enable
link:../ubiquitous_language.adoc#reward-preference[Reward Preference]
changes

|`OTR.Loyalty.PartnerLink.Flybuys` |Enable
link:external/flybuys.adoc[Flybuys] account linking via
link:interfaces/mobile.adoc[Mobile
Application]

|`OTR.Loyalty.PointsEarn.Flybuys` |Enable
link:external/flybuys.adoc[Flybuys] points earning
integration
|===

== Integrations

=== Upstream

* link:external/eagle_eye.adoc[EagleEye] (loyalty SaaS),
* link:../domains/profile.adoc[Profile Domain] (partner links,
reward preferences),
* link:external/flybuys.adoc[Flybuys] (coalition
partner)

=== Downstream

* link:engagement.adoc[Engagement Service],
* link:recommendation.adoc[RecommendationService]
(via events)

=== External

* PaymentService,
* Microsoft Entra External ID (authentication)

== Repositories

*Repositories in LoyaltyService:* - RewardTransactionRepository:
Persistence for RewardTransaction aggregate

*No repositories for:*

* Wallet (queried from EagleEye)
* Points ledger (queried from EagleEye)
* Membership/tiers (queried from EagleEye, except defensive upsert)
* Subscriptions (owned by SubscriptionService)
* Campaigns (queried from EagleEye)
* PartnerLink (moved to ProfileService) # Decisions

=== Dual-Scheme Points Tracking (Flybuys + Internal OTR Shadow Balance)

*Decision:* LoyaltyService tracks multiple loyalty schemes in parallel -
Flybuys partner points AND an internal OTR shadow points balance. Both
schemes are configured in EagleEye and updated atomically during
transaction adjudication.

*Rationale:*

* *Strategic Flexibility*: Maintains internal points balance
independently of partner relationship duration
* *System of Record*: EagleEye hosts BOTH schemes - LoyaltyService
remains BFF/orchestrator, not system of record
* *Simplicity*: All-or-nothing posting to both schemes (no complex
partial failure handling needed now)
* *Audit Trail*: RewardTransaction tracks which schemes participated for
debugging and reconciliation
* *Future Activation*: Internal scheme dormant now, but infrastructure
ready for product activation

*Implementation:*

* *EagleEye Configuration*: Two schemes per customer:
** FLYBUYS: Partner points scheme (transmitted to Flybuys via daily
batch)
** INTERNAL_OTR: Internal OTR points scheme (dormant, not
customer-visible)
* *RewardTransaction Aggregate*: `schemesParticipated` field tracks
which schemes were posted to
* *Domain Events*: `PointsEarned`, `PointsRedeemed`, `PointsExpired`,
`PointsAdjusted` include `scheme` context
* *Query Layer Separation*:
** `getCustomerVisibleBalance()`: Returns Flybuys only (current product)
** `getAllSchemeBalances()`: Returns both schemes (analytics,
backoffice)
** `getPointsBalance(scheme)`: Returns specific scheme balance
* *Adjudication*: Single EagleEye API call updates both schemes
atomically

*TOGAF Alignment:*

* *Business Architecture*: Supports reward preference flexibility and
partner independence strategy
* *Data Architecture*: EagleEye remains authoritative system of record
for all points data
* *Application Architecture*: LoyaltyService BFF pattern maintained - no
new aggregates needed
* *Technology Architecture*: Leverages existing EagleEye multi-scheme
capability (no new infrastructure)

*Future Evolution:*

* Internal scheme activation: Change `getCustomerVisibleBalance()` to
return INTERNAL_OTR instead of FLYBUYS
* Independent failure handling: Extend RewardTransaction to track
per-scheme status if business rules diverge
* Customer choice: Add reward preference UI to select visible scheme
(Flybuys vs OTR points)

=== Transaction Transactions Don’t Belong in LoyaltyService

*Decision:* LoyaltyService stores transaction summaries, not full
transaction details.

*Rationale:*

* D365 Commerce Context owns transaction details (transaction, line
items, receipt)
* LoyaltyService only needs summary for reward history display
* Storing transactions would duplicate POS data
* Bounded context boundary: ``what was purchased'' vs ``what rewards
were earned''

*Implementation:*

* RewardTransaction aggregate stores itemCount and itemSummary for
display
* Example: ``2 items - Fuel, Coffee'' instead of full product details
* Reference to POS transaction via sourceTransactionId for full details

=== OAuth Tokens Managed by Infrastructure Service

*Decision:* OAuth token management is handled by a generic
infrastructure OAuth Service, not within LoyaltyService domain.

*Rationale:*

* OAuth token life-cycle is infrastructure concern, not domain logic
* Generic OAuth Service can be used by ANY OTR system (not just loyalty)
* PartnerLink aggregate only tracks business fact: ``customer linked
partner''
* OAuth Service handles: token storage, refresh, revocation
*Implementation:*
* PartnerLink aggregate contains oauthProviderId reference to OAuth
Service
* OAuth Service handles entire OAuth flow, notifies LoyaltyService when
complete
* LoyaltyService creates PartnerLink in response to OAuthLinkEstablished
event
* Domain focuses on linking status, infrastructure handles tokens

=== Wallet Subdomain Owned by EagleEye

*Decision:* Wallet data (grants, fuel discounts, product offers) is
owned by EagleEye, queried in real-time. *Rationale:*

* EagleEye AIR platform is system of record for wallet contents
* Storing wallet locally would create sync issues
* Wallet grants are loyalty platform feature (EagleEye’s core
capability)
* LoyaltyService acts as facade/BFF, not system of record
*Implementation:*
* LoyaltyService queries EagleEye API via ACL when displaying wallet
* No local wallet storage - always query fresh data
* GrantIssued, GrantRedeemed events published based on EagleEye webhooks
* ACL translates EagleEye wallet model to OTR domain language

=== Points Subdomain Owned by EagleEye

*Decision:* Points balance and ledger are owned by EagleEye, queried in
real-time. *Rationale:*

* EagleEye manages points balance across multiple programs/schemes
* Points calculation rules defined in EagleEye
* EagleEye provides ``Account Transactions'' (ledger)
* Maintaining separate ledger would cause sync issues *Implementation:*
* LoyaltyService queries EagleEye API via ACL for balance display
* No local ledger storage - EagleEye is source of truth
* PointsEarned, PointsRedeemed, PointsExpired events published based on
EagleEye webhooks
* ACL translates EagleEye account transactions to OTR domain events

=== Membership Subdomain Owned by EagleEye

*Decision:* Membership enrollment, tiers, and progression are owned by
EagleEye. *Rationale:*

* EagleEye ``Schemes'' define tier structures and progression rules
* Tier benefits and progression logic configured in EagleEye
* Multiple loyalty programs managed by EagleEye
* LoyaltyService queries tier status, doesn’t manage it
*Implementation:*
* LoyaltyService queries EagleEye for current tier via ACL
* ACL translates EagleEye scheme/tier model to OTR domain language
* Minor exception: Simple Member record created on-demand for
transaction adjudication (defensive upsert)

=== Campaigns Subdomain Owned by EagleEye

*Decision:* Campaign management and promotional rules are owned by
EagleEye. *Rationale:*

* EagleEye ``Campaigns'' define reward rules and eligibility criteria
* Marketing team configures campaigns in EagleEye dashboard
* Campaign execution happens in EagleEye during adjudication
* Promotional logic owned by loyalty platform *Implementation:*
* LoyaltyService queries active campaigns from EagleEye via ACL
* Campaign eligibility evaluated by EagleEye during transaction
adjudication
* CampaignActivated event published based on EagleEye webhooks (if
needed)
* ACL translates EagleEye campaign model to OTR domain language

=== Subscriptions Owned by Separate Bounded Context

*Decision:* Subscription management belongs in a separate
SubscriptionService bounded context, not in LoyaltyService. *Rationale:*

* Subscription management is distinct business capability
* Integrates with payment gateway for recurring billing (note: this will
NOT be DataMesh - this is not one of their product offerings)
* Subscription life-cycle independent from loyalty rewards
* Clear bounded context boundary: billing vs. rewards *Implementation:*
* SubscriptionService bounded context owns subscription plans, billing,
payment coordination
* LoyaltyService subscribes to subscription life-cycle events
* Subscription benefits reflected in EagleEye tier/scheme configuration
* Event-driven integration between SubscriptionService and
LoyaltyService

=== LoyaltyService as Event Publisher for EagleEye

*Decision:* LoyaltyService translates EagleEye webhooks into OTR domain
events. *Rationale:*

* Third-party platforms (EagleEye, Braze) don’t publish to OTR’s Event
Hub
* LoyaltyService receives EagleEye webhooks → ACL translates → publishes
events
* Provides clean domain events in OTR’s ubiquitous language
* Other bounded contexts consume events without knowing about EagleEye
*Implementation:*
* EagleEye webhooks endpoint in LoyaltyService
* ACL translates webhook payloads to domain events
* Events like PointsEarned, GrantIssued published by LoyaltyService
* Event schemas reflect OTR domain model, not EagleEye’s model
* Documentation clarifies event sources (aggregate changes vs. webhook
translations)

=== Two-Phase transaction adjudication (Validation + Redemption)

*Decision:* LoyaltyService implements two-phase commit pattern for
reward transactions: Validation (pre-payment) and Redemption
(post-payment). *Rationale:*

* Customers need to see provisional rewards BEFORE paying (validation
phase)
* Payment method affects reward eligibility and point calculations
* Only finalise rewards AFTER payment captured (prevent fraud, handle
failed payments)
* Two phases ensure consistency between displayed rewards and actual
rewards earned
* Guards against payment method switching (validate with selected
method, redeem with actual method)

==== Payment Method Awareness

Different payment methods have different eligibility rules and earning
rates:

* *Promotional Grants/Discounts*: Payment methods with active grants may
exclude points on grant amounts
** Example: Shell Card with 8CPL/4CPL docket deals - NO points on grant
amounts, base points on net paid
* *Co-branded Payment Methods*: May have partner-specific bonus earning
rates or restrictions
** Example: Future Flybuys credit card might earn 2X points vs standard
1X
* *Digital Wallets*: May have different eligibility than physical cards
** Example: Apple Pay/Google Pay treated as standard credit card for
eligibility
* *BNPL/Gift Cards*: May have restricted eligibility or different
earning rates
** Example: Gift card purchases might not earn loyalty points
* Payment method metadata includes: type, active grants/discounts,
eligibility flags
* Payment method must be provided in validation phase to calculate
correct provisional points
* Re-validation in redemption phase ensures consistency with actual
payment method used *Implementation:* *Phase 1 (Validation):*
D365Commerce → LoyaltyService.validateTransaction(transaction,
paymentMethod)
* Applies payment-method-specific eligibility rules
* Returns provisional points/rewards customer will earn
* Displayed on payment screen before customer pays
* NO aggregate created (provisional calculation only)

*Phase 2 (Redemption):* D365Commerce →
LoyaltyService.redeemTransaction(transactionId, paymentConfirmation)

* Payment successfully captured
* Re-validates with actual payment method used (consistency check)
* Creates RewardTransaction aggregate with finalised points and payment
method metadata
* Queues for daily batch posting to loyalty partners
* Publishes TransactionAdjudicated domain event

*RewardTransaction aggregate stores paymentMethod for:*

* Audit trail (what payment method was used)
* Reconciliation (verify points calculated correctly)
* Analytics (payment method preferences, grant usage)
* Partner reporting (batch file generation may need payment method
context)

*Why This Matters:*

* Different payment methods represent different customer value
propositions
* Promotional grants affect partnership economics (e.g., Flybuys points
eligibility)
* Incorrect point calculations could lead to partnership disputes or
customer dissatisfaction
* Two-phase pattern provides clear separation: ``what customer will
earn'' vs ``what customer earned''
* Extensible to future payment types without architectural changes

== Patterns

=== Anti-Corruption Layer (ACL)

* EagleEye ACL: Translates between EagleEye’s domain model and
LoyaltyService domain
* Protects domain from external API changes
* Single place to update when EagleEye changes

=== Event-Driven Integration

* LoyaltyService publishes domain events to Event Bus
* Other contexts (EngagementService, RecommendationService) consume
events
* Loose coupling, temporal decoupling, scalability

=== Backend-for-Frontend (BFF)

* LoyaltyService acts as facade for mobile app
* Aggregates data from multiple sources (EagleEye, CRM, etc.)
* Provides clean API in OTR’s domain language

=== Query-Only for External Data

* Wallet, points, tiers queried in real-time from EagleEye
* No local caching/replication (simplicity over performance)
* EagleEye is single source of truth

=== Defensive Programming

* Auto-create member records if missing (data sync resilience)
* Graceful degradation when EagleEye unavailable
* Publish monitoring events for unusual occurrences

=== DDD Principles Applied

==== Bounded Context Boundaries

===== Don`t duplicate data across contexts

* Transaction transactions → POS owns
* Customer preferences → CRM owns
* Loyalty balances → EagleEye owns

===== Store only what you need

* Transaction summary, not full transaction
* Link status, not OAuth tokens
* Adjudication result, not calculation logic

===== Use references, not copies

* sourceTransactionId → POS transaction
* oauthProviderId → OAuth Service token
* externalMemberId → Partner account

===== Identify true system of record

* Points balance → EagleEye (they calculate it)
* Tier levels → EagleEye (they manage progression)
* Wallet grants → EagleEye (they issue them)

===== Infrastructure vs. Domain

* OAuth tokens → Infrastructure
* Linking status → Domain
* API calls → Infrastructure
* Business rules → Domain
