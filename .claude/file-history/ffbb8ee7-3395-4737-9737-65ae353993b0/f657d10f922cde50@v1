/*
 * EngagementService - Bounded Context Definition
 * ===============================================
 *
 * BIDIRECTIONAL customer engagement service for outbound marketing and inbound customer communications.
 *
 * See engagement.adoc for comprehensive architecture documentation, decision log, and patterns.
 */

import "../domains/engagement.cml"

BoundedContext EngagementService implements EngagementDomain {

    type = FEATURE
    domainVisionStatement = "Enable bidirectional customer engagement through outbound marketing automation and inbound communication management. Routes behavioral events to marketing platforms and manages customer-initiated messages, feedback, and support requests."

    responsibilities = "Outbound: Real-time event streaming to Braze",
                      "Outbound: ACL translation for marketing platforms",
                      "Inbound: Customer message and inquiry routing",
                      "Inbound: Support request triage and case creation",
                      "Inbound: Multi-source feedback aggregation"

    implementationTechnology = "Azure Functions, Event Bus, Braze API, Salesforce Service Cloud API, Webhooks"

    // ========================================================================
    // AGGREGATES
    // ========================================================================
    // EngagementService owns ZERO aggregates. It is a fully stateless service
    // that provides routing, enrichment, and ACL translation.
    //
    // OUTBOUND (Marketing): Stateless event routing to Braze
    // INBOUND (Customer Communications): Stateless routing to Salesforce Service Cloud
    //
    // All state owned by specialized systems:
    // - Campaign content and execution → Braze
    // - Customer inquiries and case resolution → Salesforce Service Cloud
    // - Customer profiles → Salesforce (Profile)
    // - Aggregated analytics → EDP
    //
    // EngagementService is a pure routing and translation layer.
    // ========================================================================

    // NO AGGREGATES - EngagementService is fully stateless

    // ========================================================================
    // DOMAIN EVENTS
    // ========================================================================
    // Events published by EngagementService for downstream consumption.
    //
    // Event Categories:
    // 1. INBOUND: Customer inquiry events (new)
    // 2. INBOUND: Support request events (new)
    // 3. INBOUND: Marketing engagement events from Braze webhooks (new)
    // 4. INBOUND: Feedback events (expanded)
    // 5. OUTBOUND: Survey platform webhooks → ACL translation (existing)
    //
    // Note: EngagementService does NOT republish loyalty/transaction events.
    // It consumes them and translates to Braze track events, but doesn't
    // republish to OTR Event Hub (other contexts subscribe directly to sources).
    // ========================================================================

    // --- Customer Inquiry Events (NEW - Inbound Communications) ---

    DomainEvent InquiryReceived {
        - InquiryId inquiryId
        - String VivaConsumerId
        - InquiryChannel channel
        - InquiryCategory category
        - Priority priority
        - String subject
        - String messageBody
        - DateTime receivedAt
    }

    DomainEvent InquiryRouted {
        - InquiryId inquiryId
        - String VivaConsumerId
        - RoutingDestination destination
        - String salesforceCaseId              // If routed to Salesforce (optional)
        - DateTime routedAt
    }

    // --- Support Request Events (NEW - Support Case Management) ---

    DomainEvent SupportRequestCreated {
        - SupportRequestId requestId
        - String VivaConsumerId
        - RequestType requestType
        - Priority priority
        - String description
        - Map<String, String> contextData
        - DateTime createdAt
    }

    DomainEvent SalesforceCaseCreated {
        - SupportRequestId requestId
        - String VivaConsumerId
        - String salesforceCaseId
        - String salesforceCaseNumber
        - DateTime caseCreatedAt
    }

    // --- Engagement Tier Events (NEW - For ProfileService Integration) ---

    DomainEvent EngagementTierChanged {
        - String VivaConsumerId
        - EngagementTier previousTier
        - EngagementTier newTier
        - DateTime changedAt
        - String trigger                   // CAMPAIGN_RESPONSE | APP_USAGE | SUPPORT_INTERACTION | CALCULATED
    }

    enum EngagementTier {
        HIGHLY_ENGAGED,                    // Active campaign participation, high app usage
        ENGAGED,                           // Moderate engagement
        DISENGAGED                         // Low/no engagement
    }

    // --- Marketing Engagement Events (NEW - Braze Webhooks Inbound) ---
    // Events received from Braze webhooks tracking customer engagement with marketing communications

    DomainEvent CommunicationSent {
        - String communicationId                // Braze message/campaign ID
        - String VivaConsumerId
        - CommunicationType type                // EMAIL | PUSH | SMS | IN_APP
        - String campaignId                     // Braze campaign ID
        - String canvasId                      // Braze canvas ID (if from journey)
        - DateTime sentAt
    }

    DomainEvent CommunicationDelivered {
        - String communicationId
        - String VivaConsumerId
        - CommunicationType type
        - String campaignId
        - DateTime deliveredAt
    }

    DomainEvent CommunicationOpened {
        - String communicationId
        - String VivaConsumerId
        - CommunicationType type
        - String campaignId
        - DateTime openedAt
        - String deviceType                    // MOBILE | DESKTOP | TABLET
    }

    DomainEvent CommunicationClicked {
        - String communicationId
        - String VivaConsumerId
        - CommunicationType type
        - String campaignId
        - String linkUrl                        // URL that was clicked
        - DateTime clickedAt
    }

    DomainEvent CommunicationBounced {
        - String communicationId
        - String VivaConsumerId
        - CommunicationType type
        - String campaignId
        - BounceType bounceType                 // HARD | SOFT
        - String bounceReason
        - DateTime bouncedAt
    }

    DomainEvent UnsubscribeRequested {
        - String VivaConsumerId
        - CommunicationType channel             // EMAIL | PUSH | SMS | ALL
        - String campaignId                    // Campaign that triggered unsubscribe
        - DateTime unsubscribedAt
    }

    enum CommunicationType {
        EMAIL, PUSH, SMS, IN_APP
    }

    enum BounceType {
        HARD, SOFT
    }

    // --- Feedback Events (EXPANDED - Multi-Source Feedback) ---

    DomainEvent FeedbackSubmitted {
        - FeedbackId feedbackId
        - String VivaConsumerId
        - FeedbackSource source
        - FeedbackType feedbackType
        - int rating
        - String feedbackText
        - FeedbackContext context
        - boolean requiresFollowup              // True if low rating
        - DateTime submittedAt
    }

    // --- Legacy Survey Feedback Events (DEPRECATED - Use FeedbackSubmitted instead) ---
    // Kept for backward compatibility with existing event consumers.
    // Will be removed in future version.

    DomainEvent FeedbackReceived {
        deprecated
        - FeedbackId feedbackId
        - String VivaConsumerId
        - TransactionId transactionId
        - SurveyType surveyType
        - DateTime submittedAt
        - int overallRating
        - String feedbackText
        - Map<String, String> responses
        - StoreId storeId
    }

    DomainEvent FeedbackResponseFailed {
        - FeedbackId feedbackId
        - String VivaConsumerId
        - DateTime failedAt
        - String reason
        - String surveyPlatformId
    }

    // ========================================================================
    // DOMAIN SERVICES
    // ========================================================================
    // Services encapsulate both outbound (marketing) and inbound (customer comms)
    // orchestration logic.
    // ========================================================================

    // --- OUTBOUND Services (Marketing Automation) ---

    Service BrazeEventTranslator {
        // OUTBOUND: Translate OTR domain events to Braze track events
        translateTransactionCompleted(@TransactionCompletedEvent event) : BrazeTrackEvent
        translatePointsEarned(@PointsEarnedEvent event) : BrazeTrackEvent
        translateTierChanged(@TierChangedEvent event) : BrazeTrackEvent
        translatePartnerLinked(@PartnerLinkedEvent event) : BrazeTrackEvent

        // Enrich events with additional context before sending to Braze
        enrichWithCustomerContext(@BrazeTrackEvent event, @String VivaConsumerId) : BrazeTrackEvent

        // INBOUND: Translate Braze webhooks to OTR domain events
        translateCommunicationSent(@BrazeWebhookPayload payload) : CommunicationSent
        translateCommunicationDelivered(@BrazeWebhookPayload payload) : CommunicationDelivered
        translateCommunicationOpened(@BrazeWebhookPayload payload) : CommunicationOpened
        translateCommunicationClicked(@BrazeWebhookPayload payload) : CommunicationClicked
        translateCommunicationBounced(@BrazeWebhookPayload payload) : CommunicationBounced
        translateUnsubscribe(@BrazeWebhookPayload payload) : UnsubscribeRequested

        // Validate Braze webhook signatures for security
        validateBrazeWebhookSignature(@WebhookRequest request) : boolean
    }

    Service SurveyPlatformAdapter {
        // Translate survey platform webhooks to OTR domain events
        translateSurveyResponse(@SurveyWebhookPayload payload) : FeedbackSubmitted

        // Validate survey platform webhook signatures
        validateWebhookSignature(@WebhookRequest request) : boolean
    }

    Service EventEnrichmentService {
        // Add contextual data to events before sending to Braze
        addStoreContext(@Event event) : Event
        addTransactionContext(@Event event) : Event
        addLoyaltyContext(@Event event) : Event
    }

    // --- INBOUND Services (Customer Communications Management) ---

    Service InquiryRoutingService {
        // Triage incoming customer inquiries and determine routing
        triageInquiry(@Inquiry inquiry) : RoutingDecision

        // Route inquiry to appropriate destination
        routeInquiry(@Inquiry inquiry, @RoutingDestination destination) : void

        // Generate automated response for common inquiries
        generateAutomatedResponse(@Inquiry inquiry) : String

        // Determine if inquiry can be handled by chatbot
        canHandleWithChatbot(@Inquiry inquiry) : boolean
    }

    Service SupportRequestOrchestrator {
        // Enrich support request with customer context before creating Salesforce case
        enrichSupportRequest(@SupportRequest request) : SupportRequest

        // Create Salesforce case from support request
        createSalesforceCase(@SupportRequest request) : SalesforceCaseResponse

        // Synchronize Salesforce case status back to support request
        synchronizeCaseStatus(@String salesforceCaseId) : void

        // Query customer transaction history for context
        getCustomerTransactionContext(@String VivaConsumerId) : Map<String, String>
    }

    Service FeedbackProcessor {
        // Process feedback submission
        processFeedback(@FeedbackSubmission feedback) : void

        // Determine if feedback requires human followup based on rating
        requiresFollowup(@FeedbackSubmission feedback) : boolean

        // Send acknowledgement to customer
        sendAcknowledgement(@FeedbackId feedbackId, @String VivaConsumerId) : void

        // Escalate low-rated feedback to support case (manual review)
        escalateToSupport(@FeedbackId feedbackId) : SupportRequestId
    }

    Service SalesforceServiceCloudAdapter {
        // ACL for Salesforce Service Cloud integration
        // Translates between OTR domain model and Salesforce case model

        // Create case in Salesforce
        createCase(@SupportRequest request) : SalesforceCaseResponse

        // Update case status
        updateCaseStatus(@String caseId, @CaseStatus status) : void

        // Get case details
        getCaseDetails(@String caseId) : SalesforceCaseDetails

        // Add comment to case
        addCaseComment(@String caseId, @String comment) : void

        // Query cases for customer
        getCasesForCustomer(@String VivaConsumerId) : List<SalesforceCaseDetails>
    }

    Service ProfileServiceIntegration {
        // Bidirectional integration with ProfileService
        // Sends engagement summaries, receives profile enrichment

        // Send engagement summary to ProfileService (daily batch)
        sendEngagementSummary(@String VivaConsumerId, @EngagementMetrics metrics) : void

        // Publish EngagementTierChanged event when tier changes
        publishEngagementTierChanged(@String VivaConsumerId, @EngagementTier previousTier, @EngagementTier newTier) : void

        // Calculate engagement tier from metrics
        calculateEngagementTier(@EngagementMetrics metrics) : EngagementTier
    }

    ValueObject EngagementMetrics {
        // Metrics sent to ProfileService for caching
        - int emailOpenRate                // Percentage 0-100
        - int emailClickRate               // Percentage 0-100
        - int pushNotificationEngagement   // Percentage 0-100
        - int campaignResponseCount
        - DateTime lastCampaignInteraction
        - EngagementTier engagementTier
        - int supportCaseCount
        - DateTime lastSupportInteraction
        - Decimal supportSentimentScore    // Average sentiment -1 to 1
    }

    // ========================================================================
    // SHARED VALUE OBJECTS
    // ========================================================================
    // Reusable value objects used across the context.
    // ========================================================================

    // --- Common Value Objects ---

    ValueObject InquiryId {
        - String id
    }

    ValueObject SupportRequestId {
        - String id
    }

    ValueObject FeedbackId {
        - String id
    }

    ValueObject TransactionId {
        - String id
    }

    ValueObject StoreId {
        - String id
    }

    enum InquiryChannel {
        MOBILE_APP, EMAIL, SMS, IN_APP_FEEDBACK
    }

    enum InquiryCategory {
        GENERAL, ACCOUNT, REWARDS, TRANSACTION, TECHNICAL, PARTNERSHIP, FEEDBACK
    }

    enum Priority {
        LOW, MEDIUM, HIGH, URGENT
    }

    enum RoutingDestination {
        SALESFORCE_CASE, AUTOMATED_RESPONSE, CHATBOT, SUPPORT_TEAM_EMAIL
    }

    enum RequestType {
        REFUND, ACCOUNT_ISSUE, POINTS_DISPUTE, TECHNICAL_ISSUE, PARTNER_ISSUE, PROMOTIONAL_INQUIRY
    }

    ValueObject FeedbackContext {
        - String transactionId
        - String productSku
        - String storeId
        - String campaignId
        - String surveyId
    }

    enum FeedbackSource {
        SURVEY, PRODUCT_REVIEW, DIRECT_FEEDBACK, APP_RATING, EMAIL_REPLY
    }

    enum FeedbackType {
        POST_TRANSACTION, NPS, CSAT, PRODUCT_REVIEW, GENERAL, SERVICE_EXPERIENCE
    }

    // --- OUTBOUND Value Objects (Marketing) ---

    ValueObject BrazeTrackEvent {
        - String eventName
        - String VivaConsumerId           // Salesforce guest identifier (maps to Braze external_id)
        - DateTime timestamp
        - Map<String, Object> properties
    }

    ValueObject BrazeWebhookPayload {
        - String eventType                // email_send, email_open, email_click, etc.
        - String messageId                // Braze message identifier
        - String campaignId               // Braze campaign identifier
        - String canvasId                // Braze canvas identifier (if from journey)
        - String externalUserId           // Maps to VivaConsumerId
        - DateTime timestamp
        - Map<String, String> properties  // Additional event-specific data
    }

    ValueObject SurveyWebhookPayload {
        - String surveyId
        - String responseId
        - Map<String, String> answers
        - DateTime submittedAt
    }

    // --- INBOUND Value Objects (Customer Communications) ---

    ValueObject RoutingDecision {
        - RoutingDestination destination
        - Priority priority
        - String routingReason
        - boolean requiresHumanReview
        - Map<String, String> routingMetadata
    }

    ValueObject SalesforceCaseResponse {
        - String caseId
        - String caseNumber
        - CaseStatus status
        - DateTime createdAt
        - String caseOwner
    }

    ValueObject SalesforceCaseDetails {
        - String caseId
        - String caseNumber
        - String subject
        - String description
        - CaseStatus status
        - Priority priority
        - String caseOwner
        - DateTime createdAt
        - DateTime closedAt
        - List<CaseComment> comments
    }

    ValueObject CaseComment {
        - String commentId
        - String commentText
        - String author
        - DateTime createdAt
        - boolean isPublic
    }

    enum CaseStatus {
        NEW, IN_PROGRESS, PENDING_CUSTOMER, ESCALATED, RESOLVED, CLOSED
    }

    enum SurveyType {
        POST_TRANSACTION, NPS, PRODUCT_REVIEW, CSAT
    }

    // ========================================================================
    // EVENT SUBSCRIPTIONS
    // ========================================================================
    // Events that EngagementService subscribes to from other bounded contexts.
    //
    // From LoyaltyService (via Event Bus):
    // - MemberEnrolled → trigger welcome campaign in Braze
    // - PointsEarned → trigger reward notification in Braze
    // - PointsRedeemed → trigger redemption confirmation in Braze
    // - TierChanged → trigger tier upgrade celebration in Braze
    //
    // From ProfileService (via Event Bus):
    // - ProfileCreated → update customer profile in Braze
    // - ProfileUpdated → sync profile changes to Braze
    // - PartnerLinked → trigger partner linking confirmation in Braze
    // - PartnerLinkChanged → update segmentation in Braze
    // - RiskStatusChanged → update customer segment (high-risk customers)
    //
    // From D365 Commerce (via Event Bus):
    // - TransactionCompleted → trigger post-transaction campaigns
    //   Channels: POS CSU (in-store/forecourt), web (cloud commerce), mobile (via mobile backend)
    //   TransactionSource attribute distinguishes: POS | MOBILE_APP | WEB
    //
    // Event processing:
    // 1. Receive event from Event Hub consumer group
    // 2. Translate via BrazeEventTranslator ACL
    // 3. Enrich with context via EventEnrichmentService
    // 4. Send to Braze API as track event
    // 5. Braze Canvas/Journey Builder decides which campaigns to trigger
    // ========================================================================

    // ========================================================================
    // ANTI-CORRUPTION LAYER (ACL) RESPONSIBILITIES
    // ========================================================================
    //
    // OUTBOUND ACLs (Marketing Automation):
    // --------------------------------------
    //
    // Braze ACL (BrazeEventTranslator) - BIDIRECTIONAL:
    // OUTBOUND (OTR → Braze):
    // - Translates OTR domain events to Braze track events
    // - Handles Braze API authentication, rate limiting, retries
    // - Maps OTR user identifiers (VivaConsumerId) to Braze external_id
    // - Enriches events with context before sending to Braze
    //
    // INBOUND (Braze → OTR):
    // - Receives Braze webhooks for engagement tracking (sent, delivered, opened, clicked, bounced)
    // - Validates Braze webhook signatures for security
    // - Translates Braze webhook payloads to OTR domain events (CommunicationSent, etc.)
    // - Maps Braze external_id back to VivaConsumerId
    // - Publishes marketing engagement events to Event Hub for analytics
    //
    // Protects domain from Braze's marketing-centric model in both directions
    //
    // Survey Platform ACL (SurveyPlatformAdapter):
    // - Translates survey platform webhooks to FeedbackSubmitted events
    // - Validates webhook signatures for security
    // - Handles survey platform-specific payload formats
    // - Protects domain from survey vendor changes
    //
    // INBOUND ACLs (Customer Communications):
    // ----------------------------------------
    //
    // Salesforce Service Cloud ACL (SalesforceServiceCloudAdapter):
    // - Translates incoming customer messages to Salesforce Case objects in-flight
    // - Protects domain from Salesforce's case management model
    // - Handles Salesforce authentication, API limits, field mappings
    // - Maps OTR VivaConsumerId to Salesforce Contact/Person Account
    // - No local state - routes immediately to Salesforce
    // - Handles case comments and attachments (virus-scanned before upload)
    //
    // Integration Notes:
    // ------------------
    // OUTBOUND:
    // - Customer master data sync (Salesforce → Braze) handled by ADF pipeline
    // - Behavioral events routed in real-time to Braze
    // - Stateless event processing via Azure Functions
    // - Profile events from ProfileService consumed for Braze segmentation
    //
    // INBOUND:
    // - Customer communications routed immediately to Salesforce (no local storage)
    // - Inquiries, support requests, feedback enriched in-flight before routing
    // - Salesforce cases created immediately for issues requiring resolution
    // - Low-rated feedback routed to Salesforce for manual review
    // - All routing logic stateless and testable independently from infrastructure
    //
    // PROFILESERVICE INTEGRATION:
    // - Bidirectional: EngagementService publishes EngagementTierChanged events
    // - Bidirectional: ProfileService publishes profile/partner/risk events
    // - Batch: Daily engagement summary sent to ProfileService
    // - Batch: Daily profile enrichment received from ProfileService (for Braze sync)
    // - Hybrid event/batch pattern maintains eventual consistency
    // ========================================================================
}

// ============================================================================
// END OF BOUNDED CONTEXT
// ============================================================================
//
// Implementation Notes:
// ----------------------
//
// OUTBOUND (Marketing):
// - Azure Functions triggered by Event Hub for event routing
// - Stateless Braze API calls with retry logic and circuit breaker
// - Survey platform webhook endpoint with signature validation
//
// INBOUND (Customer Communications):
// - Azure Functions for webhook endpoints (surveys, customer messages)
// - Salesforce Service Cloud API for case management integration
// - Azure Blob Storage for message attachments (virus-scanned, transient)
// - Retry and circuit breaker patterns for external API calls
// - No local persistence - routes immediately to Salesforce
//
// Data Storage:
// - OUTBOUND: No persistent storage (stateless event router)
// - INBOUND: No persistent storage (stateless routing layer)
// - All state lives in external systems (Braze, Salesforce)
// - Event publishing for audit trail via Event Bus
//
// ACL Pattern:
// - All external system integrations protected by ACL adapters
// - Translation logic tested independently from infrastructure
// - External API changes isolated from domain model
// - Stateless routing enables horizontal scaling
// ============================================================================
