/*
 * LocationService - Bounded Context Definition
 * =============================================
 *
 * Location-aware services for store discovery, proximity detection, and loyalty engagement.
 *
 * See location.adoc for comprehensive architecture documentation and decision log.
 */

import "../domains/location.cml"

BoundedContext LocationService implements LocationDomain {
    type = CORE_BOUNDED_CONTEXT

    domainVisionStatement = "Provides location-aware services for store discovery, proximity detection, location-based loyalty engagement, and customer store preference tracking."

    responsibilities = "Store location search and discovery",
                      "Store information management",
                      "Loyalty programme availability by location",
                      "Proximity detection and geofencing",
                      "Location-based targeting coordination",
                      "Customer store preference tracking",
                      "Proximity-based loyalty event publishing",
                      "Store performance grading for operational targeting"

    implementationTechnology = "Azure Functions, .NET Core, Azure Maps, Azure Cosmos DB"

    /* Core Aggregates */

    Aggregate Store {
        Entity StoreLocation {
            aggregateRoot

            - StoreId id
            - String storeName
            - StoreBrand brand                              // OTR, REDDY_EXPRESS, SBDOS
            - Address address
            - GeoCoordinates coordinates
            - StoreHours operatingHours
            - List<Amenity> amenities
            - List<Service> availableServices
            - AvailableLoyaltyProgrammes loyaltyProgrammes  // Which loyalty programmes are available
            - StoreStatus status
        }

        ValueObject Address {
            - String streetAddress
            - String suburb
            - String state
            - String postcode
            - String country
        }

        ValueObject GeoCoordinates {
            - Decimal latitude
            - Decimal longitude
        }

        ValueObject StoreHours {
            - Map<DayOfWeek, OpeningHours> weeklySchedule
            - List<SpecialHours> specialDates
        }

        ValueObject StoreStatus {
            - StatusType status  // OPEN, CLOSED, TEMPORARILY_CLOSED
            - String statusMessage
        }

        ValueObject AvailableLoyaltyProgrammes {
            /*
             * Defines which loyalty programmes are available at this store location.
             * This is location metadata, not loyalty business rules.
             *
             * Examples:
             * - OTR stores: All three programmes available (OTR Rewards, Flybuys, Shell Price Save)
             * - Reddy Express: OTR Rewards and Flybuys (no Shell Price Save)
             * - SBDOS: Flybuys only (Shell-branded dealer sites)
             */

            - Boolean otrRewardsAvailable       // OTR's native loyalty programme
            - Boolean flybuysAvailable          // Coalition loyalty partner (Coles Group)
            - Boolean shellPriceSaveAvailable   // Shell fuel discount programme
            - List<String> otherProgrammes      // Future extensibility for new partnerships
        }

        enum StoreBrand {
            OTR,                    // OTR-owned and operated stores
            REDDY_EXPRESS,          // Reddy Express (REXP) branded stores (formerly Coles Express)
            SBDOS                   // Shell-Branded Dealer Operated Sites
        }
    }

    Aggregate FuelPrice {
        Entity StoreFuelPrice {
            aggregateRoot

            - FuelPriceId id
            - StoreId storeId
            - Map<FuelType, Price> currentPrices  // UNLEADED, PREMIUM, DIESEL, E10
            - DateTime lastUpdated
            - PriceHistory history
        }
    }

    Aggregate ProximityZone {
        Entity Geofence {
            aggregateRoot

            - GeofenceId id
            - StoreId storeId
            - GeoCoordinates centerPoint
            - Distance radius
            - ZoneType type  // ARRIVAL, DEPARTURE, DWELL
            - Boolean isActive
        }

        ValueObject Distance {
            - Decimal value
            - DistanceUnit unit  // METRES, KILOMETRES
        }
    }

    Aggregate CustomerStorePreference {
        /*
         * Tracks customer store visit patterns and preferences for loyalty engagement
         * and personalised recommendations.
         *
         * Invariants:
         * - VivaConsumerId must be valid (15-character Salesforce Record ID)
         * - PreferredStores list limited to top 5 stores by visit frequency
         * - Visit history retained for 90 days, then aggregated
         * - Location tracking requires customer consent (consent flag must be true)
         */

        Entity CustomerLocationProfile {
            aggregateRoot

            - VivaConsumerId customerId
            - List<PreferredStore> preferredStores  // Top 5 stores by visit frequency
            - List<StoreVisitRecord> recentVisits   // Last 90 days
            - DateTime lastLocationUpdate
            - Boolean locationTrackingConsent       // Customer consent for location tracking
            - StoreId homeStore                     // Customer's nominated "home" store
        }

        ValueObject PreferredStore {
            - StoreId storeId
            - String storeName
            - Integer visitCount                    // Total visits (all time)
            - DateTime lastVisit
            - VisitFrequency frequency              // DAILY, WEEKLY, MONTHLY, OCCASIONAL
        }

        ValueObject StoreVisitRecord {
            - StoreId storeId
            - DateTime visitTimestamp
            - VisitType visitType                   // PROXIMITY_DETECTED, TRANSACTION_COMPLETED, CHECK_IN
            - Distance distanceFromStore
        }

        enum VisitFrequency {
            DAILY, WEEKLY, MONTHLY, OCCASIONAL
        }

        enum VisitType {
            PROXIMITY_DETECTED,     // Customer entered geofence
            TRANSACTION_COMPLETED,  // Transaction detected at store (from D365Commerce event)
            CHECK_IN                // Customer manually checked in
        }
    }

    Aggregate StoreGrade {
        /*
         * Tracks store performance grading for internal operational purposes.
         * Grades are manually assigned by operations/management team based on
         * multiple performance criteria and used for campaign targeting and
         * resource allocation decisions.
         *
         * Invariants:
         * - Each store can have only one active grade at a time
         * - Grade effective date must not be in the future
         * - Rationale is required when assigning LOW_PERFORMING grade
         * - Grade category must be one of: HIGH_PERFORMING, STANDARD, LOW_PERFORMING
         */

        Entity StoreGradeAssignment {
            aggregateRoot

            - StoreGradeId id
            - StoreId storeId
            - StoreGradeCategory gradeCategory
            - DateTime effectiveDate              // When this grade becomes active
            - String reviewPeriod                 // e.g., "Q4 2024", "January 2025"
            - GradeRationale rationale           // Why this grade was assigned
            - String assignedBy                  // Who assigned this grade (user ID or system)
            - DateTime assignedDate              // When grade was assigned
        }

        ValueObject GradeRationale {
            /*
             * Captures the reasoning behind store grade assignment for accountability
             * and future review. Particularly important for LOW_PERFORMING grades.
             */

            - String salesPerformanceNotes       // e.g., "Below target by 15%"
            - String customerSatisfactionNotes   // e.g., "NPS score 42, down from 58"
            - String operationalComplianceNotes  // e.g., "Failed 2 safety audits"
            - String facilitiesNotes             // e.g., "Equipment outdated, requires refresh"
            - String overallSummary              // High-level summary of grade rationale
        }

        enum StoreGradeCategory {
            HIGH_PERFORMING,    // Top tier stores - exceed performance targets
            STANDARD,           // Average performing stores - meet expectations
            LOW_PERFORMING      // Below target stores - require intervention
        }
    }

    /* Domain Events */

    DomainEvent CustomerNearStore {
        - VivaConsumerId customerId
        - StoreId storeId
        - String storeName
        - GeoCoordinates storeLocation
        - Distance distanceFromStore
        - DateTime timestamp
    }

    DomainEvent CustomerApproachedStore {
        - VivaConsumerId customerId
        - StoreId storeId
        - String storeName
        - DateTime timestamp
    }

    DomainEvent StoreVisited {
        - VivaConsumerId customerId
        - StoreId storeId
        - String storeName
        - VisitType visitType
        - DateTime timestamp
    }

    DomainEvent PreferredStoreChanged {
        - VivaConsumerId customerId
        - StoreId newPreferredStore
        - String storeName
        - DateTime timestamp
    }

    DomainEvent StoreGradeChanged {
        /*
         * Published when a store's performance grade is updated.
         * Consumed by EngagementService (campaign targeting) and
         * RecommendationService (store prioritisation).
         */

        - StoreId storeId
        - String storeName
        - StoreGradeCategory previousGrade
        - StoreGradeCategory newGrade
        - DateTime effectiveDate
        - String reviewPeriod
        - String assignedBy
        - DateTime timestamp
    }

    /* Services */

    Service StoreDiscoveryService {
        /*
         * Provides store search and discovery based on location, filters, and customer preferences.
         */

        @StoreLocation findNearbyStores(@GeoCoordinates location, @Distance radius);
        @StoreLocation searchStores(@String query, @GeoCoordinates location);
        @List<StoreLocation> getPreferredStores(@VivaConsumerId customerId);
        @StoreLocation getHomeStore(@VivaConsumerId customerId);
        @AvailableLoyaltyProgrammes getLoyaltyProgrammesForStore(@StoreId storeId);
        @List<StoreLocation> getStoresByLoyaltyProgramme(@LoyaltyProgrammeType programmeType, @GeoCoordinates location);
    }

    enum LoyaltyProgrammeType {
        OTR_REWARDS,
        FLYBUYS,
        SHELL_PRICE_SAVE
    }

    Service ProximityDetectionService {
        /*
         * Monitors geofences and publishes proximity events for loyalty engagement.
         */

        void trackCustomerLocation(@VivaConsumerId customerId, @GeoCoordinates location);
        @List<StoreId> getStoresInProximity(@VivaConsumerId customerId, @Distance radius);
        void recordStoreVisit(@VivaConsumerId customerId, @StoreId storeId, @VisitType visitType);
    }

    Service StoreGradingService {
        /*
         * Manages store performance grading for internal operational purposes.
         * Grades are manually assigned by operations/management team and published
         * to downstream consumers (EngagementService, RecommendationService).
         *
         * Query Operations:
         * - getStoreGrade: Retrieve current grade for a specific store
         * - getStoresByGrade: Bulk query for campaign targeting (e.g., "all HIGH_PERFORMING stores in SA")
         *
         * Command Operations:
         * - updateStoreGrade: Manual grade assignment by operations team
         *   * Publishes StoreGradeChanged event when grade changes
         *   * Validates invariants (rationale required for LOW_PERFORMING, effective date not in future)
         */

        @StoreGradeAssignment getStoreGrade(@StoreId storeId);
        @List<StoreLocation> getStoresByGrade(@StoreGradeCategory gradeCategory, @String state);
        @List<StoreLocation> getStoresByGrade(@StoreGradeCategory gradeCategory);
        void updateStoreGrade(@StoreId storeId, @StoreGradeCategory newGrade, @GradeRationale rationale, @String reviewPeriod, @String assignedBy);
    }
}