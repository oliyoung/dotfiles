= Payment Bounded Context
O.Young@otr.com.au
v0.1, 2025-12-19
:project-name: OTRG Apps & Ecommerce Architecture
:togaf-adm-phase: Phase C: Information Systems Architectures
:document-type: Bounded Context
:status: Draft
:version: 0.1
:domain: Payment
:bounded-context-type: FEATURE
:domain-architect: O.Young@otr.com.au
:doctype: article
:toc: left
:toclevels: 4
:sectanchors:
:sectlinks:
:sectnums:
:icons: font
:source-highlighter: highlightjs
:experimental:
:description: Bounded Context for the Payment Domain
:keywords: payment, apple pay, google pay, bounded context, togaf, ddd

Core payment processing service handling all payment operations across
OTR and Reddy Express brands, including mobile wallet integration (Apple
Pay, Google Pay), fuel pre-authorisation, and subscription billing.

== Domain Vision Statement

Handles payment processing, mobile wallet integration (Apple Pay, Google
Pay), fuel pre-authorisation, and subscription billing across all VER
brands. Provides secure, reliable, offline-tolerant payment flows with
instant receipt delivery.

== Business Context (CY26 Strategy)

Apple Pay & Google Pay integration is HIGHEST PRIORITY (Q1 CY26):

* Represents 40% of EMV payments in Australia
* #1 competitive gap vs. Ampol, BP, 7-Eleven
* Critical for pay-at-pump reliability and execution quality
* Required for unmanned 24/7 fuel capability
* Key differentiation: instant e-receipts, offline-tolerant flows

== Responsibilities

* Payment processing (in-app, pay-at-pump, in-store)
* Mobile wallet integration (Apple Pay, Google Pay, Samsung Pay)
* Fuel pre-authorisation with variable amounts
* Payment tokenisation and secure storage
* Transaction management and reconciliation
* Refund and reversal processing
* Instant e-receipt generation and delivery
* Payment gateway integration (provider TBD)
* Fraud detection and prevention
* Subscription billing and recurring payments

== What PaymentService Owns

PaymentService owns *3 aggregates*:

[arabic]
. *PaymentTransaction* - Payment transaction life-cycle including
authorisations, captures, and refunds
. *PaymentMethodProfile* - Customer payment methods with secure
tokenisation
. *SubscriptionPlan* - Subscription-based loyalty programmes and
recurring payments

== Domain Coverage

* *Payment Processing*: Standard purchases, fuel pre-authorisation,
subscriptions
* *Mobile Wallets*: Apple Pay, Google Pay, Samsung Pay tokenisation
* *Pre-authorisation*: Fuel pump variable amount holds
* *Receipts*: Instant e-receipt generation and multi-channel delivery
* *Subscriptions*: Recurring payment management

== NOT in this Context (Owned by Other Systems)

* Transaction transactions → D365 Commerce
* Loyalty points redemption logic → LoyaltyService
* Customer payment preferences → Salesforce
* OAuth tokens → OAuth Service (Infrastructure)

== Integration Points

* *Upstream*: Payment gateway (provider TBD), Apple Pay Platform, Google
Pay Platform
* *Downstream*: link:loyalty.adoc[Loyalty
Service] (reward redemption), D365 Commerce (transaction completion)
* *Events*: PaymentAuthorised, PaymentCaptured, PaymentFailed,
RefundProcessed

== Core Aggregates

=== PaymentTransaction Aggregate

Records payment transaction life-cycle including authorisations,
captures, and refunds. Supports multiple payment flows: standard
purchase, fuel pre-authorisation, subscriptions.

*Pre-authorisation Flow (Fuel Pumps):*

[arabic]
. authorised: Hold amount on customer’s card (e.g., $150)
. FUEL_DISPENSED: Customer fills tank (e.g., $87.50)
. CAPTURED: Capture actual amount ($87.50)
. RELEASED: Release remaining hold ($62.50)

*Invariants:*

* Transaction must have valid payment method
* Capture amount cannot exceed authorised amount (pre-auth)
* Refund amount cannot exceed captured amount
* Each transaction must have unique idempotency key

*Key Entities:*

* `Transaction` (aggregate root)
** TransactionId id
** String VivaConsumerId
** Money authorisedAmount
** Money capturedAmount
** PaymentMethodId paymentMethodId
** TransactionType transactionType (PURCHASE, PRE_AUTH_FUEL,
SUBSCRIPTION)
** TransactionStatus status
** DateTime transactionDate
** StoreId storeId
** String pumpId (for fuel transactions)
** RefundDetails refundInfo
** ReceiptInfo receiptInfo
** PreAuthDetails preAuthDetails

*Value Objects:*

* TransactionType: PURCHASE, PRE_AUTH_FUEL, SUBSCRIPTION, REFUND
* TransactionStatus: PENDING, authorised, CAPTURED, COMPLETED, FAILED,
REFUNDED
* RefundDetails: Refund metadata (amount, date, reason, transaction ID)
* ReceiptInfo: Receipt delivery details (URL, delivery method, status)
* PreAuthDetails: Pre-authorisation details (authorised, actual,
released amounts)

=== PaymentMethodProfile Aggregate

Stores customer payment methods with secure tokenisation. Supports
mobile wallets (Apple Pay, Google Pay) and traditional cards.

*Mobile Wallet Integration:*

* Apple Pay: Apple-provided device-specific token
* Google Pay: Google-provided pan token
* Tokens never expose actual card details

*Invariants:*

* Customer can only have one default payment method per brand
* Tokens must be encrypted at rest (Azure Key Vault)
* Expired payment methods must be removed or updated

*Key Entities:*

* `PaymentMethod` (aggregate root)
** PaymentMethodId id
** String VivaConsumerId
** MethodType type (APPLE_PAY, GOOGLE_PAY, SAMSUNG_PAY, CREDIT_CARD,
DEBIT_CARD)
** String token (tokenized payment details, encrypted)
** WalletProviderDetails walletDetails
** CardDetails cardDetails
** Boolean isDefault
** DateTime addedDate
** DateTime expiryDate
** String brandContext (OTR, SPS)

=== SubscriptionPlan Aggregate

Manages subscription-based loyalty programmes and recurring payments.
Integrates with payment methods for automatic billing.

*Key Entities:*

* `Subscription` (aggregate root)
** SubscriptionId id
** String VivaConsumerId
** PaymentMethodId paymentMethodId
** PlanType planType (MONTHLY, ANNUAL)
** Money recurringAmount
** SubscriptionStatus status
** DateTime nextBillingDate
** Integer failedPaymentAttempts
** BillingSchedule schedule

== Domain Events

=== Payment Transaction Events

* *PaymentAuthorised*: Payment authorisation successful
* *PaymentCaptured*: Payment captured and completed
* *PaymentFailed*: Payment processing failed
* *PreAuthReleased*: Pre-authorisation hold released
* *RefundProcessed*: Refund successfully processed
* *ReceiptDelivered*: Receipt delivered to customer

=== Payment Method Events

* *PaymentMethodAdded*: New payment method added
* *PaymentMethodRemoved*: Payment method removed
* *PaymentMethodExpired*: Payment method expired

=== Subscription Events

* *SubscriptionBilled*: Subscription payment processed
* *SubscriptionPaymentFailed*: Subscription payment failed

== Key Services

=== Fuel Pre-authorisation Services

* *FuelPreAuthService*: Manages fuel pump pre-authorisation flows
** authorizePreAuth: Hold amount on card
** captureFuelAmount: Capture actual fuel amount
** releasePreAuth: Release pre-auth hold
** autoReleaseExpiredPreAuths: Auto-release old holds

=== Mobile Wallet Services

* *MobileWalletService*: Mobile wallet tokenisation and management
** tokenizeApplePayMethod: Tokenize Apple Pay
** tokenizeGooglePayMethod: Tokenize Google Pay
** validateWalletToken: Validate token
** refreshWalletToken: Refresh expired token

=== Receipt Services

* *ReceiptService*: Receipt generation and delivery
** generateReceipt: Generate receipt
** deliverReceipt: Deliver via specified method
** regenerateReceipt: Regenerate for customer request

=== Payment Gateway Services

* *PaymentGatewayService*: Payment gateway integration
** processPayment: Process payment via gateway
** processRefund: Process refund via gateway
** checkTransactionStatus: Query gateway status

== Architecture Decisions

=== Decision 1: Mobile Wallet Priority

*Decision:* Apple Pay & Google Pay integration is the highest priority
for Q1 CY26.

*Rationale:*

* Represents 40% of EMV payments in Australia
* #1 competitive gap vs. competitors
* Critical for pay-at-pump reliability
* Required for unmanned 24/7 fuel capability

=== Decision 2: Fuel Pre-authorisation Flow

*Decision:* Two-phase pre-authorisation for fuel purchases (authorize →
capture → release).

*Rationale:*

* Customer fills unknown amount of fuel
* Hold maximum amount (e.g., $150)
* Capture actual amount dispensed
* Release remaining hold immediately
* Prevents overcharging and improves customer experience

=== Decision 3: Payment Tokenisation

*Decision:* All payment methods tokenized and encrypted at rest.

*Rationale:*

* PCI DSS compliance: Never store actual card details
* Mobile wallet tokens are device-specific
* Encrypted storage via Azure Key Vault
* Reduces security and compliance risk

=== Decision 4: Instant Receipt Delivery

*Decision:* Generate and deliver receipts instantly via multiple
channels.

*Rationale:*

* Key competitive differentiator
* Improves customer experience
* Reduces support inquiries
* Delivery channels: Email, push notification, SMS

== Key Architectural Patterns

=== 1. Payment Gateway Abstraction

* Payment gateway integration via adapter pattern
* Vendor-agnostic design (provider TBD)
* Enables future gateway migration

=== 2. Pre-authorisation Pattern

* Two-phase commit for fuel purchases
* Hold → Capture → Release flow
* Auto-release for expired holds (2 hours default)

=== 3. Mobile Wallet Integration

* Platform-specific SDKs (Apple PassKit, Google Pay API)
* Device-specific tokenisation
* Encrypted token storage

=== 4. Idempotency Pattern

* Unique idempotency key per transaction
* Prevents duplicate charges
* Enables safe retries

=== 5. Receipt Delivery Pattern

* Multi-channel delivery (email, push, SMS)
* Instant generation post-capture
* Receipt URL stored in Azure Blob Storage

== DDD Principles Applied

=== Bounded Context Boundaries

[arabic]
. *Don’t duplicate data across contexts*
* Transaction transactions → D365 Commerce owns
* Loyalty redemption → LoyaltyService owns
* Customer preferences → Salesforce owns
. *Store only what you need*
* Payment transaction life-cycle only
* Payment method tokens only
* Receipt metadata, not full receipt content
. *Use references, not copies*
* VivaConsumerId → Salesforce customer
* PaymentMethodId → tokenized payment method
* StoreId → location context
. *Identify true system of record*
* Payment transactions → PaymentService
* Payment methods → PaymentService
* Subscriptions → PaymentService
* Transaction transactions → D365 Commerce

== Implementation Notes

* *Security*: PCI DSS compliance, TLS 1.3, encrypted storage
* *Apple Pay*: PassKit framework (iOS)
* *Google Pay*: Google Pay API for Passes
* *Payment Gateway*: Provider TBD via RFP
* *Token Storage*: Azure Key Vault
* *Pre-Auth Timeout*: Configurable per site (default: 2 hours)
* *Receipt Delivery*: Azure Notification Hubs (push), SendGrid (email)
* *Offline Queue*: Queue payments for network failures, sync when online

== Fuel Pre-authorisation Flow

[arabic]
. Customer selects pump and payment method in app
. PaymentService authorizes pre-auth hold (e.g., $150)
. Pump unlocked for fueling
. Customer fills tank (e.g., $87.50)
. Pump signals completion
. PaymentService captures actual amount ($87.50)
. PaymentService releases remaining hold ($62.50)
. Receipt generated and delivered instantly
. Transaction sent to D365 Commerce
. LoyaltyService adjudicates rewards
