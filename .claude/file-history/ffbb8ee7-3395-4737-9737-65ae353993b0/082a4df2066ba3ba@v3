/*
 * ProfileService - Bounded Context Definition
 * ============================================
 *
 * Unified customer profile service providing enriched customer data for OTR ecosystem.
 *
 * See profile.adoc for comprehensive architecture documentation, decision log, and patterns.
 */

import "../domains/profile.cml"

BoundedContext ProfileService implements ProfileDomain {

    type = APPLICATION
    domainVisionStatement = "Provide unified, enriched customer profiles bridging Salesforce canonical data with OTR-specific attributes, behavioral insights, and risk assessments"

    responsibilities = "OTRG-specific customer profile management",
                      "Customer lifecycle stage and onboarding tracking",
                      "Partner linking status tracking",
                      "Customer risk assessment (fraud, refund, churn)",
                      "Refund history tracking",
                      "Engagement metrics caching for profile enrichment"

    implementationTechnology = "Azure Functions, .NET Core, Azure SQL, Salesforce API, Event Bus"

    // ========================================================================
    // SECTION 1: CORE AGGREGATES
    // ========================================================================
    // Aggregates represent transactional consistency boundaries.
    // Each aggregate root controls access to entities within its boundary.
    // ========================================================================

    // 1.1 CustomerProfile Aggregate
    // ------------------------------
    // OTR-specific customer profile attributes enriching Salesforce canonical data.
    // Stores behavioral data, preferences, and app-specific attributes.
    //
    // Invariants:
    // - Must have valid VCI reference to Salesforce
    // - Email verification status must be tracked
    // - Account status must be valid enum value
    // - Profile completeness score must be 0-100
    // - Onboarding completion percentage must be 0-100
    // - lifecycle stage must be valid enum value
    //
    // Bounded Context Note:
    // - Canonical customer data (name, email, phone) owned by Salesforce
    // - ProfileService stores OTR-specific enrichment only
    // - Queries Salesforce for canonical data, does not cache it
    Aggregate CustomerProfile {
        Entity CustomerProfileRecord {
            aggregateRoot

            - ProfileId id
            - String VivaConsumerId           // Salesforce customer identifier (VCI)
            - AccountStatus status
            - DateTime createdAt
            - DateTime lastUpdatedAt
            - DateTime lastLoginAt

            // Identity Verification
            - IdentityVerification verification

            // App Preferences
            - AppPreferences appPreferences

            // Profile Completeness
            - int completenessScore          // 0-100 calculated score

            // Customer lifecycle
            - LifeCycleStage lifeCycleStage  // PROSPECT | NEW | ACTIVE | DORMANT | AT_RISK | CHURNED
            - DateTime lifeCycleChangedAt

            // Onboarding Progress
            - OnboardingStatus onboardingStatus
            - int onboardingCompletionPercentage  // 0-100
            - DateTime onboardingCompletedAt

            // Customer Value
            - CustomerValue valueMetrics

            // Special Handling
            - boolean isStaffMember          // Employee customer flag

            // Operations
            def updateLastLogin(): void
            def calculateCompletenessScore(): int
            def updateLifeCycleStage(newStage: LifeCycleStage): void
            def updateOnboardingProgress(percentage: int): void
        }

        ValueObject IdentityVerification {
            - boolean emailVerified
            - boolean phoneVerified
            - VerificationLevel level        // UNVERIFIED | BASIC | FULL
            - DateTime lastVerifiedAt
        }

        ValueObject AppPreferences {
            - String preferredStore
            - String languagePreference      // ISO 639-1 code (en, zh, vi, etc.)
            - boolean pushNotificationsEnabled
            - boolean locationServicesEnabled
            - String preferredPaymentMethod
            - Map<String, String> customPreferences
        }

        ValueObject CustomerValue {
            - Money lifetimeValue
            - Money totalSpend
            - int transactionCount
            - Money averageBasketValue
            - DateTime firstPurchaseDate
            - ProfitabilityScore profitability
        }

        enum VerificationLevel {
            UNVERIFIED,                      // No verification
            BASIC,                           // Email or phone verified
            FULL                             // Multiple factors verified
        }

        enum ProfitabilityScore {
            LOW, MEDIUM, HIGH, VIP
        }

        enum LifeCycleStage {
            PROSPECT,                        // Registered but no purchase
            NEW,                             // First purchase within 90 days
            ACTIVE,                          // Regular transactions
            DORMANT,                         // No transactions 90+ days
            AT_RISK,                         // Declining engagement/transactions
            CHURNED                          // No transactions 180+ days
        }

        enum OnboardingStatus {
            NOT_STARTED,                     // Account created, onboarding not begun
            IN_PROGRESS,                     // Onboarding steps partially complete
            COMPLETED,                       // All onboarding steps finished
            SKIPPED                          // User skipped onboarding flow
        }
    }

    // 1.2 PartnerLink Aggregate
    // ------------------------------------------------------
    // Records customer linkages to external loyalty partners (Flybuys, Shell).
    // Tracks linking status and synchronization state for partner integrations.
    //
    // Invariants:
    // - Customer can only have one active link per partner type
    // - External member ID must be unique within partner
    // - Reward preference must be one of: FLYBUYS_POINTS, FUEL_DISCOUNT_SHELL, OTR_REWARDS
    // - If preference is FLYBUYS_POINTS, PartnerLink must exist with status=LINKED
    // - Default preference when no partner linked: OTR_REWARDS (fallback)
    //
    // Bounded Context Note:
    // - OAuth tokens are managed by infrastructure OAuth Service
    // - This aggregate tracks: "customer linked partner account"
    // - Created in response to OAuthLinkEstablished event from OAuth Service
    Aggregate PartnerLink {
        Entity CustomerPartnerLink {
            aggregateRoot

            - PartnerLinkId id
            - String VivaConsumerId           // Salesforce customer identifier
            - PartnerType partner             // FLYBUYS, SHELL_CARD
            - String externalMemberId         // Partner's member/account number
            - LinkingStatus status
            - RewardPreference rewardPreference   // Customer's chosen reward type
            - DateTime linkedAt
            - DateTime lastSyncedAt           // Last successful sync
            - String oauthProviderId          // Reference to OAuth Service token

            // Operations
            def updateRewardPreference(newPreference: RewardPreference): void {
                // Invariant: Cannot select FLYBUYS_POINTS unless Flybuys account linked
                // Invariant: Unlinking Flybuys resets preference to OTR_REWARDS (fallback)
            }

            def recordSync(syncStatus: SyncStatus): void
        }

        ValueObject LinkingStatus {
            - LinkState state                 // LINKED, UNLINKED, SYNC_FAILED
            - String errorMessage
            - int failedSyncAttempts
        }

        ValueObject RewardPreference {
            - RewardPreferenceType type       // FLYBUYS_POINTS, FUEL_DISCOUNT_SHELL, OTR_REWARDS
        }

        enum LinkState {
            LINKED,                           // Active partner link
            UNLINKED,                         // No partner link
            SYNC_FAILED                       // Link exists but sync failing
        }

        enum RewardPreferenceType {
            FLYBUYS_POINTS,                   // Earn Flybuys points (requires linking)
            FUEL_DISCOUNT_SHELL,              // Shell Price Save fuel discount (4c/L)
            OTR_REWARDS                       // OTR native loyalty points (default fallback)
        }

        enum PartnerType {
            FLYBUYS, SHELL_CARD
        }
    }

    // 1.3 RiskAssessment Aggregate
    // -----------------------------
    // Customer risk, fraud, and value scores for instant refund decisions.
    // Provides both computed scores and raw factors for transparency.
    //
    // Invariants:
    // - Risk scores must be 0-100
    // - Assessment must have calculated timestamp
    // - Factors must be populated when score is calculated
    //
    // Use Case: Instant Refunds
    // - Provides scored assessment to other business units
    // - Exposes raw factors for custom scoring logic
    // - Enables risk-based refund approval workflows
    Aggregate RiskAssessment {
        Entity CustomerRiskAssessment {
            aggregateRoot

            - RiskAssessmentId id
            - String VivaConsumerId
            - DateTime assessedAt
            - DateTime lastUpdatedAt

            // Computed Scores (0-100)
            - int overallRiskScore           // Combined risk score
            - int fraudRiskScore             // Fraud-specific risk
            - int refundRiskScore            // Refund abuse risk
            - int churnRiskScore             // Customer churn/attrition risk
            - int customerValueScore         // Customer lifetime value score

            // Risk Factors (raw data for transparency)
            - RiskFactors factors

            // Operations
            def calculateRiskScore(): int
            def updateFactors(newFactors: RiskFactors): void
        }

        ValueObject RiskFactors {
            // Refund History
            - int totalRefundCount
            - int refundsLast30Days
            - int refundsLast60Days
            - int refundsLast90Days
            - Money totalRefundAmount
            - Decimal refundToPurchaseRatio
            - List<String> refundReasonDistribution

            // Transaction Behavior
            - int transactionFrequency       // Transactions per month
            - DateTime lastTransactionDate
            - Money averageBasketValue
            - Decimal basketValueVariance
            - int locationDiversity          // Number of unique stores visited
            - boolean hasUnusualPatterns

            // Fraud Indicators
            - int disputedTransactionCount
            - int chargebackCount
            - Decimal failedPaymentRate
            - boolean multipleAccountDetected
            - boolean loginAnomaliesDetected
            - int fraudFlagCount

            // Account Health
            - int accountTenureDays
            - VerificationLevel verificationLevel
            - AccountStatus accountStatus

            // Engagement Metrics (cached from EngagementService)
            - int appUsageFrequency          // Logins per week
            - DateTime lastLoginDate
            - int supportInteractionCount
            - Decimal campaignEngagementRate

            // Churn Indicators
            - int daysSinceLastPurchase
            - int daysSinceLastLogin
            - Decimal transactionFrequencyTrend  // +/- percentage change
            - Decimal basketValueTrend           // +/- percentage change
            - boolean engagementDeclining        // Trend analysis flag
            - LifeCycleStage currentLifeCycleStage

            // Customer Value
            - Money lifetimeValue
            - Money totalSpend
            - ProfitabilityScore profitability
        }

        enum AccountStatus {
            ACTIVE, SUSPENDED, FLAGGED, CLOSED
        }
    }

    // 1.4 RefundHistory Aggregate
    // ----------------------------
    // Customer refund transaction history for risk assessment.
    //
    // Invariants:
    // - Refund amount must be positive
    // - Refund must reference original transaction
    // - Refund reason must be provided
    Aggregate RefundHistory {
        Entity RefundRecord {
            aggregateRoot

            - RefundId id
            - String VivaConsumerId
            - TransactionId originalTransactionId
            - Money refundAmount
            - RefundReason reason
            - RefundStatus status
            - DateTime requestedAt
            - DateTime processedAt
            - String processedBy              // System or agent identifier
            - int processingTimeDays          // Turnaround time tracking
        }

        enum RefundReason {
            PRICING_ERROR,
            PRODUCT_QUALITY,
            TRANSACTION_ERROR,
            CUSTOMER_DISPUTE,
            PROMOTIONAL_ISSUE,
            OTHER
        }

        enum RefundStatus {
            PENDING,
            APPROVED,
            REJECTED,
            PROCESSED,
            CANCELLED
        }
    }


    // ========================================================================
    // SECTION 2: DOMAIN EVENTS
    // ========================================================================
    // Events published to Event Bus for downstream consumption.
    //
    // Event Categories:
    // 1. Profile lifecycle events (creation, updates, verification, completeness, lifecycle stage, onboarding)
    // 2. Partner linking events
    // 3. Risk assessment events
    // 4. Refund history events
    // ========================================================================

    // --- Profile lifecycle Events ---

    DomainEvent ProfileCreated {
        - String VivaConsumerId
        - ProfileId profileId
        - DateTime createdAt
        - VerificationLevel initialVerificationLevel
    }

    DomainEvent ProfileUpdated {
        - String VivaConsumerId
        - ProfileId profileId
        - DateTime updatedAt
        - List<String> changedFields
    }

    DomainEvent ProfileVerificationChanged {
        - String VivaConsumerId
        - VerificationLevel previousLevel
        - VerificationLevel newLevel
        - DateTime changedAt
    }

    DomainEvent ProfileCompletenessChanged {
        - String VivaConsumerId
        - int previousScore
        - int newScore
        - DateTime changedAt
    }

    DomainEvent LifeCycleStageChanged {
        - String VivaConsumerId
        - LifeCycleStage previousStage
        - LifeCycleStage newStage
        - DateTime changedAt
        - String trigger                   // TRANSACTION_INACTIVITY | ENGAGEMENT_CHANGE | MANUAL_UPDATE
    }

    DomainEvent OnboardingCompleted {
        - String VivaConsumerId
        - DateTime completedAt
        - int completionPercentage
        - List<String> completedSteps
    }

    DomainEvent OnboardingProgressUpdated {
        - String VivaConsumerId
        - int previousPercentage
        - int newPercentage
        - String completedStep
        - DateTime updatedAt
    }

    // --- Partner Linking Events (MOVED from LoyaltyService) ---

    DomainEvent PartnerLinked {
        - String VivaConsumerId
        - PartnerType partner
        - String externalMemberId
        - DateTime linkedAt
    }

    DomainEvent PartnerUnlinked {
        - String VivaConsumerId
        - PartnerType partner
        - DateTime unlinkedAt
        - String reason
    }

    DomainEvent PartnerLinkChanged {
        - String VivaConsumerId
        - PartnerType partner
        - LinkState previousState
        - LinkState newState
        - DateTime changedAt
    }

    DomainEvent RewardPreferenceChanged {
        - String VivaConsumerId
        - RewardPreferenceType previousPreference
        - RewardPreferenceType newPreference
        - DateTime changedAt
        - String changeReason              // USER_SELECTED, PARTNER_UNLINKED, FALLBACK_APPLIED
        - PartnerType affectedPartner      // Which partner this change affects (if applicable)
    }

    // --- Risk Assessment Events ---

    DomainEvent RiskStatusChanged {
        - String VivaConsumerId
        - RiskLevel previousLevel
        - RiskLevel newLevel
        - DateTime changedAt
        - String trigger                   // REFUND_THRESHOLD | FRAUD_DETECTED | MANUAL_REVIEW
    }

    DomainEvent FraudIndicatorDetected {
        - String VivaConsumerId
        - FraudIndicatorType indicatorType
        - String description
        - Severity severity
        - DateTime detectedAt
        - boolean requiresInvestigation
    }

    enum RiskLevel {
        LOW, MEDIUM, HIGH, CRITICAL
    }

    enum FraudIndicatorType {
        MULTIPLE_ACCOUNTS,
        CHARGEBACK_PATTERN,
        LOGIN_ANOMALY,
        TRANSACTION_ANOMALY,
        REFUND_ABUSE,
        DISPUTE_PATTERN
    }

    enum Severity {
        LOW, MEDIUM, HIGH, CRITICAL
    }

    // --- Refund History Events ---

    DomainEvent RefundRequested {
        - RefundId refundId
        - String VivaConsumerId
        - TransactionId originalTransactionId
        - Money refundAmount
        - RefundReason reason
        - DateTime requestedAt
    }

    DomainEvent RefundProcessed {
        - RefundId refundId
        - String VivaConsumerId
        - Money refundAmount
        - RefundStatus status
        - DateTime processedAt
        - int processingTimeDays
    }

    // ========================================================================
    // SECTION 3: ORCHESTRATION & QUERY SERVICES
    // ========================================================================
    // Services orchestrate calls to external systems and provide query APIs.
    // ========================================================================

    Service ProfileQueryService {
        // Query customer profile (Salesforce canonical + OTR enrichment)
        getProfile(@String VivaConsumerId) : CustomerProfileResponse

        // Query profile completeness
        getProfileCompleteness(@String VivaConsumerId) : int

        // Query partner links
        getPartnerLinks(@String VivaConsumerId) : List<CustomerPartnerLink>

        // Query specific partner link status
        getPartnerLinkStatus(@String VivaConsumerId, @PartnerType partner) : LinkingStatus
    }

    Service RiskAssessmentService {
        // Get comprehensive risk assessment (scores + raw factors)
        getRiskAssessment(@String VivaConsumerId) : RiskAssessmentResponse

        // Calculate risk score from factors
        calculateRiskScore(@RiskFactors factors) : int

        // Update risk factors
        updateRiskFactors(@String VivaConsumerId, @RiskFactors factors): void

        // Specific risk queries
        getFraudRisk(@String VivaConsumerId) : int
        getRefundRisk(@String VivaConsumerId) : int
        getChurnRisk(@String VivaConsumerId) : int
        getCustomerValueScore(@String VivaConsumerId) : int
    }

    Service RefundHistoryService {
        // Query refund history
        getRefundHistory(@String VivaConsumerId) : List<RefundRecord>

        // Record new refund request
        recordRefund(@RefundRecord refund) : void

        // Calculate refund statistics
        getRefundStatistics(@String VivaConsumerId) : RefundStatistics
    }

    Service PartnerLinkService {
        // Create partner link
        createPartnerLink(@String VivaConsumerId, @PartnerType partner, @String externalMemberId) : PartnerLinkId

        // Update reward preference
        updateRewardPreference(@String VivaConsumerId, @RewardPreferenceType preference) : void

        // Sync with partner (calls partner APIs)
        syncWithPartner(@PartnerLinkId linkId) : boolean

        // Revoke partner link
        revokePartnerLink(@PartnerLinkId linkId) : void
    }

    Service EngagementSyncService {
        // Update cached engagement summary (from EngagementService)
        updateEngagementSummary(@String VivaConsumerId, @EngagementMetrics metrics) : void

        // Get cached engagement summary
        getEngagementSummary(@String VivaConsumerId) : CustomerEngagementSummary
    }

    Service SalesforceProfileAdapter {
        // ACL for Salesforce integration
        // Translates between Salesforce Contact/Person Account and OTR profile model

        // Query canonical customer data from Salesforce
        getCustomer(@String VivaConsumerId) : SalesforceCustomer

        // Resolve email to VCI (for legacy email-keyed lookups)
        resolveEmailToVCI(@String email) : String

        // Validate VCI exists in Salesforce
        validateVCI(@String VivaConsumerId) : boolean
    }

    // ========================================================================
    // SECTION 4: SHARED VALUE OBJECTS
    // ========================================================================
    // Reusable value objects used across multiple aggregates.
    // ========================================================================

    ValueObject Money {
        - Decimal amount
        - String currency                 // AUD, USD
    }

    ValueObject ProfileId {
        - String id
    }

    ValueObject PartnerLinkId {
        - String id
    }

    ValueObject RiskAssessmentId {
        - String id
    }

    ValueObject RefundId {
        - String id
    }

    ValueObject EngagementSummaryId {
        - String id
    }

    ValueObject TransactionId {
        - String id
    }

    ValueObject CustomerProfileResponse {
        // Combined response from Salesforce + ProfileService
        - String VivaConsumerId
        - SalesforceCustomer salesforceData   // Canonical data from Salesforce
        - CustomerProfileRecord otrData       // OTR-specific enrichment
        - List<CustomerPartnerLink> partnerLinks
        - int completenessScore
    }

    ValueObject SalesforceCustomer {
        // Canonical customer data from Salesforce
        - String VivaConsumerId
        - String firstName
        - String lastName
        - String email
        - String phone
        - Address mailingAddress
        - DateTime createdDate
        - DateTime lastModifiedDate
    }

    ValueObject Address {
        - String street
        - String city
        - String state
        - String postalCode
        - String country
    }

    ValueObject RiskAssessmentResponse {
        // Comprehensive risk assessment with scores and raw factors
        - String VivaConsumerId
        - DateTime assessedAt

        // Computed Scores
        - int overallRiskScore
        - int fraudRiskScore
        - int refundRiskScore
        - int churnRiskScore
        - int customerValueScore

        // Raw Factors (for transparency and custom scoring)
        - RiskFactors factors

        // Aggregated from Other Services
        - String loyaltyTier              // From LoyaltyService
        - int loyaltyPointsBalance        // From LoyaltyService
    }

    ValueObject RefundStatistics {
        - int totalRefundCount
        - Money totalRefundAmount
        - Decimal refundToPurchaseRatio
        - Money averageRefundAmount
        - int refundsLast30Days
        - int refundsLast90Days
        - List<String> topRefundReasons
    }

    ValueObject EngagementMetrics {
        // Metrics from EngagementService for caching
        - int emailOpenRate
        - int emailClickRate
        - int pushNotificationEngagement
        - int campaignResponseCount
        - DateTime lastCampaignInteraction
        - EngagementTier engagementTier
    }

    // ========================================================================
    // SECTION 5: REPOSITORIES (Persistence Abstractions)
    // ========================================================================
    // Repository interfaces define persistence operations for owned aggregates.
    // ========================================================================

    // Repository CustomerProfileRepository
    // Repository PartnerLinkRepository
    // Repository RiskAssessmentRepository
    // Repository RefundHistoryRepository
    // Repository EngagementSummaryRepository
}

// ============================================================================
// END OF BOUNDED CONTEXT
// ============================================================================
//
// Implementation Notes:
// - Database: Azure SQL (optimized for high-frequency updates)
// - Events published to Event Bus topic: "profile-events"
// - Salesforce integration via REST API with OAuth 2.0
// - EngagementService integration via Event Bus + batch sync
// - LoyaltyService queries ProfileService synchronously
// - Admin portal enhanced to use ProfileService APIs
// - VCI introduced through Flybuys initiative
// ============================================================================
