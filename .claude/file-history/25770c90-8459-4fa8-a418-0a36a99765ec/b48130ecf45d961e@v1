= Salesforce Customer Support - Architecture Definition
:project-name: OTR-002
:togaf-adm-phase: Phase C: Information Systems Architectures
:document-type: Architecture Definition Document
:status: Discovery
:version: 0.1
:domain: Customer Support & Engagement
:programme-lead: TBD
:domain-architect: O.Young@otr.com.au
:business-owner: TBD
:solution-architecture: xref:solution-architectures:salesforce_customer_support.adoc[Solution Architectures/Salesforce Customer Support]
:doctype: article
:toc: left
:toclevels: 4
:sectanchors:
:sectlinks:
:sectnums:
:icons: font
:source-highlighter: highlightjs
:experimental:
:description: Architecture Definition Document for consolidating OTR digital customer support onto Salesforce Service Cloud
:keywords: salesforce, customer-support, engagement, profile, architecture-definition, togaf, ddd

== Executive Summary

*Project:* Consolidate OTR digital customer support onto Salesforce Service Cloud

*Scope:* Establish ProfileService and EngagementService bounded contexts as the first implementation of OTR's Domain-Driven Design (DDD) architecture

*Approach:* Event-driven integration with Anti-Corruption Layers protecting digital channels from external system changes

*Bounded Contexts:* xref:bounded-contexts:profile.adoc[ProfileService] (Contact reconciliation), xref:bounded-contexts:engagement.adoc[EngagementService] (Customer feedback & support coordination)

*Strategic Significance:* First DDD bounded context implementation, establishing architectural patterns for future services (Loyalty, Location, Payment, Recommendation)

== Phase A: Architecture Vision

=== Business Context

*Business Driver:* Unify customer support platform across all Viva Energy channels, consolidating OTR digital feedback onto Salesforce Service Cloud

*Stakeholders:*

* Customer Support Teams (business owners)
* Digital Product Team (solution owners)
* Viva Energy Salesforce Team (platform owners, shared instance)
* Mobile App Users (end users)

=== Architecture Principles Applied

. *Domain-Driven Design:* Clear bounded contexts with well-defined responsibilities
. *Anti-Corruption Layer:* Protect digital domain from external system changes
. *Event-Driven Architecture:* Loose coupling between bounded contexts via domain events
. *Conformist Pattern:* Accept external system constraints where we don't have control (Salesforce shared instance)
. *Just-In-Time Integration:* Reconcile data on-demand rather than pre-synchronisation
. *Async Processing:* Non-blocking user experience with resilience to external system downtime

=== Strategic Context: First DDD Implementation

*OTR Architecture Evolution:*

This initiative marks the transition from monolithic architecture to Domain-Driven Design with bounded contexts.

[mermaid]
----
graph TB
    subgraph "Current State (Baseline)"
        D365CE[D365 Customer<br>Engagement]
        AppDB[(App-Specific<br>Contact DB)]
        MobileOld[Mobile App] --> D365CE
        MobileOld --> AppDB
    end

    subgraph "Target State (DDD Architecture)"
        Profile[ProfileService<br>Bounded Context]
        Engagement[EngagementService<br>Bounded Context]
        Salesforce[Salesforce<br>Service Cloud]
        Braze[Braze]
        EventBus[Event Bus<br>Domain Events]

        MobileNew[Mobile App] --> Profile
        MobileNew --> Engagement
        Profile <--> Salesforce
        Engagement <--> Salesforce
        Engagement --> EventBus
        Engagement --> Braze
    end

    style Profile fill:#4CAF50,stroke:#2E7D32,stroke-width:3px,color:#fff
    style Engagement fill:#4CAF50,stroke:#2E7D32,stroke-width:3px,color:#fff
    style EventBus fill:#2196F3,stroke:#0D47A1,stroke-width:2px,color:#fff
----

*Platform Strategy:*

* **First Bounded Contexts:** ProfileService and EngagementService establish DDD patterns
* **Event-Driven Integration:** Domain events provide foundation for future bounded contexts
* **Anti-Corruption Layers:** Protect OTR domain from external systems (Salesforce, Braze)
* **Foundation for Future:** Patterns reused for Loyalty, Location, Payment, Recommendation services

*Why This Matters:*

This is not just a platform consolidation - it's the foundational architecture implementation that enables OTR's digital platform to scale and evolve independently of external systems.

=== Success Criteria

* Unified customer view across all Viva Energy channels in Salesforce
* >99.5% customer feedback submission success rate
* Feedback submission p95 <1 second (non-blocking user experience)
* Case creation within 5 minutes of feedback submission
* D365 CE retired within 90 days post-cutover
* Architecture patterns established for future bounded contexts

== Phase B: Business Architecture

=== Business Capabilities

[mermaid]
----
graph TD
    A[Customer Support] --> B[Feedback Collection]
    A --> C[Case Management]
    A --> D[Customer Communication]

    B --> E[Mobile App Feedback]
    B --> F[Web Feedback]
    B --> G[Email Feedback]

    C --> H[Case Creation]
    C --> I[Case Assignment]
    C --> J[Case Resolution]
    C --> K[Case Tracking]

    D --> L[Push Notifications]
    D --> M[Email Notifications]
    D --> N[SMS Notifications]

    style E fill:#4CAF50,stroke:#2E7D32,stroke-width:2px
    style H fill:#4CAF50,stroke:#2E7D32,stroke-width:2px
    style L fill:#4CAF50,stroke:#2E7D32,stroke-width:2px
----

_Green = New capabilities enabled by this initiative_

=== Organisational Structure

*Current State:*

* Digital support team uses D365 CE (isolated from broader Viva Energy)
* Manual Contact data entry in app-specific database
* Fragmented customer interaction history

*Target State:*

* Unified support team using Salesforce Service Cloud
* Automated Contact reconciliation via ProfileService
* Complete customer interaction history across all Viva Energy channels
* Shared Salesforce instance governance with Viva Energy

=== Business Process Flow

==== Customer Feedback Submission (Target State)

. Customer opens Mobile App "Get In Touch" → "Contact Us"
. Selects feedback category (App, Service, Order, Rewards, Refund, Delete Account)
. Provides optional details (Store Name, Time of Visit, Phone Number, Free Text)
. Taps "Submit Feedback"
. **Immediate confirmation**: "Thank you, we've received your feedback"
. ProfileService reconciles customer as Salesforce Contact (JIT upsert by email)
. EngagementService publishes CustomerFeedbackSubmitted event to Event Bus
. Background worker creates Case in Salesforce asynchronously
. **Customer receives push notification**: "Your support request has been created (Case #12345)" (within 5 minutes)

==== Case Resolution (Target State)

. Support agent views Case in Salesforce (complete customer interaction history)
. Agent updates Case status, adds resolution notes
. Salesforce webhook notifies EngagementService of Case update
. EngagementService triggers Braze push notification
. **Customer receives notification**: "Your support request #12345 has been resolved"

== Phase C: Information Systems Architecture

=== Application Architecture

==== New Bounded Contexts

===== xref:bounded-contexts:profile.adoc[ProfileService]

*Responsibility:* Customer identity and Contact reconciliation

*Capabilities:*

* Just-In-Time Contact reconciliation with Salesforce (upsert by email)
* Returns Salesforce Contact ID to digital channels
* Foundation for future partner linking (Flybuys OAuth flow)
* Stateless service (Salesforce is System of Record)

*Integration Pattern:* Conformist (conforms to Salesforce Contact API)

*Technology:* AWS Lambda/ECS, .NET, Salesforce REST API

===== xref:bounded-contexts:engagement.adoc[EngagementService]

*Responsibility:* Customer feedback submission and support coordination

*Capabilities:*

* Customer feedback submission facade (Backend-for-Frontend pattern)
* Anti-Corruption Layer for Salesforce Case creation
* Asynchronous Case creation via Event Bus (non-blocking UX)
* Braze integration for all outbound customer communications
* Webhook receiver for Salesforce Case updates
* Event publisher for domain events

*Integration Pattern:* Anti-Corruption Layer (protects digital channels from Salesforce changes)

*Technology:* AWS Lambda/ECS, .NET, Salesforce REST API, Braze API, Event Bus (SNS+SQS/EventBridge)

===== Event Bus

*Responsibility:* Event-driven integration infrastructure

*Capabilities:*

* Domain event publishing (CustomerFeedbackSubmitted, SupportCaseCreated, SupportCaseUpdated)
* Asynchronous Case creation with retry logic and exponential backoff
* Dead letter queue for operations team intervention
* Foundation pattern for future bounded context integration

*Technology:* AWS SNS+SQS / EventBridge / Kinesis (decision TBD)

==== External System Integration

* **Salesforce Service Cloud:** System of Record for Contact and Case data (shared Viva Energy instance, Conformist pattern)
* **Braze:** Customer communication platform for push notifications, email, SMS (Anti-Corruption Layer)
* **Microsoft Entra External ID:** Customer authentication (existing CIAM service)
* **D365 Customer Engagement:** Legacy platform (retired within 90 days post-cutover)

=== Application Component Catalog

[width="100%",cols="30%,20%,50%",options="header",]
|===
|Component |Type |Responsibilities

|ProfileService API
|Microservice
|Contact reconciliation, Salesforce Contact ID retrieval, JIT upsert by email

|EngagementService API
|Microservice
|Feedback submission, Salesforce ACL, async Case creation, Braze integration

|Event Bus
|Infrastructure
|Domain event publishing, async processing, retry logic, DLQ

|Salesforce ACL
|Integration Layer
|Translate OTR domain language ↔ Salesforce API, Case/Contact operations

|Braze ACL
|Integration Layer
|Translate EngagementService domain events → Braze campaign triggers

|Contact Migration Tool
|Batch Process
|One-time migration from app-specific DB to Salesforce

|Mobile App Integration
|Client
|Calls ProfileService and EngagementService APIs

|===

=== Data Architecture

==== System of Record Boundaries

* **Salesforce:** Contact, Case (authoritative source)
* **ProfileService:** None (stateless, queries Salesforce on-demand)
* **EngagementService:** Event publishing log (eventual consistency with Salesforce)
* **Braze:** Customer communication preferences and history
* **Microsoft Entra External ID:** Customer authentication credentials

==== Data Migration

*Contact Migration (App-Specific DB → Salesforce):*

* One-time batch migration before cutover
* Upsert by email (primary matching key)
* Flexible matching (email/phone/VCI for conflict resolution)
* 100% validation pass rate requirement
* Reconciliation report for manual review

*No Case Migration:*

* Fresh start in Salesforce (D365 CE remains accessible temporarily for historical reference)
* Simpler migration, faster time to value

== Phase D: Technology Architecture

=== Technology Stack by Bounded Context

[width="100%",cols="25%,25%,50%",options="header",]
|===
|Bounded Context |Technology |Rationale

|ProfileService
|AWS Lambda/ECS, .NET, Salesforce REST API
|Serverless for scale, .NET for team expertise, Salesforce API for Contact operations

|EngagementService
|AWS Lambda/ECS, .NET, Event Bus, Salesforce REST API, Braze API
|Async processing, event-driven, Anti-Corruption Layer

|Event Bus
|AWS SNS+SQS / EventBridge / Kinesis (TBD)
|AWS-native event infrastructure, async domain events, retry/DLQ support

|Mobile App
|Existing stack (iOS/Android)
|No changes required (consumes new APIs)

|===

=== Technology Decisions

==== TD-001: AWS Platform for Bounded Contexts

* **Decision:** Deploy ProfileService and EngagementService on AWS
* **Rationale:** OTR ecommerce team operates on AWS, consistent platform for customer-facing services, existing expertise
* **Alternatives Considered:** Azure (rejected due to team platform standardisation on AWS for digital)

==== TD-002: Event Bus Technology

* **Decision:** TBD - Evaluate SNS+SQS, EventBridge, Kinesis
* **Criteria:** Event ordering requirements, dead letter queue support, team familiarity, cost
* **Status:** Under evaluation

==== TD-003: .NET for Microservices

* **Decision:** .NET (C#) for ProfileService and EngagementService
* **Rationale:** Team expertise, consistent with OTR ecommerce standards, strong Salesforce SDK support
* **Status:** Approved

==== TD-004: Salesforce Shared Instance (Conformist)

* **Decision:** Use existing Viva Energy Salesforce instance, conform to their governance
* **Rationale:** Business requirement (unified customer view), platform consolidation, reduced operational overhead
* **Consequences:** Less control over Salesforce platform evolution, multi-tenant data isolation required
* **Status:** Approved

==== TD-005: Email as Primary Matching Key

* **Decision:** Email as primary matching key for Contact reconciliation
* **Rationale:** Always available, unique in Salesforce, simplifies upsert logic
* **Consequences:** Email changes create duplicate Contacts (rare edge case, manual cleanup)
* **Alternatives Considered:** VCI (not always available), phone number (not unique)
* **Status:** Approved

=== Network Architecture

==== AWS Infrastructure

* **VPC:** OTR ecommerce VPC (existing)
* **Subnets:** Private subnets for microservices, public subnet for API Gateway
* **API Gateway:** REST API exposure with OAuth 2.0 authentication
* **Load Balancer:** Application Load Balancer for ECS services
* **Connectivity:** Internet Gateway for Salesforce/Braze API calls (HTTPS)

==== External Connectivity

* **Salesforce:** HTTPS API calls from AWS (public internet)
* **Braze:** HTTPS API calls from AWS (public internet)
* **Mobile App:** HTTPS API calls via API Gateway

=== Security Architecture

==== Authentication & Authorisation

* **Mobile App → ProfileService/EngagementService:** Microsoft Entra External ID JWT tokens (existing CIAM)
* **Event Bus → EngagementService Workers:** IAM roles (internal AWS)
* **Salesforce Webhooks → EngagementService:** API key authentication + IP allowlist

==== Data Protection

* **Encryption in Transit:** TLS 1.2+ for all API calls
* **Encryption at Rest:** AWS KMS for sensitive data (if stored)
* **Secrets Management:** AWS Secrets Manager for Salesforce/Braze credentials
* **API Rate Limiting:** API Gateway throttling (100 requests/second per user)

==== Audit Logging

* **CloudTrail:** AWS API calls
* **Application Logs:** CloudWatch Logs (API requests, Case creation, errors)
* **Salesforce Audit Log:** Case/Contact changes tracked in Salesforce

=== Architecture Decision Records

==== ADR-CS-001: Consolidate onto Salesforce Service Cloud

* **Context:** OTR digital support on D365 CE, Viva Energy on Salesforce
* **Decision:** Migrate OTR digital support to Salesforce Service Cloud (shared Viva Energy instance)
* **Rationale:** Unified customer view across Viva Energy, platform consolidation, proven solution
* **Consequences:** Conformist pattern (less control), multi-tenant governance
* **Status:** Approved

==== ADR-CS-002: Implement ProfileService and EngagementService as First DDD Bounded Contexts

* **Context:** Need architectural foundation for future bounded contexts
* **Decision:** Establish ProfileService and EngagementService as first DDD bounded contexts with clear responsibilities
* **Rationale:** Separation of concerns, reusable patterns, Anti-Corruption Layer, foundation for Flybuys/Loyalty
* **Consequences:** Increased initial complexity (two new microservices, Event Bus infrastructure)
* **Status:** Approved

==== ADR-CS-003: Async Case Creation via Event Bus

* **Context:** Salesforce downtime should not block customer feedback submission
* **Decision:** Async Case creation via Event Bus with immediate user acknowledgement
* **Rationale:** Non-blocking UX, resilience to Salesforce downtime, automatic retry, scalability
* **Consequences:** Eventual consistency (user gets success before Case created, not immediately)
* **Status:** Approved

==== ADR-CS-004: Email as Primary Matching Key for Contact Reconciliation

* **Context:** Need reliable way to match mobile app users to Salesforce Contacts
* **Decision:** Email as primary matching key (not VCI)
* **Rationale:** Always available, unique in Salesforce, simplifies upsert logic
* **Consequences:** Email changes create duplicate Contacts (rare edge case, manual cleanup)
* **Status:** Approved

==== ADR-CS-005: No Case Migration from D365 CE

* **Context:** D365 CE has historical Cases - should we migrate?
* **Decision:** Fresh start in Salesforce (no Case migration)
* **Rationale:** Simpler migration, faster time to value, clean start, D365 CE remains accessible temporarily
* **Consequences:** Historical Cases not visible in Salesforce
* **Status:** Approved

==== ADR-CS-006: Big Bang Cutover

* **Context:** How to transition from D365 CE to Salesforce?
* **Decision:** Big bang cutover (all users switch simultaneously)
* **Rationale:** Simpler deployment, faster D365 CE retirement, manageable user base
* **Consequences:** Higher cutover risk (comprehensive testing required)
* **Status:** Approved

==== ADR-CS-007: Braze for All Outbound Customer Communications

* **Context:** How to notify customers of Case updates?
* **Decision:** Braze handles all outbound communications (not Salesforce Marketing Cloud)
* **Rationale:** Consistent customer experience, single platform for communication preferences, team already familiar with Braze, Anti-Corruption Layer (decoupled from Salesforce)
* **Consequences:** Additional integration point, Braze must be available for notifications
* **Status:** Approved

== Key Diagrams Summary

=== Context Diagram

[mermaid]
----
graph LR
    subgraph External
        Customer([Customer])
        Salesforce[Salesforce<br>Service Cloud]
        Braze[Braze]
        Entra[Microsoft Entra<br>External ID]
    end

    subgraph "OTR Digital Platform (AWS)"
        Mobile[Mobile App]
        Profile[ProfileService]
        Engagement[EngagementService]
        EventBus[Event Bus]
    end

    Customer --> Mobile
    Mobile --> Entra
    Mobile --> Profile
    Mobile --> Engagement
    Profile <--> Salesforce
    Engagement <--> Salesforce
    Engagement --> EventBus
    Engagement --> Braze
    Braze --> Customer

    style Profile fill:#4CAF50,stroke:#2E7D32,stroke-width:3px,color:#fff
    style Engagement fill:#4CAF50,stroke:#2E7D32,stroke-width:3px,color:#fff
    style EventBus fill:#2196F3,stroke:#0D47A1,stroke-width:2px,color:#fff
----

=== Integration Pattern

[mermaid]
----
graph TB
    subgraph "Mobile App"
        User([Customer])
    end

    subgraph "Bounded Contexts (AWS)"
        Profile[ProfileService<br>JIT Contact Reconciliation]
        Engagement[EngagementService<br>Feedback Facade + ACL]
        EventBus[Event Bus<br>Domain Events]
    end

    subgraph "External Systems"
        Salesforce[Salesforce<br>System of Record]
        Braze[Braze<br>Communications]
    end

    User -->|Submit Feedback| Engagement
    Engagement -->|Get Contact ID| Profile
    Profile <-->|Conformist| Salesforce
    Engagement -->|Publish Event| EventBus
    EventBus -->|Async Case Creation| Engagement
    Engagement <-->|ACL| Salesforce
    Engagement -->|ACL| Braze
    Braze -->|Push Notification| User

    style Profile fill:#4CAF50,stroke:#2E7D32,stroke-width:3px,color:#fff
    style Engagement fill:#4CAF50,stroke:#2E7D32,stroke-width:3px,color:#fff
    style EventBus fill:#2196F3,stroke:#0D47A1,stroke-width:2px,color:#fff
----

== Document Control

[cols="1,2,2,4"]
|===
|Version |Date |Author |Changes

|0.1
|2026-01-13
|O.Young (Domain Architect)
|Initial draft - Phases A, B, C, D - aligned with Subway DMB architecture definition structure

|===

*Approval Required From:*

* [ ] Digital Product Lead (confirms business requirements)
* [ ] Viva Energy Salesforce Team (confirms shared instance governance)
* [ ] Security Architect (approves integration security model)
* [ ] Customer Support Lead (confirms support process alignment)

*Key Message for Stakeholders:*

This initiative establishes the foundational Domain-Driven Design architecture for OTR's digital platform. By implementing ProfileService and EngagementService as the first bounded contexts with clear responsibilities, Anti-Corruption Layers, and event-driven integration, we create reusable patterns for future services (Loyalty, Location, Payment, Recommendation). The consolidation onto Salesforce provides unified customer view across all Viva Energy channels while the DDD architecture ensures digital channels can evolve independently.
