= OTR-003 Subway Digital Menu Board Integration
:domain: ProductCatalog
:domain-architect: O.Young@otr.com.au
:project: OTR-003
:doctype: article
:toc: left
:toclevels: 3
:sectanchors:
:sectlinks:
:sectnums:
:icons: font
:source-highlighter: highlightjs
:experimental:

== What We're Building

A cross-cloud pricing integration that enables Subway digital menu boards (DMBs) across OTR-operated stores to display accurate, real-time pricing from D365 Commerce via a new ProductCatalogService on AWS.

[cols="1,2"]
|===
| Feature | Description

| Real-time pricing API
| RESTful API exposing product pricing from D365 Commerce to Amped Digital DMB platform

| Automated data synchronisation
| Scheduled ingestion of pricing data from Azure (D365 Commerce) to AWS (ecommerce domain)

| Multi-store pricing support
| Store-specific pricing with price group hierarchy (chain/region/store levels)

| Product catalog queries
| Structured product data with categories, descriptions, modifiers, and availability

| Integration monitoring
| Automated alerts for data pipeline failures, API degradation, and stale data detection

| Scalable architecture
| Foundation for future product catalog consumers (OTR App, SMGB Online ordering)
|===

== Architecture Approach

This initiative establishes the first cross-cloud domain integration pattern for OTR Group, bridging the back-office domain (Azure, D365 Commerce) with the ecommerce domain (AWS, customer-facing workloads).

At its core, this architecture creates a clear separation between domains while maintaining a unified view of product and pricing data. The xref:bounded-contexts:product_catalog.adoc[ProductCatalogService] acts as a Backend-for-Frontend (BFF) and Anti-Corruption Layer, translating D365 Commerce pricing structures into AWS-native APIs optimised for digital consumer experiences.

By implementing this pattern now, OTR establishes a repeatable approach for exposing back-office data to customer-facing channels without tight coupling between domains, reducing delivery risk and enabling both platforms to evolve independently.

=== New xref:bounded-contexts:product_catalog.adoc[ProductCatalogService]

Product catalog and pricing facade for ecommerce domain

- Ingests pricing data from D365 Commerce via S3 data export
- Provides RESTful API for product and pricing queries
- Manages store-specific pricing with hierarchy (chain/region/store)
- Foundation for future catalog consumers (mobile app, online ordering)
- AWS-native implementation (Lambda/ECS, RDS PostgreSQL, S3, API Gateway)

=== Cross-Cloud Integration Pattern

Data pipeline bridging Azure and AWS domains

- D365 Commerce exports pricing data to Azure Storage (scheduled)
- Azure Data Factory orchestrates cross-cloud transfer to AWS S3
- AWS ingestion pipeline (Lambda/Glue) validates and loads to RDS
- API layer queries RDS with optional Redis caching
- Automated monitoring and alerting for pipeline health

=== Integration Points

[cols="1,2"]
|===
| Integration | Description

| D365 Commerce
| System of Record for product catalog and pricing (back-office domain, Azure)

| Amped Digital
| Digital Menu Board platform consuming pricing API (external vendor)

| Azure Data Factory
| Orchestrates scheduled data export and cross-cloud transfer

| AWS S3
| Landing zone for pricing data exports (cross-account access from Azure)

| AWS RDS PostgreSQL
| Pricing data storage optimised for API queries

| Future: OTR Mobile App
| Product catalog queries for in-app ordering and promotions

| Future: SMGB Online Ordering
| Real-time product availability and pricing
|===

== Key Capabilities Delivered

[cols="1,2,2"]
|===
| Capability | How It Works | Business Value

| *Real-Time Pricing Queries*
| RESTful API with <200ms p95 response time
| Digital menu boards display accurate, current pricing without manual updates

| *Store-Specific Pricing*
| Price group hierarchy with store/region/chain fallback logic
| Supports franchise pricing variations and promotional pricing by location

| *Automated Synchronisation*
| Scheduled data pipeline (hourly/daily) with validation and error handling
| Pricing updates flow automatically without manual intervention

| *Multi-Consumer API*
| Standardised product catalog interface
| Future channels (mobile app, online ordering) reuse same data source

| *Cross-Cloud Integration*
| S3-based data contract between Azure and AWS domains
| Back-office and ecommerce domains evolve independently without tight coupling

| *Data Quality Monitoring*
| Automated validation, staleness detection, and failure alerts
| Operations team notified of pricing sync issues before business impact

| *Scalable Foundation*
| AWS-native architecture with auto-scaling and caching
| Supports future catalog expansion beyond Subway (Oporto, Red Rooster, other brands)
|===

== Customer Journey

=== Digital Menu Board (Pricing Display)

. Subway store opens for the day
. Amped Digital DMB platform queries ProductCatalogService API for store-specific pricing
. API returns current product catalog with prices (from overnight D365 Commerce sync)
. Digital menu boards display accurate pricing across all screens
. *Pricing updates automatically* when D365 Commerce pricing changes (next sync cycle)

[mermaid]
----
sequenceDiagram
    participant DMB as Amped Digital<br/>DMB Platform
    participant API as ProductCatalog API<br/>(AWS)
    participant RDS as RDS PostgreSQL<br/>(AWS)
    participant S3 as S3 Bucket<br/>(AWS)
    participant ADF as Azure Data Factory<br/>(Azure)
    participant D365 as D365 Commerce<br/>(Azure)

    Note over D365,DMB: Daily Pricing Sync (overnight)
    D365 ->> ADF: Export pricing data (scheduled)
    ADF ->> S3: Transfer to AWS S3 (cross-cloud)
    S3 ->> RDS: Ingest & validate pricing data

    Note over D365,DMB: Store Opening (daytime)
    DMB ->> API: GET /stores/{storeId}/products/pricing
    API ->> RDS: Query current pricing
    RDS -->> API: Product catalog with prices
    API -->> DMB: Return pricing (p95 <200ms)
    DMB ->> DMB: Render menu boards with accurate pricing
----

=== Pricing Update (D365 Commerce → DMB)

. Back-office team updates product pricing in D365 Commerce
. Scheduled export runs (overnight)
. Azure Data Factory transfers pricing file to AWS S3
. AWS ingestion pipeline validates and loads to RDS PostgreSQL
. Next DMB API query returns updated pricing
. *Digital menu boards refresh* with new pricing automatically

[mermaid]
----
sequenceDiagram
    actor Admin as Back-Office Team
    participant D365 as D365 Commerce
    participant ADF as Azure Data Factory
    participant S3 as AWS S3
    participant Lambda as AWS Lambda<br/>(Ingestion)
    participant RDS as RDS PostgreSQL
    participant SNS as SNS Alerts
    participant DMB as Amped Digital DMB

    Admin ->> D365: Update product pricing
    Note over D365,DMB: Overnight Sync Window (01:00-02:00)
    D365 ->> ADF: Scheduled pricing export
    ADF ->> S3: Cross-cloud transfer (PGP encrypted)
    S3 ->> Lambda: S3 event trigger
    Lambda ->> Lambda: Validate pricing data
    alt Validation Success
        Lambda ->> RDS: Load new pricing
        Lambda ->> SNS: Success notification
    else Validation Failure
        Lambda ->> SNS: Alert: Pricing sync failed
    end

    Note over D365,DMB: Next Day (store opening)
    DMB ->> RDS: Query pricing (via API Gateway)
    RDS -->> DMB: Return updated pricing
    DMB ->> DMB: Display new menu board pricing
----

== Implementation Phases

Phased Rollout with Pilot Store Validation

[cols="1,2,1,2"]
|===
| Phase | Capability Enabled | Scope | Success Criteria

| *TS-0: Foundation*
| S3 data pipeline, RDS schema, data contract with D365 Commerce
| Non-production
| Data contract agreed, S3 cross-account access validated, RDS schema approved

| *TS-1: API Development*
| ProductCatalogService API (GET products, pricing), ingestion pipeline (Lambda/Glue)
| Dev/Test environments
| API functional tests pass, ingestion handles sample data, <200ms p95 API response

| *TS-2: Pilot Stores*
| Amped Digital DMB integration, production data pipeline
| 2-3 pilot Subway stores
| DMBs display accurate pricing, overnight sync completes within 1 hour, zero pricing discrepancies

| *TS-3: Rollout*
| All Subway stores enabled
| All OTR-operated Subway locations
| >99% sync success rate, <5 manual pricing corrections per month, no P1/P2 incidents

| *TS-4: Target State*
| ProductCatalogService available for future consumers
| All channels
| API ready for OTR App and SMGB Online integration (future initiatives)
|===

*Rollback Strategy*: Pilot stores can revert to manual DMB pricing updates if API unavailable. Full rollout only after 30-day pilot validation.

== Non-Functional Requirements Met

[cols="1,2,2"]
|===
| Requirement | Target | How We Achieve It

| *API Response Time*
| p95 <200ms, p99 <500ms
| Direct RDS queries, optional Redis caching, AWS region co-location (API + RDS)

| *Data Freshness*
| Pricing synced within 24 hours of D365 Commerce update
| Scheduled nightly sync (01:00-02:00 UTC), configurable for hourly if needed

| *System Uptime*
| 99.9% (API availability)
| AWS auto-scaling (ECS/Lambda), health checks, multi-AZ RDS deployment

| *Data Accuracy*
| >99.5% pricing match with D365 Commerce
| Automated validation on ingestion, staleness detection, reconciliation reports

| *Sync Success Rate*
| >98% successful overnight syncs
| Retry logic with exponential backoff, automated alerts on failures, manual intervention playbook

| *Scalability*
| Support 100+ stores, 5000+ SKUs, 500 API requests/minute
| AWS auto-scaling, RDS read replicas, Redis caching for high-traffic queries

| *Cross-Cloud Transfer*
| Secure, encrypted data transfer (Azure → AWS)
| S3 cross-account access with IAM roles, PGP encryption, VPC endpoints

| *Data Residency*
| All pricing data in Australia East region (AWS)
| Region pinning, compliance validation
|===

== Risks & Mitigation

[cols="1,1,2"]
|===
| Risk | Impact | Mitigation

| *D365 Commerce export failures*
| Stale pricing data in DMBs
| Staleness detection alerts, fallback to previous day's pricing, manual intervention playbook

| *Cross-cloud transfer failures*
| Pricing data not reaching AWS
| Automated retry with exponential backoff, SNS alerts to operations team, S3 event logs for troubleshooting

| *API performance degradation*
| Slow DMB loading, poor customer experience
| CloudWatch alarms on p95/p99 latency, auto-scaling, optional Redis caching, performance testing in pilot phase

| *Pricing data accuracy issues*
| DMBs display incorrect prices
| Automated validation on ingestion (schema, data types, price ranges), reconciliation reports, manual spot checks in pilot

| *Amped Digital API changes*
| Integration breaks without notice
| API versioning, conformist pattern (we adapt to their contract), monitoring for 4xx/5xx errors, vendor communication channel

| *Multi-store pricing complexity*
| Wrong prices displayed at franchise locations
| Price group hierarchy validation, store mapping verification, pilot stores include franchise locations

| *Azure Data Factory downtime*
| Scheduled sync fails
| SNS alerts on missed sync window, manual retry via Azure portal, fallback to previous day's pricing

| *RDS database failures*
| API unavailable, DMBs can't load pricing
| Multi-AZ RDS deployment, automated backups, failover testing, Redis cache serves stale data during outage
|===

== Key Decisions Made

[cols="1,2,2"]
|===
| Decision | Rationale | Trade-off Accepted

| *AWS platform for ProductCatalogService* (not Azure)
| Ecommerce team operates on AWS, existing commercial agreement, aligns with customer-facing workload strategy
| Cross-cloud integration complexity (Azure → AWS data transfer)

| *S3 data contract* (not REST API or database replication)
| Loose coupling between domains, asynchronous processing, simplifies cross-cloud networking, resilient to downtime
| Data freshness (overnight sync, not real-time)

| *RDS PostgreSQL* (not DynamoDB)
| Relational data model (products, prices, stores, price groups), supports complex queries, familiar technology for team
| Additional operational overhead vs. managed NoSQL (acceptable for pilot scale)

| *Scheduled sync* (not event-driven)
| Simpler implementation, meets DMB refresh requirements (daily pricing updates), reduces cross-cloud complexity
| Data staleness (up to 24 hours), not suitable for real-time use cases

| *API Gateway + ECS/Lambda* (not direct RDS access)
| Secure API exposure, rate limiting, authentication, abstraction layer, scalable architecture
| Additional latency (~50ms), increased architecture complexity

| *Amped Digital as conformist* (not custom integration)
| External vendor, we don't control their API, simpler to adapt to their contract
| Less control over API design, must accommodate their requirements

| *Price group hierarchy* (not flat pricing)
| Supports franchise pricing variations, regional promotions, chain-wide pricing
| Additional complexity in price resolution logic, more data to synchronise

| *Optional Redis caching* (not mandatory)
| Start simple, add caching if API performance degrades during rollout
| Potential cache staleness if implemented (acceptable trade-off for performance)
|===

== Future Capacity Delivered

[cols="1,3"]
|===
| Stream | Capacity

| *Product Catalog Foundation*
| Establishes standardised product catalog API for all OTR brands (Subway, Oporto, Red Rooster, etc.)

| *Mobile App Ordering*
| Product catalog queries for in-app ordering, menu display, and promotional offers (reuses ProductCatalogService)

| *SMGB Online Ordering*
| Real-time product availability, pricing, and modifiers for small goods and beverage online ordering

| *Cross-Cloud Integration Pattern*
| Repeatable approach for exposing back-office data (Azure) to customer-facing channels (AWS) without tight coupling

| *Digital Menu Board Expansion*
| Supports DMB rollout to other OTR brands beyond Subway (Oporto, Red Rooster, Corica, Sharetea)

| *Promotional Pricing*
| Foundation for dynamic pricing, time-based promotions, and loyalty-driven discounts

| *Inventory Visibility*
| Extend ProductCatalogService to include real-time inventory for "out of stock" management

| *Multi-Brand Catalog*
| Single API serving product catalog for all OTR brands (reduces duplication, improves consistency)

| *Analytics & Insights*
| Product performance tracking, pricing effectiveness analysis, demand forecasting
|===
