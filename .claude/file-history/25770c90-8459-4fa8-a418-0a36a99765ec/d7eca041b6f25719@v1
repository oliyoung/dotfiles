/*
 * ProductCatalogService - Bounded Context Definition
 * ===================================================
 *
 * Facade and Anti-Corruption Layer for product catalog and pricing data.
 * Bridges D365 Commerce (Azure back-office) with customer-facing digital experiences (AWS).
 *
 * See product_catalog.adoc for comprehensive architecture documentation and decision log.
 */

import "../domains/product_catalog.cml"

BoundedContext ProductCatalogService implements ProductCatalogDomain {

    type = APPLICATION

    // Strategic DDD Classification: SUPPORTING_DOMAIN
    // Enables product discovery and pricing across channels but is not a primary competitive differentiator.
    // D365 Commerce owns the authoritative product catalog; this service translates and caches.
    strategicClassification = "SUPPORTING_DOMAIN"

    domainVisionStatement = "Facade and Anti-Corruption Layer that translates D365 Commerce product and pricing data into AWS-native APIs for customer-facing applications. Provides stable API contract in OTR's ubiquitous language."

    responsibilities = "Cached pricing data for fast query access",
                      "Translation from D365 Commerce model to OTR domain language (ACL)",
                      "REST API for external consumers (DMB, mobile, web)",
                      "ETL pipeline from D365 Commerce S3 exports",
                      "Data validation and quality monitoring",
                      "Event publishing for pricing changes (future-proofing)"

    implementationTechnology = "AWS (S3, Glue/Lambda, RDS PostgreSQL, API Gateway, ECS Fargate), OAuth 2.0, CloudWatch"

    // ========================================================================
    // SECTION 1: CORE AGGREGATES
    // ========================================================================
    // ProductPrice is the ONLY aggregate.
    // It represents cached pricing data from D365 Commerce for fast API queries.
    // D365 Commerce is the authoritative source; ProductPrice is eventually consistent.
    // ========================================================================

    // 1.1 ProductPrice Aggregate
    // ---------------------------
    // Cached representation of product pricing from D365 Commerce.
    // Updated hourly via ETL pipeline from S3 exports.
    // Stored in RDS PostgreSQL for fast query access.
    //
    // Invariants:
    // - Price amount must be greater than zero
    // - Each product must have at least one price group
    // - Effective date ranges cannot overlap for the same product/price group combination
    // - Store IDs must exist in the store master data
    //
    // Lifecycle:
    // 1. Created/updated via hourly ETL pipeline from D365 Commerce export
    // 2. Validated against data contract schema
    // 3. Stored in RDS PostgreSQL for fast query access
    // 4. Queried via REST API by external consumers
    // 5. Eventually consistent (max 1 hour lag from D365 Commerce)
    Aggregate ProductPrice {
        Entity Product {
            aggregateRoot

            - ProductId productId
            - String productName
            - ProductCategory category
            - DateTime lastUpdated
        }

        Entity Price {
            - PriceId id
            - ProductId productId            // Reference to Product aggregate root
            - PriceGroupId priceGroupId
            - Money amount                   // Invariant: must be > 0
            - Date effectiveFrom
            - Date effectiveTo
            - DateTime lastUpdated
        }

        Entity PriceGroup {
            - PriceGroupId priceGroupId
            - String priceGroupName
            - String regionCode
            - List<StoreAssignment> storeAssignments
            - DateTime lastUpdated
        }

        ValueObject StoreAssignment {
            - StoreId storeId
            - Date effectiveFrom
        }

        ValueObject ProductId {
            - String id                      // D365 Commerce product identifier
        }

        ValueObject PriceId {
            - Long id                        // Database-generated identifier
        }

        ValueObject PriceGroupId {
            - String id                      // D365 Commerce price group identifier (e.g., "POS-AU-NAT")
        }

        ValueObject StoreId {
            - int id                         // D365 Commerce store number
        }

        ValueObject ProductCategory {
            - String code
            - String name
        }

        ValueObject Money {
            - Decimal amount
            - String currency                // AUD
        }

        ValueObject Date {
            - String isoDate                 // ISO 8601 date format (YYYY-MM-DD)
        }
    }

    // ========================================================================
    // SECTION 2: APPLICATION SERVICES
    // ========================================================================

    // 2.1 PricingQueryService
    // ------------------------
    // Exposes REST API for external consumers to query pricing data.
    // Returns data from RDS PostgreSQL cache (eventually consistent).
    Service PricingQueryService {
        // Get pricing data for all products or filtered by query parameters
        @PricingResponse getPricing(
            @ProductId productId,
            @StoreId storeId,
            @PriceGroupId priceGroupId
        )

        // Get pricing for a specific product at a specific store
        @ProductPricing getProductPricing(@ProductId productId, @StoreId storeId)

        // Get all products in a category with pricing
        @List<ProductWithPrice> getProductsByCategory(@ProductCategory category, @StoreId storeId)
    }

    // 2.2 ProductCatalogETLService
    // -----------------------------
    // ETL service that ingests D365 Commerce pricing exports from S3.
    // Validates data contract compliance and loads into RDS PostgreSQL.
    Service ProductCatalogETLService {
        // Process hourly pricing export from D365 Commerce
        void processS3Export(@S3Location s3Location)

        // Extract pricing data from Parquet files
        @RawPricingData extractFromParquet(@S3Location s3Location)

        // Transform D365 Commerce data into ProductPrice aggregate
        @List<ProductPrice> transformPricingData(@RawPricingData rawData)

        // Load transformed data into RDS PostgreSQL
        void loadToDatabase(@List<ProductPrice> productPrices)

        // Track ETL job execution
        void recordETLRun(@ETLRunStatus status)
    }

    // 2.3 DataValidationService
    // --------------------------
    // Validates incoming pricing data against schema and business rules.
    // Publishes DataValidationFailed events when validation fails.
    Service DataValidationService {
        // Validate pricing data against schema
        @ValidationResult validateSchema(@RawPricingData rawData)

        // Validate business rules (price > 0, effective dates, etc.)
        @ValidationResult validateBusinessRules(@List<ProductPrice> productPrices)

        // Validate store assignments exist in store master
        @ValidationResult validateStoreAssignments(@List<StoreAssignment> assignments)
    }

    // 2.4 D365PricingTranslator (Anti-Corruption Layer)
    // ---------------------------------------------------
    // Translates D365 Commerce terminology and data structures into ProductCatalog domain language.
    // Protects ProductCatalog domain from D365 Commerce model changes.
    Service D365PricingTranslator {
        // Translate D365 product model to OTR Product entity
        @Product translateProduct(@D365Product d365Product)

        // Translate D365 pricing model to OTR Price entity
        @Price translatePrice(@D365Price d365Price)

        // Translate D365 price group to OTR PriceGroup entity
        @PriceGroup translatePriceGroup(@D365PriceGroup d365PriceGroup)
    }

    // 2.5 CacheInvalidationService (Future)
    // ---------------------------------------
    // Manages API Gateway cache invalidation when new pricing data is loaded.
    // Future enhancement: ElastiCache integration for distributed caching.
    Service CacheInvalidationService {
        // Invalidate API Gateway cache for updated products
        void invalidateCache(@List<ProductId> productIds)

        // Invalidate entire cache after ETL completion
        void invalidateAllCache()
    }

    // ========================================================================
    // SECTION 3: VALUE OBJECTS (Shared)
    // ========================================================================

    ValueObject PricingResponse {
        - DateTime generatedAt
        - List<ProductWithPrice> products
        - ResponseMetadata metadata
    }

    ValueObject ProductWithPrice {
        - ProductId productId
        - String productName
        - ProductCategory category
        - List<PriceForGroup> prices
    }

    ValueObject PriceForGroup {
        - PriceGroupId priceGroup
        - Money amount
        - Date effectiveFrom
        - Date effectiveTo
        - List<StoreId> stores
    }

    ValueObject ResponseMetadata {
        - int totalProducts
        - DateTime lastUpdated
    }

    ValueObject S3Location {
        - String bucket
        - String key
    }

    ValueObject RawPricingData {
        - List<D365Product> products
        - List<D365Price> prices
        - List<D365PriceGroup> priceGroups
        - List<D365StoreAssignment> storeAssignments
    }

    ValueObject D365Product {
        - String productNumber
        - String productName
        - String category
    }

    ValueObject D365Price {
        - String productNumber
        - String priceGroup
        - Decimal amount
        - String effectiveFrom
        - String effectiveTo
    }

    ValueObject D365PriceGroup {
        - String priceGroupId
        - String priceGroupName
        - String regionCode
    }

    ValueObject D365StoreAssignment {
        - int storeId
        - String priceGroupId
        - String effectiveFrom
    }

    ValueObject ValidationResult {
        - boolean isValid
        - List<String> errors
        - List<String> warnings
    }

    ValueObject ETLRunStatus {
        - DateTime runTimestamp
        - String status                  // SUCCESS | FAILED | IN_PROGRESS
        - int recordsProcessed
        - String errorMessage
        - String sourceFilePath
    }

    // ========================================================================
    // SECTION 4: DOMAIN EVENTS
    // ========================================================================
    // Events published for future extensibility.
    // Initial implementation (Subway DMB) does not require event consumers.
    // ========================================================================

    // 4.1 Product Pricing Events
    // ---------------------------
    DomainEvent ProductPriceUpdated {
        - ProductId productId
        - String productName
        - PriceGroupId priceGroupId
        - Money oldPrice
        - Money newPrice
        - Date effectiveFrom
        - DateTime updatedAt
    }

    DomainEvent ProductCatalogRefreshed {
        - DateTime refreshedAt
        - int productsUpdated
        - int pricesUpdated
        - String sourceFilePath
    }

    DomainEvent PriceGroupAssignmentChanged {
        - PriceGroupId priceGroupId
        - StoreId storeId
        - String changeType              // ADDED | REMOVED | MODIFIED
        - Date effectiveFrom
        - DateTime changedAt
    }

    DomainEvent ProductAdded {
        - ProductId productId
        - String productName
        - ProductCategory category
        - DateTime addedAt
    }

    DomainEvent ProductRemoved {
        - ProductId productId
        - String productName
        - String reason                  // DISCONTINUED | DELISTED | etc.
        - DateTime removedAt
    }

    // 4.2 Data Quality Events
    // ------------------------
    DomainEvent DataValidationFailed {
        - String validationType          // SCHEMA | BUSINESS_RULE | STORE_ASSIGNMENT
        - List<String> errors
        - String sourceFilePath
        - DateTime failedAt
    }

    DomainEvent ETLPipelineFailed {
        - String pipelineStage           // EXTRACT | TRANSFORM | LOAD
        - String errorMessage
        - String sourceFilePath
        - DateTime failedAt
    }

    DomainEvent MissingPricingData {
        - DateTime expectedAt
        - String expectedFilePath
        - DateTime detectedAt
    }
}

// ============================================================================
// INTEGRATION NOTES
// ============================================================================
//
// Upstream Integration: D365 Commerce → ProductCatalogService
// ------------------------------------------------------------
// Pattern: Customer-Supplier + Conformist
//
// - D365 Commerce (Supplier): Exports pricing data to S3 on hourly schedule
// - ProductCatalogService (Customer): Conforms to D365's data contract and schema
// - Integration Technology: S3 bucket with cross-account IAM access (Azure → AWS)
// - Data Format: Apache Parquet files with defined schema
// - Update Frequency: Hourly batch export
// - Anti-Corruption Layer: D365PricingTranslator translates D365 terminology into OTR domain language
// - Eventually Consistent: Max 1 hour lag from D365 Commerce
//
// Downstream Integration: ProductCatalogService → External Consumers
// -------------------------------------------------------------------
// Pattern: Open Host Service + Published Language
//
// - ProductCatalogService (Open Host): Publishes stable REST API contract
// - External Consumers (Amped Digital DMB, future mobile/web): Consume API without translation
// - Integration Technology: REST API via API Gateway, OAuth 2.0 Client Credentials authentication
// - Data Format: JSON with OpenAPI specification
// - Update Frequency: Real-time queries (data eventually consistent, max 1 hour lag)
// - Published Language: OTR domain terminology (product, price, store, price group)
//
// Cross-Cloud Integration
// ------------------------
// Pattern: Domain Boundary via S3 Data Contract
//
// - Back-Office Domain (Azure): D365 Commerce, Azure Data Lake, Microsoft Fabric
// - Ecommerce Domain (AWS): S3, Glue/Lambda, RDS PostgreSQL, API Gateway, ECS
// - Domain Interface: S3 bucket with data contract (schema, SLA, quality rules)
// - Rationale: Clean separation between domains; each uses native cloud services
//
// What ProductCatalogService Owns
// ---------------------------------
// - Cached product pricing data (ProductPrice aggregate in RDS PostgreSQL)
// - ETL pipeline logic (extract, transform, load from D365 exports)
// - Data validation rules and quality monitoring
// - API contract and Published Language for external consumers
// - Event publishing for pricing changes
//
// What ProductCatalogService Does NOT Own (Owned by D365 Commerce)
// ------------------------------------------------------------------
// - Authoritative product master data
// - Pricing configuration and rules
// - Store master data
// - Price group assignments and mappings
// - Promotional pricing (future: owned by EagleEye)
// - Inventory availability (future: owned by D365 Commerce)
//
// Future Event Consumers
// -----------------------
// Potential downstream consumers for pricing change events:
//
// - LocationService: Update store-specific pricing for store finder
// - MobileApp: Invalidate cached prices, show "price updated" notifications
// - EngagementService: Trigger "price drop" campaigns for customer engagement
// - Data Platform: Analytics and reporting on pricing changes
//
// ============================================================================
